multiline_comment|/*&n; * ipr.c -- driver for IBM Power Linux RAID adapters&n; *&n; * Written By: Brian King, IBM Corporation&n; *&n; * Copyright (C) 2003, 2004 IBM Corporation&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; *&n; */
multiline_comment|/*&n; * Notes:&n; *&n; * This driver is used to control the following SCSI adapters:&n; *&n; * IBM iSeries: 5702, 5703, 2780, 5709, 570A, 570B&n; *&n; * IBM pSeries: PCI-X Dual Channel Ultra 320 SCSI RAID Adapter&n; *              PCI-X Dual Channel Ultra 320 SCSI Adapter&n; *              PCI-X Dual Channel Ultra 320 SCSI RAID Enablement Card&n; *              Embedded SCSI adapter on p615 and p655 systems&n; *&n; * Supported Hardware Features:&n; *&t;- Ultra 320 SCSI controller&n; *&t;- PCI-X host interface&n; *&t;- Embedded PowerPC RISC Processor and Hardware XOR DMA Engine&n; *&t;- Non-Volatile Write Cache&n; *&t;- Supports attachment of non-RAID disks, tape, and optical devices&n; *&t;- RAID Levels 0, 5, 10&n; *&t;- Hot spare&n; *&t;- Background Parity Checking&n; *&t;- Background Data Scrubbing&n; *&t;- Ability to increase the capacity of an existing RAID 5 disk array&n; *&t;&t;by adding disks&n; *&n; * Driver Features:&n; *&t;- Tagged command queuing&n; *&t;- Adapter microcode download&n; *&t;- PCI hot plug&n; *&t;- SCSI device hot plug&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/firmware.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsi_tcq.h&gt;
macro_line|#include &lt;scsi/scsi_eh.h&gt;
macro_line|#include &lt;scsi/scsi_cmnd.h&gt;
macro_line|#include &lt;scsi/scsi_request.h&gt;
macro_line|#include &quot;ipr.h&quot;
multiline_comment|/*&n; *   Global Data&n; */
DECL|variable|ipr_ioa_head
r_static
r_struct
id|list_head
id|ipr_ioa_head
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|ipr_ioa_head
)paren
suffix:semicolon
DECL|variable|ipr_log_level
r_static
r_int
r_int
id|ipr_log_level
op_assign
id|IPR_DEFAULT_LOG_LEVEL
suffix:semicolon
DECL|variable|ipr_max_speed
r_static
r_int
r_int
id|ipr_max_speed
op_assign
l_int|1
suffix:semicolon
DECL|variable|ipr_testmode
r_static
r_int
id|ipr_testmode
op_assign
l_int|0
suffix:semicolon
DECL|variable|ipr_driver_lock
r_static
id|spinlock_t
id|ipr_driver_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* This table describes the differences between DMA controller chips */
DECL|variable|ipr_chip_cfg
r_static
r_const
r_struct
id|ipr_chip_cfg_t
id|ipr_chip_cfg
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* Gemstone */
dot
id|mailbox
op_assign
l_int|0x0042C
comma
dot
id|cache_line_size
op_assign
l_int|0x20
comma
(brace
dot
id|set_interrupt_mask_reg
op_assign
l_int|0x0022C
comma
dot
id|clr_interrupt_mask_reg
op_assign
l_int|0x00230
comma
dot
id|sense_interrupt_mask_reg
op_assign
l_int|0x0022C
comma
dot
id|clr_interrupt_reg
op_assign
l_int|0x00228
comma
dot
id|sense_interrupt_reg
op_assign
l_int|0x00224
comma
dot
id|ioarrin_reg
op_assign
l_int|0x00404
comma
dot
id|sense_uproc_interrupt_reg
op_assign
l_int|0x00214
comma
dot
id|set_uproc_interrupt_reg
op_assign
l_int|0x00214
comma
dot
id|clr_uproc_interrupt_reg
op_assign
l_int|0x00218
)brace
)brace
comma
(brace
multiline_comment|/* Snipe */
dot
id|mailbox
op_assign
l_int|0x0052C
comma
dot
id|cache_line_size
op_assign
l_int|0x20
comma
(brace
dot
id|set_interrupt_mask_reg
op_assign
l_int|0x00288
comma
dot
id|clr_interrupt_mask_reg
op_assign
l_int|0x0028C
comma
dot
id|sense_interrupt_mask_reg
op_assign
l_int|0x00288
comma
dot
id|clr_interrupt_reg
op_assign
l_int|0x00284
comma
dot
id|sense_interrupt_reg
op_assign
l_int|0x00280
comma
dot
id|ioarrin_reg
op_assign
l_int|0x00504
comma
dot
id|sense_uproc_interrupt_reg
op_assign
l_int|0x00290
comma
dot
id|set_uproc_interrupt_reg
op_assign
l_int|0x00290
comma
dot
id|clr_uproc_interrupt_reg
op_assign
l_int|0x00294
)brace
)brace
comma
)brace
suffix:semicolon
DECL|variable|ipr_max_bus_speeds
r_static
r_int
id|ipr_max_bus_speeds
(braket
)braket
op_assign
(brace
id|IPR_80MBs_SCSI_RATE
comma
id|IPR_U160_SCSI_RATE
comma
id|IPR_U320_SCSI_RATE
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Brian King &lt;brking@us.ibm.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IBM Power RAID SCSI Adapter Driver&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|max_speed
comma
id|ipr_max_speed
comma
id|uint
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_speed
comma
l_string|&quot;Maximum bus speed (0-2). Default: 1=U160. Speeds: 0=80 MB/s, 1=U160, 2=U320&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|log_level
comma
id|ipr_log_level
comma
id|uint
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|log_level
comma
l_string|&quot;Set to 0 - 4 for increasing verbosity of device driver&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|testmode
comma
id|ipr_testmode
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|testmode
comma
l_string|&quot;DANGEROUS!!! Allows unsupported configurations&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|IPR_DRIVER_VERSION
id|MODULE_VERSION
c_func
(paren
id|IPR_DRIVER_VERSION
)paren
suffix:semicolon
DECL|variable|ipr_gpdd_dev_end_states
r_static
r_const
r_char
op_star
id|ipr_gpdd_dev_end_states
(braket
)braket
op_assign
(brace
l_string|&quot;Command complete&quot;
comma
l_string|&quot;Terminated by host&quot;
comma
l_string|&quot;Terminated by device reset&quot;
comma
l_string|&quot;Terminated by bus reset&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Command not started&quot;
)brace
suffix:semicolon
DECL|variable|ipr_gpdd_dev_bus_phases
r_static
r_const
r_char
op_star
id|ipr_gpdd_dev_bus_phases
(braket
)braket
op_assign
(brace
l_string|&quot;Bus free&quot;
comma
l_string|&quot;Arbitration&quot;
comma
l_string|&quot;Selection&quot;
comma
l_string|&quot;Message out&quot;
comma
l_string|&quot;Command&quot;
comma
l_string|&quot;Message in&quot;
comma
l_string|&quot;Data out&quot;
comma
l_string|&quot;Data in&quot;
comma
l_string|&quot;Status&quot;
comma
l_string|&quot;Reselection&quot;
comma
l_string|&quot;Unknown&quot;
)brace
suffix:semicolon
multiline_comment|/*  A constant array of IOASCs/URCs/Error Messages */
r_static
r_const
DECL|variable|ipr_error_table
r_struct
id|ipr_error_table_t
id|ipr_error_table
(braket
)braket
op_assign
(brace
(brace
l_int|0x00000000
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;8155: An unknown error was received&quot;
)brace
comma
(brace
l_int|0x00330000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Soft underlength error&quot;
)brace
comma
(brace
l_int|0x005A0000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Command to be cancelled not found&quot;
)brace
comma
(brace
l_int|0x00808000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Qualified success&quot;
)brace
comma
(brace
l_int|0x01080000
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;FFFE: Soft device bus error recovered by the IOA&quot;
)brace
comma
(brace
l_int|0x01170600
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFF9: Device sector reassign successful&quot;
)brace
comma
(brace
l_int|0x01170900
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFF7: Media error recovered by device rewrite procedures&quot;
)brace
comma
(brace
l_int|0x01180200
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;7001: IOA sector reassignment successful&quot;
)brace
comma
(brace
l_int|0x01180500
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFF9: Soft media error. Sector reassignment recommended&quot;
)brace
comma
(brace
l_int|0x01180600
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFF7: Media error recovered by IOA rewrite procedures&quot;
)brace
comma
(brace
l_int|0x01418000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FF3D: Soft PCI bus error recovered by the IOA&quot;
)brace
comma
(brace
l_int|0x01440000
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;FFF6: Device hardware error recovered by the IOA&quot;
)brace
comma
(brace
l_int|0x01448100
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFF6: Device hardware error recovered by the device&quot;
)brace
comma
(brace
l_int|0x01448200
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;FF3D: Soft IOA error recovered by the IOA&quot;
)brace
comma
(brace
l_int|0x01448300
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFFA: Undefined device response recovered by the IOA&quot;
)brace
comma
(brace
l_int|0x014A0000
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;FFF6: Device bus error, message or command phase&quot;
)brace
comma
(brace
l_int|0x015D0000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFF6: Failure prediction threshold exceeded&quot;
)brace
comma
(brace
l_int|0x015D9200
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;8009: Impending cache battery pack failure&quot;
)brace
comma
(brace
l_int|0x02040400
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;34FF: Disk device format in progress&quot;
)brace
comma
(brace
l_int|0x023F0000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Synchronization required&quot;
)brace
comma
(brace
l_int|0x024E0000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;No ready, IOA shutdown&quot;
)brace
comma
(brace
l_int|0x02670100
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;3020: Storage subsystem configuration error&quot;
)brace
comma
(brace
l_int|0x03110B00
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;FFF5: Medium error, data unreadable, recommend reassign&quot;
)brace
comma
(brace
l_int|0x03110C00
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;7000: Medium error, data unreadable, do not reassign&quot;
)brace
comma
(brace
l_int|0x03310000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFF3: Disk media format bad&quot;
)brace
comma
(brace
l_int|0x04050000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;3002: Addressed device failed to respond to selection&quot;
)brace
comma
(brace
l_int|0x04080000
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;3100: Device bus error&quot;
)brace
comma
(brace
l_int|0x04080100
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;3109: IOA timed out a device command&quot;
)brace
comma
(brace
l_int|0x04088000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;3120: SCSI bus is not operational&quot;
)brace
comma
(brace
l_int|0x04118000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9000: IOA reserved area data check&quot;
)brace
comma
(brace
l_int|0x04118100
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9001: IOA reserved area invalid data pattern&quot;
)brace
comma
(brace
l_int|0x04118200
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9002: IOA reserved area LRC error&quot;
)brace
comma
(brace
l_int|0x04320000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;102E: Out of alternate sectors for disk storage&quot;
)brace
comma
(brace
l_int|0x04330000
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;FFF4: Data transfer underlength error&quot;
)brace
comma
(brace
l_int|0x04338000
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;FFF4: Data transfer overlength error&quot;
)brace
comma
(brace
l_int|0x043E0100
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;3400: Logical unit failure&quot;
)brace
comma
(brace
l_int|0x04408500
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFF4: Device microcode is corrupt&quot;
)brace
comma
(brace
l_int|0x04418000
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;8150: PCI bus error&quot;
)brace
comma
(brace
l_int|0x04430000
comma
l_int|1
comma
l_int|0
comma
l_string|&quot;Unsupported device bus message received&quot;
)brace
comma
(brace
l_int|0x04440000
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;FFF4: Disk device problem&quot;
)brace
comma
(brace
l_int|0x04448200
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;8150: Permanent IOA failure&quot;
)brace
comma
(brace
l_int|0x04448300
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;3010: Disk device returned wrong response to IOA&quot;
)brace
comma
(brace
l_int|0x04448400
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;8151: IOA microcode error&quot;
)brace
comma
(brace
l_int|0x04448500
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Device bus status error&quot;
)brace
comma
(brace
l_int|0x04448600
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;8157: IOA error requiring IOA reset to recover&quot;
)brace
comma
(brace
l_int|0x04490000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Message reject received from the device&quot;
)brace
comma
(brace
l_int|0x04449200
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;8008: A permanent cache battery pack failure occurred&quot;
)brace
comma
(brace
l_int|0x0444A000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9090: Disk unit has been modified after the last known status&quot;
)brace
comma
(brace
l_int|0x0444A200
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9081: IOA detected device error&quot;
)brace
comma
(brace
l_int|0x0444A300
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9082: IOA detected device error&quot;
)brace
comma
(brace
l_int|0x044A0000
comma
l_int|1
comma
l_int|1
comma
l_string|&quot;3110: Device bus error, message or command phase&quot;
)brace
comma
(brace
l_int|0x04670400
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9091: Incorrect hardware configuration change has been detected&quot;
)brace
comma
(brace
l_int|0x046E0000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFF4: Command to logical unit failed&quot;
)brace
comma
(brace
l_int|0x05240000
comma
l_int|1
comma
l_int|0
comma
l_string|&quot;Illegal request, invalid request type or request packet&quot;
)brace
comma
(brace
l_int|0x05250000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Illegal request, invalid resource handle&quot;
)brace
comma
(brace
l_int|0x05260000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Illegal request, invalid field in parameter list&quot;
)brace
comma
(brace
l_int|0x05260100
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Illegal request, parameter not supported&quot;
)brace
comma
(brace
l_int|0x05260200
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Illegal request, parameter value invalid&quot;
)brace
comma
(brace
l_int|0x052C0000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Illegal request, command sequence error&quot;
)brace
comma
(brace
l_int|0x06040500
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9031: Array protection temporarily suspended, protection resuming&quot;
)brace
comma
(brace
l_int|0x06040600
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9040: Array protection temporarily suspended, protection resuming&quot;
)brace
comma
(brace
l_int|0x06290000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFFB: SCSI bus was reset&quot;
)brace
comma
(brace
l_int|0x06290500
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;FFFE: SCSI bus transition to single ended&quot;
)brace
comma
(brace
l_int|0x06290600
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;FFFE: SCSI bus transition to LVD&quot;
)brace
comma
(brace
l_int|0x06298000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;FFFB: SCSI bus was reset by another initiator&quot;
)brace
comma
(brace
l_int|0x063F0300
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;3029: A device replacement has occurred&quot;
)brace
comma
(brace
l_int|0x064C8000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9051: IOA cache data exists for a missing or failed device&quot;
)brace
comma
(brace
l_int|0x06670100
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9025: Disk unit is not supported at its physical location&quot;
)brace
comma
(brace
l_int|0x06670600
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;3020: IOA detected a SCSI bus configuration error&quot;
)brace
comma
(brace
l_int|0x06678000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;3150: SCSI bus configuration error&quot;
)brace
comma
(brace
l_int|0x06690200
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9041: Array protection temporarily suspended&quot;
)brace
comma
(brace
l_int|0x066B0200
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9030: Array no longer protected due to missing or failed disk unit&quot;
)brace
comma
(brace
l_int|0x07270000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Failure due to other device&quot;
)brace
comma
(brace
l_int|0x07278000
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9008: IOA does not support functions expected by devices&quot;
)brace
comma
(brace
l_int|0x07278100
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9010: Cache data associated with attached devices cannot be found&quot;
)brace
comma
(brace
l_int|0x07278200
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9011: Cache data belongs to devices other than those attached&quot;
)brace
comma
(brace
l_int|0x07278400
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9020: Array missing 2 or more devices with only 1 device present&quot;
)brace
comma
(brace
l_int|0x07278500
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9021: Array missing 2 or more devices with 2 or more devices present&quot;
)brace
comma
(brace
l_int|0x07278600
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9022: Exposed array is missing a required device&quot;
)brace
comma
(brace
l_int|0x07278700
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9023: Array member(s) not at required physical locations&quot;
)brace
comma
(brace
l_int|0x07278800
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9024: Array not functional due to present hardware configuration&quot;
)brace
comma
(brace
l_int|0x07278900
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9026: Array not functional due to present hardware configuration&quot;
)brace
comma
(brace
l_int|0x07278A00
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9027: Array is missing a device and parity is out of sync&quot;
)brace
comma
(brace
l_int|0x07278B00
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9028: Maximum number of arrays already exist&quot;
)brace
comma
(brace
l_int|0x07278C00
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9050: Required cache data cannot be located for a disk unit&quot;
)brace
comma
(brace
l_int|0x07278D00
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9052: Cache data exists for a device that has been modified&quot;
)brace
comma
(brace
l_int|0x07278F00
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9054: IOA resources not available due to previous problems&quot;
)brace
comma
(brace
l_int|0x07279100
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9092: Disk unit requires initialization before use&quot;
)brace
comma
(brace
l_int|0x07279200
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9029: Incorrect hardware configuration change has been detected&quot;
)brace
comma
(brace
l_int|0x07279600
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9060: One or more disk pairs are missing from an array&quot;
)brace
comma
(brace
l_int|0x07279700
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9061: One or more disks are missing from an array&quot;
)brace
comma
(brace
l_int|0x07279800
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9062: One or more disks are missing from an array&quot;
)brace
comma
(brace
l_int|0x07279900
comma
l_int|0
comma
l_int|1
comma
l_string|&quot;9063: Maximum number of functional arrays has been exceeded&quot;
)brace
comma
(brace
l_int|0x0B260000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Aborted command, invalid descriptor&quot;
)brace
comma
(brace
l_int|0x0B5A0000
comma
l_int|0
comma
l_int|0
comma
l_string|&quot;Command terminated by host&quot;
)brace
)brace
suffix:semicolon
DECL|variable|ipr_ses_table
r_static
r_const
r_struct
id|ipr_ses_table_entry
id|ipr_ses_table
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;2104-DL1        &quot;
comma
l_string|&quot;XXXXXXXXXXXXXXXX&quot;
comma
l_int|80
)brace
comma
(brace
l_string|&quot;2104-TL1        &quot;
comma
l_string|&quot;XXXXXXXXXXXXXXXX&quot;
comma
l_int|80
)brace
comma
(brace
l_string|&quot;HSBP07M P U2SCSI&quot;
comma
l_string|&quot;XXXXXXXXXXXXXXXX&quot;
comma
l_int|80
)brace
comma
multiline_comment|/* Hidive 7 slot */
(brace
l_string|&quot;HSBP05M P U2SCSI&quot;
comma
l_string|&quot;XXXXXXXXXXXXXXXX&quot;
comma
l_int|80
)brace
comma
multiline_comment|/* Hidive 5 slot */
(brace
l_string|&quot;HSBP05M S U2SCSI&quot;
comma
l_string|&quot;XXXXXXXXXXXXXXXX&quot;
comma
l_int|80
)brace
comma
multiline_comment|/* Bowtie */
(brace
l_string|&quot;HSBP06E ASU2SCSI&quot;
comma
l_string|&quot;XXXXXXXXXXXXXXXX&quot;
comma
l_int|80
)brace
comma
multiline_comment|/* MartinFenning */
(brace
l_string|&quot;2104-DU3        &quot;
comma
l_string|&quot;XXXXXXXXXXXXXXXX&quot;
comma
l_int|160
)brace
comma
(brace
l_string|&quot;2104-TU3        &quot;
comma
l_string|&quot;XXXXXXXXXXXXXXXX&quot;
comma
l_int|160
)brace
comma
(brace
l_string|&quot;HSBP04C RSU2SCSI&quot;
comma
l_string|&quot;XXXXXXX*XXXXXXXX&quot;
comma
l_int|160
)brace
comma
(brace
l_string|&quot;HSBP06E RSU2SCSI&quot;
comma
l_string|&quot;XXXXXXX*XXXXXXXX&quot;
comma
l_int|160
)brace
comma
(brace
l_string|&quot;St  V1S2        &quot;
comma
l_string|&quot;XXXXXXXXXXXXXXXX&quot;
comma
l_int|160
)brace
comma
(brace
l_string|&quot;HSBPD4M  PU3SCSI&quot;
comma
l_string|&quot;XXXXXXX*XXXXXXXX&quot;
comma
l_int|160
)brace
comma
(brace
l_string|&quot;VSBPD1H   U3SCSI&quot;
comma
l_string|&quot;XXXXXXX*XXXXXXXX&quot;
comma
l_int|160
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; *  Function Prototypes&n; */
r_static
r_int
id|ipr_reset_alert
c_func
(paren
r_struct
id|ipr_cmnd
op_star
)paren
suffix:semicolon
r_static
r_void
id|ipr_process_ccn
c_func
(paren
r_struct
id|ipr_cmnd
op_star
)paren
suffix:semicolon
r_static
r_void
id|ipr_process_error
c_func
(paren
r_struct
id|ipr_cmnd
op_star
)paren
suffix:semicolon
r_static
r_void
id|ipr_reset_ioa_job
c_func
(paren
r_struct
id|ipr_cmnd
op_star
)paren
suffix:semicolon
r_static
r_void
id|ipr_initiate_ioa_reset
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
comma
r_enum
id|ipr_shutdown_type
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SCSI_IPR_TRACE
multiline_comment|/**&n; * ipr_trc_hook - Add a trace entry to the driver trace&n; * @ipr_cmd:&t;ipr command struct&n; * @type:&t;&t;trace type&n; * @add_data:&t;additional data&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_trc_hook
r_static
r_void
id|ipr_trc_hook
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
comma
id|u8
id|type
comma
id|u32
id|add_data
)paren
(brace
r_struct
id|ipr_trace_entry
op_star
id|trace_entry
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
id|trace_entry
op_assign
op_amp
id|ioa_cfg-&gt;trace
(braket
id|ioa_cfg-&gt;trace_index
op_increment
)braket
suffix:semicolon
id|trace_entry-&gt;time
op_assign
id|jiffies
suffix:semicolon
id|trace_entry-&gt;op_code
op_assign
id|ipr_cmd-&gt;ioarcb.cmd_pkt.cdb
(braket
l_int|0
)braket
suffix:semicolon
id|trace_entry-&gt;type
op_assign
id|type
suffix:semicolon
id|trace_entry-&gt;cmd_index
op_assign
id|ipr_cmd-&gt;cmd_index
suffix:semicolon
id|trace_entry-&gt;res_handle
op_assign
id|ipr_cmd-&gt;ioarcb.res_handle
suffix:semicolon
id|trace_entry-&gt;u.add_data
op_assign
id|add_data
suffix:semicolon
)brace
macro_line|#else
DECL|macro|ipr_trc_hook
mdefine_line|#define ipr_trc_hook(ipr_cmd, type, add_data) do { } while(0)
macro_line|#endif
multiline_comment|/**&n; * ipr_reinit_ipr_cmnd - Re-initialize an IPR Cmnd block for reuse&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_reinit_ipr_cmnd
r_static
r_void
id|ipr_reinit_ipr_cmnd
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
r_struct
id|ipr_ioasa
op_star
id|ioasa
op_assign
op_amp
id|ipr_cmd-&gt;ioasa
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ioarcb-&gt;cmd_pkt
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ipr_cmd_pkt
)paren
)paren
suffix:semicolon
id|ioarcb-&gt;write_data_transfer_length
op_assign
l_int|0
suffix:semicolon
id|ioarcb-&gt;read_data_transfer_length
op_assign
l_int|0
suffix:semicolon
id|ioarcb-&gt;write_ioadl_len
op_assign
l_int|0
suffix:semicolon
id|ioarcb-&gt;read_ioadl_len
op_assign
l_int|0
suffix:semicolon
id|ioasa-&gt;ioasc
op_assign
l_int|0
suffix:semicolon
id|ioasa-&gt;residual_data_len
op_assign
l_int|0
suffix:semicolon
id|ipr_cmd-&gt;scsi_cmd
op_assign
l_int|NULL
suffix:semicolon
id|ipr_cmd-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ipr_cmd-&gt;dma_use_sg
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_init_ipr_cmnd - Initialize an IPR Cmnd block&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_init_ipr_cmnd
r_static
r_void
id|ipr_init_ipr_cmnd
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
id|ipr_reinit_ipr_cmnd
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
id|ipr_cmd-&gt;u.scratch
op_assign
l_int|0
suffix:semicolon
id|ipr_cmd-&gt;sibling
op_assign
l_int|NULL
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|ipr_cmd-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_get_free_ipr_cmnd - Get a free IPR Cmnd block&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Return value:&n; * &t;pointer to ipr command struct&n; **/
r_static
DECL|function|ipr_get_free_ipr_cmnd
r_struct
id|ipr_cmnd
op_star
id|ipr_get_free_ipr_cmnd
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
suffix:semicolon
id|ipr_cmd
op_assign
id|list_entry
c_func
(paren
id|ioa_cfg-&gt;free_q.next
comma
r_struct
id|ipr_cmnd
comma
id|queue
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
)paren
suffix:semicolon
id|ipr_init_ipr_cmnd
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
r_return
id|ipr_cmd
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_unmap_sglist - Unmap scatterlist if mapped&n; * @ioa_cfg:&t;ioa config struct&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_unmap_sglist
r_static
r_void
id|ipr_unmap_sglist
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
op_assign
id|ipr_cmd-&gt;scsi_cmd
suffix:semicolon
r_if
c_cond
(paren
id|ipr_cmd-&gt;dma_use_sg
)paren
(brace
r_if
c_cond
(paren
id|scsi_cmd-&gt;use_sg
OG
l_int|0
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|scsi_cmd-&gt;request_buffer
comma
id|scsi_cmd-&gt;use_sg
comma
id|scsi_cmd-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
r_else
(brace
id|pci_unmap_single
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|ipr_cmd-&gt;dma_handle
comma
id|scsi_cmd-&gt;request_bufflen
comma
id|scsi_cmd-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * ipr_mask_and_clear_interrupts - Mask all and clear specified interrupts&n; * @ioa_cfg:&t;ioa config struct&n; * @clr_ints:     interrupts to clear&n; *&n; * This function masks all interrupts on the adapter, then clears the&n; * interrupts specified in the mask&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_mask_and_clear_interrupts
r_static
r_void
id|ipr_mask_and_clear_interrupts
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
id|u32
id|clr_ints
)paren
(brace
r_volatile
id|u32
id|int_reg
suffix:semicolon
multiline_comment|/* Stop new interrupts */
id|ioa_cfg-&gt;allow_interrupts
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set interrupt mask to stop all new interrupts */
id|writel
c_func
(paren
op_complement
l_int|0
comma
id|ioa_cfg-&gt;regs.set_interrupt_mask_reg
)paren
suffix:semicolon
multiline_comment|/* Clear any pending interrupts */
id|writel
c_func
(paren
id|clr_ints
comma
id|ioa_cfg-&gt;regs.clr_interrupt_reg
)paren
suffix:semicolon
id|int_reg
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;regs.sense_interrupt_reg
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_save_pcix_cmd_reg - Save PCI-X command register&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Return value:&n; * &t;0 on success / -EIO on failure&n; **/
DECL|function|ipr_save_pcix_cmd_reg
r_static
r_int
id|ipr_save_pcix_cmd_reg
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_int
id|pcix_cmd_reg
op_assign
id|pci_find_capability
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|PCI_CAP_ID_PCIX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcix_cmd_reg
op_eq
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Failed to save PCI-X command register&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|pcix_cmd_reg
comma
op_amp
id|ioa_cfg-&gt;saved_pcix_cmd_reg
)paren
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Failed to save PCI-X command register&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|ioa_cfg-&gt;saved_pcix_cmd_reg
op_or_assign
id|PCI_X_CMD_DPERR_E
op_or
id|PCI_X_CMD_ERO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_set_pcix_cmd_reg - Setup PCI-X command register&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Return value:&n; * &t;0 on success / -EIO on failure&n; **/
DECL|function|ipr_set_pcix_cmd_reg
r_static
r_int
id|ipr_set_pcix_cmd_reg
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_int
id|pcix_cmd_reg
op_assign
id|pci_find_capability
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|PCI_CAP_ID_PCIX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcix_cmd_reg
)paren
(brace
r_if
c_cond
(paren
id|pci_write_config_word
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|pcix_cmd_reg
comma
id|ioa_cfg-&gt;saved_pcix_cmd_reg
)paren
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Failed to setup PCI-X command register&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_else
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Failed to setup PCI-X command register&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_scsi_eh_done - mid-layer done function for aborted ops&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function is invoked by the interrupt handler for&n; * ops generated by the SCSI mid-layer which are being aborted.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_scsi_eh_done
r_static
r_void
id|ipr_scsi_eh_done
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
op_assign
id|ipr_cmd-&gt;scsi_cmd
suffix:semicolon
id|scsi_cmd-&gt;result
op_or_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|ipr_unmap_sglist
c_func
(paren
id|ioa_cfg
comma
id|ipr_cmd
)paren
suffix:semicolon
id|scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scsi_cmd
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_fail_all_ops - Fails all outstanding ops.&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * This function fails all outstanding ops.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_fail_all_ops
r_static
r_void
id|ipr_fail_all_ops
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
comma
op_star
id|temp
suffix:semicolon
id|ENTER
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|ipr_cmd
comma
id|temp
comma
op_amp
id|ioa_cfg-&gt;pending_q
comma
id|queue
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioasa.ioasc
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOASC_IOA_WAS_RESET
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioasa.ilid
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_DRIVER_ILID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipr_cmd-&gt;scsi_cmd
)paren
id|ipr_cmd-&gt;done
op_assign
id|ipr_scsi_eh_done
suffix:semicolon
id|ipr_trc_hook
c_func
(paren
id|ipr_cmd
comma
id|IPR_TRACE_FINISH
comma
id|IPR_IOASC_IOA_WAS_RESET
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ipr_cmd-&gt;timer
)paren
suffix:semicolon
id|ipr_cmd
op_member_access_from_pointer
id|done
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
)brace
id|LEAVE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_do_req -  Send driver initiated requests.&n; * @ipr_cmd:&t;&t;ipr command struct&n; * @done:&t;&t;&t;done function&n; * @timeout_func:&t;timeout function&n; * @timeout:&t;&t;timeout value&n; *&n; * This function sends the specified command to the adapter with the&n; * timeout given. The done function is invoked on command completion.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_do_req
r_static
r_void
id|ipr_do_req
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|ipr_cmnd
op_star
)paren
comma
r_void
(paren
op_star
id|timeout_func
)paren
(paren
r_struct
id|ipr_cmnd
op_star
)paren
comma
id|u32
id|timeout
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;pending_q
)paren
suffix:semicolon
id|ipr_cmd-&gt;done
op_assign
id|done
suffix:semicolon
id|ipr_cmd-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|ipr_cmd
suffix:semicolon
id|ipr_cmd-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|timeout
suffix:semicolon
id|ipr_cmd-&gt;timer.function
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|timeout_func
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ipr_cmd-&gt;timer
)paren
suffix:semicolon
id|ipr_trc_hook
c_func
(paren
id|ipr_cmd
comma
id|IPR_TRACE_START
comma
l_int|0
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioarcb.ioarcb_host_pci_addr
)paren
comma
id|ioa_cfg-&gt;regs.ioarrin_reg
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_internal_cmd_done - Op done function for an internally generated op.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function is the op done function for an internally generated,&n; * blocking op. It simply wakes the sleeping thread.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_internal_cmd_done
r_static
r_void
id|ipr_internal_cmd_done
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_if
c_cond
(paren
id|ipr_cmd-&gt;sibling
)paren
id|ipr_cmd-&gt;sibling
op_assign
l_int|NULL
suffix:semicolon
r_else
id|complete
c_func
(paren
op_amp
id|ipr_cmd-&gt;completion
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_send_blocking_cmd - Send command and sleep on its completion.&n; * @ipr_cmd:&t;ipr command struct&n; * @timeout_func:&t;function to invoke if command times out&n; * @timeout:&t;timeout&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_send_blocking_cmd
r_static
r_void
id|ipr_send_blocking_cmd
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
comma
r_void
(paren
op_star
id|timeout_func
)paren
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
comma
id|u32
id|timeout
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|ipr_cmd-&gt;completion
)paren
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|ipr_cmd
comma
id|ipr_internal_cmd_done
comma
id|timeout_func
comma
id|timeout
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|ipr_cmd-&gt;completion
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_send_hcam - Send an HCAM to the adapter.&n; * @ioa_cfg:&t;ioa config struct&n; * @type:&t;&t;HCAM type&n; * @hostrcb:&t;hostrcb struct&n; *&n; * This function will send a Host Controlled Async command to the adapter.&n; * If HCAMs are currently not allowed to be issued to the adapter, it will&n; * place the hostrcb on the free queue.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_send_hcam
r_static
r_void
id|ipr_send_hcam
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
id|u8
id|type
comma
r_struct
id|ipr_hostrcb
op_star
id|hostrcb
)paren
(brace
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
suffix:semicolon
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;allow_cmds
)paren
(brace
id|ipr_cmd
op_assign
id|ipr_get_free_ipr_cmnd
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;pending_q
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|hostrcb-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;hostrcb_pending_q
)paren
suffix:semicolon
id|ipr_cmd-&gt;u.hostrcb
op_assign
id|hostrcb
suffix:semicolon
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
id|ioarcb-&gt;res_handle
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOA_RES_HANDLE
)paren
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.request_type
op_assign
id|IPR_RQTYPE_HCAM
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|0
)braket
op_assign
id|IPR_HOST_CONTROLLED_ASYNC
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|1
)braket
op_assign
id|type
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|7
)braket
op_assign
(paren
r_sizeof
(paren
id|hostrcb-&gt;hcam
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|8
)braket
op_assign
r_sizeof
(paren
id|hostrcb-&gt;hcam
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ioarcb-&gt;read_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
id|hostrcb-&gt;hcam
)paren
)paren
suffix:semicolon
id|ioarcb-&gt;read_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioadl
(braket
l_int|0
)braket
dot
id|flags_and_data_len
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOADL_FLAGS_READ_LAST
op_or
r_sizeof
(paren
id|hostrcb-&gt;hcam
)paren
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioadl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|cpu_to_be32
c_func
(paren
id|hostrcb-&gt;hostrcb_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|IPR_HCAM_CDB_OP_CODE_CONFIG_CHANGE
)paren
id|ipr_cmd-&gt;done
op_assign
id|ipr_process_ccn
suffix:semicolon
r_else
id|ipr_cmd-&gt;done
op_assign
id|ipr_process_error
suffix:semicolon
id|ipr_trc_hook
c_func
(paren
id|ipr_cmd
comma
id|IPR_TRACE_START
comma
id|IPR_IOA_RES_ADDR
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioarcb.ioarcb_host_pci_addr
)paren
comma
id|ioa_cfg-&gt;regs.ioarrin_reg
)paren
suffix:semicolon
)brace
r_else
(brace
id|list_add_tail
c_func
(paren
op_amp
id|hostrcb-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;hostrcb_free_q
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ipr_init_res_entry - Initialize a resource entry struct.&n; * @res:&t;resource entry struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_init_res_entry
r_static
r_void
id|ipr_init_res_entry
c_func
(paren
r_struct
id|ipr_resource_entry
op_star
id|res
)paren
(brace
id|res-&gt;needs_sync_complete
op_assign
l_int|1
suffix:semicolon
id|res-&gt;in_erp
op_assign
l_int|0
suffix:semicolon
id|res-&gt;add_to_ml
op_assign
l_int|0
suffix:semicolon
id|res-&gt;del_from_ml
op_assign
l_int|0
suffix:semicolon
id|res-&gt;resetting_device
op_assign
l_int|0
suffix:semicolon
id|res-&gt;tcq_active
op_assign
l_int|0
suffix:semicolon
id|res-&gt;qdepth
op_assign
id|IPR_MAX_CMD_PER_LUN
suffix:semicolon
id|res-&gt;sdev
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_handle_config_change - Handle a config change from the adapter&n; * @ioa_cfg:&t;ioa config struct&n; * @hostrcb:&t;hostrcb&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_handle_config_change
r_static
r_void
id|ipr_handle_config_change
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_hostrcb
op_star
id|hostrcb
)paren
(brace
r_struct
id|ipr_resource_entry
op_star
id|res
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ipr_config_table_entry
op_star
id|cfgte
suffix:semicolon
id|u32
id|is_ndn
op_assign
l_int|1
suffix:semicolon
id|cfgte
op_assign
op_amp
id|hostrcb-&gt;hcam.u.ccn.cfgte
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|res
comma
op_amp
id|ioa_cfg-&gt;used_res_q
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|res-&gt;cfgte.res_addr
comma
op_amp
id|cfgte-&gt;res_addr
comma
r_sizeof
(paren
id|cfgte-&gt;res_addr
)paren
)paren
)paren
(brace
id|is_ndn
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|is_ndn
)paren
(brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ioa_cfg-&gt;free_res_q
)paren
)paren
(brace
id|ipr_send_hcam
c_func
(paren
id|ioa_cfg
comma
id|IPR_HCAM_CDB_OP_CODE_CONFIG_CHANGE
comma
id|hostrcb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|res
op_assign
id|list_entry
c_func
(paren
id|ioa_cfg-&gt;free_res_q.next
comma
r_struct
id|ipr_resource_entry
comma
id|queue
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|res-&gt;queue
)paren
suffix:semicolon
id|ipr_init_res_entry
c_func
(paren
id|res
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|res-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;used_res_q
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|res-&gt;cfgte
comma
id|cfgte
comma
r_sizeof
(paren
r_struct
id|ipr_config_table_entry
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostrcb-&gt;hcam.notify_type
op_eq
id|IPR_HOST_RCB_NOTIF_TYPE_REM_ENTRY
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;sdev
)paren
(brace
id|res-&gt;sdev-&gt;hostdata
op_assign
l_int|NULL
suffix:semicolon
id|res-&gt;del_from_ml
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;allow_ml_add_del
)paren
id|schedule_work
c_func
(paren
op_amp
id|ioa_cfg-&gt;work_q
)paren
suffix:semicolon
)brace
r_else
id|list_move_tail
c_func
(paren
op_amp
id|res-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_res_q
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|res-&gt;sdev
)paren
(brace
id|res-&gt;add_to_ml
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;allow_ml_add_del
)paren
id|schedule_work
c_func
(paren
op_amp
id|ioa_cfg-&gt;work_q
)paren
suffix:semicolon
)brace
id|ipr_send_hcam
c_func
(paren
id|ioa_cfg
comma
id|IPR_HCAM_CDB_OP_CODE_CONFIG_CHANGE
comma
id|hostrcb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_process_ccn - Op done function for a CCN.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function is the op done function for a configuration&n; * change notification host controlled async from the adapter.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_process_ccn
r_static
r_void
id|ipr_process_ccn
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_hostrcb
op_star
id|hostrcb
op_assign
id|ipr_cmd-&gt;u.hostrcb
suffix:semicolon
id|u32
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioasa.ioasc
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|hostrcb-&gt;queue
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioasc
)paren
(brace
r_if
c_cond
(paren
id|ioasc
op_ne
id|IPR_IOASC_IOA_WAS_RESET
)paren
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Host RCB failed with IOASC: 0x%08X&bslash;n&quot;
comma
id|ioasc
)paren
suffix:semicolon
id|ipr_send_hcam
c_func
(paren
id|ioa_cfg
comma
id|IPR_HCAM_CDB_OP_CODE_CONFIG_CHANGE
comma
id|hostrcb
)paren
suffix:semicolon
)brace
r_else
(brace
id|ipr_handle_config_change
c_func
(paren
id|ioa_cfg
comma
id|hostrcb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ipr_log_vpd - Log the passed VPD to the error log.&n; * @vpids:&t;&t;&t;vendor/product id struct&n; * @serial_num:&t;&t;serial number string&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_log_vpd
r_static
r_void
id|ipr_log_vpd
c_func
(paren
r_struct
id|ipr_std_inq_vpids
op_star
id|vpids
comma
id|u8
op_star
id|serial_num
)paren
(brace
r_char
id|buffer
(braket
id|max_t
c_func
(paren
r_int
comma
r_sizeof
(paren
r_struct
id|ipr_std_inq_vpids
)paren
comma
id|IPR_SERIAL_NUM_LEN
)paren
op_plus
l_int|1
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
comma
id|vpids
comma
r_sizeof
(paren
r_struct
id|ipr_std_inq_vpids
)paren
)paren
suffix:semicolon
id|buffer
(braket
r_sizeof
(paren
r_struct
id|ipr_std_inq_vpids
)paren
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;Vendor/Product ID: %s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
comma
id|serial_num
comma
id|IPR_SERIAL_NUM_LEN
)paren
suffix:semicolon
id|buffer
(braket
id|IPR_SERIAL_NUM_LEN
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;    Serial Number: %s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_log_cache_error - Log a cache error.&n; * @ioa_cfg:&t;ioa config struct&n; * @hostrcb:&t;hostrcb struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_log_cache_error
r_static
r_void
id|ipr_log_cache_error
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_hostrcb
op_star
id|hostrcb
)paren
(brace
r_struct
id|ipr_hostrcb_type_02_error
op_star
id|error
op_assign
op_amp
id|hostrcb-&gt;hcam.u.error.u.type_02_error
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;-----Current Configuration-----&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;Cache Directory Card Information:&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_log_vpd
c_func
(paren
op_amp
id|error-&gt;ioa_vpids
comma
id|error-&gt;ioa_sn
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;Adapter Card Information:&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_log_vpd
c_func
(paren
op_amp
id|error-&gt;cfc_vpids
comma
id|error-&gt;cfc_sn
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;-----Expected Configuration-----&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;Cache Directory Card Information:&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_log_vpd
c_func
(paren
op_amp
id|error-&gt;ioa_last_attached_to_cfc_vpids
comma
id|error-&gt;ioa_last_attached_to_cfc_sn
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;Adapter Card Information:&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_log_vpd
c_func
(paren
op_amp
id|error-&gt;cfc_last_attached_to_ioa_vpids
comma
id|error-&gt;cfc_last_attached_to_ioa_sn
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;Additional IOA Data: %08X %08X %08X&bslash;n&quot;
comma
id|be32_to_cpu
c_func
(paren
id|error-&gt;ioa_data
(braket
l_int|0
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|error-&gt;ioa_data
(braket
l_int|1
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|error-&gt;ioa_data
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_log_config_error - Log a configuration error.&n; * @ioa_cfg:&t;ioa config struct&n; * @hostrcb:&t;hostrcb struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_log_config_error
r_static
r_void
id|ipr_log_config_error
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_hostrcb
op_star
id|hostrcb
)paren
(brace
r_int
id|errors_logged
comma
id|i
suffix:semicolon
r_struct
id|ipr_hostrcb_device_data_entry
op_star
id|dev_entry
suffix:semicolon
r_struct
id|ipr_hostrcb_type_03_error
op_star
id|error
suffix:semicolon
id|error
op_assign
op_amp
id|hostrcb-&gt;hcam.u.error.u.type_03_error
suffix:semicolon
id|errors_logged
op_assign
id|be32_to_cpu
c_func
(paren
id|error-&gt;errors_logged
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;Device Errors Detected/Logged: %d/%d&bslash;n&quot;
comma
id|be32_to_cpu
c_func
(paren
id|error-&gt;errors_detected
)paren
comma
id|errors_logged
)paren
suffix:semicolon
id|dev_entry
op_assign
id|error-&gt;dev_entry
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|errors_logged
suffix:semicolon
id|i
op_increment
comma
id|dev_entry
op_increment
)paren
(brace
id|ipr_err_separator
suffix:semicolon
r_if
c_cond
(paren
id|dev_entry-&gt;dev_res_addr.bus
op_ge
id|IPR_MAX_NUM_BUSES
)paren
(brace
id|ipr_err
c_func
(paren
l_string|&quot;Device %d: missing&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|ipr_err
c_func
(paren
l_string|&quot;Device %d: %d:%d:%d:%d&bslash;n&quot;
comma
id|i
op_plus
l_int|1
comma
id|ioa_cfg-&gt;host-&gt;host_no
comma
id|dev_entry-&gt;dev_res_addr.bus
comma
id|dev_entry-&gt;dev_res_addr.target
comma
id|dev_entry-&gt;dev_res_addr.lun
)paren
suffix:semicolon
)brace
id|ipr_log_vpd
c_func
(paren
op_amp
id|dev_entry-&gt;dev_vpids
comma
id|dev_entry-&gt;dev_sn
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;-----New Device Information-----&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_log_vpd
c_func
(paren
op_amp
id|dev_entry-&gt;new_dev_vpids
comma
id|dev_entry-&gt;new_dev_sn
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;Cache Directory Card Information:&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_log_vpd
c_func
(paren
op_amp
id|dev_entry-&gt;ioa_last_with_dev_vpids
comma
id|dev_entry-&gt;ioa_last_with_dev_sn
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;Adapter Card Information:&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_log_vpd
c_func
(paren
op_amp
id|dev_entry-&gt;cfc_last_with_dev_vpids
comma
id|dev_entry-&gt;cfc_last_with_dev_sn
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;Additional IOA Data: %08X %08X %08X %08X %08X&bslash;n&quot;
comma
id|be32_to_cpu
c_func
(paren
id|dev_entry-&gt;ioa_data
(braket
l_int|0
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|dev_entry-&gt;ioa_data
(braket
l_int|1
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|dev_entry-&gt;ioa_data
(braket
l_int|2
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|dev_entry-&gt;ioa_data
(braket
l_int|3
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|dev_entry-&gt;ioa_data
(braket
l_int|4
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ipr_log_array_error - Log an array configuration error.&n; * @ioa_cfg:&t;ioa config struct&n; * @hostrcb:&t;hostrcb struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_log_array_error
r_static
r_void
id|ipr_log_array_error
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_hostrcb
op_star
id|hostrcb
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ipr_hostrcb_type_04_error
op_star
id|error
suffix:semicolon
r_struct
id|ipr_hostrcb_array_data_entry
op_star
id|array_entry
suffix:semicolon
id|u8
id|zero_sn
(braket
id|IPR_SERIAL_NUM_LEN
)braket
suffix:semicolon
id|memset
c_func
(paren
id|zero_sn
comma
l_char|&squot;0&squot;
comma
id|IPR_SERIAL_NUM_LEN
)paren
suffix:semicolon
id|error
op_assign
op_amp
id|hostrcb-&gt;hcam.u.error.u.type_04_error
suffix:semicolon
id|ipr_err_separator
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;RAID %s Array Configuration: %d:%d:%d:%d&bslash;n&quot;
comma
id|error-&gt;protection_level
comma
id|ioa_cfg-&gt;host-&gt;host_no
comma
id|error-&gt;last_func_vset_res_addr.bus
comma
id|error-&gt;last_func_vset_res_addr.target
comma
id|error-&gt;last_func_vset_res_addr.lun
)paren
suffix:semicolon
id|ipr_err_separator
suffix:semicolon
id|array_entry
op_assign
id|error-&gt;array_member
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|array_entry-&gt;serial_num
comma
id|zero_sn
comma
id|IPR_SERIAL_NUM_LEN
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|error-&gt;exposed_mode_adn
op_eq
id|i
)paren
(brace
id|ipr_err
c_func
(paren
l_string|&quot;Exposed Array Member %d:&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_else
(brace
id|ipr_err
c_func
(paren
l_string|&quot;Array Member %d:&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|ipr_log_vpd
c_func
(paren
op_amp
id|array_entry-&gt;vpids
comma
id|array_entry-&gt;serial_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|array_entry-&gt;dev_res_addr.bus
op_ge
id|IPR_MAX_NUM_BUSES
)paren
(brace
id|ipr_err
c_func
(paren
l_string|&quot;Current Location: unknown&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|ipr_err
c_func
(paren
l_string|&quot;Current Location: %d:%d:%d:%d&bslash;n&quot;
comma
id|ioa_cfg-&gt;host-&gt;host_no
comma
id|array_entry-&gt;dev_res_addr.bus
comma
id|array_entry-&gt;dev_res_addr.target
comma
id|array_entry-&gt;dev_res_addr.lun
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|array_entry-&gt;dev_res_addr.bus
op_ge
id|IPR_MAX_NUM_BUSES
)paren
(brace
id|ipr_err
c_func
(paren
l_string|&quot;Expected Location: unknown&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|ipr_err
c_func
(paren
l_string|&quot;Expected Location: %d:%d:%d:%d&bslash;n&quot;
comma
id|ioa_cfg-&gt;host-&gt;host_no
comma
id|array_entry-&gt;expected_dev_res_addr.bus
comma
id|array_entry-&gt;expected_dev_res_addr.target
comma
id|array_entry-&gt;expected_dev_res_addr.lun
)paren
suffix:semicolon
)brace
id|ipr_err_separator
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|9
)paren
id|array_entry
op_assign
id|error-&gt;array_member2
suffix:semicolon
r_else
id|array_entry
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ipr_log_generic_error - Log an adapter error.&n; * @ioa_cfg:&t;ioa config struct&n; * @hostrcb:&t;hostrcb struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_log_generic_error
r_static
r_void
id|ipr_log_generic_error
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_hostrcb
op_star
id|hostrcb
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|ioa_data_len
op_assign
id|be32_to_cpu
c_func
(paren
id|hostrcb-&gt;hcam.length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_data_len
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;IOA Error Data:&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;Offset    0 1 2 3  4 5 6 7  8 9 A B  C D E F&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ioa_data_len
op_div
l_int|4
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|ipr_err
c_func
(paren
l_string|&quot;%08X: %08X %08X %08X %08X&bslash;n&quot;
comma
id|i
op_star
l_int|4
comma
id|be32_to_cpu
c_func
(paren
id|hostrcb-&gt;hcam.u.raw.data
(braket
id|i
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|hostrcb-&gt;hcam.u.raw.data
(braket
id|i
op_plus
l_int|1
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|hostrcb-&gt;hcam.u.raw.data
(braket
id|i
op_plus
l_int|2
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|hostrcb-&gt;hcam.u.raw.data
(braket
id|i
op_plus
l_int|3
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ipr_get_error - Find the specfied IOASC in the ipr_error_table.&n; * @ioasc:&t;IOASC&n; *&n; * This function will return the index of into the ipr_error_table&n; * for the specified IOASC. If the IOASC is not in the table,&n; * 0 will be returned, which points to the entry used for unknown errors.&n; *&n; * Return value:&n; * &t;index into the ipr_error_table&n; **/
DECL|function|ipr_get_error
r_static
id|u32
id|ipr_get_error
c_func
(paren
id|u32
id|ioasc
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|ipr_error_table
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ipr_error_table
(braket
id|i
)braket
dot
id|ioasc
op_eq
id|ioasc
)paren
r_return
id|i
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_handle_log_data - Log an adapter error.&n; * @ioa_cfg:&t;ioa config struct&n; * @hostrcb:&t;hostrcb struct&n; *&n; * This function logs an adapter error to the system.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_handle_log_data
r_static
r_void
id|ipr_handle_log_data
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_hostrcb
op_star
id|hostrcb
)paren
(brace
id|u32
id|ioasc
suffix:semicolon
r_int
id|error_index
suffix:semicolon
r_if
c_cond
(paren
id|hostrcb-&gt;hcam.notify_type
op_ne
id|IPR_HOST_RCB_NOTIF_TYPE_ERROR_LOG_ENTRY
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|hostrcb-&gt;hcam.notifications_lost
op_eq
id|IPR_HOST_RCB_NOTIFICATIONS_LOST
)paren
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Error notifications lost&bslash;n&quot;
)paren
suffix:semicolon
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|hostrcb-&gt;hcam.u.error.failing_dev_ioasc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioasc
op_eq
id|IPR_IOASC_BUS_WAS_RESET
op_logical_or
id|ioasc
op_eq
id|IPR_IOASC_BUS_WAS_RESET_BY_OTHER
)paren
(brace
multiline_comment|/* Tell the midlayer we had a bus reset so it will handle the UA properly */
id|scsi_report_bus_reset
c_func
(paren
id|ioa_cfg-&gt;host
comma
id|hostrcb-&gt;hcam.u.error.failing_dev_res_addr.bus
)paren
suffix:semicolon
)brace
id|error_index
op_assign
id|ipr_get_error
c_func
(paren
id|ioasc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipr_error_table
(braket
id|error_index
)braket
dot
id|log_hcam
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ipr_is_device
c_func
(paren
op_amp
id|hostrcb-&gt;hcam.u.error.failing_dev_res_addr
)paren
)paren
(brace
id|ipr_res_err
c_func
(paren
id|ioa_cfg
comma
id|hostrcb-&gt;hcam.u.error.failing_dev_res_addr
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|ipr_error_table
(braket
id|error_index
)braket
dot
id|error
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|ipr_error_table
(braket
id|error_index
)braket
dot
id|error
)paren
suffix:semicolon
)brace
multiline_comment|/* Set indication we have logged an error */
id|ioa_cfg-&gt;errors_logged
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;log_level
OL
id|IPR_DEFAULT_LOG_LEVEL
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|hostrcb-&gt;hcam.overlay_id
)paren
(brace
r_case
id|IPR_HOST_RCB_OVERLAY_ID_1
suffix:colon
id|ipr_log_generic_error
c_func
(paren
id|ioa_cfg
comma
id|hostrcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPR_HOST_RCB_OVERLAY_ID_2
suffix:colon
id|ipr_log_cache_error
c_func
(paren
id|ioa_cfg
comma
id|hostrcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPR_HOST_RCB_OVERLAY_ID_3
suffix:colon
id|ipr_log_config_error
c_func
(paren
id|ioa_cfg
comma
id|hostrcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPR_HOST_RCB_OVERLAY_ID_4
suffix:colon
r_case
id|IPR_HOST_RCB_OVERLAY_ID_6
suffix:colon
id|ipr_log_array_error
c_func
(paren
id|ioa_cfg
comma
id|hostrcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPR_HOST_RCB_OVERLAY_ID_DEFAULT
suffix:colon
id|ipr_log_generic_error
c_func
(paren
id|ioa_cfg
comma
id|hostrcb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Unknown error received. Overlay ID: %d&bslash;n&quot;
comma
id|hostrcb-&gt;hcam.overlay_id
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ipr_process_error - Op done function for an adapter error log.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function is the op done function for an error log host&n; * controlled async from the adapter. It will log the error and&n; * send the HCAM back to the adapter.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_process_error
r_static
r_void
id|ipr_process_error
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_hostrcb
op_star
id|hostrcb
op_assign
id|ipr_cmd-&gt;u.hostrcb
suffix:semicolon
id|u32
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioasa.ioasc
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|hostrcb-&gt;queue
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioasc
)paren
(brace
id|ipr_handle_log_data
c_func
(paren
id|ioa_cfg
comma
id|hostrcb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioasc
op_ne
id|IPR_IOASC_IOA_WAS_RESET
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Host RCB failed with IOASC: 0x%08X&bslash;n&quot;
comma
id|ioasc
)paren
suffix:semicolon
)brace
id|ipr_send_hcam
c_func
(paren
id|ioa_cfg
comma
id|IPR_HCAM_CDB_OP_CODE_LOG_DATA
comma
id|hostrcb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_timeout -  An internally generated op has timed out.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function blocks host requests and initiates an&n; * adapter reset.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_timeout
r_static
r_void
id|ipr_timeout
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
id|ENTER
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|ioa_cfg-&gt;errors_logged
op_increment
suffix:semicolon
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Adapter being reset due to command timeout.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WAIT_FOR_DUMP
op_eq
id|ioa_cfg-&gt;sdt_state
)paren
id|ioa_cfg-&gt;sdt_state
op_assign
id|GET_DUMP
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;in_reset_reload
op_logical_or
id|ioa_cfg-&gt;reset_cmd
op_eq
id|ipr_cmd
)paren
id|ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|IPR_SHUTDOWN_NONE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_reload - Reset/Reload the IOA&n; * @ioa_cfg:&t;&t;ioa config struct&n; * @shutdown_type:&t;shutdown type&n; *&n; * This function resets the adapter and re-initializes it.&n; * This function assumes that all new host commands have been stopped.&n; * Return value:&n; * &t;SUCCESS / FAILED&n; **/
DECL|function|ipr_reset_reload
r_static
r_int
id|ipr_reset_reload
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_enum
id|ipr_shutdown_type
id|shutdown_type
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;in_reset_reload
)paren
id|ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|shutdown_type
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|ioa_cfg-&gt;reset_wait_q
comma
op_logical_neg
id|ioa_cfg-&gt;in_reset_reload
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/* If we got hit with a host reset while we were already resetting&n;&t; the adapter for some reason, and the reset failed. */
r_if
c_cond
(paren
id|ioa_cfg-&gt;ioa_is_dead
)paren
(brace
id|ipr_trace
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_find_ses_entry - Find matching SES in SES table&n; * @res:&t;resource entry struct of SES&n; *&n; * Return value:&n; * &t;pointer to SES table entry / NULL on failure&n; **/
r_static
r_const
r_struct
id|ipr_ses_table_entry
op_star
DECL|function|ipr_find_ses_entry
id|ipr_find_ses_entry
c_func
(paren
r_struct
id|ipr_resource_entry
op_star
id|res
)paren
(brace
r_int
id|i
comma
id|j
comma
id|matches
suffix:semicolon
r_const
r_struct
id|ipr_ses_table_entry
op_star
id|ste
op_assign
id|ipr_ses_table
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|ipr_ses_table
)paren
suffix:semicolon
id|i
op_increment
comma
id|ste
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|matches
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|IPR_PROD_ID_LEN
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ste-&gt;compare_product_id_byte
(braket
id|j
)braket
op_eq
l_char|&squot;X&squot;
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;cfgte.std_inq_data.vpids.product_id
(braket
id|j
)braket
op_eq
id|ste-&gt;product_id
(braket
id|j
)braket
)paren
id|matches
op_increment
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_else
id|matches
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|matches
op_eq
id|IPR_PROD_ID_LEN
)paren
r_return
id|ste
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_get_max_scsi_speed - Determine max SCSI speed for a given bus&n; * @ioa_cfg:&t;ioa config struct&n; * @bus:&t;&t;SCSI bus&n; * @bus_width:&t;bus width&n; *&n; * Return value:&n; *&t;SCSI bus speed in units of 100KHz, 1600 is 160 MHz&n; *&t;For a 2-byte wide SCSI bus, the maximum transfer speed is&n; *&t;twice the maximum transfer rate (e.g. for a wide enabled bus,&n; *&t;max 160MHz = max 320MB/sec).&n; **/
DECL|function|ipr_get_max_scsi_speed
r_static
id|u32
id|ipr_get_max_scsi_speed
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
id|u8
id|bus
comma
id|u8
id|bus_width
)paren
(brace
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_const
r_struct
id|ipr_ses_table_entry
op_star
id|ste
suffix:semicolon
id|u32
id|max_xfer_rate
op_assign
id|IPR_MAX_SCSI_RATE
c_func
(paren
id|bus_width
)paren
suffix:semicolon
multiline_comment|/* Loop through each config table entry in the config table buffer */
id|list_for_each_entry
c_func
(paren
id|res
comma
op_amp
id|ioa_cfg-&gt;used_res_q
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|IPR_IS_SES_DEVICE
c_func
(paren
id|res-&gt;cfgte.std_inq_data
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|bus
op_ne
id|res-&gt;cfgte.res_addr.bus
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ste
op_assign
id|ipr_find_ses_entry
c_func
(paren
id|res
)paren
)paren
)paren
r_continue
suffix:semicolon
id|max_xfer_rate
op_assign
(paren
id|ste-&gt;max_bus_speed_limit
op_star
l_int|10
)paren
op_div
(paren
id|bus_width
op_div
l_int|8
)paren
suffix:semicolon
)brace
r_return
id|max_xfer_rate
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_wait_iodbg_ack - Wait for an IODEBUG ACK from the IOA&n; * @ioa_cfg:&t;&t;ioa config struct&n; * @max_delay:&t;&t;max delay in micro-seconds to wait&n; *&n; * Waits for an IODEBUG ACK from the IOA, doing busy looping.&n; *&n; * Return value:&n; * &t;0 on success / other on failure&n; **/
DECL|function|ipr_wait_iodbg_ack
r_static
r_int
id|ipr_wait_iodbg_ack
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_int
id|max_delay
)paren
(brace
r_volatile
id|u32
id|pcii_reg
suffix:semicolon
r_int
id|delay
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Read interrupt reg until IOA signals IO Debug Acknowledge */
r_while
c_loop
(paren
id|delay
OL
id|max_delay
)paren
(brace
id|pcii_reg
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;regs.sense_interrupt_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcii_reg
op_amp
id|IPR_PCII_IO_DEBUG_ACKNOWLEDGE
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* udelay cannot be used if delay is more than a few milliseconds */
r_if
c_cond
(paren
(paren
id|delay
op_div
l_int|1000
)paren
OG
id|MAX_UDELAY_MS
)paren
id|mdelay
c_func
(paren
id|delay
op_div
l_int|1000
)paren
suffix:semicolon
r_else
id|udelay
c_func
(paren
id|delay
)paren
suffix:semicolon
id|delay
op_add_assign
id|delay
suffix:semicolon
)brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_get_ldump_data_section - Dump IOA memory&n; * @ioa_cfg:&t;&t;&t;ioa config struct&n; * @start_addr:&t;&t;&t;adapter address to dump&n; * @dest:&t;&t;&t;&t;destination kernel buffer&n; * @length_in_words:&t;length to dump in 4 byte words&n; *&n; * Return value:&n; * &t;0 on success / -EIO on failure&n; **/
DECL|function|ipr_get_ldump_data_section
r_static
r_int
id|ipr_get_ldump_data_section
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
id|u32
id|start_addr
comma
id|u32
op_star
id|dest
comma
id|u32
id|length_in_words
)paren
(brace
r_volatile
id|u32
id|temp_pcii_reg
suffix:semicolon
r_int
id|i
comma
id|delay
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Write IOA interrupt reg starting LDUMP state  */
id|writel
c_func
(paren
(paren
id|IPR_UPROCI_RESET_ALERT
op_or
id|IPR_UPROCI_IO_DEBUG_ALERT
)paren
comma
id|ioa_cfg-&gt;regs.set_uproc_interrupt_reg
)paren
suffix:semicolon
multiline_comment|/* Wait for IO debug acknowledge */
r_if
c_cond
(paren
id|ipr_wait_iodbg_ack
c_func
(paren
id|ioa_cfg
comma
id|IPR_LDUMP_MAX_LONG_ACK_DELAY_IN_USEC
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;IOA dump long data transfer timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Signal LDUMP interlocked - clear IO debug ack */
id|writel
c_func
(paren
id|IPR_PCII_IO_DEBUG_ACKNOWLEDGE
comma
id|ioa_cfg-&gt;regs.clr_interrupt_reg
)paren
suffix:semicolon
multiline_comment|/* Write Mailbox with starting address */
id|writel
c_func
(paren
id|start_addr
comma
id|ioa_cfg-&gt;ioa_mailbox
)paren
suffix:semicolon
multiline_comment|/* Signal address valid - clear IOA Reset alert */
id|writel
c_func
(paren
id|IPR_UPROCI_RESET_ALERT
comma
id|ioa_cfg-&gt;regs.clr_uproc_interrupt_reg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length_in_words
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Wait for IO debug acknowledge */
r_if
c_cond
(paren
id|ipr_wait_iodbg_ack
c_func
(paren
id|ioa_cfg
comma
id|IPR_LDUMP_MAX_SHORT_ACK_DELAY_IN_USEC
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;IOA dump short data transfer timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Read data from mailbox and increment destination pointer */
op_star
id|dest
op_assign
id|cpu_to_be32
c_func
(paren
id|readl
c_func
(paren
id|ioa_cfg-&gt;ioa_mailbox
)paren
)paren
suffix:semicolon
id|dest
op_increment
suffix:semicolon
multiline_comment|/* For all but the last word of data, signal data received */
r_if
c_cond
(paren
id|i
OL
(paren
id|length_in_words
op_minus
l_int|1
)paren
)paren
(brace
multiline_comment|/* Signal dump data received - Clear IO debug Ack */
id|writel
c_func
(paren
id|IPR_PCII_IO_DEBUG_ACKNOWLEDGE
comma
id|ioa_cfg-&gt;regs.clr_interrupt_reg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Signal end of block transfer. Set reset alert then clear IO debug ack */
id|writel
c_func
(paren
id|IPR_UPROCI_RESET_ALERT
comma
id|ioa_cfg-&gt;regs.set_uproc_interrupt_reg
)paren
suffix:semicolon
id|writel
c_func
(paren
id|IPR_UPROCI_IO_DEBUG_ALERT
comma
id|ioa_cfg-&gt;regs.clr_uproc_interrupt_reg
)paren
suffix:semicolon
multiline_comment|/* Signal dump data received - Clear IO debug Ack */
id|writel
c_func
(paren
id|IPR_PCII_IO_DEBUG_ACKNOWLEDGE
comma
id|ioa_cfg-&gt;regs.clr_interrupt_reg
)paren
suffix:semicolon
multiline_comment|/* Wait for IOA to signal LDUMP exit - IOA reset alert will be cleared */
r_while
c_loop
(paren
id|delay
OL
id|IPR_LDUMP_MAX_SHORT_ACK_DELAY_IN_USEC
)paren
(brace
id|temp_pcii_reg
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;regs.sense_uproc_interrupt_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|temp_pcii_reg
op_amp
id|IPR_UPROCI_RESET_ALERT
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|delay
op_add_assign
l_int|10
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SCSI_IPR_DUMP
multiline_comment|/**&n; * ipr_sdt_copy - Copy Smart Dump Table to kernel buffer&n; * @ioa_cfg:&t;&t;ioa config struct&n; * @pci_address:&t;adapter address&n; * @length:&t;&t;&t;length of data to copy&n; *&n; * Copy data from PCI adapter to kernel buffer.&n; * Note: length MUST be a 4 byte multiple&n; * Return value:&n; * &t;0 on success / other on failure&n; **/
DECL|function|ipr_sdt_copy
r_static
r_int
id|ipr_sdt_copy
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_int
r_int
id|pci_address
comma
id|u32
id|length
)paren
(brace
r_int
id|bytes_copied
op_assign
l_int|0
suffix:semicolon
r_int
id|cur_len
comma
id|rc
comma
id|rem_len
comma
id|rem_page_len
suffix:semicolon
id|u32
op_star
id|page
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|ipr_ioa_dump
op_star
id|ioa_dump
op_assign
op_amp
id|ioa_cfg-&gt;dump-&gt;ioa_dump
suffix:semicolon
r_while
c_loop
(paren
id|bytes_copied
OL
id|length
op_logical_and
(paren
id|ioa_dump-&gt;hdr.len
op_plus
id|bytes_copied
)paren
OL
id|IPR_MAX_IOA_DUMP_SIZE
)paren
(brace
r_if
c_cond
(paren
id|ioa_dump-&gt;page_offset
op_ge
id|PAGE_SIZE
op_logical_or
id|ioa_dump-&gt;page_offset
op_eq
l_int|0
)paren
(brace
id|page
op_assign
(paren
id|u32
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
(brace
id|ipr_trace
suffix:semicolon
r_return
id|bytes_copied
suffix:semicolon
)brace
id|ioa_dump-&gt;page_offset
op_assign
l_int|0
suffix:semicolon
id|ioa_dump-&gt;ioa_data
(braket
id|ioa_dump-&gt;next_page_index
)braket
op_assign
id|page
suffix:semicolon
id|ioa_dump-&gt;next_page_index
op_increment
suffix:semicolon
)brace
r_else
id|page
op_assign
id|ioa_dump-&gt;ioa_data
(braket
id|ioa_dump-&gt;next_page_index
op_minus
l_int|1
)braket
suffix:semicolon
id|rem_len
op_assign
id|length
op_minus
id|bytes_copied
suffix:semicolon
id|rem_page_len
op_assign
id|PAGE_SIZE
op_minus
id|ioa_dump-&gt;page_offset
suffix:semicolon
id|cur_len
op_assign
id|min
c_func
(paren
id|rem_len
comma
id|rem_page_len
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;sdt_state
op_eq
id|ABORT_DUMP
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|ipr_get_ldump_data_section
c_func
(paren
id|ioa_cfg
comma
id|pci_address
op_plus
id|bytes_copied
comma
op_amp
id|page
(braket
id|ioa_dump-&gt;page_offset
op_div
l_int|4
)braket
comma
(paren
id|cur_len
op_div
r_sizeof
(paren
id|u32
)paren
)paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|ioa_dump-&gt;page_offset
op_add_assign
id|cur_len
suffix:semicolon
id|bytes_copied
op_add_assign
id|cur_len
suffix:semicolon
)brace
r_else
(brace
id|ipr_trace
suffix:semicolon
r_break
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|bytes_copied
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_init_dump_entry_hdr - Initialize a dump entry header.&n; * @hdr:&t;dump entry header struct&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_init_dump_entry_hdr
r_static
r_void
id|ipr_init_dump_entry_hdr
c_func
(paren
r_struct
id|ipr_dump_entry_header
op_star
id|hdr
)paren
(brace
id|hdr-&gt;eye_catcher
op_assign
id|IPR_DUMP_EYE_CATCHER
suffix:semicolon
id|hdr-&gt;num_elems
op_assign
l_int|1
suffix:semicolon
id|hdr-&gt;offset
op_assign
r_sizeof
(paren
op_star
id|hdr
)paren
suffix:semicolon
id|hdr-&gt;status
op_assign
id|IPR_DUMP_STATUS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_dump_ioa_type_data - Fill in the adapter type in the dump.&n; * @ioa_cfg:&t;ioa config struct&n; * @driver_dump:&t;driver dump struct&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_dump_ioa_type_data
r_static
r_void
id|ipr_dump_ioa_type_data
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_driver_dump
op_star
id|driver_dump
)paren
(brace
r_struct
id|ipr_inquiry_page3
op_star
id|ucode_vpd
op_assign
op_amp
id|ioa_cfg-&gt;vpd_cbs-&gt;page3_data
suffix:semicolon
id|ipr_init_dump_entry_hdr
c_func
(paren
op_amp
id|driver_dump-&gt;ioa_type_entry.hdr
)paren
suffix:semicolon
id|driver_dump-&gt;ioa_type_entry.hdr.len
op_assign
r_sizeof
(paren
r_struct
id|ipr_dump_ioa_type_entry
)paren
op_minus
r_sizeof
(paren
r_struct
id|ipr_dump_entry_header
)paren
suffix:semicolon
id|driver_dump-&gt;ioa_type_entry.hdr.data_type
op_assign
id|IPR_DUMP_DATA_TYPE_BINARY
suffix:semicolon
id|driver_dump-&gt;ioa_type_entry.hdr.id
op_assign
id|IPR_DUMP_DRIVER_TYPE_ID
suffix:semicolon
id|driver_dump-&gt;ioa_type_entry.type
op_assign
id|ioa_cfg-&gt;type
suffix:semicolon
id|driver_dump-&gt;ioa_type_entry.fw_version
op_assign
(paren
id|ucode_vpd-&gt;major_release
op_lshift
l_int|24
)paren
op_or
(paren
id|ucode_vpd-&gt;card_type
op_lshift
l_int|16
)paren
op_or
(paren
id|ucode_vpd-&gt;minor_release
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|ucode_vpd-&gt;minor_release
(braket
l_int|1
)braket
suffix:semicolon
id|driver_dump-&gt;hdr.num_entries
op_increment
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_dump_version_data - Fill in the driver version in the dump.&n; * @ioa_cfg:&t;ioa config struct&n; * @driver_dump:&t;driver dump struct&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_dump_version_data
r_static
r_void
id|ipr_dump_version_data
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_driver_dump
op_star
id|driver_dump
)paren
(brace
id|ipr_init_dump_entry_hdr
c_func
(paren
op_amp
id|driver_dump-&gt;version_entry.hdr
)paren
suffix:semicolon
id|driver_dump-&gt;version_entry.hdr.len
op_assign
r_sizeof
(paren
r_struct
id|ipr_dump_version_entry
)paren
op_minus
r_sizeof
(paren
r_struct
id|ipr_dump_entry_header
)paren
suffix:semicolon
id|driver_dump-&gt;version_entry.hdr.data_type
op_assign
id|IPR_DUMP_DATA_TYPE_ASCII
suffix:semicolon
id|driver_dump-&gt;version_entry.hdr.id
op_assign
id|IPR_DUMP_DRIVER_VERSION_ID
suffix:semicolon
id|strcpy
c_func
(paren
id|driver_dump-&gt;version_entry.version
comma
id|IPR_DRIVER_VERSION
)paren
suffix:semicolon
id|driver_dump-&gt;hdr.num_entries
op_increment
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_dump_trace_data - Fill in the IOA trace in the dump.&n; * @ioa_cfg:&t;ioa config struct&n; * @driver_dump:&t;driver dump struct&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_dump_trace_data
r_static
r_void
id|ipr_dump_trace_data
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_driver_dump
op_star
id|driver_dump
)paren
(brace
id|ipr_init_dump_entry_hdr
c_func
(paren
op_amp
id|driver_dump-&gt;trace_entry.hdr
)paren
suffix:semicolon
id|driver_dump-&gt;trace_entry.hdr.len
op_assign
r_sizeof
(paren
r_struct
id|ipr_dump_trace_entry
)paren
op_minus
r_sizeof
(paren
r_struct
id|ipr_dump_entry_header
)paren
suffix:semicolon
id|driver_dump-&gt;trace_entry.hdr.data_type
op_assign
id|IPR_DUMP_DATA_TYPE_BINARY
suffix:semicolon
id|driver_dump-&gt;trace_entry.hdr.id
op_assign
id|IPR_DUMP_TRACE_ID
suffix:semicolon
id|memcpy
c_func
(paren
id|driver_dump-&gt;trace_entry.trace
comma
id|ioa_cfg-&gt;trace
comma
id|IPR_TRACE_SIZE
)paren
suffix:semicolon
id|driver_dump-&gt;hdr.num_entries
op_increment
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_dump_location_data - Fill in the IOA location in the dump.&n; * @ioa_cfg:&t;ioa config struct&n; * @driver_dump:&t;driver dump struct&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_dump_location_data
r_static
r_void
id|ipr_dump_location_data
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_driver_dump
op_star
id|driver_dump
)paren
(brace
id|ipr_init_dump_entry_hdr
c_func
(paren
op_amp
id|driver_dump-&gt;location_entry.hdr
)paren
suffix:semicolon
id|driver_dump-&gt;location_entry.hdr.len
op_assign
r_sizeof
(paren
r_struct
id|ipr_dump_location_entry
)paren
op_minus
r_sizeof
(paren
r_struct
id|ipr_dump_entry_header
)paren
suffix:semicolon
id|driver_dump-&gt;location_entry.hdr.data_type
op_assign
id|IPR_DUMP_DATA_TYPE_ASCII
suffix:semicolon
id|driver_dump-&gt;location_entry.hdr.id
op_assign
id|IPR_DUMP_LOCATION_ID
suffix:semicolon
id|strcpy
c_func
(paren
id|driver_dump-&gt;location_entry.location
comma
id|ioa_cfg-&gt;pdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|driver_dump-&gt;hdr.num_entries
op_increment
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_get_ioa_dump - Perform a dump of the driver and adapter.&n; * @ioa_cfg:&t;ioa config struct&n; * @dump:&t;&t;dump struct&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_get_ioa_dump
r_static
r_void
id|ipr_get_ioa_dump
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_dump
op_star
id|dump
)paren
(brace
r_int
r_int
id|start_addr
comma
id|sdt_word
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|ipr_driver_dump
op_star
id|driver_dump
op_assign
op_amp
id|dump-&gt;driver_dump
suffix:semicolon
r_struct
id|ipr_ioa_dump
op_star
id|ioa_dump
op_assign
op_amp
id|dump-&gt;ioa_dump
suffix:semicolon
id|u32
id|num_entries
comma
id|start_off
comma
id|end_off
suffix:semicolon
id|u32
id|bytes_to_copy
comma
id|bytes_copied
comma
id|rc
suffix:semicolon
r_struct
id|ipr_sdt
op_star
id|sdt
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ENTER
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;sdt_state
op_ne
id|GET_DUMP
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|start_addr
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;ioa_mailbox
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipr_sdt_is_fmt2
c_func
(paren
id|start_addr
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Invalid dump table format: %lx&bslash;n&quot;
comma
id|start_addr
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Dump of IOA initiated&bslash;n&quot;
)paren
suffix:semicolon
id|driver_dump-&gt;hdr.eye_catcher
op_assign
id|IPR_DUMP_EYE_CATCHER
suffix:semicolon
multiline_comment|/* Initialize the overall dump header */
id|driver_dump-&gt;hdr.len
op_assign
r_sizeof
(paren
r_struct
id|ipr_driver_dump
)paren
suffix:semicolon
id|driver_dump-&gt;hdr.num_entries
op_assign
l_int|1
suffix:semicolon
id|driver_dump-&gt;hdr.first_entry_offset
op_assign
r_sizeof
(paren
r_struct
id|ipr_dump_header
)paren
suffix:semicolon
id|driver_dump-&gt;hdr.status
op_assign
id|IPR_DUMP_STATUS_SUCCESS
suffix:semicolon
id|driver_dump-&gt;hdr.os
op_assign
id|IPR_DUMP_OS_LINUX
suffix:semicolon
id|driver_dump-&gt;hdr.driver_name
op_assign
id|IPR_DUMP_DRIVER_NAME
suffix:semicolon
id|ipr_dump_version_data
c_func
(paren
id|ioa_cfg
comma
id|driver_dump
)paren
suffix:semicolon
id|ipr_dump_location_data
c_func
(paren
id|ioa_cfg
comma
id|driver_dump
)paren
suffix:semicolon
id|ipr_dump_ioa_type_data
c_func
(paren
id|ioa_cfg
comma
id|driver_dump
)paren
suffix:semicolon
id|ipr_dump_trace_data
c_func
(paren
id|ioa_cfg
comma
id|driver_dump
)paren
suffix:semicolon
multiline_comment|/* Update dump_header */
id|driver_dump-&gt;hdr.len
op_add_assign
r_sizeof
(paren
r_struct
id|ipr_dump_entry_header
)paren
suffix:semicolon
multiline_comment|/* IOA Dump entry */
id|ipr_init_dump_entry_hdr
c_func
(paren
op_amp
id|ioa_dump-&gt;hdr
)paren
suffix:semicolon
id|ioa_dump-&gt;format
op_assign
id|IPR_SDT_FMT2
suffix:semicolon
id|ioa_dump-&gt;hdr.len
op_assign
l_int|0
suffix:semicolon
id|ioa_dump-&gt;hdr.data_type
op_assign
id|IPR_DUMP_DATA_TYPE_BINARY
suffix:semicolon
id|ioa_dump-&gt;hdr.id
op_assign
id|IPR_DUMP_IOA_DUMP_ID
suffix:semicolon
multiline_comment|/* First entries in sdt are actually a list of dump addresses and&n;&t; lengths to gather the real dump data.  sdt represents the pointer&n;&t; to the ioa generated dump table.  Dump data will be extracted based&n;&t; on entries in this table */
id|sdt
op_assign
op_amp
id|ioa_dump-&gt;sdt
suffix:semicolon
id|rc
op_assign
id|ipr_get_ldump_data_section
c_func
(paren
id|ioa_cfg
comma
id|start_addr
comma
(paren
id|u32
op_star
)paren
id|sdt
comma
r_sizeof
(paren
r_struct
id|ipr_sdt
)paren
op_div
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* Smart Dump table is ready to use and the first entry is valid */
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|be32_to_cpu
c_func
(paren
id|sdt-&gt;hdr.state
)paren
op_ne
id|IPR_FMT2_SDT_READY_TO_USE
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Dump of IOA failed. Dump table not valid: %d, %X.&bslash;n&quot;
comma
id|rc
comma
id|be32_to_cpu
c_func
(paren
id|sdt-&gt;hdr.state
)paren
)paren
suffix:semicolon
id|driver_dump-&gt;hdr.status
op_assign
id|IPR_DUMP_STATUS_FAILED
suffix:semicolon
id|ioa_cfg-&gt;sdt_state
op_assign
id|DUMP_OBTAINED
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|num_entries
op_assign
id|be32_to_cpu
c_func
(paren
id|sdt-&gt;hdr.num_entries_used
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_entries
OG
id|IPR_NUM_SDT_ENTRIES
)paren
id|num_entries
op_assign
id|IPR_NUM_SDT_ENTRIES
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_entries
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ioa_dump-&gt;hdr.len
OG
id|IPR_MAX_IOA_DUMP_SIZE
)paren
(brace
id|driver_dump-&gt;hdr.status
op_assign
id|IPR_DUMP_STATUS_QUAL_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sdt-&gt;entry
(braket
id|i
)braket
dot
id|flags
op_amp
id|IPR_SDT_VALID_ENTRY
)paren
(brace
id|sdt_word
op_assign
id|be32_to_cpu
c_func
(paren
id|sdt-&gt;entry
(braket
id|i
)braket
dot
id|bar_str_offset
)paren
suffix:semicolon
id|start_off
op_assign
id|sdt_word
op_amp
id|IPR_FMT2_MBX_ADDR_MASK
suffix:semicolon
id|end_off
op_assign
id|be32_to_cpu
c_func
(paren
id|sdt-&gt;entry
(braket
id|i
)braket
dot
id|end_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipr_sdt_is_fmt2
c_func
(paren
id|sdt_word
)paren
op_logical_and
id|sdt_word
)paren
(brace
id|bytes_to_copy
op_assign
id|end_off
op_minus
id|start_off
suffix:semicolon
r_if
c_cond
(paren
id|bytes_to_copy
OG
id|IPR_MAX_IOA_DUMP_SIZE
)paren
(brace
id|sdt-&gt;entry
(braket
id|i
)braket
dot
id|flags
op_and_assign
op_complement
id|IPR_SDT_VALID_ENTRY
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Copy data from adapter to driver buffers */
id|bytes_copied
op_assign
id|ipr_sdt_copy
c_func
(paren
id|ioa_cfg
comma
id|sdt_word
comma
id|bytes_to_copy
)paren
suffix:semicolon
id|ioa_dump-&gt;hdr.len
op_add_assign
id|bytes_copied
suffix:semicolon
r_if
c_cond
(paren
id|bytes_copied
op_ne
id|bytes_to_copy
)paren
(brace
id|driver_dump-&gt;hdr.status
op_assign
id|IPR_DUMP_STATUS_QUAL_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Dump of IOA completed.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Update dump_header */
id|driver_dump-&gt;hdr.len
op_add_assign
id|ioa_dump-&gt;hdr.len
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|ioa_cfg-&gt;sdt_state
op_assign
id|DUMP_OBTAINED
suffix:semicolon
id|LEAVE
suffix:semicolon
)brace
macro_line|#else
DECL|macro|ipr_get_ioa_dump
mdefine_line|#define ipr_get_ioa_dump(ioa_cfg, dump) do { } while(0)
macro_line|#endif
multiline_comment|/**&n; * ipr_worker_thread - Worker thread&n; * @data:&t;&t;ioa config struct&n; *&n; * Called at task level from a work thread. This function takes care&n; * of adding and removing device from the mid-layer as configuration&n; * changes are detected by the adapter.&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_worker_thread
r_static
r_void
id|ipr_worker_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|lock_flags
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_struct
id|scsi_device
op_star
id|sdev
suffix:semicolon
r_struct
id|ipr_dump
op_star
id|dump
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|data
suffix:semicolon
id|u8
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
r_int
id|did_work
suffix:semicolon
id|ENTER
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;sdt_state
op_eq
id|GET_DUMP
)paren
(brace
id|dump
op_assign
id|ioa_cfg-&gt;dump
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dump
op_logical_or
op_logical_neg
id|kobject_get
c_func
(paren
op_amp
id|dump-&gt;kobj
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|ipr_get_ioa_dump
c_func
(paren
id|ioa_cfg
comma
id|dump
)paren
suffix:semicolon
id|kobject_put
c_func
(paren
op_amp
id|dump-&gt;kobj
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;sdt_state
op_eq
id|DUMP_OBTAINED
)paren
id|ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|IPR_SHUTDOWN_NONE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|restart
suffix:colon
r_do
(brace
id|did_work
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;allow_cmds
op_logical_or
op_logical_neg
id|ioa_cfg-&gt;allow_ml_add_del
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|list_for_each_entry
c_func
(paren
id|res
comma
op_amp
id|ioa_cfg-&gt;used_res_q
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;del_from_ml
op_logical_and
id|res-&gt;sdev
)paren
(brace
id|did_work
op_assign
l_int|1
suffix:semicolon
id|sdev
op_assign
id|res-&gt;sdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_device_get
c_func
(paren
id|sdev
)paren
)paren
(brace
id|res-&gt;sdev
op_assign
l_int|NULL
suffix:semicolon
id|list_move_tail
c_func
(paren
op_amp
id|res-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_res_q
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|scsi_remove_device
c_func
(paren
id|sdev
)paren
suffix:semicolon
id|scsi_device_put
c_func
(paren
id|sdev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|did_work
)paren
(brace
suffix:semicolon
)brace
id|list_for_each_entry
c_func
(paren
id|res
comma
op_amp
id|ioa_cfg-&gt;used_res_q
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;add_to_ml
)paren
(brace
id|bus
op_assign
id|res-&gt;cfgte.res_addr.bus
suffix:semicolon
id|target
op_assign
id|res-&gt;cfgte.res_addr.target
suffix:semicolon
id|lun
op_assign
id|res-&gt;cfgte.res_addr.lun
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|scsi_add_device
c_func
(paren
id|ioa_cfg-&gt;host
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SCSI_IPR_TRACE
multiline_comment|/**&n; * ipr_read_trace - Dump the adapter trace&n; * @kobj:&t;&t;kobject struct&n; * @buf:&t;&t;buffer&n; * @off:&t;&t;offset&n; * @count:&t;&t;buffer size&n; *&n; * Return value:&n; *&t;number of bytes printed to buffer&n; **/
DECL|function|ipr_read_trace
r_static
id|ssize_t
id|ipr_read_trace
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|buf
comma
id|loff_t
id|off
comma
r_int
id|count
)paren
(brace
r_struct
id|class_device
op_star
id|cdev
op_assign
id|container_of
c_func
(paren
id|kobj
comma
r_struct
id|class_device
comma
id|kobj
)paren
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
r_int
id|size
op_assign
id|IPR_TRACE_SIZE
suffix:semicolon
r_char
op_star
id|src
op_assign
(paren
r_char
op_star
)paren
id|ioa_cfg-&gt;trace
suffix:semicolon
r_if
c_cond
(paren
id|off
OG
id|size
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|off
op_plus
id|count
OG
id|size
)paren
(brace
id|size
op_sub_assign
id|off
suffix:semicolon
id|count
op_assign
id|size
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
op_amp
id|src
(braket
id|off
)braket
comma
id|count
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|variable|ipr_trace_attr
r_static
r_struct
id|bin_attribute
id|ipr_trace_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;trace&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
)brace
comma
dot
id|size
op_assign
l_int|0
comma
dot
id|read
op_assign
id|ipr_read_trace
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/**&n; * ipr_show_fw_version - Show the firmware version&n; * @class_dev:&t;class device struct&n; * @buf:&t;&t;buffer&n; *&n; * Return value:&n; *&t;number of bytes printed to buffer&n; **/
DECL|function|ipr_show_fw_version
r_static
id|ssize_t
id|ipr_show_fw_version
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_inquiry_page3
op_star
id|ucode_vpd
op_assign
op_amp
id|ioa_cfg-&gt;vpd_cbs-&gt;page3_data
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|len
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%02X%02X%02X%02X&bslash;n&quot;
comma
id|ucode_vpd-&gt;major_release
comma
id|ucode_vpd-&gt;card_type
comma
id|ucode_vpd-&gt;minor_release
(braket
l_int|0
)braket
comma
id|ucode_vpd-&gt;minor_release
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|ipr_fw_version_attr
r_static
r_struct
id|class_device_attribute
id|ipr_fw_version_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;fw_version&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
)brace
comma
dot
id|show
op_assign
id|ipr_show_fw_version
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * ipr_show_log_level - Show the adapter&squot;s error logging level&n; * @class_dev:&t;class device struct&n; * @buf:&t;&t;buffer&n; *&n; * Return value:&n; * &t;number of bytes printed to buffer&n; **/
DECL|function|ipr_show_log_level
r_static
id|ssize_t
id|ipr_show_log_level
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|len
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|ioa_cfg-&gt;log_level
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_store_log_level - Change the adapter&squot;s error logging level&n; * @class_dev:&t;class device struct&n; * @buf:&t;&t;buffer&n; *&n; * Return value:&n; * &t;number of bytes printed to buffer&n; **/
DECL|function|ipr_store_log_level
r_static
id|ssize_t
id|ipr_store_log_level
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|ioa_cfg-&gt;log_level
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|strlen
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
DECL|variable|ipr_log_level_attr
r_static
r_struct
id|class_device_attribute
id|ipr_log_level_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;log_level&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
op_or
id|S_IWUSR
comma
)brace
comma
dot
id|show
op_assign
id|ipr_show_log_level
comma
dot
id|store
op_assign
id|ipr_store_log_level
)brace
suffix:semicolon
multiline_comment|/**&n; * ipr_store_diagnostics - IOA Diagnostics interface&n; * @class_dev:&t;class_device struct&n; * @buf:&t;&t;buffer&n; * @count:&t;&t;buffer size&n; *&n; * This function will reset the adapter and wait a reasonable&n; * amount of time for any errors that the adapter might log.&n; *&n; * Return value:&n; * &t;count on success / other on failure&n; **/
DECL|function|ipr_store_diagnostics
r_static
id|ssize_t
id|ipr_store_diagnostics
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|wait_event
c_func
(paren
id|ioa_cfg-&gt;reset_wait_q
comma
op_logical_neg
id|ioa_cfg-&gt;in_reset_reload
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|ioa_cfg-&gt;errors_logged
op_assign
l_int|0
suffix:semicolon
id|ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|IPR_SHUTDOWN_NORMAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;in_reset_reload
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|ioa_cfg-&gt;reset_wait_q
comma
op_logical_neg
id|ioa_cfg-&gt;in_reset_reload
)paren
suffix:semicolon
multiline_comment|/* Wait for a second for any errors to be logged */
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;in_reset_reload
op_logical_or
id|ioa_cfg-&gt;errors_logged
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|ipr_diagnostics_attr
r_static
r_struct
id|class_device_attribute
id|ipr_diagnostics_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;run_diagnostics&quot;
comma
dot
id|mode
op_assign
id|S_IWUSR
comma
)brace
comma
dot
id|store
op_assign
id|ipr_store_diagnostics
)brace
suffix:semicolon
multiline_comment|/**&n; * ipr_store_reset_adapter - Reset the adapter&n; * @class_dev:&t;class_device struct&n; * @buf:&t;&t;buffer&n; * @count:&t;&t;buffer size&n; *&n; * This function will reset the adapter.&n; *&n; * Return value:&n; * &t;count on success / other on failure&n; **/
DECL|function|ipr_store_reset_adapter
r_static
id|ssize_t
id|ipr_store_reset_adapter
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_int
id|result
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;in_reset_reload
)paren
id|ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|IPR_SHUTDOWN_NORMAL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|ioa_cfg-&gt;reset_wait_q
comma
op_logical_neg
id|ioa_cfg-&gt;in_reset_reload
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|variable|ipr_ioa_reset_attr
r_static
r_struct
id|class_device_attribute
id|ipr_ioa_reset_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;reset_host&quot;
comma
dot
id|mode
op_assign
id|S_IWUSR
comma
)brace
comma
dot
id|store
op_assign
id|ipr_store_reset_adapter
)brace
suffix:semicolon
multiline_comment|/**&n; * ipr_alloc_ucode_buffer - Allocates a microcode download buffer&n; * @buf_len:&t;&t;buffer length&n; *&n; * Allocates a DMA&squot;able buffer in chunks and assembles a scatter/gather&n; * list to use for microcode download&n; *&n; * Return value:&n; * &t;pointer to sglist / NULL on failure&n; **/
DECL|function|ipr_alloc_ucode_buffer
r_static
r_struct
id|ipr_sglist
op_star
id|ipr_alloc_ucode_buffer
c_func
(paren
r_int
id|buf_len
)paren
(brace
r_int
id|sg_size
comma
id|order
comma
id|bsize_elem
comma
id|num_elem
comma
id|i
comma
id|j
suffix:semicolon
r_struct
id|ipr_sglist
op_star
id|sglist
suffix:semicolon
r_struct
id|scatterlist
op_star
id|scatterlist
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
multiline_comment|/* Get the minimum size per scatter/gather element */
id|sg_size
op_assign
id|buf_len
op_div
(paren
id|IPR_MAX_SGLIST
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Get the actual size per element */
id|order
op_assign
id|get_order
c_func
(paren
id|sg_size
)paren
suffix:semicolon
multiline_comment|/* Determine the actual number of bytes per element */
id|bsize_elem
op_assign
id|PAGE_SIZE
op_star
(paren
l_int|1
op_lshift
id|order
)paren
suffix:semicolon
multiline_comment|/* Determine the actual number of sg entries needed */
r_if
c_cond
(paren
id|buf_len
op_mod
id|bsize_elem
)paren
id|num_elem
op_assign
(paren
id|buf_len
op_div
id|bsize_elem
)paren
op_plus
l_int|1
suffix:semicolon
r_else
id|num_elem
op_assign
id|buf_len
op_div
id|bsize_elem
suffix:semicolon
multiline_comment|/* Allocate a scatter/gather list for the DMA */
id|sglist
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_sglist
)paren
op_plus
(paren
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_star
(paren
id|num_elem
op_minus
l_int|1
)paren
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sglist
op_eq
l_int|NULL
)paren
(brace
id|ipr_trace
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sglist
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ipr_sglist
)paren
op_plus
(paren
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_star
(paren
id|num_elem
op_minus
l_int|1
)paren
)paren
)paren
suffix:semicolon
id|scatterlist
op_assign
id|sglist-&gt;scatterlist
suffix:semicolon
id|sglist-&gt;order
op_assign
id|order
suffix:semicolon
id|sglist-&gt;num_sg
op_assign
id|num_elem
suffix:semicolon
multiline_comment|/* Allocate a bunch of sg elements */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_elem
suffix:semicolon
id|i
op_increment
)paren
(brace
id|page
op_assign
id|alloc_pages
c_func
(paren
id|GFP_KERNEL
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
(brace
id|ipr_trace
suffix:semicolon
multiline_comment|/* Free up what we already allocated */
r_for
c_loop
(paren
id|j
op_assign
id|i
op_minus
l_int|1
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
id|__free_pages
c_func
(paren
id|scatterlist
(braket
id|j
)braket
dot
id|page
comma
id|order
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sglist
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|scatterlist
(braket
id|i
)braket
dot
id|page
op_assign
id|page
suffix:semicolon
)brace
r_return
id|sglist
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_free_ucode_buffer - Frees a microcode download buffer&n; * @p_dnld:&t;&t;scatter/gather list pointer&n; *&n; * Free a DMA&squot;able ucode download buffer previously allocated with&n; * ipr_alloc_ucode_buffer&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_free_ucode_buffer
r_static
r_void
id|ipr_free_ucode_buffer
c_func
(paren
r_struct
id|ipr_sglist
op_star
id|sglist
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sglist-&gt;num_sg
suffix:semicolon
id|i
op_increment
)paren
id|__free_pages
c_func
(paren
id|sglist-&gt;scatterlist
(braket
id|i
)braket
dot
id|page
comma
id|sglist-&gt;order
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sglist
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_copy_ucode_buffer - Copy user buffer to kernel buffer&n; * @sglist:&t;&t;scatter/gather list pointer&n; * @buffer:&t;&t;buffer pointer&n; * @len:&t;&t;buffer length&n; *&n; * Copy a microcode image from a user buffer into a buffer allocated by&n; * ipr_alloc_ucode_buffer&n; *&n; * Return value:&n; * &t;0 on success / other on failure&n; **/
DECL|function|ipr_copy_ucode_buffer
r_static
r_int
id|ipr_copy_ucode_buffer
c_func
(paren
r_struct
id|ipr_sglist
op_star
id|sglist
comma
id|u8
op_star
id|buffer
comma
id|u32
id|len
)paren
(brace
r_int
id|bsize_elem
comma
id|i
comma
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|scatterlist
op_star
id|scatterlist
suffix:semicolon
r_void
op_star
id|kaddr
suffix:semicolon
multiline_comment|/* Determine the actual number of bytes per element */
id|bsize_elem
op_assign
id|PAGE_SIZE
op_star
(paren
l_int|1
op_lshift
id|sglist-&gt;order
)paren
suffix:semicolon
id|scatterlist
op_assign
id|sglist-&gt;scatterlist
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|len
op_div
id|bsize_elem
)paren
suffix:semicolon
id|i
op_increment
comma
id|buffer
op_add_assign
id|bsize_elem
)paren
(brace
id|kaddr
op_assign
id|kmap
c_func
(paren
id|scatterlist
(braket
id|i
)braket
dot
id|page
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|kaddr
comma
id|buffer
comma
id|bsize_elem
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|scatterlist
(braket
id|i
)braket
dot
id|page
)paren
suffix:semicolon
id|scatterlist
(braket
id|i
)braket
dot
id|length
op_assign
id|bsize_elem
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
)paren
(brace
id|ipr_trace
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|len
op_mod
id|bsize_elem
)paren
(brace
id|kaddr
op_assign
id|kmap
c_func
(paren
id|scatterlist
(braket
id|i
)braket
dot
id|page
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|kaddr
comma
id|buffer
comma
id|len
op_mod
id|bsize_elem
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|scatterlist
(braket
id|i
)braket
dot
id|page
)paren
suffix:semicolon
id|scatterlist
(braket
id|i
)braket
dot
id|length
op_assign
id|len
op_mod
id|bsize_elem
suffix:semicolon
)brace
id|sglist-&gt;buffer_len
op_assign
id|len
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_map_ucode_buffer - Map a microcode download buffer&n; * @ipr_cmd:&t;ipr command struct&n; * @sglist:&t;&t;scatter/gather list&n; * @len:&t;&t;total length of download buffer&n; *&n; * Maps a microcode download scatter/gather list for DMA and&n; * builds the IOADL.&n; *&n; * Return value:&n; * &t;0 on success / -EIO on failure&n; **/
DECL|function|ipr_map_ucode_buffer
r_static
r_int
id|ipr_map_ucode_buffer
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
comma
r_struct
id|ipr_sglist
op_star
id|sglist
comma
r_int
id|len
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
r_struct
id|ipr_ioadl_desc
op_star
id|ioadl
op_assign
id|ipr_cmd-&gt;ioadl
suffix:semicolon
r_struct
id|scatterlist
op_star
id|scatterlist
op_assign
id|sglist-&gt;scatterlist
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ipr_cmd-&gt;dma_use_sg
op_assign
id|pci_map_sg
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|scatterlist
comma
id|sglist-&gt;num_sg
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.flags_hi
op_or_assign
id|IPR_FLAGS_HI_WRITE_NOT_READ
suffix:semicolon
id|ioarcb-&gt;write_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
id|len
)paren
suffix:semicolon
id|ioarcb-&gt;write_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
op_star
id|ipr_cmd-&gt;dma_use_sg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ipr_cmd-&gt;dma_use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ioadl
(braket
id|i
)braket
dot
id|flags_and_data_len
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOADL_FLAGS_WRITE
op_or
id|sg_dma_len
c_func
(paren
op_amp
id|scatterlist
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|ioadl
(braket
id|i
)braket
dot
id|address
op_assign
id|cpu_to_be32
c_func
(paren
id|sg_dma_address
c_func
(paren
op_amp
id|scatterlist
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|likely
c_func
(paren
id|ipr_cmd-&gt;dma_use_sg
)paren
)paren
(brace
id|ioadl
(braket
id|i
op_minus
l_int|1
)braket
dot
id|flags_and_data_len
op_or_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOADL_FLAGS_LAST
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;pci_map_sg failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_store_update_fw - Update the firmware on the adapter&n; * @class_dev:&t;class_device struct&n; * @buf:&t;&t;buffer&n; * @count:&t;&t;buffer size&n; *&n; * This function will update the firmware on the adapter.&n; *&n; * Return value:&n; * &t;count on success / other on failure&n; **/
DECL|function|ipr_store_update_fw
r_static
id|ssize_t
id|ipr_store_update_fw
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_ucode_image_header
op_star
id|image_hdr
suffix:semicolon
r_const
r_struct
id|firmware
op_star
id|fw_entry
suffix:semicolon
r_struct
id|ipr_sglist
op_star
id|sglist
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_char
id|fname
(braket
l_int|100
)braket
suffix:semicolon
r_char
op_star
id|src
suffix:semicolon
r_int
id|len
comma
id|result
comma
id|dnld_size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|len
op_assign
id|snprintf
c_func
(paren
id|fname
comma
l_int|99
comma
l_string|&quot;%s&quot;
comma
id|buf
)paren
suffix:semicolon
id|fname
(braket
id|len
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|request_firmware
c_func
(paren
op_amp
id|fw_entry
comma
id|fname
comma
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Firmware file %s not found&bslash;n&quot;
comma
id|fname
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|image_hdr
op_assign
(paren
r_struct
id|ipr_ucode_image_header
op_star
)paren
id|fw_entry-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|be32_to_cpu
c_func
(paren
id|image_hdr-&gt;header_length
)paren
OG
id|fw_entry-&gt;size
op_logical_or
(paren
id|ioa_cfg-&gt;vpd_cbs-&gt;page3_data.card_type
op_logical_and
id|ioa_cfg-&gt;vpd_cbs-&gt;page3_data.card_type
op_ne
id|image_hdr-&gt;card_type
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Invalid microcode buffer&bslash;n&quot;
)paren
suffix:semicolon
id|release_firmware
c_func
(paren
id|fw_entry
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|src
op_assign
(paren
id|u8
op_star
)paren
id|image_hdr
op_plus
id|be32_to_cpu
c_func
(paren
id|image_hdr-&gt;header_length
)paren
suffix:semicolon
id|dnld_size
op_assign
id|fw_entry-&gt;size
op_minus
id|be32_to_cpu
c_func
(paren
id|image_hdr-&gt;header_length
)paren
suffix:semicolon
id|sglist
op_assign
id|ipr_alloc_ucode_buffer
c_func
(paren
id|dnld_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sglist
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Microcode buffer allocation failed&bslash;n&quot;
)paren
suffix:semicolon
id|release_firmware
c_func
(paren
id|fw_entry
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|result
op_assign
id|ipr_copy_ucode_buffer
c_func
(paren
id|sglist
comma
id|src
comma
id|dnld_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Microcode buffer copy to DMA buffer failed&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_free_ucode_buffer
c_func
(paren
id|sglist
)paren
suffix:semicolon
id|release_firmware
c_func
(paren
id|fw_entry
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;ucode_sglist
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Microcode download already in progress&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_free_ucode_buffer
c_func
(paren
id|sglist
)paren
suffix:semicolon
id|release_firmware
c_func
(paren
id|fw_entry
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|ioa_cfg-&gt;ucode_sglist
op_assign
id|sglist
suffix:semicolon
id|ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|IPR_SHUTDOWN_NORMAL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|ioa_cfg-&gt;reset_wait_q
comma
op_logical_neg
id|ioa_cfg-&gt;in_reset_reload
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|ioa_cfg-&gt;ucode_sglist
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|ipr_free_ucode_buffer
c_func
(paren
id|sglist
)paren
suffix:semicolon
id|release_firmware
c_func
(paren
id|fw_entry
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|variable|ipr_update_fw_attr
r_static
r_struct
id|class_device_attribute
id|ipr_update_fw_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;update_fw&quot;
comma
dot
id|mode
op_assign
id|S_IWUSR
comma
)brace
comma
dot
id|store
op_assign
id|ipr_store_update_fw
)brace
suffix:semicolon
DECL|variable|ipr_ioa_attrs
r_static
r_struct
id|class_device_attribute
op_star
id|ipr_ioa_attrs
(braket
)braket
op_assign
(brace
op_amp
id|ipr_fw_version_attr
comma
op_amp
id|ipr_log_level_attr
comma
op_amp
id|ipr_diagnostics_attr
comma
op_amp
id|ipr_ioa_reset_attr
comma
op_amp
id|ipr_update_fw_attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_SCSI_IPR_DUMP
multiline_comment|/**&n; * ipr_read_dump - Dump the adapter&n; * @kobj:&t;&t;kobject struct&n; * @buf:&t;&t;buffer&n; * @off:&t;&t;offset&n; * @count:&t;&t;buffer size&n; *&n; * Return value:&n; *&t;number of bytes printed to buffer&n; **/
DECL|function|ipr_read_dump
r_static
id|ssize_t
id|ipr_read_dump
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|buf
comma
id|loff_t
id|off
comma
r_int
id|count
)paren
(brace
r_struct
id|class_device
op_star
id|cdev
op_assign
id|container_of
c_func
(paren
id|kobj
comma
r_struct
id|class_device
comma
id|kobj
)paren
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_dump
op_star
id|dump
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|src
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|rc
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|dump
op_assign
id|ioa_cfg-&gt;dump
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;sdt_state
op_ne
id|DUMP_OBTAINED
op_logical_or
op_logical_neg
id|dump
op_logical_or
op_logical_neg
id|kobject_get
c_func
(paren
op_amp
id|dump-&gt;kobj
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|off
OG
id|dump-&gt;driver_dump.hdr.len
)paren
(brace
id|kobject_put
c_func
(paren
op_amp
id|dump-&gt;kobj
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|off
op_plus
id|count
OG
id|dump-&gt;driver_dump.hdr.len
)paren
(brace
id|count
op_assign
id|dump-&gt;driver_dump.hdr.len
op_minus
id|off
suffix:semicolon
id|rc
op_assign
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_logical_and
id|off
OL
r_sizeof
(paren
id|dump-&gt;driver_dump
)paren
)paren
(brace
r_if
c_cond
(paren
id|off
op_plus
id|count
OG
r_sizeof
(paren
id|dump-&gt;driver_dump
)paren
)paren
id|len
op_assign
r_sizeof
(paren
id|dump-&gt;driver_dump
)paren
op_minus
id|off
suffix:semicolon
r_else
id|len
op_assign
id|count
suffix:semicolon
id|src
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|dump-&gt;driver_dump
op_plus
id|off
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|src
comma
id|len
)paren
suffix:semicolon
id|buf
op_add_assign
id|len
suffix:semicolon
id|off
op_add_assign
id|len
suffix:semicolon
id|count
op_sub_assign
id|len
suffix:semicolon
)brace
id|off
op_sub_assign
r_sizeof
(paren
id|dump-&gt;driver_dump
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_logical_and
id|off
OL
m_offsetof
(paren
r_struct
id|ipr_ioa_dump
comma
id|ioa_data
)paren
)paren
(brace
r_if
c_cond
(paren
id|off
op_plus
id|count
OG
m_offsetof
(paren
r_struct
id|ipr_ioa_dump
comma
id|ioa_data
)paren
)paren
id|len
op_assign
m_offsetof
(paren
r_struct
id|ipr_ioa_dump
comma
id|ioa_data
)paren
op_minus
id|off
suffix:semicolon
r_else
id|len
op_assign
id|count
suffix:semicolon
id|src
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|dump-&gt;ioa_dump
op_plus
id|off
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|src
comma
id|len
)paren
suffix:semicolon
id|buf
op_add_assign
id|len
suffix:semicolon
id|off
op_add_assign
id|len
suffix:semicolon
id|count
op_sub_assign
id|len
suffix:semicolon
)brace
id|off
op_sub_assign
m_offsetof
(paren
r_struct
id|ipr_ioa_dump
comma
id|ioa_data
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
r_if
c_cond
(paren
(paren
id|off
op_amp
id|PAGE_MASK
)paren
op_ne
(paren
(paren
id|off
op_plus
id|count
)paren
op_amp
id|PAGE_MASK
)paren
)paren
id|len
op_assign
id|PAGE_ALIGN
c_func
(paren
id|off
)paren
op_minus
id|off
suffix:semicolon
r_else
id|len
op_assign
id|count
suffix:semicolon
id|src
op_assign
(paren
id|u8
op_star
)paren
id|dump-&gt;ioa_dump.ioa_data
(braket
(paren
id|off
op_amp
id|PAGE_MASK
)paren
op_rshift
id|PAGE_SHIFT
)braket
suffix:semicolon
id|src
op_add_assign
id|off
op_amp
op_complement
id|PAGE_MASK
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|src
comma
id|len
)paren
suffix:semicolon
id|buf
op_add_assign
id|len
suffix:semicolon
id|off
op_add_assign
id|len
suffix:semicolon
id|count
op_sub_assign
id|len
suffix:semicolon
)brace
id|kobject_put
c_func
(paren
op_amp
id|dump-&gt;kobj
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_release_dump - Free adapter dump memory&n; * @kobj:&t;kobject struct&n; *&n; * Return value:&n; *&t;nothing&n; **/
DECL|function|ipr_release_dump
r_static
r_void
id|ipr_release_dump
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
)paren
(brace
r_struct
id|ipr_dump
op_star
id|dump
op_assign
id|container_of
c_func
(paren
id|kobj
comma
r_struct
id|ipr_dump
comma
id|kobj
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|dump-&gt;ioa_cfg
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ENTER
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|ioa_cfg-&gt;dump
op_assign
l_int|NULL
suffix:semicolon
id|ioa_cfg-&gt;sdt_state
op_assign
id|INACTIVE
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dump-&gt;ioa_dump.next_page_index
suffix:semicolon
id|i
op_increment
)paren
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|dump-&gt;ioa_dump.ioa_data
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dump
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
)brace
DECL|variable|ipr_dump_kobj_type
r_static
r_struct
id|kobj_type
id|ipr_dump_kobj_type
op_assign
(brace
dot
id|release
op_assign
id|ipr_release_dump
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * ipr_alloc_dump - Prepare for adapter dump&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Return value:&n; *&t;0 on success / other on failure&n; **/
DECL|function|ipr_alloc_dump
r_static
r_int
id|ipr_alloc_dump
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_struct
id|ipr_dump
op_star
id|dump
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|ENTER
suffix:semicolon
id|dump
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_dump
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dump
)paren
(brace
id|ipr_err
c_func
(paren
l_string|&quot;Dump memory allocation failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dump
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ipr_dump
)paren
)paren
suffix:semicolon
id|kobject_init
c_func
(paren
op_amp
id|dump-&gt;kobj
)paren
suffix:semicolon
id|dump-&gt;kobj.ktype
op_assign
op_amp
id|ipr_dump_kobj_type
suffix:semicolon
id|dump-&gt;ioa_cfg
op_assign
id|ioa_cfg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|INACTIVE
op_ne
id|ioa_cfg-&gt;sdt_state
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dump
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ioa_cfg-&gt;dump
op_assign
id|dump
suffix:semicolon
id|ioa_cfg-&gt;sdt_state
op_assign
id|WAIT_FOR_DUMP
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;ioa_is_dead
op_logical_and
op_logical_neg
id|ioa_cfg-&gt;dump_taken
)paren
(brace
id|ioa_cfg-&gt;dump_taken
op_assign
l_int|1
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|ioa_cfg-&gt;work_q
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_free_dump - Free adapter dump memory&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Return value:&n; *&t;0 on success / other on failure&n; **/
DECL|function|ipr_free_dump
r_static
r_int
id|ipr_free_dump
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_struct
id|ipr_dump
op_star
id|dump
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|ENTER
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|dump
op_assign
id|ioa_cfg-&gt;dump
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dump
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ioa_cfg-&gt;dump
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|kobject_put
c_func
(paren
op_amp
id|dump-&gt;kobj
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_write_dump - Setup dump state of adapter&n; * @kobj:&t;&t;kobject struct&n; * @buf:&t;&t;buffer&n; * @off:&t;&t;offset&n; * @count:&t;&t;buffer size&n; *&n; * Return value:&n; *&t;number of bytes printed to buffer&n; **/
DECL|function|ipr_write_dump
r_static
id|ssize_t
id|ipr_write_dump
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|buf
comma
id|loff_t
id|off
comma
r_int
id|count
)paren
(brace
r_struct
id|class_device
op_star
id|cdev
op_assign
id|container_of
c_func
(paren
id|kobj
comma
r_struct
id|class_device
comma
id|kobj
)paren
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|buf
(braket
l_int|0
)braket
op_eq
l_char|&squot;1&squot;
)paren
id|rc
op_assign
id|ipr_alloc_dump
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|buf
(braket
l_int|0
)braket
op_eq
l_char|&squot;0&squot;
)paren
id|rc
op_assign
id|ipr_free_dump
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_else
r_return
id|count
suffix:semicolon
)brace
DECL|variable|ipr_dump_attr
r_static
r_struct
id|bin_attribute
id|ipr_dump_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;dump&quot;
comma
dot
id|mode
op_assign
id|S_IRUSR
op_or
id|S_IWUSR
comma
)brace
comma
dot
id|size
op_assign
l_int|0
comma
dot
id|read
op_assign
id|ipr_read_dump
comma
dot
id|write
op_assign
id|ipr_write_dump
)brace
suffix:semicolon
macro_line|#else
DECL|function|ipr_free_dump
r_static
r_int
id|ipr_free_dump
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/**&n; * ipr_store_queue_depth - Change the device&squot;s queue depth&n; * @dev:&t;device struct&n; * @buf:&t;buffer&n; *&n; * Return value:&n; * &t;number of bytes printed to buffer&n; **/
DECL|function|ipr_store_queue_depth
r_static
id|ssize_t
id|ipr_store_queue_depth
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_int
id|qdepth
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_int
id|tagged
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|ssize_t
id|len
op_assign
op_minus
id|ENXIO
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|res
op_assign
(paren
r_struct
id|ipr_resource_entry
op_star
)paren
id|sdev-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|res-&gt;qdepth
op_assign
id|qdepth
suffix:semicolon
r_if
c_cond
(paren
id|ipr_is_gscsi
c_func
(paren
id|res
)paren
op_logical_and
id|res-&gt;tcq_active
)paren
id|tagged
op_assign
id|MSG_ORDERED_TAG
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|scsi_adjust_queue_depth
c_func
(paren
id|sdev
comma
id|tagged
comma
id|qdepth
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|ipr_queue_depth_attr
r_static
r_struct
id|device_attribute
id|ipr_queue_depth_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;queue_depth&quot;
comma
dot
id|mode
op_assign
id|S_IRUSR
op_or
id|S_IWUSR
comma
)brace
comma
dot
id|store
op_assign
id|ipr_store_queue_depth
)brace
suffix:semicolon
multiline_comment|/**&n; * ipr_show_tcq_enable - Show if the device is enabled for tcqing&n; * @dev:&t;device struct&n; * @buf:&t;buffer&n; *&n; * Return value:&n; * &t;number of bytes printed to buffer&n; **/
DECL|function|ipr_show_tcq_enable
r_static
id|ssize_t
id|ipr_show_tcq_enable
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|ssize_t
id|len
op_assign
op_minus
id|ENXIO
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|res
op_assign
(paren
r_struct
id|ipr_resource_entry
op_star
)paren
id|sdev-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
id|len
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|res-&gt;tcq_active
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_store_tcq_enable - Change the device&squot;s TCQing state&n; * @dev:&t;device struct&n; * @buf:&t;buffer&n; *&n; * Return value:&n; * &t;number of bytes printed to buffer&n; **/
DECL|function|ipr_store_tcq_enable
r_static
id|ssize_t
id|ipr_store_tcq_enable
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
r_int
id|tcq_active
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_int
id|qdepth
op_assign
id|IPR_MAX_CMD_PER_LUN
suffix:semicolon
r_int
id|tagged
op_assign
l_int|0
suffix:semicolon
id|ssize_t
id|len
op_assign
op_minus
id|ENXIO
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|res
op_assign
(paren
r_struct
id|ipr_resource_entry
op_star
)paren
id|sdev-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|res-&gt;tcq_active
op_assign
l_int|0
suffix:semicolon
id|qdepth
op_assign
id|res-&gt;qdepth
suffix:semicolon
r_if
c_cond
(paren
id|ipr_is_gscsi
c_func
(paren
id|res
)paren
op_logical_and
id|sdev-&gt;tagged_supported
)paren
(brace
r_if
c_cond
(paren
id|tcq_active
)paren
(brace
id|tagged
op_assign
id|MSG_ORDERED_TAG
suffix:semicolon
id|res-&gt;tcq_active
op_assign
l_int|1
suffix:semicolon
)brace
id|len
op_assign
id|strlen
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tcq_active
)paren
(brace
id|len
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|scsi_adjust_queue_depth
c_func
(paren
id|sdev
comma
id|tagged
comma
id|qdepth
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|ipr_tcqing_attr
r_static
r_struct
id|device_attribute
id|ipr_tcqing_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;tcq_enable&quot;
comma
dot
id|mode
op_assign
id|S_IRUSR
op_or
id|S_IWUSR
comma
)brace
comma
dot
id|store
op_assign
id|ipr_store_tcq_enable
comma
dot
id|show
op_assign
id|ipr_show_tcq_enable
)brace
suffix:semicolon
multiline_comment|/**&n; * ipr_show_adapter_handle - Show the adapter&squot;s resource handle for this device&n; * @dev:&t;device struct&n; * @buf:&t;buffer&n; *&n; * Return value:&n; * &t;number of bytes printed to buffer&n; **/
DECL|function|ipr_show_adapter_handle
r_static
id|ssize_t
id|ipr_show_adapter_handle
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|ssize_t
id|len
op_assign
op_minus
id|ENXIO
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|res
op_assign
(paren
r_struct
id|ipr_resource_entry
op_star
)paren
id|sdev-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
id|len
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%08X&bslash;n&quot;
comma
id|res-&gt;cfgte.res_handle
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|ipr_adapter_handle_attr
r_static
r_struct
id|device_attribute
id|ipr_adapter_handle_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;adapter_handle&quot;
comma
dot
id|mode
op_assign
id|S_IRUSR
comma
)brace
comma
dot
id|show
op_assign
id|ipr_show_adapter_handle
)brace
suffix:semicolon
DECL|variable|ipr_dev_attrs
r_static
r_struct
id|device_attribute
op_star
id|ipr_dev_attrs
(braket
)braket
op_assign
(brace
op_amp
id|ipr_queue_depth_attr
comma
op_amp
id|ipr_tcqing_attr
comma
op_amp
id|ipr_adapter_handle_attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * ipr_biosparam - Return the HSC mapping&n; * @sdev:&t;&t;&t;scsi device struct&n; * @block_device:&t;block device pointer&n; * @capacity:&t;&t;capacity of the device&n; * @parm:&t;&t;&t;Array containing returned HSC values.&n; *&n; * This function generates the HSC parms that fdisk uses.&n; * We want to make sure we return something that places partitions&n; * on 4k boundaries for best performance with the IOA.&n; *&n; * Return value:&n; * &t;0 on success&n; **/
DECL|function|ipr_biosparam
r_static
r_int
id|ipr_biosparam
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
comma
r_struct
id|block_device
op_star
id|block_device
comma
id|sector_t
id|capacity
comma
r_int
op_star
id|parm
)paren
(brace
r_int
id|heads
comma
id|sectors
suffix:semicolon
id|sector_t
id|cylinders
suffix:semicolon
id|heads
op_assign
l_int|128
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|capacity
suffix:semicolon
id|sector_div
c_func
(paren
id|cylinders
comma
(paren
l_int|128
op_star
l_int|32
)paren
)paren
suffix:semicolon
multiline_comment|/* return result */
id|parm
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|parm
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|parm
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_slave_destroy - Unconfigure a SCSI device&n; * @sdev:&t;scsi device struct&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_slave_destroy
r_static
r_void
id|ipr_slave_destroy
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
)paren
(brace
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|res
op_assign
(paren
r_struct
id|ipr_resource_entry
op_star
)paren
id|sdev-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|sdev-&gt;hostdata
op_assign
l_int|NULL
suffix:semicolon
id|res-&gt;sdev
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_slave_configure - Configure a SCSI device&n; * @sdev:&t;scsi device struct&n; *&n; * This function configures the specified scsi device.&n; *&n; * Return value:&n; * &t;0 on success&n; **/
DECL|function|ipr_slave_configure
r_static
r_int
id|ipr_slave_configure
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|res
op_assign
id|sdev-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
r_if
c_cond
(paren
id|ipr_is_af_dasd_device
c_func
(paren
id|res
)paren
)paren
id|sdev-&gt;type
op_assign
id|TYPE_RAID
suffix:semicolon
r_if
c_cond
(paren
id|ipr_is_af_dasd_device
c_func
(paren
id|res
)paren
op_logical_or
id|ipr_is_ioa_resource
c_func
(paren
id|res
)paren
)paren
id|sdev-&gt;scsi_level
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|ipr_is_vset_device
c_func
(paren
id|res
)paren
)paren
id|sdev-&gt;timeout
op_assign
id|IPR_VSET_RW_TIMEOUT
suffix:semicolon
id|sdev-&gt;allow_restart
op_assign
l_int|1
suffix:semicolon
id|scsi_adjust_queue_depth
c_func
(paren
id|sdev
comma
l_int|0
comma
id|res-&gt;qdepth
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_slave_alloc - Prepare for commands to a device.&n; * @sdev:&t;scsi device struct&n; *&n; * This function saves a pointer to the resource entry&n; * in the scsi device struct if the device exists. We&n; * can then use this pointer in ipr_queuecommand when&n; * handling new commands.&n; *&n; * Return value:&n; * &t;0 on success&n; **/
DECL|function|ipr_slave_alloc
r_static
r_int
id|ipr_slave_alloc
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
id|sdev-&gt;hostdata
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|res
comma
op_amp
id|ioa_cfg-&gt;used_res_q
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
(paren
id|res-&gt;cfgte.res_addr.bus
op_eq
id|sdev-&gt;channel
)paren
op_logical_and
(paren
id|res-&gt;cfgte.res_addr.target
op_eq
id|sdev-&gt;id
)paren
op_logical_and
(paren
id|res-&gt;cfgte.res_addr.lun
op_eq
id|sdev-&gt;lun
)paren
)paren
(brace
id|res-&gt;sdev
op_assign
id|sdev
suffix:semicolon
id|res-&gt;add_to_ml
op_assign
l_int|0
suffix:semicolon
id|res-&gt;in_erp
op_assign
l_int|0
suffix:semicolon
id|sdev-&gt;hostdata
op_assign
id|res
suffix:semicolon
id|res-&gt;needs_sync_complete
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_eh_host_reset - Reset the host adapter&n; * @scsi_cmd:&t;scsi command struct&n; *&n; * Return value:&n; * &t;SUCCESS / FAILED&n; **/
DECL|function|ipr_eh_host_reset
r_static
r_int
id|ipr_eh_host_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ENTER
suffix:semicolon
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|scsi_cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Adapter being reset as a result of error recovery.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WAIT_FOR_DUMP
op_eq
id|ioa_cfg-&gt;sdt_state
)paren
id|ioa_cfg-&gt;sdt_state
op_assign
id|GET_DUMP
suffix:semicolon
id|rc
op_assign
id|ipr_reset_reload
c_func
(paren
id|ioa_cfg
comma
id|IPR_SHUTDOWN_ABBREV
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_eh_dev_reset - Reset the device&n; * @scsi_cmd:&t;scsi command struct&n; *&n; * This function issues a device reset to the affected device.&n; * A LUN reset will be sent to the device first. If that does&n; * not work, a target reset will be sent.&n; *&n; * Return value:&n; *&t;SUCCESS / FAILED&n; **/
DECL|function|ipr_eh_dev_reset
r_static
r_int
id|ipr_eh_dev_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
)paren
(brace
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_struct
id|ipr_cmd_pkt
op_star
id|cmd_pkt
suffix:semicolon
id|u32
id|ioasc
suffix:semicolon
id|ENTER
suffix:semicolon
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|scsi_cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|res
op_assign
id|scsi_cmd-&gt;device-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
op_logical_or
(paren
op_logical_neg
id|ipr_is_gscsi
c_func
(paren
id|res
)paren
op_logical_and
op_logical_neg
id|ipr_is_vset_device
c_func
(paren
id|res
)paren
)paren
)paren
r_return
id|FAILED
suffix:semicolon
multiline_comment|/*&n;&t; * If we are currently going through reset/reload, return failed. This will force the&n;&t; * mid-layer to call ipr_eh_host_reset, which will then go to sleep and wait for the&n;&t; * reset to complete&n;&t; */
r_if
c_cond
(paren
id|ioa_cfg-&gt;in_reset_reload
)paren
r_return
id|FAILED
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;ioa_is_dead
)paren
r_return
id|FAILED
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|ipr_cmd
comma
op_amp
id|ioa_cfg-&gt;pending_q
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
id|ipr_cmd-&gt;ioarcb.res_handle
op_eq
id|res-&gt;cfgte.res_handle
)paren
(brace
r_if
c_cond
(paren
id|ipr_cmd-&gt;scsi_cmd
)paren
id|ipr_cmd-&gt;done
op_assign
id|ipr_scsi_eh_done
suffix:semicolon
)brace
)brace
id|res-&gt;resetting_device
op_assign
l_int|1
suffix:semicolon
id|ipr_cmd
op_assign
id|ipr_get_free_ipr_cmnd
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.res_handle
op_assign
id|res-&gt;cfgte.res_handle
suffix:semicolon
id|cmd_pkt
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb.cmd_pkt
suffix:semicolon
id|cmd_pkt-&gt;request_type
op_assign
id|IPR_RQTYPE_IOACMD
suffix:semicolon
id|cmd_pkt-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPR_RESET_DEVICE
suffix:semicolon
id|ipr_sdev_err
c_func
(paren
id|scsi_cmd-&gt;device
comma
l_string|&quot;Resetting device&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_send_blocking_cmd
c_func
(paren
id|ipr_cmd
comma
id|ipr_timeout
comma
id|IPR_DEVICE_RESET_TIMEOUT
)paren
suffix:semicolon
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioasa.ioasc
)paren
suffix:semicolon
id|res-&gt;resetting_device
op_assign
l_int|0
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
(paren
id|IPR_IOASC_SENSE_KEY
c_func
(paren
id|ioasc
)paren
ques
c_cond
id|FAILED
suffix:colon
id|SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_bus_reset_done - Op done function for bus reset.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function is the op done function for a bus reset&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_bus_reset_done
r_static
r_void
id|ipr_bus_reset_done
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
id|ENTER
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|res
comma
op_amp
id|ioa_cfg-&gt;used_res_q
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|res-&gt;cfgte.res_handle
comma
op_amp
id|ipr_cmd-&gt;ioarcb.res_handle
comma
r_sizeof
(paren
id|res-&gt;cfgte.res_handle
)paren
)paren
)paren
(brace
id|scsi_report_bus_reset
c_func
(paren
id|ioa_cfg-&gt;host
comma
id|res-&gt;cfgte.res_addr.bus
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * If abort has not completed, indicate the reset has, else call the&n;&t; * abort&squot;s done function to wake the sleeping eh thread&n;&t; */
r_if
c_cond
(paren
id|ipr_cmd-&gt;sibling-&gt;sibling
)paren
id|ipr_cmd-&gt;sibling-&gt;sibling
op_assign
l_int|NULL
suffix:semicolon
r_else
id|ipr_cmd-&gt;sibling
op_member_access_from_pointer
id|done
c_func
(paren
id|ipr_cmd-&gt;sibling
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_abort_timeout - An abort task has timed out&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function handles when an abort task times out. If this&n; * happens we issue a bus reset since we have resources tied&n; * up that must be freed before returning to the midlayer.&n; *&n; * Return value:&n; *&t;none&n; **/
DECL|function|ipr_abort_timeout
r_static
r_void
id|ipr_abort_timeout
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_cmnd
op_star
id|reset_cmd
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_cmd_pkt
op_star
id|cmd_pkt
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|ENTER
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipr_cmd-&gt;completion.done
op_logical_or
id|ioa_cfg-&gt;in_reset_reload
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ipr_sdev_err
c_func
(paren
id|ipr_cmd-&gt;u.sdev
comma
l_string|&quot;Abort timed out. Resetting bus&bslash;n&quot;
)paren
suffix:semicolon
id|reset_cmd
op_assign
id|ipr_get_free_ipr_cmnd
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|ipr_cmd-&gt;sibling
op_assign
id|reset_cmd
suffix:semicolon
id|reset_cmd-&gt;sibling
op_assign
id|ipr_cmd
suffix:semicolon
id|reset_cmd-&gt;ioarcb.res_handle
op_assign
id|ipr_cmd-&gt;ioarcb.res_handle
suffix:semicolon
id|cmd_pkt
op_assign
op_amp
id|reset_cmd-&gt;ioarcb.cmd_pkt
suffix:semicolon
id|cmd_pkt-&gt;request_type
op_assign
id|IPR_RQTYPE_IOACMD
suffix:semicolon
id|cmd_pkt-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPR_RESET_DEVICE
suffix:semicolon
id|cmd_pkt-&gt;cdb
(braket
l_int|2
)braket
op_assign
id|IPR_RESET_TYPE_SELECT
op_or
id|IPR_BUS_RESET
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|reset_cmd
comma
id|ipr_bus_reset_done
comma
id|ipr_timeout
comma
id|IPR_DEVICE_RESET_TIMEOUT
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_cancel_op - Cancel specified op&n; * @scsi_cmd:&t;scsi command struct&n; *&n; * This function cancels specified op.&n; *&n; * Return value:&n; *&t;SUCCESS / FAILED&n; **/
DECL|function|ipr_cancel_op
r_static
r_int
id|ipr_cancel_op
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
)paren
(brace
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_struct
id|ipr_cmd_pkt
op_star
id|cmd_pkt
suffix:semicolon
id|u32
id|ioasc
comma
id|ioarcb_addr
suffix:semicolon
r_int
id|op_found
op_assign
l_int|0
suffix:semicolon
id|ENTER
suffix:semicolon
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|scsi_cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|res
op_assign
id|scsi_cmd-&gt;device-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
op_logical_or
(paren
op_logical_neg
id|ipr_is_gscsi
c_func
(paren
id|res
)paren
op_logical_and
op_logical_neg
id|ipr_is_vset_device
c_func
(paren
id|res
)paren
)paren
)paren
r_return
id|FAILED
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|ipr_cmd
comma
op_amp
id|ioa_cfg-&gt;pending_q
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
id|ipr_cmd-&gt;scsi_cmd
op_eq
id|scsi_cmd
)paren
(brace
id|ipr_cmd-&gt;done
op_assign
id|ipr_scsi_eh_done
suffix:semicolon
id|op_found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|op_found
)paren
r_return
id|SUCCESS
suffix:semicolon
id|ioarcb_addr
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioarcb.ioarcb_host_pci_addr
)paren
suffix:semicolon
id|ipr_cmd
op_assign
id|ipr_get_free_ipr_cmnd
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.res_handle
op_assign
id|res-&gt;cfgte.res_handle
suffix:semicolon
id|cmd_pkt
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb.cmd_pkt
suffix:semicolon
id|cmd_pkt-&gt;request_type
op_assign
id|IPR_RQTYPE_IOACMD
suffix:semicolon
id|cmd_pkt-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPR_ABORT_TASK
suffix:semicolon
id|cmd_pkt-&gt;cdb
(braket
l_int|2
)braket
op_assign
(paren
id|ioarcb_addr
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
id|cmd_pkt-&gt;cdb
(braket
l_int|3
)braket
op_assign
(paren
id|ioarcb_addr
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|cmd_pkt-&gt;cdb
(braket
l_int|4
)braket
op_assign
(paren
id|ioarcb_addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|cmd_pkt-&gt;cdb
(braket
l_int|5
)braket
op_assign
id|ioarcb_addr
op_amp
l_int|0xff
suffix:semicolon
id|ipr_cmd-&gt;u.sdev
op_assign
id|scsi_cmd-&gt;device
suffix:semicolon
id|ipr_sdev_err
c_func
(paren
id|scsi_cmd-&gt;device
comma
l_string|&quot;Aborting command: %02X&bslash;n&quot;
comma
id|scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ipr_send_blocking_cmd
c_func
(paren
id|ipr_cmd
comma
id|ipr_abort_timeout
comma
id|IPR_ABORT_TASK_TIMEOUT
)paren
suffix:semicolon
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioasa.ioasc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If the abort task timed out and we sent a bus reset, we will get&n;&t; * one the following responses to the abort&n;&t; */
r_if
c_cond
(paren
id|ioasc
op_eq
id|IPR_IOASC_BUS_WAS_RESET
op_logical_or
id|ioasc
op_eq
id|IPR_IOASC_SYNC_REQUIRED
)paren
(brace
id|ioasc
op_assign
l_int|0
suffix:semicolon
id|ipr_trace
suffix:semicolon
)brace
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
id|res-&gt;needs_sync_complete
op_assign
l_int|1
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
(paren
id|IPR_IOASC_SENSE_KEY
c_func
(paren
id|ioasc
)paren
ques
c_cond
id|FAILED
suffix:colon
id|SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_eh_abort - Abort a single op&n; * @scsi_cmd:&t;scsi command struct&n; *&n; * Return value:&n; * &t;SUCCESS / FAILED&n; **/
DECL|function|ipr_eh_abort
r_static
r_int
id|ipr_eh_abort
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
suffix:semicolon
id|ENTER
suffix:semicolon
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|scsi_cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
multiline_comment|/* If we are currently going through reset/reload, return failed. This will force the&n;&t;   mid-layer to call ipr_eh_host_reset, which will then go to sleep and wait for the&n;&t;   reset to complete */
r_if
c_cond
(paren
id|ioa_cfg-&gt;in_reset_reload
)paren
r_return
id|FAILED
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;ioa_is_dead
)paren
r_return
id|FAILED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_cmd-&gt;device-&gt;hostdata
)paren
r_return
id|FAILED
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|ipr_cancel_op
c_func
(paren
id|scsi_cmd
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_handle_other_interrupt - Handle &quot;other&quot; interrupts&n; * @ioa_cfg:&t;ioa config struct&n; * @int_reg:&t;interrupt register&n; *&n; * Return value:&n; * &t;IRQ_NONE / IRQ_HANDLED&n; **/
DECL|function|ipr_handle_other_interrupt
r_static
id|irqreturn_t
id|ipr_handle_other_interrupt
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_volatile
id|u32
id|int_reg
)paren
(brace
id|irqreturn_t
id|rc
op_assign
id|IRQ_HANDLED
suffix:semicolon
r_if
c_cond
(paren
id|int_reg
op_amp
id|IPR_PCII_IOA_TRANS_TO_OPER
)paren
(brace
multiline_comment|/* Mask the interrupt */
id|writel
c_func
(paren
id|IPR_PCII_IOA_TRANS_TO_OPER
comma
id|ioa_cfg-&gt;regs.set_interrupt_mask_reg
)paren
suffix:semicolon
multiline_comment|/* Clear the interrupt */
id|writel
c_func
(paren
id|IPR_PCII_IOA_TRANS_TO_OPER
comma
id|ioa_cfg-&gt;regs.clr_interrupt_reg
)paren
suffix:semicolon
id|int_reg
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;regs.sense_interrupt_reg
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|ioa_cfg-&gt;reset_cmd-&gt;queue
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ioa_cfg-&gt;reset_cmd-&gt;timer
)paren
suffix:semicolon
id|ipr_reset_ioa_job
c_func
(paren
id|ioa_cfg-&gt;reset_cmd
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|int_reg
op_amp
id|IPR_PCII_IOA_UNIT_CHECKED
)paren
id|ioa_cfg-&gt;ioa_unit_checked
op_assign
l_int|1
suffix:semicolon
r_else
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Permanent IOA failure. 0x%08X&bslash;n&quot;
comma
id|int_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WAIT_FOR_DUMP
op_eq
id|ioa_cfg-&gt;sdt_state
)paren
id|ioa_cfg-&gt;sdt_state
op_assign
id|GET_DUMP
suffix:semicolon
id|ipr_mask_and_clear_interrupts
c_func
(paren
id|ioa_cfg
comma
op_complement
l_int|0
)paren
suffix:semicolon
id|ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|IPR_SHUTDOWN_NONE
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_isr - Interrupt service routine&n; * @irq:&t;irq number&n; * @devp:&t;pointer to ioa config struct&n; * @regs:&t;pt_regs struct&n; *&n; * Return value:&n; * &t;IRQ_NONE / IRQ_HANDLED&n; **/
DECL|function|ipr_isr
r_static
id|irqreturn_t
id|ipr_isr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|devp
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|devp
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
r_volatile
id|u32
id|int_reg
comma
id|int_mask_reg
suffix:semicolon
id|u32
id|ioasc
suffix:semicolon
id|u16
id|cmd_index
suffix:semicolon
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
suffix:semicolon
id|irqreturn_t
id|rc
op_assign
id|IRQ_NONE
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
multiline_comment|/* If interrupts are disabled, ignore the interrupt */
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;allow_interrupts
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|int_mask_reg
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;regs.sense_interrupt_mask_reg
)paren
suffix:semicolon
id|int_reg
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;regs.sense_interrupt_reg
)paren
op_amp
op_complement
id|int_mask_reg
suffix:semicolon
multiline_comment|/* If an interrupt on the adapter did not occur, ignore it */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
(paren
id|int_reg
op_amp
id|IPR_PCII_OPER_INTERRUPTS
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|ipr_cmd
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|be32_to_cpu
c_func
(paren
op_star
id|ioa_cfg-&gt;hrrq_curr
)paren
op_amp
id|IPR_HRRQ_TOGGLE_BIT
)paren
op_eq
id|ioa_cfg-&gt;toggle_bit
)paren
(brace
id|cmd_index
op_assign
(paren
id|be32_to_cpu
c_func
(paren
op_star
id|ioa_cfg-&gt;hrrq_curr
)paren
op_amp
id|IPR_HRRQ_REQ_RESP_HANDLE_MASK
)paren
op_rshift
id|IPR_HRRQ_REQ_RESP_HANDLE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|cmd_index
op_ge
id|IPR_NUM_CMD_BLKS
)paren
)paren
(brace
id|ioa_cfg-&gt;errors_logged
op_increment
suffix:semicolon
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Invalid response handle from IOA&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|WAIT_FOR_DUMP
op_eq
id|ioa_cfg-&gt;sdt_state
)paren
id|ioa_cfg-&gt;sdt_state
op_assign
id|GET_DUMP
suffix:semicolon
id|ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|IPR_SHUTDOWN_NONE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|ipr_cmd
op_assign
id|ioa_cfg-&gt;ipr_cmnd_list
(braket
id|cmd_index
)braket
suffix:semicolon
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioasa.ioasc
)paren
suffix:semicolon
id|ipr_trc_hook
c_func
(paren
id|ipr_cmd
comma
id|IPR_TRACE_FINISH
comma
id|ioasc
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ipr_cmd-&gt;timer
)paren
suffix:semicolon
id|ipr_cmd
op_member_access_from_pointer
id|done
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
id|rc
op_assign
id|IRQ_HANDLED
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;hrrq_curr
OL
id|ioa_cfg-&gt;hrrq_end
)paren
(brace
id|ioa_cfg-&gt;hrrq_curr
op_increment
suffix:semicolon
)brace
r_else
(brace
id|ioa_cfg-&gt;hrrq_curr
op_assign
id|ioa_cfg-&gt;hrrq_start
suffix:semicolon
id|ioa_cfg-&gt;toggle_bit
op_xor_assign
l_int|1u
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ipr_cmd
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Clear the PCI interrupt */
id|writel
c_func
(paren
id|IPR_PCII_HRRQ_UPDATED
comma
id|ioa_cfg-&gt;regs.clr_interrupt_reg
)paren
suffix:semicolon
id|int_reg
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;regs.sense_interrupt_reg
)paren
op_amp
op_complement
id|int_mask_reg
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|rc
op_eq
id|IRQ_NONE
)paren
)paren
id|rc
op_assign
id|ipr_handle_other_interrupt
c_func
(paren
id|ioa_cfg
comma
id|int_reg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_build_ioadl - Build a scatter/gather list and map the buffer&n; * @ioa_cfg:&t;ioa config struct&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Return value:&n; * &t;0 on success / -1 on failure&n; **/
DECL|function|ipr_build_ioadl
r_static
r_int
id|ipr_build_ioadl
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sglist
suffix:semicolon
id|u32
id|length
suffix:semicolon
id|u32
id|ioadl_flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
op_assign
id|ipr_cmd-&gt;scsi_cmd
suffix:semicolon
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
r_struct
id|ipr_ioadl_desc
op_star
id|ioadl
op_assign
id|ipr_cmd-&gt;ioadl
suffix:semicolon
id|length
op_assign
id|scsi_cmd-&gt;request_bufflen
suffix:semicolon
r_if
c_cond
(paren
id|length
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scsi_cmd-&gt;use_sg
)paren
(brace
id|ipr_cmd-&gt;dma_use_sg
op_assign
id|pci_map_sg
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|scsi_cmd-&gt;request_buffer
comma
id|scsi_cmd-&gt;use_sg
comma
id|scsi_cmd-&gt;sc_data_direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_cmd-&gt;sc_data_direction
op_eq
id|DMA_TO_DEVICE
)paren
(brace
id|ioadl_flags
op_assign
id|IPR_IOADL_FLAGS_WRITE
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.flags_hi
op_or_assign
id|IPR_FLAGS_HI_WRITE_NOT_READ
suffix:semicolon
id|ioarcb-&gt;write_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
id|length
)paren
suffix:semicolon
id|ioarcb-&gt;write_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
op_star
id|ipr_cmd-&gt;dma_use_sg
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|scsi_cmd-&gt;sc_data_direction
op_eq
id|DMA_FROM_DEVICE
)paren
(brace
id|ioadl_flags
op_assign
id|IPR_IOADL_FLAGS_READ
suffix:semicolon
id|ioarcb-&gt;read_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
id|length
)paren
suffix:semicolon
id|ioarcb-&gt;read_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
op_star
id|ipr_cmd-&gt;dma_use_sg
)paren
suffix:semicolon
)brace
id|sglist
op_assign
id|scsi_cmd-&gt;request_buffer
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ipr_cmd-&gt;dma_use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ioadl
(braket
id|i
)braket
dot
id|flags_and_data_len
op_assign
id|cpu_to_be32
c_func
(paren
id|ioadl_flags
op_or
id|sg_dma_len
c_func
(paren
op_amp
id|sglist
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|ioadl
(braket
id|i
)braket
dot
id|address
op_assign
id|cpu_to_be32
c_func
(paren
id|sg_dma_address
c_func
(paren
op_amp
id|sglist
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|likely
c_func
(paren
id|ipr_cmd-&gt;dma_use_sg
)paren
)paren
(brace
id|ioadl
(braket
id|i
op_minus
l_int|1
)braket
dot
id|flags_and_data_len
op_or_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOADL_FLAGS_LAST
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;pci_map_sg failed!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|scsi_cmd-&gt;sc_data_direction
op_eq
id|DMA_TO_DEVICE
)paren
(brace
id|ioadl_flags
op_assign
id|IPR_IOADL_FLAGS_WRITE
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.flags_hi
op_or_assign
id|IPR_FLAGS_HI_WRITE_NOT_READ
suffix:semicolon
id|ioarcb-&gt;write_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
id|length
)paren
suffix:semicolon
id|ioarcb-&gt;write_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|scsi_cmd-&gt;sc_data_direction
op_eq
id|DMA_FROM_DEVICE
)paren
(brace
id|ioadl_flags
op_assign
id|IPR_IOADL_FLAGS_READ
suffix:semicolon
id|ioarcb-&gt;read_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
id|length
)paren
suffix:semicolon
id|ioarcb-&gt;read_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
)paren
suffix:semicolon
)brace
id|ipr_cmd-&gt;dma_handle
op_assign
id|pci_map_single
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|scsi_cmd-&gt;request_buffer
comma
id|length
comma
id|scsi_cmd-&gt;sc_data_direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
op_logical_neg
id|pci_dma_mapping_error
c_func
(paren
id|ipr_cmd-&gt;dma_handle
)paren
)paren
)paren
(brace
id|ipr_cmd-&gt;dma_use_sg
op_assign
l_int|1
suffix:semicolon
id|ioadl
(braket
l_int|0
)braket
dot
id|flags_and_data_len
op_assign
id|cpu_to_be32
c_func
(paren
id|ioadl_flags
op_or
id|length
op_or
id|IPR_IOADL_FLAGS_LAST
)paren
suffix:semicolon
id|ioadl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|cpu_to_be32
c_func
(paren
id|ipr_cmd-&gt;dma_handle
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;pci_map_single failed!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_get_task_attributes - Translate SPI Q-Tag to task attributes&n; * @scsi_cmd:&t;scsi command struct&n; *&n; * Return value:&n; * &t;task attributes&n; **/
DECL|function|ipr_get_task_attributes
r_static
id|u8
id|ipr_get_task_attributes
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
)paren
(brace
id|u8
id|tag
(braket
l_int|2
)braket
suffix:semicolon
id|u8
id|rc
op_assign
id|IPR_FLAGS_LO_UNTAGGED_TASK
suffix:semicolon
r_if
c_cond
(paren
id|scsi_populate_tag_msg
c_func
(paren
id|scsi_cmd
comma
id|tag
)paren
)paren
(brace
r_switch
c_cond
(paren
id|tag
(braket
l_int|0
)braket
)paren
(brace
r_case
id|MSG_SIMPLE_TAG
suffix:colon
id|rc
op_assign
id|IPR_FLAGS_LO_SIMPLE_TASK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSG_HEAD_TAG
suffix:colon
id|rc
op_assign
id|IPR_FLAGS_LO_HEAD_OF_Q_TASK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSG_ORDERED_TAG
suffix:colon
id|rc
op_assign
id|IPR_FLAGS_LO_ORDERED_TASK
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_erp_done - Process completion of ERP for a device&n; * @ipr_cmd:&t;&t;ipr command struct&n; *&n; * This function copies the sense buffer into the scsi_cmd&n; * struct and pushes the scsi_done function.&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_erp_done
r_static
r_void
id|ipr_erp_done
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
op_assign
id|ipr_cmd-&gt;scsi_cmd
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
op_assign
id|scsi_cmd-&gt;device-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
id|u32
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioasa.ioasc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IPR_IOASC_SENSE_KEY
c_func
(paren
id|ioasc
)paren
OG
l_int|0
)paren
(brace
id|scsi_cmd-&gt;result
op_or_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|ipr_sdev_err
c_func
(paren
id|scsi_cmd-&gt;device
comma
l_string|&quot;Request Sense failed with IOASC: 0x%08X&bslash;n&quot;
comma
id|ioasc
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|scsi_cmd-&gt;sense_buffer
comma
id|ipr_cmd-&gt;sense_buffer
comma
id|SCSI_SENSE_BUFFERSIZE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res
)paren
(brace
id|res-&gt;needs_sync_complete
op_assign
l_int|1
suffix:semicolon
id|res-&gt;in_erp
op_assign
l_int|0
suffix:semicolon
)brace
id|ipr_unmap_sglist
c_func
(paren
id|ioa_cfg
comma
id|ipr_cmd
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
id|scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scsi_cmd
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reinit_ipr_cmnd_for_erp - Re-initialize a cmnd block to be used for ERP&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_reinit_ipr_cmnd_for_erp
r_static
r_void
id|ipr_reinit_ipr_cmnd_for_erp
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
suffix:semicolon
r_struct
id|ipr_ioasa
op_star
id|ioasa
suffix:semicolon
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
id|ioasa
op_assign
op_amp
id|ipr_cmd-&gt;ioasa
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ioarcb-&gt;cmd_pkt
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ipr_cmd_pkt
)paren
)paren
suffix:semicolon
id|ioarcb-&gt;write_data_transfer_length
op_assign
l_int|0
suffix:semicolon
id|ioarcb-&gt;read_data_transfer_length
op_assign
l_int|0
suffix:semicolon
id|ioarcb-&gt;write_ioadl_len
op_assign
l_int|0
suffix:semicolon
id|ioarcb-&gt;read_ioadl_len
op_assign
l_int|0
suffix:semicolon
id|ioasa-&gt;ioasc
op_assign
l_int|0
suffix:semicolon
id|ioasa-&gt;residual_data_len
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_erp_request_sense - Send request sense to a device&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function sends a request sense to a device as a result&n; * of a check condition.&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_erp_request_sense
r_static
r_void
id|ipr_erp_request_sense
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_cmd_pkt
op_star
id|cmd_pkt
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb.cmd_pkt
suffix:semicolon
id|u32
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioasa.ioasc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IPR_IOASC_SENSE_KEY
c_func
(paren
id|ioasc
)paren
OG
l_int|0
)paren
(brace
id|ipr_erp_done
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ipr_reinit_ipr_cmnd_for_erp
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
id|cmd_pkt-&gt;request_type
op_assign
id|IPR_RQTYPE_SCSICDB
suffix:semicolon
id|cmd_pkt-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|REQUEST_SENSE
suffix:semicolon
id|cmd_pkt-&gt;cdb
(braket
l_int|4
)braket
op_assign
id|SCSI_SENSE_BUFFERSIZE
suffix:semicolon
id|cmd_pkt-&gt;flags_hi
op_or_assign
id|IPR_FLAGS_HI_SYNC_OVERRIDE
suffix:semicolon
id|cmd_pkt-&gt;flags_hi
op_or_assign
id|IPR_FLAGS_HI_NO_ULEN_CHK
suffix:semicolon
id|cmd_pkt-&gt;timeout
op_assign
id|cpu_to_be16
c_func
(paren
id|IPR_REQUEST_SENSE_TIMEOUT
op_div
id|HZ
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioadl
(braket
l_int|0
)braket
dot
id|flags_and_data_len
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOADL_FLAGS_READ_LAST
op_or
id|SCSI_SENSE_BUFFERSIZE
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioadl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|cpu_to_be32
c_func
(paren
id|ipr_cmd-&gt;sense_buffer_dma
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.read_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.read_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
id|SCSI_SENSE_BUFFERSIZE
)paren
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|ipr_cmd
comma
id|ipr_erp_done
comma
id|ipr_timeout
comma
id|IPR_REQUEST_SENSE_TIMEOUT
op_star
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_erp_cancel_all - Send cancel all to a device&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function sends a cancel all to a device to clear the&n; * queue. If we are running TCQ on the device, QERR is set to 1,&n; * which means all outstanding ops have been dropped on the floor.&n; * Cancel all will return them to us.&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_erp_cancel_all
r_static
r_void
id|ipr_erp_cancel_all
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
op_assign
id|ipr_cmd-&gt;scsi_cmd
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
op_assign
id|scsi_cmd-&gt;device-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_cmd_pkt
op_star
id|cmd_pkt
suffix:semicolon
id|res-&gt;in_erp
op_assign
l_int|1
suffix:semicolon
id|ipr_reinit_ipr_cmnd_for_erp
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res-&gt;tcq_active
)paren
(brace
id|ipr_erp_request_sense
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cmd_pkt
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb.cmd_pkt
suffix:semicolon
id|cmd_pkt-&gt;request_type
op_assign
id|IPR_RQTYPE_IOACMD
suffix:semicolon
id|cmd_pkt-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPR_CANCEL_ALL_REQUESTS
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|ipr_cmd
comma
id|ipr_erp_request_sense
comma
id|ipr_timeout
comma
id|IPR_CANCEL_ALL_TIMEOUT
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_dump_ioasa - Dump contents of IOASA&n; * @ioa_cfg:&t;ioa config struct&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function is invoked by the interrupt handler when ops&n; * fail. It will log the IOASA if appropriate. Only called&n; * for GPDD ops.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_dump_ioasa
r_static
r_void
id|ipr_dump_ioasa
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|data_len
suffix:semicolon
id|u32
id|ioasc
suffix:semicolon
r_struct
id|ipr_ioasa
op_star
id|ioasa
op_assign
op_amp
id|ipr_cmd-&gt;ioasa
suffix:semicolon
id|u32
op_star
id|ioasa_data
op_assign
(paren
id|u32
op_star
)paren
id|ioasa
suffix:semicolon
r_int
id|error_index
suffix:semicolon
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ioasa-&gt;ioasc
)paren
op_amp
id|IPR_IOASC_IOASC_MASK
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|ioasc
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;log_level
OL
id|IPR_DEFAULT_LOG_LEVEL
)paren
r_return
suffix:semicolon
id|error_index
op_assign
id|ipr_get_error
c_func
(paren
id|ioasc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;log_level
OL
id|IPR_MAX_LOG_LEVEL
)paren
(brace
multiline_comment|/* Don&squot;t log an error if the IOA already logged one */
r_if
c_cond
(paren
id|ioasa-&gt;ilid
op_ne
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ipr_error_table
(braket
id|error_index
)braket
dot
id|log_ioasa
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
id|ipr_sdev_err
c_func
(paren
id|ipr_cmd-&gt;scsi_cmd-&gt;device
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|ipr_error_table
(braket
id|error_index
)braket
dot
id|error
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioasa-&gt;u.gpdd.end_state
op_le
id|ARRAY_SIZE
c_func
(paren
id|ipr_gpdd_dev_end_states
)paren
)paren
op_logical_and
(paren
id|ioasa-&gt;u.gpdd.bus_phase
op_le
id|ARRAY_SIZE
c_func
(paren
id|ipr_gpdd_dev_bus_phases
)paren
)paren
)paren
(brace
id|ipr_sdev_err
c_func
(paren
id|ipr_cmd-&gt;scsi_cmd-&gt;device
comma
l_string|&quot;Device End state: %s Phase: %s&bslash;n&quot;
comma
id|ipr_gpdd_dev_end_states
(braket
id|ioasa-&gt;u.gpdd.end_state
)braket
comma
id|ipr_gpdd_dev_bus_phases
(braket
id|ioasa-&gt;u.gpdd.bus_phase
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|ipr_ioasa
)paren
OL
id|be16_to_cpu
c_func
(paren
id|ioasa-&gt;ret_stat_len
)paren
)paren
id|data_len
op_assign
r_sizeof
(paren
r_struct
id|ipr_ioasa
)paren
suffix:semicolon
r_else
id|data_len
op_assign
id|be16_to_cpu
c_func
(paren
id|ioasa-&gt;ret_stat_len
)paren
suffix:semicolon
id|ipr_err
c_func
(paren
l_string|&quot;IOASA Dump:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data_len
op_div
l_int|4
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|ipr_err
c_func
(paren
l_string|&quot;%08X: %08X %08X %08X %08X&bslash;n&quot;
comma
id|i
op_star
l_int|4
comma
id|be32_to_cpu
c_func
(paren
id|ioasa_data
(braket
id|i
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|ioasa_data
(braket
id|i
op_plus
l_int|1
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|ioasa_data
(braket
id|i
op_plus
l_int|2
)braket
)paren
comma
id|be32_to_cpu
c_func
(paren
id|ioasa_data
(braket
id|i
op_plus
l_int|3
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ipr_gen_sense - Generate SCSI sense data from an IOASA&n; * @ioasa:&t;&t;IOASA&n; * @sense_buf:&t;sense data buffer&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_gen_sense
r_static
r_void
id|ipr_gen_sense
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
id|u32
id|failing_lba
suffix:semicolon
id|u8
op_star
id|sense_buf
op_assign
id|ipr_cmd-&gt;scsi_cmd-&gt;sense_buffer
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
op_assign
id|ipr_cmd-&gt;scsi_cmd-&gt;device-&gt;hostdata
suffix:semicolon
r_struct
id|ipr_ioasa
op_star
id|ioasa
op_assign
op_amp
id|ipr_cmd-&gt;ioasa
suffix:semicolon
id|u32
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ioasa-&gt;ioasc
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sense_buf
comma
l_int|0
comma
id|SCSI_SENSE_BUFFERSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioasc
op_ge
id|IPR_FIRST_DRIVER_IOASC
)paren
r_return
suffix:semicolon
id|ipr_cmd-&gt;scsi_cmd-&gt;result
op_assign
id|SAM_STAT_CHECK_CONDITION
suffix:semicolon
r_if
c_cond
(paren
id|ipr_is_vset_device
c_func
(paren
id|res
)paren
op_logical_and
id|ioasc
op_eq
id|IPR_IOASC_MED_DO_NOT_REALLOC
op_logical_and
id|ioasa-&gt;u.vset.failing_lba_hi
op_ne
l_int|0
)paren
(brace
id|sense_buf
(braket
l_int|0
)braket
op_assign
l_int|0x72
suffix:semicolon
id|sense_buf
(braket
l_int|1
)braket
op_assign
id|IPR_IOASC_SENSE_KEY
c_func
(paren
id|ioasc
)paren
suffix:semicolon
id|sense_buf
(braket
l_int|2
)braket
op_assign
id|IPR_IOASC_SENSE_CODE
c_func
(paren
id|ioasc
)paren
suffix:semicolon
id|sense_buf
(braket
l_int|3
)braket
op_assign
id|IPR_IOASC_SENSE_QUAL
c_func
(paren
id|ioasc
)paren
suffix:semicolon
id|sense_buf
(braket
l_int|7
)braket
op_assign
l_int|12
suffix:semicolon
id|sense_buf
(braket
l_int|8
)braket
op_assign
l_int|0
suffix:semicolon
id|sense_buf
(braket
l_int|9
)braket
op_assign
l_int|0x0A
suffix:semicolon
id|sense_buf
(braket
l_int|10
)braket
op_assign
l_int|0x80
suffix:semicolon
id|failing_lba
op_assign
id|be32_to_cpu
c_func
(paren
id|ioasa-&gt;u.vset.failing_lba_hi
)paren
suffix:semicolon
id|sense_buf
(braket
l_int|12
)braket
op_assign
(paren
id|failing_lba
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
suffix:semicolon
id|sense_buf
(braket
l_int|13
)braket
op_assign
(paren
id|failing_lba
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|sense_buf
(braket
l_int|14
)braket
op_assign
(paren
id|failing_lba
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|sense_buf
(braket
l_int|15
)braket
op_assign
id|failing_lba
op_amp
l_int|0x000000ff
suffix:semicolon
id|failing_lba
op_assign
id|be32_to_cpu
c_func
(paren
id|ioasa-&gt;u.vset.failing_lba_lo
)paren
suffix:semicolon
id|sense_buf
(braket
l_int|16
)braket
op_assign
(paren
id|failing_lba
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
suffix:semicolon
id|sense_buf
(braket
l_int|17
)braket
op_assign
(paren
id|failing_lba
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|sense_buf
(braket
l_int|18
)braket
op_assign
(paren
id|failing_lba
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|sense_buf
(braket
l_int|19
)braket
op_assign
id|failing_lba
op_amp
l_int|0x000000ff
suffix:semicolon
)brace
r_else
(brace
id|sense_buf
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|sense_buf
(braket
l_int|2
)braket
op_assign
id|IPR_IOASC_SENSE_KEY
c_func
(paren
id|ioasc
)paren
suffix:semicolon
id|sense_buf
(braket
l_int|12
)braket
op_assign
id|IPR_IOASC_SENSE_CODE
c_func
(paren
id|ioasc
)paren
suffix:semicolon
id|sense_buf
(braket
l_int|13
)braket
op_assign
id|IPR_IOASC_SENSE_QUAL
c_func
(paren
id|ioasc
)paren
suffix:semicolon
multiline_comment|/* Illegal request */
r_if
c_cond
(paren
(paren
id|IPR_IOASC_SENSE_KEY
c_func
(paren
id|ioasc
)paren
op_eq
l_int|0x05
)paren
op_logical_and
(paren
id|be32_to_cpu
c_func
(paren
id|ioasa-&gt;ioasc_specific
)paren
op_amp
id|IPR_FIELD_POINTER_VALID
)paren
)paren
(brace
id|sense_buf
(braket
l_int|7
)braket
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* additional length */
multiline_comment|/* IOARCB was in error */
r_if
c_cond
(paren
id|IPR_IOASC_SENSE_CODE
c_func
(paren
id|ioasc
)paren
op_eq
l_int|0x24
)paren
id|sense_buf
(braket
l_int|15
)braket
op_assign
l_int|0xC0
suffix:semicolon
r_else
multiline_comment|/* Parameter data was invalid */
id|sense_buf
(braket
l_int|15
)braket
op_assign
l_int|0x80
suffix:semicolon
id|sense_buf
(braket
l_int|16
)braket
op_assign
(paren
(paren
id|IPR_FIELD_POINTER_MASK
op_amp
id|be32_to_cpu
c_func
(paren
id|ioasa-&gt;ioasc_specific
)paren
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|sense_buf
(braket
l_int|17
)braket
op_assign
(paren
id|IPR_FIELD_POINTER_MASK
op_amp
id|be32_to_cpu
c_func
(paren
id|ioasa-&gt;ioasc_specific
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ioasc
op_eq
id|IPR_IOASC_MED_DO_NOT_REALLOC
)paren
(brace
r_if
c_cond
(paren
id|ipr_is_vset_device
c_func
(paren
id|res
)paren
)paren
id|failing_lba
op_assign
id|be32_to_cpu
c_func
(paren
id|ioasa-&gt;u.vset.failing_lba_lo
)paren
suffix:semicolon
r_else
id|failing_lba
op_assign
id|be32_to_cpu
c_func
(paren
id|ioasa-&gt;u.dasd.failing_lba
)paren
suffix:semicolon
id|sense_buf
(braket
l_int|0
)braket
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Or in the Valid bit */
id|sense_buf
(braket
l_int|3
)braket
op_assign
(paren
id|failing_lba
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
suffix:semicolon
id|sense_buf
(braket
l_int|4
)braket
op_assign
(paren
id|failing_lba
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|sense_buf
(braket
l_int|5
)braket
op_assign
(paren
id|failing_lba
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|sense_buf
(braket
l_int|6
)braket
op_assign
id|failing_lba
op_amp
l_int|0x000000ff
suffix:semicolon
)brace
id|sense_buf
(braket
l_int|7
)braket
op_assign
l_int|6
suffix:semicolon
multiline_comment|/* additional length */
)brace
)brace
)brace
multiline_comment|/**&n; * ipr_erp_start - Process an error response for a SCSI op&n; * @ioa_cfg:&t;ioa config struct&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function determines whether or not to initiate ERP&n; * on the affected device.&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_erp_start
r_static
r_void
id|ipr_erp_start
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
op_assign
id|ipr_cmd-&gt;scsi_cmd
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
op_assign
id|scsi_cmd-&gt;device-&gt;hostdata
suffix:semicolon
id|u32
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioasa.ioasc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|ipr_scsi_eh_done
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ipr_is_gscsi
c_func
(paren
id|res
)paren
)paren
id|ipr_dump_ioasa
c_func
(paren
id|ioa_cfg
comma
id|ipr_cmd
)paren
suffix:semicolon
r_else
id|ipr_gen_sense
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ioasc
op_amp
id|IPR_IOASC_IOASC_MASK
)paren
(brace
r_case
id|IPR_IOASC_ABORTED_CMD_TERM_BY_HOST
suffix:colon
id|scsi_cmd-&gt;result
op_or_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPR_IOASC_IR_RESOURCE_HANDLE
suffix:colon
id|scsi_cmd-&gt;result
op_or_assign
(paren
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPR_IOASC_HW_SEL_TIMEOUT
suffix:colon
id|scsi_cmd-&gt;result
op_or_assign
(paren
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
suffix:semicolon
id|res-&gt;needs_sync_complete
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPR_IOASC_SYNC_REQUIRED
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|res-&gt;in_erp
)paren
id|res-&gt;needs_sync_complete
op_assign
l_int|1
suffix:semicolon
id|scsi_cmd-&gt;result
op_or_assign
(paren
id|DID_IMM_RETRY
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPR_IOASC_MED_DO_NOT_REALLOC
suffix:colon
multiline_comment|/* prevent retries */
id|scsi_cmd-&gt;result
op_or_assign
(paren
id|DID_PASSTHROUGH
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPR_IOASC_BUS_WAS_RESET
suffix:colon
r_case
id|IPR_IOASC_BUS_WAS_RESET_BY_OTHER
suffix:colon
multiline_comment|/*&n;&t;&t; * Report the bus reset and ask for a retry. The device&n;&t;&t; * will give CC/UA the next command.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|res-&gt;resetting_device
)paren
id|scsi_report_bus_reset
c_func
(paren
id|ioa_cfg-&gt;host
comma
id|scsi_cmd-&gt;device-&gt;channel
)paren
suffix:semicolon
id|scsi_cmd-&gt;result
op_or_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|res-&gt;needs_sync_complete
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPR_IOASC_HW_DEV_BUS_STATUS
suffix:colon
id|scsi_cmd-&gt;result
op_or_assign
id|IPR_IOASC_SENSE_STATUS
c_func
(paren
id|ioasc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IPR_IOASC_SENSE_STATUS
c_func
(paren
id|ioasc
)paren
op_eq
id|SAM_STAT_CHECK_CONDITION
)paren
(brace
id|ipr_erp_cancel_all
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|res-&gt;needs_sync_complete
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPR_IOASC_NR_INIT_CMD_REQUIRED
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|scsi_cmd-&gt;result
op_or_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipr_is_vset_device
c_func
(paren
id|res
)paren
)paren
id|res-&gt;needs_sync_complete
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ipr_unmap_sglist
c_func
(paren
id|ioa_cfg
comma
id|ipr_cmd
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
id|scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scsi_cmd
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_scsi_done - mid-layer done function&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function is invoked by the interrupt handler for&n; * ops generated by the SCSI mid-layer&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_scsi_done
r_static
r_void
id|ipr_scsi_done
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
op_assign
id|ipr_cmd-&gt;scsi_cmd
suffix:semicolon
id|u32
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioasa.ioasc
)paren
suffix:semicolon
id|scsi_cmd-&gt;resid
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioasa.residual_data_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|IPR_IOASC_SENSE_KEY
c_func
(paren
id|ioasc
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|ipr_unmap_sglist
c_func
(paren
id|ioa_cfg
comma
id|ipr_cmd
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
id|scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scsi_cmd
)paren
suffix:semicolon
)brace
r_else
id|ipr_erp_start
c_func
(paren
id|ioa_cfg
comma
id|ipr_cmd
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_save_ioafp_mode_select - Save adapters mode select data&n; * @ioa_cfg:&t;ioa config struct&n; * @scsi_cmd:&t;scsi command struct&n; *&n; * This function saves mode select data for the adapter to&n; * use following an adapter reset.&n; *&n; * Return value:&n; *&t;0 on success / SCSI_MLQUEUE_HOST_BUSY on failure&n; **/
DECL|function|ipr_save_ioafp_mode_select
r_static
r_int
id|ipr_save_ioafp_mode_select
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;saved_mode_pages
)paren
(brace
id|ioa_cfg-&gt;saved_mode_pages
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_mode_pages
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;saved_mode_pages
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;IOA mode select buffer allocation failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
)brace
)brace
id|memcpy
c_func
(paren
id|ioa_cfg-&gt;saved_mode_pages
comma
id|scsi_cmd-&gt;buffer
comma
id|scsi_cmd-&gt;cmnd
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|ioa_cfg-&gt;saved_mode_page_len
op_assign
id|scsi_cmd-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_queuecommand - Queue a mid-layer request&n; * @scsi_cmd:&t;scsi command struct&n; * @done:&t;&t;done function&n; *&n; * This function queues a request generated by the mid-layer.&n; *&n; * Return value:&n; *&t;0 on success&n; *&t;SCSI_MLQUEUE_DEVICE_BUSY if device is busy&n; *&t;SCSI_MLQUEUE_HOST_BUSY if host is busy&n; **/
DECL|function|ipr_queuecommand
r_static
r_int
id|ipr_queuecommand
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scsi_cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
suffix:semicolon
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|scsi_cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|scsi_cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|res
op_assign
id|scsi_cmd-&gt;device-&gt;hostdata
suffix:semicolon
id|scsi_cmd-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We are currently blocking all devices due to a host reset&n;&t; * We have told the host to stop giving us new requests, but&n;&t; * ERP ops don&squot;t count. FIXME&n;&t; */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|ioa_cfg-&gt;allow_cmds
)paren
)paren
r_return
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
multiline_comment|/*&n;&t; * FIXME - Create scsi_set_host_offline interface&n;&t; *  and the ioa_is_dead check can be removed&n;&t; */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ioa_cfg-&gt;ioa_is_dead
op_logical_or
op_logical_neg
id|res
)paren
)paren
(brace
id|memset
c_func
(paren
id|scsi_cmd-&gt;sense_buffer
comma
l_int|0
comma
id|SCSI_SENSE_BUFFERSIZE
)paren
suffix:semicolon
id|scsi_cmd-&gt;result
op_assign
(paren
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
suffix:semicolon
id|scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scsi_cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ipr_cmd
op_assign
id|ipr_get_free_ipr_cmnd
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;pending_q
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ioarcb-&gt;cmd_pkt.cdb
comma
id|scsi_cmd-&gt;cmnd
comma
id|scsi_cmd-&gt;cmd_len
)paren
suffix:semicolon
id|ipr_cmd-&gt;scsi_cmd
op_assign
id|scsi_cmd
suffix:semicolon
id|ioarcb-&gt;res_handle
op_assign
id|res-&gt;cfgte.res_handle
suffix:semicolon
id|ipr_cmd-&gt;done
op_assign
id|ipr_scsi_done
suffix:semicolon
id|ipr_trc_hook
c_func
(paren
id|ipr_cmd
comma
id|IPR_TRACE_START
comma
id|IPR_GET_PHYS_LOC
c_func
(paren
id|res-&gt;cfgte.res_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipr_is_gscsi
c_func
(paren
id|res
)paren
op_logical_or
id|ipr_is_vset_device
c_func
(paren
id|res
)paren
)paren
(brace
r_if
c_cond
(paren
id|scsi_cmd-&gt;underflow
op_eq
l_int|0
)paren
id|ioarcb-&gt;cmd_pkt.flags_hi
op_or_assign
id|IPR_FLAGS_HI_NO_ULEN_CHK
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;needs_sync_complete
)paren
(brace
id|ioarcb-&gt;cmd_pkt.flags_hi
op_or_assign
id|IPR_FLAGS_HI_SYNC_COMPLETE
suffix:semicolon
id|res-&gt;needs_sync_complete
op_assign
l_int|0
suffix:semicolon
)brace
id|ioarcb-&gt;cmd_pkt.flags_hi
op_or_assign
id|IPR_FLAGS_HI_NO_LINK_DESC
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.flags_lo
op_or_assign
id|IPR_FLAGS_LO_DELAY_AFTER_RST
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.flags_lo
op_or_assign
id|IPR_FLAGS_LO_ALIGNED_BFR
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.flags_lo
op_or_assign
id|ipr_get_task_attributes
c_func
(paren
id|scsi_cmd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ipr_is_gscsi
c_func
(paren
id|res
)paren
op_logical_and
id|scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_ge
l_int|0xC0
)paren
id|ioarcb-&gt;cmd_pkt.request_type
op_assign
id|IPR_RQTYPE_IOACMD
suffix:semicolon
r_if
c_cond
(paren
id|ipr_is_ioa_resource
c_func
(paren
id|res
)paren
op_logical_and
id|scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|MODE_SELECT
)paren
id|rc
op_assign
id|ipr_save_ioafp_mode_select
c_func
(paren
id|ioa_cfg
comma
id|scsi_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|rc
op_eq
l_int|0
)paren
)paren
id|rc
op_assign
id|ipr_build_ioadl
c_func
(paren
id|ioa_cfg
comma
id|ipr_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|rc
op_eq
l_int|0
)paren
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioarcb.ioarcb_host_pci_addr
)paren
comma
id|ioa_cfg-&gt;regs.ioarrin_reg
)paren
suffix:semicolon
)brace
r_else
(brace
id|list_move_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
r_return
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_info - Get information about the card/driver&n; * @scsi_host:&t;scsi host struct&n; *&n; * Return value:&n; * &t;pointer to buffer with description string&n; **/
DECL|function|ipr_ioa_info
r_static
r_const
r_char
op_star
id|ipr_ioa_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_static
r_char
id|buffer
(braket
l_int|512
)braket
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;IBM %X Storage Adapter&quot;
comma
id|ioa_cfg-&gt;type
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
DECL|variable|driver_template
r_static
r_struct
id|scsi_host_template
id|driver_template
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;IPR&quot;
comma
dot
id|info
op_assign
id|ipr_ioa_info
comma
dot
id|queuecommand
op_assign
id|ipr_queuecommand
comma
dot
id|eh_abort_handler
op_assign
id|ipr_eh_abort
comma
dot
id|eh_device_reset_handler
op_assign
id|ipr_eh_dev_reset
comma
dot
id|eh_host_reset_handler
op_assign
id|ipr_eh_host_reset
comma
dot
id|slave_alloc
op_assign
id|ipr_slave_alloc
comma
dot
id|slave_configure
op_assign
id|ipr_slave_configure
comma
dot
id|slave_destroy
op_assign
id|ipr_slave_destroy
comma
dot
id|bios_param
op_assign
id|ipr_biosparam
comma
dot
id|can_queue
op_assign
id|IPR_MAX_COMMANDS
comma
dot
id|this_id
op_assign
op_minus
l_int|1
comma
dot
id|sg_tablesize
op_assign
id|IPR_MAX_SGLIST
comma
dot
id|max_sectors
op_assign
id|IPR_MAX_SECTORS
comma
dot
id|cmd_per_lun
op_assign
id|IPR_MAX_CMD_PER_LUN
comma
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
dot
id|shost_attrs
op_assign
id|ipr_ioa_attrs
comma
dot
id|sdev_attrs
op_assign
id|ipr_dev_attrs
comma
dot
id|proc_name
op_assign
id|IPR_NAME
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PPC_PSERIES
DECL|variable|ipr_blocked_processors
r_static
r_const
id|u16
id|ipr_blocked_processors
(braket
)braket
op_assign
(brace
id|PV_NORTHSTAR
comma
id|PV_PULSAR
comma
id|PV_POWER4
comma
id|PV_ICESTAR
comma
id|PV_SSTAR
comma
id|PV_POWER4p
comma
id|PV_630
comma
id|PV_630p
)brace
suffix:semicolon
multiline_comment|/**&n; * ipr_invalid_adapter - Determine if this adapter is supported on this hardware&n; * @ioa_cfg:&t;ioa cfg struct&n; *&n; * Adapters that use Gemstone revision &lt; 3.1 do not work reliably on&n; * certain pSeries hardware. This function determines if the given&n; * adapter is in one of these confgurations or not.&n; *&n; * Return value:&n; * &t;1 if adapter is not supported / 0 if adapter is supported&n; **/
DECL|function|ipr_invalid_adapter
r_static
r_int
id|ipr_invalid_adapter
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
id|u8
id|rev_id
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;type
op_eq
l_int|0x5702
)paren
(brace
r_if
c_cond
(paren
id|pci_read_config_byte
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|PCI_REVISION_ID
comma
op_amp
id|rev_id
)paren
op_eq
id|PCIBIOS_SUCCESSFUL
)paren
(brace
r_if
c_cond
(paren
id|rev_id
OL
l_int|4
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|ipr_blocked_processors
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|__is_processor
c_func
(paren
id|ipr_blocked_processors
(braket
id|i
)braket
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|macro|ipr_invalid_adapter
mdefine_line|#define ipr_invalid_adapter(ioa_cfg) 0
macro_line|#endif
multiline_comment|/**&n; * ipr_ioa_bringdown_done - IOA bring down completion.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function processes the completion of an adapter bring down.&n; * It wakes any reset sleepers.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_ioa_bringdown_done
r_static
r_int
id|ipr_ioa_bringdown_done
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
id|ENTER
suffix:semicolon
id|ioa_cfg-&gt;in_reset_reload
op_assign
l_int|0
suffix:semicolon
id|ioa_cfg-&gt;reset_retries
op_assign
l_int|0
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
id|wake_up_all
c_func
(paren
op_amp
id|ioa_cfg-&gt;reset_wait_q
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|scsi_unblock_requests
c_func
(paren
id|ioa_cfg-&gt;host
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_ioa_reset_done - IOA reset completion.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function processes the completion of an adapter reset.&n; * It schedules any necessary mid-layer add/removes and&n; * wakes any reset sleepers.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_ioa_reset_done
r_static
r_int
id|ipr_ioa_reset_done
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
suffix:semicolon
r_struct
id|ipr_hostrcb
op_star
id|hostrcb
comma
op_star
id|temp
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|ENTER
suffix:semicolon
id|ioa_cfg-&gt;in_reset_reload
op_assign
l_int|0
suffix:semicolon
id|ioa_cfg-&gt;allow_cmds
op_assign
l_int|1
suffix:semicolon
id|ioa_cfg-&gt;reset_cmd
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|res
comma
op_amp
id|ioa_cfg-&gt;used_res_q
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
id|ioa_cfg-&gt;allow_ml_add_del
op_logical_and
(paren
id|res-&gt;add_to_ml
op_logical_or
id|res-&gt;del_from_ml
)paren
)paren
(brace
id|ipr_trace
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|ioa_cfg-&gt;work_q
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|list_for_each_entry_safe
c_func
(paren
id|hostrcb
comma
id|temp
comma
op_amp
id|ioa_cfg-&gt;hostrcb_free_q
comma
id|queue
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|hostrcb-&gt;queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_increment
OL
id|IPR_NUM_LOG_HCAMS
)paren
id|ipr_send_hcam
c_func
(paren
id|ioa_cfg
comma
id|IPR_HCAM_CDB_OP_CODE_LOG_DATA
comma
id|hostrcb
)paren
suffix:semicolon
r_else
id|ipr_send_hcam
c_func
(paren
id|ioa_cfg
comma
id|IPR_HCAM_CDB_OP_CODE_CONFIG_CHANGE
comma
id|hostrcb
)paren
suffix:semicolon
)brace
id|dev_info
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;IOA initialized.&bslash;n&quot;
)paren
suffix:semicolon
id|ioa_cfg-&gt;reset_retries
op_assign
l_int|0
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
id|wake_up_all
c_func
(paren
op_amp
id|ioa_cfg-&gt;reset_wait_q
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|scsi_unblock_requests
c_func
(paren
id|ioa_cfg-&gt;host
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;allow_cmds
)paren
id|scsi_block_requests
c_func
(paren
id|ioa_cfg-&gt;host
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_set_sup_dev_dflt - Initialize a Set Supported Device buffer&n; * @supported_dev:&t;supported device struct&n; * @vpids:&t;&t;&t;vendor product id struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_set_sup_dev_dflt
r_static
r_void
id|ipr_set_sup_dev_dflt
c_func
(paren
r_struct
id|ipr_supported_device
op_star
id|supported_dev
comma
r_struct
id|ipr_std_inq_vpids
op_star
id|vpids
)paren
(brace
id|memset
c_func
(paren
id|supported_dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ipr_supported_device
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|supported_dev-&gt;vpids
comma
id|vpids
comma
r_sizeof
(paren
r_struct
id|ipr_std_inq_vpids
)paren
)paren
suffix:semicolon
id|supported_dev-&gt;num_records
op_assign
l_int|1
suffix:semicolon
id|supported_dev-&gt;data_length
op_assign
id|cpu_to_be16
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_supported_device
)paren
)paren
suffix:semicolon
id|supported_dev-&gt;reserved
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_set_supported_devs - Send Set Supported Devices for a device&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function send a Set Supported Devices to the adapter&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_set_supported_devs
r_static
r_int
id|ipr_set_supported_devs
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_supported_device
op_star
id|supp_dev
op_assign
op_amp
id|ioa_cfg-&gt;vpd_cbs-&gt;supp_dev
suffix:semicolon
r_struct
id|ipr_ioadl_desc
op_star
id|ioadl
op_assign
id|ipr_cmd-&gt;ioadl
suffix:semicolon
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
op_assign
id|ipr_cmd-&gt;u.res
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_ioa_reset_done
suffix:semicolon
id|list_for_each_entry_continue
c_func
(paren
id|res
comma
op_amp
id|ioa_cfg-&gt;used_res_q
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ipr_is_af_dasd_device
c_func
(paren
id|res
)paren
)paren
r_continue
suffix:semicolon
id|ipr_cmd-&gt;u.res
op_assign
id|res
suffix:semicolon
id|ipr_set_sup_dev_dflt
c_func
(paren
id|supp_dev
comma
op_amp
id|res-&gt;cfgte.std_inq_data.vpids
)paren
suffix:semicolon
id|ioarcb-&gt;res_handle
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOA_RES_HANDLE
)paren
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.flags_hi
op_or_assign
id|IPR_FLAGS_HI_WRITE_NOT_READ
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.request_type
op_assign
id|IPR_RQTYPE_IOACMD
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|0
)braket
op_assign
id|IPR_SET_SUPPORTED_DEVICES
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|7
)braket
op_assign
(paren
r_sizeof
(paren
r_struct
id|ipr_supported_device
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|8
)braket
op_assign
r_sizeof
(paren
r_struct
id|ipr_supported_device
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ioadl-&gt;flags_and_data_len
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOADL_FLAGS_WRITE_LAST
op_or
r_sizeof
(paren
r_struct
id|ipr_supported_device
)paren
)paren
suffix:semicolon
id|ioadl-&gt;address
op_assign
id|cpu_to_be32
c_func
(paren
id|ioa_cfg-&gt;vpd_cbs_dma
op_plus
m_offsetof
(paren
r_struct
id|ipr_misc_cbs
comma
id|supp_dev
)paren
)paren
suffix:semicolon
id|ioarcb-&gt;write_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
)paren
suffix:semicolon
id|ioarcb-&gt;write_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_supported_device
)paren
)paren
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|ipr_cmd
comma
id|ipr_reset_ioa_job
comma
id|ipr_timeout
comma
id|IPR_SET_SUP_DEVICE_TIMEOUT
)paren
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_set_supported_devs
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
r_return
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_get_mode_page - Locate specified mode page&n; * @mode_pages:&t;mode page buffer&n; * @page_code:&t;page code to find&n; * @len:&t;&t;minimum required length for mode page&n; *&n; * Return value:&n; * &t;pointer to mode page / NULL on failure&n; **/
DECL|function|ipr_get_mode_page
r_static
r_void
op_star
id|ipr_get_mode_page
c_func
(paren
r_struct
id|ipr_mode_pages
op_star
id|mode_pages
comma
id|u32
id|page_code
comma
id|u32
id|len
)paren
(brace
r_struct
id|ipr_mode_page_hdr
op_star
id|mode_hdr
suffix:semicolon
id|u32
id|page_length
suffix:semicolon
id|u32
id|length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mode_pages
op_logical_or
(paren
id|mode_pages-&gt;hdr.length
op_eq
l_int|0
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|length
op_assign
(paren
id|mode_pages-&gt;hdr.length
op_plus
l_int|1
)paren
op_minus
l_int|4
op_minus
id|mode_pages-&gt;hdr.block_desc_len
suffix:semicolon
id|mode_hdr
op_assign
(paren
r_struct
id|ipr_mode_page_hdr
op_star
)paren
(paren
id|mode_pages-&gt;data
op_plus
id|mode_pages-&gt;hdr.block_desc_len
)paren
suffix:semicolon
r_while
c_loop
(paren
id|length
)paren
(brace
r_if
c_cond
(paren
id|IPR_GET_MODE_PAGE_CODE
c_func
(paren
id|mode_hdr
)paren
op_eq
id|page_code
)paren
(brace
r_if
c_cond
(paren
id|mode_hdr-&gt;page_length
op_ge
(paren
id|len
op_minus
r_sizeof
(paren
r_struct
id|ipr_mode_page_hdr
)paren
)paren
)paren
r_return
id|mode_hdr
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|page_length
op_assign
(paren
r_sizeof
(paren
r_struct
id|ipr_mode_page_hdr
)paren
op_plus
id|mode_hdr-&gt;page_length
)paren
suffix:semicolon
id|length
op_sub_assign
id|page_length
suffix:semicolon
id|mode_hdr
op_assign
(paren
r_struct
id|ipr_mode_page_hdr
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|mode_hdr
op_plus
id|page_length
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_check_term_power - Check for term power errors&n; * @ioa_cfg:&t;ioa config struct&n; * @mode_pages:&t;IOAFP mode pages buffer&n; *&n; * Check the IOAFP&squot;s mode page 28 for term power errors&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_check_term_power
r_static
r_void
id|ipr_check_term_power
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_mode_pages
op_star
id|mode_pages
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|entry_length
suffix:semicolon
r_struct
id|ipr_dev_bus_entry
op_star
id|bus
suffix:semicolon
r_struct
id|ipr_mode_page28
op_star
id|mode_page
suffix:semicolon
id|mode_page
op_assign
id|ipr_get_mode_page
c_func
(paren
id|mode_pages
comma
l_int|0x28
comma
r_sizeof
(paren
r_struct
id|ipr_mode_page28
)paren
)paren
suffix:semicolon
id|entry_length
op_assign
id|mode_page-&gt;entry_length
suffix:semicolon
id|bus
op_assign
id|mode_page-&gt;bus
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mode_page-&gt;num_entries
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|bus-&gt;flags
op_amp
id|IPR_SCSI_ATTR_NO_TERM_PWR
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Term power is absent on scsi bus %d&bslash;n&quot;
comma
id|bus-&gt;res_addr.bus
)paren
suffix:semicolon
)brace
id|bus
op_assign
(paren
r_struct
id|ipr_dev_bus_entry
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|bus
op_plus
id|entry_length
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ipr_scsi_bus_speed_limit - Limit the SCSI speed based on SES table&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Looks through the config table checking for SES devices. If&n; * the SES device is in the SES table indicating a maximum SCSI&n; * bus speed, the speed is limited for the bus.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_scsi_bus_speed_limit
r_static
r_void
id|ipr_scsi_bus_speed_limit
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
id|u32
id|max_xfer_rate
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPR_MAX_NUM_BUSES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|max_xfer_rate
op_assign
id|ipr_get_max_scsi_speed
c_func
(paren
id|ioa_cfg
comma
id|i
comma
id|ioa_cfg-&gt;bus_attr
(braket
id|i
)braket
dot
id|bus_width
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max_xfer_rate
OL
id|ioa_cfg-&gt;bus_attr
(braket
id|i
)braket
dot
id|max_xfer_rate
)paren
id|ioa_cfg-&gt;bus_attr
(braket
id|i
)braket
dot
id|max_xfer_rate
op_assign
id|max_xfer_rate
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ipr_modify_ioafp_mode_page_28 - Modify IOAFP Mode Page 28&n; * @ioa_cfg:&t;ioa config struct&n; * @mode_pages:&t;mode page 28 buffer&n; *&n; * Updates mode page 28 based on driver configuration&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_modify_ioafp_mode_page_28
r_static
r_void
id|ipr_modify_ioafp_mode_page_28
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|ipr_mode_pages
op_star
id|mode_pages
)paren
(brace
r_int
id|i
comma
id|entry_length
suffix:semicolon
r_struct
id|ipr_dev_bus_entry
op_star
id|bus
suffix:semicolon
r_struct
id|ipr_bus_attributes
op_star
id|bus_attr
suffix:semicolon
r_struct
id|ipr_mode_page28
op_star
id|mode_page
suffix:semicolon
id|mode_page
op_assign
id|ipr_get_mode_page
c_func
(paren
id|mode_pages
comma
l_int|0x28
comma
r_sizeof
(paren
r_struct
id|ipr_mode_page28
)paren
)paren
suffix:semicolon
id|entry_length
op_assign
id|mode_page-&gt;entry_length
suffix:semicolon
multiline_comment|/* Loop for each device bus entry */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|bus
op_assign
id|mode_page-&gt;bus
suffix:semicolon
id|i
OL
id|mode_page-&gt;num_entries
suffix:semicolon
id|i
op_increment
comma
id|bus
op_assign
(paren
r_struct
id|ipr_dev_bus_entry
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|bus
op_plus
id|entry_length
)paren
)paren
(brace
r_if
c_cond
(paren
id|bus-&gt;res_addr.bus
OG
id|IPR_MAX_NUM_BUSES
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Invalid resource address reported: 0x%08X&bslash;n&quot;
comma
id|IPR_GET_PHYS_LOC
c_func
(paren
id|bus-&gt;res_addr
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|bus_attr
op_assign
op_amp
id|ioa_cfg-&gt;bus_attr
(braket
id|i
)braket
suffix:semicolon
id|bus-&gt;extended_reset_delay
op_assign
id|IPR_EXTENDED_RESET_DELAY
suffix:semicolon
id|bus-&gt;bus_width
op_assign
id|bus_attr-&gt;bus_width
suffix:semicolon
id|bus-&gt;max_xfer_rate
op_assign
id|cpu_to_be32
c_func
(paren
id|bus_attr-&gt;max_xfer_rate
)paren
suffix:semicolon
id|bus-&gt;flags
op_and_assign
op_complement
id|IPR_SCSI_ATTR_QAS_MASK
suffix:semicolon
r_if
c_cond
(paren
id|bus_attr-&gt;qas_enabled
)paren
id|bus-&gt;flags
op_or_assign
id|IPR_SCSI_ATTR_ENABLE_QAS
suffix:semicolon
r_else
id|bus-&gt;flags
op_or_assign
id|IPR_SCSI_ATTR_DISABLE_QAS
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ipr_build_mode_select - Build a mode select command&n; * @ipr_cmd:&t;ipr command struct&n; * @res_handle:&t;resource handle to send command to&n; * @parm:&t;&t;Byte 2 of Mode Sense command&n; * @dma_addr:&t;DMA buffer address&n; * @xfer_len:&t;data transfer length&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_build_mode_select
r_static
r_void
id|ipr_build_mode_select
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
comma
id|u32
id|res_handle
comma
id|u8
id|parm
comma
id|u32
id|dma_addr
comma
id|u8
id|xfer_len
)paren
(brace
r_struct
id|ipr_ioadl_desc
op_star
id|ioadl
op_assign
id|ipr_cmd-&gt;ioadl
suffix:semicolon
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
id|ioarcb-&gt;res_handle
op_assign
id|res_handle
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.request_type
op_assign
id|IPR_RQTYPE_SCSICDB
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.flags_hi
op_or_assign
id|IPR_FLAGS_HI_WRITE_NOT_READ
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|0
)braket
op_assign
id|MODE_SELECT
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|1
)braket
op_assign
id|parm
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|4
)braket
op_assign
id|xfer_len
suffix:semicolon
id|ioadl-&gt;flags_and_data_len
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOADL_FLAGS_WRITE_LAST
op_or
id|xfer_len
)paren
suffix:semicolon
id|ioadl-&gt;address
op_assign
id|cpu_to_be32
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
id|ioarcb-&gt;write_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
)paren
suffix:semicolon
id|ioarcb-&gt;write_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
id|xfer_len
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_ioafp_mode_select_page28 - Issue Mode Select Page 28 to IOA&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function sets up the SCSI bus attributes and sends&n; * a Mode Select for Page 28 to activate them.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_ioafp_mode_select_page28
r_static
r_int
id|ipr_ioafp_mode_select_page28
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_mode_pages
op_star
id|mode_pages
op_assign
op_amp
id|ioa_cfg-&gt;vpd_cbs-&gt;mode_pages
suffix:semicolon
r_int
id|length
suffix:semicolon
id|ENTER
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;saved_mode_pages
)paren
(brace
id|memcpy
c_func
(paren
id|mode_pages
comma
id|ioa_cfg-&gt;saved_mode_pages
comma
id|ioa_cfg-&gt;saved_mode_page_len
)paren
suffix:semicolon
id|length
op_assign
id|ioa_cfg-&gt;saved_mode_page_len
suffix:semicolon
)brace
r_else
(brace
id|ipr_scsi_bus_speed_limit
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|ipr_check_term_power
c_func
(paren
id|ioa_cfg
comma
id|mode_pages
)paren
suffix:semicolon
id|ipr_modify_ioafp_mode_page_28
c_func
(paren
id|ioa_cfg
comma
id|mode_pages
)paren
suffix:semicolon
id|length
op_assign
id|mode_pages-&gt;hdr.length
op_plus
l_int|1
suffix:semicolon
id|mode_pages-&gt;hdr.length
op_assign
l_int|0
suffix:semicolon
)brace
id|ipr_build_mode_select
c_func
(paren
id|ipr_cmd
comma
id|cpu_to_be32
c_func
(paren
id|IPR_IOA_RES_HANDLE
)paren
comma
l_int|0x11
comma
id|ioa_cfg-&gt;vpd_cbs_dma
op_plus
m_offsetof
(paren
r_struct
id|ipr_misc_cbs
comma
id|mode_pages
)paren
comma
id|length
)paren
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_set_supported_devs
suffix:semicolon
id|ipr_cmd-&gt;u.res
op_assign
id|list_entry
c_func
(paren
id|ioa_cfg-&gt;used_res_q.next
comma
r_struct
id|ipr_resource_entry
comma
id|queue
)paren
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|ipr_cmd
comma
id|ipr_reset_ioa_job
comma
id|ipr_timeout
comma
id|IPR_INTERNAL_TIMEOUT
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_build_mode_sense - Builds a mode sense command&n; * @ipr_cmd:&t;ipr command struct&n; * @res:&t;&t;resource entry struct&n; * @parm:&t;&t;Byte 2 of mode sense command&n; * @dma_addr:&t;DMA address of mode sense buffer&n; * @xfer_len:&t;Size of DMA buffer&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_build_mode_sense
r_static
r_void
id|ipr_build_mode_sense
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
comma
id|u32
id|res_handle
comma
id|u8
id|parm
comma
id|u32
id|dma_addr
comma
id|u8
id|xfer_len
)paren
(brace
r_struct
id|ipr_ioadl_desc
op_star
id|ioadl
op_assign
id|ipr_cmd-&gt;ioadl
suffix:semicolon
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
id|ioarcb-&gt;res_handle
op_assign
id|res_handle
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|0
)braket
op_assign
id|MODE_SENSE
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|2
)braket
op_assign
id|parm
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|4
)braket
op_assign
id|xfer_len
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.request_type
op_assign
id|IPR_RQTYPE_SCSICDB
suffix:semicolon
id|ioadl-&gt;flags_and_data_len
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOADL_FLAGS_READ_LAST
op_or
id|xfer_len
)paren
suffix:semicolon
id|ioadl-&gt;address
op_assign
id|cpu_to_be32
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
id|ioarcb-&gt;read_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
)paren
suffix:semicolon
id|ioarcb-&gt;read_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
id|xfer_len
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_ioafp_mode_sense_page28 - Issue Mode Sense Page 28 to IOA&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function send a Page 28 mode sense to the IOA to&n; * retrieve SCSI bus attributes.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_ioafp_mode_sense_page28
r_static
r_int
id|ipr_ioafp_mode_sense_page28
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
id|ENTER
suffix:semicolon
id|ipr_build_mode_sense
c_func
(paren
id|ipr_cmd
comma
id|cpu_to_be32
c_func
(paren
id|IPR_IOA_RES_HANDLE
)paren
comma
l_int|0x28
comma
id|ioa_cfg-&gt;vpd_cbs_dma
op_plus
m_offsetof
(paren
r_struct
id|ipr_misc_cbs
comma
id|mode_pages
)paren
comma
r_sizeof
(paren
r_struct
id|ipr_mode_pages
)paren
)paren
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_ioafp_mode_select_page28
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|ipr_cmd
comma
id|ipr_reset_ioa_job
comma
id|ipr_timeout
comma
id|IPR_INTERNAL_TIMEOUT
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_init_res_table - Initialize the resource table&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function looks through the existing resource table, comparing&n; * it with the config table. This function will take care of old/new&n; * devices and schedule adding/removing them from the mid-layer&n; * as appropriate.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_CONTINUE&n; **/
DECL|function|ipr_init_res_table
r_static
r_int
id|ipr_init_res_table
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_resource_entry
op_star
id|res
comma
op_star
id|temp
suffix:semicolon
r_struct
id|ipr_config_table_entry
op_star
id|cfgte
suffix:semicolon
r_int
id|found
comma
id|i
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|old_res
)paren
suffix:semicolon
id|ENTER
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;cfg_table-&gt;hdr.flags
op_amp
id|IPR_UCODE_DOWNLOAD_REQ
)paren
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Microcode download required&bslash;n&quot;
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|res
comma
id|temp
comma
op_amp
id|ioa_cfg-&gt;used_res_q
comma
id|queue
)paren
id|list_move_tail
c_func
(paren
op_amp
id|res-&gt;queue
comma
op_amp
id|old_res
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ioa_cfg-&gt;cfg_table-&gt;hdr.num_entries
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cfgte
op_assign
op_amp
id|ioa_cfg-&gt;cfg_table-&gt;dev
(braket
id|i
)braket
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|res
comma
id|temp
comma
op_amp
id|old_res
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|res-&gt;cfgte.res_addr
comma
op_amp
id|cfgte-&gt;res_addr
comma
r_sizeof
(paren
id|cfgte-&gt;res_addr
)paren
)paren
)paren
(brace
id|list_move_tail
c_func
(paren
op_amp
id|res-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;used_res_q
)paren
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ioa_cfg-&gt;free_res_q
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Too many devices attached&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|found
op_assign
l_int|1
suffix:semicolon
id|res
op_assign
id|list_entry
c_func
(paren
id|ioa_cfg-&gt;free_res_q.next
comma
r_struct
id|ipr_resource_entry
comma
id|queue
)paren
suffix:semicolon
id|list_move_tail
c_func
(paren
op_amp
id|res-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;used_res_q
)paren
suffix:semicolon
id|ipr_init_res_entry
c_func
(paren
id|res
)paren
suffix:semicolon
id|res-&gt;add_to_ml
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
)paren
id|memcpy
c_func
(paren
op_amp
id|res-&gt;cfgte
comma
id|cfgte
comma
r_sizeof
(paren
r_struct
id|ipr_config_table_entry
)paren
)paren
suffix:semicolon
)brace
id|list_for_each_entry_safe
c_func
(paren
id|res
comma
id|temp
comma
op_amp
id|old_res
comma
id|queue
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;sdev
)paren
(brace
id|res-&gt;del_from_ml
op_assign
l_int|1
suffix:semicolon
id|list_move_tail
c_func
(paren
op_amp
id|res-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;used_res_q
)paren
suffix:semicolon
)brace
r_else
(brace
id|list_move_tail
c_func
(paren
op_amp
id|res-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_res_q
)paren
suffix:semicolon
)brace
)brace
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_ioafp_mode_sense_page28
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_ioafp_query_ioa_cfg - Send a Query IOA Config to the adapter.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function sends a Query IOA Configuration command&n; * to the adapter to retrieve the IOA configuration table.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_ioafp_query_ioa_cfg
r_static
r_int
id|ipr_ioafp_query_ioa_cfg
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
r_struct
id|ipr_ioadl_desc
op_star
id|ioadl
op_assign
id|ipr_cmd-&gt;ioadl
suffix:semicolon
r_struct
id|ipr_inquiry_page3
op_star
id|ucode_vpd
op_assign
op_amp
id|ioa_cfg-&gt;vpd_cbs-&gt;page3_data
suffix:semicolon
id|ENTER
suffix:semicolon
id|dev_info
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Adapter firmware version: %02X%02X%02X%02X&bslash;n&quot;
comma
id|ucode_vpd-&gt;major_release
comma
id|ucode_vpd-&gt;card_type
comma
id|ucode_vpd-&gt;minor_release
(braket
l_int|0
)braket
comma
id|ucode_vpd-&gt;minor_release
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.request_type
op_assign
id|IPR_RQTYPE_IOACMD
suffix:semicolon
id|ioarcb-&gt;res_handle
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOA_RES_HANDLE
)paren
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|0
)braket
op_assign
id|IPR_QUERY_IOA_CONFIG
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|7
)braket
op_assign
(paren
r_sizeof
(paren
r_struct
id|ipr_config_table
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|8
)braket
op_assign
r_sizeof
(paren
r_struct
id|ipr_config_table
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ioarcb-&gt;read_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
)paren
suffix:semicolon
id|ioarcb-&gt;read_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_config_table
)paren
)paren
suffix:semicolon
id|ioadl-&gt;address
op_assign
id|cpu_to_be32
c_func
(paren
id|ioa_cfg-&gt;cfg_table_dma
)paren
suffix:semicolon
id|ioadl-&gt;flags_and_data_len
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOADL_FLAGS_READ_LAST
op_or
r_sizeof
(paren
r_struct
id|ipr_config_table
)paren
)paren
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_init_res_table
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|ipr_cmd
comma
id|ipr_reset_ioa_job
comma
id|ipr_timeout
comma
id|IPR_INTERNAL_TIMEOUT
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_ioafp_inquiry - Send an Inquiry to the adapter.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This utility function sends an inquiry to the adapter.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_ioafp_inquiry
r_static
r_void
id|ipr_ioafp_inquiry
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
comma
id|u8
id|flags
comma
id|u8
id|page
comma
id|u32
id|dma_addr
comma
id|u8
id|xfer_len
)paren
(brace
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
r_struct
id|ipr_ioadl_desc
op_star
id|ioadl
op_assign
id|ipr_cmd-&gt;ioadl
suffix:semicolon
id|ENTER
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.request_type
op_assign
id|IPR_RQTYPE_SCSICDB
suffix:semicolon
id|ioarcb-&gt;res_handle
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOA_RES_HANDLE
)paren
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|0
)braket
op_assign
id|INQUIRY
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|1
)braket
op_assign
id|flags
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|2
)braket
op_assign
id|page
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|4
)braket
op_assign
id|xfer_len
suffix:semicolon
id|ioarcb-&gt;read_ioadl_len
op_assign
id|cpu_to_be32
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioadl_desc
)paren
)paren
suffix:semicolon
id|ioarcb-&gt;read_data_transfer_length
op_assign
id|cpu_to_be32
c_func
(paren
id|xfer_len
)paren
suffix:semicolon
id|ioadl-&gt;address
op_assign
id|cpu_to_be32
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
id|ioadl-&gt;flags_and_data_len
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOADL_FLAGS_READ_LAST
op_or
id|xfer_len
)paren
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|ipr_cmd
comma
id|ipr_reset_ioa_job
comma
id|ipr_timeout
comma
id|IPR_INTERNAL_TIMEOUT
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_ioafp_page3_inquiry - Send a Page 3 Inquiry to the adapter.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function sends a Page 3 inquiry to the adapter&n; * to retrieve software VPD information.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_ioafp_page3_inquiry
r_static
r_int
id|ipr_ioafp_page3_inquiry
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_char
id|type
(braket
l_int|5
)braket
suffix:semicolon
id|ENTER
suffix:semicolon
multiline_comment|/* Grab the type out of the VPD and store it away */
id|memcpy
c_func
(paren
id|type
comma
id|ioa_cfg-&gt;vpd_cbs-&gt;ioa_vpd.std_inq_data.vpids.product_id
comma
l_int|4
)paren
suffix:semicolon
id|type
(braket
l_int|4
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|ioa_cfg-&gt;type
op_assign
id|simple_strtoul
c_func
(paren
(paren
r_char
op_star
)paren
id|type
comma
l_int|NULL
comma
l_int|16
)paren
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_ioafp_query_ioa_cfg
suffix:semicolon
id|ipr_ioafp_inquiry
c_func
(paren
id|ipr_cmd
comma
l_int|1
comma
l_int|3
comma
id|ioa_cfg-&gt;vpd_cbs_dma
op_plus
m_offsetof
(paren
r_struct
id|ipr_misc_cbs
comma
id|page3_data
)paren
comma
r_sizeof
(paren
r_struct
id|ipr_inquiry_page3
)paren
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_ioafp_std_inquiry - Send a Standard Inquiry to the adapter.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function sends a standard inquiry to the adapter.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_ioafp_std_inquiry
r_static
r_int
id|ipr_ioafp_std_inquiry
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
id|ENTER
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_ioafp_page3_inquiry
suffix:semicolon
id|ipr_ioafp_inquiry
c_func
(paren
id|ipr_cmd
comma
l_int|0
comma
l_int|0
comma
id|ioa_cfg-&gt;vpd_cbs_dma
op_plus
m_offsetof
(paren
r_struct
id|ipr_misc_cbs
comma
id|ioa_vpd
)paren
comma
r_sizeof
(paren
r_struct
id|ipr_ioa_vpd
)paren
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_ioafp_indentify_hrrq - Send Identify Host RRQ.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function send an Identify Host Request Response Queue&n; * command to establish the HRRQ with the adapter.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_ioafp_indentify_hrrq
r_static
r_int
id|ipr_ioafp_indentify_hrrq
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
id|ENTER
suffix:semicolon
id|dev_info
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Starting IOA initialization sequence.&bslash;n&quot;
)paren
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|0
)braket
op_assign
id|IPR_ID_HOST_RR_Q
suffix:semicolon
id|ioarcb-&gt;res_handle
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOA_RES_HANDLE
)paren
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.request_type
op_assign
id|IPR_RQTYPE_IOACMD
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|u32
)paren
id|ioa_cfg-&gt;host_rrq_dma
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|3
)braket
op_assign
(paren
(paren
id|u32
)paren
id|ioa_cfg-&gt;host_rrq_dma
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|4
)braket
op_assign
(paren
(paren
id|u32
)paren
id|ioa_cfg-&gt;host_rrq_dma
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|5
)braket
op_assign
(paren
(paren
id|u32
)paren
id|ioa_cfg-&gt;host_rrq_dma
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|7
)braket
op_assign
(paren
(paren
r_sizeof
(paren
id|u32
)paren
op_star
id|IPR_NUM_CMD_BLKS
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ioarcb-&gt;cmd_pkt.cdb
(braket
l_int|8
)braket
op_assign
(paren
r_sizeof
(paren
id|u32
)paren
op_star
id|IPR_NUM_CMD_BLKS
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_ioafp_std_inquiry
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|ipr_cmd
comma
id|ipr_reset_ioa_job
comma
id|ipr_timeout
comma
id|IPR_INTERNAL_TIMEOUT
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_timer_done - Adapter reset timer function&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Description: This function is used in adapter reset processing&n; * for timing events. If the reset_cmd pointer in the IOA&n; * config struct is not this adapter&squot;s we are doing nested&n; * resets and fail_all_ops will take care of freeing the&n; * command block.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_reset_timer_done
r_static
r_void
id|ipr_reset_timer_done
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;reset_cmd
op_eq
id|ipr_cmd
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
)paren
suffix:semicolon
id|ipr_cmd
op_member_access_from_pointer
id|done
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_start_timer - Start a timer for adapter reset job&n; * @ipr_cmd:&t;ipr command struct&n; * @timeout:&t;timeout value&n; *&n; * Description: This function is used in adapter reset processing&n; * for timing events. If the reset_cmd pointer in the IOA&n; * config struct is not this adapter&squot;s we are doing nested&n; * resets and fail_all_ops will take care of freeing the&n; * command block.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_reset_start_timer
r_static
r_void
id|ipr_reset_start_timer
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
comma
r_int
r_int
id|timeout
)paren
(brace
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ipr_cmd-&gt;ioa_cfg-&gt;pending_q
)paren
suffix:semicolon
id|ipr_cmd-&gt;done
op_assign
id|ipr_reset_ioa_job
suffix:semicolon
id|ipr_cmd-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|ipr_cmd
suffix:semicolon
id|ipr_cmd-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|timeout
suffix:semicolon
id|ipr_cmd-&gt;timer.function
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|ipr_reset_timer_done
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ipr_cmd-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_init_ioa_mem - Initialize ioa_cfg control block&n; * @ioa_cfg:&t;ioa cfg struct&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_init_ioa_mem
r_static
r_void
id|ipr_init_ioa_mem
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
id|memset
c_func
(paren
id|ioa_cfg-&gt;host_rrq
comma
l_int|0
comma
r_sizeof
(paren
id|u32
)paren
op_star
id|IPR_NUM_CMD_BLKS
)paren
suffix:semicolon
multiline_comment|/* Initialize Host RRQ pointers */
id|ioa_cfg-&gt;hrrq_start
op_assign
id|ioa_cfg-&gt;host_rrq
suffix:semicolon
id|ioa_cfg-&gt;hrrq_end
op_assign
op_amp
id|ioa_cfg-&gt;host_rrq
(braket
id|IPR_NUM_CMD_BLKS
op_minus
l_int|1
)braket
suffix:semicolon
id|ioa_cfg-&gt;hrrq_curr
op_assign
id|ioa_cfg-&gt;hrrq_start
suffix:semicolon
id|ioa_cfg-&gt;toggle_bit
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Zero out config table */
id|memset
c_func
(paren
id|ioa_cfg-&gt;cfg_table
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ipr_config_table
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_enable_ioa - Enable the IOA following a reset.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function reinitializes some control blocks and&n; * enables destructive diagnostics on the adapter.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_reset_enable_ioa
r_static
r_int
id|ipr_reset_enable_ioa
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_volatile
id|u32
id|int_reg
suffix:semicolon
id|ENTER
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_ioafp_indentify_hrrq
suffix:semicolon
id|ipr_init_ioa_mem
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|ioa_cfg-&gt;allow_interrupts
op_assign
l_int|1
suffix:semicolon
id|int_reg
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;regs.sense_interrupt_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|int_reg
op_amp
id|IPR_PCII_IOA_TRANS_TO_OPER
)paren
(brace
id|writel
c_func
(paren
(paren
id|IPR_PCII_ERROR_INTERRUPTS
op_or
id|IPR_PCII_HRRQ_UPDATED
)paren
comma
id|ioa_cfg-&gt;regs.clr_interrupt_mask_reg
)paren
suffix:semicolon
id|int_reg
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;regs.sense_interrupt_mask_reg
)paren
suffix:semicolon
r_return
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
)brace
multiline_comment|/* Enable destructive diagnostics on IOA */
id|writel
c_func
(paren
id|IPR_DOORBELL
comma
id|ioa_cfg-&gt;regs.set_uproc_interrupt_reg
)paren
suffix:semicolon
id|writel
c_func
(paren
id|IPR_PCII_OPER_INTERRUPTS
comma
id|ioa_cfg-&gt;regs.clr_interrupt_mask_reg
)paren
suffix:semicolon
id|int_reg
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;regs.sense_interrupt_mask_reg
)paren
suffix:semicolon
id|dev_info
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Initializing IOA.&bslash;n&quot;
)paren
suffix:semicolon
id|ipr_cmd-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|ipr_cmd
suffix:semicolon
id|ipr_cmd-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|IPR_OPERATIONAL_TIMEOUT
suffix:semicolon
id|ipr_cmd-&gt;timer.function
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|ipr_timeout
suffix:semicolon
id|ipr_cmd-&gt;done
op_assign
id|ipr_reset_ioa_job
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ipr_cmd-&gt;timer
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;pending_q
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_wait_for_dump - Wait for a dump to timeout.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function is invoked when an adapter dump has run out&n; * of processing time.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_CONTINUE&n; **/
DECL|function|ipr_reset_wait_for_dump
r_static
r_int
id|ipr_reset_wait_for_dump
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;sdt_state
op_eq
id|GET_DUMP
)paren
id|ioa_cfg-&gt;sdt_state
op_assign
id|ABORT_DUMP
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_alert
suffix:semicolon
r_return
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_unit_check_no_data - Log a unit check/no data error log&n; * @ioa_cfg:&t;&t;ioa config struct&n; *&n; * Logs an error indicating the adapter unit checked, but for some&n; * reason, we were unable to fetch the unit check buffer.&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_unit_check_no_data
r_static
r_void
id|ipr_unit_check_no_data
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
id|ioa_cfg-&gt;errors_logged
op_increment
suffix:semicolon
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;IOA unit check with no data&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_get_unit_check_buffer - Get the unit check buffer from the IOA&n; * @ioa_cfg:&t;&t;ioa config struct&n; *&n; * Fetches the unit check buffer from the adapter by clocking the data&n; * through the mailbox register.&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_get_unit_check_buffer
r_static
r_void
id|ipr_get_unit_check_buffer
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_int
r_int
id|mailbox
suffix:semicolon
r_struct
id|ipr_hostrcb
op_star
id|hostrcb
suffix:semicolon
r_struct
id|ipr_uc_sdt
id|sdt
suffix:semicolon
r_int
id|rc
comma
id|length
suffix:semicolon
id|mailbox
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;ioa_mailbox
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipr_sdt_is_fmt2
c_func
(paren
id|mailbox
)paren
)paren
(brace
id|ipr_unit_check_no_data
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|sdt
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ipr_uc_sdt
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|ipr_get_ldump_data_section
c_func
(paren
id|ioa_cfg
comma
id|mailbox
comma
(paren
id|u32
op_star
)paren
op_amp
id|sdt
comma
(paren
r_sizeof
(paren
r_struct
id|ipr_uc_sdt
)paren
)paren
op_div
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|be32_to_cpu
c_func
(paren
id|sdt.hdr.state
)paren
op_ne
id|IPR_FMT2_SDT_READY_TO_USE
)paren
op_logical_or
op_logical_neg
(paren
id|sdt.entry
(braket
l_int|0
)braket
dot
id|flags
op_amp
id|IPR_SDT_VALID_ENTRY
)paren
)paren
(brace
id|ipr_unit_check_no_data
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Find length of the first sdt entry (UC buffer) */
id|length
op_assign
(paren
id|be32_to_cpu
c_func
(paren
id|sdt.entry
(braket
l_int|0
)braket
dot
id|end_offset
)paren
op_minus
id|be32_to_cpu
c_func
(paren
id|sdt.entry
(braket
l_int|0
)braket
dot
id|bar_str_offset
)paren
)paren
op_amp
id|IPR_FMT2_MBX_ADDR_MASK
suffix:semicolon
id|hostrcb
op_assign
id|list_entry
c_func
(paren
id|ioa_cfg-&gt;hostrcb_free_q.next
comma
r_struct
id|ipr_hostrcb
comma
id|queue
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|hostrcb-&gt;queue
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hostrcb-&gt;hcam
comma
l_int|0
comma
r_sizeof
(paren
id|hostrcb-&gt;hcam
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|ipr_get_ldump_data_section
c_func
(paren
id|ioa_cfg
comma
id|be32_to_cpu
c_func
(paren
id|sdt.entry
(braket
l_int|0
)braket
dot
id|bar_str_offset
)paren
comma
(paren
id|u32
op_star
)paren
op_amp
id|hostrcb-&gt;hcam
comma
id|min
c_func
(paren
id|length
comma
(paren
r_int
)paren
r_sizeof
(paren
id|hostrcb-&gt;hcam
)paren
)paren
op_div
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|ipr_handle_log_data
c_func
(paren
id|ioa_cfg
comma
id|hostrcb
)paren
suffix:semicolon
r_else
id|ipr_unit_check_no_data
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|hostrcb-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;hostrcb_free_q
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_restore_cfg_space - Restore PCI config space.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Description: This function restores the saved PCI config space of&n; * the adapter, fails all outstanding ops back to the callers, and&n; * fetches the dump/unit check if applicable to this reset.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_reset_restore_cfg_space
r_static
r_int
id|ipr_reset_restore_cfg_space
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ENTER
suffix:semicolon
id|rc
op_assign
id|pci_restore_state
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|ioa_cfg-&gt;pci_cfg_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|ipr_cmd-&gt;ioasa.ioasc
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOASC_PCI_ACCESS_ERROR
)paren
suffix:semicolon
r_return
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ipr_set_pcix_cmd_reg
c_func
(paren
id|ioa_cfg
)paren
)paren
(brace
id|ipr_cmd-&gt;ioasa.ioasc
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOASC_PCI_ACCESS_ERROR
)paren
suffix:semicolon
r_return
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
)brace
id|ipr_fail_all_ops
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;ioa_unit_checked
)paren
(brace
id|ioa_cfg-&gt;ioa_unit_checked
op_assign
l_int|0
suffix:semicolon
id|ipr_get_unit_check_buffer
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_alert
suffix:semicolon
id|ipr_reset_start_timer
c_func
(paren
id|ipr_cmd
comma
l_int|0
)paren
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioa_cfg-&gt;in_ioa_bringdown
)paren
(brace
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_ioa_bringdown_done
suffix:semicolon
)brace
r_else
(brace
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_enable_ioa
suffix:semicolon
r_if
c_cond
(paren
id|GET_DUMP
op_eq
id|ioa_cfg-&gt;sdt_state
)paren
(brace
id|ipr_reset_start_timer
c_func
(paren
id|ipr_cmd
comma
id|IPR_DUMP_TIMEOUT
)paren
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_wait_for_dump
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|ioa_cfg-&gt;work_q
)paren
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
)brace
id|ENTER
suffix:semicolon
r_return
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_start_bist - Run BIST on the adapter.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Description: This function runs BIST on the adapter, then delays 2 seconds.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_reset_start_bist
r_static
r_int
id|ipr_reset_start_bist
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ENTER
suffix:semicolon
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|PCI_BIST
comma
id|PCI_BIST_START
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|ipr_cmd-&gt;ioasa.ioasc
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOASC_PCI_ACCESS_ERROR
)paren
suffix:semicolon
id|rc
op_assign
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
)brace
r_else
(brace
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_restore_cfg_space
suffix:semicolon
id|ipr_reset_start_timer
c_func
(paren
id|ipr_cmd
comma
id|IPR_WAIT_FOR_BIST_TIMEOUT
)paren
suffix:semicolon
id|rc
op_assign
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
id|LEAVE
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_allowed - Query whether or not IOA can be reset&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Return value:&n; * &t;0 if reset not allowed / non-zero if reset is allowed&n; **/
DECL|function|ipr_reset_allowed
r_static
r_int
id|ipr_reset_allowed
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_volatile
id|u32
id|temp_reg
suffix:semicolon
id|temp_reg
op_assign
id|readl
c_func
(paren
id|ioa_cfg-&gt;regs.sense_interrupt_reg
)paren
suffix:semicolon
r_return
(paren
(paren
id|temp_reg
op_amp
id|IPR_PCII_CRITICAL_OPERATION
)paren
op_eq
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_wait_to_start_bist - Wait for permission to reset IOA.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Description: This function waits for adapter permission to run BIST,&n; * then runs BIST. If the adapter does not give permission after a&n; * reasonable time, we will reset the adapter anyway. The impact of&n; * resetting the adapter without warning the adapter is the risk of&n; * losing the persistent error log on the adapter. If the adapter is&n; * reset while it is writing to the flash on the adapter, the flash&n; * segment will have bad ECC and be zeroed.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_reset_wait_to_start_bist
r_static
r_int
id|ipr_reset_wait_to_start_bist
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_int
id|rc
op_assign
id|IPR_RC_JOB_RETURN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipr_reset_allowed
c_func
(paren
id|ioa_cfg
)paren
op_logical_and
id|ipr_cmd-&gt;u.time_left
)paren
(brace
id|ipr_cmd-&gt;u.time_left
op_sub_assign
id|IPR_CHECK_FOR_RESET_TIMEOUT
suffix:semicolon
id|ipr_reset_start_timer
c_func
(paren
id|ipr_cmd
comma
id|IPR_CHECK_FOR_RESET_TIMEOUT
)paren
suffix:semicolon
)brace
r_else
(brace
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_start_bist
suffix:semicolon
id|rc
op_assign
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_alert_part2 - Alert the adapter of a pending reset&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Description: This function alerts the adapter that it will be reset.&n; * If memory space is not currently enabled, proceed directly&n; * to running BIST on the adapter. The timer must always be started&n; * so we guarantee we do not run BIST from ipr_isr.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_reset_alert
r_static
r_int
id|ipr_reset_alert
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
id|u16
id|cmd_reg
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ENTER
suffix:semicolon
id|rc
op_assign
id|pci_read_config_word
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_eq
id|PCIBIOS_SUCCESSFUL
)paren
op_logical_and
(paren
id|cmd_reg
op_amp
id|PCI_COMMAND_MEMORY
)paren
)paren
(brace
id|ipr_mask_and_clear_interrupts
c_func
(paren
id|ioa_cfg
comma
op_complement
l_int|0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|IPR_UPROCI_RESET_ALERT
comma
id|ioa_cfg-&gt;regs.set_uproc_interrupt_reg
)paren
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_wait_to_start_bist
suffix:semicolon
)brace
r_else
(brace
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_start_bist
suffix:semicolon
)brace
id|ipr_cmd-&gt;u.time_left
op_assign
id|IPR_WAIT_FOR_RESET_TIMEOUT
suffix:semicolon
id|ipr_reset_start_timer
c_func
(paren
id|ipr_cmd
comma
id|IPR_CHECK_FOR_RESET_TIMEOUT
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_ucode_download_done - Microcode download completion&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Description: This function unmaps the microcode download buffer.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_CONTINUE&n; **/
DECL|function|ipr_reset_ucode_download_done
r_static
r_int
id|ipr_reset_ucode_download_done
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_sglist
op_star
id|sglist
op_assign
id|ioa_cfg-&gt;ucode_sglist
suffix:semicolon
id|pci_unmap_sg
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
id|sglist-&gt;scatterlist
comma
id|sglist-&gt;num_sg
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_alert
suffix:semicolon
r_return
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_ucode_download - Download microcode to the adapter&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Description: This function checks to see if it there is microcode&n; * to download to the adapter. If there is, a download is performed.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_reset_ucode_download
r_static
r_int
id|ipr_reset_ucode_download
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_struct
id|ipr_sglist
op_star
id|sglist
op_assign
id|ioa_cfg-&gt;ucode_sglist
suffix:semicolon
id|ENTER
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_alert
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sglist
)paren
r_return
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.res_handle
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOA_RES_HANDLE
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.cmd_pkt.request_type
op_assign
id|IPR_RQTYPE_SCSICDB
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.cmd_pkt.cdb
(braket
l_int|0
)braket
op_assign
id|WRITE_BUFFER
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.cmd_pkt.cdb
(braket
l_int|1
)braket
op_assign
id|IPR_WR_BUF_DOWNLOAD_AND_SAVE
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.cmd_pkt.cdb
(braket
l_int|6
)braket
op_assign
(paren
id|sglist-&gt;buffer_len
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.cmd_pkt.cdb
(braket
l_int|7
)braket
op_assign
(paren
id|sglist-&gt;buffer_len
op_amp
l_int|0x00ff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.cmd_pkt.cdb
(braket
l_int|8
)braket
op_assign
id|sglist-&gt;buffer_len
op_amp
l_int|0x0000ff
suffix:semicolon
r_if
c_cond
(paren
id|ipr_map_ucode_buffer
c_func
(paren
id|ipr_cmd
comma
id|sglist
comma
id|sglist-&gt;buffer_len
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Failed to map microcode download buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
)brace
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_ucode_download_done
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|ipr_cmd
comma
id|ipr_reset_ioa_job
comma
id|ipr_timeout
comma
id|IPR_WRITE_BUFFER_TIMEOUT
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|IPR_RC_JOB_RETURN
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_shutdown_ioa - Shutdown the adapter&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Description: This function issues an adapter shutdown of the&n; * specified type to the specified adapter as part of the&n; * adapter reset job.&n; *&n; * Return value:&n; * &t;IPR_RC_JOB_CONTINUE / IPR_RC_JOB_RETURN&n; **/
DECL|function|ipr_reset_shutdown_ioa
r_static
r_int
id|ipr_reset_shutdown_ioa
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_enum
id|ipr_shutdown_type
id|shutdown_type
op_assign
id|ipr_cmd-&gt;u.shutdown_type
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_int
id|rc
op_assign
id|IPR_RC_JOB_CONTINUE
suffix:semicolon
id|ENTER
suffix:semicolon
r_if
c_cond
(paren
id|shutdown_type
op_ne
id|IPR_SHUTDOWN_NONE
op_logical_and
op_logical_neg
id|ioa_cfg-&gt;ioa_is_dead
)paren
(brace
id|ipr_cmd-&gt;ioarcb.res_handle
op_assign
id|cpu_to_be32
c_func
(paren
id|IPR_IOA_RES_HANDLE
)paren
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.cmd_pkt.request_type
op_assign
id|IPR_RQTYPE_IOACMD
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.cmd_pkt.cdb
(braket
l_int|0
)braket
op_assign
id|IPR_IOA_SHUTDOWN
suffix:semicolon
id|ipr_cmd-&gt;ioarcb.cmd_pkt.cdb
(braket
l_int|1
)braket
op_assign
id|shutdown_type
suffix:semicolon
r_if
c_cond
(paren
id|shutdown_type
op_eq
id|IPR_SHUTDOWN_ABBREV
)paren
id|timeout
op_assign
id|IPR_ABBREV_SHUTDOWN_TIMEOUT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|shutdown_type
op_eq
id|IPR_SHUTDOWN_PREPARE_FOR_NORMAL
)paren
id|timeout
op_assign
id|IPR_INTERNAL_TIMEOUT
suffix:semicolon
r_else
id|timeout
op_assign
id|IPR_SHUTDOWN_TIMEOUT
suffix:semicolon
id|ipr_do_req
c_func
(paren
id|ipr_cmd
comma
id|ipr_reset_ioa_job
comma
id|ipr_timeout
comma
id|timeout
)paren
suffix:semicolon
id|rc
op_assign
id|IPR_RC_JOB_RETURN
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_ucode_download
suffix:semicolon
)brace
r_else
id|ipr_cmd-&gt;job_step
op_assign
id|ipr_reset_alert
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_reset_ioa_job - Adapter reset job&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * Description: This function is the job router for the adapter reset job.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_reset_ioa_job
r_static
r_void
id|ipr_reset_ioa_job
c_func
(paren
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
)paren
(brace
id|u32
id|rc
comma
id|ioasc
suffix:semicolon
r_int
r_int
id|scratch
op_assign
id|ipr_cmd-&gt;u.scratch
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|ipr_cmd-&gt;ioa_cfg
suffix:semicolon
r_do
(brace
id|ioasc
op_assign
id|be32_to_cpu
c_func
(paren
id|ipr_cmd-&gt;ioasa.ioasc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;reset_cmd
op_ne
id|ipr_cmd
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * We are doing nested adapter resets and this is&n;&t;&t;&t; * not the current reset job.&n;&t;&t;&t; */
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IPR_IOASC_SENSE_KEY
c_func
(paren
id|ioasc
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;0x%02X failed with IOASC: 0x%08X&bslash;n&quot;
comma
id|ipr_cmd-&gt;ioarcb.cmd_pkt.cdb
(braket
l_int|0
)braket
comma
id|ioasc
)paren
suffix:semicolon
id|ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|IPR_SHUTDOWN_NONE
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ipr_reinit_ipr_cmnd
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
id|ipr_cmd-&gt;u.scratch
op_assign
id|scratch
suffix:semicolon
id|rc
op_assign
id|ipr_cmd
op_member_access_from_pointer
id|job_step
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rc
op_eq
id|IPR_RC_JOB_CONTINUE
)paren
(brace
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * _ipr_initiate_ioa_reset - Initiate an adapter reset&n; * @ioa_cfg:&t;&t;ioa config struct&n; * @job_step:&t;&t;first job step of reset job&n; * @shutdown_type:&t;shutdown type&n; *&n; * Description: This function will initiate the reset of the given adapter&n; * starting at the selected job step.&n; * If the caller needs to wait on the completion of the reset,&n; * the caller must sleep on the reset_wait_q.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|_ipr_initiate_ioa_reset
r_static
r_void
id|_ipr_initiate_ioa_reset
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_int
(paren
op_star
id|job_step
)paren
(paren
r_struct
id|ipr_cmnd
op_star
)paren
comma
r_enum
id|ipr_shutdown_type
id|shutdown_type
)paren
(brace
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
suffix:semicolon
id|ioa_cfg-&gt;in_reset_reload
op_assign
l_int|1
suffix:semicolon
id|ioa_cfg-&gt;allow_cmds
op_assign
l_int|0
suffix:semicolon
id|scsi_block_requests
c_func
(paren
id|ioa_cfg-&gt;host
)paren
suffix:semicolon
id|ipr_cmd
op_assign
id|ipr_get_free_ipr_cmnd
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|ioa_cfg-&gt;reset_cmd
op_assign
id|ipr_cmd
suffix:semicolon
id|ipr_cmd-&gt;job_step
op_assign
id|job_step
suffix:semicolon
id|ipr_cmd-&gt;u.shutdown_type
op_assign
id|shutdown_type
suffix:semicolon
id|ipr_reset_ioa_job
c_func
(paren
id|ipr_cmd
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_initiate_ioa_reset - Initiate an adapter reset&n; * @ioa_cfg:&t;&t;ioa config struct&n; * @shutdown_type:&t;shutdown type&n; *&n; * Description: This function will initiate the reset of the given adapter.&n; * If the caller needs to wait on the completion of the reset,&n; * the caller must sleep on the reset_wait_q.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_initiate_ioa_reset
r_static
r_void
id|ipr_initiate_ioa_reset
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_enum
id|ipr_shutdown_type
id|shutdown_type
)paren
(brace
r_if
c_cond
(paren
id|ioa_cfg-&gt;ioa_is_dead
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;in_reset_reload
op_logical_and
id|ioa_cfg-&gt;sdt_state
op_eq
id|GET_DUMP
)paren
id|ioa_cfg-&gt;sdt_state
op_assign
id|ABORT_DUMP
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;reset_retries
op_increment
OG
id|IPR_NUM_RESET_RELOAD_RETRIES
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;IOA taken offline - error recovery failed&bslash;n&quot;
)paren
suffix:semicolon
id|ioa_cfg-&gt;reset_retries
op_assign
l_int|0
suffix:semicolon
id|ioa_cfg-&gt;ioa_is_dead
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;in_ioa_bringdown
)paren
(brace
id|ioa_cfg-&gt;reset_cmd
op_assign
l_int|NULL
suffix:semicolon
id|ioa_cfg-&gt;in_reset_reload
op_assign
l_int|0
suffix:semicolon
id|ipr_fail_all_ops
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|wake_up_all
c_func
(paren
op_amp
id|ioa_cfg-&gt;reset_wait_q
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|scsi_unblock_requests
c_func
(paren
id|ioa_cfg-&gt;host
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|ioa_cfg-&gt;in_ioa_bringdown
op_assign
l_int|1
suffix:semicolon
id|shutdown_type
op_assign
id|IPR_SHUTDOWN_NONE
suffix:semicolon
)brace
)brace
id|_ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|ipr_reset_shutdown_ioa
comma
id|shutdown_type
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_probe_ioa_part2 - Initializes IOAs found in ipr_probe_ioa(..)&n; * @ioa_cfg:&t;ioa cfg struct&n; *&n; * Description: This is the second phase of adapter intialization&n; * This function takes care of initilizing the adapter to the point&n; * where it can accept new commands.&n;&n; * Return value:&n; * &t;0 on sucess / -EIO on failure&n; **/
DECL|function|ipr_probe_ioa_part2
r_static
r_int
id|__devinit
id|ipr_probe_ioa_part2
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|host_lock_flags
op_assign
l_int|0
suffix:semicolon
id|ENTER
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|host_lock_flags
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;ioa_cfg adx: 0x%p&bslash;n&quot;
comma
id|ioa_cfg
)paren
suffix:semicolon
id|_ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|ipr_reset_enable_ioa
comma
id|IPR_SHUTDOWN_NONE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|host_lock_flags
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|ioa_cfg-&gt;reset_wait_q
comma
op_logical_neg
id|ioa_cfg-&gt;in_reset_reload
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|host_lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;ioa_is_dead
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ipr_invalid_adapter
c_func
(paren
id|ioa_cfg
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ipr_testmode
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|dev_err
c_func
(paren
op_amp
id|ioa_cfg-&gt;pdev-&gt;dev
comma
l_string|&quot;Adapter not supported in this hardware configuration.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|host_lock_flags
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_free_cmd_blks - Frees command blocks allocated for an adapter&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_free_cmd_blks
r_static
r_void
id|ipr_free_cmd_blks
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPR_NUM_CMD_BLKS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ioa_cfg-&gt;ipr_cmnd_list
(braket
id|i
)braket
)paren
id|pci_pool_free
c_func
(paren
id|ioa_cfg-&gt;ipr_cmd_pool
comma
id|ioa_cfg-&gt;ipr_cmnd_list
(braket
id|i
)braket
comma
id|ioa_cfg-&gt;ipr_cmnd_list_dma
(braket
id|i
)braket
)paren
suffix:semicolon
id|ioa_cfg-&gt;ipr_cmnd_list
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioa_cfg-&gt;ipr_cmd_pool
)paren
id|pci_pool_destroy
(paren
id|ioa_cfg-&gt;ipr_cmd_pool
)paren
suffix:semicolon
id|ioa_cfg-&gt;ipr_cmd_pool
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_free_mem - Frees memory allocated for an adapter&n; * @ioa_cfg:&t;ioa cfg struct&n; *&n; * Return value:&n; * &t;nothing&n; **/
DECL|function|ipr_free_mem
r_static
r_void
id|ipr_free_mem
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_int
id|i
suffix:semicolon
id|kfree
c_func
(paren
id|ioa_cfg-&gt;res_entries
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|ipr_misc_cbs
)paren
comma
id|ioa_cfg-&gt;vpd_cbs
comma
id|ioa_cfg-&gt;vpd_cbs_dma
)paren
suffix:semicolon
id|ipr_free_cmd_blks
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
r_sizeof
(paren
id|u32
)paren
op_star
id|IPR_NUM_CMD_BLKS
comma
id|ioa_cfg-&gt;host_rrq
comma
id|ioa_cfg-&gt;host_rrq_dma
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|ipr_config_table
)paren
comma
id|ioa_cfg-&gt;cfg_table
comma
id|ioa_cfg-&gt;cfg_table_dma
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPR_NUM_HCAMS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|ipr_hostrcb
)paren
comma
id|ioa_cfg-&gt;hostrcb
(braket
id|i
)braket
comma
id|ioa_cfg-&gt;hostrcb_dma
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|ipr_free_dump
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioa_cfg-&gt;saved_mode_pages
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ioa_cfg-&gt;trace
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_free_all_resources - Free all allocated resources for an adapter.&n; * @ipr_cmd:&t;ipr command struct&n; *&n; * This function frees all allocated resources for the&n; * specified adapter.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_free_all_resources
r_static
r_void
id|ipr_free_all_resources
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
id|ENTER
suffix:semicolon
id|free_irq
c_func
(paren
id|ioa_cfg-&gt;pdev-&gt;irq
comma
id|ioa_cfg
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|ioa_cfg-&gt;hdw_dma_regs
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|ioa_cfg-&gt;hdw_dma_regs_pci
comma
id|pci_resource_len
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|ipr_free_mem
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|ioa_cfg-&gt;host
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_alloc_cmd_blks - Allocate command blocks for an adapter&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Return value:&n; * &t;0 on success / -ENOMEM on allocation failure&n; **/
DECL|function|ipr_alloc_cmd_blks
r_static
r_int
id|__devinit
id|ipr_alloc_cmd_blks
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_struct
id|ipr_cmnd
op_star
id|ipr_cmd
suffix:semicolon
r_struct
id|ipr_ioarcb
op_star
id|ioarcb
suffix:semicolon
id|u32
id|dma_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ioa_cfg-&gt;ipr_cmd_pool
op_assign
id|pci_pool_create
(paren
id|IPR_NAME
comma
id|ioa_cfg-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|ipr_cmnd
)paren
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;ipr_cmd_pool
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPR_NUM_CMD_BLKS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ipr_cmd
op_assign
id|pci_pool_alloc
(paren
id|ioa_cfg-&gt;ipr_cmd_pool
comma
id|SLAB_KERNEL
comma
op_amp
id|dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipr_cmd
)paren
(brace
id|ipr_free_cmd_blks
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ipr_cmd
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ipr_cmd
)paren
)paren
suffix:semicolon
id|ioa_cfg-&gt;ipr_cmnd_list
(braket
id|i
)braket
op_assign
id|ipr_cmd
suffix:semicolon
id|ioa_cfg-&gt;ipr_cmnd_list_dma
(braket
id|i
)braket
op_assign
id|dma_addr
suffix:semicolon
id|ioarcb
op_assign
op_amp
id|ipr_cmd-&gt;ioarcb
suffix:semicolon
id|ioarcb-&gt;ioarcb_host_pci_addr
op_assign
id|cpu_to_be32
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
id|ioarcb-&gt;host_response_handle
op_assign
id|cpu_to_be32
c_func
(paren
id|i
op_lshift
l_int|2
)paren
suffix:semicolon
id|ioarcb-&gt;write_ioadl_addr
op_assign
id|cpu_to_be32
c_func
(paren
id|dma_addr
op_plus
m_offsetof
(paren
r_struct
id|ipr_cmnd
comma
id|ioadl
)paren
)paren
suffix:semicolon
id|ioarcb-&gt;read_ioadl_addr
op_assign
id|ioarcb-&gt;write_ioadl_addr
suffix:semicolon
id|ioarcb-&gt;ioasa_host_pci_addr
op_assign
id|cpu_to_be32
c_func
(paren
id|dma_addr
op_plus
m_offsetof
(paren
r_struct
id|ipr_cmnd
comma
id|ioasa
)paren
)paren
suffix:semicolon
id|ioarcb-&gt;ioasa_len
op_assign
id|cpu_to_be16
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_ioasa
)paren
)paren
suffix:semicolon
id|ipr_cmd-&gt;cmd_index
op_assign
id|i
suffix:semicolon
id|ipr_cmd-&gt;ioa_cfg
op_assign
id|ioa_cfg
suffix:semicolon
id|ipr_cmd-&gt;sense_buffer_dma
op_assign
id|dma_addr
op_plus
m_offsetof
(paren
r_struct
id|ipr_cmnd
comma
id|sense_buffer
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ipr_cmd-&gt;queue
comma
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_alloc_mem - Allocate memory for an adapter&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Return value:&n; * &t;0 on success / non-zero for error&n; **/
DECL|function|ipr_alloc_mem
r_static
r_int
id|__devinit
id|ipr_alloc_mem
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_int
id|i
suffix:semicolon
id|ENTER
suffix:semicolon
id|ioa_cfg-&gt;res_entries
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_resource_entry
)paren
op_star
id|IPR_MAX_PHYSICAL_DEVS
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;res_entries
)paren
r_goto
id|cleanup
suffix:semicolon
id|memset
c_func
(paren
id|ioa_cfg-&gt;res_entries
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ipr_resource_entry
)paren
op_star
id|IPR_MAX_PHYSICAL_DEVS
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPR_MAX_PHYSICAL_DEVS
suffix:semicolon
id|i
op_increment
)paren
id|list_add_tail
c_func
(paren
op_amp
id|ioa_cfg-&gt;res_entries
(braket
id|i
)braket
dot
id|queue
comma
op_amp
id|ioa_cfg-&gt;free_res_q
)paren
suffix:semicolon
id|ioa_cfg-&gt;vpd_cbs
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|ipr_misc_cbs
)paren
comma
op_amp
id|ioa_cfg-&gt;vpd_cbs_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;vpd_cbs
)paren
r_goto
id|cleanup
suffix:semicolon
r_if
c_cond
(paren
id|ipr_alloc_cmd_blks
c_func
(paren
id|ioa_cfg
)paren
)paren
r_goto
id|cleanup
suffix:semicolon
id|ioa_cfg-&gt;host_rrq
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
r_sizeof
(paren
id|u32
)paren
op_star
id|IPR_NUM_CMD_BLKS
comma
op_amp
id|ioa_cfg-&gt;host_rrq_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;host_rrq
)paren
r_goto
id|cleanup
suffix:semicolon
id|ioa_cfg-&gt;cfg_table
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|ipr_config_table
)paren
comma
op_amp
id|ioa_cfg-&gt;cfg_table_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;cfg_table
)paren
r_goto
id|cleanup
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPR_NUM_HCAMS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ioa_cfg-&gt;hostrcb
(braket
id|i
)braket
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ioa_cfg-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|ipr_hostrcb
)paren
comma
op_amp
id|ioa_cfg-&gt;hostrcb_dma
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;hostrcb
(braket
id|i
)braket
)paren
r_goto
id|cleanup
suffix:semicolon
id|memset
c_func
(paren
id|ioa_cfg-&gt;hostrcb
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ipr_hostrcb
)paren
)paren
suffix:semicolon
id|ioa_cfg-&gt;hostrcb
(braket
id|i
)braket
op_member_access_from_pointer
id|hostrcb_dma
op_assign
id|ioa_cfg-&gt;hostrcb_dma
(braket
id|i
)braket
op_plus
m_offsetof
(paren
r_struct
id|ipr_hostrcb
comma
id|hcam
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ioa_cfg-&gt;hostrcb
(braket
id|i
)braket
op_member_access_from_pointer
id|queue
comma
op_amp
id|ioa_cfg-&gt;hostrcb_free_q
)paren
suffix:semicolon
)brace
id|ioa_cfg-&gt;trace
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ipr_trace_entry
)paren
op_star
id|IPR_NUM_TRACE_ENTRIES
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioa_cfg-&gt;trace
)paren
r_goto
id|cleanup
suffix:semicolon
id|memset
c_func
(paren
id|ioa_cfg-&gt;trace
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ipr_trace_entry
)paren
op_star
id|IPR_NUM_TRACE_ENTRIES
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|cleanup
suffix:colon
id|ipr_free_mem
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_initialize_bus_attr - Initialize SCSI bus attributes to default values&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_initialize_bus_attr
r_static
r_void
id|__devinit
id|ipr_initialize_bus_attr
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPR_MAX_NUM_BUSES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ioa_cfg-&gt;bus_attr
(braket
id|i
)braket
dot
id|bus
op_assign
id|i
suffix:semicolon
id|ioa_cfg-&gt;bus_attr
(braket
id|i
)braket
dot
id|qas_enabled
op_assign
l_int|0
suffix:semicolon
id|ioa_cfg-&gt;bus_attr
(braket
id|i
)braket
dot
id|bus_width
op_assign
id|IPR_DEFAULT_BUS_WIDTH
suffix:semicolon
r_if
c_cond
(paren
id|ipr_max_speed
OL
id|ARRAY_SIZE
c_func
(paren
id|ipr_max_bus_speeds
)paren
)paren
id|ioa_cfg-&gt;bus_attr
(braket
id|i
)braket
dot
id|max_xfer_rate
op_assign
id|ipr_max_bus_speeds
(braket
id|ipr_max_speed
)braket
suffix:semicolon
r_else
id|ioa_cfg-&gt;bus_attr
(braket
id|i
)braket
dot
id|max_xfer_rate
op_assign
id|IPR_U160_SCSI_RATE
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * ipr_init_ioa_cfg - Initialize IOA config struct&n; * @ioa_cfg:&t;ioa config struct&n; * @host:&t;&t;scsi host struct&n; * @pdev:&t;&t;PCI dev struct&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_init_ioa_cfg
r_static
r_void
id|__devinit
id|ipr_init_ioa_cfg
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_struct
id|Scsi_Host
op_star
id|host
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|ioa_cfg-&gt;host
op_assign
id|host
suffix:semicolon
id|ioa_cfg-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|ioa_cfg-&gt;log_level
op_assign
id|ipr_log_level
suffix:semicolon
id|sprintf
c_func
(paren
id|ioa_cfg-&gt;eye_catcher
comma
id|IPR_EYECATCHER
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|ioa_cfg-&gt;trace_start
comma
id|IPR_TRACE_START_LABEL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|ioa_cfg-&gt;ipr_free_label
comma
id|IPR_FREEQ_LABEL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|ioa_cfg-&gt;ipr_pending_label
comma
id|IPR_PENDQ_LABEL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|ioa_cfg-&gt;cfg_table_start
comma
id|IPR_CFG_TBL_START
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|ioa_cfg-&gt;resource_table_label
comma
id|IPR_RES_TABLE_LABEL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|ioa_cfg-&gt;ipr_hcam_label
comma
id|IPR_HCAM_LABEL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|ioa_cfg-&gt;ipr_cmd_label
comma
id|IPR_CMD_LABEL
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ioa_cfg-&gt;free_q
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ioa_cfg-&gt;pending_q
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ioa_cfg-&gt;hostrcb_free_q
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ioa_cfg-&gt;hostrcb_pending_q
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ioa_cfg-&gt;free_res_q
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ioa_cfg-&gt;used_res_q
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|ioa_cfg-&gt;work_q
comma
id|ipr_worker_thread
comma
id|ioa_cfg
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ioa_cfg-&gt;reset_wait_q
)paren
suffix:semicolon
id|ioa_cfg-&gt;sdt_state
op_assign
id|INACTIVE
suffix:semicolon
id|ipr_initialize_bus_attr
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|host-&gt;max_id
op_assign
id|IPR_MAX_NUM_TARGETS_PER_BUS
suffix:semicolon
id|host-&gt;max_lun
op_assign
id|IPR_MAX_NUM_LUNS_PER_TARGET
suffix:semicolon
id|host-&gt;max_channel
op_assign
id|IPR_MAX_BUS_TO_SCAN
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|host-&gt;host_no
suffix:semicolon
id|host-&gt;max_cmd_len
op_assign
id|IPR_MAX_CDB_LEN
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|ioa_cfg
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|ioa_cfg-&gt;regs
comma
op_amp
id|ioa_cfg-&gt;chip_cfg-&gt;regs
comma
r_sizeof
(paren
id|ioa_cfg-&gt;regs
)paren
)paren
suffix:semicolon
id|ioa_cfg-&gt;regs.set_interrupt_mask_reg
op_add_assign
id|ioa_cfg-&gt;hdw_dma_regs
suffix:semicolon
id|ioa_cfg-&gt;regs.clr_interrupt_mask_reg
op_add_assign
id|ioa_cfg-&gt;hdw_dma_regs
suffix:semicolon
id|ioa_cfg-&gt;regs.sense_interrupt_mask_reg
op_add_assign
id|ioa_cfg-&gt;hdw_dma_regs
suffix:semicolon
id|ioa_cfg-&gt;regs.clr_interrupt_reg
op_add_assign
id|ioa_cfg-&gt;hdw_dma_regs
suffix:semicolon
id|ioa_cfg-&gt;regs.sense_interrupt_reg
op_add_assign
id|ioa_cfg-&gt;hdw_dma_regs
suffix:semicolon
id|ioa_cfg-&gt;regs.ioarrin_reg
op_add_assign
id|ioa_cfg-&gt;hdw_dma_regs
suffix:semicolon
id|ioa_cfg-&gt;regs.sense_uproc_interrupt_reg
op_add_assign
id|ioa_cfg-&gt;hdw_dma_regs
suffix:semicolon
id|ioa_cfg-&gt;regs.set_uproc_interrupt_reg
op_add_assign
id|ioa_cfg-&gt;hdw_dma_regs
suffix:semicolon
id|ioa_cfg-&gt;regs.clr_uproc_interrupt_reg
op_add_assign
id|ioa_cfg-&gt;hdw_dma_regs
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_probe_ioa - Allocates memory and does first stage of initialization&n; * @pdev:&t;&t;PCI device struct&n; * @dev_id:&t;&t;PCI device id struct&n; *&n; * Return value:&n; * &t;0 on success / non-zero on failure&n; **/
DECL|function|ipr_probe_ioa
r_static
r_int
id|__devinit
id|ipr_probe_ioa
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|dev_id
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_int
r_int
id|ipr_regs
comma
id|ipr_regs_pci
suffix:semicolon
id|u32
id|rc
op_assign
id|PCIBIOS_SUCCESSFUL
suffix:semicolon
id|ENTER
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Cannot enable adapter&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|dev_info
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Found IOA with IRQ: %d&bslash;n&quot;
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
id|host
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|driver_template
comma
r_sizeof
(paren
op_star
id|ioa_cfg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;call to scsi_host_alloc failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ioa_cfg
op_assign
(paren
r_struct
id|ipr_ioa_cfg
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|memset
c_func
(paren
id|ioa_cfg
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ipr_ioa_cfg
)paren
)paren
suffix:semicolon
id|ioa_cfg-&gt;chip_cfg
op_assign
(paren
r_const
r_struct
id|ipr_chip_cfg_t
op_star
)paren
id|dev_id-&gt;driver_data
suffix:semicolon
id|ipr_regs_pci
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|ipr_regs_pci
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|IPR_NAME
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Couldn&squot;t register memory range of registers&bslash;n&quot;
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ipr_regs
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|ipr_regs_pci
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipr_regs
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Couldn&squot;t map memory range of registers&bslash;n&quot;
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|ipr_regs_pci
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ioa_cfg-&gt;hdw_dma_regs
op_assign
id|ipr_regs
suffix:semicolon
id|ioa_cfg-&gt;hdw_dma_regs_pci
op_assign
id|ipr_regs_pci
suffix:semicolon
id|ioa_cfg-&gt;ioa_mailbox
op_assign
id|ioa_cfg-&gt;chip_cfg-&gt;mailbox
op_plus
id|ipr_regs
suffix:semicolon
id|ipr_init_ioa_cfg
c_func
(paren
id|ioa_cfg
comma
id|host
comma
id|pdev
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|rc
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Failed to set PCI DMA mask&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|cleanup_nomem
suffix:semicolon
)brace
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_CACHE_LINE_SIZE
comma
id|ioa_cfg-&gt;chip_cfg-&gt;cache_line_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Write of cache line size failed&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|cleanup_nomem
suffix:semicolon
)brace
multiline_comment|/* Save away PCI config space for use following IOA reset */
id|rc
op_assign
id|pci_save_state
c_func
(paren
id|pdev
comma
id|ioa_cfg-&gt;pci_cfg_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Failed to save PCI config space&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|cleanup_nomem
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ipr_save_pcix_cmd_reg
c_func
(paren
id|ioa_cfg
)paren
)paren
)paren
r_goto
id|cleanup_nomem
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ipr_set_pcix_cmd_reg
c_func
(paren
id|ioa_cfg
)paren
)paren
)paren
r_goto
id|cleanup_nomem
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ipr_alloc_mem
c_func
(paren
id|ioa_cfg
)paren
)paren
)paren
r_goto
id|cleanup
suffix:semicolon
id|ipr_mask_and_clear_interrupts
c_func
(paren
id|ioa_cfg
comma
op_complement
id|IPR_PCII_IOA_TRANS_TO_OPER
)paren
suffix:semicolon
id|rc
op_assign
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|ipr_isr
comma
id|SA_SHIRQ
comma
id|IPR_NAME
comma
id|ioa_cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Couldn&squot;t register IRQ %d! rc=%d&bslash;n&quot;
comma
id|pdev-&gt;irq
comma
id|rc
)paren
suffix:semicolon
r_goto
id|cleanup_nolog
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|ipr_driver_lock
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ioa_cfg-&gt;queue
comma
op_amp
id|ipr_ioa_head
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ipr_driver_lock
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|cleanup
suffix:colon
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Couldn&squot;t allocate enough memory for device driver!&bslash;n&quot;
)paren
suffix:semicolon
id|cleanup_nolog
suffix:colon
id|ipr_free_mem
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|cleanup_nomem
suffix:colon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|ipr_regs
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|ipr_regs_pci
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_scan_vsets - Scans for VSET devices&n; * @ioa_cfg:&t;ioa config struct&n; *&n; * Description: Since the VSET resources do not follow SAM in that we can have&n; * sparse LUNs with no LUN 0, we have to scan for these ourselves.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_scan_vsets
r_static
r_void
id|ipr_scan_vsets
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
)paren
(brace
r_int
id|target
comma
id|lun
suffix:semicolon
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
id|IPR_MAX_NUM_TARGETS_PER_BUS
suffix:semicolon
id|target
op_increment
)paren
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
id|IPR_MAX_NUM_VSET_LUNS_PER_TARGET
suffix:semicolon
id|lun
op_increment
)paren
id|scsi_add_device
c_func
(paren
id|ioa_cfg-&gt;host
comma
id|IPR_VSET_BUS
comma
id|target
comma
id|lun
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_initiate_ioa_bringdown - Bring down an adapter&n; * @ioa_cfg:&t;&t;ioa config struct&n; * @shutdown_type:&t;shutdown type&n; *&n; * Description: This function will initiate bringing down the adapter.&n; * This consists of issuing an IOA shutdown to the adapter&n; * to flush the cache, and running BIST.&n; * If the caller needs to wait on the completion of the reset,&n; * the caller must sleep on the reset_wait_q.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_initiate_ioa_bringdown
r_static
r_void
id|ipr_initiate_ioa_bringdown
c_func
(paren
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
comma
r_enum
id|ipr_shutdown_type
id|shutdown_type
)paren
(brace
id|ENTER
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;sdt_state
op_eq
id|WAIT_FOR_DUMP
)paren
id|ioa_cfg-&gt;sdt_state
op_assign
id|ABORT_DUMP
suffix:semicolon
id|ioa_cfg-&gt;reset_retries
op_assign
l_int|0
suffix:semicolon
id|ioa_cfg-&gt;in_ioa_bringdown
op_assign
l_int|1
suffix:semicolon
id|ipr_initiate_ioa_reset
c_func
(paren
id|ioa_cfg
comma
id|shutdown_type
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
)brace
multiline_comment|/**&n; * __ipr_remove - Remove a single adapter&n; * @pdev:&t;pci device struct&n; *&n; * Adapter hot plug remove entry point.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|__ipr_remove
r_static
r_void
id|__ipr_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_int
r_int
id|host_lock_flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|ENTER
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|host_lock_flags
)paren
suffix:semicolon
id|ipr_initiate_ioa_bringdown
c_func
(paren
id|ioa_cfg
comma
id|IPR_SHUTDOWN_NORMAL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|host_lock_flags
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|ioa_cfg-&gt;reset_wait_q
comma
op_logical_neg
id|ioa_cfg-&gt;in_reset_reload
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|host_lock_flags
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ipr_driver_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|ioa_cfg-&gt;queue
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ipr_driver_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioa_cfg-&gt;sdt_state
op_eq
id|ABORT_DUMP
)paren
id|ioa_cfg-&gt;sdt_state
op_assign
id|WAIT_FOR_DUMP
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|host_lock_flags
)paren
suffix:semicolon
id|ipr_free_all_resources
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_remove - IOA hot plug remove entry point&n; * @pdev:&t;pci device struct&n; *&n; * Adapter hot plug remove entry point.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_remove
r_static
r_void
id|ipr_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|ENTER
suffix:semicolon
id|ioa_cfg-&gt;allow_cmds
op_assign
l_int|0
suffix:semicolon
id|flush_scheduled_work
c_func
(paren
)paren
suffix:semicolon
id|ipr_remove_trace_file
c_func
(paren
op_amp
id|ioa_cfg-&gt;host-&gt;shost_classdev.kobj
comma
op_amp
id|ipr_trace_attr
)paren
suffix:semicolon
id|ipr_remove_dump_file
c_func
(paren
op_amp
id|ioa_cfg-&gt;host-&gt;shost_classdev.kobj
comma
op_amp
id|ipr_dump_attr
)paren
suffix:semicolon
id|scsi_remove_host
c_func
(paren
id|ioa_cfg-&gt;host
)paren
suffix:semicolon
id|__ipr_remove
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|LEAVE
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_probe - Adapter hot plug add entry point&n; *&n; * Return value:&n; * &t;0 on success / non-zero on failure&n; **/
DECL|function|ipr_probe
r_static
r_int
id|__devinit
id|ipr_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|dev_id
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|ipr_probe_ioa
c_func
(paren
id|pdev
comma
id|dev_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|ioa_cfg
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|rc
op_assign
id|ipr_probe_ioa_part2
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|__ipr_remove
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|scsi_add_host
c_func
(paren
id|ioa_cfg-&gt;host
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|__ipr_remove
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|ipr_create_trace_file
c_func
(paren
op_amp
id|ioa_cfg-&gt;host-&gt;shost_classdev.kobj
comma
op_amp
id|ipr_trace_attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|scsi_remove_host
c_func
(paren
id|ioa_cfg-&gt;host
)paren
suffix:semicolon
id|__ipr_remove
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|ipr_create_dump_file
c_func
(paren
op_amp
id|ioa_cfg-&gt;host-&gt;shost_classdev.kobj
comma
op_amp
id|ipr_dump_attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|ipr_remove_trace_file
c_func
(paren
op_amp
id|ioa_cfg-&gt;host-&gt;shost_classdev.kobj
comma
op_amp
id|ipr_trace_attr
)paren
suffix:semicolon
id|scsi_remove_host
c_func
(paren
id|ioa_cfg-&gt;host
)paren
suffix:semicolon
id|__ipr_remove
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|scsi_scan_host
c_func
(paren
id|ioa_cfg-&gt;host
)paren
suffix:semicolon
id|ipr_scan_vsets
c_func
(paren
id|ioa_cfg
)paren
suffix:semicolon
id|scsi_add_device
c_func
(paren
id|ioa_cfg-&gt;host
comma
id|IPR_IOA_BUS
comma
id|IPR_IOA_TARGET
comma
id|IPR_IOA_LUN
)paren
suffix:semicolon
id|ioa_cfg-&gt;allow_ml_add_del
op_assign
l_int|1
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|ioa_cfg-&gt;work_q
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_shutdown - Shutdown handler.&n; * @dev:&t;device struct&n; *&n; * This function is invoked upon system shutdown/reboot. It will issue&n; * an adapter shutdown to the adapter to flush the write cache.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_shutdown
r_static
r_void
id|ipr_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ipr_ioa_cfg
op_star
id|ioa_cfg
op_assign
id|pci_get_drvdata
c_func
(paren
id|to_pci_dev
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_int
r_int
id|lock_flags
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|ipr_initiate_ioa_bringdown
c_func
(paren
id|ioa_cfg
comma
id|IPR_SHUTDOWN_NORMAL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ioa_cfg-&gt;host-&gt;host_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|ioa_cfg-&gt;reset_wait_q
comma
op_logical_neg
id|ioa_cfg-&gt;in_reset_reload
)paren
suffix:semicolon
)brace
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|ipr_pci_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_MYLEX
comma
id|PCI_DEVICE_ID_IBM_GEMSTONE
comma
id|PCI_VENDOR_ID_IBM
comma
id|IPR_SUBS_DEV_ID_5702
comma
l_int|0
comma
l_int|0
comma
(paren
id|kernel_ulong_t
)paren
op_amp
id|ipr_chip_cfg
(braket
l_int|0
)braket
)brace
comma
(brace
id|PCI_VENDOR_ID_MYLEX
comma
id|PCI_DEVICE_ID_IBM_GEMSTONE
comma
id|PCI_VENDOR_ID_IBM
comma
id|IPR_SUBS_DEV_ID_572E
comma
l_int|0
comma
l_int|0
comma
(paren
id|kernel_ulong_t
)paren
op_amp
id|ipr_chip_cfg
(braket
l_int|0
)braket
)brace
comma
(brace
id|PCI_VENDOR_ID_MYLEX
comma
id|PCI_DEVICE_ID_IBM_GEMSTONE
comma
id|PCI_VENDOR_ID_IBM
comma
id|IPR_SUBS_DEV_ID_5703
comma
l_int|0
comma
l_int|0
comma
(paren
id|kernel_ulong_t
)paren
op_amp
id|ipr_chip_cfg
(braket
l_int|0
)braket
)brace
comma
(brace
id|PCI_VENDOR_ID_MYLEX
comma
id|PCI_DEVICE_ID_IBM_GEMSTONE
comma
id|PCI_VENDOR_ID_IBM
comma
id|IPR_SUBS_DEV_ID_573D
comma
l_int|0
comma
l_int|0
comma
(paren
id|kernel_ulong_t
)paren
op_amp
id|ipr_chip_cfg
(braket
l_int|0
)braket
)brace
comma
(brace
id|PCI_VENDOR_ID_IBM
comma
id|PCI_DEVICE_ID_IBM_SNIPE
comma
id|PCI_VENDOR_ID_IBM
comma
id|IPR_SUBS_DEV_ID_2780
comma
l_int|0
comma
l_int|0
comma
(paren
id|kernel_ulong_t
)paren
op_amp
id|ipr_chip_cfg
(braket
l_int|1
)braket
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|ipr_pci_table
)paren
suffix:semicolon
DECL|variable|ipr_driver
r_static
r_struct
id|pci_driver
id|ipr_driver
op_assign
(brace
dot
id|name
op_assign
id|IPR_NAME
comma
dot
id|id_table
op_assign
id|ipr_pci_table
comma
dot
id|probe
op_assign
id|ipr_probe
comma
dot
id|remove
op_assign
id|ipr_remove
comma
dot
id|driver
op_assign
(brace
dot
id|shutdown
op_assign
id|ipr_shutdown
comma
)brace
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * ipr_init - Module entry point&n; *&n; * Return value:&n; * &t;0 on success / non-zero on failure&n; **/
DECL|function|ipr_init
r_static
r_int
id|__init
id|ipr_init
c_func
(paren
r_void
)paren
(brace
id|ipr_info
c_func
(paren
l_string|&quot;IBM Power RAID SCSI Device Driver version: %s %s&bslash;n&quot;
comma
id|IPR_DRIVER_VERSION
comma
id|IPR_DRIVER_DATE
)paren
suffix:semicolon
id|pci_register_driver
c_func
(paren
op_amp
id|ipr_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ipr_exit - Module unload&n; *&n; * Module unload entry point.&n; *&n; * Return value:&n; * &t;none&n; **/
DECL|function|ipr_exit
r_static
r_void
id|__exit
id|ipr_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|ipr_driver
)paren
suffix:semicolon
)brace
DECL|variable|ipr_init
id|module_init
c_func
(paren
id|ipr_init
)paren
suffix:semicolon
DECL|variable|ipr_exit
id|module_exit
c_func
(paren
id|ipr_exit
)paren
suffix:semicolon
eof
