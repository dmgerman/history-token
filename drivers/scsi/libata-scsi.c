multiline_comment|/*&n;   libata-scsi.c - helper library for ATA&n;&n;   Copyright 2003 Red Hat, Inc.  All rights reserved.&n;   Copyright 2003 Jeff Garzik&n;&n;   The contents of this file are subject to the Open&n;   Software License version 1.1 that can be found at&n;   http://www.opensource.org/licenses/osl-1.1.txt and is included herein&n;   by reference.&n;&n;   Alternatively, the contents of this file may be used under the terms&n;   of the GNU General Public License version 2 (the &quot;GPL&quot;) as distributed&n;   in the kernel source COPYING file, in which case the provisions of&n;   the GPL are applicable instead of the above.  If you wish to allow&n;   the use of your version of this file only under the terms of the&n;   GPL and not to allow others to use your version of this file under&n;   the OSL, indicate your decision by deleting the provisions above and&n;   replace them with the notice and other provisions required by the GPL.&n;   If you do not delete the provisions above, a recipient may use your&n;   version of this file under either the OSL or the GPL.&n;&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &lt;linux/libata.h&gt;
macro_line|#include &quot;libata.h&quot;
multiline_comment|/**&n; *&t;ata_std_bios_param - generic bios head/sector/cylinder calculator&n; *&t;    used by sd. Most BIOSes nowadays expect a XXX/255/16  (CHS) &n; *&t;    mapping. Some situations may arise where the disk is not &n; *&t;    bootable if this is not used.&n; *&n; *&t;LOCKING:&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_std_bios_param
r_int
id|ata_std_bios_param
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
comma
r_struct
id|block_device
op_star
id|bdev
comma
id|sector_t
id|capacity
comma
r_int
id|geom
(braket
)braket
)paren
(brace
id|geom
(braket
l_int|0
)braket
op_assign
l_int|255
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
id|sector_div
c_func
(paren
id|capacity
comma
l_int|255
op_star
l_int|63
)paren
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|capacity
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ata_scsi_qc_new
r_struct
id|ata_queued_cmd
op_star
id|ata_scsi_qc_new
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_device
op_star
id|dev
comma
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
id|qc
op_assign
id|ata_qc_new_init
c_func
(paren
id|ap
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qc
)paren
(brace
id|qc-&gt;scsicmd
op_assign
id|cmd
suffix:semicolon
id|qc-&gt;scsidone
op_assign
id|done
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
id|qc-&gt;sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
id|qc-&gt;n_elem
op_assign
id|cmd-&gt;use_sg
suffix:semicolon
)brace
r_else
(brace
id|qc-&gt;sg
op_assign
op_amp
id|qc-&gt;sgent
suffix:semicolon
id|qc-&gt;n_elem
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|cmd-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
(paren
id|QUEUE_FULL
op_lshift
l_int|1
)paren
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
r_return
id|qc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_to_sense_error -&n; *&t;@qc:&n; *&t;@cmd:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_to_sense_error
r_void
id|ata_to_sense_error
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|cmd
op_assign
id|qc-&gt;scsicmd
suffix:semicolon
id|cmd-&gt;result
op_assign
id|SAM_STAT_CHECK_CONDITION
suffix:semicolon
id|cmd-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|cmd-&gt;sense_buffer
(braket
l_int|2
)braket
op_assign
id|MEDIUM_ERROR
suffix:semicolon
id|cmd-&gt;sense_buffer
(braket
l_int|7
)braket
op_assign
l_int|14
op_minus
l_int|8
suffix:semicolon
multiline_comment|/* addnl. sense len. FIXME: correct? */
multiline_comment|/* additional-sense-code[-qualifier] */
r_if
c_cond
(paren
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_WRITE
)paren
op_eq
l_int|0
)paren
(brace
id|cmd-&gt;sense_buffer
(braket
l_int|12
)braket
op_assign
l_int|0x11
suffix:semicolon
multiline_comment|/* &quot;unrecovered read error&quot; */
id|cmd-&gt;sense_buffer
(braket
l_int|13
)braket
op_assign
l_int|0x04
suffix:semicolon
)brace
r_else
(brace
id|cmd-&gt;sense_buffer
(braket
l_int|12
)braket
op_assign
l_int|0x0C
suffix:semicolon
multiline_comment|/* &quot;write error -             */
id|cmd-&gt;sense_buffer
(braket
l_int|13
)braket
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/*  auto-reallocation failed&quot; */
)brace
)brace
multiline_comment|/**&n; *&t;ata_scsi_slave_config -&n; *&t;@sdev:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|ata_scsi_slave_config
r_int
id|ata_scsi_slave_config
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
)paren
(brace
id|sdev-&gt;use_10_for_rw
op_assign
l_int|1
suffix:semicolon
id|sdev-&gt;use_10_for_ms
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* scsi layer doesn&squot;t check return value, sigh */
)brace
multiline_comment|/**&n; *&t;ata_scsi_error - SCSI layer error handler callback&n; *&t;@host: SCSI host on which error occurred&n; *&n; *&t;Handles SCSI-layer-thrown error events.&n; *&n; *&t;LOCKING:&n; *&t;Inherited from SCSI layer (none, can sleep)&n; *&n; *&t;RETURNS:&n; *&t;Zero.&n; */
DECL|function|ata_scsi_error
r_int
id|ata_scsi_error
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|ap
op_assign
(paren
r_struct
id|ata_port
op_star
)paren
op_amp
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|eng_timeout
c_func
(paren
id|ap
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsi_rw_xlat -&n; *&t;@qc:&n; *&t;@scsicmd:&n; *&t;@cmd_size:&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_scsi_rw_xlat
r_static
r_int
r_int
id|ata_scsi_rw_xlat
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
comma
id|u8
op_star
id|scsicmd
comma
r_int
r_int
id|cmd_size
)paren
(brace
r_struct
id|ata_taskfile
op_star
id|tf
op_assign
op_amp
id|qc-&gt;tf
suffix:semicolon
r_int
r_int
id|lba48
op_assign
id|tf-&gt;flags
op_amp
id|ATA_TFLAG_LBA48
suffix:semicolon
r_int
r_int
id|dma
op_assign
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_DMA
suffix:semicolon
id|qc-&gt;cursect
op_assign
id|qc-&gt;cursg
op_assign
id|qc-&gt;cursg_ofs
op_assign
l_int|0
suffix:semicolon
id|tf-&gt;flags
op_or_assign
id|ATA_TFLAG_ISADDR
op_or
id|ATA_TFLAG_DEVICE
suffix:semicolon
id|tf-&gt;hob_nsect
op_assign
l_int|0
suffix:semicolon
id|tf-&gt;hob_lbal
op_assign
l_int|0
suffix:semicolon
id|tf-&gt;hob_lbam
op_assign
l_int|0
suffix:semicolon
id|tf-&gt;hob_lbah
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scsicmd
(braket
l_int|0
)braket
op_eq
id|READ_10
op_logical_or
id|scsicmd
(braket
l_int|0
)braket
op_eq
id|READ_6
op_logical_or
id|scsicmd
(braket
l_int|0
)braket
op_eq
id|READ_16
)paren
(brace
r_if
c_cond
(paren
id|likely
c_func
(paren
id|dma
)paren
)paren
(brace
r_if
c_cond
(paren
id|lba48
)paren
id|tf-&gt;command
op_assign
id|ATA_CMD_READ_EXT
suffix:semicolon
r_else
id|tf-&gt;command
op_assign
id|ATA_CMD_READ
suffix:semicolon
id|tf-&gt;protocol
op_assign
id|ATA_PROT_DMA_READ
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|lba48
)paren
id|tf-&gt;command
op_assign
id|ATA_CMD_PIO_READ_EXT
suffix:semicolon
r_else
id|tf-&gt;command
op_assign
id|ATA_CMD_PIO_READ
suffix:semicolon
id|tf-&gt;protocol
op_assign
id|ATA_PROT_PIO_READ
suffix:semicolon
)brace
id|qc-&gt;flags
op_and_assign
op_complement
id|ATA_QCFLAG_WRITE
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;reading&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|likely
c_func
(paren
id|dma
)paren
)paren
(brace
r_if
c_cond
(paren
id|lba48
)paren
id|tf-&gt;command
op_assign
id|ATA_CMD_WRITE_EXT
suffix:semicolon
r_else
id|tf-&gt;command
op_assign
id|ATA_CMD_WRITE
suffix:semicolon
id|tf-&gt;protocol
op_assign
id|ATA_PROT_DMA_WRITE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|lba48
)paren
id|tf-&gt;command
op_assign
id|ATA_CMD_PIO_WRITE_EXT
suffix:semicolon
r_else
id|tf-&gt;command
op_assign
id|ATA_CMD_PIO_WRITE
suffix:semicolon
id|tf-&gt;protocol
op_assign
id|ATA_PROT_PIO_WRITE
suffix:semicolon
)brace
id|qc-&gt;flags
op_or_assign
id|ATA_QCFLAG_WRITE
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;writing&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd_size
op_eq
l_int|10
)paren
(brace
r_if
c_cond
(paren
id|lba48
)paren
(brace
id|tf-&gt;hob_nsect
op_assign
id|scsicmd
(braket
l_int|7
)braket
suffix:semicolon
id|tf-&gt;hob_lbal
op_assign
id|scsicmd
(braket
l_int|2
)braket
suffix:semicolon
id|qc-&gt;nsect
op_assign
(paren
(paren
r_int
r_int
)paren
id|scsicmd
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
op_or
id|scsicmd
(braket
l_int|8
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* if we don&squot;t support LBA48 addressing, the request&n;&t;&t;&t; * -may- be too large. */
r_if
c_cond
(paren
(paren
id|scsicmd
(braket
l_int|2
)braket
op_amp
l_int|0xf0
)paren
op_logical_or
id|scsicmd
(braket
l_int|7
)braket
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* stores LBA27:24 in lower 4 bits of device reg */
id|tf-&gt;device
op_or_assign
id|scsicmd
(braket
l_int|2
)braket
suffix:semicolon
id|qc-&gt;nsect
op_assign
id|scsicmd
(braket
l_int|8
)braket
suffix:semicolon
)brace
id|tf-&gt;device
op_or_assign
id|ATA_LBA
suffix:semicolon
id|tf-&gt;nsect
op_assign
id|scsicmd
(braket
l_int|8
)braket
suffix:semicolon
id|tf-&gt;lbal
op_assign
id|scsicmd
(braket
l_int|5
)braket
suffix:semicolon
id|tf-&gt;lbam
op_assign
id|scsicmd
(braket
l_int|4
)braket
suffix:semicolon
id|tf-&gt;lbah
op_assign
id|scsicmd
(braket
l_int|3
)braket
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ten-byte command&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd_size
op_eq
l_int|6
)paren
(brace
id|qc-&gt;nsect
op_assign
id|tf-&gt;nsect
op_assign
id|scsicmd
(braket
l_int|4
)braket
suffix:semicolon
id|tf-&gt;lbal
op_assign
id|scsicmd
(braket
l_int|3
)braket
suffix:semicolon
id|tf-&gt;lbam
op_assign
id|scsicmd
(braket
l_int|2
)braket
suffix:semicolon
id|tf-&gt;lbah
op_assign
id|scsicmd
(braket
l_int|1
)braket
op_amp
l_int|0x1f
suffix:semicolon
multiline_comment|/* mask out reserved bits */
id|VPRINTK
c_func
(paren
l_string|&quot;six-byte command&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd_size
op_eq
l_int|16
)paren
(brace
multiline_comment|/* rule out impossible LBAs and sector counts */
r_if
c_cond
(paren
id|scsicmd
(braket
l_int|2
)braket
op_logical_or
id|scsicmd
(braket
l_int|3
)braket
op_logical_or
id|scsicmd
(braket
l_int|10
)braket
op_logical_or
id|scsicmd
(braket
l_int|11
)braket
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|lba48
)paren
(brace
id|tf-&gt;hob_nsect
op_assign
id|scsicmd
(braket
l_int|12
)braket
suffix:semicolon
id|tf-&gt;hob_lbal
op_assign
id|scsicmd
(braket
l_int|6
)braket
suffix:semicolon
id|tf-&gt;hob_lbam
op_assign
id|scsicmd
(braket
l_int|5
)braket
suffix:semicolon
id|tf-&gt;hob_lbah
op_assign
id|scsicmd
(braket
l_int|4
)braket
suffix:semicolon
id|qc-&gt;nsect
op_assign
(paren
(paren
r_int
r_int
)paren
id|scsicmd
(braket
l_int|12
)braket
op_lshift
l_int|8
)paren
op_or
id|scsicmd
(braket
l_int|13
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* once again, filter out impossible non-zero values */
r_if
c_cond
(paren
id|scsicmd
(braket
l_int|4
)braket
op_logical_or
id|scsicmd
(braket
l_int|5
)braket
op_logical_or
id|scsicmd
(braket
l_int|12
)braket
op_logical_or
(paren
id|scsicmd
(braket
l_int|6
)braket
op_amp
l_int|0xf0
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* stores LBA27:24 in lower 4 bits of device reg */
id|tf-&gt;device
op_or_assign
id|scsicmd
(braket
l_int|2
)braket
suffix:semicolon
id|qc-&gt;nsect
op_assign
id|scsicmd
(braket
l_int|13
)braket
suffix:semicolon
)brace
id|tf-&gt;device
op_or_assign
id|ATA_LBA
suffix:semicolon
id|tf-&gt;nsect
op_assign
id|scsicmd
(braket
l_int|13
)braket
suffix:semicolon
id|tf-&gt;lbal
op_assign
id|scsicmd
(braket
l_int|9
)braket
suffix:semicolon
id|tf-&gt;lbam
op_assign
id|scsicmd
(braket
l_int|8
)braket
suffix:semicolon
id|tf-&gt;lbah
op_assign
id|scsicmd
(braket
l_int|7
)braket
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;sixteen-byte command&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;no-byte command&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsi_rw_queue -&n; *&t;@ap:&n; *&t;@dev:&n; *&t;@cmd:&n; *&t;@done:&n; *&t;@cmd_size:&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsi_rw_queue
r_void
id|ata_scsi_rw_queue
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_device
op_star
id|dev
comma
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
comma
r_int
r_int
id|cmd_size
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
id|u8
op_star
id|scsicmd
op_assign
id|cmd-&gt;cmnd
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|cmd-&gt;request_bufflen
OL
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ata%u(%u): empty request buffer&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|dev-&gt;devno
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|qc
op_assign
id|ata_scsi_qc_new
c_func
(paren
id|ap
comma
id|dev
comma
id|cmd
comma
id|done
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qc
)paren
r_return
suffix:semicolon
id|qc-&gt;flags
op_or_assign
id|ATA_QCFLAG_SG
suffix:semicolon
multiline_comment|/* data is present; dma-map it */
r_if
c_cond
(paren
id|ata_scsi_rw_xlat
c_func
(paren
id|qc
comma
id|scsicmd
comma
id|cmd_size
)paren
)paren
r_goto
id|err_out
suffix:semicolon
multiline_comment|/* select device, send command to hardware */
r_if
c_cond
(paren
id|ata_qc_issue
c_func
(paren
id|qc
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
id|err_out
suffix:colon
id|ata_bad_cdb
c_func
(paren
id|cmd
comma
id|done
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT - badcmd&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsi_rbuf_get - Map response buffer.&n; *&t;@cmd: SCSI command containing buffer to be mapped.&n; *&t;@buf_out: Pointer to mapped area.&n; *&n; *&t;Maps buffer contained within SCSI command @cmd.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; *&t;FIXME: kmap inside spin_lock_irqsave ok?&n; *&n; *&t;RETURNS:&n; *&t;Length of response buffer.&n; */
DECL|function|ata_scsi_rbuf_get
r_static
r_int
r_int
id|ata_scsi_rbuf_get
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
id|u8
op_star
op_star
id|buf_out
)paren
(brace
id|u8
op_star
id|buf
suffix:semicolon
r_int
r_int
id|buflen
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
id|buf
op_assign
id|kmap
c_func
(paren
id|sg-&gt;page
)paren
op_plus
id|sg-&gt;offset
suffix:semicolon
id|buflen
op_assign
id|sg-&gt;length
suffix:semicolon
)brace
r_else
(brace
id|buf
op_assign
id|cmd-&gt;request_buffer
suffix:semicolon
id|buflen
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
id|buflen
)paren
suffix:semicolon
op_star
id|buf_out
op_assign
id|buf
suffix:semicolon
r_return
id|buflen
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsi_rbuf_put - Unmap response buffer.&n; *&t;@cmd: SCSI command containing buffer to be unmapped.&n; *&n; *&t;Unmaps response buffer contained within @cmd.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsi_rbuf_put
r_static
r_inline
r_void
id|ata_scsi_rbuf_put
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
id|kunmap
c_func
(paren
id|sg-&gt;page
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;ata_scsi_rbuf_fill - wrapper for SCSI command simulators&n; *&t;@args: Port / device / SCSI command of interest.&n; *&t;@actor: Callback hook for desired SCSI command simulator&n; *&n; *&t;Takes care of the hard work of simulating a SCSI command...&n; *&t;Mapping the response buffer, calling the command&squot;s handler,&n; *&t;and handling the handler&squot;s return value.  This return value&n; *&t;indicates whether the handler wishes the SCSI command to be&n; *&t;completed successfully, or not.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsi_rbuf_fill
r_void
id|ata_scsi_rbuf_fill
c_func
(paren
r_struct
id|ata_scsi_args
op_star
id|args
comma
r_int
r_int
(paren
op_star
id|actor
)paren
(paren
r_struct
id|ata_scsi_args
op_star
id|args
comma
id|u8
op_star
id|rbuf
comma
r_int
r_int
id|buflen
)paren
)paren
(brace
id|u8
op_star
id|rbuf
suffix:semicolon
r_int
r_int
id|buflen
comma
id|rc
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmd
op_assign
id|args-&gt;cmd
suffix:semicolon
id|buflen
op_assign
id|ata_scsi_rbuf_get
c_func
(paren
id|cmd
comma
op_amp
id|rbuf
)paren
suffix:semicolon
id|rc
op_assign
id|actor
c_func
(paren
id|args
comma
id|rbuf
comma
id|buflen
)paren
suffix:semicolon
id|ata_scsi_rbuf_put
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|ata_bad_cdb
c_func
(paren
id|cmd
comma
id|args-&gt;done
)paren
suffix:semicolon
r_else
(brace
id|cmd-&gt;result
op_assign
id|SAM_STAT_GOOD
suffix:semicolon
id|args
op_member_access_from_pointer
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;ata_scsiop_inq_std - Simulate INQUIRY command&n; *&t;@args: Port / device / SCSI command of interest.&n; *&t;@rbuf: Response buffer, to which simulated SCSI cmd output is sent.&n; *&t;@buflen: Response buffer length.&n; *&n; *&t;Returns standard device identification data associated&n; *&t;with non-EVPD INQUIRY command output.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsiop_inq_std
r_int
r_int
id|ata_scsiop_inq_std
c_func
(paren
r_struct
id|ata_scsi_args
op_star
id|args
comma
id|u8
op_star
id|rbuf
comma
r_int
r_int
id|buflen
)paren
(brace
r_const
id|u8
id|hdr
(braket
)braket
op_assign
(brace
id|TYPE_DISK
comma
l_int|0
comma
l_int|0x5
comma
multiline_comment|/* claim SPC-3 version compatibility */
l_int|2
comma
l_int|96
op_minus
l_int|4
)brace
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|rbuf
comma
id|hdr
comma
r_sizeof
(paren
id|hdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buflen
OG
l_int|36
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|rbuf
(braket
l_int|8
)braket
comma
id|args-&gt;dev-&gt;vendor
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|rbuf
(braket
l_int|16
)braket
comma
id|args-&gt;dev-&gt;product
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|rbuf
(braket
l_int|32
)braket
comma
id|DRV_VERSION
comma
l_int|4
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buflen
OG
l_int|63
)paren
(brace
r_const
id|u8
id|versions
(braket
)braket
op_assign
(brace
l_int|0x60
comma
multiline_comment|/* SAM-3 (no version claimed) */
l_int|0x03
comma
l_int|0x20
comma
multiline_comment|/* SBC-2 (no version claimed) */
l_int|0x02
comma
l_int|0x60
multiline_comment|/* SPC-3 (no version claimed) */
)brace
suffix:semicolon
id|memcpy
c_func
(paren
id|rbuf
op_plus
l_int|59
comma
id|versions
comma
r_sizeof
(paren
id|versions
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsiop_inq_00 - Simulate INQUIRY EVPD page 0, list of pages&n; *&t;@args: Port / device / SCSI command of interest.&n; *&t;@rbuf: Response buffer, to which simulated SCSI cmd output is sent.&n; *&t;@buflen: Response buffer length.&n; *&n; *&t;Returns list of inquiry EVPD pages available.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsiop_inq_00
r_int
r_int
id|ata_scsiop_inq_00
c_func
(paren
r_struct
id|ata_scsi_args
op_star
id|args
comma
id|u8
op_star
id|rbuf
comma
r_int
r_int
id|buflen
)paren
(brace
r_const
id|u8
id|pages
(braket
)braket
op_assign
(brace
l_int|0x00
comma
multiline_comment|/* page 0x00, this page */
l_int|0x80
comma
multiline_comment|/* page 0x80, unit serial no page */
l_int|0x83
multiline_comment|/* page 0x83, device ident page */
)brace
suffix:semicolon
id|rbuf
(braket
l_int|3
)braket
op_assign
r_sizeof
(paren
id|pages
)paren
suffix:semicolon
multiline_comment|/* number of supported EVPD pages */
r_if
c_cond
(paren
id|buflen
OG
l_int|6
)paren
id|memcpy
c_func
(paren
id|rbuf
op_plus
l_int|4
comma
id|pages
comma
r_sizeof
(paren
id|pages
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsiop_inq_80 - Simulate INQUIRY EVPD page 80, device serial number&n; *&t;@args: Port / device / SCSI command of interest.&n; *&t;@rbuf: Response buffer, to which simulated SCSI cmd output is sent.&n; *&t;@buflen: Response buffer length.&n; *&n; *&t;Returns ATA device serial number.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsiop_inq_80
r_int
r_int
id|ata_scsiop_inq_80
c_func
(paren
r_struct
id|ata_scsi_args
op_star
id|args
comma
id|u8
op_star
id|rbuf
comma
r_int
r_int
id|buflen
)paren
(brace
r_const
id|u8
id|hdr
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0x80
comma
multiline_comment|/* this page code */
l_int|0
comma
id|ATA_SERNO_LEN
comma
multiline_comment|/* page len */
)brace
suffix:semicolon
id|memcpy
c_func
(paren
id|rbuf
comma
id|hdr
comma
r_sizeof
(paren
id|hdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buflen
OG
(paren
id|ATA_SERNO_LEN
op_plus
l_int|4
)paren
)paren
id|ata_dev_id_string
c_func
(paren
id|args-&gt;dev
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|rbuf
(braket
l_int|4
)braket
comma
id|ATA_ID_SERNO_OFS
comma
id|ATA_SERNO_LEN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|inq_83_str
r_static
r_const
r_char
op_star
id|inq_83_str
op_assign
l_string|&quot;Linux ATA-SCSI simulator&quot;
suffix:semicolon
multiline_comment|/**&n; *&t;ata_scsiop_inq_83 - Simulate INQUIRY EVPD page 83, device identity&n; *&t;@args: Port / device / SCSI command of interest.&n; *&t;@rbuf: Response buffer, to which simulated SCSI cmd output is sent.&n; *&t;@buflen: Response buffer length.&n; *&n; *&t;Returns device identification.  Currently hardcoded to&n; *&t;return &quot;Linux ATA-SCSI simulator&quot;.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsiop_inq_83
r_int
r_int
id|ata_scsiop_inq_83
c_func
(paren
r_struct
id|ata_scsi_args
op_star
id|args
comma
id|u8
op_star
id|rbuf
comma
r_int
r_int
id|buflen
)paren
(brace
id|rbuf
(braket
l_int|1
)braket
op_assign
l_int|0x83
suffix:semicolon
multiline_comment|/* this page code */
id|rbuf
(braket
l_int|3
)braket
op_assign
l_int|4
op_plus
id|strlen
c_func
(paren
id|inq_83_str
)paren
suffix:semicolon
multiline_comment|/* page len */
multiline_comment|/* our one and only identification descriptor (vendor-specific) */
r_if
c_cond
(paren
id|buflen
OG
(paren
id|strlen
c_func
(paren
id|inq_83_str
)paren
op_plus
l_int|4
op_plus
l_int|4
)paren
)paren
(brace
id|rbuf
(braket
l_int|4
op_plus
l_int|0
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* code set: ASCII */
id|rbuf
(braket
l_int|4
op_plus
l_int|3
)braket
op_assign
id|strlen
c_func
(paren
id|inq_83_str
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|rbuf
op_plus
l_int|4
op_plus
l_int|4
comma
id|inq_83_str
comma
id|strlen
c_func
(paren
id|inq_83_str
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsiop_noop -&n; *&t;@args: Port / device / SCSI command of interest.&n; *&t;@rbuf: Response buffer, to which simulated SCSI cmd output is sent.&n; *&t;@buflen: Response buffer length.&n; *&n; *&t;No operation.  Simply returns success to caller, to indicate&n; *&t;that the caller should successfully complete this SCSI command.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsiop_noop
r_int
r_int
id|ata_scsiop_noop
c_func
(paren
r_struct
id|ata_scsi_args
op_star
id|args
comma
id|u8
op_star
id|rbuf
comma
r_int
r_int
id|buflen
)paren
(brace
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsiop_sync_cache - Simulate SYNCHRONIZE CACHE command&n; *&t;@args: Port / device / SCSI command of interest.&n; *&t;@rbuf: Response buffer, to which simulated SCSI cmd output is sent.&n; *&t;@buflen: Response buffer length.&n; *&n; *&t;Initiates flush of device&squot;s cache.&n; *&n; *&t;TODO:&n; *&t;Actually do this :)&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsiop_sync_cache
r_int
r_int
id|ata_scsiop_sync_cache
c_func
(paren
r_struct
id|ata_scsi_args
op_star
id|args
comma
id|u8
op_star
id|rbuf
comma
r_int
r_int
id|buflen
)paren
(brace
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_msense_push - Push data onto MODE SENSE data output buffer&n; *&t;@ptr_io: (input/output) Location to store more output data&n; *&t;@last: End of output data buffer&n; *&t;@buf: Pointer to BLOB being added to output buffer&n; *&t;@buflen: Length of BLOB&n; *&n; *&t;Store MODE SENSE data on an output buffer.&n; *&n; *&t;LOCKING:&n; *&t;None.&n; */
DECL|function|ata_msense_push
r_static
r_void
id|ata_msense_push
c_func
(paren
id|u8
op_star
op_star
id|ptr_io
comma
r_const
id|u8
op_star
id|last
comma
r_const
id|u8
op_star
id|buf
comma
r_int
r_int
id|buflen
)paren
(brace
id|u8
op_star
id|ptr
op_assign
op_star
id|ptr_io
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ptr
op_plus
id|buflen
op_minus
l_int|1
)paren
OG
id|last
)paren
r_return
suffix:semicolon
id|memcpy
c_func
(paren
id|ptr
comma
id|buf
comma
id|buflen
)paren
suffix:semicolon
id|ptr
op_add_assign
id|buflen
suffix:semicolon
op_star
id|ptr_io
op_assign
id|ptr
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_msense_caching - Simulate MODE SENSE caching info page&n; *&t;@dev:&n; *&t;@ptr_io:&n; *&t;@last:&n; *&n; *&t;Generate a caching info page, which conditionally indicates&n; *&t;write caching to the SCSI layer, depending on device&n; *&t;capabilities.&n; *&n; *&t;LOCKING:&n; *&t;None.&n; */
DECL|function|ata_msense_caching
r_static
r_int
r_int
id|ata_msense_caching
c_func
(paren
r_struct
id|ata_device
op_star
id|dev
comma
id|u8
op_star
op_star
id|ptr_io
comma
r_const
id|u8
op_star
id|last
)paren
(brace
id|u8
id|page
(braket
l_int|7
)braket
op_assign
(brace
l_int|0xf
comma
l_int|0
comma
l_int|0x10
comma
l_int|0
comma
l_int|0x8
comma
l_int|0xa
comma
l_int|0
)brace
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|ATA_DFLAG_WCACHE
)paren
id|page
(braket
l_int|6
)braket
op_assign
l_int|0x4
suffix:semicolon
id|ata_msense_push
c_func
(paren
id|ptr_io
comma
id|last
comma
id|page
comma
r_sizeof
(paren
id|page
)paren
)paren
suffix:semicolon
r_return
r_sizeof
(paren
id|page
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_msense_ctl_mode - Simulate MODE SENSE control mode page&n; *&t;@dev:&n; *&t;@ptr_io:&n; *&t;@last:&n; *&n; *&t;Generate a generic MODE SENSE control mode page.&n; *&n; *&t;LOCKING:&n; *&t;None.&n; */
DECL|function|ata_msense_ctl_mode
r_static
r_int
r_int
id|ata_msense_ctl_mode
c_func
(paren
id|u8
op_star
op_star
id|ptr_io
comma
r_const
id|u8
op_star
id|last
)paren
(brace
r_const
id|u8
id|page
(braket
)braket
op_assign
(brace
l_int|0xa
comma
l_int|0xa
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0
comma
l_int|30
)brace
suffix:semicolon
id|ata_msense_push
c_func
(paren
id|ptr_io
comma
id|last
comma
id|page
comma
r_sizeof
(paren
id|page
)paren
)paren
suffix:semicolon
r_return
r_sizeof
(paren
id|page
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsiop_mode_sense - Simulate MODE SENSE 6, 10 commands&n; *&t;@args: Port / device / SCSI command of interest.&n; *&t;@rbuf: Response buffer, to which simulated SCSI cmd output is sent.&n; *&t;@buflen: Response buffer length.&n; *&n; *&t;Simulate MODE SENSE commands.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsiop_mode_sense
r_int
r_int
id|ata_scsiop_mode_sense
c_func
(paren
r_struct
id|ata_scsi_args
op_star
id|args
comma
id|u8
op_star
id|rbuf
comma
r_int
r_int
id|buflen
)paren
(brace
id|u8
op_star
id|scsicmd
op_assign
id|args-&gt;cmd-&gt;cmnd
comma
op_star
id|p
comma
op_star
id|last
suffix:semicolon
r_struct
id|ata_device
op_star
id|dev
op_assign
id|args-&gt;dev
suffix:semicolon
r_int
r_int
id|page_control
comma
id|six_byte
comma
id|output_len
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|six_byte
op_assign
(paren
id|scsicmd
(braket
l_int|0
)braket
op_eq
id|MODE_SENSE
)paren
suffix:semicolon
multiline_comment|/* we only support saved and current values (which we treat&n;&t; * in the same manner)&n;&t; */
id|page_control
op_assign
id|scsicmd
(braket
l_int|2
)braket
op_rshift
l_int|6
suffix:semicolon
r_if
c_cond
(paren
(paren
id|page_control
op_ne
l_int|0
)paren
op_logical_and
(paren
id|page_control
op_ne
l_int|3
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|six_byte
)paren
id|output_len
op_assign
l_int|4
suffix:semicolon
r_else
id|output_len
op_assign
l_int|8
suffix:semicolon
id|p
op_assign
id|rbuf
op_plus
id|output_len
suffix:semicolon
id|last
op_assign
id|rbuf
op_plus
id|buflen
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|scsicmd
(braket
l_int|2
)braket
op_amp
l_int|0x3f
)paren
(brace
r_case
l_int|0x08
suffix:colon
multiline_comment|/* caching */
id|output_len
op_add_assign
id|ata_msense_caching
c_func
(paren
id|dev
comma
op_amp
id|p
comma
id|last
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0a
suffix:colon
(brace
multiline_comment|/* control mode */
id|output_len
op_add_assign
id|ata_msense_ctl_mode
c_func
(paren
op_amp
id|p
comma
id|last
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x3f
suffix:colon
multiline_comment|/* all pages */
id|output_len
op_add_assign
id|ata_msense_caching
c_func
(paren
id|dev
comma
op_amp
id|p
comma
id|last
)paren
suffix:semicolon
id|output_len
op_add_assign
id|ata_msense_ctl_mode
c_func
(paren
op_amp
id|p
comma
id|last
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* invalid page code */
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|six_byte
)paren
(brace
id|output_len
op_decrement
suffix:semicolon
id|rbuf
(braket
l_int|0
)braket
op_assign
id|output_len
suffix:semicolon
)brace
r_else
(brace
id|output_len
op_sub_assign
l_int|2
suffix:semicolon
id|rbuf
(braket
l_int|0
)braket
op_assign
id|output_len
op_rshift
l_int|8
suffix:semicolon
id|rbuf
(braket
l_int|1
)braket
op_assign
id|output_len
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsiop_read_cap - Simulate READ CAPACITY[ 16] commands&n; *&t;@args: Port / device / SCSI command of interest.&n; *&t;@rbuf: Response buffer, to which simulated SCSI cmd output is sent.&n; *&t;@buflen: Response buffer length.&n; *&n; *&t;Simulate READ CAPACITY commands.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsiop_read_cap
r_int
r_int
id|ata_scsiop_read_cap
c_func
(paren
r_struct
id|ata_scsi_args
op_star
id|args
comma
id|u8
op_star
id|rbuf
comma
r_int
r_int
id|buflen
)paren
(brace
id|u64
id|n_sectors
op_assign
id|args-&gt;dev-&gt;n_sectors
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|n_sectors
op_decrement
suffix:semicolon
multiline_comment|/* one off */
id|tmp
op_assign
id|n_sectors
suffix:semicolon
multiline_comment|/* note: truncates, if lba48 */
r_if
c_cond
(paren
id|args-&gt;cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_CAPACITY
)paren
(brace
id|rbuf
(braket
l_int|0
)braket
op_assign
id|tmp
op_rshift
(paren
l_int|8
op_star
l_int|3
)paren
suffix:semicolon
id|rbuf
(braket
l_int|1
)braket
op_assign
id|tmp
op_rshift
(paren
l_int|8
op_star
l_int|2
)paren
suffix:semicolon
id|rbuf
(braket
l_int|2
)braket
op_assign
id|tmp
op_rshift
(paren
l_int|8
op_star
l_int|1
)paren
suffix:semicolon
id|rbuf
(braket
l_int|3
)braket
op_assign
id|tmp
suffix:semicolon
id|tmp
op_assign
id|ATA_SECT_SIZE
suffix:semicolon
id|rbuf
(braket
l_int|6
)braket
op_assign
id|tmp
op_rshift
l_int|8
suffix:semicolon
id|rbuf
(braket
l_int|7
)braket
op_assign
id|tmp
suffix:semicolon
)brace
r_else
(brace
id|rbuf
(braket
l_int|2
)braket
op_assign
id|n_sectors
op_rshift
(paren
l_int|8
op_star
l_int|7
)paren
suffix:semicolon
id|rbuf
(braket
l_int|3
)braket
op_assign
id|n_sectors
op_rshift
(paren
l_int|8
op_star
l_int|6
)paren
suffix:semicolon
id|rbuf
(braket
l_int|4
)braket
op_assign
id|n_sectors
op_rshift
(paren
l_int|8
op_star
l_int|5
)paren
suffix:semicolon
id|rbuf
(braket
l_int|5
)braket
op_assign
id|n_sectors
op_rshift
(paren
l_int|8
op_star
l_int|4
)paren
suffix:semicolon
id|rbuf
(braket
l_int|6
)braket
op_assign
id|tmp
op_rshift
(paren
l_int|8
op_star
l_int|3
)paren
suffix:semicolon
id|rbuf
(braket
l_int|7
)braket
op_assign
id|tmp
op_rshift
(paren
l_int|8
op_star
l_int|2
)paren
suffix:semicolon
id|rbuf
(braket
l_int|8
)braket
op_assign
id|tmp
op_rshift
(paren
l_int|8
op_star
l_int|1
)paren
suffix:semicolon
id|rbuf
(braket
l_int|9
)braket
op_assign
id|tmp
suffix:semicolon
id|tmp
op_assign
id|ATA_SECT_SIZE
suffix:semicolon
id|rbuf
(braket
l_int|12
)braket
op_assign
id|tmp
op_rshift
l_int|8
suffix:semicolon
id|rbuf
(braket
l_int|13
)braket
op_assign
id|tmp
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsiop_report_luns - Simulate REPORT LUNS command&n; *&t;@args: Port / device / SCSI command of interest.&n; *&t;@rbuf: Response buffer, to which simulated SCSI cmd output is sent.&n; *&t;@buflen: Response buffer length.&n; *&n; *&t;Simulate REPORT LUNS command.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsiop_report_luns
r_int
r_int
id|ata_scsiop_report_luns
c_func
(paren
r_struct
id|ata_scsi_args
op_star
id|args
comma
id|u8
op_star
id|rbuf
comma
r_int
r_int
id|buflen
)paren
(brace
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|rbuf
(braket
l_int|3
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* just one lun, LUN 0, size 8 bytes */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsi_badcmd -&n; *&t;@cmd:&n; *&t;@done:&n; *&t;@asc:&n; *&t;@ascq:&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_scsi_badcmd
r_void
id|ata_scsi_badcmd
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
comma
id|u8
id|asc
comma
id|u8
id|ascq
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|SAM_STAT_CHECK_CONDITION
suffix:semicolon
id|cmd-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|cmd-&gt;sense_buffer
(braket
l_int|2
)braket
op_assign
id|ILLEGAL_REQUEST
suffix:semicolon
id|cmd-&gt;sense_buffer
(braket
l_int|7
)braket
op_assign
l_int|14
op_minus
l_int|8
suffix:semicolon
multiline_comment|/* addnl. sense len. FIXME: correct? */
id|cmd-&gt;sense_buffer
(braket
l_int|12
)braket
op_assign
id|asc
suffix:semicolon
id|cmd-&gt;sense_buffer
(braket
l_int|13
)braket
op_assign
id|ascq
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;atapi_scsi_queuecmd - Send CDB to ATAPI device&n; *&t;@ap: Port to which ATAPI device is attached.&n; *&t;@dev: Target device for CDB.&n; *&t;@cmd: SCSI command being sent to device.&n; *&t;@done: SCSI command completion function.&n; *&n; *&t;Sends CDB to ATAPI device.  If the Linux SCSI layer sends a&n; *&t;non-data command, then this function handles the command&n; *&t;directly, via polling.  Otherwise, the bmdma engine is started.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|atapi_scsi_queuecmd
r_static
r_void
id|atapi_scsi_queuecmd
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_device
op_star
id|dev
comma
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
id|u8
op_star
id|scsicmd
op_assign
id|cmd-&gt;cmnd
comma
id|status
suffix:semicolon
r_int
r_int
id|doing_dma
op_assign
l_int|0
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER, drv_stat = 0x%x&bslash;n&quot;
comma
id|ata_chk_status
c_func
(paren
id|ap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;sc_data_direction
op_eq
id|SCSI_DATA_UNKNOWN
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;unknown data, scsicmd 0x%x&bslash;n&quot;
comma
id|scsicmd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ata_bad_cdb
c_func
(paren
id|cmd
comma
id|done
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|scsicmd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|MODE_SELECT
suffix:colon
r_case
id|MODE_SENSE
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;read6/write6/modesel/modesense trap&bslash;n&quot;
)paren
suffix:semicolon
id|ata_bad_scsiop
c_func
(paren
id|cmd
comma
id|done
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
)brace
id|qc
op_assign
id|ata_scsi_qc_new
c_func
(paren
id|ap
comma
id|dev
comma
id|cmd
comma
id|done
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%u: command queue empty&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|qc-&gt;flags
op_or_assign
id|ATA_QCFLAG_ATAPI
suffix:semicolon
id|qc-&gt;tf.flags
op_or_assign
id|ATA_TFLAG_ISADDR
op_or
id|ATA_TFLAG_DEVICE
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;sc_data_direction
op_eq
id|SCSI_DATA_WRITE
)paren
(brace
id|qc-&gt;flags
op_or_assign
id|ATA_QCFLAG_WRITE
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;direction: write&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|qc-&gt;tf.command
op_assign
id|ATA_CMD_PACKET
suffix:semicolon
multiline_comment|/* set up SG table */
r_if
c_cond
(paren
id|cmd-&gt;sc_data_direction
op_eq
id|SCSI_DATA_NONE
)paren
(brace
id|ap-&gt;active_tag
op_assign
id|qc-&gt;tag
suffix:semicolon
id|qc-&gt;flags
op_or_assign
id|ATA_QCFLAG_ACTIVE
op_or
id|ATA_QCFLAG_POLL
suffix:semicolon
id|qc-&gt;tf.protocol
op_assign
id|ATA_PROT_ATAPI
suffix:semicolon
id|ata_dev_select
c_func
(paren
id|ap
comma
id|dev-&gt;devno
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;direction: none&bslash;n&quot;
)paren
suffix:semicolon
id|qc-&gt;tf.ctl
op_or_assign
id|ATA_NIEN
suffix:semicolon
multiline_comment|/* disable interrupts */
id|ata_tf_to_host_nolock
c_func
(paren
id|ap
comma
op_amp
id|qc-&gt;tf
)paren
suffix:semicolon
)brace
r_else
(brace
id|qc-&gt;flags
op_or_assign
id|ATA_QCFLAG_SG
suffix:semicolon
multiline_comment|/* data is present; dma-map it */
id|qc-&gt;tf.feature
op_assign
id|ATAPI_PKT_DMA
suffix:semicolon
id|qc-&gt;tf.protocol
op_assign
id|ATA_PROT_ATAPI_DMA
suffix:semicolon
id|doing_dma
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* select device, send command to hardware */
r_if
c_cond
(paren
id|ata_qc_issue
c_func
(paren
id|qc
)paren
)paren
r_goto
id|err_out
suffix:semicolon
)brace
id|status
op_assign
id|ata_busy_wait
c_func
(paren
id|ap
comma
id|ATA_BUSY
comma
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ATA_BUSY
)paren
(brace
id|ata_thread_wake
c_func
(paren
id|ap
comma
id|THR_PACKET
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
id|ATA_DRQ
)paren
op_eq
l_int|0
)paren
r_goto
id|err_out
suffix:semicolon
multiline_comment|/* FIXME: mmio-ize */
id|DPRINTK
c_func
(paren
l_string|&quot;writing cdb&bslash;n&quot;
)paren
suffix:semicolon
id|outsl
c_func
(paren
id|ap-&gt;ioaddr.data_addr
comma
id|scsicmd
comma
id|ap-&gt;host-&gt;max_cmd_len
op_div
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|doing_dma
)paren
id|ata_thread_wake
c_func
(paren
id|ap
comma
id|THR_PACKET
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
id|err_out
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|doing_dma
)paren
id|ata_irq_on
c_func
(paren
id|ap
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupts */
id|ata_bad_cdb
c_func
(paren
id|cmd
comma
id|done
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT - badcmd&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsi_queuecmd - Issue SCSI cdb to libata-managed device&n; *&t;@cmd: SCSI command to be sent&n; *&t;@done: Completion function, called when command is complete&n; *&n; *&t;In some cases, this function translates SCSI commands into&n; *&t;ATA taskfiles, and queues the taskfiles to be sent to&n; *&t;hardware.  In other cases, this function simulates a&n; *&t;SCSI device by evaluating and responding to certain&n; *&t;SCSI commands.  This creates the overall effect of&n; *&t;ATA and ATAPI devices appearing as SCSI devices.&n; *&n; *&t;LOCKING:&n; *&t;Releases scsi-layer-held lock, and obtains host_set lock.&n; *&n; *&t;RETURNS:&n; *&t;Zero.&n; */
DECL|function|ata_scsi_queuecmd
r_int
id|ata_scsi_queuecmd
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
id|u8
op_star
id|scsicmd
op_assign
id|cmd-&gt;cmnd
suffix:semicolon
r_struct
id|ata_port
op_star
id|ap
suffix:semicolon
r_struct
id|ata_device
op_star
id|dev
suffix:semicolon
r_struct
id|ata_scsi_args
id|args
suffix:semicolon
r_const
r_int
r_int
id|atapi_support
op_assign
macro_line|#ifdef ATA_ENABLE_ATAPI
l_int|1
suffix:semicolon
macro_line|#else
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Note: spin_lock_irqsave is held by caller... */
id|spin_unlock
c_func
(paren
id|cmd-&gt;device-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|ap
op_assign
(paren
r_struct
id|ata_port
op_star
)paren
op_amp
id|cmd-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;CDB (%u:%d,%d,%d) %02x %02x %02x %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|cmd-&gt;device-&gt;channel
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
comma
id|scsicmd
(braket
l_int|0
)braket
comma
id|scsicmd
(braket
l_int|1
)braket
comma
id|scsicmd
(braket
l_int|2
)braket
comma
id|scsicmd
(braket
l_int|3
)braket
comma
id|scsicmd
(braket
l_int|4
)braket
comma
id|scsicmd
(braket
l_int|5
)braket
comma
id|scsicmd
(braket
l_int|6
)braket
comma
id|scsicmd
(braket
l_int|7
)braket
comma
id|scsicmd
(braket
l_int|8
)braket
)paren
suffix:semicolon
multiline_comment|/* skip commands not addressed to targets we care about */
r_if
c_cond
(paren
(paren
id|cmd-&gt;device-&gt;channel
op_ne
l_int|0
)paren
op_logical_or
(paren
id|cmd-&gt;device-&gt;lun
op_ne
l_int|0
)paren
op_logical_or
(paren
id|cmd-&gt;device-&gt;id
op_ge
id|ATA_MAX_DEVICES
)paren
)paren
(brace
id|cmd-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* FIXME: correct? */
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|ap-&gt;host_set-&gt;lock
)paren
suffix:semicolon
id|dev
op_assign
op_amp
id|ap-&gt;device
(braket
id|cmd-&gt;device-&gt;id
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ata_dev_present
c_func
(paren
id|dev
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;no device&bslash;n&quot;
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* FIXME: correct? */
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
op_member_access_from_pointer
r_class
op_eq
id|ATA_DEV_ATAPI
)paren
(brace
r_if
c_cond
(paren
id|atapi_support
)paren
id|atapi_scsi_queuecmd
c_func
(paren
id|ap
comma
id|dev
comma
id|cmd
comma
id|done
)paren
suffix:semicolon
r_else
(brace
id|cmd-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* correct? */
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
r_goto
id|out_unlock
suffix:semicolon
)brace
multiline_comment|/* fast path */
r_switch
c_cond
(paren
id|scsicmd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
id|ata_scsi_rw_queue
c_func
(paren
id|ap
comma
id|dev
comma
id|cmd
comma
id|done
comma
l_int|6
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
r_case
id|READ_10
suffix:colon
r_case
id|WRITE_10
suffix:colon
id|ata_scsi_rw_queue
c_func
(paren
id|ap
comma
id|dev
comma
id|cmd
comma
id|done
comma
l_int|10
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
r_case
id|READ_16
suffix:colon
r_case
id|WRITE_16
suffix:colon
id|ata_scsi_rw_queue
c_func
(paren
id|ap
comma
id|dev
comma
id|cmd
comma
id|done
comma
l_int|16
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * slow path&n;&t; */
id|args.ap
op_assign
id|ap
suffix:semicolon
id|args.dev
op_assign
id|dev
suffix:semicolon
id|args.cmd
op_assign
id|cmd
suffix:semicolon
id|args.done
op_assign
id|done
suffix:semicolon
r_switch
c_cond
(paren
id|scsicmd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|TEST_UNIT_READY
suffix:colon
multiline_comment|/* FIXME: correct? */
r_case
id|FORMAT_UNIT
suffix:colon
multiline_comment|/* FIXME: correct? */
r_case
id|SEND_DIAGNOSTIC
suffix:colon
multiline_comment|/* FIXME: correct? */
id|ata_scsi_rbuf_fill
c_func
(paren
op_amp
id|args
comma
id|ata_scsiop_noop
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
r_if
c_cond
(paren
id|scsicmd
(braket
l_int|1
)braket
op_amp
l_int|2
)paren
multiline_comment|/* is CmdDt set?  */
id|ata_bad_cdb
c_func
(paren
id|cmd
comma
id|done
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|scsicmd
(braket
l_int|1
)braket
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
multiline_comment|/* is EVPD clear? */
id|ata_scsi_rbuf_fill
c_func
(paren
op_amp
id|args
comma
id|ata_scsiop_inq_std
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|scsicmd
(braket
l_int|2
)braket
op_eq
l_int|0x00
)paren
id|ata_scsi_rbuf_fill
c_func
(paren
op_amp
id|args
comma
id|ata_scsiop_inq_00
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|scsicmd
(braket
l_int|2
)braket
op_eq
l_int|0x80
)paren
id|ata_scsi_rbuf_fill
c_func
(paren
op_amp
id|args
comma
id|ata_scsiop_inq_80
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|scsicmd
(braket
l_int|2
)braket
op_eq
l_int|0x83
)paren
id|ata_scsi_rbuf_fill
c_func
(paren
op_amp
id|args
comma
id|ata_scsiop_inq_83
)paren
suffix:semicolon
r_else
id|ata_bad_cdb
c_func
(paren
id|cmd
comma
id|done
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
r_case
id|MODE_SENSE_10
suffix:colon
id|ata_scsi_rbuf_fill
c_func
(paren
op_amp
id|args
comma
id|ata_scsiop_mode_sense
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SELECT
suffix:colon
multiline_comment|/* unconditionally return */
r_case
id|MODE_SELECT_10
suffix:colon
multiline_comment|/* bad-field-in-cdb */
id|ata_bad_cdb
c_func
(paren
id|cmd
comma
id|done
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNCHRONIZE_CACHE
suffix:colon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|ATA_DFLAG_WCACHE
)paren
op_eq
l_int|0
)paren
id|ata_bad_scsiop
c_func
(paren
id|cmd
comma
id|done
)paren
suffix:semicolon
r_else
id|ata_scsi_rbuf_fill
c_func
(paren
op_amp
id|args
comma
id|ata_scsiop_sync_cache
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
id|ata_scsi_rbuf_fill
c_func
(paren
op_amp
id|args
comma
id|ata_scsiop_read_cap
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SERVICE_ACTION_IN
suffix:colon
r_if
c_cond
(paren
(paren
id|scsicmd
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
op_eq
id|SAI_READ_CAPACITY_16
)paren
id|ata_scsi_rbuf_fill
c_func
(paren
op_amp
id|args
comma
id|ata_scsiop_read_cap
)paren
suffix:semicolon
r_else
id|ata_bad_cdb
c_func
(paren
id|cmd
comma
id|done
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REPORT_LUNS
suffix:colon
id|ata_scsi_rbuf_fill
c_func
(paren
op_amp
id|args
comma
id|ata_scsiop_report_luns
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* mandantory commands we haven&squot;t implemented yet */
r_case
id|REQUEST_SENSE
suffix:colon
multiline_comment|/* all other commands */
r_default
suffix:colon
id|ata_bad_scsiop
c_func
(paren
id|cmd
comma
id|done
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out_unlock
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|ap-&gt;host_set-&gt;lock
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_lock
c_func
(paren
id|cmd-&gt;device-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
