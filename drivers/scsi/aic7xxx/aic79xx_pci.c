multiline_comment|/*&n; * Product specific probe and attach routines for:&n; *&t;aic7901 and aic7902 SCSI controllers&n; *&n; * Copyright (c) 1994-2001 Justin T. Gibbs.&n; * Copyright (c) 2000-2002 Adaptec Inc.&n; * All rights reserved.&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions, and the following disclaimer,&n; *    without modification.&n; * 2. Redistributions in binary form must reproduce at minimum a disclaimer&n; *    substantially similar to the &quot;NO WARRANTY&quot; disclaimer below&n; *    (&quot;Disclaimer&quot;) and any redistribution must be conditioned upon&n; *    including a substantially similar Disclaimer requirement for further&n; *    binary redistribution.&n; * 3. Neither the names of the above-listed copyright holders nor the names&n; *    of any contributors may be used to endorse or promote products derived&n; *    from this software without specific prior written permission.&n; *&n; * Alternatively, this software may be distributed under the terms of the&n; * GNU General Public License (&quot;GPL&quot;) version 2 as published by the Free&n; * Software Foundation.&n; *&n; * NO WARRANTY&n; * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS&n; * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT&n; * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR&n; * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT&n; * HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,&n; * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING&n; * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE&n; * POSSIBILITY OF SUCH DAMAGES.&n; *&n; * $Id: //depot/aic7xxx/aic7xxx/aic79xx_pci.c#67 $&n; *&n; * $FreeBSD$&n; */
macro_line|#ifdef __linux__
macro_line|#include &quot;aic79xx_osm.h&quot;
macro_line|#include &quot;aic79xx_inline.h&quot;
macro_line|#else
macro_line|#include &lt;dev/aic7xxx/aic79xx_osm.h&gt;
macro_line|#include &lt;dev/aic7xxx/aic79xx_inline.h&gt;
macro_line|#endif
r_static
id|__inline
r_uint64
DECL|function|ahd_compose_id
id|ahd_compose_id
c_func
(paren
id|u_int
id|device
comma
id|u_int
id|vendor
comma
id|u_int
id|subdevice
comma
id|u_int
id|subvendor
)paren
(brace
r_uint64
id|id
suffix:semicolon
id|id
op_assign
id|subvendor
op_or
(paren
id|subdevice
op_lshift
l_int|16
)paren
op_or
(paren
(paren
r_uint64
)paren
id|vendor
op_lshift
l_int|32
)paren
op_or
(paren
(paren
r_uint64
)paren
id|device
op_lshift
l_int|48
)paren
suffix:semicolon
r_return
(paren
id|id
)paren
suffix:semicolon
)brace
DECL|macro|ID_ALL_MASK
mdefine_line|#define ID_ALL_MASK&t;&t;&t;0xFFFFFFFFFFFFFFFFull
DECL|macro|ID_DEV_VENDOR_MASK
mdefine_line|#define ID_DEV_VENDOR_MASK&t;&t;0xFFFFFFFF00000000ull
DECL|macro|ID_9005_GENERIC_MASK
mdefine_line|#define ID_9005_GENERIC_MASK&t;&t;0xFFF0FFFF00000000ull
DECL|macro|ID_AIC7901
mdefine_line|#define ID_AIC7901&t;&t;&t;0x800F9005FFFF9005ull
DECL|macro|ID_AIC7901A
mdefine_line|#define ID_AIC7901A&t;&t;&t;0x801E9005FFFF9005ull
DECL|macro|ID_AIC7901A_IROC
mdefine_line|#define ID_AIC7901A_IROC&t;&t;0x809E9005FFFF9005ull
DECL|macro|ID_AHA_29320A
mdefine_line|#define ID_AHA_29320A&t;&t;&t;0x8000900500609005ull
DECL|macro|ID_AHA_29320LP
mdefine_line|#define ID_AHA_29320LP&t;&t;&t;0x8014900500449005ull
DECL|macro|ID_AHA_29320LP_IROC
mdefine_line|#define ID_AHA_29320LP_IROC&t;&t;0x8094900500449005ull
DECL|macro|ID_AIC7902
mdefine_line|#define ID_AIC7902&t;&t;&t;0x801F9005FFFF9005ull
DECL|macro|ID_AIC7902_IROC
mdefine_line|#define ID_AIC7902_IROC&t;&t;&t;0x809F9005FFFF9005ull
DECL|macro|ID_AIC7902_B
mdefine_line|#define ID_AIC7902_B&t;&t;&t;0x801D9005FFFF9005ull
DECL|macro|ID_AIC7902_B_IROC
mdefine_line|#define ID_AIC7902_B_IROC&t;&t;0x809D9005FFFF9005ull
DECL|macro|ID_AHA_39320
mdefine_line|#define ID_AHA_39320&t;&t;&t;0x8010900500409005ull
DECL|macro|ID_AHA_39320A
mdefine_line|#define ID_AHA_39320A&t;&t;&t;0x8016900500409005ull
DECL|macro|ID_AHA_39320D
mdefine_line|#define ID_AHA_39320D&t;&t;&t;0x8011900500419005ull
DECL|macro|ID_AHA_39320D_B
mdefine_line|#define ID_AHA_39320D_B&t;&t;&t;0x801C900500419005ull
DECL|macro|ID_AHA_39320D_HP
mdefine_line|#define ID_AHA_39320D_HP&t;&t;0x8011900500AC0E11ull
DECL|macro|ID_AHA_39320D_B_HP
mdefine_line|#define ID_AHA_39320D_B_HP&t;&t;0x801C900500AC0E11ull
DECL|macro|ID_AHA_29320
mdefine_line|#define ID_AHA_29320&t;&t;&t;0x8012900500429005ull
DECL|macro|ID_AHA_29320B
mdefine_line|#define ID_AHA_29320B&t;&t;&t;0x8013900500439005ull
DECL|macro|ID_AIC7902_PCI_REV_A4
mdefine_line|#define ID_AIC7902_PCI_REV_A4&t;&t;0x3
DECL|macro|ID_AIC7902_PCI_REV_B0
mdefine_line|#define ID_AIC7902_PCI_REV_B0&t;&t;0x10
DECL|macro|SUBID_HP
mdefine_line|#define SUBID_HP&t;&t;&t;0x0E11
DECL|macro|DEVID_9005_TYPE
mdefine_line|#define DEVID_9005_TYPE(id) ((id) &amp; 0xF)
DECL|macro|DEVID_9005_TYPE_HBA
mdefine_line|#define&t;&t;DEVID_9005_TYPE_HBA&t;&t;0x0&t;/* Standard Card */
DECL|macro|DEVID_9005_TYPE_HBA_2EXT
mdefine_line|#define&t;&t;DEVID_9005_TYPE_HBA_2EXT&t;0x1&t;/* 2 External Ports */
DECL|macro|DEVID_9005_TYPE_IROC
mdefine_line|#define&t;&t;DEVID_9005_TYPE_IROC&t;&t;0x8&t;/* Raid(0,1,10) Card */
DECL|macro|DEVID_9005_TYPE_MB
mdefine_line|#define&t;&t;DEVID_9005_TYPE_MB&t;&t;0xF&t;/* On Motherboard */
DECL|macro|DEVID_9005_MFUNC
mdefine_line|#define DEVID_9005_MFUNC(id) ((id) &amp; 0x10)
DECL|macro|DEVID_9005_PACKETIZED
mdefine_line|#define DEVID_9005_PACKETIZED(id) ((id) &amp; 0x8000)
DECL|macro|SUBID_9005_TYPE
mdefine_line|#define SUBID_9005_TYPE(id) ((id) &amp; 0xF)
DECL|macro|SUBID_9005_TYPE_HBA
mdefine_line|#define&t;&t;SUBID_9005_TYPE_HBA&t;&t;0x0&t;/* Standard Card */
DECL|macro|SUBID_9005_TYPE_MB
mdefine_line|#define&t;&t;SUBID_9005_TYPE_MB&t;&t;0xF&t;/* On Motherboard */
DECL|macro|SUBID_9005_AUTOTERM
mdefine_line|#define SUBID_9005_AUTOTERM(id)&t;(((id) &amp; 0x10) == 0)
DECL|macro|SUBID_9005_LEGACYCONN_FUNC
mdefine_line|#define SUBID_9005_LEGACYCONN_FUNC(id) ((id) &amp; 0x20)
DECL|macro|SUBID_9005_SEEPTYPE
mdefine_line|#define SUBID_9005_SEEPTYPE(id) ((id) &amp; 0x0C0) &gt;&gt; 6)
DECL|macro|SUBID_9005_SEEPTYPE_NONE
mdefine_line|#define&t;&t;SUBID_9005_SEEPTYPE_NONE&t;0x0
DECL|macro|SUBID_9005_SEEPTYPE_4K
mdefine_line|#define&t;&t;SUBID_9005_SEEPTYPE_4K&t;&t;0x1
DECL|variable|ahd_aic7901A_setup
r_static
id|ahd_device_setup_t
id|ahd_aic7901A_setup
suffix:semicolon
DECL|variable|ahd_aic7902_setup
r_static
id|ahd_device_setup_t
id|ahd_aic7902_setup
suffix:semicolon
DECL|variable|ahd_pci_ident_table
r_struct
id|ahd_pci_identity
id|ahd_pci_ident_table
(braket
)braket
op_assign
(brace
multiline_comment|/* aic7901A based controllers */
(brace
id|ID_AHA_29320LP
comma
id|ID_ALL_MASK
comma
l_string|&quot;Adaptec 29320LP Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7901A_setup
)brace
comma
(brace
id|ID_AHA_29320A
comma
id|ID_ALL_MASK
comma
l_string|&quot;Adaptec 29320A Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7901A_setup
)brace
comma
multiline_comment|/* aic7902 based controllers */
(brace
id|ID_AHA_39320
comma
id|ID_ALL_MASK
comma
l_string|&quot;Adaptec 39320 Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7902_setup
)brace
comma
(brace
id|ID_AHA_39320A
comma
id|ID_ALL_MASK
comma
l_string|&quot;Adaptec 39320A Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7902_setup
)brace
comma
(brace
id|ID_AHA_39320D
comma
id|ID_ALL_MASK
comma
l_string|&quot;Adaptec 39320D Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7902_setup
)brace
comma
(brace
id|ID_AHA_39320D_HP
comma
id|ID_ALL_MASK
comma
l_string|&quot;Adaptec (HP OEM) 39320D Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7902_setup
)brace
comma
(brace
id|ID_AHA_39320D_B
comma
id|ID_ALL_MASK
comma
l_string|&quot;Adaptec 39320D Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7902_setup
)brace
comma
(brace
id|ID_AHA_39320D_B_HP
comma
id|ID_ALL_MASK
comma
l_string|&quot;Adaptec (HP OEM) 39320D Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7902_setup
)brace
comma
(brace
id|ID_AHA_29320
comma
id|ID_ALL_MASK
comma
l_string|&quot;Adaptec 29320 Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7902_setup
)brace
comma
(brace
id|ID_AHA_29320B
comma
id|ID_ALL_MASK
comma
l_string|&quot;Adaptec 29320B Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7902_setup
)brace
comma
multiline_comment|/* Generic chip probes for devices we don&squot;t know &squot;exactly&squot; */
(brace
id|ID_AIC7901A
op_amp
id|ID_DEV_VENDOR_MASK
comma
id|ID_DEV_VENDOR_MASK
comma
l_string|&quot;Adaptec AIC7901A Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7901A_setup
)brace
comma
(brace
id|ID_AIC7902
op_amp
id|ID_9005_GENERIC_MASK
comma
id|ID_9005_GENERIC_MASK
comma
l_string|&quot;Adaptec AIC7902 Ultra320 SCSI adapter&quot;
comma
id|ahd_aic7902_setup
)brace
)brace
suffix:semicolon
DECL|variable|ahd_num_pci_devs
r_const
id|u_int
id|ahd_num_pci_devs
op_assign
id|NUM_ELEMENTS
c_func
(paren
id|ahd_pci_ident_table
)paren
suffix:semicolon
DECL|macro|DEVCONFIG
mdefine_line|#define&t;DEVCONFIG&t;&t;0x40
DECL|macro|PCIXINITPAT
mdefine_line|#define&t;&t;PCIXINITPAT&t;0x0000E000ul
DECL|macro|PCIXINIT_PCI33_66
mdefine_line|#define&t;&t;&t;PCIXINIT_PCI33_66&t;0x0000E000ul
DECL|macro|PCIXINIT_PCIX50_66
mdefine_line|#define&t;&t;&t;PCIXINIT_PCIX50_66&t;0x0000C000ul
DECL|macro|PCIXINIT_PCIX66_100
mdefine_line|#define&t;&t;&t;PCIXINIT_PCIX66_100&t;0x0000A000ul
DECL|macro|PCIXINIT_PCIX100_133
mdefine_line|#define&t;&t;&t;PCIXINIT_PCIX100_133&t;0x00008000ul
DECL|macro|PCI_BUS_MODES_INDEX
mdefine_line|#define&t;PCI_BUS_MODES_INDEX(devconfig)&t;&bslash;&n;&t;(((devconfig) &amp; PCIXINITPAT) &gt;&gt; 13)
DECL|variable|pci_bus_modes
r_static
r_const
r_char
op_star
id|pci_bus_modes
(braket
)braket
op_assign
(brace
l_string|&quot;PCI bus mode unknown&quot;
comma
l_string|&quot;PCI bus mode unknown&quot;
comma
l_string|&quot;PCI bus mode unknown&quot;
comma
l_string|&quot;PCI bus mode unknown&quot;
comma
l_string|&quot;PCI-X 101-133Mhz&quot;
comma
l_string|&quot;PCI-X 67-100Mhz&quot;
comma
l_string|&quot;PCI-X 50-66Mhz&quot;
comma
l_string|&quot;PCI 33 or 66Mhz&quot;
)brace
suffix:semicolon
DECL|macro|TESTMODE
mdefine_line|#define&t;&t;TESTMODE&t;0x00000800ul
DECL|macro|IRDY_RST
mdefine_line|#define&t;&t;IRDY_RST&t;0x00000200ul
DECL|macro|FRAME_RST
mdefine_line|#define&t;&t;FRAME_RST&t;0x00000100ul
DECL|macro|PCI64BIT
mdefine_line|#define&t;&t;PCI64BIT&t;0x00000080ul
DECL|macro|MRDCEN
mdefine_line|#define&t;&t;MRDCEN&t;&t;0x00000040ul
DECL|macro|ENDIANSEL
mdefine_line|#define&t;&t;ENDIANSEL&t;0x00000020ul
DECL|macro|MIXQWENDIANEN
mdefine_line|#define&t;&t;MIXQWENDIANEN&t;0x00000008ul
DECL|macro|DACEN
mdefine_line|#define&t;&t;DACEN&t;&t;0x00000004ul
DECL|macro|STPWLEVEL
mdefine_line|#define&t;&t;STPWLEVEL&t;0x00000002ul
DECL|macro|QWENDIANSEL
mdefine_line|#define&t;&t;QWENDIANSEL&t;0x00000001ul
DECL|macro|DEVCONFIG1
mdefine_line|#define&t;DEVCONFIG1&t;&t;0x44
DECL|macro|PREQDIS
mdefine_line|#define&t;&t;PREQDIS&t;&t;0x01
DECL|macro|CSIZE_LATTIME
mdefine_line|#define&t;CSIZE_LATTIME&t;&t;0x0c
DECL|macro|CACHESIZE
mdefine_line|#define&t;&t;CACHESIZE&t;0x000000fful
DECL|macro|LATTIME
mdefine_line|#define&t;&t;LATTIME&t;&t;0x0000ff00ul
r_static
r_int
id|ahd_check_extport
c_func
(paren
r_struct
id|ahd_softc
op_star
id|ahd
)paren
suffix:semicolon
r_static
r_void
id|ahd_configure_termination
c_func
(paren
r_struct
id|ahd_softc
op_star
id|ahd
comma
id|u_int
id|adapter_control
)paren
suffix:semicolon
r_static
r_void
id|ahd_pci_split_intr
c_func
(paren
r_struct
id|ahd_softc
op_star
id|ahd
comma
id|u_int
id|intstat
)paren
suffix:semicolon
r_struct
id|ahd_pci_identity
op_star
DECL|function|ahd_find_pci_device
id|ahd_find_pci_device
c_func
(paren
id|ahd_dev_softc_t
id|pci
)paren
(brace
r_uint64
id|full_id
suffix:semicolon
r_uint16
id|device
suffix:semicolon
r_uint16
id|vendor
suffix:semicolon
r_uint16
id|subdevice
suffix:semicolon
r_uint16
id|subvendor
suffix:semicolon
r_struct
id|ahd_pci_identity
op_star
id|entry
suffix:semicolon
id|u_int
id|i
suffix:semicolon
id|vendor
op_assign
id|ahd_pci_read_config
c_func
(paren
id|pci
comma
id|PCIR_DEVVENDOR
comma
multiline_comment|/*bytes*/
l_int|2
)paren
suffix:semicolon
id|device
op_assign
id|ahd_pci_read_config
c_func
(paren
id|pci
comma
id|PCIR_DEVICE
comma
multiline_comment|/*bytes*/
l_int|2
)paren
suffix:semicolon
id|subvendor
op_assign
id|ahd_pci_read_config
c_func
(paren
id|pci
comma
id|PCIR_SUBVEND_0
comma
multiline_comment|/*bytes*/
l_int|2
)paren
suffix:semicolon
id|subdevice
op_assign
id|ahd_pci_read_config
c_func
(paren
id|pci
comma
id|PCIR_SUBDEV_0
comma
multiline_comment|/*bytes*/
l_int|2
)paren
suffix:semicolon
id|full_id
op_assign
id|ahd_compose_id
c_func
(paren
id|device
comma
id|vendor
comma
id|subdevice
comma
id|subvendor
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ahd_num_pci_devs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|entry
op_assign
op_amp
id|ahd_pci_ident_table
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;full_id
op_eq
(paren
id|full_id
op_amp
id|entry-&gt;id_mask
)paren
)paren
(brace
multiline_comment|/* Honor exclusion entries. */
r_if
c_cond
(paren
id|entry-&gt;name
op_eq
l_int|NULL
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
r_return
(paren
id|entry
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_int
DECL|function|ahd_pci_config
id|ahd_pci_config
c_func
(paren
r_struct
id|ahd_softc
op_star
id|ahd
comma
r_struct
id|ahd_pci_identity
op_star
id|entry
)paren
(brace
r_struct
id|scb_data
op_star
id|shared_scb_data
suffix:semicolon
id|u_long
id|l
suffix:semicolon
id|u_int
id|command
suffix:semicolon
r_uint32
id|devconfig
suffix:semicolon
r_uint16
id|subvendor
suffix:semicolon
r_int
id|error
suffix:semicolon
id|shared_scb_data
op_assign
l_int|NULL
suffix:semicolon
id|ahd-&gt;description
op_assign
id|entry-&gt;name
suffix:semicolon
multiline_comment|/*&n;&t; * Record if this is an HP board.&n;&t; */
id|subvendor
op_assign
id|ahd_pci_read_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIR_SUBVEND_0
comma
multiline_comment|/*bytes*/
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|subvendor
op_eq
id|SUBID_HP
)paren
id|ahd-&gt;flags
op_or_assign
id|AHD_HP_BOARD
suffix:semicolon
id|error
op_assign
id|entry
op_member_access_from_pointer
id|setup
c_func
(paren
id|ahd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
r_return
(paren
id|error
)paren
suffix:semicolon
id|devconfig
op_assign
id|ahd_pci_read_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|DEVCONFIG
comma
multiline_comment|/*bytes*/
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|devconfig
op_amp
id|PCIXINITPAT
)paren
op_eq
id|PCIXINIT_PCI33_66
)paren
(brace
id|ahd-&gt;chip
op_or_assign
id|AHD_PCI
suffix:semicolon
multiline_comment|/* Disable PCIX workarounds when running in PCI mode. */
id|ahd-&gt;bugs
op_and_assign
op_complement
id|AHD_PCIX_BUG_MASK
suffix:semicolon
)brace
r_else
(brace
id|ahd-&gt;chip
op_or_assign
id|AHD_PCIX
suffix:semicolon
)brace
id|ahd-&gt;bus_description
op_assign
id|pci_bus_modes
(braket
id|PCI_BUS_MODES_INDEX
c_func
(paren
id|devconfig
)paren
)braket
suffix:semicolon
id|ahd_power_state_change
c_func
(paren
id|ahd
comma
id|AHD_POWER_STATE_D0
)paren
suffix:semicolon
id|error
op_assign
id|ahd_pci_map_registers
c_func
(paren
id|ahd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
r_return
(paren
id|error
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we need to support high memory, enable dual&n;&t; * address cycles.  This bit must be set to enable&n;&t; * high address bit generation even if we are on a&n;&t; * 64bit bus (PCI64BIT set in devconfig).&n;&t; */
r_if
c_cond
(paren
(paren
id|ahd-&gt;flags
op_amp
(paren
id|AHD_39BIT_ADDRESSING
op_or
id|AHD_64BIT_ADDRESSING
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_uint32
id|devconfig
suffix:semicolon
r_if
c_cond
(paren
id|bootverbose
)paren
id|printf
c_func
(paren
l_string|&quot;%s: Enabling 39Bit Addressing&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
)paren
suffix:semicolon
id|devconfig
op_assign
id|ahd_pci_read_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|DEVCONFIG
comma
multiline_comment|/*bytes*/
l_int|4
)paren
suffix:semicolon
id|devconfig
op_or_assign
id|DACEN
suffix:semicolon
id|ahd_pci_write_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|DEVCONFIG
comma
id|devconfig
comma
multiline_comment|/*bytes*/
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* Ensure busmastering is enabled */
id|command
op_assign
id|ahd_pci_read_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIR_COMMAND
comma
multiline_comment|/*bytes*/
l_int|1
)paren
suffix:semicolon
id|command
op_or_assign
id|PCIM_CMD_BUSMASTEREN
suffix:semicolon
id|ahd_pci_write_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIR_COMMAND
comma
id|command
comma
multiline_comment|/*bytes*/
l_int|1
)paren
suffix:semicolon
id|error
op_assign
id|ahd_softc_init
c_func
(paren
id|ahd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
r_return
(paren
id|error
)paren
suffix:semicolon
id|ahd-&gt;bus_intr
op_assign
id|ahd_pci_intr
suffix:semicolon
id|error
op_assign
id|ahd_reset
c_func
(paren
id|ahd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
r_return
(paren
id|ENXIO
)paren
suffix:semicolon
id|ahd-&gt;pci_cachesize
op_assign
id|ahd_pci_read_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|CSIZE_LATTIME
comma
multiline_comment|/*bytes*/
l_int|1
)paren
op_amp
id|CACHESIZE
suffix:semicolon
id|ahd-&gt;pci_cachesize
op_mul_assign
l_int|4
suffix:semicolon
id|ahd_set_modes
c_func
(paren
id|ahd
comma
id|AHD_MODE_SCSI
comma
id|AHD_MODE_SCSI
)paren
suffix:semicolon
multiline_comment|/* See if we have a SEEPROM and perform auto-term */
id|error
op_assign
id|ahd_check_extport
c_func
(paren
id|ahd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
r_return
(paren
id|error
)paren
suffix:semicolon
multiline_comment|/* Core initialization */
id|error
op_assign
id|ahd_init
c_func
(paren
id|ahd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
r_return
(paren
id|error
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allow interrupts now that we are completely setup.&n;&t; */
id|error
op_assign
id|ahd_pci_map_int
c_func
(paren
id|ahd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
r_return
(paren
id|error
)paren
suffix:semicolon
id|ahd_list_lock
c_func
(paren
op_amp
id|l
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Link this softc in with all other ahd instances.&n;&t; */
id|ahd_softc_insert
c_func
(paren
id|ahd
)paren
suffix:semicolon
id|ahd_list_unlock
c_func
(paren
op_amp
id|l
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform some simple tests that should catch situations where&n; * our registers are invalidly mapped.&n; */
r_int
DECL|function|ahd_pci_test_register_access
id|ahd_pci_test_register_access
c_func
(paren
r_struct
id|ahd_softc
op_star
id|ahd
)paren
(brace
r_uint32
id|cmd
suffix:semicolon
r_int
id|error
suffix:semicolon
r_uint8
id|hcntrl
suffix:semicolon
id|error
op_assign
id|EIO
suffix:semicolon
multiline_comment|/*&n;&t; * Enable PCI error interrupt status, but suppress NMIs&n;&t; * generated by SERR raised due to target aborts.&n;&t; */
id|cmd
op_assign
id|ahd_pci_read_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIR_COMMAND
comma
multiline_comment|/*bytes*/
l_int|2
)paren
suffix:semicolon
id|ahd_pci_write_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIR_COMMAND
comma
id|cmd
op_amp
op_complement
id|PCIM_CMD_SERRESPEN
comma
multiline_comment|/*bytes*/
l_int|2
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * First a simple test to see if any&n;&t; * registers can be read.  Reading&n;&t; * HCNTRL has no side effects and has&n;&t; * at least one bit that is guaranteed to&n;&t; * be zero so it is a good register to&n;&t; * use for this test.&n;&t; */
id|hcntrl
op_assign
id|ahd_inb
c_func
(paren
id|ahd
comma
id|HCNTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hcntrl
op_eq
l_int|0xFF
)paren
r_goto
id|fail
suffix:semicolon
multiline_comment|/*&n;&t; * Next create a situation where write combining&n;&t; * or read prefetching could be initiated by the&n;&t; * CPU or host bridge.  Our device does not support&n;&t; * either, so look for data corruption and/or flaged&n;&t; * PCI errors.&n;&t; */
id|ahd_outb
c_func
(paren
id|ahd
comma
id|HCNTRL
comma
id|hcntrl
op_or
id|PAUSE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ahd_is_paused
c_func
(paren
id|ahd
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|ahd_outb
c_func
(paren
id|ahd
comma
id|SEQCTL0
comma
id|PERRORDIS
)paren
suffix:semicolon
id|ahd_outl
c_func
(paren
id|ahd
comma
id|SRAM_BASE
comma
l_int|0x5aa555aa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ahd_inl
c_func
(paren
id|ahd
comma
id|SRAM_BASE
)paren
op_ne
l_int|0x5aa555aa
)paren
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ahd_inb
c_func
(paren
id|ahd
comma
id|INTSTAT
)paren
op_amp
id|PCIINT
)paren
op_ne
l_int|0
)paren
(brace
id|u_int
id|targpcistat
suffix:semicolon
id|ahd_set_modes
c_func
(paren
id|ahd
comma
id|AHD_MODE_CFG
comma
id|AHD_MODE_CFG
)paren
suffix:semicolon
id|targpcistat
op_assign
id|ahd_inb
c_func
(paren
id|ahd
comma
id|TARGPCISTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|targpcistat
op_amp
id|STA
)paren
op_ne
l_int|0
)paren
r_goto
id|fail
suffix:semicolon
)brace
id|error
op_assign
l_int|0
suffix:semicolon
id|fail
suffix:colon
r_if
c_cond
(paren
(paren
id|ahd_inb
c_func
(paren
id|ahd
comma
id|INTSTAT
)paren
op_amp
id|PCIINT
)paren
op_ne
l_int|0
)paren
(brace
id|u_int
id|targpcistat
suffix:semicolon
id|u_int
id|pci_status1
suffix:semicolon
id|ahd_set_modes
c_func
(paren
id|ahd
comma
id|AHD_MODE_CFG
comma
id|AHD_MODE_CFG
)paren
suffix:semicolon
id|targpcistat
op_assign
id|ahd_inb
c_func
(paren
id|ahd
comma
id|TARGPCISTAT
)paren
suffix:semicolon
multiline_comment|/* Silently clear any latched errors. */
id|ahd_outb
c_func
(paren
id|ahd
comma
id|TARGPCISTAT
comma
id|targpcistat
)paren
suffix:semicolon
id|pci_status1
op_assign
id|ahd_pci_read_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIR_STATUS
op_plus
l_int|1
comma
multiline_comment|/*bytes*/
l_int|1
)paren
suffix:semicolon
id|ahd_pci_write_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIR_STATUS
op_plus
l_int|1
comma
id|pci_status1
comma
multiline_comment|/*bytes*/
l_int|1
)paren
suffix:semicolon
id|ahd_outb
c_func
(paren
id|ahd
comma
id|CLRINT
comma
id|CLRPCIINT
)paren
suffix:semicolon
)brace
id|ahd_outb
c_func
(paren
id|ahd
comma
id|SEQCTL0
comma
id|PERRORDIS
op_or
id|FAILDIS
)paren
suffix:semicolon
id|ahd_pci_write_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIR_COMMAND
comma
id|cmd
comma
multiline_comment|/*bytes*/
l_int|2
)paren
suffix:semicolon
r_return
(paren
id|error
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Check the external port logic for a serial eeprom&n; * and termination/cable detection contrls.&n; */
r_static
r_int
DECL|function|ahd_check_extport
id|ahd_check_extport
c_func
(paren
r_struct
id|ahd_softc
op_star
id|ahd
)paren
(brace
r_struct
id|seeprom_config
op_star
id|sc
suffix:semicolon
id|u_int
id|adapter_control
suffix:semicolon
r_int
id|have_seeprom
suffix:semicolon
r_int
id|error
suffix:semicolon
id|sc
op_assign
id|ahd-&gt;seep_config
suffix:semicolon
id|have_seeprom
op_assign
id|ahd_acquire_seeprom
c_func
(paren
id|ahd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|have_seeprom
)paren
(brace
id|u_int
id|start_addr
suffix:semicolon
r_if
c_cond
(paren
id|bootverbose
)paren
id|printf
c_func
(paren
l_string|&quot;%s: Reading SEEPROM...&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
)paren
suffix:semicolon
multiline_comment|/* Address is always in units of 16bit words */
id|start_addr
op_assign
(paren
r_sizeof
(paren
op_star
id|sc
)paren
op_div
l_int|2
)paren
op_star
(paren
id|ahd-&gt;channel
op_minus
l_char|&squot;A&squot;
)paren
suffix:semicolon
id|error
op_assign
id|ahd_read_seeprom
c_func
(paren
id|ahd
comma
(paren
r_uint16
op_star
)paren
id|sc
comma
id|start_addr
comma
r_sizeof
(paren
op_star
id|sc
)paren
op_div
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;Unable to read SEEPROM&bslash;n&quot;
)paren
suffix:semicolon
id|have_seeprom
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|have_seeprom
op_assign
id|ahd_verify_cksum
c_func
(paren
id|sc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bootverbose
)paren
(brace
r_if
c_cond
(paren
id|have_seeprom
op_eq
l_int|0
)paren
id|printf
(paren
l_string|&quot;checksum error&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printf
(paren
l_string|&quot;done.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|ahd_release_seeprom
c_func
(paren
id|ahd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|have_seeprom
)paren
(brace
id|u_int
id|nvram_scb
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Pull scratch ram settings and treat them as&n;&t;&t; * if they are the contents of an seeprom if&n;&t;&t; * the &squot;ADPT&squot;, &squot;BIOS&squot;, or &squot;ASPI&squot; signature is found&n;&t;&t; * in SCB 0xFF.  We manually compose the data as 16bit&n;&t;&t; * values to avoid endian issues.&n;&t;&t; */
id|ahd_set_scbptr
c_func
(paren
id|ahd
comma
l_int|0xFF
)paren
suffix:semicolon
id|nvram_scb
op_assign
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
id|NVRAM_SCB_OFFSET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nvram_scb
op_ne
l_int|0xFF
op_logical_and
(paren
(paren
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|0
)paren
op_eq
l_char|&squot;A&squot;
op_logical_and
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|1
)paren
op_eq
l_char|&squot;D&squot;
op_logical_and
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|2
)paren
op_eq
l_char|&squot;P&squot;
op_logical_and
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|3
)paren
op_eq
l_char|&squot;T&squot;
)paren
op_logical_or
(paren
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|0
)paren
op_eq
l_char|&squot;B&squot;
op_logical_and
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|1
)paren
op_eq
l_char|&squot;I&squot;
op_logical_and
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|2
)paren
op_eq
l_char|&squot;O&squot;
op_logical_and
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|3
)paren
op_eq
l_char|&squot;S&squot;
)paren
op_logical_or
(paren
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|0
)paren
op_eq
l_char|&squot;A&squot;
op_logical_and
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|1
)paren
op_eq
l_char|&squot;S&squot;
op_logical_and
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|2
)paren
op_eq
l_char|&squot;P&squot;
op_logical_and
id|ahd_inb_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
l_int|3
)paren
op_eq
l_char|&squot;I&squot;
)paren
)paren
)paren
(brace
r_uint16
op_star
id|sc_data
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ahd_set_scbptr
c_func
(paren
id|ahd
comma
id|nvram_scb
)paren
suffix:semicolon
id|sc_data
op_assign
(paren
r_uint16
op_star
)paren
id|sc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
op_star
id|sc_data
op_increment
op_assign
id|ahd_inw_scbram
c_func
(paren
id|ahd
comma
id|SCB_BASE
op_plus
id|i
)paren
suffix:semicolon
id|have_seeprom
op_assign
id|ahd_verify_cksum
c_func
(paren
id|sc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|have_seeprom
)paren
id|ahd-&gt;flags
op_or_assign
id|AHD_SCB_CONFIG_USED
suffix:semicolon
)brace
)brace
macro_line|#if AHD_DEBUG
r_if
c_cond
(paren
id|have_seeprom
op_ne
l_int|0
op_logical_and
(paren
id|ahd_debug
op_amp
id|AHD_DUMP_SEEPROM
)paren
op_ne
l_int|0
)paren
(brace
r_uint8
op_star
id|sc_data
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;%s: Seeprom Contents:&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
)paren
suffix:semicolon
id|sc_data
op_assign
(paren
r_uint8
op_star
)paren
id|sc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
op_star
id|sc
)paren
)paren
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
id|printf
c_func
(paren
l_string|&quot;&bslash;n&bslash;t0x%.4x&quot;
comma
id|sc_data
(braket
id|i
)braket
op_or
(paren
id|sc_data
(braket
id|i
op_plus
l_int|1
)braket
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|have_seeprom
)paren
(brace
r_if
c_cond
(paren
id|bootverbose
)paren
id|printf
c_func
(paren
l_string|&quot;%s: No SEEPROM available.&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
)paren
suffix:semicolon
id|ahd-&gt;flags
op_or_assign
id|AHD_USEDEFAULTS
suffix:semicolon
id|error
op_assign
id|ahd_default_config
c_func
(paren
id|ahd
)paren
suffix:semicolon
id|adapter_control
op_assign
id|CFAUTOTERM
op_or
id|CFSEAUTOTERM
suffix:semicolon
id|free
c_func
(paren
id|ahd-&gt;seep_config
comma
id|M_DEVBUF
)paren
suffix:semicolon
id|ahd-&gt;seep_config
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|error
op_assign
id|ahd_parse_cfgdata
c_func
(paren
id|ahd
comma
id|sc
)paren
suffix:semicolon
id|adapter_control
op_assign
id|sc-&gt;adapter_control
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
r_return
(paren
id|error
)paren
suffix:semicolon
id|ahd_configure_termination
c_func
(paren
id|ahd
comma
id|adapter_control
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ahd_configure_termination
id|ahd_configure_termination
c_func
(paren
r_struct
id|ahd_softc
op_star
id|ahd
comma
id|u_int
id|adapter_control
)paren
(brace
r_int
id|error
suffix:semicolon
id|u_int
id|sxfrctl1
suffix:semicolon
r_uint8
id|termctl
suffix:semicolon
r_uint32
id|devconfig
suffix:semicolon
id|devconfig
op_assign
id|ahd_pci_read_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|DEVCONFIG
comma
multiline_comment|/*bytes*/
l_int|4
)paren
suffix:semicolon
id|devconfig
op_and_assign
op_complement
id|STPWLEVEL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ahd-&gt;flags
op_amp
id|AHD_STPWLEVEL_A
)paren
op_ne
l_int|0
)paren
id|devconfig
op_or_assign
id|STPWLEVEL
suffix:semicolon
r_if
c_cond
(paren
id|bootverbose
)paren
id|printf
c_func
(paren
l_string|&quot;%s: STPWLEVEL is %s&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
comma
(paren
id|devconfig
op_amp
id|STPWLEVEL
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|ahd_pci_write_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|DEVCONFIG
comma
id|devconfig
comma
multiline_comment|/*bytes*/
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Make sure current sensing is off. */
r_if
c_cond
(paren
(paren
id|ahd-&gt;flags
op_amp
id|AHD_CURRENT_SENSING
)paren
op_ne
l_int|0
)paren
(brace
(paren
r_void
)paren
id|ahd_write_flexport
c_func
(paren
id|ahd
comma
id|FLXADDR_ROMSTAT_CURSENSECTL
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Read to sense.  Write to set.&n;&t; */
id|error
op_assign
id|ahd_read_flexport
c_func
(paren
id|ahd
comma
id|FLXADDR_TERMCTL
comma
op_amp
id|termctl
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|adapter_control
op_amp
id|CFAUTOTERM
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|bootverbose
)paren
id|printf
c_func
(paren
l_string|&quot;%s: Manual Primary Termination&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
)paren
suffix:semicolon
id|termctl
op_and_assign
op_complement
(paren
id|FLX_TERMCTL_ENPRILOW
op_or
id|FLX_TERMCTL_ENPRIHIGH
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|adapter_control
op_amp
id|CFSTERM
)paren
op_ne
l_int|0
)paren
id|termctl
op_or_assign
id|FLX_TERMCTL_ENPRILOW
suffix:semicolon
r_if
c_cond
(paren
(paren
id|adapter_control
op_amp
id|CFWSTERM
)paren
op_ne
l_int|0
)paren
id|termctl
op_or_assign
id|FLX_TERMCTL_ENPRIHIGH
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;%s: Primary Auto-Term Sensing failed! &quot;
l_string|&quot;Using Defaults.&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
)paren
suffix:semicolon
id|termctl
op_assign
id|FLX_TERMCTL_ENPRILOW
op_or
id|FLX_TERMCTL_ENPRIHIGH
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|adapter_control
op_amp
id|CFSEAUTOTERM
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|bootverbose
)paren
id|printf
c_func
(paren
l_string|&quot;%s: Manual Secondary Termination&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
)paren
suffix:semicolon
id|termctl
op_and_assign
op_complement
(paren
id|FLX_TERMCTL_ENSECLOW
op_or
id|FLX_TERMCTL_ENSECHIGH
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|adapter_control
op_amp
id|CFSELOWTERM
)paren
op_ne
l_int|0
)paren
id|termctl
op_or_assign
id|FLX_TERMCTL_ENSECLOW
suffix:semicolon
r_if
c_cond
(paren
(paren
id|adapter_control
op_amp
id|CFSEHIGHTERM
)paren
op_ne
l_int|0
)paren
id|termctl
op_or_assign
id|FLX_TERMCTL_ENSECHIGH
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;%s: Secondary Auto-Term Sensing failed! &quot;
l_string|&quot;Using Defaults.&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
)paren
suffix:semicolon
id|termctl
op_or_assign
id|FLX_TERMCTL_ENSECLOW
op_or
id|FLX_TERMCTL_ENSECHIGH
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now set the termination based on what we found.&n;&t; */
id|sxfrctl1
op_assign
id|ahd_inb
c_func
(paren
id|ahd
comma
id|SXFRCTL1
)paren
op_amp
op_complement
id|STPWEN
suffix:semicolon
r_if
c_cond
(paren
(paren
id|termctl
op_amp
id|FLX_TERMCTL_ENPRILOW
)paren
op_ne
l_int|0
)paren
(brace
id|ahd-&gt;flags
op_or_assign
id|AHD_TERM_ENB_A
suffix:semicolon
id|sxfrctl1
op_or_assign
id|STPWEN
suffix:semicolon
)brace
multiline_comment|/* Must set the latch once in order to be effective. */
id|ahd_outb
c_func
(paren
id|ahd
comma
id|SXFRCTL1
comma
id|sxfrctl1
op_or
id|STPWEN
)paren
suffix:semicolon
id|ahd_outb
c_func
(paren
id|ahd
comma
id|SXFRCTL1
comma
id|sxfrctl1
)paren
suffix:semicolon
id|error
op_assign
id|ahd_write_flexport
c_func
(paren
id|ahd
comma
id|FLXADDR_TERMCTL
comma
id|termctl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;%s: Unable to set termination settings!&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bootverbose
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;%s: Primary High byte termination %sabled&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
comma
(paren
id|termctl
op_amp
id|FLX_TERMCTL_ENPRIHIGH
)paren
ques
c_cond
l_string|&quot;En&quot;
suffix:colon
l_string|&quot;Dis&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;%s: Primary Low byte termination %sabled&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
comma
(paren
id|termctl
op_amp
id|FLX_TERMCTL_ENPRILOW
)paren
ques
c_cond
l_string|&quot;En&quot;
suffix:colon
l_string|&quot;Dis&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;%s: Secondary High byte termination %sabled&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
comma
(paren
id|termctl
op_amp
id|FLX_TERMCTL_ENSECHIGH
)paren
ques
c_cond
l_string|&quot;En&quot;
suffix:colon
l_string|&quot;Dis&quot;
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;%s: Secondary Low byte termination %sabled&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
comma
(paren
id|termctl
op_amp
id|FLX_TERMCTL_ENSECLOW
)paren
ques
c_cond
l_string|&quot;En&quot;
suffix:colon
l_string|&quot;Dis&quot;
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|macro|DPE
mdefine_line|#define&t;DPE&t;0x80
DECL|macro|SSE
mdefine_line|#define SSE&t;0x40
DECL|macro|RMA
mdefine_line|#define&t;RMA&t;0x20
DECL|macro|RTA
mdefine_line|#define&t;RTA&t;0x10
DECL|macro|STA
mdefine_line|#define STA&t;0x08
DECL|macro|DPR
mdefine_line|#define DPR&t;0x01
DECL|variable|split_status_source
r_static
r_const
r_char
op_star
id|split_status_source
(braket
)braket
op_assign
(brace
l_string|&quot;DFF0&quot;
comma
l_string|&quot;DFF1&quot;
comma
l_string|&quot;OVLY&quot;
comma
l_string|&quot;CMC&quot;
comma
)brace
suffix:semicolon
DECL|variable|pci_status_source
r_static
r_const
r_char
op_star
id|pci_status_source
(braket
)braket
op_assign
(brace
l_string|&quot;DFF0&quot;
comma
l_string|&quot;DFF1&quot;
comma
l_string|&quot;SG&quot;
comma
l_string|&quot;CMC&quot;
comma
l_string|&quot;OVLY&quot;
comma
l_string|&quot;NONE&quot;
comma
l_string|&quot;MSI&quot;
comma
l_string|&quot;TARG&quot;
)brace
suffix:semicolon
DECL|variable|split_status_strings
r_static
r_const
r_char
op_star
id|split_status_strings
(braket
)braket
op_assign
(brace
l_string|&quot;%s: Received split response in %s.&bslash;n&quot;
comma
l_string|&quot;%s: Received split completion error message in %s&bslash;n&quot;
comma
l_string|&quot;%s: Receive overrun in %s&bslash;n&quot;
comma
l_string|&quot;%s: Count not complete in %s&bslash;n&quot;
comma
l_string|&quot;%s: Split completion data bucket in %s&bslash;n&quot;
comma
l_string|&quot;%s: Split completion address error in %s&bslash;n&quot;
comma
l_string|&quot;%s: Split completion byte count error in %s&bslash;n&quot;
comma
l_string|&quot;%s: Signaled Target-abort to early terminate a split in %s&bslash;n&quot;
)brace
suffix:semicolon
DECL|variable|pci_status_strings
r_static
r_const
r_char
op_star
id|pci_status_strings
(braket
)braket
op_assign
(brace
l_string|&quot;%s: Data Parity Error has been reported via PERR# in %s&bslash;n&quot;
comma
l_string|&quot;%s: Target initial wait state error in %s&bslash;n&quot;
comma
l_string|&quot;%s: Split completion read data parity error in %s&bslash;n&quot;
comma
l_string|&quot;%s: Split completion address attribute parity error in %s&bslash;n&quot;
comma
l_string|&quot;%s: Received a Target Abort in %s&bslash;n&quot;
comma
l_string|&quot;%s: Received a Master Abort in %s&bslash;n&quot;
comma
l_string|&quot;%s: Signal System Error Detected in %s&bslash;n&quot;
comma
l_string|&quot;%s: Address or Write Phase Parity Error Detected in %s.&bslash;n&quot;
)brace
suffix:semicolon
r_void
DECL|function|ahd_pci_intr
id|ahd_pci_intr
c_func
(paren
r_struct
id|ahd_softc
op_star
id|ahd
)paren
(brace
r_uint8
id|pci_status
(braket
l_int|8
)braket
suffix:semicolon
id|ahd_mode_state
id|saved_modes
suffix:semicolon
id|u_int
id|pci_status1
suffix:semicolon
id|u_int
id|intstat
suffix:semicolon
id|u_int
id|i
suffix:semicolon
id|u_int
id|reg
suffix:semicolon
id|intstat
op_assign
id|ahd_inb
c_func
(paren
id|ahd
comma
id|INTSTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|intstat
op_amp
id|SPLTINT
)paren
op_ne
l_int|0
)paren
id|ahd_pci_split_intr
c_func
(paren
id|ahd
comma
id|intstat
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|intstat
op_amp
id|PCIINT
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;%s: PCI error Interrupt&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
)paren
suffix:semicolon
id|saved_modes
op_assign
id|ahd_save_modes
c_func
(paren
id|ahd
)paren
suffix:semicolon
id|ahd_dump_card_state
c_func
(paren
id|ahd
)paren
suffix:semicolon
id|ahd_set_modes
c_func
(paren
id|ahd
comma
id|AHD_MODE_CFG
comma
id|AHD_MODE_CFG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|reg
op_assign
id|DF0PCISTAT
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|reg
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|5
)paren
r_continue
suffix:semicolon
id|pci_status
(braket
id|i
)braket
op_assign
id|ahd_inb
c_func
(paren
id|ahd
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* Clear latched errors.  So our interrupt deasserts. */
id|ahd_outb
c_func
(paren
id|ahd
comma
id|reg
comma
id|pci_status
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u_int
id|bit
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|5
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|0
suffix:semicolon
id|bit
OL
l_int|8
suffix:semicolon
id|bit
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|pci_status
(braket
id|i
)braket
op_amp
(paren
l_int|0x1
op_lshift
id|bit
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_static
r_const
r_char
op_star
id|s
suffix:semicolon
id|s
op_assign
id|pci_status_strings
(braket
id|bit
)braket
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|7
multiline_comment|/*TARG*/
op_logical_and
id|bit
op_eq
l_int|3
)paren
id|s
op_assign
l_string|&quot;%s: Signaled Target Abort&bslash;n&quot;
suffix:semicolon
id|printf
c_func
(paren
id|s
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
comma
id|pci_status_source
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
id|pci_status1
op_assign
id|ahd_pci_read_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIR_STATUS
op_plus
l_int|1
comma
multiline_comment|/*bytes*/
l_int|1
)paren
suffix:semicolon
id|ahd_pci_write_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIR_STATUS
op_plus
l_int|1
comma
id|pci_status1
comma
multiline_comment|/*bytes*/
l_int|1
)paren
suffix:semicolon
id|ahd_restore_modes
c_func
(paren
id|ahd
comma
id|saved_modes
)paren
suffix:semicolon
id|ahd_outb
c_func
(paren
id|ahd
comma
id|CLRINT
comma
id|CLRPCIINT
)paren
suffix:semicolon
id|ahd_unpause
c_func
(paren
id|ahd
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ahd_pci_split_intr
id|ahd_pci_split_intr
c_func
(paren
r_struct
id|ahd_softc
op_star
id|ahd
comma
id|u_int
id|intstat
)paren
(brace
r_uint8
id|split_status
(braket
l_int|4
)braket
suffix:semicolon
r_uint8
id|split_status1
(braket
l_int|4
)braket
suffix:semicolon
r_uint8
id|sg_split_status
(braket
l_int|2
)braket
suffix:semicolon
r_uint8
id|sg_split_status1
(braket
l_int|2
)braket
suffix:semicolon
id|ahd_mode_state
id|saved_modes
suffix:semicolon
id|u_int
id|i
suffix:semicolon
r_uint16
id|pcix_status
suffix:semicolon
multiline_comment|/*&n;&t; * Check for splits in all modes.  Modes 0 and 1&n;&t; * additionally have SG engine splits to look at.&n;&t; */
id|pcix_status
op_assign
id|ahd_pci_read_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIXR_STATUS
comma
multiline_comment|/*bytes*/
l_int|2
)paren
suffix:semicolon
id|printf
c_func
(paren
l_string|&quot;%s: PCI Split Interrupt - PCI-X status = 0x%x&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
comma
id|pcix_status
)paren
suffix:semicolon
id|saved_modes
op_assign
id|ahd_save_modes
c_func
(paren
id|ahd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ahd_set_modes
c_func
(paren
id|ahd
comma
id|i
comma
id|i
)paren
suffix:semicolon
id|split_status
(braket
id|i
)braket
op_assign
id|ahd_inb
c_func
(paren
id|ahd
comma
id|DCHSPLTSTAT0
)paren
suffix:semicolon
id|split_status1
(braket
id|i
)braket
op_assign
id|ahd_inb
c_func
(paren
id|ahd
comma
id|DCHSPLTSTAT1
)paren
suffix:semicolon
multiline_comment|/* Clear latched errors.  So our interrupt deasserts. */
id|ahd_outb
c_func
(paren
id|ahd
comma
id|DCHSPLTSTAT0
comma
id|split_status
(braket
id|i
)braket
)paren
suffix:semicolon
id|ahd_outb
c_func
(paren
id|ahd
comma
id|DCHSPLTSTAT1
comma
id|split_status1
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
r_continue
suffix:semicolon
id|sg_split_status
(braket
id|i
)braket
op_assign
id|ahd_inb
c_func
(paren
id|ahd
comma
id|SGSPLTSTAT0
)paren
suffix:semicolon
id|sg_split_status1
(braket
id|i
)braket
op_assign
id|ahd_inb
c_func
(paren
id|ahd
comma
id|SGSPLTSTAT1
)paren
suffix:semicolon
multiline_comment|/* Clear latched errors.  So our interrupt deasserts. */
id|ahd_outb
c_func
(paren
id|ahd
comma
id|SGSPLTSTAT0
comma
id|sg_split_status
(braket
id|i
)braket
)paren
suffix:semicolon
id|ahd_outb
c_func
(paren
id|ahd
comma
id|SGSPLTSTAT1
comma
id|sg_split_status1
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u_int
id|bit
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|0
suffix:semicolon
id|bit
OL
l_int|8
suffix:semicolon
id|bit
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|split_status
(braket
id|i
)braket
op_amp
(paren
l_int|0x1
op_lshift
id|bit
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_static
r_const
r_char
op_star
id|s
suffix:semicolon
id|s
op_assign
id|split_status_strings
(braket
id|bit
)braket
suffix:semicolon
id|printf
c_func
(paren
id|s
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
comma
id|split_status_source
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sg_split_status
(braket
id|i
)braket
op_amp
(paren
l_int|0x1
op_lshift
id|bit
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_static
r_const
r_char
op_star
id|s
suffix:semicolon
id|s
op_assign
id|split_status_strings
(braket
id|bit
)braket
suffix:semicolon
id|printf
c_func
(paren
id|s
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
comma
l_string|&quot;SG&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;&t; * Clear PCI-X status bits.&n;&t; */
id|ahd_pci_write_config
c_func
(paren
id|ahd-&gt;dev_softc
comma
id|PCIXR_STATUS
comma
id|pcix_status
comma
multiline_comment|/*bytes*/
l_int|2
)paren
suffix:semicolon
id|ahd_outb
c_func
(paren
id|ahd
comma
id|CLRINT
comma
id|CLRSPLTINT
)paren
suffix:semicolon
id|ahd_restore_modes
c_func
(paren
id|ahd
comma
id|saved_modes
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ahd_aic7901A_setup
id|ahd_aic7901A_setup
c_func
(paren
r_struct
id|ahd_softc
op_star
id|ahd
)paren
(brace
r_int
id|error
suffix:semicolon
id|error
op_assign
id|ahd_aic7902_setup
c_func
(paren
id|ahd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
r_return
(paren
id|error
)paren
suffix:semicolon
id|ahd-&gt;chip
op_assign
id|AHD_AIC7901A
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ahd_aic7902_setup
id|ahd_aic7902_setup
c_func
(paren
r_struct
id|ahd_softc
op_star
id|ahd
)paren
(brace
id|ahd_dev_softc_t
id|pci
suffix:semicolon
id|u_int
id|rev
suffix:semicolon
id|pci
op_assign
id|ahd-&gt;dev_softc
suffix:semicolon
id|rev
op_assign
id|ahd_pci_read_config
c_func
(paren
id|pci
comma
id|PCIR_REVID
comma
multiline_comment|/*bytes*/
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rev
OL
id|ID_AIC7902_PCI_REV_A4
)paren
(brace
id|printf
c_func
(paren
l_string|&quot;%s: Unable to attach to unsupported chip revision %d&bslash;n&quot;
comma
id|ahd_name
c_func
(paren
id|ahd
)paren
comma
id|rev
)paren
suffix:semicolon
id|ahd_pci_write_config
c_func
(paren
id|pci
comma
id|PCIR_COMMAND
comma
l_int|0
comma
multiline_comment|/*bytes*/
l_int|1
)paren
suffix:semicolon
r_return
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
id|ahd-&gt;channel
op_assign
id|ahd_get_pci_function
c_func
(paren
id|pci
)paren
op_plus
l_char|&squot;A&squot;
suffix:semicolon
id|ahd-&gt;chip
op_assign
id|AHD_AIC7902
suffix:semicolon
id|ahd-&gt;features
op_assign
id|AHD_AIC7902_FE
suffix:semicolon
r_if
c_cond
(paren
id|rev
OL
id|ID_AIC7902_PCI_REV_B0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Enable A series workarounds.&n;&t;&t; */
id|ahd-&gt;bugs
op_or_assign
id|AHD_SENT_SCB_UPDATE_BUG
op_or
id|AHD_ABORT_LQI_BUG
op_or
id|AHD_PKT_BITBUCKET_BUG
op_or
id|AHD_LONG_SETIMO_BUG
op_or
id|AHD_NLQICRC_DELAYED_BUG
op_or
id|AHD_SCSIRST_BUG
op_or
id|AHD_LQO_ATNO_BUG
op_or
id|AHD_AUTOFLUSH_BUG
op_or
id|AHD_CLRLQO_AUTOCLR_BUG
op_or
id|AHD_PCIX_MMAPIO_BUG
op_or
id|AHD_PCIX_CHIPRST_BUG
op_or
id|AHD_PCIX_SCBRAM_RD_BUG
op_or
id|AHD_PKTIZED_STATUS_BUG
op_or
id|AHD_PKT_LUN_BUG
op_or
id|AHD_MDFF_WSCBPTR_BUG
op_or
id|AHD_REG_SLOW_SETTLE_BUG
op_or
id|AHD_SET_MODE_BUG
op_or
id|AHD_BUSFREEREV_BUG
op_or
id|AHD_NONPACKFIFO_BUG
op_or
id|AHD_PACED_NEGTABLE_BUG
suffix:semicolon
multiline_comment|/*&n;&t;&t; * IO Cell paramter setup.&n;&t;&t; */
id|AHD_SET_PRECOMP
c_func
(paren
id|ahd
comma
id|AHD_PRECOMP_CUTBACK_29
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ahd-&gt;flags
op_amp
id|AHD_HP_BOARD
)paren
op_eq
l_int|0
)paren
id|AHD_SET_SLEWRATE
c_func
(paren
id|ahd
comma
id|AHD_SLEWRATE_DEF_REVA
)paren
suffix:semicolon
)brace
r_else
(brace
id|u_int
id|devconfig1
suffix:semicolon
id|ahd-&gt;features
op_or_assign
id|AHD_RTI
op_or
id|AHD_NEW_IOCELL_OPTS
op_or
id|AHD_NEW_DFCNTRL_OPTS
suffix:semicolon
id|ahd-&gt;bugs
op_or_assign
id|AHD_LQOOVERRUN_BUG
op_or
id|AHD_ABORT_LQI_BUG
op_or
id|AHD_INTCOLLISION_BUG
op_or
id|AHD_EARLY_REQ_BUG
suffix:semicolon
multiline_comment|/*&n;&t;&t; * IO Cell paramter setup.&n;&t;&t; */
id|AHD_SET_PRECOMP
c_func
(paren
id|ahd
comma
id|AHD_PRECOMP_CUTBACK_29
)paren
suffix:semicolon
id|AHD_SET_SLEWRATE
c_func
(paren
id|ahd
comma
id|AHD_SLEWRATE_DEF_REVB
)paren
suffix:semicolon
id|AHD_SET_AMPLITUDE
c_func
(paren
id|ahd
comma
id|AHD_AMPLITUDE_DEF
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Set the PREQDIS bit for H2B which disables some workaround&n;&t;&t; * that doesn&squot;t work on regular PCI busses.&n;&t;&t; * XXX - Find out exactly what this does from the hardware&n;&t;&t; * &t; folks!&n;&t;&t; */
id|devconfig1
op_assign
id|ahd_pci_read_config
c_func
(paren
id|pci
comma
id|DEVCONFIG1
comma
multiline_comment|/*bytes*/
l_int|1
)paren
suffix:semicolon
id|ahd_pci_write_config
c_func
(paren
id|pci
comma
id|DEVCONFIG1
comma
id|devconfig1
op_or
id|PREQDIS
comma
multiline_comment|/*bytes*/
l_int|1
)paren
suffix:semicolon
id|devconfig1
op_assign
id|ahd_pci_read_config
c_func
(paren
id|pci
comma
id|DEVCONFIG1
comma
multiline_comment|/*bytes*/
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
eof
