multiline_comment|/*&n;   libata-core.c - helper library for ATA&n;&n;   Copyright 2003 Red Hat, Inc.  All rights reserved.&n;   Copyright 2003 Jeff Garzik&n;&n;   The contents of this file are subject to the Open&n;   Software License version 1.1 that can be found at&n;   http://www.opensource.org/licenses/osl-1.1.txt and is included herein&n;   by reference.&n;&n;   Alternatively, the contents of this file may be used under the terms&n;   of the GNU General Public License version 2 (the &quot;GPL&quot;) as distributed&n;   in the kernel source COPYING file, in which case the provisions of&n;   the GPL are applicable instead of the above.  If you wish to allow&n;   the use of your version of this file only under the terms of the&n;   GPL and not to allow others to use your version of this file under&n;   the OSL, indicate your decision by deleting the provisions above and&n;   replace them with the notice and other provisions required by the GPL.&n;   If you do not delete the provisions above, a recipient may use your&n;   version of this file under either the OSL or the GPL.&n;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/highmem.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &lt;linux/libata.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &quot;libata.h&quot;
r_static
r_void
id|atapi_cdb_send
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_int
r_int
id|ata_busy_sleep
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|tmout_pat
comma
r_int
r_int
id|tmout
)paren
suffix:semicolon
r_static
r_void
id|__ata_dev_select
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
)paren
suffix:semicolon
r_static
r_void
id|ata_qc_push
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
comma
r_int
r_int
id|append
)paren
suffix:semicolon
r_static
r_void
id|ata_dma_complete
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
id|u8
id|host_stat
comma
r_int
r_int
id|done_late
)paren
suffix:semicolon
r_static
r_void
id|ata_host_set_pio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_void
id|ata_host_set_udma
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_void
id|ata_dev_set_pio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
)paren
suffix:semicolon
r_static
r_void
id|ata_dev_set_udma
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
)paren
suffix:semicolon
DECL|variable|ata_unique_id
r_static
r_int
r_int
id|ata_unique_id
op_assign
l_int|1
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jeff Garzik&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Library module for ATA devices&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|thr_state_name
r_static
r_const
r_char
op_star
id|thr_state_name
(braket
)braket
op_assign
(brace
l_string|&quot;THR_UNKNOWN&quot;
comma
l_string|&quot;THR_PORT_RESET&quot;
comma
l_string|&quot;THR_AWAIT_DEATH&quot;
comma
l_string|&quot;THR_PROBE_FAILED&quot;
comma
l_string|&quot;THR_IDLE&quot;
comma
l_string|&quot;THR_PROBE_SUCCESS&quot;
comma
l_string|&quot;THR_PROBE_START&quot;
comma
l_string|&quot;THR_PIO_POLL&quot;
comma
l_string|&quot;THR_PIO_TMOUT&quot;
comma
l_string|&quot;THR_PIO&quot;
comma
l_string|&quot;THR_PIO_LAST&quot;
comma
l_string|&quot;THR_PIO_LAST_POLL&quot;
comma
l_string|&quot;THR_PIO_ERR&quot;
comma
l_string|&quot;THR_PACKET&quot;
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;ata_thr_state_name - convert thread state enum to string&n; *&t;@thr_state: thread state to be converted to string&n; *&n; *&t;Converts the specified thread state id to a constant C string.&n; *&n; *&t;LOCKING:&n; *&t;None.&n; *&n; *&t;RETURNS:&n; *&t;The THR_xxx-prefixed string naming the specified thread&n; *&t;state id, or the string &quot;&lt;invalid THR_xxx state&gt;&quot;.&n; */
DECL|function|ata_thr_state_name
r_static
r_const
r_char
op_star
id|ata_thr_state_name
c_func
(paren
r_int
r_int
id|thr_state
)paren
(brace
r_if
c_cond
(paren
id|thr_state
OL
id|ARRAY_SIZE
c_func
(paren
id|thr_state_name
)paren
)paren
r_return
id|thr_state_name
(braket
id|thr_state
)braket
suffix:semicolon
r_return
l_string|&quot;&lt;invalid THR_xxx state&gt;&quot;
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;msleep - sleep for a number of milliseconds&n; *&t;@msecs: number of milliseconds to sleep&n; *&n; *&t;Issues schedule_timeout call for the specified number&n; *&t;of milliseconds.&n; *&n; *&t;LOCKING:&n; *&t;None.&n; */
DECL|function|msleep
r_static
r_void
id|msleep
c_func
(paren
r_int
r_int
id|msecs
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|msecs_to_jiffies
c_func
(paren
id|msecs
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_tf_load_pio - send taskfile registers to host controller&n; *&t;@ioaddr: set of IO ports to which output is sent&n; *&t;@tf: ATA taskfile register set&n; *&n; *&t;Outputs ATA taskfile to standard ATA host controller using PIO.&n; *&n; *&t;LOCKING:&n; *&t;Inherited from caller.&n; */
DECL|function|ata_tf_load_pio
r_void
id|ata_tf_load_pio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_taskfile
op_star
id|tf
)paren
(brace
r_struct
id|ata_ioports
op_star
id|ioaddr
op_assign
op_amp
id|ap-&gt;ioaddr
suffix:semicolon
r_int
r_int
id|is_addr
op_assign
id|tf-&gt;flags
op_amp
id|ATA_TFLAG_ISADDR
suffix:semicolon
r_if
c_cond
(paren
id|tf-&gt;ctl
op_ne
id|ap-&gt;last_ctl
)paren
(brace
id|outb
c_func
(paren
id|tf-&gt;ctl
comma
id|ioaddr-&gt;ctl_addr
)paren
suffix:semicolon
id|ap-&gt;last_ctl
op_assign
id|tf-&gt;ctl
suffix:semicolon
id|ata_wait_idle
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_addr
op_logical_and
(paren
id|tf-&gt;flags
op_amp
id|ATA_TFLAG_LBA48
)paren
)paren
(brace
id|outb
c_func
(paren
id|tf-&gt;hob_feature
comma
id|ioaddr-&gt;error_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tf-&gt;hob_nsect
comma
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tf-&gt;hob_lbal
comma
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tf-&gt;hob_lbam
comma
id|ioaddr-&gt;lbam_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tf-&gt;hob_lbah
comma
id|ioaddr-&gt;lbah_addr
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;hob: feat 0x%X nsect 0x%X, lba 0x%X 0x%X 0x%X&bslash;n&quot;
comma
id|tf-&gt;hob_feature
comma
id|tf-&gt;hob_nsect
comma
id|tf-&gt;hob_lbal
comma
id|tf-&gt;hob_lbam
comma
id|tf-&gt;hob_lbah
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_addr
)paren
(brace
id|outb
c_func
(paren
id|tf-&gt;feature
comma
id|ioaddr-&gt;error_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tf-&gt;nsect
comma
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tf-&gt;lbal
comma
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tf-&gt;lbam
comma
id|ioaddr-&gt;lbam_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tf-&gt;lbah
comma
id|ioaddr-&gt;lbah_addr
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;feat 0x%X nsect 0x%X lba 0x%X 0x%X 0x%X&bslash;n&quot;
comma
id|tf-&gt;feature
comma
id|tf-&gt;nsect
comma
id|tf-&gt;lbal
comma
id|tf-&gt;lbam
comma
id|tf-&gt;lbah
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tf-&gt;flags
op_amp
id|ATA_TFLAG_DEVICE
)paren
(brace
id|outb
c_func
(paren
id|tf-&gt;device
comma
id|ioaddr-&gt;device_addr
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;device 0x%X&bslash;n&quot;
comma
id|tf-&gt;device
)paren
suffix:semicolon
)brace
id|ata_wait_idle
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_tf_load_mmio - send taskfile registers to host controller&n; *&t;@ioaddr: set of IO ports to which output is sent&n; *&t;@tf: ATA taskfile register set&n; *&n; *&t;Outputs ATA taskfile to standard ATA host controller using MMIO.&n; *&n; *&t;LOCKING:&n; *&t;Inherited from caller.&n; */
DECL|function|ata_tf_load_mmio
r_void
id|ata_tf_load_mmio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_taskfile
op_star
id|tf
)paren
(brace
r_struct
id|ata_ioports
op_star
id|ioaddr
op_assign
op_amp
id|ap-&gt;ioaddr
suffix:semicolon
r_int
r_int
id|is_addr
op_assign
id|tf-&gt;flags
op_amp
id|ATA_TFLAG_ISADDR
suffix:semicolon
r_if
c_cond
(paren
id|tf-&gt;ctl
op_ne
id|ap-&gt;last_ctl
)paren
(brace
id|writeb
c_func
(paren
id|tf-&gt;ctl
comma
id|ap-&gt;ioaddr.ctl_addr
)paren
suffix:semicolon
id|ap-&gt;last_ctl
op_assign
id|tf-&gt;ctl
suffix:semicolon
id|ata_wait_idle
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_addr
op_logical_and
(paren
id|tf-&gt;flags
op_amp
id|ATA_TFLAG_LBA48
)paren
)paren
(brace
id|writeb
c_func
(paren
id|tf-&gt;hob_feature
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;error_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|tf-&gt;hob_nsect
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|tf-&gt;hob_lbal
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|tf-&gt;hob_lbam
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbam_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|tf-&gt;hob_lbah
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbah_addr
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;hob: feat 0x%X nsect 0x%X, lba 0x%X 0x%X 0x%X&bslash;n&quot;
comma
id|tf-&gt;hob_feature
comma
id|tf-&gt;hob_nsect
comma
id|tf-&gt;hob_lbal
comma
id|tf-&gt;hob_lbam
comma
id|tf-&gt;hob_lbah
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_addr
)paren
(brace
id|writeb
c_func
(paren
id|tf-&gt;feature
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;error_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|tf-&gt;nsect
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|tf-&gt;lbal
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|tf-&gt;lbam
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbam_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|tf-&gt;lbah
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbah_addr
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;feat 0x%X nsect 0x%X lba 0x%X 0x%X 0x%X&bslash;n&quot;
comma
id|tf-&gt;feature
comma
id|tf-&gt;nsect
comma
id|tf-&gt;lbal
comma
id|tf-&gt;lbam
comma
id|tf-&gt;lbah
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tf-&gt;flags
op_amp
id|ATA_TFLAG_DEVICE
)paren
(brace
id|writeb
c_func
(paren
id|tf-&gt;device
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;device_addr
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;device 0x%X&bslash;n&quot;
comma
id|tf-&gt;device
)paren
suffix:semicolon
)brace
id|ata_wait_idle
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_exec_command_pio - issue ATA command to host controller&n; *&t;@ap: port to which command is being issued&n; *&t;@tf: ATA taskfile register set&n; *&n; *&t;Issues PIO write to ATA command register, with proper&n; *&t;synchronization with interrupt handler / other threads.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_exec_command_pio
r_void
id|ata_exec_command_pio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_taskfile
op_star
id|tf
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ata%u: cmd 0x%X&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|tf-&gt;command
)paren
suffix:semicolon
id|outb
c_func
(paren
id|tf-&gt;command
comma
id|ap-&gt;ioaddr.cmdstat_addr
)paren
suffix:semicolon
id|ata_pause
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_exec_command_mmio - issue ATA command to host controller&n; *&t;@ap: port to which command is being issued&n; *&t;@tf: ATA taskfile register set&n; *&n; *&t;Issues MMIO write to ATA command register, with proper&n; *&t;synchronization with interrupt handler / other threads.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_exec_command_mmio
r_void
id|ata_exec_command_mmio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_taskfile
op_star
id|tf
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ata%u: cmd 0x%X&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|tf-&gt;command
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|tf-&gt;command
comma
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.cmdstat_addr
)paren
suffix:semicolon
id|ata_pause
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_exec - issue ATA command to host controller&n; *&t;@ap: port to which command is being issued&n; *&t;@tf: ATA taskfile register set&n; *&n; *&t;Issues PIO write to ATA command register, with proper&n; *&t;synchronization with interrupt handler / other threads.&n; *&n; *&t;LOCKING:&n; *&t;Obtains host_set lock.&n; */
DECL|function|ata_exec
r_static
r_inline
r_void
id|ata_exec
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_taskfile
op_star
id|tf
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ata%u: cmd 0x%X&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|tf-&gt;command
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ap-&gt;host_set-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|exec_command
c_func
(paren
id|ap
comma
id|tf
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ap-&gt;host_set-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_tf_to_host - issue ATA taskfile to host controller&n; *&t;@ap: port to which command is being issued&n; *&t;@tf: ATA taskfile register set&n; *&n; *&t;Issues ATA taskfile register set to ATA host controller,&n; *&t;via PIO, with proper synchronization with interrupt handler and&n; *&t;other threads.&n; *&n; *&t;LOCKING:&n; *&t;Obtains host_set lock.&n; */
DECL|function|ata_tf_to_host
r_static
r_void
id|ata_tf_to_host
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_taskfile
op_star
id|tf
)paren
(brace
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|ap-&gt;sem
)paren
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|tf_load
c_func
(paren
id|ap
comma
id|tf
)paren
suffix:semicolon
id|ata_exec
c_func
(paren
id|ap
comma
id|tf
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_tf_to_host_nolock - issue ATA taskfile to host controller&n; *&t;@ap: port to which command is being issued&n; *&t;@tf: ATA taskfile register set&n; *&n; *&t;Issues ATA taskfile register set to ATA host controller,&n; *&t;via PIO, with proper synchronization with interrupt handler and&n; *&t;other threads.&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_tf_to_host_nolock
r_void
id|ata_tf_to_host_nolock
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_taskfile
op_star
id|tf
)paren
(brace
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|ap-&gt;sem
)paren
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|tf_load
c_func
(paren
id|ap
comma
id|tf
)paren
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|exec_command
c_func
(paren
id|ap
comma
id|tf
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_tf_read_pio - input device&squot;s ATA taskfile shadow registers&n; *&t;@ioaddr: set of IO ports from which input is read&n; *&t;@tf: ATA taskfile register set for storing input&n; *&n; *&t;Reads ATA taskfile registers for currently-selected device&n; *&t;into @tf via PIO.&n; *&n; *&t;LOCKING:&n; *&t;Inherited from caller.&n; */
DECL|function|ata_tf_read_pio
r_void
id|ata_tf_read_pio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_taskfile
op_star
id|tf
)paren
(brace
r_struct
id|ata_ioports
op_star
id|ioaddr
op_assign
op_amp
id|ap-&gt;ioaddr
suffix:semicolon
id|tf-&gt;nsect
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|tf-&gt;lbal
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|tf-&gt;lbam
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;lbam_addr
)paren
suffix:semicolon
id|tf-&gt;lbah
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;lbah_addr
)paren
suffix:semicolon
id|tf-&gt;device
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;device_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tf-&gt;flags
op_amp
id|ATA_TFLAG_LBA48
)paren
(brace
id|outb
c_func
(paren
id|tf-&gt;ctl
op_or
id|ATA_HOB
comma
id|ioaddr-&gt;ctl_addr
)paren
suffix:semicolon
id|tf-&gt;hob_feature
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;error_addr
)paren
suffix:semicolon
id|tf-&gt;hob_nsect
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|tf-&gt;hob_lbal
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|tf-&gt;hob_lbam
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;lbam_addr
)paren
suffix:semicolon
id|tf-&gt;hob_lbah
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;lbah_addr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;ata_tf_read_mmio - input device&squot;s ATA taskfile shadow registers&n; *&t;@ioaddr: set of IO ports from which input is read&n; *&t;@tf: ATA taskfile register set for storing input&n; *&n; *&t;Reads ATA taskfile registers for currently-selected device&n; *&t;into @tf via MMIO.&n; *&n; *&t;LOCKING:&n; *&t;Inherited from caller.&n; */
DECL|function|ata_tf_read_mmio
r_void
id|ata_tf_read_mmio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_taskfile
op_star
id|tf
)paren
(brace
r_struct
id|ata_ioports
op_star
id|ioaddr
op_assign
op_amp
id|ap-&gt;ioaddr
suffix:semicolon
id|tf-&gt;nsect
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|tf-&gt;lbal
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|tf-&gt;lbam
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbam_addr
)paren
suffix:semicolon
id|tf-&gt;lbah
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbah_addr
)paren
suffix:semicolon
id|tf-&gt;device
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;device_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tf-&gt;flags
op_amp
id|ATA_TFLAG_LBA48
)paren
(brace
id|writeb
c_func
(paren
id|tf-&gt;ctl
op_or
id|ATA_HOB
comma
id|ap-&gt;ioaddr.ctl_addr
)paren
suffix:semicolon
id|tf-&gt;hob_feature
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;error_addr
)paren
suffix:semicolon
id|tf-&gt;hob_nsect
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|tf-&gt;hob_lbal
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|tf-&gt;hob_lbam
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbam_addr
)paren
suffix:semicolon
id|tf-&gt;hob_lbah
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbah_addr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;ata_check_status_pio - Read device status reg &amp; clear interrupt&n; *&t;@ap: port where the device is&n; *&n; *&t;Reads ATA taskfile status register for currently-selected device&n; *&t;via PIO and return it&squot;s value. This also clears pending interrupts&n; *      from this device&n; *&n; *&t;LOCKING:&n; *&t;Inherited from caller.&n; */
DECL|function|ata_check_status_pio
id|u8
id|ata_check_status_pio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_return
id|inb
c_func
(paren
id|ap-&gt;ioaddr.cmdstat_addr
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_check_status_mmio - Read device status reg &amp; clear interrupt&n; *&t;@ap: port where the device is&n; *&n; *&t;Reads ATA taskfile status register for currently-selected device&n; *&t;via MMIO and return it&squot;s value. This also clears pending interrupts&n; *      from this device&n; *&n; *&t;LOCKING:&n; *&t;Inherited from caller.&n; */
DECL|function|ata_check_status_mmio
id|u8
id|ata_check_status_mmio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_return
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.cmdstat_addr
)paren
suffix:semicolon
)brace
DECL|variable|udma_str
r_static
r_const
r_char
op_star
id|udma_str
(braket
)braket
op_assign
(brace
l_string|&quot;UDMA/16&quot;
comma
l_string|&quot;UDMA/25&quot;
comma
l_string|&quot;UDMA/33&quot;
comma
l_string|&quot;UDMA/44&quot;
comma
l_string|&quot;UDMA/66&quot;
comma
l_string|&quot;UDMA/100&quot;
comma
l_string|&quot;UDMA/133&quot;
comma
l_string|&quot;UDMA7&quot;
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;ata_udma_string - convert UDMA bit offset to string&n; *&t;@udma_mask: mask of bits supported; only highest bit counts.&n; *&n; *&t;Determine string which represents the highest speed&n; *&t;(highest bit in @udma_mask).&n; *&n; *&t;LOCKING:&n; *&t;None.&n; *&n; *&t;RETURNS:&n; *&t;Constant C string representing highest speed listed in&n; *&t;@udma_mask, or the constant C string &quot;&lt;n/a&gt;&quot;.&n; */
DECL|function|ata_udma_string
r_static
r_const
r_char
op_star
id|ata_udma_string
c_func
(paren
r_int
r_int
id|udma_mask
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|udma_mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
r_return
id|udma_str
(braket
id|i
)braket
suffix:semicolon
)brace
r_return
l_string|&quot;&lt;n/a&gt;&quot;
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_pio_devchk -&n; *&t;@ap:&n; *&t;@device:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|ata_pio_devchk
r_static
r_int
r_int
id|ata_pio_devchk
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
)paren
(brace
r_struct
id|ata_ioports
op_star
id|ioaddr
op_assign
op_amp
id|ap-&gt;ioaddr
suffix:semicolon
id|u8
id|nsect
comma
id|lbal
suffix:semicolon
id|__ata_dev_select
c_func
(paren
id|ap
comma
id|device
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x55
comma
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xaa
comma
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xaa
comma
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x55
comma
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x55
comma
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xaa
comma
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|nsect
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|lbal
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nsect
op_eq
l_int|0x55
)paren
op_logical_and
(paren
id|lbal
op_eq
l_int|0xaa
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* we found a device */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* nothing found */
)brace
multiline_comment|/**&n; *&t;ata_mmio_devchk -&n; *&t;@ap:&n; *&t;@device:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|ata_mmio_devchk
r_static
r_int
r_int
id|ata_mmio_devchk
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
)paren
(brace
r_struct
id|ata_ioports
op_star
id|ioaddr
op_assign
op_amp
id|ap-&gt;ioaddr
suffix:semicolon
id|u8
id|nsect
comma
id|lbal
suffix:semicolon
id|__ata_dev_select
c_func
(paren
id|ap
comma
id|device
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x55
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xaa
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xaa
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x55
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x55
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xaa
comma
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
id|nsect
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|lbal
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nsect
op_eq
l_int|0x55
)paren
op_logical_and
(paren
id|lbal
op_eq
l_int|0xaa
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* we found a device */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* nothing found */
)brace
multiline_comment|/**&n; *&t;ata_dev_devchk -&n; *&t;@ap:&n; *&t;@device:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|ata_dev_devchk
r_static
r_int
r_int
id|ata_dev_devchk
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
)paren
(brace
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_MMIO
)paren
r_return
id|ata_mmio_devchk
c_func
(paren
id|ap
comma
id|device
)paren
suffix:semicolon
r_return
id|ata_pio_devchk
c_func
(paren
id|ap
comma
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_dev_classify - determine device type based on ATA-spec signature&n; *&t;@tf: ATA taskfile register set for device to be identified&n; *&n; *&t;Determine from taskfile register contents whether a device is&n; *&t;ATA or ATAPI, as per &quot;Signature and persistence&quot; section&n; *&t;of ATA/PI spec (volume 1, sect 5.14).&n; *&n; *&t;LOCKING:&n; *&t;None.&n; *&n; *&t;RETURNS:&n; *&t;Device type, %ATA_DEV_ATA, %ATA_DEV_ATAPI, or %ATA_DEV_UNKNOWN&n; *&t;the event of failure.&n; */
DECL|function|ata_dev_classify
r_static
r_int
r_int
id|ata_dev_classify
c_func
(paren
r_struct
id|ata_taskfile
op_star
id|tf
)paren
(brace
multiline_comment|/* Apple&squot;s open source Darwin code hints that some devices only&n;&t; * put a proper signature into the LBA mid/high registers,&n;&t; * So, we only check those.  It&squot;s sufficient for uniqueness.&n;&t; */
r_if
c_cond
(paren
(paren
(paren
id|tf-&gt;lbam
op_eq
l_int|0
)paren
op_logical_and
(paren
id|tf-&gt;lbah
op_eq
l_int|0
)paren
)paren
op_logical_or
(paren
(paren
id|tf-&gt;lbam
op_eq
l_int|0x3c
)paren
op_logical_and
(paren
id|tf-&gt;lbah
op_eq
l_int|0xc3
)paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;found ATA device by sig&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ATA_DEV_ATA
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|tf-&gt;lbam
op_eq
l_int|0x14
)paren
op_logical_and
(paren
id|tf-&gt;lbah
op_eq
l_int|0xeb
)paren
)paren
op_logical_or
(paren
(paren
id|tf-&gt;lbam
op_eq
l_int|0x69
)paren
op_logical_and
(paren
id|tf-&gt;lbah
op_eq
l_int|0x96
)paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;found ATAPI device by sig&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ATA_DEV_ATAPI
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;unknown device&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ATA_DEV_UNKNOWN
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_dev_try_classify -&n; *&t;@ap:&n; *&t;@device:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|ata_dev_try_classify
r_static
id|u8
id|ata_dev_try_classify
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
comma
r_int
r_int
id|maybe_have_dev
)paren
(brace
r_struct
id|ata_device
op_star
id|dev
op_assign
op_amp
id|ap-&gt;device
(braket
id|device
)braket
suffix:semicolon
r_struct
id|ata_taskfile
id|tf
suffix:semicolon
r_int
r_int
r_class
suffix:semicolon
id|u8
id|err
suffix:semicolon
id|__ata_dev_select
c_func
(paren
id|ap
comma
id|device
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tf
comma
l_int|0
comma
r_sizeof
(paren
id|tf
)paren
)paren
suffix:semicolon
id|err
op_assign
id|ata_chk_err
c_func
(paren
id|ap
)paren
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|tf_read
c_func
(paren
id|ap
comma
op_amp
id|tf
)paren
suffix:semicolon
id|dev
op_member_access_from_pointer
r_class
op_assign
id|ATA_DEV_NONE
suffix:semicolon
multiline_comment|/* see if device passed diags */
r_if
c_cond
(paren
id|err
op_eq
l_int|1
)paren
multiline_comment|/* do nothing */
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|device
op_eq
l_int|0
)paren
op_logical_and
(paren
id|err
op_eq
l_int|0x81
)paren
)paren
multiline_comment|/* do nothing */
suffix:semicolon
r_else
r_return
id|err
suffix:semicolon
multiline_comment|/* determine if device if ATA or ATAPI */
r_class
op_assign
id|ata_dev_classify
c_func
(paren
op_amp
id|tf
)paren
suffix:semicolon
r_if
c_cond
(paren
r_class
op_eq
id|ATA_DEV_UNKNOWN
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
r_class
op_eq
id|ATA_DEV_ATA
)paren
op_logical_and
(paren
id|ata_chk_status
c_func
(paren
id|ap
)paren
op_eq
l_int|0
)paren
)paren
r_return
id|err
suffix:semicolon
id|dev
op_member_access_from_pointer
r_class
op_assign
r_class
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_dev_id_string -&n; *&t;@dev:&n; *&t;@s:&n; *&t;@ofs:&n; *&t;@len:&n; *&n; *&t;LOCKING:&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_dev_id_string
r_int
r_int
id|ata_dev_id_string
c_func
(paren
r_struct
id|ata_device
op_star
id|dev
comma
r_int
r_char
op_star
id|s
comma
r_int
r_int
id|ofs
comma
r_int
r_int
id|len
)paren
(brace
r_int
r_int
id|c
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
id|c
op_assign
id|dev-&gt;id
(braket
id|ofs
)braket
op_rshift
l_int|8
suffix:semicolon
op_star
id|s
op_assign
id|c
suffix:semicolon
id|s
op_increment
suffix:semicolon
id|ret
op_assign
id|c
op_assign
id|dev-&gt;id
(braket
id|ofs
)braket
op_amp
l_int|0xff
suffix:semicolon
op_star
id|s
op_assign
id|c
suffix:semicolon
id|s
op_increment
suffix:semicolon
id|ofs
op_increment
suffix:semicolon
id|len
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_dev_parse_strings -&n; *&t;@dev:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_dev_parse_strings
r_static
r_void
id|ata_dev_parse_strings
c_func
(paren
r_struct
id|ata_device
op_star
id|dev
)paren
(brace
m_assert
(paren
id|dev
op_member_access_from_pointer
r_class
op_eq
id|ATA_DEV_ATA
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;vendor
comma
l_string|&quot;ATA     &quot;
comma
l_int|8
)paren
suffix:semicolon
id|ata_dev_id_string
c_func
(paren
id|dev
comma
id|dev-&gt;product
comma
id|ATA_ID_PROD_OFS
comma
r_sizeof
(paren
id|dev-&gt;product
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;__ata_dev_select -&n; *&t;@ap:&n; *&t;@device:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|__ata_dev_select
r_static
r_void
id|__ata_dev_select
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
)paren
(brace
id|u8
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|0
)paren
id|tmp
op_assign
id|ATA_DEVICE_OBS
suffix:semicolon
r_else
id|tmp
op_assign
id|ATA_DEVICE_OBS
op_or
id|ATA_DEV1
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_MMIO
)paren
(brace
id|writeb
c_func
(paren
id|tmp
comma
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.device_addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|outb
c_func
(paren
id|tmp
comma
id|ap-&gt;ioaddr.device_addr
)paren
suffix:semicolon
)brace
id|ata_pause
c_func
(paren
id|ap
)paren
suffix:semicolon
multiline_comment|/* needed; also flushes, for mmio */
)brace
multiline_comment|/**&n; *&t;ata_dev_select -&n; *&t;@ap:&n; *&t;@device:&n; *&t;@wait:&n; *&t;@can_sleep:&n; *&n; *&t;LOCKING:&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_dev_select
r_void
id|ata_dev_select
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
comma
r_int
r_int
id|wait
comma
r_int
r_int
id|can_sleep
)paren
(brace
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER, ata%u: device %u, wait %u&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|device
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait
)paren
id|ata_wait_idle
c_func
(paren
id|ap
)paren
suffix:semicolon
id|__ata_dev_select
c_func
(paren
id|ap
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait
)paren
(brace
r_if
c_cond
(paren
id|can_sleep
op_logical_and
id|ap-&gt;device
(braket
id|device
)braket
dot
r_class
op_eq
id|ATA_DEV_ATAPI
)paren
id|msleep
c_func
(paren
l_int|150
)paren
suffix:semicolon
id|ata_wait_idle
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;ata_dump_id -&n; *&t;@dev:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_dump_id
r_static
r_inline
r_void
id|ata_dump_id
c_func
(paren
r_struct
id|ata_device
op_star
id|dev
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;49==0x%04x  &quot;
l_string|&quot;53==0x%04x  &quot;
l_string|&quot;63==0x%04x  &quot;
l_string|&quot;64==0x%04x  &quot;
l_string|&quot;75==0x%04x  &bslash;n&quot;
comma
id|dev-&gt;id
(braket
l_int|49
)braket
comma
id|dev-&gt;id
(braket
l_int|53
)braket
comma
id|dev-&gt;id
(braket
l_int|63
)braket
comma
id|dev-&gt;id
(braket
l_int|64
)braket
comma
id|dev-&gt;id
(braket
l_int|75
)braket
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;80==0x%04x  &quot;
l_string|&quot;81==0x%04x  &quot;
l_string|&quot;82==0x%04x  &quot;
l_string|&quot;83==0x%04x  &quot;
l_string|&quot;84==0x%04x  &bslash;n&quot;
comma
id|dev-&gt;id
(braket
l_int|80
)braket
comma
id|dev-&gt;id
(braket
l_int|81
)braket
comma
id|dev-&gt;id
(braket
l_int|82
)braket
comma
id|dev-&gt;id
(braket
l_int|83
)braket
comma
id|dev-&gt;id
(braket
l_int|84
)braket
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;88==0x%04x  &quot;
l_string|&quot;93==0x%04x&bslash;n&quot;
comma
id|dev-&gt;id
(braket
l_int|88
)braket
comma
id|dev-&gt;id
(braket
l_int|93
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_dev_identify - obtain IDENTIFY x DEVICE page&n; *&t;@ap: port on which device we wish to probe resides&n; *&t;@device: device bus address, starting at zero&n; *&n; *&t;Following bus reset, we issue the IDENTIFY [PACKET] DEVICE&n; *&t;command, and read back the 512-byte device information page.&n; *&t;The device information page is fed to us via the standard&n; *&t;PIO-IN protocol, but we hand-code it here. (TODO: investigate&n; *&t;using standard PIO-IN paths)&n; *&n; *&t;After reading the device information page, we use several&n; *&t;bits of information from it to initialize data structures&n; *&t;that will be used during the lifetime of the ata_device.&n; *&t;Other data from the info page is used to disqualify certain&n; *&t;older ATA devices we do not wish to support.&n; *&n; *&t;LOCKING:&n; *&t;Inherited from caller.  Some functions called by this function&n; *&t;obtain the host_set lock.&n; */
DECL|function|ata_dev_identify
r_static
r_void
id|ata_dev_identify
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
)paren
(brace
r_struct
id|ata_device
op_star
id|dev
op_assign
op_amp
id|ap-&gt;device
(braket
id|device
)braket
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
id|u16
id|tmp
comma
id|udma_modes
suffix:semicolon
id|u8
id|status
suffix:semicolon
r_struct
id|ata_taskfile
id|tf
suffix:semicolon
r_int
r_int
id|using_edd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ata_dev_present
c_func
(paren
id|dev
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER/EXIT (host %u, dev %u) -- nodev&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|device
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
(paren
id|ATA_FLAG_SRST
op_or
id|ATA_FLAG_SATA_RESET
)paren
)paren
id|using_edd
op_assign
l_int|0
suffix:semicolon
r_else
id|using_edd
op_assign
l_int|1
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER, host %u, dev %u&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|device
)paren
suffix:semicolon
m_assert
(paren
id|dev
op_member_access_from_pointer
r_class
op_eq
id|ATA_DEV_ATA
op_logical_or
id|dev
op_member_access_from_pointer
r_class
op_eq
id|ATA_DEV_ATAPI
op_logical_or
id|dev
op_member_access_from_pointer
r_class
op_eq
id|ATA_DEV_NONE
)paren
suffix:semicolon
id|ata_dev_select
c_func
(paren
id|ap
comma
id|device
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* select device 0/1 */
id|retry
suffix:colon
id|ata_tf_init
c_func
(paren
id|ap
comma
op_amp
id|tf
comma
id|device
)paren
suffix:semicolon
id|tf.ctl
op_or_assign
id|ATA_NIEN
suffix:semicolon
id|tf.protocol
op_assign
id|ATA_PROT_PIO_READ
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_member_access_from_pointer
r_class
op_eq
id|ATA_DEV_ATA
)paren
(brace
id|tf.command
op_assign
id|ATA_CMD_ID_ATA
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;do ATA identify&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|tf.command
op_assign
id|ATA_CMD_ID_ATAPI
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;do ATAPI identify&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ata_tf_to_host
c_func
(paren
id|ap
comma
op_amp
id|tf
)paren
suffix:semicolon
multiline_comment|/* crazy ATAPI devices... */
r_if
c_cond
(paren
id|dev
op_member_access_from_pointer
r_class
op_eq
id|ATA_DEV_ATAPI
)paren
id|msleep
c_func
(paren
l_int|150
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ata_busy_sleep
c_func
(paren
id|ap
comma
id|ATA_TMOUT_BOOT_QUICK
comma
id|ATA_TMOUT_BOOT
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|status
op_assign
id|ata_chk_status
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ATA_ERR
)paren
(brace
multiline_comment|/*&n;&t;&t; * arg!  EDD works for all test cases, but seems to return&n;&t;&t; * the ATA signature for some ATAPI devices.  Until the&n;&t;&t; * reason for this is found and fixed, we fix up the mess&n;&t;&t; * here.  If IDENTIFY DEVICE returns command aborted&n;&t;&t; * (as ATAPI devices do), then we issue an&n;&t;&t; * IDENTIFY PACKET DEVICE.&n;&t;&t; *&n;&t;&t; * ATA software reset (SRST, the default) does not appear&n;&t;&t; * to have this problem.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|using_edd
)paren
op_logical_and
(paren
id|tf.command
op_eq
id|ATA_CMD_ID_ATA
)paren
)paren
(brace
id|u8
id|err
op_assign
id|ata_chk_err
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_amp
id|ATA_ABORTED
)paren
(brace
id|dev
op_member_access_from_pointer
r_class
op_assign
id|ATA_DEV_ATAPI
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
)brace
r_goto
id|err_out
suffix:semicolon
)brace
multiline_comment|/* make sure we have BSY=0, DRQ=1 */
r_if
c_cond
(paren
(paren
id|status
op_amp
id|ATA_DRQ
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ata%u: dev %u (ATA%s?) not returning id page (0x%x)&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|device
comma
id|dev
op_member_access_from_pointer
r_class
op_eq
id|ATA_DEV_ATA
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;PI&quot;
comma
id|status
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
multiline_comment|/* read IDENTIFY [X] DEVICE page */
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_MMIO
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ATA_ID_WORDS
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;id
(braket
id|i
)braket
op_assign
id|readw
c_func
(paren
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.data_addr
)paren
suffix:semicolon
)brace
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ATA_ID_WORDS
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;id
(braket
id|i
)braket
op_assign
id|inw
c_func
(paren
id|ap-&gt;ioaddr.data_addr
)paren
suffix:semicolon
multiline_comment|/* wait for host_idle */
id|status
op_assign
id|ata_wait_idle
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|ATA_BUSY
op_or
id|ATA_DRQ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ata%u: dev %u (ATA%s?) error after id page (0x%x)&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|device
comma
id|dev
op_member_access_from_pointer
r_class
op_eq
id|ATA_DEV_ATA
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;PI&quot;
comma
id|status
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|ata_irq_on
c_func
(paren
id|ap
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupts */
multiline_comment|/* print device capabilities */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ata%u: dev %u cfg &quot;
l_string|&quot;49:%04x 82:%04x 83:%04x 84:%04x 85:%04x 86:%04x 87:%04x 88:%04x&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|device
comma
id|dev-&gt;id
(braket
l_int|49
)braket
comma
id|dev-&gt;id
(braket
l_int|82
)braket
comma
id|dev-&gt;id
(braket
l_int|83
)braket
comma
id|dev-&gt;id
(braket
l_int|84
)braket
comma
id|dev-&gt;id
(braket
l_int|85
)braket
comma
id|dev-&gt;id
(braket
l_int|86
)braket
comma
id|dev-&gt;id
(braket
l_int|87
)braket
comma
id|dev-&gt;id
(braket
l_int|88
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * common ATA, ATAPI feature tests&n;&t; */
multiline_comment|/* we require LBA and DMA support (bits 8 &amp; 9 of word 49) */
r_if
c_cond
(paren
op_logical_neg
id|ata_id_has_dma
c_func
(paren
id|dev
)paren
op_logical_or
op_logical_neg
id|ata_id_has_lba
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ata%u: no dma/lba&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
r_goto
id|err_out_nosup
suffix:semicolon
)brace
multiline_comment|/* we require UDMA support */
id|udma_modes
op_assign
id|tmp
op_assign
id|dev-&gt;id
(braket
id|ATA_ID_UDMA_MODES
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0xff
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ata%u: no udma&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
r_goto
id|err_out_nosup
suffix:semicolon
)brace
id|ata_dump_id
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ata_dev_parse_strings
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* ATA-specific feature tests */
r_if
c_cond
(paren
id|dev
op_member_access_from_pointer
r_class
op_eq
id|ATA_DEV_ATA
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ata_id_is_ata
c_func
(paren
id|dev
)paren
)paren
multiline_comment|/* sanity check */
r_goto
id|err_out_nosup
suffix:semicolon
id|tmp
op_assign
id|dev-&gt;id
(braket
id|ATA_ID_MAJOR_VER
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|14
suffix:semicolon
id|i
op_ge
l_int|1
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
id|tmp
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* we require at least ATA-3 */
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ata%u: no ATA-3&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
r_goto
id|err_out_nosup
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ata_id_has_lba48
c_func
(paren
id|dev
)paren
)paren
(brace
id|dev-&gt;flags
op_or_assign
id|ATA_DFLAG_LBA48
suffix:semicolon
id|dev-&gt;n_sectors
op_assign
id|ata_id_u64
c_func
(paren
id|dev
comma
l_int|100
)paren
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;n_sectors
op_assign
id|ata_id_u32
c_func
(paren
id|dev
comma
l_int|60
)paren
suffix:semicolon
)brace
id|ap-&gt;host-&gt;max_cmd_len
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* print device info to dmesg */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ata%u: dev %u ATA, max %s, %Lu sectors%s&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|device
comma
id|ata_udma_string
c_func
(paren
id|udma_modes
)paren
comma
id|dev-&gt;n_sectors
comma
id|dev-&gt;flags
op_amp
id|ATA_DFLAG_LBA48
ques
c_cond
l_string|&quot; (lba48)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* ATAPI-specific feature tests */
r_else
(brace
r_if
c_cond
(paren
id|ata_id_is_ata
c_func
(paren
id|dev
)paren
)paren
multiline_comment|/* sanity check */
r_goto
id|err_out_nosup
suffix:semicolon
multiline_comment|/* see if 16-byte commands supported */
id|tmp
op_assign
id|dev-&gt;id
(braket
l_int|0
)braket
op_amp
l_int|0x3
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_eq
l_int|1
)paren
id|ap-&gt;host-&gt;max_cmd_len
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* print device info to dmesg */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ata%u: dev %u ATAPI, max %s&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|device
comma
id|ata_udma_string
c_func
(paren
id|udma_modes
)paren
)paren
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, drv_stat = 0x%x&bslash;n&quot;
comma
id|ata_chk_status
c_func
(paren
id|ap
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
id|err_out_nosup
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ata%u: dev %u not supported, ignoring&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|device
)paren
suffix:semicolon
id|err_out
suffix:colon
id|ata_irq_on
c_func
(paren
id|ap
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupts */
id|dev
op_member_access_from_pointer
r_class
op_increment
suffix:semicolon
multiline_comment|/* converts ATA_DEV_xxx into ATA_DEV_xxx_UNSUP */
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, err&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_port_reset -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_port_reset
r_static
r_void
id|ata_port_reset
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_int
r_int
id|i
comma
id|found
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|phy_reset
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
r_goto
id|err_out
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ATA_MAX_DEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ata_dev_identify
c_func
(paren
id|ap
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ata_dev_present
c_func
(paren
op_amp
id|ap-&gt;device
(braket
id|i
)braket
)paren
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;ops-&gt;dev_config
)paren
id|ap-&gt;ops
op_member_access_from_pointer
id|dev_config
c_func
(paren
id|ap
comma
op_amp
id|ap-&gt;device
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|found
)paren
op_logical_or
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
)paren
r_goto
id|err_out_disable
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|phy_config
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
r_goto
id|err_out_disable
suffix:semicolon
id|ap-&gt;thr_state
op_assign
id|THR_PROBE_SUCCESS
suffix:semicolon
r_return
suffix:semicolon
id|err_out_disable
suffix:colon
id|ap-&gt;ops
op_member_access_from_pointer
id|port_disable
c_func
(paren
id|ap
)paren
suffix:semicolon
id|err_out
suffix:colon
id|ap-&gt;thr_state
op_assign
id|THR_PROBE_FAILED
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_port_probe -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_port_probe
r_void
id|ata_port_probe
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
id|ap-&gt;flags
op_and_assign
op_complement
id|ATA_FLAG_PORT_DISABLED
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;sata_phy_reset -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|sata_phy_reset
r_void
id|sata_phy_reset
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
id|u32
id|sstatus
suffix:semicolon
r_int
r_int
id|timeout
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_SATA_RESET
)paren
(brace
id|scr_write
c_func
(paren
id|ap
comma
id|SCR_CONTROL
comma
l_int|0x301
)paren
suffix:semicolon
multiline_comment|/* issue phy wake/reset */
id|scr_read
c_func
(paren
id|ap
comma
id|SCR_STATUS
)paren
suffix:semicolon
multiline_comment|/* dummy read; flush */
id|udelay
c_func
(paren
l_int|400
)paren
suffix:semicolon
multiline_comment|/* FIXME: a guess */
)brace
id|scr_write
c_func
(paren
id|ap
comma
id|SCR_CONTROL
comma
l_int|0x300
)paren
suffix:semicolon
multiline_comment|/* issue phy wake/clear reset */
multiline_comment|/* wait for phy to become ready, if necessary */
r_do
(brace
id|msleep
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|sstatus
op_assign
id|scr_read
c_func
(paren
id|ap
comma
id|SCR_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sstatus
op_amp
l_int|0xf
)paren
op_ne
l_int|1
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
suffix:semicolon
multiline_comment|/* TODO: phy layer with polling, timeouts, etc. */
r_if
c_cond
(paren
id|sata_dev_present
c_func
(paren
id|ap
)paren
)paren
id|ata_port_probe
c_func
(paren
id|ap
)paren
suffix:semicolon
r_else
(brace
id|sstatus
op_assign
id|scr_read
c_func
(paren
id|ap
comma
id|SCR_STATUS
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ata%u: no device found (phy stat %08x)&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|sstatus
)paren
suffix:semicolon
id|ata_port_disable
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ata_busy_sleep
c_func
(paren
id|ap
comma
id|ATA_TMOUT_BOOT_QUICK
comma
id|ATA_TMOUT_BOOT
)paren
)paren
(brace
id|ata_port_disable
c_func
(paren
id|ap
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ata_bus_reset
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_port_disable -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_port_disable
r_void
id|ata_port_disable
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
id|ap-&gt;device
(braket
l_int|0
)braket
dot
r_class
op_assign
id|ATA_DEV_NONE
suffix:semicolon
id|ap-&gt;device
(braket
l_int|1
)braket
dot
r_class
op_assign
id|ATA_DEV_NONE
suffix:semicolon
id|ap-&gt;flags
op_or_assign
id|ATA_FLAG_PORT_DISABLED
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;pata_phy_config -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|pata_phy_config
r_void
id|pata_phy_config
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_int
r_int
id|force_pio
suffix:semicolon
id|ata_host_set_pio
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
r_return
suffix:semicolon
id|ata_host_set_udma
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
r_return
suffix:semicolon
macro_line|#ifdef ATA_FORCE_PIO
id|force_pio
op_assign
l_int|1
suffix:semicolon
macro_line|#else
id|force_pio
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|force_pio
)paren
(brace
id|ata_dev_set_pio
c_func
(paren
id|ap
comma
l_int|0
)paren
suffix:semicolon
id|ata_dev_set_pio
c_func
(paren
id|ap
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
r_return
suffix:semicolon
)brace
r_else
(brace
id|ata_dev_set_udma
c_func
(paren
id|ap
comma
l_int|0
)paren
suffix:semicolon
id|ata_dev_set_udma
c_func
(paren
id|ap
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;ata_busy_sleep - sleep until BSY clears, or timeout&n; *&t;@ap: port containing status register to be polled&n; *&t;@tmout_pat: impatience timeout&n; *&t;@tmout: overall timeout&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|ata_busy_sleep
r_static
r_int
r_int
id|ata_busy_sleep
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|tmout_pat
comma
r_int
r_int
id|tmout
)paren
(brace
r_int
r_int
id|timer_start
comma
id|timeout
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|status
op_assign
id|ata_busy_wait
c_func
(paren
id|ap
comma
id|ATA_BUSY
comma
l_int|300
)paren
suffix:semicolon
id|timer_start
op_assign
id|jiffies
suffix:semicolon
id|timeout
op_assign
id|timer_start
op_plus
id|tmout_pat
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_amp
id|ATA_BUSY
)paren
op_logical_and
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
)paren
(brace
id|msleep
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|status
op_assign
id|ata_busy_wait
c_func
(paren
id|ap
comma
id|ATA_BUSY
comma
l_int|3
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|ATA_BUSY
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ata%u is slow to respond, &quot;
l_string|&quot;please be patient&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
id|timeout
op_assign
id|timer_start
op_plus
id|tmout
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_amp
id|ATA_BUSY
)paren
op_logical_and
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
)paren
(brace
id|msleep
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|status
op_assign
id|ata_chk_status
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|ATA_BUSY
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%u failed to respond (%lu secs)&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|tmout
op_div
id|HZ
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ata_bus_post_reset
r_static
r_void
id|ata_bus_post_reset
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|devmask
)paren
(brace
r_struct
id|ata_ioports
op_star
id|ioaddr
op_assign
op_amp
id|ap-&gt;ioaddr
suffix:semicolon
r_int
r_int
id|dev0
op_assign
id|devmask
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
r_int
r_int
id|dev1
op_assign
id|devmask
op_amp
(paren
l_int|1
op_lshift
l_int|1
)paren
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
multiline_comment|/* if device 0 was found in ata_dev_devchk, wait for its&n;&t; * BSY bit to clear&n;&t; */
r_if
c_cond
(paren
id|dev0
)paren
id|ata_busy_sleep
c_func
(paren
id|ap
comma
id|ATA_TMOUT_BOOT_QUICK
comma
id|ATA_TMOUT_BOOT
)paren
suffix:semicolon
multiline_comment|/* if device 1 was found in ata_dev_devchk, wait for&n;&t; * register access, then wait for BSY to clear&n;&t; */
id|timeout
op_assign
id|jiffies
op_plus
id|ATA_TMOUT_BOOT
suffix:semicolon
r_while
c_loop
(paren
id|dev1
)paren
(brace
id|u8
id|nsect
comma
id|lbal
suffix:semicolon
id|__ata_dev_select
c_func
(paren
id|ap
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_MMIO
)paren
(brace
id|nsect
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|lbal
op_assign
id|readb
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|nsect
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;nsect_addr
)paren
suffix:semicolon
id|lbal
op_assign
id|inb
c_func
(paren
id|ioaddr-&gt;lbal_addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|nsect
op_eq
l_int|1
)paren
op_logical_and
(paren
id|lbal
op_eq
l_int|1
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|dev1
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|msleep
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* give drive a breather */
)brace
r_if
c_cond
(paren
id|dev1
)paren
id|ata_busy_sleep
c_func
(paren
id|ap
comma
id|ATA_TMOUT_BOOT_QUICK
comma
id|ATA_TMOUT_BOOT
)paren
suffix:semicolon
multiline_comment|/* is all this really necessary? */
id|__ata_dev_select
c_func
(paren
id|ap
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev1
)paren
id|__ata_dev_select
c_func
(paren
id|ap
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev0
)paren
id|__ata_dev_select
c_func
(paren
id|ap
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_bus_edd -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|ata_bus_edd
r_static
r_int
r_int
id|ata_bus_edd
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|ata_taskfile
id|tf
suffix:semicolon
multiline_comment|/* set up execute-device-diag (bus reset) taskfile */
multiline_comment|/* also, take interrupts to a known state (disabled) */
id|DPRINTK
c_func
(paren
l_string|&quot;execute-device-diag&bslash;n&quot;
)paren
suffix:semicolon
id|ata_tf_init
c_func
(paren
id|ap
comma
op_amp
id|tf
comma
l_int|0
)paren
suffix:semicolon
id|tf.ctl
op_or_assign
id|ATA_NIEN
suffix:semicolon
id|tf.command
op_assign
id|ATA_CMD_EDD
suffix:semicolon
id|tf.protocol
op_assign
id|ATA_PROT_NODATA
suffix:semicolon
multiline_comment|/* do bus reset */
id|ata_tf_to_host
c_func
(paren
id|ap
comma
op_amp
id|tf
)paren
suffix:semicolon
multiline_comment|/* spec says at least 2ms.  but who knows with those&n;&t; * crazy ATAPI devices...&n;&t; */
id|msleep
c_func
(paren
l_int|150
)paren
suffix:semicolon
r_return
id|ata_busy_sleep
c_func
(paren
id|ap
comma
id|ATA_TMOUT_BOOT_QUICK
comma
id|ATA_TMOUT_BOOT
)paren
suffix:semicolon
)brace
DECL|function|ata_bus_softreset
r_static
r_int
r_int
id|ata_bus_softreset
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|devmask
)paren
(brace
r_struct
id|ata_ioports
op_star
id|ioaddr
op_assign
op_amp
id|ap-&gt;ioaddr
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ata%u: bus reset via SRST&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
multiline_comment|/* software reset.  causes dev0 to be selected */
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_MMIO
)paren
(brace
id|writeb
c_func
(paren
id|ap-&gt;ctl
comma
id|ioaddr-&gt;ctl_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* FIXME: flush */
id|writeb
c_func
(paren
id|ap-&gt;ctl
op_or
id|ATA_SRST
comma
id|ioaddr-&gt;ctl_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* FIXME: flush */
id|writeb
c_func
(paren
id|ap-&gt;ctl
comma
id|ioaddr-&gt;ctl_addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|outb
c_func
(paren
id|ap-&gt;ctl
comma
id|ioaddr-&gt;ctl_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ap-&gt;ctl
op_or
id|ATA_SRST
comma
id|ioaddr-&gt;ctl_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ap-&gt;ctl
comma
id|ioaddr-&gt;ctl_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* spec mandates &quot;&gt;= 2ms&quot; before checking status.&n;&t; * We wait 150ms, because that was the magic delay used for&n;&t; * ATAPI devices in Hale Landis&squot;s ATADRVR, for the period of time&n;&t; * between when the ATA command register is written, and then&n;&t; * status is checked.  Because waiting for &quot;a while&quot; before&n;&t; * checking status is fine, post SRST, we perform this magic&n;&t; * delay here as well.&n;&t; */
id|msleep
c_func
(paren
l_int|150
)paren
suffix:semicolon
id|ata_bus_post_reset
c_func
(paren
id|ap
comma
id|devmask
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_bus_reset - reset host port and associated ATA channel&n; *&t;@ap: port to reset&n; *&n; *&t;This is typically the first time we actually start issuing&n; *&t;commands to the ATA channel.  We wait for BSY to clear, then&n; *&t;issue EXECUTE DEVICE DIAGNOSTIC command, polling for its&n; *&t;result.  Determine what devices, if any, are on the channel&n; *&t;by looking at the device 0/1 error register.  Look at the signature&n; *&t;stored in each device&squot;s taskfile registers, to determine if&n; *&t;the device is ATA or ATAPI.&n; *&n; *&t;LOCKING:&n; *&t;Inherited from caller.  Some functions called by this function&n; *&t;obtain the host_set lock.&n; *&n; *&t;SIDE EFFECTS:&n; *&t;Sets ATA_FLAG_PORT_DISABLED if bus reset fails.&n; */
DECL|function|ata_bus_reset
r_void
id|ata_bus_reset
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|ata_ioports
op_star
id|ioaddr
op_assign
op_amp
id|ap-&gt;ioaddr
suffix:semicolon
r_int
r_int
id|slave_possible
op_assign
id|ap-&gt;flags
op_amp
id|ATA_FLAG_SLAVE_POSS
suffix:semicolon
id|u8
id|err
suffix:semicolon
r_int
r_int
id|dev0
comma
id|dev1
op_assign
l_int|0
comma
id|rc
op_assign
l_int|0
comma
id|devmask
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER, host %u, port %u&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|ap-&gt;port_no
)paren
suffix:semicolon
multiline_comment|/* set up device control */
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_MMIO
)paren
id|writeb
c_func
(paren
id|ap-&gt;ctl
comma
id|ioaddr-&gt;ctl_addr
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
id|ap-&gt;ctl
comma
id|ioaddr-&gt;ctl_addr
)paren
suffix:semicolon
multiline_comment|/* determine if device 0/1 are present */
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_SATA_RESET
)paren
id|dev0
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|dev0
op_assign
id|ata_dev_devchk
c_func
(paren
id|ap
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slave_possible
)paren
id|dev1
op_assign
id|ata_dev_devchk
c_func
(paren
id|ap
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev0
)paren
id|devmask
op_or_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev1
)paren
id|devmask
op_or_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* select device 0 again */
id|__ata_dev_select
c_func
(paren
id|ap
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* issue bus reset */
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_SRST
)paren
id|rc
op_assign
id|ata_bus_softreset
c_func
(paren
id|ap
comma
id|devmask
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_SATA_RESET
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
id|ata_bus_edd
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out
suffix:semicolon
multiline_comment|/*&n;&t; * determine by signature whether we have ATA or ATAPI devices&n;&t; */
id|err
op_assign
id|ata_dev_try_classify
c_func
(paren
id|ap
comma
l_int|0
comma
id|dev0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|slave_possible
)paren
op_logical_and
(paren
id|err
op_ne
l_int|0x81
)paren
)paren
id|ata_dev_try_classify
c_func
(paren
id|ap
comma
l_int|1
comma
id|dev1
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupts */
id|ata_irq_on
c_func
(paren
id|ap
)paren
suffix:semicolon
multiline_comment|/* is double-select really necessary? */
r_if
c_cond
(paren
id|ap-&gt;device
(braket
l_int|1
)braket
dot
r_class
op_ne
id|ATA_DEV_NONE
)paren
id|__ata_dev_select
c_func
(paren
id|ap
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;device
(braket
l_int|0
)braket
dot
r_class
op_ne
id|ATA_DEV_NONE
)paren
id|__ata_dev_select
c_func
(paren
id|ap
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* if no devices were detected, disable this port */
r_if
c_cond
(paren
(paren
id|ap-&gt;device
(braket
l_int|0
)braket
dot
r_class
op_eq
id|ATA_DEV_NONE
)paren
op_logical_and
(paren
id|ap-&gt;device
(braket
l_int|1
)braket
dot
r_class
op_eq
id|ATA_DEV_NONE
)paren
)paren
r_goto
id|err_out
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
id|err_out
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%u: disabling port&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|port_disable
c_func
(paren
id|ap
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_host_set_pio -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_host_set_pio
r_static
r_void
id|ata_host_set_pio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|ata_device
op_star
id|master
comma
op_star
id|slave
suffix:semicolon
r_int
r_int
id|pio
comma
id|i
suffix:semicolon
id|u16
id|mask
suffix:semicolon
id|master
op_assign
op_amp
id|ap-&gt;device
(braket
l_int|0
)braket
suffix:semicolon
id|slave
op_assign
op_amp
id|ap-&gt;device
(braket
l_int|1
)braket
suffix:semicolon
m_assert
(paren
id|ata_dev_present
c_func
(paren
id|master
)paren
op_logical_or
id|ata_dev_present
c_func
(paren
id|slave
)paren
)paren
suffix:semicolon
id|mask
op_assign
id|ap-&gt;pio_mask
suffix:semicolon
r_if
c_cond
(paren
id|ata_dev_present
c_func
(paren
id|master
)paren
)paren
id|mask
op_and_assign
(paren
id|master-&gt;id
(braket
id|ATA_ID_PIO_MODES
)braket
op_amp
l_int|0x03
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ata_dev_present
c_func
(paren
id|slave
)paren
)paren
id|mask
op_and_assign
(paren
id|slave-&gt;id
(braket
id|ATA_ID_PIO_MODES
)braket
op_amp
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* require pio mode 3 or 4 support for host and all devices */
r_if
c_cond
(paren
id|mask
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ata%u: no PIO3/4 support, ignoring&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|pio
op_assign
(paren
id|mask
op_amp
id|ATA_ID_PIO4
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|3
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ATA_MAX_DEVICES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ata_dev_present
c_func
(paren
op_amp
id|ap-&gt;device
(braket
id|i
)braket
)paren
)paren
(brace
id|ap-&gt;device
(braket
id|i
)braket
dot
id|pio_mode
op_assign
(paren
id|pio
op_eq
l_int|3
)paren
ques
c_cond
id|XFER_PIO_3
suffix:colon
id|XFER_PIO_4
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|set_piomode
c_func
(paren
id|ap
comma
op_amp
id|ap-&gt;device
(braket
id|i
)braket
comma
id|pio
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|err_out
suffix:colon
id|ap-&gt;ops
op_member_access_from_pointer
id|port_disable
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_host_set_udma -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_host_set_udma
r_static
r_void
id|ata_host_set_udma
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|ata_device
op_star
id|master
comma
op_star
id|slave
suffix:semicolon
id|u16
id|mask
suffix:semicolon
r_int
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|udma_mode
op_assign
op_minus
l_int|1
suffix:semicolon
id|master
op_assign
op_amp
id|ap-&gt;device
(braket
l_int|0
)braket
suffix:semicolon
id|slave
op_assign
op_amp
id|ap-&gt;device
(braket
l_int|1
)braket
suffix:semicolon
m_assert
(paren
id|ata_dev_present
c_func
(paren
id|master
)paren
op_logical_or
id|ata_dev_present
c_func
(paren
id|slave
)paren
)paren
suffix:semicolon
m_assert
(paren
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;udma masks: host 0x%X, master 0x%X, slave 0x%X&bslash;n&quot;
comma
id|ap-&gt;udma_mask
comma
(paren
op_logical_neg
id|ata_dev_present
c_func
(paren
id|master
)paren
)paren
ques
c_cond
l_int|0xff
suffix:colon
(paren
id|master-&gt;id
(braket
id|ATA_ID_UDMA_MODES
)braket
op_amp
l_int|0xff
)paren
comma
(paren
op_logical_neg
id|ata_dev_present
c_func
(paren
id|slave
)paren
)paren
ques
c_cond
l_int|0xff
suffix:colon
(paren
id|slave-&gt;id
(braket
id|ATA_ID_UDMA_MODES
)braket
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|mask
op_assign
id|ap-&gt;udma_mask
suffix:semicolon
r_if
c_cond
(paren
id|ata_dev_present
c_func
(paren
id|master
)paren
)paren
id|mask
op_and_assign
(paren
id|master-&gt;id
(braket
id|ATA_ID_UDMA_MODES
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ata_dev_present
c_func
(paren
id|slave
)paren
)paren
id|mask
op_and_assign
(paren
id|slave-&gt;id
(braket
id|ATA_ID_UDMA_MODES
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
id|i
op_assign
id|XFER_UDMA_7
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ge
id|XFER_UDMA_0
)paren
(brace
id|j
op_assign
id|i
op_minus
id|XFER_UDMA_0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;mask 0x%X i 0x%X j %u&bslash;n&quot;
comma
id|mask
comma
id|i
comma
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
id|udma_mode
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
id|i
op_decrement
suffix:semicolon
)brace
multiline_comment|/* require udma for host and all attached devices */
r_if
c_cond
(paren
id|udma_mode
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ata%u: no UltraDMA support, ignoring&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ATA_MAX_DEVICES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ata_dev_present
c_func
(paren
op_amp
id|ap-&gt;device
(braket
id|i
)braket
)paren
)paren
(brace
id|ap-&gt;device
(braket
id|i
)braket
dot
id|udma_mode
op_assign
id|udma_mode
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|set_udmamode
c_func
(paren
id|ap
comma
op_amp
id|ap-&gt;device
(braket
id|i
)braket
comma
id|udma_mode
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
id|err_out
suffix:colon
id|ap-&gt;ops
op_member_access_from_pointer
id|port_disable
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_dev_set_xfermode -&n; *&t;@ap:&n; *&t;@dev:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_dev_set_xfermode
r_static
r_void
id|ata_dev_set_xfermode
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_device
op_star
id|dev
)paren
(brace
r_struct
id|ata_taskfile
id|tf
suffix:semicolon
multiline_comment|/* set up set-features taskfile */
id|DPRINTK
c_func
(paren
l_string|&quot;set features - xfer mode&bslash;n&quot;
)paren
suffix:semicolon
id|ata_tf_init
c_func
(paren
id|ap
comma
op_amp
id|tf
comma
id|dev-&gt;devno
)paren
suffix:semicolon
id|tf.ctl
op_or_assign
id|ATA_NIEN
suffix:semicolon
id|tf.command
op_assign
id|ATA_CMD_SET_FEATURES
suffix:semicolon
id|tf.feature
op_assign
id|SETFEATURES_XFER
suffix:semicolon
id|tf.flags
op_or_assign
id|ATA_TFLAG_ISADDR
op_or
id|ATA_TFLAG_DEVICE
suffix:semicolon
id|tf.protocol
op_assign
id|ATA_PROT_NODATA
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|ATA_DFLAG_PIO
)paren
id|tf.nsect
op_assign
id|dev-&gt;pio_mode
suffix:semicolon
r_else
id|tf.nsect
op_assign
id|dev-&gt;udma_mode
suffix:semicolon
multiline_comment|/* do bus reset */
id|ata_tf_to_host
c_func
(paren
id|ap
comma
op_amp
id|tf
)paren
suffix:semicolon
multiline_comment|/* crazy ATAPI devices... */
r_if
c_cond
(paren
id|dev
op_member_access_from_pointer
r_class
op_eq
id|ATA_DEV_ATAPI
)paren
id|msleep
c_func
(paren
l_int|150
)paren
suffix:semicolon
id|ata_busy_sleep
c_func
(paren
id|ap
comma
id|ATA_TMOUT_BOOT_QUICK
comma
id|ATA_TMOUT_BOOT
)paren
suffix:semicolon
id|ata_irq_on
c_func
(paren
id|ap
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupts */
id|ata_wait_idle
c_func
(paren
id|ap
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_dev_set_udma -&n; *&t;@ap:&n; *&t;@device:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_dev_set_udma
r_static
r_void
id|ata_dev_set_udma
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
)paren
(brace
r_struct
id|ata_device
op_star
id|dev
op_assign
op_amp
id|ap-&gt;device
(braket
id|device
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ata_dev_present
c_func
(paren
id|dev
)paren
op_logical_or
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
)paren
r_return
suffix:semicolon
id|ata_dev_set_xfermode
c_func
(paren
id|ap
comma
id|dev
)paren
suffix:semicolon
m_assert
(paren
(paren
id|dev-&gt;udma_mode
op_ge
id|XFER_UDMA_0
)paren
op_logical_and
(paren
id|dev-&gt;udma_mode
op_le
id|XFER_UDMA_7
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ata%u: dev %u configured for %s&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|device
comma
id|udma_str
(braket
id|dev-&gt;udma_mode
op_minus
id|XFER_UDMA_0
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_dev_set_pio -&n; *&t;@ap:&n; *&t;@device:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_dev_set_pio
r_static
r_void
id|ata_dev_set_pio
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|device
)paren
(brace
r_struct
id|ata_device
op_star
id|dev
op_assign
op_amp
id|ap-&gt;device
(braket
id|device
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ata_dev_present
c_func
(paren
id|dev
)paren
op_logical_or
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* force PIO mode */
id|dev-&gt;flags
op_or_assign
id|ATA_DFLAG_PIO
suffix:semicolon
id|ata_dev_set_xfermode
c_func
(paren
id|ap
comma
id|dev
)paren
suffix:semicolon
m_assert
(paren
(paren
id|dev-&gt;pio_mode
op_ge
id|XFER_PIO_3
)paren
op_logical_and
(paren
id|dev-&gt;pio_mode
op_le
id|XFER_PIO_4
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ata%u: dev %u configured for PIO%c&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|device
comma
id|dev-&gt;pio_mode
op_eq
l_int|3
ques
c_cond
l_char|&squot;3&squot;
suffix:colon
l_char|&squot;4&squot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_sg_clean -&n; *&t;@qc:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_sg_clean
r_static
r_void
id|ata_sg_clean
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|qc-&gt;scsicmd
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
id|qc-&gt;sg
suffix:semicolon
r_int
id|dir
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
m_assert
(paren
id|dir
op_eq
id|SCSI_DATA_READ
op_logical_or
id|dir
op_eq
id|SCSI_DATA_WRITE
)paren
suffix:semicolon
m_assert
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_SG
)paren
suffix:semicolon
m_assert
(paren
id|sg
op_ne
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmd-&gt;use_sg
)paren
m_assert
(paren
id|qc-&gt;n_elem
op_eq
l_int|1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;unmapping %u sg elements&bslash;n&quot;
comma
id|qc-&gt;n_elem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
id|pci_unmap_sg
c_func
(paren
id|ap-&gt;host_set-&gt;pdev
comma
id|sg
comma
id|qc-&gt;n_elem
comma
id|dir
)paren
suffix:semicolon
r_else
id|pci_unmap_single
c_func
(paren
id|ap-&gt;host_set-&gt;pdev
comma
id|sg
(braket
l_int|0
)braket
dot
id|dma_address
comma
id|sg
(braket
l_int|0
)braket
dot
id|length
comma
id|dir
)paren
suffix:semicolon
id|qc-&gt;flags
op_and_assign
op_complement
id|ATA_QCFLAG_SG
suffix:semicolon
id|qc-&gt;sg
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_fill_sg -&n; *&t;@qc:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|ata_fill_sg
r_void
id|ata_fill_sg
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
id|qc-&gt;sg
suffix:semicolon
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
m_assert
(paren
id|sg
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|qc-&gt;n_elem
OG
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|qc-&gt;n_elem
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ap-&gt;prd
(braket
id|i
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|dma_address
)paren
suffix:semicolon
id|ap-&gt;prd
(braket
id|i
)braket
dot
id|flags_len
op_assign
id|cpu_to_le32
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;PRD[%u] = (0x%X, 0x%X)&bslash;n&quot;
comma
id|i
comma
id|le32_to_cpu
c_func
(paren
id|ap-&gt;prd
(braket
id|i
)braket
dot
id|addr
)paren
comma
id|le32_to_cpu
c_func
(paren
id|ap-&gt;prd
(braket
id|i
)braket
dot
id|flags_len
)paren
)paren
suffix:semicolon
)brace
id|ap-&gt;prd
(braket
id|qc-&gt;n_elem
op_minus
l_int|1
)braket
dot
id|flags_len
op_or_assign
id|cpu_to_le32
c_func
(paren
id|ATA_PRD_EOT
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_sg_setup_one -&n; *&t;@qc:&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_sg_setup_one
r_static
r_int
id|ata_sg_setup_one
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|qc-&gt;scsicmd
suffix:semicolon
r_int
id|dir
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
id|qc-&gt;sg
suffix:semicolon
r_int
r_int
id|have_sg
op_assign
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_SG
)paren
suffix:semicolon
m_assert
(paren
id|sg
op_eq
op_amp
id|qc-&gt;sgent
)paren
suffix:semicolon
m_assert
(paren
id|qc-&gt;n_elem
op_eq
l_int|1
)paren
suffix:semicolon
id|sg-&gt;page
op_assign
id|virt_to_page
c_func
(paren
id|cmd-&gt;request_buffer
)paren
suffix:semicolon
id|sg-&gt;offset
op_assign
(paren
r_int
r_int
)paren
id|cmd-&gt;request_buffer
op_amp
op_complement
id|PAGE_MASK
suffix:semicolon
id|sg-&gt;length
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|have_sg
)paren
r_return
l_int|0
suffix:semicolon
id|sg-&gt;dma_address
op_assign
id|pci_map_single
c_func
(paren
id|ap-&gt;host_set-&gt;pdev
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;request_bufflen
comma
id|dir
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;mapped buffer of %d bytes for %s&bslash;n&quot;
comma
id|cmd-&gt;request_bufflen
comma
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_WRITE
ques
c_cond
l_string|&quot;write&quot;
suffix:colon
l_string|&quot;read&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_sg_setup -&n; *&t;@qc:&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_sg_setup
r_static
r_int
id|ata_sg_setup
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|qc-&gt;scsicmd
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|n_elem
suffix:semicolon
r_int
r_int
id|have_sg
op_assign
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_SG
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER, ata%u, use_sg %d&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|cmd-&gt;use_sg
)paren
suffix:semicolon
m_assert
(paren
id|cmd-&gt;use_sg
OG
l_int|0
)paren
suffix:semicolon
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|have_sg
)paren
(brace
r_int
id|dir
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|n_elem
op_assign
id|pci_map_sg
c_func
(paren
id|ap-&gt;host_set-&gt;pdev
comma
id|sg
comma
id|cmd-&gt;use_sg
comma
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n_elem
OL
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;%d sg elements mapped&bslash;n&quot;
comma
id|n_elem
)paren
suffix:semicolon
)brace
r_else
(brace
id|n_elem
op_assign
id|cmd-&gt;use_sg
suffix:semicolon
)brace
id|qc-&gt;n_elem
op_assign
id|n_elem
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_pio_poll -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_pio_poll
r_static
r_int
r_int
id|ata_pio_poll
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
id|u8
id|status
suffix:semicolon
r_int
r_int
id|poll_state
op_assign
id|THR_UNKNOWN
suffix:semicolon
r_int
r_int
id|reg_state
op_assign
id|THR_UNKNOWN
suffix:semicolon
r_const
r_int
r_int
id|tmout_state
op_assign
id|THR_PIO_TMOUT
suffix:semicolon
r_switch
c_cond
(paren
id|ap-&gt;thr_state
)paren
(brace
r_case
id|THR_PIO
suffix:colon
r_case
id|THR_PIO_POLL
suffix:colon
id|poll_state
op_assign
id|THR_PIO_POLL
suffix:semicolon
id|reg_state
op_assign
id|THR_PIO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_PIO_LAST
suffix:colon
r_case
id|THR_PIO_LAST_POLL
suffix:colon
id|poll_state
op_assign
id|THR_PIO_LAST_POLL
suffix:semicolon
id|reg_state
op_assign
id|THR_PIO_LAST
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|status
op_assign
id|ata_chk_status
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ATA_BUSY
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|ap-&gt;thr_timeout
)paren
)paren
(brace
id|ap-&gt;thr_state
op_assign
id|tmout_state
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ap-&gt;thr_state
op_assign
id|poll_state
suffix:semicolon
r_return
id|ATA_SHORT_PAUSE
suffix:semicolon
)brace
id|ap-&gt;thr_state
op_assign
id|reg_state
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_pio_start -&n; *&t;@qc:&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_pio_start
r_static
r_void
id|ata_pio_start
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
m_assert
(paren
(paren
id|qc-&gt;tf.protocol
op_eq
id|ATA_PROT_PIO_READ
)paren
op_logical_or
(paren
id|qc-&gt;tf.protocol
op_eq
id|ATA_PROT_PIO_WRITE
)paren
)paren
suffix:semicolon
id|qc-&gt;flags
op_or_assign
id|ATA_QCFLAG_POLL
suffix:semicolon
id|qc-&gt;tf.ctl
op_or_assign
id|ATA_NIEN
suffix:semicolon
multiline_comment|/* disable interrupts */
id|ata_tf_to_host_nolock
c_func
(paren
id|ap
comma
op_amp
id|qc-&gt;tf
)paren
suffix:semicolon
id|ata_thread_wake
c_func
(paren
id|ap
comma
id|THR_PIO
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_pio_complete -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_pio_complete
r_static
r_void
id|ata_pio_complete
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u8
id|drv_stat
suffix:semicolon
multiline_comment|/*&n;&t; * This is purely hueristic.  This is a fast path.&n;&t; * Sometimes when we enter, BSY will be cleared in&n;&t; * a chk-status or two.  If not, the drive is probably seeking&n;&t; * or something.  Snooze for a couple msecs, then&n;&t; * chk-status again.  If still busy, fall back to&n;&t; * THR_PIO_POLL state.&n;&t; */
id|drv_stat
op_assign
id|ata_busy_wait
c_func
(paren
id|ap
comma
id|ATA_BUSY
op_or
id|ATA_DRQ
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drv_stat
op_amp
(paren
id|ATA_BUSY
op_or
id|ATA_DRQ
)paren
)paren
(brace
id|msleep
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|drv_stat
op_assign
id|ata_busy_wait
c_func
(paren
id|ap
comma
id|ATA_BUSY
op_or
id|ATA_DRQ
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drv_stat
op_amp
(paren
id|ATA_BUSY
op_or
id|ATA_DRQ
)paren
)paren
(brace
id|ap-&gt;thr_state
op_assign
id|THR_PIO_LAST_POLL
suffix:semicolon
id|ap-&gt;thr_timeout
op_assign
id|jiffies
op_plus
id|ATA_TMOUT_PIO
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|drv_stat
op_assign
id|ata_wait_idle
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drv_stat
op_amp
(paren
id|ATA_BUSY
op_or
id|ATA_DRQ
)paren
)paren
(brace
id|ap-&gt;thr_state
op_assign
id|THR_PIO_ERR
suffix:semicolon
r_return
suffix:semicolon
)brace
id|qc
op_assign
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|ap-&gt;active_tag
)paren
suffix:semicolon
m_assert
(paren
id|qc
op_ne
l_int|NULL
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ap-&gt;host_set-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ap-&gt;thr_state
op_assign
id|THR_IDLE
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ap-&gt;host_set-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ata_irq_on
c_func
(paren
id|ap
)paren
suffix:semicolon
id|ata_qc_complete
c_func
(paren
id|qc
comma
id|drv_stat
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_pio_sector -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_pio_sector
r_static
r_void
id|ata_pio_sector
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
id|u8
id|status
suffix:semicolon
multiline_comment|/*&n;&t; * This is purely hueristic.  This is a fast path.&n;&t; * Sometimes when we enter, BSY will be cleared in&n;&t; * a chk-status or two.  If not, the drive is probably seeking&n;&t; * or something.  Snooze for a couple msecs, then&n;&t; * chk-status again.  If still busy, fall back to&n;&t; * THR_PIO_POLL state.&n;&t; */
id|status
op_assign
id|ata_busy_wait
c_func
(paren
id|ap
comma
id|ATA_BUSY
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ATA_BUSY
)paren
(brace
id|msleep
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|status
op_assign
id|ata_busy_wait
c_func
(paren
id|ap
comma
id|ATA_BUSY
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|ATA_BUSY
)paren
(brace
id|ap-&gt;thr_state
op_assign
id|THR_PIO_POLL
suffix:semicolon
id|ap-&gt;thr_timeout
op_assign
id|jiffies
op_plus
id|ATA_TMOUT_PIO
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* handle BSY=0, DRQ=0 as error */
r_if
c_cond
(paren
(paren
id|status
op_amp
id|ATA_DRQ
)paren
op_eq
l_int|0
)paren
(brace
id|ap-&gt;thr_state
op_assign
id|THR_PIO_ERR
suffix:semicolon
r_return
suffix:semicolon
)brace
id|qc
op_assign
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|ap-&gt;active_tag
)paren
suffix:semicolon
m_assert
(paren
id|qc
op_ne
l_int|NULL
)paren
suffix:semicolon
id|cmd
op_assign
id|qc-&gt;scsicmd
suffix:semicolon
id|sg
op_assign
id|qc-&gt;sg
suffix:semicolon
r_if
c_cond
(paren
id|qc-&gt;cursect
op_eq
(paren
id|qc-&gt;nsect
op_minus
l_int|1
)paren
)paren
id|ap-&gt;thr_state
op_assign
id|THR_PIO_LAST
suffix:semicolon
id|buf
op_assign
id|kmap
c_func
(paren
id|sg
(braket
id|qc-&gt;cursg
)braket
dot
id|page
)paren
op_plus
id|sg
(braket
id|qc-&gt;cursg
)braket
dot
id|offset
op_plus
(paren
id|qc-&gt;cursg_ofs
op_star
id|ATA_SECT_SIZE
)paren
suffix:semicolon
id|qc-&gt;cursect
op_increment
suffix:semicolon
id|qc-&gt;cursg_ofs
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
r_if
c_cond
(paren
(paren
id|qc-&gt;cursg_ofs
op_star
id|ATA_SECT_SIZE
)paren
op_eq
id|sg
(braket
id|qc-&gt;cursg
)braket
dot
id|length
)paren
(brace
id|qc-&gt;cursg
op_increment
suffix:semicolon
id|qc-&gt;cursg_ofs
op_assign
l_int|0
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;data %s, drv_stat 0x%X&bslash;n&quot;
comma
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_WRITE
ques
c_cond
l_string|&quot;write&quot;
suffix:colon
l_string|&quot;read&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* do the actual data transfer */
multiline_comment|/* FIXME: mmio-ize */
r_if
c_cond
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_WRITE
)paren
id|outsl
c_func
(paren
id|ap-&gt;ioaddr.data_addr
comma
id|buf
comma
id|ATA_SECT_DWORDS
)paren
suffix:semicolon
r_else
id|insl
c_func
(paren
id|ap-&gt;ioaddr.data_addr
comma
id|buf
comma
id|ATA_SECT_DWORDS
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|sg
(braket
id|qc-&gt;cursg
)braket
dot
id|page
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_eng_schedule - run an iteration of the pio/dma/whatever engine&n; *&t;@ap: port on which activity will occur&n; *&t;@eng: instance of engine&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_eng_schedule
r_static
r_void
id|ata_eng_schedule
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_engine
op_star
id|eng
)paren
(brace
multiline_comment|/* FIXME */
)brace
multiline_comment|/**&n; *&t;ata_eng_timeout - Handle timeout of queued command&n; *&t;@ap: Port on which timed-out command is active&n; *&n; *&t;Some part of the kernel (currently, only the SCSI layer)&n; *&t;has noticed that the active command on port @ap has not&n; *&t;completed after a specified length of time.  Handle this&n; *&t;condition by disabling DMA (if necessary) and completing&n; *&t;transactions, with error if necessary.&n; *&n; *&t;This also handles the case of the &quot;lost interrupt&quot;, where&n; *&t;for some reason (possibly hardware bug, possibly driver bug)&n; *&t;an interrupt was not delivered to the driver, even though the&n; *&t;transaction completed successfully.&n; *&n; *&t;LOCKING:&n; *&t;Inherited from SCSI layer (none, can sleep)&n; */
DECL|function|ata_eng_timeout
r_void
id|ata_eng_timeout
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
id|u8
id|host_stat
comma
id|drv_stat
suffix:semicolon
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|qc
op_assign
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|ap-&gt;active_tag
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%u: BUG: timeout without command&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|qc-&gt;tf.protocol
)paren
(brace
r_case
id|ATA_PROT_DMA_READ
suffix:colon
r_case
id|ATA_PROT_DMA_WRITE
suffix:colon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_MMIO
)paren
(brace
r_void
op_star
id|mmio
op_assign
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.bmdma_addr
suffix:semicolon
id|host_stat
op_assign
id|readb
c_func
(paren
id|mmio
op_plus
id|ATA_DMA_STATUS
)paren
suffix:semicolon
)brace
r_else
id|host_stat
op_assign
id|inb
c_func
(paren
id|ap-&gt;ioaddr.bmdma_addr
op_plus
id|ATA_DMA_STATUS
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%u: DMA timeout, stat 0x%x&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|host_stat
)paren
suffix:semicolon
id|ata_dma_complete
c_func
(paren
id|ap
comma
id|host_stat
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATA_PROT_NODATA
suffix:colon
id|drv_stat
op_assign
id|ata_busy_wait
c_func
(paren
id|ap
comma
id|ATA_BUSY
op_or
id|ATA_DRQ
comma
l_int|1000
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%u: command 0x%x timeout, stat 0x%x&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|qc-&gt;tf.command
comma
id|drv_stat
)paren
suffix:semicolon
id|ata_qc_complete
c_func
(paren
id|qc
comma
id|drv_stat
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|drv_stat
op_assign
id|ata_busy_wait
c_func
(paren
id|ap
comma
id|ATA_BUSY
op_or
id|ATA_DRQ
comma
l_int|1000
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%u: unknown timeout, cmd 0x%x stat 0x%x&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|qc-&gt;tf.command
comma
id|drv_stat
)paren
suffix:semicolon
id|ata_qc_complete
c_func
(paren
id|qc
comma
id|drv_stat
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_qc_new -&n; *&t;@ap:&n; *&t;@dev:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_qc_new
r_static
r_struct
id|ata_queued_cmd
op_star
id|ata_qc_new
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ATA_MAX_QUEUE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|i
comma
op_amp
id|ap-&gt;qactive
)paren
)paren
(brace
id|qc
op_assign
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qc
)paren
id|qc-&gt;tag
op_assign
id|i
suffix:semicolon
r_return
id|qc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_qc_new_init -&n; *&t;@ap:&n; *&t;@dev:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_qc_new_init
r_struct
id|ata_queued_cmd
op_star
id|ata_qc_new_init
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_device
op_star
id|dev
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
id|qc
op_assign
id|ata_qc_new
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qc
)paren
(brace
id|qc-&gt;sg
op_assign
l_int|NULL
suffix:semicolon
id|qc-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|qc-&gt;scsicmd
op_assign
l_int|NULL
suffix:semicolon
id|qc-&gt;ap
op_assign
id|ap
suffix:semicolon
id|qc-&gt;dev
op_assign
id|dev
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|qc-&gt;node
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|qc-&gt;sem
)paren
suffix:semicolon
id|ata_tf_init
c_func
(paren
id|ap
comma
op_amp
id|qc-&gt;tf
comma
id|dev-&gt;devno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
(paren
id|dev-&gt;flags
op_amp
id|ATA_DFLAG_PIO
)paren
op_eq
l_int|0
)paren
)paren
id|qc-&gt;flags
op_or_assign
id|ATA_QCFLAG_DMA
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|ATA_DFLAG_LBA48
)paren
id|qc-&gt;tf.flags
op_or_assign
id|ATA_TFLAG_LBA48
suffix:semicolon
)brace
r_return
id|qc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_qc_complete -&n; *&t;@qc:&n; *&t;@drv_stat:&n; *&t;@done_late:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|ata_qc_complete
r_void
id|ata_qc_complete
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
comma
id|u8
id|drv_stat
comma
r_int
r_int
id|done_late
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|qc-&gt;scsicmd
suffix:semicolon
r_int
r_int
id|tag
comma
id|do_clear
op_assign
l_int|0
suffix:semicolon
m_assert
(paren
id|qc
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* ata_qc_from_tag _might_ return NULL */
m_assert
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_ACTIVE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_SG
)paren
)paren
id|ata_sg_clean
c_func
(paren
id|qc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
)paren
(brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|drv_stat
op_amp
(paren
id|ATA_ERR
op_or
id|ATA_BUSY
op_or
id|ATA_DRQ
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_ATAPI
)paren
id|cmd-&gt;result
op_assign
id|SAM_STAT_CHECK_CONDITION
suffix:semicolon
r_else
id|ata_to_sense_error
c_func
(paren
id|qc
)paren
suffix:semicolon
)brace
r_else
(brace
id|cmd-&gt;result
op_assign
id|SAM_STAT_GOOD
suffix:semicolon
)brace
id|qc
op_member_access_from_pointer
id|scsidone
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
id|qc-&gt;flags
op_and_assign
op_complement
id|ATA_QCFLAG_ACTIVE
suffix:semicolon
id|tag
op_assign
id|qc-&gt;tag
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|ata_tag_valid
c_func
(paren
id|tag
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|tag
op_eq
id|ap-&gt;active_tag
)paren
id|ap-&gt;active_tag
op_assign
id|ATA_TAG_POISON
suffix:semicolon
id|qc-&gt;tag
op_assign
id|ATA_TAG_POISON
suffix:semicolon
id|do_clear
op_assign
l_int|1
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|qc-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|do_clear
)paren
)paren
id|clear_bit
c_func
(paren
id|tag
comma
op_amp
id|ap-&gt;qactive
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_qc_push -&n; *&t;@qc:&n; *&t;@append:&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_qc_push
r_static
r_void
id|ata_qc_push
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
comma
r_int
r_int
id|append
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
r_struct
id|ata_engine
op_star
id|eng
op_assign
op_amp
id|ap-&gt;eng
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|append
)paren
)paren
id|list_add_tail
c_func
(paren
op_amp
id|qc-&gt;node
comma
op_amp
id|eng-&gt;q
)paren
suffix:semicolon
r_else
id|list_add
c_func
(paren
op_amp
id|qc-&gt;node
comma
op_amp
id|eng-&gt;q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|ATA_EFLG_ACTIVE
comma
op_amp
id|eng-&gt;flags
)paren
)paren
id|ata_eng_schedule
c_func
(paren
id|ap
comma
id|eng
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_qc_issue -&n; *&t;@qc:&n; *&n; *&t;LOCKING:&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_qc_issue
r_int
id|ata_qc_issue
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|qc-&gt;scsicmd
suffix:semicolon
r_int
r_int
id|dma
op_assign
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_DMA
suffix:semicolon
id|ata_dev_select
c_func
(paren
id|ap
comma
id|qc-&gt;dev-&gt;devno
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set up SG table */
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
r_if
c_cond
(paren
id|ata_sg_setup
c_func
(paren
id|qc
)paren
)paren
r_goto
id|err_out
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ata_sg_setup_one
c_func
(paren
id|qc
)paren
)paren
r_goto
id|err_out
suffix:semicolon
)brace
id|ap-&gt;ops
op_member_access_from_pointer
id|fill_sg
c_func
(paren
id|qc
)paren
suffix:semicolon
id|qc-&gt;ap-&gt;active_tag
op_assign
id|qc-&gt;tag
suffix:semicolon
id|qc-&gt;flags
op_or_assign
id|ATA_QCFLAG_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|dma
)paren
)paren
(brace
id|ap-&gt;ops
op_member_access_from_pointer
id|tf_load
c_func
(paren
id|ap
comma
op_amp
id|qc-&gt;tf
)paren
suffix:semicolon
multiline_comment|/* load tf registers */
id|ap-&gt;ops
op_member_access_from_pointer
id|bmdma_start
c_func
(paren
id|qc
)paren
suffix:semicolon
multiline_comment|/* initiate bmdma */
)brace
r_else
multiline_comment|/* load tf registers, initiate polling pio */
id|ata_pio_start
c_func
(paren
id|qc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_bmdma_start_mmio -&n; *&t;@qc:&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_bmdma_start_mmio
r_void
id|ata_bmdma_start_mmio
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
r_int
r_int
id|rw
op_assign
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_WRITE
)paren
suffix:semicolon
id|u8
id|host_stat
comma
id|dmactl
suffix:semicolon
r_void
op_star
id|mmio
op_assign
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.bmdma_addr
suffix:semicolon
multiline_comment|/* load PRD table addr. */
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* make sure PRD table writes are visible to controller */
id|writel
c_func
(paren
id|ap-&gt;prd_dma
comma
id|mmio
op_plus
id|ATA_DMA_TABLE_OFS
)paren
suffix:semicolon
multiline_comment|/* specify data direction */
multiline_comment|/* FIXME: redundant to later start-dma command? */
id|writeb
c_func
(paren
id|rw
ques
c_cond
l_int|0
suffix:colon
id|ATA_DMA_WR
comma
id|mmio
op_plus
id|ATA_DMA_CMD
)paren
suffix:semicolon
multiline_comment|/* clear interrupt, error bits */
id|host_stat
op_assign
id|readb
c_func
(paren
id|mmio
op_plus
id|ATA_DMA_STATUS
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|host_stat
op_or
id|ATA_DMA_INTR
op_or
id|ATA_DMA_ERR
comma
id|mmio
op_plus
id|ATA_DMA_STATUS
)paren
suffix:semicolon
multiline_comment|/* issue r/w command */
id|ap-&gt;ops
op_member_access_from_pointer
id|exec_command
c_func
(paren
id|ap
comma
op_amp
id|qc-&gt;tf
)paren
suffix:semicolon
multiline_comment|/* start host DMA transaction */
id|dmactl
op_assign
id|readb
c_func
(paren
id|mmio
op_plus
id|ATA_DMA_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|dmactl
op_or
id|ATA_DMA_START
comma
id|mmio
op_plus
id|ATA_DMA_CMD
)paren
suffix:semicolon
multiline_comment|/* Strictly, one may wish to issue a readb() here, to&n;&t; * flush the mmio write.  However, control also passes&n;&t; * to the hardware at this point, and it will interrupt&n;&t; * us when we are to resume control.  So, in effect,&n;&t; * we don&squot;t care when the mmio write flushes.&n;&t; * Further, a read of the DMA status register _immediately_&n;&t; * following the write may not be what certain flaky hardware&n;&t; * is expected, so I think it is best to not add a readb()&n;&t; * without first all the MMIO ATA cards/mobos.&n;&t; * Or maybe I&squot;m just being paranoid.&n;&t; */
)brace
multiline_comment|/**&n; *&t;ata_bmdma_start_pio -&n; *&t;@qc:&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_bmdma_start_pio
r_void
id|ata_bmdma_start_pio
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
r_int
r_int
id|rw
op_assign
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_WRITE
)paren
suffix:semicolon
id|u8
id|host_stat
comma
id|dmactl
suffix:semicolon
multiline_comment|/* load PRD table addr. */
id|outl
c_func
(paren
id|ap-&gt;prd_dma
comma
id|ap-&gt;ioaddr.bmdma_addr
op_plus
id|ATA_DMA_TABLE_OFS
)paren
suffix:semicolon
multiline_comment|/* specify data direction */
multiline_comment|/* FIXME: redundant to later start-dma command? */
id|outb
c_func
(paren
id|rw
ques
c_cond
l_int|0
suffix:colon
id|ATA_DMA_WR
comma
id|ap-&gt;ioaddr.bmdma_addr
op_plus
id|ATA_DMA_CMD
)paren
suffix:semicolon
multiline_comment|/* clear interrupt, error bits */
id|host_stat
op_assign
id|inb
c_func
(paren
id|ap-&gt;ioaddr.bmdma_addr
op_plus
id|ATA_DMA_STATUS
)paren
suffix:semicolon
id|outb
c_func
(paren
id|host_stat
op_or
id|ATA_DMA_INTR
op_or
id|ATA_DMA_ERR
comma
id|ap-&gt;ioaddr.bmdma_addr
op_plus
id|ATA_DMA_STATUS
)paren
suffix:semicolon
multiline_comment|/* issue r/w command */
id|ap-&gt;ops
op_member_access_from_pointer
id|exec_command
c_func
(paren
id|ap
comma
op_amp
id|qc-&gt;tf
)paren
suffix:semicolon
multiline_comment|/* start host DMA transaction */
id|dmactl
op_assign
id|inb
c_func
(paren
id|ap-&gt;ioaddr.bmdma_addr
op_plus
id|ATA_DMA_CMD
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dmactl
op_or
id|ATA_DMA_START
comma
id|ap-&gt;ioaddr.bmdma_addr
op_plus
id|ATA_DMA_CMD
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_dma_complete -&n; *&t;@ap:&n; *&t;@host_stat:&n; *&t;@done_late:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_dma_complete
r_static
r_void
id|ata_dma_complete
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
id|u8
id|host_stat
comma
r_int
r_int
id|done_late
)paren
(brace
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_MMIO
)paren
(brace
r_void
op_star
id|mmio
op_assign
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.bmdma_addr
suffix:semicolon
multiline_comment|/* clear start/stop bit */
id|writeb
c_func
(paren
l_int|0
comma
id|mmio
op_plus
id|ATA_DMA_CMD
)paren
suffix:semicolon
multiline_comment|/* ack intr, err bits */
id|writeb
c_func
(paren
id|host_stat
op_or
id|ATA_DMA_INTR
op_or
id|ATA_DMA_ERR
comma
id|mmio
op_plus
id|ATA_DMA_STATUS
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* clear start/stop bit */
id|outb
c_func
(paren
l_int|0
comma
id|ap-&gt;ioaddr.bmdma_addr
op_plus
id|ATA_DMA_CMD
)paren
suffix:semicolon
multiline_comment|/* ack intr, err bits */
id|outb
c_func
(paren
id|host_stat
op_or
id|ATA_DMA_INTR
op_or
id|ATA_DMA_ERR
comma
id|ap-&gt;ioaddr.bmdma_addr
op_plus
id|ATA_DMA_STATUS
)paren
suffix:semicolon
)brace
multiline_comment|/* one-PIO-cycle guaranteed wait, per spec, for HDMA1:0 transition */
id|ata_altstatus
c_func
(paren
id|ap
)paren
suffix:semicolon
multiline_comment|/* dummy read */
id|DPRINTK
c_func
(paren
l_string|&quot;host %u, host_stat==0x%X, drv_stat==0x%X&bslash;n&quot;
comma
id|ap-&gt;id
comma
(paren
id|u32
)paren
id|host_stat
comma
(paren
id|u32
)paren
id|ata_chk_status
c_func
(paren
id|ap
)paren
)paren
suffix:semicolon
multiline_comment|/* get drive status; clear intr; complete txn */
id|ata_qc_complete
c_func
(paren
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|ap-&gt;active_tag
)paren
comma
id|ata_wait_idle
c_func
(paren
id|ap
)paren
comma
id|done_late
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_host_intr - Handle host interrupt for given (port, task)&n; *&t;@ap: Port on which interrupt arrived (possibly...)&n; *&t;@qc: Taskfile currently active in engine&n; *&n; *&t;Handle host interrupt for given queued command.  Currently,&n; *&t;only DMA interrupts are handled.  All other commands are&n; *&t;handled via polling with interrupts disabled (nIEN bit).&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; *&n; *&t;RETURNS:&n; *&t;One if interrupt was handled, zero if not (shared irq).&n; */
DECL|function|ata_host_intr
r_static
r_inline
r_int
r_int
id|ata_host_intr
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
id|u8
id|status
comma
id|host_stat
suffix:semicolon
r_int
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|qc-&gt;tf.protocol
)paren
(brace
r_case
id|ATA_PROT_DMA_READ
suffix:colon
r_case
id|ATA_PROT_DMA_WRITE
suffix:colon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_MMIO
)paren
(brace
r_void
op_star
id|mmio
op_assign
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.bmdma_addr
suffix:semicolon
id|host_stat
op_assign
id|readb
c_func
(paren
id|mmio
op_plus
id|ATA_DMA_STATUS
)paren
suffix:semicolon
)brace
r_else
id|host_stat
op_assign
id|inb
c_func
(paren
id|ap-&gt;ioaddr.bmdma_addr
op_plus
id|ATA_DMA_STATUS
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;BUS_DMA (host_stat 0x%X)&bslash;n&quot;
comma
id|host_stat
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|host_stat
op_amp
id|ATA_DMA_INTR
)paren
)paren
(brace
id|ap-&gt;stats.idle_irq
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ata_dma_complete
c_func
(paren
id|ap
comma
id|host_stat
comma
l_int|0
)paren
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATA_PROT_NODATA
suffix:colon
multiline_comment|/* command completion, but no data xfer */
id|status
op_assign
id|ata_busy_wait
c_func
(paren
id|ap
comma
id|ATA_BUSY
op_or
id|ATA_DRQ
comma
l_int|1000
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;BUS_NODATA (drv_stat 0x%X)&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|ata_qc_complete
c_func
(paren
id|qc
comma
id|status
comma
l_int|0
)paren
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ap-&gt;stats.idle_irq
op_increment
suffix:semicolon
macro_line|#ifdef ATA_IRQ_TRAP
r_if
c_cond
(paren
(paren
id|ap-&gt;stats.idle_irq
op_mod
l_int|1000
)paren
op_eq
l_int|0
)paren
(brace
id|handled
op_assign
l_int|1
suffix:semicolon
id|ata_irq_ack
c_func
(paren
id|ap
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* debug trap */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ata%d: irq trap&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
)brace
macro_line|#endif
r_break
suffix:semicolon
)brace
r_return
id|handled
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_interrupt -&n; *&t;@irq:&n; *&t;@dev_instance:&n; *&t;@regs:&n; *&n; *&t;LOCKING:&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_interrupt
id|irqreturn_t
id|ata_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ata_host_set
op_star
id|host_set
op_assign
id|dev_instance
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* TODO: make _irqsave conditional on x86 PCI IDE legacy mode */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host_set-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|host_set-&gt;n_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
suffix:semicolon
id|ap
op_assign
id|host_set-&gt;ports
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ap
op_logical_and
(paren
op_logical_neg
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
)paren
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
id|qc
op_assign
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|ap-&gt;active_tag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qc
op_logical_and
(paren
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_POLL
)paren
op_eq
l_int|0
)paren
)paren
id|handled
op_add_assign
id|ata_host_intr
c_func
(paren
id|ap
comma
id|qc
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host_set-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_thread_wake -&n; *&t;@ap:&n; *&t;@thr_state:&n; *&n; *&t;LOCKING:&n; *&t;spin_lock_irqsave(host_set lock)&n; */
DECL|function|ata_thread_wake
r_void
id|ata_thread_wake
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|thr_state
)paren
(brace
m_assert
(paren
id|ap-&gt;thr_state
op_eq
id|THR_IDLE
)paren
suffix:semicolon
id|ap-&gt;thr_state
op_assign
id|thr_state
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ap-&gt;thr_sem
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_thread_timer -&n; *&t;@opaque:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_thread_timer
r_static
r_void
id|ata_thread_timer
c_func
(paren
r_int
r_int
id|opaque
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
(paren
r_struct
id|ata_port
op_star
)paren
id|opaque
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ap-&gt;thr_sem
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_thread_iter -&n; *&t;@ap:&n; *&n; *&t;LOCKING:&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_thread_iter
r_static
r_int
r_int
id|ata_thread_iter
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_int
id|timeout
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ata%u: thr_state %s&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|ata_thr_state_name
c_func
(paren
id|ap-&gt;thr_state
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ap-&gt;thr_state
)paren
(brace
r_case
id|THR_UNKNOWN
suffix:colon
id|ap-&gt;thr_state
op_assign
id|THR_PORT_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_PROBE_START
suffix:colon
id|down
c_func
(paren
op_amp
id|ap-&gt;sem
)paren
suffix:semicolon
id|ap-&gt;thr_state
op_assign
id|THR_PORT_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_PORT_RESET
suffix:colon
id|ata_port_reset
c_func
(paren
id|ap
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_PROBE_SUCCESS
suffix:colon
id|up
c_func
(paren
op_amp
id|ap-&gt;probe_sem
)paren
suffix:semicolon
id|ap-&gt;thr_state
op_assign
id|THR_IDLE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_PROBE_FAILED
suffix:colon
id|up
c_func
(paren
op_amp
id|ap-&gt;probe_sem
)paren
suffix:semicolon
id|ap-&gt;thr_state
op_assign
id|THR_AWAIT_DEATH
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_AWAIT_DEATH
suffix:colon
id|timeout
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_IDLE
suffix:colon
id|timeout
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_PIO
suffix:colon
id|ata_pio_sector
c_func
(paren
id|ap
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_PIO_LAST
suffix:colon
id|ata_pio_complete
c_func
(paren
id|ap
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_PIO_POLL
suffix:colon
r_case
id|THR_PIO_LAST_POLL
suffix:colon
id|timeout
op_assign
id|ata_pio_poll
c_func
(paren
id|ap
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_PIO_TMOUT
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%d: FIXME: THR_PIO_TMOUT&bslash;n&quot;
comma
multiline_comment|/* FIXME */
id|ap-&gt;id
)paren
suffix:semicolon
id|timeout
op_assign
l_int|11
op_star
id|HZ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_PIO_ERR
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%d: FIXME: THR_PIO_ERR&bslash;n&quot;
comma
multiline_comment|/* FIXME */
id|ap-&gt;id
)paren
suffix:semicolon
id|timeout
op_assign
l_int|11
op_star
id|HZ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|THR_PACKET
suffix:colon
id|atapi_cdb_send
c_func
(paren
id|ap
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ata%u: unknown thr state %s&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|ata_thr_state_name
c_func
(paren
id|ap-&gt;thr_state
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;ata%u: new thr_state %s, returning %ld&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|ata_thr_state_name
c_func
(paren
id|ap-&gt;thr_state
)paren
comma
id|timeout
)paren
suffix:semicolon
r_return
id|timeout
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_thread -&n; *&t;@data:&n; *&n; *&t;LOCKING:&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_thread
r_static
r_int
id|ata_thread
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|data
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|daemonize
(paren
l_string|&quot;katad-%u&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
id|allow_signal
c_func
(paren
id|SIGTERM
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|cond_resched
c_func
(paren
)paren
suffix:semicolon
id|timeout
op_assign
id|ata_thread_iter
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
id|flush_signals
c_func
(paren
id|current
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|timeout
OL
l_int|0
)paren
op_logical_or
(paren
id|ap-&gt;time_to_die
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* note sleeping for full timeout not guaranteed (that&squot;s ok) */
r_if
c_cond
(paren
id|timeout
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|ap-&gt;thr_timer
comma
id|jiffies
op_plus
id|timeout
)paren
suffix:semicolon
id|down_interruptible
c_func
(paren
op_amp
id|ap-&gt;thr_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
id|flush_signals
c_func
(paren
id|current
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;time_to_die
)paren
r_break
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ata%u: thread exiting&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
id|ap-&gt;thr_pid
op_assign
op_minus
l_int|1
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|ap-&gt;thr_timer
)paren
suffix:semicolon
id|complete_and_exit
(paren
op_amp
id|ap-&gt;thr_exited
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_thread_kill - kill per-port kernel thread&n; *&t;@ap: port those thread is to be killed&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|ata_thread_kill
r_static
r_int
id|ata_thread_kill
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;thr_pid
op_ge
l_int|0
)paren
(brace
id|ap-&gt;time_to_die
op_assign
l_int|1
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|kill_proc
c_func
(paren
id|ap-&gt;thr_pid
comma
id|SIGTERM
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%d: unable to kill kernel thread&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
r_else
id|wait_for_completion
c_func
(paren
op_amp
id|ap-&gt;thr_exited
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;atapi_cdb_send - Write CDB bytes to hardware&n; *&t;@ap: Port to which ATAPI device is attached.&n; *&n; *&t;When device has indicated its readiness to accept&n; *&t;a CDB, this function is called.  Send the CDB.&n; *&t;If DMA is to be performed, exit immediately.&n; *&t;Otherwise, we are in polling mode, so poll&n; *&t;status under operation succeeds or fails.&n; *&n; *&t;LOCKING:&n; *&t;Kernel thread context (may sleep)&n; */
DECL|function|atapi_cdb_send
r_static
r_void
id|atapi_cdb_send
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|qc
op_assign
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|ap-&gt;active_tag
)paren
suffix:semicolon
m_assert
(paren
id|qc
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_ACTIVE
)paren
suffix:semicolon
multiline_comment|/* sleep-wait for BSY to clear */
id|DPRINTK
c_func
(paren
l_string|&quot;busy wait&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ata_busy_sleep
c_func
(paren
id|ap
comma
id|ATA_TMOUT_CDB_QUICK
comma
id|ATA_TMOUT_CDB
)paren
)paren
r_goto
id|err_out
suffix:semicolon
multiline_comment|/* make sure DRQ is set */
id|status
op_assign
id|ata_chk_status
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|ATA_DRQ
)paren
op_eq
l_int|0
)paren
r_goto
id|err_out
suffix:semicolon
multiline_comment|/* send SCSI cdb */
multiline_comment|/* FIXME: mmio-ize */
id|DPRINTK
c_func
(paren
l_string|&quot;send cdb&bslash;n&quot;
)paren
suffix:semicolon
id|outsl
c_func
(paren
id|ap-&gt;ioaddr.data_addr
comma
id|qc-&gt;scsicmd-&gt;cmnd
comma
id|ap-&gt;host-&gt;max_cmd_len
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* if we are DMA&squot;ing, irq handler takes over from here */
r_if
c_cond
(paren
id|qc-&gt;tf.feature
op_eq
id|ATAPI_PKT_DMA
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* sleep-wait for BSY to clear */
id|DPRINTK
c_func
(paren
l_string|&quot;busy wait 2&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ata_busy_sleep
c_func
(paren
id|ap
comma
id|ATA_TMOUT_CDB_QUICK
comma
id|ATA_TMOUT_CDB
)paren
)paren
r_goto
id|err_out
suffix:semicolon
multiline_comment|/* wait for BSY,DRQ to clear */
id|status
op_assign
id|ata_wait_idle
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|ATA_BUSY
op_or
id|ATA_DRQ
)paren
)paren
r_goto
id|err_out
suffix:semicolon
multiline_comment|/* transaction completed, indicate such to scsi stack */
id|ata_qc_complete
c_func
(paren
id|qc
comma
id|status
comma
l_int|0
)paren
suffix:semicolon
id|ata_irq_on
c_func
(paren
id|ap
)paren
suffix:semicolon
id|out
suffix:colon
id|ap-&gt;thr_state
op_assign
id|THR_IDLE
suffix:semicolon
r_return
suffix:semicolon
id|err_out
suffix:colon
id|ata_qc_complete
c_func
(paren
id|qc
comma
id|ATA_ERR
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
DECL|function|ata_port_start
r_int
id|ata_port_start
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|ap-&gt;host_set-&gt;pdev
suffix:semicolon
id|ap-&gt;prd
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|ATA_PRD_TBL_SZ
comma
op_amp
id|ap-&gt;prd_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ap-&gt;prd
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;prd alloc, virt %p, dma %x&bslash;n&quot;
comma
id|ap-&gt;prd
comma
id|ap-&gt;prd_dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ata_port_stop
r_void
id|ata_port_stop
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|ap-&gt;host_set-&gt;pdev
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|ATA_PRD_TBL_SZ
comma
id|ap-&gt;prd
comma
id|ap-&gt;prd_dma
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_host_remove -&n; *&t;@ap:&n; *&t;@do_unregister:&n; *&n; *&t;LOCKING:&n; */
DECL|function|ata_host_remove
r_static
r_void
id|ata_host_remove
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|do_unregister
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|sh
op_assign
id|ap-&gt;host
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_unregister
)paren
id|scsi_remove_host
c_func
(paren
id|sh
)paren
suffix:semicolon
multiline_comment|/* FIXME: check return val */
id|ata_thread_kill
c_func
(paren
id|ap
)paren
suffix:semicolon
multiline_comment|/* FIXME: check return val */
id|ap-&gt;ops
op_member_access_from_pointer
id|port_stop
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_host_init -&n; *&t;@host:&n; *&t;@ent:&n; *&t;@port_no:&n; *&n; *&t;LOCKING:&n; *&n; */
DECL|function|ata_host_init
r_static
r_void
id|ata_host_init
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|Scsi_Host
op_star
id|host
comma
r_struct
id|ata_host_set
op_star
id|host_set
comma
r_struct
id|ata_probe_ent
op_star
id|ent
comma
r_int
r_int
id|port_no
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
id|host-&gt;max_id
op_assign
l_int|16
suffix:semicolon
id|host-&gt;max_lun
op_assign
l_int|1
suffix:semicolon
id|host-&gt;max_channel
op_assign
l_int|1
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|ata_unique_id
op_increment
suffix:semicolon
id|host-&gt;max_cmd_len
op_assign
l_int|12
suffix:semicolon
id|scsi_set_device
c_func
(paren
id|host
comma
op_amp
id|ent-&gt;pdev-&gt;dev
)paren
suffix:semicolon
id|ap-&gt;flags
op_assign
id|ATA_FLAG_PORT_DISABLED
suffix:semicolon
id|ap-&gt;id
op_assign
id|host-&gt;unique_id
suffix:semicolon
id|ap-&gt;host
op_assign
id|host
suffix:semicolon
id|ap-&gt;ctl
op_assign
id|ATA_DEVCTL_OBS
suffix:semicolon
id|ap-&gt;host_set
op_assign
id|host_set
suffix:semicolon
id|ap-&gt;port_no
op_assign
id|port_no
suffix:semicolon
id|ap-&gt;pio_mask
op_assign
id|ent-&gt;pio_mask
suffix:semicolon
id|ap-&gt;udma_mask
op_assign
id|ent-&gt;udma_mask
suffix:semicolon
id|ap-&gt;flags
op_or_assign
id|ent-&gt;host_flags
suffix:semicolon
id|ap-&gt;ops
op_assign
id|ent-&gt;port_ops
suffix:semicolon
id|ap-&gt;thr_state
op_assign
id|THR_PROBE_START
suffix:semicolon
id|ap-&gt;cbl
op_assign
id|ATA_CBL_NONE
suffix:semicolon
id|ap-&gt;device
(braket
l_int|0
)braket
dot
id|flags
op_assign
id|ATA_DFLAG_MASTER
suffix:semicolon
id|ap-&gt;active_tag
op_assign
id|ATA_TAG_POISON
suffix:semicolon
id|ap-&gt;last_ctl
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* ata_engine init */
id|ap-&gt;eng.flags
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ap-&gt;eng.q
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ATA_MAX_DEVICES
suffix:semicolon
id|i
op_increment
)paren
id|ap-&gt;device
(braket
id|i
)braket
dot
id|devno
op_assign
id|i
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|ap-&gt;thr_exited
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|ap-&gt;probe_sem
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|ap-&gt;sem
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|ap-&gt;thr_sem
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|ap-&gt;thr_timer
)paren
suffix:semicolon
id|ap-&gt;thr_timer.function
op_assign
id|ata_thread_timer
suffix:semicolon
id|ap-&gt;thr_timer.data
op_assign
(paren
r_int
r_int
)paren
id|ap
suffix:semicolon
macro_line|#ifdef ATA_IRQ_TRAP
id|ap-&gt;stats.unhandled_irq
op_assign
l_int|1
suffix:semicolon
id|ap-&gt;stats.idle_irq
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
op_amp
id|ap-&gt;ioaddr
comma
op_amp
id|ent-&gt;port
(braket
id|port_no
)braket
comma
r_sizeof
(paren
r_struct
id|ata_ioports
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_host_add -&n; *&t;@ent:&n; *&t;@host_set:&n; *&t;@port_no:&n; *&n; *&t;LOCKING:&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_host_add
r_static
r_struct
id|ata_port
op_star
id|ata_host_add
c_func
(paren
r_struct
id|ata_probe_ent
op_star
id|ent
comma
r_struct
id|ata_host_set
op_star
id|host_set
comma
r_int
r_int
id|port_no
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_struct
id|ata_port
op_star
id|ap
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|host
op_assign
id|scsi_host_alloc
c_func
(paren
id|ent-&gt;sht
comma
r_sizeof
(paren
r_struct
id|ata_port
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_return
l_int|NULL
suffix:semicolon
id|ap
op_assign
(paren
r_struct
id|ata_port
op_star
)paren
op_amp
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|ata_host_init
c_func
(paren
id|ap
comma
id|host
comma
id|host_set
comma
id|ent
comma
id|port_no
)paren
suffix:semicolon
id|rc
op_assign
id|ap-&gt;ops
op_member_access_from_pointer
id|port_start
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out
suffix:semicolon
id|ap-&gt;thr_pid
op_assign
id|kernel_thread
c_func
(paren
id|ata_thread
comma
id|ap
comma
id|CLONE_FS
op_or
id|CLONE_FILES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;thr_pid
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%d: unable to start kernel thread&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
r_goto
id|err_out_free
suffix:semicolon
)brace
r_return
id|ap
suffix:semicolon
id|err_out_free
suffix:colon
id|ap-&gt;ops
op_member_access_from_pointer
id|port_stop
c_func
(paren
id|ap
)paren
suffix:semicolon
id|err_out
suffix:colon
id|scsi_host_put
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_device_add -&n; *&t;@ent:&n; *&n; *&t;LOCKING:&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_device_add
r_int
id|ata_device_add
c_func
(paren
r_struct
id|ata_probe_ent
op_star
id|ent
)paren
(brace
r_int
r_int
id|count
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|ent-&gt;pdev
suffix:semicolon
r_struct
id|ata_host_set
op_star
id|host_set
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* alloc a container for our list of ATA ports (buses) */
id|host_set
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ata_host_set
)paren
op_plus
(paren
id|ent-&gt;n_ports
op_star
r_sizeof
(paren
r_void
op_star
)paren
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host_set
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|host_set
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ata_host_set
)paren
op_plus
(paren
id|ent-&gt;n_ports
op_star
r_sizeof
(paren
r_void
op_star
)paren
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|host_set-&gt;lock
)paren
suffix:semicolon
id|host_set-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|host_set-&gt;n_ports
op_assign
id|ent-&gt;n_ports
suffix:semicolon
id|host_set-&gt;irq
op_assign
id|ent-&gt;irq
suffix:semicolon
id|host_set-&gt;mmio_base
op_assign
id|ent-&gt;mmio_base
suffix:semicolon
id|host_set-&gt;private_data
op_assign
id|ent-&gt;private_data
suffix:semicolon
multiline_comment|/* register each port bound to this device */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ent-&gt;n_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
suffix:semicolon
id|ap
op_assign
id|ata_host_add
c_func
(paren
id|ent
comma
id|host_set
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ap
)paren
r_goto
id|err_out
suffix:semicolon
id|host_set-&gt;ports
(braket
id|i
)braket
op_assign
id|ap
suffix:semicolon
multiline_comment|/* print per-port info to dmesg */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ata%u: %cATA max %s cmd 0x%lX ctl 0x%lX &quot;
l_string|&quot;bmdma 0x%lX irq %lu&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|ap-&gt;flags
op_amp
id|ATA_FLAG_SATA
ques
c_cond
l_char|&squot;S&squot;
suffix:colon
l_char|&squot;P&squot;
comma
id|ata_udma_string
c_func
(paren
id|ent-&gt;udma_mask
)paren
comma
id|ap-&gt;ioaddr.cmd_addr
comma
id|ap-&gt;ioaddr.ctl_addr
comma
id|ap-&gt;ioaddr.bmdma_addr
comma
id|ent-&gt;irq
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
(brace
id|kfree
c_func
(paren
id|host_set
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* obtain irq, that is shared between channels */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|ent-&gt;irq
comma
id|ent-&gt;port_ops-&gt;irq_handler
comma
id|ent-&gt;irq_flags
comma
id|DRV_NAME
comma
id|host_set
)paren
)paren
r_goto
id|err_out
suffix:semicolon
multiline_comment|/* perform each probe synchronously */
id|DPRINTK
c_func
(paren
l_string|&quot;probe begin&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ap
op_assign
id|host_set-&gt;ports
(braket
id|i
)braket
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ata%u: probe begin&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ap-&gt;sem
)paren
suffix:semicolon
multiline_comment|/* start probe */
id|DPRINTK
c_func
(paren
l_string|&quot;ata%u: probe-wait begin&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ap-&gt;probe_sem
)paren
suffix:semicolon
multiline_comment|/* wait for end */
id|DPRINTK
c_func
(paren
l_string|&quot;ata%u: probe-wait end&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
id|rc
op_assign
id|scsi_add_host
c_func
(paren
id|ap-&gt;host
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%u: scsi_add_host failed&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
multiline_comment|/* FIXME: do something useful here */
multiline_comment|/* FIXME: handle unconditional calls to&n;&t;&t;&t; * scsi_scan_host and ata_host_remove, below,&n;&t;&t;&t; * at the very least&n;&t;&t;&t; */
)brace
)brace
multiline_comment|/* probes are done, now scan each port&squot;s disk(s) */
id|DPRINTK
c_func
(paren
l_string|&quot;probe begin&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|host_set-&gt;ports
(braket
id|i
)braket
suffix:semicolon
id|scsi_scan_host
c_func
(paren
id|ap-&gt;host
)paren
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|host_set
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;EXIT, returning %u&bslash;n&quot;
comma
id|ent-&gt;n_ports
)paren
suffix:semicolon
r_return
id|ent-&gt;n_ports
suffix:semicolon
multiline_comment|/* success */
id|err_out
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ata_host_remove
c_func
(paren
id|host_set-&gt;ports
(braket
id|i
)braket
comma
l_int|1
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|host_set-&gt;ports
(braket
id|i
)braket
op_member_access_from_pointer
id|host
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|host_set
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_scsi_release - SCSI layer callback hook for host unload&n; *&t;@host: libata host to be unloaded&n; *&n; *&t;Performs all duties necessary to shut down a libata port:&n; *&t;Kill port kthread, disable port, and release resources.&n; *&n; *&t;LOCKING:&n; *&t;Inherited from SCSI layer.&n; *&n; *&t;RETURNS:&n; *&t;One.&n; */
DECL|function|ata_scsi_release
r_int
id|ata_scsi_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
(paren
r_struct
id|ata_port
op_star
)paren
op_amp
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|ap-&gt;ops
op_member_access_from_pointer
id|port_disable
c_func
(paren
id|ap
)paren
suffix:semicolon
id|ata_host_remove
c_func
(paren
id|ap
comma
l_int|0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_std_ports - initialize ioaddr with standard port offsets.&n; *&t;@ioaddr:&n; */
DECL|function|ata_std_ports
r_void
id|ata_std_ports
c_func
(paren
r_struct
id|ata_ioports
op_star
id|ioaddr
)paren
(brace
id|ioaddr-&gt;data_addr
op_assign
id|ioaddr-&gt;cmd_addr
op_plus
id|ATA_REG_DATA
suffix:semicolon
id|ioaddr-&gt;error_addr
op_assign
id|ioaddr-&gt;cmd_addr
op_plus
id|ATA_REG_ERR
suffix:semicolon
id|ioaddr-&gt;nsect_addr
op_assign
id|ioaddr-&gt;cmd_addr
op_plus
id|ATA_REG_NSECT
suffix:semicolon
id|ioaddr-&gt;lbal_addr
op_assign
id|ioaddr-&gt;cmd_addr
op_plus
id|ATA_REG_LBAL
suffix:semicolon
id|ioaddr-&gt;lbam_addr
op_assign
id|ioaddr-&gt;cmd_addr
op_plus
id|ATA_REG_LBAM
suffix:semicolon
id|ioaddr-&gt;lbah_addr
op_assign
id|ioaddr-&gt;cmd_addr
op_plus
id|ATA_REG_LBAH
suffix:semicolon
id|ioaddr-&gt;device_addr
op_assign
id|ioaddr-&gt;cmd_addr
op_plus
id|ATA_REG_DEVICE
suffix:semicolon
id|ioaddr-&gt;cmdstat_addr
op_assign
id|ioaddr-&gt;cmd_addr
op_plus
id|ATA_REG_CMD
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_pci_init_one -&n; *&t;@pdev:&n; *&t;@port_info:&n; *&t;@n_ports:&n; *&n; *&t;LOCKING:&n; *&t;Inherited from PCI layer (may sleep).&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_pci_init_one
r_int
id|ata_pci_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|ata_port_info
op_star
op_star
id|port_info
comma
r_int
r_int
id|n_ports
)paren
(brace
r_struct
id|ata_probe_ent
op_star
id|probe_ent
comma
op_star
id|probe_ent2
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ata_port_info
op_star
id|port0
comma
op_star
id|port1
suffix:semicolon
id|u8
id|tmp8
comma
id|mask
suffix:semicolon
r_int
r_int
id|legacy_mode
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|port0
op_assign
id|port_info
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|n_ports
OG
l_int|1
)paren
id|port1
op_assign
id|port_info
(braket
l_int|1
)braket
suffix:semicolon
r_else
id|port1
op_assign
id|port0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|port0-&gt;host_flags
op_amp
id|ATA_FLAG_NO_LEGACY
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* TODO: support transitioning to native mode? */
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_CLASS_PROG
comma
op_amp
id|tmp8
)paren
suffix:semicolon
id|mask
op_assign
(paren
l_int|1
op_lshift
l_int|2
)paren
op_or
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp8
op_amp
id|mask
)paren
op_ne
id|mask
)paren
id|legacy_mode
op_assign
(paren
l_int|1
op_lshift
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME... */
r_if
c_cond
(paren
(paren
op_logical_neg
id|legacy_mode
)paren
op_logical_and
(paren
id|n_ports
OG
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata: BUG: native mode, n_ports &gt; 1&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|rc
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|DRV_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out
suffix:semicolon
r_if
c_cond
(paren
id|legacy_mode
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
l_int|0x1f0
comma
l_int|8
comma
l_string|&quot;libata&quot;
)paren
)paren
(brace
r_struct
id|resource
op_star
id|conflict
comma
id|res
suffix:semicolon
id|res.start
op_assign
l_int|0x1f0
suffix:semicolon
id|res.end
op_assign
l_int|0x1f0
op_plus
l_int|8
op_minus
l_int|1
suffix:semicolon
id|conflict
op_assign
id|____request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|conflict-&gt;name
comma
l_string|&quot;libata&quot;
)paren
)paren
id|legacy_mode
op_or_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ata: 0x1f0 IDE port busy&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|legacy_mode
op_or_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
l_int|0x170
comma
l_int|8
comma
l_string|&quot;libata&quot;
)paren
)paren
(brace
r_struct
id|resource
op_star
id|conflict
comma
id|res
suffix:semicolon
id|res.start
op_assign
l_int|0x170
suffix:semicolon
id|res.end
op_assign
l_int|0x170
op_plus
l_int|8
op_minus
l_int|1
suffix:semicolon
id|conflict
op_assign
id|____request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|conflict-&gt;name
comma
l_string|&quot;libata&quot;
)paren
)paren
id|legacy_mode
op_or_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ata: 0x170 IDE port busy&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|legacy_mode
op_or_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* we have legacy mode, but all ports are unavailable */
r_if
c_cond
(paren
id|legacy_mode
op_eq
(paren
l_int|1
op_lshift
l_int|3
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err_out_regions
suffix:semicolon
)brace
id|rc
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|ATA_DMA_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out_regions
suffix:semicolon
id|probe_ent
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|probe_ent
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|probe_ent
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_regions
suffix:semicolon
)brace
id|memset
c_func
(paren
id|probe_ent
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|probe_ent
)paren
)paren
suffix:semicolon
id|probe_ent-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|probe_ent-&gt;node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|legacy_mode
)paren
(brace
id|probe_ent2
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|probe_ent
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|probe_ent2
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_free_ent
suffix:semicolon
)brace
id|memset
c_func
(paren
id|probe_ent2
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|probe_ent
)paren
)paren
suffix:semicolon
id|probe_ent2-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|probe_ent2-&gt;node
)paren
suffix:semicolon
)brace
id|probe_ent-&gt;port
(braket
l_int|0
)braket
dot
id|bmdma_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|4
)paren
suffix:semicolon
id|probe_ent-&gt;sht
op_assign
id|port0-&gt;sht
suffix:semicolon
id|probe_ent-&gt;host_flags
op_assign
id|port0-&gt;host_flags
suffix:semicolon
id|probe_ent-&gt;pio_mask
op_assign
id|port0-&gt;pio_mask
suffix:semicolon
id|probe_ent-&gt;udma_mask
op_assign
id|port0-&gt;udma_mask
suffix:semicolon
id|probe_ent-&gt;port_ops
op_assign
id|port0-&gt;port_ops
suffix:semicolon
r_if
c_cond
(paren
id|legacy_mode
)paren
(brace
id|probe_ent-&gt;port
(braket
l_int|0
)braket
dot
id|cmd_addr
op_assign
l_int|0x1f0
suffix:semicolon
id|probe_ent-&gt;port
(braket
l_int|0
)braket
dot
id|ctl_addr
op_assign
l_int|0x3f6
suffix:semicolon
id|probe_ent-&gt;n_ports
op_assign
l_int|1
suffix:semicolon
id|probe_ent-&gt;irq
op_assign
l_int|14
suffix:semicolon
id|ata_std_ports
c_func
(paren
op_amp
id|probe_ent-&gt;port
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|probe_ent2-&gt;port
(braket
l_int|0
)braket
dot
id|cmd_addr
op_assign
l_int|0x170
suffix:semicolon
id|probe_ent2-&gt;port
(braket
l_int|0
)braket
dot
id|ctl_addr
op_assign
l_int|0x376
suffix:semicolon
id|probe_ent2-&gt;port
(braket
l_int|0
)braket
dot
id|bmdma_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|4
)paren
op_plus
l_int|8
suffix:semicolon
id|probe_ent2-&gt;n_ports
op_assign
l_int|1
suffix:semicolon
id|probe_ent2-&gt;irq
op_assign
l_int|15
suffix:semicolon
id|ata_std_ports
c_func
(paren
op_amp
id|probe_ent2-&gt;port
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|probe_ent2-&gt;sht
op_assign
id|port1-&gt;sht
suffix:semicolon
id|probe_ent2-&gt;host_flags
op_assign
id|port1-&gt;host_flags
suffix:semicolon
id|probe_ent2-&gt;pio_mask
op_assign
id|port1-&gt;pio_mask
suffix:semicolon
id|probe_ent2-&gt;udma_mask
op_assign
id|port1-&gt;udma_mask
suffix:semicolon
id|probe_ent2-&gt;port_ops
op_assign
id|port1-&gt;port_ops
suffix:semicolon
)brace
r_else
(brace
id|probe_ent-&gt;port
(braket
l_int|0
)braket
dot
id|cmd_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|ata_std_ports
c_func
(paren
op_amp
id|probe_ent-&gt;port
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|probe_ent-&gt;port
(braket
l_int|0
)braket
dot
id|ctl_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
op_or
id|ATA_PCI_CTL_OFS
suffix:semicolon
id|probe_ent-&gt;port
(braket
l_int|1
)braket
dot
id|cmd_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
id|ata_std_ports
c_func
(paren
op_amp
id|probe_ent-&gt;port
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|probe_ent-&gt;port
(braket
l_int|1
)braket
dot
id|ctl_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|3
)paren
op_or
id|ATA_PCI_CTL_OFS
suffix:semicolon
id|probe_ent-&gt;port
(braket
l_int|1
)braket
dot
id|bmdma_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|4
)paren
op_plus
l_int|8
suffix:semicolon
id|probe_ent-&gt;n_ports
op_assign
l_int|2
suffix:semicolon
id|probe_ent-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|probe_ent-&gt;irq_flags
op_assign
id|SA_SHIRQ
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* FIXME: check ata_device_add return */
r_if
c_cond
(paren
id|legacy_mode
)paren
(brace
r_if
c_cond
(paren
id|legacy_mode
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
id|ata_device_add
c_func
(paren
id|probe_ent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|legacy_mode
op_amp
(paren
l_int|1
op_lshift
l_int|1
)paren
)paren
id|ata_device_add
c_func
(paren
id|probe_ent2
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|probe_ent2
)paren
suffix:semicolon
)brace
r_else
(brace
id|ata_device_add
c_func
(paren
id|probe_ent
)paren
suffix:semicolon
m_assert
(paren
id|probe_ent2
op_eq
l_int|NULL
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|probe_ent
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_free_ent
suffix:colon
id|kfree
c_func
(paren
id|probe_ent
)paren
suffix:semicolon
id|err_out_regions
suffix:colon
r_if
c_cond
(paren
id|legacy_mode
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
id|release_region
c_func
(paren
l_int|0x1f0
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|legacy_mode
op_amp
(paren
l_int|1
op_lshift
l_int|1
)paren
)paren
id|release_region
c_func
(paren
l_int|0x170
comma
l_int|8
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_pci_remove_one - PCI layer callback for device removal&n; *&t;@pdev: PCI device that was removed&n; *&n; *&t;PCI layer indicates to libata via this hook that&n; *&t;hot-unplug or module unload event has occured.&n; *&t;Handle this by unregistering all objects associated&n; *&t;with this PCI device.  Free those objects.  Then finally&n; *&t;release PCI resources and disable device.&n; *&n; *&t;LOCKING:&n; *&t;Inherited from PCI layer (may sleep).&n; */
DECL|function|ata_pci_remove_one
r_void
id|ata_pci_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|ata_host_set
op_star
id|host_set
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|ata_port
op_star
id|ap
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|host_set-&gt;n_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ap
op_assign
id|host_set-&gt;ports
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* FIXME: check return val */
id|scsi_remove_host
c_func
(paren
id|ap-&gt;host
)paren
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|host_set-&gt;irq
comma
id|host_set
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host_set-&gt;mmio_base
)paren
id|iounmap
c_func
(paren
id|host_set-&gt;mmio_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host_set-&gt;ports
(braket
l_int|0
)braket
op_member_access_from_pointer
id|ops-&gt;host_stop
)paren
id|host_set-&gt;ports
(braket
l_int|0
)braket
op_member_access_from_pointer
id|ops
op_member_access_from_pointer
id|host_stop
c_func
(paren
id|host_set
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|host_set-&gt;n_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Scsi_Host_Template
op_star
id|sht
suffix:semicolon
id|ap
op_assign
id|host_set-&gt;ports
(braket
id|i
)braket
suffix:semicolon
id|sht
op_assign
id|ap-&gt;host-&gt;hostt
suffix:semicolon
id|ata_scsi_release
c_func
(paren
id|ap-&gt;host
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|ap-&gt;host
)paren
suffix:semicolon
multiline_comment|/* FIXME: check return val */
)brace
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|host_set-&gt;n_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|ata_ioports
op_star
id|ioaddr
suffix:semicolon
id|ap
op_assign
id|host_set-&gt;ports
(braket
id|i
)braket
suffix:semicolon
id|ioaddr
op_assign
op_amp
id|ap-&gt;ioaddr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_NO_LEGACY
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ioaddr-&gt;cmd_addr
op_eq
l_int|0x1f0
)paren
id|release_region
c_func
(paren
l_int|0x1f0
comma
l_int|8
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ioaddr-&gt;cmd_addr
op_eq
l_int|0x170
)paren
id|release_region
c_func
(paren
l_int|0x170
comma
l_int|8
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|host_set
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* move to PCI subsystem */
DECL|function|pci_test_config_bits
r_int
id|pci_test_config_bits
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|pci_bits
op_star
id|bits
)paren
(brace
r_int
r_int
id|tmp
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|bits-&gt;width
)paren
(brace
r_case
l_int|1
suffix:colon
(brace
id|u8
id|tmp8
op_assign
l_int|0
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|bits-&gt;reg
comma
op_amp
id|tmp8
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp8
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|2
suffix:colon
(brace
id|u16
id|tmp16
op_assign
l_int|0
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|bits-&gt;reg
comma
op_amp
id|tmp16
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp16
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|4
suffix:colon
(brace
id|u32
id|tmp32
op_assign
l_int|0
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|bits-&gt;reg
comma
op_amp
id|tmp32
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp32
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|tmp
op_and_assign
id|bits-&gt;mask
suffix:semicolon
r_return
(paren
id|tmp
op_eq
id|bits-&gt;val
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ata_init -&n; *&n; *&t;LOCKING:&n; *&n; *&t;RETURNS:&n; *&n; */
DECL|function|ata_init
r_static
r_int
id|__init
id|ata_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;libata version &quot;
id|DRV_VERSION
l_string|&quot; loaded.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ata_init
id|module_init
c_func
(paren
id|ata_init
)paren
suffix:semicolon
multiline_comment|/*&n; * libata is essentially a library of internal helper functions for&n; * low-level ATA host controller drivers.  As such, the API/ABI is&n; * likely to change as new drivers are added and updated.&n; * Do not depend on ABI/API stability.&n; */
DECL|variable|pci_test_config_bits
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|pci_test_config_bits
)paren
suffix:semicolon
DECL|variable|ata_std_ports
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_std_ports
)paren
suffix:semicolon
DECL|variable|ata_device_add
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_device_add
)paren
suffix:semicolon
DECL|variable|ata_qc_complete
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_qc_complete
)paren
suffix:semicolon
DECL|variable|ata_eng_timeout
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_eng_timeout
)paren
suffix:semicolon
DECL|variable|ata_tf_load_pio
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_tf_load_pio
)paren
suffix:semicolon
DECL|variable|ata_tf_load_mmio
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_tf_load_mmio
)paren
suffix:semicolon
DECL|variable|ata_tf_read_pio
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_tf_read_pio
)paren
suffix:semicolon
DECL|variable|ata_tf_read_mmio
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_tf_read_mmio
)paren
suffix:semicolon
DECL|variable|ata_check_status_pio
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_check_status_pio
)paren
suffix:semicolon
DECL|variable|ata_check_status_mmio
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_check_status_mmio
)paren
suffix:semicolon
DECL|variable|ata_exec_command_pio
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_exec_command_pio
)paren
suffix:semicolon
DECL|variable|ata_exec_command_mmio
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_exec_command_mmio
)paren
suffix:semicolon
DECL|variable|ata_port_start
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_port_start
)paren
suffix:semicolon
DECL|variable|ata_port_stop
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_port_stop
)paren
suffix:semicolon
DECL|variable|ata_interrupt
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_interrupt
)paren
suffix:semicolon
DECL|variable|ata_fill_sg
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_fill_sg
)paren
suffix:semicolon
DECL|variable|ata_bmdma_start_pio
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_bmdma_start_pio
)paren
suffix:semicolon
DECL|variable|ata_bmdma_start_mmio
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_bmdma_start_mmio
)paren
suffix:semicolon
DECL|variable|ata_port_probe
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_port_probe
)paren
suffix:semicolon
DECL|variable|sata_phy_reset
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|sata_phy_reset
)paren
suffix:semicolon
DECL|variable|pata_phy_config
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|pata_phy_config
)paren
suffix:semicolon
DECL|variable|ata_bus_reset
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_bus_reset
)paren
suffix:semicolon
DECL|variable|ata_port_disable
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_port_disable
)paren
suffix:semicolon
DECL|variable|ata_pci_init_one
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_pci_init_one
)paren
suffix:semicolon
DECL|variable|ata_pci_remove_one
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_pci_remove_one
)paren
suffix:semicolon
DECL|variable|ata_scsi_queuecmd
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_scsi_queuecmd
)paren
suffix:semicolon
DECL|variable|ata_scsi_error
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_scsi_error
)paren
suffix:semicolon
DECL|variable|ata_scsi_slave_config
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_scsi_slave_config
)paren
suffix:semicolon
DECL|variable|ata_scsi_release
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ata_scsi_release
)paren
suffix:semicolon
eof
