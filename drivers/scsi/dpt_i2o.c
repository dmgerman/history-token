multiline_comment|/***************************************************************************&n;                          dpti.c  -  description&n;                             -------------------&n;    begin                : Thu Sep 7 2000&n;    copyright            : (C) 2000 by Adaptec&n;    email                : deanna_bonds@adaptec.com&n;&n;&t;&t;&t;   July 30, 2001 First version being submitted&n;&t;&t;&t;   for inclusion in the kernel.  V2.4&n;&n;    See Documentation/scsi/dpti.txt for history, notes, license info&n;    and credits&n; ***************************************************************************/
multiline_comment|/***************************************************************************&n; *                                                                         *&n; *   This program is free software; you can redistribute it and/or modify  *&n; *   it under the terms of the GNU General Public License as published by  *&n; *   the Free Software Foundation; either version 2 of the License, or     *&n; *   (at your option) any later version.                                   *&n; *                                                                         *&n; ***************************************************************************/
singleline_comment|//#define DEBUG 1
singleline_comment|//#define UARTDELAY 1
singleline_comment|// On the real kernel ADDR32 should always be zero for 2.4. GFP_HIGH allocates
singleline_comment|// high pages. Keep the macro around because of the broken unmerged ia64 tree
DECL|macro|ADDR32
mdefine_line|#define ADDR32 (0)
macro_line|#error Please convert me to Documentation/DMA-mapping.txt
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Deanna Bonds, with _lots_ of help from Mark Salyzyn&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Adaptec I2O RAID Driver&quot;
)paren
suffix:semicolon
singleline_comment|////////////////////////////////////////////////////////////////
macro_line|#include &lt;linux/ioctl.h&gt;&t;/* For SCSI-Passthrough */
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/slab.h&gt;&t;&t;/* for kmalloc() */
macro_line|#include &lt;linux/config.h&gt;&t;/* for CONFIG_PCI */
macro_line|#include &lt;linux/pci.h&gt;&t;&t;/* for PCI support */
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/delay.h&gt;&t;/* for udelay */
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;&t;/* for printk */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;asm/processor.h&gt;&t;/* for boot_cpu_data */
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/io.h&gt;&t;&t;/* for virt_to_bus, etc. */
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;dpt/dptsig.h&quot;
macro_line|#include &quot;dpti.h&quot;
multiline_comment|/*============================================================================&n; * Create a binary signature - this is read by dptsig&n; * Needed for our management apps&n; *============================================================================&n; */
DECL|variable|DPTI_sig
r_static
id|dpt_sig_S
id|DPTI_sig
op_assign
(brace
(brace
l_char|&squot;d&squot;
comma
l_char|&squot;P&squot;
comma
l_char|&squot;t&squot;
comma
l_char|&squot;S&squot;
comma
l_char|&squot;i&squot;
comma
l_char|&squot;G&squot;
)brace
comma
id|SIG_VERSION
comma
macro_line|#ifdef __i386__
id|PROC_INTEL
comma
id|PROC_386
op_or
id|PROC_486
op_or
id|PROC_PENTIUM
op_or
id|PROC_SEXIUM
comma
macro_line|#elif defined(__ia64__)
id|PROC_INTEL
comma
id|PROC_IA64
comma
macro_line|#elif defined(__sparc__)
id|PROC_ULTRASPARC
comma
macro_line|#elif defined(__alpha__)
id|PROC_ALPHA
comma
macro_line|#else
(paren
op_minus
l_int|1
)paren
comma
(paren
op_minus
l_int|1
)paren
macro_line|#endif
id|FT_HBADRVR
comma
l_int|0
comma
id|OEM_DPT
comma
id|OS_LINUX
comma
id|CAP_OVERLAP
comma
id|DEV_ALL
comma
id|ADF_ALL_SC5
comma
l_int|0
comma
l_int|0
comma
id|DPT_VERSION
comma
id|DPT_REVISION
comma
id|DPT_SUBREVISION
comma
id|DPT_MONTH
comma
id|DPT_DAY
comma
id|DPT_YEAR
comma
l_string|&quot;Adaptec Linux I2O RAID Driver&quot;
)brace
suffix:semicolon
multiline_comment|/*============================================================================&n; * Globals&n; *============================================================================&n; */
DECL|variable|adpt_configuration_lock
id|DECLARE_MUTEX
c_func
(paren
id|adpt_configuration_lock
)paren
suffix:semicolon
DECL|variable|sys_tbl
r_static
r_struct
id|i2o_sys_tbl
op_star
id|sys_tbl
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|sys_tbl_ind
r_static
r_int
id|sys_tbl_ind
op_assign
l_int|0
suffix:semicolon
DECL|variable|sys_tbl_len
r_static
r_int
id|sys_tbl_len
op_assign
l_int|0
suffix:semicolon
DECL|variable|hbas
r_static
id|adpt_hba
op_star
id|hbas
(braket
id|DPTI_MAX_HBA
)braket
suffix:semicolon
DECL|variable|hba_chain
r_static
id|adpt_hba
op_star
id|hba_chain
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|hba_count
r_static
r_int
id|hba_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|adpt_fops
r_static
r_struct
id|file_operations
id|adpt_fops
op_assign
(brace
dot
id|ioctl
op_assign
id|adpt_ioctl
comma
dot
id|open
op_assign
id|adpt_open
comma
dot
id|release
op_assign
id|adpt_close
)brace
suffix:semicolon
macro_line|#ifdef REBOOT_NOTIFIER
DECL|variable|adpt_reboot_notifier
r_static
r_struct
id|notifier_block
id|adpt_reboot_notifier
op_assign
(brace
id|adpt_reboot_event
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* Structures and definitions for synchronous message posting.&n; * See adpt_i2o_post_wait() for description&n; * */
DECL|struct|adpt_i2o_post_wait_data
r_struct
id|adpt_i2o_post_wait_data
(brace
DECL|member|status
r_int
id|status
suffix:semicolon
DECL|member|id
id|u32
id|id
suffix:semicolon
DECL|member|wq
id|adpt_wait_queue_head_t
op_star
id|wq
suffix:semicolon
DECL|member|next
r_struct
id|adpt_i2o_post_wait_data
op_star
id|next
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|adpt_post_wait_queue
r_static
r_struct
id|adpt_i2o_post_wait_data
op_star
id|adpt_post_wait_queue
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|adpt_post_wait_id
r_static
id|u32
id|adpt_post_wait_id
op_assign
l_int|0
suffix:semicolon
DECL|variable|adpt_post_wait_lock
r_static
id|spinlock_t
id|adpt_post_wait_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*============================================================================&n; * &t;&t;&t;&t;Functions&n; *============================================================================&n; */
DECL|function|adpt_read_blink_led
r_static
id|u8
id|adpt_read_blink_led
c_func
(paren
id|adpt_hba
op_star
id|host
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;FwDebugBLEDflag_P
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|readb
c_func
(paren
id|host-&gt;FwDebugBLEDflag_P
)paren
op_eq
l_int|0xbc
)paren
(brace
r_return
id|readb
c_func
(paren
id|host-&gt;FwDebugBLEDvalue_P
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; * Scsi host template interface functions&n; *============================================================================&n; */
DECL|variable|dptids
r_static
r_struct
id|pci_device_id
id|dptids
(braket
)braket
op_assign
(brace
(brace
id|PCI_DPT_VENDOR_ID
comma
id|PCI_DPT_DEVICE_ID
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
id|PCI_DPT_VENDOR_ID
comma
id|PCI_DPT_RAPTOR_DEVICE_ID
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|dptids
)paren
suffix:semicolon
DECL|function|adpt_detect
r_static
r_int
id|adpt_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|sht
)paren
(brace
r_struct
id|pci_dev
op_star
id|pDev
op_assign
l_int|NULL
suffix:semicolon
id|adpt_hba
op_star
id|pHba
suffix:semicolon
id|adpt_init
c_func
(paren
)paren
suffix:semicolon
id|PINFO
c_func
(paren
l_string|&quot;Detecting Adaptec I2O RAID controllers...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* search for all Adatpec I2O RAID cards */
r_while
c_loop
(paren
(paren
id|pDev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_DPT_VENDOR_ID
comma
id|PCI_ANY_ID
comma
id|pDev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pDev-&gt;device
op_eq
id|PCI_DPT_DEVICE_ID
op_logical_or
id|pDev-&gt;device
op_eq
id|PCI_DPT_RAPTOR_DEVICE_ID
)paren
(brace
r_if
c_cond
(paren
id|adpt_install_hba
c_func
(paren
id|sht
comma
id|pDev
)paren
)paren
(brace
id|PERROR
c_func
(paren
l_string|&quot;Could not Init an I2O RAID device&bslash;n&quot;
)paren
suffix:semicolon
id|PERROR
c_func
(paren
l_string|&quot;Will not try to detect others.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|hba_count
op_minus
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* In INIT state, Activate IOPs */
r_for
c_loop
(paren
id|pHba
op_assign
id|hba_chain
suffix:semicolon
id|pHba
suffix:semicolon
id|pHba
op_assign
id|pHba-&gt;next
)paren
(brace
singleline_comment|// Activate does get status , init outbound, and get hrt
r_if
c_cond
(paren
id|adpt_i2o_activate_hba
c_func
(paren
id|pHba
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Active IOPs in HOLD state */
id|rebuild_sys_tab
suffix:colon
r_if
c_cond
(paren
id|hba_chain
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * If build_sys_table fails, we kill everything and bail&n;&t; * as we can&squot;t init the IOPs w/o a system table&n;&t; */
r_if
c_cond
(paren
id|adpt_i2o_build_sys_table
c_func
(paren
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_sys_shutdown
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_string|&quot;HBA&squot;s in HOLD state&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* If IOP don&squot;t get online, we need to rebuild the System table */
r_for
c_loop
(paren
id|pHba
op_assign
id|hba_chain
suffix:semicolon
id|pHba
suffix:semicolon
id|pHba
op_assign
id|pHba-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|adpt_i2o_online_hba
c_func
(paren
id|pHba
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_goto
id|rebuild_sys_tab
suffix:semicolon
)brace
)brace
multiline_comment|/* Active IOPs now in OPERATIONAL state */
id|PDEBUG
c_func
(paren
l_string|&quot;HBA&squot;s in OPERATIONAL state&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;dpti: If you have a lot of devices this could take a few minutes.&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pHba
op_assign
id|hba_chain
suffix:semicolon
id|pHba
suffix:semicolon
id|pHba
op_assign
id|pHba-&gt;next
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Reading the hardware resource table.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adpt_i2o_lct_get
c_func
(paren
id|pHba
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adpt_i2o_parse_lct
c_func
(paren
id|pHba
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|adpt_inquiry
c_func
(paren
id|pHba
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|pHba
op_assign
id|hba_chain
suffix:semicolon
id|pHba
suffix:semicolon
id|pHba
op_assign
id|pHba-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|adpt_scsi_register
c_func
(paren
id|pHba
comma
id|sht
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pHba-&gt;initialized
op_assign
id|TRUE
suffix:semicolon
id|pHba-&gt;state
op_and_assign
op_complement
id|DPTI_STATE_RESET
suffix:semicolon
)brace
singleline_comment|// Register our control device node
singleline_comment|// nodes will need to be created in /dev to access this
singleline_comment|// the nodes can not be created from within the driver
r_if
c_cond
(paren
id|hba_count
op_logical_and
id|register_chrdev
c_func
(paren
id|DPTI_I2O_MAJOR
comma
id|DPT_DRIVER
comma
op_amp
id|adpt_fops
)paren
)paren
(brace
id|adpt_i2o_sys_shutdown
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|hba_count
suffix:semicolon
)brace
multiline_comment|/*&n; * scsi_unregister will be called AFTER we return. &n; */
DECL|function|adpt_release
r_static
r_int
id|adpt_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|adpt_hba
op_star
id|pHba
op_assign
(paren
id|adpt_hba
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
singleline_comment|//&t;adpt_i2o_quiesce_hba(pHba);
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_inquiry
r_static
r_void
id|adpt_inquiry
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|u32
id|msg
(braket
l_int|14
)braket
suffix:semicolon
id|u32
op_star
id|mptr
suffix:semicolon
id|u32
op_star
id|lenptr
suffix:semicolon
r_int
id|direction
suffix:semicolon
r_int
id|scsidir
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|u32
id|reqlen
suffix:semicolon
id|u8
op_star
id|buf
suffix:semicolon
id|u8
id|scb
(braket
l_int|16
)braket
suffix:semicolon
id|s32
id|rcode
suffix:semicolon
id|memset
c_func
(paren
id|msg
comma
l_int|0
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
id|buf
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
l_int|80
comma
id|GFP_KERNEL
op_or
id|ADDR32
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Could not allocate buffer&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|buf
comma
l_int|0
comma
l_int|36
)paren
suffix:semicolon
id|len
op_assign
l_int|36
suffix:semicolon
id|direction
op_assign
l_int|0x00000000
suffix:semicolon
id|scsidir
op_assign
l_int|0x40000000
suffix:semicolon
singleline_comment|// DATA IN  (iop&lt;--dev)
id|reqlen
op_assign
l_int|14
suffix:semicolon
singleline_comment|// SINGLE SGE
multiline_comment|/* Stick the headers on */
id|msg
(braket
l_int|0
)braket
op_assign
id|reqlen
op_lshift
l_int|16
op_or
id|SGL_OFFSET_12
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
(paren
l_int|0xff
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
)paren
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Adaptec/DPT Private stuff 
id|msg
(braket
l_int|4
)braket
op_assign
id|I2O_CMD_SCSI_EXEC
op_or
id|DPT_ORGANIZATION_ID
op_lshift
l_int|16
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
id|ADAPTER_TID
op_or
l_int|1
op_lshift
l_int|16
multiline_comment|/* Interpret*/
suffix:semicolon
multiline_comment|/* Direction, disconnect ok | sense data | simple queue , CDBLen */
singleline_comment|// I2O_SCB_FLAG_ENABLE_DISCONNECT | 
singleline_comment|// I2O_SCB_FLAG_SIMPLE_QUEUE_TAG | 
singleline_comment|// I2O_SCB_FLAG_SENSE_DATA_IN_MESSAGE;
id|msg
(braket
l_int|6
)braket
op_assign
id|scsidir
op_or
l_int|0x20a00000
op_or
l_int|6
multiline_comment|/* cmd len*/
suffix:semicolon
id|mptr
op_assign
id|msg
op_plus
l_int|7
suffix:semicolon
id|memset
c_func
(paren
id|scb
comma
l_int|0
comma
r_sizeof
(paren
id|scb
)paren
)paren
suffix:semicolon
singleline_comment|// Write SCSI command into the message - always 16 byte block 
id|scb
(braket
l_int|0
)braket
op_assign
id|INQUIRY
suffix:semicolon
id|scb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|scb
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|scb
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|scb
(braket
l_int|4
)braket
op_assign
l_int|36
suffix:semicolon
id|scb
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Don&squot;t care about the rest of scb
id|memcpy
c_func
(paren
id|mptr
comma
id|scb
comma
r_sizeof
(paren
id|scb
)paren
)paren
suffix:semicolon
id|mptr
op_add_assign
l_int|4
suffix:semicolon
id|lenptr
op_assign
id|mptr
op_increment
suffix:semicolon
multiline_comment|/* Remember me - fill in when we know */
multiline_comment|/* Now fill in the SGList and command */
op_star
id|lenptr
op_assign
id|len
suffix:semicolon
op_star
id|mptr
op_increment
op_assign
l_int|0xD0000000
op_or
id|direction
op_or
id|len
suffix:semicolon
op_star
id|mptr
op_increment
op_assign
id|virt_to_bus
c_func
(paren
id|buf
)paren
suffix:semicolon
singleline_comment|// Send it on it&squot;s way
id|rcode
op_assign
id|adpt_i2o_post_wait
c_func
(paren
id|pHba
comma
id|msg
comma
id|reqlen
op_lshift
l_int|2
comma
l_int|120
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcode
op_ne
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|pHba-&gt;detail
comma
l_string|&quot;Adaptec I2O RAID&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Inquiry Error (%d)&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|rcode
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|pHba-&gt;detail
comma
l_int|0
comma
r_sizeof
(paren
id|pHba-&gt;detail
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|pHba-&gt;detail
)paren
comma
l_string|&quot;Vendor: Adaptec &quot;
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|pHba-&gt;detail
(braket
l_int|16
)braket
)paren
comma
l_string|&quot; Model: &quot;
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|pHba-&gt;detail
(braket
l_int|24
)braket
)paren
comma
(paren
id|u8
op_star
)paren
op_amp
id|buf
(braket
l_int|16
)braket
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|pHba-&gt;detail
(braket
l_int|40
)braket
)paren
comma
l_string|&quot; FW: &quot;
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
id|pHba-&gt;detail
(braket
l_int|44
)braket
)paren
comma
(paren
id|u8
op_star
)paren
op_amp
id|buf
(braket
l_int|32
)braket
comma
l_int|4
)paren
suffix:semicolon
id|pHba-&gt;detail
(braket
l_int|48
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* precautionary */
)brace
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
id|adpt_i2o_status_get
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|adpt_slave_configure
r_static
r_int
id|adpt_slave_configure
c_func
(paren
id|Scsi_Device
op_star
id|device
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|device-&gt;host
suffix:semicolon
id|adpt_hba
op_star
id|pHba
suffix:semicolon
id|pHba
op_assign
(paren
id|adpt_hba
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;can_queue
op_logical_and
id|device-&gt;tagged_supported
)paren
(brace
id|scsi_adjust_queue_depth
c_func
(paren
id|device
comma
id|MSG_SIMPLE_TAG
comma
id|host-&gt;can_queue
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|scsi_adjust_queue_depth
c_func
(paren
id|device
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_queue
r_static
r_int
id|adpt_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|adpt_hba
op_star
id|pHba
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|adpt_device
op_star
id|pDev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* dpt per device information */
id|ulong
id|timeout
op_assign
id|jiffies
op_plus
(paren
id|TMOUT_SCSI
op_star
id|HZ
)paren
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
multiline_comment|/*&n;&t; * SCSI REQUEST_SENSE commands will be executed automatically by the &n;&t; * Host Adapter for any errors, so they should not be executed &n;&t; * explicitly unless the Sense Data is zero indicating that no error &n;&t; * occurred.&n;&t; */
r_if
c_cond
(paren
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
op_logical_and
(paren
id|cmd-&gt;sense_buffer
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
)paren
(brace
id|cmd-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pHba
op_assign
(paren
id|adpt_hba
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pHba
)paren
(brace
r_return
id|FAILED
suffix:semicolon
)brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * TODO: I need to block here if I am processing ioctl cmds&n;&t; * but if the outstanding cmds all finish before the ioctl,&n;&t; * the scsi-core will not know to start sending cmds to me again.&n;&t; * I need to a way to restart the scsi-cores queues or should I block&n;&t; * calling scsi_done on the outstanding cmds instead&n;&t; * for now we don&squot;t set the IOCTL state&n;&t; */
r_if
c_cond
(paren
(paren
(paren
id|pHba-&gt;state
)paren
op_amp
id|DPTI_STATE_IOCTL
)paren
op_logical_or
(paren
(paren
id|pHba-&gt;state
)paren
op_amp
id|DPTI_STATE_RESET
)paren
)paren
(brace
id|pHba-&gt;host-&gt;last_reset
op_assign
id|jiffies
suffix:semicolon
id|pHba-&gt;host-&gt;resetting
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd-&gt;eh_state
op_ne
id|SCSI_STATE_QUEUED
)paren
(brace
singleline_comment|// If we are not doing error recovery
id|mod_timer
c_func
(paren
op_amp
id|cmd-&gt;eh_timeout
comma
id|timeout
)paren
suffix:semicolon
)brace
singleline_comment|// TODO if the cmd-&gt;device if offline then I may need to issue a bus rescan
singleline_comment|// followed by a get_lct to see if the device is there anymore
r_if
c_cond
(paren
(paren
id|pDev
op_assign
(paren
r_struct
id|adpt_device
op_star
)paren
(paren
id|cmd-&gt;device-&gt;hostdata
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t; * First command request for this device.  Set up a pointer&n;&t;&t; * to the device structure.  This should be a TEST_UNIT_READY&n;&t;&t; * command from scan_scsis_single.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|pDev
op_assign
id|adpt_find_device
c_func
(paren
id|pHba
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;channel
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;id
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;lun
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
singleline_comment|// TODO: if any luns are at this bus, scsi id then fake a TEST_UNIT_READY and INQUIRY response 
singleline_comment|// with type 7F (for all luns less than the max for this bus,id) so the lun scan will continue.
id|cmd-&gt;result
op_assign
(paren
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
suffix:semicolon
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
(paren
r_struct
id|adpt_device
op_star
)paren
(paren
id|cmd-&gt;device-&gt;hostdata
)paren
op_assign
id|pDev
suffix:semicolon
)brace
id|pDev-&gt;pScsi_dev
op_assign
id|cmd-&gt;device
suffix:semicolon
multiline_comment|/*&n;&t; * If we are being called from when the device is being reset, &n;&t; * delay processing of the command until later.&n;&t; */
r_if
c_cond
(paren
id|pDev-&gt;state
op_amp
id|DPTI_DEV_RESET
)paren
(brace
r_return
id|FAILED
suffix:semicolon
)brace
r_return
id|adpt_scsi_to_i2o
c_func
(paren
id|pHba
comma
id|cmd
comma
id|pDev
)paren
suffix:semicolon
)brace
DECL|function|adpt_bios_param
r_static
r_int
id|adpt_bios_param
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
comma
r_struct
id|block_device
op_star
id|dev
comma
id|sector_t
id|capacity
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_int
id|heads
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|sectors
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|cylinders
op_assign
op_minus
l_int|1
suffix:semicolon
singleline_comment|// *** First lets set the default geometry ****
singleline_comment|// If the capacity is less than ox2000
r_if
c_cond
(paren
id|capacity
OL
l_int|0x2000
)paren
(brace
singleline_comment|// floppy
id|heads
op_assign
l_int|18
suffix:semicolon
id|sectors
op_assign
l_int|2
suffix:semicolon
)brace
singleline_comment|// else if between 0x2000 and 0x20000
r_else
r_if
c_cond
(paren
id|capacity
OL
l_int|0x20000
)paren
(brace
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
)brace
singleline_comment|// else if between 0x20000 and 0x40000
r_else
r_if
c_cond
(paren
id|capacity
OL
l_int|0x40000
)paren
(brace
id|heads
op_assign
l_int|65
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
)brace
singleline_comment|// else if between 0x4000 and 0x80000
r_else
r_if
c_cond
(paren
id|capacity
OL
l_int|0x80000
)paren
(brace
id|heads
op_assign
l_int|128
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
)brace
singleline_comment|// else if greater than 0x80000
r_else
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
)brace
id|cylinders
op_assign
id|capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
singleline_comment|// Special case if CDROM
r_if
c_cond
(paren
id|sdev-&gt;type
op_eq
l_int|5
)paren
(brace
singleline_comment|// CDROM
id|heads
op_assign
l_int|252
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
l_int|1111
suffix:semicolon
)brace
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;adpt_bios_param: exit&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_info
r_static
r_const
r_char
op_star
id|adpt_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
id|adpt_hba
op_star
id|pHba
suffix:semicolon
id|pHba
op_assign
(paren
id|adpt_hba
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_return
(paren
r_char
op_star
)paren
(paren
id|pHba-&gt;detail
)paren
suffix:semicolon
)brace
DECL|function|adpt_proc_info
r_static
r_int
id|adpt_proc_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|inout
)paren
(brace
r_struct
id|adpt_device
op_star
id|d
suffix:semicolon
r_int
id|id
suffix:semicolon
r_int
id|chan
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|pos
op_assign
l_int|0
suffix:semicolon
id|adpt_hba
op_star
id|pHba
suffix:semicolon
r_int
id|unit
suffix:semicolon
op_star
id|start
op_assign
id|buffer
suffix:semicolon
r_if
c_cond
(paren
id|inout
op_eq
id|TRUE
)paren
(brace
multiline_comment|/*&n;&t;&t; * The user has done a write and wants us to take the&n;&t;&t; * data in the buffer and do something with it.&n;&t;&t; * proc_scsiwrite calls us with inout = 1&n;&t;&t; *&n;&t;&t; * Read data from buffer (writing to us) - NOT SUPPORTED&n;&t;&t; */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * inout = 0 means the user has done a read and wants information&n;&t; * returned, so we write information about the cards into the buffer&n;&t; * proc_scsiread() calls us with inout = 0&n;&t; */
singleline_comment|// Find HBA (host bus adapter) we are looking for
id|down
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pHba
op_assign
id|hba_chain
suffix:semicolon
id|pHba
suffix:semicolon
id|pHba
op_assign
id|pHba-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pHba-&gt;host
op_eq
id|host
)paren
(brace
r_break
suffix:semicolon
multiline_comment|/* found adapter */
)brace
)brace
id|up
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pHba
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|host
op_assign
id|pHba-&gt;host
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Adaptec I2O RAID Driver Version: %s&bslash;n&bslash;n&quot;
comma
id|DPT_I2O_VERSION
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|pHba-&gt;detail
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;SCSI Host=scsi%d  Control Node=/dev/%s  irq=%d&bslash;n&quot;
comma
id|pHba-&gt;host-&gt;host_no
comma
id|pHba-&gt;name
comma
id|host-&gt;irq
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;tpost fifo size  = %d&bslash;n&bslash;treply fifo size = %d&bslash;n&bslash;tsg table size   = %d&bslash;n&bslash;n&quot;
comma
id|host-&gt;can_queue
comma
(paren
r_int
)paren
id|pHba-&gt;reply_fifo_size
comma
id|host-&gt;sg_tablesize
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
multiline_comment|/* CHECKPOINT */
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_goto
id|stop_output
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
op_le
id|offset
)paren
(brace
multiline_comment|/*&n;&t;&t; * If we haven&squot;t even written to where we last left&n;&t;&t; * off (the last time we were called), reset the &n;&t;&t; * beginning pointer.&n;&t;&t; */
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;Devices:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|chan
op_assign
l_int|0
suffix:semicolon
id|chan
OL
id|MAX_CHANNEL
suffix:semicolon
id|chan
op_increment
)paren
(brace
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|MAX_ID
suffix:semicolon
id|id
op_increment
)paren
(brace
id|d
op_assign
id|pHba-&gt;channel
(braket
id|chan
)braket
dot
id|device
(braket
id|id
)braket
suffix:semicolon
r_while
c_loop
(paren
id|d
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;t%-24.24s&quot;
comma
id|d-&gt;pScsi_dev-&gt;vendor
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot; Rev: %-8.8s&bslash;n&quot;
comma
id|d-&gt;pScsi_dev-&gt;rev
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
multiline_comment|/* CHECKPOINT */
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_goto
id|stop_output
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
op_le
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
id|unit
op_assign
id|d-&gt;pI2o_dev-&gt;lct_data.tid
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;tTID=%d, (Channel=%d, Target=%d, Lun=%d)  (%s)&bslash;n&bslash;n&quot;
comma
id|unit
comma
(paren
r_int
)paren
id|d-&gt;scsi_channel
comma
(paren
r_int
)paren
id|d-&gt;scsi_id
comma
(paren
r_int
)paren
id|d-&gt;scsi_lun
comma
id|d-&gt;pScsi_dev-&gt;online
ques
c_cond
l_string|&quot;online&quot;
suffix:colon
l_string|&quot;offline&quot;
)paren
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
multiline_comment|/* CHECKPOINT */
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_goto
id|stop_output
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
op_le
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
id|d
op_assign
id|d-&gt;next_lun
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;&t; * begin is where we last checked our position with regards to offset&n;&t; * begin is always less than offset.  len is relative to begin.  It&n;&t; * is the number of bytes written past begin&n;&t; *&n;&t; */
id|stop_output
suffix:colon
multiline_comment|/* stop the output and calculate the correct length */
op_star
(paren
id|buffer
op_plus
id|len
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
multiline_comment|/* Start of wanted data */
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
op_star
op_star
id|start
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*===========================================================================&n; * Error Handling routines&n; *===========================================================================&n; */
DECL|function|adpt_abort
r_static
r_int
id|adpt_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|adpt_hba
op_star
id|pHba
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* host bus adapter structure */
r_struct
id|adpt_device
op_star
id|dptdevice
suffix:semicolon
multiline_comment|/* dpt per device information */
id|u32
id|msg
(braket
l_int|5
)braket
suffix:semicolon
r_int
id|rcode
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;serial_number
op_eq
l_int|0
)paren
(brace
r_return
id|FAILED
suffix:semicolon
)brace
id|pHba
op_assign
(paren
id|adpt_hba
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Trying to Abort cmd=%ld&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|cmd-&gt;serial_number
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dptdevice
op_assign
(paren
r_void
op_star
)paren
(paren
id|cmd-&gt;device-&gt;hostdata
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to abort: No device in cmnd&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|memset
c_func
(paren
id|msg
comma
l_int|0
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FIVE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_SCSI_ABORT
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|dptdevice-&gt;tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
(paren
id|u32
)paren
id|cmd
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rcode
op_assign
id|adpt_i2o_post_wait
c_func
(paren
id|pHba
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
id|FOREVER
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rcode
op_eq
op_minus
id|EOPNOTSUPP
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Abort cmd not supported&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Abort cmd=%ld failed.&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|cmd-&gt;serial_number
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Abort cmd=%ld complete.&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|cmd-&gt;serial_number
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
DECL|macro|I2O_DEVICE_RESET
mdefine_line|#define I2O_DEVICE_RESET 0x27
singleline_comment|// This is the same for BLK and SCSI devices
singleline_comment|// NOTE this is wrong in the i2o.h definitions
singleline_comment|// This is not currently supported by our adapter but we issue it anyway
DECL|function|adpt_device_reset
r_static
r_int
id|adpt_device_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|adpt_hba
op_star
id|pHba
suffix:semicolon
id|u32
id|msg
(braket
l_int|4
)braket
suffix:semicolon
id|u32
id|rcode
suffix:semicolon
r_int
id|old_state
suffix:semicolon
r_struct
id|adpt_device
op_star
id|d
op_assign
(paren
r_void
op_star
)paren
id|cmd-&gt;device-&gt;hostdata
suffix:semicolon
id|pHba
op_assign
(paren
r_void
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Trying to reset device&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|d
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Reset Device: Device Not found&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|memset
c_func
(paren
id|msg
comma
l_int|0
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
(paren
id|I2O_DEVICE_RESET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|d-&gt;tid
)paren
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|old_state
op_assign
id|d-&gt;state
suffix:semicolon
id|d-&gt;state
op_or_assign
id|DPTI_DEV_RESET
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rcode
op_assign
id|adpt_i2o_post_wait
c_func
(paren
id|pHba
comma
(paren
r_void
op_star
)paren
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
id|FOREVER
)paren
)paren
)paren
(brace
id|d-&gt;state
op_assign
id|old_state
suffix:semicolon
r_if
c_cond
(paren
id|rcode
op_eq
op_minus
id|EOPNOTSUPP
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Device reset not supported&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Device reset failed&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;state
op_assign
id|old_state
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Device reset successful&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
)brace
DECL|macro|I2O_HBA_BUS_RESET
mdefine_line|#define I2O_HBA_BUS_RESET 0x87
singleline_comment|// This version of bus reset is called by the eh_error handler
DECL|function|adpt_bus_reset
r_static
r_int
id|adpt_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|adpt_hba
op_star
id|pHba
suffix:semicolon
id|u32
id|msg
(braket
l_int|4
)braket
suffix:semicolon
id|pHba
op_assign
(paren
id|adpt_hba
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|memset
c_func
(paren
id|msg
comma
l_int|0
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Bus reset: SCSI Bus %d: tid: %d&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|cmd-&gt;device-&gt;channel
comma
id|pHba-&gt;channel
(braket
id|cmd-&gt;device-&gt;channel
)braket
dot
id|tid
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
(paren
id|I2O_HBA_BUS_RESET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|pHba-&gt;channel
(braket
id|cmd-&gt;device-&gt;channel
)braket
dot
id|tid
)paren
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|adpt_i2o_post_wait
c_func
(paren
id|pHba
comma
(paren
r_void
op_star
)paren
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
id|FOREVER
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Bus reset failed.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Bus reset success.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
)brace
singleline_comment|// This version of reset is called by the eh_error_handler
DECL|function|adpt_reset
r_static
r_int
id|adpt_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|adpt_hba
op_star
id|pHba
suffix:semicolon
r_int
id|rcode
suffix:semicolon
id|pHba
op_assign
(paren
id|adpt_hba
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Hba Reset: scsi id %d: tid: %d&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|cmd-&gt;device-&gt;channel
comma
id|pHba-&gt;channel
(braket
id|cmd-&gt;device-&gt;channel
)braket
dot
id|tid
)paren
suffix:semicolon
id|rcode
op_assign
id|adpt_hba_reset
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcode
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: HBA reset complete&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: HBA reset failed (%x)&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|rcode
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
)brace
singleline_comment|// This version of reset is called by the ioctls and indirectly from eh_error_handler via adpt_reset
DECL|function|adpt_hba_reset
r_static
r_int
id|adpt_hba_reset
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
r_int
id|rcode
suffix:semicolon
id|pHba-&gt;state
op_or_assign
id|DPTI_STATE_RESET
suffix:semicolon
singleline_comment|// Activate does get status , init outbound, and get hrt
r_if
c_cond
(paren
(paren
id|rcode
op_assign
id|adpt_i2o_activate_hba
c_func
(paren
id|pHba
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Could not activate&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
id|rcode
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rcode
op_assign
id|adpt_i2o_build_sys_table
c_func
(paren
)paren
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
id|rcode
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_string|&quot;%s: in HOLD state&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rcode
op_assign
id|adpt_i2o_online_hba
c_func
(paren
id|pHba
)paren
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
id|rcode
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_string|&quot;%s: in OPERATIONAL state&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rcode
op_assign
id|adpt_i2o_lct_get
c_func
(paren
id|pHba
)paren
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
id|rcode
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rcode
op_assign
id|adpt_i2o_reparse_lct
c_func
(paren
id|pHba
)paren
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
id|rcode
suffix:semicolon
)brace
id|pHba-&gt;state
op_and_assign
op_complement
id|DPTI_STATE_RESET
suffix:semicolon
id|adpt_fail_posted_scbs
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* return success */
)brace
multiline_comment|/*===========================================================================&n; * &n; *===========================================================================&n; */
DECL|function|adpt_i2o_sys_shutdown
r_static
r_void
id|adpt_i2o_sys_shutdown
c_func
(paren
r_void
)paren
(brace
id|adpt_hba
op_star
id|pHba
comma
op_star
id|pNext
suffix:semicolon
r_struct
id|adpt_i2o_post_wait_data
op_star
id|p1
comma
op_star
id|p2
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Shutting down Adaptec I2O controllers.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;   This could take a few minutes if there are many devices attached&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Delete all IOPs from the controller chain */
multiline_comment|/* They should have already been released by the&n;&t; * scsi-core&n;&t; */
r_for
c_loop
(paren
id|pHba
op_assign
id|hba_chain
suffix:semicolon
id|pHba
suffix:semicolon
id|pHba
op_assign
id|pNext
)paren
(brace
id|pNext
op_assign
id|pHba-&gt;next
suffix:semicolon
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
)brace
multiline_comment|/* Remove any timedout entries from the wait queue.  */
id|p2
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//&t;spin_lock_irqsave(&amp;adpt_post_wait_lock, flags);
multiline_comment|/* Nothing should be outstanding at this point so just&n;&t; * free them &n;&t; */
r_for
c_loop
(paren
id|p1
op_assign
id|adpt_post_wait_queue
suffix:semicolon
id|p1
suffix:semicolon
id|p2
op_assign
id|p1
comma
id|p1
op_assign
id|p2-&gt;next
)paren
(brace
id|kfree
c_func
(paren
id|p1
)paren
suffix:semicolon
)brace
singleline_comment|//&t;spin_unlock_irqrestore(&amp;adpt_post_wait_lock, flags);
id|adpt_post_wait_queue
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Adaptec I2O controllers down.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * reboot/shutdown notification.&n; *&n; * - Quiesce each IOP in the system&n; *&n; */
macro_line|#ifdef REBOOT_NOTIFIER
DECL|function|adpt_reboot_event
r_static
r_int
id|adpt_reboot_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|n
comma
id|ulong
id|code
comma
r_void
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
id|code
op_ne
id|SYS_RESTART
op_logical_and
id|code
op_ne
id|SYS_HALT
op_logical_and
id|code
op_ne
id|SYS_POWER_OFF
)paren
(brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
id|adpt_i2o_sys_shutdown
c_func
(paren
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
macro_line|#endif
DECL|function|adpt_install_hba
r_static
r_int
id|adpt_install_hba
c_func
(paren
id|Scsi_Host_Template
op_star
id|sht
comma
r_struct
id|pci_dev
op_star
id|pDev
)paren
(brace
id|adpt_hba
op_star
id|pHba
op_assign
l_int|NULL
suffix:semicolon
id|adpt_hba
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
id|ulong
id|base_addr0_phys
op_assign
l_int|0
suffix:semicolon
id|ulong
id|base_addr1_phys
op_assign
l_int|0
suffix:semicolon
id|u32
id|hba_map0_area_size
op_assign
l_int|0
suffix:semicolon
id|u32
id|hba_map1_area_size
op_assign
l_int|0
suffix:semicolon
id|ulong
id|base_addr_virt
op_assign
l_int|0
suffix:semicolon
id|ulong
id|msg_addr_virt
op_assign
l_int|0
suffix:semicolon
r_int
id|raptorFlag
op_assign
id|FALSE
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pDev
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pDev
)paren
suffix:semicolon
id|base_addr0_phys
op_assign
id|pci_resource_start
c_func
(paren
id|pDev
comma
l_int|0
)paren
suffix:semicolon
id|hba_map0_area_size
op_assign
id|pci_resource_len
c_func
(paren
id|pDev
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// Check if standard PCI card or single BAR Raptor
r_if
c_cond
(paren
id|pDev-&gt;device
op_eq
id|PCI_DPT_DEVICE_ID
)paren
(brace
r_if
c_cond
(paren
id|pDev-&gt;subsystem_device
op_ge
l_int|0xc032
op_logical_and
id|pDev-&gt;subsystem_device
op_le
l_int|0xc03b
)paren
(brace
singleline_comment|// Raptor card with this device id needs 4M
id|hba_map0_area_size
op_assign
l_int|0x400000
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Not Raptor - it is a PCI card
r_if
c_cond
(paren
id|hba_map0_area_size
OG
l_int|0x100000
)paren
(brace
id|hba_map0_area_size
op_assign
l_int|0x100000
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
singleline_comment|// Raptor split BAR config
singleline_comment|// Use BAR1 in this configuration
id|base_addr1_phys
op_assign
id|pci_resource_start
c_func
(paren
id|pDev
comma
l_int|1
)paren
suffix:semicolon
id|hba_map1_area_size
op_assign
id|pci_resource_len
c_func
(paren
id|pDev
comma
l_int|1
)paren
suffix:semicolon
id|raptorFlag
op_assign
id|TRUE
suffix:semicolon
)brace
id|base_addr_virt
op_assign
(paren
id|ulong
)paren
id|ioremap
c_func
(paren
id|base_addr0_phys
comma
id|hba_map0_area_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base_addr_virt
op_eq
l_int|0
)paren
(brace
id|PERROR
c_func
(paren
l_string|&quot;dpti: adpt_config_hba: io remap failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|raptorFlag
op_eq
id|TRUE
)paren
(brace
id|msg_addr_virt
op_assign
(paren
id|ulong
)paren
id|ioremap
c_func
(paren
id|base_addr1_phys
comma
id|hba_map1_area_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg_addr_virt
op_eq
l_int|0
)paren
(brace
id|PERROR
c_func
(paren
l_string|&quot;dpti: adpt_config_hba: io remap failed on BAR1&bslash;n&quot;
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|base_addr_virt
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|msg_addr_virt
op_assign
id|base_addr_virt
suffix:semicolon
)brace
singleline_comment|// Allocate and zero the data structure
id|pHba
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|adpt_hba
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pHba
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|msg_addr_virt
op_ne
id|base_addr_virt
)paren
(brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|msg_addr_virt
)paren
suffix:semicolon
)brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|base_addr_virt
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pHba
comma
l_int|0
comma
r_sizeof
(paren
id|adpt_hba
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DPTI_MAX_HBA
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hbas
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|hbas
(braket
id|i
)braket
op_assign
id|pHba
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hba_chain
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|p
op_assign
id|hba_chain
suffix:semicolon
id|p-&gt;next
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
suffix:semicolon
)brace
id|p-&gt;next
op_assign
id|pHba
suffix:semicolon
)brace
r_else
(brace
id|hba_chain
op_assign
id|pHba
suffix:semicolon
)brace
id|pHba-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|pHba-&gt;unit
op_assign
id|hba_count
suffix:semicolon
id|sprintf
c_func
(paren
id|pHba-&gt;name
comma
l_string|&quot;dpti%d&quot;
comma
id|i
)paren
suffix:semicolon
id|hba_count
op_increment
suffix:semicolon
id|up
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
id|pHba-&gt;pDev
op_assign
id|pDev
suffix:semicolon
id|pHba-&gt;base_addr_phys
op_assign
id|base_addr0_phys
suffix:semicolon
singleline_comment|// Set up the Virtual Base Address of the I2O Device
id|pHba-&gt;base_addr_virt
op_assign
id|base_addr_virt
suffix:semicolon
id|pHba-&gt;msg_addr_virt
op_assign
id|msg_addr_virt
suffix:semicolon
id|pHba-&gt;irq_mask
op_assign
(paren
id|ulong
)paren
(paren
id|base_addr_virt
op_plus
l_int|0x30
)paren
suffix:semicolon
id|pHba-&gt;post_port
op_assign
(paren
id|ulong
)paren
(paren
id|base_addr_virt
op_plus
l_int|0x40
)paren
suffix:semicolon
id|pHba-&gt;reply_port
op_assign
(paren
id|ulong
)paren
(paren
id|base_addr_virt
op_plus
l_int|0x44
)paren
suffix:semicolon
id|pHba-&gt;hrt
op_assign
l_int|NULL
suffix:semicolon
id|pHba-&gt;lct
op_assign
l_int|NULL
suffix:semicolon
id|pHba-&gt;lct_size
op_assign
l_int|0
suffix:semicolon
id|pHba-&gt;status_block
op_assign
l_int|NULL
suffix:semicolon
id|pHba-&gt;post_count
op_assign
l_int|0
suffix:semicolon
id|pHba-&gt;state
op_assign
id|DPTI_STATE_RESET
suffix:semicolon
id|pHba-&gt;pDev
op_assign
id|pDev
suffix:semicolon
id|pHba-&gt;devices
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// Initializing the spinlocks
id|spin_lock_init
c_func
(paren
op_amp
id|pHba-&gt;state_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raptorFlag
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Adaptec I2O RAID controller %d at %lx size=%x irq=%d&bslash;n&quot;
comma
id|hba_count
op_minus
l_int|1
comma
id|base_addr_virt
comma
id|hba_map0_area_size
comma
id|pDev-&gt;irq
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Adaptec I2O RAID controller %d irq=%d&bslash;n&quot;
comma
id|hba_count
op_minus
l_int|1
comma
id|pDev-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;     BAR0 %lx - size= %x&bslash;n&quot;
comma
id|base_addr_virt
comma
id|hba_map0_area_size
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;     BAR1 %lx - size= %x&bslash;n&quot;
comma
id|msg_addr_virt
comma
id|hba_map1_area_size
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
(paren
id|pDev-&gt;irq
comma
id|adpt_isr
comma
id|SA_SHIRQ
comma
id|pHba-&gt;name
comma
id|pHba
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Couldn&squot;t register IRQ %d&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|pDev-&gt;irq
)paren
suffix:semicolon
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_i2o_delete_hba
r_static
r_void
id|adpt_i2o_delete_hba
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|adpt_hba
op_star
id|p1
suffix:semicolon
id|adpt_hba
op_star
id|p2
suffix:semicolon
r_struct
id|i2o_device
op_star
id|d
suffix:semicolon
r_struct
id|i2o_device
op_star
id|next
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|j
suffix:semicolon
r_struct
id|adpt_device
op_star
id|pDev
suffix:semicolon
r_struct
id|adpt_device
op_star
id|pNext
suffix:semicolon
id|down
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
singleline_comment|// scsi_unregister calls our adpt_release which
singleline_comment|// does a quiese
r_if
c_cond
(paren
id|pHba-&gt;host
)paren
(brace
id|free_irq
c_func
(paren
id|pHba-&gt;host-&gt;irq
comma
id|pHba
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DPTI_MAX_HBA
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hbas
(braket
id|i
)braket
op_eq
id|pHba
)paren
(brace
id|hbas
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|p2
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|p1
op_assign
id|hba_chain
suffix:semicolon
id|p1
suffix:semicolon
id|p2
op_assign
id|p1
comma
id|p1
op_assign
id|p1-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p1
op_eq
id|pHba
)paren
(brace
r_if
c_cond
(paren
id|p2
)paren
(brace
id|p2-&gt;next
op_assign
id|p1-&gt;next
suffix:semicolon
)brace
r_else
(brace
id|hba_chain
op_assign
id|p1-&gt;next
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|hba_count
op_decrement
suffix:semicolon
id|up
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|pHba-&gt;base_addr_virt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;msg_addr_virt
op_ne
id|pHba-&gt;base_addr_virt
)paren
(brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|pHba-&gt;msg_addr_virt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pHba-&gt;hrt
)paren
(brace
id|kfree
c_func
(paren
id|pHba-&gt;hrt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pHba-&gt;lct
)paren
(brace
id|kfree
c_func
(paren
id|pHba-&gt;lct
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pHba-&gt;status_block
)paren
(brace
id|kfree
c_func
(paren
id|pHba-&gt;status_block
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pHba-&gt;reply_pool
)paren
(brace
id|kfree
c_func
(paren
id|pHba-&gt;reply_pool
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|d
op_assign
id|pHba-&gt;devices
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|next
)paren
(brace
id|next
op_assign
id|d-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|d
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pHba-&gt;top_scsi_channel
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|MAX_ID
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pHba-&gt;channel
(braket
id|i
)braket
dot
id|device
(braket
id|j
)braket
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|pDev
op_assign
id|pHba-&gt;channel
(braket
id|i
)braket
dot
id|device
(braket
id|j
)braket
suffix:semicolon
id|pDev
suffix:semicolon
id|pDev
op_assign
id|pNext
)paren
(brace
id|pNext
op_assign
id|pDev-&gt;next_lun
suffix:semicolon
id|kfree
c_func
(paren
id|pDev
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|kfree
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hba_count
op_le
l_int|0
)paren
(brace
id|unregister_chrdev
c_func
(paren
id|DPTI_I2O_MAJOR
comma
id|DPT_DRIVER
)paren
suffix:semicolon
)brace
)brace
DECL|function|adpt_init
r_static
r_int
id|adpt_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Loading Adaptec I2O RAID: Version &quot;
id|DPT_I2O_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DPTI_MAX_HBA
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hbas
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef REBOOT_NOTIFIER
id|register_reboot_notifier
c_func
(paren
op_amp
id|adpt_reboot_notifier
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_find_device
r_static
r_struct
id|adpt_device
op_star
id|adpt_find_device
c_func
(paren
id|adpt_hba
op_star
id|pHba
comma
id|u32
id|chan
comma
id|u32
id|id
comma
id|u32
id|lun
)paren
(brace
r_struct
id|adpt_device
op_star
id|d
suffix:semicolon
r_if
c_cond
(paren
id|chan
OL
l_int|0
op_logical_or
id|chan
op_ge
id|MAX_CHANNEL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pHba-&gt;channel
(braket
id|chan
)braket
dot
id|device
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Adaptec I2O RAID: Trying to find device before they are allocated&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|d
op_assign
id|pHba-&gt;channel
(braket
id|chan
)braket
dot
id|device
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|d
op_logical_or
id|d-&gt;tid
op_eq
l_int|0
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* If it is the only lun at that address then this should match*/
r_if
c_cond
(paren
id|d-&gt;scsi_lun
op_eq
id|lun
)paren
(brace
r_return
id|d
suffix:semicolon
)brace
multiline_comment|/* else we need to look through all the luns */
r_for
c_loop
(paren
id|d
op_assign
id|d-&gt;next_lun
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next_lun
)paren
(brace
r_if
c_cond
(paren
id|d-&gt;scsi_lun
op_eq
id|lun
)paren
(brace
r_return
id|d
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|adpt_i2o_post_wait
r_static
r_int
id|adpt_i2o_post_wait
c_func
(paren
id|adpt_hba
op_star
id|pHba
comma
id|u32
op_star
id|msg
comma
r_int
id|len
comma
r_int
id|timeout
)paren
(brace
singleline_comment|// I used my own version of the WAIT_QUEUE_HEAD
singleline_comment|// to handle some version differences
singleline_comment|// When embedded in the kernel this could go back to the vanilla one
id|ADPT_DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|adpt_wq_i2o_post
)paren
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|ulong
id|flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|adpt_i2o_post_wait_data
op_star
id|p1
comma
op_star
id|p2
suffix:semicolon
r_struct
id|adpt_i2o_post_wait_data
op_star
id|wait_data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|adpt_i2o_post_wait_data
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|adpt_wait_queue_t
id|wait
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wait_data
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The spin locking is needed to keep anyone from playing&n;&t; * with the queue pointers and id while we do the same&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adpt_post_wait_lock
comma
id|flags
)paren
suffix:semicolon
singleline_comment|// TODO we need a MORE unique way of getting ids
singleline_comment|// to support async LCT get
id|wait_data-&gt;next
op_assign
id|adpt_post_wait_queue
suffix:semicolon
id|adpt_post_wait_queue
op_assign
id|wait_data
suffix:semicolon
id|adpt_post_wait_id
op_increment
suffix:semicolon
id|adpt_post_wait_id
op_and_assign
l_int|0x7fff
suffix:semicolon
id|wait_data-&gt;id
op_assign
id|adpt_post_wait_id
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adpt_post_wait_lock
comma
id|flags
)paren
suffix:semicolon
id|wait_data-&gt;wq
op_assign
op_amp
id|adpt_wq_i2o_post
suffix:semicolon
id|wait_data-&gt;status
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
singleline_comment|// this code is taken from kernel/sched.c:interruptible_sleep_on_timeout
id|wait.task
op_assign
id|current
suffix:semicolon
id|init_waitqueue_entry
c_func
(paren
op_amp
id|wait
comma
id|current
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adpt_wq_i2o_post.lock
comma
id|flags
)paren
suffix:semicolon
id|__add_wait_queue
c_func
(paren
op_amp
id|adpt_wq_i2o_post
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|adpt_wq_i2o_post.lock
)paren
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_or_assign
l_int|0x80000000
op_or
(paren
(paren
id|u32
)paren
id|wait_data-&gt;id
)paren
suffix:semicolon
id|timeout
op_mul_assign
id|HZ
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|adpt_i2o_post_this
c_func
(paren
id|pHba
comma
id|msg
comma
id|len
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|pHba-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_else
id|schedule_timeout
c_func
(paren
id|timeout
op_star
id|HZ
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|pHba-&gt;host-&gt;host_lock
)paren
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|adpt_wq_i2o_post.lock
)paren
suffix:semicolon
id|__remove_wait_queue
c_func
(paren
op_amp
id|adpt_wq_i2o_post
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adpt_wq_i2o_post.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|ETIMEDOUT
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;dpti%d: POST WAIT TIMEOUT&bslash;n&quot;
comma
id|pHba-&gt;unit
)paren
suffix:semicolon
singleline_comment|// We will have to free the wait_data memory during shutdown
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* Remove the entry from the queue.  */
id|p2
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adpt_post_wait_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p1
op_assign
id|adpt_post_wait_queue
suffix:semicolon
id|p1
suffix:semicolon
id|p2
op_assign
id|p1
comma
id|p1
op_assign
id|p1-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p1
op_eq
id|wait_data
)paren
(brace
r_if
c_cond
(paren
id|p1-&gt;status
op_eq
id|I2O_DETAIL_STATUS_UNSUPPORTED_FUNCTION
)paren
(brace
id|status
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p2
)paren
(brace
id|p2-&gt;next
op_assign
id|p1-&gt;next
suffix:semicolon
)brace
r_else
(brace
id|adpt_post_wait_queue
op_assign
id|p1-&gt;next
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adpt_post_wait_lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|wait_data
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|adpt_i2o_post_this
r_static
id|s32
id|adpt_i2o_post_this
c_func
(paren
id|adpt_hba
op_star
id|pHba
comma
id|u32
op_star
id|data
comma
r_int
id|len
)paren
(brace
id|u32
id|m
op_assign
id|EMPTY_QUEUE
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
id|ulong
id|timeout
op_assign
id|jiffies
op_plus
l_int|30
op_star
id|HZ
suffix:semicolon
r_do
(brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|m
op_assign
id|readl
c_func
(paren
id|pHba-&gt;post_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_ne
id|EMPTY_QUEUE
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dpti%d: Timeout waiting for message frame!&bslash;n&quot;
comma
id|pHba-&gt;unit
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|m
op_eq
id|EMPTY_QUEUE
)paren
(brace
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|pHba-&gt;msg_addr_virt
op_plus
id|m
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|msg
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
singleline_comment|//post message
id|writel
c_func
(paren
id|m
comma
id|pHba-&gt;post_port
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_i2o_post_wait_complete
r_static
r_void
id|adpt_i2o_post_wait_complete
c_func
(paren
id|u32
id|context
comma
r_int
id|status
)paren
(brace
r_struct
id|adpt_i2o_post_wait_data
op_star
id|p1
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * We need to search through the adpt_post_wait&n;&t; * queue to see if the given message is still&n;&t; * outstanding.  If not, it means that the IOP&n;&t; * took longer to respond to the message than we&n;&t; * had allowed and timer has already expired.&n;&t; * Not much we can do about that except log&n;&t; * it for debug purposes, increase timeout, and recompile&n;&t; *&n;&t; * Lock needed to keep anyone from moving queue pointers&n;&t; * around while we&squot;re looking through them.&n;&t; */
id|context
op_and_assign
l_int|0x7fff
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|adpt_post_wait_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p1
op_assign
id|adpt_post_wait_queue
suffix:semicolon
id|p1
suffix:semicolon
id|p1
op_assign
id|p1-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p1-&gt;id
op_eq
id|context
)paren
(brace
id|p1-&gt;status
op_assign
id|status
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|adpt_post_wait_lock
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
id|p1-&gt;wq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|adpt_post_wait_lock
)paren
suffix:semicolon
singleline_comment|// If this happens we lose commands that probably really completed
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dpti: Could Not find task %d in wait queue&bslash;n&quot;
comma
id|context
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;      Tasks in wait queue:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p1
op_assign
id|adpt_post_wait_queue
suffix:semicolon
id|p1
suffix:semicolon
id|p1
op_assign
id|p1-&gt;next
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;           %d&bslash;n&quot;
comma
id|p1-&gt;id
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|adpt_i2o_reset_hba
r_static
id|s32
id|adpt_i2o_reset_hba
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|u32
id|msg
(braket
l_int|8
)braket
suffix:semicolon
id|u8
op_star
id|status
suffix:semicolon
id|u32
id|m
op_assign
id|EMPTY_QUEUE
suffix:semicolon
id|ulong
id|timeout
op_assign
id|jiffies
op_plus
(paren
id|TMOUT_IOPRESET
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;initialized
op_eq
id|FALSE
)paren
(brace
singleline_comment|// First time reset should be quick
id|timeout
op_assign
id|jiffies
op_plus
(paren
l_int|25
op_star
id|HZ
)paren
suffix:semicolon
)brace
r_else
(brace
id|adpt_i2o_quiesce_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
)brace
r_do
(brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|m
op_assign
id|readl
c_func
(paren
id|pHba-&gt;post_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_ne
id|EMPTY_QUEUE
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Timeout waiting for message!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|m
op_eq
id|EMPTY_QUEUE
)paren
suffix:semicolon
id|status
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
l_int|4
comma
id|GFP_KERNEL
op_or
id|ADDR32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|NULL
)paren
(brace
id|adpt_send_nop
c_func
(paren
id|pHba
comma
id|m
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IOP reset failed - no free memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|status
comma
l_int|0
comma
l_int|4
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|EIGHT_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_ADAPTER_RESET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|6
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|status
)paren
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|pHba-&gt;msg_addr_virt
op_plus
id|m
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|m
comma
id|pHba-&gt;post_port
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|status
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: IOP Reset Timeout&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|status
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|status
op_eq
l_int|0x01
multiline_comment|/*I2O_EXEC_IOP_RESET_IN_PROGRESS*/
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;%s: Reset in progress...&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
singleline_comment|// Here we wait for message frame to become available
singleline_comment|// indicated that reset has finished
r_do
(brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|m
op_assign
id|readl
c_func
(paren
id|pHba-&gt;post_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_ne
id|EMPTY_QUEUE
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s:Timeout waiting for IOP Reset.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|m
op_eq
id|EMPTY_QUEUE
)paren
suffix:semicolon
singleline_comment|// Flush the offset
id|adpt_send_nop
c_func
(paren
id|pHba
comma
id|m
)paren
suffix:semicolon
)brace
id|adpt_i2o_status_get
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|status
op_eq
l_int|0x02
op_logical_or
id|pHba-&gt;status_block-&gt;iop_state
op_ne
id|ADAPTER_STATE_RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Reset reject, trying to clear&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;%s: Reset completed.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|status
)paren
suffix:semicolon
macro_line|#ifdef UARTDELAY
singleline_comment|// This delay is to allow someone attached to the card through the debug UART to 
singleline_comment|// set up the dump levels that they want before the rest of the initialization sequence
id|adpt_delay
c_func
(paren
l_int|20000
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_i2o_parse_lct
r_static
r_int
id|adpt_i2o_parse_lct
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|max
suffix:semicolon
r_int
id|tid
suffix:semicolon
r_struct
id|i2o_device
op_star
id|d
suffix:semicolon
id|i2o_lct
op_star
id|lct
op_assign
id|pHba-&gt;lct
suffix:semicolon
id|u8
id|bus_no
op_assign
l_int|0
suffix:semicolon
id|s16
id|scsi_id
suffix:semicolon
id|s16
id|scsi_lun
suffix:semicolon
id|u32
id|buf
(braket
l_int|10
)braket
suffix:semicolon
singleline_comment|// larger than 7, or 8 ...
r_struct
id|adpt_device
op_star
id|pDev
suffix:semicolon
r_if
c_cond
(paren
id|lct
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: LCT is empty???&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|max
op_assign
id|lct-&gt;table_size
suffix:semicolon
id|max
op_sub_assign
l_int|3
suffix:semicolon
id|max
op_div_assign
l_int|9
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|lct-&gt;lct_entry
(braket
id|i
)braket
dot
id|user_tid
op_ne
l_int|0xfff
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * If we have hidden devices, we need to inform the upper layers about&n;&t;&t;&t; * the possible maximum id reference to handle device access when&n;&t;&t;&t; * an array is disassembled. This code has no other purpose but to&n;&t;&t;&t; * allow us future access to devices that are currently hidden&n;&t;&t;&t; * behind arrays, hotspares or have not been configured (JBOD mode).&n;&t;&t;&t; */
r_if
c_cond
(paren
id|lct-&gt;lct_entry
(braket
id|i
)braket
dot
id|class_id
op_ne
id|I2O_CLASS_RANDOM_BLOCK_STORAGE
op_logical_and
id|lct-&gt;lct_entry
(braket
id|i
)braket
dot
id|class_id
op_ne
id|I2O_CLASS_SCSI_PERIPHERAL
op_logical_and
id|lct-&gt;lct_entry
(braket
id|i
)braket
dot
id|class_id
op_ne
id|I2O_CLASS_FIBRE_CHANNEL_PERIPHERAL
)paren
(brace
r_continue
suffix:semicolon
)brace
id|tid
op_assign
id|lct-&gt;lct_entry
(braket
id|i
)braket
dot
id|tid
suffix:semicolon
singleline_comment|// I2O_DPT_DEVICE_INFO_GROUP_NO;
r_if
c_cond
(paren
id|adpt_i2o_query_scalar
c_func
(paren
id|pHba
comma
id|tid
comma
l_int|0x8000
comma
op_minus
l_int|1
comma
id|buf
comma
l_int|32
)paren
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|bus_no
op_assign
id|buf
(braket
l_int|0
)braket
op_rshift
l_int|16
suffix:semicolon
id|scsi_id
op_assign
id|buf
(braket
l_int|1
)braket
suffix:semicolon
id|scsi_lun
op_assign
(paren
id|buf
(braket
l_int|2
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|bus_no
op_ge
id|MAX_CHANNEL
)paren
(brace
singleline_comment|// Something wrong skip it
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Channel number %d out of range &bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|bus_no
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id
op_ge
id|MAX_ID
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: SCSI ID %d out of range &bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|bus_no
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bus_no
OG
id|pHba-&gt;top_scsi_channel
)paren
(brace
id|pHba-&gt;top_scsi_channel
op_assign
id|bus_no
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id
OG
id|pHba-&gt;top_scsi_id
)paren
(brace
id|pHba-&gt;top_scsi_id
op_assign
id|scsi_id
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_lun
OG
id|pHba-&gt;top_scsi_lun
)paren
(brace
id|pHba-&gt;top_scsi_lun
op_assign
id|scsi_lun
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
id|d
op_assign
(paren
r_struct
id|i2o_device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|i2o_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%s: Out of memory for I2O device data.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|d-&gt;controller
op_assign
(paren
r_void
op_star
)paren
id|pHba
suffix:semicolon
id|d-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|d-&gt;lct_data
comma
op_amp
id|lct-&gt;lct_entry
(braket
id|i
)braket
comma
r_sizeof
(paren
id|i2o_lct_entry
)paren
)paren
suffix:semicolon
id|d-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|tid
op_assign
id|d-&gt;lct_data.tid
suffix:semicolon
id|adpt_i2o_report_hba_unit
c_func
(paren
id|pHba
comma
id|d
)paren
suffix:semicolon
id|adpt_i2o_install_device
c_func
(paren
id|pHba
comma
id|d
)paren
suffix:semicolon
)brace
id|bus_no
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|d
op_assign
id|pHba-&gt;devices
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|d-&gt;lct_data.class_id
op_eq
id|I2O_CLASS_BUS_ADAPTER_PORT
op_logical_or
id|d-&gt;lct_data.class_id
op_eq
id|I2O_CLASS_FIBRE_CHANNEL_PORT
)paren
(brace
id|tid
op_assign
id|d-&gt;lct_data.tid
suffix:semicolon
singleline_comment|// TODO get the bus_no from hrt-but for now they are in order
singleline_comment|//bus_no = 
r_if
c_cond
(paren
id|bus_no
OG
id|pHba-&gt;top_scsi_channel
)paren
(brace
id|pHba-&gt;top_scsi_channel
op_assign
id|bus_no
suffix:semicolon
)brace
id|pHba-&gt;channel
(braket
id|bus_no
)braket
dot
id|type
op_assign
id|d-&gt;lct_data.class_id
suffix:semicolon
id|pHba-&gt;channel
(braket
id|bus_no
)braket
dot
id|tid
op_assign
id|tid
suffix:semicolon
r_if
c_cond
(paren
id|adpt_i2o_query_scalar
c_func
(paren
id|pHba
comma
id|tid
comma
l_int|0x0200
comma
op_minus
l_int|1
comma
id|buf
comma
l_int|28
)paren
op_ge
l_int|0
)paren
(brace
id|pHba-&gt;channel
(braket
id|bus_no
)braket
dot
id|scsi_id
op_assign
id|buf
(braket
l_int|1
)braket
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;Bus %d - SCSI ID %d.&bslash;n&quot;
comma
id|bus_no
comma
id|buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
singleline_comment|// TODO remove - this is just until we get from hrt
id|bus_no
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bus_no
op_ge
id|MAX_CHANNEL
)paren
(brace
singleline_comment|// Something wrong skip it
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Channel number %d out of range - LCT&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|bus_no
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
singleline_comment|// Setup adpt_device table
r_for
c_loop
(paren
id|d
op_assign
id|pHba-&gt;devices
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|d-&gt;lct_data.class_id
op_eq
id|I2O_CLASS_RANDOM_BLOCK_STORAGE
op_logical_or
id|d-&gt;lct_data.class_id
op_eq
id|I2O_CLASS_SCSI_PERIPHERAL
op_logical_or
id|d-&gt;lct_data.class_id
op_eq
id|I2O_CLASS_FIBRE_CHANNEL_PERIPHERAL
)paren
(brace
id|tid
op_assign
id|d-&gt;lct_data.tid
suffix:semicolon
id|scsi_id
op_assign
op_minus
l_int|1
suffix:semicolon
singleline_comment|// I2O_DPT_DEVICE_INFO_GROUP_NO;
r_if
c_cond
(paren
id|adpt_i2o_query_scalar
c_func
(paren
id|pHba
comma
id|tid
comma
l_int|0x8000
comma
op_minus
l_int|1
comma
id|buf
comma
l_int|32
)paren
op_ge
l_int|0
)paren
(brace
id|bus_no
op_assign
id|buf
(braket
l_int|0
)braket
op_rshift
l_int|16
suffix:semicolon
id|scsi_id
op_assign
id|buf
(braket
l_int|1
)braket
suffix:semicolon
id|scsi_lun
op_assign
(paren
id|buf
(braket
l_int|2
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|bus_no
op_ge
id|MAX_CHANNEL
)paren
(brace
singleline_comment|// Something wrong skip it
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id
op_ge
id|MAX_ID
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pHba-&gt;channel
(braket
id|bus_no
)braket
dot
id|device
(braket
id|scsi_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|pDev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|adpt_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDev
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pHba-&gt;channel
(braket
id|bus_no
)braket
dot
id|device
(braket
id|scsi_id
)braket
op_assign
id|pDev
suffix:semicolon
id|memset
c_func
(paren
id|pDev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|adpt_device
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|pDev
op_assign
id|pHba-&gt;channel
(braket
id|bus_no
)braket
dot
id|device
(braket
id|scsi_id
)braket
suffix:semicolon
id|pDev-&gt;next_lun
suffix:semicolon
id|pDev
op_assign
id|pDev-&gt;next_lun
)paren
(brace
)brace
id|pDev-&gt;next_lun
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|adpt_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDev-&gt;next_lun
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pDev-&gt;next_lun
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|adpt_device
)paren
)paren
suffix:semicolon
id|pDev
op_assign
id|pDev-&gt;next_lun
suffix:semicolon
)brace
id|pDev-&gt;tid
op_assign
id|tid
suffix:semicolon
id|pDev-&gt;scsi_channel
op_assign
id|bus_no
suffix:semicolon
id|pDev-&gt;scsi_id
op_assign
id|scsi_id
suffix:semicolon
id|pDev-&gt;scsi_lun
op_assign
id|scsi_lun
suffix:semicolon
id|pDev-&gt;pI2o_dev
op_assign
id|d
suffix:semicolon
id|d-&gt;owner
op_assign
id|pDev
suffix:semicolon
id|pDev-&gt;type
op_assign
(paren
id|buf
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xff
suffix:semicolon
id|pDev-&gt;flags
op_assign
(paren
id|buf
(braket
l_int|0
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|scsi_id
OG
id|pHba-&gt;top_scsi_id
)paren
(brace
id|pHba-&gt;top_scsi_id
op_assign
id|scsi_id
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_lun
OG
id|pHba-&gt;top_scsi_lun
)paren
(brace
id|pHba-&gt;top_scsi_lun
op_assign
id|scsi_lun
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|scsi_id
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Could not find SCSI ID for %s&bslash;n&quot;
comma
id|d-&gt;lct_data.identity_tag
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Each I2O controller has a chain of devices on it - these match&n; *&t;the useful parts of the LCT of the board.&n; */
DECL|function|adpt_i2o_install_device
r_static
r_int
id|adpt_i2o_install_device
c_func
(paren
id|adpt_hba
op_star
id|pHba
comma
r_struct
id|i2o_device
op_star
id|d
)paren
(brace
id|down
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
id|d-&gt;controller
op_assign
id|pHba
suffix:semicolon
id|d-&gt;owner
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;next
op_assign
id|pHba-&gt;devices
suffix:semicolon
id|d-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;devices
op_ne
l_int|NULL
)paren
(brace
id|pHba-&gt;devices-&gt;prev
op_assign
id|d
suffix:semicolon
)brace
id|pHba-&gt;devices
op_assign
id|d
suffix:semicolon
op_star
id|d-&gt;dev_name
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_open
r_static
r_int
id|adpt_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
suffix:semicolon
id|adpt_hba
op_star
id|pHba
suffix:semicolon
singleline_comment|//TODO check for root access
singleline_comment|//
id|minor
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
op_ge
id|hba_count
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pHba
op_assign
id|hba_chain
suffix:semicolon
id|pHba
suffix:semicolon
id|pHba
op_assign
id|pHba-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pHba-&gt;unit
op_eq
id|minor
)paren
(brace
r_break
suffix:semicolon
multiline_comment|/* found adapter */
)brace
)brace
r_if
c_cond
(paren
id|pHba
op_eq
l_int|NULL
)paren
(brace
id|up
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
singleline_comment|//&t;if(pHba-&gt;in_use){
singleline_comment|//&t;up(&amp;adpt_configuration_lock);
singleline_comment|//&t;&t;return -EBUSY;
singleline_comment|//&t;}
id|pHba-&gt;in_use
op_assign
l_int|1
suffix:semicolon
id|up
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_close
r_static
r_int
id|adpt_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
suffix:semicolon
id|adpt_hba
op_star
id|pHba
suffix:semicolon
id|minor
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
op_ge
id|hba_count
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pHba
op_assign
id|hba_chain
suffix:semicolon
id|pHba
suffix:semicolon
id|pHba
op_assign
id|pHba-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pHba-&gt;unit
op_eq
id|minor
)paren
(brace
r_break
suffix:semicolon
multiline_comment|/* found adapter */
)brace
)brace
id|up
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pHba
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|pHba-&gt;in_use
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_i2o_passthru
r_static
r_int
id|adpt_i2o_passthru
c_func
(paren
id|adpt_hba
op_star
id|pHba
comma
id|u32
op_star
id|arg
)paren
(brace
id|u32
id|msg
(braket
id|MAX_MESSAGE_SIZE
)braket
suffix:semicolon
id|u32
op_star
id|reply
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|size
op_assign
l_int|0
suffix:semicolon
id|u32
id|reply_size
op_assign
l_int|0
suffix:semicolon
id|u32
op_star
id|user_msg
op_assign
(paren
id|u32
op_star
)paren
id|arg
suffix:semicolon
id|u32
op_star
id|user_reply
op_assign
l_int|NULL
suffix:semicolon
id|ulong
id|sg_list
(braket
id|pHba-&gt;sg_tablesize
)braket
suffix:semicolon
id|u32
id|sg_offset
op_assign
l_int|0
suffix:semicolon
id|u32
id|sg_count
op_assign
l_int|0
suffix:semicolon
r_int
id|sg_index
op_assign
l_int|0
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|u32
id|rcode
op_assign
l_int|0
suffix:semicolon
id|ulong
id|p
op_assign
l_int|0
suffix:semicolon
id|ulong
id|flags
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|msg
comma
l_int|0
comma
id|MAX_MESSAGE_SIZE
op_star
l_int|4
)paren
suffix:semicolon
singleline_comment|// get user msg size in u32s 
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|size
comma
op_amp
id|user_msg
(braket
l_int|0
)braket
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|size
op_assign
id|size
op_rshift
l_int|16
suffix:semicolon
id|user_reply
op_assign
op_amp
id|user_msg
(braket
id|size
)braket
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|MAX_MESSAGE_SIZE
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|size
op_mul_assign
l_int|4
suffix:semicolon
singleline_comment|// Convert to bytes
multiline_comment|/* Copy in the user&squot;s I2O command */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
id|msg
comma
(paren
r_void
op_star
)paren
id|user_msg
comma
id|size
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|get_user
c_func
(paren
id|reply_size
comma
op_amp
id|user_reply
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|reply_size
op_assign
id|reply_size
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|reply_size
OG
id|REPLY_FRAME_SIZE
)paren
(brace
id|reply_size
op_assign
id|REPLY_FRAME_SIZE
suffix:semicolon
)brace
id|reply_size
op_mul_assign
l_int|4
suffix:semicolon
id|reply
op_assign
id|kmalloc
c_func
(paren
id|REPLY_FRAME_SIZE
op_star
l_int|4
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reply
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not allocate reply buffer&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|reply
comma
l_int|0
comma
id|REPLY_FRAME_SIZE
op_star
l_int|4
)paren
suffix:semicolon
id|sg_offset
op_assign
(paren
id|msg
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0x40000000
suffix:semicolon
singleline_comment|// IOCTL context
id|msg
(braket
l_int|3
)braket
op_assign
(paren
id|u32
)paren
id|reply
suffix:semicolon
id|memset
c_func
(paren
id|sg_list
comma
l_int|0
comma
r_sizeof
(paren
id|sg_list
(braket
l_int|0
)braket
)paren
op_star
id|pHba-&gt;sg_tablesize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_offset
)paren
(brace
singleline_comment|// TODO 64bit fix
r_struct
id|sg_simple_element
op_star
id|sg
op_assign
(paren
r_struct
id|sg_simple_element
op_star
)paren
(paren
id|msg
op_plus
id|sg_offset
)paren
suffix:semicolon
id|sg_count
op_assign
(paren
id|size
op_minus
id|sg_offset
op_star
l_int|4
)paren
op_div
r_sizeof
(paren
r_struct
id|sg_simple_element
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_count
OG
id|pHba-&gt;sg_tablesize
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:IOCTL SG List too large (%u)&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|sg_count
)paren
suffix:semicolon
id|kfree
(paren
id|reply
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sg_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|sg_size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sg
(braket
id|i
)braket
dot
id|flag_count
op_amp
l_int|0x10000000
multiline_comment|/*I2O_SGL_FLAGS_SIMPLE_ADDRESS_ELEMENT*/
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:Bad SG element %d - not simple (%x)&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|i
comma
id|sg
(braket
id|i
)braket
dot
id|flag_count
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|sg_size
op_assign
id|sg
(braket
id|i
)braket
dot
id|flag_count
op_amp
l_int|0xffffff
suffix:semicolon
multiline_comment|/* Allocate memory for the transfer */
id|p
op_assign
(paren
id|ulong
)paren
id|kmalloc
c_func
(paren
id|sg_size
comma
id|GFP_KERNEL
op_or
id|ADDR32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Could not allocate SG buffer - size = %d buffer number %d of %d&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|sg_size
comma
id|i
comma
id|sg_count
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|sg_list
(braket
id|sg_index
op_increment
)braket
op_assign
id|p
suffix:semicolon
singleline_comment|// sglist indexed with input frame, not our internal frame.
multiline_comment|/* Copy in the user&squot;s SG buffer if necessary */
r_if
c_cond
(paren
id|sg
(braket
id|i
)braket
dot
id|flag_count
op_amp
l_int|0x04000000
multiline_comment|/*I2O_SGL_FLAGS_DIR*/
)paren
(brace
singleline_comment|// TODO 64bit fix
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
id|p
comma
(paren
r_void
op_star
)paren
id|sg
(braket
id|i
)braket
dot
id|addr_bus
comma
id|sg_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Could not copy SG buf %d FROM user&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|i
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
)brace
singleline_comment|//TODO 64bit fix
id|sg
(braket
id|i
)braket
dot
id|addr_bus
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|p
)paren
suffix:semicolon
)brace
)brace
r_do
(brace
id|spin_lock_irqsave
c_func
(paren
id|pHba-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
singleline_comment|// This state stops any new commands from enterring the
singleline_comment|// controller while processing the ioctl
singleline_comment|//&t;&t;pHba-&gt;state |= DPTI_STATE_IOCTL;
singleline_comment|//&t;&t;We can&squot;t set this now - The scsi subsystem sets host_blocked and
singleline_comment|//&t;&t;the queue empties and stops.  We need a way to restart the queue
id|rcode
op_assign
id|adpt_i2o_post_wait
c_func
(paren
id|pHba
comma
id|msg
comma
id|size
comma
id|FOREVER
)paren
suffix:semicolon
singleline_comment|//&t;&t;pHba-&gt;state &amp;= ~DPTI_STATE_IOCTL;
id|spin_unlock_irqrestore
c_func
(paren
id|pHba-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rcode
op_eq
op_minus
id|ETIMEDOUT
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rcode
)paren
(brace
r_goto
id|cleanup
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sg_offset
)paren
(brace
multiline_comment|/* Copy back the Scatter Gather buffers back to user space */
id|u32
id|j
suffix:semicolon
singleline_comment|// TODO 64bit fix
r_struct
id|sg_simple_element
op_star
id|sg
suffix:semicolon
r_int
id|sg_size
suffix:semicolon
singleline_comment|// re-acquire the original message to handle correctly the sg copy operation
id|memset
c_func
(paren
op_amp
id|msg
comma
l_int|0
comma
id|MAX_MESSAGE_SIZE
op_star
l_int|4
)paren
suffix:semicolon
singleline_comment|// get user msg size in u32s 
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|size
comma
op_amp
id|user_msg
(braket
l_int|0
)braket
)paren
)paren
(brace
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|size
op_assign
id|size
op_rshift
l_int|16
suffix:semicolon
id|size
op_mul_assign
l_int|4
suffix:semicolon
multiline_comment|/* Copy in the user&squot;s I2O command */
r_if
c_cond
(paren
id|copy_from_user
(paren
(paren
r_void
op_star
)paren
id|msg
comma
(paren
r_void
op_star
)paren
id|user_msg
comma
id|size
)paren
)paren
(brace
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|sg_count
op_assign
(paren
id|size
op_minus
id|sg_offset
op_star
l_int|4
)paren
op_div
r_sizeof
(paren
r_struct
id|sg_simple_element
)paren
suffix:semicolon
singleline_comment|// TODO 64bit fix
id|sg
op_assign
(paren
r_struct
id|sg_simple_element
op_star
)paren
(paren
id|msg
op_plus
id|sg_offset
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|sg_count
suffix:semicolon
id|j
op_increment
)paren
(brace
multiline_comment|/* Copy out the SG list to user&squot;s buffer if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sg
(braket
id|j
)braket
dot
id|flag_count
op_amp
l_int|0x4000000
multiline_comment|/*I2O_SGL_FLAGS_DIR*/
)paren
)paren
(brace
id|sg_size
op_assign
id|sg
(braket
id|j
)braket
dot
id|flag_count
op_amp
l_int|0xffffff
suffix:semicolon
singleline_comment|// TODO 64bit fix
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|sg
(braket
id|j
)braket
dot
id|addr_bus
comma
(paren
r_void
op_star
)paren
id|sg_list
(braket
id|j
)braket
comma
id|sg_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not copy %lx TO user %x&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|sg_list
(braket
id|j
)braket
comma
id|sg
(braket
id|j
)braket
dot
id|addr_bus
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Copy back the reply to user space */
r_if
c_cond
(paren
id|reply_size
)paren
(brace
singleline_comment|// we wrote our own values for context - now restore the user supplied ones
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|reply
op_plus
l_int|2
comma
id|user_msg
op_plus
l_int|2
comma
r_sizeof
(paren
id|u32
)paren
op_star
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not copy message context FROM user&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user_reply
comma
id|reply
comma
id|reply_size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not copy reply TO user&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
id|rcode
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
id|cleanup
suffix:colon
id|kfree
(paren
id|reply
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sg_index
)paren
(brace
r_if
c_cond
(paren
id|sg_list
(braket
op_decrement
id|sg_index
)braket
)paren
(brace
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|sg_list
(braket
id|sg_index
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
id|rcode
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine returns information about the system.  This does not effect&n; * any logic and if the info is wrong - it doesn&squot;t matter.&n; */
multiline_comment|/* Get all the info we can not get from kernel services */
DECL|function|adpt_system_info
r_static
r_int
id|adpt_system_info
c_func
(paren
r_void
op_star
id|buffer
)paren
(brace
id|sysInfo_S
id|si
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|si
comma
l_int|0
comma
r_sizeof
(paren
id|si
)paren
)paren
suffix:semicolon
id|si.osType
op_assign
id|OS_LINUX
suffix:semicolon
id|si.osMajorVersion
op_assign
(paren
id|u8
)paren
(paren
id|LINUX_VERSION_CODE
op_rshift
l_int|16
)paren
suffix:semicolon
id|si.osMinorVersion
op_assign
(paren
id|u8
)paren
(paren
id|LINUX_VERSION_CODE
op_rshift
l_int|8
op_amp
l_int|0x0ff
)paren
suffix:semicolon
id|si.osRevision
op_assign
(paren
id|u8
)paren
(paren
id|LINUX_VERSION_CODE
op_amp
l_int|0x0ff
)paren
suffix:semicolon
id|si.busType
op_assign
id|SI_PCI_BUS
suffix:semicolon
id|si.processorFamily
op_assign
id|DPTI_sig.dsProcessorFamily
suffix:semicolon
macro_line|#if defined __i386__ 
id|adpt_i386_info
c_func
(paren
op_amp
id|si
)paren
suffix:semicolon
macro_line|#elif defined (__ia64__)
id|adpt_ia64_info
c_func
(paren
op_amp
id|si
)paren
suffix:semicolon
macro_line|#elif defined(__sparc__)
id|adpt_sparc_info
c_func
(paren
op_amp
id|si
)paren
suffix:semicolon
macro_line|#elif defined (__alpha__)
id|adpt_alpha_info
c_func
(paren
op_amp
id|si
)paren
suffix:semicolon
macro_line|#else
id|si.processorType
op_assign
l_int|0xff
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
op_amp
id|si
comma
r_sizeof
(paren
id|si
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dpti: Could not copy buffer TO user&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if defined __ia64__ 
DECL|function|adpt_ia64_info
r_static
r_void
id|adpt_ia64_info
c_func
(paren
id|sysInfo_S
op_star
id|si
)paren
(brace
singleline_comment|// This is all the info we need for now
singleline_comment|// We will add more info as our new
singleline_comment|// managmenent utility requires it
id|si-&gt;processorType
op_assign
id|PROC_IA64
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined __sparc__ 
DECL|function|adpt_sparc_info
r_static
r_void
id|adpt_sparc_info
c_func
(paren
id|sysInfo_S
op_star
id|si
)paren
(brace
singleline_comment|// This is all the info we need for now
singleline_comment|// We will add more info as our new
singleline_comment|// managmenent utility requires it
id|si-&gt;processorType
op_assign
id|PROC_ULTRASPARC
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined __alpha__ 
DECL|function|adpt_alpha_info
r_static
r_void
id|adpt_alpha_info
c_func
(paren
id|sysInfo_S
op_star
id|si
)paren
(brace
singleline_comment|// This is all the info we need for now
singleline_comment|// We will add more info as our new
singleline_comment|// managmenent utility requires it
id|si-&gt;processorType
op_assign
id|PROC_ALPHA
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined __i386__
DECL|function|adpt_i386_info
r_static
r_void
id|adpt_i386_info
c_func
(paren
id|sysInfo_S
op_star
id|si
)paren
(brace
singleline_comment|// This is all the info we need for now
singleline_comment|// We will add more info as our new
singleline_comment|// managmenent utility requires it
r_switch
c_cond
(paren
id|boot_cpu_data.x86
)paren
(brace
r_case
id|CPU_386
suffix:colon
id|si-&gt;processorType
op_assign
id|PROC_386
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_486
suffix:colon
id|si-&gt;processorType
op_assign
id|PROC_486
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPU_586
suffix:colon
id|si-&gt;processorType
op_assign
id|PROC_PENTIUM
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|// Just in case 
id|si-&gt;processorType
op_assign
id|PROC_PENTIUM
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|function|adpt_ioctl
r_static
r_int
id|adpt_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|uint
id|cmd
comma
id|ulong
id|arg
)paren
(brace
r_int
id|minor
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|adpt_hba
op_star
id|pHba
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|minor
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
op_ge
id|DPTI_MAX_HBA
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pHba
op_assign
id|hba_chain
suffix:semicolon
id|pHba
suffix:semicolon
id|pHba
op_assign
id|pHba-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pHba-&gt;unit
op_eq
id|minor
)paren
(brace
r_break
suffix:semicolon
multiline_comment|/* found adapter */
)brace
)brace
id|up
c_func
(paren
op_amp
id|adpt_configuration_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pHba
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
r_volatile
id|u32
)paren
id|pHba-&gt;state
op_amp
id|DPTI_STATE_RESET
)paren
(brace
id|set_task_state
c_func
(paren
id|current
comma
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
singleline_comment|// TODO: handle 3 cases
r_case
id|DPT_SIGNATURE
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|DPTI_sig
comma
r_sizeof
(paren
id|DPTI_sig
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|I2OUSRCMD
suffix:colon
r_return
id|adpt_i2o_passthru
c_func
(paren
id|pHba
comma
(paren
id|u32
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DPT_CTRLINFO
suffix:colon
(brace
id|drvrHBAinfo_S
id|HbaInfo
suffix:semicolon
DECL|macro|FLG_OSD_PCI_VALID
mdefine_line|#define FLG_OSD_PCI_VALID 0x0001
DECL|macro|FLG_OSD_DMA
mdefine_line|#define FLG_OSD_DMA&t;  0x0002
DECL|macro|FLG_OSD_I2O
mdefine_line|#define FLG_OSD_I2O&t;  0x0004
id|memset
c_func
(paren
op_amp
id|HbaInfo
comma
l_int|0
comma
r_sizeof
(paren
id|HbaInfo
)paren
)paren
suffix:semicolon
id|HbaInfo.drvrHBAnum
op_assign
id|pHba-&gt;unit
suffix:semicolon
id|HbaInfo.baseAddr
op_assign
(paren
id|ulong
)paren
id|pHba-&gt;base_addr_phys
suffix:semicolon
id|HbaInfo.blinkState
op_assign
id|adpt_read_blink_led
c_func
(paren
id|pHba
)paren
suffix:semicolon
id|HbaInfo.pciBusNum
op_assign
id|pHba-&gt;pDev-&gt;bus-&gt;number
suffix:semicolon
id|HbaInfo.pciDeviceNum
op_assign
id|PCI_SLOT
c_func
(paren
id|pHba-&gt;pDev-&gt;devfn
)paren
suffix:semicolon
id|HbaInfo.Interrupt
op_assign
id|pHba-&gt;pDev-&gt;irq
suffix:semicolon
id|HbaInfo.hbaFlags
op_assign
id|FLG_OSD_PCI_VALID
op_or
id|FLG_OSD_DMA
op_or
id|FLG_OSD_I2O
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|HbaInfo
comma
r_sizeof
(paren
id|HbaInfo
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not copy HbaInfo TO user&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|DPT_SYSINFO
suffix:colon
r_return
id|adpt_system_info
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DPT_BLINKLED
suffix:colon
(brace
id|u32
id|value
suffix:semicolon
id|value
op_assign
(paren
id|u32
)paren
id|adpt_read_blink_led
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|value
comma
r_sizeof
(paren
id|value
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|I2ORESETCMD
suffix:colon
id|spin_lock_irqsave
c_func
(paren
id|pHba-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|adpt_hba_reset
c_func
(paren
id|pHba
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|pHba-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2ORESCANCMD
suffix:colon
id|adpt_rescan
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
DECL|function|adpt_isr
r_static
r_void
id|adpt_isr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
id|adpt_hba
op_star
id|pHba
op_assign
id|dev_id
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|ulong
id|reply
suffix:semicolon
id|u32
id|status
op_assign
l_int|0
suffix:semicolon
id|u32
id|context
suffix:semicolon
id|ulong
id|flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pHba
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;adpt_isr: NULL dev_id&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
id|pHba-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readl
c_func
(paren
id|pHba-&gt;irq_mask
)paren
op_amp
id|I2O_INTERRUPT_PENDING_B
)paren
(brace
id|m
op_assign
id|readl
c_func
(paren
id|pHba-&gt;reply_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|EMPTY_QUEUE
)paren
(brace
singleline_comment|// Try twice then give up
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|m
op_assign
id|readl
c_func
(paren
id|pHba-&gt;reply_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
id|EMPTY_QUEUE
)paren
(brace
singleline_comment|// This really should not happen
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dpti: Could not get reply frame&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|reply
op_assign
(paren
id|ulong
)paren
id|bus_to_virt
c_func
(paren
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
id|reply
)paren
op_amp
id|MSG_FAIL
)paren
(brace
id|u32
id|old_m
op_assign
id|readl
c_func
(paren
id|reply
op_plus
l_int|28
)paren
suffix:semicolon
id|ulong
id|msg
suffix:semicolon
id|u32
id|old_context
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;%s: Failed message&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_m
op_ge
l_int|0x100000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Bad preserved MFA (%x)- dropping frame&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|old_m
)paren
suffix:semicolon
id|writel
c_func
(paren
id|m
comma
id|pHba-&gt;reply_port
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
singleline_comment|// Transaction context is 0 in failed reply frame
id|msg
op_assign
(paren
id|ulong
)paren
(paren
id|pHba-&gt;msg_addr_virt
op_plus
id|old_m
)paren
suffix:semicolon
id|old_context
op_assign
id|readl
c_func
(paren
id|msg
op_plus
l_int|12
)paren
suffix:semicolon
id|writel
c_func
(paren
id|old_context
comma
id|reply
op_plus
l_int|12
)paren
suffix:semicolon
id|adpt_send_nop
c_func
(paren
id|pHba
comma
id|old_m
)paren
suffix:semicolon
)brace
id|context
op_assign
id|readl
c_func
(paren
id|reply
op_plus
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|context
op_amp
l_int|0x40000000
)paren
(brace
singleline_comment|// IOCTL
id|ulong
id|p
op_assign
(paren
id|ulong
)paren
(paren
id|readl
c_func
(paren
id|reply
op_plus
l_int|12
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ne
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|p
comma
(paren
r_void
op_star
)paren
id|reply
comma
id|REPLY_FRAME_SIZE
op_star
l_int|4
)paren
suffix:semicolon
)brace
singleline_comment|// All IOCTLs will also be post wait
)brace
r_if
c_cond
(paren
id|context
op_amp
l_int|0x80000000
)paren
(brace
singleline_comment|// Post wait message
id|status
op_assign
id|readl
c_func
(paren
id|reply
op_plus
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_rshift
l_int|24
)paren
(brace
id|status
op_and_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* Get detail status */
)brace
r_else
(brace
id|status
op_assign
id|I2O_POST_WAIT_OK
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|context
op_amp
l_int|0x40000000
)paren
)paren
(brace
id|cmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|readl
c_func
(paren
id|reply
op_plus
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Apparent SCSI cmd in Post Wait Context - cmd=%p context=%x&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|cmd
comma
id|context
)paren
suffix:semicolon
)brace
)brace
id|adpt_i2o_post_wait_complete
c_func
(paren
id|context
comma
id|status
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// SCSI message
id|cmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|readl
c_func
(paren
id|reply
op_plus
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|cmd-&gt;serial_number
op_ne
l_int|0
)paren
(brace
singleline_comment|// If not timedout
id|adpt_i2o_to_scsi
c_func
(paren
id|reply
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
)brace
id|writel
c_func
(paren
id|m
comma
id|pHba-&gt;reply_port
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
id|pHba-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|adpt_scsi_to_i2o
r_static
id|s32
id|adpt_scsi_to_i2o
c_func
(paren
id|adpt_hba
op_star
id|pHba
comma
id|Scsi_Cmnd
op_star
id|cmd
comma
r_struct
id|adpt_device
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
id|u32
id|msg
(braket
id|MAX_MESSAGE_SIZE
)braket
suffix:semicolon
id|u32
op_star
id|mptr
suffix:semicolon
id|u32
op_star
id|lenptr
suffix:semicolon
r_int
id|direction
suffix:semicolon
r_int
id|scsidir
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|u32
id|reqlen
suffix:semicolon
id|s32
id|rcode
suffix:semicolon
id|memset
c_func
(paren
id|msg
comma
l_int|0
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
id|len
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
id|direction
op_assign
l_int|0x00000000
suffix:semicolon
id|scsidir
op_assign
l_int|0x00000000
suffix:semicolon
singleline_comment|// DATA NO XFER
r_if
c_cond
(paren
id|len
)paren
(brace
multiline_comment|/*&n;&t;&t; * Set SCBFlags to indicate if data is being transferred&n;&t;&t; * in or out, or no data transfer&n;&t;&t; * Note:  Do not have to verify index is less than 0 since&n;&t;&t; * cmd-&gt;cmnd[0] is an unsigned char&n;&t;&t; */
r_switch
c_cond
(paren
id|cmd-&gt;sc_data_direction
)paren
(brace
r_case
id|SCSI_DATA_READ
suffix:colon
id|scsidir
op_assign
l_int|0x40000000
suffix:semicolon
singleline_comment|// DATA IN  (iop&lt;--dev)
r_break
suffix:semicolon
r_case
id|SCSI_DATA_WRITE
suffix:colon
id|direction
op_assign
l_int|0x04000000
suffix:semicolon
singleline_comment|// SGL OUT
id|scsidir
op_assign
l_int|0x80000000
suffix:semicolon
singleline_comment|// DATA OUT (iop--&gt;dev)
r_break
suffix:semicolon
r_case
id|SCSI_DATA_NONE
suffix:colon
r_break
suffix:semicolon
r_case
id|SCSI_DATA_UNKNOWN
suffix:colon
id|scsidir
op_assign
l_int|0x40000000
suffix:semicolon
singleline_comment|// DATA IN  (iop&lt;--dev)
singleline_comment|// Assume In - and continue;
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: scsi opcode 0x%x not supported.&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
(paren
id|INITIATOR_ERROR
op_lshift
l_int|8
)paren
suffix:semicolon
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
singleline_comment|// msg[0] is set later
singleline_comment|// I2O_CMD_SCSI_EXEC
id|msg
(braket
l_int|1
)braket
op_assign
(paren
(paren
l_int|0xff
op_lshift
l_int|24
)paren
op_or
(paren
id|HOST_TID
op_lshift
l_int|12
)paren
op_or
id|d-&gt;tid
)paren
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
(paren
id|u32
)paren
id|cmd
suffix:semicolon
multiline_comment|/* We want the SCSI control block back */
singleline_comment|// Our cards use the transaction context as the tag for queueing
singleline_comment|// Adaptec/DPT Private stuff 
id|msg
(braket
l_int|4
)braket
op_assign
id|I2O_CMD_SCSI_EXEC
op_or
(paren
id|DPT_ORGANIZATION_ID
op_lshift
l_int|16
)paren
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
id|d-&gt;tid
suffix:semicolon
multiline_comment|/* Direction, disconnect ok | sense data | simple queue , CDBLen */
singleline_comment|// I2O_SCB_FLAG_ENABLE_DISCONNECT | 
singleline_comment|// I2O_SCB_FLAG_SIMPLE_QUEUE_TAG | 
singleline_comment|// I2O_SCB_FLAG_SENSE_DATA_IN_MESSAGE;
id|msg
(braket
l_int|6
)braket
op_assign
id|scsidir
op_or
l_int|0x20a00000
op_or
id|cmd-&gt;cmd_len
suffix:semicolon
id|mptr
op_assign
id|msg
op_plus
l_int|7
suffix:semicolon
singleline_comment|// Write SCSI command into the message - always 16 byte block 
id|memset
c_func
(paren
id|mptr
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mptr
comma
id|cmd-&gt;cmnd
comma
id|cmd-&gt;cmd_len
)paren
suffix:semicolon
id|mptr
op_add_assign
l_int|4
suffix:semicolon
id|lenptr
op_assign
id|mptr
op_increment
suffix:semicolon
multiline_comment|/* Remember me - fill in when we know */
id|reqlen
op_assign
l_int|14
suffix:semicolon
singleline_comment|// SINGLE SGE
multiline_comment|/* Now fill in the SGList and command */
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|mptr
op_increment
op_assign
id|direction
op_or
l_int|0x10000000
op_or
id|sg-&gt;length
suffix:semicolon
id|len
op_add_assign
id|sg-&gt;length
suffix:semicolon
op_star
id|mptr
op_increment
op_assign
id|virt_to_bus
c_func
(paren
id|sg-&gt;address
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
multiline_comment|/* Make this an end of list */
id|mptr
(braket
op_minus
l_int|2
)braket
op_assign
id|direction
op_or
l_int|0xD0000000
op_or
(paren
id|sg
op_minus
l_int|1
)paren
op_member_access_from_pointer
id|length
suffix:semicolon
id|reqlen
op_assign
id|mptr
op_minus
id|msg
suffix:semicolon
op_star
id|lenptr
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;underflow
op_logical_and
id|len
op_ne
id|cmd-&gt;underflow
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Cmd len %08X Cmd underflow %08X&bslash;n&quot;
comma
id|len
comma
id|cmd-&gt;underflow
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
op_star
id|lenptr
op_assign
id|len
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
id|reqlen
op_assign
l_int|12
suffix:semicolon
)brace
r_else
(brace
op_star
id|mptr
op_increment
op_assign
l_int|0xD0000000
op_or
id|direction
op_or
id|cmd-&gt;request_bufflen
suffix:semicolon
op_star
id|mptr
op_increment
op_assign
id|virt_to_bus
c_func
(paren
id|cmd-&gt;request_buffer
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Stick the headers on */
id|msg
(braket
l_int|0
)braket
op_assign
id|reqlen
op_lshift
l_int|16
op_or
(paren
(paren
id|reqlen
OG
l_int|12
)paren
ques
c_cond
id|SGL_OFFSET_12
suffix:colon
id|SGL_OFFSET_0
)paren
suffix:semicolon
singleline_comment|// Send it on it&squot;s way
id|rcode
op_assign
id|adpt_i2o_post_this
c_func
(paren
id|pHba
comma
id|msg
comma
id|reqlen
op_lshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcode
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|rcode
suffix:semicolon
)brace
DECL|function|adpt_scsi_register
r_static
id|s32
id|adpt_scsi_register
c_func
(paren
id|adpt_hba
op_star
id|pHba
comma
id|Scsi_Host_Template
op_star
id|sht
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
l_int|NULL
suffix:semicolon
id|host
op_assign
id|scsi_register
c_func
(paren
id|sht
comma
r_sizeof
(paren
id|adpt_hba
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;%s: scsi_register returned NULL&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
(paren
id|adpt_hba
op_star
)paren
(paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
)paren
op_assign
id|pHba
suffix:semicolon
id|pHba-&gt;host
op_assign
id|host
suffix:semicolon
id|host-&gt;irq
op_assign
id|pHba-&gt;pDev-&gt;irq
suffix:semicolon
multiline_comment|/* no IO ports, so don&squot;t have to set host-&gt;io_port and &n;&t; * host-&gt;n_io_port&n;&t; */
id|host-&gt;io_port
op_assign
l_int|0
suffix:semicolon
id|host-&gt;n_io_port
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* see comments in hosts.h */
id|host-&gt;max_id
op_assign
l_int|16
suffix:semicolon
id|host-&gt;max_lun
op_assign
l_int|256
suffix:semicolon
id|host-&gt;max_channel
op_assign
id|pHba-&gt;top_scsi_channel
op_plus
l_int|1
suffix:semicolon
id|host-&gt;cmd_per_lun
op_assign
l_int|1
suffix:semicolon
id|host-&gt;unique_id
op_assign
(paren
id|uint
)paren
id|pHba
suffix:semicolon
id|host-&gt;sg_tablesize
op_assign
id|pHba-&gt;sg_tablesize
suffix:semicolon
id|host-&gt;can_queue
op_assign
id|pHba-&gt;post_fifo_size
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_i2o_to_scsi
r_static
id|s32
id|adpt_i2o_to_scsi
c_func
(paren
id|ulong
id|reply
comma
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|adpt_hba
op_star
id|pHba
suffix:semicolon
id|u32
id|hba_status
suffix:semicolon
id|u32
id|dev_status
suffix:semicolon
id|u32
id|reply_flags
op_assign
id|readl
c_func
(paren
id|reply
)paren
op_amp
l_int|0xff00
suffix:semicolon
singleline_comment|// Leave it shifted up 8 bits 
singleline_comment|// I know this would look cleaner if I just read bytes
singleline_comment|// but the model I have been using for all the rest of the
singleline_comment|// io is in 4 byte words - so I keep that model
id|u16
id|detailed_status
op_assign
id|readl
c_func
(paren
id|reply
op_plus
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|dev_status
op_assign
(paren
id|detailed_status
op_amp
l_int|0xff
)paren
suffix:semicolon
id|hba_status
op_assign
id|detailed_status
op_rshift
l_int|8
suffix:semicolon
singleline_comment|// calculate resid for sg 
id|cmd-&gt;resid
op_assign
id|cmd-&gt;request_bufflen
op_minus
id|readl
c_func
(paren
id|reply
op_plus
l_int|5
)paren
suffix:semicolon
id|pHba
op_assign
(paren
id|adpt_hba
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|cmd-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
singleline_comment|// initialize sense valid flag to false
r_if
c_cond
(paren
op_logical_neg
(paren
id|reply_flags
op_amp
id|MSG_FAIL
)paren
)paren
(brace
r_switch
c_cond
(paren
id|detailed_status
op_amp
id|I2O_SCSI_DSC_MASK
)paren
(brace
r_case
id|I2O_SCSI_DSC_SUCCESS
suffix:colon
id|cmd-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
singleline_comment|// handle underflow
r_if
c_cond
(paren
id|readl
c_func
(paren
id|reply
op_plus
l_int|5
)paren
OL
id|cmd-&gt;underflow
)paren
(brace
id|cmd-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: SCSI CMD underflow&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|I2O_SCSI_DSC_REQUEST_ABORTED
suffix:colon
id|cmd-&gt;result
op_assign
(paren
id|DID_ABORT
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_SCSI_DSC_PATH_INVALID
suffix:colon
r_case
id|I2O_SCSI_DSC_DEVICE_NOT_PRESENT
suffix:colon
r_case
id|I2O_SCSI_DSC_SELECTION_TIMEOUT
suffix:colon
r_case
id|I2O_SCSI_DSC_COMMAND_TIMEOUT
suffix:colon
r_case
id|I2O_SCSI_DSC_NO_ADAPTER
suffix:colon
r_case
id|I2O_SCSI_DSC_RESOURCE_UNAVAILABLE
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: SCSI Timeout-Device (%d,%d,%d) hba status=0x%x, dev status=0x%x, cmd=0x%x&bslash;n&quot;
comma
id|pHba-&gt;name
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;channel
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;id
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;lun
comma
id|hba_status
comma
id|dev_status
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
(paren
id|DID_TIME_OUT
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_SCSI_DSC_ADAPTER_BUSY
suffix:colon
r_case
id|I2O_SCSI_DSC_BUS_BUSY
suffix:colon
id|cmd-&gt;result
op_assign
(paren
id|DID_BUS_BUSY
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_SCSI_DSC_SCSI_BUS_RESET
suffix:colon
r_case
id|I2O_SCSI_DSC_BDR_MESSAGE_SENT
suffix:colon
id|cmd-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_SCSI_DSC_PARITY_ERROR_FAILURE
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: SCSI CMD parity error&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
(paren
id|DID_PARITY
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_SCSI_DSC_UNABLE_TO_ABORT
suffix:colon
r_case
id|I2O_SCSI_DSC_COMPLETE_WITH_ERROR
suffix:colon
r_case
id|I2O_SCSI_DSC_UNABLE_TO_TERMINATE
suffix:colon
r_case
id|I2O_SCSI_DSC_MR_MESSAGE_RECEIVED
suffix:colon
r_case
id|I2O_SCSI_DSC_AUTOSENSE_FAILED
suffix:colon
r_case
id|I2O_SCSI_DSC_DATA_OVERRUN
suffix:colon
r_case
id|I2O_SCSI_DSC_UNEXPECTED_BUS_FREE
suffix:colon
r_case
id|I2O_SCSI_DSC_SEQUENCE_FAILURE
suffix:colon
r_case
id|I2O_SCSI_DSC_REQUEST_LENGTH_ERROR
suffix:colon
r_case
id|I2O_SCSI_DSC_PROVIDE_FAILURE
suffix:colon
r_case
id|I2O_SCSI_DSC_REQUEST_TERMINATED
suffix:colon
r_case
id|I2O_SCSI_DSC_IDE_MESSAGE_SENT
suffix:colon
r_case
id|I2O_SCSI_DSC_UNACKNOWLEDGED_EVENT
suffix:colon
r_case
id|I2O_SCSI_DSC_MESSAGE_RECEIVED
suffix:colon
r_case
id|I2O_SCSI_DSC_INVALID_CDB
suffix:colon
r_case
id|I2O_SCSI_DSC_LUN_INVALID
suffix:colon
r_case
id|I2O_SCSI_DSC_SCSI_TID_INVALID
suffix:colon
r_case
id|I2O_SCSI_DSC_FUNCTION_UNAVAILABLE
suffix:colon
r_case
id|I2O_SCSI_DSC_NO_NEXUS
suffix:colon
r_case
id|I2O_SCSI_DSC_CDB_RECEIVED
suffix:colon
r_case
id|I2O_SCSI_DSC_LUN_ALREADY_ENABLED
suffix:colon
r_case
id|I2O_SCSI_DSC_QUEUE_FROZEN
suffix:colon
r_case
id|I2O_SCSI_DSC_REQUEST_INVALID
suffix:colon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: SCSI error %0x-Device(%d,%d,%d) hba_status=0x%x, dev_status=0x%x, cmd=0x%x&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|detailed_status
op_amp
id|I2O_SCSI_DSC_MASK
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;channel
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;id
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;lun
comma
id|hba_status
comma
id|dev_status
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// copy over the request sense data if it was a check
singleline_comment|// condition status
r_if
c_cond
(paren
id|dev_status
op_eq
l_int|0x02
multiline_comment|/*CHECK_CONDITION*/
)paren
(brace
id|u32
id|len
op_assign
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
suffix:semicolon
id|len
op_assign
(paren
id|len
OG
l_int|40
)paren
ques
c_cond
l_int|40
suffix:colon
id|len
suffix:semicolon
singleline_comment|// Copy over the sense data
id|memcpy
c_func
(paren
id|cmd-&gt;sense_buffer
comma
(paren
r_void
op_star
)paren
(paren
id|reply
op_plus
l_int|28
)paren
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;sense_buffer
(braket
l_int|0
)braket
op_eq
l_int|0x70
multiline_comment|/* class 7 */
op_logical_and
id|cmd-&gt;sense_buffer
(braket
l_int|2
)braket
op_eq
id|DATA_PROTECT
)paren
(brace
multiline_comment|/* This is to handle an array failed */
id|cmd-&gt;result
op_assign
(paren
id|DID_TIME_OUT
op_lshift
l_int|16
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: SCSI Data Protect-Device (%d,%d,%d) hba_status=0x%x, dev_status=0x%x, cmd=0x%x&bslash;n&quot;
comma
id|pHba-&gt;name
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;channel
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;id
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;lun
comma
id|hba_status
comma
id|dev_status
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* In this condtion we could not talk to the tid&n;&t;&t; * the card rejected it.  We should signal a retry&n;&t;&t; * for a limitted number of retries.&n;&t;&t; */
id|cmd-&gt;result
op_assign
(paren
id|DID_TIME_OUT
op_lshift
l_int|16
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: I2O MSG_FAIL - Device (%d,%d,%d) tid=%d, cmd=0x%x&bslash;n&quot;
comma
id|pHba-&gt;name
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;channel
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;id
comma
(paren
id|u32
)paren
id|cmd-&gt;device-&gt;lun
comma
(paren
(paren
r_struct
id|adpt_device
op_star
)paren
(paren
id|cmd-&gt;device-&gt;hostdata
)paren
)paren
op_member_access_from_pointer
id|tid
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|cmd-&gt;result
op_or_assign
(paren
id|dev_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;scsi_done
op_ne
l_int|NULL
)paren
(brace
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
r_return
id|cmd-&gt;result
suffix:semicolon
)brace
DECL|function|adpt_rescan
r_static
id|s32
id|adpt_rescan
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|s32
id|rcode
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|pHba-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rcode
op_assign
id|adpt_i2o_lct_get
c_func
(paren
id|pHba
)paren
)paren
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rcode
op_assign
id|adpt_i2o_reparse_lct
c_func
(paren
id|pHba
)paren
)paren
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|rcode
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
id|pHba-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rcode
suffix:semicolon
)brace
DECL|function|adpt_i2o_reparse_lct
r_static
id|s32
id|adpt_i2o_reparse_lct
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|max
suffix:semicolon
r_int
id|tid
suffix:semicolon
r_struct
id|i2o_device
op_star
id|d
suffix:semicolon
id|i2o_lct
op_star
id|lct
op_assign
id|pHba-&gt;lct
suffix:semicolon
id|u8
id|bus_no
op_assign
l_int|0
suffix:semicolon
id|s16
id|scsi_id
suffix:semicolon
id|s16
id|scsi_lun
suffix:semicolon
id|u32
id|buf
(braket
l_int|10
)braket
suffix:semicolon
singleline_comment|// at least 8 u32&squot;s
r_struct
id|adpt_device
op_star
id|pDev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|i2o_device
op_star
id|pI2o_dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|lct
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: LCT is empty???&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|max
op_assign
id|lct-&gt;table_size
suffix:semicolon
id|max
op_sub_assign
l_int|3
suffix:semicolon
id|max
op_div_assign
l_int|9
suffix:semicolon
singleline_comment|// Mark each drive as unscanned
r_for
c_loop
(paren
id|d
op_assign
id|pHba-&gt;devices
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next
)paren
(brace
id|pDev
op_assign
(paren
r_struct
id|adpt_device
op_star
)paren
id|d-&gt;owner
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDev
)paren
(brace
r_continue
suffix:semicolon
)brace
id|pDev-&gt;state
op_or_assign
id|DPTI_DEV_UNSCANNED
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: LCT has %d entries.&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|max
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|lct-&gt;lct_entry
(braket
id|i
)braket
dot
id|user_tid
op_ne
l_int|0xfff
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lct-&gt;lct_entry
(braket
id|i
)braket
dot
id|class_id
op_eq
id|I2O_CLASS_RANDOM_BLOCK_STORAGE
op_logical_or
id|lct-&gt;lct_entry
(braket
id|i
)braket
dot
id|class_id
op_eq
id|I2O_CLASS_SCSI_PERIPHERAL
op_logical_or
id|lct-&gt;lct_entry
(braket
id|i
)braket
dot
id|class_id
op_eq
id|I2O_CLASS_FIBRE_CHANNEL_PERIPHERAL
)paren
(brace
id|tid
op_assign
id|lct-&gt;lct_entry
(braket
id|i
)braket
dot
id|tid
suffix:semicolon
r_if
c_cond
(paren
id|adpt_i2o_query_scalar
c_func
(paren
id|pHba
comma
id|tid
comma
l_int|0x8000
comma
op_minus
l_int|1
comma
id|buf
comma
l_int|32
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Could not query device&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|bus_no
op_assign
id|buf
(braket
l_int|0
)braket
op_rshift
l_int|16
suffix:semicolon
id|scsi_id
op_assign
id|buf
(braket
l_int|1
)braket
suffix:semicolon
id|scsi_lun
op_assign
(paren
id|buf
(braket
l_int|2
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|pDev
op_assign
id|pHba-&gt;channel
(braket
id|bus_no
)braket
dot
id|device
(braket
id|scsi_id
)braket
suffix:semicolon
multiline_comment|/* da lun */
r_while
c_loop
(paren
id|pDev
)paren
(brace
r_if
c_cond
(paren
id|pDev-&gt;scsi_lun
op_eq
id|scsi_lun
)paren
(brace
r_break
suffix:semicolon
)brace
id|pDev
op_assign
id|pDev-&gt;next_lun
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pDev
)paren
(brace
singleline_comment|// Something new add it
id|d
op_assign
(paren
r_struct
id|i2o_device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|i2o_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;Out of memory for I2O device data.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|d-&gt;controller
op_assign
(paren
r_void
op_star
)paren
id|pHba
suffix:semicolon
id|d-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|d-&gt;lct_data
comma
op_amp
id|lct-&gt;lct_entry
(braket
id|i
)braket
comma
r_sizeof
(paren
id|i2o_lct_entry
)paren
)paren
suffix:semicolon
id|d-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|adpt_i2o_report_hba_unit
c_func
(paren
id|pHba
comma
id|d
)paren
suffix:semicolon
id|adpt_i2o_install_device
c_func
(paren
id|pHba
comma
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus_no
op_ge
id|MAX_CHANNEL
)paren
(brace
singleline_comment|// Something wrong skip it
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Channel number %d out of range &bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|bus_no
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pDev
op_assign
id|pHba-&gt;channel
(braket
id|bus_no
)braket
dot
id|device
(braket
id|scsi_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pDev
op_eq
l_int|NULL
)paren
(brace
id|pDev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|adpt_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDev
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pHba-&gt;channel
(braket
id|bus_no
)braket
dot
id|device
(braket
id|scsi_id
)braket
op_assign
id|pDev
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|pDev-&gt;next_lun
)paren
(brace
id|pDev
op_assign
id|pDev-&gt;next_lun
suffix:semicolon
)brace
id|pDev
op_assign
id|pDev-&gt;next_lun
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|adpt_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDev
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
id|pDev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|adpt_device
)paren
)paren
suffix:semicolon
id|pDev-&gt;tid
op_assign
id|d-&gt;lct_data.tid
suffix:semicolon
id|pDev-&gt;scsi_channel
op_assign
id|bus_no
suffix:semicolon
id|pDev-&gt;scsi_id
op_assign
id|scsi_id
suffix:semicolon
id|pDev-&gt;scsi_lun
op_assign
id|scsi_lun
suffix:semicolon
id|pDev-&gt;pI2o_dev
op_assign
id|d
suffix:semicolon
id|d-&gt;owner
op_assign
id|pDev
suffix:semicolon
id|pDev-&gt;type
op_assign
(paren
id|buf
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xff
suffix:semicolon
id|pDev-&gt;flags
op_assign
(paren
id|buf
(braket
l_int|0
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
singleline_comment|// Too late, SCSI system has made up it&squot;s mind, but what the hey ...
r_if
c_cond
(paren
id|scsi_id
OG
id|pHba-&gt;top_scsi_id
)paren
(brace
id|pHba-&gt;top_scsi_id
op_assign
id|scsi_id
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_lun
OG
id|pHba-&gt;top_scsi_lun
)paren
(brace
id|pHba-&gt;top_scsi_lun
op_assign
id|scsi_lun
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
singleline_comment|// end of new i2o device
singleline_comment|// We found an old device - check it
r_while
c_loop
(paren
id|pDev
)paren
(brace
r_if
c_cond
(paren
id|pDev-&gt;scsi_lun
op_eq
id|scsi_lun
)paren
(brace
r_if
c_cond
(paren
id|pDev-&gt;pScsi_dev-&gt;online
op_eq
id|FALSE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Setting device (%d,%d,%d) back online&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|bus_no
comma
id|scsi_id
comma
id|scsi_lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDev-&gt;pScsi_dev
)paren
(brace
id|pDev-&gt;pScsi_dev-&gt;online
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
id|d
op_assign
id|pDev-&gt;pI2o_dev
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;lct_data.tid
op_ne
id|tid
)paren
(brace
singleline_comment|// something changed
id|pDev-&gt;tid
op_assign
id|tid
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|d-&gt;lct_data
comma
op_amp
id|lct-&gt;lct_entry
(braket
id|i
)braket
comma
r_sizeof
(paren
id|i2o_lct_entry
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDev-&gt;pScsi_dev
)paren
(brace
id|pDev-&gt;pScsi_dev-&gt;changed
op_assign
id|TRUE
suffix:semicolon
id|pDev-&gt;pScsi_dev-&gt;removable
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
singleline_comment|// Found it - mark it scanned
id|pDev-&gt;state
op_assign
id|DPTI_DEV_ONLINE
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pDev
op_assign
id|pDev-&gt;next_lun
suffix:semicolon
)brace
)brace
)brace
r_for
c_loop
(paren
id|pI2o_dev
op_assign
id|pHba-&gt;devices
suffix:semicolon
id|pI2o_dev
suffix:semicolon
id|pI2o_dev
op_assign
id|pI2o_dev-&gt;next
)paren
(brace
id|pDev
op_assign
(paren
r_struct
id|adpt_device
op_star
)paren
id|pI2o_dev-&gt;owner
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDev
)paren
(brace
r_continue
suffix:semicolon
)brace
singleline_comment|// Drive offline drives that previously existed but could not be found
singleline_comment|// in the LCT table
r_if
c_cond
(paren
id|pDev-&gt;state
op_amp
id|DPTI_DEV_UNSCANNED
)paren
(brace
id|pDev-&gt;state
op_assign
id|DPTI_DEV_OFFLINE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Device (%d,%d,%d) offline&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|pDev-&gt;scsi_channel
comma
id|pDev-&gt;scsi_id
comma
id|pDev-&gt;scsi_lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDev-&gt;pScsi_dev
)paren
(brace
id|pDev-&gt;pScsi_dev-&gt;online
op_assign
id|FALSE
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_fail_posted_scbs
r_static
r_void
id|adpt_fail_posted_scbs
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|Scsi_Cmnd
op_star
id|cmd
op_assign
l_int|NULL
suffix:semicolon
id|Scsi_Device
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
id|shost_for_each_device
c_func
(paren
id|d
comma
id|pHba-&gt;host
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|cmd
comma
op_amp
id|d-&gt;cmd_list
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|cmd-&gt;serial_number
op_eq
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|cmd-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
(paren
id|QUEUE_FULL
op_lshift
l_int|1
)paren
suffix:semicolon
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================================&n; *  Routines from i2o subsystem&n; *============================================================================&n; */
multiline_comment|/*&n; *&t;Bring an I2O controller into HOLD state. See the spec.&n; */
DECL|function|adpt_i2o_activate_hba
r_static
r_int
id|adpt_i2o_activate_hba
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
r_int
id|rcode
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;initialized
)paren
(brace
r_if
c_cond
(paren
id|adpt_i2o_status_get
c_func
(paren
id|pHba
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|rcode
op_assign
id|adpt_i2o_reset_hba
c_func
(paren
id|pHba
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could NOT reset.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
id|rcode
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adpt_i2o_status_get
c_func
(paren
id|pHba
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HBA not responding.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pHba-&gt;status_block-&gt;iop_state
op_eq
id|ADAPTER_STATE_FAULTED
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%s: hardware fault&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pHba-&gt;status_block-&gt;iop_state
op_eq
id|ADAPTER_STATE_READY
op_logical_or
id|pHba-&gt;status_block-&gt;iop_state
op_eq
id|ADAPTER_STATE_OPERATIONAL
op_logical_or
id|pHba-&gt;status_block-&gt;iop_state
op_eq
id|ADAPTER_STATE_HOLD
op_logical_or
id|pHba-&gt;status_block-&gt;iop_state
op_eq
id|ADAPTER_STATE_FAILED
)paren
(brace
id|adpt_i2o_reset_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adpt_i2o_status_get
c_func
(paren
id|pHba
)paren
OL
l_int|0
op_logical_or
id|pHba-&gt;status_block-&gt;iop_state
op_ne
id|ADAPTER_STATE_RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Failed to initialize.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|rcode
op_assign
id|adpt_i2o_reset_hba
c_func
(paren
id|pHba
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could NOT reset.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
id|rcode
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|adpt_i2o_init_outbound_q
c_func
(paren
id|pHba
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* In HOLD state */
r_if
c_cond
(paren
id|adpt_i2o_hrt_get
c_func
(paren
id|pHba
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Bring a controller online into OPERATIONAL state. &n; */
DECL|function|adpt_i2o_online_hba
r_static
r_int
id|adpt_i2o_online_hba
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
r_if
c_cond
(paren
id|adpt_i2o_systab_send
c_func
(paren
id|pHba
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* In READY state */
r_if
c_cond
(paren
id|adpt_i2o_enable_hba
c_func
(paren
id|pHba
)paren
OL
l_int|0
)paren
(brace
id|adpt_i2o_delete_hba
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* In OPERATIONAL state  */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_send_nop
r_static
id|s32
id|adpt_send_nop
c_func
(paren
id|adpt_hba
op_star
id|pHba
comma
id|u32
id|m
)paren
(brace
id|u32
op_star
id|msg
suffix:semicolon
id|ulong
id|timeout
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|m
op_eq
id|EMPTY_QUEUE
)paren
(brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|m
op_assign
id|readl
c_func
(paren
id|pHba-&gt;post_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_ne
id|EMPTY_QUEUE
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Timeout waiting for message frame!&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|pHba-&gt;msg_addr_virt
op_plus
id|m
)paren
suffix:semicolon
id|writel
c_func
(paren
id|THREE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_UTIL_NOP
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
l_int|0
comma
op_amp
id|msg
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|m
comma
id|pHba-&gt;post_port
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_i2o_init_outbound_q
r_static
id|s32
id|adpt_i2o_init_outbound_q
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|u8
op_star
id|status
suffix:semicolon
id|u32
op_star
id|msg
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ulong
id|timeout
op_assign
id|jiffies
op_plus
id|TMOUT_INITOUTBOUND
op_star
id|HZ
suffix:semicolon
id|u32
op_star
id|ptr
suffix:semicolon
id|u32
id|outbound_frame
suffix:semicolon
singleline_comment|// This had to be a 32 bit address
id|u32
id|m
suffix:semicolon
r_do
(brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|m
op_assign
id|readl
c_func
(paren
id|pHba-&gt;post_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_ne
id|EMPTY_QUEUE
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Timeout waiting for message frame&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|m
op_eq
id|EMPTY_QUEUE
)paren
(brace
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|pHba-&gt;msg_addr_virt
op_plus
id|m
)paren
suffix:semicolon
id|status
op_assign
id|kmalloc
c_func
(paren
l_int|4
comma
id|GFP_KERNEL
op_or
id|ADDR32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|NULL
)paren
(brace
id|adpt_send_nop
c_func
(paren
id|pHba
comma
id|m
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: IOP reset failed - no free memory.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|status
comma
l_int|0
comma
l_int|4
)paren
suffix:semicolon
id|writel
c_func
(paren
id|EIGHT_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_6
comma
op_amp
id|msg
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_OUTBOUND_INIT
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x0106
comma
op_amp
id|msg
(braket
l_int|3
)braket
)paren
suffix:semicolon
multiline_comment|/* Transaction context */
id|writel
c_func
(paren
l_int|4096
comma
op_amp
id|msg
(braket
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/* Host page frame size */
id|writel
c_func
(paren
(paren
id|REPLY_FRAME_SIZE
)paren
op_lshift
l_int|16
op_or
l_int|0x80
comma
op_amp
id|msg
(braket
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/* Outbound msg frame size and Initcode */
id|writel
c_func
(paren
l_int|0xD0000004
comma
op_amp
id|msg
(braket
l_int|6
)braket
)paren
suffix:semicolon
multiline_comment|/* Simple SG LE, EOB */
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|status
)paren
comma
op_amp
id|msg
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|m
comma
id|pHba-&gt;post_port
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// Wait for the reply status to come back
r_do
(brace
r_if
c_cond
(paren
op_star
id|status
)paren
(brace
r_if
c_cond
(paren
op_star
id|status
op_ne
l_int|0x01
multiline_comment|/*I2O_EXEC_OUTBOUND_INIT_IN_PROGRESS*/
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Timeout Initializing&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|status
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
singleline_comment|// If the command was successful, fill the fifo with our reply
singleline_comment|// message packets
r_if
c_cond
(paren
op_star
id|status
op_ne
l_int|0x04
multiline_comment|/*I2O_EXEC_OUTBOUND_INIT_COMPLETE*/
)paren
(brace
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|status
)paren
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;reply_pool
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|pHba-&gt;reply_pool
)paren
suffix:semicolon
)brace
id|pHba-&gt;reply_pool
op_assign
(paren
id|u32
op_star
)paren
id|kmalloc
c_func
(paren
id|pHba-&gt;reply_fifo_size
op_star
id|REPLY_FRAME_SIZE
op_star
l_int|4
comma
id|GFP_KERNEL
op_or
id|ADDR32
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pHba-&gt;reply_pool
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Could not allocate reply pool&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pHba-&gt;reply_pool
comma
l_int|0
comma
id|pHba-&gt;reply_fifo_size
op_star
id|REPLY_FRAME_SIZE
op_star
l_int|4
)paren
suffix:semicolon
id|ptr
op_assign
id|pHba-&gt;reply_pool
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pHba-&gt;reply_fifo_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outbound_frame
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|outbound_frame
comma
id|pHba-&gt;reply_port
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|ptr
op_add_assign
id|REPLY_FRAME_SIZE
suffix:semicolon
)brace
id|adpt_i2o_status_get
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * I2O System Table.  Contains information about&n; * all the IOPs in the system.  Used to inform IOPs&n; * about each other&squot;s existence.&n; *&n; * sys_tbl_ver is the CurrentChangeIndicator that is&n; * used by IOPs to track changes.&n; */
DECL|function|adpt_i2o_status_get
r_static
id|s32
id|adpt_i2o_status_get
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|ulong
id|timeout
suffix:semicolon
id|u32
id|m
suffix:semicolon
id|u32
op_star
id|msg
suffix:semicolon
id|u8
op_star
id|status_block
op_assign
l_int|NULL
suffix:semicolon
id|ulong
id|status_block_bus
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;status_block
op_eq
l_int|NULL
)paren
(brace
id|pHba-&gt;status_block
op_assign
(paren
id|i2o_status_block
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|i2o_status_block
)paren
comma
id|GFP_KERNEL
op_or
id|ADDR32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;status_block
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dpti%d: Get Status Block failed; Out of memory. &bslash;n&quot;
comma
id|pHba-&gt;unit
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
id|pHba-&gt;status_block
comma
l_int|0
comma
r_sizeof
(paren
id|i2o_status_block
)paren
)paren
suffix:semicolon
id|status_block
op_assign
(paren
id|u8
op_star
)paren
(paren
id|pHba-&gt;status_block
)paren
suffix:semicolon
id|status_block_bus
op_assign
id|virt_to_bus
c_func
(paren
id|pHba-&gt;status_block
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|TMOUT_GETSTATUS
op_star
id|HZ
suffix:semicolon
r_do
(brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|m
op_assign
id|readl
c_func
(paren
id|pHba-&gt;post_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_ne
id|EMPTY_QUEUE
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Timeout waiting for message !&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|m
op_eq
id|EMPTY_QUEUE
)paren
(brace
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|u32
op_star
)paren
(paren
id|pHba-&gt;msg_addr_virt
op_plus
id|m
)paren
suffix:semicolon
id|writel
c_func
(paren
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
comma
op_amp
id|msg
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
id|I2O_CMD_STATUS_GET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
comma
op_amp
id|msg
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|1
comma
op_amp
id|msg
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
(paren
id|u32
)paren
id|status_block_bus
)paren
op_amp
l_int|0xffffffff
comma
op_amp
id|msg
(braket
l_int|6
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|msg
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|writel
c_func
(paren
r_sizeof
(paren
id|i2o_status_block
)paren
comma
op_amp
id|msg
(braket
l_int|8
)braket
)paren
suffix:semicolon
singleline_comment|// 88 bytes
singleline_comment|//post message
id|writel
c_func
(paren
id|m
comma
id|pHba-&gt;post_port
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|status_block
(braket
l_int|87
)braket
op_ne
l_int|0xff
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dpti%d: Get status timeout.&bslash;n&quot;
comma
id|pHba-&gt;unit
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
)brace
singleline_comment|// Set up our number of outbound and inbound messages
id|pHba-&gt;post_fifo_size
op_assign
id|pHba-&gt;status_block-&gt;max_inbound_frames
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;post_fifo_size
OG
id|MAX_TO_IOP_MESSAGES
)paren
(brace
id|pHba-&gt;post_fifo_size
op_assign
id|MAX_TO_IOP_MESSAGES
suffix:semicolon
)brace
id|pHba-&gt;reply_fifo_size
op_assign
id|pHba-&gt;status_block-&gt;max_outbound_frames
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;reply_fifo_size
OG
id|MAX_FROM_IOP_MESSAGES
)paren
(brace
id|pHba-&gt;reply_fifo_size
op_assign
id|MAX_FROM_IOP_MESSAGES
suffix:semicolon
)brace
singleline_comment|// Calculate the Scatter Gather list size
id|pHba-&gt;sg_tablesize
op_assign
(paren
id|pHba-&gt;status_block-&gt;inbound_frame_size
op_star
l_int|4
op_minus
l_int|40
)paren
op_div
r_sizeof
(paren
r_struct
id|sg_simple_element
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;sg_tablesize
OG
id|SG_LIST_ELEMENTS
)paren
(brace
id|pHba-&gt;sg_tablesize
op_assign
id|SG_LIST_ELEMENTS
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;dpti%d: State = &quot;
comma
id|pHba-&gt;unit
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|pHba-&gt;status_block-&gt;iop_state
)paren
(brace
r_case
l_int|0x01
suffix:colon
id|printk
c_func
(paren
l_string|&quot;INIT&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|printk
c_func
(paren
l_string|&quot;RESET&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|printk
c_func
(paren
l_string|&quot;HOLD&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|printk
c_func
(paren
l_string|&quot;READY&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|printk
c_func
(paren
l_string|&quot;OPERATIONAL&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x10
suffix:colon
id|printk
c_func
(paren
l_string|&quot;FAILED&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x11
suffix:colon
id|printk
c_func
(paren
l_string|&quot;FAULTED&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%x (unknown!!)&bslash;n&quot;
comma
id|pHba-&gt;status_block-&gt;iop_state
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Get the IOP&squot;s Logical Configuration Table&n; */
DECL|function|adpt_i2o_lct_get
r_static
r_int
id|adpt_i2o_lct_get
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|u32
id|msg
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|u32
id|buf
(braket
l_int|16
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pHba-&gt;lct_size
op_eq
l_int|0
)paren
op_logical_or
(paren
id|pHba-&gt;lct
op_eq
l_int|NULL
)paren
)paren
(brace
id|pHba-&gt;lct_size
op_assign
id|pHba-&gt;status_block-&gt;expected_lct_size
suffix:semicolon
)brace
r_do
(brace
r_if
c_cond
(paren
id|pHba-&gt;lct
op_eq
l_int|NULL
)paren
(brace
id|pHba-&gt;lct
op_assign
id|kmalloc
c_func
(paren
id|pHba-&gt;lct_size
comma
id|GFP_KERNEL
op_or
id|ADDR32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;lct
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%s: Lct Get failed. Out of memory.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
id|pHba-&gt;lct
comma
l_int|0
comma
id|pHba-&gt;lct_size
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|EIGHT_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_6
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_LCT_NOTIFY
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
multiline_comment|/* All devices */
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0x00000000
suffix:semicolon
multiline_comment|/* Report now */
id|msg
(braket
l_int|6
)braket
op_assign
l_int|0xD0000000
op_or
id|pHba-&gt;lct_size
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|pHba-&gt;lct
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|adpt_i2o_post_wait
c_func
(paren
id|pHba
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
l_int|360
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: LCT Get failed (status=%#10x.&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|ret
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Adaptec: Error Reading Hardware.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pHba-&gt;lct-&gt;table_size
op_lshift
l_int|2
)paren
OG
id|pHba-&gt;lct_size
)paren
(brace
id|pHba-&gt;lct_size
op_assign
id|pHba-&gt;lct-&gt;table_size
op_lshift
l_int|2
suffix:semicolon
id|kfree
c_func
(paren
id|pHba-&gt;lct
)paren
suffix:semicolon
id|pHba-&gt;lct
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|pHba-&gt;lct
op_eq
l_int|NULL
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;%s: Hardware resource table read.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
singleline_comment|// I2O_DPT_EXEC_IOP_BUFFERS_GROUP_NO;
r_if
c_cond
(paren
id|adpt_i2o_query_scalar
c_func
(paren
id|pHba
comma
l_int|0
comma
l_int|0x8000
comma
op_minus
l_int|1
comma
id|buf
comma
r_sizeof
(paren
id|buf
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|pHba-&gt;FwDebugBufferSize
op_assign
id|buf
(braket
l_int|1
)braket
suffix:semicolon
id|pHba-&gt;FwDebugBuffer_P
op_assign
id|pHba-&gt;base_addr_virt
op_plus
id|buf
(braket
l_int|0
)braket
suffix:semicolon
id|pHba-&gt;FwDebugFlags_P
op_assign
id|pHba-&gt;FwDebugBuffer_P
op_plus
id|FW_DEBUG_FLAGS_OFFSET
suffix:semicolon
id|pHba-&gt;FwDebugBLEDvalue_P
op_assign
id|pHba-&gt;FwDebugBuffer_P
op_plus
id|FW_DEBUG_BLED_OFFSET
suffix:semicolon
id|pHba-&gt;FwDebugBLEDflag_P
op_assign
id|pHba-&gt;FwDebugBLEDvalue_P
op_plus
l_int|1
suffix:semicolon
id|pHba-&gt;FwDebugStrLength_P
op_assign
id|pHba-&gt;FwDebugBuffer_P
op_plus
id|FW_DEBUG_STR_LENGTH_OFFSET
suffix:semicolon
id|pHba-&gt;FwDebugBuffer_P
op_add_assign
id|buf
(braket
l_int|2
)braket
suffix:semicolon
id|pHba-&gt;FwDebugFlags
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adpt_i2o_build_sys_table
r_static
r_int
id|adpt_i2o_build_sys_table
c_func
(paren
r_void
)paren
(brace
id|adpt_hba
op_star
id|pHba
op_assign
l_int|NULL
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|sys_tbl_len
op_assign
r_sizeof
(paren
r_struct
id|i2o_sys_tbl
)paren
op_plus
singleline_comment|// Header + IOPs
(paren
id|hba_count
)paren
op_star
r_sizeof
(paren
r_struct
id|i2o_sys_tbl_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sys_tbl
)paren
(brace
id|kfree
c_func
(paren
id|sys_tbl
)paren
suffix:semicolon
)brace
id|sys_tbl
op_assign
id|kmalloc
c_func
(paren
id|sys_tbl_len
comma
id|GFP_KERNEL
op_or
id|ADDR32
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sys_tbl
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SysTab Set failed. Out of memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sys_tbl
comma
l_int|0
comma
id|sys_tbl_len
)paren
suffix:semicolon
id|sys_tbl-&gt;num_entries
op_assign
id|hba_count
suffix:semicolon
id|sys_tbl-&gt;version
op_assign
id|I2OVERSION
suffix:semicolon
id|sys_tbl-&gt;change_ind
op_assign
id|sys_tbl_ind
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|pHba
op_assign
id|hba_chain
suffix:semicolon
id|pHba
suffix:semicolon
id|pHba
op_assign
id|pHba-&gt;next
)paren
(brace
singleline_comment|// Get updated Status Block so we have the latest information
r_if
c_cond
(paren
id|adpt_i2o_status_get
c_func
(paren
id|pHba
)paren
)paren
(brace
id|sys_tbl-&gt;num_entries
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
singleline_comment|// try next one&t;
)brace
id|sys_tbl-&gt;iops
(braket
id|count
)braket
dot
id|org_id
op_assign
id|pHba-&gt;status_block-&gt;org_id
suffix:semicolon
id|sys_tbl-&gt;iops
(braket
id|count
)braket
dot
id|iop_id
op_assign
id|pHba-&gt;unit
op_plus
l_int|2
suffix:semicolon
id|sys_tbl-&gt;iops
(braket
id|count
)braket
dot
id|seg_num
op_assign
l_int|0
suffix:semicolon
id|sys_tbl-&gt;iops
(braket
id|count
)braket
dot
id|i2o_version
op_assign
id|pHba-&gt;status_block-&gt;i2o_version
suffix:semicolon
id|sys_tbl-&gt;iops
(braket
id|count
)braket
dot
id|iop_state
op_assign
id|pHba-&gt;status_block-&gt;iop_state
suffix:semicolon
id|sys_tbl-&gt;iops
(braket
id|count
)braket
dot
id|msg_type
op_assign
id|pHba-&gt;status_block-&gt;msg_type
suffix:semicolon
id|sys_tbl-&gt;iops
(braket
id|count
)braket
dot
id|frame_size
op_assign
id|pHba-&gt;status_block-&gt;inbound_frame_size
suffix:semicolon
id|sys_tbl-&gt;iops
(braket
id|count
)braket
dot
id|last_changed
op_assign
id|sys_tbl_ind
op_minus
l_int|1
suffix:semicolon
singleline_comment|// ??
id|sys_tbl-&gt;iops
(braket
id|count
)braket
dot
id|iop_capabilities
op_assign
id|pHba-&gt;status_block-&gt;iop_capabilities
suffix:semicolon
id|sys_tbl-&gt;iops
(braket
id|count
)braket
dot
id|inbound_low
op_assign
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|pHba-&gt;post_port
)paren
suffix:semicolon
id|sys_tbl-&gt;iops
(braket
id|count
)braket
dot
id|inbound_high
op_assign
(paren
id|u32
)paren
(paren
(paren
id|u64
)paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|pHba-&gt;post_port
)paren
op_rshift
l_int|32
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
(brace
id|u32
op_star
id|table
op_assign
(paren
id|u32
op_star
)paren
id|sys_tbl
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sys_tbl_len=%d in 32bit words&bslash;n&quot;
comma
(paren
id|sys_tbl_len
op_rshift
l_int|2
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
(paren
id|sys_tbl_len
op_rshift
l_int|2
)paren
suffix:semicolon
id|count
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sys_tbl[%d] = %0#10x&bslash;n&quot;
comma
id|count
comma
id|table
(braket
id|count
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t; Dump the information block associated with a given unit (TID)&n; */
DECL|function|adpt_i2o_report_hba_unit
r_static
r_void
id|adpt_i2o_report_hba_unit
c_func
(paren
id|adpt_hba
op_star
id|pHba
comma
r_struct
id|i2o_device
op_star
id|d
)paren
(brace
r_char
id|buf
(braket
l_int|64
)braket
suffix:semicolon
r_int
id|unit
op_assign
id|d-&gt;lct_data.tid
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;TID %3.3d &quot;
comma
id|unit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adpt_i2o_query_scalar
c_func
(paren
id|pHba
comma
id|unit
comma
l_int|0xF100
comma
l_int|3
comma
id|buf
comma
l_int|16
)paren
op_ge
l_int|0
)paren
(brace
id|buf
(braket
l_int|16
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; Vendor: %-12.12s&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adpt_i2o_query_scalar
c_func
(paren
id|pHba
comma
id|unit
comma
l_int|0xF100
comma
l_int|4
comma
id|buf
comma
l_int|16
)paren
op_ge
l_int|0
)paren
(brace
id|buf
(braket
l_int|16
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; Device: %-12.12s&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adpt_i2o_query_scalar
c_func
(paren
id|pHba
comma
id|unit
comma
l_int|0xF100
comma
l_int|6
comma
id|buf
comma
l_int|8
)paren
op_ge
l_int|0
)paren
(brace
id|buf
(braket
l_int|8
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; Rev: %-12.12s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;tClass: %.21s&bslash;n&quot;
comma
id|adpt_i2o_get_class_name
c_func
(paren
id|d-&gt;lct_data.class_id
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;tSubclass: 0x%04X&bslash;n&quot;
comma
id|d-&gt;lct_data.sub_class
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;tFlags: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;lct_data.device_flags
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;C&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// ConfigDialog requested
r_if
c_cond
(paren
id|d-&gt;lct_data.device_flags
op_amp
(paren
l_int|1
op_lshift
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;U&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// Multi-user capable
r_if
c_cond
(paren
op_logical_neg
(paren
id|d-&gt;lct_data.device_flags
op_amp
(paren
l_int|1
op_lshift
l_int|4
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;P&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// Peer service enabled!
r_if
c_cond
(paren
op_logical_neg
(paren
id|d-&gt;lct_data.device_flags
op_amp
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;M&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// Mgmt service enabled!
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef DEBUG
multiline_comment|/*&n; *&t;Do i2o class name lookup&n; */
DECL|function|adpt_i2o_get_class_name
r_static
r_const
r_char
op_star
id|adpt_i2o_get_class_name
c_func
(paren
r_int
r_class
)paren
(brace
r_int
id|idx
op_assign
l_int|16
suffix:semicolon
r_static
r_char
op_star
id|i2o_class_name
(braket
)braket
op_assign
(brace
l_string|&quot;Executive&quot;
comma
l_string|&quot;Device Driver Module&quot;
comma
l_string|&quot;Block Device&quot;
comma
l_string|&quot;Tape Device&quot;
comma
l_string|&quot;LAN Interface&quot;
comma
l_string|&quot;WAN Interface&quot;
comma
l_string|&quot;Fibre Channel Port&quot;
comma
l_string|&quot;Fibre Channel Device&quot;
comma
l_string|&quot;SCSI Device&quot;
comma
l_string|&quot;ATE Port&quot;
comma
l_string|&quot;ATE Device&quot;
comma
l_string|&quot;Floppy Controller&quot;
comma
l_string|&quot;Floppy Device&quot;
comma
l_string|&quot;Secondary Bus Port&quot;
comma
l_string|&quot;Peer Transport Agent&quot;
comma
l_string|&quot;Peer Transport&quot;
comma
l_string|&quot;Unknown&quot;
)brace
suffix:semicolon
r_switch
c_cond
(paren
r_class
op_amp
l_int|0xFFF
)paren
(brace
r_case
id|I2O_CLASS_EXECUTIVE
suffix:colon
id|idx
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_DDM
suffix:colon
id|idx
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_RANDOM_BLOCK_STORAGE
suffix:colon
id|idx
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_SEQUENTIAL_STORAGE
suffix:colon
id|idx
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_LAN
suffix:colon
id|idx
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_WAN
suffix:colon
id|idx
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_FIBRE_CHANNEL_PORT
suffix:colon
id|idx
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_FIBRE_CHANNEL_PERIPHERAL
suffix:colon
id|idx
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_SCSI_PERIPHERAL
suffix:colon
id|idx
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_ATE_PORT
suffix:colon
id|idx
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_ATE_PERIPHERAL
suffix:colon
id|idx
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_FLOPPY_CONTROLLER
suffix:colon
id|idx
op_assign
l_int|11
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_FLOPPY_DEVICE
suffix:colon
id|idx
op_assign
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_BUS_ADAPTER_PORT
suffix:colon
id|idx
op_assign
l_int|13
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_PEER_TRANSPORT_AGENT
suffix:colon
id|idx
op_assign
l_int|14
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2O_CLASS_PEER_TRANSPORT
suffix:colon
id|idx
op_assign
l_int|15
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|i2o_class_name
(braket
id|idx
)braket
suffix:semicolon
)brace
macro_line|#endif
DECL|function|adpt_i2o_hrt_get
r_static
id|s32
id|adpt_i2o_hrt_get
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|u32
id|msg
(braket
l_int|6
)braket
suffix:semicolon
r_int
id|ret
comma
id|size
op_assign
r_sizeof
(paren
id|i2o_hrt
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|pHba-&gt;hrt
op_eq
l_int|NULL
)paren
(brace
id|pHba-&gt;hrt
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
op_or
id|ADDR32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pHba-&gt;hrt
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%s: Hrt Get failed; Out of memory.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|msg
(braket
l_int|0
)braket
op_assign
id|SIX_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_4
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_HRT_GET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
(paren
l_int|0xD0000000
op_or
id|size
)paren
suffix:semicolon
multiline_comment|/* Simple transaction */
id|msg
(braket
l_int|5
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|pHba-&gt;hrt
)paren
suffix:semicolon
multiline_comment|/* Dump it here */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|adpt_i2o_post_wait
c_func
(paren
id|pHba
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
l_int|20
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to get HRT (status=%#10x)&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pHba-&gt;hrt-&gt;num_entries
op_star
id|pHba-&gt;hrt-&gt;entry_len
op_lshift
l_int|2
OG
id|size
)paren
(brace
id|size
op_assign
id|pHba-&gt;hrt-&gt;num_entries
op_star
id|pHba-&gt;hrt-&gt;entry_len
op_lshift
l_int|2
suffix:semicolon
id|kfree
c_func
(paren
id|pHba-&gt;hrt
)paren
suffix:semicolon
id|pHba-&gt;hrt
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|pHba-&gt;hrt
op_eq
l_int|NULL
)paren
(brace
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t; Query one scalar group value or a whole scalar group.&n; */
DECL|function|adpt_i2o_query_scalar
r_static
r_int
id|adpt_i2o_query_scalar
c_func
(paren
id|adpt_hba
op_star
id|pHba
comma
r_int
id|tid
comma
r_int
id|group
comma
r_int
id|field
comma
r_void
op_star
id|buf
comma
r_int
id|buflen
)paren
(brace
id|u16
id|opblk
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|0
comma
id|I2O_PARAMS_FIELD_GET
comma
id|group
comma
l_int|1
comma
id|field
)brace
suffix:semicolon
id|u8
id|resblk
(braket
l_int|8
op_plus
id|buflen
)braket
suffix:semicolon
multiline_comment|/* 8 bytes for header */
r_int
id|size
suffix:semicolon
r_if
c_cond
(paren
id|field
op_eq
op_minus
l_int|1
)paren
multiline_comment|/* whole group */
id|opblk
(braket
l_int|4
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|size
op_assign
id|adpt_i2o_issue_params
c_func
(paren
id|I2O_CMD_UTIL_PARAMS_GET
comma
id|pHba
comma
id|tid
comma
id|opblk
comma
r_sizeof
(paren
id|opblk
)paren
comma
id|resblk
comma
r_sizeof
(paren
id|resblk
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|resblk
op_plus
l_int|8
comma
id|buflen
)paren
suffix:semicolon
multiline_comment|/* cut off header */
r_if
c_cond
(paren
id|size
OL
l_int|0
)paren
r_return
id|size
suffix:semicolon
r_return
id|buflen
suffix:semicolon
)brace
multiline_comment|/*&t;Issue UTIL_PARAMS_GET or UTIL_PARAMS_SET&n; *&n; *&t;This function can be used for all UtilParamsGet/Set operations.&n; *&t;The OperationBlock is given in opblk-buffer, &n; *&t;and results are returned in resblk-buffer.&n; *&t;Note that the minimum sized resblk is 8 bytes and contains&n; *&t;ResultCount, ErrorInfoSize, BlockStatus and BlockSize.&n; */
DECL|function|adpt_i2o_issue_params
r_static
r_int
id|adpt_i2o_issue_params
c_func
(paren
r_int
id|cmd
comma
id|adpt_hba
op_star
id|pHba
comma
r_int
id|tid
comma
r_void
op_star
id|opblk
comma
r_int
id|oplen
comma
r_void
op_star
id|resblk
comma
r_int
id|reslen
)paren
(brace
id|u32
id|msg
(braket
l_int|9
)braket
suffix:semicolon
id|u32
op_star
id|res
op_assign
(paren
id|u32
op_star
)paren
id|resblk
suffix:semicolon
r_int
id|wait_status
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|NINE_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_5
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|cmd
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|tid
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0x54000000
op_or
id|oplen
suffix:semicolon
multiline_comment|/* OperationBlock */
id|msg
(braket
l_int|6
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|opblk
)paren
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
l_int|0xD0000000
op_or
id|reslen
suffix:semicolon
multiline_comment|/* ResultBlock */
id|msg
(braket
l_int|8
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|resblk
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wait_status
op_assign
id|adpt_i2o_post_wait
c_func
(paren
id|pHba
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
l_int|20
)paren
)paren
)paren
(brace
r_return
id|wait_status
suffix:semicolon
multiline_comment|/* -DetailedStatus */
)brace
r_if
c_cond
(paren
id|res
(braket
l_int|1
)braket
op_amp
l_int|0x00FF0000
)paren
(brace
multiline_comment|/* BlockStatus != SUCCESS */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: %s - Error:&bslash;n  ErrorInfoSize = 0x%02x, &quot;
l_string|&quot;BlockStatus = 0x%02x, BlockSize = 0x%04x&bslash;n&quot;
comma
id|pHba-&gt;name
comma
(paren
id|cmd
op_eq
id|I2O_CMD_UTIL_PARAMS_SET
)paren
ques
c_cond
l_string|&quot;PARAMS_SET&quot;
suffix:colon
l_string|&quot;PARAMS_GET&quot;
comma
id|res
(braket
l_int|1
)braket
op_rshift
l_int|24
comma
(paren
id|res
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
comma
id|res
(braket
l_int|1
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
r_return
op_minus
(paren
(paren
id|res
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* -BlockStatus */
)brace
r_return
l_int|4
op_plus
(paren
(paren
id|res
(braket
l_int|1
)braket
op_amp
l_int|0x0000FFFF
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* bytes used in resblk */
)brace
DECL|function|adpt_i2o_quiesce_hba
r_static
id|s32
id|adpt_i2o_quiesce_hba
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|u32
id|msg
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|adpt_i2o_status_get
c_func
(paren
id|pHba
)paren
suffix:semicolon
multiline_comment|/* SysQuiesce discarded if IOP not in READY or OPERATIONAL state */
r_if
c_cond
(paren
(paren
id|pHba-&gt;status_block-&gt;iop_state
op_ne
id|ADAPTER_STATE_READY
)paren
op_logical_and
(paren
id|pHba-&gt;status_block-&gt;iop_state
op_ne
id|ADAPTER_STATE_OPERATIONAL
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_SYS_QUIESCE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|adpt_i2o_post_wait
c_func
(paren
id|pHba
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
l_int|240
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;dpti%d: Unable to quiesce (status=%#x).&bslash;n&quot;
comma
id|pHba-&gt;unit
comma
op_minus
id|ret
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;dpti%d: Quiesced.&bslash;n&quot;
comma
id|pHba-&gt;unit
)paren
suffix:semicolon
)brace
id|adpt_i2o_status_get
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* &n; * Enable IOP. Allows the IOP to resume external operations.&n; */
DECL|function|adpt_i2o_enable_hba
r_static
r_int
id|adpt_i2o_enable_hba
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|u32
id|msg
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|adpt_i2o_status_get
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pHba-&gt;status_block
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Enable only allowed on READY state */
r_if
c_cond
(paren
id|pHba-&gt;status_block-&gt;iop_state
op_eq
id|ADAPTER_STATE_OPERATIONAL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pHba-&gt;status_block-&gt;iop_state
op_ne
id|ADAPTER_STATE_READY
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|msg
(braket
l_int|0
)braket
op_assign
id|FOUR_WORD_MSG_SIZE
op_or
id|SGL_OFFSET_0
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_SYS_ENABLE
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|adpt_i2o_post_wait
c_func
(paren
id|pHba
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
l_int|240
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Could not enable (status=%#10x).&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|ret
)paren
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;%s: Enabled.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
)brace
id|adpt_i2o_status_get
c_func
(paren
id|pHba
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|adpt_i2o_systab_send
r_static
r_int
id|adpt_i2o_systab_send
c_func
(paren
id|adpt_hba
op_star
id|pHba
)paren
(brace
id|u32
id|msg
(braket
l_int|12
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|msg
(braket
l_int|0
)braket
op_assign
id|I2O_MESSAGE_SIZE
c_func
(paren
l_int|12
)paren
op_or
id|SGL_OFFSET_6
suffix:semicolon
id|msg
(braket
l_int|1
)braket
op_assign
id|I2O_CMD_SYS_TAB_SET
op_lshift
l_int|24
op_or
id|HOST_TID
op_lshift
l_int|12
op_or
id|ADAPTER_TID
suffix:semicolon
id|msg
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|4
)braket
op_assign
(paren
l_int|0
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|pHba-&gt;unit
op_plus
l_int|2
)paren
op_lshift
l_int|12
)paren
suffix:semicolon
multiline_comment|/* Host 0 IOP ID (unit + 2) */
id|msg
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Segment 0 */
multiline_comment|/* &n;&t; * Provide three SGL-elements:&n;&t; * System table (SysTab), Private memory space declaration and &n;&t; * Private i/o space declaration  &n;&t; */
id|msg
(braket
l_int|6
)braket
op_assign
l_int|0x54000000
op_or
id|sys_tbl_len
suffix:semicolon
id|msg
(braket
l_int|7
)braket
op_assign
id|virt_to_phys
c_func
(paren
id|sys_tbl
)paren
suffix:semicolon
id|msg
(braket
l_int|8
)braket
op_assign
l_int|0x54000000
op_or
l_int|0
suffix:semicolon
id|msg
(braket
l_int|9
)braket
op_assign
l_int|0
suffix:semicolon
id|msg
(braket
l_int|10
)braket
op_assign
l_int|0xD4000000
op_or
l_int|0
suffix:semicolon
id|msg
(braket
l_int|11
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|adpt_i2o_post_wait
c_func
(paren
id|pHba
comma
id|msg
comma
r_sizeof
(paren
id|msg
)paren
comma
l_int|120
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unable to set SysTab (status=%#10x).&bslash;n&quot;
comma
id|pHba-&gt;name
comma
id|ret
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_else
(brace
id|PINFO
c_func
(paren
l_string|&quot;%s: SysTab set.&bslash;n&quot;
comma
id|pHba-&gt;name
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*============================================================================&n; *&n; *============================================================================&n; */
macro_line|#ifdef UARTDELAY 
DECL|function|adpt_delay
r_static
r_static
r_void
id|adpt_delay
c_func
(paren
r_int
id|millisec
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|millisec
suffix:semicolon
id|i
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* delay for one millisecond */
)brace
)brace
macro_line|#endif
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;dpt_i2o&quot;
comma
dot
id|proc_name
op_assign
l_string|&quot;dpt_i2o&quot;
comma
dot
id|proc_info
op_assign
id|adpt_proc_info
comma
dot
id|detect
op_assign
id|adpt_detect
comma
dot
id|release
op_assign
id|adpt_release
comma
dot
id|info
op_assign
id|adpt_info
comma
dot
id|queuecommand
op_assign
id|adpt_queue
comma
dot
id|eh_abort_handler
op_assign
id|adpt_abort
comma
dot
id|eh_device_reset_handler
op_assign
id|adpt_device_reset
comma
dot
id|eh_bus_reset_handler
op_assign
id|adpt_bus_reset
comma
dot
id|eh_host_reset_handler
op_assign
id|adpt_reset
comma
dot
id|bios_param
op_assign
id|adpt_bios_param
comma
dot
id|slave_configure
op_assign
id|adpt_slave_configure
comma
dot
id|can_queue
op_assign
id|MAX_TO_IOP_MESSAGES
comma
dot
id|this_id
op_assign
l_int|7
comma
dot
id|cmd_per_lun
op_assign
l_int|1
comma
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
)brace
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
