multiline_comment|/*&n; *  sata_qstor.c - Pacific Digital Corporation QStor SATA&n; *&n; *  Maintained by:  Mark Lord &lt;mlord@pobox.com&gt;&n; *&n; *  Copyright 2005 Pacific Digital Corporation.&n; *  (OSL/GPL code release authorized by Jalil Fadavi).&n; *&n; *  The contents of this file are subject to the Open&n; *  Software License version 1.1 that can be found at&n; *  http://www.opensource.org/licenses/osl-1.1.txt and is included herein&n; *  by reference.&n; *&n; *  Alternatively, the contents of this file may be used under the terms&n; *  of the GNU General Public License version 2 (the &quot;GPL&quot;) as distributed&n; *  in the kernel source COPYING file, in which case the provisions of&n; *  the GPL are applicable instead of the above.  If you wish to allow&n; *  the use of your version of this file only under the terms of the&n; *  GPL and not to allow others to use your version of this file under&n; *  the OSL, indicate your decision by deleting the provisions above and&n; *  replace them with the notice and other provisions required by the GPL.&n; *  If you do not delete the provisions above, a recipient may use your&n; *  version of this file under either the OSL or the GPL.&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/libata.h&gt;
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME&t;&quot;sata_qstor&quot;
DECL|macro|DRV_VERSION
mdefine_line|#define DRV_VERSION&t;&quot;0.03&quot;
r_enum
(brace
DECL|enumerator|QS_PORTS
id|QS_PORTS
op_assign
l_int|4
comma
DECL|enumerator|QS_MAX_PRD
id|QS_MAX_PRD
op_assign
id|LIBATA_MAX_PRD
comma
DECL|enumerator|QS_CPB_ORDER
id|QS_CPB_ORDER
op_assign
l_int|6
comma
DECL|enumerator|QS_CPB_BYTES
id|QS_CPB_BYTES
op_assign
(paren
l_int|1
op_lshift
id|QS_CPB_ORDER
)paren
comma
DECL|enumerator|QS_PRD_BYTES
id|QS_PRD_BYTES
op_assign
id|QS_MAX_PRD
op_star
l_int|16
comma
DECL|enumerator|QS_PKT_BYTES
id|QS_PKT_BYTES
op_assign
id|QS_CPB_BYTES
op_plus
id|QS_PRD_BYTES
comma
DECL|enumerator|QS_DMA_BOUNDARY
id|QS_DMA_BOUNDARY
op_assign
op_complement
l_int|0UL
comma
multiline_comment|/* global register offsets */
DECL|enumerator|QS_HCF_CNFG3
id|QS_HCF_CNFG3
op_assign
l_int|0x0003
comma
multiline_comment|/* host configuration offset */
DECL|enumerator|QS_HID_HPHY
id|QS_HID_HPHY
op_assign
l_int|0x0004
comma
multiline_comment|/* host physical interface info */
DECL|enumerator|QS_HCT_CTRL
id|QS_HCT_CTRL
op_assign
l_int|0x00e4
comma
multiline_comment|/* global interrupt mask offset */
DECL|enumerator|QS_HST_SFF
id|QS_HST_SFF
op_assign
l_int|0x0100
comma
multiline_comment|/* host status fifo offset */
DECL|enumerator|QS_HVS_SERD3
id|QS_HVS_SERD3
op_assign
l_int|0x0393
comma
multiline_comment|/* PHY enable offset */
multiline_comment|/* global control bits */
DECL|enumerator|QS_HPHY_64BIT
id|QS_HPHY_64BIT
op_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
comma
multiline_comment|/* 64-bit bus detected */
DECL|enumerator|QS_CNFG3_GSRST
id|QS_CNFG3_GSRST
op_assign
l_int|0x01
comma
multiline_comment|/* global chip reset */
DECL|enumerator|QS_SERD3_PHY_ENA
id|QS_SERD3_PHY_ENA
op_assign
l_int|0xf0
comma
multiline_comment|/* PHY detection ENAble*/
multiline_comment|/* per-channel register offsets */
DECL|enumerator|QS_CCF_CPBA
id|QS_CCF_CPBA
op_assign
l_int|0x0710
comma
multiline_comment|/* chan CPB base address */
DECL|enumerator|QS_CCF_CSEP
id|QS_CCF_CSEP
op_assign
l_int|0x0718
comma
multiline_comment|/* chan CPB separation factor */
DECL|enumerator|QS_CFC_HUFT
id|QS_CFC_HUFT
op_assign
l_int|0x0800
comma
multiline_comment|/* host upstream fifo threshold */
DECL|enumerator|QS_CFC_HDFT
id|QS_CFC_HDFT
op_assign
l_int|0x0804
comma
multiline_comment|/* host downstream fifo threshold */
DECL|enumerator|QS_CFC_DUFT
id|QS_CFC_DUFT
op_assign
l_int|0x0808
comma
multiline_comment|/* dev upstream fifo threshold */
DECL|enumerator|QS_CFC_DDFT
id|QS_CFC_DDFT
op_assign
l_int|0x080c
comma
multiline_comment|/* dev downstream fifo threshold */
DECL|enumerator|QS_CCT_CTR0
id|QS_CCT_CTR0
op_assign
l_int|0x0900
comma
multiline_comment|/* chan control-0 offset */
DECL|enumerator|QS_CCT_CTR1
id|QS_CCT_CTR1
op_assign
l_int|0x0901
comma
multiline_comment|/* chan control-1 offset */
DECL|enumerator|QS_CCT_CFF
id|QS_CCT_CFF
op_assign
l_int|0x0a00
comma
multiline_comment|/* chan command fifo offset */
multiline_comment|/* channel control bits */
DECL|enumerator|QS_CTR0_REG
id|QS_CTR0_REG
op_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
comma
multiline_comment|/* register mode (vs. pkt mode) */
DECL|enumerator|QS_CTR0_CLER
id|QS_CTR0_CLER
op_assign
(paren
l_int|1
op_lshift
l_int|2
)paren
comma
multiline_comment|/* clear channel errors */
DECL|enumerator|QS_CTR1_RDEV
id|QS_CTR1_RDEV
op_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
comma
multiline_comment|/* sata phy/comms reset */
DECL|enumerator|QS_CTR1_RCHN
id|QS_CTR1_RCHN
op_assign
(paren
l_int|1
op_lshift
l_int|4
)paren
comma
multiline_comment|/* reset channel logic */
DECL|enumerator|QS_CCF_RUN_PKT
id|QS_CCF_RUN_PKT
op_assign
l_int|0x107
comma
multiline_comment|/* RUN a new dma PKT */
multiline_comment|/* pkt sub-field headers */
DECL|enumerator|QS_HCB_HDR
id|QS_HCB_HDR
op_assign
l_int|0x01
comma
multiline_comment|/* Host Control Block header */
DECL|enumerator|QS_DCB_HDR
id|QS_DCB_HDR
op_assign
l_int|0x02
comma
multiline_comment|/* Device Control Block header */
multiline_comment|/* pkt HCB flag bits */
DECL|enumerator|QS_HF_DIRO
id|QS_HF_DIRO
op_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
comma
multiline_comment|/* data DIRection Out */
DECL|enumerator|QS_HF_DAT
id|QS_HF_DAT
op_assign
(paren
l_int|1
op_lshift
l_int|3
)paren
comma
multiline_comment|/* DATa pkt */
DECL|enumerator|QS_HF_IEN
id|QS_HF_IEN
op_assign
(paren
l_int|1
op_lshift
l_int|4
)paren
comma
multiline_comment|/* Interrupt ENable */
DECL|enumerator|QS_HF_VLD
id|QS_HF_VLD
op_assign
(paren
l_int|1
op_lshift
l_int|5
)paren
comma
multiline_comment|/* VaLiD pkt */
multiline_comment|/* pkt DCB flag bits */
DECL|enumerator|QS_DF_PORD
id|QS_DF_PORD
op_assign
(paren
l_int|1
op_lshift
l_int|2
)paren
comma
multiline_comment|/* Pio OR Dma */
DECL|enumerator|QS_DF_ELBA
id|QS_DF_ELBA
op_assign
(paren
l_int|1
op_lshift
l_int|3
)paren
comma
multiline_comment|/* Extended LBA (lba48) */
multiline_comment|/* PCI device IDs */
DECL|enumerator|board_2068_idx
id|board_2068_idx
op_assign
l_int|0
comma
multiline_comment|/* QStor 4-port SATA/RAID */
)brace
suffix:semicolon
DECL|enumerator|qs_state_idle
DECL|enumerator|qs_state_pkt
DECL|enumerator|qs_state_mmio
DECL|typedef|qs_state_t
r_typedef
r_enum
(brace
id|qs_state_idle
comma
id|qs_state_pkt
comma
id|qs_state_mmio
)brace
id|qs_state_t
suffix:semicolon
DECL|struct|qs_port_priv
r_struct
id|qs_port_priv
(brace
DECL|member|pkt
id|u8
op_star
id|pkt
suffix:semicolon
DECL|member|pkt_dma
id|dma_addr_t
id|pkt_dma
suffix:semicolon
DECL|member|state
id|qs_state_t
id|state
suffix:semicolon
)brace
suffix:semicolon
r_static
id|u32
id|qs_scr_read
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|sc_reg
)paren
suffix:semicolon
r_static
r_void
id|qs_scr_write
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|sc_reg
comma
id|u32
id|val
)paren
suffix:semicolon
r_static
r_int
id|qs_ata_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|qs_intr
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|qs_port_start
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_void
id|qs_host_stop
c_func
(paren
r_struct
id|ata_host_set
op_star
id|host_set
)paren
suffix:semicolon
r_static
r_void
id|qs_port_stop
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_void
id|qs_phy_reset
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_void
id|qs_qc_prep
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
suffix:semicolon
r_static
r_int
id|qs_qc_issue
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
suffix:semicolon
r_static
r_int
id|qs_check_atapi_dma
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
suffix:semicolon
r_static
r_void
id|qs_bmdma_stop
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
id|u8
id|qs_bmdma_status
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_void
id|qs_irq_clear
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
DECL|variable|qs_ata_sht
r_static
id|Scsi_Host_Template
id|qs_ata_sht
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|DRV_NAME
comma
dot
id|ioctl
op_assign
id|ata_scsi_ioctl
comma
dot
id|queuecommand
op_assign
id|ata_scsi_queuecmd
comma
dot
id|eh_strategy_handler
op_assign
id|ata_scsi_error
comma
dot
id|can_queue
op_assign
id|ATA_DEF_QUEUE
comma
dot
id|this_id
op_assign
id|ATA_SHT_THIS_ID
comma
dot
id|sg_tablesize
op_assign
id|QS_MAX_PRD
comma
dot
id|max_sectors
op_assign
id|ATA_MAX_SECTORS
comma
dot
id|cmd_per_lun
op_assign
id|ATA_SHT_CMD_PER_LUN
comma
dot
id|emulated
op_assign
id|ATA_SHT_EMULATED
comma
singleline_comment|//FIXME .use_clustering&t;&t;= ATA_SHT_USE_CLUSTERING,
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
dot
id|proc_name
op_assign
id|DRV_NAME
comma
dot
id|dma_boundary
op_assign
id|QS_DMA_BOUNDARY
comma
dot
id|slave_configure
op_assign
id|ata_scsi_slave_config
comma
dot
id|bios_param
op_assign
id|ata_std_bios_param
comma
)brace
suffix:semicolon
DECL|variable|qs_ata_ops
r_static
r_struct
id|ata_port_operations
id|qs_ata_ops
op_assign
(brace
dot
id|port_disable
op_assign
id|ata_port_disable
comma
dot
id|tf_load
op_assign
id|ata_tf_load
comma
dot
id|tf_read
op_assign
id|ata_tf_read
comma
dot
id|check_status
op_assign
id|ata_check_status
comma
dot
id|check_atapi_dma
op_assign
id|qs_check_atapi_dma
comma
dot
id|exec_command
op_assign
id|ata_exec_command
comma
dot
id|dev_select
op_assign
id|ata_std_dev_select
comma
dot
id|phy_reset
op_assign
id|qs_phy_reset
comma
dot
id|qc_prep
op_assign
id|qs_qc_prep
comma
dot
id|qc_issue
op_assign
id|qs_qc_issue
comma
dot
id|eng_timeout
op_assign
id|ata_eng_timeout
comma
dot
id|irq_handler
op_assign
id|qs_intr
comma
dot
id|irq_clear
op_assign
id|qs_irq_clear
comma
dot
id|scr_read
op_assign
id|qs_scr_read
comma
dot
id|scr_write
op_assign
id|qs_scr_write
comma
dot
id|port_start
op_assign
id|qs_port_start
comma
dot
id|port_stop
op_assign
id|qs_port_stop
comma
dot
id|host_stop
op_assign
id|qs_host_stop
comma
dot
id|bmdma_stop
op_assign
id|qs_bmdma_stop
comma
dot
id|bmdma_status
op_assign
id|qs_bmdma_status
comma
)brace
suffix:semicolon
DECL|variable|qs_port_info
r_static
r_struct
id|ata_port_info
id|qs_port_info
(braket
)braket
op_assign
(brace
multiline_comment|/* board_2068_idx */
(brace
dot
id|sht
op_assign
op_amp
id|qs_ata_sht
comma
dot
id|host_flags
op_assign
id|ATA_FLAG_SATA
op_or
id|ATA_FLAG_NO_LEGACY
op_or
id|ATA_FLAG_SATA_RESET
op_or
singleline_comment|//FIXME ATA_FLAG_SRST |
id|ATA_FLAG_MMIO
comma
dot
id|pio_mask
op_assign
l_int|0x10
comma
multiline_comment|/* pio4 */
dot
id|udma_mask
op_assign
l_int|0x7f
comma
multiline_comment|/* udma0-6 */
dot
id|port_ops
op_assign
op_amp
id|qs_ata_ops
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|qs_ata_pci_tbl
r_static
r_struct
id|pci_device_id
id|qs_ata_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_PDC
comma
l_int|0x2068
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|board_2068_idx
)brace
comma
(brace
)brace
multiline_comment|/* terminate list */
)brace
suffix:semicolon
DECL|variable|qs_ata_pci_driver
r_static
r_struct
id|pci_driver
id|qs_ata_pci_driver
op_assign
(brace
dot
id|name
op_assign
id|DRV_NAME
comma
dot
id|id_table
op_assign
id|qs_ata_pci_tbl
comma
dot
id|probe
op_assign
id|qs_ata_init_one
comma
dot
id|remove
op_assign
id|ata_pci_remove_one
comma
)brace
suffix:semicolon
DECL|function|qs_check_atapi_dma
r_static
r_int
id|qs_check_atapi_dma
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* ATAPI DMA not supported */
)brace
DECL|function|qs_bmdma_stop
r_static
r_void
id|qs_bmdma_stop
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
multiline_comment|/* nothing */
)brace
DECL|function|qs_bmdma_status
r_static
id|u8
id|qs_bmdma_status
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qs_irq_clear
r_static
r_void
id|qs_irq_clear
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
multiline_comment|/* nothing */
)brace
DECL|function|qs_enter_reg_mode
r_static
r_void
id|qs_enter_reg_mode
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
id|u8
id|__iomem
op_star
id|chan
op_assign
id|ap-&gt;host_set-&gt;mmio_base
op_plus
(paren
id|ap-&gt;port_no
op_star
l_int|0x4000
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|QS_CTR0_REG
comma
id|chan
op_plus
id|QS_CCT_CTR0
)paren
suffix:semicolon
id|readb
c_func
(paren
id|chan
op_plus
id|QS_CCT_CTR0
)paren
suffix:semicolon
multiline_comment|/* flush */
)brace
DECL|function|qs_phy_reset
r_static
r_void
id|qs_phy_reset
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
id|u8
id|__iomem
op_star
id|chan
op_assign
id|ap-&gt;host_set-&gt;mmio_base
op_plus
(paren
id|ap-&gt;port_no
op_star
l_int|0x4000
)paren
suffix:semicolon
r_struct
id|qs_port_priv
op_star
id|pp
op_assign
id|ap-&gt;private_data
suffix:semicolon
id|pp-&gt;state
op_assign
id|qs_state_idle
suffix:semicolon
id|writeb
c_func
(paren
id|QS_CTR1_RCHN
comma
id|chan
op_plus
id|QS_CCT_CTR1
)paren
suffix:semicolon
id|qs_enter_reg_mode
c_func
(paren
id|ap
)paren
suffix:semicolon
id|sata_phy_reset
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
DECL|function|qs_scr_read
r_static
id|u32
id|qs_scr_read
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|sc_reg
)paren
(brace
r_if
c_cond
(paren
id|sc_reg
OG
id|SCR_CONTROL
)paren
r_return
op_complement
l_int|0U
suffix:semicolon
r_return
id|readl
c_func
(paren
(paren
r_void
id|__iomem
op_star
)paren
(paren
id|ap-&gt;ioaddr.scr_addr
op_plus
(paren
id|sc_reg
op_star
l_int|8
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|qs_scr_write
r_static
r_void
id|qs_scr_write
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|sc_reg
comma
id|u32
id|val
)paren
(brace
r_if
c_cond
(paren
id|sc_reg
OG
id|SCR_CONTROL
)paren
r_return
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
(paren
r_void
id|__iomem
op_star
)paren
(paren
id|ap-&gt;ioaddr.scr_addr
op_plus
(paren
id|sc_reg
op_star
l_int|8
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|qs_fill_sg
r_static
r_void
id|qs_fill_sg
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
id|qc-&gt;sg
suffix:semicolon
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
r_struct
id|qs_port_priv
op_star
id|pp
op_assign
id|ap-&gt;private_data
suffix:semicolon
r_int
r_int
id|nelem
suffix:semicolon
id|u8
op_star
id|prd
op_assign
id|pp-&gt;pkt
op_plus
id|QS_CPB_BYTES
suffix:semicolon
m_assert
(paren
id|sg
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|qc-&gt;n_elem
OG
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|nelem
op_assign
l_int|0
suffix:semicolon
id|nelem
OL
id|qc-&gt;n_elem
suffix:semicolon
id|nelem
op_increment
comma
id|sg
op_increment
)paren
(brace
id|u64
id|addr
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|addr
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
op_star
(paren
id|__le64
op_star
)paren
id|prd
op_assign
id|cpu_to_le64
c_func
(paren
id|addr
)paren
suffix:semicolon
id|prd
op_add_assign
r_sizeof
(paren
id|u64
)paren
suffix:semicolon
id|len
op_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
op_star
(paren
id|__le32
op_star
)paren
id|prd
op_assign
id|cpu_to_le32
c_func
(paren
id|len
)paren
suffix:semicolon
id|prd
op_add_assign
r_sizeof
(paren
id|u64
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;PRD[%u] = (0x%llX, 0x%X)&bslash;n&quot;
comma
id|nelem
comma
(paren
r_int
r_int
r_int
)paren
id|addr
comma
id|len
)paren
suffix:semicolon
)brace
)brace
DECL|function|qs_qc_prep
r_static
r_void
id|qs_qc_prep
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|qs_port_priv
op_star
id|pp
op_assign
id|qc-&gt;ap-&gt;private_data
suffix:semicolon
id|u8
id|dflags
op_assign
id|QS_DF_PORD
comma
op_star
id|buf
op_assign
id|pp-&gt;pkt
suffix:semicolon
id|u8
id|hflags
op_assign
id|QS_HF_DAT
op_or
id|QS_HF_IEN
op_or
id|QS_HF_VLD
suffix:semicolon
id|u64
id|addr
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|qs_enter_reg_mode
c_func
(paren
id|qc-&gt;ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qc-&gt;tf.protocol
op_ne
id|ATA_PROT_DMA
)paren
(brace
id|ata_qc_prep
c_func
(paren
id|qc
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|qs_fill_sg
c_func
(paren
id|qc
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|qc-&gt;tf.flags
op_amp
id|ATA_TFLAG_WRITE
)paren
)paren
id|hflags
op_or_assign
id|QS_HF_DIRO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|qc-&gt;tf.flags
op_amp
id|ATA_TFLAG_LBA48
)paren
)paren
id|dflags
op_or_assign
id|QS_DF_ELBA
suffix:semicolon
multiline_comment|/* host control block (HCB) */
id|buf
(braket
l_int|0
)braket
op_assign
id|QS_HCB_HDR
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|hflags
suffix:semicolon
op_star
(paren
id|__le32
op_star
)paren
(paren
op_amp
id|buf
(braket
l_int|4
)braket
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|qc-&gt;nsect
op_star
id|ATA_SECT_SIZE
)paren
suffix:semicolon
op_star
(paren
id|__le32
op_star
)paren
(paren
op_amp
id|buf
(braket
l_int|8
)braket
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|qc-&gt;n_elem
)paren
suffix:semicolon
id|addr
op_assign
(paren
(paren
id|u64
)paren
id|pp-&gt;pkt_dma
)paren
op_plus
id|QS_CPB_BYTES
suffix:semicolon
op_star
(paren
id|__le64
op_star
)paren
(paren
op_amp
id|buf
(braket
l_int|16
)braket
)paren
op_assign
id|cpu_to_le64
c_func
(paren
id|addr
)paren
suffix:semicolon
multiline_comment|/* device control block (DCB) */
id|buf
(braket
l_int|24
)braket
op_assign
id|QS_DCB_HDR
suffix:semicolon
id|buf
(braket
l_int|28
)braket
op_assign
id|dflags
suffix:semicolon
multiline_comment|/* frame information structure (FIS) */
id|ata_tf_to_fis
c_func
(paren
op_amp
id|qc-&gt;tf
comma
op_amp
id|buf
(braket
l_int|32
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|qs_packet_start
r_static
r_inline
r_void
id|qs_packet_start
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
id|u8
id|__iomem
op_star
id|chan
op_assign
id|ap-&gt;host_set-&gt;mmio_base
op_plus
(paren
id|ap-&gt;port_no
op_star
l_int|0x4000
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER, ap %p&bslash;n&quot;
comma
id|ap
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|QS_CTR0_CLER
comma
id|chan
op_plus
id|QS_CCT_CTR0
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* flush PRDs and pkt to memory */
id|writel
c_func
(paren
id|QS_CCF_RUN_PKT
comma
id|chan
op_plus
id|QS_CCT_CFF
)paren
suffix:semicolon
id|readl
c_func
(paren
id|chan
op_plus
id|QS_CCT_CFF
)paren
suffix:semicolon
multiline_comment|/* flush */
)brace
DECL|function|qs_qc_issue
r_static
r_int
id|qs_qc_issue
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|qs_port_priv
op_star
id|pp
op_assign
id|qc-&gt;ap-&gt;private_data
suffix:semicolon
r_switch
c_cond
(paren
id|qc-&gt;tf.protocol
)paren
(brace
r_case
id|ATA_PROT_DMA
suffix:colon
id|pp-&gt;state
op_assign
id|qs_state_pkt
suffix:semicolon
id|qs_packet_start
c_func
(paren
id|qc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ATA_PROT_ATAPI_DMA
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|pp-&gt;state
op_assign
id|qs_state_mmio
suffix:semicolon
r_return
id|ata_qc_issue_prot
c_func
(paren
id|qc
)paren
suffix:semicolon
)brace
DECL|function|qs_intr_pkt
r_static
r_inline
r_int
r_int
id|qs_intr_pkt
c_func
(paren
r_struct
id|ata_host_set
op_star
id|host_set
)paren
(brace
r_int
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
id|u8
id|sFFE
suffix:semicolon
id|u8
id|__iomem
op_star
id|mmio_base
op_assign
id|host_set-&gt;mmio_base
suffix:semicolon
r_do
(brace
id|u32
id|sff0
op_assign
id|readl
c_func
(paren
id|mmio_base
op_plus
id|QS_HST_SFF
)paren
suffix:semicolon
id|u32
id|sff1
op_assign
id|readl
c_func
(paren
id|mmio_base
op_plus
id|QS_HST_SFF
op_plus
l_int|4
)paren
suffix:semicolon
id|u8
id|sEVLD
op_assign
(paren
id|sff1
op_rshift
l_int|30
)paren
op_amp
l_int|0x01
suffix:semicolon
multiline_comment|/* valid flag */
id|sFFE
op_assign
id|sff1
op_rshift
l_int|31
suffix:semicolon
multiline_comment|/* empty flag */
r_if
c_cond
(paren
id|sEVLD
)paren
(brace
id|u8
id|sDST
op_assign
id|sff0
op_rshift
l_int|16
suffix:semicolon
multiline_comment|/* dev status */
id|u8
id|sHST
op_assign
id|sff1
op_amp
l_int|0x3f
suffix:semicolon
multiline_comment|/* host status */
r_int
r_int
id|port_no
op_assign
(paren
id|sff1
op_rshift
l_int|8
)paren
op_amp
l_int|0x03
suffix:semicolon
r_struct
id|ata_port
op_star
id|ap
op_assign
id|host_set-&gt;ports
(braket
id|port_no
)braket
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;SFF=%08x%08x: sCHAN=%u sHST=%d sDST=%02x&bslash;n&quot;
comma
id|sff1
comma
id|sff0
comma
id|port_no
comma
id|sHST
comma
id|sDST
)paren
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ap
op_logical_and
(paren
op_logical_neg
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
)paren
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
r_struct
id|qs_port_priv
op_star
id|pp
op_assign
id|ap-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pp
op_logical_or
id|pp-&gt;state
op_ne
id|qs_state_pkt
)paren
r_continue
suffix:semicolon
id|qc
op_assign
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|ap-&gt;active_tag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qc
op_logical_and
(paren
op_logical_neg
(paren
id|qc-&gt;tf.ctl
op_amp
id|ATA_NIEN
)paren
)paren
)paren
(brace
r_switch
c_cond
(paren
id|sHST
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* sucessful CPB */
r_case
l_int|3
suffix:colon
multiline_comment|/* device error */
id|pp-&gt;state
op_assign
id|qs_state_idle
suffix:semicolon
id|qs_enter_reg_mode
c_func
(paren
id|qc-&gt;ap
)paren
suffix:semicolon
id|ata_qc_complete
c_func
(paren
id|qc
comma
id|sDST
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|sFFE
)paren
suffix:semicolon
r_return
id|handled
suffix:semicolon
)brace
DECL|function|qs_intr_mmio
r_static
r_inline
r_int
r_int
id|qs_intr_mmio
c_func
(paren
r_struct
id|ata_host_set
op_star
id|host_set
)paren
(brace
r_int
r_int
id|handled
op_assign
l_int|0
comma
id|port_no
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
l_int|0
suffix:semicolon
id|port_no
OL
id|host_set-&gt;n_ports
suffix:semicolon
op_increment
id|port_no
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
suffix:semicolon
id|ap
op_assign
id|host_set-&gt;ports
(braket
id|port_no
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ap
op_logical_and
(paren
op_logical_neg
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
)paren
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
r_struct
id|qs_port_priv
op_star
id|pp
op_assign
id|ap-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pp
op_logical_or
id|pp-&gt;state
op_ne
id|qs_state_mmio
)paren
r_continue
suffix:semicolon
id|qc
op_assign
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|ap-&gt;active_tag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qc
op_logical_and
(paren
op_logical_neg
(paren
id|qc-&gt;tf.ctl
op_amp
id|ATA_NIEN
)paren
)paren
)paren
(brace
multiline_comment|/* check main status, clearing INTRQ */
id|u8
id|status
op_assign
id|ata_chk_status
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|ATA_BUSY
)paren
)paren
r_continue
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ata%u: protocol %d (dev_stat 0x%X)&bslash;n&quot;
comma
id|ap-&gt;id
comma
id|qc-&gt;tf.protocol
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* complete taskfile transaction */
id|pp-&gt;state
op_assign
id|qs_state_idle
suffix:semicolon
id|ata_qc_complete
c_func
(paren
id|qc
comma
id|status
)paren
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_return
id|handled
suffix:semicolon
)brace
DECL|function|qs_intr
r_static
id|irqreturn_t
id|qs_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ata_host_set
op_star
id|host_set
op_assign
id|dev_instance
suffix:semicolon
r_int
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|host_set-&gt;lock
)paren
suffix:semicolon
id|handled
op_assign
id|qs_intr_pkt
c_func
(paren
id|host_set
)paren
op_or
id|qs_intr_mmio
c_func
(paren
id|host_set
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|host_set-&gt;lock
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
DECL|function|qs_ata_setup_port
r_static
r_void
id|qs_ata_setup_port
c_func
(paren
r_struct
id|ata_ioports
op_star
id|port
comma
r_int
r_int
id|base
)paren
(brace
id|port-&gt;cmd_addr
op_assign
id|port-&gt;data_addr
op_assign
id|base
op_plus
l_int|0x400
suffix:semicolon
id|port-&gt;error_addr
op_assign
id|port-&gt;feature_addr
op_assign
id|base
op_plus
l_int|0x408
suffix:semicolon
multiline_comment|/* hob_feature = 0x409 */
id|port-&gt;nsect_addr
op_assign
id|base
op_plus
l_int|0x410
suffix:semicolon
multiline_comment|/* hob_nsect   = 0x411 */
id|port-&gt;lbal_addr
op_assign
id|base
op_plus
l_int|0x418
suffix:semicolon
multiline_comment|/* hob_lbal    = 0x419 */
id|port-&gt;lbam_addr
op_assign
id|base
op_plus
l_int|0x420
suffix:semicolon
multiline_comment|/* hob_lbam    = 0x421 */
id|port-&gt;lbah_addr
op_assign
id|base
op_plus
l_int|0x428
suffix:semicolon
multiline_comment|/* hob_lbah    = 0x429 */
id|port-&gt;device_addr
op_assign
id|base
op_plus
l_int|0x430
suffix:semicolon
id|port-&gt;status_addr
op_assign
id|port-&gt;command_addr
op_assign
id|base
op_plus
l_int|0x438
suffix:semicolon
id|port-&gt;altstatus_addr
op_assign
id|port-&gt;ctl_addr
op_assign
id|base
op_plus
l_int|0x440
suffix:semicolon
id|port-&gt;scr_addr
op_assign
id|base
op_plus
l_int|0xc00
suffix:semicolon
)brace
DECL|function|qs_port_start
r_static
r_int
id|qs_port_start
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|ap-&gt;host_set-&gt;dev
suffix:semicolon
r_struct
id|qs_port_priv
op_star
id|pp
suffix:semicolon
r_void
id|__iomem
op_star
id|mmio_base
op_assign
id|ap-&gt;host_set-&gt;mmio_base
suffix:semicolon
r_void
id|__iomem
op_star
id|chan
op_assign
id|mmio_base
op_plus
(paren
id|ap-&gt;port_no
op_star
l_int|0x4000
)paren
suffix:semicolon
id|u64
id|addr
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|ata_port_start
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|qs_enter_reg_mode
c_func
(paren
id|ap
)paren
suffix:semicolon
id|pp
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|pp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pp
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|pp-&gt;pkt
op_assign
id|dma_alloc_coherent
c_func
(paren
id|dev
comma
id|QS_PKT_BYTES
comma
op_amp
id|pp-&gt;pkt_dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pp-&gt;pkt
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_kfree
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pp-&gt;pkt
comma
l_int|0
comma
id|QS_PKT_BYTES
)paren
suffix:semicolon
id|ap-&gt;private_data
op_assign
id|pp
suffix:semicolon
id|addr
op_assign
(paren
id|u64
)paren
id|pp-&gt;pkt_dma
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
id|addr
comma
id|chan
op_plus
id|QS_CCF_CPBA
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
(paren
id|addr
op_rshift
l_int|32
)paren
comma
id|chan
op_plus
id|QS_CCF_CPBA
op_plus
l_int|4
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_kfree
suffix:colon
id|kfree
c_func
(paren
id|pp
)paren
suffix:semicolon
id|err_out
suffix:colon
id|ata_port_stop
c_func
(paren
id|ap
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|qs_port_stop
r_static
r_void
id|qs_port_stop
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|ap-&gt;host_set-&gt;dev
suffix:semicolon
r_struct
id|qs_port_priv
op_star
id|pp
op_assign
id|ap-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|pp
op_ne
l_int|NULL
)paren
(brace
id|ap-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pp-&gt;pkt
op_ne
l_int|NULL
)paren
id|dma_free_coherent
c_func
(paren
id|dev
comma
id|QS_PKT_BYTES
comma
id|pp-&gt;pkt
comma
id|pp-&gt;pkt_dma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pp
)paren
suffix:semicolon
)brace
id|ata_port_stop
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
DECL|function|qs_host_stop
r_static
r_void
id|qs_host_stop
c_func
(paren
r_struct
id|ata_host_set
op_star
id|host_set
)paren
(brace
r_void
id|__iomem
op_star
id|mmio_base
op_assign
id|host_set-&gt;mmio_base
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|mmio_base
op_plus
id|QS_HCT_CTRL
)paren
suffix:semicolon
multiline_comment|/* disable host interrupts */
id|writeb
c_func
(paren
id|QS_CNFG3_GSRST
comma
id|mmio_base
op_plus
id|QS_HCF_CNFG3
)paren
suffix:semicolon
multiline_comment|/* global reset */
)brace
DECL|function|qs_host_init
r_static
r_void
id|qs_host_init
c_func
(paren
r_int
r_int
id|chip_id
comma
r_struct
id|ata_probe_ent
op_star
id|pe
)paren
(brace
r_void
id|__iomem
op_star
id|mmio_base
op_assign
id|pe-&gt;mmio_base
suffix:semicolon
r_int
r_int
id|port_no
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|mmio_base
op_plus
id|QS_HCT_CTRL
)paren
suffix:semicolon
multiline_comment|/* disable host interrupts */
id|writeb
c_func
(paren
id|QS_CNFG3_GSRST
comma
id|mmio_base
op_plus
id|QS_HCF_CNFG3
)paren
suffix:semicolon
multiline_comment|/* global reset */
multiline_comment|/* reset each channel in turn */
r_for
c_loop
(paren
id|port_no
op_assign
l_int|0
suffix:semicolon
id|port_no
OL
id|pe-&gt;n_ports
suffix:semicolon
op_increment
id|port_no
)paren
(brace
id|u8
id|__iomem
op_star
id|chan
op_assign
id|mmio_base
op_plus
(paren
id|port_no
op_star
l_int|0x4000
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|QS_CTR1_RDEV
op_or
id|QS_CTR1_RCHN
comma
id|chan
op_plus
id|QS_CCT_CTR1
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|QS_CTR0_REG
comma
id|chan
op_plus
id|QS_CCT_CTR0
)paren
suffix:semicolon
id|readb
c_func
(paren
id|chan
op_plus
id|QS_CCT_CTR0
)paren
suffix:semicolon
multiline_comment|/* flush */
)brace
id|writeb
c_func
(paren
id|QS_SERD3_PHY_ENA
comma
id|mmio_base
op_plus
id|QS_HVS_SERD3
)paren
suffix:semicolon
multiline_comment|/* enable phy */
r_for
c_loop
(paren
id|port_no
op_assign
l_int|0
suffix:semicolon
id|port_no
OL
id|pe-&gt;n_ports
suffix:semicolon
op_increment
id|port_no
)paren
(brace
id|u8
id|__iomem
op_star
id|chan
op_assign
id|mmio_base
op_plus
(paren
id|port_no
op_star
l_int|0x4000
)paren
suffix:semicolon
multiline_comment|/* set FIFO depths to same settings as Windows driver */
id|writew
c_func
(paren
l_int|32
comma
id|chan
op_plus
id|QS_CFC_HUFT
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|32
comma
id|chan
op_plus
id|QS_CFC_HDFT
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|10
comma
id|chan
op_plus
id|QS_CFC_DUFT
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|8
comma
id|chan
op_plus
id|QS_CFC_DDFT
)paren
suffix:semicolon
multiline_comment|/* set CPB size in bytes, as a power of two */
id|writeb
c_func
(paren
id|QS_CPB_ORDER
comma
id|chan
op_plus
id|QS_CCF_CSEP
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
l_int|1
comma
id|mmio_base
op_plus
id|QS_HCT_CTRL
)paren
suffix:semicolon
multiline_comment|/* enable host interrupts */
)brace
multiline_comment|/*&n; * The QStor understands 64-bit buses, and uses 64-bit fields&n; * for DMA pointers regardless of bus width.  We just have to&n; * make sure our DMA masks are set appropriately for whatever&n; * bridge lies between us and the QStor, and then the DMA mapping&n; * code will ensure we only ever &quot;see&quot; appropriate buffer addresses.&n; * If we&squot;re 32-bit limited somewhere, then our 64-bit fields will&n; * just end up with zeros in the upper 32-bits, without any special&n; * logic required outside of this routine (below).&n; */
DECL|function|qs_set_dma_masks
r_static
r_int
id|qs_set_dma_masks
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_void
id|__iomem
op_star
id|mmio_base
)paren
(brace
id|u32
id|bus_info
op_assign
id|readl
c_func
(paren
id|mmio_base
op_plus
id|QS_HID_HPHY
)paren
suffix:semicolon
r_int
id|rc
comma
id|have_64bit_bus
op_assign
(paren
id|bus_info
op_amp
id|QS_HPHY_64BIT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|have_64bit_bus
op_logical_and
op_logical_neg
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_64BIT_MASK
)paren
)paren
(brace
id|rc
op_assign
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_64BIT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|rc
op_assign
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_32BIT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): 64-bit DMA enable failed&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|rc
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_32BIT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): 32-bit DMA enable failed&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
id|DMA_32BIT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): 32-bit consistent DMA enable failed&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|qs_ata_init_one
r_static
r_int
id|qs_ata_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_static
r_int
id|printed_version
suffix:semicolon
r_struct
id|ata_probe_ent
op_star
id|probe_ent
op_assign
l_int|NULL
suffix:semicolon
r_void
id|__iomem
op_star
id|mmio_base
suffix:semicolon
r_int
r_int
id|board_idx
op_assign
(paren
r_int
r_int
)paren
id|ent-&gt;driver_data
suffix:semicolon
r_int
id|rc
comma
id|port_no
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|printed_version
op_increment
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
id|DRV_NAME
l_string|&quot; version &quot;
id|DRV_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|DRV_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|4
)paren
op_amp
id|IORESOURCE_MEM
)paren
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out_regions
suffix:semicolon
)brace
id|mmio_base
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|4
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|4
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mmio_base
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_regions
suffix:semicolon
)brace
id|rc
op_assign
id|qs_set_dma_masks
c_func
(paren
id|pdev
comma
id|mmio_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out_iounmap
suffix:semicolon
id|probe_ent
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|probe_ent
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|probe_ent
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_iounmap
suffix:semicolon
)brace
id|memset
c_func
(paren
id|probe_ent
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|probe_ent
)paren
)paren
suffix:semicolon
id|probe_ent-&gt;dev
op_assign
id|pci_dev_to_dev
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|probe_ent-&gt;node
)paren
suffix:semicolon
id|probe_ent-&gt;sht
op_assign
id|qs_port_info
(braket
id|board_idx
)braket
dot
id|sht
suffix:semicolon
id|probe_ent-&gt;host_flags
op_assign
id|qs_port_info
(braket
id|board_idx
)braket
dot
id|host_flags
suffix:semicolon
id|probe_ent-&gt;pio_mask
op_assign
id|qs_port_info
(braket
id|board_idx
)braket
dot
id|pio_mask
suffix:semicolon
id|probe_ent-&gt;mwdma_mask
op_assign
id|qs_port_info
(braket
id|board_idx
)braket
dot
id|mwdma_mask
suffix:semicolon
id|probe_ent-&gt;udma_mask
op_assign
id|qs_port_info
(braket
id|board_idx
)braket
dot
id|udma_mask
suffix:semicolon
id|probe_ent-&gt;port_ops
op_assign
id|qs_port_info
(braket
id|board_idx
)braket
dot
id|port_ops
suffix:semicolon
id|probe_ent-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|probe_ent-&gt;irq_flags
op_assign
id|SA_SHIRQ
suffix:semicolon
id|probe_ent-&gt;mmio_base
op_assign
id|mmio_base
suffix:semicolon
id|probe_ent-&gt;n_ports
op_assign
id|QS_PORTS
suffix:semicolon
r_for
c_loop
(paren
id|port_no
op_assign
l_int|0
suffix:semicolon
id|port_no
OL
id|probe_ent-&gt;n_ports
suffix:semicolon
op_increment
id|port_no
)paren
(brace
r_int
r_int
id|chan
op_assign
(paren
r_int
r_int
)paren
id|mmio_base
op_plus
(paren
id|port_no
op_star
l_int|0x4000
)paren
suffix:semicolon
id|qs_ata_setup_port
c_func
(paren
op_amp
id|probe_ent-&gt;port
(braket
id|port_no
)braket
comma
id|chan
)paren
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* initialize adapter */
id|qs_host_init
c_func
(paren
id|board_idx
comma
id|probe_ent
)paren
suffix:semicolon
id|rc
op_assign
id|ata_device_add
c_func
(paren
id|probe_ent
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|probe_ent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|QS_PORTS
)paren
r_goto
id|err_out_iounmap
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_iounmap
suffix:colon
id|iounmap
c_func
(paren
id|mmio_base
)paren
suffix:semicolon
id|err_out_regions
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|qs_ata_init
r_static
r_int
id|__init
id|qs_ata_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|qs_ata_pci_driver
)paren
suffix:semicolon
)brace
DECL|function|qs_ata_exit
r_static
r_void
id|__exit
id|qs_ata_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|qs_ata_pci_driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Mark Lord&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Pacific Digital Corporation QStor SATA low-level driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|qs_ata_pci_tbl
)paren
suffix:semicolon
DECL|variable|DRV_VERSION
id|MODULE_VERSION
c_func
(paren
id|DRV_VERSION
)paren
suffix:semicolon
DECL|variable|qs_ata_init
id|module_init
c_func
(paren
id|qs_ata_init
)paren
suffix:semicolon
DECL|variable|qs_ata_exit
id|module_exit
c_func
(paren
id|qs_ata_exit
)paren
suffix:semicolon
eof
