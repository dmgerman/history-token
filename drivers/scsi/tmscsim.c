multiline_comment|/************************************************************************&n; *&t;FILE NAME : TMSCSIM.C&t;&t;&t;&t;&t;&t;*&n; *&t;     BY   : C.L. Huang,  ching@tekram.com.tw&t;&t;&t;*&n; *&t;Description: Device Driver for Tekram DC-390(T) PCI SCSI&t;*&n; *&t;&t;     Bus Master Host Adapter&t;&t;&t;&t;*&n; * (C)Copyright 1995-1996 Tekram Technology Co., Ltd.&t;&t;&t;*&n; ************************************************************************&n; * (C) Copyright: put under GNU GPL in 10/96&t;&t;&t;&t;*&n; *&t;&t;&t;&t;(see Documentation/scsi/tmscsim.txt)&t;*&n; ************************************************************************&n; * $Id: tmscsim.c,v 2.60.2.30 2000/12/20 01:07:12 garloff Exp $&t;&t;*&n; *&t;Enhancements and bugfixes by&t;&t;&t;&t;&t;*&n; *&t;Kurt Garloff &lt;kurt@garloff.de&gt;&t;&lt;garloff@suse.de&gt;&t;&t;*&n; ************************************************************************&n; *&t;HISTORY:&t;&t;&t;&t;&t;&t;&t;*&n; *&t;&t;&t;&t;&t;&t;&t;&t;&t;*&n; *&t;REV#&t;DATE&t;NAME&t;DESCRIPTION&t;&t;&t;&t;*&n; *&t;1.00  96/04/24&t;CLH&t;First release&t;&t;&t;&t;*&n; *&t;1.01  96/06/12&t;CLH&t;Fixed bug of Media Change for Removable *&n; *&t;&t;&t;&t;Device, scan all LUN. Support Pre2.0.10 *&n; *&t;1.02  96/06/18&t;CLH&t;Fixed bug of Command timeout ...&t;*&n; *&t;1.03  96/09/25&t;KG&t;Added tmscsim_proc_info()&t;&t;*&n; *&t;1.04  96/10/11&t;CLH&t;Updating for support KV 2.0.x&t;&t;*&n; *&t;1.05  96/10/18&t;KG&t;Fixed bug in DC390_abort(null ptr deref)*&n; *&t;1.06  96/10/25&t;KG&t;Fixed module support&t;&t;&t;*&n; *&t;1.07  96/11/09&t;KG&t;Fixed tmscsim_proc_info()&t;&t;*&n; *&t;1.08  96/11/18&t;KG&t;Fixed null ptr in DC390_Disconnect()&t;*&n; *&t;1.09  96/11/30&t;KG&t;Added register the allocated IO space&t;*&n; *&t;1.10  96/12/05&t;CLH&t;Modified tmscsim_proc_info(), and reset *&n; *&t;&t;&t;&t;pending interrupt in DC390_detect()&t;*&n; *&t;1.11  97/02/05&t;KG/CLH&t;Fixeds problem with partitions greater&t;*&n; *&t;&t;&t;&t;than 1GB&t;&t;&t;&t;*&n; *&t;1.12  98/02/15  MJ      Rewritten PCI probing&t;&t;&t;*&n; *&t;1.13  98/04/08&t;KG&t;Support for non DC390, __initfunc decls,*&n; *&t;&t;&t;&t;changed max devs from 10 to 16&t;&t;*&n; *&t;1.14a 98/05/05&t;KG&t;Dynamic DCB allocation, add-single-dev&t;*&n; *&t;&t;&t;&t;for LUNs if LUN_SCAN (BIOS) not set&t;*&n; *&t;&t;&t;&t;runtime config using /proc interface&t;*&n; *&t;1.14b 98/05/06&t;KG&t;eliminated cli (); sti (); spinlocks&t;*&n; *&t;1.14c 98/05/07&t;KG&t;2.0.x compatibility&t;&t;&t;*&n; *&t;1.20a 98/05/07&t;KG&t;changed names of funcs to be consistent *&n; *&t;&t;&t;&t;DC390_ (entry points), dc390_ (internal)*&n; *&t;&t;&t;&t;reworked locking&t;&t;&t;*&n; *&t;1.20b 98/05/12&t;KG&t;bugs: version, kfree, _ctmp&t;&t;*&n; *&t;&t;&t;&t;debug output&t;&t;&t;&t;*&n; *&t;1.20c 98/05/12&t;KG&t;bugs: kfree, parsing, EEpromDefaults&t;*&n; *&t;1.20d 98/05/14&t;KG&t;bugs: list linkage, clear flag after  &t;*&n; *&t;&t;&t;&t;reset on startup, code cleanup&t;&t;*&n; *&t;1.20e 98/05/15&t;KG&t;spinlock comments, name space cleanup&t;*&n; *&t;&t;&t;&t;pLastDCB now part of ACB structure&t;*&n; *&t;&t;&t;&t;added stats, timeout for 2.1, TagQ bug&t;*&n; *&t;&t;&t;&t;RESET and INQUIRY interface commands&t;*&n; *&t;1.20f 98/05/18&t;KG&t;spinlocks fixes, max_lun fix, free DCBs&t;*&n; *&t;&t;&t;&t;for missing LUNs, pending int&t;&t;*&n; *&t;1.20g 98/05/19&t;KG&t;Clean up: Avoid short&t;&t;&t;*&n; *&t;1.20h 98/05/21&t;KG&t;Remove AdaptSCSIID, max_lun ...&t;&t;*&n; *&t;1.20i 98/05/21&t;KG&t;Aiiie: Bug with TagQMask       &t;&t;*&n; *&t;1.20j 98/05/24&t;KG&t;Handle STAT_BUSY, handle pACB-&gt;pLinkDCB&t;*&n; *&t;&t;&t;&t;== 0 in remove_dev and DoingSRB_Done&t;*&n; *&t;1.20k 98/05/25&t;KG&t;DMA_INT&t;(experimental)&t;       &t;&t;*&n; *&t;1.20l 98/05/27&t;KG&t;remove DMA_INT; DMA_IDLE cmds added;&t;*&n; *&t;1.20m 98/06/10&t;KG&t;glitch configurable; made some global&t;*&n; *&t;&t;&t;&t;vars part of ACB; use DC390_readX&t;*&n; *&t;1.20n 98/06/11&t;KG&t;startup params&t;&t;&t;&t;*&n; *&t;1.20o 98/06/15&t;KG&t;added TagMaxNum to boot/module params&t;*&n; *&t;&t;&t;&t;Device Nr -&gt; Idx, TagMaxNum power of 2  *&n; *&t;1.20p 98/06/17&t;KG&t;Docu updates. Reset depends on settings *&n; *&t;&t;&t;&t;pci_set_master added; 2.0.xx: pcibios_*&t;*&n; *&t;&t;&t;&t;used instead of MechNum things ...&t;*&n; *&t;1.20q 98/06/23&t;KG&t;Changed defaults. Added debug code for&t;*&n; *&t;&t;&t;&t;removable media and fixed it. TagMaxNum&t;*&n; *&t;&t;&t;&t;fixed for DC390. Locking: ACB, DRV for&t;*&n; *&t;&t;&t;&t;better IRQ sharing. Spelling: Queueing&t;*&n; *&t;&t;&t;&t;Parsing and glitch_cfg changes. Display&t;*&n; *&t;&t;&t;&t;real SyncSpeed value. Made DisConn&t;*&n; *&t;&t;&t;&t;functional (!)&t;&t;&t;&t;*&n; *&t;1.20r 98/06/30&t;KG&t;Debug macros, allow disabling DsCn, set&t;*&n; *&t;&t;&t;&t;BIT4 in CtrlR4, EN_PAGE_INT, 2.0 module&t;*&n; *&t;&t;&t;&t;param -1 fixed.&t;&t;&t;&t;*&n; *&t;1.20s 98/08/20&t;KG&t;Debug info on abort(), try to check PCI,*&n; *&t;&t;&t;&t;phys_to_bus instead of phys_to_virt,&t;*&n; *&t;&t;&t;&t;fixed sel. process, fixed locking,&t;*&n; *&t;&t;&t;&t;added MODULE_XXX infos, changed IRQ&t;*&n; *&t;&t;&t;&t;request flags, disable DMA_INT&t;&t;*&n; *&t;1.20t 98/09/07&t;KG&t;TagQ report fixed; Write Erase DMA Stat;*&n; *&t;&t;&t;&t;initfunc -&gt; __init; better abort;&t;*&n; *&t;&t;&t;&t;Timeout for XFER_DONE &amp; BLAST_COMPLETE;&t;*&n; *&t;&t;&t;&t;Allow up to 33 commands being processed *&n; *&t;2.0a  98/10/14&t;KG&t;Max Cmnds back to 17. DMA_Stat clearing *&n; *&t;&t;&t;&t;all flags. Clear within while() loops&t;*&n; *&t;&t;&t;&t;in DataIn_0/Out_0. Null ptr in dumpinfo&t;*&n; *&t;&t;&t;&t;for pSRB==0. Better locking during init.*&n; *&t;&t;&t;&t;bios_param() now respects part. table.&t;*&n; *&t;2.0b  98/10/24&t;KG&t;Docu fixes. Timeout Msg in DMA Blast.&t;*&n; *&t;&t;&t;&t;Disallow illegal idx in INQUIRY/REMOVE&t;*&n; *&t;2.0c  98/11/19&t;KG&t;Cleaned up detect/init for SMP boxes, &t;*&n; *&t;&t;&t;&t;Write Erase DMA (1.20t) caused problems&t;*&n; *&t;2.0d  98/12/25&t;KG&t;Christmas release ;-) Message handling  *&n; *&t;&t;&t;&t;completely reworked. Handle target ini-&t;*&n; *&t;&t;&t;&t;tiated SDTR correctly.&t;&t;&t;*&n; *&t;2.0d1 99/01/25&t;KG&t;Try to handle RESTORE_PTR&t;&t;*&n; *&t;2.0d2 99/02/08&t;KG&t;Check for failure of kmalloc, correct &t;*&n; *&t;&t;&t;&t;inclusion of scsicam.h, DelayReset&t;*&n; *&t;2.0d3 99/05/31&t;KG&t;DRIVER_OK -&gt; DID_OK, DID_NO_CONNECT,&t;*&n; *&t;&t;&t;&t;detect Target mode and warn.&t;&t;*&n; *&t;&t;&t;&t;pcmd-&gt;result handling cleaned up.&t;*&n; *&t;2.0d4 99/06/01&t;KG&t;Cleaned selection process. Found bug&t;*&n; *&t;&t;&t;&t;which prevented more than 16 tags. Now:&t;*&n; *&t;&t;&t;&t;24. SDTR cleanup. Cleaner multi-LUN&t;*&n; *&t;&t;&t;&t;handling. Don&squot;t modify ControlRegs/FIFO&t;*&n; *&t;&t;&t;&t;when connected.&t;&t;&t;&t;*&n; *&t;2.0d5 99/06/01&t;KG&t;Clear DevID, Fix INQUIRY after cfg chg.&t;*&n; *&t;2.0d6 99/06/02&t;KG&t;Added ADD special command to allow cfg.&t;*&n; *&t;&t;&t;&t;before detection. Reset SYNC_NEGO_DONE&t;*&n; *&t;&t;&t;&t;after a bus reset.&t;&t;&t;*&n; *&t;2.0d7 99/06/03&t;KG&t;Fixed bugs wrt add,remove commands&t;*&n; *&t;2.0d8 99/06/04&t;KG&t;Removed copying of cmnd into CmdBlock.&t;*&n; *&t;&t;&t;&t;Fixed Oops in _release().&t;&t;*&n; *&t;2.0d9 99/06/06&t;KG&t;Also tag queue INQUIRY, T_U_R, ...&t;*&n; *&t;&t;&t;&t;Allow arb. no. of Tagged Cmnds. Max 32&t;*&n; *&t;2.0d1099/06/20&t;KG&t;TagMaxNo changes now honoured! Queueing *&n; *&t;&t;&t;&t;clearified (renamed ..) TagMask handling*&n; *&t;&t;&t;&t;cleaned.&t;&t;&t;&t;*&n; *&t;2.0d1199/06/28&t;KG&t;cmd-&gt;result now identical to 2.0d2&t;*&n; *&t;2.0d1299/07/04&t;KG&t;Changed order of processing in IRQ&t;*&n; *&t;2.0d1399/07/05&t;KG&t;Don&squot;t update DCB fields if removed&t;*&n; *&t;2.0d1499/07/05&t;KG&t;remove_dev: Move kfree() to the end&t;*&n; *&t;2.0d1599/07/12&t;KG&t;use_new_eh_code: 0, ULONG -&gt; UINT where&t;*&n; *&t;&t;&t;&t;appropriate&t;&t;&t;&t;*&n; *&t;2.0d1699/07/13&t;KG&t;Reenable StartSCSI interrupt, Retry msg&t;*&n; *&t;2.0d1799/07/15&t;KG&t;Remove debug msg. Disable recfg. when&t;*&n; *&t;&t;&t;&t;there are queued cmnds&t;&t;&t;*&n; *&t;2.0d1899/07/18&t;KG&t;Selection timeout: Don&squot;t requeue&t;*&n; *&t;2.0d1999/07/18&t;KG&t;Abort: Only call scsi_done if dequeued&t;*&n; *&t;2.0d2099/07/19&t;KG&t;Rst_Detect: DoingSRB_Done&t;&t;*&n; *&t;2.0d2199/08/15&t;KG&t;dev_id for request/free_irq, cmnd[0] for*&n; *&t;&t;&t;&t;RETRY, SRBdone does DID_ABORT for the &t;*&n; *&t;&t;&t;&t;cmd passed by DC390_reset()&t;&t;*&n; *&t;2.0d2299/08/25&t;KG&t;dev_id fixed. can_queue: 42&t;&t;*&n; *&t;2.0d2399/08/25&t;KG&t;Removed some debugging code. dev_id &t;*&n; *&t;&t;&t;&t;now is set to pACB. Use u8,u16,u32. &t;*&n; *&t;2.0d2499/11/14&t;KG&t;Unreg. I/O if failed IRQ alloc. Call&t;*&n; * &t;&t;&t;&t;done () w/ DID_BAD_TARGET in case of&t;*&n; *&t;&t;&t;&t;missing DCB. We&t;are old EH!!&t;&t;*&n; *&t;2.0d2500/01/15&t;KG&t;2.3.3x compat from Andreas Schultz&t;*&n; *&t;&t;&t;&t;set unique_id. Disable RETRY message.&t;*&n; *&t;2.0d2600/01/29&t;KG&t;Go to new EH.&t;&t;&t;&t;*&n; *&t;2.0d2700/01/31&t;KG&t;... but maintain 2.0 compat.&t;&t;*&n; *&t;&t;&t;&t;and fix DCB freeing&t;&t;&t;*&n; *&t;2.0d2800/02/14&t;KG&t;Queue statistics fixed, dump special cmd*&n; *&t;&t;&t;&t;Waiting_Timer for failed StartSCSI&t;*&n; *&t;&t;&t;&t;New EH: Don&squot;t return cmnds to ML on RST *&n; *&t;&t;&t;&t;Use old EH (don&squot;t have new EH fns yet)&t;*&n; * &t;&t;&t;&t;Reset: Unlock, but refuse to queue&t;*&n; * &t;&t;&t;&t;2.3 __setup function&t;&t;&t;*&n; *&t;2.0e  00/05/22&t;KG&t;Return residual for 2.3&t;&t;&t;*&n; *&t;2.0e1 00/05/25&t;KG&t;Compile fixes for 2.3.99&t;&t;*&n; *&t;2.0e2 00/05/27&t;KG&t;Jeff Garzik&squot;s pci_enable_device()&t;*&n; *&t;2.0e3 00/09/29&t;KG&t;Some 2.4 changes. Don&squot;t try Sync Nego&t;*&n; *&t;&t;&t;&t;before INQUIRY has reported ability. &t;*&n; *&t;&t;&t;&t;Recognise INQUIRY as scanning command.&t;*&n; *&t;2.0e4 00/10/13&t;KG&t;Allow compilation into 2.4 kernel&t;*&n; *&t;2.0e5 00/11/17&t;KG&t;Store Inq.flags in DCB&t;&t;&t;*&n; *&t;2.0e6 00/11/22  KG&t;2.4 init function (Thx to O.Schumann)&t;*&n; * &t;&t;&t;&t;2.4 PCI device table (Thx to A.Richter)&t;*&n; *&t;2.0e7 00/11/28&t;KG&t;Allow overriding of BIOS settings&t;*&n; *&t;2.0f  00/12/20&t;KG&t;Handle failed INQUIRYs during scan&t;*&n; *&t;2.1a  03/11/29  GL, KG&t;Initial fixing for 2.6. Convert to&t;*&n; *&t;&t;&t;&t;use the current PCI-mapping API, update&t;*&n; *&t;&t;&t;&t;command-queuing.&t;&t;&t;*&n; *&t;2.1b  04/04/13  GL&t;Fix for 64-bit platforms&t;&t;*&n; *&t;2.1b1 04/01/31&t;GL&t;(applied 05.04) Remove internal&t;&t;*&n; *&t;&t;&t;&t;command-queuing.&t;&t;&t;*&n; *&t;2.1b2 04/02/01&t;CH&t;(applied 05.04) Fix error-handling&t;*&n; *&t;2.1c  04/05/23  GL&t;Update to use the new pci_driver API,&t;*&n; *&t;&t;&t;&t;some scsi EH updates, more cleanup.&t;*&n; *&t;2.1d  04/05/27&t;GL&t;Moved setting of scan_devices to&t;*&n; *&t;&t;&t;&t;slave_alloc/_configure/_destroy, as&t;*&n; *&t;&t;&t;&t;suggested by CH.&t;&t;&t;*&n; ***********************************************************************/
multiline_comment|/* DEBUG options */
singleline_comment|//#define DC390_DEBUG0
singleline_comment|//#define DC390_DEBUG1
singleline_comment|//#define DC390_DCBDEBUG
singleline_comment|//#define DC390_PARSEDEBUG
singleline_comment|//#define DC390_REMOVABLEDEBUG
singleline_comment|//#define DC390_LOCKDEBUG
singleline_comment|//#define NOP do{}while(0)
DECL|macro|C_NOP
mdefine_line|#define C_NOP
multiline_comment|/* Debug definitions */
macro_line|#ifdef DC390_DEBUG0
DECL|macro|DEBUG0
macro_line|# define DEBUG0(x) x
macro_line|#else
DECL|macro|DEBUG0
macro_line|# define DEBUG0(x) C_NOP
macro_line|#endif
macro_line|#ifdef DC390_DEBUG1
DECL|macro|DEBUG1
macro_line|# define DEBUG1(x) x
macro_line|#else
DECL|macro|DEBUG1
macro_line|# define DEBUG1(x) C_NOP
macro_line|#endif
macro_line|#ifdef DC390_DCBDEBUG
DECL|macro|DCBDEBUG
macro_line|# define DCBDEBUG(x) x
macro_line|#else
DECL|macro|DCBDEBUG
macro_line|# define DCBDEBUG(x) C_NOP
macro_line|#endif
macro_line|#ifdef DC390_PARSEDEBUG
DECL|macro|PARSEDEBUG
macro_line|# define PARSEDEBUG(x) x
macro_line|#else
DECL|macro|PARSEDEBUG
macro_line|# define PARSEDEBUG(x) C_NOP
macro_line|#endif
macro_line|#ifdef DC390_REMOVABLEDEBUG
DECL|macro|REMOVABLEDEBUG
macro_line|# define REMOVABLEDEBUG(x) x
macro_line|#else
DECL|macro|REMOVABLEDEBUG
macro_line|# define REMOVABLEDEBUG(x) C_NOP
macro_line|#endif
DECL|macro|DCBDEBUG1
mdefine_line|#define DCBDEBUG1(x) C_NOP
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_cmnd.h&gt;
macro_line|#include &lt;scsi/scsi_device.h&gt;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsicam.h&gt;
DECL|macro|DC390_BANNER
mdefine_line|#define DC390_BANNER &quot;Tekram DC390/AM53C974&quot;
DECL|macro|DC390_VERSION
mdefine_line|#define DC390_VERSION &quot;2.1d 2004-05-27&quot;
DECL|macro|PCI_DEVICE_ID_AMD53C974
mdefine_line|#define PCI_DEVICE_ID_AMD53C974 &t;PCI_DEVICE_ID_AMD_SCSI
macro_line|#include &quot;tmscsim.h&quot;
r_static
id|u8
id|dc390_StartSCSI
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|dc390_DataOut_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_DataIn_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Command_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Status_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_MsgOut_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_MsgIn_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_DataOutPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_DataInPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_CommandPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_StatusPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_MsgOutPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_MsgInPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Nop_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Nop_1
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_SetXferRate
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
)paren
suffix:semicolon
r_static
r_void
id|dc390_Disconnect
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|dc390_Reselect
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|dc390_SRBdone
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|dc390_DoingSRB_Done
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|dc390_ScsiRstDetect
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|dc390_ResetSCSIBus
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|dc390_EnableMsgOut_Abort
c_func
(paren
r_struct
id|dc390_acb
op_star
comma
r_struct
id|dc390_srb
op_star
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|do_DC390_Interrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|dc390_updateDCB
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
)paren
suffix:semicolon
DECL|variable|dc390_pACB_start
r_static
r_struct
id|dc390_acb
op_star
id|dc390_pACB_start
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|dc390_pACB_current
r_static
r_struct
id|dc390_acb
op_star
id|dc390_pACB_current
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|dc390_laststatus
r_static
id|u32
id|dc390_laststatus
op_assign
l_int|0
suffix:semicolon
DECL|variable|dc390_adapterCnt
r_static
id|u8
id|dc390_adapterCnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Startup values, to be overriden on the commandline */
DECL|variable|tmscsim
r_static
r_int
id|tmscsim
(braket
)braket
op_assign
(brace
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
)brace
suffix:semicolon
DECL|variable|tmscsim_paramnum
r_static
r_int
id|tmscsim_paramnum
op_assign
id|ARRAY_SIZE
c_func
(paren
id|tmscsim
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|tmscsim
comma
r_int
comma
id|tmscsim_paramnum
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|tmscsim
comma
l_string|&quot;Host SCSI ID, Speed (0=10MHz), Device Flags, Adapter Flags, Max Tags (log2(tags)-1), DelayReset (s)&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;C.L. Huang / Kurt Garloff&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SCSI host adapter driver for Tekram DC390 and other AMD53C974A based PCI SCSI adapters&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;sd,sr,sg,st&quot;
)paren
suffix:semicolon
DECL|variable|dc390_phase0
r_static
r_void
op_star
id|dc390_phase0
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|dc390_phase1
r_static
r_void
op_star
id|dc390_phase1
(braket
)braket
op_assign
initialization_block
suffix:semicolon
macro_line|#ifdef DC390_DEBUG1
DECL|variable|dc390_p0_str
r_static
r_char
op_star
id|dc390_p0_str
(braket
)braket
op_assign
(brace
l_string|&quot;dc390_DataOut_0&quot;
comma
l_string|&quot;dc390_DataIn_0&quot;
comma
l_string|&quot;dc390_Command_0&quot;
comma
l_string|&quot;dc390_Status_0&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_MsgOut_0&quot;
comma
l_string|&quot;dc390_MsgIn_0&quot;
comma
l_string|&quot;dc390_Nop_1&quot;
)brace
suffix:semicolon
DECL|variable|dc390_p1_str
r_static
r_char
op_star
id|dc390_p1_str
(braket
)braket
op_assign
(brace
l_string|&quot;dc390_DataOutPhase&quot;
comma
l_string|&quot;dc390_DataInPhase&quot;
comma
l_string|&quot;dc390_CommandPhase&quot;
comma
l_string|&quot;dc390_StatusPhase&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_MsgOutPhase&quot;
comma
l_string|&quot;dc390_MsgInPhase&quot;
comma
l_string|&quot;dc390_Nop_1&quot;
)brace
suffix:semicolon
macro_line|#endif   
multiline_comment|/* Devices erroneously pretending to be able to do TagQ */
DECL|variable|dc390_baddevname1
r_static
id|u8
id|dc390_baddevname1
(braket
l_int|2
)braket
(braket
l_int|28
)braket
op_assign
initialization_block
suffix:semicolon
DECL|macro|BADDEVCNT
mdefine_line|#define BADDEVCNT&t;2
DECL|variable|dc390_eepromBuf
r_static
id|u8
id|dc390_eepromBuf
(braket
id|MAX_ADAPTER_NUM
)braket
(braket
id|EE_LEN
)braket
suffix:semicolon
DECL|variable|dc390_clock_period1
r_static
id|u8
id|dc390_clock_period1
(braket
)braket
op_assign
(brace
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|10
comma
l_int|13
comma
l_int|20
)brace
suffix:semicolon
DECL|variable|dc390_clock_speed
r_static
id|u8
id|dc390_clock_speed
(braket
)braket
op_assign
(brace
l_int|100
comma
l_int|80
comma
l_int|67
comma
l_int|57
comma
l_int|50
comma
l_int|40
comma
l_int|31
comma
l_int|20
)brace
suffix:semicolon
multiline_comment|/***********************************************************************&n; * Functions for the management of the internal structures &n; * (DCBs, SRBs, Queueing)&n; *&n; **********************************************************************/
DECL|function|dc390_findDCB
r_static
r_struct
id|dc390_dcb
id|__inline__
op_star
id|dc390_findDCB
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
id|u8
id|id
comma
id|u8
id|lun
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|pDCB-&gt;TargetID
op_ne
id|id
op_logical_or
id|pDCB-&gt;TargetLUN
op_ne
id|lun
)paren
(brace
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLinkDCB
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|DCBDEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DCB %p (%02x,%02x) found.&bslash;n&quot;
comma
"&bslash;"
id|pDCB
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
)paren
suffix:semicolon
r_return
id|pDCB
suffix:semicolon
)brace
multiline_comment|/* Queueing philosphy:&n; * There are a couple of lists:&n; * - Query: Contains the Scsi Commands not yet turned into SRBs (per ACB)&n; *   (Note: For new EH, it is unnecessary!)&n; * - Waiting: Contains a list of SRBs not yet sent (per DCB)&n; * - Free: List of free SRB slots&n; * &n; * If there are no waiting commands for the DCB, the new one is sent to the bus&n; * otherwise the oldest one is taken from the Waiting list and the new one is &n; * queued to the Waiting List&n; * &n; * Lists are managed using two pointers and eventually a counter&n; */
multiline_comment|/* Return next free SRB */
DECL|function|dc390_Free_get
r_static
id|__inline__
r_struct
id|dc390_srb
op_star
id|dc390_Free_get
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
(brace
r_struct
id|dc390_srb
op_star
id|pSRB
suffix:semicolon
id|pSRB
op_assign
id|pACB-&gt;pFreeSRB
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Get Free SRB %p&bslash;n&quot;
comma
id|pSRB
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
(brace
id|pACB-&gt;pFreeSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|pSRB
suffix:semicolon
)brace
multiline_comment|/* Insert SRB oin top of free list */
DECL|function|dc390_Free_insert
r_static
id|__inline__
r_void
id|dc390_Free_insert
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Free SRB %p&bslash;n&quot;
comma
id|pSRB
)paren
)paren
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
id|pACB-&gt;pFreeSRB
suffix:semicolon
id|pACB-&gt;pFreeSRB
op_assign
id|pSRB
suffix:semicolon
)brace
multiline_comment|/* Inserts a SRB to the top of the Waiting list */
DECL|function|dc390_Waiting_insert
r_static
id|__inline__
r_void
id|dc390_Waiting_insert
(paren
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Insert pSRB %p cmd %li to Waiting&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
)paren
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB-&gt;pWaitingSRB
)paren
id|pDCB-&gt;pWaitLast
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_increment
suffix:semicolon
)brace
multiline_comment|/* Queue SRB to waiting list */
DECL|function|dc390_Waiting_append
r_static
id|__inline__
r_void
id|dc390_Waiting_append
(paren
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Append pSRB %p cmd %li to Waiting&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|pDCB-&gt;pWaitLast-&gt;pNextSRB
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pWaitLast
op_assign
id|pSRB
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_increment
suffix:semicolon
id|pDCB-&gt;pDCBACB-&gt;CmdInQ
op_increment
suffix:semicolon
)brace
DECL|function|dc390_Going_append
r_static
id|__inline__
r_void
id|dc390_Going_append
(paren
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|pDCB-&gt;GoingSRBCnt
op_increment
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DC390: Append SRB %p to Going&bslash;n&quot;
comma
id|pSRB
)paren
)paren
suffix:semicolon
multiline_comment|/* Append to the list of Going commands */
r_if
c_cond
(paren
id|pDCB-&gt;pGoingSRB
)paren
(brace
id|pDCB-&gt;pGoingLast-&gt;pNextSRB
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
id|pDCB-&gt;pGoingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pGoingLast
op_assign
id|pSRB
suffix:semicolon
multiline_comment|/* No next one in sent list */
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|dc390_Going_remove
r_static
id|__inline__
r_void
id|dc390_Going_remove
(paren
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DC390: Remove SRB %p from Going&bslash;n&quot;
comma
id|pSRB
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pGoingSRB
)paren
id|pDCB-&gt;pGoingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_else
(brace
r_struct
id|dc390_srb
op_star
id|psrb
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
r_while
c_loop
(paren
id|psrb
op_logical_and
id|psrb-&gt;pNextSRB
op_ne
id|pSRB
)paren
id|psrb
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psrb
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Remove non-ex. SRB %p from Going!&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|psrb-&gt;pNextSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pGoingLast
)paren
id|pDCB-&gt;pGoingLast
op_assign
id|psrb
suffix:semicolon
)brace
id|pDCB-&gt;GoingSRBCnt
op_decrement
suffix:semicolon
)brace
multiline_comment|/* Moves SRB from Going list to the top of Waiting list */
DECL|function|dc390_Going_to_Waiting
r_static
r_void
id|dc390_Going_to_Waiting
(paren
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: Going_to_Waiting (SRB %p) pid = %li&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
)paren
suffix:semicolon
multiline_comment|/* Remove SRB from Going */
id|dc390_Going_remove
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/* Insert on top of Waiting */
id|dc390_Waiting_insert
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/* Tag Mask must be freed elsewhere ! (KG, 99/06/18) */
)brace
multiline_comment|/* Moves first SRB from Waiting list to Going list */
DECL|function|dc390_Waiting_to_Going
r_static
id|__inline__
r_void
id|dc390_Waiting_to_Going
(paren
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
multiline_comment|/* Remove from waiting list */
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DC390: Remove SRB %p from head of Waiting&bslash;n&quot;
comma
id|pSRB
)paren
)paren
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|pDCB-&gt;pWaitLast
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pDCB-&gt;WaitSRBCnt
op_decrement
suffix:semicolon
id|dc390_Going_append
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_static
r_void
id|DC390_waiting_timed_out
(paren
r_int
r_int
id|ptr
)paren
suffix:semicolon
multiline_comment|/* Sets the timer to wake us up */
DECL|function|dc390_waiting_timer
r_static
r_void
id|dc390_waiting_timer
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_int
r_int
id|to
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
r_return
suffix:semicolon
id|init_timer
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
id|pACB-&gt;Waiting_Timer.function
op_assign
id|DC390_waiting_timed_out
suffix:semicolon
id|pACB-&gt;Waiting_Timer.data
op_assign
(paren
r_int
r_int
)paren
id|pACB
suffix:semicolon
r_if
c_cond
(paren
id|time_before
(paren
id|jiffies
op_plus
id|to
comma
id|pACB-&gt;pScsiHost-&gt;last_reset
)paren
)paren
id|pACB-&gt;Waiting_Timer.expires
op_assign
id|pACB-&gt;pScsiHost-&gt;last_reset
op_plus
l_int|1
suffix:semicolon
r_else
id|pACB-&gt;Waiting_Timer.expires
op_assign
id|jiffies
op_plus
id|to
op_plus
l_int|1
suffix:semicolon
id|add_timer
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Send the next command from the waiting list to the bus */
DECL|function|dc390_Waiting_process
r_static
r_void
id|dc390_Waiting_process
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|ptr
comma
op_star
id|ptr1
suffix:semicolon
r_struct
id|dc390_srb
op_star
id|pSRB
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pACB-&gt;pActiveDCB
)paren
op_logical_or
(paren
id|pACB-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timer_pending
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
id|del_timer
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
id|ptr
op_assign
id|pACB-&gt;pDCBRunRobin
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
(brace
id|ptr
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
id|ptr
suffix:semicolon
)brace
id|ptr1
op_assign
id|ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr1
)paren
r_return
suffix:semicolon
r_do
(brace
id|pACB-&gt;pDCBRunRobin
op_assign
id|ptr1-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB
op_assign
id|ptr1-&gt;pWaitingSRB
)paren
op_logical_or
(paren
id|ptr1-&gt;MaxCommand
op_le
id|ptr1-&gt;GoingSRBCnt
)paren
)paren
(brace
id|ptr1
op_assign
id|ptr1-&gt;pNextDCB
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Try to send to the bus */
r_if
c_cond
(paren
op_logical_neg
id|dc390_StartSCSI
c_func
(paren
id|pACB
comma
id|ptr1
comma
id|pSRB
)paren
)paren
(brace
id|dc390_Waiting_to_Going
(paren
id|ptr1
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_else
id|dc390_waiting_timer
(paren
id|pACB
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|ptr1
op_ne
id|ptr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Wake up waiting queue */
DECL|function|DC390_waiting_timed_out
r_static
r_void
id|DC390_waiting_timed_out
(paren
r_int
r_int
id|ptr
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|ptr
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Debug: Waiting queue woken up by timer!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|pACB-&gt;pScsiHost-&gt;host_lock
comma
id|iflags
)paren
suffix:semicolon
id|dc390_Waiting_process
(paren
id|pACB
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|pACB-&gt;pScsiHost-&gt;host_lock
comma
id|iflags
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function: static void dc390_SendSRB (struct dc390_acb* pACB, struct dc390_srb* pSRB)&n; *&n; * Purpose: Send SCSI Request Block (pSRB) to adapter (pACB)&n; *&n; ***********************************************************************/
DECL|function|dc390_SendSRB
r_static
r_void
id|dc390_SendSRB
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
suffix:semicolon
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pDCB-&gt;MaxCommand
op_le
id|pDCB-&gt;GoingSRBCnt
)paren
op_logical_or
(paren
id|pACB-&gt;pActiveDCB
)paren
op_logical_or
(paren
id|pACB-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
)paren
(brace
id|dc390_Waiting_append
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_Waiting_process
(paren
id|pACB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|dc390_Waiting_append
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/*&t;pSRB = GetWaitingSRB(pDCB); */
multiline_comment|/* non-existent */
id|pSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
multiline_comment|/* Remove from waiting list */
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB-&gt;pWaitingSRB
)paren
id|pDCB-&gt;pWaitLast
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|dc390_StartSCSI
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
)paren
id|dc390_Going_append
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
r_else
(brace
id|dc390_Waiting_insert
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_waiting_timer
(paren
id|pACB
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
)brace
)brace
DECL|function|dc390_sg_build_single
r_static
r_struct
id|scatterlist
op_star
id|dc390_sg_build_single
c_func
(paren
r_struct
id|scatterlist
op_star
id|sg
comma
r_void
op_star
id|addr
comma
r_int
r_int
id|length
)paren
(brace
id|memset
c_func
(paren
id|sg
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scatterlist
)paren
)paren
suffix:semicolon
id|sg-&gt;page
op_assign
id|virt_to_page
c_func
(paren
id|addr
)paren
suffix:semicolon
id|sg-&gt;length
op_assign
id|length
suffix:semicolon
id|sg-&gt;offset
op_assign
(paren
r_int
r_int
)paren
id|addr
op_amp
op_complement
id|PAGE_MASK
suffix:semicolon
r_return
id|sg
suffix:semicolon
)brace
multiline_comment|/* Create pci mapping */
DECL|function|dc390_pci_map
r_static
r_int
id|dc390_pci_map
(paren
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pSRB-&gt;pSRBDCB-&gt;pDCBACB-&gt;pdev
suffix:semicolon
id|dc390_cmd_scp_t
op_star
id|cmdp
op_assign
(paren
(paren
id|dc390_cmd_scp_t
op_star
)paren
(paren
op_amp
id|pcmd-&gt;SCp
)paren
)paren
suffix:semicolon
multiline_comment|/* Map sense buffer */
r_if
c_cond
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
(brace
id|pSRB-&gt;pSegmentList
op_assign
id|dc390_sg_build_single
c_func
(paren
op_amp
id|pSRB-&gt;Segmentx
comma
id|pcmd-&gt;sense_buffer
comma
r_sizeof
(paren
id|pcmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|pSRB-&gt;SGcount
op_assign
id|pci_map_sg
c_func
(paren
id|pdev
comma
id|pSRB-&gt;pSegmentList
comma
l_int|1
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|cmdp-&gt;saved_dma_handle
op_assign
id|sg_dma_address
c_func
(paren
id|pSRB-&gt;pSegmentList
)paren
suffix:semicolon
multiline_comment|/* TODO: error handling */
r_if
c_cond
(paren
id|pSRB-&gt;SGcount
op_ne
l_int|1
)paren
id|error
op_assign
l_int|1
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Mapped sense buffer %p at %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pcmd-&gt;sense_buffer
comma
id|cmdp-&gt;saved_dma_handle
)paren
)paren
suffix:semicolon
multiline_comment|/* Map SG list */
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
(brace
id|pSRB-&gt;pSegmentList
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
id|pSRB-&gt;SGcount
op_assign
id|pci_map_sg
c_func
(paren
id|pdev
comma
id|pSRB-&gt;pSegmentList
comma
id|pcmd-&gt;use_sg
comma
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
multiline_comment|/* TODO: error handling */
r_if
c_cond
(paren
op_logical_neg
id|pSRB-&gt;SGcount
)paren
id|error
op_assign
l_int|1
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Mapped SG %p with %d (%d) elements&bslash;n&quot;
comma
"&bslash;"
id|__FUNCTION__
comma
id|pcmd-&gt;request_buffer
comma
id|pSRB-&gt;SGcount
comma
id|pcmd-&gt;use_sg
)paren
)paren
suffix:semicolon
multiline_comment|/* Map single segment */
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
op_logical_and
id|pcmd-&gt;request_bufflen
)paren
(brace
id|pSRB-&gt;pSegmentList
op_assign
id|dc390_sg_build_single
c_func
(paren
op_amp
id|pSRB-&gt;Segmentx
comma
id|pcmd-&gt;request_buffer
comma
id|pcmd-&gt;request_bufflen
)paren
suffix:semicolon
id|pSRB-&gt;SGcount
op_assign
id|pci_map_sg
c_func
(paren
id|pdev
comma
id|pSRB-&gt;pSegmentList
comma
l_int|1
comma
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|cmdp-&gt;saved_dma_handle
op_assign
id|sg_dma_address
c_func
(paren
id|pSRB-&gt;pSegmentList
)paren
suffix:semicolon
multiline_comment|/* TODO: error handling */
r_if
c_cond
(paren
id|pSRB-&gt;SGcount
op_ne
l_int|1
)paren
id|error
op_assign
l_int|1
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Mapped request buffer %p at %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pcmd-&gt;request_buffer
comma
id|cmdp-&gt;saved_dma_handle
)paren
)paren
suffix:semicolon
multiline_comment|/* No mapping !? */
)brace
r_else
id|pSRB-&gt;SGcount
op_assign
l_int|0
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Remove pci mapping */
DECL|function|dc390_pci_unmap
r_static
r_void
id|dc390_pci_unmap
(paren
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pSRB-&gt;pSRBDCB-&gt;pDCBACB-&gt;pdev
suffix:semicolon
id|DEBUG1
c_func
(paren
id|dc390_cmd_scp_t
op_star
id|cmdp
op_assign
(paren
(paren
id|dc390_cmd_scp_t
op_star
)paren
(paren
op_amp
id|pcmd-&gt;SCp
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SRBFlag
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|pdev
comma
op_amp
id|pSRB-&gt;Segmentx
comma
l_int|1
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Unmapped sense buffer at %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cmdp-&gt;saved_dma_handle
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|pdev
comma
id|pcmd-&gt;request_buffer
comma
id|pcmd-&gt;use_sg
comma
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Unmapped SG at %p with %d elements&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pcmd-&gt;request_buffer
comma
id|pcmd-&gt;use_sg
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
op_logical_and
id|pcmd-&gt;request_bufflen
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|pdev
comma
op_amp
id|pSRB-&gt;Segmentx
comma
l_int|1
comma
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Unmapped request buffer at %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cmdp-&gt;saved_dma_handle
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/***********************************************************************&n; * Function: static void dc390_BuildSRB (Scsi_Cmd *pcmd, struct dc390_dcb* pDCB, &n; * &t;&t;&t;&t;&t; struct dc390_srb* pSRB)&n; *&n; * Purpose: Prepare SRB for being sent to Device DCB w/ command *pcmd&n; *&n; ***********************************************************************/
DECL|function|dc390_BuildSRB
r_static
r_void
id|dc390_BuildSRB
(paren
r_struct
id|scsi_cmnd
op_star
id|pcmd
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|pSRB-&gt;pSRBDCB
op_assign
id|pDCB
suffix:semicolon
id|pSRB-&gt;pcmd
op_assign
id|pcmd
suffix:semicolon
id|pSRB-&gt;SGIndex
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevType
op_ne
id|TYPE_TAPE
)paren
(brace
id|pSRB-&gt;RetryCnt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|pSRB-&gt;RetryCnt
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBFlag
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;EndMessage
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TagNumber
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* KG: deferred PCI mapping to dc390_StartSCSI */
)brace
multiline_comment|/***********************************************************************&n; * Function : static int DC390_queue_command (struct scsi_cmnd *cmd,&n; *&t;&t;&t;&t;&t;       void (*done)(struct scsi_cmnd *))&n; *&n; * Purpose : enqueues a SCSI command&n; *&n; * Inputs : cmd - SCSI command, done - callback function called on &n; *&t;    completion, with a pointer to the command descriptor.&n; *&n; * Returns : (depending on kernel version)&n; * 2.0.x: always return 0&n; * 2.1.x: old model: (use_new_eh_code == 0): like 2.0.x&n; *&t;  TO BE DONE:&n; *&t;  new model: return 0 if successful, or must not be re-queued&n; *&t;&t;     return 1 if command cannot be queued (queue full)&n; *&t;&t;     command will be inserted in midlevel queue then ...&n; *&n; ***********************************************************************/
DECL|function|DC390_queue_command
r_static
r_int
id|DC390_queue_command
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
op_assign
(paren
r_struct
id|dc390_dcb
op_star
)paren
id|cmd-&gt;device-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_srb
op_star
id|pSRB
suffix:semicolon
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|pACB-&gt;Cmds
op_increment
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|cmd-&gt;result
op_assign
l_int|0
suffix:semicolon
id|pSRB
op_assign
id|dc390_Free_get
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
r_goto
id|requeue
suffix:semicolon
id|dc390_BuildSRB
c_func
(paren
id|cmd
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|dc390_Waiting_append
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
id|dc390_SendSRB
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; ... command (pid %li) queued successfully.&bslash;n&quot;
comma
id|cmd-&gt;pid
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|requeue
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|dc390_dumpinfo
r_static
r_void
id|dc390_dumpinfo
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
id|u16
id|pstat
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
op_logical_and
id|pDCB
)paren
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: SRB: Xferred %08lx, Remain %08lx, State %08x, Phase %02x&bslash;n&quot;
comma
id|pSRB-&gt;TotalXferredLen
comma
id|pSRB-&gt;SGToBeXferLen
comma
id|pSRB-&gt;SRBState
comma
id|pSRB-&gt;ScsiPhase
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: AdpaterStatus: %02x, SRB Status %02x&bslash;n&quot;
comma
id|pSRB-&gt;AdaptStatus
comma
id|pSRB-&gt;SRBStatus
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;DC390: Status of last IRQ (DMA/SC/Int/IRQ): %08x&bslash;n&quot;
comma
id|dc390_laststatus
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Register dump: SCSI block:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: XferCnt  Cmd Stat IntS IRQS FFIS Ctl1 Ctl2 Ctl3 Ctl4&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390:  %06x   %02x   %02x   %02x&quot;
comma
id|DC390_read8
c_func
(paren
id|CtcReg_Low
)paren
op_plus
(paren
id|DC390_read8
c_func
(paren
id|CtcReg_Mid
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|DC390_read8
c_func
(paren
id|CtcReg_High
)paren
op_lshift
l_int|16
)paren
comma
id|DC390_read8
c_func
(paren
id|ScsiCmd
)paren
comma
id|DC390_read8
c_func
(paren
id|Scsi_Status
)paren
comma
id|DC390_read8
c_func
(paren
id|Intern_State
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;   %02x   %02x   %02x   %02x   %02x   %02x&bslash;n&quot;
comma
id|DC390_read8
c_func
(paren
id|INT_Status
)paren
comma
id|DC390_read8
c_func
(paren
id|Current_Fifo
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg1
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg2
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg3
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg4
)paren
)paren
suffix:semicolon
id|DC390_write32
(paren
id|DMA_ScsiBusCtrl
comma
id|WRT_ERASE_DMA_STAT
op_or
id|EN_INT_ON_PCI_ABORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DC390_read8
c_func
(paren
id|Current_Fifo
)paren
op_amp
l_int|0x1f
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: FIFO:&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|DC390_read8
c_func
(paren
id|Current_Fifo
)paren
op_amp
l_int|0x1f
)paren
id|printk
(paren
l_string|&quot; %02x&quot;
comma
id|DC390_read8
c_func
(paren
id|ScsiFifo
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;DC390: Register dump: DMA engine:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Cmd   STrCnt    SBusA    WrkBC    WrkAC Stat SBusCtrl&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390:  %02x %08x %08x %08x %08x   %02x %08x&bslash;n&quot;
comma
id|DC390_read8
c_func
(paren
id|DMA_Cmd
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_XferCnt
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_XferAddr
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_Wk_ByteCntr
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_Wk_AddrCntr
)paren
comma
id|DC390_read8
c_func
(paren
id|DMA_Status
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_ScsiBusCtrl
)paren
)paren
suffix:semicolon
id|DC390_write32
(paren
id|DMA_ScsiBusCtrl
comma
id|EN_INT_ON_PCI_ABORT
)paren
suffix:semicolon
id|pdev
op_assign
id|pACB-&gt;pdev
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
op_amp
id|pstat
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Register dump: PCI Status: %04x&bslash;n&quot;
comma
id|pstat
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: In case of driver trouble read Documentation/scsi/tmscsim.txt&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|DC390_abort
r_static
r_int
id|DC390_abort
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pDCB
op_assign
(paren
r_struct
id|dc390_dcb
op_star
)paren
id|cmd-&gt;device-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_srb
op_star
id|pSRB
comma
op_star
id|psrb
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DC390: Abort command (pid %li, Device %02i-%02i)&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|pSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
r_goto
id|on_going
suffix:semicolon
multiline_comment|/* Now scan Waiting queue */
r_if
c_cond
(paren
id|pSRB-&gt;pcmd
op_ne
id|cmd
)paren
(brace
id|psrb
op_assign
id|pSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|psrb-&gt;pNextSRB
)paren
)paren
r_goto
id|on_going
suffix:semicolon
r_while
c_loop
(paren
id|psrb-&gt;pNextSRB-&gt;pcmd
op_ne
id|cmd
)paren
(brace
id|psrb
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|psrb-&gt;pNextSRB
)paren
op_logical_or
id|psrb
op_eq
id|pSRB
)paren
r_goto
id|on_going
suffix:semicolon
)brace
id|pSRB
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
id|psrb-&gt;pNextSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pWaitLast
)paren
id|pDCB-&gt;pWaitLast
op_assign
id|psrb
suffix:semicolon
)brace
r_else
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|dc390_Free_insert
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_decrement
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
(paren
r_struct
id|list_head
op_star
)paren
op_amp
id|cmd-&gt;SCp
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
id|on_going
suffix:colon
multiline_comment|/* abort() is too stupid for already sent commands at the moment. &n;&t; * If it&squot;s called we are in trouble anyway, so let&squot;s dump some info &n;&t; * into the syslog at least. (KG, 98/08/20,99/06/20) */
id|dc390_dumpinfo
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|pDCB-&gt;DCBFlag
op_or_assign
id|ABORT_DEV_
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: Aborted pid %li&bslash;n&quot;
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
DECL|function|dc390_ResetDevParam
r_static
r_void
id|dc390_ResetDevParam
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
op_star
id|pdcb
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
suffix:semicolon
id|pdcb
op_assign
id|pDCB
suffix:semicolon
r_do
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|SYNC_NEGO_DONE
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;CtrlR3
op_assign
id|FAST_CLK
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_and_assign
id|NEGATE_REQACKDATA
op_or
id|CTRL4_RESERVED
op_or
id|NEGATE_REQACK
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_or_assign
id|pACB-&gt;glitch_cfg
suffix:semicolon
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pdcb
op_ne
id|pDCB
)paren
(brace
suffix:semicolon
)brace
id|pACB-&gt;ACBFlag
op_and_assign
op_complement
(paren
id|RESET_DEV
op_or
id|RESET_DONE
op_or
id|RESET_DETECT
)paren
suffix:semicolon
)brace
DECL|function|DC390_bus_reset
r_static
r_int
id|DC390_bus_reset
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|u8
id|bval
suffix:semicolon
id|del_timer
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
id|bval
op_assign
id|DC390_read8
c_func
(paren
id|CtrlReg1
)paren
op_or
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|DC390_write8
c_func
(paren
id|CtrlReg1
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* disable IRQ on bus reset */
id|pACB-&gt;ACBFlag
op_or_assign
id|RESET_DEV
suffix:semicolon
id|dc390_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|dc390_ResetDevParam
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|pACB-&gt;pScsiHost-&gt;last_reset
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc390_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
(braket
id|EE_DELAY
)braket
suffix:semicolon
id|DC390_write8
c_func
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|DC390_read8
c_func
(paren
id|INT_Status
)paren
suffix:semicolon
multiline_comment|/* Reset Pending INT */
id|dc390_DoingSRB_Done
c_func
(paren
id|pACB
comma
id|cmd
)paren
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
id|bval
op_assign
id|DC390_read8
c_func
(paren
id|CtrlReg1
)paren
op_amp
op_complement
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|DC390_write8
c_func
(paren
id|CtrlReg1
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupt */
id|dc390_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
macro_line|#include &quot;scsiiom.c&quot;
multiline_comment|/***********************************************************************&n; * Function : static void dc390_updateDCB()&n; *&n; * Purpose :  Set the configuration dependent DCB parameters&n; ***********************************************************************/
DECL|function|dc390_updateDCB
r_static
r_void
id|dc390_updateDCB
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
)paren
(brace
id|pDCB-&gt;SyncMode
op_and_assign
id|EN_TAG_QUEUEING
op_or
id|SYNC_NEGO_DONE
multiline_comment|/*| EN_ATN_STOP*/
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|TAG_QUEUEING_
)paren
(brace
singleline_comment|//if (pDCB-&gt;SyncMode &amp; EN_TAG_QUEUEING) pDCB-&gt;MaxCommand = pACB-&gt;TagMaxNum;
)brace
r_else
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|EN_TAG_QUEUEING
suffix:semicolon
id|pDCB-&gt;MaxCommand
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|SYNC_NEGO_
)paren
(brace
id|pDCB-&gt;SyncMode
op_or_assign
id|SYNC_ENABLE
suffix:semicolon
)brace
r_else
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
(paren
id|SYNC_NEGO_DONE
op_or
id|SYNC_ENABLE
)paren
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_and_assign
op_complement
l_int|0x0f
suffix:semicolon
)brace
singleline_comment|//if (! (pDCB-&gt;DevMode &amp; EN_DISCONNECT_)) pDCB-&gt;SyncMode &amp;= ~EN_ATN_STOP; 
id|pDCB-&gt;CtrlR1
op_assign
id|pACB-&gt;pScsiHost-&gt;this_id
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|PARITY_CHK_
)paren
(brace
id|pDCB-&gt;CtrlR1
op_or_assign
id|PARITY_ERR_REPO
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * dc390_slave_alloc - Called by the scsi mid layer to tell us about a new&n; * scsi device that we need to deal with.&n; *&n; * @scsi_device: The new scsi device that we need to handle.&n; */
DECL|function|dc390_slave_alloc
r_static
r_int
id|dc390_slave_alloc
c_func
(paren
r_struct
id|scsi_device
op_star
id|scsi_device
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|scsi_device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
op_star
id|pDCB2
op_assign
l_int|0
suffix:semicolon
id|uint
id|id
op_assign
id|scsi_device-&gt;id
suffix:semicolon
id|uint
id|lun
op_assign
id|scsi_device-&gt;lun
suffix:semicolon
id|pDCB
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dc390_dcb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|pDCB
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dc390_dcb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;DCBCnt
op_increment
)paren
(brace
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
id|pDCB
suffix:semicolon
)brace
r_else
(brace
id|pACB-&gt;pLastDCB-&gt;pNextDCB
op_assign
id|pDCB
suffix:semicolon
)brace
id|pDCB-&gt;pNextDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pACB-&gt;pLastDCB
op_assign
id|pDCB
suffix:semicolon
id|pDCB-&gt;pDCBACB
op_assign
id|pACB
suffix:semicolon
id|pDCB-&gt;TargetID
op_assign
id|id
suffix:semicolon
id|pDCB-&gt;TargetLUN
op_assign
id|lun
suffix:semicolon
id|pDCB-&gt;MaxCommand
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Some values are for all LUNs: Copy them &n;&t; * In a clean way: We would have an own structure for a SCSI-ID &n;&t; */
r_if
c_cond
(paren
id|lun
op_logical_and
(paren
id|pDCB2
op_assign
id|dc390_findDCB
c_func
(paren
id|pACB
comma
id|id
comma
l_int|0
)paren
)paren
)paren
(brace
id|pDCB-&gt;DevMode
op_assign
id|pDCB2-&gt;DevMode
suffix:semicolon
id|pDCB-&gt;SyncMode
op_assign
id|pDCB2-&gt;SyncMode
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
id|pDCB2-&gt;SyncPeriod
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
id|pDCB2-&gt;SyncOffset
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
id|pDCB2-&gt;NegoPeriod
suffix:semicolon
id|pDCB-&gt;CtrlR3
op_assign
id|pDCB2-&gt;CtrlR3
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_assign
id|pDCB2-&gt;CtrlR4
suffix:semicolon
id|pDCB-&gt;Inquiry7
op_assign
id|pDCB2-&gt;Inquiry7
suffix:semicolon
)brace
r_else
(brace
id|u8
id|index
op_assign
id|pACB-&gt;AdapterIndex
suffix:semicolon
id|PEEprom
id|prom
op_assign
(paren
id|PEEprom
)paren
op_amp
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|id
op_lshift
l_int|2
)braket
suffix:semicolon
id|pDCB-&gt;DevMode
op_assign
id|prom-&gt;EE_MODE1
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
(paren
id|dc390_clock_period1
(braket
id|prom-&gt;EE_SPEED
)braket
op_star
l_int|25
)paren
op_rshift
l_int|2
suffix:semicolon
id|pDCB-&gt;CtrlR3
op_assign
id|FAST_CLK
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_assign
id|pACB-&gt;glitch_cfg
op_or
id|CTRL4_RESERVED
suffix:semicolon
r_if
c_cond
(paren
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|ACTIVE_NEGATION
)paren
id|pDCB-&gt;CtrlR4
op_or_assign
id|NEGATE_REQACKDATA
op_or
id|NEGATE_REQACK
suffix:semicolon
)brace
id|dc390_updateDCB
c_func
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
id|pACB-&gt;scan_devices
op_assign
l_int|1
suffix:semicolon
id|scsi_device-&gt;hostdata
op_assign
id|pDCB
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * dc390_slave_destroy - Called by the scsi mid layer to tell us about a&n; * device that is going away.&n; *&n; * @scsi_device: The scsi device that we need to remove.&n; */
DECL|function|dc390_slave_destroy
r_static
r_void
id|dc390_slave_destroy
c_func
(paren
r_struct
id|scsi_device
op_star
id|scsi_device
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|scsi_device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pDCB
op_assign
(paren
r_struct
id|dc390_dcb
op_star
)paren
id|scsi_device-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pPrevDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pACB-&gt;scan_devices
op_assign
l_int|0
suffix:semicolon
id|BUG_ON
c_func
(paren
id|pDCB-&gt;GoingSRBCnt
OG
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLinkDCB
)paren
(brace
r_if
c_cond
(paren
id|pACB-&gt;pLastDCB
op_eq
id|pDCB
)paren
(brace
id|pDCB-&gt;pNextDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pLastDCB
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|pPrevDCB-&gt;pNextDCB
op_ne
id|pDCB
)paren
id|pPrevDCB
op_assign
id|pPrevDCB-&gt;pNextDCB
suffix:semicolon
id|pPrevDCB-&gt;pNextDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLastDCB
)paren
id|pACB-&gt;pLastDCB
op_assign
id|pPrevDCB
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pActiveDCB
)paren
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLinkDCB
)paren
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pDCBRunRobin
)paren
id|pACB-&gt;pDCBRunRobin
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
id|kfree
c_func
(paren
id|pDCB
)paren
suffix:semicolon
id|pACB-&gt;DCBCnt
op_decrement
suffix:semicolon
)brace
DECL|function|dc390_slave_configure
r_static
r_int
id|dc390_slave_configure
c_func
(paren
r_struct
id|scsi_device
op_star
id|scsi_device
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|scsi_device-&gt;host-&gt;hostdata
suffix:semicolon
id|pACB-&gt;scan_devices
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|driver_template
r_static
r_struct
id|scsi_host_template
id|driver_template
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|proc_name
op_assign
l_string|&quot;tmscsim&quot;
comma
dot
id|name
op_assign
id|DC390_BANNER
l_string|&quot; V&quot;
id|DC390_VERSION
comma
dot
id|slave_alloc
op_assign
id|dc390_slave_alloc
comma
dot
id|slave_configure
op_assign
id|dc390_slave_configure
comma
dot
id|slave_destroy
op_assign
id|dc390_slave_destroy
comma
dot
id|queuecommand
op_assign
id|DC390_queue_command
comma
dot
id|eh_abort_handler
op_assign
id|DC390_abort
comma
dot
id|eh_bus_reset_handler
op_assign
id|DC390_bus_reset
comma
dot
id|can_queue
op_assign
l_int|42
comma
dot
id|this_id
op_assign
l_int|7
comma
dot
id|sg_tablesize
op_assign
id|SG_ALL
comma
dot
id|cmd_per_lun
op_assign
l_int|16
comma
dot
id|use_clustering
op_assign
id|DISABLE_CLUSTERING
comma
)brace
suffix:semicolon
DECL|function|dc390_eeprom_prepare_read
r_static
r_void
id|__devinit
id|dc390_eeprom_prepare_read
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u8
id|cd
)paren
(brace
id|u8
id|carryFlag
op_assign
l_int|1
comma
id|j
op_assign
l_int|0x80
comma
id|i
comma
id|bval
comma
id|regval
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|carryFlag
)paren
(brace
id|bval
op_assign
l_int|0x40
suffix:semicolon
id|regval
op_assign
l_int|0x80
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|regval
comma
id|bval
)paren
suffix:semicolon
)brace
r_else
(brace
id|bval
op_assign
l_int|0
suffix:semicolon
id|regval
op_assign
l_int|0xc0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|regval
comma
id|bval
op_or
l_int|0x80
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|regval
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|carryFlag
op_assign
(paren
id|cmd
op_amp
id|j
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|j
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|dc390_eeprom_get_data
r_static
id|u16
id|__devinit
id|dc390_eeprom_get_data
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|u8
id|wval
op_assign
l_int|0
comma
id|bval
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|wval
op_lshift_assign
l_int|1
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x80
comma
l_int|0x80
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x80
comma
l_int|0x40
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
l_int|0x00
comma
op_amp
id|bval
)paren
suffix:semicolon
id|wval
op_or_assign
(paren
(paren
id|bval
op_eq
l_int|0x22
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|wval
suffix:semicolon
)brace
DECL|function|dc390_read_eeprom
r_static
r_void
id|__devinit
id|dc390_read_eeprom
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u16
op_star
id|ptr
)paren
(brace
id|u8
id|cmd
op_assign
id|EEPROM_READ
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x40
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0xc0
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|dc390_eeprom_prepare_read
c_func
(paren
id|pdev
comma
id|cmd
op_increment
)paren
suffix:semicolon
op_star
id|ptr
op_increment
op_assign
id|dc390_eeprom_get_data
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x80
comma
l_int|0
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x80
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Override EEprom values with explicitly set values */
DECL|function|dc390_eeprom_override
r_static
r_void
id|__devinit
id|dc390_eeprom_override
c_func
(paren
id|u8
id|index
)paren
(brace
id|u8
op_star
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|dc390_eepromBuf
(braket
id|index
)braket
comma
id|id
suffix:semicolon
multiline_comment|/* Adapter Settings */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|0
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_ADAPT_SCSI_ID
)braket
op_assign
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Adapter ID */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|3
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_MODE2
)braket
op_assign
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|5
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_DELAY
)braket
op_assign
id|tmscsim
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* Reset delay */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|4
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_TAG_CMD_NUM
)braket
op_assign
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Tagged Cmds */
multiline_comment|/* Device Settings */
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|MAX_SCSI_ID
suffix:semicolon
id|id
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|2
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|id
op_lshift
l_int|2
)braket
op_assign
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* EE_MODE1 */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|1
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
(paren
id|id
op_lshift
l_int|2
)paren
op_plus
l_int|1
)braket
op_assign
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* EE_Speed */
)brace
)brace
DECL|variable|tmscsim_def
r_static
r_int
id|__devinitdata
id|tmscsim_def
(braket
)braket
op_assign
(brace
l_int|7
comma
l_int|0
multiline_comment|/* 10MHz */
comma
id|PARITY_CHK_
op_or
id|SEND_START_
op_or
id|EN_DISCONNECT_
op_or
id|SYNC_NEGO_
op_or
id|TAG_QUEUEING_
comma
id|MORE2_DRV
op_or
id|GREATER_1G
op_or
id|RST_SCSI_BUS
op_or
id|ACTIVE_NEGATION
op_or
id|LUN_CHECK
comma
l_int|3
multiline_comment|/* 16 Tags per LUN */
comma
l_int|1
multiline_comment|/* s delay after Reset */
comma
)brace
suffix:semicolon
multiline_comment|/* Copy defaults over set values where missing */
DECL|function|dc390_fill_with_defaults
r_static
r_void
id|__devinit
id|dc390_fill_with_defaults
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tmscsim
(braket
id|i
)braket
template_param
l_int|255
)paren
id|tmscsim
(braket
id|i
)braket
op_assign
id|tmscsim_def
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* Sanity checks */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|0
)braket
OG
l_int|7
)paren
id|tmscsim
(braket
l_int|0
)braket
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|1
)braket
OG
l_int|7
)paren
id|tmscsim
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|4
)braket
OG
l_int|5
)paren
id|tmscsim
(braket
l_int|4
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|5
)braket
OG
l_int|180
)paren
id|tmscsim
(braket
l_int|5
)braket
op_assign
l_int|180
suffix:semicolon
)brace
DECL|function|dc390_check_eeprom
r_static
r_void
id|__devinit
id|dc390_check_eeprom
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u8
id|index
)paren
(brace
r_char
id|interpd
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|3
comma
l_int|5
comma
l_int|10
comma
l_int|16
comma
l_int|30
comma
l_int|60
comma
l_int|120
)brace
suffix:semicolon
r_char
id|EEbuf
(braket
l_int|128
)braket
suffix:semicolon
id|u16
op_star
id|ptr
op_assign
(paren
id|u16
op_star
)paren
id|EEbuf
comma
id|wval
op_assign
l_int|0
suffix:semicolon
id|u8
id|i
suffix:semicolon
id|dc390_read_eeprom
c_func
(paren
id|pdev
comma
id|ptr
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dc390_eepromBuf
(braket
id|index
)braket
comma
id|EEbuf
comma
id|EE_ADAPT_SCSI_ID
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
comma
op_amp
id|EEbuf
(braket
id|REAL_EE_ADAPT_SCSI_ID
)braket
comma
id|EE_LEN
op_minus
id|EE_ADAPT_SCSI_ID
)paren
suffix:semicolon
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_DELAY
)braket
op_assign
id|interpd
(braket
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_DELAY
)braket
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x40
suffix:semicolon
id|i
op_increment
comma
id|ptr
op_increment
)paren
id|wval
op_add_assign
op_star
id|ptr
suffix:semicolon
multiline_comment|/* no Tekram EEprom found */
r_if
c_cond
(paren
id|wval
op_ne
l_int|0x1234
)paren
(brace
r_int
id|speed
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390_init: No EEPROM found! &quot;
l_string|&quot;Trying default settings ...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * XXX(hch): bogus, because we might have tekram and&n;&t;&t; *           non-tekram hbas in a single machine.&n;&t;&t; */
id|dc390_fill_with_defaults
c_func
(paren
)paren
suffix:semicolon
id|speed
op_assign
id|dc390_clock_speed
(braket
id|tmscsim
(braket
l_int|1
)braket
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: Used defaults: AdaptID=%i, &quot;
l_string|&quot;SpeedIdx=%i (%i.%i MHz),&quot;
l_string|&quot; DevMode=0x%02x, AdaptMode=0x%02x, &quot;
l_string|&quot;TaggedCmnds=%i (%i), DelayReset=%is&bslash;n&quot;
comma
id|tmscsim
(braket
l_int|0
)braket
comma
id|tmscsim
(braket
l_int|1
)braket
comma
id|speed
op_div
l_int|10
comma
id|speed
op_mod
l_int|10
comma
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|2
)braket
comma
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|3
)braket
comma
id|tmscsim
(braket
l_int|4
)braket
comma
l_int|2
op_lshift
(paren
id|tmscsim
(braket
l_int|4
)braket
)paren
comma
id|tmscsim
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|dc390_init_hw
r_static
r_void
id|__devinit
id|dc390_init_hw
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
id|u8
id|index
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|pACB-&gt;pScsiHost
suffix:semicolon
id|u8
id|dstate
suffix:semicolon
multiline_comment|/* Disable SCSI bus reset interrupt */
id|DC390_write8
c_func
(paren
id|CtrlReg1
comma
id|DIS_INT_ON_SCSI_RST
op_or
id|shost-&gt;this_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;Gmode2
op_amp
id|RST_SCSI_BUS
)paren
(brace
id|dc390_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|shost-&gt;last_reset
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc390_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
(braket
id|EE_DELAY
)braket
suffix:semicolon
)brace
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset Pending INT */
id|DC390_read8
c_func
(paren
id|INT_Status
)paren
suffix:semicolon
multiline_comment|/* 250ms selection timeout */
id|DC390_write8
c_func
(paren
id|Scsi_TimeOut
comma
id|SEL_TIMEOUT
)paren
suffix:semicolon
multiline_comment|/* Conversion factor = 0 , 40MHz clock */
id|DC390_write8
c_func
(paren
id|Clk_Factor
comma
id|CLK_FREQ_40MHZ
)paren
suffix:semicolon
multiline_comment|/* NOP cmd - clear command register */
id|DC390_write8
c_func
(paren
id|ScsiCmd
comma
id|NOP_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable Feature and SCSI-2 */
id|DC390_write8
c_func
(paren
id|CtrlReg2
comma
id|EN_FEATURE
op_plus
id|EN_SCSI2_CMD
)paren
suffix:semicolon
multiline_comment|/* Fast clock */
id|DC390_write8
c_func
(paren
id|CtrlReg3
comma
id|FAST_CLK
)paren
suffix:semicolon
multiline_comment|/* Negation */
id|DC390_write8
c_func
(paren
id|CtrlReg4
comma
id|pACB-&gt;glitch_cfg
op_or
multiline_comment|/* glitch eater */
(paren
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|ACTIVE_NEGATION
)paren
ques
c_cond
id|NEGATE_REQACKDATA
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Clear Transfer Count High: ID */
id|DC390_write8
c_func
(paren
id|CtcReg_High
comma
l_int|0
)paren
suffix:semicolon
id|DC390_write8
c_func
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
)paren
suffix:semicolon
id|DC390_write8
c_func
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|DC390_write32
c_func
(paren
id|DMA_ScsiBusCtrl
comma
id|EN_INT_ON_PCI_ABORT
)paren
suffix:semicolon
id|dstate
op_assign
id|DC390_read8
c_func
(paren
id|DMA_Status
)paren
suffix:semicolon
id|DC390_write8
c_func
(paren
id|DMA_Status
comma
id|dstate
)paren
suffix:semicolon
)brace
DECL|function|dc390_probe_one
r_static
r_int
id|__devinit
id|dc390_probe_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
comma
op_star
id|pACB2
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shost
suffix:semicolon
r_int
r_int
id|io_port
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|ENODEV
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_goto
id|out
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|shost
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|driver_template
comma
r_sizeof
(paren
r_struct
id|dc390_acb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shost
)paren
r_goto
id|out_disable_device
suffix:semicolon
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
id|memset
c_func
(paren
id|pACB
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dc390_acb
)paren
)paren
suffix:semicolon
id|dc390_check_eeprom
c_func
(paren
id|pdev
comma
id|dc390_adapterCnt
)paren
suffix:semicolon
id|dc390_eeprom_override
c_func
(paren
id|dc390_adapterCnt
)paren
suffix:semicolon
id|io_port
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|shost-&gt;can_queue
op_assign
id|MAX_CMD_QUEUE
suffix:semicolon
id|shost-&gt;cmd_per_lun
op_assign
id|MAX_CMD_PER_LUN
suffix:semicolon
id|shost-&gt;this_id
op_assign
id|dc390_eepromBuf
(braket
id|dc390_adapterCnt
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
suffix:semicolon
id|shost-&gt;io_port
op_assign
id|io_port
suffix:semicolon
id|shost-&gt;n_io_port
op_assign
l_int|0x80
suffix:semicolon
id|shost-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|shost-&gt;base
op_assign
id|io_port
suffix:semicolon
id|shost-&gt;unique_id
op_assign
id|io_port
suffix:semicolon
id|shost-&gt;last_reset
op_assign
id|jiffies
suffix:semicolon
id|pACB-&gt;pScsiHost
op_assign
id|shost
suffix:semicolon
id|pACB-&gt;IOPortBase
op_assign
(paren
id|u16
)paren
id|io_port
suffix:semicolon
id|pACB-&gt;IRQLevel
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|shost-&gt;max_id
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|shost-&gt;max_id
op_minus
l_int|1
op_eq
id|dc390_eepromBuf
(braket
id|dc390_adapterCnt
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
)paren
id|shost-&gt;max_id
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|dc390_eepromBuf
(braket
id|dc390_adapterCnt
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|LUN_CHECK
)paren
id|shost-&gt;max_lun
op_assign
l_int|8
suffix:semicolon
r_else
id|shost-&gt;max_lun
op_assign
l_int|1
suffix:semicolon
id|pACB-&gt;pFreeSRB
op_assign
id|pACB-&gt;SRB_array
suffix:semicolon
id|pACB-&gt;SRBCount
op_assign
id|MAX_SRB_CNT
suffix:semicolon
id|pACB-&gt;AdapterIndex
op_assign
id|dc390_adapterCnt
suffix:semicolon
id|pACB-&gt;TagMaxNum
op_assign
l_int|2
op_lshift
id|dc390_eepromBuf
(braket
id|dc390_adapterCnt
)braket
(braket
id|EE_TAG_CMD_NUM
)braket
suffix:semicolon
id|pACB-&gt;Gmode2
op_assign
id|dc390_eepromBuf
(braket
id|dc390_adapterCnt
)braket
(braket
id|EE_MODE2
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pACB-&gt;SRBCount
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|pACB-&gt;SRB_array
(braket
id|i
)braket
dot
id|pNextSRB
op_assign
op_amp
id|pACB-&gt;SRB_array
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|pACB-&gt;SRB_array
(braket
id|pACB-&gt;SRBCount
op_minus
l_int|1
)braket
dot
id|pNextSRB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pTmpSRB
op_assign
op_amp
id|pACB-&gt;TmpSRB
suffix:semicolon
id|pACB-&gt;sel_timeout
op_assign
id|SEL_TIMEOUT
suffix:semicolon
id|pACB-&gt;glitch_cfg
op_assign
id|EATER_25NS
suffix:semicolon
id|pACB-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|io_port
comma
id|shost-&gt;n_io_port
comma
l_string|&quot;tmscsim&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DC390: register IO ports error!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_host_put
suffix:semicolon
)brace
multiline_comment|/* Reset Pending INT */
id|DC390_read8_
c_func
(paren
id|INT_Status
comma
id|io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|do_DC390_Interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;tmscsim&quot;
comma
id|pACB
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DC390: register IRQ error!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_release_region
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dc390_pACB_start
)paren
(brace
id|pACB2
op_assign
l_int|NULL
suffix:semicolon
id|dc390_pACB_start
op_assign
id|pACB
suffix:semicolon
id|dc390_pACB_current
op_assign
id|pACB
suffix:semicolon
id|pACB-&gt;pNextACB
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|pACB2
op_assign
id|dc390_pACB_current
suffix:semicolon
id|dc390_pACB_current-&gt;pNextACB
op_assign
id|pACB
suffix:semicolon
id|dc390_pACB_current
op_assign
id|pACB
suffix:semicolon
id|pACB-&gt;pNextACB
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dc390_init_hw
c_func
(paren
id|pACB
comma
id|dc390_adapterCnt
)paren
suffix:semicolon
id|dc390_adapterCnt
op_increment
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|shost
)paren
suffix:semicolon
id|error
op_assign
id|scsi_add_host
c_func
(paren
id|shost
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out_free_irq
suffix:semicolon
id|scsi_scan_host
c_func
(paren
id|shost
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_free_irq
suffix:colon
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|pACB
)paren
suffix:semicolon
id|out_release_region
suffix:colon
id|release_region
c_func
(paren
id|io_port
comma
id|shost-&gt;n_io_port
)paren
suffix:semicolon
id|out_host_put
suffix:colon
id|scsi_host_put
c_func
(paren
id|shost
)paren
suffix:semicolon
id|out_disable_device
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; * dc390_remove_one - Called to remove a single instance of the adapter.&n; *&n; * @dev: The PCI device to remove.&n; */
DECL|function|dc390_remove_one
r_static
r_void
id|__devexit
id|dc390_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|scsi_host
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|scsi_host-&gt;hostdata
suffix:semicolon
id|u8
id|bval
suffix:semicolon
id|scsi_remove_host
c_func
(paren
id|scsi_host
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|scsi_host-&gt;host_lock
comma
id|iflags
)paren
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
id|RESET_DEV
suffix:semicolon
id|bval
op_assign
id|DC390_read8
c_func
(paren
id|CtrlReg1
)paren
op_or
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg1
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* disable interrupt */
r_if
c_cond
(paren
id|pACB-&gt;Gmode2
op_amp
id|RST_SCSI_BUS
)paren
id|dc390_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|scsi_host-&gt;host_lock
comma
id|iflags
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|scsi_host-&gt;irq
comma
id|pACB
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|scsi_host-&gt;io_port
comma
id|scsi_host-&gt;n_io_port
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|scsi_host
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|tmscsim_pci_tbl
r_static
r_struct
id|pci_device_id
id|tmscsim_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_AMD
comma
id|PCI_DEVICE_ID_AMD53C974
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|tmscsim_pci_tbl
)paren
suffix:semicolon
DECL|variable|dc390_driver
r_static
r_struct
id|pci_driver
id|dc390_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;tmscsim&quot;
comma
dot
id|id_table
op_assign
id|tmscsim_pci_tbl
comma
dot
id|probe
op_assign
id|dc390_probe_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|dc390_remove_one
)paren
comma
)brace
suffix:semicolon
DECL|function|dc390_module_init
r_static
r_int
id|__init
id|dc390_module_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
op_logical_or
id|tmscsim
(braket
l_int|0
)braket
OG
l_int|15
)paren
(brace
id|tmscsim
(braket
l_int|0
)braket
op_assign
l_int|7
suffix:semicolon
id|tmscsim
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
id|tmscsim
(braket
l_int|2
)braket
op_assign
l_int|0x09
suffix:semicolon
id|tmscsim
(braket
l_int|3
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|tmscsim
(braket
l_int|4
)braket
op_assign
l_int|2
suffix:semicolon
id|tmscsim
(braket
l_int|5
)braket
op_assign
l_int|10
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: Using safe settings.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|dc390_driver
)paren
suffix:semicolon
)brace
DECL|function|dc390_module_exit
r_static
r_void
id|__exit
id|dc390_module_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|dc390_driver
)paren
suffix:semicolon
)brace
DECL|variable|dc390_module_init
id|module_init
c_func
(paren
id|dc390_module_init
)paren
suffix:semicolon
DECL|variable|dc390_module_exit
id|module_exit
c_func
(paren
id|dc390_module_exit
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|dc390_setup
r_static
r_int
id|__init
id|dc390_setup
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|ints
(braket
l_int|8
)braket
comma
id|i
comma
id|im
suffix:semicolon
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|im
op_assign
id|ints
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|im
OG
l_int|6
)paren
(brace
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;DC390: ignore extra params!&bslash;n&quot;
)paren
suffix:semicolon
id|im
op_assign
l_int|6
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|im
suffix:semicolon
id|i
op_increment
)paren
id|tmscsim
(braket
id|i
)braket
op_assign
id|ints
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* dc390_checkparams (); */
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;tmscsim=&quot;
comma
id|dc390_setup
)paren
suffix:semicolon
macro_line|#endif
eof
