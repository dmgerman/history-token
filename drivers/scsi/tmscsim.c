multiline_comment|/************************************************************************&n; *&t;FILE NAME : TMSCSIM.C&t;&t;&t;&t;&t;&t;*&n; *&t;     BY   : C.L. Huang,  ching@tekram.com.tw&t;&t;&t;*&n; *&t;Description: Device Driver for Tekram DC-390(T) PCI SCSI&t;*&n; *&t;&t;     Bus Master Host Adapter&t;&t;&t;&t;*&n; * (C)Copyright 1995-1996 Tekram Technology Co., Ltd.&t;&t;&t;*&n; ************************************************************************&n; * (C) Copyright: put under GNU GPL in 10/96&t;&t;&t;&t;*&n; *&t;&t;&t;&t;(see Documentation/scsi/tmscsim.txt)&t;*&n; ************************************************************************&n; * $Id: tmscsim.c,v 2.60.2.30 2000/12/20 01:07:12 garloff Exp $&t;&t;*&n; *&t;Enhancements and bugfixes by&t;&t;&t;&t;&t;*&n; *&t;Kurt Garloff &lt;kurt@garloff.de&gt;&t;&lt;garloff@suse.de&gt;&t;&t;*&n; ************************************************************************&n; *&t;HISTORY:&t;&t;&t;&t;&t;&t;&t;*&n; *&t;&t;&t;&t;&t;&t;&t;&t;&t;*&n; *&t;REV#&t;DATE&t;NAME&t;DESCRIPTION&t;&t;&t;&t;*&n; *&t;1.00  96/04/24&t;CLH&t;First release&t;&t;&t;&t;*&n; *&t;1.01  96/06/12&t;CLH&t;Fixed bug of Media Change for Removable *&n; *&t;&t;&t;&t;Device, scan all LUN. Support Pre2.0.10 *&n; *&t;1.02  96/06/18&t;CLH&t;Fixed bug of Command timeout ...&t;*&n; *&t;1.03  96/09/25&t;KG&t;Added tmscsim_proc_info()&t;&t;*&n; *&t;1.04  96/10/11&t;CLH&t;Updating for support KV 2.0.x&t;&t;*&n; *&t;1.05  96/10/18&t;KG&t;Fixed bug in DC390_abort(null ptr deref)*&n; *&t;1.06  96/10/25&t;KG&t;Fixed module support&t;&t;&t;*&n; *&t;1.07  96/11/09&t;KG&t;Fixed tmscsim_proc_info()&t;&t;*&n; *&t;1.08  96/11/18&t;KG&t;Fixed null ptr in DC390_Disconnect()&t;*&n; *&t;1.09  96/11/30&t;KG&t;Added register the allocated IO space&t;*&n; *&t;1.10  96/12/05&t;CLH&t;Modified tmscsim_proc_info(), and reset *&n; *&t;&t;&t;&t;pending interrupt in DC390_detect()&t;*&n; *&t;1.11  97/02/05&t;KG/CLH&t;Fixeds problem with partitions greater&t;*&n; *&t;&t;&t;&t;than 1GB&t;&t;&t;&t;*&n; *&t;1.12  98/02/15  MJ      Rewritten PCI probing&t;&t;&t;*&n; *&t;1.13  98/04/08&t;KG&t;Support for non DC390, __initfunc decls,*&n; *&t;&t;&t;&t;changed max devs from 10 to 16&t;&t;*&n; *&t;1.14a 98/05/05&t;KG&t;Dynamic DCB allocation, add-single-dev&t;*&n; *&t;&t;&t;&t;for LUNs if LUN_SCAN (BIOS) not set&t;*&n; *&t;&t;&t;&t;runtime config using /proc interface&t;*&n; *&t;1.14b 98/05/06&t;KG&t;eliminated cli (); sti (); spinlocks&t;*&n; *&t;1.14c 98/05/07&t;KG&t;2.0.x compatibility&t;&t;&t;*&n; *&t;1.20a 98/05/07&t;KG&t;changed names of funcs to be consistent *&n; *&t;&t;&t;&t;DC390_ (entry points), dc390_ (internal)*&n; *&t;&t;&t;&t;reworked locking&t;&t;&t;*&n; *&t;1.20b 98/05/12&t;KG&t;bugs: version, kfree, _ctmp&t;&t;*&n; *&t;&t;&t;&t;debug output&t;&t;&t;&t;*&n; *&t;1.20c 98/05/12&t;KG&t;bugs: kfree, parsing, EEpromDefaults&t;*&n; *&t;1.20d 98/05/14&t;KG&t;bugs: list linkage, clear flag after  &t;*&n; *&t;&t;&t;&t;reset on startup, code cleanup&t;&t;*&n; *&t;1.20e 98/05/15&t;KG&t;spinlock comments, name space cleanup&t;*&n; *&t;&t;&t;&t;pLastDCB now part of ACB structure&t;*&n; *&t;&t;&t;&t;added stats, timeout for 2.1, TagQ bug&t;*&n; *&t;&t;&t;&t;RESET and INQUIRY interface commands&t;*&n; *&t;1.20f 98/05/18&t;KG&t;spinlocks fixes, max_lun fix, free DCBs&t;*&n; *&t;&t;&t;&t;for missing LUNs, pending int&t;&t;*&n; *&t;1.20g 98/05/19&t;KG&t;Clean up: Avoid short&t;&t;&t;*&n; *&t;1.20h 98/05/21&t;KG&t;Remove AdaptSCSIID, max_lun ...&t;&t;*&n; *&t;1.20i 98/05/21&t;KG&t;Aiiie: Bug with TagQMask       &t;&t;*&n; *&t;1.20j 98/05/24&t;KG&t;Handle STAT_BUSY, handle pACB-&gt;pLinkDCB&t;*&n; *&t;&t;&t;&t;== 0 in remove_dev and DoingSRB_Done&t;*&n; *&t;1.20k 98/05/25&t;KG&t;DMA_INT&t;(experimental)&t;       &t;&t;*&n; *&t;1.20l 98/05/27&t;KG&t;remove DMA_INT; DMA_IDLE cmds added;&t;*&n; *&t;1.20m 98/06/10&t;KG&t;glitch configurable; made some global&t;*&n; *&t;&t;&t;&t;vars part of ACB; use DC390_readX&t;*&n; *&t;1.20n 98/06/11&t;KG&t;startup params&t;&t;&t;&t;*&n; *&t;1.20o 98/06/15&t;KG&t;added TagMaxNum to boot/module params&t;*&n; *&t;&t;&t;&t;Device Nr -&gt; Idx, TagMaxNum power of 2  *&n; *&t;1.20p 98/06/17&t;KG&t;Docu updates. Reset depends on settings *&n; *&t;&t;&t;&t;pci_set_master added; 2.0.xx: pcibios_*&t;*&n; *&t;&t;&t;&t;used instead of MechNum things ...&t;*&n; *&t;1.20q 98/06/23&t;KG&t;Changed defaults. Added debug code for&t;*&n; *&t;&t;&t;&t;removable media and fixed it. TagMaxNum&t;*&n; *&t;&t;&t;&t;fixed for DC390. Locking: ACB, DRV for&t;*&n; *&t;&t;&t;&t;better IRQ sharing. Spelling: Queueing&t;*&n; *&t;&t;&t;&t;Parsing and glitch_cfg changes. Display&t;*&n; *&t;&t;&t;&t;real SyncSpeed value. Made DisConn&t;*&n; *&t;&t;&t;&t;functional (!)&t;&t;&t;&t;*&n; *&t;1.20r 98/06/30&t;KG&t;Debug macros, allow disabling DsCn, set&t;*&n; *&t;&t;&t;&t;BIT4 in CtrlR4, EN_PAGE_INT, 2.0 module&t;*&n; *&t;&t;&t;&t;param -1 fixed.&t;&t;&t;&t;*&n; *&t;1.20s 98/08/20&t;KG&t;Debug info on abort(), try to check PCI,*&n; *&t;&t;&t;&t;phys_to_bus instead of phys_to_virt,&t;*&n; *&t;&t;&t;&t;fixed sel. process, fixed locking,&t;*&n; *&t;&t;&t;&t;added MODULE_XXX infos, changed IRQ&t;*&n; *&t;&t;&t;&t;request flags, disable DMA_INT&t;&t;*&n; *&t;1.20t 98/09/07&t;KG&t;TagQ report fixed; Write Erase DMA Stat;*&n; *&t;&t;&t;&t;initfunc -&gt; __init; better abort;&t;*&n; *&t;&t;&t;&t;Timeout for XFER_DONE &amp; BLAST_COMPLETE;&t;*&n; *&t;&t;&t;&t;Allow up to 33 commands being processed *&n; *&t;2.0a  98/10/14&t;KG&t;Max Cmnds back to 17. DMA_Stat clearing *&n; *&t;&t;&t;&t;all flags. Clear within while() loops&t;*&n; *&t;&t;&t;&t;in DataIn_0/Out_0. Null ptr in dumpinfo&t;*&n; *&t;&t;&t;&t;for pSRB==0. Better locking during init.*&n; *&t;&t;&t;&t;bios_param() now respects part. table.&t;*&n; *&t;2.0b  98/10/24&t;KG&t;Docu fixes. Timeout Msg in DMA Blast.&t;*&n; *&t;&t;&t;&t;Disallow illegal idx in INQUIRY/REMOVE&t;*&n; *&t;2.0c  98/11/19&t;KG&t;Cleaned up detect/init for SMP boxes, &t;*&n; *&t;&t;&t;&t;Write Erase DMA (1.20t) caused problems&t;*&n; *&t;2.0d  98/12/25&t;KG&t;Christmas release ;-) Message handling  *&n; *&t;&t;&t;&t;completely reworked. Handle target ini-&t;*&n; *&t;&t;&t;&t;tiated SDTR correctly.&t;&t;&t;*&n; *&t;2.0d1 99/01/25&t;KG&t;Try to handle RESTORE_PTR&t;&t;*&n; *&t;2.0d2 99/02/08&t;KG&t;Check for failure of kmalloc, correct &t;*&n; *&t;&t;&t;&t;inclusion of scsicam.h, DelayReset&t;*&n; *&t;2.0d3 99/05/31&t;KG&t;DRIVER_OK -&gt; DID_OK, DID_NO_CONNECT,&t;*&n; *&t;&t;&t;&t;detect Target mode and warn.&t;&t;*&n; *&t;&t;&t;&t;pcmd-&gt;result handling cleaned up.&t;*&n; *&t;2.0d4 99/06/01&t;KG&t;Cleaned selection process. Found bug&t;*&n; *&t;&t;&t;&t;which prevented more than 16 tags. Now:&t;*&n; *&t;&t;&t;&t;24. SDTR cleanup. Cleaner multi-LUN&t;*&n; *&t;&t;&t;&t;handling. Don&squot;t modify ControlRegs/FIFO&t;*&n; *&t;&t;&t;&t;when connected.&t;&t;&t;&t;*&n; *&t;2.0d5 99/06/01&t;KG&t;Clear DevID, Fix INQUIRY after cfg chg.&t;*&n; *&t;2.0d6 99/06/02&t;KG&t;Added ADD special command to allow cfg.&t;*&n; *&t;&t;&t;&t;before detection. Reset SYNC_NEGO_DONE&t;*&n; *&t;&t;&t;&t;after a bus reset.&t;&t;&t;*&n; *&t;2.0d7 99/06/03&t;KG&t;Fixed bugs wrt add,remove commands&t;*&n; *&t;2.0d8 99/06/04&t;KG&t;Removed copying of cmnd into CmdBlock.&t;*&n; *&t;&t;&t;&t;Fixed Oops in _release().&t;&t;*&n; *&t;2.0d9 99/06/06&t;KG&t;Also tag queue INQUIRY, T_U_R, ...&t;*&n; *&t;&t;&t;&t;Allow arb. no. of Tagged Cmnds. Max 32&t;*&n; *&t;2.0d1099/06/20&t;KG&t;TagMaxNo changes now honoured! Queueing *&n; *&t;&t;&t;&t;clearified (renamed ..) TagMask handling*&n; *&t;&t;&t;&t;cleaned.&t;&t;&t;&t;*&n; *&t;2.0d1199/06/28&t;KG&t;cmd-&gt;result now identical to 2.0d2&t;*&n; *&t;2.0d1299/07/04&t;KG&t;Changed order of processing in IRQ&t;*&n; *&t;2.0d1399/07/05&t;KG&t;Don&squot;t update DCB fields if removed&t;*&n; *&t;2.0d1499/07/05&t;KG&t;remove_dev: Move kfree() to the end&t;*&n; *&t;2.0d1599/07/12&t;KG&t;use_new_eh_code: 0, ULONG -&gt; UINT where&t;*&n; *&t;&t;&t;&t;appropriate&t;&t;&t;&t;*&n; *&t;2.0d1699/07/13&t;KG&t;Reenable StartSCSI interrupt, Retry msg&t;*&n; *&t;2.0d1799/07/15&t;KG&t;Remove debug msg. Disable recfg. when&t;*&n; *&t;&t;&t;&t;there are queued cmnds&t;&t;&t;*&n; *&t;2.0d1899/07/18&t;KG&t;Selection timeout: Don&squot;t requeue&t;*&n; *&t;2.0d1999/07/18&t;KG&t;Abort: Only call scsi_done if dequeued&t;*&n; *&t;2.0d2099/07/19&t;KG&t;Rst_Detect: DoingSRB_Done&t;&t;*&n; *&t;2.0d2199/08/15&t;KG&t;dev_id for request/free_irq, cmnd[0] for*&n; *&t;&t;&t;&t;RETRY, SRBdone does DID_ABORT for the &t;*&n; *&t;&t;&t;&t;cmd passed by DC390_reset()&t;&t;*&n; *&t;2.0d2299/08/25&t;KG&t;dev_id fixed. can_queue: 42&t;&t;*&n; *&t;2.0d2399/08/25&t;KG&t;Removed some debugging code. dev_id &t;*&n; *&t;&t;&t;&t;now is set to pACB. Use u8,u16,u32. &t;*&n; *&t;2.0d2499/11/14&t;KG&t;Unreg. I/O if failed IRQ alloc. Call&t;*&n; * &t;&t;&t;&t;done () w/ DID_BAD_TARGET in case of&t;*&n; *&t;&t;&t;&t;missing DCB. We&t;are old EH!!&t;&t;*&n; *&t;2.0d2500/01/15&t;KG&t;2.3.3x compat from Andreas Schultz&t;*&n; *&t;&t;&t;&t;set unique_id. Disable RETRY message.&t;*&n; *&t;2.0d2600/01/29&t;KG&t;Go to new EH.&t;&t;&t;&t;*&n; *&t;2.0d2700/01/31&t;KG&t;... but maintain 2.0 compat.&t;&t;*&n; *&t;&t;&t;&t;and fix DCB freeing&t;&t;&t;*&n; *&t;2.0d2800/02/14&t;KG&t;Queue statistics fixed, dump special cmd*&n; *&t;&t;&t;&t;Waiting_Timer for failed StartSCSI&t;*&n; *&t;&t;&t;&t;New EH: Don&squot;t return cmnds to ML on RST *&n; *&t;&t;&t;&t;Use old EH (don&squot;t have new EH fns yet)&t;*&n; * &t;&t;&t;&t;Reset: Unlock, but refuse to queue&t;*&n; * &t;&t;&t;&t;2.3 __setup function&t;&t;&t;*&n; *&t;2.0e  00/05/22&t;KG&t;Return residual for 2.3&t;&t;&t;*&n; *&t;2.0e1 00/05/25&t;KG&t;Compile fixes for 2.3.99&t;&t;*&n; *&t;2.0e2 00/05/27&t;KG&t;Jeff Garzik&squot;s pci_enable_device()&t;*&n; *&t;2.0e3 00/09/29&t;KG&t;Some 2.4 changes. Don&squot;t try Sync Nego&t;*&n; *&t;&t;&t;&t;before INQUIRY has reported ability. &t;*&n; *&t;&t;&t;&t;Recognise INQUIRY as scanning command.&t;*&n; *&t;2.0e4 00/10/13&t;KG&t;Allow compilation into 2.4 kernel&t;*&n; *&t;2.0e5 00/11/17&t;KG&t;Store Inq.flags in DCB&t;&t;&t;*&n; *&t;2.0e6 00/11/22  KG&t;2.4 init function (Thx to O.Schumann)&t;*&n; * &t;&t;&t;&t;2.4 PCI device table (Thx to A.Richter)&t;*&n; *&t;2.0e7 00/11/28&t;KG&t;Allow overriding of BIOS settings&t;*&n; *&t;2.0f  00/12/20&t;KG&t;Handle failed INQUIRYs during scan&t;*&n; *&t;2.1a  03/11/29  GL, KG&t;Initial fixing for 2.6. Convert to&t;*&n; *&t;&t;&t;&t;use the current PCI-mapping API, update&t;*&n; *&t;&t;&t;&t;command-queuing.&t;&t;&t;*&n; *&t;2.1b  04/04/13  GL&t;Fix for 64-bit platforms&t;&t;*&n; *&t;2.1b1 04/01/31&t;GL&t;(applied 05.04) Remove internal&t;&t;*&n; *&t;&t;&t;&t;command-queuing.&t;&t;&t;*&n; *&t;2.1b2 04/02/01&t;CH&t;(applied 05.04) Fix error-handling&t;*&n; *&t;2.1c  04/05/23  GL&t;Update to use the new pci_driver API,&t;*&n; *&t;&t;&t;&t;some scsi EH updates, more cleanup.&t;*&n; *&t;2.1d  04/05/27&t;GL&t;Moved setting of scan_devices to&t;*&n; *&t;&t;&t;&t;slave_alloc/_configure/_destroy, as&t;*&n; *&t;&t;&t;&t;suggested by CH.&t;&t;&t;*&n; ***********************************************************************/
multiline_comment|/* DEBUG options */
singleline_comment|//#define DC390_DEBUG0
singleline_comment|//#define DC390_DEBUG1
singleline_comment|//#define DC390_DCBDEBUG
singleline_comment|//#define DC390_PARSEDEBUG
singleline_comment|//#define DC390_REMOVABLEDEBUG
singleline_comment|//#define DC390_LOCKDEBUG
singleline_comment|//#define NOP do{}while(0)
DECL|macro|C_NOP
mdefine_line|#define C_NOP
multiline_comment|/* Debug definitions */
macro_line|#ifdef DC390_DEBUG0
DECL|macro|DEBUG0
macro_line|# define DEBUG0(x) x
macro_line|#else
DECL|macro|DEBUG0
macro_line|# define DEBUG0(x) C_NOP
macro_line|#endif
macro_line|#ifdef DC390_DEBUG1
DECL|macro|DEBUG1
macro_line|# define DEBUG1(x) x
macro_line|#else
DECL|macro|DEBUG1
macro_line|# define DEBUG1(x) C_NOP
macro_line|#endif
macro_line|#ifdef DC390_DCBDEBUG
DECL|macro|DCBDEBUG
macro_line|# define DCBDEBUG(x) x
macro_line|#else
DECL|macro|DCBDEBUG
macro_line|# define DCBDEBUG(x) C_NOP
macro_line|#endif
macro_line|#ifdef DC390_PARSEDEBUG
DECL|macro|PARSEDEBUG
macro_line|# define PARSEDEBUG(x) x
macro_line|#else
DECL|macro|PARSEDEBUG
macro_line|# define PARSEDEBUG(x) C_NOP
macro_line|#endif
macro_line|#ifdef DC390_REMOVABLEDEBUG
DECL|macro|REMOVABLEDEBUG
macro_line|# define REMOVABLEDEBUG(x) x
macro_line|#else
DECL|macro|REMOVABLEDEBUG
macro_line|# define REMOVABLEDEBUG(x) C_NOP
macro_line|#endif
DECL|macro|DCBDEBUG1
mdefine_line|#define DCBDEBUG1(x) C_NOP
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_cmnd.h&gt;
macro_line|#include &lt;scsi/scsi_device.h&gt;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsicam.h&gt;
macro_line|#include &lt;scsi/scsi_tcq.h&gt;
DECL|macro|DC390_BANNER
mdefine_line|#define DC390_BANNER &quot;Tekram DC390/AM53C974&quot;
DECL|macro|DC390_VERSION
mdefine_line|#define DC390_VERSION &quot;2.1d 2004-05-27&quot;
DECL|macro|PCI_DEVICE_ID_AMD53C974
mdefine_line|#define PCI_DEVICE_ID_AMD53C974 &t;PCI_DEVICE_ID_AMD_SCSI
macro_line|#include &quot;tmscsim.h&quot;
r_static
r_void
id|dc390_DataOut_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_DataIn_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Command_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Status_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_MsgOut_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_MsgIn_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_DataOutPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_DataInPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_CommandPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_StatusPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_MsgOutPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_MsgInPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Nop_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_Nop_1
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
suffix:semicolon
r_static
r_void
id|dc390_SetXferRate
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
)paren
suffix:semicolon
r_static
r_void
id|dc390_Disconnect
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|dc390_Reselect
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|dc390_SRBdone
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|dc390_ScsiRstDetect
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|dc390_EnableMsgOut_Abort
c_func
(paren
r_struct
id|dc390_acb
op_star
comma
r_struct
id|dc390_srb
op_star
)paren
suffix:semicolon
r_static
r_void
id|dc390_dumpinfo
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|dc390_ResetDevParam
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
suffix:semicolon
DECL|variable|dc390_laststatus
r_static
id|u32
id|dc390_laststatus
op_assign
l_int|0
suffix:semicolon
DECL|variable|dc390_adapterCnt
r_static
id|u8
id|dc390_adapterCnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Startup values, to be overriden on the commandline */
DECL|variable|tmscsim
r_static
r_int
id|tmscsim
(braket
)braket
op_assign
(brace
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
)brace
suffix:semicolon
DECL|variable|tmscsim_paramnum
r_static
r_int
id|tmscsim_paramnum
op_assign
id|ARRAY_SIZE
c_func
(paren
id|tmscsim
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|tmscsim
comma
r_int
comma
id|tmscsim_paramnum
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|tmscsim
comma
l_string|&quot;Host SCSI ID, Speed (0=10MHz), Device Flags, Adapter Flags, Max Tags (log2(tags)-1), DelayReset (s)&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;C.L. Huang / Kurt Garloff&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SCSI host adapter driver for Tekram DC390 and other AMD53C974A based PCI SCSI adapters&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;sd,sr,sg,st&quot;
)paren
suffix:semicolon
DECL|variable|dc390_phase0
r_static
r_void
op_star
id|dc390_phase0
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|dc390_phase1
r_static
r_void
op_star
id|dc390_phase1
(braket
)braket
op_assign
initialization_block
suffix:semicolon
macro_line|#ifdef DC390_DEBUG1
DECL|variable|dc390_p0_str
r_static
r_char
op_star
id|dc390_p0_str
(braket
)braket
op_assign
(brace
l_string|&quot;dc390_DataOut_0&quot;
comma
l_string|&quot;dc390_DataIn_0&quot;
comma
l_string|&quot;dc390_Command_0&quot;
comma
l_string|&quot;dc390_Status_0&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_MsgOut_0&quot;
comma
l_string|&quot;dc390_MsgIn_0&quot;
comma
l_string|&quot;dc390_Nop_1&quot;
)brace
suffix:semicolon
DECL|variable|dc390_p1_str
r_static
r_char
op_star
id|dc390_p1_str
(braket
)braket
op_assign
(brace
l_string|&quot;dc390_DataOutPhase&quot;
comma
l_string|&quot;dc390_DataInPhase&quot;
comma
l_string|&quot;dc390_CommandPhase&quot;
comma
l_string|&quot;dc390_StatusPhase&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_Nop_0&quot;
comma
l_string|&quot;dc390_MsgOutPhase&quot;
comma
l_string|&quot;dc390_MsgInPhase&quot;
comma
l_string|&quot;dc390_Nop_1&quot;
)brace
suffix:semicolon
macro_line|#endif   
DECL|variable|dc390_eepromBuf
r_static
id|u8
id|dc390_eepromBuf
(braket
id|MAX_ADAPTER_NUM
)braket
(braket
id|EE_LEN
)braket
suffix:semicolon
DECL|variable|dc390_clock_period1
r_static
id|u8
id|dc390_clock_period1
(braket
)braket
op_assign
(brace
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|10
comma
l_int|13
comma
l_int|20
)brace
suffix:semicolon
DECL|variable|dc390_clock_speed
r_static
id|u8
id|dc390_clock_speed
(braket
)braket
op_assign
(brace
l_int|100
comma
l_int|80
comma
l_int|67
comma
l_int|57
comma
l_int|50
comma
l_int|40
comma
l_int|31
comma
l_int|20
)brace
suffix:semicolon
multiline_comment|/***********************************************************************&n; * Functions for the management of the internal structures &n; * (DCBs, SRBs, Queueing)&n; *&n; **********************************************************************/
DECL|function|dc390_findDCB
r_static
r_struct
id|dc390_dcb
id|__inline__
op_star
id|dc390_findDCB
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
id|u8
id|id
comma
id|u8
id|lun
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|pDCB-&gt;TargetID
op_ne
id|id
op_logical_or
id|pDCB-&gt;TargetLUN
op_ne
id|lun
)paren
(brace
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLinkDCB
)paren
r_return
l_int|NULL
suffix:semicolon
)brace
id|DCBDEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DCB %p (%02x,%02x) found.&bslash;n&quot;
comma
"&bslash;"
id|pDCB
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
)paren
suffix:semicolon
r_return
id|pDCB
suffix:semicolon
)brace
multiline_comment|/* Insert SRB oin top of free list */
DECL|function|dc390_Free_insert
r_static
id|__inline__
r_void
id|dc390_Free_insert
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Free SRB %p&bslash;n&quot;
comma
id|pSRB
)paren
)paren
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
id|pACB-&gt;pFreeSRB
suffix:semicolon
id|pACB-&gt;pFreeSRB
op_assign
id|pSRB
suffix:semicolon
)brace
DECL|function|dc390_Going_append
r_static
id|__inline__
r_void
id|dc390_Going_append
(paren
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|pDCB-&gt;GoingSRBCnt
op_increment
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DC390: Append SRB %p to Going&bslash;n&quot;
comma
id|pSRB
)paren
)paren
suffix:semicolon
multiline_comment|/* Append to the list of Going commands */
r_if
c_cond
(paren
id|pDCB-&gt;pGoingSRB
)paren
(brace
id|pDCB-&gt;pGoingLast-&gt;pNextSRB
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
id|pDCB-&gt;pGoingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pGoingLast
op_assign
id|pSRB
suffix:semicolon
multiline_comment|/* No next one in sent list */
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|dc390_Going_remove
r_static
id|__inline__
r_void
id|dc390_Going_remove
(paren
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DC390: Remove SRB %p from Going&bslash;n&quot;
comma
id|pSRB
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pGoingSRB
)paren
id|pDCB-&gt;pGoingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_else
(brace
r_struct
id|dc390_srb
op_star
id|psrb
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
r_while
c_loop
(paren
id|psrb
op_logical_and
id|psrb-&gt;pNextSRB
op_ne
id|pSRB
)paren
id|psrb
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psrb
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Remove non-ex. SRB %p from Going!&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|psrb-&gt;pNextSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pGoingLast
)paren
id|pDCB-&gt;pGoingLast
op_assign
id|psrb
suffix:semicolon
)brace
id|pDCB-&gt;GoingSRBCnt
op_decrement
suffix:semicolon
)brace
DECL|function|dc390_sg_build_single
r_static
r_struct
id|scatterlist
op_star
id|dc390_sg_build_single
c_func
(paren
r_struct
id|scatterlist
op_star
id|sg
comma
r_void
op_star
id|addr
comma
r_int
r_int
id|length
)paren
(brace
id|memset
c_func
(paren
id|sg
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scatterlist
)paren
)paren
suffix:semicolon
id|sg-&gt;page
op_assign
id|virt_to_page
c_func
(paren
id|addr
)paren
suffix:semicolon
id|sg-&gt;length
op_assign
id|length
suffix:semicolon
id|sg-&gt;offset
op_assign
(paren
r_int
r_int
)paren
id|addr
op_amp
op_complement
id|PAGE_MASK
suffix:semicolon
r_return
id|sg
suffix:semicolon
)brace
multiline_comment|/* Create pci mapping */
DECL|function|dc390_pci_map
r_static
r_int
id|dc390_pci_map
(paren
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pSRB-&gt;pSRBDCB-&gt;pDCBACB-&gt;pdev
suffix:semicolon
id|dc390_cmd_scp_t
op_star
id|cmdp
op_assign
(paren
(paren
id|dc390_cmd_scp_t
op_star
)paren
(paren
op_amp
id|pcmd-&gt;SCp
)paren
)paren
suffix:semicolon
multiline_comment|/* Map sense buffer */
r_if
c_cond
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
(brace
id|pSRB-&gt;pSegmentList
op_assign
id|dc390_sg_build_single
c_func
(paren
op_amp
id|pSRB-&gt;Segmentx
comma
id|pcmd-&gt;sense_buffer
comma
r_sizeof
(paren
id|pcmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|pSRB-&gt;SGcount
op_assign
id|pci_map_sg
c_func
(paren
id|pdev
comma
id|pSRB-&gt;pSegmentList
comma
l_int|1
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|cmdp-&gt;saved_dma_handle
op_assign
id|sg_dma_address
c_func
(paren
id|pSRB-&gt;pSegmentList
)paren
suffix:semicolon
multiline_comment|/* TODO: error handling */
r_if
c_cond
(paren
id|pSRB-&gt;SGcount
op_ne
l_int|1
)paren
id|error
op_assign
l_int|1
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Mapped sense buffer %p at %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pcmd-&gt;sense_buffer
comma
id|cmdp-&gt;saved_dma_handle
)paren
)paren
suffix:semicolon
multiline_comment|/* Map SG list */
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
(brace
id|pSRB-&gt;pSegmentList
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
id|pSRB-&gt;SGcount
op_assign
id|pci_map_sg
c_func
(paren
id|pdev
comma
id|pSRB-&gt;pSegmentList
comma
id|pcmd-&gt;use_sg
comma
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
multiline_comment|/* TODO: error handling */
r_if
c_cond
(paren
op_logical_neg
id|pSRB-&gt;SGcount
)paren
id|error
op_assign
l_int|1
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Mapped SG %p with %d (%d) elements&bslash;n&quot;
comma
"&bslash;"
id|__FUNCTION__
comma
id|pcmd-&gt;request_buffer
comma
id|pSRB-&gt;SGcount
comma
id|pcmd-&gt;use_sg
)paren
)paren
suffix:semicolon
multiline_comment|/* Map single segment */
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
op_logical_and
id|pcmd-&gt;request_bufflen
)paren
(brace
id|pSRB-&gt;pSegmentList
op_assign
id|dc390_sg_build_single
c_func
(paren
op_amp
id|pSRB-&gt;Segmentx
comma
id|pcmd-&gt;request_buffer
comma
id|pcmd-&gt;request_bufflen
)paren
suffix:semicolon
id|pSRB-&gt;SGcount
op_assign
id|pci_map_sg
c_func
(paren
id|pdev
comma
id|pSRB-&gt;pSegmentList
comma
l_int|1
comma
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|cmdp-&gt;saved_dma_handle
op_assign
id|sg_dma_address
c_func
(paren
id|pSRB-&gt;pSegmentList
)paren
suffix:semicolon
multiline_comment|/* TODO: error handling */
r_if
c_cond
(paren
id|pSRB-&gt;SGcount
op_ne
l_int|1
)paren
id|error
op_assign
l_int|1
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Mapped request buffer %p at %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pcmd-&gt;request_buffer
comma
id|cmdp-&gt;saved_dma_handle
)paren
)paren
suffix:semicolon
multiline_comment|/* No mapping !? */
)brace
r_else
id|pSRB-&gt;SGcount
op_assign
l_int|0
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Remove pci mapping */
DECL|function|dc390_pci_unmap
r_static
r_void
id|dc390_pci_unmap
(paren
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pSRB-&gt;pSRBDCB-&gt;pDCBACB-&gt;pdev
suffix:semicolon
id|DEBUG1
c_func
(paren
id|dc390_cmd_scp_t
op_star
id|cmdp
op_assign
(paren
(paren
id|dc390_cmd_scp_t
op_star
)paren
(paren
op_amp
id|pcmd-&gt;SCp
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SRBFlag
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|pdev
comma
op_amp
id|pSRB-&gt;Segmentx
comma
l_int|1
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Unmapped sense buffer at %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cmdp-&gt;saved_dma_handle
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|pdev
comma
id|pcmd-&gt;request_buffer
comma
id|pcmd-&gt;use_sg
comma
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Unmapped SG at %p with %d elements&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pcmd-&gt;request_buffer
comma
id|pcmd-&gt;use_sg
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
op_logical_and
id|pcmd-&gt;request_bufflen
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|pdev
comma
op_amp
id|pSRB-&gt;Segmentx
comma
l_int|1
comma
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Unmapped request buffer at %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cmdp-&gt;saved_dma_handle
)paren
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
id|__inline__
DECL|function|dc390_freetag
id|dc390_freetag
(paren
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;TagNumber
op_ne
id|SCSI_NO_TAG
)paren
(brace
id|pDCB-&gt;TagMask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|pSRB-&gt;TagNumber
)paren
suffix:semicolon
multiline_comment|/* free tag mask */
id|pSRB-&gt;TagNumber
op_assign
id|SCSI_NO_TAG
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|dc390_StartSCSI
id|dc390_StartSCSI
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|pSRB-&gt;pcmd-&gt;device
suffix:semicolon
id|u8
id|cmd
suffix:semicolon
id|u8
id|disc_allowed
comma
id|try_sync_nego
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|SCSI_NOP0
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;Connected
)paren
(brace
singleline_comment|// Should not happen normally
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: Can&squot;t select when connected! (%08x,%02x)&bslash;n&quot;
comma
id|pSRB-&gt;SRBState
comma
id|pSRB-&gt;SRBFlag
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_READY
suffix:semicolon
id|pACB-&gt;SelConn
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_before
(paren
id|jiffies
comma
id|pACB-&gt;pScsiHost-&gt;last_reset
)paren
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: We were just reset and don&squot;t accept commands yet!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* KG: Moved pci mapping here */
id|dc390_pci_map
c_func
(paren
id|pSRB
)paren
suffix:semicolon
multiline_comment|/* TODO: error handling */
id|DC390_write8
(paren
id|Scsi_Dest_ID
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
id|DC390_write8
(paren
id|Sync_Period
comma
id|pDCB-&gt;SyncPeriod
)paren
suffix:semicolon
id|DC390_write8
(paren
id|Sync_Offset
comma
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg1
comma
id|pDCB-&gt;CtrlR1
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg3
comma
id|pDCB-&gt;CtrlR3
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg4
comma
id|pDCB-&gt;CtrlR4
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
multiline_comment|/* Flush FIFO */
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Start SCSI command: %02x (Sync:%02x)&bslash;n&quot;
comma
"&bslash;"
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;SyncMode
)paren
)paren
suffix:semicolon
id|disc_allowed
op_assign
id|pDCB-&gt;DevMode
op_amp
id|EN_DISCONNECT_
suffix:semicolon
id|try_sync_nego
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Don&squot;t disconnect on AUTO_REQSENSE, cause it might be an&n;     * Contingent Allegiance Condition (6.6), where no tags should be used.&n;     * All other have to be allowed to disconnect to prevent Incorrect &n;     * Initiator Connection (6.8.2/6.5.2) */
multiline_comment|/* Changed KG, 99/06/06 */
r_if
c_cond
(paren
multiline_comment|/*(((pSRB-&gt;pcmd-&gt;cmnd[0] == INQUIRY) || (pSRB-&gt;pcmd-&gt;cmnd[0] == REQUEST_SENSE) ||&n;&t; * (pSRB-&gt;pcmd-&gt;cmnd[0] == TEST_UNIT_READY)) &amp;&amp; pACB-&gt;scan_devices)&n;&t;&t;||*/
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
)paren
(brace
id|disc_allowed
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_ENABLE
)paren
op_logical_and
(paren
id|pDCB-&gt;TargetLUN
op_eq
l_int|0
)paren
op_logical_and
id|sdev-&gt;sdtr
op_logical_and
(paren
(paren
(paren
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
op_logical_or
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_NEGO_DONE
)paren
)paren
op_logical_or
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
)paren
)paren
id|try_sync_nego
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
id|cmd
op_assign
id|SEL_W_ATN
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|IDENTIFY
c_func
(paren
id|disc_allowed
comma
id|pDCB-&gt;TargetLUN
)paren
)paren
suffix:semicolon
multiline_comment|/* Change 99/05/31: Don&squot;t use tags when not disconnecting (BUSY) */
r_if
c_cond
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|EN_TAG_QUEUEING
)paren
op_logical_and
id|disc_allowed
)paren
(brace
id|s8
id|tag_no
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
l_int|1
op_lshift
id|tag_no
)paren
op_amp
id|pDCB-&gt;TagMask
)paren
id|tag_no
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tag_no
op_ge
r_sizeof
(paren
id|pDCB-&gt;TagMask
)paren
op_star
l_int|8
op_logical_or
id|tag_no
op_ge
id|pDCB-&gt;MaxCommand
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: Out of tags for Dev. %02x %02x&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
singleline_comment|//goto no_tag;
)brace
id|DC390_write8
(paren
id|ScsiFifo
comma
id|SIMPLE_QUEUE_TAG
)paren
suffix:semicolon
id|pDCB-&gt;TagMask
op_or_assign
(paren
l_int|1
op_lshift
id|tag_no
)paren
suffix:semicolon
id|pSRB-&gt;TagNumber
op_assign
id|tag_no
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|tag_no
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DC390: Select w/DisCn for Cmd %li (SRB %p), Using Tag %02x&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB
comma
id|tag_no
)paren
)paren
suffix:semicolon
id|cmd
op_assign
id|SEL_W_ATN3
suffix:semicolon
)brace
r_else
multiline_comment|/* No TagQ */
(brace
singleline_comment|//      no_tag:
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DC390: Select w%s/DisCn for Cmd %li (SRB %p), No TagQ&bslash;n&quot;
comma
(paren
id|disc_allowed
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;o&quot;
)paren
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB
)paren
)paren
suffix:semicolon
)brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_START_
suffix:semicolon
r_if
c_cond
(paren
id|try_sync_nego
)paren
(brace
id|u8
id|Sync_Off
op_assign
id|pDCB-&gt;SyncOffset
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: NEW Sync Nego code triggered (%i %i)&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
)paren
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|EXTENDED_MESSAGE
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|2
)braket
op_assign
id|EXTENDED_SDTR
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|3
)braket
op_assign
id|pDCB-&gt;NegoPeriod
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|Sync_Off
op_amp
l_int|0x0f
)paren
)paren
id|Sync_Off
op_assign
id|SYNC_NEGO_OFFSET
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|4
)braket
op_assign
id|Sync_Off
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|5
suffix:semicolon
singleline_comment|//pSRB-&gt;SRBState = SRB_MSGOUT_;
id|pSRB-&gt;SRBState
op_or_assign
id|DO_SYNC_NEGO
suffix:semicolon
id|cmd
op_assign
id|SEL_W_ATN_STOP
suffix:semicolon
)brace
multiline_comment|/* Command is written in CommandPhase, if SEL_W_ATN_STOP ... */
r_if
c_cond
(paren
id|cmd
op_ne
id|SEL_W_ATN_STOP
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
(brace
id|DC390_write8
(paren
id|ScsiFifo
comma
id|REQUEST_SENSE
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|pDCB-&gt;TargetLUN
op_lshift
l_int|5
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
l_int|0
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
l_int|0
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
r_sizeof
(paren
id|pSRB-&gt;pcmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
l_int|0
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DC390: AutoReqSense !&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* write cmnd to bus */
(brace
id|u8
op_star
id|ptr
suffix:semicolon
id|u8
id|i
suffix:semicolon
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|pSRB-&gt;pcmd-&gt;cmnd
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pSRB-&gt;pcmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|DC390_write8
(paren
id|ScsiFifo
comma
op_star
(paren
id|ptr
op_increment
)paren
)paren
suffix:semicolon
)brace
)brace
id|DEBUG0
c_func
(paren
r_if
(paren
id|pACB-&gt;pActiveDCB
)paren
"&bslash;"
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: ActiveDCB != 0&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
r_if
(paren
id|pDCB-&gt;pActiveSRB
)paren
"&bslash;"
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390: ActiveSRB != 0&bslash;n&quot;
)paren
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD);
r_if
c_cond
(paren
id|DC390_read8
(paren
id|Scsi_Status
)paren
op_amp
id|INTERRUPT
)paren
(brace
id|dc390_freetag
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: Interrupt during Start SCSI (pid %li, target %02i-%02i)&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;id
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;lun
)paren
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_READY
suffix:semicolon
singleline_comment|//DC390_write8 (ScsiCmd, CLEAR_FIFO_CMD);
id|pACB-&gt;SelLost
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|cmd
)paren
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
id|pDCB
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
id|pACB-&gt;Connected
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|SCSI_NOP1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//#define DMA_INT EN_DMA_INT /*| EN_PAGE_INT*/
DECL|macro|DMA_INT
mdefine_line|#define DMA_INT 0
macro_line|#if DMA_INT
multiline_comment|/* This is similar to AM53C974.c ... */
r_static
id|u8
DECL|function|dc390_dma_intr
id|dc390_dma_intr
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
(brace
r_struct
id|dc390_srb
op_star
id|pSRB
suffix:semicolon
id|u8
id|dstate
suffix:semicolon
id|DEBUG0
c_func
(paren
id|u16
id|pstate
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pACB-&gt;pdev
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
op_amp
id|pstate
)paren
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
r_if
(paren
id|pstate
op_amp
(paren
id|PCI_STATUS_SIG_SYSTEM_ERROR
op_or
id|PCI_STATUS_DETECTED_PARITY
)paren
)paren
"&bslash;"
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;DC390: PCI state = %04x!&bslash;n&quot;
comma
id|pstate
)paren
suffix:semicolon
"&bslash;"
id|pci_write_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
(paren
id|PCI_STATUS_SIG_SYSTEM_ERROR
op_or
id|PCI_STATUS_DETECTED_PARITY
)paren
)paren
suffix:semicolon
)brace
)paren
suffix:semicolon
id|dstate
op_assign
id|DC390_read8
(paren
id|DMA_Status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;pActiveDCB
op_logical_or
op_logical_neg
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
)paren
r_return
id|dstate
suffix:semicolon
r_else
id|pSRB
op_assign
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
id|dstate
op_amp
(paren
id|DMA_XFER_ABORT
op_or
id|DMA_XFER_ERROR
op_or
id|POWER_DOWN
op_or
id|PCI_MS_ABORT
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: DMA error (%02x)!&bslash;n&quot;
comma
id|dstate
)paren
suffix:semicolon
r_return
id|dstate
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dstate
op_amp
id|DMA_XFER_DONE
)paren
(brace
id|u32
id|residual
comma
id|xferCnt
suffix:semicolon
r_int
id|ctr
op_assign
l_int|6000000
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC390_read8
(paren
id|DMA_Cmd
)paren
op_amp
id|READ_DIRECTION
)paren
)paren
(brace
r_do
(brace
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DC390: read residual bytes ... &bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dstate
op_assign
id|DC390_read8
(paren
id|DMA_Status
)paren
suffix:semicolon
id|residual
op_assign
id|DC390_read8
(paren
id|CtcReg_Low
)paren
op_or
id|DC390_read8
(paren
id|CtcReg_Mid
)paren
op_lshift
l_int|8
op_or
id|DC390_read8
(paren
id|CtcReg_High
)paren
op_lshift
l_int|16
suffix:semicolon
id|residual
op_add_assign
id|DC390_read8
(paren
id|Current_Fifo
)paren
op_amp
l_int|0x1f
suffix:semicolon
)brace
r_while
c_loop
(paren
id|residual
op_logical_and
op_logical_neg
(paren
id|dstate
op_amp
id|SCSI_INTERRUPT
)paren
op_logical_and
op_decrement
id|ctr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctr
)paren
id|printk
(paren
id|KERN_CRIT
l_string|&quot;DC390: dma_intr: DMA aborted unfinished: %06x bytes remain!!&bslash;n&quot;
comma
id|DC390_read32
(paren
id|DMA_Wk_ByteCntr
)paren
)paren
suffix:semicolon
multiline_comment|/* residual =  ... */
)brace
r_else
id|residual
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ??? */
id|xferCnt
op_assign
id|pSRB-&gt;SGToBeXferLen
op_minus
id|residual
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
id|residual
suffix:semicolon
macro_line|# ifdef DC390_DEBUG0
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: DMA: residual = %i, xfer = %i&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|residual
comma
(paren
r_int
r_int
)paren
id|xferCnt
)paren
suffix:semicolon
macro_line|# endif
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
)paren
suffix:semicolon
)brace
id|dc390_laststatus
op_and_assign
op_complement
l_int|0xff000000
suffix:semicolon
id|dc390_laststatus
op_or_assign
id|dstate
op_lshift
l_int|24
suffix:semicolon
r_return
id|dstate
suffix:semicolon
)brace
macro_line|#endif
r_static
r_void
id|__inline__
DECL|function|dc390_InvalidCmd
id|dc390_InvalidCmd
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
(brace
r_if
c_cond
(paren
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB-&gt;SRBState
op_amp
(paren
id|SRB_START_
op_or
id|SRB_MSGOUT
)paren
)paren
id|DC390_write8
c_func
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
)brace
r_static
id|irqreturn_t
id|__inline__
DECL|function|DC390_Interrupt
id|DC390_Interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pDCB
suffix:semicolon
r_struct
id|dc390_srb
op_star
id|pSRB
suffix:semicolon
id|u8
id|sstatus
op_assign
l_int|0
suffix:semicolon
id|u8
id|phase
suffix:semicolon
r_void
(paren
op_star
id|stateV
)paren
(paren
r_struct
id|dc390_acb
op_star
comma
r_struct
id|dc390_srb
op_star
comma
id|u8
op_star
)paren
suffix:semicolon
id|u8
id|istate
comma
id|istatus
suffix:semicolon
macro_line|#if DMA_INT
id|u8
id|dstatus
suffix:semicolon
macro_line|#endif
id|sstatus
op_assign
id|DC390_read8
(paren
id|Scsi_Status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sstatus
op_amp
id|INTERRUPT
)paren
)paren
(brace
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;sstatus=%02x,&quot;
comma
id|sstatus
)paren
)paren
suffix:semicolon
macro_line|#if DMA_INT
id|spin_lock_irq
c_func
(paren
id|pACB-&gt;pScsiHost-&gt;host_lock
)paren
suffix:semicolon
id|dstatus
op_assign
id|dc390_dma_intr
(paren
id|pACB
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|pACB-&gt;pScsiHost-&gt;host_lock
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;dstatus=%02x,&quot;
comma
id|dstatus
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dstatus
op_amp
id|SCSI_INTERRUPT
)paren
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;DC390 Int w/o SCSI actions (only DMA?)&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
macro_line|#else
singleline_comment|//DC390_write32 (DMA_ScsiBusCtrl, WRT_ERASE_DMA_STAT | EN_INT_ON_PCI_ABORT);
singleline_comment|//dstatus = DC390_read8 (DMA_Status);
singleline_comment|//DC390_write32 (DMA_ScsiBusCtrl, EN_INT_ON_PCI_ABORT);
macro_line|#endif
id|spin_lock_irq
c_func
(paren
id|pACB-&gt;pScsiHost-&gt;host_lock
)paren
suffix:semicolon
id|istate
op_assign
id|DC390_read8
(paren
id|Intern_State
)paren
suffix:semicolon
id|istatus
op_assign
id|DC390_read8
(paren
id|INT_Status
)paren
suffix:semicolon
multiline_comment|/* This clears Scsi_Status, Intern_State and INT_Status ! */
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;Istatus(Res,Inv,Dis,Serv,Succ,ReS,SelA,Sel)=%02x,&quot;
comma
id|istatus
)paren
)paren
suffix:semicolon
id|dc390_laststatus
op_and_assign
op_complement
l_int|0x00ffffff
suffix:semicolon
id|dc390_laststatus
op_or_assign
multiline_comment|/* dstatus&lt;&lt;24 | */
id|sstatus
op_lshift
l_int|16
op_or
id|istate
op_lshift
l_int|8
op_or
id|istatus
suffix:semicolon
r_if
c_cond
(paren
id|sstatus
op_amp
id|ILLEGAL_OP_ERR
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: Illegal Operation detected (%08x)!&bslash;n&quot;
comma
id|dc390_laststatus
)paren
suffix:semicolon
id|dc390_dumpinfo
(paren
id|pACB
comma
id|pACB-&gt;pActiveDCB
comma
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|istatus
op_amp
id|INVALID_CMD
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: Invalid Command detected (%08x)!&bslash;n&quot;
comma
id|dc390_laststatus
)paren
suffix:semicolon
id|dc390_InvalidCmd
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istatus
op_amp
id|SCSI_RESET
)paren
(brace
id|dc390_ScsiRstDetect
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istatus
op_amp
id|DISCONNECTED
)paren
(brace
id|dc390_Disconnect
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istatus
op_amp
id|RESELECTED
)paren
(brace
id|dc390_Reselect
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|istatus
op_amp
(paren
id|SELECTED
op_or
id|SEL_ATTENTION
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Target mode not supported!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istatus
op_amp
(paren
id|SUCCESSFUL_OP
op_or
id|SERVICE_REQUEST
)paren
)paren
(brace
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Suc. op/ Serv. req: pActiveDCB = 0!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DCBFlag
op_amp
id|ABORT_DEV_
)paren
(brace
id|dc390_EnableMsgOut_Abort
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
id|phase
op_assign
id|pSRB-&gt;ScsiPhase
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: [%i]%s(0) (%02x)&bslash;n&quot;
comma
id|phase
comma
id|dc390_p0_str
(braket
id|phase
)braket
comma
id|sstatus
)paren
)paren
suffix:semicolon
id|stateV
op_assign
(paren
r_void
op_star
)paren
id|dc390_phase0
(braket
id|phase
)braket
suffix:semicolon
(paren
op_star
id|stateV
)paren
(paren
id|pACB
comma
id|pSRB
comma
op_amp
id|sstatus
)paren
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|sstatus
op_amp
l_int|7
suffix:semicolon
id|phase
op_assign
(paren
id|u8
)paren
id|sstatus
op_amp
l_int|7
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: [%i]%s(1) (%02x)&bslash;n&quot;
comma
id|phase
comma
id|dc390_p1_str
(braket
id|phase
)braket
comma
id|sstatus
)paren
)paren
suffix:semicolon
id|stateV
op_assign
(paren
r_void
op_star
)paren
id|dc390_phase1
(braket
id|phase
)braket
suffix:semicolon
(paren
op_star
id|stateV
)paren
(paren
id|pACB
comma
id|pSRB
comma
op_amp
id|sstatus
)paren
suffix:semicolon
)brace
id|unlock
suffix:colon
id|spin_unlock_irq
c_func
(paren
id|pACB-&gt;pScsiHost-&gt;host_lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|do_DC390_Interrupt
r_static
id|irqreturn_t
id|do_DC390_Interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|irqreturn_t
id|ret
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Irq (%i) caught: &quot;
comma
id|irq
)paren
)paren
suffix:semicolon
multiline_comment|/* Locking is done in DC390_Interrupt */
id|ret
op_assign
id|DC390_Interrupt
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
l_string|&quot;.. IRQ returned&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_DataOut_0
id|dc390_DataOut_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
id|u8
id|sstatus
suffix:semicolon
r_struct
id|scatterlist
op_star
id|psgl
suffix:semicolon
id|u32
id|ResidCnt
comma
id|xferCnt
suffix:semicolon
id|u8
id|dstate
op_assign
l_int|0
suffix:semicolon
id|sstatus
op_assign
op_star
id|psstatus
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_XFERPAD
)paren
)paren
(brace
r_if
c_cond
(paren
id|sstatus
op_amp
(paren
id|PARITY_ERR
op_or
id|ILLEGAL_OP_ERR
)paren
)paren
(brace
id|pSRB-&gt;SRBStatus
op_or_assign
id|PARITY_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sstatus
op_amp
id|COUNT_2_ZERO
)paren
(brace
r_int
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
multiline_comment|/* Function called from the ISR with the host_lock held and interrupts disabled */
r_if
c_cond
(paren
id|pSRB-&gt;SGToBeXferLen
)paren
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
op_logical_and
op_logical_neg
(paren
(paren
id|dstate
op_assign
id|DC390_read8
(paren
id|DMA_Status
)paren
)paren
op_amp
id|DMA_XFER_DONE
)paren
)paren
(brace
id|spin_unlock_irq
c_func
(paren
id|pACB-&gt;pScsiHost-&gt;host_lock
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|pACB-&gt;pScsiHost-&gt;host_lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
id|printk
(paren
id|KERN_CRIT
l_string|&quot;DC390: Deadlock in DataOut_0: DMA aborted unfinished: %06x bytes remain!!&bslash;n&quot;
comma
id|DC390_read32
(paren
id|DMA_Wk_ByteCntr
)paren
)paren
suffix:semicolon
id|dc390_laststatus
op_and_assign
op_complement
l_int|0xff000000
suffix:semicolon
id|dc390_laststatus
op_or_assign
id|dstate
op_lshift
l_int|24
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_add_assign
id|pSRB-&gt;SGToBeXferLen
suffix:semicolon
id|pSRB-&gt;SGIndex
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SGIndex
OL
id|pSRB-&gt;SGcount
)paren
(brace
id|pSRB-&gt;pSegmentList
op_increment
suffix:semicolon
id|psgl
op_assign
id|pSRB-&gt;pSegmentList
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|psgl
)paren
)paren
)paren
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|psgl
)paren
)paren
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ResidCnt
op_assign
(paren
id|u32
)paren
id|DC390_read8
(paren
id|Current_Fifo
)paren
op_amp
l_int|0x1f
suffix:semicolon
id|ResidCnt
op_or_assign
(paren
id|u32
)paren
id|DC390_read8
(paren
id|CtcReg_High
)paren
op_lshift
l_int|16
suffix:semicolon
id|ResidCnt
op_or_assign
(paren
id|u32
)paren
id|DC390_read8
(paren
id|CtcReg_Mid
)paren
op_lshift
l_int|8
suffix:semicolon
id|ResidCnt
op_add_assign
(paren
id|u32
)paren
id|DC390_read8
(paren
id|CtcReg_Low
)paren
suffix:semicolon
id|xferCnt
op_assign
id|pSRB-&gt;SGToBeXferLen
op_minus
id|ResidCnt
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
id|ResidCnt
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
op_star
id|psstatus
op_amp
l_int|7
)paren
op_ne
id|SCSI_DATA_OUT
)paren
(brace
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|WRITE_DIRECTION
op_plus
id|DMA_IDLE_CMD
)paren
suffix:semicolon
multiline_comment|/* | DMA_INT */
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|dc390_DataIn_0
id|dc390_DataIn_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
id|u8
id|sstatus
comma
id|residual
comma
id|bval
suffix:semicolon
r_struct
id|scatterlist
op_star
id|psgl
suffix:semicolon
id|u32
id|ResidCnt
comma
id|i
suffix:semicolon
r_int
r_int
id|xferCnt
suffix:semicolon
id|u8
op_star
id|ptr
suffix:semicolon
id|sstatus
op_assign
op_star
id|psstatus
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_XFERPAD
)paren
)paren
(brace
r_if
c_cond
(paren
id|sstatus
op_amp
(paren
id|PARITY_ERR
op_or
id|ILLEGAL_OP_ERR
)paren
)paren
(brace
id|pSRB-&gt;SRBStatus
op_or_assign
id|PARITY_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sstatus
op_amp
id|COUNT_2_ZERO
)paren
(brace
r_int
id|dstate
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|timeout
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
multiline_comment|/* Function called from the ISR with the host_lock held and interrupts disabled */
r_if
c_cond
(paren
id|pSRB-&gt;SGToBeXferLen
)paren
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
op_logical_and
op_logical_neg
(paren
(paren
id|dstate
op_assign
id|DC390_read8
(paren
id|DMA_Status
)paren
)paren
op_amp
id|DMA_XFER_DONE
)paren
)paren
(brace
id|spin_unlock_irq
c_func
(paren
id|pACB-&gt;pScsiHost-&gt;host_lock
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|pACB-&gt;pScsiHost-&gt;host_lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|time_before
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|printk
(paren
id|KERN_CRIT
l_string|&quot;DC390: Deadlock in DataIn_0: DMA aborted unfinished: %06x bytes remain!!&bslash;n&quot;
comma
id|DC390_read32
(paren
id|DMA_Wk_ByteCntr
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_CRIT
l_string|&quot;DC390: DataIn_0: DMA State: %i&bslash;n&quot;
comma
id|dstate
)paren
suffix:semicolon
)brace
id|dc390_laststatus
op_and_assign
op_complement
l_int|0xff000000
suffix:semicolon
id|dc390_laststatus
op_or_assign
id|dstate
op_lshift
l_int|24
suffix:semicolon
id|DEBUG1
c_func
(paren
id|ResidCnt
op_assign
(paren
(paren
r_int
r_int
)paren
id|DC390_read8
(paren
id|CtcReg_High
)paren
op_lshift
l_int|16
)paren
"&bslash;"
op_plus
(paren
(paren
r_int
r_int
)paren
id|DC390_read8
(paren
id|CtcReg_Mid
)paren
op_lshift
l_int|8
)paren
"&bslash;"
op_plus
(paren
(paren
r_int
r_int
)paren
id|DC390_read8
(paren
id|CtcReg_Low
)paren
)paren
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Count_2_Zero (ResidCnt=%i,ToBeXfer=%li),&quot;
comma
id|ResidCnt
comma
id|pSRB-&gt;SGToBeXferLen
)paren
)paren
suffix:semicolon
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|READ_DIRECTION
op_plus
id|DMA_IDLE_CMD
)paren
suffix:semicolon
multiline_comment|/* | DMA_INT */
id|pSRB-&gt;TotalXferredLen
op_add_assign
id|pSRB-&gt;SGToBeXferLen
suffix:semicolon
id|pSRB-&gt;SGIndex
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SGIndex
OL
id|pSRB-&gt;SGcount
)paren
(brace
id|pSRB-&gt;pSegmentList
op_increment
suffix:semicolon
id|psgl
op_assign
id|pSRB-&gt;pSegmentList
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|psgl
)paren
)paren
)paren
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|psgl
)paren
)paren
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
)brace
r_else
multiline_comment|/* phase changed */
(brace
id|residual
op_assign
l_int|0
suffix:semicolon
id|bval
op_assign
id|DC390_read8
(paren
id|Current_Fifo
)paren
suffix:semicolon
r_while
c_loop
(paren
id|bval
op_amp
l_int|0x1f
)paren
(brace
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Check for residuals,&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bval
op_amp
l_int|0x1f
)paren
op_eq
l_int|1
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bval
op_assign
id|DC390_read8
(paren
id|Current_Fifo
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
l_int|0x1f
)paren
)paren
(brace
r_goto
id|din_1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i
op_eq
l_int|0x0ff
)paren
(brace
id|residual
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ;1 residual byte */
r_goto
id|din_1
suffix:semicolon
)brace
)brace
)brace
r_else
id|bval
op_assign
id|DC390_read8
(paren
id|Current_Fifo
)paren
suffix:semicolon
)brace
id|din_1
suffix:colon
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|READ_DIRECTION
op_plus
id|DMA_BLAST_CMD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0xa000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|bval
op_assign
id|DC390_read8
(paren
id|DMA_Status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_amp
id|BLAST_COMPLETE
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* It seems a DMA Blast abort isn&squot;t that bad ... */
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: DMA Blast aborted unfinished!&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (DMA_Cmd, READ_DIRECTION+DMA_IDLE_CMD); /* | DMA_INT */
id|dc390_laststatus
op_and_assign
op_complement
l_int|0xff000000
suffix:semicolon
id|dc390_laststatus
op_or_assign
id|bval
op_lshift
l_int|24
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Blast: Read %i times DMA_Status %02x&quot;
comma
l_int|0xa000
op_minus
id|i
comma
id|bval
)paren
)paren
suffix:semicolon
id|ResidCnt
op_assign
(paren
id|u32
)paren
id|DC390_read8
(paren
id|CtcReg_High
)paren
suffix:semicolon
id|ResidCnt
op_lshift_assign
l_int|8
suffix:semicolon
id|ResidCnt
op_or_assign
(paren
id|u32
)paren
id|DC390_read8
(paren
id|CtcReg_Mid
)paren
suffix:semicolon
id|ResidCnt
op_lshift_assign
l_int|8
suffix:semicolon
id|ResidCnt
op_or_assign
(paren
id|u32
)paren
id|DC390_read8
(paren
id|CtcReg_Low
)paren
suffix:semicolon
id|xferCnt
op_assign
id|pSRB-&gt;SGToBeXferLen
op_minus
id|ResidCnt
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_add_assign
id|xferCnt
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
id|ResidCnt
suffix:semicolon
r_if
c_cond
(paren
id|residual
)paren
(brace
id|bval
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
multiline_comment|/* get one residual byte */
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|bus_to_virt
c_func
(paren
id|pSRB-&gt;SGBusAddr
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|bval
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_increment
suffix:semicolon
id|xferCnt
op_increment
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_increment
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_decrement
suffix:semicolon
)brace
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Xfered: %li, Total: %li, Remaining: %li&bslash;n&quot;
comma
id|xferCnt
comma
"&bslash;"
id|pSRB-&gt;TotalXferredLen
comma
id|pSRB-&gt;SGToBeXferLen
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
op_star
id|psstatus
op_amp
l_int|7
)paren
op_ne
id|SCSI_DATA_IN
)paren
(brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|READ_DIRECTION
op_plus
id|DMA_IDLE_CMD
)paren
suffix:semicolon
multiline_comment|/* | DMA_INT */
)brace
)brace
r_static
r_void
DECL|function|dc390_Command_0
id|dc390_Command_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
)brace
r_static
r_void
DECL|function|dc390_Status_0
id|dc390_Status_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
id|pSRB-&gt;TargetStatus
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
singleline_comment|//udelay (1);
id|pSRB-&gt;EndMessage
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
multiline_comment|/* get message */
op_star
id|psstatus
op_assign
id|SCSI_NOP0
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_COMPLETED
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|MSG_ACCEPTED_CMD
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_MsgOut_0
id|dc390_MsgOut_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
(paren
id|SRB_UNEXPECT_RESEL
op_plus
id|SRB_ABORT_SENT
)paren
)paren
(brace
op_star
id|psstatus
op_assign
id|SCSI_NOP0
suffix:semicolon
)brace
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD);
)brace
r_static
r_void
id|__inline__
DECL|function|dc390_reprog
id|dc390_reprog
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
)paren
(brace
id|DC390_write8
(paren
id|Sync_Period
comma
id|pDCB-&gt;SyncPeriod
)paren
suffix:semicolon
id|DC390_write8
(paren
id|Sync_Offset
comma
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg3
comma
id|pDCB-&gt;CtrlR3
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg4
comma
id|pDCB-&gt;CtrlR4
)paren
suffix:semicolon
id|dc390_SetXferRate
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
macro_line|#ifdef DC390_DEBUG0
r_static
r_void
DECL|function|dc390_printMsg
id|dc390_printMsg
(paren
id|u8
op_star
id|MsgBuf
comma
id|u8
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
(paren
l_string|&quot; %02x&quot;
comma
id|MsgBuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
l_string|&quot; %02x&quot;
comma
id|MsgBuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|macro|DC390_ENABLE_MSGOUT
mdefine_line|#define DC390_ENABLE_MSGOUT DC390_write8 (ScsiCmd, SET_ATN_CMD)
multiline_comment|/* reject_msg */
r_static
r_void
id|__inline__
DECL|function|dc390_MsgIn_reject
id|dc390_MsgIn_reject
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|MESSAGE_REJECT
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|1
suffix:semicolon
id|DC390_ENABLE_MSGOUT
suffix:semicolon
id|DEBUG0
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Reject message&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* abort command */
r_static
r_void
DECL|function|dc390_EnableMsgOut_Abort
id|dc390_EnableMsgOut_Abort
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|ABORT
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|1
suffix:semicolon
id|DC390_ENABLE_MSGOUT
suffix:semicolon
id|pSRB-&gt;pSRBDCB-&gt;DCBFlag
op_and_assign
op_complement
id|ABORT_DEV_
suffix:semicolon
)brace
r_static
r_struct
id|dc390_srb
op_star
DECL|function|dc390_MsgIn_QTag
id|dc390_MsgIn_QTag
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
id|s8
id|tag
)paren
(brace
r_struct
id|dc390_srb
op_star
id|lastSRB
op_assign
id|pDCB-&gt;pGoingLast
suffix:semicolon
r_struct
id|dc390_srb
op_star
id|pSRB
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|pSRB
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;TagNumber
op_eq
id|tag
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|lastSRB
)paren
r_goto
id|mingx0
suffix:semicolon
id|pSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pDCB-&gt;DCBFlag
op_amp
id|ABORT_DEV_
)paren
(brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_ABORT_SENT
suffix:semicolon
id|dc390_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DISCONNECT
)paren
)paren
(brace
r_goto
id|mingx0
suffix:semicolon
)brace
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_DATA_XFER
suffix:semicolon
)brace
r_else
(brace
id|mingx0
suffix:colon
id|pSRB
op_assign
id|pACB-&gt;pTmpSRB
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_UNEXPECT_RESEL
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|ABORT_TAG
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|1
suffix:semicolon
id|DC390_ENABLE_MSGOUT
suffix:semicolon
)brace
r_return
id|pSRB
suffix:semicolon
)brace
multiline_comment|/* set async transfer mode */
r_static
r_void
DECL|function|dc390_MsgIn_set_async
id|dc390_MsgIn_set_async
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|DO_SYNC_NEGO
)paren
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Target %i initiates Non-Sync?&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|DO_SYNC_NEGO
suffix:semicolon
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
(paren
id|SYNC_ENABLE
op_plus
id|SYNC_NEGO_DONE
)paren
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
singleline_comment|//pDCB-&gt;NegoPeriod = 50; /* 200ns &lt;=&gt; 5 MHz */
id|pDCB-&gt;CtrlR3
op_assign
id|FAST_CLK
suffix:semicolon
multiline_comment|/* fast clock / normal scsi */
id|pDCB-&gt;CtrlR4
op_and_assign
l_int|0x3f
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_or_assign
id|pACB-&gt;glitch_cfg
suffix:semicolon
multiline_comment|/* glitch eater */
id|dc390_reprog
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
multiline_comment|/* set sync transfer mode */
r_static
r_void
DECL|function|dc390_MsgIn_set_sync
id|dc390_MsgIn_set_sync
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|u8
id|bval
suffix:semicolon
id|u16
id|wval
comma
id|wval1
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
id|u8
id|oldsyncperiod
op_assign
id|pDCB-&gt;SyncPeriod
suffix:semicolon
id|u8
id|oldsyncoffset
op_assign
id|pDCB-&gt;SyncOffset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|DO_SYNC_NEGO
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Target %i initiates Sync: %ins %i ... answer ...&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
op_lshift
l_int|2
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
)paren
suffix:semicolon
multiline_comment|/* reject */
singleline_comment|//dc390_MsgIn_reject (pACB, pSRB);
singleline_comment|//return dc390_MsgIn_set_async (pACB, pSRB);
multiline_comment|/* Reply with corrected SDTR Message */
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
OG
l_int|15
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Lower Sync Offset to 15&bslash;n&quot;
)paren
suffix:semicolon
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
op_assign
l_int|15
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
OL
id|pDCB-&gt;NegoPeriod
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Set sync nego period to %ins&bslash;n&quot;
comma
id|pDCB-&gt;NegoPeriod
op_lshift
l_int|2
)paren
suffix:semicolon
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
op_assign
id|pDCB-&gt;NegoPeriod
suffix:semicolon
)brace
id|memcpy
(paren
id|pSRB-&gt;MsgOutBuf
comma
id|pSRB-&gt;MsgInBuf
comma
l_int|5
)paren
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|5
suffix:semicolon
id|DC390_ENABLE_MSGOUT
suffix:semicolon
)brace
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|DO_SYNC_NEGO
suffix:semicolon
id|pDCB-&gt;SyncMode
op_or_assign
id|SYNC_ENABLE
op_plus
id|SYNC_NEGO_DONE
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_and_assign
l_int|0x0f0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_or_assign
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
suffix:semicolon
id|wval
op_assign
(paren
id|u16
)paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
suffix:semicolon
id|wval
op_assign
id|wval
op_lshift
l_int|2
suffix:semicolon
id|wval
op_sub_assign
l_int|3
suffix:semicolon
id|wval1
op_assign
id|wval
op_div
l_int|25
suffix:semicolon
multiline_comment|/* compute speed */
r_if
c_cond
(paren
(paren
id|wval1
op_star
l_int|25
)paren
op_ne
id|wval
)paren
(brace
id|wval1
op_increment
suffix:semicolon
)brace
id|bval
op_assign
id|FAST_CLK
op_plus
id|FAST_SCSI
suffix:semicolon
multiline_comment|/* fast clock / fast scsi */
id|pDCB-&gt;CtrlR4
op_and_assign
l_int|0x3f
suffix:semicolon
multiline_comment|/* Glitch eater: 12ns less than normal */
r_if
c_cond
(paren
id|pACB-&gt;glitch_cfg
op_ne
id|NS_TO_GLITCH
c_func
(paren
l_int|0
)paren
)paren
id|pDCB-&gt;CtrlR4
op_or_assign
id|NS_TO_GLITCH
c_func
(paren
(paren
(paren
id|GLITCH_TO_NS
c_func
(paren
id|pACB-&gt;glitch_cfg
)paren
)paren
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_else
id|pDCB-&gt;CtrlR4
op_or_assign
id|NS_TO_GLITCH
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wval1
OL
l_int|4
)paren
id|pDCB-&gt;CtrlR4
op_or_assign
id|NS_TO_GLITCH
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Ultra */
r_if
c_cond
(paren
id|wval1
op_ge
l_int|8
)paren
(brace
id|wval1
op_decrement
suffix:semicolon
multiline_comment|/* Timing computation differs by 1 from FAST_SCSI */
id|bval
op_assign
id|FAST_CLK
suffix:semicolon
multiline_comment|/* fast clock / normal scsi */
id|pDCB-&gt;CtrlR4
op_or_assign
id|pACB-&gt;glitch_cfg
suffix:semicolon
multiline_comment|/* glitch eater */
)brace
id|pDCB-&gt;CtrlR3
op_assign
id|bval
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
(paren
id|u8
)paren
id|wval1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|oldsyncperiod
op_ne
id|wval1
op_logical_or
id|oldsyncoffset
op_ne
id|pDCB-&gt;SyncOffset
)paren
op_logical_and
id|pDCB-&gt;TargetLUN
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
id|FAST_SCSI
)paren
)paren
id|wval1
op_increment
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Target %i: Sync transfer %i.%1i MHz, Offset %i&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
l_int|40
op_div
id|wval1
comma
(paren
(paren
l_int|40
op_mod
id|wval1
)paren
op_star
l_int|10
op_plus
id|wval1
op_div
l_int|2
)paren
op_div
id|wval1
comma
id|pDCB-&gt;SyncOffset
op_amp
l_int|0x0f
)paren
suffix:semicolon
)brace
id|dc390_reprog
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
multiline_comment|/* handle RESTORE_PTR */
multiline_comment|/* I presume, this command is already mapped, so, have to remap. */
r_static
r_void
DECL|function|dc390_restore_ptr
id|dc390_restore_ptr
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
r_struct
id|scatterlist
op_star
id|psgl
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGIndex
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
(brace
id|pSRB-&gt;pSegmentList
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
id|psgl
op_assign
id|pSRB-&gt;pSegmentList
suffix:semicolon
singleline_comment|//dc390_pci_sync(pSRB);
r_while
c_loop
(paren
id|pSRB-&gt;TotalXferredLen
op_plus
(paren
r_int
r_int
)paren
id|sg_dma_len
c_func
(paren
id|psgl
)paren
OL
id|pSRB-&gt;Saved_Ptr
)paren
(brace
id|pSRB-&gt;TotalXferredLen
op_add_assign
(paren
r_int
r_int
)paren
id|sg_dma_len
c_func
(paren
id|psgl
)paren
suffix:semicolon
id|pSRB-&gt;SGIndex
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SGIndex
OL
id|pSRB-&gt;SGcount
)paren
(brace
id|pSRB-&gt;pSegmentList
op_increment
suffix:semicolon
id|psgl
op_assign
id|pSRB-&gt;pSegmentList
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|psgl
)paren
)paren
)paren
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|psgl
)paren
)paren
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
)brace
id|pSRB-&gt;SGToBeXferLen
op_sub_assign
(paren
id|pSRB-&gt;Saved_Ptr
op_minus
id|pSRB-&gt;TotalXferredLen
)paren
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_add_assign
(paren
id|pSRB-&gt;Saved_Ptr
op_minus
id|pSRB-&gt;TotalXferredLen
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Pointer restored. Segment %i, Total %li, Bus %08lx&bslash;n&quot;
comma
id|pSRB-&gt;SGIndex
comma
id|pSRB-&gt;Saved_Ptr
comma
id|pSRB-&gt;SGBusAddr
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
)paren
(brace
singleline_comment|//dc390_pci_sync(pSRB);
id|sg_dma_len
c_func
(paren
op_amp
id|pSRB-&gt;Segmentx
)paren
op_assign
id|pcmd-&gt;request_bufflen
op_minus
id|pSRB-&gt;Saved_Ptr
suffix:semicolon
id|pSRB-&gt;SGcount
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;pSegmentList
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
op_amp
id|pSRB-&gt;Segmentx
suffix:semicolon
)brace
r_else
(brace
id|pSRB-&gt;SGcount
op_assign
l_int|0
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: RESTORE_PTR message for Transfer without Scatter-Gather ??&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pSRB-&gt;TotalXferredLen
op_assign
id|pSRB-&gt;Saved_Ptr
suffix:semicolon
)brace
multiline_comment|/* According to the docs, the AM53C974 reads the message and &n; * generates a Successful Operation IRQ before asserting ACK for&n; * the last byte (how does it know whether it&squot;s the last ?) */
multiline_comment|/* The old code handled it in another way, indicating, that on&n; * every message byte an IRQ is generated and every byte has to&n; * be manually ACKed. Hmmm ?  (KG, 98/11/28) */
multiline_comment|/* The old implementation was correct. Sigh! */
multiline_comment|/* Check if the message is complete */
r_static
id|u8
id|__inline__
DECL|function|dc390_MsgIn_complete
id|dc390_MsgIn_complete
(paren
id|u8
op_star
id|msgbuf
comma
id|u32
id|len
)paren
(brace
r_if
c_cond
(paren
op_star
id|msgbuf
op_eq
id|EXTENDED_MESSAGE
)paren
(brace
r_if
c_cond
(paren
id|len
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|msgbuf
(braket
l_int|1
)braket
op_plus
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|msgbuf
op_ge
l_int|0x20
op_logical_and
op_star
id|msgbuf
op_le
l_int|0x2f
)paren
singleline_comment|// two byte messages
r_if
c_cond
(paren
id|len
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* read and eval received messages */
r_static
r_void
DECL|function|dc390_MsgIn_0
id|dc390_MsgIn_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
multiline_comment|/* Read the msg */
id|pSRB-&gt;MsgInBuf
(braket
id|pACB-&gt;MsgLen
op_increment
)braket
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
singleline_comment|//pSRB-&gt;SRBState = 0;
multiline_comment|/* Msg complete ? */
r_if
c_cond
(paren
id|dc390_MsgIn_complete
(paren
id|pSRB-&gt;MsgInBuf
comma
id|pACB-&gt;MsgLen
)paren
)paren
(brace
id|DEBUG0
(paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: MsgIn:&quot;
)paren
suffix:semicolon
id|dc390_printMsg
(paren
id|pSRB-&gt;MsgInBuf
comma
id|pACB-&gt;MsgLen
)paren
)paren
suffix:semicolon
multiline_comment|/* Now eval the msg */
r_switch
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|0
)braket
)paren
(brace
r_case
id|DISCONNECT
suffix:colon
id|pSRB-&gt;SRBState
op_assign
id|SRB_DISCONNECT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIMPLE_QUEUE_TAG
suffix:colon
r_case
id|HEAD_OF_QUEUE_TAG
suffix:colon
r_case
id|ORDERED_QUEUE_TAG
suffix:colon
id|pSRB
op_assign
id|dc390_MsgIn_QTag
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MESSAGE_REJECT
suffix:colon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|RESET_ATN_CMD
)paren
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
l_int|50
suffix:semicolon
multiline_comment|/* 200ns &lt;=&gt; 5 MHz */
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|DO_SYNC_NEGO
)paren
(brace
id|dc390_MsgIn_set_async
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
multiline_comment|/* reject every extended msg but SDTR */
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|1
)braket
op_ne
l_int|3
op_logical_or
id|pSRB-&gt;MsgInBuf
(braket
l_int|2
)braket
op_ne
id|EXTENDED_SDTR
)paren
id|dc390_MsgIn_reject
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
op_eq
l_int|0
op_logical_or
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
op_eq
l_int|0
)paren
id|dc390_MsgIn_set_async
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_else
id|dc390_MsgIn_set_sync
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
singleline_comment|// nothing has to be done
r_case
id|COMMAND_COMPLETE
suffix:colon
r_break
suffix:semicolon
singleline_comment|// SAVE POINTER may be ignored as we have the struct dc390_srb* associated with the
singleline_comment|// scsi command. Thanks, Gerard, for pointing it out.
r_case
id|SAVE_POINTERS
suffix:colon
id|pSRB-&gt;Saved_Ptr
op_assign
id|pSRB-&gt;TotalXferredLen
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// The device might want to restart transfer with a RESTORE
r_case
id|RESTORE_POINTERS
suffix:colon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: RESTORE POINTER message received ... try to handle&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dc390_restore_ptr
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// reject unknown messages
r_default
suffix:colon
id|dc390_MsgIn_reject
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear counter and MsgIn state */
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_MSGIN
suffix:semicolon
id|pACB-&gt;MsgLen
op_assign
l_int|0
suffix:semicolon
)brace
op_star
id|psstatus
op_assign
id|SCSI_NOP0
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|MSG_ACCEPTED_CMD
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD);
)brace
r_static
r_void
DECL|function|dc390_DataIO_Comm
id|dc390_DataIO_Comm
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
id|ioDir
)paren
(brace
r_struct
id|scatterlist
op_star
id|psgl
suffix:semicolon
r_int
r_int
id|lval
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pACB-&gt;pTmpSRB
)paren
(brace
r_if
c_cond
(paren
id|pDCB
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DC390: pSRB == pTmpSRB! (TagQ Error?) (%02i-%i)&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DC390: pSRB == pTmpSRB! (TagQ Error?) (DCB 0!)&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Try to recover - some broken disks react badly to tagged INQUIRY */
r_if
c_cond
(paren
id|pDCB
op_logical_and
id|pACB-&gt;scan_devices
op_logical_and
id|pDCB-&gt;GoingSRBCnt
op_eq
l_int|1
)paren
(brace
id|pSRB
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
(brace
id|pSRB-&gt;pSRBDCB
op_assign
id|pDCB
suffix:semicolon
id|dc390_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
)paren
id|pDCB-&gt;DCBFlag
op_or_assign
id|ABORT_DEV
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSRB-&gt;SGIndex
OL
id|pSRB-&gt;SGcount
)paren
(brace
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
op_or
id|ioDir
multiline_comment|/* | DMA_INT */
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB-&gt;SGToBeXferLen
)paren
(brace
id|psgl
op_assign
id|pSRB-&gt;pSegmentList
suffix:semicolon
id|pSRB-&gt;SGBusAddr
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|psgl
)paren
)paren
)paren
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|psgl
)paren
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; DC390: Next SG segment.&quot;
)paren
)paren
suffix:semicolon
)brace
id|lval
op_assign
id|pSRB-&gt;SGToBeXferLen
suffix:semicolon
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; DC390: Start transfer: %li bytes (address %08lx)&bslash;n&quot;
comma
id|lval
comma
id|pSRB-&gt;SGBusAddr
)paren
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtcReg_Low
comma
(paren
id|u8
)paren
id|lval
)paren
suffix:semicolon
id|lval
op_rshift_assign
l_int|8
suffix:semicolon
id|DC390_write8
(paren
id|CtcReg_Mid
comma
(paren
id|u8
)paren
id|lval
)paren
suffix:semicolon
id|lval
op_rshift_assign
l_int|8
suffix:semicolon
id|DC390_write8
(paren
id|CtcReg_High
comma
(paren
id|u8
)paren
id|lval
)paren
suffix:semicolon
id|DC390_write32
(paren
id|DMA_XferCnt
comma
id|pSRB-&gt;SGToBeXferLen
)paren
suffix:semicolon
id|DC390_write32
(paren
id|DMA_XferAddr
comma
id|pSRB-&gt;SGBusAddr
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD | ioDir); /* | DMA_INT; */
id|pSRB-&gt;SRBState
op_assign
id|SRB_DATA_XFER
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|DMA_COMMAND
op_plus
id|INFO_XFER_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_START_CMD
op_or
id|ioDir
op_or
id|DMA_INT
)paren
suffix:semicolon
singleline_comment|//DEBUG1(DC390_write32 (DMA_ScsiBusCtrl, WRT_ERASE_DMA_STAT | EN_INT_ON_PCI_ABORT));
singleline_comment|//DEBUG1(printk (KERN_DEBUG &quot;DC390: DMA_Status: %02x&bslash;n&quot;, DC390_read8 (DMA_Status)));
singleline_comment|//DEBUG1(DC390_write32 (DMA_ScsiBusCtrl, EN_INT_ON_PCI_ABORT));
)brace
r_else
multiline_comment|/* xfer pad */
(brace
r_if
c_cond
(paren
id|pSRB-&gt;SGcount
)paren
(brace
id|pSRB-&gt;AdaptStatus
op_assign
id|H_OVER_UNDER_RUN
suffix:semicolon
id|pSRB-&gt;SRBStatus
op_or_assign
id|OVER_RUN
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot; DC390: Overrun -&quot;
)paren
)paren
suffix:semicolon
)brace
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot; Clear transfer pad &bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtcReg_Low
comma
l_int|0
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtcReg_Mid
comma
l_int|0
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtcReg_High
comma
l_int|0
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_XFERPAD
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|DMA_COMMAND
op_plus
id|XFER_PAD_BYTE
)paren
suffix:semicolon
multiline_comment|/*&n;&t;DC390_write8 (DMA_Cmd, DMA_IDLE_CMD | ioDir); // | DMA_INT;&n;&t;DC390_write8 (DMA_Cmd, DMA_START_CMD | ioDir | DMA_INT);&n;*/
)brace
)brace
r_static
r_void
DECL|function|dc390_DataOutPhase
id|dc390_DataOutPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
id|dc390_DataIO_Comm
(paren
id|pACB
comma
id|pSRB
comma
id|WRITE_DIRECTION
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_DataInPhase
id|dc390_DataInPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
id|dc390_DataIO_Comm
(paren
id|pACB
comma
id|pSRB
comma
id|READ_DIRECTION
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_CommandPhase
id|dc390_CommandPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
suffix:semicolon
id|u8
id|i
comma
id|cnt
suffix:semicolon
id|u8
op_star
id|ptr
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|RESET_ATN_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
)paren
(brace
id|cnt
op_assign
(paren
id|u8
)paren
id|pSRB-&gt;pcmd-&gt;cmd_len
suffix:semicolon
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|pSRB-&gt;pcmd-&gt;cmnd
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DC390_write8
(paren
id|ScsiFifo
comma
op_star
(paren
id|ptr
op_increment
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|u8
id|bval
op_assign
l_int|0
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|REQUEST_SENSE
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|pDCB-&gt;TargetLUN
op_lshift
l_int|5
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|bval
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|bval
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
r_sizeof
(paren
id|pSRB-&gt;pcmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|bval
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;DC390: AutoReqSense (CmndPhase)!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_COMMAND
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|INFO_XFER_CMD
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_StatusPhase
id|dc390_StatusPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_STATUS
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|INITIATOR_CMD_CMPLTE
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD);
)brace
r_static
r_void
DECL|function|dc390_MsgOutPhase
id|dc390_MsgOutPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
id|u8
id|bval
comma
id|i
comma
id|cnt
suffix:semicolon
id|u8
op_star
id|ptr
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pDCB
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_MSGOUT
)paren
)paren
(brace
id|cnt
op_assign
id|pSRB-&gt;MsgCnt
suffix:semicolon
r_if
c_cond
(paren
id|cnt
)paren
(brace
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|pSRB-&gt;MsgOutBuf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DC390_write8
(paren
id|ScsiFifo
comma
op_star
(paren
id|ptr
op_increment
)paren
)paren
suffix:semicolon
)brace
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pDCB-&gt;DCBFlag
op_amp
id|ABORT_DEV_
)paren
op_logical_and
(paren
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_eq
id|ABORT
)paren
)paren
(brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_ABORT_SENT
suffix:semicolon
)brace
)brace
r_else
(brace
id|bval
op_assign
id|ABORT
suffix:semicolon
multiline_comment|/* ??? MSG_NOP */
r_if
c_cond
(paren
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_or
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
op_logical_or
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
)paren
(brace
r_if
c_cond
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_ENABLE
)paren
(brace
r_goto
id|mop1
suffix:semicolon
)brace
)brace
id|DC390_write8
(paren
id|ScsiFifo
comma
id|bval
)paren
suffix:semicolon
)brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|INFO_XFER_CMD
)paren
suffix:semicolon
)brace
r_else
(brace
id|mop1
suffix:colon
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: OLD Sync Nego code triggered! (%i %i)&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
id|EXTENDED_MESSAGE
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiFifo
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/*    ;length of extended msg */
id|DC390_write8
(paren
id|ScsiFifo
comma
id|EXTENDED_SDTR
)paren
suffix:semicolon
multiline_comment|/*    ; sync nego */
id|DC390_write8
(paren
id|ScsiFifo
comma
id|pDCB-&gt;NegoPeriod
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;SyncOffset
op_amp
l_int|0x0f
)paren
id|DC390_write8
(paren
id|ScsiFifo
comma
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
r_else
id|DC390_write8
(paren
id|ScsiFifo
comma
id|SYNC_NEGO_OFFSET
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|DO_SYNC_NEGO
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|INFO_XFER_CMD
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|dc390_MsgInPhase
id|dc390_MsgInPhase
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_MSGIN
)paren
)paren
(brace
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_DISCONNECT
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_MSGIN
suffix:semicolon
)brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|INFO_XFER_CMD
)paren
suffix:semicolon
singleline_comment|//DC390_write8 (DMA_Cmd, DMA_IDLE_CMD);
)brace
r_static
r_void
DECL|function|dc390_Nop_0
id|dc390_Nop_0
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
)brace
r_static
r_void
DECL|function|dc390_Nop_1
id|dc390_Nop_1
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
comma
id|u8
op_star
id|psstatus
)paren
(brace
)brace
r_static
r_void
DECL|function|dc390_SetXferRate
id|dc390_SetXferRate
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
)paren
(brace
id|u8
id|bval
comma
id|i
comma
id|cnt
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;TargetLUN
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;scan_devices
)paren
(brace
id|ptr
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|cnt
op_assign
id|pACB-&gt;DCBCnt
suffix:semicolon
id|bval
op_assign
id|pDCB-&gt;TargetID
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ptr-&gt;TargetID
op_eq
id|bval
)paren
(brace
id|ptr-&gt;SyncPeriod
op_assign
id|pDCB-&gt;SyncPeriod
suffix:semicolon
id|ptr-&gt;SyncOffset
op_assign
id|pDCB-&gt;SyncOffset
suffix:semicolon
id|ptr-&gt;CtrlR3
op_assign
id|pDCB-&gt;CtrlR3
suffix:semicolon
id|ptr-&gt;CtrlR4
op_assign
id|pDCB-&gt;CtrlR4
suffix:semicolon
id|ptr-&gt;SyncMode
op_assign
id|pDCB-&gt;SyncMode
suffix:semicolon
)brace
id|ptr
op_assign
id|ptr-&gt;pNextDCB
suffix:semicolon
)brace
)brace
)brace
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_Disconnect
id|dc390_Disconnect
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
suffix:semicolon
r_struct
id|dc390_srb
op_star
id|pSRB
comma
op_star
id|psrb
suffix:semicolon
id|u8
id|i
comma
id|cnt
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DISC,&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;Connected
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DC390: Disconnect not-connected bus?&bslash;n&quot;
)paren
suffix:semicolon
id|pACB-&gt;Connected
op_assign
l_int|0
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ACB:%p-&gt;ActiveDCB:%p IOPort:%04x IRQ:%02x !&bslash;n&quot;
comma
"&bslash;"
id|pACB
comma
id|pDCB
comma
id|pACB-&gt;IOPortBase
comma
id|pACB-&gt;IRQLevel
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|400
)paren
suffix:semicolon
id|DC390_read8
(paren
id|INT_Status
)paren
suffix:semicolon
multiline_comment|/* Reset Pending INT */
id|DC390_write8
(paren
id|ScsiCmd
comma
id|EN_SEL_RESEL
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DC390_write8
(paren
id|ScsiCmd
comma
id|EN_SEL_RESEL
)paren
suffix:semicolon
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|SCSI_NOP0
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_UNEXPECT_RESEL
)paren
(brace
id|pSRB-&gt;SRBState
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_ABORT_SENT
)paren
(brace
id|pDCB-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;DCBFlag
op_assign
l_int|0
suffix:semicolon
id|cnt
op_assign
id|pDCB-&gt;GoingSRBCnt
suffix:semicolon
id|pDCB-&gt;GoingSRBCnt
op_assign
l_int|0
suffix:semicolon
id|pSRB
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|psrb
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|dc390_Free_insert
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|pSRB
op_assign
id|psrb
suffix:semicolon
)brace
id|pDCB-&gt;pGoingSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|pSRB-&gt;SRBState
op_amp
(paren
id|SRB_START_
op_plus
id|SRB_MSGOUT
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
(paren
id|SRB_DISCONNECT
op_plus
id|SRB_COMPLETED
)paren
)paren
)paren
(brace
multiline_comment|/* Selection time out */
id|pSRB-&gt;TargetStatus
op_assign
id|SCSI_STAT_SEL_TIMEOUT
suffix:semicolon
r_goto
id|disc1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DISCONNECT
)paren
op_logical_and
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_COMPLETED
)paren
)paren
(brace
id|disc1
suffix:colon
id|dc390_freetag
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
l_int|NULL
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_FREE
suffix:semicolon
id|dc390_SRBdone
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
)brace
)brace
id|pACB-&gt;MsgLen
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_Reselect
id|dc390_Reselect
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
suffix:semicolon
r_struct
id|dc390_srb
op_star
id|pSRB
suffix:semicolon
id|u8
id|id
comma
id|lun
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;RSEL,&quot;
)paren
)paren
suffix:semicolon
id|pACB-&gt;Connected
op_assign
l_int|1
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
)paren
(brace
multiline_comment|/* Arbitration lost but Reselection won */
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;DC390: (ActiveDCB != 0: Arb. lost but resel. won)!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pACB-&gt;scan_devices
)paren
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
id|pcmd-&gt;resid
op_assign
id|pcmd-&gt;request_bufflen
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_SOFT_ERROR
)paren
suffix:semicolon
id|dc390_Going_remove
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|dc390_Free_insert
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|pcmd-&gt;scsi_done
(paren
id|pcmd
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;DC390: Return SRB %p to free&bslash;n&quot;
comma
id|pSRB
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Get ID */
id|lun
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;Dev %02x,&quot;
comma
id|lun
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lun
op_amp
(paren
l_int|1
op_lshift
id|pACB-&gt;pScsiHost-&gt;this_id
)paren
)paren
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Reselection must select host adapter: %02x!&bslash;n&quot;
comma
id|lun
)paren
suffix:semicolon
r_else
id|lun
op_xor_assign
l_int|1
op_lshift
id|pACB-&gt;pScsiHost-&gt;this_id
suffix:semicolon
multiline_comment|/* Mask AdapterID */
id|id
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|lun
op_rshift_assign
l_int|1
)paren
id|id
op_increment
suffix:semicolon
multiline_comment|/* Get LUN */
id|lun
op_assign
id|DC390_read8
(paren
id|ScsiFifo
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lun
op_amp
id|IDENTIFY_BASE
)paren
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Resel: Expect identify message!&bslash;n&quot;
)paren
suffix:semicolon
id|lun
op_and_assign
l_int|7
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot;(%02i-%i),&quot;
comma
id|id
comma
id|lun
)paren
)paren
suffix:semicolon
id|pDCB
op_assign
id|dc390_findDCB
(paren
id|pACB
comma
id|id
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Reselect from non existing device (%02i-%i)&bslash;n&quot;
comma
id|id
comma
id|lun
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pACB-&gt;pActiveDCB
op_assign
id|pDCB
suffix:semicolon
multiline_comment|/* TagQ: We expect a message soon, so never mind the exact SRB */
r_if
c_cond
(paren
id|pDCB-&gt;SyncMode
op_amp
id|EN_TAG_QUEUEING
)paren
(brace
id|pSRB
op_assign
id|pACB-&gt;pTmpSRB
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
)brace
r_else
(brace
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
op_logical_or
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DISCONNECT
)paren
)paren
(brace
id|pSRB
op_assign
id|pACB-&gt;pTmpSRB
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_UNEXPECT_RESEL
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;DC390: Reselect without outstanding cmnd (%02i-%i)&bslash;n&quot;
comma
id|id
comma
id|lun
)paren
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
id|dc390_EnableMsgOut_Abort
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pDCB-&gt;DCBFlag
op_amp
id|ABORT_DEV_
)paren
(brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_ABORT_SENT
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Reselect: Abort (%02i-%i)&bslash;n&quot;
comma
id|id
comma
id|lun
)paren
suffix:semicolon
id|dc390_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SRBState
op_assign
id|SRB_DATA_XFER
suffix:semicolon
)brace
)brace
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Resel SRB(%p): TagNum (%02x)&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;TagNumber
)paren
)paren
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|SCSI_NOP0
suffix:semicolon
id|DC390_write8
(paren
id|Scsi_Dest_ID
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
id|DC390_write8
(paren
id|Sync_Period
comma
id|pDCB-&gt;SyncPeriod
)paren
suffix:semicolon
id|DC390_write8
(paren
id|Sync_Offset
comma
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg1
comma
id|pDCB-&gt;CtrlR1
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg3
comma
id|pDCB-&gt;CtrlR3
)paren
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg4
comma
id|pDCB-&gt;CtrlR4
)paren
suffix:semicolon
multiline_comment|/* ; Glitch eater */
id|DC390_write8
(paren
id|ScsiCmd
comma
id|MSG_ACCEPTED_CMD
)paren
suffix:semicolon
multiline_comment|/* ;to release the /ACK signal */
)brace
r_static
r_int
id|__inline__
DECL|function|dc390_RequestSense
id|dc390_RequestSense
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|pcmd
suffix:semicolon
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
id|REMOVABLEDEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: RequestSense(Cmd %02x, Id %02x, LUN %02x)&bslash;n&quot;
comma
"&bslash;"
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
)paren
suffix:semicolon
id|pSRB-&gt;SRBFlag
op_or_assign
id|AUTO_REQSENSE
suffix:semicolon
id|pSRB-&gt;SavedSGCount
op_assign
id|pcmd-&gt;use_sg
suffix:semicolon
id|pSRB-&gt;SavedTotXLen
op_assign
id|pSRB-&gt;TotalXferredLen
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CHECK_CONDITION&lt;&lt;1; */
multiline_comment|/* We are called from SRBdone, original PCI mapping has been removed&n;&t; * already, new one is set up from StartSCSI */
id|pSRB-&gt;SGIndex
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
r_return
id|dc390_StartSCSI
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_SRBdone
id|dc390_SRBdone
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
id|u8
id|bval
comma
id|status
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|pcmd
suffix:semicolon
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
multiline_comment|/* KG: Moved pci_unmap here */
id|dc390_pci_unmap
c_func
(paren
id|pSRB
)paren
suffix:semicolon
id|status
op_assign
id|pSRB-&gt;TargetStatus
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
l_string|&quot; SRBdone (%02x,%08x), SRB %p, pid %li&bslash;n&quot;
comma
id|status
comma
id|pcmd-&gt;result
comma
"&bslash;"
id|pSRB
comma
id|pcmd-&gt;pid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
(brace
multiline_comment|/* Last command was a Request Sense */
id|pSRB-&gt;SRBFlag
op_and_assign
op_complement
id|AUTO_REQSENSE
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
id|CHECK_CONDITION
op_lshift
l_int|1
suffix:semicolon
singleline_comment|//pcmd-&gt;result = MK_RES(DRIVER_SENSE,DID_OK,0,status);
r_if
c_cond
(paren
id|status
op_eq
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
)paren
id|pcmd-&gt;result
op_assign
id|MK_RES_LNX
c_func
(paren
l_int|0
comma
id|DID_BAD_TARGET
comma
l_int|0
comma
multiline_comment|/*CHECK_CONDITION*/
l_int|0
)paren
suffix:semicolon
r_else
multiline_comment|/* Retry */
(brace
r_if
c_cond
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|TEST_UNIT_READY
multiline_comment|/* || pSRB-&gt;pcmd-&gt;cmnd[0] == START_STOP */
)paren
(brace
multiline_comment|/* Don&squot;t retry on TEST_UNIT_READY */
id|pcmd-&gt;result
op_assign
id|MK_RES_LNX
c_func
(paren
id|DRIVER_SENSE
comma
id|DID_OK
comma
l_int|0
comma
id|CHECK_CONDITION
)paren
suffix:semicolon
id|REMOVABLEDEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Cmd=%02x, Result=%08x, XferL=%08x&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
"&bslash;"
(paren
id|u32
)paren
id|pcmd-&gt;result
comma
(paren
id|u32
)paren
id|pSRB-&gt;TotalXferredLen
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|SET_RES_DRV
c_func
(paren
id|pcmd-&gt;result
comma
id|DRIVER_SENSE
)paren
suffix:semicolon
id|pcmd-&gt;use_sg
op_assign
id|pSRB-&gt;SavedSGCount
suffix:semicolon
singleline_comment|//pSRB-&gt;ScsiCmdLen&t; = (u8) (pSRB-&gt;Segment1[0] &gt;&gt; 8);
id|DEBUG0
(paren
id|printk
(paren
l_string|&quot;DC390: RETRY pid %li (%02x), target %02i-%02i&bslash;n&quot;
comma
id|pcmd-&gt;pid
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pcmd-&gt;device-&gt;id
comma
id|pcmd-&gt;device-&gt;lun
)paren
)paren
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_SOFT_ERROR
)paren
suffix:semicolon
)brace
)brace
r_goto
id|cmd_done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|status
)paren
op_eq
id|CHECK_CONDITION
)paren
(brace
r_if
c_cond
(paren
id|dc390_RequestSense
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
)paren
(brace
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
r_goto
id|cmd_done
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|status
)paren
op_eq
id|QUEUE_FULL
)paren
(brace
id|bval
op_assign
(paren
id|u8
)paren
id|pDCB-&gt;GoingSRBCnt
suffix:semicolon
id|bval
op_decrement
suffix:semicolon
id|pDCB-&gt;MaxCommand
op_assign
id|bval
suffix:semicolon
id|pcmd-&gt;use_sg
op_assign
id|pSRB-&gt;SavedSGCount
suffix:semicolon
id|DEBUG0
(paren
id|printk
(paren
l_string|&quot;DC390: RETRY pid %li (%02x), target %02i-%02i&bslash;n&quot;
comma
id|pcmd-&gt;pid
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pcmd-&gt;device-&gt;id
comma
id|pcmd-&gt;device-&gt;lun
)paren
)paren
suffix:semicolon
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_SOFT_ERROR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_eq
id|SCSI_STAT_SEL_TIMEOUT
)paren
(brace
id|pSRB-&gt;AdaptStatus
op_assign
id|H_SEL_TIMEOUT
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|pcmd-&gt;result
op_assign
id|MK_RES
c_func
(paren
l_int|0
comma
id|DID_NO_CONNECT
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Devices are removed below ... */
)brace
r_else
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|status
)paren
op_eq
id|BUSY
op_logical_and
(paren
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|TEST_UNIT_READY
op_logical_or
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_and
id|pACB-&gt;scan_devices
)paren
(brace
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
id|status
suffix:semicolon
id|pcmd-&gt;result
op_assign
id|MK_RES
c_func
(paren
l_int|0
comma
l_int|0
comma
id|pSRB-&gt;EndMessage
comma
multiline_comment|/*status*/
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Another error */
id|pSRB-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_SOFT_ERROR
)paren
suffix:semicolon
r_goto
id|cmd_done
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*  Target status == 0 */
id|status
op_assign
id|pSRB-&gt;AdaptStatus
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|H_OVER_UNDER_RUN
)paren
(brace
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_OK
)paren
suffix:semicolon
id|SET_RES_MSG
c_func
(paren
id|pcmd-&gt;result
comma
id|pSRB-&gt;EndMessage
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pSRB-&gt;SRBStatus
op_amp
id|PARITY_ERROR
)paren
(brace
singleline_comment|//pcmd-&gt;result = MK_RES(0,DID_PARITY,pSRB-&gt;EndMessage,0);
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_PARITY
)paren
suffix:semicolon
id|SET_RES_MSG
c_func
(paren
id|pcmd-&gt;result
comma
id|pSRB-&gt;EndMessage
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* No error */
(brace
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_OK
)paren
suffix:semicolon
)brace
)brace
id|cmd_done
suffix:colon
id|pcmd-&gt;resid
op_assign
id|pcmd-&gt;request_bufflen
op_minus
id|pSRB-&gt;TotalXferredLen
suffix:semicolon
id|dc390_Going_remove
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/* Add to free list */
id|dc390_Free_insert
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;DC390: SRBdone: done pid %li&bslash;n&quot;
comma
id|pcmd-&gt;pid
)paren
)paren
suffix:semicolon
id|pcmd-&gt;scsi_done
(paren
id|pcmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Remove all SRBs from Going list and inform midlevel */
r_static
r_void
DECL|function|dc390_DoingSRB_Done
id|dc390_DoingSRB_Done
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
op_star
id|pdcb
suffix:semicolon
r_struct
id|dc390_srb
op_star
id|psrb
comma
op_star
id|psrb2
suffix:semicolon
id|u8
id|i
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|pcmd
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pdcb
op_assign
id|pDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdcb
)paren
r_return
suffix:semicolon
r_do
(brace
id|psrb
op_assign
id|pdcb-&gt;pGoingSRB
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pdcb-&gt;GoingSRBCnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|psrb2
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
id|pcmd
op_assign
id|psrb-&gt;pcmd
suffix:semicolon
id|dc390_Free_insert
(paren
id|pACB
comma
id|psrb
)paren
suffix:semicolon
id|psrb
op_assign
id|psrb2
suffix:semicolon
)brace
id|pdcb-&gt;GoingSRBCnt
op_assign
l_int|0
suffix:semicolon
id|pdcb-&gt;pGoingSRB
op_assign
l_int|NULL
suffix:semicolon
id|pdcb-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pdcb
op_assign
id|pdcb-&gt;pNextDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pdcb
op_ne
id|pDCB
)paren
(brace
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|dc390_ResetSCSIBus
id|dc390_ResetSCSIBus
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
(brace
singleline_comment|//DC390_write8 (ScsiCmd, RST_DEVICE_CMD);
singleline_comment|//udelay (250);
singleline_comment|//DC390_write8 (ScsiCmd, NOP_CMD);
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|RST_SCSI_BUS_CMD
)paren
suffix:semicolon
id|pACB-&gt;Connected
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|dc390_ScsiRstDetect
id|dc390_ScsiRstDetect
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: Rst_Detect: laststat = %08x&bslash;n&quot;
comma
id|dc390_laststatus
)paren
suffix:semicolon
singleline_comment|//DEBUG0(printk(KERN_INFO &quot;RST_DETECT,&quot;));
id|DC390_write8
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
)paren
suffix:semicolon
multiline_comment|/* Unlock before ? */
multiline_comment|/* delay half a second */
id|udelay
(paren
l_int|1000
)paren
suffix:semicolon
id|DC390_write8
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|pACB-&gt;pScsiHost-&gt;last_reset
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc390_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
(braket
id|EE_DELAY
)braket
suffix:semicolon
id|pACB-&gt;Connected
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;ACBFlag
op_amp
id|RESET_DEV
)paren
(brace
id|pACB-&gt;ACBFlag
op_or_assign
id|RESET_DONE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Reset was issued by sb else */
id|pACB-&gt;ACBFlag
op_or_assign
id|RESET_DETECT
suffix:semicolon
id|dc390_ResetDevParam
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|dc390_DoingSRB_Done
c_func
(paren
id|pACB
comma
l_int|NULL
)paren
suffix:semicolon
singleline_comment|//dc390_RecoverSRB( pACB );
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|DC390_queuecommand
r_static
r_int
id|DC390_queuecommand
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|cmd-&gt;device
suffix:semicolon
r_struct
id|dc390_acb
op_star
id|acb
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|dcb
op_assign
id|sdev-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_srb
op_star
id|srb
suffix:semicolon
r_if
c_cond
(paren
id|dcb-&gt;MaxCommand
op_le
id|dcb-&gt;GoingSRBCnt
)paren
r_goto
id|device_busy
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;pActiveDCB
)paren
r_goto
id|host_busy
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_or
id|RESET_DONE
op_or
id|RESET_DEV
)paren
)paren
r_goto
id|host_busy
suffix:semicolon
id|srb
op_assign
id|acb-&gt;pFreeSRB
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|srb
op_eq
l_int|NULL
)paren
)paren
r_goto
id|host_busy
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|cmd-&gt;result
op_assign
l_int|0
suffix:semicolon
id|acb-&gt;Cmds
op_increment
suffix:semicolon
id|acb-&gt;pFreeSRB
op_assign
id|srb-&gt;pNextSRB
suffix:semicolon
id|srb-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
id|srb-&gt;pSRBDCB
op_assign
id|dcb
suffix:semicolon
id|srb-&gt;pcmd
op_assign
id|cmd
suffix:semicolon
id|srb-&gt;SGIndex
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;SRBStatus
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;SRBFlag
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;SRBState
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;TotalXferredLen
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;SGBusAddr
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;SGToBeXferLen
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;ScsiPhase
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;EndMessage
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;TagNumber
op_assign
id|SCSI_NO_TAG
suffix:semicolon
r_if
c_cond
(paren
id|dc390_StartSCSI
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
)paren
(brace
id|dc390_Free_insert
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
r_goto
id|host_busy
suffix:semicolon
)brace
id|dc390_Going_append
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|host_busy
suffix:colon
r_return
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
id|device_busy
suffix:colon
r_return
id|SCSI_MLQUEUE_DEVICE_BUSY
suffix:semicolon
)brace
DECL|function|dc390_dumpinfo
r_static
r_void
id|dc390_dumpinfo
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
r_struct
id|dc390_srb
op_star
id|pSRB
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
id|u16
id|pstat
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
op_logical_and
id|pDCB
)paren
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: SRB: Xferred %08lx, Remain %08lx, State %08x, Phase %02x&bslash;n&quot;
comma
id|pSRB-&gt;TotalXferredLen
comma
id|pSRB-&gt;SGToBeXferLen
comma
id|pSRB-&gt;SRBState
comma
id|pSRB-&gt;ScsiPhase
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: AdpaterStatus: %02x, SRB Status %02x&bslash;n&quot;
comma
id|pSRB-&gt;AdaptStatus
comma
id|pSRB-&gt;SRBStatus
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;DC390: Status of last IRQ (DMA/SC/Int/IRQ): %08x&bslash;n&quot;
comma
id|dc390_laststatus
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Register dump: SCSI block:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: XferCnt  Cmd Stat IntS IRQS FFIS Ctl1 Ctl2 Ctl3 Ctl4&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390:  %06x   %02x   %02x   %02x&quot;
comma
id|DC390_read8
c_func
(paren
id|CtcReg_Low
)paren
op_plus
(paren
id|DC390_read8
c_func
(paren
id|CtcReg_Mid
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|DC390_read8
c_func
(paren
id|CtcReg_High
)paren
op_lshift
l_int|16
)paren
comma
id|DC390_read8
c_func
(paren
id|ScsiCmd
)paren
comma
id|DC390_read8
c_func
(paren
id|Scsi_Status
)paren
comma
id|DC390_read8
c_func
(paren
id|Intern_State
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;   %02x   %02x   %02x   %02x   %02x   %02x&bslash;n&quot;
comma
id|DC390_read8
c_func
(paren
id|INT_Status
)paren
comma
id|DC390_read8
c_func
(paren
id|Current_Fifo
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg1
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg2
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg3
)paren
comma
id|DC390_read8
c_func
(paren
id|CtrlReg4
)paren
)paren
suffix:semicolon
id|DC390_write32
(paren
id|DMA_ScsiBusCtrl
comma
id|WRT_ERASE_DMA_STAT
op_or
id|EN_INT_ON_PCI_ABORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DC390_read8
c_func
(paren
id|Current_Fifo
)paren
op_amp
l_int|0x1f
)paren
(brace
id|printk
(paren
l_string|&quot;DC390: FIFO:&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|DC390_read8
c_func
(paren
id|Current_Fifo
)paren
op_amp
l_int|0x1f
)paren
id|printk
(paren
l_string|&quot; %02x&quot;
comma
id|DC390_read8
c_func
(paren
id|ScsiFifo
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;DC390: Register dump: DMA engine:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Cmd   STrCnt    SBusA    WrkBC    WrkAC Stat SBusCtrl&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390:  %02x %08x %08x %08x %08x   %02x %08x&bslash;n&quot;
comma
id|DC390_read8
c_func
(paren
id|DMA_Cmd
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_XferCnt
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_XferAddr
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_Wk_ByteCntr
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_Wk_AddrCntr
)paren
comma
id|DC390_read8
c_func
(paren
id|DMA_Status
)paren
comma
id|DC390_read32
c_func
(paren
id|DMA_ScsiBusCtrl
)paren
)paren
suffix:semicolon
id|DC390_write32
(paren
id|DMA_ScsiBusCtrl
comma
id|EN_INT_ON_PCI_ABORT
)paren
suffix:semicolon
id|pdev
op_assign
id|pACB-&gt;pdev
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
op_amp
id|pstat
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: Register dump: PCI Status: %04x&bslash;n&quot;
comma
id|pstat
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DC390: In case of driver trouble read Documentation/scsi/tmscsim.txt&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|DC390_abort
r_static
r_int
id|DC390_abort
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pDCB
op_assign
(paren
r_struct
id|dc390_dcb
op_star
)paren
id|cmd-&gt;device-&gt;hostdata
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DC390: Abort command (pid %li, Device %02i-%02i)&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
multiline_comment|/* abort() is too stupid for already sent commands at the moment. &n;&t; * If it&squot;s called we are in trouble anyway, so let&squot;s dump some info &n;&t; * into the syslog at least. (KG, 98/08/20,99/06/20) */
id|dc390_dumpinfo
c_func
(paren
id|pACB
comma
id|pDCB
comma
l_int|NULL
)paren
suffix:semicolon
id|pDCB-&gt;DCBFlag
op_or_assign
id|ABORT_DEV_
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: Aborted pid %li&bslash;n&quot;
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
DECL|function|dc390_ResetDevParam
r_static
r_void
id|dc390_ResetDevParam
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
)paren
(brace
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
op_star
id|pdcb
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
suffix:semicolon
id|pdcb
op_assign
id|pDCB
suffix:semicolon
r_do
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|SYNC_NEGO_DONE
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;CtrlR3
op_assign
id|FAST_CLK
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_and_assign
id|NEGATE_REQACKDATA
op_or
id|CTRL4_RESERVED
op_or
id|NEGATE_REQACK
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_or_assign
id|pACB-&gt;glitch_cfg
suffix:semicolon
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pdcb
op_ne
id|pDCB
)paren
(brace
suffix:semicolon
)brace
id|pACB-&gt;ACBFlag
op_and_assign
op_complement
(paren
id|RESET_DEV
op_or
id|RESET_DONE
op_or
id|RESET_DETECT
)paren
suffix:semicolon
)brace
DECL|function|DC390_bus_reset
r_static
r_int
id|DC390_bus_reset
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|u8
id|bval
suffix:semicolon
id|bval
op_assign
id|DC390_read8
c_func
(paren
id|CtrlReg1
)paren
op_or
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|DC390_write8
c_func
(paren
id|CtrlReg1
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* disable IRQ on bus reset */
id|pACB-&gt;ACBFlag
op_or_assign
id|RESET_DEV
suffix:semicolon
id|dc390_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|dc390_ResetDevParam
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|pACB-&gt;pScsiHost-&gt;last_reset
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc390_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
(braket
id|EE_DELAY
)braket
suffix:semicolon
id|DC390_write8
c_func
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|DC390_read8
c_func
(paren
id|INT_Status
)paren
suffix:semicolon
multiline_comment|/* Reset Pending INT */
id|dc390_DoingSRB_Done
c_func
(paren
id|pACB
comma
id|cmd
)paren
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
id|bval
op_assign
id|DC390_read8
c_func
(paren
id|CtrlReg1
)paren
op_amp
op_complement
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|DC390_write8
c_func
(paren
id|CtrlReg1
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* re-enable interrupt */
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/**&n; * dc390_slave_alloc - Called by the scsi mid layer to tell us about a new&n; * scsi device that we need to deal with.&n; *&n; * @scsi_device: The new scsi device that we need to handle.&n; */
DECL|function|dc390_slave_alloc
r_static
r_int
id|dc390_slave_alloc
c_func
(paren
r_struct
id|scsi_device
op_star
id|scsi_device
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|scsi_device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pDCB
comma
op_star
id|pDCB2
op_assign
l_int|NULL
suffix:semicolon
id|uint
id|id
op_assign
id|scsi_device-&gt;id
suffix:semicolon
id|uint
id|lun
op_assign
id|scsi_device-&gt;lun
suffix:semicolon
id|pDCB
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dc390_dcb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|pDCB
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dc390_dcb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;DCBCnt
op_increment
)paren
(brace
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
id|pDCB
suffix:semicolon
)brace
r_else
(brace
id|pACB-&gt;pLastDCB-&gt;pNextDCB
op_assign
id|pDCB
suffix:semicolon
)brace
id|pDCB-&gt;pNextDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pACB-&gt;pLastDCB
op_assign
id|pDCB
suffix:semicolon
id|pDCB-&gt;pDCBACB
op_assign
id|pACB
suffix:semicolon
id|pDCB-&gt;TargetID
op_assign
id|id
suffix:semicolon
id|pDCB-&gt;TargetLUN
op_assign
id|lun
suffix:semicolon
id|pDCB-&gt;MaxCommand
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Some values are for all LUNs: Copy them &n;&t; * In a clean way: We would have an own structure for a SCSI-ID &n;&t; */
r_if
c_cond
(paren
id|lun
op_logical_and
(paren
id|pDCB2
op_assign
id|dc390_findDCB
c_func
(paren
id|pACB
comma
id|id
comma
l_int|0
)paren
)paren
)paren
(brace
id|pDCB-&gt;DevMode
op_assign
id|pDCB2-&gt;DevMode
suffix:semicolon
id|pDCB-&gt;SyncMode
op_assign
id|pDCB2-&gt;SyncMode
op_amp
id|SYNC_NEGO_DONE
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
id|pDCB2-&gt;SyncPeriod
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
id|pDCB2-&gt;SyncOffset
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
id|pDCB2-&gt;NegoPeriod
suffix:semicolon
id|pDCB-&gt;CtrlR3
op_assign
id|pDCB2-&gt;CtrlR3
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_assign
id|pDCB2-&gt;CtrlR4
suffix:semicolon
)brace
r_else
(brace
id|u8
id|index
op_assign
id|pACB-&gt;AdapterIndex
suffix:semicolon
id|PEEprom
id|prom
op_assign
(paren
id|PEEprom
)paren
op_amp
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|id
op_lshift
l_int|2
)braket
suffix:semicolon
id|pDCB-&gt;DevMode
op_assign
id|prom-&gt;EE_MODE1
suffix:semicolon
id|pDCB-&gt;NegoPeriod
op_assign
(paren
id|dc390_clock_period1
(braket
id|prom-&gt;EE_SPEED
)braket
op_star
l_int|25
)paren
op_rshift
l_int|2
suffix:semicolon
id|pDCB-&gt;CtrlR3
op_assign
id|FAST_CLK
suffix:semicolon
id|pDCB-&gt;CtrlR4
op_assign
id|pACB-&gt;glitch_cfg
op_or
id|CTRL4_RESERVED
suffix:semicolon
r_if
c_cond
(paren
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|ACTIVE_NEGATION
)paren
id|pDCB-&gt;CtrlR4
op_or_assign
id|NEGATE_REQACKDATA
op_or
id|NEGATE_REQACK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|SYNC_NEGO_
)paren
id|pDCB-&gt;SyncMode
op_or_assign
id|SYNC_ENABLE
suffix:semicolon
r_else
(brace
id|pDCB-&gt;SyncMode
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_and_assign
op_complement
l_int|0x0f
suffix:semicolon
)brace
id|pDCB-&gt;CtrlR1
op_assign
id|pACB-&gt;pScsiHost-&gt;this_id
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|PARITY_CHK_
)paren
id|pDCB-&gt;CtrlR1
op_or_assign
id|PARITY_ERR_REPO
suffix:semicolon
id|pACB-&gt;scan_devices
op_assign
l_int|1
suffix:semicolon
id|scsi_device-&gt;hostdata
op_assign
id|pDCB
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * dc390_slave_destroy - Called by the scsi mid layer to tell us about a&n; * device that is going away.&n; *&n; * @scsi_device: The scsi device that we need to remove.&n; */
DECL|function|dc390_slave_destroy
r_static
r_void
id|dc390_slave_destroy
c_func
(paren
r_struct
id|scsi_device
op_star
id|scsi_device
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|scsi_device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pDCB
op_assign
(paren
r_struct
id|dc390_dcb
op_star
)paren
id|scsi_device-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|pPrevDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pACB-&gt;scan_devices
op_assign
l_int|0
suffix:semicolon
id|BUG_ON
c_func
(paren
id|pDCB-&gt;GoingSRBCnt
OG
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLinkDCB
)paren
(brace
r_if
c_cond
(paren
id|pACB-&gt;pLastDCB
op_eq
id|pDCB
)paren
(brace
id|pDCB-&gt;pNextDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pLastDCB
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|pPrevDCB-&gt;pNextDCB
op_ne
id|pDCB
)paren
id|pPrevDCB
op_assign
id|pPrevDCB-&gt;pNextDCB
suffix:semicolon
id|pPrevDCB-&gt;pNextDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLastDCB
)paren
id|pACB-&gt;pLastDCB
op_assign
id|pPrevDCB
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pActiveDCB
)paren
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLinkDCB
)paren
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pDCBRunRobin
)paren
id|pACB-&gt;pDCBRunRobin
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
id|kfree
c_func
(paren
id|pDCB
)paren
suffix:semicolon
id|pACB-&gt;DCBCnt
op_decrement
suffix:semicolon
)brace
DECL|function|dc390_slave_configure
r_static
r_int
id|dc390_slave_configure
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
)paren
(brace
r_struct
id|dc390_acb
op_star
id|acb
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|dc390_dcb
op_star
id|dcb
op_assign
(paren
r_struct
id|dc390_dcb
op_star
)paren
id|sdev-&gt;hostdata
suffix:semicolon
id|acb-&gt;scan_devices
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sdev-&gt;tagged_supported
op_logical_and
(paren
id|dcb-&gt;DevMode
op_amp
id|TAG_QUEUEING_
)paren
)paren
(brace
id|dcb-&gt;SyncMode
op_or_assign
id|EN_TAG_QUEUEING
suffix:semicolon
id|dcb-&gt;MaxCommand
op_assign
id|dcb-&gt;pDCBACB-&gt;TagMaxNum
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|driver_template
r_static
r_struct
id|scsi_host_template
id|driver_template
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|proc_name
op_assign
l_string|&quot;tmscsim&quot;
comma
dot
id|name
op_assign
id|DC390_BANNER
l_string|&quot; V&quot;
id|DC390_VERSION
comma
dot
id|slave_alloc
op_assign
id|dc390_slave_alloc
comma
dot
id|slave_configure
op_assign
id|dc390_slave_configure
comma
dot
id|slave_destroy
op_assign
id|dc390_slave_destroy
comma
dot
id|queuecommand
op_assign
id|DC390_queuecommand
comma
dot
id|eh_abort_handler
op_assign
id|DC390_abort
comma
dot
id|eh_bus_reset_handler
op_assign
id|DC390_bus_reset
comma
dot
id|can_queue
op_assign
l_int|42
comma
dot
id|this_id
op_assign
l_int|7
comma
dot
id|sg_tablesize
op_assign
id|SG_ALL
comma
dot
id|cmd_per_lun
op_assign
l_int|16
comma
dot
id|use_clustering
op_assign
id|DISABLE_CLUSTERING
comma
)brace
suffix:semicolon
multiline_comment|/***********************************************************************&n; * Functions for access to DC390 EEPROM&n; * and some to emulate it&n; *&n; **********************************************************************/
DECL|function|dc390_EnDisableCE
r_static
r_void
id|__devinit
id|dc390_EnDisableCE
c_func
(paren
id|u8
id|mode
comma
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u8
op_star
id|regval
)paren
(brace
id|u8
id|bval
suffix:semicolon
id|bval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|ENABLE_CE
)paren
(brace
op_star
id|regval
op_assign
l_int|0xc0
suffix:semicolon
)brace
r_else
op_star
id|regval
op_assign
l_int|0x80
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|DISABLE_CE
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
)brace
multiline_comment|/* Override EEprom values with explicitly set values */
DECL|function|dc390_EEprom_Override
r_static
r_void
id|__devinit
id|dc390_EEprom_Override
(paren
id|u8
id|index
)paren
(brace
id|u8
op_star
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|dc390_eepromBuf
(braket
id|index
)braket
suffix:semicolon
id|u8
id|id
suffix:semicolon
multiline_comment|/* Adapter Settings */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|0
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_ADAPT_SCSI_ID
)braket
op_assign
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Adapter ID */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|3
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_MODE2
)braket
op_assign
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|5
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_DELAY
)braket
op_assign
id|tmscsim
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* Reset delay */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|4
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|EE_TAG_CMD_NUM
)braket
op_assign
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Tagged Cmds */
multiline_comment|/* Device Settings */
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|MAX_SCSI_ID
suffix:semicolon
id|id
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|2
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
id|id
op_lshift
l_int|2
)braket
op_assign
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* EE_MODE1 */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|1
)braket
op_ne
op_minus
l_int|2
)paren
id|ptr
(braket
(paren
id|id
op_lshift
l_int|2
)paren
op_plus
l_int|1
)braket
op_assign
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* EE_Speed */
)brace
)brace
multiline_comment|/* Handle &quot;-1&quot; case */
DECL|function|dc390_check_for_safe_settings
r_static
r_void
id|__devinit
id|dc390_check_for_safe_settings
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
op_logical_or
id|tmscsim
(braket
l_int|0
)braket
OG
l_int|15
)paren
multiline_comment|/* modules-2.0.0 passes -1 as string */
(brace
id|tmscsim
(braket
l_int|0
)braket
op_assign
l_int|7
suffix:semicolon
id|tmscsim
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
id|tmscsim
(braket
l_int|2
)braket
op_assign
l_int|0x09
suffix:semicolon
id|tmscsim
(braket
l_int|3
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|tmscsim
(braket
l_int|4
)braket
op_assign
l_int|2
suffix:semicolon
id|tmscsim
(braket
l_int|5
)braket
op_assign
l_int|10
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;DC390: Using safe settings.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|variable|tmscsim_def
r_static
r_int
id|__initdata
id|tmscsim_def
(braket
)braket
op_assign
(brace
l_int|7
comma
l_int|0
multiline_comment|/* 10MHz */
comma
id|PARITY_CHK_
op_or
id|SEND_START_
op_or
id|EN_DISCONNECT_
op_or
id|SYNC_NEGO_
op_or
id|TAG_QUEUEING_
comma
id|MORE2_DRV
op_or
id|GREATER_1G
op_or
id|RST_SCSI_BUS
op_or
id|ACTIVE_NEGATION
multiline_comment|/* | NO_SEEK */
macro_line|# ifdef CONFIG_SCSI_MULTI_LUN
op_or
id|LUN_CHECK
macro_line|# endif
comma
l_int|3
multiline_comment|/* 16 Tags per LUN */
comma
l_int|1
multiline_comment|/* s delay after Reset */
)brace
suffix:semicolon
multiline_comment|/* Copy defaults over set values where missing */
DECL|function|dc390_fill_with_defaults
r_static
r_void
id|__devinit
id|dc390_fill_with_defaults
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|PARSEDEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: setup %08x %08x %08x %08x %08x %08x&bslash;n&quot;
comma
id|tmscsim
(braket
l_int|0
)braket
comma
"&bslash;"
id|tmscsim
(braket
l_int|1
)braket
comma
id|tmscsim
(braket
l_int|2
)braket
comma
id|tmscsim
(braket
l_int|3
)braket
comma
id|tmscsim
(braket
l_int|4
)braket
comma
id|tmscsim
(braket
l_int|5
)braket
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tmscsim
(braket
id|i
)braket
template_param
l_int|255
)paren
id|tmscsim
(braket
id|i
)braket
op_assign
id|tmscsim_def
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* Sanity checks */
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|0
)braket
OG
l_int|7
)paren
id|tmscsim
(braket
l_int|0
)braket
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|1
)braket
OG
l_int|7
)paren
id|tmscsim
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|4
)braket
OG
l_int|5
)paren
id|tmscsim
(braket
l_int|4
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|tmscsim
(braket
l_int|5
)braket
OG
l_int|180
)paren
id|tmscsim
(braket
l_int|5
)braket
op_assign
l_int|180
suffix:semicolon
)brace
DECL|function|dc390_EEpromOutDI
r_static
r_void
id|__devinit
id|dc390_EEpromOutDI
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u8
op_star
id|regval
comma
id|u8
id|Carry
)paren
(brace
id|u8
id|bval
suffix:semicolon
id|bval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|Carry
)paren
(brace
id|bval
op_assign
l_int|0x40
suffix:semicolon
op_star
id|regval
op_assign
l_int|0x80
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|bval
op_or_assign
l_int|0x80
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|bval
op_assign
l_int|0
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
op_star
id|regval
comma
id|bval
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
)brace
DECL|function|dc390_EEpromInDO
r_static
id|u8
id|__devinit
id|dc390_EEpromInDO
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|u8
id|bval
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x80
comma
l_int|0x80
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
l_int|0x80
comma
l_int|0x40
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|160
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
l_int|0x00
comma
op_amp
id|bval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_eq
l_int|0x22
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dc390_EEpromGetData1
r_static
id|u16
id|__devinit
id|dc390_EEpromGetData1
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|u8
id|i
suffix:semicolon
id|u8
id|carryFlag
suffix:semicolon
id|u16
id|wval
suffix:semicolon
id|wval
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|wval
op_lshift_assign
l_int|1
suffix:semicolon
id|carryFlag
op_assign
id|dc390_EEpromInDO
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|wval
op_or_assign
id|carryFlag
suffix:semicolon
)brace
r_return
id|wval
suffix:semicolon
)brace
DECL|function|dc390_Prepare
r_static
r_void
id|__devinit
id|dc390_Prepare
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u8
op_star
id|regval
comma
id|u8
id|EEpromCmd
)paren
(brace
id|u8
id|i
comma
id|j
suffix:semicolon
id|u8
id|carryFlag
suffix:semicolon
id|carryFlag
op_assign
l_int|1
suffix:semicolon
id|j
op_assign
l_int|0x80
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dc390_EEpromOutDI
c_func
(paren
id|pdev
comma
id|regval
comma
id|carryFlag
)paren
suffix:semicolon
id|carryFlag
op_assign
(paren
id|EEpromCmd
op_amp
id|j
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|j
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|dc390_ReadEEprom
r_static
r_void
id|__devinit
id|dc390_ReadEEprom
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u16
op_star
id|ptr
)paren
(brace
id|u8
id|regval
comma
id|cmd
suffix:semicolon
id|u8
id|i
suffix:semicolon
id|cmd
op_assign
id|EEPROM_READ
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x40
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dc390_EnDisableCE
c_func
(paren
id|ENABLE_CE
comma
id|pdev
comma
op_amp
id|regval
)paren
suffix:semicolon
id|dc390_Prepare
c_func
(paren
id|pdev
comma
op_amp
id|regval
comma
id|cmd
op_increment
)paren
suffix:semicolon
op_star
id|ptr
op_increment
op_assign
id|dc390_EEpromGetData1
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|dc390_EnDisableCE
c_func
(paren
id|DISABLE_CE
comma
id|pdev
comma
op_amp
id|regval
)paren
suffix:semicolon
)brace
)brace
DECL|function|dc390_interpret_delay
r_static
r_void
id|__devinit
id|dc390_interpret_delay
(paren
id|u8
id|index
)paren
(brace
r_char
id|interpd
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|3
comma
l_int|5
comma
l_int|10
comma
l_int|16
comma
l_int|30
comma
l_int|60
comma
l_int|120
)brace
suffix:semicolon
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_DELAY
)braket
op_assign
id|interpd
(braket
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_DELAY
)braket
)braket
suffix:semicolon
)brace
DECL|function|dc390_CheckEEpromCheckSum
r_static
id|u8
id|__devinit
id|dc390_CheckEEpromCheckSum
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u8
id|index
)paren
(brace
id|u8
id|i
suffix:semicolon
r_char
id|EEbuf
(braket
l_int|128
)braket
suffix:semicolon
id|u16
id|wval
comma
op_star
id|ptr
op_assign
(paren
id|u16
op_star
)paren
id|EEbuf
suffix:semicolon
id|dc390_ReadEEprom
c_func
(paren
id|pdev
comma
id|ptr
)paren
suffix:semicolon
id|memcpy
(paren
id|dc390_eepromBuf
(braket
id|index
)braket
comma
id|EEbuf
comma
id|EE_ADAPT_SCSI_ID
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
comma
op_amp
id|EEbuf
(braket
id|REAL_EE_ADAPT_SCSI_ID
)braket
comma
id|EE_LEN
op_minus
id|EE_ADAPT_SCSI_ID
)paren
suffix:semicolon
id|dc390_interpret_delay
(paren
id|index
)paren
suffix:semicolon
id|wval
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x40
suffix:semicolon
id|i
op_increment
comma
id|ptr
op_increment
)paren
(brace
id|wval
op_add_assign
op_star
id|ptr
suffix:semicolon
)brace
r_return
(paren
id|wval
op_eq
l_int|0x1234
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|dc390_init_hw
r_static
r_void
id|__devinit
id|dc390_init_hw
c_func
(paren
r_struct
id|dc390_acb
op_star
id|pACB
comma
id|u8
id|index
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|pACB-&gt;pScsiHost
suffix:semicolon
id|u8
id|dstate
suffix:semicolon
multiline_comment|/* Disable SCSI bus reset interrupt */
id|DC390_write8
c_func
(paren
id|CtrlReg1
comma
id|DIS_INT_ON_SCSI_RST
op_or
id|shost-&gt;this_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;Gmode2
op_amp
id|RST_SCSI_BUS
)paren
(brace
id|dc390_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|shost-&gt;last_reset
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc390_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
(braket
id|EE_DELAY
)braket
suffix:semicolon
)brace
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset Pending INT */
id|DC390_read8
c_func
(paren
id|INT_Status
)paren
suffix:semicolon
multiline_comment|/* 250ms selection timeout */
id|DC390_write8
c_func
(paren
id|Scsi_TimeOut
comma
id|SEL_TIMEOUT
)paren
suffix:semicolon
multiline_comment|/* Conversion factor = 0 , 40MHz clock */
id|DC390_write8
c_func
(paren
id|Clk_Factor
comma
id|CLK_FREQ_40MHZ
)paren
suffix:semicolon
multiline_comment|/* NOP cmd - clear command register */
id|DC390_write8
c_func
(paren
id|ScsiCmd
comma
id|NOP_CMD
)paren
suffix:semicolon
multiline_comment|/* Enable Feature and SCSI-2 */
id|DC390_write8
c_func
(paren
id|CtrlReg2
comma
id|EN_FEATURE
op_plus
id|EN_SCSI2_CMD
)paren
suffix:semicolon
multiline_comment|/* Fast clock */
id|DC390_write8
c_func
(paren
id|CtrlReg3
comma
id|FAST_CLK
)paren
suffix:semicolon
multiline_comment|/* Negation */
id|DC390_write8
c_func
(paren
id|CtrlReg4
comma
id|pACB-&gt;glitch_cfg
op_or
multiline_comment|/* glitch eater */
(paren
id|dc390_eepromBuf
(braket
id|index
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|ACTIVE_NEGATION
)paren
ques
c_cond
id|NEGATE_REQACKDATA
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Clear Transfer Count High: ID */
id|DC390_write8
c_func
(paren
id|CtcReg_High
comma
l_int|0
)paren
suffix:semicolon
id|DC390_write8
c_func
(paren
id|DMA_Cmd
comma
id|DMA_IDLE_CMD
)paren
suffix:semicolon
id|DC390_write8
c_func
(paren
id|ScsiCmd
comma
id|CLEAR_FIFO_CMD
)paren
suffix:semicolon
id|DC390_write32
c_func
(paren
id|DMA_ScsiBusCtrl
comma
id|EN_INT_ON_PCI_ABORT
)paren
suffix:semicolon
id|dstate
op_assign
id|DC390_read8
c_func
(paren
id|DMA_Status
)paren
suffix:semicolon
id|DC390_write8
c_func
(paren
id|DMA_Status
comma
id|dstate
)paren
suffix:semicolon
)brace
DECL|function|dc390_probe_one
r_static
r_int
id|__devinit
id|dc390_probe_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|dc390_acb
op_star
id|pACB
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shost
suffix:semicolon
r_int
r_int
id|io_port
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|ENODEV
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_goto
id|out
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|shost
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|driver_template
comma
r_sizeof
(paren
r_struct
id|dc390_acb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shost
)paren
r_goto
id|out_disable_device
suffix:semicolon
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
id|memset
c_func
(paren
id|pACB
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dc390_acb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dc390_CheckEEpromCheckSum
c_func
(paren
id|pdev
comma
id|dc390_adapterCnt
)paren
)paren
(brace
r_int
id|speed
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390_init: No EEPROM found! Trying default settings ...&bslash;n&quot;
)paren
suffix:semicolon
id|dc390_check_for_safe_settings
c_func
(paren
)paren
suffix:semicolon
id|dc390_fill_with_defaults
c_func
(paren
)paren
suffix:semicolon
id|dc390_EEprom_Override
c_func
(paren
id|dc390_adapterCnt
)paren
suffix:semicolon
id|speed
op_assign
id|dc390_clock_speed
(braket
id|tmscsim
(braket
l_int|1
)braket
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DC390: Used defaults: AdaptID=%i, SpeedIdx=%i (%i.%i MHz),&quot;
l_string|&quot; DevMode=0x%02x, AdaptMode=0x%02x, TaggedCmnds=%i (%i), DelayReset=%is&bslash;n&quot;
comma
id|tmscsim
(braket
l_int|0
)braket
comma
id|tmscsim
(braket
l_int|1
)braket
comma
id|speed
op_div
l_int|10
comma
id|speed
op_mod
l_int|10
comma
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|2
)braket
comma
(paren
id|u8
)paren
id|tmscsim
(braket
l_int|3
)braket
comma
id|tmscsim
(braket
l_int|4
)braket
comma
l_int|2
op_lshift
(paren
id|tmscsim
(braket
l_int|4
)braket
)paren
comma
id|tmscsim
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|dc390_check_for_safe_settings
c_func
(paren
)paren
suffix:semicolon
id|dc390_EEprom_Override
c_func
(paren
id|dc390_adapterCnt
)paren
suffix:semicolon
)brace
id|io_port
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|shost-&gt;can_queue
op_assign
id|MAX_CMD_QUEUE
suffix:semicolon
id|shost-&gt;cmd_per_lun
op_assign
id|MAX_CMD_PER_LUN
suffix:semicolon
id|shost-&gt;this_id
op_assign
id|dc390_eepromBuf
(braket
id|dc390_adapterCnt
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
suffix:semicolon
id|shost-&gt;io_port
op_assign
id|io_port
suffix:semicolon
id|shost-&gt;n_io_port
op_assign
l_int|0x80
suffix:semicolon
id|shost-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|shost-&gt;base
op_assign
id|io_port
suffix:semicolon
id|shost-&gt;unique_id
op_assign
id|io_port
suffix:semicolon
id|shost-&gt;last_reset
op_assign
id|jiffies
suffix:semicolon
id|pACB-&gt;pScsiHost
op_assign
id|shost
suffix:semicolon
id|pACB-&gt;IOPortBase
op_assign
(paren
id|u16
)paren
id|io_port
suffix:semicolon
id|pACB-&gt;IRQLevel
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|shost-&gt;max_id
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|shost-&gt;max_id
op_minus
l_int|1
op_eq
id|dc390_eepromBuf
(braket
id|dc390_adapterCnt
)braket
(braket
id|EE_ADAPT_SCSI_ID
)braket
)paren
id|shost-&gt;max_id
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|dc390_eepromBuf
(braket
id|dc390_adapterCnt
)braket
(braket
id|EE_MODE2
)braket
op_amp
id|LUN_CHECK
)paren
id|shost-&gt;max_lun
op_assign
l_int|8
suffix:semicolon
r_else
id|shost-&gt;max_lun
op_assign
l_int|1
suffix:semicolon
id|pACB-&gt;pFreeSRB
op_assign
id|pACB-&gt;SRB_array
suffix:semicolon
id|pACB-&gt;SRBCount
op_assign
id|MAX_SRB_CNT
suffix:semicolon
id|pACB-&gt;AdapterIndex
op_assign
id|dc390_adapterCnt
suffix:semicolon
id|pACB-&gt;TagMaxNum
op_assign
l_int|2
op_lshift
id|dc390_eepromBuf
(braket
id|dc390_adapterCnt
)braket
(braket
id|EE_TAG_CMD_NUM
)braket
suffix:semicolon
id|pACB-&gt;Gmode2
op_assign
id|dc390_eepromBuf
(braket
id|dc390_adapterCnt
)braket
(braket
id|EE_MODE2
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pACB-&gt;SRBCount
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|pACB-&gt;SRB_array
(braket
id|i
)braket
dot
id|pNextSRB
op_assign
op_amp
id|pACB-&gt;SRB_array
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|pACB-&gt;SRB_array
(braket
id|pACB-&gt;SRBCount
op_minus
l_int|1
)braket
dot
id|pNextSRB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pTmpSRB
op_assign
op_amp
id|pACB-&gt;TmpSRB
suffix:semicolon
id|pACB-&gt;sel_timeout
op_assign
id|SEL_TIMEOUT
suffix:semicolon
id|pACB-&gt;glitch_cfg
op_assign
id|EATER_25NS
suffix:semicolon
id|pACB-&gt;pdev
op_assign
id|pdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|io_port
comma
id|shost-&gt;n_io_port
comma
l_string|&quot;tmscsim&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DC390: register IO ports error!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_host_put
suffix:semicolon
)brace
multiline_comment|/* Reset Pending INT */
id|DC390_read8_
c_func
(paren
id|INT_Status
comma
id|io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|do_DC390_Interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;tmscsim&quot;
comma
id|pACB
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DC390: register IRQ error!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_release_region
suffix:semicolon
)brace
id|dc390_init_hw
c_func
(paren
id|pACB
comma
id|dc390_adapterCnt
)paren
suffix:semicolon
id|dc390_adapterCnt
op_increment
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|shost
)paren
suffix:semicolon
id|error
op_assign
id|scsi_add_host
c_func
(paren
id|shost
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out_free_irq
suffix:semicolon
id|scsi_scan_host
c_func
(paren
id|shost
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_free_irq
suffix:colon
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|pACB
)paren
suffix:semicolon
id|out_release_region
suffix:colon
id|release_region
c_func
(paren
id|io_port
comma
id|shost-&gt;n_io_port
)paren
suffix:semicolon
id|out_host_put
suffix:colon
id|scsi_host_put
c_func
(paren
id|shost
)paren
suffix:semicolon
id|out_disable_device
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; * dc390_remove_one - Called to remove a single instance of the adapter.&n; *&n; * @dev: The PCI device to remove.&n; */
DECL|function|dc390_remove_one
r_static
r_void
id|__devexit
id|dc390_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|scsi_host
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_struct
id|dc390_acb
op_star
id|pACB
op_assign
(paren
r_struct
id|dc390_acb
op_star
)paren
id|scsi_host-&gt;hostdata
suffix:semicolon
id|u8
id|bval
suffix:semicolon
id|scsi_remove_host
c_func
(paren
id|scsi_host
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|scsi_host-&gt;host_lock
comma
id|iflags
)paren
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
id|RESET_DEV
suffix:semicolon
id|bval
op_assign
id|DC390_read8
c_func
(paren
id|CtrlReg1
)paren
op_or
id|DIS_INT_ON_SCSI_RST
suffix:semicolon
id|DC390_write8
(paren
id|CtrlReg1
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* disable interrupt */
r_if
c_cond
(paren
id|pACB-&gt;Gmode2
op_amp
id|RST_SCSI_BUS
)paren
id|dc390_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|scsi_host-&gt;host_lock
comma
id|iflags
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|scsi_host-&gt;irq
comma
id|pACB
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|scsi_host-&gt;io_port
comma
id|scsi_host-&gt;n_io_port
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|scsi_host
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|tmscsim_pci_tbl
r_static
r_struct
id|pci_device_id
id|tmscsim_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_AMD
comma
id|PCI_DEVICE_ID_AMD53C974
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|tmscsim_pci_tbl
)paren
suffix:semicolon
DECL|variable|dc390_driver
r_static
r_struct
id|pci_driver
id|dc390_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;tmscsim&quot;
comma
dot
id|id_table
op_assign
id|tmscsim_pci_tbl
comma
dot
id|probe
op_assign
id|dc390_probe_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|dc390_remove_one
)paren
comma
)brace
suffix:semicolon
DECL|function|dc390_module_init
r_static
r_int
id|__init
id|dc390_module_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|dc390_driver
)paren
suffix:semicolon
)brace
DECL|function|dc390_module_exit
r_static
r_void
id|__exit
id|dc390_module_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|dc390_driver
)paren
suffix:semicolon
)brace
DECL|variable|dc390_module_init
id|module_init
c_func
(paren
id|dc390_module_init
)paren
suffix:semicolon
DECL|variable|dc390_module_exit
id|module_exit
c_func
(paren
id|dc390_module_exit
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|dc390_setup
r_static
r_int
id|__init
id|dc390_setup
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|ints
(braket
l_int|8
)braket
comma
id|i
comma
id|im
suffix:semicolon
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|im
op_assign
id|ints
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|im
OG
l_int|6
)paren
(brace
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;DC390: ignore extra params!&bslash;n&quot;
)paren
suffix:semicolon
id|im
op_assign
l_int|6
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|im
suffix:semicolon
id|i
op_increment
)paren
id|tmscsim
(braket
id|i
)braket
op_assign
id|ints
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* dc390_checkparams (); */
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;tmscsim=&quot;
comma
id|dc390_setup
)paren
suffix:semicolon
macro_line|#endif
eof
