multiline_comment|/*======================================================================&n;&n;    NinjaSCSI-3 / NinjaSCSI-32Bi PCMCIA SCSI host adapter card driver&n;      By: YOKOTA Hiroshi &lt;yokota@netlab.is.tsukuba.ac.jp&gt;&n;&n;    Ver.2.8   Support 32bit MMIO mode&n;              Support Synchronous Data Transfer Request (SDTR) mode&n;    Ver.2.0   Support 32bit PIO mode&n;    Ver.1.1.2 Fix for scatter list buffer exceeds&n;    Ver.1.1   Support scatter list&n;    Ver.0.1   Initial version&n;&n;    This software may be used and distributed according to the terms of&n;    the GNU General Public License.&n;&n;======================================================================*/
multiline_comment|/***********************************************************************&n;    This driver is for these PCcards.&n;&n;&t;I-O DATA PCSC-F&t; (Workbit NinjaSCSI-3)&n;&t;&t;&t;&quot;WBT&quot;, &quot;NinjaSCSI-3&quot;, &quot;R1.0&quot;&n;&t;I-O DATA CBSC-II (Workbit NinjaSCSI-32Bi in 16bit mode)&n;&t;&t;&t;&quot;IO DATA&quot;, &quot;CBSC16&t; &quot;, &quot;1&quot;&n;&n;***********************************************************************/
multiline_comment|/* $Id: nsp_cs.c,v 1.23 2003/08/18 11:09:19 elca Exp $ */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;../drivers/scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_ioctl.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/cisreg.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
macro_line|#include &quot;nsp_cs.h&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;YOKOTA Hiroshi &lt;yokota@netlab.is.tsukuba.ac.jp&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;WorkBit NinjaSCSI-3 / NinjaSCSI-32Bi(16bit) PCMCIA SCSI host adapter module $Revision: 1.23 $&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;sd,sr,sg,st&quot;
)paren
suffix:semicolon
macro_line|#ifdef MODULE_LICENSE
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#include &quot;nsp_io.h&quot;
multiline_comment|/*====================================================================*/
multiline_comment|/* Parameters that can be set with &squot;insmod&squot; */
DECL|variable|irq_mask
r_static
r_int
r_int
id|irq_mask
op_assign
l_int|0xffff
suffix:semicolon
id|module_param
c_func
(paren
id|irq_mask
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq_mask
comma
l_string|&quot;IRQ mask bits (default: 0xffff)&quot;
)paren
suffix:semicolon
DECL|variable|irq_list
r_static
r_int
id|irq_list
(braket
l_int|4
)braket
op_assign
(brace
op_minus
l_int|1
)brace
suffix:semicolon
id|module_param_array
c_func
(paren
id|irq_list
comma
r_int
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq_list
comma
l_string|&quot;Use specified IRQ number. (default: auto select)&quot;
)paren
suffix:semicolon
DECL|variable|nsp_burst_mode
r_static
r_int
id|nsp_burst_mode
op_assign
id|BURST_MEM32
suffix:semicolon
id|module_param
c_func
(paren
id|nsp_burst_mode
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|nsp_burst_mode
comma
l_string|&quot;Burst transfer mode (0=io8, 1=io32, 2=mem32(default))&quot;
)paren
suffix:semicolon
multiline_comment|/* Release IO ports after configuration? */
DECL|variable|free_ports
r_static
r_int
id|free_ports
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|free_ports
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|free_ports
comma
l_string|&quot;Release IO ports after configuration? (default: 0 (=no))&quot;
)paren
suffix:semicolon
multiline_comment|/* /usr/src/linux/drivers/scsi/hosts.h */
DECL|variable|nsp_driver_template
r_static
id|Scsi_Host_Template
id|nsp_driver_template
op_assign
(brace
dot
id|proc_name
op_assign
l_string|&quot;nsp_cs&quot;
comma
dot
id|proc_info
op_assign
id|nsp_proc_info
comma
dot
id|name
op_assign
l_string|&quot;WorkBit NinjaSCSI-3/32Bi(16bit)&quot;
comma
macro_line|#if (LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,5,0))
dot
id|detect
op_assign
id|nsp_detect_old
comma
dot
id|release
op_assign
id|nsp_release_old
comma
macro_line|#endif
dot
id|info
op_assign
id|nsp_info
comma
dot
id|queuecommand
op_assign
id|nsp_queuecommand
comma
multiline_comment|/*&t;.eh_strategy_handler&t; = nsp_eh_strategy,*/
multiline_comment|/*&t;.eh_abort_handler&t; = nsp_eh_abort,*/
multiline_comment|/*&t;.eh_device_reset_handler = nsp_eh_device_reset,*/
dot
id|eh_bus_reset_handler
op_assign
id|nsp_eh_bus_reset
comma
dot
id|eh_host_reset_handler
op_assign
id|nsp_eh_host_reset
comma
dot
id|can_queue
op_assign
l_int|1
comma
dot
id|this_id
op_assign
id|NSP_INITIATOR_ID
comma
dot
id|sg_tablesize
op_assign
id|SG_ALL
comma
dot
id|cmd_per_lun
op_assign
l_int|1
comma
dot
id|use_clustering
op_assign
id|DISABLE_CLUSTERING
comma
macro_line|#if (LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,5,2))
dot
id|use_new_eh_code
op_assign
l_int|1
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|variable|dev_list
r_static
id|dev_link_t
op_star
id|dev_list
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|dev_info
r_static
id|dev_info_t
id|dev_info
op_assign
(brace
l_string|&quot;nsp_cs&quot;
)brace
suffix:semicolon
DECL|variable|nsp_data_base
r_static
id|nsp_hw_data
id|nsp_data_base
suffix:semicolon
multiline_comment|/* attach &lt;-&gt; detect glue */
multiline_comment|/*&n; * debug, error print&n; */
macro_line|#ifndef NSP_DEBUG
DECL|macro|NSP_DEBUG_MASK
macro_line|# define NSP_DEBUG_MASK&t;&t;0x000000
DECL|macro|nsp_msg
macro_line|# define nsp_msg(type, args...) nsp_cs_message(&quot;&quot;, 0, (type), args)
DECL|macro|nsp_dbg
macro_line|# define nsp_dbg(mask, args...) /* */
macro_line|#else
DECL|macro|NSP_DEBUG_MASK
macro_line|# define NSP_DEBUG_MASK&t;&t;0xffffff
DECL|macro|nsp_msg
macro_line|# define nsp_msg(type, args...) &bslash;&n;&t;nsp_cs_message (__FUNCTION__, __LINE__, (type), args)
DECL|macro|nsp_dbg
macro_line|# define nsp_dbg(mask, args...) &bslash;&n;&t;nsp_cs_dmessage(__FUNCTION__, __LINE__, (mask), args)
macro_line|#endif
DECL|macro|NSP_DEBUG_QUEUECOMMAND
mdefine_line|#define NSP_DEBUG_QUEUECOMMAND&t;&t;BIT(0)
DECL|macro|NSP_DEBUG_REGISTER
mdefine_line|#define NSP_DEBUG_REGISTER&t;&t;BIT(1)
DECL|macro|NSP_DEBUG_AUTOSCSI
mdefine_line|#define NSP_DEBUG_AUTOSCSI&t;&t;BIT(2)
DECL|macro|NSP_DEBUG_INTR
mdefine_line|#define NSP_DEBUG_INTR&t;&t;&t;BIT(3)
DECL|macro|NSP_DEBUG_SGLIST
mdefine_line|#define NSP_DEBUG_SGLIST&t;&t;BIT(4)
DECL|macro|NSP_DEBUG_BUSFREE
mdefine_line|#define NSP_DEBUG_BUSFREE&t;&t;BIT(5)
DECL|macro|NSP_DEBUG_CDB_CONTENTS
mdefine_line|#define NSP_DEBUG_CDB_CONTENTS&t;&t;BIT(6)
DECL|macro|NSP_DEBUG_RESELECTION
mdefine_line|#define NSP_DEBUG_RESELECTION&t;&t;BIT(7)
DECL|macro|NSP_DEBUG_MSGINOCCUR
mdefine_line|#define NSP_DEBUG_MSGINOCCUR&t;&t;BIT(8)
DECL|macro|NSP_DEBUG_EEPROM
mdefine_line|#define NSP_DEBUG_EEPROM&t;&t;BIT(9)
DECL|macro|NSP_DEBUG_MSGOUTOCCUR
mdefine_line|#define NSP_DEBUG_MSGOUTOCCUR&t;&t;BIT(10)
DECL|macro|NSP_DEBUG_BUSRESET
mdefine_line|#define NSP_DEBUG_BUSRESET&t;&t;BIT(11)
DECL|macro|NSP_DEBUG_RESTART
mdefine_line|#define NSP_DEBUG_RESTART&t;&t;BIT(12)
DECL|macro|NSP_DEBUG_SYNC
mdefine_line|#define NSP_DEBUG_SYNC&t;&t;&t;BIT(13)
DECL|macro|NSP_DEBUG_WAIT
mdefine_line|#define NSP_DEBUG_WAIT&t;&t;&t;BIT(14)
DECL|macro|NSP_DEBUG_TARGETFLAG
mdefine_line|#define NSP_DEBUG_TARGETFLAG&t;&t;BIT(15)
DECL|macro|NSP_DEBUG_PROC
mdefine_line|#define NSP_DEBUG_PROC&t;&t;&t;BIT(16)
DECL|macro|NSP_DEBUG_INIT
mdefine_line|#define NSP_DEBUG_INIT&t;&t;&t;BIT(17)
DECL|macro|NSP_DEBUG_DATA_IO
mdefine_line|#define NSP_DEBUG_DATA_IO      &t;&t;BIT(18)
DECL|macro|NSP_SPECIAL_PRINT_REGISTER
mdefine_line|#define NSP_SPECIAL_PRINT_REGISTER&t;BIT(20)
DECL|macro|NSP_DEBUG_BUF_LEN
mdefine_line|#define NSP_DEBUG_BUF_LEN&t;&t;150
DECL|function|nsp_cs_message
r_static
r_void
id|nsp_cs_message
c_func
(paren
r_const
r_char
op_star
id|func
comma
r_int
id|line
comma
r_char
op_star
id|type
comma
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_char
id|buf
(braket
id|NSP_DEBUG_BUF_LEN
)braket
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsnprintf
c_func
(paren
id|buf
comma
r_sizeof
(paren
id|buf
)paren
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
macro_line|#ifndef NSP_DEBUG
id|printk
c_func
(paren
l_string|&quot;%snsp_cs: %s&bslash;n&quot;
comma
id|type
comma
id|buf
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;%snsp_cs: %s (%d): %s&bslash;n&quot;
comma
id|type
comma
id|func
comma
id|line
comma
id|buf
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef NSP_DEBUG
DECL|function|nsp_cs_dmessage
r_static
r_void
id|nsp_cs_dmessage
c_func
(paren
r_const
r_char
op_star
id|func
comma
r_int
id|line
comma
r_int
id|mask
comma
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_char
id|buf
(braket
id|NSP_DEBUG_BUF_LEN
)braket
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsnprintf
c_func
(paren
id|buf
comma
r_sizeof
(paren
id|buf
)paren
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
id|NSP_DEBUG_MASK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nsp_cs-debug: 0x%x %s (%d): %s&bslash;n&quot;
comma
id|mask
comma
id|func
comma
id|line
comma
id|buf
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/***********************************************************/
multiline_comment|/*====================================================&n; * Clenaup parameters and call done() functions.&n; * You must be set SCpnt-&gt;result before call this function.&n; */
DECL|function|nsp_scsi_done
r_static
r_void
id|nsp_scsi_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|data-&gt;CurrentSC
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
DECL|function|nsp_queuecommand
r_static
r_int
id|nsp_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
macro_line|#ifdef NSP_DEBUG
multiline_comment|/*unsigned int host_id = SCpnt-&gt;device-&gt;host-&gt;this_id;*/
multiline_comment|/*unsigned int base    = SCpnt-&gt;device-&gt;host-&gt;io_port;*/
r_int
r_char
id|target
op_assign
id|SCpnt-&gt;device-&gt;id
suffix:semicolon
macro_line|#endif
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_QUEUECOMMAND
comma
l_string|&quot;SCpnt=0x%p target=%d lun=%d buff=0x%p bufflen=%d use_sg=%d&quot;
comma
id|SCpnt
comma
id|target
comma
id|SCpnt-&gt;device-&gt;lun
comma
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;request_bufflen
comma
id|SCpnt-&gt;use_sg
)paren
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_QUEUECOMMAND, &quot;before CurrentSC=0x%p&quot;, data-&gt;CurrentSC);
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;CurrentSC
op_ne
l_int|NULL
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;CurrentSC!=NULL this can&squot;t be happen&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
id|nsp_scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* XXX: pcmcia-cs generates SCSI command with &quot;scsi_info&quot; utility.&n;&t;        This makes kernel crash when suspending... */
r_if
c_cond
(paren
id|data-&gt;ScsiInfo-&gt;stop
op_ne
l_int|0
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;suspending device. reject command.&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
id|nsp_scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
)brace
macro_line|#endif
id|show_command
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|data-&gt;CurrentSC
op_assign
id|SCpnt
suffix:semicolon
id|SCpnt-&gt;SCp.Status
op_assign
id|CHECK_CONDITION
suffix:semicolon
id|SCpnt-&gt;SCp.Message
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.have_data_in
op_assign
id|IO_UNKNOWN
suffix:semicolon
id|SCpnt-&gt;SCp.sent_command
op_assign
l_int|0
suffix:semicolon
id|SCpnt-&gt;SCp.phase
op_assign
id|PH_UNDETERMINED
suffix:semicolon
id|SCpnt-&gt;resid
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
multiline_comment|/* setup scratch area&n;&t;   SCp.ptr&t;&t;: buffer pointer&n;&t;   SCp.this_residual&t;: buffer length&n;&t;   SCp.buffer&t;&t;: next buffer&n;&t;   SCp.buffers_residual : left buffers in list&n;&t;   SCp.phase&t;&t;: current state of the command */
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|SCpnt-&gt;SCp.buffer
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
id|BUFFER_ADDR
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;SCp.buffer-&gt;length
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
id|SCpnt-&gt;use_sg
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|SCpnt-&gt;SCp.ptr
op_assign
(paren
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|SCpnt-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
id|SCpnt-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nsphw_start_selection
c_func
(paren
id|SCpnt
)paren
op_eq
id|FALSE
)paren
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_QUEUECOMMAND
comma
l_string|&quot;selection fail&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|nsp_scsi_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//nsp_dbg(NSP_DEBUG_QUEUECOMMAND, &quot;out&quot;);
macro_line|#ifdef NSP_DEBUG
id|data-&gt;CmdId
op_increment
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * setup PIO FIFO transfer mode and enable/disable to data out&n; */
DECL|function|nsp_setup_fifo
r_static
r_void
id|nsp_setup_fifo
c_func
(paren
id|nsp_hw_data
op_star
id|data
comma
r_int
id|enabled
)paren
(brace
r_int
r_int
id|base
op_assign
id|data-&gt;BaseAddress
suffix:semicolon
r_int
r_char
id|transfer_mode_reg
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;enabled=%d&quot;, enabled);
r_if
c_cond
(paren
id|enabled
op_ne
id|FALSE
)paren
(brace
id|transfer_mode_reg
op_assign
id|TRANSFER_GO
op_or
id|BRAIND
suffix:semicolon
)brace
r_else
(brace
id|transfer_mode_reg
op_assign
l_int|0
suffix:semicolon
)brace
id|transfer_mode_reg
op_or_assign
id|data-&gt;TransferMode
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|TRANSFERMODE
comma
id|transfer_mode_reg
)paren
suffix:semicolon
)brace
DECL|function|nsphw_init_sync
r_static
r_void
id|nsphw_init_sync
c_func
(paren
id|nsp_hw_data
op_star
id|data
)paren
(brace
id|sync_data
id|tmp_sync
op_assign
(brace
dot
id|SyncNegotiation
op_assign
id|SYNC_NOT_YET
comma
dot
id|SyncPeriod
op_assign
l_int|0
comma
dot
id|SyncOffset
op_assign
l_int|0
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* setup sync data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|data-&gt;Sync
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data-&gt;Sync
(braket
id|i
)braket
op_assign
id|tmp_sync
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Initialize Ninja hardware&n; */
DECL|function|nsphw_init
r_static
r_int
id|nsphw_init
c_func
(paren
id|nsp_hw_data
op_star
id|data
)paren
(brace
r_int
r_int
id|base
op_assign
id|data-&gt;BaseAddress
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;in base=0x%x&quot;
comma
id|base
)paren
suffix:semicolon
id|data-&gt;ScsiClockDiv
op_assign
id|CLOCK_40M
op_or
id|FAST_20
suffix:semicolon
id|data-&gt;CurrentSC
op_assign
l_int|NULL
suffix:semicolon
id|data-&gt;FifoCount
op_assign
l_int|0
suffix:semicolon
id|data-&gt;TransferMode
op_assign
id|MODE_IO8
suffix:semicolon
id|nsphw_init_sync
c_func
(paren
id|data
)paren
suffix:semicolon
multiline_comment|/* block all interrupts */
id|nsp_write
c_func
(paren
id|base
comma
id|IRQCONTROL
comma
id|IRQCONTROL_ALLMASK
)paren
suffix:semicolon
multiline_comment|/* setup SCSI interface */
id|nsp_write
c_func
(paren
id|base
comma
id|IFSELECT
comma
id|IF_IFSEL
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIIRQMODE
comma
l_int|0
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|TRANSFERMODE
comma
id|MODE_IO8
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|CLOCKDIV
comma
id|data-&gt;ScsiClockDiv
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|PARITYCTRL
comma
l_int|0
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|POINTERCLR
comma
id|POINTER_CLEAR
op_or
id|ACK_COUNTER_CLEAR
op_or
id|REQ_COUNTER_CLEAR
op_or
id|HOST_COUNTER_CLEAR
)paren
suffix:semicolon
multiline_comment|/* setup fifo asic */
id|nsp_write
c_func
(paren
id|base
comma
id|IFSELECT
comma
id|IF_REGSEL
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|TERMPWRCTRL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nsp_index_read
c_func
(paren
id|base
comma
id|OTHERCONTROL
)paren
op_amp
id|TPWR_SENSE
)paren
op_eq
l_int|0
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;terminator power on&quot;
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|TERMPWRCTRL
comma
id|POWER_ON
)paren
suffix:semicolon
)brace
id|nsp_index_write
c_func
(paren
id|base
comma
id|TIMERCOUNT
comma
l_int|0
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|TIMERCOUNT
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* requires 2 times!! */
id|nsp_index_write
c_func
(paren
id|base
comma
id|SYNCREG
comma
l_int|0
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|ACKWIDTH
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* enable interrupts and ack them */
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIIRQMODE
comma
id|SCSI_PHASE_CHANGE_EI
op_or
id|RESELECT_EI
op_or
id|SCSI_RESET_IRQ_EI
)paren
suffix:semicolon
id|nsp_write
c_func
(paren
id|base
comma
id|IRQCONTROL
comma
id|IRQCONTROL_ALLCLEAR
)paren
suffix:semicolon
id|nsp_setup_fifo
c_func
(paren
id|data
comma
id|FALSE
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; * Start selection phase&n; */
DECL|function|nsphw_start_selection
r_static
r_int
id|nsphw_start_selection
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_int
id|host_id
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;this_id
suffix:semicolon
r_int
r_int
id|base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;io_port
suffix:semicolon
r_int
r_char
id|target
op_assign
id|SCpnt-&gt;device-&gt;id
suffix:semicolon
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_int
id|time_out
suffix:semicolon
r_int
r_char
id|phase
comma
id|arbit
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_RESELECTION, &quot;in&quot;);
id|phase
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|SCSIBUSMON
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phase
op_ne
id|BUSMON_BUS_FREE
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_RESELECTION, &quot;bus busy&quot;);
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* start arbitration */
singleline_comment|//nsp_dbg(NSP_DEBUG_RESELECTION, &quot;start arbit&quot;);
id|SCpnt-&gt;SCp.phase
op_assign
id|PH_ARBSTART
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|SETARBIT
comma
id|ARBIT_GO
)paren
suffix:semicolon
id|time_out
op_assign
l_int|1000
suffix:semicolon
r_do
(brace
multiline_comment|/* XXX: what a stupid chip! */
id|arbit
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|ARBITSTATUS
)paren
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_RESELECTION, &quot;arbit=%d, wait_count=%d&quot;, arbit, wait_count);
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* hold 1.2us */
)brace
r_while
c_loop
(paren
(paren
id|arbit
op_amp
(paren
id|ARBIT_WIN
op_or
id|ARBIT_FAIL
)paren
)paren
op_eq
l_int|0
op_logical_and
(paren
id|time_out
op_decrement
op_ne
l_int|0
)paren
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|arbit
op_amp
id|ARBIT_WIN
)paren
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_RESELECTION, &quot;arbit fail&quot;);
id|nsp_index_write
c_func
(paren
id|base
comma
id|SETARBIT
comma
id|ARBIT_FLAG_CLEAR
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* assert select line */
singleline_comment|//nsp_dbg(NSP_DEBUG_RESELECTION, &quot;assert SEL line&quot;);
id|SCpnt-&gt;SCp.phase
op_assign
id|PH_SELSTART
suffix:semicolon
id|udelay
c_func
(paren
l_int|3
)paren
suffix:semicolon
multiline_comment|/* wait 2.4us */
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIDATALATCH
comma
id|BIT
c_func
(paren
id|host_id
)paren
op_or
id|BIT
c_func
(paren
id|target
)paren
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
comma
id|SCSI_SEL
op_or
id|SCSI_BSY
op_or
id|SCSI_ATN
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* wait &gt;1.2us */
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
comma
id|SCSI_SEL
op_or
id|SCSI_BSY
op_or
id|SCSI_DATAOUT_ENB
op_or
id|SCSI_ATN
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|SETARBIT
comma
id|ARBIT_FLAG_CLEAR
)paren
suffix:semicolon
multiline_comment|/*udelay(1);*/
multiline_comment|/* wait &gt;90ns */
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
comma
id|SCSI_SEL
op_or
id|SCSI_DATAOUT_ENB
op_or
id|SCSI_ATN
)paren
suffix:semicolon
multiline_comment|/* check selection timeout */
id|nsp_start_timer
c_func
(paren
id|SCpnt
comma
l_int|1000
op_div
l_int|51
)paren
suffix:semicolon
id|data-&gt;SelectionTimeOut
op_assign
l_int|1
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
DECL|struct|nsp_sync_table
r_struct
id|nsp_sync_table
(brace
DECL|member|min_period
r_int
r_int
id|min_period
suffix:semicolon
DECL|member|max_period
r_int
r_int
id|max_period
suffix:semicolon
DECL|member|chip_period
r_int
r_int
id|chip_period
suffix:semicolon
DECL|member|ack_width
r_int
r_int
id|ack_width
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|nsp_sync_table_40M
r_static
r_struct
id|nsp_sync_table
id|nsp_sync_table_40M
(braket
)braket
op_assign
(brace
(brace
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x1
comma
l_int|0
)brace
comma
multiline_comment|/* 20MB&t;  50ns*/
(brace
l_int|0x19
comma
l_int|0x19
comma
l_int|0x3
comma
l_int|1
)brace
comma
multiline_comment|/* 10MB&t; 100ns*/
(brace
l_int|0x1a
comma
l_int|0x25
comma
l_int|0x5
comma
l_int|2
)brace
comma
multiline_comment|/* 7.5MB 150ns*/
(brace
l_int|0x26
comma
l_int|0x32
comma
l_int|0x7
comma
l_int|3
)brace
comma
multiline_comment|/* 5MB&t; 200ns*/
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|variable|nsp_sync_table_20M
r_static
r_struct
id|nsp_sync_table
id|nsp_sync_table_20M
(braket
)braket
op_assign
(brace
(brace
l_int|0x19
comma
l_int|0x19
comma
l_int|0x1
comma
l_int|0
)brace
comma
multiline_comment|/* 10MB&t; 100ns*/
(brace
l_int|0x1a
comma
l_int|0x25
comma
l_int|0x2
comma
l_int|0
)brace
comma
multiline_comment|/* 7.5MB 150ns*/
(brace
l_int|0x26
comma
l_int|0x32
comma
l_int|0x3
comma
l_int|1
)brace
comma
multiline_comment|/* 5MB&t; 200ns*/
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * setup synchronous data transfer mode&n; */
DECL|function|nsp_analyze_sdtr
r_static
r_int
id|nsp_analyze_sdtr
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_char
id|target
op_assign
id|SCpnt-&gt;device-&gt;id
suffix:semicolon
singleline_comment|//&t;unsigned char&t;       lun    = SCpnt-&gt;device-&gt;lun;
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|sync_data
op_star
id|sync
op_assign
op_amp
(paren
id|data-&gt;Sync
(braket
id|target
)braket
)paren
suffix:semicolon
r_struct
id|nsp_sync_table
op_star
id|sync_table
suffix:semicolon
r_int
r_int
id|period
comma
id|offset
suffix:semicolon
r_int
id|i
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_SYNC
comma
l_string|&quot;in&quot;
)paren
suffix:semicolon
id|period
op_assign
id|sync-&gt;SyncPeriod
suffix:semicolon
id|offset
op_assign
id|sync-&gt;SyncOffset
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_SYNC
comma
l_string|&quot;period=0x%x, offset=0x%x&quot;
comma
id|period
comma
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data-&gt;ScsiClockDiv
op_amp
(paren
id|BIT
c_func
(paren
l_int|0
)paren
op_or
id|BIT
c_func
(paren
l_int|1
)paren
)paren
)paren
op_eq
id|CLOCK_20M
)paren
(brace
id|sync_table
op_assign
id|nsp_sync_table_20M
suffix:semicolon
)brace
r_else
(brace
id|sync_table
op_assign
id|nsp_sync_table_40M
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|sync_table-&gt;max_period
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
comma
id|sync_table
op_increment
)paren
(brace
r_if
c_cond
(paren
id|period
op_ge
id|sync_table-&gt;min_period
op_logical_and
id|period
op_le
id|sync_table-&gt;max_period
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|period
op_ne
l_int|0
op_logical_and
id|sync_table-&gt;max_period
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * No proper period/offset found&n;&t;&t; */
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_SYNC
comma
l_string|&quot;no proper period/offset&quot;
)paren
suffix:semicolon
id|sync-&gt;SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|sync-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
id|sync-&gt;SyncRegister
op_assign
l_int|0
suffix:semicolon
id|sync-&gt;AckWidth
op_assign
l_int|0
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|sync-&gt;SyncRegister
op_assign
(paren
id|sync_table-&gt;chip_period
op_lshift
id|SYNCREG_PERIOD_SHIFT
)paren
op_or
(paren
id|offset
op_amp
id|SYNCREG_OFFSET_MASK
)paren
suffix:semicolon
id|sync-&gt;AckWidth
op_assign
id|sync_table-&gt;ack_width
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_SYNC
comma
l_string|&quot;sync_reg=0x%x, ack_width=0x%x&quot;
comma
id|sync-&gt;SyncRegister
comma
id|sync-&gt;AckWidth
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; * start ninja hardware timer&n; */
DECL|function|nsp_start_timer
r_static
r_void
id|nsp_start_timer
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
id|time
)paren
(brace
r_int
r_int
id|base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;io_port
suffix:semicolon
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;in SCpnt=0x%p, time=%d&quot;, SCpnt, time);
id|data-&gt;TimerCount
op_assign
id|time
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|TIMERCOUNT
comma
id|time
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * wait for bus phase change&n; */
DECL|function|nsp_negate_signal
r_static
r_int
id|nsp_negate_signal
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_char
id|mask
comma
r_char
op_star
id|str
)paren
(brace
r_int
r_int
id|base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;io_port
suffix:semicolon
r_int
r_char
id|reg
suffix:semicolon
r_int
id|time_out
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;in&quot;);
id|time_out
op_assign
l_int|100
suffix:semicolon
r_do
(brace
id|reg
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|SCSIBUSMON
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_eq
l_int|0xff
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|time_out
op_decrement
op_ne
l_int|0
)paren
op_logical_and
(paren
id|reg
op_amp
id|mask
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_out
op_eq
l_int|0
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot; %s signal off timeut&quot;
comma
id|str
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * expect Ninja Irq&n; */
DECL|function|nsp_expect_signal
r_static
r_int
id|nsp_expect_signal
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_char
id|current_phase
comma
r_int
r_char
id|mask
)paren
(brace
r_int
r_int
id|base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;io_port
suffix:semicolon
r_int
id|time_out
suffix:semicolon
r_int
r_char
id|phase
comma
id|i_src
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;current_phase=0x%x, mask=0x%x&quot;, current_phase, mask);
id|time_out
op_assign
l_int|100
suffix:semicolon
r_do
(brace
id|phase
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|SCSIBUSMON
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phase
op_eq
l_int|0xff
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;ret -1&quot;);
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|i_src
op_assign
id|nsp_read
c_func
(paren
id|base
comma
id|IRQSTATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i_src
op_amp
id|IRQSTATUS_SCSI
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;ret 0 found scsi signal&quot;);
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|phase
op_amp
id|mask
)paren
op_ne
l_int|0
op_logical_and
(paren
id|phase
op_amp
id|BUSMON_PHASE_MASK
)paren
op_eq
id|current_phase
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;ret 1 phase=0x%x&quot;, phase);
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|time_out
op_decrement
op_ne
l_int|0
)paren
(brace
suffix:semicolon
)brace
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;timeout&quot;);
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * transfer SCSI message&n; */
DECL|function|nsp_xfer
r_static
r_int
id|nsp_xfer
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
id|phase
)paren
(brace
r_int
r_int
id|base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;io_port
suffix:semicolon
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|data-&gt;MsgBuffer
suffix:semicolon
r_int
id|len
op_assign
id|min
c_func
(paren
id|MSGBUF_SIZE
comma
id|data-&gt;MsgLen
)paren
suffix:semicolon
r_int
id|ptr
suffix:semicolon
r_int
id|ret
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;in&quot;);
r_for
c_loop
(paren
id|ptr
op_assign
l_int|0
suffix:semicolon
id|len
OG
l_int|0
suffix:semicolon
id|len
op_decrement
comma
id|ptr
op_increment
)paren
(brace
id|ret
op_assign
id|nsp_expect_signal
c_func
(paren
id|SCpnt
comma
id|phase
comma
id|BUSMON_REQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_le
l_int|0
)paren
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;xfer quit&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* if last byte, negate ATN */
r_if
c_cond
(paren
id|len
op_eq
l_int|1
op_logical_and
id|SCpnt-&gt;SCp.phase
op_eq
id|PH_MSG_OUT
)paren
(brace
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
comma
id|AUTODIRECTION
op_or
id|ACKENB
)paren
suffix:semicolon
)brace
multiline_comment|/* read &amp; write message */
r_if
c_cond
(paren
id|phase
op_amp
id|BUSMON_IO
)paren
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;read msg&quot;
)paren
suffix:semicolon
id|buf
(braket
id|ptr
)braket
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|SCSIDATAWITHACK
)paren
suffix:semicolon
)brace
r_else
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;write msg&quot;
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIDATAWITHACK
comma
id|buf
(braket
id|ptr
)braket
)paren
suffix:semicolon
)brace
id|nsp_negate_signal
c_func
(paren
id|SCpnt
comma
id|BUSMON_ACK
comma
l_string|&quot;xfer&lt;ack&gt;&quot;
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * get extra SCSI data from fifo&n; */
DECL|function|nsp_dataphase_bypass
r_static
r_int
id|nsp_dataphase_bypass
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_int
r_int
id|count
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;in&quot;);
r_if
c_cond
(paren
id|SCpnt-&gt;SCp.have_data_in
op_ne
id|IO_IN
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|count
op_assign
id|nsp_fifo_count
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;FifoCount
op_eq
id|count
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;not use bypass quirk&quot;);
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * XXX: NSP_QUIRK&n;&t; * data phase skip only occures in case of SCSI_LOW_READ&n;&t; */
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;use bypass quirk&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;SCp.phase
op_assign
id|PH_DATA
suffix:semicolon
id|nsp_pio_read
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|nsp_setup_fifo
c_func
(paren
id|data
comma
id|FALSE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * accept reselection&n; */
DECL|function|nsp_reselected
r_static
r_int
id|nsp_reselected
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_int
id|base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;io_port
suffix:semicolon
r_int
r_int
id|host_id
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;this_id
suffix:semicolon
singleline_comment|//nsp_hw_data *data = (nsp_hw_data *)SCpnt-&gt;device-&gt;host-&gt;hostdata;
r_int
r_char
id|bus_reg
suffix:semicolon
r_int
r_char
id|id_reg
comma
id|tmp
suffix:semicolon
r_int
id|target
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_RESELECTION
comma
l_string|&quot;in&quot;
)paren
suffix:semicolon
id|id_reg
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|RESELECTID
)paren
suffix:semicolon
id|tmp
op_assign
id|id_reg
op_amp
(paren
op_complement
id|BIT
c_func
(paren
id|host_id
)paren
)paren
suffix:semicolon
id|target
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tmp
op_amp
id|BIT
c_func
(paren
l_int|0
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|tmp
op_rshift_assign
l_int|1
suffix:semicolon
id|target
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;id
op_ne
id|target
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;XXX: reselect ID must be %d in this implementation.&quot;
comma
id|target
)paren
suffix:semicolon
)brace
id|nsp_negate_signal
c_func
(paren
id|SCpnt
comma
id|BUSMON_SEL
comma
l_string|&quot;reselect&lt;SEL&gt;&quot;
)paren
suffix:semicolon
id|nsp_nexus
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|bus_reg
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
)paren
op_amp
op_complement
(paren
id|SCSI_BSY
op_or
id|SCSI_ATN
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
comma
id|bus_reg
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
comma
id|bus_reg
op_or
id|AUTODIRECTION
op_or
id|ACKENB
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*&n; * count how many data transferd&n; */
DECL|function|nsp_fifo_count
r_static
r_int
id|nsp_fifo_count
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_int
id|base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;io_port
suffix:semicolon
r_int
r_int
id|count
suffix:semicolon
r_int
r_int
id|l
comma
id|m
comma
id|h
comma
id|dummy
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|POINTERCLR
comma
id|POINTER_CLEAR
op_or
id|ACK_COUNTER
)paren
suffix:semicolon
id|l
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|TRANSFERCOUNT
)paren
suffix:semicolon
id|m
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|TRANSFERCOUNT
)paren
suffix:semicolon
id|h
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|TRANSFERCOUNT
)paren
suffix:semicolon
id|dummy
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|TRANSFERCOUNT
)paren
suffix:semicolon
multiline_comment|/* required this! */
id|count
op_assign
(paren
id|h
op_lshift
l_int|16
)paren
op_or
(paren
id|m
op_lshift
l_int|8
)paren
op_or
(paren
id|l
op_lshift
l_int|0
)paren
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;count=0x%x&quot;, count);
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* fifo size */
DECL|macro|RFIFO_CRIT
mdefine_line|#define RFIFO_CRIT 64
DECL|macro|WFIFO_CRIT
mdefine_line|#define WFIFO_CRIT 64
multiline_comment|/*&n; * read data in DATA IN phase&n; */
DECL|function|nsp_pio_read
r_static
r_void
id|nsp_pio_read
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_int
id|base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;io_port
suffix:semicolon
r_int
r_int
id|mmio_base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;base
suffix:semicolon
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_int
id|time_out
suffix:semicolon
r_int
id|ocount
comma
id|res
suffix:semicolon
r_int
r_char
id|stat
comma
id|fifo_stat
suffix:semicolon
id|ocount
op_assign
id|data-&gt;FifoCount
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;in SCpnt=0x%p resid=%d ocount=%d ptr=0x%p this_residual=%d buffers=0x%p nbuf=%d&quot;
comma
id|SCpnt
comma
id|SCpnt-&gt;resid
comma
id|ocount
comma
id|SCpnt-&gt;SCp.ptr
comma
id|SCpnt-&gt;SCp.this_residual
comma
id|SCpnt-&gt;SCp.buffer
comma
id|SCpnt-&gt;SCp.buffers_residual
)paren
suffix:semicolon
id|time_out
op_assign
l_int|1000
suffix:semicolon
r_while
c_loop
(paren
(paren
id|time_out
op_decrement
op_ne
l_int|0
)paren
op_logical_and
(paren
id|SCpnt-&gt;SCp.this_residual
OG
l_int|0
op_logical_or
id|SCpnt-&gt;SCp.buffers_residual
OG
l_int|0
)paren
)paren
(brace
id|stat
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|SCSIBUSMON
)paren
suffix:semicolon
id|stat
op_and_assign
id|BUSMON_PHASE_MASK
suffix:semicolon
id|res
op_assign
id|nsp_fifo_count
c_func
(paren
id|SCpnt
)paren
op_minus
id|ocount
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;ptr=0x%p this=0x%x ocount=0x%x res=0x%x&quot;, SCpnt-&gt;SCp.ptr, SCpnt-&gt;SCp.this_residual, ocount, res);
r_if
c_cond
(paren
id|res
op_eq
l_int|0
)paren
(brace
multiline_comment|/* if some data avilable ? */
r_if
c_cond
(paren
id|stat
op_eq
id|BUSPHASE_DATA_IN
)paren
(brace
multiline_comment|/* phase changed? */
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot; wait for data this=%d&quot;, SCpnt-&gt;SCp.this_residual);
r_continue
suffix:semicolon
)brace
r_else
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;phase changed stat=0x%x&quot;
comma
id|stat
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|fifo_stat
op_assign
id|nsp_read
c_func
(paren
id|base
comma
id|FIFOSTATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fifo_stat
op_amp
id|FIFOSTATUS_FULL_EMPTY
)paren
op_eq
l_int|0
op_logical_and
id|stat
op_eq
id|BUSPHASE_DATA_IN
)paren
(brace
r_continue
suffix:semicolon
)brace
id|res
op_assign
id|min
c_func
(paren
id|res
comma
id|SCpnt-&gt;SCp.this_residual
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|data-&gt;TransferMode
)paren
(brace
r_case
id|MODE_IO32
suffix:colon
id|res
op_and_assign
op_complement
(paren
id|BIT
c_func
(paren
l_int|1
)paren
op_or
id|BIT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* align 4 */
id|nsp_fifo32_read
c_func
(paren
id|base
comma
id|SCpnt-&gt;SCp.ptr
comma
id|res
op_rshift
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_IO8
suffix:colon
id|nsp_fifo8_read
(paren
id|base
comma
id|SCpnt-&gt;SCp.ptr
comma
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_MEM32
suffix:colon
id|res
op_and_assign
op_complement
(paren
id|BIT
c_func
(paren
l_int|1
)paren
op_or
id|BIT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* align 4 */
id|nsp_mmio_fifo32_read
c_func
(paren
id|mmio_base
comma
id|SCpnt-&gt;SCp.ptr
comma
id|res
op_rshift
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;unknown read mode&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|SCpnt-&gt;resid
op_sub_assign
id|res
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_add_assign
id|res
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_sub_assign
id|res
suffix:semicolon
id|ocount
op_add_assign
id|res
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;ptr=0x%p this_residual=0x%x ocount=0x%x&quot;, SCpnt-&gt;SCp.ptr, SCpnt-&gt;SCp.this_residual, ocount);
multiline_comment|/* go to next scatter list if available */
r_if
c_cond
(paren
id|SCpnt-&gt;SCp.this_residual
op_eq
l_int|0
op_logical_and
id|SCpnt-&gt;SCp.buffers_residual
op_ne
l_int|0
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;scatterlist next timeout=%d&quot;, time_out);
id|SCpnt-&gt;SCp.buffers_residual
op_decrement
suffix:semicolon
id|SCpnt-&gt;SCp.buffer
op_increment
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
id|BUFFER_ADDR
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;SCp.buffer-&gt;length
suffix:semicolon
id|time_out
op_assign
l_int|1000
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;page: 0x%p, off: 0x%x&quot;, SCpnt-&gt;SCp.buffer-&gt;page, SCpnt-&gt;SCp.buffer-&gt;offset);
)brace
)brace
id|data-&gt;FifoCount
op_assign
id|ocount
suffix:semicolon
r_if
c_cond
(paren
id|time_out
op_eq
l_int|0
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;pio read timeout resid=%d this_residual=%d buffers_residual=%d&quot;
comma
id|SCpnt-&gt;resid
comma
id|SCpnt-&gt;SCp.this_residual
comma
id|SCpnt-&gt;SCp.buffers_residual
)paren
suffix:semicolon
)brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;read ocount=0x%x&quot;
comma
id|ocount
)paren
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;r cmd=%d resid=0x%x&bslash;n&quot;
comma
id|data-&gt;CmdId
comma
id|SCpnt-&gt;resid
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * write data in DATA OUT phase&n; */
DECL|function|nsp_pio_write
r_static
r_void
id|nsp_pio_write
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_int
id|base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;io_port
suffix:semicolon
r_int
r_int
id|mmio_base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;base
suffix:semicolon
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_int
id|time_out
suffix:semicolon
r_int
id|ocount
comma
id|res
suffix:semicolon
r_int
r_char
id|stat
suffix:semicolon
id|ocount
op_assign
id|data-&gt;FifoCount
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;in fifocount=%d ptr=0x%p this_residual=%d buffers=0x%p nbuf=%d resid=0x%x&quot;
comma
id|data-&gt;FifoCount
comma
id|SCpnt-&gt;SCp.ptr
comma
id|SCpnt-&gt;SCp.this_residual
comma
id|SCpnt-&gt;SCp.buffer
comma
id|SCpnt-&gt;SCp.buffers_residual
comma
id|SCpnt-&gt;resid
)paren
suffix:semicolon
id|time_out
op_assign
l_int|1000
suffix:semicolon
r_while
c_loop
(paren
(paren
id|time_out
op_decrement
op_ne
l_int|0
)paren
op_logical_and
(paren
id|SCpnt-&gt;SCp.this_residual
OG
l_int|0
op_logical_or
id|SCpnt-&gt;SCp.buffers_residual
OG
l_int|0
)paren
)paren
(brace
id|stat
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|SCSIBUSMON
)paren
suffix:semicolon
id|stat
op_and_assign
id|BUSMON_PHASE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_ne
id|BUSPHASE_DATA_OUT
)paren
(brace
id|res
op_assign
id|ocount
op_minus
id|nsp_fifo_count
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;phase changed stat=0x%x, res=%d&bslash;n&quot;
comma
id|stat
comma
id|res
)paren
suffix:semicolon
multiline_comment|/* Put back pointer */
id|SCpnt-&gt;resid
op_add_assign
id|res
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_sub_assign
id|res
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_add_assign
id|res
suffix:semicolon
id|ocount
op_sub_assign
id|res
suffix:semicolon
r_break
suffix:semicolon
)brace
id|res
op_assign
id|ocount
op_minus
id|nsp_fifo_count
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OG
l_int|0
)paren
(brace
multiline_comment|/* write all data? */
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;wait for all data out. ocount=0x%x res=%d&quot;
comma
id|ocount
comma
id|res
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|res
op_assign
id|min
c_func
(paren
id|SCpnt-&gt;SCp.this_residual
comma
id|WFIFO_CRIT
)paren
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;ptr=0x%p this=0x%x res=0x%x&quot;, SCpnt-&gt;SCp.ptr, SCpnt-&gt;SCp.this_residual, res);
r_switch
c_cond
(paren
id|data-&gt;TransferMode
)paren
(brace
r_case
id|MODE_IO32
suffix:colon
id|res
op_and_assign
op_complement
(paren
id|BIT
c_func
(paren
l_int|1
)paren
op_or
id|BIT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* align 4 */
id|nsp_fifo32_write
c_func
(paren
id|base
comma
id|SCpnt-&gt;SCp.ptr
comma
id|res
op_rshift
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_IO8
suffix:colon
id|nsp_fifo8_write
(paren
id|base
comma
id|SCpnt-&gt;SCp.ptr
comma
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_MEM32
suffix:colon
id|res
op_and_assign
op_complement
(paren
id|BIT
c_func
(paren
l_int|1
)paren
op_or
id|BIT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* align 4 */
id|nsp_mmio_fifo32_write
c_func
(paren
id|mmio_base
comma
id|SCpnt-&gt;SCp.ptr
comma
id|res
op_rshift
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;unknown write mode&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SCpnt-&gt;resid
op_sub_assign
id|res
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_add_assign
id|res
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_sub_assign
id|res
suffix:semicolon
id|ocount
op_add_assign
id|res
suffix:semicolon
multiline_comment|/* go to next scatter list if available */
r_if
c_cond
(paren
id|SCpnt-&gt;SCp.this_residual
op_eq
l_int|0
op_logical_and
id|SCpnt-&gt;SCp.buffers_residual
op_ne
l_int|0
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;scatterlist next&quot;);
id|SCpnt-&gt;SCp.buffers_residual
op_decrement
suffix:semicolon
id|SCpnt-&gt;SCp.buffer
op_increment
suffix:semicolon
id|SCpnt-&gt;SCp.ptr
op_assign
id|BUFFER_ADDR
suffix:semicolon
id|SCpnt-&gt;SCp.this_residual
op_assign
id|SCpnt-&gt;SCp.buffer-&gt;length
suffix:semicolon
id|time_out
op_assign
l_int|1000
suffix:semicolon
)brace
)brace
id|data-&gt;FifoCount
op_assign
id|ocount
suffix:semicolon
r_if
c_cond
(paren
id|time_out
op_eq
l_int|0
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;pio write timeout resid=0x%x&quot;
comma
id|SCpnt-&gt;resid
)paren
suffix:semicolon
)brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;write ocount=0x%x&quot;
comma
id|ocount
)paren
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_DATA_IO
comma
l_string|&quot;w cmd=%d resid=0x%x&bslash;n&quot;
comma
id|data-&gt;CmdId
comma
id|SCpnt-&gt;resid
)paren
suffix:semicolon
)brace
DECL|macro|RFIFO_CRIT
macro_line|#undef RFIFO_CRIT
DECL|macro|WFIFO_CRIT
macro_line|#undef WFIFO_CRIT
multiline_comment|/*&n; * setup synchronous/asynchronous data transfer mode&n; */
DECL|function|nsp_nexus
r_static
r_int
id|nsp_nexus
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_int
id|base
op_assign
id|SCpnt-&gt;device-&gt;host-&gt;io_port
suffix:semicolon
r_int
r_char
id|target
op_assign
id|SCpnt-&gt;device-&gt;id
suffix:semicolon
singleline_comment|//&t;unsigned char  lun    = SCpnt-&gt;device-&gt;lun;
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|sync_data
op_star
id|sync
op_assign
op_amp
(paren
id|data-&gt;Sync
(braket
id|target
)braket
)paren
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_DATA_IO, &quot;in SCpnt=0x%p&quot;, SCpnt);
multiline_comment|/* setup synch transfer registers */
id|nsp_index_write
c_func
(paren
id|base
comma
id|SYNCREG
comma
id|sync-&gt;SyncRegister
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|ACKWIDTH
comma
id|sync-&gt;AckWidth
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
op_eq
l_int|0
op_logical_or
id|SCpnt-&gt;resid
op_mod
l_int|4
op_ne
l_int|0
op_logical_or
id|SCpnt-&gt;resid
op_le
id|PAGE_SIZE
)paren
(brace
id|data-&gt;TransferMode
op_assign
id|MODE_IO8
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|nsp_burst_mode
op_eq
id|BURST_MEM32
)paren
(brace
id|data-&gt;TransferMode
op_assign
id|MODE_MEM32
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|nsp_burst_mode
op_eq
id|BURST_IO32
)paren
(brace
id|data-&gt;TransferMode
op_assign
id|MODE_IO32
suffix:semicolon
)brace
r_else
(brace
id|data-&gt;TransferMode
op_assign
id|MODE_IO8
suffix:semicolon
)brace
multiline_comment|/* setup pdma fifo */
id|nsp_setup_fifo
c_func
(paren
id|data
comma
id|TRUE
)paren
suffix:semicolon
multiline_comment|/* clear ack counter */
id|data-&gt;FifoCount
op_assign
l_int|0
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|POINTERCLR
comma
id|POINTER_CLEAR
op_or
id|ACK_COUNTER_CLEAR
op_or
id|REQ_COUNTER_CLEAR
op_or
id|HOST_COUNTER_CLEAR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#include &quot;nsp_message.c&quot;
multiline_comment|/*&n; * interrupt handler&n; */
DECL|function|nspintr
r_static
id|irqreturn_t
id|nspintr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|base
suffix:semicolon
r_int
r_char
id|irq_status
comma
id|irq_phase
comma
id|phase
suffix:semicolon
id|Scsi_Cmnd
op_star
id|tmpSC
suffix:semicolon
r_int
r_char
id|target
comma
id|lun
suffix:semicolon
r_int
r_int
op_star
id|sync_neg
suffix:semicolon
r_int
id|i
comma
id|tmp
suffix:semicolon
id|nsp_hw_data
op_star
id|data
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;dev_id=0x%p&quot;, dev_id);
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;host=0x%p&quot;, ((scsi_info_t *)dev_id)-&gt;host);
r_if
c_cond
(paren
id|dev_id
op_ne
l_int|NULL
op_logical_and
(paren
(paren
id|scsi_info_t
op_star
)paren
id|dev_id
)paren
op_member_access_from_pointer
id|host
op_ne
l_int|NULL
)paren
(brace
id|scsi_info_t
op_star
id|info
op_assign
(paren
id|scsi_info_t
op_star
)paren
id|dev_id
suffix:semicolon
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|info-&gt;host-&gt;hostdata
suffix:semicolon
)brace
r_else
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;host data wrong&quot;
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;&amp;nsp_data_base=0x%p, dev_id=0x%p&quot;, &amp;nsp_data_base, dev_id);
id|base
op_assign
id|data-&gt;BaseAddress
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;base=0x%x&quot;, base);
multiline_comment|/*&n;&t; * interrupt check&n;&t; */
id|nsp_write
c_func
(paren
id|base
comma
id|IRQCONTROL
comma
id|IRQCONTROL_IRQDISABLE
)paren
suffix:semicolon
id|irq_status
op_assign
id|nsp_read
c_func
(paren
id|base
comma
id|IRQSTATUS
)paren
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;irq_status=0x%x&quot;, irq_status);
r_if
c_cond
(paren
(paren
id|irq_status
op_eq
l_int|0xff
)paren
op_logical_or
(paren
(paren
id|irq_status
op_amp
id|IRQSTATUS_MASK
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|nsp_write
c_func
(paren
id|base
comma
id|IRQCONTROL
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;no irq/shared irq&quot;);
r_return
id|IRQ_NONE
suffix:semicolon
)brace
multiline_comment|/* XXX: IMPORTANT&n;&t; * Do not read an irq_phase register if no scsi phase interrupt.&n;&t; * Unless, you should lose a scsi phase interrupt.&n;&t; */
id|phase
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|SCSIBUSMON
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|irq_status
op_amp
id|IRQSTATUS_SCSI
)paren
op_ne
l_int|0
)paren
(brace
id|irq_phase
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|IRQPHASESENCE
)paren
suffix:semicolon
)brace
r_else
(brace
id|irq_phase
op_assign
l_int|0
suffix:semicolon
)brace
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;irq_phase=0x%x&quot;, irq_phase);
multiline_comment|/*&n;&t; * timer interrupt handler (scsi vs timer interrupts)&n;&t; */
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;timercount=%d&quot;, data-&gt;TimerCount);
r_if
c_cond
(paren
id|data-&gt;TimerCount
op_ne
l_int|0
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;stop timer&quot;);
id|nsp_index_write
c_func
(paren
id|base
comma
id|TIMERCOUNT
comma
l_int|0
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|TIMERCOUNT
comma
l_int|0
)paren
suffix:semicolon
id|data-&gt;TimerCount
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|irq_status
op_amp
id|IRQSTATUS_MASK
)paren
op_eq
id|IRQSTATUS_TIMER
op_logical_and
id|data-&gt;SelectionTimeOut
op_eq
l_int|0
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;timer start&quot;);
id|nsp_write
c_func
(paren
id|base
comma
id|IRQCONTROL
comma
id|IRQCONTROL_TIMER_CLEAR
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|nsp_write
c_func
(paren
id|base
comma
id|IRQCONTROL
comma
id|IRQCONTROL_TIMER_CLEAR
op_or
id|IRQCONTROL_FIFO_CLEAR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|irq_status
op_amp
id|IRQSTATUS_SCSI
)paren
op_logical_and
(paren
id|irq_phase
op_amp
id|SCSI_RESET_IRQ
)paren
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;bus reset (power off?)&quot;
)paren
suffix:semicolon
id|nsphw_init
c_func
(paren
id|data
)paren
suffix:semicolon
id|nsp_bus_reset
c_func
(paren
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;CurrentSC
op_ne
l_int|NULL
)paren
(brace
id|tmpSC
op_assign
id|data-&gt;CurrentSC
suffix:semicolon
id|tmpSC-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|tmpSC-&gt;SCp.Message
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|tmpSC-&gt;SCp.Status
op_amp
l_int|0xff
)paren
op_lshift
l_int|0
)paren
suffix:semicolon
id|nsp_scsi_done
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data-&gt;CurrentSC
op_eq
l_int|NULL
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;CurrentSC==NULL irq_status=0x%x phase=0x%x irq_phase=0x%x this can&squot;t be happen. reset everything&quot;
comma
id|irq_status
comma
id|phase
comma
id|irq_phase
)paren
suffix:semicolon
id|nsphw_init
c_func
(paren
id|data
)paren
suffix:semicolon
id|nsp_bus_reset
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|tmpSC
op_assign
id|data-&gt;CurrentSC
suffix:semicolon
id|target
op_assign
id|tmpSC-&gt;device-&gt;id
suffix:semicolon
id|lun
op_assign
id|tmpSC-&gt;device-&gt;lun
suffix:semicolon
id|sync_neg
op_assign
op_amp
(paren
id|data-&gt;Sync
(braket
id|target
)braket
dot
id|SyncNegotiation
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * parse hardware SCSI irq reasons register&n;&t; */
r_if
c_cond
(paren
id|irq_status
op_amp
id|IRQSTATUS_SCSI
)paren
(brace
r_if
c_cond
(paren
id|irq_phase
op_amp
id|RESELECT_IRQ
)paren
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;reselect&quot;
)paren
suffix:semicolon
id|nsp_write
c_func
(paren
id|base
comma
id|IRQCONTROL
comma
id|IRQCONTROL_RESELECT_CLEAR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nsp_reselected
c_func
(paren
id|tmpSC
)paren
op_ne
id|FALSE
)paren
(brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|irq_phase
op_amp
(paren
id|PHASE_CHANGE_IRQ
op_or
id|LATCHED_BUS_FREE
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
)brace
singleline_comment|//show_phase(tmpSC);
r_switch
c_cond
(paren
id|tmpSC-&gt;SCp.phase
)paren
(brace
r_case
id|PH_SELSTART
suffix:colon
singleline_comment|// *sync_neg = SYNC_NOT_YET;
r_if
c_cond
(paren
(paren
id|phase
op_amp
id|BUSMON_BSY
)paren
op_eq
l_int|0
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;selection count=%d&quot;, data-&gt;SelectionTimeOut);
r_if
c_cond
(paren
id|data-&gt;SelectionTimeOut
op_ge
id|NSP_SELTIMEOUT
)paren
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;selection time out&quot;
)paren
suffix:semicolon
id|data-&gt;SelectionTimeOut
op_assign
l_int|0
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
comma
l_int|0
)paren
suffix:semicolon
id|tmpSC-&gt;result
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
id|nsp_scsi_done
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|data-&gt;SelectionTimeOut
op_add_assign
l_int|1
suffix:semicolon
id|nsp_start_timer
c_func
(paren
id|tmpSC
comma
l_int|1000
op_div
l_int|51
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* attention assert */
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;attention assert&quot;);
id|data-&gt;SelectionTimeOut
op_assign
l_int|0
suffix:semicolon
id|tmpSC-&gt;SCp.phase
op_assign
id|PH_SELECTED
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
comma
id|SCSI_ATN
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
comma
id|SCSI_ATN
op_or
id|AUTODIRECTION
op_or
id|ACKENB
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PH_RESELECT
suffix:colon
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;phase reselect&quot;);
singleline_comment|// *sync_neg = SYNC_NOT_YET;
r_if
c_cond
(paren
(paren
id|phase
op_amp
id|BUSMON_PHASE_MASK
)paren
op_ne
id|BUSPHASE_MESSAGE_IN
)paren
(brace
id|tmpSC-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|nsp_scsi_done
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* fall thru */
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
(paren
id|irq_status
op_amp
(paren
id|IRQSTATUS_SCSI
op_or
id|IRQSTATUS_FIFO
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * SCSI sequencer&n;&t; */
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;start scsi seq&quot;);
multiline_comment|/* normal disconnect */
r_if
c_cond
(paren
(paren
(paren
id|tmpSC-&gt;SCp.phase
op_eq
id|PH_MSG_IN
)paren
op_logical_or
(paren
id|tmpSC-&gt;SCp.phase
op_eq
id|PH_MSG_OUT
)paren
)paren
op_logical_and
(paren
id|irq_phase
op_amp
id|LATCHED_BUS_FREE
)paren
op_ne
l_int|0
)paren
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;normal disconnect irq_status=0x%x, phase=0x%x, irq_phase=0x%x&quot;
comma
id|irq_status
comma
id|phase
comma
id|irq_phase
)paren
suffix:semicolon
singleline_comment|//*sync_neg       = SYNC_NOT_YET;
r_if
c_cond
(paren
(paren
id|tmpSC-&gt;SCp.Message
op_eq
id|MSG_COMMAND_COMPLETE
)paren
)paren
(brace
multiline_comment|/* all command complete and return status */
id|tmpSC-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|tmpSC-&gt;SCp.Message
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|tmpSC-&gt;SCp.Status
op_amp
l_int|0xff
)paren
op_lshift
l_int|0
)paren
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;command complete result=0x%x&quot;
comma
id|tmpSC-&gt;result
)paren
suffix:semicolon
id|nsp_scsi_done
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* check unexpected bus free state */
r_if
c_cond
(paren
id|phase
op_eq
l_int|0
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;unexpected bus free. irq_status=0x%x, phase=0x%x, irq_phase=0x%x&quot;
comma
id|irq_status
comma
id|phase
comma
id|irq_phase
)paren
suffix:semicolon
op_star
id|sync_neg
op_assign
id|SYNC_NG
suffix:semicolon
id|tmpSC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|nsp_scsi_done
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|phase
op_amp
id|BUSMON_PHASE_MASK
)paren
(brace
r_case
id|BUSPHASE_COMMAND
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;BUSPHASE_COMMAND&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|phase
op_amp
id|BUSMON_REQ
)paren
op_eq
l_int|0
)paren
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;REQ == 0&quot;
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|tmpSC-&gt;SCp.phase
op_assign
id|PH_COMMAND
suffix:semicolon
id|nsp_nexus
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
multiline_comment|/* write scsi command */
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;cmd_len=%d&quot;
comma
id|tmpSC-&gt;cmd_len
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|COMMANDCTRL
comma
id|CLEAR_COMMAND_POINTER
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tmpSC-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|nsp_index_write
c_func
(paren
id|base
comma
id|COMMANDDATA
comma
id|tmpSC-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|nsp_index_write
c_func
(paren
id|base
comma
id|COMMANDCTRL
comma
id|CLEAR_COMMAND_POINTER
op_or
id|AUTO_COMMAND_GO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUSPHASE_DATA_OUT
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;BUSPHASE_DATA_OUT&quot;
)paren
suffix:semicolon
id|tmpSC-&gt;SCp.phase
op_assign
id|PH_DATA
suffix:semicolon
id|tmpSC-&gt;SCp.have_data_in
op_assign
id|IO_OUT
suffix:semicolon
id|nsp_pio_write
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUSPHASE_DATA_IN
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;BUSPHASE_DATA_IN&quot;
)paren
suffix:semicolon
id|tmpSC-&gt;SCp.phase
op_assign
id|PH_DATA
suffix:semicolon
id|tmpSC-&gt;SCp.have_data_in
op_assign
id|IO_IN
suffix:semicolon
id|nsp_pio_read
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUSPHASE_STATUS
suffix:colon
id|nsp_dataphase_bypass
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;BUSPHASE_STATUS&quot;
)paren
suffix:semicolon
id|tmpSC-&gt;SCp.phase
op_assign
id|PH_STATUS
suffix:semicolon
id|tmpSC-&gt;SCp.Status
op_assign
id|nsp_index_read
c_func
(paren
id|base
comma
id|SCSIDATAWITHACK
)paren
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;message=0x%x status=0x%x&quot;
comma
id|tmpSC-&gt;SCp.Message
comma
id|tmpSC-&gt;SCp.Status
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUSPHASE_MESSAGE_OUT
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;BUSPHASE_MESSAGE_OUT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|phase
op_amp
id|BUSMON_REQ
)paren
op_eq
l_int|0
)paren
(brace
r_goto
id|timer_out
suffix:semicolon
)brace
id|tmpSC-&gt;SCp.phase
op_assign
id|PH_MSG_OUT
suffix:semicolon
singleline_comment|//*sync_neg = SYNC_NOT_YET;
id|data-&gt;MsgLen
op_assign
id|i
op_assign
l_int|0
suffix:semicolon
id|data-&gt;MsgBuffer
(braket
id|i
)braket
op_assign
id|IDENTIFY
c_func
(paren
id|TRUE
comma
id|lun
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|sync_neg
op_eq
id|SYNC_NOT_YET
)paren
(brace
id|data-&gt;Sync
(braket
id|target
)braket
dot
id|SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|data-&gt;Sync
(braket
id|target
)braket
dot
id|SyncOffset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/**/
id|data-&gt;MsgBuffer
(braket
id|i
)braket
op_assign
id|MSG_EXTENDED
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|data-&gt;MsgBuffer
(braket
id|i
)braket
op_assign
l_int|3
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|data-&gt;MsgBuffer
(braket
id|i
)braket
op_assign
id|MSG_EXT_SDTR
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|data-&gt;MsgBuffer
(braket
id|i
)braket
op_assign
l_int|0x0c
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|data-&gt;MsgBuffer
(braket
id|i
)braket
op_assign
l_int|15
suffix:semicolon
id|i
op_increment
suffix:semicolon
multiline_comment|/**/
)brace
id|data-&gt;MsgLen
op_assign
id|i
suffix:semicolon
id|nsp_analyze_sdtr
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
id|show_message
c_func
(paren
id|data
)paren
suffix:semicolon
id|nsp_message_out
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUSPHASE_MESSAGE_IN
suffix:colon
id|nsp_dataphase_bypass
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;BUSPHASE_MESSAGE_IN&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|phase
op_amp
id|BUSMON_REQ
)paren
op_eq
l_int|0
)paren
(brace
r_goto
id|timer_out
suffix:semicolon
)brace
id|tmpSC-&gt;SCp.phase
op_assign
id|PH_MSG_IN
suffix:semicolon
id|nsp_message_in
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
multiline_comment|/**/
r_if
c_cond
(paren
op_star
id|sync_neg
op_eq
id|SYNC_NOT_YET
)paren
(brace
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;sync target=%d,lun=%d&quot;,target,lun);
r_if
c_cond
(paren
id|data-&gt;MsgLen
op_ge
l_int|5
op_logical_and
id|data-&gt;MsgBuffer
(braket
l_int|0
)braket
op_eq
id|MSG_EXTENDED
op_logical_and
id|data-&gt;MsgBuffer
(braket
l_int|1
)braket
op_eq
l_int|3
op_logical_and
id|data-&gt;MsgBuffer
(braket
l_int|2
)braket
op_eq
id|MSG_EXT_SDTR
)paren
(brace
id|data-&gt;Sync
(braket
id|target
)braket
dot
id|SyncPeriod
op_assign
id|data-&gt;MsgBuffer
(braket
l_int|3
)braket
suffix:semicolon
id|data-&gt;Sync
(braket
id|target
)braket
dot
id|SyncOffset
op_assign
id|data-&gt;MsgBuffer
(braket
l_int|4
)braket
suffix:semicolon
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;sync ok, %d %d&quot;, data-&gt;MsgBuffer[3], data-&gt;MsgBuffer[4]);
op_star
id|sync_neg
op_assign
id|SYNC_OK
suffix:semicolon
)brace
r_else
(brace
id|data-&gt;Sync
(braket
id|target
)braket
dot
id|SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|data-&gt;Sync
(braket
id|target
)braket
dot
id|SyncOffset
op_assign
l_int|0
suffix:semicolon
op_star
id|sync_neg
op_assign
id|SYNC_NG
suffix:semicolon
)brace
id|nsp_analyze_sdtr
c_func
(paren
id|tmpSC
)paren
suffix:semicolon
)brace
multiline_comment|/**/
multiline_comment|/* search last messeage byte */
id|tmp
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data-&gt;MsgLen
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp
op_assign
id|data-&gt;MsgBuffer
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;MsgBuffer
(braket
id|i
)braket
op_eq
id|MSG_EXTENDED
)paren
(brace
id|i
op_add_assign
(paren
l_int|1
op_plus
id|data-&gt;MsgBuffer
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
)brace
)brace
id|tmpSC-&gt;SCp.Message
op_assign
id|tmp
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;message=0x%x len=%d&quot;
comma
id|tmpSC-&gt;SCp.Message
comma
id|data-&gt;MsgLen
)paren
suffix:semicolon
id|show_message
c_func
(paren
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUSPHASE_SELECT
suffix:colon
r_default
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INTR
comma
l_string|&quot;BUSPHASE other&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|//nsp_dbg(NSP_DEBUG_INTR, &quot;out&quot;);
r_return
id|IRQ_HANDLED
suffix:semicolon
id|timer_out
suffix:colon
id|nsp_start_timer
c_func
(paren
id|tmpSC
comma
l_int|1000
op_div
l_int|102
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
macro_line|#ifdef NSP_DEBUG
macro_line|#include &quot;nsp_debug.c&quot;
macro_line|#endif&t;/* NSP_DEBUG */
multiline_comment|/*----------------------------------------------------------------*/
multiline_comment|/* look for ninja3 card and init if found&t;&t;&t;  */
multiline_comment|/*----------------------------------------------------------------*/
DECL|function|nsp_detect
r_static
r_struct
id|Scsi_Host
op_star
id|nsp_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|sht
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
multiline_comment|/* registered host structure */
id|nsp_hw_data
op_star
id|data_b
op_assign
op_amp
id|nsp_data_base
comma
op_star
id|data
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;this_id=%d&quot;
comma
id|sht-&gt;this_id
)paren
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,5,73))
id|host
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|nsp_driver_template
comma
r_sizeof
(paren
id|nsp_hw_data
)paren
)paren
suffix:semicolon
macro_line|#else
id|host
op_assign
id|scsi_register
c_func
(paren
id|sht
comma
r_sizeof
(paren
id|nsp_hw_data
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;host failed&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|host-&gt;hostdata
comma
id|data_b
comma
r_sizeof
(paren
id|nsp_hw_data
)paren
)paren
suffix:semicolon
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|data-&gt;ScsiInfo-&gt;host
op_assign
id|host
suffix:semicolon
macro_line|#ifdef NSP_DEBUG
id|data-&gt;CmdId
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;irq=%d,%d&quot;
comma
id|data_b-&gt;IrqNumber
comma
(paren
(paren
id|nsp_hw_data
op_star
)paren
id|host-&gt;hostdata
)paren
op_member_access_from_pointer
id|IrqNumber
)paren
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|data-&gt;BaseAddress
suffix:semicolon
id|host-&gt;io_port
op_assign
id|data-&gt;BaseAddress
suffix:semicolon
id|host-&gt;n_io_port
op_assign
id|data-&gt;NumAddress
suffix:semicolon
id|host-&gt;irq
op_assign
id|data-&gt;IrqNumber
suffix:semicolon
id|host-&gt;base
op_assign
id|data-&gt;MmioAddress
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
(paren
id|data-&gt;Lock
)paren
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|data-&gt;nspinfo
comma
r_sizeof
(paren
id|data-&gt;nspinfo
)paren
comma
l_string|&quot;NinjaSCSI-3/32Bi Driver $Revision: 1.23 $ IO:0x%04lx-0x%04lx MMIO(virt addr):0x%04lx IRQ:%02d&quot;
comma
id|host-&gt;io_port
comma
id|host-&gt;io_port
op_plus
id|host-&gt;n_io_port
op_minus
l_int|1
comma
id|host-&gt;base
comma
id|host-&gt;irq
)paren
suffix:semicolon
id|sht-&gt;name
op_assign
id|data-&gt;nspinfo
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;end&quot;
)paren
suffix:semicolon
r_return
id|host
suffix:semicolon
multiline_comment|/* detect done. */
)brace
macro_line|#if (LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,5,0))
DECL|function|nsp_detect_old
r_static
r_int
id|nsp_detect_old
c_func
(paren
id|Scsi_Host_Template
op_star
id|sht
)paren
(brace
r_if
c_cond
(paren
id|nsp_detect
c_func
(paren
id|sht
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
singleline_comment|//MOD_INC_USE_COUNT;
r_return
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|nsp_release_old
r_static
r_int
id|nsp_release_old
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
singleline_comment|//nsp_hw_data *data = (nsp_hw_data *)shpnt-&gt;hostdata;
multiline_comment|/* PCMCIA Card Service dose same things below. */
multiline_comment|/* So we do nothing.                           */
singleline_comment|//if (shpnt-&gt;irq) {
singleline_comment|//&t;free_irq(shpnt-&gt;irq, data-&gt;ScsiInfo);
singleline_comment|//}
singleline_comment|//if (shpnt-&gt;io_port) {
singleline_comment|//&t;release_region(shpnt-&gt;io_port, shpnt-&gt;n_io_port);
singleline_comment|//}
singleline_comment|//MOD_DEC_USE_COUNT;
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*----------------------------------------------------------------*/
multiline_comment|/* return info string&t;&t;&t;&t;&t;&t;  */
multiline_comment|/*----------------------------------------------------------------*/
DECL|function|nsp_info
r_static
r_const
r_char
op_star
id|nsp_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|shpnt-&gt;hostdata
suffix:semicolon
r_return
id|data-&gt;nspinfo
suffix:semicolon
)brace
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
DECL|macro|SPRINTF
mdefine_line|#define SPRINTF(args...) &bslash;&n;        do { &bslash;&n;&t;&t;if(length &gt; (pos - buffer)) { &bslash;&n;&t;&t;&t;pos += snprintf(pos, length - (pos - buffer) + 1, ## args); &bslash;&n;&t;&t;&t;nsp_dbg(NSP_DEBUG_PROC, &quot;buffer=0x%p pos=0x%p length=%d %d&bslash;n&quot;, buffer, pos, length,  length - (pos - buffer));&bslash;&n;&t;&t;} &bslash;&n;&t;} while(0)
r_static
r_int
DECL|function|nsp_proc_info
id|nsp_proc_info
c_func
(paren
macro_line|#if (LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,5,73))
r_struct
id|Scsi_Host
op_star
id|host
comma
macro_line|#endif
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
macro_line|#if !(LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,5,73))
r_int
id|hostno
comma
macro_line|#endif
r_int
id|inout
)paren
(brace
r_int
id|id
suffix:semicolon
r_char
op_star
id|pos
op_assign
id|buffer
suffix:semicolon
r_int
id|thislength
suffix:semicolon
r_int
id|speed
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|nsp_hw_data
op_star
id|data
suffix:semicolon
macro_line|#if !(LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,5,73))
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
macro_line|#else
r_int
id|hostno
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|inout
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#if (LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,5,73))
id|hostno
op_assign
id|host-&gt;host_no
suffix:semicolon
macro_line|#else
multiline_comment|/* search this HBA host */
id|host
op_assign
id|scsi_host_hn_get
c_func
(paren
id|hostno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
macro_line|#endif
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;NinjaSCSI status&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;Driver version:        $Revision: 1.23 $&bslash;n&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SCSI host No.:         %d&bslash;n&quot;
comma
id|hostno
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;IRQ:                   %d&bslash;n&quot;
comma
id|host-&gt;irq
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;IO:                    0x%lx-0x%lx&bslash;n&quot;
comma
id|host-&gt;io_port
comma
id|host-&gt;io_port
op_plus
id|host-&gt;n_io_port
op_minus
l_int|1
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;MMIO(virtual address): 0x%lx-0x%lx&bslash;n&quot;
comma
id|host-&gt;base
comma
id|host-&gt;base
op_plus
id|data-&gt;MmioLength
op_minus
l_int|1
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;sg_tablesize:          %d&bslash;n&quot;
comma
id|host-&gt;sg_tablesize
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;burst transfer mode:   &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|nsp_burst_mode
)paren
(brace
r_case
id|BURST_IO8
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;io8&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BURST_IO32
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;io32&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BURST_MEM32
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;mem32&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;???&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|data-&gt;Lock
)paren
comma
id|flags
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;CurrentSC:             0x%p&bslash;n&bslash;n&quot;
comma
id|data-&gt;CurrentSC
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|data-&gt;Lock
)paren
comma
id|flags
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SDTR status&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|ARRAY_SIZE
c_func
(paren
id|data-&gt;Sync
)paren
suffix:semicolon
id|id
op_increment
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;id %d: &quot;
comma
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
id|host-&gt;this_id
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;----- NinjaSCSI-3 host adapter&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|data-&gt;Sync
(braket
id|id
)braket
dot
id|SyncNegotiation
)paren
(brace
r_case
id|SYNC_OK
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot; sync&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNC_NG
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;async&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNC_NOT_YET
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot; none&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SPRINTF
c_func
(paren
l_string|&quot;?????&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data-&gt;Sync
(braket
id|id
)braket
dot
id|SyncPeriod
op_ne
l_int|0
)paren
(brace
id|speed
op_assign
l_int|1000000
op_div
(paren
id|data-&gt;Sync
(braket
id|id
)braket
dot
id|SyncPeriod
op_star
l_int|4
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot; transfer %d.%dMB/s, offset %d&quot;
comma
id|speed
op_div
l_int|1000
comma
id|speed
op_mod
l_int|1000
comma
id|data-&gt;Sync
(braket
id|id
)braket
dot
id|SyncOffset
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|thislength
op_assign
id|pos
op_minus
(paren
id|buffer
op_plus
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|thislength
OL
l_int|0
)paren
(brace
op_star
id|start
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|thislength
op_assign
id|min
c_func
(paren
id|thislength
comma
id|length
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
r_return
id|thislength
suffix:semicolon
)brace
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
multiline_comment|/*---------------------------------------------------------------*/
multiline_comment|/* error handler                                                 */
multiline_comment|/*---------------------------------------------------------------*/
multiline_comment|/*static int nsp_eh_strategy(struct Scsi_Host *Shost)&n;{&n;&t;return FAILED;&n;}*/
multiline_comment|/*&n;static int nsp_eh_abort(Scsi_Cmnd *SCpnt)&n;{&n;&t;nsp_dbg(NSP_DEBUG_BUSRESET, &quot;SCpnt=0x%p&quot;, SCpnt);&n;&n;&t;return nsp_eh_bus_reset(SCpnt);&n;}*/
multiline_comment|/*&n;static int nsp_eh_device_reset(Scsi_Cmnd *SCpnt)&n;{&n;&t;nsp_dbg(NSP_DEBUG_BUSRESET, &quot;%s: SCpnt=0x%p&quot;, SCpnt);&n;&n;&t;return FAILED;&n;}*/
DECL|function|nsp_bus_reset
r_static
r_int
id|nsp_bus_reset
c_func
(paren
id|nsp_hw_data
op_star
id|data
)paren
(brace
r_int
r_int
id|base
op_assign
id|data-&gt;BaseAddress
suffix:semicolon
r_int
id|i
suffix:semicolon
id|nsp_write
c_func
(paren
id|base
comma
id|IRQCONTROL
comma
id|IRQCONTROL_ALLMASK
)paren
suffix:semicolon
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
comma
id|SCSI_RST
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* 100ms */
id|nsp_index_write
c_func
(paren
id|base
comma
id|SCSIBUSCTRL
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|nsp_index_read
c_func
(paren
id|base
comma
id|IRQPHASESENCE
)paren
suffix:semicolon
multiline_comment|/* dummy read */
)brace
id|nsphw_init_sync
c_func
(paren
id|data
)paren
suffix:semicolon
id|nsp_write
c_func
(paren
id|base
comma
id|IRQCONTROL
comma
id|IRQCONTROL_ALLCLEAR
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
DECL|function|nsp_eh_bus_reset
r_static
r_int
id|nsp_eh_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_BUSRESET
comma
l_string|&quot;SCpnt=0x%p&quot;
comma
id|SCpnt
)paren
suffix:semicolon
r_return
id|nsp_bus_reset
c_func
(paren
id|data
)paren
suffix:semicolon
)brace
DECL|function|nsp_eh_host_reset
r_static
r_int
id|nsp_eh_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|nsp_hw_data
op_star
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_BUSRESET
comma
l_string|&quot;in&quot;
)paren
suffix:semicolon
id|nsphw_init
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n;  PCMCIA functions&n;**********************************************************************/
multiline_comment|/*======================================================================&n;    nsp_cs_attach() creates an &quot;instance&quot; of the driver, allocating&n;    local data structures for one device.  The device is registered&n;    with Card Services.&n;&n;    The dev_link structure is initialized, but we don&squot;t actually&n;    configure the card at this point -- we wait until we receive a&n;    card insertion event.&n;======================================================================*/
DECL|function|nsp_cs_attach
r_static
id|dev_link_t
op_star
id|nsp_cs_attach
c_func
(paren
r_void
)paren
(brace
id|scsi_info_t
op_star
id|info
suffix:semicolon
id|client_reg_t
id|client_reg
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
r_int
id|ret
comma
id|i
suffix:semicolon
id|nsp_hw_data
op_star
id|data
op_assign
op_amp
id|nsp_data_base
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;in&quot;
)paren
suffix:semicolon
multiline_comment|/* Create new SCSI device */
id|info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|info
)paren
)paren
suffix:semicolon
id|link
op_assign
op_amp
id|info-&gt;link
suffix:semicolon
id|link-&gt;priv
op_assign
id|info
suffix:semicolon
id|data-&gt;ScsiInfo
op_assign
id|info
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;info=0x%p&quot;
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* The io structure describes IO port mapping */
id|link-&gt;io.NumPorts1
op_assign
l_int|0x10
suffix:semicolon
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_AUTO
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* not used */
multiline_comment|/* Interrupt setup */
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_EXCLUSIVE
op_or
id|IRQ_HANDLE_PRESENT
suffix:semicolon
id|link-&gt;irq.IRQInfo1
op_assign
id|IRQ_INFO2_VALID
op_or
id|IRQ_LEVEL_ID
suffix:semicolon
r_if
c_cond
(paren
id|irq_list
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
(brace
id|link-&gt;irq.IRQInfo2
op_assign
id|irq_mask
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|link-&gt;irq.IRQInfo2
op_or_assign
id|BIT
c_func
(paren
id|irq_list
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Interrupt handler */
id|link-&gt;irq.Handler
op_assign
op_amp
id|nspintr
suffix:semicolon
id|link-&gt;irq.Instance
op_assign
id|info
suffix:semicolon
id|link-&gt;irq.Attributes
op_or_assign
(paren
id|SA_SHIRQ
op_or
id|SA_SAMPLE_RANDOM
)paren
suffix:semicolon
multiline_comment|/* General socket configuration */
id|link-&gt;conf.Attributes
op_assign
id|CONF_ENABLE_IRQ
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
l_int|50
suffix:semicolon
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY_AND_IO
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|PRESENT_OPTION
suffix:semicolon
multiline_comment|/* Register with Card Services */
id|link-&gt;next
op_assign
id|dev_list
suffix:semicolon
id|dev_list
op_assign
id|link
suffix:semicolon
id|client_reg.dev_info
op_assign
op_amp
id|dev_info
suffix:semicolon
id|client_reg.EventMask
op_assign
id|CS_EVENT_CARD_INSERTION
op_or
id|CS_EVENT_CARD_REMOVAL
op_or
id|CS_EVENT_RESET_PHYSICAL
op_or
id|CS_EVENT_CARD_RESET
op_or
id|CS_EVENT_PM_SUSPEND
op_or
id|CS_EVENT_PM_RESUME
suffix:semicolon
id|client_reg.event_handler
op_assign
op_amp
id|nsp_cs_event
suffix:semicolon
id|client_reg.Version
op_assign
l_int|0x0210
suffix:semicolon
id|client_reg.event_callback_args.client_data
op_assign
id|link
suffix:semicolon
id|ret
op_assign
id|pcmcia_register_client
c_func
(paren
op_amp
id|link-&gt;handle
comma
op_amp
id|client_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RegisterClient
comma
id|ret
)paren
suffix:semicolon
id|nsp_cs_detach
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;link=0x%p&quot;
comma
id|link
)paren
suffix:semicolon
r_return
id|link
suffix:semicolon
)brace
multiline_comment|/* nsp_cs_attach */
multiline_comment|/*======================================================================&n;    This deletes a driver &quot;instance&quot;.  The device is de-registered&n;    with Card Services.&t; If it has been released, all local data&n;    structures are freed.  Otherwise, the structures will be freed&n;    when the device is released.&n;======================================================================*/
DECL|function|nsp_cs_detach
r_static
r_void
id|nsp_cs_detach
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|dev_link_t
op_star
op_star
id|linkp
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;in, link=0x%p&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* Locate device structure */
r_for
c_loop
(paren
id|linkp
op_assign
op_amp
id|dev_list
suffix:semicolon
op_star
id|linkp
suffix:semicolon
id|linkp
op_assign
op_amp
(paren
op_star
id|linkp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|linkp
op_eq
id|link
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_star
id|linkp
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
id|nsp_cs_release
c_func
(paren
id|link
)paren
suffix:semicolon
multiline_comment|/* Break the link with Card Services */
r_if
c_cond
(paren
id|link-&gt;handle
)paren
(brace
id|pcmcia_deregister_client
c_func
(paren
id|link-&gt;handle
)paren
suffix:semicolon
)brace
multiline_comment|/* Unlink device structure, free bits */
op_star
id|linkp
op_assign
id|link-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|link-&gt;priv
)paren
suffix:semicolon
id|link-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* nsp_cs_detach */
multiline_comment|/*======================================================================&n;    nsp_cs_config() is scheduled to run after a CARD_INSERTION event&n;    is received, to configure the PCMCIA socket, and to make the&n;    ethernet device available to the system.&n;======================================================================*/
DECL|macro|CS_CHECK
mdefine_line|#define CS_CHECK(fn, ret) &bslash;&n;do { last_fn = (fn); if ((last_ret = (ret)) != 0) goto cs_failed; } while (0)
multiline_comment|/*====================================================================*/
DECL|function|nsp_cs_config
r_static
r_void
id|nsp_cs_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
id|scsi_info_t
op_star
id|info
op_assign
id|link-&gt;priv
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
r_int
id|last_ret
comma
id|last_fn
suffix:semicolon
r_int
r_char
id|tuple_data
(braket
l_int|64
)braket
suffix:semicolon
id|config_info_t
id|conf
suffix:semicolon
id|win_req_t
id|req
suffix:semicolon
id|memreq_t
id|map
suffix:semicolon
id|cistpl_cftable_entry_t
id|dflt
op_assign
(brace
l_int|0
)brace
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
id|nsp_hw_data
op_star
id|data
op_assign
op_amp
id|nsp_data_base
suffix:semicolon
macro_line|#if !(LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,5,74))
id|Scsi_Device
op_star
id|dev
suffix:semicolon
id|dev_node_t
op_star
op_star
id|tail
comma
op_star
id|node
suffix:semicolon
macro_line|#endif
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;in&quot;
)paren
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_CONFIG
suffix:semicolon
id|tuple.Attributes
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleData
op_assign
id|tuple_data
suffix:semicolon
id|tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|tuple_data
)paren
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|pcmcia_get_first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|pcmcia_get_tuple_data
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|ParseTuple
comma
id|pcmcia_parse_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
)paren
suffix:semicolon
id|link-&gt;conf.ConfigBase
op_assign
id|parse.config.base
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|parse.config.rmask
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Configure card */
id|link-&gt;state
op_or_assign
id|DEV_CONFIG
suffix:semicolon
multiline_comment|/* Look up the current Vcc */
id|CS_CHECK
c_func
(paren
id|GetConfigurationInfo
comma
id|pcmcia_get_configuration_info
c_func
(paren
id|handle
comma
op_amp
id|conf
)paren
)paren
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
id|conf.Vcc
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|CISTPL_CFTABLE_ENTRY
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|pcmcia_get_first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|cistpl_cftable_entry_t
op_star
id|cfg
op_assign
op_amp
(paren
id|parse.cftable_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcmcia_get_tuple_data
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
op_ne
l_int|0
op_logical_or
id|pcmcia_parse_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
op_ne
l_int|0
)paren
r_goto
id|next_entry
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;flags
op_amp
id|CISTPL_CFTABLE_DEFAULT
)paren
(brace
id|dflt
op_assign
op_star
id|cfg
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg-&gt;index
op_eq
l_int|0
)paren
(brace
r_goto
id|next_entry
suffix:semicolon
)brace
id|link-&gt;conf.ConfigIndex
op_assign
id|cfg-&gt;index
suffix:semicolon
multiline_comment|/* Does this card need audio output? */
r_if
c_cond
(paren
id|cfg-&gt;flags
op_amp
id|CISTPL_CFTABLE_AUDIO
)paren
(brace
id|link-&gt;conf.Attributes
op_or_assign
id|CONF_ENABLE_SPKR
suffix:semicolon
id|link-&gt;conf.Status
op_assign
id|CCSR_AUDIO_ENA
suffix:semicolon
)brace
multiline_comment|/* Use power settings for Vcc and Vpp if present */
multiline_comment|/*  Note that the CIS values need to be rescaled */
r_if
c_cond
(paren
id|cfg-&gt;vcc.present
op_amp
(paren
l_int|1
op_lshift
id|CISTPL_POWER_VNOM
)paren
)paren
(brace
r_if
c_cond
(paren
id|conf.Vcc
op_ne
id|cfg-&gt;vcc.param
(braket
id|CISTPL_POWER_VNOM
)braket
op_div
l_int|10000
)paren
(brace
r_goto
id|next_entry
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|dflt.vcc.present
op_amp
(paren
l_int|1
op_lshift
id|CISTPL_POWER_VNOM
)paren
)paren
(brace
r_if
c_cond
(paren
id|conf.Vcc
op_ne
id|dflt.vcc.param
(braket
id|CISTPL_POWER_VNOM
)braket
op_div
l_int|10000
)paren
(brace
r_goto
id|next_entry
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cfg-&gt;vpp1.present
op_amp
(paren
l_int|1
op_lshift
id|CISTPL_POWER_VNOM
)paren
)paren
(brace
id|link-&gt;conf.Vpp1
op_assign
id|link-&gt;conf.Vpp2
op_assign
id|cfg-&gt;vpp1.param
(braket
id|CISTPL_POWER_VNOM
)braket
op_div
l_int|10000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dflt.vpp1.present
op_amp
(paren
l_int|1
op_lshift
id|CISTPL_POWER_VNOM
)paren
)paren
(brace
id|link-&gt;conf.Vpp1
op_assign
id|link-&gt;conf.Vpp2
op_assign
id|dflt.vpp1.param
(braket
id|CISTPL_POWER_VNOM
)braket
op_div
l_int|10000
suffix:semicolon
)brace
multiline_comment|/* Do we need to allocate an interrupt? */
r_if
c_cond
(paren
id|cfg-&gt;irq.IRQInfo1
op_logical_or
id|dflt.irq.IRQInfo1
)paren
(brace
id|link-&gt;conf.Attributes
op_or_assign
id|CONF_ENABLE_IRQ
suffix:semicolon
)brace
multiline_comment|/* IO window settings */
id|link-&gt;io.NumPorts1
op_assign
id|link-&gt;io.NumPorts2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cfg-&gt;io.nwin
OG
l_int|0
)paren
op_logical_or
(paren
id|dflt.io.nwin
OG
l_int|0
)paren
)paren
(brace
id|cistpl_io_t
op_star
id|io
op_assign
(paren
id|cfg-&gt;io.nwin
)paren
ques
c_cond
op_amp
id|cfg-&gt;io
suffix:colon
op_amp
id|dflt.io
suffix:semicolon
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_AUTO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|io-&gt;flags
op_amp
id|CISTPL_IO_8BIT
)paren
)paren
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_16
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|io-&gt;flags
op_amp
id|CISTPL_IO_16BIT
)paren
)paren
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_8
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
id|io-&gt;flags
op_amp
id|CISTPL_IO_LINES_MASK
suffix:semicolon
id|link-&gt;io.BasePort1
op_assign
id|io-&gt;win
(braket
l_int|0
)braket
dot
id|base
suffix:semicolon
id|link-&gt;io.NumPorts1
op_assign
id|io-&gt;win
(braket
l_int|0
)braket
dot
id|len
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;nwin
OG
l_int|1
)paren
(brace
id|link-&gt;io.Attributes2
op_assign
id|link-&gt;io.Attributes1
suffix:semicolon
id|link-&gt;io.BasePort2
op_assign
id|io-&gt;win
(braket
l_int|1
)braket
dot
id|base
suffix:semicolon
id|link-&gt;io.NumPorts2
op_assign
id|io-&gt;win
(braket
l_int|1
)braket
dot
id|len
suffix:semicolon
)brace
multiline_comment|/* This reserves IO space but doesn&squot;t actually enable it */
r_if
c_cond
(paren
id|pcmcia_request_io
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
op_ne
l_int|0
)paren
r_goto
id|next_entry
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cfg-&gt;mem.nwin
OG
l_int|0
)paren
op_logical_or
(paren
id|dflt.mem.nwin
OG
l_int|0
)paren
)paren
(brace
id|cistpl_mem_t
op_star
id|mem
op_assign
(paren
id|cfg-&gt;mem.nwin
)paren
ques
c_cond
op_amp
id|cfg-&gt;mem
suffix:colon
op_amp
id|dflt.mem
suffix:semicolon
id|req.Attributes
op_assign
id|WIN_DATA_WIDTH_16
op_or
id|WIN_MEMORY_TYPE_CM
suffix:semicolon
id|req.Attributes
op_or_assign
id|WIN_ENABLE
suffix:semicolon
id|req.Base
op_assign
id|mem-&gt;win
(braket
l_int|0
)braket
dot
id|host_addr
suffix:semicolon
id|req.Size
op_assign
id|mem-&gt;win
(braket
l_int|0
)braket
dot
id|len
suffix:semicolon
r_if
c_cond
(paren
id|req.Size
OL
l_int|0x1000
)paren
(brace
id|req.Size
op_assign
l_int|0x1000
suffix:semicolon
)brace
id|req.AccessSpeed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pcmcia_request_window
c_func
(paren
op_amp
id|link-&gt;handle
comma
op_amp
id|req
comma
op_amp
id|link-&gt;win
)paren
op_ne
l_int|0
)paren
r_goto
id|next_entry
suffix:semicolon
id|map.Page
op_assign
l_int|0
suffix:semicolon
id|map.CardOffset
op_assign
id|mem-&gt;win
(braket
l_int|0
)braket
dot
id|card_addr
suffix:semicolon
r_if
c_cond
(paren
id|pcmcia_map_mem_page
c_func
(paren
id|link-&gt;win
comma
op_amp
id|map
)paren
op_ne
l_int|0
)paren
r_goto
id|next_entry
suffix:semicolon
id|data-&gt;MmioAddress
op_assign
(paren
r_int
r_int
)paren
id|ioremap_nocache
c_func
(paren
id|req.Base
comma
id|req.Size
)paren
suffix:semicolon
id|data-&gt;MmioLength
op_assign
id|req.Size
suffix:semicolon
)brace
multiline_comment|/* If we got this far, we&squot;re cool! */
r_break
suffix:semicolon
id|next_entry
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;next&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;io.NumPorts1
)paren
(brace
id|pcmcia_release_io
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
)brace
id|CS_CHECK
c_func
(paren
id|GetNextTuple
comma
id|pcmcia_get_next_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link-&gt;conf.Attributes
op_amp
id|CONF_ENABLE_IRQ
)paren
(brace
id|CS_CHECK
c_func
(paren
id|RequestIRQ
comma
id|pcmcia_request_irq
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
)paren
suffix:semicolon
)brace
id|CS_CHECK
c_func
(paren
id|RequestConfiguration
comma
id|pcmcia_request_configuration
c_func
(paren
id|handle
comma
op_amp
id|link-&gt;conf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|free_ports
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;io.BasePort1
)paren
(brace
id|release_region
c_func
(paren
id|link-&gt;io.BasePort1
comma
id|link-&gt;io.NumPorts1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link-&gt;io.BasePort2
)paren
(brace
id|release_region
c_func
(paren
id|link-&gt;io.BasePort2
comma
id|link-&gt;io.NumPorts2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Set port and IRQ */
id|data-&gt;BaseAddress
op_assign
id|link-&gt;io.BasePort1
suffix:semicolon
id|data-&gt;NumAddress
op_assign
id|link-&gt;io.NumPorts1
suffix:semicolon
id|data-&gt;IrqNumber
op_assign
id|link-&gt;irq.AssignedIRQ
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;I/O[0x%x+0x%x] IRQ %d&quot;
comma
id|data-&gt;BaseAddress
comma
id|data-&gt;NumAddress
comma
id|data-&gt;IrqNumber
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nsphw_init
c_func
(paren
id|data
)paren
op_eq
id|FALSE
)paren
(brace
r_goto
id|cs_failed
suffix:semicolon
)brace
macro_line|#if (LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,5,2))
id|host
op_assign
id|nsp_detect
c_func
(paren
op_amp
id|nsp_driver_template
)paren
suffix:semicolon
macro_line|#else
id|scsi_register_host
c_func
(paren
op_amp
id|nsp_driver_template
)paren
suffix:semicolon
r_for
c_loop
(paren
id|host
op_assign
id|scsi_host_get_next
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|host
op_ne
l_int|NULL
suffix:semicolon
id|host
op_assign
id|scsi_host_get_next
c_func
(paren
id|host
)paren
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;hostt
op_eq
op_amp
id|nsp_driver_template
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;detect failed&quot;
)paren
suffix:semicolon
r_goto
id|cs_failed
suffix:semicolon
)brace
macro_line|#if (LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,5,74))
id|scsi_add_host
(paren
id|host
comma
l_int|NULL
)paren
suffix:semicolon
id|scsi_scan_host
c_func
(paren
id|host
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|info-&gt;node.dev_name
comma
r_sizeof
(paren
id|info-&gt;node.dev_name
)paren
comma
l_string|&quot;scsi%d&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
id|link-&gt;dev
op_assign
op_amp
id|info-&gt;node
suffix:semicolon
id|info-&gt;host
op_assign
id|host
suffix:semicolon
macro_line|#else
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;GET_SCSI_INFO&quot;
)paren
suffix:semicolon
id|tail
op_assign
op_amp
id|link-&gt;dev
suffix:semicolon
id|info-&gt;ndev
op_assign
l_int|0
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;host=0x%p&quot;
comma
id|host
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|host-&gt;host_queue
suffix:semicolon
id|dev
op_ne
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
r_int
r_int
id|id
suffix:semicolon
id|id
op_assign
(paren
id|dev-&gt;id
op_amp
l_int|0x0f
)paren
op_plus
(paren
(paren
id|dev-&gt;lun
op_amp
l_int|0x0f
)paren
op_lshift
l_int|4
)paren
op_plus
(paren
(paren
id|dev-&gt;channel
op_amp
l_int|0x0f
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
(paren
id|dev-&gt;host-&gt;host_no
op_amp
l_int|0x0f
)paren
op_lshift
l_int|12
)paren
suffix:semicolon
id|node
op_assign
op_amp
id|info-&gt;node
(braket
id|info-&gt;ndev
)braket
suffix:semicolon
id|node-&gt;minor
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;type
)paren
(brace
r_case
id|TYPE_TAPE
suffix:colon
id|node-&gt;major
op_assign
id|SCSI_TAPE_MAJOR
suffix:semicolon
id|snprintf
c_func
(paren
id|node-&gt;dev_name
comma
r_sizeof
(paren
id|node-&gt;dev_name
)paren
comma
l_string|&quot;st#%04lx&quot;
comma
id|id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPE_DISK
suffix:colon
r_case
id|TYPE_MOD
suffix:colon
id|node-&gt;major
op_assign
id|SCSI_DISK0_MAJOR
suffix:semicolon
id|snprintf
c_func
(paren
id|node-&gt;dev_name
comma
r_sizeof
(paren
id|node-&gt;dev_name
)paren
comma
l_string|&quot;sd#%04lx&quot;
comma
id|id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPE_ROM
suffix:colon
r_case
id|TYPE_WORM
suffix:colon
id|node-&gt;major
op_assign
id|SCSI_CDROM_MAJOR
suffix:semicolon
id|snprintf
c_func
(paren
id|node-&gt;dev_name
comma
r_sizeof
(paren
id|node-&gt;dev_name
)paren
comma
l_string|&quot;sr#%04lx&quot;
comma
id|id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|node-&gt;major
op_assign
id|SCSI_GENERIC_MAJOR
suffix:semicolon
id|snprintf
c_func
(paren
id|node-&gt;dev_name
comma
r_sizeof
(paren
id|node-&gt;dev_name
)paren
comma
l_string|&quot;sg#%04lx&quot;
comma
id|id
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|tail
op_assign
id|node
suffix:semicolon
id|tail
op_assign
op_amp
id|node-&gt;next
suffix:semicolon
id|info-&gt;ndev
op_increment
suffix:semicolon
id|info-&gt;host
op_assign
id|dev-&gt;host
suffix:semicolon
)brace
op_star
id|tail
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;ndev
op_eq
l_int|0
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;no SCSI devices found&quot;
)paren
suffix:semicolon
)brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;host=0x%p&quot;
comma
id|host
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Finally, report what we&squot;ve done */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;nsp_cs: index 0x%02x: Vcc %d.%d&quot;
comma
id|link-&gt;conf.ConfigIndex
comma
id|link-&gt;conf.Vcc
op_div
l_int|10
comma
id|link-&gt;conf.Vcc
op_mod
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;conf.Vpp1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;, Vpp %d.%d&quot;
comma
id|link-&gt;conf.Vpp1
op_div
l_int|10
comma
id|link-&gt;conf.Vpp1
op_mod
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link-&gt;conf.Attributes
op_amp
id|CONF_ENABLE_IRQ
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;, irq %d&quot;
comma
id|link-&gt;irq.AssignedIRQ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link-&gt;io.NumPorts1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;, io 0x%04x-0x%04x&quot;
comma
id|link-&gt;io.BasePort1
comma
id|link-&gt;io.BasePort1
op_plus
id|link-&gt;io.NumPorts1
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link-&gt;io.NumPorts2
)paren
id|printk
c_func
(paren
l_string|&quot; &amp; 0x%04x-0x%04x&quot;
comma
id|link-&gt;io.BasePort2
comma
id|link-&gt;io.BasePort2
op_plus
id|link-&gt;io.NumPorts2
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;win
)paren
id|printk
c_func
(paren
l_string|&quot;, mem 0x%06lx-0x%06lx&quot;
comma
id|req.Base
comma
id|req.Base
op_plus
id|req.Size
op_minus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
r_return
suffix:semicolon
id|cs_failed
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;config fail&quot;
)paren
suffix:semicolon
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|last_fn
comma
id|last_ret
)paren
suffix:semicolon
id|nsp_cs_release
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* nsp_cs_config */
DECL|macro|CS_CHECK
macro_line|#undef CS_CHECK
multiline_comment|/*======================================================================&n;    After a card is removed, nsp_cs_release() will unregister the net&n;    device, and release the PCMCIA configuration.  If the device is&n;    still open, this will be postponed until it is closed.&n;======================================================================*/
DECL|function|nsp_cs_release
r_static
r_void
id|nsp_cs_release
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|scsi_info_t
op_star
id|info
op_assign
id|link-&gt;priv
suffix:semicolon
id|nsp_hw_data
op_star
id|data
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;host
op_eq
l_int|NULL
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;unexpected card release call.&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|info-&gt;host-&gt;hostdata
suffix:semicolon
)brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;link=0x%p&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* Unlink the device chain */
macro_line|#if (LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,5,2))
r_if
c_cond
(paren
id|info-&gt;host
op_ne
l_int|NULL
)paren
(brace
id|scsi_remove_host
c_func
(paren
id|info-&gt;host
)paren
suffix:semicolon
)brace
macro_line|#else
id|scsi_unregister_host
c_func
(paren
op_amp
id|nsp_driver_template
)paren
suffix:semicolon
macro_line|#endif
id|link-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;win
)paren
(brace
r_if
c_cond
(paren
id|data
op_ne
l_int|NULL
)paren
(brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|data-&gt;MmioAddress
)paren
)paren
suffix:semicolon
)brace
id|pcmcia_release_window
c_func
(paren
id|link-&gt;win
)paren
suffix:semicolon
)brace
id|pcmcia_release_configuration
c_func
(paren
id|link-&gt;handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;io.NumPorts1
)paren
(brace
id|pcmcia_release_io
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link-&gt;irq.AssignedIRQ
)paren
(brace
id|pcmcia_release_irq
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
)brace
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,5,2))
r_if
c_cond
(paren
id|info-&gt;host
op_ne
l_int|NULL
)paren
(brace
id|scsi_host_put
c_func
(paren
id|info-&gt;host
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* nsp_cs_release */
multiline_comment|/*======================================================================&n;&n;    The card status event handler.  Mostly, this schedules other&n;    stuff to run after an event is received.  A CARD_REMOVAL event&n;    also sets some flags to discourage the net drivers from trying&n;    to talk to the card any more.&n;&n;    When a CARD_REMOVAL event is received, we immediately set a flag&n;    to block future accesses to this device.  All the functions that&n;    actually access the device should check this flag to make sure&n;    the card is still present.&n;&n;======================================================================*/
DECL|function|nsp_cs_event
r_static
r_int
id|nsp_cs_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|args-&gt;client_data
suffix:semicolon
id|scsi_info_t
op_star
id|info
op_assign
id|link-&gt;priv
suffix:semicolon
id|nsp_hw_data
op_star
id|data
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;in, event=0x%08x&quot;
comma
id|event
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CS_EVENT_CARD_REMOVAL
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;event: remove&quot;
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
(paren
(paren
id|scsi_info_t
op_star
)paren
id|link-&gt;priv
)paren
op_member_access_from_pointer
id|stop
op_assign
l_int|1
suffix:semicolon
id|nsp_cs_release
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_INSERTION
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;event: insert&quot;
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_PRESENT
op_or
id|DEV_CONFIG_PENDING
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,5,68))
id|info-&gt;bus
op_assign
id|args-&gt;bus
suffix:semicolon
macro_line|#endif
id|nsp_cs_config
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_SUSPEND
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;event: suspend&quot;
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_RESET_PHYSICAL
suffix:colon
multiline_comment|/* Mark the device as stopped, to block IO until later */
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;event: reset physical&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;host
op_ne
l_int|NULL
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;clear SDTR status&quot;
)paren
suffix:semicolon
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|info-&gt;host-&gt;hostdata
suffix:semicolon
id|nsphw_init_sync
c_func
(paren
id|data
)paren
suffix:semicolon
)brace
id|info-&gt;stop
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|pcmcia_release_configuration
c_func
(paren
id|link-&gt;handle
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_RESUME
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;event: resume&quot;
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_CARD_RESET
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;event: reset&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|pcmcia_request_configuration
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
)brace
id|info-&gt;stop
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;host
op_ne
l_int|NULL
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;reset host and bus&quot;
)paren
suffix:semicolon
id|data
op_assign
(paren
id|nsp_hw_data
op_star
)paren
id|info-&gt;host-&gt;hostdata
suffix:semicolon
id|nsphw_init
(paren
id|data
)paren
suffix:semicolon
id|nsp_bus_reset
c_func
(paren
id|data
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;event: unknown&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;end&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* nsp_cs_event */
multiline_comment|/*======================================================================*&n; *&t;module entry point&n; *====================================================================*/
macro_line|#if (LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,5,68))
DECL|variable|nsp_driver
r_static
r_struct
id|pcmcia_driver
id|nsp_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|drv
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;nsp_cs&quot;
comma
)brace
comma
dot
id|attach
op_assign
id|nsp_cs_attach
comma
dot
id|detach
op_assign
id|nsp_cs_detach
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|function|nsp_cs_init
r_static
r_int
id|__init
id|nsp_cs_init
c_func
(paren
r_void
)paren
(brace
macro_line|#if (LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,5,68))
id|nsp_msg
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;loading...&quot;
)paren
suffix:semicolon
r_return
id|pcmcia_register_driver
c_func
(paren
op_amp
id|nsp_driver
)paren
suffix:semicolon
macro_line|#else
id|servinfo_t
id|serv
suffix:semicolon
id|nsp_msg
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;loading...&quot;
)paren
suffix:semicolon
id|pcmcia_get_card_services_info
c_func
(paren
op_amp
id|serv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv.Revision
op_ne
id|CS_RELEASE_CODE
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Card Services release does not match!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|register_pcmcia_driver
c_func
(paren
op_amp
id|dev_info
comma
op_amp
id|nsp_cs_attach
comma
op_amp
id|nsp_cs_detach
)paren
suffix:semicolon
id|nsp_dbg
c_func
(paren
id|NSP_DEBUG_INIT
comma
l_string|&quot;out&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
DECL|function|nsp_cs_exit
r_static
r_void
id|__exit
id|nsp_cs_exit
c_func
(paren
r_void
)paren
(brace
id|nsp_msg
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;unloading...&quot;
)paren
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,5,68))
id|pcmcia_unregister_driver
c_func
(paren
op_amp
id|nsp_driver
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|dev_list
op_ne
l_int|NULL
)paren
suffix:semicolon
macro_line|#else
id|unregister_pcmcia_driver
c_func
(paren
op_amp
id|dev_info
)paren
suffix:semicolon
multiline_comment|/* XXX: this really needs to move into generic code.. */
r_while
c_loop
(paren
id|dev_list
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|dev_list-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|nsp_cs_release
c_func
(paren
id|dev_list
)paren
suffix:semicolon
)brace
id|nsp_cs_detach
c_func
(paren
id|dev_list
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
id|module_init
c_func
(paren
id|nsp_cs_init
)paren
id|module_exit
c_func
(paren
id|nsp_cs_exit
)paren
multiline_comment|/* end */
eof
