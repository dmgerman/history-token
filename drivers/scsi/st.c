multiline_comment|/*&n;   SCSI Tape Driver for Linux version 1.1 and newer. See the accompanying&n;   file Documentation/scsi/st.txt for more information.&n;&n;   History:&n;   Rewritten from Dwayne Forsyth&squot;s SCSI tape driver by Kai Makisara.&n;   Contribution and ideas from several people including (in alphabetical&n;   order) Klaus Ehrenfried, Eugene Exarevsky, Eric Lee Green, Wolfgang Denk,&n;   Steve Hirsch, Andreas Koppenh&quot;ofer, Michael Leodolter, Eyal Lebedinsky,&n;   Michael Schaefer, J&quot;org Weule, and Eric Youngdale.&n;&n;   Copyright 1992 - 2005 Kai Makisara&n;   email Kai.Makisara@kolumbus.fi&n;&n;   Some small formal changes - aeb, 950809&n;&n;   Last modified: 18-JAN-1998 Richard Gooch &lt;rgooch@atnf.csiro.au&gt; Devfs support&n; */
DECL|variable|verstr
r_static
r_char
op_star
id|verstr
op_assign
l_string|&quot;20050312&quot;
suffix:semicolon
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mtio.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/cdev.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_dbg.h&gt;
macro_line|#include &lt;scsi/scsi_device.h&gt;
macro_line|#include &lt;scsi/scsi_driver.h&gt;
macro_line|#include &lt;scsi/scsi_eh.h&gt;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsi_ioctl.h&gt;
macro_line|#include &lt;scsi/scsi_request.h&gt;
multiline_comment|/* The driver prints some debugging information on the console if DEBUG&n;   is defined and non-zero. */
DECL|macro|DEBUG
mdefine_line|#define DEBUG 0
macro_line|#if DEBUG
multiline_comment|/* The message level for the debug messages is currently set to KERN_NOTICE&n;   so that people can easily see the messages. Later when the debugging messages&n;   in the drivers are more widely classified, this may be changed to KERN_DEBUG. */
DECL|macro|ST_DEB_MSG
mdefine_line|#define ST_DEB_MSG  KERN_NOTICE
DECL|macro|DEB
mdefine_line|#define DEB(a) a
DECL|macro|DEBC
mdefine_line|#define DEBC(a) if (debugging) { a ; }
macro_line|#else
DECL|macro|DEB
mdefine_line|#define DEB(a)
DECL|macro|DEBC
mdefine_line|#define DEBC(a)
macro_line|#endif
DECL|macro|ST_KILOBYTE
mdefine_line|#define ST_KILOBYTE 1024
macro_line|#include &quot;st_options.h&quot;
macro_line|#include &quot;st.h&quot;
DECL|variable|buffer_kbs
r_static
r_int
id|buffer_kbs
suffix:semicolon
DECL|variable|max_sg_segs
r_static
r_int
id|max_sg_segs
suffix:semicolon
DECL|variable|try_direct_io
r_static
r_int
id|try_direct_io
op_assign
id|TRY_DIRECT_IO
suffix:semicolon
DECL|variable|try_rdio
r_static
r_int
id|try_rdio
op_assign
l_int|1
suffix:semicolon
DECL|variable|try_wdio
r_static
r_int
id|try_wdio
op_assign
l_int|1
suffix:semicolon
DECL|variable|st_dev_max
r_static
r_int
id|st_dev_max
suffix:semicolon
DECL|variable|st_nr_dev
r_static
r_int
id|st_nr_dev
suffix:semicolon
DECL|variable|st_sysfs_class
r_static
r_struct
id|class_simple
op_star
id|st_sysfs_class
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Kai Makisara&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SCSI Tape Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* Set &squot;perm&squot; (4th argument) to 0 to disable module_param&squot;s definition&n; * of sysfs parameters (which module_param doesn&squot;t yet support).&n; * Sysfs parameters defined explicitly later.&n; */
id|module_param_named
c_func
(paren
id|buffer_kbs
comma
id|buffer_kbs
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|buffer_kbs
comma
l_string|&quot;Default driver buffer size for fixed block mode (KB; 32)&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|max_sg_segs
comma
id|max_sg_segs
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_sg_segs
comma
l_string|&quot;Maximum number of scatter/gather segments to use (256)&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|try_direct_io
comma
id|try_direct_io
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|try_direct_io
comma
l_string|&quot;Try direct I/O between user buffer and tape drive (1)&quot;
)paren
suffix:semicolon
multiline_comment|/* Extra parameters for testing */
id|module_param_named
c_func
(paren
id|try_rdio
comma
id|try_rdio
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|try_rdio
comma
l_string|&quot;Try direct read i/o when possible&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|try_wdio
comma
id|try_wdio
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|try_wdio
comma
l_string|&quot;Try direct write i/o when possible&quot;
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|variable|write_threshold_kbs
r_static
r_int
id|write_threshold_kbs
suffix:semicolon
multiline_comment|/* retained for compatibility */
DECL|struct|st_dev_parm
r_static
r_struct
id|st_dev_parm
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|val
r_int
op_star
id|val
suffix:semicolon
DECL|variable|__initdata
)brace
id|parms
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_string|&quot;buffer_kbs&quot;
comma
op_amp
id|buffer_kbs
)brace
comma
(brace
multiline_comment|/* Retained for compatibility with 2.4 */
l_string|&quot;write_threshold_kbs&quot;
comma
op_amp
id|write_threshold_kbs
)brace
comma
(brace
l_string|&quot;max_sg_segs&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;try_direct_io&quot;
comma
op_amp
id|try_direct_io
)brace
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* Restrict the number of modes so that names for all are assigned */
macro_line|#if ST_NBR_MODES &gt; 16
macro_line|#error &quot;Maximum number of modes is 16&quot;
macro_line|#endif
multiline_comment|/* Bit reversed order to get same names for same minors with all&n;   mode counts */
DECL|variable|st_formats
r_static
r_char
op_star
id|st_formats
(braket
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
l_string|&quot;r&quot;
comma
l_string|&quot;k&quot;
comma
l_string|&quot;s&quot;
comma
l_string|&quot;l&quot;
comma
l_string|&quot;t&quot;
comma
l_string|&quot;o&quot;
comma
l_string|&quot;u&quot;
comma
l_string|&quot;m&quot;
comma
l_string|&quot;v&quot;
comma
l_string|&quot;p&quot;
comma
l_string|&quot;x&quot;
comma
l_string|&quot;a&quot;
comma
l_string|&quot;y&quot;
comma
l_string|&quot;q&quot;
comma
l_string|&quot;z&quot;
)brace
suffix:semicolon
multiline_comment|/* The default definitions have been moved to st_options.h */
DECL|macro|ST_FIXED_BUFFER_SIZE
mdefine_line|#define ST_FIXED_BUFFER_SIZE (ST_FIXED_BUFFER_BLOCKS * ST_KILOBYTE)
multiline_comment|/* The buffer size should fit into the 24 bits for length in the&n;   6-byte SCSI read and write commands. */
macro_line|#if ST_FIXED_BUFFER_SIZE &gt;= (2 &lt;&lt; 24 - 1)
macro_line|#error &quot;Buffer size should not exceed (2 &lt;&lt; 24 - 1) bytes!&quot;
macro_line|#endif
DECL|variable|debugging
r_static
r_int
id|debugging
op_assign
id|DEBUG
suffix:semicolon
DECL|macro|MAX_RETRIES
mdefine_line|#define MAX_RETRIES 0
DECL|macro|MAX_WRITE_RETRIES
mdefine_line|#define MAX_WRITE_RETRIES 0
DECL|macro|MAX_READY_RETRIES
mdefine_line|#define MAX_READY_RETRIES 0
DECL|macro|NO_TAPE
mdefine_line|#define NO_TAPE  NOT_READY
DECL|macro|ST_TIMEOUT
mdefine_line|#define ST_TIMEOUT (900 * HZ)
DECL|macro|ST_LONG_TIMEOUT
mdefine_line|#define ST_LONG_TIMEOUT (14000 * HZ)
multiline_comment|/* Remove mode bits and auto-rewind bit (7) */
DECL|macro|TAPE_NR
mdefine_line|#define TAPE_NR(x) ( ((iminor(x) &amp; ~255) &gt;&gt; (ST_NBR_MODE_BITS + 1)) | &bslash;&n;    (iminor(x) &amp; ~(-1 &lt;&lt; ST_MODE_SHIFT)) )
DECL|macro|TAPE_MODE
mdefine_line|#define TAPE_MODE(x) ((iminor(x) &amp; ST_MODE_MASK) &gt;&gt; ST_MODE_SHIFT)
multiline_comment|/* Construct the minor number from the device (d), mode (m), and non-rewind (n) data */
DECL|macro|TAPE_MINOR
mdefine_line|#define TAPE_MINOR(d, m, n) (((d &amp; ~(255 &gt;&gt; (ST_NBR_MODE_BITS + 1))) &lt;&lt; (ST_NBR_MODE_BITS + 1)) | &bslash;&n;  (d &amp; (255 &gt;&gt; (ST_NBR_MODE_BITS + 1))) | (m &lt;&lt; ST_MODE_SHIFT) | ((n != 0) &lt;&lt; 7) )
multiline_comment|/* Internal ioctl to set both density (uppermost 8 bits) and blocksize (lower&n;   24 bits) */
DECL|macro|SET_DENS_AND_BLK
mdefine_line|#define SET_DENS_AND_BLK 0x10001
r_static
id|DEFINE_RWLOCK
c_func
(paren
id|st_dev_arr_lock
)paren
suffix:semicolon
DECL|variable|st_fixed_buffer_size
r_static
r_int
id|st_fixed_buffer_size
op_assign
id|ST_FIXED_BUFFER_SIZE
suffix:semicolon
DECL|variable|st_max_sg_segs
r_static
r_int
id|st_max_sg_segs
op_assign
id|ST_MAX_SG
suffix:semicolon
DECL|variable|scsi_tapes
r_static
r_struct
id|scsi_tape
op_star
op_star
id|scsi_tapes
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|modes_defined
r_static
r_int
id|modes_defined
suffix:semicolon
r_static
r_struct
id|st_buffer
op_star
id|new_tape_buffer
c_func
(paren
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|enlarge_buffer
c_func
(paren
r_struct
id|st_buffer
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|normalize_buffer
c_func
(paren
r_struct
id|st_buffer
op_star
)paren
suffix:semicolon
r_static
r_int
id|append_to_buffer
c_func
(paren
r_const
r_char
id|__user
op_star
comma
r_struct
id|st_buffer
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|from_buffer
c_func
(paren
r_struct
id|st_buffer
op_star
comma
r_char
id|__user
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|move_buffer_data
c_func
(paren
r_struct
id|st_buffer
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|buf_to_sg
c_func
(paren
r_struct
id|st_buffer
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|st_map_user_pages
c_func
(paren
r_struct
id|scatterlist
op_star
comma
r_const
r_int
r_int
comma
r_int
r_int
comma
r_int
comma
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|sgl_map_user_pages
c_func
(paren
r_struct
id|scatterlist
op_star
comma
r_const
r_int
r_int
comma
r_int
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|sgl_unmap_user_pages
c_func
(paren
r_struct
id|scatterlist
op_star
comma
r_const
r_int
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|st_probe
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|st_remove
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|st_init_command
c_func
(paren
r_struct
id|scsi_cmnd
op_star
)paren
suffix:semicolon
r_static
r_void
id|do_create_driverfs_files
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_remove_driverfs_files
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_create_class_files
c_func
(paren
r_struct
id|scsi_tape
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
DECL|variable|st_template
r_static
r_struct
id|scsi_driver
id|st_template
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|gendrv
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;st&quot;
comma
dot
id|probe
op_assign
id|st_probe
comma
dot
id|remove
op_assign
id|st_remove
comma
)brace
comma
dot
id|init_command
op_assign
id|st_init_command
comma
)brace
suffix:semicolon
r_static
r_int
id|st_compression
c_func
(paren
r_struct
id|scsi_tape
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|find_partition
c_func
(paren
r_struct
id|scsi_tape
op_star
)paren
suffix:semicolon
r_static
r_int
id|switch_partition
c_func
(paren
r_struct
id|scsi_tape
op_star
)paren
suffix:semicolon
r_static
r_int
id|st_int_ioctl
c_func
(paren
r_struct
id|scsi_tape
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
"&f;"
macro_line|#include &quot;osst_detect.h&quot;
macro_line|#ifndef SIGS_FROM_OSST
DECL|macro|SIGS_FROM_OSST
mdefine_line|#define SIGS_FROM_OSST &bslash;&n;&t;{&quot;OnStream&quot;, &quot;SC-&quot;, &quot;&quot;, &quot;osst&quot;}, &bslash;&n;&t;{&quot;OnStream&quot;, &quot;DI-&quot;, &quot;&quot;, &quot;osst&quot;}, &bslash;&n;&t;{&quot;OnStream&quot;, &quot;DP-&quot;, &quot;&quot;, &quot;osst&quot;}, &bslash;&n;&t;{&quot;OnStream&quot;, &quot;USB&quot;, &quot;&quot;, &quot;osst&quot;}, &bslash;&n;&t;{&quot;OnStream&quot;, &quot;FW-&quot;, &quot;&quot;, &quot;osst&quot;}
macro_line|#endif
DECL|struct|st_reject_data
r_struct
id|st_reject_data
(brace
DECL|member|vendor
r_char
op_star
id|vendor
suffix:semicolon
DECL|member|model
r_char
op_star
id|model
suffix:semicolon
DECL|member|rev
r_char
op_star
id|rev
suffix:semicolon
DECL|member|driver_hint
r_char
op_star
id|driver_hint
suffix:semicolon
multiline_comment|/* Name of the correct driver, NULL if unknown */
)brace
suffix:semicolon
DECL|variable|reject_list
r_static
r_struct
id|st_reject_data
id|reject_list
(braket
)braket
op_assign
(brace
multiline_comment|/* {&quot;XXX&quot;, &quot;Yy-&quot;, &quot;&quot;, NULL},  example */
id|SIGS_FROM_OSST
comma
(brace
l_int|NULL
comma
)brace
)brace
suffix:semicolon
multiline_comment|/* If the device signature is on the list of incompatible drives, the&n;   function returns a pointer to the name of the correct driver (if known) */
DECL|function|st_incompatible
r_static
r_char
op_star
id|st_incompatible
c_func
(paren
r_struct
id|scsi_device
op_star
id|SDp
)paren
(brace
r_struct
id|st_reject_data
op_star
id|rp
suffix:semicolon
r_for
c_loop
(paren
id|rp
op_assign
op_amp
(paren
id|reject_list
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|rp-&gt;vendor
op_ne
l_int|NULL
suffix:semicolon
id|rp
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|rp-&gt;vendor
comma
id|SDp-&gt;vendor
comma
id|strlen
c_func
(paren
id|rp-&gt;vendor
)paren
)paren
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|rp-&gt;model
comma
id|SDp-&gt;model
comma
id|strlen
c_func
(paren
id|rp-&gt;model
)paren
)paren
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|rp-&gt;rev
comma
id|SDp-&gt;rev
comma
id|strlen
c_func
(paren
id|rp-&gt;rev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|rp-&gt;driver_hint
)paren
r_return
id|rp-&gt;driver_hint
suffix:semicolon
r_else
r_return
l_string|&quot;unknown&quot;
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
"&f;"
DECL|function|tape_name
r_static
r_inline
r_char
op_star
id|tape_name
c_func
(paren
r_struct
id|scsi_tape
op_star
id|tape
)paren
(brace
r_return
id|tape-&gt;disk-&gt;disk_name
suffix:semicolon
)brace
DECL|function|st_analyze_sense
r_static
r_void
id|st_analyze_sense
c_func
(paren
r_struct
id|scsi_request
op_star
id|SRpnt
comma
r_struct
id|st_cmdstatus
op_star
id|s
)paren
(brace
r_const
id|u8
op_star
id|ucp
suffix:semicolon
r_const
id|u8
op_star
id|sense
op_assign
id|SRpnt-&gt;sr_sense_buffer
suffix:semicolon
id|s-&gt;have_sense
op_assign
id|scsi_request_normalize_sense
c_func
(paren
id|SRpnt
comma
op_amp
id|s-&gt;sense_hdr
)paren
suffix:semicolon
id|s-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;have_sense
)paren
(brace
id|s-&gt;deferred
op_assign
l_int|0
suffix:semicolon
id|s-&gt;remainder_valid
op_assign
id|scsi_get_sense_info_fld
c_func
(paren
id|sense
comma
id|SCSI_SENSE_BUFFERSIZE
comma
op_amp
id|s-&gt;uremainder64
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x7f
)paren
(brace
r_case
l_int|0x71
suffix:colon
id|s-&gt;deferred
op_assign
l_int|1
suffix:semicolon
r_case
l_int|0x70
suffix:colon
id|s-&gt;fixed_format
op_assign
l_int|1
suffix:semicolon
id|s-&gt;flags
op_assign
id|sense
(braket
l_int|2
)braket
op_amp
l_int|0xe0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x73
suffix:colon
id|s-&gt;deferred
op_assign
l_int|1
suffix:semicolon
r_case
l_int|0x72
suffix:colon
id|s-&gt;fixed_format
op_assign
l_int|0
suffix:semicolon
id|ucp
op_assign
id|scsi_sense_desc_find
c_func
(paren
id|sense
comma
id|SCSI_SENSE_BUFFERSIZE
comma
l_int|4
)paren
suffix:semicolon
id|s-&gt;flags
op_assign
id|ucp
ques
c_cond
(paren
id|ucp
(braket
l_int|3
)braket
op_amp
l_int|0xe0
)paren
suffix:colon
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Convert the result to success code */
DECL|function|st_chk_result
r_static
r_int
id|st_chk_result
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_struct
id|scsi_request
op_star
id|SRpnt
)paren
(brace
r_int
id|result
op_assign
id|SRpnt-&gt;sr_result
suffix:semicolon
id|u8
id|scode
suffix:semicolon
id|DEB
c_func
(paren
r_const
r_char
op_star
id|stp
suffix:semicolon
)paren
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
r_struct
id|st_cmdstatus
op_star
id|cmdstatp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
r_return
l_int|0
suffix:semicolon
id|cmdstatp
op_assign
op_amp
id|STp-&gt;buffer-&gt;cmdstat
suffix:semicolon
id|st_analyze_sense
c_func
(paren
id|STp-&gt;buffer-&gt;last_SRpnt
comma
id|cmdstatp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmdstatp-&gt;have_sense
)paren
id|scode
op_assign
id|STp-&gt;buffer-&gt;cmdstat.sense_hdr.sense_key
suffix:semicolon
r_else
id|scode
op_assign
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Error: %x, cmd: %x %x %x %x %x %x Len: %d&bslash;n&quot;
comma
id|name
comma
id|result
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|1
)braket
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|2
)braket
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|3
)braket
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|4
)braket
comma
id|SRpnt-&gt;sr_cmnd
(braket
l_int|5
)braket
comma
id|SRpnt-&gt;sr_bufflen
)paren
suffix:semicolon
r_if
(paren
id|cmdstatp-&gt;have_sense
)paren
id|scsi_print_req_sense
c_func
(paren
l_string|&quot;st&quot;
comma
id|SRpnt
)paren
suffix:semicolon
)brace
)paren
multiline_comment|/* end DEB */
r_if
c_cond
(paren
op_logical_neg
id|debugging
)paren
(brace
multiline_comment|/* Abnormal conditions for tape */
r_if
c_cond
(paren
op_logical_neg
id|cmdstatp-&gt;have_sense
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Error %x (sugg. bt 0x%x, driver bt 0x%x, host bt 0x%x).&bslash;n&quot;
comma
id|name
comma
id|result
comma
id|suggestion
c_func
(paren
id|result
)paren
comma
id|driver_byte
c_func
(paren
id|result
)paren
op_amp
id|DRIVER_MASK
comma
id|host_byte
c_func
(paren
id|result
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmdstatp-&gt;have_sense
op_logical_and
id|scode
op_ne
id|NO_SENSE
op_logical_and
id|scode
op_ne
id|RECOVERED_ERROR
op_logical_and
multiline_comment|/* scode != UNIT_ATTENTION &amp;&amp; */
id|scode
op_ne
id|BLANK_CHECK
op_logical_and
id|scode
op_ne
id|VOLUME_OVERFLOW
op_logical_and
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
op_ne
id|MODE_SENSE
op_logical_and
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
op_ne
id|TEST_UNIT_READY
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Error with sense data: &quot;
comma
id|name
)paren
suffix:semicolon
id|scsi_print_req_sense
c_func
(paren
l_string|&quot;st&quot;
comma
id|SRpnt
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cmdstatp-&gt;fixed_format
op_logical_and
id|STp-&gt;cln_mode
op_ge
id|EXTENDED_SENSE_START
)paren
(brace
multiline_comment|/* Only fixed format sense */
r_if
c_cond
(paren
id|STp-&gt;cln_sense_value
)paren
id|STp-&gt;cleaning_req
op_or_assign
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
id|STp-&gt;cln_mode
)braket
op_amp
id|STp-&gt;cln_sense_mask
)paren
op_eq
id|STp-&gt;cln_sense_value
)paren
suffix:semicolon
r_else
id|STp-&gt;cleaning_req
op_or_assign
(paren
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
id|STp-&gt;cln_mode
)braket
op_amp
id|STp-&gt;cln_sense_mask
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmdstatp-&gt;have_sense
op_logical_and
id|cmdstatp-&gt;sense_hdr.asc
op_eq
l_int|0
op_logical_and
id|cmdstatp-&gt;sense_hdr.ascq
op_eq
l_int|0x17
)paren
id|STp-&gt;cleaning_req
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ASC and ASCQ =&gt; cleaning requested */
id|STp-&gt;pos_unknown
op_or_assign
id|STp-&gt;device-&gt;was_reset
suffix:semicolon
r_if
c_cond
(paren
id|cmdstatp-&gt;have_sense
op_logical_and
id|scode
op_eq
id|RECOVERED_ERROR
macro_line|#if ST_RECOVERED_WRITE_FATAL
op_logical_and
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
op_ne
id|WRITE_6
op_logical_and
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
op_ne
id|WRITE_FILEMARKS
macro_line|#endif
)paren
(brace
id|STp-&gt;recover_count
op_increment
suffix:semicolon
id|STp-&gt;recover_reg
op_increment
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|debugging
)paren
(brace
r_if
(paren
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
)paren
id|stp
op_assign
l_string|&quot;read&quot;
suffix:semicolon
r_else
r_if
(paren
id|SRpnt-&gt;sr_cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
id|stp
op_assign
l_string|&quot;write&quot;
suffix:semicolon
r_else
id|stp
op_assign
l_string|&quot;ioctl&quot;
suffix:semicolon
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Recovered %s error (%d).&bslash;n&quot;
comma
id|name
comma
id|stp
comma
id|STp-&gt;recover_count
)paren
suffix:semicolon
)brace
)paren
multiline_comment|/* end DEB */
r_if
c_cond
(paren
id|cmdstatp-&gt;flags
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/* Wakeup from interrupt */
DECL|function|st_sleep_done
r_static
r_void
id|st_sleep_done
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
)paren
(brace
r_struct
id|scsi_tape
op_star
id|STp
op_assign
id|container_of
c_func
(paren
id|SCpnt-&gt;request-&gt;rq_disk-&gt;private_data
comma
r_struct
id|scsi_tape
comma
id|driver
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|cmdstat.midlevel_result
op_assign
id|SCpnt-&gt;result
suffix:semicolon
id|SCpnt-&gt;request-&gt;rq_status
op_assign
id|RQ_SCSI_DONE
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_SRpnt
op_assign
id|SCpnt-&gt;sc_request
suffix:semicolon
id|DEB
c_func
(paren
id|STp-&gt;write_pending
op_assign
l_int|0
suffix:semicolon
)paren
id|complete
c_func
(paren
id|SCpnt-&gt;request-&gt;waiting
)paren
suffix:semicolon
)brace
multiline_comment|/* Do the scsi command. Waits until command performed if do_wait is true.&n;   Otherwise write_behind_check() is used to check that the command&n;   has finished. */
r_static
r_struct
id|scsi_request
op_star
DECL|function|st_do_scsi
id|st_do_scsi
c_func
(paren
r_struct
id|scsi_request
op_star
id|SRpnt
comma
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
r_char
op_star
id|cmd
comma
r_int
id|bytes
comma
r_int
id|direction
comma
r_int
id|timeout
comma
r_int
id|retries
comma
r_int
id|do_wait
)paren
(brace
r_int
r_char
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt
op_eq
l_int|NULL
)paren
(brace
id|SRpnt
op_assign
id|scsi_allocate_request
c_func
(paren
id|STp-&gt;device
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt
op_eq
l_int|NULL
)paren
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Can&squot;t get SCSI request.&bslash;n&quot;
comma
id|tape_name
c_func
(paren
id|STp
)paren
)paren
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_assign
(paren
op_minus
id|EINTR
)paren
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_assign
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|init_completion
c_func
(paren
op_amp
id|STp-&gt;wait
)paren
suffix:semicolon
id|SRpnt-&gt;sr_use_sg
op_assign
id|STp-&gt;buffer-&gt;do_dio
op_logical_or
(paren
id|bytes
OG
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|frp
(braket
l_int|0
)braket
dot
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt-&gt;sr_use_sg
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;buffer-&gt;do_dio
)paren
id|buf_to_sg
c_func
(paren
id|STp-&gt;buffer
comma
id|bytes
)paren
suffix:semicolon
id|SRpnt-&gt;sr_use_sg
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|sg_segs
suffix:semicolon
id|bp
op_assign
(paren
r_char
op_star
)paren
op_amp
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|sg
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
id|bp
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
suffix:semicolon
id|SRpnt-&gt;sr_data_direction
op_assign
id|direction
suffix:semicolon
id|SRpnt-&gt;sr_cmd_len
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_request-&gt;waiting
op_assign
op_amp
(paren
id|STp-&gt;wait
)paren
suffix:semicolon
id|SRpnt-&gt;sr_request-&gt;rq_status
op_assign
id|RQ_SCSI_BUSY
suffix:semicolon
id|SRpnt-&gt;sr_request-&gt;rq_disk
op_assign
id|STp-&gt;disk
suffix:semicolon
id|STp-&gt;buffer-&gt;cmdstat.have_sense
op_assign
l_int|0
suffix:semicolon
id|scsi_do_req
c_func
(paren
id|SRpnt
comma
(paren
r_void
op_star
)paren
id|cmd
comma
id|bp
comma
id|bytes
comma
id|st_sleep_done
comma
id|timeout
comma
id|retries
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_wait
)paren
(brace
id|wait_for_completion
c_func
(paren
id|SRpnt-&gt;sr_request-&gt;waiting
)paren
suffix:semicolon
id|SRpnt-&gt;sr_request-&gt;waiting
op_assign
l_int|NULL
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_assign
id|st_chk_result
c_func
(paren
id|STp
comma
id|SRpnt
)paren
suffix:semicolon
)brace
r_return
id|SRpnt
suffix:semicolon
)brace
multiline_comment|/* Handle the write-behind checking (waits for completion). Returns -ENOSPC if&n;   write has been correct but EOM early warning reached, -EIO if write ended in&n;   error or zero if write successful. Asynchronous writes are used only in&n;   variable block mode. */
DECL|function|write_behind_check
r_static
r_int
id|write_behind_check
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|st_buffer
op_star
id|STbuffer
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_struct
id|st_cmdstatus
op_star
id|cmdstatp
suffix:semicolon
id|STbuffer
op_assign
id|STp-&gt;buffer
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STbuffer-&gt;writing
)paren
r_return
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|STp-&gt;write_pending
)paren
id|STp-&gt;nbr_waits
op_increment
suffix:semicolon
r_else
id|STp-&gt;nbr_finished
op_increment
suffix:semicolon
)paren
multiline_comment|/* end DEB */
id|wait_for_completion
c_func
(paren
op_amp
(paren
id|STp-&gt;wait
)paren
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_SRpnt-&gt;sr_request-&gt;waiting
op_assign
l_int|NULL
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_assign
id|st_chk_result
c_func
(paren
id|STp
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_SRpnt
)paren
suffix:semicolon
id|scsi_release_request
c_func
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|last_SRpnt
)paren
suffix:semicolon
id|STbuffer-&gt;buffer_bytes
op_sub_assign
id|STbuffer-&gt;writing
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|STps-&gt;drv_block
op_increment
suffix:semicolon
r_else
id|STps-&gt;drv_block
op_add_assign
id|STbuffer-&gt;writing
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
id|cmdstatp
op_assign
op_amp
id|STbuffer-&gt;cmdstat
suffix:semicolon
r_if
c_cond
(paren
id|STbuffer-&gt;syscall_result
)paren
(brace
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|cmdstatp-&gt;have_sense
op_logical_and
op_logical_neg
id|cmdstatp-&gt;deferred
op_logical_and
(paren
id|cmdstatp-&gt;flags
op_amp
id|SENSE_EOM
)paren
op_logical_and
(paren
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|NO_SENSE
op_logical_or
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|RECOVERED_ERROR
)paren
)paren
(brace
multiline_comment|/* EOM at write-behind, has all data been written? */
r_if
c_cond
(paren
op_logical_neg
id|cmdstatp-&gt;remainder_valid
op_logical_or
id|cmdstatp-&gt;uremainder64
op_eq
l_int|0
)paren
id|retval
op_assign
op_minus
id|ENOSPC
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|EIO
)paren
id|STps-&gt;drv_block
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|STbuffer-&gt;writing
op_assign
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|debugging
op_logical_and
id|retval
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Async write error %x, return value %d.&bslash;n&quot;
comma
id|tape_name
c_func
(paren
id|STp
)paren
comma
id|STbuffer-&gt;cmdstat.midlevel_result
comma
id|retval
)paren
suffix:semicolon
)paren
multiline_comment|/* end DEB */
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Step over EOF if it has been inadvertently crossed (ioctl not used because&n;   it messes up the block number). */
DECL|function|cross_eof
r_static
r_int
id|cross_eof
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
id|forward
)paren
(brace
r_struct
id|scsi_request
op_star
id|SRpnt
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Space FileMarks */
r_if
c_cond
(paren
id|forward
)paren
(brace
id|cmd
(braket
l_int|2
)braket
op_assign
id|cmd
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|cmd
(braket
l_int|2
)braket
op_assign
id|cmd
(braket
l_int|3
)braket
op_assign
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* -1 filemarks */
id|cmd
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Stepping over filemark %s.&bslash;n&quot;
comma
id|tape_name
c_func
(paren
id|STp
)paren
comma
id|forward
ques
c_cond
l_string|&quot;forward&quot;
suffix:colon
l_string|&quot;backward&quot;
)paren
)paren
suffix:semicolon
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|DMA_NONE
comma
id|STp-&gt;device-&gt;timeout
comma
id|MAX_RETRIES
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|cmdstat.midlevel_result
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Stepping over filemark %s failed.&bslash;n&quot;
comma
id|tape_name
c_func
(paren
id|STp
)paren
comma
id|forward
ques
c_cond
l_string|&quot;forward&quot;
suffix:colon
l_string|&quot;backward&quot;
)paren
suffix:semicolon
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
)brace
multiline_comment|/* Flush the write buffer (never need to write if variable blocksize). */
DECL|function|flush_write_buffer
r_static
r_int
id|flush_write_buffer
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
)paren
(brace
r_int
id|offset
comma
id|transfer
comma
id|blks
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
id|result
op_assign
id|write_behind_check
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;dirty
op_eq
l_int|1
)paren
(brace
id|offset
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
suffix:semicolon
id|transfer
op_assign
(paren
(paren
id|offset
op_plus
id|STp-&gt;block_size
op_minus
l_int|1
)paren
op_div
id|STp-&gt;block_size
)paren
op_star
id|STp-&gt;block_size
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Flushing %d bytes.&bslash;n&quot;
comma
id|tape_name
c_func
(paren
id|STp
)paren
comma
id|transfer
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
op_plus
id|offset
comma
l_int|0
comma
id|transfer
op_minus
id|offset
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|blks
op_assign
id|transfer
op_div
id|STp-&gt;block_size
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|cmd
comma
id|transfer
comma
id|DMA_TO_DEVICE
comma
id|STp-&gt;device-&gt;timeout
comma
id|MAX_WRITE_RETRIES
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
r_struct
id|st_cmdstatus
op_star
id|cmdstatp
op_assign
op_amp
id|STp-&gt;buffer-&gt;cmdstat
suffix:semicolon
r_if
c_cond
(paren
id|cmdstatp-&gt;have_sense
op_logical_and
op_logical_neg
id|cmdstatp-&gt;deferred
op_logical_and
(paren
id|cmdstatp-&gt;flags
op_amp
id|SENSE_EOM
)paren
op_logical_and
(paren
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|NO_SENSE
op_logical_or
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|RECOVERED_ERROR
)paren
op_logical_and
(paren
op_logical_neg
id|cmdstatp-&gt;remainder_valid
op_logical_or
id|cmdstatp-&gt;uremainder64
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* All written at EOM early warning */
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
id|STps-&gt;drv_block
op_add_assign
id|blks
suffix:semicolon
id|result
op_assign
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Error on flush.&bslash;n&quot;
comma
id|tape_name
c_func
(paren
id|STp
)paren
)paren
suffix:semicolon
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
id|STps-&gt;drv_block
op_add_assign
id|blks
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
)brace
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Flush the tape buffer. The tape will be positioned correctly unless&n;   seek_next is true. */
DECL|function|flush_buffer
r_static
r_int
id|flush_buffer
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
id|seek_next
)paren
(brace
r_int
id|backspace
comma
id|result
suffix:semicolon
r_struct
id|st_buffer
op_star
id|STbuffer
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
id|STbuffer
op_assign
id|STp-&gt;buffer
suffix:semicolon
multiline_comment|/*&n;&t; * If there was a bus reset, block further access&n;&t; * to this device.&n;&t; */
r_if
c_cond
(paren
id|STp-&gt;pos_unknown
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
l_int|0
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
)paren
multiline_comment|/* Writing */
r_return
id|flush_write_buffer
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|backspace
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
)paren
op_div
id|STp-&gt;block_size
op_minus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_plus
id|STp-&gt;block_size
op_minus
l_int|1
)paren
op_div
id|STp-&gt;block_size
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|seek_next
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
id|result
op_assign
id|cross_eof
c_func
(paren
id|STp
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Back over the EOF hit */
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|result
op_logical_and
id|backspace
OG
l_int|0
)paren
id|result
op_assign
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|MTBSR
comma
id|backspace
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Set the mode parameters */
DECL|function|set_mode_densblk
r_static
r_int
id|set_mode_densblk
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_struct
id|st_modedef
op_star
id|STm
)paren
(brace
r_int
id|set_it
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|arg
suffix:semicolon
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;density_changed
op_logical_and
id|STm-&gt;default_density
op_ge
l_int|0
op_logical_and
id|STm-&gt;default_density
op_ne
id|STp-&gt;density
)paren
(brace
id|arg
op_assign
id|STm-&gt;default_density
suffix:semicolon
id|set_it
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|arg
op_assign
id|STp-&gt;density
suffix:semicolon
id|arg
op_lshift_assign
id|MT_ST_DENSITY_SHIFT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;blksize_changed
op_logical_and
id|STm-&gt;default_blksize
op_ge
l_int|0
op_logical_and
id|STm-&gt;default_blksize
op_ne
id|STp-&gt;block_size
)paren
(brace
id|arg
op_or_assign
id|STm-&gt;default_blksize
suffix:semicolon
id|set_it
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|arg
op_or_assign
id|STp-&gt;block_size
suffix:semicolon
r_if
c_cond
(paren
id|set_it
op_logical_and
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|SET_DENS_AND_BLK
comma
id|arg
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Can&squot;t set default block size to %d bytes and density %x.&bslash;n&quot;
comma
id|name
comma
id|STm-&gt;default_blksize
comma
id|STm-&gt;default_density
)paren
suffix:semicolon
r_if
c_cond
(paren
id|modes_defined
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Lock or unlock the drive door. Don&squot;t use when scsi_request allocated. */
DECL|function|do_door_lock
r_static
r_int
id|do_door_lock
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
id|do_lock
)paren
(brace
r_int
id|retval
comma
id|cmd
suffix:semicolon
id|DEB
c_func
(paren
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
)paren
id|cmd
op_assign
id|do_lock
ques
c_cond
id|SCSI_IOCTL_DOORLOCK
suffix:colon
id|SCSI_IOCTL_DOORUNLOCK
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: %socking drive door.&bslash;n&quot;
comma
id|name
comma
id|do_lock
ques
c_cond
l_string|&quot;L&quot;
suffix:colon
l_string|&quot;Unl&quot;
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|scsi_ioctl
c_func
(paren
id|STp-&gt;device
comma
id|cmd
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
id|STp-&gt;door_locked
op_assign
id|do_lock
ques
c_cond
id|ST_LOCKED_EXPLICIT
suffix:colon
id|ST_UNLOCKED
suffix:semicolon
)brace
r_else
(brace
id|STp-&gt;door_locked
op_assign
id|ST_LOCK_FAILS
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Set the internal state after reset */
DECL|function|reset_state
r_static
r_void
id|reset_state
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
id|STp-&gt;pos_unknown
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|i
)braket
)paren
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;last_block_valid
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;drv_block
op_assign
op_minus
l_int|1
suffix:semicolon
id|STps-&gt;drv_file
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;can_partitions
)paren
(brace
id|STp-&gt;partition
op_assign
id|find_partition
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;partition
OL
l_int|0
)paren
id|STp-&gt;partition
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;new_partition
op_assign
id|STp-&gt;partition
suffix:semicolon
)brace
)brace
"&f;"
multiline_comment|/* Test if the drive is ready. Returns either one of the codes below or a negative system&n;   error code. */
DECL|macro|CHKRES_READY
mdefine_line|#define CHKRES_READY       0
DECL|macro|CHKRES_NEW_SESSION
mdefine_line|#define CHKRES_NEW_SESSION 1
DECL|macro|CHKRES_NOT_READY
mdefine_line|#define CHKRES_NOT_READY   2
DECL|macro|CHKRES_NO_TAPE
mdefine_line|#define CHKRES_NO_TAPE     3
DECL|macro|MAX_ATTENTIONS
mdefine_line|#define MAX_ATTENTIONS    10
DECL|function|test_ready
r_static
r_int
id|test_ready
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
id|do_wait
)paren
(brace
r_int
id|attentions
comma
id|waits
comma
id|max_wait
comma
id|scode
suffix:semicolon
r_int
id|retval
op_assign
id|CHKRES_READY
comma
id|new_session
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|st_cmdstatus
op_star
id|cmdstatp
op_assign
op_amp
id|STp-&gt;buffer-&gt;cmdstat
suffix:semicolon
id|max_wait
op_assign
id|do_wait
ques
c_cond
id|ST_BLOCK_SECONDS
suffix:colon
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|attentions
op_assign
id|waits
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
)paren
(brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|TEST_UNIT_READY
suffix:semicolon
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|DMA_NONE
comma
id|STp-&gt;long_timeout
comma
id|MAX_READY_RETRIES
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
(brace
id|retval
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmdstatp-&gt;have_sense
)paren
(brace
id|scode
op_assign
id|cmdstatp-&gt;sense_hdr.sense_key
suffix:semicolon
r_if
c_cond
(paren
id|scode
op_eq
id|UNIT_ATTENTION
)paren
(brace
multiline_comment|/* New media? */
id|new_session
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|attentions
OL
id|MAX_ATTENTIONS
)paren
(brace
id|attentions
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|scode
op_eq
id|NOT_READY
)paren
(brace
r_if
c_cond
(paren
id|waits
OL
id|max_wait
)paren
(brace
r_if
c_cond
(paren
id|msleep_interruptible
c_func
(paren
l_int|1000
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINTR
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|waits
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
op_ge
id|SCSI_2
op_logical_and
id|cmdstatp-&gt;sense_hdr.asc
op_eq
l_int|0x3a
)paren
multiline_comment|/* Check ASC */
id|retval
op_assign
id|CHKRES_NO_TAPE
suffix:semicolon
r_else
id|retval
op_assign
id|CHKRES_NOT_READY
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|retval
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|retval
op_assign
id|new_session
ques
c_cond
id|CHKRES_NEW_SESSION
suffix:colon
id|CHKRES_READY
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SRpnt
op_ne
l_int|NULL
)paren
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* See if the drive is ready and gather information about the tape. Return values:&n;   &lt; 0   negative error code from errno.h&n;   0     drive ready&n;   1     drive not ready (possibly no tape)&n;*/
DECL|function|check_tape
r_static
r_int
id|check_tape
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|i
comma
id|retval
comma
id|new_session
op_assign
l_int|0
comma
id|do_wait
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
comma
id|saved_cleaning
suffix:semicolon
r_int
r_int
id|st_flags
op_assign
id|filp-&gt;f_flags
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|st_modedef
op_star
id|STm
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_int
id|mode
op_assign
id|TAPE_MODE
c_func
(paren
id|inode
)paren
suffix:semicolon
id|STp-&gt;ready
op_assign
id|ST_READY
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
id|STp-&gt;current_mode
)paren
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Mode change from %d to %d.&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;current_mode
comma
id|mode
)paren
)paren
suffix:semicolon
id|new_session
op_assign
l_int|1
suffix:semicolon
id|STp-&gt;current_mode
op_assign
id|mode
suffix:semicolon
)brace
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
id|saved_cleaning
op_assign
id|STp-&gt;cleaning_req
suffix:semicolon
id|STp-&gt;cleaning_req
op_assign
l_int|0
suffix:semicolon
id|do_wait
op_assign
(paren
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|retval
op_assign
id|test_ready
c_func
(paren
id|STp
comma
id|do_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_goto
id|err_out
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
id|CHKRES_NEW_SESSION
)paren
(brace
id|STp-&gt;pos_unknown
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;partition
op_assign
id|STp-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;can_partitions
)paren
id|STp-&gt;nbr_partitions
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* This guess will be updated later&n;                                                    if necessary */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|i
)braket
)paren
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;last_block_valid
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;drv_file
op_assign
l_int|0
suffix:semicolon
)brace
id|new_session
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|STp-&gt;cleaning_req
op_or_assign
id|saved_cleaning
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
id|CHKRES_NOT_READY
op_logical_or
id|retval
op_eq
id|CHKRES_NO_TAPE
)paren
(brace
r_if
c_cond
(paren
id|retval
op_eq
id|CHKRES_NO_TAPE
)paren
id|STp-&gt;ready
op_assign
id|ST_NO_TAPE
suffix:semicolon
r_else
id|STp-&gt;ready
op_assign
id|ST_NOT_READY
suffix:semicolon
id|STp-&gt;density
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear the erroneous &quot;residue&quot; */
id|STp-&gt;write_prot
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;block_size
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;ps
(braket
l_int|0
)braket
dot
id|drv_file
op_assign
id|STp-&gt;ps
(braket
l_int|0
)braket
dot
id|drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|STp-&gt;partition
op_assign
id|STp-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;door_locked
op_assign
id|ST_UNLOCKED
suffix:semicolon
r_return
id|CHKRES_NOT_READY
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|STp-&gt;omit_blklims
)paren
id|STp-&gt;min_block
op_assign
id|STp-&gt;max_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_else
(brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|READ_BLOCK_LIMITS
suffix:semicolon
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
l_int|6
comma
id|DMA_FROM_DEVICE
comma
id|STp-&gt;device-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
(brace
id|retval
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|SRpnt-&gt;sr_result
op_logical_and
op_logical_neg
id|STp-&gt;buffer-&gt;cmdstat.have_sense
)paren
(brace
id|STp-&gt;max_block
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|3
)braket
suffix:semicolon
id|STp-&gt;min_block
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|5
)braket
suffix:semicolon
r_if
c_cond
(paren
id|DEB
c_func
(paren
id|debugging
op_logical_or
)paren
op_logical_neg
id|STp-&gt;inited
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Block limits %d - %d bytes.&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;min_block
comma
id|STp-&gt;max_block
)paren
suffix:semicolon
)brace
r_else
(brace
id|STp-&gt;min_block
op_assign
id|STp-&gt;max_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Can&squot;t read block limits.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|cmd
(braket
l_int|0
)braket
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SENSE
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|12
suffix:semicolon
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
l_int|12
comma
id|DMA_FROM_DEVICE
comma
id|STp-&gt;device-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
(brace
id|retval
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: No Mode Sense.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
id|STp-&gt;block_size
op_assign
id|ST_DEFAULT_BLOCK
suffix:semicolon
multiline_comment|/* Educated guess (?) */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Prevent error propagation */
id|STp-&gt;drv_write_prot
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Mode sense. Length %d, medium %x, WBS %x, BLL %d&bslash;n&quot;
comma
id|name
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|3
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|3
)braket
op_ge
l_int|8
)paren
(brace
id|STp-&gt;drv_buffer
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|7
suffix:semicolon
id|STp-&gt;density
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
suffix:semicolon
id|STp-&gt;block_size
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|9
)braket
op_star
l_int|65536
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|10
)braket
op_star
l_int|256
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|11
)braket
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Density %x, tape length: %x, drv buffer: %d&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;density
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|5
)braket
op_star
l_int|65536
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|6
)braket
op_star
l_int|256
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|7
)braket
comma
id|STp-&gt;drv_buffer
)paren
)paren
suffix:semicolon
)brace
id|STp-&gt;drv_write_prot
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
suffix:semicolon
)brace
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
id|STp-&gt;inited
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
OG
l_int|0
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
op_div
id|STp-&gt;block_size
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
op_assign
l_int|1
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_assign
l_int|0
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Block size: %d, buffer size: %d (%d blocks).&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;block_size
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;drv_write_prot
)paren
(brace
id|STp-&gt;write_prot
op_assign
l_int|1
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Write protected&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_wait
op_logical_and
(paren
(paren
id|st_flags
op_amp
id|O_ACCMODE
)paren
op_eq
id|O_WRONLY
op_logical_or
(paren
id|st_flags
op_amp
id|O_ACCMODE
)paren
op_eq
id|O_RDWR
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EROFS
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
id|STp-&gt;nbr_partitions
OL
l_int|1
)paren
(brace
multiline_comment|/* This code is reached when the device is opened for the first time&n;&t;&t;   after the driver has been initialized with tape in the drive and the&n;&t;&t;   partition support has been enabled. */
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Updating partition number in status.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;partition
op_assign
id|find_partition
c_func
(paren
id|STp
)paren
)paren
OL
l_int|0
)paren
(brace
id|retval
op_assign
id|STp-&gt;partition
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|STp-&gt;new_partition
op_assign
id|STp-&gt;partition
suffix:semicolon
id|STp-&gt;nbr_partitions
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* This guess will be updated when necessary */
)brace
r_if
c_cond
(paren
id|new_session
)paren
(brace
multiline_comment|/* Change the drive parameters for the new mode */
id|STp-&gt;density_changed
op_assign
id|STp-&gt;blksize_changed
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;compression_changed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|STm-&gt;defaults_for_writes
)paren
op_logical_and
(paren
id|retval
op_assign
id|set_mode_densblk
c_func
(paren
id|STp
comma
id|STm
)paren
)paren
OL
l_int|0
)paren
r_goto
id|err_out
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;default_drvbuffer
op_ne
l_int|0xff
)paren
(brace
r_if
c_cond
(paren
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|MTSETDRVBUFFER
comma
id|STp-&gt;default_drvbuffer
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Can&squot;t set default drive buffering to %d.&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;default_drvbuffer
)paren
suffix:semicolon
)brace
)brace
r_return
id|CHKRES_READY
suffix:semicolon
id|err_out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Open the device. Needs to be called with BKL only because of incrementing the SCSI host&n;   module count. */
DECL|function|st_open
r_static
r_int
id|st_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|i
comma
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_struct
id|scsi_tape
op_star
id|STp
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_int
id|dev
op_assign
id|TAPE_NR
c_func
(paren
id|inode
)paren
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
multiline_comment|/*&n;&t; * We really want to do nonseekable_open(inode, filp); here, but some&n;&t; * versions of tar incorrectly call lseek on tapes and bail out if that&n;&t; * fails.  So we disallow pread() and pwrite(), but permit lseeks.&n;&t; */
id|filp-&gt;f_mode
op_and_assign
op_complement
(paren
id|FMODE_PREAD
op_or
id|FMODE_PWRITE
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|st_dev_max
op_logical_or
id|scsi_tapes
op_eq
l_int|NULL
op_logical_or
(paren
(paren
id|STp
op_assign
id|scsi_tapes
(braket
id|dev
)braket
)paren
op_eq
l_int|NULL
)paren
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
)brace
id|filp-&gt;private_data
op_assign
id|STp
suffix:semicolon
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;in_use
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Device already in use.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_device_get
c_func
(paren
id|STp-&gt;device
)paren
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
)brace
id|STp-&gt;in_use
op_assign
l_int|1
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
id|STp-&gt;rew_at_close
op_assign
id|STp-&gt;autorew_dev
op_assign
(paren
id|iminor
c_func
(paren
id|inode
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_block_when_processing_errors
c_func
(paren
id|STp-&gt;device
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
multiline_comment|/* See that we have at least a one page buffer available */
r_if
c_cond
(paren
op_logical_neg
id|enlarge_buffer
c_func
(paren
id|STp-&gt;buffer
comma
id|PAGE_SIZE
comma
id|STp-&gt;restr_dma
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Can&squot;t allocate one page tape buffer.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EOVERFLOW
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|writing
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;write_prot
op_assign
(paren
(paren
id|filp-&gt;f_flags
op_amp
id|O_ACCMODE
)paren
op_eq
id|O_RDONLY
)paren
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|i
)braket
)paren
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
)brace
id|STp-&gt;recover_count
op_assign
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
id|STp-&gt;nbr_waits
op_assign
id|STp-&gt;nbr_finished
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;nbr_requests
op_assign
id|STp-&gt;nbr_dio
op_assign
id|STp-&gt;nbr_pages
op_assign
id|STp-&gt;nbr_combinable
op_assign
l_int|0
suffix:semicolon
)paren
id|retval
op_assign
id|check_tape
c_func
(paren
id|STp
comma
id|filp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_goto
id|err_out
suffix:semicolon
r_if
c_cond
(paren
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
op_eq
l_int|0
op_logical_and
id|retval
op_ne
id|CHKRES_READY
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|err_out
suffix:colon
id|normalize_buffer
c_func
(paren
id|STp-&gt;buffer
)paren
suffix:semicolon
id|STp-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|scsi_device_put
c_func
(paren
id|STp-&gt;device
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Flush the tape buffer before close */
DECL|function|st_flush
r_static
r_int
id|st_flush
c_func
(paren
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|result
op_assign
l_int|0
comma
id|result2
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
suffix:semicolon
r_struct
id|scsi_tape
op_star
id|STp
op_assign
id|filp-&gt;private_data
suffix:semicolon
r_struct
id|st_modedef
op_star
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file_count
c_func
(paren
id|filp
)paren
OG
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
op_logical_and
op_logical_neg
id|STp-&gt;pos_unknown
)paren
(brace
id|result
op_assign
id|flush_write_buffer
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
op_logical_and
id|result
op_ne
(paren
op_minus
id|ENOSPC
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
(paren
id|result2
op_assign
id|switch_partition
c_func
(paren
id|STp
)paren
)paren
OL
l_int|0
)paren
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: switch_partition at close failed.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
id|result
op_assign
id|result2
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|DEBC
c_func
(paren
r_if
(paren
id|STp-&gt;nbr_requests
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Number of r/w requests %d, dio used in %d, pages %d (%d).&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;nbr_requests
comma
id|STp-&gt;nbr_dio
comma
id|STp-&gt;nbr_pages
comma
id|STp-&gt;nbr_combinable
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
op_logical_and
op_logical_neg
id|STp-&gt;pos_unknown
)paren
(brace
r_struct
id|st_cmdstatus
op_star
id|cmdstatp
op_assign
op_amp
id|STp-&gt;buffer-&gt;cmdstat
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Async write waits %d, finished %d.&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;nbr_waits
comma
id|STp-&gt;nbr_finished
)paren
suffix:semicolon
)paren
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_FILEMARKS
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|1
op_plus
id|STp-&gt;two_fm
suffix:semicolon
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|DMA_NONE
comma
id|STp-&gt;device-&gt;timeout
comma
id|MAX_WRITE_RETRIES
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
(brace
id|result
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;buffer-&gt;syscall_result
op_eq
l_int|0
op_logical_or
(paren
id|cmdstatp-&gt;have_sense
op_logical_and
op_logical_neg
id|cmdstatp-&gt;deferred
op_logical_and
(paren
id|cmdstatp-&gt;flags
op_amp
id|SENSE_EOM
)paren
op_logical_and
(paren
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|NO_SENSE
op_logical_or
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|RECOVERED_ERROR
)paren
op_logical_and
(paren
op_logical_neg
id|cmdstatp-&gt;remainder_valid
op_logical_or
id|cmdstatp-&gt;uremainder64
op_eq
l_int|0
)paren
)paren
)paren
(brace
multiline_comment|/* Write successful at EOM */
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;two_fm
)paren
id|cross_eof
c_func
(paren
id|STp
comma
l_int|0
)paren
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_FM
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Write error */
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Error on write filemark.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Buffer flushed, %d EOF(s) written&bslash;n&quot;
comma
id|name
comma
id|cmd
(braket
l_int|4
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;rew_at_close
)paren
(brace
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;sysv
op_logical_or
id|STps-&gt;rw
op_ne
id|ST_READING
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;can_bsr
)paren
id|result
op_assign
id|flush_buffer
c_func
(paren
id|STp
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
id|result
op_assign
id|cross_eof
c_func
(paren
id|STp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_FM
suffix:semicolon
)brace
r_else
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|STps-&gt;eof
op_eq
id|ST_NOEOF
op_logical_and
op_logical_neg
(paren
id|result
op_assign
id|cross_eof
c_func
(paren
id|STp
comma
l_int|1
)paren
)paren
)paren
op_logical_or
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_FM
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;rew_at_close
)paren
(brace
id|result2
op_assign
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|MTREW
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
id|result
op_assign
id|result2
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Close the device and release it. BKL is not needed: this is the only thread&n;   accessing this tape. */
DECL|function|st_release
r_static
r_int
id|st_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|scsi_tape
op_star
id|STp
op_assign
id|filp-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;door_locked
op_eq
id|ST_LOCKED_AUTO
)paren
id|do_door_lock
c_func
(paren
id|STp
comma
l_int|0
)paren
suffix:semicolon
id|normalize_buffer
c_func
(paren
id|STp-&gt;buffer
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
id|STp-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
id|scsi_device_put
c_func
(paren
id|STp-&gt;device
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
"&f;"
multiline_comment|/* The checks common to both reading and writing */
DECL|function|rw_checks
r_static
id|ssize_t
id|rw_checks
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|count
)paren
(brace
id|ssize_t
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * If we are in the middle of error recovery, don&squot;t let anyone&n;&t; * else try and use this device.  Also, if error recovery fails, it&n;&t; * may try and take the device offline, in which case all further&n;&t; * access to the device is prohibited.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|scsi_block_when_processing_errors
c_func
(paren
id|STp-&gt;device
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_NO_TAPE
)paren
id|retval
op_assign
(paren
op_minus
id|ENOMEDIUM
)paren
suffix:semicolon
r_else
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
dot
id|defined
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If there was a bus reset, block further access&n;&t; * to this device.&n;&t; */
r_if
c_cond
(paren
id|STp-&gt;pos_unknown
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
op_logical_neg
id|STp-&gt;in_use
)paren
(brace
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Incorrect device.&bslash;n&quot;
comma
id|tape_name
c_func
(paren
id|STp
)paren
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)paren
multiline_comment|/* end DEB */
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
(paren
id|retval
op_assign
id|switch_partition
c_func
(paren
id|STp
)paren
)paren
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
op_logical_and
id|STp-&gt;max_block
OG
l_int|0
op_logical_and
(paren
id|count
template_param
id|STp-&gt;max_block
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;do_auto_lock
op_logical_and
id|STp-&gt;door_locked
op_eq
id|ST_UNLOCKED
op_logical_and
op_logical_neg
id|do_door_lock
c_func
(paren
id|STp
comma
l_int|1
)paren
)paren
id|STp-&gt;door_locked
op_assign
id|ST_LOCKED_AUTO
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|setup_buffering
r_static
r_int
id|setup_buffering
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|is_read
)paren
(brace
r_int
id|i
comma
id|bufsize
comma
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|st_buffer
op_star
id|STbp
op_assign
id|STp-&gt;buffer
suffix:semicolon
r_if
c_cond
(paren
id|is_read
)paren
id|i
op_assign
id|STp-&gt;try_dio
op_logical_and
id|try_rdio
suffix:semicolon
r_else
id|i
op_assign
id|STp-&gt;try_dio
op_logical_and
id|try_wdio
suffix:semicolon
r_if
c_cond
(paren
id|i
op_logical_and
(paren
(paren
r_int
r_int
)paren
id|buf
op_amp
id|queue_dma_alignment
c_func
(paren
id|STp-&gt;device-&gt;request_queue
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|i
op_assign
id|st_map_user_pages
c_func
(paren
op_amp
(paren
id|STbp-&gt;sg
(braket
l_int|0
)braket
)paren
comma
id|STbp-&gt;use_sg
comma
(paren
r_int
r_int
)paren
id|buf
comma
id|count
comma
(paren
id|is_read
ques
c_cond
id|READ
suffix:colon
id|WRITE
)paren
comma
id|STp-&gt;max_pfn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|0
)paren
(brace
id|STbp-&gt;do_dio
op_assign
id|i
suffix:semicolon
id|STbp-&gt;buffer_bytes
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* can be used as transfer counter */
)brace
r_else
id|STbp-&gt;do_dio
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fall back to buffering with any error */
id|STbp-&gt;sg_segs
op_assign
id|STbp-&gt;do_dio
suffix:semicolon
id|STbp-&gt;frp_sg_current
op_assign
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|STbp-&gt;do_dio
)paren
(brace
id|STp-&gt;nbr_dio
op_increment
suffix:semicolon
id|STp-&gt;nbr_pages
op_add_assign
id|STbp-&gt;do_dio
suffix:semicolon
r_for
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|STbp-&gt;do_dio
suffix:semicolon
id|i
op_increment
)paren
r_if
(paren
id|page_to_pfn
c_func
(paren
id|STbp-&gt;sg
(braket
id|i
)braket
dot
id|page
)paren
op_eq
id|page_to_pfn
c_func
(paren
id|STbp-&gt;sg
(braket
id|i
op_minus
l_int|1
)braket
dot
id|page
)paren
op_plus
l_int|1
)paren
id|STp-&gt;nbr_combinable
op_increment
suffix:semicolon
)brace
)paren
)brace
r_else
id|STbp-&gt;do_dio
op_assign
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
id|STp-&gt;nbr_requests
op_increment
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|STbp-&gt;do_dio
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
)paren
id|bufsize
op_assign
id|STp-&gt;block_size
OG
id|st_fixed_buffer_size
ques
c_cond
id|STp-&gt;block_size
suffix:colon
id|st_fixed_buffer_size
suffix:semicolon
r_else
id|bufsize
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|bufsize
OG
id|STbp-&gt;buffer_size
op_logical_and
op_logical_neg
id|enlarge_buffer
c_func
(paren
id|STbp
comma
id|bufsize
comma
id|STp-&gt;restr_dma
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Can&squot;t allocate %d byte tape buffer.&bslash;n&quot;
comma
id|tape_name
c_func
(paren
id|STp
)paren
comma
id|bufsize
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EOVERFLOW
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;block_size
)paren
id|STbp-&gt;buffer_blocks
op_assign
id|bufsize
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Can be called more than once after each setup_buffer() */
DECL|function|release_buffering
r_static
r_void
id|release_buffering
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
)paren
(brace
r_struct
id|st_buffer
op_star
id|STbp
suffix:semicolon
id|STbp
op_assign
id|STp-&gt;buffer
suffix:semicolon
r_if
c_cond
(paren
id|STbp-&gt;do_dio
)paren
(brace
id|sgl_unmap_user_pages
c_func
(paren
op_amp
(paren
id|STbp-&gt;sg
(braket
l_int|0
)braket
)paren
comma
id|STbp-&gt;do_dio
comma
l_int|0
)paren
suffix:semicolon
id|STbp-&gt;do_dio
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Write command */
r_static
id|ssize_t
DECL|function|st_write
id|st_write
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ssize_t
id|total
suffix:semicolon
id|ssize_t
id|i
comma
id|do_count
comma
id|blks
comma
id|transfer
suffix:semicolon
id|ssize_t
id|retval
suffix:semicolon
r_int
id|undone
comma
id|retry_eot
op_assign
l_int|0
comma
id|scode
suffix:semicolon
r_int
id|async_write
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_const
r_char
id|__user
op_star
id|b_point
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|scsi_tape
op_star
id|STp
op_assign
id|filp-&gt;private_data
suffix:semicolon
r_struct
id|st_modedef
op_star
id|STm
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_struct
id|st_buffer
op_star
id|STbp
suffix:semicolon
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|retval
op_assign
id|rw_checks
c_func
(paren
id|STp
comma
id|filp
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_logical_or
id|count
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Write must be integral number of blocks */
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
op_logical_and
(paren
id|count
op_mod
id|STp-&gt;block_size
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Write not multiple of tape block size.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;write_prot
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_READING
)paren
(brace
id|retval
op_assign
id|flush_buffer
c_func
(paren
id|STp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_WRITING
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;rw
op_ne
id|ST_WRITING
op_logical_and
id|STps-&gt;drv_file
op_eq
l_int|0
op_logical_and
id|STps-&gt;drv_block
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|set_mode_densblk
c_func
(paren
id|STp
comma
id|STm
)paren
)paren
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|STm-&gt;default_compression
op_ne
id|ST_DONT_TOUCH
op_logical_and
op_logical_neg
(paren
id|STp-&gt;compression_changed
)paren
)paren
(brace
r_if
c_cond
(paren
id|st_compression
c_func
(paren
id|STp
comma
(paren
id|STm-&gt;default_compression
op_eq
id|ST_YES
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Can&squot;t set default compression.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|modes_defined
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
)brace
)brace
id|STbp
op_assign
id|STp-&gt;buffer
suffix:semicolon
id|i
op_assign
id|write_behind_check
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
op_minus
id|ENOSPC
)paren
id|STps-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
r_else
id|STps-&gt;eof
op_assign
id|ST_EOM_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_EOM_OK
)paren
(brace
id|STps-&gt;eof
op_assign
id|ST_EOD_1
suffix:semicolon
multiline_comment|/* allow next write */
id|retval
op_assign
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_EOM_ERROR
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Check the buffer readability in cases where copy_user might catch&n;&t;   the problems after some tape movement. */
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
op_logical_and
op_logical_neg
id|STbp-&gt;do_dio
op_logical_and
(paren
id|copy_from_user
c_func
(paren
op_amp
id|i
comma
id|buf
comma
l_int|1
)paren
op_ne
l_int|0
op_logical_or
id|copy_from_user
c_func
(paren
op_amp
id|i
comma
id|buf
op_plus
id|count
op_minus
l_int|1
comma
l_int|1
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|setup_buffering
c_func
(paren
id|STp
comma
id|buf
comma
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
id|total
op_assign
id|count
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_WRITING
suffix:semicolon
id|b_point
op_assign
id|buf
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
op_logical_and
op_logical_neg
id|retry_eot
)paren
(brace
r_if
c_cond
(paren
id|STbp-&gt;do_dio
)paren
(brace
id|do_count
op_assign
id|count
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|do_count
op_assign
id|count
suffix:semicolon
r_else
(brace
id|do_count
op_assign
id|STbp-&gt;buffer_blocks
op_star
id|STp-&gt;block_size
op_minus
id|STbp-&gt;buffer_bytes
suffix:semicolon
r_if
c_cond
(paren
id|do_count
OG
id|count
)paren
id|do_count
op_assign
id|count
suffix:semicolon
)brace
id|i
op_assign
id|append_to_buffer
c_func
(paren
id|b_point
comma
id|STbp
comma
id|do_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|count
op_sub_assign
id|do_count
suffix:semicolon
id|b_point
op_add_assign
id|do_count
suffix:semicolon
id|async_write
op_assign
id|STp-&gt;block_size
op_eq
l_int|0
op_logical_and
op_logical_neg
id|STbp-&gt;do_dio
op_logical_and
id|STm-&gt;do_async_writes
op_logical_and
id|STps-&gt;eof
OL
id|ST_EOM_OK
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
op_logical_and
id|STm-&gt;do_buffer_writes
op_logical_and
op_logical_neg
(paren
id|STp-&gt;try_dio
op_logical_and
id|try_wdio
)paren
op_logical_and
id|STps-&gt;eof
OL
id|ST_EOM_OK
op_logical_and
id|STbp-&gt;buffer_bytes
OL
id|STbp-&gt;buffer_size
)paren
(brace
id|STp-&gt;dirty
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t write a buffer that is not full enough. */
r_if
c_cond
(paren
op_logical_neg
id|async_write
op_logical_and
id|count
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|retry_write
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|blks
op_assign
id|transfer
op_assign
id|do_count
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|STbp-&gt;do_dio
)paren
id|blks
op_assign
id|STbp-&gt;buffer_bytes
suffix:semicolon
r_else
id|blks
op_assign
id|do_count
suffix:semicolon
id|blks
op_div_assign
id|STp-&gt;block_size
suffix:semicolon
id|transfer
op_assign
id|blks
op_star
id|STp-&gt;block_size
suffix:semicolon
)brace
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|transfer
comma
id|DMA_TO_DEVICE
comma
id|STp-&gt;device-&gt;timeout
comma
id|MAX_WRITE_RETRIES
comma
op_logical_neg
id|async_write
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
(brace
id|retval
op_assign
id|STbp-&gt;syscall_result
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|async_write
)paren
(brace
id|STbp-&gt;writing
op_assign
id|transfer
suffix:semicolon
id|STp-&gt;dirty
op_assign
op_logical_neg
(paren
id|STbp-&gt;writing
op_eq
id|STbp-&gt;buffer_bytes
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Prevent releasing this request! */
id|DEB
c_func
(paren
id|STp-&gt;write_pending
op_assign
l_int|1
suffix:semicolon
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STbp-&gt;syscall_result
op_ne
l_int|0
)paren
(brace
r_struct
id|st_cmdstatus
op_star
id|cmdstatp
op_assign
op_amp
id|STp-&gt;buffer-&gt;cmdstat
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Error on write:&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmdstatp-&gt;have_sense
op_logical_and
(paren
id|cmdstatp-&gt;flags
op_amp
id|SENSE_EOM
)paren
)paren
(brace
id|scode
op_assign
id|cmdstatp-&gt;sense_hdr.sense_key
suffix:semicolon
r_if
c_cond
(paren
id|cmdstatp-&gt;remainder_valid
)paren
id|undone
op_assign
(paren
r_int
)paren
id|cmdstatp-&gt;uremainder64
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
op_logical_and
id|scode
op_eq
id|VOLUME_OVERFLOW
)paren
id|undone
op_assign
id|transfer
suffix:semicolon
r_else
id|undone
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
id|undone
op_mul_assign
id|STp-&gt;block_size
suffix:semicolon
r_if
c_cond
(paren
id|undone
op_le
id|do_count
)paren
(brace
multiline_comment|/* Only data from this write is not written */
id|count
op_add_assign
id|undone
suffix:semicolon
id|do_count
op_sub_assign
id|undone
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
)paren
id|blks
op_assign
(paren
id|transfer
op_minus
id|undone
)paren
op_div
id|STp-&gt;block_size
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
multiline_comment|/* Continue in fixed block mode if all written&n;&t;&t;&t;&t;&t;   in this request but still something left to write&n;&t;&t;&t;&t;&t;   (retval left to zero)&n;&t;&t;&t;&t;&t;*/
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
op_logical_or
id|undone
OG
l_int|0
op_logical_or
id|count
op_eq
l_int|0
)paren
id|retval
op_assign
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
multiline_comment|/* EOM within current request */
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: EOM with %d bytes unwritten.&bslash;n&quot;
comma
id|name
comma
(paren
r_int
)paren
id|count
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* EOT within data buffered earlier (possible only&n;&t;&t;&t;&t;&t;   in fixed block mode without direct i/o) */
r_if
c_cond
(paren
op_logical_neg
id|retry_eot
op_logical_and
op_logical_neg
id|cmdstatp-&gt;deferred
op_logical_and
(paren
id|scode
op_eq
id|NO_SENSE
op_logical_or
id|scode
op_eq
id|RECOVERED_ERROR
)paren
)paren
(brace
id|move_buffer_data
c_func
(paren
id|STp-&gt;buffer
comma
id|transfer
op_minus
id|undone
)paren
suffix:semicolon
id|retry_eot
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
(brace
id|STps-&gt;drv_block
op_add_assign
(paren
id|transfer
op_minus
id|undone
)paren
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
id|STps-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Retry write of %d bytes at EOM.&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;buffer-&gt;buffer_bytes
)paren
)paren
suffix:semicolon
r_goto
id|retry_write
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Either error within data buffered by driver or&n;&t;&t;&t;&t;&t;&t;   failed retry */
id|count
op_sub_assign
id|do_count
suffix:semicolon
id|blks
op_assign
id|do_count
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_EOM_ERROR
suffix:semicolon
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Too cautious? */
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* EOM for old data */
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: EOM with lost data.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|count
op_add_assign
id|do_count
suffix:semicolon
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Too cautious? */
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|STps-&gt;drv_block
op_add_assign
(paren
id|do_count
OG
l_int|0
)paren
suffix:semicolon
r_else
id|STps-&gt;drv_block
op_add_assign
id|blks
suffix:semicolon
)brace
id|STbp-&gt;buffer_bytes
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;dirty
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_logical_or
id|retry_eot
)paren
(brace
r_if
c_cond
(paren
id|count
OL
id|total
)paren
id|retval
op_assign
id|total
op_minus
id|count
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_EOD_1
)paren
id|STps-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_ne
id|ST_EOM_OK
)paren
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|retval
op_assign
id|total
op_minus
id|count
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|SRpnt
op_ne
l_int|NULL
)paren
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|release_buffering
c_func
(paren
id|STp
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Read data from the tape. Returns zero in the normal case, one if the&n;   eof status has changed, and the negative error code in case of a&n;   fatal error. Otherwise updates the buffer and the eof state.&n;&n;   Does release user buffer mapping if it is set.&n;*/
DECL|function|read_tape
r_static
r_int
id|read_tape
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
id|count
comma
r_struct
id|scsi_request
op_star
op_star
id|aSRpnt
)paren
(brace
r_int
id|transfer
comma
id|blks
comma
id|bytes
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
suffix:semicolon
r_struct
id|st_modedef
op_star
id|STm
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_struct
id|st_buffer
op_star
id|STbp
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
r_return
l_int|1
suffix:semicolon
id|STbp
op_assign
id|STp-&gt;buffer
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|blks
op_assign
id|bytes
op_assign
id|count
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|STp-&gt;try_dio
op_logical_and
id|try_rdio
)paren
op_logical_and
id|STm-&gt;do_read_ahead
)paren
(brace
id|blks
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
suffix:semicolon
id|bytes
op_assign
id|blks
op_star
id|STp-&gt;block_size
suffix:semicolon
)brace
r_else
(brace
id|bytes
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STbp-&gt;do_dio
op_logical_and
id|bytes
OG
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
)paren
id|bytes
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
suffix:semicolon
id|blks
op_assign
id|bytes
op_div
id|STp-&gt;block_size
suffix:semicolon
id|bytes
op_assign
id|blks
op_star
id|STp-&gt;block_size
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|READ_6
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|blks
op_rshift
l_int|16
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|blks
op_rshift
l_int|8
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|blks
suffix:semicolon
id|SRpnt
op_assign
op_star
id|aSRpnt
suffix:semicolon
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|bytes
comma
id|DMA_FROM_DEVICE
comma
id|STp-&gt;device-&gt;timeout
comma
id|MAX_RETRIES
comma
l_int|1
)paren
suffix:semicolon
id|release_buffering
c_func
(paren
id|STp
)paren
suffix:semicolon
op_star
id|aSRpnt
op_assign
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
id|STbp-&gt;syscall_result
suffix:semicolon
id|STbp-&gt;read_pointer
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Something to check */
r_if
c_cond
(paren
id|STbp-&gt;syscall_result
)paren
(brace
r_struct
id|st_cmdstatus
op_star
id|cmdstatp
op_assign
op_amp
id|STp-&gt;buffer-&gt;cmdstat
suffix:semicolon
id|retval
op_assign
l_int|1
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Sense: %2x %2x %2x %2x %2x %2x %2x %2x&bslash;n&quot;
comma
id|name
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|1
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|3
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|4
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|5
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|6
)braket
comma
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmdstatp-&gt;have_sense
)paren
(brace
r_if
c_cond
(paren
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|BLANK_CHECK
)paren
id|cmdstatp-&gt;flags
op_and_assign
l_int|0xcf
suffix:semicolon
multiline_comment|/* No need for EOM in this case */
r_if
c_cond
(paren
id|cmdstatp-&gt;flags
op_ne
l_int|0
)paren
(brace
multiline_comment|/* EOF, EOM, or ILI */
multiline_comment|/* Compute the residual count */
r_if
c_cond
(paren
id|cmdstatp-&gt;remainder_valid
)paren
id|transfer
op_assign
(paren
r_int
)paren
id|cmdstatp-&gt;uremainder64
suffix:semicolon
r_else
id|transfer
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
op_logical_and
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|MEDIUM_ERROR
)paren
id|transfer
op_assign
id|bytes
suffix:semicolon
r_if
c_cond
(paren
id|cmdstatp-&gt;flags
op_amp
id|SENSE_ILI
)paren
(brace
multiline_comment|/* ILI */
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|transfer
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|transfer
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Failed to read %d byte block with %d byte transfer.&bslash;n&quot;
comma
id|name
comma
id|bytes
op_minus
id|transfer
comma
id|bytes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
id|STps-&gt;drv_block
op_add_assign
l_int|1
suffix:semicolon
id|STbp-&gt;buffer_bytes
op_assign
l_int|0
suffix:semicolon
r_return
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|STbp-&gt;buffer_bytes
op_assign
id|bytes
op_minus
id|transfer
suffix:semicolon
)brace
r_else
(brace
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
op_star
id|aSRpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|transfer
op_eq
id|blks
)paren
(brace
multiline_comment|/* We did not get anything, error */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Incorrect block size.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
id|STps-&gt;drv_block
op_add_assign
id|blks
op_minus
id|transfer
op_plus
l_int|1
suffix:semicolon
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|MTBSR
comma
l_int|1
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/* We have some data, deliver it */
id|STbp-&gt;buffer_bytes
op_assign
(paren
id|blks
op_minus
id|transfer
)paren
op_star
id|STp-&gt;block_size
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: ILI but enough data received %ld %d.&bslash;n&quot;
comma
id|name
comma
id|count
comma
id|STbp-&gt;buffer_bytes
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
id|STps-&gt;drv_block
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|MTBSR
comma
l_int|1
)paren
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|cmdstatp-&gt;flags
op_amp
id|SENSE_FMK
)paren
(brace
multiline_comment|/* FM overrides EOM */
r_if
c_cond
(paren
id|STps-&gt;eof
op_ne
id|ST_FM_HIT
)paren
id|STps-&gt;eof
op_assign
id|ST_FM_HIT
suffix:semicolon
r_else
id|STps-&gt;eof
op_assign
id|ST_EOD_2
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|STbp-&gt;buffer_bytes
op_assign
l_int|0
suffix:semicolon
r_else
id|STbp-&gt;buffer_bytes
op_assign
id|bytes
op_minus
id|transfer
op_star
id|STp-&gt;block_size
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: EOF detected (%d bytes read).&bslash;n&quot;
comma
id|name
comma
id|STbp-&gt;buffer_bytes
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmdstatp-&gt;flags
op_amp
id|SENSE_EOM
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM
)paren
id|STps-&gt;eof
op_assign
id|ST_EOD_1
suffix:semicolon
r_else
id|STps-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|STbp-&gt;buffer_bytes
op_assign
id|bytes
op_minus
id|transfer
suffix:semicolon
r_else
id|STbp-&gt;buffer_bytes
op_assign
id|bytes
op_minus
id|transfer
op_star
id|STp-&gt;block_size
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: EOM detected (%d bytes read).&bslash;n&quot;
comma
id|name
comma
id|STbp-&gt;buffer_bytes
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end of EOF, EOM, ILI test */
r_else
(brace
multiline_comment|/* nonzero sense key */
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Tape error while reading.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM
op_logical_and
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|BLANK_CHECK
)paren
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Zero returned for first BLANK CHECK after EOF.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_EOD_2
suffix:semicolon
multiline_comment|/* First BLANK_CHECK after FM */
)brace
r_else
multiline_comment|/* Some other extended sense code */
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STbp-&gt;buffer_bytes
OL
l_int|0
)paren
multiline_comment|/* Caused by bogus sense data */
id|STbp-&gt;buffer_bytes
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End of extended sense test */
r_else
(brace
multiline_comment|/* Non-extended sense */
id|retval
op_assign
id|STbp-&gt;syscall_result
suffix:semicolon
)brace
)brace
multiline_comment|/* End of error handling */
r_else
multiline_comment|/* Read successful */
id|STbp-&gt;buffer_bytes
op_assign
id|bytes
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
id|STps-&gt;drv_block
op_increment
suffix:semicolon
r_else
id|STps-&gt;drv_block
op_add_assign
id|STbp-&gt;buffer_bytes
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Read command */
r_static
id|ssize_t
DECL|function|st_read
id|st_read
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ssize_t
id|total
suffix:semicolon
id|ssize_t
id|retval
op_assign
l_int|0
suffix:semicolon
id|ssize_t
id|i
comma
id|transfer
suffix:semicolon
r_int
id|special
comma
id|do_dio
op_assign
l_int|0
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|scsi_tape
op_star
id|STp
op_assign
id|filp-&gt;private_data
suffix:semicolon
r_struct
id|st_modedef
op_star
id|STm
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_struct
id|st_buffer
op_star
id|STbp
op_assign
id|STp-&gt;buffer
suffix:semicolon
id|DEB
c_func
(paren
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|retval
op_assign
id|rw_checks
c_func
(paren
id|STp
comma
id|filp
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_logical_or
id|count
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|STm-&gt;do_read_ahead
)paren
op_logical_and
id|STp-&gt;block_size
op_ne
l_int|0
op_logical_and
(paren
id|count
op_mod
id|STp-&gt;block_size
)paren
op_ne
l_int|0
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* Read must be integral number of blocks */
r_goto
id|out
suffix:semicolon
)brace
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
)paren
(brace
id|retval
op_assign
id|flush_buffer
c_func
(paren
id|STp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_READING
suffix:semicolon
)brace
id|DEB
c_func
(paren
r_if
(paren
id|debugging
op_logical_and
id|STps-&gt;eof
op_ne
id|ST_NOEOF
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: EOF/EOM flag up (%d). Bytes %d&bslash;n&quot;
comma
id|name
comma
id|STps-&gt;eof
comma
id|STbp-&gt;buffer_bytes
)paren
suffix:semicolon
)paren
multiline_comment|/* end DEB */
id|retval
op_assign
id|setup_buffering
c_func
(paren
id|STp
comma
id|buf
comma
id|count
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
id|do_dio
op_assign
id|STbp-&gt;do_dio
suffix:semicolon
r_if
c_cond
(paren
id|STbp-&gt;buffer_bytes
op_eq
l_int|0
op_logical_and
id|STps-&gt;eof
op_ge
id|ST_EOD_1
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;eof
OL
id|ST_EOD
)paren
(brace
id|STps-&gt;eof
op_add_assign
l_int|1
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* EOM or Blank Check */
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_dio
)paren
(brace
multiline_comment|/* Check the buffer writability before any tape movement. Don&squot;t alter&n;&t;&t;   buffer data. */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|i
comma
id|buf
comma
l_int|1
)paren
op_ne
l_int|0
op_logical_or
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|i
comma
l_int|1
)paren
op_ne
l_int|0
op_logical_or
id|copy_from_user
c_func
(paren
op_amp
id|i
comma
id|buf
op_plus
id|count
op_minus
l_int|1
comma
l_int|1
)paren
op_ne
l_int|0
op_logical_or
id|copy_to_user
c_func
(paren
id|buf
op_plus
id|count
op_minus
l_int|1
comma
op_amp
id|i
comma
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|STps-&gt;rw
op_assign
id|ST_READING
suffix:semicolon
multiline_comment|/* Loop until enough data in buffer or a special condition found */
r_for
c_loop
(paren
id|total
op_assign
l_int|0
comma
id|special
op_assign
l_int|0
suffix:semicolon
id|total
OL
id|count
op_logical_and
op_logical_neg
id|special
suffix:semicolon
)paren
(brace
multiline_comment|/* Get new data if the buffer is empty */
r_if
c_cond
(paren
id|STbp-&gt;buffer_bytes
op_eq
l_int|0
)paren
(brace
id|special
op_assign
id|read_tape
c_func
(paren
id|STp
comma
id|count
op_minus
id|total
comma
op_amp
id|SRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|special
OL
l_int|0
)paren
(brace
multiline_comment|/* No need to continue read */
id|retval
op_assign
id|special
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/* Move the data from driver buffer to user buffer */
r_if
c_cond
(paren
id|STbp-&gt;buffer_bytes
OG
l_int|0
)paren
(brace
id|DEB
c_func
(paren
r_if
(paren
id|debugging
op_logical_and
id|STps-&gt;eof
op_ne
id|ST_NOEOF
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: EOF up (%d). Left %d, needed %d.&bslash;n&quot;
comma
id|name
comma
id|STps-&gt;eof
comma
id|STbp-&gt;buffer_bytes
comma
(paren
r_int
)paren
(paren
id|count
op_minus
id|total
)paren
)paren
suffix:semicolon
)paren
multiline_comment|/* end DEB */
id|transfer
op_assign
id|STbp-&gt;buffer_bytes
OL
id|count
op_minus
id|total
ques
c_cond
id|STbp-&gt;buffer_bytes
suffix:colon
id|count
op_minus
id|total
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|do_dio
)paren
(brace
id|i
op_assign
id|from_buffer
c_func
(paren
id|STbp
comma
id|buf
comma
id|transfer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|buf
op_add_assign
id|transfer
suffix:semicolon
id|total
op_add_assign
id|transfer
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;block_size
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* Read only one variable length block */
)brace
multiline_comment|/* for (total = 0, special = 0;&n;                                   total &lt; count &amp;&amp; !special; ) */
multiline_comment|/* Change the eof state if no data from tape or buffer */
r_if
c_cond
(paren
id|total
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
id|STps-&gt;eof
op_assign
id|ST_FM
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_EOD_1
)paren
(brace
id|STps-&gt;eof
op_assign
id|ST_EOD_2
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_EOD_2
)paren
id|STps-&gt;eof
op_assign
id|ST_EOD
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM
)paren
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|retval
op_assign
id|total
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|SRpnt
op_ne
l_int|NULL
)paren
(brace
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_dio
)paren
(brace
id|release_buffering
c_func
(paren
id|STp
)paren
suffix:semicolon
id|STbp-&gt;buffer_bytes
op_assign
l_int|0
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
"&f;"
id|DEB
c_func
(paren
multiline_comment|/* Set the driver options */
r_static
r_void
id|st_log_options
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_struct
id|st_modedef
op_star
id|STm
comma
r_char
op_star
id|name
)paren
(brace
r_if
(paren
id|debugging
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Mode %d options: buffer writes: %d, async writes: %d, read ahead: %d&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;current_mode
comma
id|STm-&gt;do_buffer_writes
comma
id|STm-&gt;do_async_writes
comma
id|STm-&gt;do_read_ahead
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:    can bsr: %d, two FMs: %d, fast mteom: %d, auto lock: %d,&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;can_bsr
comma
id|STp-&gt;two_fm
comma
id|STp-&gt;fast_mteom
comma
id|STp-&gt;do_auto_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:    defs for wr: %d, no block limits: %d, partitions: %d, s2 log: %d&bslash;n&quot;
comma
id|name
comma
id|STm-&gt;defaults_for_writes
comma
id|STp-&gt;omit_blklims
comma
id|STp-&gt;can_partitions
comma
id|STp-&gt;scsi2_logical
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:    sysv: %d nowait: %d&bslash;n&quot;
comma
id|name
comma
id|STm-&gt;sysv
comma
id|STp-&gt;immediate
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:    debugging: %d&bslash;n&quot;
comma
id|name
comma
id|debugging
)paren
suffix:semicolon
)brace
)brace
)paren
DECL|function|st_set_options
r_static
r_int
id|st_set_options
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
id|options
)paren
(brace
r_int
id|value
suffix:semicolon
r_int
id|code
suffix:semicolon
r_struct
id|st_modedef
op_star
id|STm
suffix:semicolon
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
r_struct
id|cdev
op_star
id|cd0
comma
op_star
id|cd1
suffix:semicolon
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
)paren
(brace
id|cd0
op_assign
id|STm-&gt;cdevs
(braket
l_int|0
)braket
suffix:semicolon
id|cd1
op_assign
id|STm-&gt;cdevs
(braket
l_int|1
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|STm
comma
op_amp
(paren
id|STp-&gt;modes
(braket
l_int|0
)braket
)paren
comma
r_sizeof
(paren
r_struct
id|st_modedef
)paren
)paren
suffix:semicolon
id|STm-&gt;cdevs
(braket
l_int|0
)braket
op_assign
id|cd0
suffix:semicolon
id|STm-&gt;cdevs
(braket
l_int|1
)braket
op_assign
id|cd1
suffix:semicolon
id|modes_defined
op_assign
l_int|1
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Initialized mode %d definition from mode 0&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;current_mode
)paren
)paren
suffix:semicolon
)brace
id|code
op_assign
id|options
op_amp
id|MT_ST_OPTIONS
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_BOOLEANS
)paren
(brace
id|STm-&gt;do_buffer_writes
op_assign
(paren
id|options
op_amp
id|MT_ST_BUFFER_WRITES
)paren
op_ne
l_int|0
suffix:semicolon
id|STm-&gt;do_async_writes
op_assign
(paren
id|options
op_amp
id|MT_ST_ASYNC_WRITES
)paren
op_ne
l_int|0
suffix:semicolon
id|STm-&gt;defaults_for_writes
op_assign
(paren
id|options
op_amp
id|MT_ST_DEF_WRITES
)paren
op_ne
l_int|0
suffix:semicolon
id|STm-&gt;do_read_ahead
op_assign
(paren
id|options
op_amp
id|MT_ST_READ_AHEAD
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;two_fm
op_assign
(paren
id|options
op_amp
id|MT_ST_TWO_FM
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;fast_mteom
op_assign
(paren
id|options
op_amp
id|MT_ST_FAST_MTEOM
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;do_auto_lock
op_assign
(paren
id|options
op_amp
id|MT_ST_AUTO_LOCK
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;can_bsr
op_assign
(paren
id|options
op_amp
id|MT_ST_CAN_BSR
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;omit_blklims
op_assign
(paren
id|options
op_amp
id|MT_ST_NO_BLKLIMS
)paren
op_ne
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
op_ge
id|SCSI_2
)paren
id|STp-&gt;can_partitions
op_assign
(paren
id|options
op_amp
id|MT_ST_CAN_PARTITIONS
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;scsi2_logical
op_assign
(paren
id|options
op_amp
id|MT_ST_SCSI2LOGICAL
)paren
op_ne
l_int|0
suffix:semicolon
id|STp-&gt;immediate
op_assign
(paren
id|options
op_amp
id|MT_ST_NOWAIT
)paren
op_ne
l_int|0
suffix:semicolon
id|STm-&gt;sysv
op_assign
(paren
id|options
op_amp
id|MT_ST_SYSV
)paren
op_ne
l_int|0
suffix:semicolon
id|DEB
c_func
(paren
id|debugging
op_assign
(paren
id|options
op_amp
id|MT_ST_DEBUGGING
)paren
op_ne
l_int|0
suffix:semicolon
id|st_log_options
c_func
(paren
id|STp
comma
id|STm
comma
id|name
)paren
suffix:semicolon
)paren
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_SETBOOLEANS
op_logical_or
id|code
op_eq
id|MT_ST_CLEARBOOLEANS
)paren
(brace
id|value
op_assign
(paren
id|code
op_eq
id|MT_ST_SETBOOLEANS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_BUFFER_WRITES
)paren
op_ne
l_int|0
)paren
id|STm-&gt;do_buffer_writes
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_ASYNC_WRITES
)paren
op_ne
l_int|0
)paren
id|STm-&gt;do_async_writes
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_DEF_WRITES
)paren
op_ne
l_int|0
)paren
id|STm-&gt;defaults_for_writes
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_READ_AHEAD
)paren
op_ne
l_int|0
)paren
id|STm-&gt;do_read_ahead
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_TWO_FM
)paren
op_ne
l_int|0
)paren
id|STp-&gt;two_fm
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_FAST_MTEOM
)paren
op_ne
l_int|0
)paren
id|STp-&gt;fast_mteom
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_AUTO_LOCK
)paren
op_ne
l_int|0
)paren
id|STp-&gt;do_auto_lock
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_CAN_BSR
)paren
op_ne
l_int|0
)paren
id|STp-&gt;can_bsr
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_NO_BLKLIMS
)paren
op_ne
l_int|0
)paren
id|STp-&gt;omit_blklims
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
op_ge
id|SCSI_2
op_logical_and
(paren
id|options
op_amp
id|MT_ST_CAN_PARTITIONS
)paren
op_ne
l_int|0
)paren
id|STp-&gt;can_partitions
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_SCSI2LOGICAL
)paren
op_ne
l_int|0
)paren
id|STp-&gt;scsi2_logical
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_NOWAIT
)paren
op_ne
l_int|0
)paren
id|STp-&gt;immediate
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_amp
id|MT_ST_SYSV
)paren
op_ne
l_int|0
)paren
id|STm-&gt;sysv
op_assign
id|value
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
(paren
id|options
op_amp
id|MT_ST_DEBUGGING
)paren
op_ne
l_int|0
)paren
id|debugging
op_assign
id|value
suffix:semicolon
id|st_log_options
c_func
(paren
id|STp
comma
id|STm
comma
id|name
)paren
suffix:semicolon
)paren
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_WRITE_THRESHOLD
)paren
(brace
multiline_comment|/* Retained for compatibility */
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_BLKSIZE
)paren
(brace
id|value
op_assign
(paren
id|options
op_amp
op_complement
id|MT_ST_OPTIONS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
op_complement
id|MT_ST_OPTIONS
)paren
(brace
id|STm-&gt;default_blksize
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Default block size disabled.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|STm-&gt;default_blksize
op_assign
id|value
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Default block size set to %d bytes.&bslash;n&quot;
comma
id|name
comma
id|STm-&gt;default_blksize
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_READY
)paren
(brace
id|STp-&gt;blksize_changed
op_assign
l_int|0
suffix:semicolon
id|set_mode_densblk
c_func
(paren
id|STp
comma
id|STm
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_TIMEOUTS
)paren
(brace
id|value
op_assign
(paren
id|options
op_amp
op_complement
id|MT_ST_OPTIONS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|value
op_amp
id|MT_ST_SET_LONG_TIMEOUT
)paren
op_ne
l_int|0
)paren
(brace
id|STp-&gt;long_timeout
op_assign
(paren
id|value
op_amp
op_complement
id|MT_ST_SET_LONG_TIMEOUT
)paren
op_star
id|HZ
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Long timeout set to %d seconds.&bslash;n&quot;
comma
id|name
comma
(paren
id|value
op_amp
op_complement
id|MT_ST_SET_LONG_TIMEOUT
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|STp-&gt;device-&gt;timeout
op_assign
id|value
op_star
id|HZ
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Normal timeout set to %d seconds.&bslash;n&quot;
comma
id|name
comma
id|value
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_SET_CLN
)paren
(brace
id|value
op_assign
(paren
id|options
op_amp
op_complement
id|MT_ST_OPTIONS
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|value
op_ne
l_int|0
op_logical_and
id|value
OL
id|EXTENDED_SENSE_START
op_logical_and
id|value
op_ge
id|SCSI_SENSE_BUFFERSIZE
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|STp-&gt;cln_mode
op_assign
id|value
suffix:semicolon
id|STp-&gt;cln_sense_mask
op_assign
(paren
id|options
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|STp-&gt;cln_sense_value
op_assign
(paren
id|options
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Cleaning request mode %d, mask %02x, value %02x&bslash;n&quot;
comma
id|name
comma
id|value
comma
id|STp-&gt;cln_sense_mask
comma
id|STp-&gt;cln_sense_value
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_OPTIONS
)paren
(brace
id|code
op_assign
(paren
id|options
op_amp
op_complement
id|MT_ST_CLEAR_DEFAULT
)paren
suffix:semicolon
id|value
op_assign
(paren
id|options
op_amp
id|MT_ST_CLEAR_DEFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_DENSITY
)paren
(brace
r_if
c_cond
(paren
id|value
op_eq
id|MT_ST_CLEAR_DEFAULT
)paren
(brace
id|STm-&gt;default_density
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Density default disabled.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|STm-&gt;default_density
op_assign
id|value
op_amp
l_int|0xff
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Density default set to %x&bslash;n&quot;
comma
id|name
comma
id|STm-&gt;default_density
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_READY
)paren
(brace
id|STp-&gt;density_changed
op_assign
l_int|0
suffix:semicolon
id|set_mode_densblk
c_func
(paren
id|STp
comma
id|STm
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_DRVBUFFER
)paren
(brace
r_if
c_cond
(paren
id|value
op_eq
id|MT_ST_CLEAR_DEFAULT
)paren
(brace
id|STp-&gt;default_drvbuffer
op_assign
l_int|0xff
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Drive buffer default disabled.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|STp-&gt;default_drvbuffer
op_assign
id|value
op_amp
l_int|7
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Drive buffer default set to %x&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;default_drvbuffer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_READY
)paren
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|MTSETDRVBUFFER
comma
id|STp-&gt;default_drvbuffer
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|code
op_eq
id|MT_ST_DEF_COMPRESSION
)paren
(brace
r_if
c_cond
(paren
id|value
op_eq
id|MT_ST_CLEAR_DEFAULT
)paren
(brace
id|STm-&gt;default_compression
op_assign
id|ST_DONT_TOUCH
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Compression default disabled.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|value
op_amp
l_int|0xff00
)paren
op_ne
l_int|0
)paren
(brace
id|STp-&gt;c_algo
op_assign
(paren
id|value
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Compression algorithm set to 0x%x.&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;c_algo
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|value
op_amp
l_int|0xff
)paren
op_ne
l_int|0xff
)paren
(brace
id|STm-&gt;default_compression
op_assign
(paren
id|value
op_amp
l_int|1
ques
c_cond
id|ST_YES
suffix:colon
id|ST_NO
)paren
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Compression default set to %x&bslash;n&quot;
comma
id|name
comma
(paren
id|value
op_amp
l_int|1
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_READY
)paren
(brace
id|STp-&gt;compression_changed
op_assign
l_int|0
suffix:semicolon
id|st_compression
c_func
(paren
id|STp
comma
(paren
id|STm-&gt;default_compression
op_eq
id|ST_YES
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
r_else
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
"&f;"
DECL|macro|MODE_HEADER_LENGTH
mdefine_line|#define MODE_HEADER_LENGTH  4
multiline_comment|/* Mode header and page byte offsets */
DECL|macro|MH_OFF_DATA_LENGTH
mdefine_line|#define MH_OFF_DATA_LENGTH     0
DECL|macro|MH_OFF_MEDIUM_TYPE
mdefine_line|#define MH_OFF_MEDIUM_TYPE     1
DECL|macro|MH_OFF_DEV_SPECIFIC
mdefine_line|#define MH_OFF_DEV_SPECIFIC    2
DECL|macro|MH_OFF_BDESCS_LENGTH
mdefine_line|#define MH_OFF_BDESCS_LENGTH   3
DECL|macro|MP_OFF_PAGE_NBR
mdefine_line|#define MP_OFF_PAGE_NBR        0
DECL|macro|MP_OFF_PAGE_LENGTH
mdefine_line|#define MP_OFF_PAGE_LENGTH     1
multiline_comment|/* Mode header and page bit masks */
DECL|macro|MH_BIT_WP
mdefine_line|#define MH_BIT_WP              0x80
DECL|macro|MP_MSK_PAGE_NBR
mdefine_line|#define MP_MSK_PAGE_NBR        0x3f
multiline_comment|/* Don&squot;t return block descriptors */
DECL|macro|MODE_SENSE_OMIT_BDESCS
mdefine_line|#define MODE_SENSE_OMIT_BDESCS 0x08
DECL|macro|MODE_SELECT_PAGE_FORMAT
mdefine_line|#define MODE_SELECT_PAGE_FORMAT 0x10
multiline_comment|/* Read a mode page into the tape buffer. The block descriptors are included&n;   if incl_block_descs is true. The page control is ored to the page number&n;   parameter, if necessary. */
DECL|function|read_mode_page
r_static
r_int
id|read_mode_page
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
id|page
comma
r_int
id|omit_block_descs
)paren
(brace
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SENSE
suffix:semicolon
r_if
c_cond
(paren
id|omit_block_descs
)paren
id|cmd
(braket
l_int|1
)braket
op_assign
id|MODE_SENSE_OMIT_BDESCS
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|page
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|255
suffix:semicolon
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|DMA_FROM_DEVICE
comma
id|STp-&gt;device-&gt;timeout
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt
op_eq
l_int|NULL
)paren
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
)brace
multiline_comment|/* Send the mode page in the tape buffer to the drive. Assumes that the mode data&n;   in the buffer is correctly formatted. The long timeout is used if slow is non-zero. */
DECL|function|write_mode_page
r_static
r_int
id|write_mode_page
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
id|page
comma
r_int
id|slow
)paren
(brace
r_int
id|pgo
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SELECT
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
id|MODE_SELECT_PAGE_FORMAT
suffix:semicolon
id|pgo
op_assign
id|MODE_HEADER_LENGTH
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MH_OFF_BDESCS_LENGTH
)braket
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|pgo
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|pgo
op_plus
id|MP_OFF_PAGE_LENGTH
)braket
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* Clear reserved fields */
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MH_OFF_DATA_LENGTH
)braket
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MH_OFF_MEDIUM_TYPE
)braket
op_assign
l_int|0
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MH_OFF_DEV_SPECIFIC
)braket
op_and_assign
op_complement
id|MH_BIT_WP
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|pgo
op_plus
id|MP_OFF_PAGE_NBR
)braket
op_and_assign
id|MP_MSK_PAGE_NBR
suffix:semicolon
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
id|SRpnt
comma
id|STp
comma
id|cmd
comma
id|cmd
(braket
l_int|4
)braket
comma
id|DMA_TO_DEVICE
comma
(paren
id|slow
ques
c_cond
id|STp-&gt;long_timeout
suffix:colon
id|STp-&gt;device-&gt;timeout
)paren
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt
op_eq
l_int|NULL
)paren
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
)brace
DECL|macro|COMPRESSION_PAGE
mdefine_line|#define COMPRESSION_PAGE        0x0f
DECL|macro|COMPRESSION_PAGE_LENGTH
mdefine_line|#define COMPRESSION_PAGE_LENGTH 16
DECL|macro|CP_OFF_DCE_DCC
mdefine_line|#define CP_OFF_DCE_DCC          2
DECL|macro|CP_OFF_C_ALGO
mdefine_line|#define CP_OFF_C_ALGO           7
DECL|macro|DCE_MASK
mdefine_line|#define DCE_MASK  0x80
DECL|macro|DCC_MASK
mdefine_line|#define DCC_MASK  0x40
DECL|macro|RED_MASK
mdefine_line|#define RED_MASK  0x60
multiline_comment|/* Control the compression with mode page 15. Algorithm not changed if zero.&n;&n;   The block descriptors are read and written because Sony SDT-7000 does not&n;   work without this (suggestion from Michael Schaefer &lt;Michael.Schaefer@dlr.de&gt;).&n;   Including block descriptors should not cause any harm to other drives. */
DECL|function|st_compression
r_static
r_int
id|st_compression
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
id|state
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
id|mpoffs
suffix:semicolon
multiline_comment|/* Offset to mode page start */
r_int
r_char
op_star
id|b_data
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
suffix:semicolon
id|DEB
c_func
(paren
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* Read the current page contents */
id|retval
op_assign
id|read_mode_page
c_func
(paren
id|STp
comma
id|COMPRESSION_PAGE
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Compression mode page not supported.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|mpoffs
op_assign
id|MODE_HEADER_LENGTH
op_plus
id|b_data
(braket
id|MH_OFF_BDESCS_LENGTH
)braket
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Compression state is %d.&bslash;n&quot;
comma
id|name
comma
(paren
id|b_data
(braket
id|mpoffs
op_plus
id|CP_OFF_DCE_DCC
)braket
op_amp
id|DCE_MASK
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Check if compression can be changed */
r_if
c_cond
(paren
(paren
id|b_data
(braket
id|mpoffs
op_plus
id|CP_OFF_DCE_DCC
)braket
op_amp
id|DCC_MASK
)paren
op_eq
l_int|0
)paren
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Compression not supported.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/* Do the change */
r_if
c_cond
(paren
id|state
)paren
(brace
id|b_data
(braket
id|mpoffs
op_plus
id|CP_OFF_DCE_DCC
)braket
op_or_assign
id|DCE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;c_algo
op_ne
l_int|0
)paren
id|b_data
(braket
id|mpoffs
op_plus
id|CP_OFF_C_ALGO
)braket
op_assign
id|STp-&gt;c_algo
suffix:semicolon
)brace
r_else
(brace
id|b_data
(braket
id|mpoffs
op_plus
id|CP_OFF_DCE_DCC
)braket
op_and_assign
op_complement
id|DCE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;c_algo
op_ne
l_int|0
)paren
id|b_data
(braket
id|mpoffs
op_plus
id|CP_OFF_C_ALGO
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no compression */
)brace
id|retval
op_assign
id|write_mode_page
c_func
(paren
id|STp
comma
id|COMPRESSION_PAGE
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Compression change failed.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Compression state changed to %d.&bslash;n&quot;
comma
id|name
comma
id|state
)paren
)paren
suffix:semicolon
id|STp-&gt;compression_changed
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Process the load and unload commands (does unload if the load code is zero) */
DECL|function|do_load_unload
r_static
r_int
id|do_load_unload
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|load_code
)paren
(brace
r_int
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
comma
id|timeout
suffix:semicolon
id|DEB
c_func
(paren
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
)paren
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
op_logical_and
op_logical_neg
id|load_code
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_NO_TAPE
)paren
r_return
(paren
op_minus
id|ENOMEDIUM
)paren
suffix:semicolon
r_else
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|START_STOP
suffix:semicolon
r_if
c_cond
(paren
id|load_code
)paren
id|cmd
(braket
l_int|4
)braket
op_or_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * If arg &gt;= 1 &amp;&amp; arg &lt;= 6 Enhanced load/unload in HP C1553A&n;&t; */
r_if
c_cond
(paren
id|load_code
op_ge
l_int|1
op_plus
id|MT_ST_HPLOADER_OFFSET
op_logical_and
id|load_code
op_le
l_int|6
op_plus
id|MT_ST_HPLOADER_OFFSET
)paren
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Enhanced %sload slot %2d.&bslash;n&quot;
comma
id|name
comma
(paren
id|cmd
(braket
l_int|4
)braket
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;un&quot;
comma
id|load_code
op_minus
id|MT_ST_HPLOADER_OFFSET
)paren
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|load_code
op_minus
id|MT_ST_HPLOADER_OFFSET
suffix:semicolon
multiline_comment|/* MediaID field of C1553A */
)brace
r_if
c_cond
(paren
id|STp-&gt;immediate
)paren
(brace
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|STp-&gt;device-&gt;timeout
suffix:semicolon
)brace
r_else
id|timeout
op_assign
id|STp-&gt;long_timeout
suffix:semicolon
id|DEBC
c_func
(paren
r_if
(paren
op_logical_neg
id|load_code
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Unloading tape.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Loading tape.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
)paren
suffix:semicolon
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|cmd
comma
l_int|0
comma
id|DMA_NONE
comma
id|timeout
comma
id|MAX_RETRIES
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
id|retval
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
multiline_comment|/* SCSI command successful */
r_if
c_cond
(paren
op_logical_neg
id|load_code
)paren
(brace
id|STp-&gt;rew_at_close
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;ready
op_assign
id|ST_NO_TAPE
suffix:semicolon
)brace
r_else
(brace
id|STp-&gt;rew_at_close
op_assign
id|STp-&gt;autorew_dev
suffix:semicolon
id|retval
op_assign
id|check_tape
c_func
(paren
id|STp
comma
id|filp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OG
l_int|0
)paren
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
id|STps-&gt;drv_file
op_assign
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
"&f;"
macro_line|#if DEBUG
DECL|macro|ST_DEB_FORWARD
mdefine_line|#define ST_DEB_FORWARD  0
DECL|macro|ST_DEB_BACKWARD
mdefine_line|#define ST_DEB_BACKWARD 1
DECL|function|deb_space_print
r_static
r_void
id|deb_space_print
c_func
(paren
r_char
op_star
id|name
comma
r_int
id|direction
comma
r_char
op_star
id|units
comma
r_int
r_char
op_star
id|cmd
)paren
(brace
id|s32
id|sc
suffix:semicolon
id|sc
op_assign
id|cmd
(braket
l_int|2
)braket
op_amp
l_int|0x80
ques
c_cond
l_int|0xff000000
suffix:colon
l_int|0
suffix:semicolon
id|sc
op_or_assign
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|direction
)paren
id|sc
op_assign
op_minus
id|sc
suffix:semicolon
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Spacing tape %s over %d %s.&bslash;n&quot;
comma
id|name
comma
id|direction
ques
c_cond
l_string|&quot;backward&quot;
suffix:colon
l_string|&quot;forward&quot;
comma
id|sc
comma
id|units
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Internal ioctl function */
DECL|function|st_int_ioctl
r_static
r_int
id|st_int_ioctl
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
id|ltmp
suffix:semicolon
r_int
id|ioctl_result
suffix:semicolon
r_int
id|chg_eof
op_assign
l_int|1
suffix:semicolon
r_int
r_char
id|cmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_int
id|fileno
comma
id|blkno
comma
id|at_sm
comma
id|undone
suffix:semicolon
r_int
id|datalen
op_assign
l_int|0
comma
id|direction
op_assign
id|DMA_NONE
suffix:semicolon
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
id|WARN_ON
c_func
(paren
id|STp-&gt;buffer-&gt;do_dio
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
(brace
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_NO_TAPE
)paren
r_return
(paren
op_minus
id|ENOMEDIUM
)paren
suffix:semicolon
r_else
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|timeout
op_assign
id|STp-&gt;long_timeout
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
id|fileno
op_assign
id|STps-&gt;drv_file
suffix:semicolon
id|blkno
op_assign
id|STps-&gt;drv_block
suffix:semicolon
id|at_sm
op_assign
id|STps-&gt;at_sm
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd_in
)paren
(brace
r_case
id|MTFSFM
suffix:colon
id|chg_eof
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Changed from the FSF after this */
r_case
id|MTFSF
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Space FileMarks */
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
id|DEBC
c_func
(paren
id|deb_space_print
c_func
(paren
id|name
comma
id|ST_DEB_FORWARD
comma
l_string|&quot;filemarks&quot;
comma
id|cmd
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_add_assign
id|arg
suffix:semicolon
id|blkno
op_assign
l_int|0
suffix:semicolon
id|at_sm
op_and_assign
(paren
id|arg
op_eq
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSFM
suffix:colon
id|chg_eof
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Changed from the FSF after this */
r_case
id|MTBSF
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Space FileMarks */
id|ltmp
op_assign
(paren
op_minus
id|arg
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|ltmp
suffix:semicolon
id|DEBC
c_func
(paren
id|deb_space_print
c_func
(paren
id|name
comma
id|ST_DEB_BACKWARD
comma
l_string|&quot;filemarks&quot;
comma
id|cmd
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_sub_assign
id|arg
suffix:semicolon
id|blkno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We can&squot;t know the block number */
id|at_sm
op_and_assign
(paren
id|arg
op_eq
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSR
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Space Blocks */
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
id|DEBC
c_func
(paren
id|deb_space_print
c_func
(paren
id|name
comma
id|ST_DEB_FORWARD
comma
l_string|&quot;blocks&quot;
comma
id|cmd
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|blkno
op_ge
l_int|0
)paren
id|blkno
op_add_assign
id|arg
suffix:semicolon
id|at_sm
op_and_assign
(paren
id|arg
op_eq
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSR
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Space Blocks */
id|ltmp
op_assign
(paren
op_minus
id|arg
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|ltmp
suffix:semicolon
id|DEBC
c_func
(paren
id|deb_space_print
c_func
(paren
id|name
comma
id|ST_DEB_BACKWARD
comma
l_string|&quot;blocks&quot;
comma
id|cmd
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|blkno
op_ge
l_int|0
)paren
id|blkno
op_sub_assign
id|arg
suffix:semicolon
id|at_sm
op_and_assign
(paren
id|arg
op_eq
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSS
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Space Setmarks */
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
id|DEBC
c_func
(paren
id|deb_space_print
c_func
(paren
id|name
comma
id|ST_DEB_FORWARD
comma
l_string|&quot;setmarks&quot;
comma
id|cmd
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|arg
op_ne
l_int|0
)paren
(brace
id|blkno
op_assign
id|fileno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|at_sm
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MTBSS
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Space Setmarks */
id|ltmp
op_assign
(paren
op_minus
id|arg
)paren
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|ltmp
suffix:semicolon
id|DEBC
c_func
(paren
id|deb_space_print
c_func
(paren
id|name
comma
id|ST_DEB_BACKWARD
comma
l_string|&quot;setmarks&quot;
comma
id|cmd
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|arg
op_ne
l_int|0
)paren
(brace
id|blkno
op_assign
id|fileno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|at_sm
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MTWEOF
suffix:colon
r_case
id|MTWSM
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;write_prot
)paren
r_return
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|WRITE_FILEMARKS
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTWSM
)paren
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|2
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_rshift
l_int|16
)paren
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
id|timeout
op_assign
id|STp-&gt;device-&gt;timeout
suffix:semicolon
id|DEBC
c_func
(paren
r_if
(paren
id|cmd_in
op_eq
id|MTWEOF
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Writing %d filemarks.&bslash;n&quot;
comma
id|name
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Writing %d setmarks.&bslash;n&quot;
comma
id|name
comma
id|cmd
(braket
l_int|2
)braket
op_star
l_int|65536
op_plus
id|cmd
(braket
l_int|3
)braket
op_star
l_int|256
op_plus
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_add_assign
id|arg
suffix:semicolon
id|blkno
op_assign
l_int|0
suffix:semicolon
id|at_sm
op_assign
(paren
id|cmd_in
op_eq
id|MTWSM
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTREW
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|REZERO_UNIT
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;immediate
)paren
(brace
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|STp-&gt;device-&gt;timeout
suffix:semicolon
)brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Rewinding tape.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
id|fileno
op_assign
id|blkno
op_assign
id|at_sm
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTNOP
suffix:colon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: No op on tape.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Should do something ? */
r_break
suffix:semicolon
r_case
id|MTRETEN
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|START_STOP
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;immediate
)paren
(brace
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|STp-&gt;device-&gt;timeout
suffix:semicolon
)brace
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|3
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Retensioning tape.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
id|fileno
op_assign
id|blkno
op_assign
id|at_sm
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTEOM
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;fast_mteom
)paren
(brace
multiline_comment|/* space to the end of tape */
id|ioctl_result
op_assign
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|MTFSF
comma
l_int|0x7fffff
)paren
suffix:semicolon
id|fileno
op_assign
id|STps-&gt;drv_file
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;eof
op_ge
id|ST_EOD_1
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* The next lines would hide the number of spaced FileMarks&n;&t;&t;&t;   That&squot;s why I inserted the previous lines. I had no luck&n;&t;&t;&t;   with detecting EOM with FSF, so we go now to EOM.&n;&t;&t;&t;   Joerg Weule */
)brace
r_else
id|fileno
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SPACE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Spacing to end of recorded medium.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
id|blkno
op_assign
op_minus
l_int|1
suffix:semicolon
id|at_sm
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTERASE
suffix:colon
r_if
c_cond
(paren
id|STp-&gt;write_prot
)paren
r_return
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|ERASE
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
(paren
id|arg
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Long erase with non-zero argument */
r_if
c_cond
(paren
id|STp-&gt;immediate
)paren
(brace
id|cmd
(braket
l_int|1
)braket
op_or_assign
l_int|2
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|STp-&gt;device-&gt;timeout
suffix:semicolon
)brace
r_else
id|timeout
op_assign
id|STp-&gt;long_timeout
op_star
l_int|8
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Erasing tape.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
id|fileno
op_assign
id|blkno
op_assign
id|at_sm
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSETBLK
suffix:colon
multiline_comment|/* Set block length */
r_case
id|MTSETDENSITY
suffix:colon
multiline_comment|/* Set tape density */
r_case
id|MTSETDRVBUFFER
suffix:colon
multiline_comment|/* Set drive buffering */
r_case
id|SET_DENS_AND_BLK
suffix:colon
multiline_comment|/* Set density and block size */
id|chg_eof
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;dirty
op_logical_or
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_ne
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* Not allowed if data in buffer */
r_if
c_cond
(paren
(paren
id|cmd_in
op_eq
id|MTSETBLK
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
op_logical_and
(paren
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
)paren
op_ne
l_int|0
op_logical_and
id|STp-&gt;max_block
OG
l_int|0
op_logical_and
(paren
(paren
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
)paren
template_param
id|STp-&gt;max_block
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Illegal block size.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|cmd
(braket
l_int|0
)braket
op_assign
id|MODE_SELECT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;use_pf
op_amp
id|USE_PF
)paren
)paren
id|cmd
(braket
l_int|1
)braket
op_assign
id|MODE_SELECT_PAGE_FORMAT
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|datalen
op_assign
l_int|12
suffix:semicolon
id|direction
op_assign
id|DMA_TO_DEVICE
suffix:semicolon
id|memset
c_func
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
comma
l_int|0
comma
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETDRVBUFFER
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_assign
(paren
id|arg
op_amp
l_int|7
)paren
op_lshift
l_int|4
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_assign
id|STp-&gt;drv_buffer
op_lshift
l_int|4
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|3
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* block descriptor length */
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETDENSITY
)paren
(brace
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
op_assign
id|arg
suffix:semicolon
id|STp-&gt;density_changed
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* At least we tried ;-) */
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
op_assign
id|arg
op_rshift
l_int|24
suffix:semicolon
r_else
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
op_assign
id|STp-&gt;density
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
(brace
id|ltmp
op_assign
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
)paren
id|STp-&gt;blksize_changed
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* At least we tried ;-) */
)brace
r_else
id|ltmp
op_assign
id|STp-&gt;block_size
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|9
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|16
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|10
)braket
op_assign
(paren
id|ltmp
op_rshift
l_int|8
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|11
)braket
op_assign
id|ltmp
suffix:semicolon
id|timeout
op_assign
id|STp-&gt;device-&gt;timeout
suffix:semicolon
id|DEBC
c_func
(paren
r_if
(paren
id|cmd_in
op_eq
id|MTSETBLK
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Setting block size to %d bytes.&bslash;n&quot;
comma
id|name
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|9
)braket
op_star
l_int|65536
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|10
)braket
op_star
l_int|256
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|11
)braket
)paren
suffix:semicolon
r_if
(paren
id|cmd_in
op_eq
id|MTSETDENSITY
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Setting density code to %x.&bslash;n&quot;
comma
id|name
comma
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_if
(paren
id|cmd_in
op_eq
id|MTSETDRVBUFFER
)paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Setting drive buffer code to %d.&bslash;n&quot;
comma
id|name
comma
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|7
)paren
suffix:semicolon
)paren
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
op_minus
id|ENOSYS
)paren
suffix:semicolon
)brace
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|cmd
comma
id|datalen
comma
id|direction
comma
id|timeout
comma
id|MAX_RETRIES
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
id|ioctl_result
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioctl_result
)paren
(brace
multiline_comment|/* SCSI command successful */
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
id|STps-&gt;drv_block
op_assign
id|blkno
suffix:semicolon
id|STps-&gt;drv_file
op_assign
id|fileno
suffix:semicolon
id|STps-&gt;at_sm
op_assign
id|at_sm
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTBSFM
)paren
id|ioctl_result
op_assign
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|MTFSF
comma
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTFSFM
)paren
id|ioctl_result
op_assign
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|MTBSF
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
(brace
r_int
id|old_block_size
op_assign
id|STp-&gt;block_size
suffix:semicolon
id|STp-&gt;block_size
op_assign
id|arg
op_amp
id|MT_ST_BLKSIZE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|old_block_size
op_eq
l_int|0
)paren
id|normalize_buffer
c_func
(paren
id|STp-&gt;buffer
)paren
suffix:semicolon
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_blocks
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_size
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|read_pointer
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
id|STp-&gt;density
op_assign
id|arg
op_rshift
id|MT_ST_DENSITY_SHIFT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETDRVBUFFER
)paren
id|STp-&gt;drv_buffer
op_assign
(paren
id|arg
op_amp
l_int|7
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETDENSITY
)paren
id|STp-&gt;density
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTEOM
)paren
id|STps-&gt;eof
op_assign
id|ST_EOD
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTFSF
)paren
id|STps-&gt;eof
op_assign
id|ST_FM
suffix:semicolon
r_else
r_if
c_cond
(paren
id|chg_eof
)paren
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTWEOF
)paren
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* SCSI command was not completely successful. Don&squot;t return&n;                    from this block without releasing the SCSI command block! */
r_struct
id|st_cmdstatus
op_star
id|cmdstatp
op_assign
op_amp
id|STp-&gt;buffer-&gt;cmdstat
suffix:semicolon
r_if
c_cond
(paren
id|cmdstatp-&gt;flags
op_amp
id|SENSE_EOM
)paren
(brace
r_if
c_cond
(paren
id|cmd_in
op_ne
id|MTBSF
op_logical_and
id|cmd_in
op_ne
id|MTBSFM
op_logical_and
id|cmd_in
op_ne
id|MTBSR
op_logical_and
id|cmd_in
op_ne
id|MTBSS
)paren
id|STps-&gt;eof
op_assign
id|ST_EOM_OK
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmdstatp-&gt;remainder_valid
)paren
id|undone
op_assign
(paren
r_int
)paren
id|cmdstatp-&gt;uremainder64
suffix:semicolon
r_else
id|undone
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTWEOF
op_logical_and
id|cmdstatp-&gt;have_sense
op_logical_and
(paren
id|cmdstatp-&gt;flags
op_amp
id|SENSE_EOM
)paren
op_logical_and
(paren
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|NO_SENSE
op_logical_or
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|RECOVERED_ERROR
)paren
op_logical_and
id|undone
op_eq
l_int|0
)paren
(brace
id|ioctl_result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* EOF written succesfully at EOM */
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|fileno
op_increment
suffix:semicolon
id|STps-&gt;drv_file
op_assign
id|fileno
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|cmd_in
op_eq
id|MTFSF
)paren
op_logical_or
(paren
id|cmd_in
op_eq
id|MTFSFM
)paren
)paren
(brace
r_if
c_cond
(paren
id|fileno
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_assign
id|fileno
op_minus
id|undone
suffix:semicolon
r_else
id|STps-&gt;drv_file
op_assign
id|fileno
suffix:semicolon
id|STps-&gt;drv_block
op_assign
op_minus
l_int|1
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|cmd_in
op_eq
id|MTBSF
)paren
op_logical_or
(paren
id|cmd_in
op_eq
id|MTBSFM
)paren
)paren
(brace
r_if
c_cond
(paren
id|arg
OG
l_int|0
op_logical_and
id|undone
OL
l_int|0
)paren
multiline_comment|/* Some drives get this wrong */
id|undone
op_assign
(paren
op_minus
id|undone
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_assign
id|fileno
op_plus
id|undone
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTFSR
)paren
(brace
r_if
c_cond
(paren
id|cmdstatp-&gt;flags
op_amp
id|SENSE_FMK
)paren
(brace
multiline_comment|/* Hit filemark */
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_increment
suffix:semicolon
id|STps-&gt;drv_block
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_FM
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|blkno
op_ge
id|undone
)paren
id|STps-&gt;drv_block
op_assign
id|blkno
op_minus
id|undone
suffix:semicolon
r_else
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTBSR
)paren
(brace
r_if
c_cond
(paren
id|cmdstatp-&gt;flags
op_amp
id|SENSE_FMK
)paren
(brace
multiline_comment|/* Hit filemark */
id|STps-&gt;drv_file
op_decrement
suffix:semicolon
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|arg
OG
l_int|0
op_logical_and
id|undone
OL
l_int|0
)paren
multiline_comment|/* Some drives get this wrong */
id|undone
op_assign
(paren
op_minus
id|undone
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_block
op_ge
l_int|0
)paren
id|STps-&gt;drv_block
op_assign
id|blkno
op_plus
id|undone
suffix:semicolon
)brace
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTEOM
)paren
(brace
id|STps-&gt;drv_file
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_EOD
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd_in
op_eq
id|MTSETBLK
op_logical_or
id|cmd_in
op_eq
id|MTSETDENSITY
op_logical_or
id|cmd_in
op_eq
id|MTSETDRVBUFFER
op_logical_or
id|cmd_in
op_eq
id|SET_DENS_AND_BLK
)paren
(brace
r_if
c_cond
(paren
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|ILLEGAL_REQUEST
op_logical_and
op_logical_neg
(paren
id|STp-&gt;use_pf
op_amp
id|PF_TESTED
)paren
)paren
(brace
multiline_comment|/* Try the other possible state of Page Format if not&n;&t;&t;&t;&t;   already tried */
id|STp-&gt;use_pf
op_assign
op_logical_neg
id|STp-&gt;use_pf
op_or
id|PF_TESTED
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_return
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|cmd_in
comma
id|arg
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|chg_eof
)paren
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
r_if
c_cond
(paren
id|cmdstatp-&gt;sense_hdr.sense_key
op_eq
id|BLANK_CHECK
)paren
id|STps-&gt;eof
op_assign
id|ST_EOD
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|ioctl_result
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Get the tape position. If bt == 2, arg points into a kernel space mt_loc&n;   structure. */
DECL|function|get_location
r_static
r_int
id|get_location
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
r_int
op_star
id|block
comma
r_int
op_star
id|partition
comma
r_int
id|logical
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
r_char
id|scmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
suffix:semicolon
id|DEB
c_func
(paren
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|memset
c_func
(paren
id|scmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
OL
id|SCSI_2
)paren
(brace
id|scmd
(braket
l_int|0
)braket
op_assign
id|QFA_REQUEST_BLOCK
suffix:semicolon
id|scmd
(braket
l_int|4
)braket
op_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
id|scmd
(braket
l_int|0
)braket
op_assign
id|READ_POSITION
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|logical
op_logical_and
op_logical_neg
id|STp-&gt;scsi2_logical
)paren
id|scmd
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
)brace
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|scmd
comma
l_int|20
comma
id|DMA_FROM_DEVICE
comma
id|STp-&gt;device-&gt;timeout
comma
id|MAX_READY_RETRIES
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
op_logical_or
(paren
id|STp-&gt;device-&gt;scsi_level
op_ge
id|SCSI_2
op_logical_and
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
op_amp
l_int|4
)paren
op_ne
l_int|0
)paren
)paren
(brace
op_star
id|block
op_assign
op_star
id|partition
op_assign
l_int|0
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Can&squot;t read tape position.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
OL
id|SCSI_2
)paren
(brace
op_star
id|block
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|2
)braket
suffix:semicolon
op_star
id|partition
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|block
op_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|4
)braket
op_lshift
l_int|24
)paren
op_plus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|5
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|6
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|7
)braket
suffix:semicolon
op_star
id|partition
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_logical_and
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
l_int|1
)braket
op_eq
l_int|0
)paren
multiline_comment|/* BOP of partition 0 */
id|STp-&gt;ps
(braket
l_int|0
)braket
dot
id|drv_block
op_assign
id|STp-&gt;ps
(braket
l_int|0
)braket
dot
id|drv_file
op_assign
l_int|0
suffix:semicolon
)brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Got tape pos. blk %d part %d.&bslash;n&quot;
comma
id|name
comma
op_star
id|block
comma
op_star
id|partition
)paren
)paren
suffix:semicolon
)brace
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Set the tape block and partition. Negative partition means that only the&n;   block should be set in vendor specific way. */
DECL|function|set_location
r_static
r_int
id|set_location
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
r_int
id|block
comma
r_int
id|partition
comma
r_int
id|logical
)paren
(brace
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_int
id|result
comma
id|p
suffix:semicolon
r_int
r_int
id|blk
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_int
r_char
id|scmd
(braket
id|MAX_COMMAND_SIZE
)braket
suffix:semicolon
r_struct
id|scsi_request
op_star
id|SRpnt
suffix:semicolon
id|DEB
c_func
(paren
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|timeout
op_assign
id|STp-&gt;long_timeout
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Setting block to %d and partition to %d.&bslash;n&quot;
comma
id|name
comma
id|block
comma
id|partition
)paren
)paren
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|partition
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)paren
multiline_comment|/* Update the location at the partition we are leaving */
r_if
c_cond
(paren
(paren
op_logical_neg
id|STp-&gt;can_partitions
op_logical_and
id|partition
op_ne
l_int|0
)paren
op_logical_or
id|partition
op_ge
id|ST_NBR_PARTITIONS
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|partition
op_ne
id|STp-&gt;partition
)paren
(brace
r_if
c_cond
(paren
id|get_location
c_func
(paren
id|STp
comma
op_amp
id|blk
comma
op_amp
id|p
comma
l_int|1
)paren
)paren
id|STps-&gt;last_block_valid
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|STps-&gt;last_block_valid
op_assign
l_int|1
suffix:semicolon
id|STps-&gt;last_block_visited
op_assign
id|blk
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Visited block %d for partition %d saved.&bslash;n&quot;
comma
id|name
comma
id|blk
comma
id|STp-&gt;partition
)paren
)paren
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
id|scmd
comma
l_int|0
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
OL
id|SCSI_2
)paren
(brace
id|scmd
(braket
l_int|0
)braket
op_assign
id|QFA_SEEK_BLOCK
suffix:semicolon
id|scmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
suffix:semicolon
id|scmd
(braket
l_int|3
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
suffix:semicolon
id|scmd
(braket
l_int|4
)braket
op_assign
id|block
suffix:semicolon
id|scmd
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|scmd
(braket
l_int|0
)braket
op_assign
id|SEEK_10
suffix:semicolon
id|scmd
(braket
l_int|3
)braket
op_assign
(paren
id|block
op_rshift
l_int|24
)paren
suffix:semicolon
id|scmd
(braket
l_int|4
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
suffix:semicolon
id|scmd
(braket
l_int|5
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
suffix:semicolon
id|scmd
(braket
l_int|6
)braket
op_assign
id|block
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|logical
op_logical_and
op_logical_neg
id|STp-&gt;scsi2_logical
)paren
id|scmd
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;partition
op_ne
id|partition
)paren
(brace
id|scmd
(braket
l_int|1
)braket
op_or_assign
l_int|2
suffix:semicolon
id|scmd
(braket
l_int|8
)braket
op_assign
id|partition
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Trying to change partition from %d to %d&bslash;n&quot;
comma
id|name
comma
id|STp-&gt;partition
comma
id|partition
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|STp-&gt;immediate
)paren
(brace
id|scmd
(braket
l_int|1
)braket
op_or_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t wait for completion */
id|timeout
op_assign
id|STp-&gt;device-&gt;timeout
suffix:semicolon
)brace
id|SRpnt
op_assign
id|st_do_scsi
c_func
(paren
l_int|NULL
comma
id|STp
comma
id|scmd
comma
l_int|0
comma
id|DMA_NONE
comma
id|timeout
comma
id|MAX_READY_RETRIES
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SRpnt
)paren
r_return
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
suffix:semicolon
id|STps-&gt;drv_block
op_assign
id|STps-&gt;drv_file
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
r_if
c_cond
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|syscall_result
op_ne
l_int|0
)paren
(brace
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
(paren
id|STp-&gt;device
)paren
op_member_access_from_pointer
id|scsi_level
op_ge
id|SCSI_2
op_logical_and
(paren
id|p
op_assign
id|find_partition
c_func
(paren
id|STp
)paren
)paren
op_ge
l_int|0
)paren
id|STp-&gt;partition
op_assign
id|p
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|STp-&gt;can_partitions
)paren
(brace
id|STp-&gt;partition
op_assign
id|partition
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STps-&gt;last_block_valid
op_logical_or
id|STps-&gt;last_block_visited
op_ne
id|block
)paren
(brace
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
)brace
)brace
r_else
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|block
op_eq
l_int|0
)paren
id|STps-&gt;drv_block
op_assign
id|STps-&gt;drv_file
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
)brace
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Find the current partition number for the drive status. Called from open and&n;   returns either partition number of negative error code. */
DECL|function|find_partition
r_static
r_int
id|find_partition
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
)paren
(brace
r_int
id|i
comma
id|partition
suffix:semicolon
r_int
r_int
id|block
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|get_location
c_func
(paren
id|STp
comma
op_amp
id|block
comma
op_amp
id|partition
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
id|partition
op_ge
id|ST_NBR_PARTITIONS
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_return
id|partition
suffix:semicolon
)brace
multiline_comment|/* Change the partition if necessary */
DECL|function|switch_partition
r_static
r_int
id|switch_partition
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
)paren
(brace
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;partition
op_eq
id|STp-&gt;new_partition
)paren
r_return
l_int|0
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;new_partition
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STps-&gt;last_block_valid
)paren
id|STps-&gt;last_block_visited
op_assign
l_int|0
suffix:semicolon
r_return
id|set_location
c_func
(paren
id|STp
comma
id|STps-&gt;last_block_visited
comma
id|STp-&gt;new_partition
comma
l_int|1
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/* Functions for reading and writing the medium partition mode page. */
DECL|macro|PART_PAGE
mdefine_line|#define PART_PAGE   0x11
DECL|macro|PART_PAGE_FIXED_LENGTH
mdefine_line|#define PART_PAGE_FIXED_LENGTH 8
DECL|macro|PP_OFF_MAX_ADD_PARTS
mdefine_line|#define PP_OFF_MAX_ADD_PARTS   2
DECL|macro|PP_OFF_NBR_ADD_PARTS
mdefine_line|#define PP_OFF_NBR_ADD_PARTS   3
DECL|macro|PP_OFF_FLAGS
mdefine_line|#define PP_OFF_FLAGS           4
DECL|macro|PP_OFF_PART_UNITS
mdefine_line|#define PP_OFF_PART_UNITS      6
DECL|macro|PP_OFF_RESERVED
mdefine_line|#define PP_OFF_RESERVED        7
DECL|macro|PP_BIT_IDP
mdefine_line|#define PP_BIT_IDP             0x20
DECL|macro|PP_MSK_PSUM_MB
mdefine_line|#define PP_MSK_PSUM_MB         0x10
multiline_comment|/* Get the number of partitions on the tape. As a side effect reads the&n;   mode page into the tape buffer. */
DECL|function|nbr_partitions
r_static
r_int
id|nbr_partitions
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
)paren
(brace
r_int
id|result
suffix:semicolon
id|DEB
c_func
(paren
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|STp-&gt;ready
op_ne
id|ST_READY
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|result
op_assign
id|read_mode_page
c_func
(paren
id|STp
comma
id|PART_PAGE
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Can&squot;t read medium partition page.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
(braket
id|MODE_HEADER_LENGTH
op_plus
id|PP_OFF_NBR_ADD_PARTS
)braket
op_plus
l_int|1
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Number of partitions %d.&bslash;n&quot;
comma
id|name
comma
id|result
)paren
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Partition the tape into two partitions if size &gt; 0 or one partition if&n;   size == 0.&n;&n;   The block descriptors are read and written because Sony SDT-7000 does not&n;   work without this (suggestion from Michael Schaefer &lt;Michael.Schaefer@dlr.de&gt;).&n;&n;   My HP C1533A drive returns only one partition size field. This is used to&n;   set the size of partition 1. There is no size field for the default partition.&n;   Michael Schaefer&squot;s Sony SDT-7000 returns two descriptors and the second is&n;   used to set the size of partition 1 (this is what the SCSI-3 standard specifies).&n;   The following algorithm is used to accommodate both drives: if the number of&n;   partition size fields is greater than the maximum number of additional partitions&n;   in the mode page, the second field is used. Otherwise the first field is used.&n;&n;   For Seagate DDS drives the page length must be 8 when no partitions is defined&n;   and 10 when 1 partition is defined (information from Eric Lee Green). This is&n;   is acceptable also to some other old drives and enforced if the first partition&n;   size field is used for the first additional partition size.&n; */
DECL|function|partition_tape
r_static
r_int
id|partition_tape
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
id|size
)paren
(brace
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|pgo
comma
id|psd_cnt
comma
id|psdo
suffix:semicolon
r_int
r_char
op_star
id|bp
suffix:semicolon
id|result
op_assign
id|read_mode_page
c_func
(paren
id|STp
comma
id|PART_PAGE
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Can&squot;t read partition mode page.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* The mode page is in the buffer. Let&squot;s modify it and write it. */
id|bp
op_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|b_data
suffix:semicolon
id|pgo
op_assign
id|MODE_HEADER_LENGTH
op_plus
id|bp
(braket
id|MH_OFF_BDESCS_LENGTH
)braket
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Partition page length is %d bytes.&bslash;n&quot;
comma
id|name
comma
id|bp
(braket
id|pgo
op_plus
id|MP_OFF_PAGE_LENGTH
)braket
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|psd_cnt
op_assign
(paren
id|bp
(braket
id|pgo
op_plus
id|MP_OFF_PAGE_LENGTH
)braket
op_plus
l_int|2
op_minus
id|PART_PAGE_FIXED_LENGTH
)paren
op_div
l_int|2
suffix:semicolon
id|psdo
op_assign
id|pgo
op_plus
id|PART_PAGE_FIXED_LENGTH
suffix:semicolon
r_if
c_cond
(paren
id|psd_cnt
OG
id|bp
(braket
id|pgo
op_plus
id|PP_OFF_MAX_ADD_PARTS
)braket
)paren
(brace
id|bp
(braket
id|psdo
)braket
op_assign
id|bp
(braket
id|psdo
op_plus
l_int|1
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* Rest of the tape */
id|psdo
op_add_assign
l_int|2
suffix:semicolon
)brace
id|memset
c_func
(paren
id|bp
op_plus
id|psdo
comma
l_int|0
comma
id|bp
(braket
id|pgo
op_plus
id|PP_OFF_NBR_ADD_PARTS
)braket
op_star
l_int|2
)paren
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s: psd_cnt %d, max.parts %d, nbr_parts %d&bslash;n&quot;
comma
id|name
comma
id|psd_cnt
comma
id|bp
(braket
id|pgo
op_plus
id|PP_OFF_MAX_ADD_PARTS
)braket
comma
id|bp
(braket
id|pgo
op_plus
id|PP_OFF_NBR_ADD_PARTS
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
l_int|0
)paren
(brace
id|bp
(braket
id|pgo
op_plus
id|PP_OFF_NBR_ADD_PARTS
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|psd_cnt
op_le
id|bp
(braket
id|pgo
op_plus
id|PP_OFF_MAX_ADD_PARTS
)braket
)paren
id|bp
(braket
id|pgo
op_plus
id|MP_OFF_PAGE_LENGTH
)braket
op_assign
l_int|6
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Formatting tape with one partition.&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|bp
(braket
id|psdo
)braket
op_assign
(paren
id|size
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|bp
(braket
id|psdo
op_plus
l_int|1
)braket
op_assign
id|size
op_amp
l_int|0xff
suffix:semicolon
id|bp
(braket
id|pgo
op_plus
l_int|3
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|bp
(braket
id|pgo
op_plus
id|MP_OFF_PAGE_LENGTH
)braket
OL
l_int|8
)paren
id|bp
(braket
id|pgo
op_plus
id|MP_OFF_PAGE_LENGTH
)braket
op_assign
l_int|8
suffix:semicolon
id|DEBC
c_func
(paren
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Formatting tape with two partitions (1 = %d MB).&bslash;n&quot;
comma
id|name
comma
id|size
)paren
)paren
suffix:semicolon
)brace
id|bp
(braket
id|pgo
op_plus
id|PP_OFF_PART_UNITS
)braket
op_assign
l_int|0
suffix:semicolon
id|bp
(braket
id|pgo
op_plus
id|PP_OFF_RESERVED
)braket
op_assign
l_int|0
suffix:semicolon
id|bp
(braket
id|pgo
op_plus
id|PP_OFF_FLAGS
)braket
op_assign
id|PP_BIT_IDP
op_or
id|PP_MSK_PSUM_MB
suffix:semicolon
id|result
op_assign
id|write_mode_page
c_func
(paren
id|STp
comma
id|PART_PAGE
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Partitioning of tape failed.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|result
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
"&f;"
multiline_comment|/* The ioctl command */
DECL|function|st_ioctl
r_static
r_int
id|st_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|i
comma
id|cmd_nr
comma
id|cmd_type
comma
id|bt
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|blk
suffix:semicolon
r_struct
id|scsi_tape
op_star
id|STp
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|st_modedef
op_star
id|STm
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_char
op_star
id|name
op_assign
id|tape_name
c_func
(paren
id|STp
)paren
suffix:semicolon
r_void
id|__user
op_star
id|p
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|DEB
c_func
(paren
r_if
(paren
id|debugging
op_logical_and
op_logical_neg
id|STp-&gt;in_use
)paren
(brace
id|printk
c_func
(paren
id|ST_DEB_MSG
l_string|&quot;%s: Incorrect device.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)paren
multiline_comment|/* end DEB */
id|STm
op_assign
op_amp
(paren
id|STp-&gt;modes
(braket
id|STp-&gt;current_mode
)braket
)paren
suffix:semicolon
id|STps
op_assign
op_amp
(paren
id|STp-&gt;ps
(braket
id|STp-&gt;partition
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we are in the middle of error recovery, don&squot;t let anyone&n;&t; * else try and use this device.  Also, if error recovery fails, it&n;&t; * may try and take the device offline, in which case all further&n;&t; * access to the device is prohibited.&n;&t; */
id|retval
op_assign
id|scsi_nonblockable_ioctl
c_func
(paren
id|STp-&gt;device
comma
id|cmd_in
comma
id|p
comma
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_block_when_processing_errors
c_func
(paren
id|STp-&gt;device
)paren
op_logical_or
id|retval
op_ne
op_minus
id|ENODEV
)paren
r_goto
id|out
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|cmd_type
op_assign
id|_IOC_TYPE
c_func
(paren
id|cmd_in
)paren
suffix:semicolon
id|cmd_nr
op_assign
id|_IOC_NR
c_func
(paren
id|cmd_in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_type
op_eq
id|_IOC_TYPE
c_func
(paren
id|MTIOCTOP
)paren
op_logical_and
id|cmd_nr
op_eq
id|_IOC_NR
c_func
(paren
id|MTIOCTOP
)paren
)paren
(brace
r_struct
id|mtop
id|mtc
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_SIZE
c_func
(paren
id|cmd_in
)paren
op_ne
r_sizeof
(paren
id|mtc
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|i
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|mtc
comma
id|p
comma
r_sizeof
(paren
r_struct
id|mtop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSETDRVBUFFER
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: MTSETDRVBUFFER only allowed for root.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|retval
op_assign
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
op_logical_and
(paren
id|mtc.mt_op
op_ne
id|MTSETDRVBUFFER
op_logical_and
(paren
id|mtc.mt_count
op_amp
id|MT_ST_OPTIONS
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;pos_unknown
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_FM_HIT
)paren
(brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTFSF
op_logical_or
id|mtc.mt_op
op_eq
id|MTFSFM
op_logical_or
id|mtc.mt_op
op_eq
id|MTEOM
)paren
(brace
id|mtc.mt_count
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_add_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTBSF
op_logical_or
id|mtc.mt_op
op_eq
id|MTBSFM
)paren
(brace
id|mtc.mt_count
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;drv_file
op_ge
l_int|0
)paren
id|STps-&gt;drv_file
op_add_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSEEK
)paren
(brace
multiline_comment|/* Old position must be restored if partition will be&n;                                   changed */
id|i
op_assign
op_logical_neg
id|STp-&gt;can_partitions
op_logical_or
(paren
id|STp-&gt;new_partition
op_ne
id|STp-&gt;partition
)paren
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
id|mtc.mt_op
op_eq
id|MTREW
op_logical_or
id|mtc.mt_op
op_eq
id|MTOFFL
op_logical_or
id|mtc.mt_op
op_eq
id|MTRETEN
op_logical_or
id|mtc.mt_op
op_eq
id|MTEOM
op_logical_or
id|mtc.mt_op
op_eq
id|MTLOCK
op_logical_or
id|mtc.mt_op
op_eq
id|MTLOAD
op_logical_or
id|mtc.mt_op
op_eq
id|MTFSF
op_logical_or
id|mtc.mt_op
op_eq
id|MTFSFM
op_logical_or
id|mtc.mt_op
op_eq
id|MTBSF
op_logical_or
id|mtc.mt_op
op_eq
id|MTBSFM
op_logical_or
id|mtc.mt_op
op_eq
id|MTCOMPRESSION
suffix:semicolon
)brace
id|i
op_assign
id|flush_buffer
c_func
(paren
id|STp
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
op_logical_and
(paren
id|mtc.mt_op
op_eq
id|MTREW
op_logical_or
id|mtc.mt_op
op_eq
id|MTOFFL
op_logical_or
id|mtc.mt_op
op_eq
id|MTSEEK
op_logical_or
id|mtc.mt_op
op_eq
id|MTBSF
op_logical_or
id|mtc.mt_op
op_eq
id|MTBSFM
)paren
)paren
(brace
id|i
op_assign
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|MTWEOF
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTBSF
op_logical_or
id|mtc.mt_op
op_eq
id|MTBSFM
)paren
id|mtc.mt_count
op_increment
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * If there was a bus reset, block further access&n;&t;&t;&t; * to this device.  If the user wants to rewind the tape,&n;&t;&t;&t; * then reset the flag and allow access again.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|mtc.mt_op
op_ne
id|MTREW
op_logical_and
id|mtc.mt_op
op_ne
id|MTOFFL
op_logical_and
id|mtc.mt_op
op_ne
id|MTRETEN
op_logical_and
id|mtc.mt_op
op_ne
id|MTERASE
op_logical_and
id|mtc.mt_op
op_ne
id|MTSEEK
op_logical_and
id|mtc.mt_op
op_ne
id|MTEOM
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|reset_state
c_func
(paren
id|STp
)paren
suffix:semicolon
multiline_comment|/* remove this when the midlevel properly clears was_reset */
id|STp-&gt;device-&gt;was_reset
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_ne
id|MTNOP
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETBLK
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETDENSITY
op_logical_and
id|mtc.mt_op
op_ne
id|MTWSM
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETDRVBUFFER
op_logical_and
id|mtc.mt_op
op_ne
id|MTSETPART
)paren
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
multiline_comment|/* Prevent automatic WEOF and fsf */
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTOFFL
op_logical_and
id|STp-&gt;door_locked
op_ne
id|ST_UNLOCKED
)paren
id|do_door_lock
c_func
(paren
id|STp
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Ignore result! */
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSETDRVBUFFER
op_logical_and
(paren
id|mtc.mt_count
op_amp
id|MT_ST_OPTIONS
)paren
op_ne
l_int|0
)paren
(brace
id|retval
op_assign
id|st_set_options
c_func
(paren
id|STp
comma
id|mtc.mt_count
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSETPART
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;can_partitions
op_logical_or
id|mtc.mt_count
OL
l_int|0
op_logical_or
id|mtc.mt_count
op_ge
id|ST_NBR_PARTITIONS
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_count
op_ge
id|STp-&gt;nbr_partitions
op_logical_and
(paren
id|STp-&gt;nbr_partitions
op_assign
id|nbr_partitions
c_func
(paren
id|STp
)paren
)paren
OL
l_int|0
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_count
op_ge
id|STp-&gt;nbr_partitions
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|STp-&gt;new_partition
op_assign
id|mtc.mt_count
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTMKPART
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;can_partitions
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|MTREW
comma
l_int|0
)paren
)paren
OL
l_int|0
op_logical_or
(paren
id|i
op_assign
id|partition_tape
c_func
(paren
id|STp
comma
id|mtc.mt_count
)paren
)paren
OL
l_int|0
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|at_sm
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;ps
(braket
id|i
)braket
dot
id|last_block_valid
op_assign
l_int|0
suffix:semicolon
)brace
id|STp-&gt;partition
op_assign
id|STp-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
id|STp-&gt;nbr_partitions
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Bad guess ?-) */
id|STps-&gt;drv_block
op_assign
id|STps-&gt;drv_file
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTSEEK
)paren
(brace
id|i
op_assign
id|set_location
c_func
(paren
id|STp
comma
id|mtc.mt_count
comma
id|STp-&gt;new_partition
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|STp-&gt;can_partitions
)paren
id|STp-&gt;ps
(braket
l_int|0
)braket
dot
id|rw
op_assign
id|ST_IDLE
suffix:semicolon
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTUNLOAD
op_logical_or
id|mtc.mt_op
op_eq
id|MTOFFL
)paren
(brace
id|retval
op_assign
id|do_load_unload
c_func
(paren
id|STp
comma
id|file
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTLOAD
)paren
(brace
id|retval
op_assign
id|do_load_unload
c_func
(paren
id|STp
comma
id|file
comma
id|max
c_func
(paren
l_int|1
comma
id|mtc.mt_count
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTLOCK
op_logical_or
id|mtc.mt_op
op_eq
id|MTUNLOCK
)paren
(brace
id|retval
op_assign
id|do_door_lock
c_func
(paren
id|STp
comma
(paren
id|mtc.mt_op
op_eq
id|MTLOCK
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
id|STp-&gt;ready
op_eq
id|ST_READY
op_logical_and
(paren
id|i
op_assign
id|switch_partition
c_func
(paren
id|STp
)paren
)paren
OL
l_int|0
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mtc.mt_op
op_eq
id|MTCOMPRESSION
)paren
id|retval
op_assign
id|st_compression
c_func
(paren
id|STp
comma
(paren
id|mtc.mt_count
op_amp
l_int|1
)paren
)paren
suffix:semicolon
r_else
id|retval
op_assign
id|st_int_ioctl
c_func
(paren
id|STp
comma
id|mtc.mt_op
comma
id|mtc.mt_count
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|STm-&gt;defined
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|flush_buffer
c_func
(paren
id|STp
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STp-&gt;can_partitions
op_logical_and
(paren
id|i
op_assign
id|switch_partition
c_func
(paren
id|STp
)paren
)paren
OL
l_int|0
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd_type
op_eq
id|_IOC_TYPE
c_func
(paren
id|MTIOCGET
)paren
op_logical_and
id|cmd_nr
op_eq
id|_IOC_NR
c_func
(paren
id|MTIOCGET
)paren
)paren
(brace
r_struct
id|mtget
id|mt_status
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_SIZE
c_func
(paren
id|cmd_in
)paren
op_ne
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|mt_status.mt_type
op_assign
id|STp-&gt;tape_type
suffix:semicolon
id|mt_status.mt_dsreg
op_assign
(paren
(paren
id|STp-&gt;block_size
op_lshift
id|MT_ST_BLKSIZE_SHIFT
)paren
op_amp
id|MT_ST_BLKSIZE_MASK
)paren
op_or
(paren
(paren
id|STp-&gt;density
op_lshift
id|MT_ST_DENSITY_SHIFT
)paren
op_amp
id|MT_ST_DENSITY_MASK
)paren
suffix:semicolon
id|mt_status.mt_blkno
op_assign
id|STps-&gt;drv_block
suffix:semicolon
id|mt_status.mt_fileno
op_assign
id|STps-&gt;drv_file
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;block_size
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_WRITING
)paren
id|mt_status.mt_blkno
op_add_assign
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_div
id|STp-&gt;block_size
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STps-&gt;rw
op_eq
id|ST_READING
)paren
id|mt_status.mt_blkno
op_sub_assign
(paren
(paren
id|STp-&gt;buffer
)paren
op_member_access_from_pointer
id|buffer_bytes
op_plus
id|STp-&gt;block_size
op_minus
l_int|1
)paren
op_div
id|STp-&gt;block_size
suffix:semicolon
)brace
id|mt_status.mt_gstat
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;drv_write_prot
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_WR_PROT
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mt_status.mt_blkno
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|mt_status.mt_fileno
op_eq
l_int|0
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_BOT
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
id|mt_status.mt_gstat
op_or_assign
id|GMT_EOF
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
)brace
id|mt_status.mt_erreg
op_assign
(paren
id|STp-&gt;recover_reg
op_lshift
id|MT_ST_SOFTERR_SHIFT
)paren
suffix:semicolon
id|mt_status.mt_resid
op_assign
id|STp-&gt;partition
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;eof
op_eq
id|ST_EOM_OK
op_logical_or
id|STps-&gt;eof
op_eq
id|ST_EOM_ERROR
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_EOT
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STps-&gt;eof
op_ge
id|ST_EOM_OK
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_EOD
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;density
op_eq
l_int|1
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_D_800
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STp-&gt;density
op_eq
l_int|2
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_D_1600
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|STp-&gt;density
op_eq
l_int|3
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_D_6250
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_READY
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_ONLINE
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;ready
op_eq
id|ST_NO_TAPE
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_DR_OPEN
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STps-&gt;at_sm
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_SM
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STm-&gt;do_async_writes
op_logical_or
(paren
id|STm-&gt;do_buffer_writes
op_logical_and
id|STp-&gt;block_size
op_ne
l_int|0
)paren
op_logical_or
id|STp-&gt;drv_buffer
op_ne
l_int|0
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_IM_REP_EN
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STp-&gt;cleaning_req
)paren
id|mt_status.mt_gstat
op_or_assign
id|GMT_CLN
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
id|i
op_assign
id|copy_to_user
c_func
(paren
id|p
comma
op_amp
id|mt_status
comma
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|STp-&gt;recover_reg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear after read */
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* End of MTIOCGET */
r_if
c_cond
(paren
id|cmd_type
op_eq
id|_IOC_TYPE
c_func
(paren
id|MTIOCPOS
)paren
op_logical_and
id|cmd_nr
op_eq
id|_IOC_NR
c_func
(paren
id|MTIOCPOS
)paren
)paren
(brace
r_struct
id|mtpos
id|mt_pos
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_SIZE
c_func
(paren
id|cmd_in
)paren
op_ne
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
(brace
id|retval
op_assign
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|get_location
c_func
(paren
id|STp
comma
op_amp
id|blk
comma
op_amp
id|bt
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|retval
op_assign
id|i
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|mt_pos.mt_blkno
op_assign
id|blk
suffix:semicolon
id|i
op_assign
id|copy_to_user
c_func
(paren
id|p
comma
op_amp
id|mt_pos
comma
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
id|retval
op_assign
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd_in
)paren
(brace
r_case
id|SCSI_IOCTL_GET_IDLUN
suffix:colon
r_case
id|SCSI_IOCTL_GET_BUS_NUMBER
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
id|i
op_assign
op_minus
id|EPERM
suffix:semicolon
r_else
id|i
op_assign
id|scsi_cmd_ioctl
c_func
(paren
id|file
comma
id|STp-&gt;disk
comma
id|cmd_in
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
op_minus
id|ENOTTY
)paren
r_return
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_and
(paren
id|cmd_in
op_eq
id|SCSI_IOCTL_START_UNIT
op_logical_or
id|cmd_in
op_eq
id|SCSI_IOCTL_STOP_UNIT
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_return
id|scsi_ioctl
c_func
(paren
id|STp-&gt;device
comma
id|cmd_in
comma
id|p
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|STp-&gt;lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_COMPAT
DECL|function|st_compat_ioctl
r_static
r_int
id|st_compat_ioctl
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|scsi_tape
op_star
id|STp
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|STp-&gt;device
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_if
c_cond
(paren
id|sdev-&gt;host-&gt;hostt-&gt;compat_ioctl
)paren
(brace
id|ret
op_assign
id|sdev-&gt;host-&gt;hostt
op_member_access_from_pointer
id|compat_ioctl
c_func
(paren
id|sdev
comma
id|cmd
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif
"&f;"
multiline_comment|/* Try to allocate a new tape buffer. Calling function must not hold&n;   dev_arr_lock. */
r_static
r_struct
id|st_buffer
op_star
DECL|function|new_tape_buffer
id|new_tape_buffer
c_func
(paren
r_int
id|from_initialization
comma
r_int
id|need_dma
comma
r_int
id|max_sg
)paren
(brace
r_int
id|i
comma
id|priority
comma
id|got
op_assign
l_int|0
comma
id|segs
op_assign
l_int|0
suffix:semicolon
r_struct
id|st_buffer
op_star
id|tb
suffix:semicolon
r_if
c_cond
(paren
id|from_initialization
)paren
id|priority
op_assign
id|GFP_ATOMIC
suffix:semicolon
r_else
id|priority
op_assign
id|GFP_KERNEL
suffix:semicolon
id|i
op_assign
r_sizeof
(paren
r_struct
id|st_buffer
)paren
op_plus
(paren
id|max_sg
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_plus
id|max_sg
op_star
r_sizeof
(paren
r_struct
id|st_buf_fragment
)paren
suffix:semicolon
id|tb
op_assign
id|kmalloc
c_func
(paren
id|i
comma
id|priority
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tb
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;st: Can&squot;t allocate new tape buffer.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tb
comma
l_int|0
comma
id|i
)paren
suffix:semicolon
id|tb-&gt;frp_segs
op_assign
id|tb-&gt;orig_frp_segs
op_assign
id|segs
suffix:semicolon
id|tb-&gt;use_sg
op_assign
id|max_sg
suffix:semicolon
r_if
c_cond
(paren
id|segs
OG
l_int|0
)paren
id|tb-&gt;b_data
op_assign
id|page_address
c_func
(paren
id|tb-&gt;sg
(braket
l_int|0
)braket
dot
id|page
)paren
suffix:semicolon
id|tb-&gt;frp
op_assign
(paren
r_struct
id|st_buf_fragment
op_star
)paren
(paren
op_amp
(paren
id|tb-&gt;sg
(braket
l_int|0
)braket
)paren
op_plus
id|max_sg
)paren
suffix:semicolon
id|tb-&gt;in_use
op_assign
l_int|1
suffix:semicolon
id|tb-&gt;dma
op_assign
id|need_dma
suffix:semicolon
id|tb-&gt;buffer_size
op_assign
id|got
suffix:semicolon
r_return
id|tb
suffix:semicolon
)brace
multiline_comment|/* Try to allocate enough space in the tape buffer */
DECL|function|enlarge_buffer
r_static
r_int
id|enlarge_buffer
c_func
(paren
r_struct
id|st_buffer
op_star
id|STbuffer
comma
r_int
id|new_size
comma
r_int
id|need_dma
)paren
(brace
r_int
id|segs
comma
id|nbr
comma
id|max_segs
comma
id|b_size
comma
id|priority
comma
id|order
comma
id|got
suffix:semicolon
r_if
c_cond
(paren
id|new_size
op_le
id|STbuffer-&gt;buffer_size
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|STbuffer-&gt;buffer_size
op_le
id|PAGE_SIZE
)paren
id|normalize_buffer
c_func
(paren
id|STbuffer
)paren
suffix:semicolon
multiline_comment|/* Avoid extra segment */
id|max_segs
op_assign
id|STbuffer-&gt;use_sg
suffix:semicolon
id|nbr
op_assign
id|max_segs
op_minus
id|STbuffer-&gt;frp_segs
suffix:semicolon
r_if
c_cond
(paren
id|nbr
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|priority
op_assign
id|GFP_KERNEL
op_or
id|__GFP_NOWARN
suffix:semicolon
r_if
c_cond
(paren
id|need_dma
)paren
id|priority
op_or_assign
id|GFP_DMA
suffix:semicolon
r_for
c_loop
(paren
id|b_size
op_assign
id|PAGE_SIZE
comma
id|order
op_assign
l_int|0
suffix:semicolon
id|b_size
OL
id|new_size
op_minus
id|STbuffer-&gt;buffer_size
suffix:semicolon
id|order
op_increment
comma
id|b_size
op_mul_assign
l_int|2
)paren
suffix:semicolon
multiline_comment|/* empty */
r_for
c_loop
(paren
id|segs
op_assign
id|STbuffer-&gt;frp_segs
comma
id|got
op_assign
id|STbuffer-&gt;buffer_size
suffix:semicolon
id|segs
OL
id|max_segs
op_logical_and
id|got
OL
id|new_size
suffix:semicolon
)paren
(brace
id|STbuffer-&gt;frp
(braket
id|segs
)braket
dot
id|page
op_assign
id|alloc_pages
c_func
(paren
id|priority
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STbuffer-&gt;frp
(braket
id|segs
)braket
dot
id|page
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|new_size
op_minus
id|got
op_le
(paren
id|max_segs
op_minus
id|segs
)paren
op_star
id|b_size
op_div
l_int|2
)paren
(brace
id|b_size
op_div_assign
l_int|2
suffix:semicolon
multiline_comment|/* Large enough for the rest of the buffers */
id|order
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|DEB
c_func
(paren
id|STbuffer-&gt;buffer_size
op_assign
id|got
)paren
suffix:semicolon
id|normalize_buffer
c_func
(paren
id|STbuffer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|STbuffer-&gt;frp
(braket
id|segs
)braket
dot
id|length
op_assign
id|b_size
suffix:semicolon
id|STbuffer-&gt;frp_segs
op_add_assign
l_int|1
suffix:semicolon
id|got
op_add_assign
id|b_size
suffix:semicolon
id|STbuffer-&gt;buffer_size
op_assign
id|got
suffix:semicolon
id|segs
op_increment
suffix:semicolon
)brace
id|STbuffer-&gt;b_data
op_assign
id|page_address
c_func
(paren
id|STbuffer-&gt;frp
(braket
l_int|0
)braket
dot
id|page
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Release the extra buffer */
DECL|function|normalize_buffer
r_static
r_void
id|normalize_buffer
c_func
(paren
r_struct
id|st_buffer
op_star
id|STbuffer
)paren
(brace
r_int
id|i
comma
id|order
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|STbuffer-&gt;orig_frp_segs
suffix:semicolon
id|i
OL
id|STbuffer-&gt;frp_segs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|order
op_assign
id|get_order
c_func
(paren
id|STbuffer-&gt;frp
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
id|__free_pages
c_func
(paren
id|STbuffer-&gt;frp
(braket
id|i
)braket
dot
id|page
comma
id|order
)paren
suffix:semicolon
id|STbuffer-&gt;buffer_size
op_sub_assign
id|STbuffer-&gt;frp
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
id|STbuffer-&gt;frp_segs
op_assign
id|STbuffer-&gt;orig_frp_segs
suffix:semicolon
id|STbuffer-&gt;frp_sg_current
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Move data from the user buffer to the tape buffer. Returns zero (success) or&n;   negative error code. */
DECL|function|append_to_buffer
r_static
r_int
id|append_to_buffer
c_func
(paren
r_const
r_char
id|__user
op_star
id|ubp
comma
r_struct
id|st_buffer
op_star
id|st_bp
comma
r_int
id|do_count
)paren
(brace
r_int
id|i
comma
id|cnt
comma
id|res
comma
id|offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|offset
op_assign
id|st_bp-&gt;buffer_bytes
suffix:semicolon
id|i
OL
id|st_bp-&gt;frp_segs
op_logical_and
id|offset
op_ge
id|st_bp-&gt;frp
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|i
op_increment
)paren
id|offset
op_sub_assign
id|st_bp-&gt;frp
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|st_bp-&gt;frp_segs
)paren
(brace
multiline_comment|/* Should never happen */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st: append_to_buffer offset overflow.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
template_param
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cnt
op_assign
id|st_bp-&gt;frp
(braket
id|i
)braket
dot
id|length
op_minus
id|offset
OL
id|do_count
ques
c_cond
id|st_bp-&gt;frp
(braket
id|i
)braket
dot
id|length
op_minus
id|offset
suffix:colon
id|do_count
suffix:semicolon
id|res
op_assign
id|copy_from_user
c_func
(paren
id|page_address
c_func
(paren
id|st_bp-&gt;frp
(braket
id|i
)braket
dot
id|page
)paren
op_plus
id|offset
comma
id|ubp
comma
id|cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
id|do_count
op_sub_assign
id|cnt
suffix:semicolon
id|st_bp-&gt;buffer_bytes
op_add_assign
id|cnt
suffix:semicolon
id|ubp
op_add_assign
id|cnt
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_count
)paren
multiline_comment|/* Should never happen */
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Move data from the tape buffer to the user buffer. Returns zero (success) or&n;   negative error code. */
DECL|function|from_buffer
r_static
r_int
id|from_buffer
c_func
(paren
r_struct
id|st_buffer
op_star
id|st_bp
comma
r_char
id|__user
op_star
id|ubp
comma
r_int
id|do_count
)paren
(brace
r_int
id|i
comma
id|cnt
comma
id|res
comma
id|offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|offset
op_assign
id|st_bp-&gt;read_pointer
suffix:semicolon
id|i
OL
id|st_bp-&gt;frp_segs
op_logical_and
id|offset
op_ge
id|st_bp-&gt;frp
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|i
op_increment
)paren
id|offset
op_sub_assign
id|st_bp-&gt;frp
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|st_bp-&gt;frp_segs
)paren
(brace
multiline_comment|/* Should never happen */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st: from_buffer offset overflow.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
template_param
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cnt
op_assign
id|st_bp-&gt;frp
(braket
id|i
)braket
dot
id|length
op_minus
id|offset
OL
id|do_count
ques
c_cond
id|st_bp-&gt;frp
(braket
id|i
)braket
dot
id|length
op_minus
id|offset
suffix:colon
id|do_count
suffix:semicolon
id|res
op_assign
id|copy_to_user
c_func
(paren
id|ubp
comma
id|page_address
c_func
(paren
id|st_bp-&gt;frp
(braket
id|i
)braket
dot
id|page
)paren
op_plus
id|offset
comma
id|cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
id|do_count
op_sub_assign
id|cnt
suffix:semicolon
id|st_bp-&gt;buffer_bytes
op_sub_assign
id|cnt
suffix:semicolon
id|st_bp-&gt;read_pointer
op_add_assign
id|cnt
suffix:semicolon
id|ubp
op_add_assign
id|cnt
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_count
)paren
multiline_comment|/* Should never happen */
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Move data towards start of buffer */
DECL|function|move_buffer_data
r_static
r_void
id|move_buffer_data
c_func
(paren
r_struct
id|st_buffer
op_star
id|st_bp
comma
r_int
id|offset
)paren
(brace
r_int
id|src_seg
comma
id|dst_seg
comma
id|src_offset
op_assign
l_int|0
comma
id|dst_offset
suffix:semicolon
r_int
id|count
comma
id|total
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|total
op_assign
id|st_bp-&gt;buffer_bytes
op_minus
id|offset
suffix:semicolon
r_for
c_loop
(paren
id|src_seg
op_assign
l_int|0
suffix:semicolon
id|src_seg
OL
id|st_bp-&gt;frp_segs
suffix:semicolon
id|src_seg
op_increment
)paren
(brace
id|src_offset
op_assign
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|src_offset
OL
id|st_bp-&gt;frp
(braket
id|src_seg
)braket
dot
id|length
)paren
r_break
suffix:semicolon
id|offset
op_sub_assign
id|st_bp-&gt;frp
(braket
id|src_seg
)braket
dot
id|length
suffix:semicolon
)brace
id|st_bp-&gt;buffer_bytes
op_assign
id|st_bp-&gt;read_pointer
op_assign
id|total
suffix:semicolon
r_for
c_loop
(paren
id|dst_seg
op_assign
id|dst_offset
op_assign
l_int|0
suffix:semicolon
id|total
OG
l_int|0
suffix:semicolon
)paren
(brace
id|count
op_assign
id|min
c_func
(paren
id|st_bp-&gt;frp
(braket
id|dst_seg
)braket
dot
id|length
op_minus
id|dst_offset
comma
id|st_bp-&gt;frp
(braket
id|src_seg
)braket
dot
id|length
op_minus
id|src_offset
)paren
suffix:semicolon
id|memmove
c_func
(paren
id|page_address
c_func
(paren
id|st_bp-&gt;frp
(braket
id|dst_seg
)braket
dot
id|page
)paren
op_plus
id|dst_offset
comma
id|page_address
c_func
(paren
id|st_bp-&gt;frp
(braket
id|src_seg
)braket
dot
id|page
)paren
op_plus
id|src_offset
comma
id|count
)paren
suffix:semicolon
id|src_offset
op_add_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|src_offset
op_ge
id|st_bp-&gt;frp
(braket
id|src_seg
)braket
dot
id|length
)paren
(brace
id|src_seg
op_increment
suffix:semicolon
id|src_offset
op_assign
l_int|0
suffix:semicolon
)brace
id|dst_offset
op_add_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|dst_offset
op_ge
id|st_bp-&gt;frp
(braket
id|dst_seg
)braket
dot
id|length
)paren
(brace
id|dst_seg
op_increment
suffix:semicolon
id|dst_offset
op_assign
l_int|0
suffix:semicolon
)brace
id|total
op_sub_assign
id|count
suffix:semicolon
)brace
)brace
multiline_comment|/* Fill the s/g list up to the length required for this transfer */
DECL|function|buf_to_sg
r_static
r_void
id|buf_to_sg
c_func
(paren
r_struct
id|st_buffer
op_star
id|STbp
comma
r_int
r_int
id|length
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|count
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_struct
id|st_buf_fragment
op_star
id|frp
suffix:semicolon
r_if
c_cond
(paren
id|length
op_eq
id|STbp-&gt;frp_sg_current
)paren
r_return
suffix:semicolon
multiline_comment|/* work already done */
id|sg
op_assign
op_amp
(paren
id|STbp-&gt;sg
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|frp
op_assign
id|STbp-&gt;frp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|length
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sg
(braket
id|i
)braket
dot
id|page
op_assign
id|frp
(braket
id|i
)braket
dot
id|page
suffix:semicolon
r_if
c_cond
(paren
id|length
op_minus
id|count
OG
id|frp
(braket
id|i
)braket
dot
id|length
)paren
id|sg
(braket
id|i
)braket
dot
id|length
op_assign
id|frp
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_else
id|sg
(braket
id|i
)braket
dot
id|length
op_assign
id|length
op_minus
id|count
suffix:semicolon
id|count
op_add_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|sg
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
id|STbp-&gt;sg_segs
op_assign
id|i
suffix:semicolon
id|STbp-&gt;frp_sg_current
op_assign
id|length
suffix:semicolon
)brace
multiline_comment|/* Validate the options from command line or module parameters */
DECL|function|validate_options
r_static
r_void
id|validate_options
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|buffer_kbs
OG
l_int|0
)paren
id|st_fixed_buffer_size
op_assign
id|buffer_kbs
op_star
id|ST_KILOBYTE
suffix:semicolon
r_if
c_cond
(paren
id|max_sg_segs
op_ge
id|ST_FIRST_SG
)paren
id|st_max_sg_segs
op_assign
id|max_sg_segs
suffix:semicolon
)brace
macro_line|#ifndef MODULE
multiline_comment|/* Set the boot options. Syntax is defined in Documenation/scsi/st.txt.&n; */
DECL|function|st_setup
r_static
r_int
id|__init
id|st_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|i
comma
id|len
comma
id|ints
(braket
l_int|5
)braket
suffix:semicolon
r_char
op_star
id|stp
suffix:semicolon
id|stp
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ints
(braket
l_int|0
)braket
op_logical_and
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|parms
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|parms
(braket
id|i
)braket
dot
id|val
)paren
op_star
id|parms
(braket
id|i
)braket
dot
id|val
op_assign
id|ints
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|stp
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|parms
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_assign
id|strlen
c_func
(paren
id|parms
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|stp
comma
id|parms
(braket
id|i
)braket
dot
id|name
comma
id|len
)paren
op_logical_and
(paren
op_star
(paren
id|stp
op_plus
id|len
)paren
op_eq
l_char|&squot;:&squot;
op_logical_or
op_star
(paren
id|stp
op_plus
id|len
)paren
op_eq
l_char|&squot;=&squot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|parms
(braket
id|i
)braket
dot
id|val
)paren
op_star
id|parms
(braket
id|i
)braket
dot
id|val
op_assign
id|simple_strtoul
c_func
(paren
id|stp
op_plus
id|len
op_plus
l_int|1
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st: Obsolete parameter %s&bslash;n&quot;
comma
id|parms
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_ge
r_sizeof
(paren
id|parms
)paren
op_div
r_sizeof
(paren
r_struct
id|st_dev_parm
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st: invalid parameter in &squot;%s&squot;&bslash;n&quot;
comma
id|stp
)paren
suffix:semicolon
id|stp
op_assign
id|strchr
c_func
(paren
id|stp
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stp
)paren
id|stp
op_increment
suffix:semicolon
)brace
)brace
id|validate_options
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;st=&quot;
comma
id|st_setup
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|st_fops
r_static
r_struct
id|file_operations
id|st_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|read
op_assign
id|st_read
comma
dot
id|write
op_assign
id|st_write
comma
dot
id|ioctl
op_assign
id|st_ioctl
comma
macro_line|#ifdef CONFIG_COMPAT
dot
id|compat_ioctl
op_assign
id|st_compat_ioctl
comma
macro_line|#endif
dot
id|open
op_assign
id|st_open
comma
dot
id|flush
op_assign
id|st_flush
comma
dot
id|release
op_assign
id|st_release
comma
)brace
suffix:semicolon
DECL|function|st_probe
r_static
r_int
id|st_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|scsi_device
op_star
id|SDp
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|gendisk
op_star
id|disk
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|cdev
op_star
id|cdev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|scsi_tape
op_star
id|tpnt
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|st_modedef
op_star
id|STm
suffix:semicolon
r_struct
id|st_partstat
op_star
id|STps
suffix:semicolon
r_struct
id|st_buffer
op_star
id|buffer
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|mode
comma
id|dev_num
comma
id|error
suffix:semicolon
r_char
op_star
id|stp
suffix:semicolon
id|u64
id|bounce_limit
suffix:semicolon
r_if
c_cond
(paren
id|SDp-&gt;type
op_ne
id|TYPE_TAPE
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stp
op_assign
id|st_incompatible
c_func
(paren
id|SDp
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st: Found incompatible tape at scsi%d, channel %d, id %d, lun %d&bslash;n&quot;
comma
id|SDp-&gt;host-&gt;host_no
comma
id|SDp-&gt;channel
comma
id|SDp-&gt;id
comma
id|SDp-&gt;lun
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st: The suggested driver is %s.&bslash;n&quot;
comma
id|stp
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|i
op_assign
id|SDp-&gt;host-&gt;sg_tablesize
suffix:semicolon
r_if
c_cond
(paren
id|st_max_sg_segs
OL
id|i
)paren
id|i
op_assign
id|st_max_sg_segs
suffix:semicolon
id|buffer
op_assign
id|new_tape_buffer
c_func
(paren
l_int|1
comma
(paren
id|SDp-&gt;host
)paren
op_member_access_from_pointer
id|unchecked_isa_dma
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st: Can&squot;t allocate new tape buffer. Device not attached.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|disk
op_assign
id|alloc_disk
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disk
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st: out of memory. Device not attached.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_buffer_free
suffix:semicolon
)brace
id|write_lock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_nr_dev
op_ge
id|st_dev_max
)paren
(brace
r_struct
id|scsi_tape
op_star
op_star
id|tmp_da
suffix:semicolon
r_int
id|tmp_dev_max
suffix:semicolon
id|tmp_dev_max
op_assign
id|max
c_func
(paren
id|st_nr_dev
op_star
l_int|2
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_dev_max
OG
id|ST_MAX_TAPES
)paren
id|tmp_dev_max
op_assign
id|ST_MAX_TAPES
suffix:semicolon
r_if
c_cond
(paren
id|tmp_dev_max
op_le
id|st_nr_dev
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st: Too many tape devices (max. %d).&bslash;n&quot;
comma
id|ST_MAX_TAPES
)paren
suffix:semicolon
r_goto
id|out_put_disk
suffix:semicolon
)brace
id|tmp_da
op_assign
id|kmalloc
c_func
(paren
id|tmp_dev_max
op_star
r_sizeof
(paren
r_struct
id|scsi_tape
op_star
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_da
op_eq
l_int|NULL
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st: Can&squot;t extend device array.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_put_disk
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tmp_da
comma
l_int|0
comma
id|tmp_dev_max
op_star
r_sizeof
(paren
r_struct
id|scsi_tape
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_tapes
op_ne
l_int|NULL
)paren
(brace
id|memcpy
c_func
(paren
id|tmp_da
comma
id|scsi_tapes
comma
id|st_dev_max
op_star
r_sizeof
(paren
r_struct
id|scsi_tape
op_star
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|scsi_tapes
)paren
suffix:semicolon
)brace
id|scsi_tapes
op_assign
id|tmp_da
suffix:semicolon
id|st_dev_max
op_assign
id|tmp_dev_max
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|st_dev_max
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|scsi_tapes
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|st_dev_max
)paren
id|panic
c_func
(paren
l_string|&quot;scsi_devices corrupt (st)&quot;
)paren
suffix:semicolon
id|tpnt
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scsi_tape
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tpnt
op_eq
l_int|NULL
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st: Can&squot;t allocate device descriptor.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_put_disk
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tpnt
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scsi_tape
)paren
)paren
suffix:semicolon
id|tpnt-&gt;disk
op_assign
id|disk
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;disk_name
comma
l_string|&quot;st%d&quot;
comma
id|i
)paren
suffix:semicolon
id|disk-&gt;private_data
op_assign
op_amp
id|tpnt-&gt;driver
suffix:semicolon
id|disk-&gt;queue
op_assign
id|SDp-&gt;request_queue
suffix:semicolon
id|tpnt-&gt;driver
op_assign
op_amp
id|st_template
suffix:semicolon
id|scsi_tapes
(braket
id|i
)braket
op_assign
id|tpnt
suffix:semicolon
id|dev_num
op_assign
id|i
suffix:semicolon
id|tpnt-&gt;device
op_assign
id|SDp
suffix:semicolon
r_if
c_cond
(paren
id|SDp-&gt;scsi_level
op_le
l_int|2
)paren
id|tpnt-&gt;tape_type
op_assign
id|MT_ISSCSI1
suffix:semicolon
r_else
id|tpnt-&gt;tape_type
op_assign
id|MT_ISSCSI2
suffix:semicolon
id|tpnt-&gt;buffer
op_assign
id|buffer
suffix:semicolon
id|tpnt-&gt;inited
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;dirty
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;drv_buffer
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Try buffering if no mode sense */
id|tpnt-&gt;restr_dma
op_assign
(paren
id|SDp-&gt;host
)paren
op_member_access_from_pointer
id|unchecked_isa_dma
suffix:semicolon
id|tpnt-&gt;use_pf
op_assign
(paren
id|SDp-&gt;scsi_level
op_ge
id|SCSI_2
)paren
suffix:semicolon
id|tpnt-&gt;density
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;do_auto_lock
op_assign
id|ST_AUTO_LOCK
suffix:semicolon
id|tpnt-&gt;can_bsr
op_assign
(paren
id|SDp-&gt;scsi_level
OG
l_int|2
ques
c_cond
l_int|1
suffix:colon
id|ST_IN_FILE_POS
)paren
suffix:semicolon
multiline_comment|/* BSR mandatory in SCSI3 */
id|tpnt-&gt;can_partitions
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;two_fm
op_assign
id|ST_TWO_FM
suffix:semicolon
id|tpnt-&gt;fast_mteom
op_assign
id|ST_FAST_MTEOM
suffix:semicolon
id|tpnt-&gt;scsi2_logical
op_assign
id|ST_SCSI2LOGICAL
suffix:semicolon
id|tpnt-&gt;immediate
op_assign
id|ST_NOWAIT
suffix:semicolon
id|tpnt-&gt;default_drvbuffer
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* No forced buffering */
id|tpnt-&gt;partition
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;new_partition
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;nbr_partitions
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;device-&gt;timeout
op_assign
id|ST_TIMEOUT
suffix:semicolon
id|tpnt-&gt;long_timeout
op_assign
id|ST_LONG_TIMEOUT
suffix:semicolon
id|tpnt-&gt;try_dio
op_assign
id|try_direct_io
op_logical_and
op_logical_neg
id|SDp-&gt;host-&gt;unchecked_isa_dma
suffix:semicolon
id|bounce_limit
op_assign
id|scsi_calculate_bounce_limit
c_func
(paren
id|SDp-&gt;host
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|bounce_limit
OG
id|ULONG_MAX
)paren
id|bounce_limit
op_assign
id|ULONG_MAX
suffix:semicolon
id|tpnt-&gt;max_pfn
op_assign
id|bounce_limit
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_MODES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STm
op_assign
op_amp
(paren
id|tpnt-&gt;modes
(braket
id|i
)braket
)paren
suffix:semicolon
id|STm-&gt;defined
op_assign
l_int|0
suffix:semicolon
id|STm-&gt;sysv
op_assign
id|ST_SYSV
suffix:semicolon
id|STm-&gt;defaults_for_writes
op_assign
l_int|0
suffix:semicolon
id|STm-&gt;do_async_writes
op_assign
id|ST_ASYNC_WRITES
suffix:semicolon
id|STm-&gt;do_buffer_writes
op_assign
id|ST_BUFFER_WRITES
suffix:semicolon
id|STm-&gt;do_read_ahead
op_assign
id|ST_READ_AHEAD
suffix:semicolon
id|STm-&gt;default_compression
op_assign
id|ST_DONT_TOUCH
suffix:semicolon
id|STm-&gt;default_blksize
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* No forced size */
id|STm-&gt;default_density
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* No forced density */
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ST_NBR_PARTITIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|STps
op_assign
op_amp
(paren
id|tpnt-&gt;ps
(braket
id|i
)braket
)paren
suffix:semicolon
id|STps-&gt;rw
op_assign
id|ST_IDLE
suffix:semicolon
id|STps-&gt;eof
op_assign
id|ST_NOEOF
suffix:semicolon
id|STps-&gt;at_sm
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;last_block_valid
op_assign
l_int|0
suffix:semicolon
id|STps-&gt;drv_block
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|STps-&gt;drv_file
op_assign
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|tpnt-&gt;current_mode
op_assign
l_int|0
suffix:semicolon
id|tpnt-&gt;modes
(braket
l_int|0
)braket
dot
id|defined
op_assign
l_int|1
suffix:semicolon
id|tpnt-&gt;density_changed
op_assign
id|tpnt-&gt;compression_changed
op_assign
id|tpnt-&gt;blksize_changed
op_assign
l_int|0
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|tpnt-&gt;lock
)paren
suffix:semicolon
id|st_nr_dev
op_increment
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|mode
op_assign
l_int|0
suffix:semicolon
id|mode
OL
id|ST_NBR_MODES
suffix:semicolon
op_increment
id|mode
)paren
(brace
id|STm
op_assign
op_amp
(paren
id|tpnt-&gt;modes
(braket
id|mode
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
id|cdev
op_assign
id|cdev_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st%d: out of memory. Device not attached.&bslash;n&quot;
comma
id|dev_num
)paren
suffix:semicolon
r_goto
id|out_free_tape
suffix:semicolon
)brace
id|cdev-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|cdev-&gt;ops
op_assign
op_amp
id|st_fops
suffix:semicolon
id|error
op_assign
id|cdev_add
c_func
(paren
id|cdev
comma
id|MKDEV
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
id|TAPE_MINOR
c_func
(paren
id|dev_num
comma
id|mode
comma
id|j
)paren
)paren
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st%d: Can&squot;t add %s-rewind mode %d&bslash;n&quot;
comma
id|dev_num
comma
id|j
ques
c_cond
l_string|&quot;non&quot;
suffix:colon
l_string|&quot;auto&quot;
comma
id|mode
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st%d: Device not attached.&bslash;n&quot;
comma
id|dev_num
)paren
suffix:semicolon
r_goto
id|out_free_tape
suffix:semicolon
)brace
id|STm-&gt;cdevs
(braket
id|j
)braket
op_assign
id|cdev
suffix:semicolon
)brace
id|do_create_class_files
c_func
(paren
id|tpnt
comma
id|dev_num
comma
id|mode
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|mode
op_assign
l_int|0
suffix:semicolon
id|mode
OL
id|ST_NBR_MODES
suffix:semicolon
op_increment
id|mode
)paren
(brace
multiline_comment|/* Make sure that the minor numbers corresponding to the four&n;&t;&t;   first modes always get the same names */
id|i
op_assign
id|mode
op_lshift
(paren
l_int|4
op_minus
id|ST_NBR_MODE_BITS
)paren
suffix:semicolon
multiline_comment|/*  Rewind entry  */
id|devfs_mk_cdev
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
id|TAPE_MINOR
c_func
(paren
id|dev_num
comma
id|mode
comma
l_int|0
)paren
)paren
comma
id|S_IFCHR
op_or
id|S_IRUGO
op_or
id|S_IWUGO
comma
l_string|&quot;%s/mt%s&quot;
comma
id|SDp-&gt;devfs_name
comma
id|st_formats
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/*  No-rewind entry  */
id|devfs_mk_cdev
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
id|TAPE_MINOR
c_func
(paren
id|dev_num
comma
id|mode
comma
l_int|1
)paren
)paren
comma
id|S_IFCHR
op_or
id|S_IRUGO
op_or
id|S_IWUGO
comma
l_string|&quot;%s/mt%sn&quot;
comma
id|SDp-&gt;devfs_name
comma
id|st_formats
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|disk-&gt;number
op_assign
id|devfs_register_tape
c_func
(paren
id|SDp-&gt;devfs_name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Attached scsi tape %s at scsi%d, channel %d, id %d, lun %d&bslash;n&quot;
comma
id|tape_name
c_func
(paren
id|tpnt
)paren
comma
id|SDp-&gt;host-&gt;host_no
comma
id|SDp-&gt;channel
comma
id|SDp-&gt;id
comma
id|SDp-&gt;lun
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: try direct i/o: %s (alignment %d B), max page reachable by HBA %lu&bslash;n&quot;
comma
id|tape_name
c_func
(paren
id|tpnt
)paren
comma
id|tpnt-&gt;try_dio
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|queue_dma_alignment
c_func
(paren
id|SDp-&gt;request_queue
)paren
op_plus
l_int|1
comma
id|tpnt-&gt;max_pfn
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_free_tape
suffix:colon
r_for
c_loop
(paren
id|mode
op_assign
l_int|0
suffix:semicolon
id|mode
OL
id|ST_NBR_MODES
suffix:semicolon
id|mode
op_increment
)paren
(brace
id|STm
op_assign
op_amp
(paren
id|tpnt-&gt;modes
(braket
id|mode
)braket
)paren
suffix:semicolon
id|sysfs_remove_link
c_func
(paren
op_amp
id|tpnt-&gt;device-&gt;sdev_gendev.kobj
comma
l_string|&quot;tape&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|STm-&gt;cdevs
(braket
id|j
)braket
)paren
(brace
r_if
c_cond
(paren
id|cdev
op_eq
id|STm-&gt;cdevs
(braket
id|j
)braket
)paren
id|cdev
op_assign
l_int|NULL
suffix:semicolon
id|class_simple_device_remove
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
id|TAPE_MINOR
c_func
(paren
id|i
comma
id|mode
comma
id|j
)paren
)paren
)paren
suffix:semicolon
id|cdev_del
c_func
(paren
id|STm-&gt;cdevs
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|cdev
)paren
id|cdev_del
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
id|scsi_tapes
(braket
id|dev_num
)braket
op_assign
l_int|NULL
suffix:semicolon
id|st_nr_dev
op_decrement
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
id|out_put_disk
suffix:colon
id|put_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tpnt
)paren
id|kfree
c_func
(paren
id|tpnt
)paren
suffix:semicolon
id|out_buffer_free
suffix:colon
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|out
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
suffix:semicolon
DECL|function|st_remove
r_static
r_int
id|st_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|scsi_device
op_star
id|SDp
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|scsi_tape
op_star
id|tpnt
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|mode
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|st_dev_max
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tpnt
op_assign
id|scsi_tapes
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tpnt
op_ne
l_int|NULL
op_logical_and
id|tpnt-&gt;device
op_eq
id|SDp
)paren
(brace
id|scsi_tapes
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|st_nr_dev
op_decrement
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
id|devfs_unregister_tape
c_func
(paren
id|tpnt-&gt;disk-&gt;number
)paren
suffix:semicolon
id|sysfs_remove_link
c_func
(paren
op_amp
id|tpnt-&gt;device-&gt;sdev_gendev.kobj
comma
l_string|&quot;tape&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|mode
op_assign
l_int|0
suffix:semicolon
id|mode
OL
id|ST_NBR_MODES
suffix:semicolon
op_increment
id|mode
)paren
(brace
id|j
op_assign
id|mode
op_lshift
(paren
l_int|4
op_minus
id|ST_NBR_MODE_BITS
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;%s/mt%s&quot;
comma
id|SDp-&gt;devfs_name
comma
id|st_formats
(braket
id|j
)braket
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;%s/mt%sn&quot;
comma
id|SDp-&gt;devfs_name
comma
id|st_formats
(braket
id|j
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
id|class_simple_device_remove
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
id|TAPE_MINOR
c_func
(paren
id|i
comma
id|mode
comma
id|j
)paren
)paren
)paren
suffix:semicolon
id|cdev_del
c_func
(paren
id|tpnt-&gt;modes
(braket
id|mode
)braket
dot
id|cdevs
(braket
id|j
)braket
)paren
suffix:semicolon
id|tpnt-&gt;modes
(braket
id|mode
)braket
dot
id|cdevs
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|tpnt-&gt;device
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|tpnt-&gt;buffer
)paren
(brace
id|tpnt-&gt;buffer-&gt;orig_frp_segs
op_assign
l_int|0
suffix:semicolon
id|normalize_buffer
c_func
(paren
id|tpnt-&gt;buffer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tpnt-&gt;buffer
)paren
suffix:semicolon
)brace
id|put_disk
c_func
(paren
id|tpnt-&gt;disk
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|write_unlock
c_func
(paren
op_amp
id|st_dev_arr_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|st_intr
r_static
r_void
id|st_intr
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
)paren
(brace
id|scsi_io_completion
c_func
(paren
id|SCpnt
comma
(paren
id|SCpnt-&gt;result
ques
c_cond
l_int|0
suffix:colon
id|SCpnt-&gt;bufflen
)paren
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * st_init_command: only called via the scsi_cmd_ioctl (block SG_IO)&n; * interface for REQ_BLOCK_PC commands.&n; */
DECL|function|st_init_command
r_static
r_int
id|st_init_command
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
)paren
(brace
r_struct
id|request
op_star
id|rq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|SCpnt-&gt;request-&gt;flags
op_amp
id|REQ_BLOCK_PC
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|rq
op_assign
id|SCpnt-&gt;request
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|rq-&gt;cmd
)paren
OG
r_sizeof
(paren
id|SCpnt-&gt;cmnd
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|SCpnt-&gt;cmnd
comma
id|rq-&gt;cmd
comma
r_sizeof
(paren
id|SCpnt-&gt;cmnd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|rq
)paren
op_eq
id|WRITE
)paren
id|SCpnt-&gt;sc_data_direction
op_assign
id|DMA_TO_DEVICE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rq-&gt;data_len
)paren
id|SCpnt-&gt;sc_data_direction
op_assign
id|DMA_FROM_DEVICE
suffix:semicolon
r_else
id|SCpnt-&gt;sc_data_direction
op_assign
id|DMA_NONE
suffix:semicolon
id|SCpnt-&gt;timeout_per_command
op_assign
id|rq-&gt;timeout
suffix:semicolon
id|SCpnt-&gt;transfersize
op_assign
id|rq-&gt;data_len
suffix:semicolon
id|SCpnt-&gt;done
op_assign
id|st_intr
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|init_st
r_static
r_int
id|__init
id|init_st
c_func
(paren
r_void
)paren
(brace
id|validate_options
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st: Version %s, fixed bufsize %d, s/g segs %d&bslash;n&quot;
comma
id|verstr
comma
id|st_fixed_buffer_size
comma
id|st_max_sg_segs
)paren
suffix:semicolon
id|st_sysfs_class
op_assign
id|class_simple_create
c_func
(paren
id|THIS_MODULE
comma
l_string|&quot;scsi_tape&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|st_sysfs_class
)paren
)paren
(brace
id|st_sysfs_class
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable create sysfs class for SCSI tapes&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|register_chrdev_region
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
l_int|0
)paren
comma
id|ST_MAX_TAPE_ENTRIES
comma
l_string|&quot;st&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|scsi_register_driver
c_func
(paren
op_amp
id|st_template.gendrv
)paren
op_eq
l_int|0
)paren
(brace
id|do_create_driverfs_files
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|st_sysfs_class
)paren
id|class_simple_destroy
c_func
(paren
id|st_sysfs_class
)paren
suffix:semicolon
id|unregister_chrdev_region
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
l_int|0
)paren
comma
id|ST_MAX_TAPE_ENTRIES
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to get major %d for SCSI tapes&bslash;n&quot;
comma
id|SCSI_TAPE_MAJOR
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|exit_st
r_static
r_void
id|__exit
id|exit_st
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|st_sysfs_class
)paren
id|class_simple_destroy
c_func
(paren
id|st_sysfs_class
)paren
suffix:semicolon
id|st_sysfs_class
op_assign
l_int|NULL
suffix:semicolon
id|do_remove_driverfs_files
c_func
(paren
)paren
suffix:semicolon
id|scsi_unregister_driver
c_func
(paren
op_amp
id|st_template.gendrv
)paren
suffix:semicolon
id|unregister_chrdev_region
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
l_int|0
)paren
comma
id|ST_MAX_TAPE_ENTRIES
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|scsi_tapes
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;st: Unloaded.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|init_st
id|module_init
c_func
(paren
id|init_st
)paren
suffix:semicolon
DECL|variable|exit_st
id|module_exit
c_func
(paren
id|exit_st
)paren
suffix:semicolon
multiline_comment|/* The sysfs driver interface. Read-only at the moment */
DECL|function|st_try_direct_io_show
r_static
id|ssize_t
id|st_try_direct_io_show
c_func
(paren
r_struct
id|device_driver
op_star
id|ddp
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|try_direct_io
)paren
suffix:semicolon
)brace
r_static
id|DRIVER_ATTR
c_func
(paren
id|try_direct_io
comma
id|S_IRUGO
comma
id|st_try_direct_io_show
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|st_fixed_buffer_size_show
r_static
id|ssize_t
id|st_fixed_buffer_size_show
c_func
(paren
r_struct
id|device_driver
op_star
id|ddp
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|st_fixed_buffer_size
)paren
suffix:semicolon
)brace
r_static
id|DRIVER_ATTR
c_func
(paren
id|fixed_buffer_size
comma
id|S_IRUGO
comma
id|st_fixed_buffer_size_show
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|st_max_sg_segs_show
r_static
id|ssize_t
id|st_max_sg_segs_show
c_func
(paren
r_struct
id|device_driver
op_star
id|ddp
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|st_max_sg_segs
)paren
suffix:semicolon
)brace
r_static
id|DRIVER_ATTR
c_func
(paren
id|max_sg_segs
comma
id|S_IRUGO
comma
id|st_max_sg_segs_show
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|st_version_show
r_static
id|ssize_t
id|st_version_show
c_func
(paren
r_struct
id|device_driver
op_star
id|ddd
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;[%s]&bslash;n&quot;
comma
id|verstr
)paren
suffix:semicolon
)brace
r_static
id|DRIVER_ATTR
c_func
(paren
id|version
comma
id|S_IRUGO
comma
id|st_version_show
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|do_create_driverfs_files
r_static
r_void
id|do_create_driverfs_files
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_driver
op_star
id|driverfs
op_assign
op_amp
id|st_template.gendrv
suffix:semicolon
id|driver_create_file
c_func
(paren
id|driverfs
comma
op_amp
id|driver_attr_try_direct_io
)paren
suffix:semicolon
id|driver_create_file
c_func
(paren
id|driverfs
comma
op_amp
id|driver_attr_fixed_buffer_size
)paren
suffix:semicolon
id|driver_create_file
c_func
(paren
id|driverfs
comma
op_amp
id|driver_attr_max_sg_segs
)paren
suffix:semicolon
id|driver_create_file
c_func
(paren
id|driverfs
comma
op_amp
id|driver_attr_version
)paren
suffix:semicolon
)brace
DECL|function|do_remove_driverfs_files
r_static
r_void
id|do_remove_driverfs_files
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_driver
op_star
id|driverfs
op_assign
op_amp
id|st_template.gendrv
suffix:semicolon
id|driver_remove_file
c_func
(paren
id|driverfs
comma
op_amp
id|driver_attr_version
)paren
suffix:semicolon
id|driver_remove_file
c_func
(paren
id|driverfs
comma
op_amp
id|driver_attr_max_sg_segs
)paren
suffix:semicolon
id|driver_remove_file
c_func
(paren
id|driverfs
comma
op_amp
id|driver_attr_fixed_buffer_size
)paren
suffix:semicolon
id|driver_remove_file
c_func
(paren
id|driverfs
comma
op_amp
id|driver_attr_try_direct_io
)paren
suffix:semicolon
)brace
multiline_comment|/* The sysfs simple class interface */
DECL|function|st_defined_show
r_static
id|ssize_t
id|st_defined_show
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|st_modedef
op_star
id|STm
op_assign
(paren
r_struct
id|st_modedef
op_star
)paren
id|class_get_devdata
c_func
(paren
id|class_dev
)paren
suffix:semicolon
id|ssize_t
id|l
op_assign
l_int|0
suffix:semicolon
id|l
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|STm-&gt;defined
)paren
suffix:semicolon
r_return
id|l
suffix:semicolon
)brace
id|CLASS_DEVICE_ATTR
c_func
(paren
id|defined
comma
id|S_IRUGO
comma
id|st_defined_show
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|st_defblk_show
r_static
id|ssize_t
id|st_defblk_show
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|st_modedef
op_star
id|STm
op_assign
(paren
r_struct
id|st_modedef
op_star
)paren
id|class_get_devdata
c_func
(paren
id|class_dev
)paren
suffix:semicolon
id|ssize_t
id|l
op_assign
l_int|0
suffix:semicolon
id|l
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|STm-&gt;default_blksize
)paren
suffix:semicolon
r_return
id|l
suffix:semicolon
)brace
id|CLASS_DEVICE_ATTR
c_func
(paren
id|default_blksize
comma
id|S_IRUGO
comma
id|st_defblk_show
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|st_defdensity_show
r_static
id|ssize_t
id|st_defdensity_show
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|st_modedef
op_star
id|STm
op_assign
(paren
r_struct
id|st_modedef
op_star
)paren
id|class_get_devdata
c_func
(paren
id|class_dev
)paren
suffix:semicolon
id|ssize_t
id|l
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|fmt
suffix:semicolon
id|fmt
op_assign
id|STm-&gt;default_density
op_ge
l_int|0
ques
c_cond
l_string|&quot;0x%02x&bslash;n&quot;
suffix:colon
l_string|&quot;%d&bslash;n&quot;
suffix:semicolon
id|l
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
id|fmt
comma
id|STm-&gt;default_density
)paren
suffix:semicolon
r_return
id|l
suffix:semicolon
)brace
id|CLASS_DEVICE_ATTR
c_func
(paren
id|default_density
comma
id|S_IRUGO
comma
id|st_defdensity_show
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|st_defcompression_show
r_static
id|ssize_t
id|st_defcompression_show
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|st_modedef
op_star
id|STm
op_assign
(paren
r_struct
id|st_modedef
op_star
)paren
id|class_get_devdata
c_func
(paren
id|class_dev
)paren
suffix:semicolon
id|ssize_t
id|l
op_assign
l_int|0
suffix:semicolon
id|l
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|STm-&gt;default_compression
op_minus
l_int|1
)paren
suffix:semicolon
r_return
id|l
suffix:semicolon
)brace
id|CLASS_DEVICE_ATTR
c_func
(paren
id|default_compression
comma
id|S_IRUGO
comma
id|st_defcompression_show
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|do_create_class_files
r_static
r_void
id|do_create_class_files
c_func
(paren
r_struct
id|scsi_tape
op_star
id|STp
comma
r_int
id|dev_num
comma
r_int
id|mode
)paren
(brace
r_int
id|i
comma
id|rew
comma
id|error
suffix:semicolon
r_char
id|name
(braket
l_int|10
)braket
suffix:semicolon
r_struct
id|class_device
op_star
id|st_class_member
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_sysfs_class
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|rew
op_assign
l_int|0
suffix:semicolon
id|rew
OL
l_int|2
suffix:semicolon
id|rew
op_increment
)paren
(brace
multiline_comment|/* Make sure that the minor numbers corresponding to the four&n;&t;&t;   first modes always get the same names */
id|i
op_assign
id|mode
op_lshift
(paren
l_int|4
op_minus
id|ST_NBR_MODE_BITS
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|name
comma
l_int|10
comma
l_string|&quot;%s%s%s&quot;
comma
id|rew
ques
c_cond
l_string|&quot;n&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|STp-&gt;disk-&gt;disk_name
comma
id|st_formats
(braket
id|i
)braket
)paren
suffix:semicolon
id|st_class_member
op_assign
id|class_simple_device_add
c_func
(paren
id|st_sysfs_class
comma
id|MKDEV
c_func
(paren
id|SCSI_TAPE_MAJOR
comma
id|TAPE_MINOR
c_func
(paren
id|dev_num
comma
id|mode
comma
id|rew
)paren
)paren
comma
op_amp
id|STp-&gt;device-&gt;sdev_gendev
comma
l_string|&quot;%s&quot;
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|st_class_member
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;st%d: class_simple_device_add failed&bslash;n&quot;
comma
id|dev_num
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|class_set_devdata
c_func
(paren
id|st_class_member
comma
op_amp
id|STp-&gt;modes
(braket
id|mode
)braket
)paren
suffix:semicolon
id|class_device_create_file
c_func
(paren
id|st_class_member
comma
op_amp
id|class_device_attr_defined
)paren
suffix:semicolon
id|class_device_create_file
c_func
(paren
id|st_class_member
comma
op_amp
id|class_device_attr_default_blksize
)paren
suffix:semicolon
id|class_device_create_file
c_func
(paren
id|st_class_member
comma
op_amp
id|class_device_attr_default_density
)paren
suffix:semicolon
id|class_device_create_file
c_func
(paren
id|st_class_member
comma
op_amp
id|class_device_attr_default_compression
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
l_int|0
op_logical_and
id|rew
op_eq
l_int|0
)paren
(brace
id|error
op_assign
id|sysfs_create_link
c_func
(paren
op_amp
id|STp-&gt;device-&gt;sdev_gendev.kobj
comma
op_amp
id|st_class_member-&gt;kobj
comma
l_string|&quot;tape&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;st%d: Can&squot;t create sysfs link from SCSI device.&bslash;n&quot;
comma
id|dev_num
)paren
suffix:semicolon
)brace
)brace
)brace
id|out
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/* Pin down user pages and put them into a scatter gather list. Returns &lt;= 0 if&n;   - mapping of all pages not successful&n;   - any page is above max_pfn&n;   (i.e., either completely successful or fails)&n;*/
DECL|function|st_map_user_pages
r_static
r_int
id|st_map_user_pages
c_func
(paren
r_struct
id|scatterlist
op_star
id|sgl
comma
r_const
r_int
r_int
id|max_pages
comma
r_int
r_int
id|uaddr
comma
r_int
id|count
comma
r_int
id|rw
comma
r_int
r_int
id|max_pfn
)paren
(brace
r_int
id|i
comma
id|nr_pages
suffix:semicolon
id|nr_pages
op_assign
id|sgl_map_user_pages
c_func
(paren
id|sgl
comma
id|max_pages
comma
id|uaddr
comma
id|count
comma
id|rw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nr_pages
op_le
l_int|0
)paren
r_return
id|nr_pages
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_pages
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|page_to_pfn
c_func
(paren
id|sgl
(braket
id|i
)braket
dot
id|page
)paren
OG
id|max_pfn
)paren
r_goto
id|out_unmap
suffix:semicolon
)brace
r_return
id|nr_pages
suffix:semicolon
id|out_unmap
suffix:colon
id|sgl_unmap_user_pages
c_func
(paren
id|sgl
comma
id|nr_pages
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The following functions may be useful for a larger audience. */
DECL|function|sgl_map_user_pages
r_static
r_int
id|sgl_map_user_pages
c_func
(paren
r_struct
id|scatterlist
op_star
id|sgl
comma
r_const
r_int
r_int
id|max_pages
comma
r_int
r_int
id|uaddr
comma
r_int
id|count
comma
r_int
id|rw
)paren
(brace
r_int
id|res
comma
id|i
comma
id|j
suffix:semicolon
r_int
r_int
id|nr_pages
suffix:semicolon
r_struct
id|page
op_star
op_star
id|pages
suffix:semicolon
id|nr_pages
op_assign
(paren
(paren
id|uaddr
op_amp
op_complement
id|PAGE_MASK
)paren
op_plus
id|count
op_plus
op_complement
id|PAGE_MASK
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
multiline_comment|/* User attempted Overflow! */
r_if
c_cond
(paren
(paren
id|uaddr
op_plus
id|count
)paren
OL
id|uaddr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Too big */
r_if
c_cond
(paren
id|nr_pages
OG
id|max_pages
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Hmm? */
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pages
op_assign
id|kmalloc
c_func
(paren
id|max_pages
op_star
r_sizeof
(paren
op_star
id|pages
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Try to fault in all of the necessary pages */
id|down_read
c_func
(paren
op_amp
id|current-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
multiline_comment|/* rw==READ means read from drive, write into memory area */
id|res
op_assign
id|get_user_pages
c_func
(paren
id|current
comma
id|current-&gt;mm
comma
id|uaddr
comma
id|nr_pages
comma
id|rw
op_eq
id|READ
comma
l_int|0
comma
multiline_comment|/* don&squot;t force */
id|pages
comma
l_int|NULL
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|current-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
multiline_comment|/* Errors and no page mapped should return here */
r_if
c_cond
(paren
id|res
OL
id|nr_pages
)paren
r_goto
id|out_unmap
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_pages
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* FIXME: flush superflous for rw==READ,&n;                 * probably wrong function for rw==WRITE&n;                 */
id|flush_dcache_page
c_func
(paren
id|pages
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Populate the scatter/gather list */
id|sgl
(braket
l_int|0
)braket
dot
id|page
op_assign
id|pages
(braket
l_int|0
)braket
suffix:semicolon
id|sgl
(braket
l_int|0
)braket
dot
id|offset
op_assign
id|uaddr
op_amp
op_complement
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|nr_pages
OG
l_int|1
)paren
(brace
id|sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
id|PAGE_SIZE
op_minus
id|sgl
(braket
l_int|0
)braket
dot
id|offset
suffix:semicolon
id|count
op_sub_assign
id|sgl
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|nr_pages
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sgl
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
id|sgl
(braket
id|i
)braket
dot
id|page
op_assign
id|pages
(braket
id|i
)braket
suffix:semicolon
id|sgl
(braket
id|i
)braket
dot
id|length
op_assign
id|count
OL
id|PAGE_SIZE
ques
c_cond
id|count
suffix:colon
id|PAGE_SIZE
suffix:semicolon
id|count
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
r_else
(brace
id|sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
id|count
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|pages
)paren
suffix:semicolon
r_return
id|nr_pages
suffix:semicolon
id|out_unmap
suffix:colon
r_if
c_cond
(paren
id|res
OG
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|res
suffix:semicolon
id|j
op_increment
)paren
id|page_cache_release
c_func
(paren
id|pages
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|pages
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* And unmap them... */
DECL|function|sgl_unmap_user_pages
r_static
r_int
id|sgl_unmap_user_pages
c_func
(paren
r_struct
id|scatterlist
op_star
id|sgl
comma
r_const
r_int
r_int
id|nr_pages
comma
r_int
id|dirtied
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_pages
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dirtied
op_logical_and
op_logical_neg
id|PageReserved
c_func
(paren
id|sgl
(braket
id|i
)braket
dot
id|page
)paren
)paren
id|SetPageDirty
c_func
(paren
id|sgl
(braket
id|i
)braket
dot
id|page
)paren
suffix:semicolon
multiline_comment|/* FIXME: cache flush missing for rw==READ&n;&t;&t; * FIXME: call the correct reference counting function&n;&t;&t; */
id|page_cache_release
c_func
(paren
id|sgl
(braket
id|i
)braket
dot
id|page
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
