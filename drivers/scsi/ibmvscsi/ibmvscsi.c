multiline_comment|/* ------------------------------------------------------------&n; * ibmvscsi.c&n; * (C) Copyright IBM Corporation 1994, 2004&n; * Authors: Colin DeVilbiss (devilbis@us.ibm.com)&n; *          Santiago Leon (santil@us.ibm.com)&n; *          Dave Boutcher (sleddog@us.ibm.com)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307&n; * USA&n; *&n; * ------------------------------------------------------------&n; * Emulation of a SCSI host adapter for Virtual I/O devices&n; *&n; * This driver supports the SCSI adapter implemented by the IBM&n; * Power5 firmware.  That SCSI adapter is not a physical adapter,&n; * but allows Linux SCSI peripheral drivers to directly&n; * access devices in another logical partition on the physical system.&n; *&n; * The virtual adapter(s) are present in the open firmware device&n; * tree just like real adapters.&n; *&n; * One of the capabilities provided on these systems is the ability&n; * to DMA between partitions.  The architecture states that for VSCSI,&n; * the server side is allowed to DMA to and from the client.  The client&n; * is never trusted to DMA to or from the server directly.&n; *&n; * Messages are sent between partitions on a &quot;Command/Response Queue&quot; &n; * (CRQ), which is just a buffer of 16 byte entries in the receiver&squot;s &n; * Senders cannot access the buffer directly, but send messages by&n; * making a hypervisor call and passing in the 16 bytes.  The hypervisor&n; * puts the message in the next 16 byte space in round-robbin fashion,&n; * turns on the high order bit of the message (the valid bit), and &n; * generates an interrupt to the receiver (if interrupts are turned on.) &n; * The receiver just turns off the valid bit when they have copied out&n; * the message.&n; *&n; * The VSCSI client builds a SCSI Remote Protocol (SRP) Information Unit&n; * (IU) (as defined in the T10 standard available at www.t10.org), gets &n; * a DMA address for the message, and sends it to the server as the&n; * payload of a CRQ message.  The server DMAs the SRP IU and processes it,&n; * including doing any additional data transfers.  When it is done, it&n; * DMAs the SRP response back to the same address as the request came from,&n; * and sends a CRQ message back to inform the client that the request has&n; * completed.&n; *&n; * Note that some of the underlying infrastructure is different between&n; * machines conforming to the &quot;RS/6000 Platform Architecture&quot; (RPA) and&n; * the older iSeries hypervisor models.  To support both, some low level&n; * routines have been broken out into rpa_vscsi.c and iseries_vscsi.c.&n; * The Makefile should pick one, not two, not zero, of these.&n; *&n; * TODO: This is currently pretty tied to the IBM i/pSeries hypervisor&n; * interfaces.  It would be really nice to abstract this above an RDMA&n; * layer.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/vio.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_cmnd.h&gt;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsi_device.h&gt;
macro_line|#include &quot;ibmvscsi.h&quot;
multiline_comment|/* The values below are somewhat arbitrary default values, but &n; * OS/400 will use 3 busses (disks, CDs, tapes, I think.)&n; * Note that there are 3 bits of channel value, 6 bits of id, and&n; * 5 bits of LUN.&n; */
DECL|variable|max_id
r_static
r_int
id|max_id
op_assign
l_int|64
suffix:semicolon
DECL|variable|max_channel
r_static
r_int
id|max_channel
op_assign
l_int|3
suffix:semicolon
DECL|variable|init_timeout
r_static
r_int
id|init_timeout
op_assign
l_int|5
suffix:semicolon
DECL|variable|max_requests
r_static
r_int
id|max_requests
op_assign
l_int|50
suffix:semicolon
DECL|macro|IBMVSCSI_VERSION
mdefine_line|#define IBMVSCSI_VERSION &quot;1.5.1&quot;
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IBM Virtual SCSI&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Dave Boutcher&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|IBMVSCSI_VERSION
id|MODULE_VERSION
c_func
(paren
id|IBMVSCSI_VERSION
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|max_id
comma
id|max_id
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_id
comma
l_string|&quot;Largest ID value for each channel&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|max_channel
comma
id|max_channel
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_channel
comma
l_string|&quot;Largest channel value&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|init_timeout
comma
id|init_timeout
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|init_timeout
comma
l_string|&quot;Initialization timeout in seconds&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|max_requests
comma
id|max_requests
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_requests
comma
l_string|&quot;Maximum requests for this adapter&quot;
)paren
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------&n; * Routines for the event pool and event structs&n; */
multiline_comment|/**&n; * initialize_event_pool: - Allocates and initializes the event pool for a host&n; * @pool:&t;event_pool to be initialized&n; * @size:&t;Number of events in pool&n; * @hostdata:&t;ibmvscsi_host_data who owns the event pool&n; *&n; * Returns zero on success.&n;*/
DECL|function|initialize_event_pool
r_static
r_int
id|initialize_event_pool
c_func
(paren
r_struct
id|event_pool
op_star
id|pool
comma
r_int
id|size
comma
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
)paren
(brace
r_int
id|i
suffix:semicolon
id|pool-&gt;size
op_assign
id|size
suffix:semicolon
id|pool-&gt;next
op_assign
l_int|0
suffix:semicolon
id|pool-&gt;events
op_assign
id|kmalloc
c_func
(paren
id|pool-&gt;size
op_star
r_sizeof
(paren
op_star
id|pool-&gt;events
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pool-&gt;events
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|pool-&gt;events
comma
l_int|0x00
comma
id|pool-&gt;size
op_star
r_sizeof
(paren
op_star
id|pool-&gt;events
)paren
)paren
suffix:semicolon
id|pool-&gt;iu_storage
op_assign
id|dma_alloc_coherent
c_func
(paren
id|hostdata-&gt;dev
comma
id|pool-&gt;size
op_star
r_sizeof
(paren
op_star
id|pool-&gt;iu_storage
)paren
comma
op_amp
id|pool-&gt;iu_token
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pool-&gt;iu_storage
)paren
(brace
id|kfree
c_func
(paren
id|pool-&gt;events
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pool-&gt;size
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|srp_event_struct
op_star
id|evt
op_assign
op_amp
id|pool-&gt;events
(braket
id|i
)braket
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|evt-&gt;crq
comma
l_int|0x00
comma
r_sizeof
(paren
id|evt-&gt;crq
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|evt-&gt;free
comma
l_int|1
)paren
suffix:semicolon
id|evt-&gt;crq.valid
op_assign
l_int|0x80
suffix:semicolon
id|evt-&gt;crq.IU_length
op_assign
r_sizeof
(paren
op_star
id|evt-&gt;xfer_iu
)paren
suffix:semicolon
id|evt-&gt;crq.IU_data_ptr
op_assign
id|pool-&gt;iu_token
op_plus
r_sizeof
(paren
op_star
id|evt-&gt;xfer_iu
)paren
op_star
id|i
suffix:semicolon
id|evt-&gt;xfer_iu
op_assign
id|pool-&gt;iu_storage
op_plus
id|i
suffix:semicolon
id|evt-&gt;hostdata
op_assign
id|hostdata
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * release_event_pool: - Frees memory of an event pool of a host&n; * @pool:&t;event_pool to be released&n; * @hostdata:&t;ibmvscsi_host_data who owns the even pool&n; *&n; * Returns zero on success.&n;*/
DECL|function|release_event_pool
r_static
r_void
id|release_event_pool
c_func
(paren
r_struct
id|event_pool
op_star
id|pool
comma
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
)paren
(brace
r_int
id|i
comma
id|in_use
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pool-&gt;size
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|pool-&gt;events
(braket
id|i
)braket
dot
id|free
)paren
op_ne
l_int|1
)paren
op_increment
id|in_use
suffix:semicolon
r_if
c_cond
(paren
id|in_use
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ibmvscsi: releasing event pool with %d &quot;
l_string|&quot;events still in use?&bslash;n&quot;
comma
id|in_use
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pool-&gt;events
)paren
suffix:semicolon
id|dma_free_coherent
c_func
(paren
id|hostdata-&gt;dev
comma
id|pool-&gt;size
op_star
r_sizeof
(paren
op_star
id|pool-&gt;iu_storage
)paren
comma
id|pool-&gt;iu_storage
comma
id|pool-&gt;iu_token
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * valid_event_struct: - Determines if event is valid.&n; * @pool:&t;event_pool that contains the event&n; * @evt:&t;srp_event_struct to be checked for validity&n; *&n; * Returns zero if event is invalid, one otherwise.&n;*/
DECL|function|valid_event_struct
r_static
r_int
id|valid_event_struct
c_func
(paren
r_struct
id|event_pool
op_star
id|pool
comma
r_struct
id|srp_event_struct
op_star
id|evt
)paren
(brace
r_int
id|index
op_assign
id|evt
op_minus
id|pool-&gt;events
suffix:semicolon
r_if
c_cond
(paren
id|index
OL
l_int|0
op_logical_or
id|index
op_ge
id|pool-&gt;size
)paren
multiline_comment|/* outside of bounds */
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|evt
op_ne
id|pool-&gt;events
op_plus
id|index
)paren
multiline_comment|/* unaligned */
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * ibmvscsi_free-event_struct: - Changes status of event to &quot;free&quot;&n; * @pool:&t;event_pool that contains the event&n; * @evt:&t;srp_event_struct to be modified&n; *&n;*/
DECL|function|free_event_struct
r_static
r_void
id|free_event_struct
c_func
(paren
r_struct
id|event_pool
op_star
id|pool
comma
r_struct
id|srp_event_struct
op_star
id|evt
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|valid_event_struct
c_func
(paren
id|pool
comma
id|evt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: Freeing invalid event_struct %p &quot;
l_string|&quot;(not in pool %p)&bslash;n&quot;
comma
id|evt
comma
id|pool-&gt;events
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_inc_return
c_func
(paren
op_amp
id|evt-&gt;free
)paren
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: Freeing event_struct %p &quot;
l_string|&quot;which is not in use!&bslash;n&quot;
comma
id|evt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * get_evt_struct: - Gets the next free event in pool&n; * @pool:&t;event_pool that contains the events to be searched&n; *&n; * Returns the next event in &quot;free&quot; state, and NULL if none are free.&n; * Note that no synchronization is done here, we assume the host_lock&n; * will syncrhonze things.&n;*/
DECL|function|get_event_struct
r_static
r_struct
id|srp_event_struct
op_star
id|get_event_struct
c_func
(paren
r_struct
id|event_pool
op_star
id|pool
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|poolsize
op_assign
id|pool-&gt;size
suffix:semicolon
r_int
id|offset
op_assign
id|pool-&gt;next
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|poolsize
suffix:semicolon
id|i
op_increment
)paren
(brace
id|offset
op_assign
(paren
id|offset
op_plus
l_int|1
)paren
op_mod
id|poolsize
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_dec_if_positive
c_func
(paren
op_amp
id|pool-&gt;events
(braket
id|offset
)braket
dot
id|free
)paren
)paren
(brace
id|pool-&gt;next
op_assign
id|offset
suffix:semicolon
r_return
op_amp
id|pool-&gt;events
(braket
id|offset
)braket
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: found no event struct in pool!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * init_event_struct: Initialize fields in an event struct that are always &n; *                    required.&n; * @evt:        The event&n; * @done:       Routine to call when the event is responded to&n; * @format:     SRP or MAD format&n; * @timeout:    timeout value set in the CRQ&n; */
DECL|function|init_event_struct
r_static
r_void
id|init_event_struct
c_func
(paren
r_struct
id|srp_event_struct
op_star
id|evt_struct
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|srp_event_struct
op_star
)paren
comma
id|u8
id|format
comma
r_int
id|timeout
)paren
(brace
id|evt_struct-&gt;cmnd
op_assign
l_int|NULL
suffix:semicolon
id|evt_struct-&gt;cmnd_done
op_assign
l_int|NULL
suffix:semicolon
id|evt_struct-&gt;crq.format
op_assign
id|format
suffix:semicolon
id|evt_struct-&gt;crq.timeout
op_assign
id|timeout
suffix:semicolon
id|evt_struct-&gt;done
op_assign
id|done
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------&n; * Routines for receiving SCSI responses from the hosting partition&n; */
multiline_comment|/**&n; * set_srp_direction: Set the fields in the srp related to data&n; *     direction and number of buffers based on the direction in&n; *     the scsi_cmnd and the number of buffers&n; */
DECL|function|set_srp_direction
r_static
r_void
id|set_srp_direction
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_struct
id|srp_cmd
op_star
id|srp_cmd
comma
r_int
id|numbuf
)paren
(brace
r_if
c_cond
(paren
id|numbuf
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|numbuf
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|cmd-&gt;sc_data_direction
op_eq
id|DMA_TO_DEVICE
)paren
id|srp_cmd-&gt;data_out_format
op_assign
id|SRP_DIRECT_BUFFER
suffix:semicolon
r_else
id|srp_cmd-&gt;data_in_format
op_assign
id|SRP_DIRECT_BUFFER
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|cmd-&gt;sc_data_direction
op_eq
id|DMA_TO_DEVICE
)paren
(brace
id|srp_cmd-&gt;data_out_format
op_assign
id|SRP_INDIRECT_BUFFER
suffix:semicolon
id|srp_cmd-&gt;data_out_count
op_assign
id|numbuf
suffix:semicolon
)brace
r_else
(brace
id|srp_cmd-&gt;data_in_format
op_assign
id|SRP_INDIRECT_BUFFER
suffix:semicolon
id|srp_cmd-&gt;data_in_count
op_assign
id|numbuf
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * unmap_cmd_data: - Unmap data pointed in srp_cmd based on the format&n; * @cmd:&t;srp_cmd whose additional_data member will be unmapped&n; * @dev:&t;device for which the memory is mapped&n; *&n;*/
DECL|function|unmap_cmd_data
r_static
r_void
id|unmap_cmd_data
c_func
(paren
r_struct
id|srp_cmd
op_star
id|cmd
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd-&gt;data_out_format
op_eq
id|SRP_NO_BUFFER
)paren
op_logical_and
(paren
id|cmd-&gt;data_in_format
op_eq
id|SRP_NO_BUFFER
)paren
)paren
r_return
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|cmd-&gt;data_out_format
op_eq
id|SRP_DIRECT_BUFFER
)paren
op_logical_or
(paren
id|cmd-&gt;data_in_format
op_eq
id|SRP_DIRECT_BUFFER
)paren
)paren
(brace
r_struct
id|memory_descriptor
op_star
id|data
op_assign
(paren
r_struct
id|memory_descriptor
op_star
)paren
id|cmd-&gt;additional_data
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|dev
comma
id|data-&gt;virtual_address
comma
id|data-&gt;length
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|indirect_descriptor
op_star
id|indirect
op_assign
(paren
r_struct
id|indirect_descriptor
op_star
)paren
id|cmd-&gt;additional_data
suffix:semicolon
r_int
id|num_mapped
op_assign
id|indirect-&gt;head.length
op_div
r_sizeof
(paren
id|indirect-&gt;list
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_mapped
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|memory_descriptor
op_star
id|data
op_assign
op_amp
id|indirect-&gt;list
(braket
id|i
)braket
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|dev
comma
id|data-&gt;virtual_address
comma
id|data-&gt;length
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * map_sg_data: - Maps dma for a scatterlist and initializes decriptor fields&n; * @cmd:&t;Scsi_Cmnd with the scatterlist&n; * @srp_cmd:&t;srp_cmd that contains the memory descriptor&n; * @dev:&t;device for which to map dma memory&n; *&n; * Called by map_data_for_srp_cmd() when building srp cmd from scsi cmd.&n; * Returns 1 on success.&n;*/
DECL|function|map_sg_data
r_static
r_int
id|map_sg_data
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_struct
id|srp_cmd
op_star
id|srp_cmd
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
comma
id|sg_mapped
suffix:semicolon
id|u64
id|total_length
op_assign
l_int|0
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
id|cmd-&gt;request_buffer
suffix:semicolon
r_struct
id|memory_descriptor
op_star
id|data
op_assign
(paren
r_struct
id|memory_descriptor
op_star
)paren
id|srp_cmd-&gt;additional_data
suffix:semicolon
r_struct
id|indirect_descriptor
op_star
id|indirect
op_assign
(paren
r_struct
id|indirect_descriptor
op_star
)paren
id|data
suffix:semicolon
id|sg_mapped
op_assign
id|dma_map_sg
c_func
(paren
id|dev
comma
id|sg
comma
id|cmd-&gt;use_sg
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_mapped
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|set_srp_direction
c_func
(paren
id|cmd
comma
id|srp_cmd
comma
id|sg_mapped
)paren
suffix:semicolon
multiline_comment|/* special case; we can use a single direct descriptor */
r_if
c_cond
(paren
id|sg_mapped
op_eq
l_int|1
)paren
(brace
id|data-&gt;virtual_address
op_assign
id|sg_dma_address
c_func
(paren
op_amp
id|sg
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|data-&gt;length
op_assign
id|sg_dma_len
c_func
(paren
op_amp
id|sg
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|data-&gt;memory_handle
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sg_mapped
OG
id|MAX_INDIRECT_BUFS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: More than %d mapped sg entries, got %d&bslash;n&quot;
comma
id|MAX_INDIRECT_BUFS
comma
id|sg_mapped
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|indirect-&gt;head.virtual_address
op_assign
l_int|0
suffix:semicolon
id|indirect-&gt;head.length
op_assign
id|sg_mapped
op_star
r_sizeof
(paren
id|indirect-&gt;list
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|indirect-&gt;head.memory_handle
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sg_mapped
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|memory_descriptor
op_star
id|descr
op_assign
op_amp
id|indirect-&gt;list
(braket
id|i
)braket
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg_entry
op_assign
op_amp
id|sg
(braket
id|i
)braket
suffix:semicolon
id|descr-&gt;virtual_address
op_assign
id|sg_dma_address
c_func
(paren
id|sg_entry
)paren
suffix:semicolon
id|descr-&gt;length
op_assign
id|sg_dma_len
c_func
(paren
id|sg_entry
)paren
suffix:semicolon
id|descr-&gt;memory_handle
op_assign
l_int|0
suffix:semicolon
id|total_length
op_add_assign
id|sg_dma_len
c_func
(paren
id|sg_entry
)paren
suffix:semicolon
)brace
id|indirect-&gt;total_length
op_assign
id|total_length
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * map_single_data: - Maps memory and initializes memory decriptor fields&n; * @cmd:&t;struct scsi_cmnd with the memory to be mapped&n; * @srp_cmd:&t;srp_cmd that contains the memory descriptor&n; * @dev:&t;device for which to map dma memory&n; *&n; * Called by map_data_for_srp_cmd() when building srp cmd from scsi cmd.&n; * Returns 1 on success.&n;*/
DECL|function|map_single_data
r_static
r_int
id|map_single_data
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_struct
id|srp_cmd
op_star
id|srp_cmd
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|memory_descriptor
op_star
id|data
op_assign
(paren
r_struct
id|memory_descriptor
op_star
)paren
id|srp_cmd-&gt;additional_data
suffix:semicolon
id|data-&gt;virtual_address
op_assign
id|dma_map_single
c_func
(paren
id|dev
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;request_bufflen
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_mapping_error
c_func
(paren
id|data-&gt;virtual_address
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: Unable to map request_buffer for command!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|data-&gt;length
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
id|data-&gt;memory_handle
op_assign
l_int|0
suffix:semicolon
id|set_srp_direction
c_func
(paren
id|cmd
comma
id|srp_cmd
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * map_data_for_srp_cmd: - Calls functions to map data for srp cmds&n; * @cmd:&t;struct scsi_cmnd with the memory to be mapped&n; * @srp_cmd:&t;srp_cmd that contains the memory descriptor&n; * @dev:&t;dma device for which to map dma memory&n; *&n; * Called by scsi_cmd_to_srp_cmd() when converting scsi cmds to srp cmds &n; * Returns 1 on success.&n;*/
DECL|function|map_data_for_srp_cmd
r_static
r_int
id|map_data_for_srp_cmd
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_struct
id|srp_cmd
op_star
id|srp_cmd
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_switch
c_cond
(paren
id|cmd-&gt;sc_data_direction
)paren
(brace
r_case
id|DMA_FROM_DEVICE
suffix:colon
r_case
id|DMA_TO_DEVICE
suffix:colon
r_break
suffix:semicolon
r_case
id|DMA_NONE
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|DMA_BIDIRECTIONAL
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: Can&squot;t map DMA_BIDIRECTIONAL to read/write&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: Unknown data direction 0x%02x; can&squot;t map!&bslash;n&quot;
comma
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cmd-&gt;request_buffer
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
r_return
id|map_sg_data
c_func
(paren
id|cmd
comma
id|srp_cmd
comma
id|dev
)paren
suffix:semicolon
r_return
id|map_single_data
c_func
(paren
id|cmd
comma
id|srp_cmd
comma
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------&n; * Routines for sending and receiving SRPs&n; */
multiline_comment|/**&n; * ibmvscsi_send_srp_event: - Transforms event to u64 array and calls send_crq()&n; * @evt_struct:&t;evt_struct to be sent&n; * @hostdata:&t;ibmvscsi_host_data of host&n; *&n; * Returns the value returned from ibmvscsi_send_crq(). (Zero for success)&n; * Note that this routine assumes that host_lock is held for synchronization&n;*/
DECL|function|ibmvscsi_send_srp_event
r_static
r_int
id|ibmvscsi_send_srp_event
c_func
(paren
r_struct
id|srp_event_struct
op_star
id|evt_struct
comma
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|cmnd
op_assign
id|evt_struct-&gt;cmnd
suffix:semicolon
id|u64
op_star
id|crq_as_u64
op_assign
(paren
id|u64
op_star
)paren
op_amp
id|evt_struct-&gt;crq
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* If we have exhausted our request limit, just fail this request.&n;&t; * Note that there are rare cases involving driver generated requests &n;&t; * (such as task management requests) that the mid layer may think we&n;&t; * can handle more requests (can_queue) when we actually can&squot;t&n;&t; */
r_if
c_cond
(paren
(paren
id|evt_struct-&gt;crq.format
op_eq
id|VIOSRP_SRP_FORMAT
)paren
op_logical_and
(paren
id|atomic_dec_if_positive
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
)paren
OL
l_int|0
)paren
)paren
(brace
multiline_comment|/* See if the adapter is disabled */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cmnd
)paren
id|cmnd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|evt_struct-&gt;cmnd_done
)paren
id|evt_struct
op_member_access_from_pointer
id|cmnd_done
c_func
(paren
id|cmnd
)paren
suffix:semicolon
id|unmap_cmd_data
c_func
(paren
op_amp
id|evt_struct-&gt;iu.srp.cmd
comma
id|hostdata-&gt;dev
)paren
suffix:semicolon
id|free_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
comma
id|evt_struct
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;ibmvscsi: Warning, request_limit exceeded&bslash;n&quot;
)paren
suffix:semicolon
id|unmap_cmd_data
c_func
(paren
op_amp
id|evt_struct-&gt;iu.srp.cmd
comma
id|hostdata-&gt;dev
)paren
suffix:semicolon
id|free_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
comma
id|evt_struct
)paren
suffix:semicolon
r_return
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
)brace
)brace
multiline_comment|/* Copy the IU into the transfer area */
op_star
id|evt_struct-&gt;xfer_iu
op_assign
id|evt_struct-&gt;iu
suffix:semicolon
id|evt_struct-&gt;xfer_iu-&gt;srp.generic.tag
op_assign
(paren
id|u64
)paren
id|evt_struct
suffix:semicolon
multiline_comment|/* Add this to the sent list.  We need to do this &n;&t; * before we actually send &n;&t; * in case it comes back REALLY fast&n;&t; */
id|list_add_tail
c_func
(paren
op_amp
id|evt_struct-&gt;list
comma
op_amp
id|hostdata-&gt;sent
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ibmvscsi_send_crq
c_func
(paren
id|hostdata
comma
id|crq_as_u64
(braket
l_int|0
)braket
comma
id|crq_as_u64
(braket
l_int|1
)braket
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|evt_struct-&gt;list
)paren
suffix:semicolon
id|cmnd
op_assign
id|evt_struct-&gt;cmnd
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: failed to send event struct rc %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|unmap_cmd_data
c_func
(paren
op_amp
id|evt_struct-&gt;iu.srp.cmd
comma
id|hostdata-&gt;dev
)paren
suffix:semicolon
id|free_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
comma
id|evt_struct
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmnd
)paren
id|cmnd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|evt_struct-&gt;cmnd_done
)paren
id|evt_struct
op_member_access_from_pointer
id|cmnd_done
c_func
(paren
id|cmnd
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * handle_cmd_rsp: -  Handle responses from commands&n; * @evt_struct:&t;srp_event_struct to be handled&n; *&n; * Used as a callback by when sending scsi cmds.&n; * Gets called by ibmvscsi_handle_crq()&n;*/
DECL|function|handle_cmd_rsp
r_static
r_void
id|handle_cmd_rsp
c_func
(paren
r_struct
id|srp_event_struct
op_star
id|evt_struct
)paren
(brace
r_struct
id|srp_rsp
op_star
id|rsp
op_assign
op_amp
id|evt_struct-&gt;xfer_iu-&gt;srp.rsp
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmnd
op_assign
id|evt_struct-&gt;cmnd
suffix:semicolon
r_if
c_cond
(paren
id|cmnd
)paren
(brace
id|cmnd-&gt;result
op_assign
id|rsp-&gt;status
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|cmnd-&gt;result
op_rshift
l_int|1
)paren
op_amp
l_int|0x1f
)paren
op_eq
id|CHECK_CONDITION
)paren
id|memcpy
c_func
(paren
id|cmnd-&gt;sense_buffer
comma
id|rsp-&gt;sense_and_response_data
comma
id|rsp-&gt;sense_data_list_length
)paren
suffix:semicolon
id|unmap_cmd_data
c_func
(paren
op_amp
id|evt_struct-&gt;iu.srp.cmd
comma
id|evt_struct-&gt;hostdata-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rsp-&gt;doover
)paren
id|cmnd-&gt;resid
op_assign
id|rsp-&gt;data_out_residual_count
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rsp-&gt;diover
)paren
id|cmnd-&gt;resid
op_assign
id|rsp-&gt;data_in_residual_count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|evt_struct-&gt;cmnd_done
)paren
id|evt_struct
op_member_access_from_pointer
id|cmnd_done
c_func
(paren
id|cmnd
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * lun_from_dev: - Returns the lun of the scsi device&n; * @dev:&t;struct scsi_device&n; *&n;*/
DECL|function|lun_from_dev
r_static
r_inline
id|u16
id|lun_from_dev
c_func
(paren
r_struct
id|scsi_device
op_star
id|dev
)paren
(brace
r_return
(paren
l_int|0x2
op_lshift
l_int|14
)paren
op_or
(paren
id|dev-&gt;id
op_lshift
l_int|8
)paren
op_or
(paren
id|dev-&gt;channel
op_lshift
l_int|5
)paren
op_or
id|dev-&gt;lun
suffix:semicolon
)brace
multiline_comment|/**&n; * ibmvscsi_queue: - The queuecommand function of the scsi template &n; * @cmd:&t;struct scsi_cmnd to be executed&n; * @done:&t;Callback function to be called when cmd is completed&n;*/
DECL|function|ibmvscsi_queuecommand
r_static
r_int
id|ibmvscsi_queuecommand
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmnd
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
r_struct
id|srp_cmd
op_star
id|srp_cmd
suffix:semicolon
r_struct
id|srp_event_struct
op_star
id|evt_struct
suffix:semicolon
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
op_amp
id|cmnd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|u16
id|lun
op_assign
id|lun_from_dev
c_func
(paren
id|cmnd-&gt;device
)paren
suffix:semicolon
id|evt_struct
op_assign
id|get_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|evt_struct
)paren
r_return
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
id|init_event_struct
c_func
(paren
id|evt_struct
comma
id|handle_cmd_rsp
comma
id|VIOSRP_SRP_FORMAT
comma
id|cmnd-&gt;timeout
)paren
suffix:semicolon
id|evt_struct-&gt;cmnd
op_assign
id|cmnd
suffix:semicolon
id|evt_struct-&gt;cmnd_done
op_assign
id|done
suffix:semicolon
multiline_comment|/* Set up the actual SRP IU */
id|srp_cmd
op_assign
op_amp
id|evt_struct-&gt;iu.srp.cmd
suffix:semicolon
id|memset
c_func
(paren
id|srp_cmd
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|srp_cmd
)paren
)paren
suffix:semicolon
id|srp_cmd-&gt;type
op_assign
id|SRP_CMD_TYPE
suffix:semicolon
id|memcpy
c_func
(paren
id|srp_cmd-&gt;cdb
comma
id|cmnd-&gt;cmnd
comma
r_sizeof
(paren
id|cmnd-&gt;cmnd
)paren
)paren
suffix:semicolon
id|srp_cmd-&gt;lun
op_assign
(paren
(paren
id|u64
)paren
id|lun
)paren
op_lshift
l_int|48
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|map_data_for_srp_cmd
c_func
(paren
id|cmnd
comma
id|srp_cmd
comma
id|hostdata-&gt;dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: couldn&squot;t convert cmd to srp_cmd&bslash;n&quot;
)paren
suffix:semicolon
id|free_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
comma
id|evt_struct
)paren
suffix:semicolon
r_return
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
)brace
multiline_comment|/* Fix up dma address of the buffer itself */
r_if
c_cond
(paren
(paren
id|srp_cmd-&gt;data_out_format
op_eq
id|SRP_INDIRECT_BUFFER
)paren
op_logical_or
(paren
id|srp_cmd-&gt;data_in_format
op_eq
id|SRP_INDIRECT_BUFFER
)paren
)paren
(brace
r_struct
id|indirect_descriptor
op_star
id|indirect
op_assign
(paren
r_struct
id|indirect_descriptor
op_star
)paren
id|srp_cmd-&gt;additional_data
suffix:semicolon
id|indirect-&gt;head.virtual_address
op_assign
id|evt_struct-&gt;crq.IU_data_ptr
op_plus
m_offsetof
(paren
r_struct
id|srp_cmd
comma
id|additional_data
)paren
op_plus
m_offsetof
(paren
r_struct
id|indirect_descriptor
comma
id|list
)paren
suffix:semicolon
)brace
r_return
id|ibmvscsi_send_srp_event
c_func
(paren
id|evt_struct
comma
id|hostdata
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------&n; * Routines for driver initialization&n; */
multiline_comment|/**&n; * adapter_info_rsp: - Handle response to MAD adapter info request&n; * @evt_struct:&t;srp_event_struct with the response&n; *&n; * Used as a &quot;done&quot; callback by when sending adapter_info. Gets called&n; * by ibmvscsi_handle_crq()&n;*/
DECL|function|adapter_info_rsp
r_static
r_void
id|adapter_info_rsp
c_func
(paren
r_struct
id|srp_event_struct
op_star
id|evt_struct
)paren
(brace
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
id|evt_struct-&gt;hostdata
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|hostdata-&gt;dev
comma
id|evt_struct-&gt;iu.mad.adapter_info.buffer
comma
id|evt_struct-&gt;iu.mad.adapter_info.common.length
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|evt_struct-&gt;xfer_iu-&gt;mad.adapter_info.common.status
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ibmvscsi: error %d getting adapter info&bslash;n&quot;
comma
id|evt_struct-&gt;xfer_iu-&gt;mad.adapter_info.common.status
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;ibmvscsi: host srp version: %s, &quot;
l_string|&quot;host partition %s (%d), OS %d&bslash;n&quot;
comma
id|hostdata-&gt;madapter_info.srp_version
comma
id|hostdata-&gt;madapter_info.partition_name
comma
id|hostdata-&gt;madapter_info.partition_number
comma
id|hostdata-&gt;madapter_info.os_type
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * send_mad_adapter_info: - Sends the mad adapter info request&n; *      and stores the result so it can be retrieved with&n; *      sysfs.  We COULD consider causing a failure if the&n; *      returned SRP version doesn&squot;t match ours.&n; * @hostdata:&t;ibmvscsi_host_data of host&n; * &n; * Returns zero if successful.&n;*/
DECL|function|send_mad_adapter_info
r_static
r_void
id|send_mad_adapter_info
c_func
(paren
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
)paren
(brace
r_struct
id|viosrp_adapter_info
op_star
id|req
suffix:semicolon
r_struct
id|srp_event_struct
op_star
id|evt_struct
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hostdata-&gt;madapter_info
comma
l_int|0x00
comma
r_sizeof
(paren
id|hostdata-&gt;madapter_info
)paren
)paren
suffix:semicolon
id|evt_struct
op_assign
id|get_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|evt_struct
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: couldn&squot;t allocate an event &quot;
l_string|&quot;for ADAPTER_INFO_REQ!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|init_event_struct
c_func
(paren
id|evt_struct
comma
id|adapter_info_rsp
comma
id|VIOSRP_MAD_FORMAT
comma
id|init_timeout
op_star
id|HZ
)paren
suffix:semicolon
id|req
op_assign
op_amp
id|evt_struct-&gt;iu.mad.adapter_info
suffix:semicolon
id|memset
c_func
(paren
id|req
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|req
)paren
)paren
suffix:semicolon
id|req-&gt;common.type
op_assign
id|VIOSRP_ADAPTER_INFO_TYPE
suffix:semicolon
id|req-&gt;common.length
op_assign
r_sizeof
(paren
id|hostdata-&gt;madapter_info
)paren
suffix:semicolon
id|req-&gt;buffer
op_assign
id|dma_map_single
c_func
(paren
id|hostdata-&gt;dev
comma
op_amp
id|hostdata-&gt;madapter_info
comma
r_sizeof
(paren
id|hostdata-&gt;madapter_info
)paren
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_mapping_error
c_func
(paren
id|req-&gt;buffer
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: Unable to map request_buffer &quot;
l_string|&quot;for adapter_info!&bslash;n&quot;
)paren
suffix:semicolon
id|free_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
comma
id|evt_struct
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ibmvscsi_send_srp_event
c_func
(paren
id|evt_struct
comma
id|hostdata
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: couldn&squot;t send ADAPTER_INFO_REQ!&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; * login_rsp: - Handle response to SRP login request&n; * @evt_struct:&t;srp_event_struct with the response&n; *&n; * Used as a &quot;done&quot; callback by when sending srp_login. Gets called&n; * by ibmvscsi_handle_crq()&n;*/
DECL|function|login_rsp
r_static
r_void
id|login_rsp
c_func
(paren
r_struct
id|srp_event_struct
op_star
id|evt_struct
)paren
(brace
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
id|evt_struct-&gt;hostdata
suffix:semicolon
r_switch
c_cond
(paren
id|evt_struct-&gt;xfer_iu-&gt;srp.generic.type
)paren
(brace
r_case
id|SRP_LOGIN_RSP_TYPE
suffix:colon
multiline_comment|/* it worked! */
r_break
suffix:semicolon
r_case
id|SRP_LOGIN_REJ_TYPE
suffix:colon
multiline_comment|/* refused! */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ibmvscsi: SRP_LOGIN_REQ rejected&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Login failed.  */
id|atomic_set
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: Invalid login response typecode 0x%02x!&bslash;n&quot;
comma
id|evt_struct-&gt;xfer_iu-&gt;srp.generic.type
)paren
suffix:semicolon
multiline_comment|/* Login failed.  */
id|atomic_set
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ibmvscsi: SRP_LOGIN succeeded&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|evt_struct-&gt;xfer_iu-&gt;srp.login_rsp.request_limit_delta
OG
(paren
id|max_requests
op_minus
l_int|2
)paren
)paren
id|evt_struct-&gt;xfer_iu-&gt;srp.login_rsp.request_limit_delta
op_assign
id|max_requests
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* Now we know what the real request-limit is */
id|atomic_set
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
comma
id|evt_struct-&gt;xfer_iu-&gt;srp.login_rsp.request_limit_delta
)paren
suffix:semicolon
id|hostdata-&gt;host-&gt;can_queue
op_assign
id|evt_struct-&gt;xfer_iu-&gt;srp.login_rsp.request_limit_delta
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;host-&gt;can_queue
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: Invalid request_limit_delta&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|send_mad_adapter_info
c_func
(paren
id|hostdata
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/**&n; * send_srp_login: - Sends the srp login&n; * @hostdata:&t;ibmvscsi_host_data of host&n; * &n; * Returns zero if successful.&n;*/
DECL|function|send_srp_login
r_static
r_int
id|send_srp_login
c_func
(paren
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|srp_login_req
op_star
id|login
suffix:semicolon
r_struct
id|srp_event_struct
op_star
id|evt_struct
op_assign
id|get_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|evt_struct
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: couldn&squot;t allocate an event for login req!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|init_event_struct
c_func
(paren
id|evt_struct
comma
id|login_rsp
comma
id|VIOSRP_SRP_FORMAT
comma
id|init_timeout
op_star
id|HZ
)paren
suffix:semicolon
id|login
op_assign
op_amp
id|evt_struct-&gt;iu.srp.login_req
suffix:semicolon
id|login-&gt;type
op_assign
id|SRP_LOGIN_REQ_TYPE
suffix:semicolon
id|login-&gt;max_requested_initiator_to_target_iulen
op_assign
r_sizeof
(paren
r_union
id|srp_iu
)paren
suffix:semicolon
id|login-&gt;required_buffer_formats
op_assign
l_int|0x0006
suffix:semicolon
multiline_comment|/* Start out with a request limit of 1, since this is negotiated in&n;&t; * the login request we are just sending&n;&t; */
id|atomic_set
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
comma
l_int|1
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|hostdata-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|ibmvscsi_send_srp_event
c_func
(paren
id|evt_struct
comma
id|hostdata
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|hostdata-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; * sync_completion: Signal that a synchronous command has completed&n; * Note that after returning from this call, the evt_struct is freed.&n; * the caller waiting on this completion shouldn&squot;t touch the evt_struct&n; * again.&n; */
DECL|function|sync_completion
r_static
r_void
id|sync_completion
c_func
(paren
r_struct
id|srp_event_struct
op_star
id|evt_struct
)paren
(brace
id|complete
c_func
(paren
op_amp
id|evt_struct-&gt;comp
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ibmvscsi_abort: Abort a command...from scsi host template&n; * send this over to the server and wait synchronously for the response&n; */
DECL|function|ibmvscsi_eh_abort_handler
r_static
r_int
id|ibmvscsi_eh_abort_handler
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|srp_tsk_mgmt
op_star
id|tsk_mgmt
suffix:semicolon
r_struct
id|srp_event_struct
op_star
id|evt
suffix:semicolon
r_struct
id|srp_event_struct
op_star
id|tmp_evt
comma
op_star
id|found_evt
suffix:semicolon
id|u16
id|lun
op_assign
id|lun_from_dev
c_func
(paren
id|cmd-&gt;device
)paren
suffix:semicolon
multiline_comment|/* First, find this command in our sent list so we can figure&n;&t; * out the correct tag&n;&t; */
id|found_evt
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|tmp_evt
comma
op_amp
id|hostdata-&gt;sent
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|tmp_evt-&gt;cmnd
op_eq
id|cmd
)paren
(brace
id|found_evt
op_assign
id|tmp_evt
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found_evt
)paren
r_return
id|FAILED
suffix:semicolon
id|evt
op_assign
id|get_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
)paren
suffix:semicolon
r_if
c_cond
(paren
id|evt
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: failed to allocate abort event&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|init_event_struct
c_func
(paren
id|evt
comma
id|sync_completion
comma
id|VIOSRP_SRP_FORMAT
comma
id|init_timeout
op_star
id|HZ
)paren
suffix:semicolon
id|tsk_mgmt
op_assign
op_amp
id|evt-&gt;iu.srp.tsk_mgmt
suffix:semicolon
multiline_comment|/* Set up an abort SRP command */
id|memset
c_func
(paren
id|tsk_mgmt
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|tsk_mgmt
)paren
)paren
suffix:semicolon
id|tsk_mgmt-&gt;type
op_assign
id|SRP_TSK_MGMT_TYPE
suffix:semicolon
id|tsk_mgmt-&gt;lun
op_assign
(paren
(paren
id|u64
)paren
id|lun
)paren
op_lshift
l_int|48
suffix:semicolon
id|tsk_mgmt-&gt;task_mgmt_flags
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* ABORT TASK */
id|tsk_mgmt-&gt;managed_task_tag
op_assign
(paren
id|u64
)paren
id|found_evt
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ibmvscsi: aborting command. lun 0x%lx, tag 0x%lx&bslash;n&quot;
comma
id|tsk_mgmt-&gt;lun
comma
id|tsk_mgmt-&gt;managed_task_tag
)paren
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|evt-&gt;comp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmvscsi_send_srp_event
c_func
(paren
id|evt
comma
id|hostdata
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: failed to send abort() event&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
id|hostdata-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|evt-&gt;comp
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|hostdata-&gt;host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/* Because we dropped the spinlock above, it&squot;s possible&n;&t; * The event is no longer in our list.  Make sure it didn&squot;t&n;&t; * complete while we were aborting&n;&t; */
id|found_evt
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|tmp_evt
comma
op_amp
id|hostdata-&gt;sent
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|tmp_evt-&gt;cmnd
op_eq
id|cmd
)paren
(brace
id|found_evt
op_assign
id|tmp_evt
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ibmvscsi: successfully aborted task tag 0x%lx&bslash;n&quot;
comma
id|tsk_mgmt-&gt;managed_task_tag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|found_evt
op_eq
l_int|NULL
)paren
r_return
id|SUCCESS
suffix:semicolon
id|cmd-&gt;result
op_assign
(paren
id|DID_ABORT
op_lshift
l_int|16
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|found_evt-&gt;list
)paren
suffix:semicolon
id|unmap_cmd_data
c_func
(paren
op_amp
id|found_evt-&gt;iu.srp.cmd
comma
id|found_evt-&gt;hostdata-&gt;dev
)paren
suffix:semicolon
id|free_event_struct
c_func
(paren
op_amp
id|found_evt-&gt;hostdata-&gt;pool
comma
id|found_evt
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/**&n; * ibmvscsi_eh_device_reset_handler: Reset a single LUN...from scsi host &n; * template send this over to the server and wait synchronously for the &n; * response&n; */
DECL|function|ibmvscsi_eh_device_reset_handler
r_static
r_int
id|ibmvscsi_eh_device_reset_handler
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|srp_tsk_mgmt
op_star
id|tsk_mgmt
suffix:semicolon
r_struct
id|srp_event_struct
op_star
id|evt
suffix:semicolon
r_struct
id|srp_event_struct
op_star
id|tmp_evt
comma
op_star
id|pos
suffix:semicolon
id|u16
id|lun
op_assign
id|lun_from_dev
c_func
(paren
id|cmd-&gt;device
)paren
suffix:semicolon
id|evt
op_assign
id|get_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
)paren
suffix:semicolon
r_if
c_cond
(paren
id|evt
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: failed to allocate reset event&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|init_event_struct
c_func
(paren
id|evt
comma
id|sync_completion
comma
id|VIOSRP_SRP_FORMAT
comma
id|init_timeout
op_star
id|HZ
)paren
suffix:semicolon
id|tsk_mgmt
op_assign
op_amp
id|evt-&gt;iu.srp.tsk_mgmt
suffix:semicolon
multiline_comment|/* Set up a lun reset SRP command */
id|memset
c_func
(paren
id|tsk_mgmt
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|tsk_mgmt
)paren
)paren
suffix:semicolon
id|tsk_mgmt-&gt;type
op_assign
id|SRP_TSK_MGMT_TYPE
suffix:semicolon
id|tsk_mgmt-&gt;lun
op_assign
(paren
(paren
id|u64
)paren
id|lun
)paren
op_lshift
l_int|48
suffix:semicolon
id|tsk_mgmt-&gt;task_mgmt_flags
op_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* LUN RESET */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ibmvscsi: resetting device. lun 0x%lx&bslash;n&quot;
comma
id|tsk_mgmt-&gt;lun
)paren
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|evt-&gt;comp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmvscsi_send_srp_event
c_func
(paren
id|evt
comma
id|hostdata
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: failed to send reset event&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
id|hostdata-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|evt-&gt;comp
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|hostdata-&gt;host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/* We need to find all commands for this LUN that have not yet been&n;&t; * responded to, and fail them with DID_RESET&n;&t; */
id|list_for_each_entry_safe
c_func
(paren
id|tmp_evt
comma
id|pos
comma
op_amp
id|hostdata-&gt;sent
comma
id|list
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp_evt-&gt;cmnd
)paren
op_logical_and
(paren
id|tmp_evt-&gt;cmnd-&gt;device
op_eq
id|cmd-&gt;device
)paren
)paren
(brace
r_if
c_cond
(paren
id|tmp_evt-&gt;cmnd
)paren
id|tmp_evt-&gt;cmnd-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|tmp_evt-&gt;list
)paren
suffix:semicolon
id|unmap_cmd_data
c_func
(paren
op_amp
id|tmp_evt-&gt;iu.srp.cmd
comma
id|tmp_evt-&gt;hostdata-&gt;dev
)paren
suffix:semicolon
id|free_event_struct
c_func
(paren
op_amp
id|tmp_evt-&gt;hostdata-&gt;pool
comma
id|tmp_evt
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_evt-&gt;cmnd_done
)paren
id|tmp_evt
op_member_access_from_pointer
id|cmnd_done
c_func
(paren
id|tmp_evt-&gt;cmnd
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tmp_evt-&gt;done
)paren
id|tmp_evt
op_member_access_from_pointer
id|done
c_func
(paren
id|tmp_evt
)paren
suffix:semicolon
)brace
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/**&n; * purge_requests: Our virtual adapter just shut down.  purge any sent requests&n; * @hostdata:    the adapter&n; */
DECL|function|purge_requests
r_static
r_void
id|purge_requests
c_func
(paren
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
)paren
(brace
r_struct
id|srp_event_struct
op_star
id|tmp_evt
comma
op_star
id|pos
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|hostdata-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|tmp_evt
comma
id|pos
comma
op_amp
id|hostdata-&gt;sent
comma
id|list
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|tmp_evt-&gt;list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_evt-&gt;cmnd
)paren
(brace
id|tmp_evt-&gt;cmnd-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|unmap_cmd_data
c_func
(paren
op_amp
id|tmp_evt-&gt;iu.srp.cmd
comma
id|tmp_evt-&gt;hostdata-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_evt-&gt;cmnd_done
)paren
id|tmp_evt
op_member_access_from_pointer
id|cmnd_done
c_func
(paren
id|tmp_evt-&gt;cmnd
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tmp_evt-&gt;done
)paren
(brace
id|tmp_evt
op_member_access_from_pointer
id|done
c_func
(paren
id|tmp_evt
)paren
suffix:semicolon
)brace
)brace
id|free_event_struct
c_func
(paren
op_amp
id|tmp_evt-&gt;hostdata-&gt;pool
comma
id|tmp_evt
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|hostdata-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ibmvscsi_handle_crq: - Handles and frees received events in the CRQ&n; * @crq:&t;Command/Response queue&n; * @hostdata:&t;ibmvscsi_host_data of host&n; *&n;*/
DECL|function|ibmvscsi_handle_crq
r_void
id|ibmvscsi_handle_crq
c_func
(paren
r_struct
id|viosrp_crq
op_star
id|crq
comma
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|srp_event_struct
op_star
id|evt_struct
op_assign
(paren
r_struct
id|srp_event_struct
op_star
)paren
id|crq-&gt;IU_data_ptr
suffix:semicolon
r_switch
c_cond
(paren
id|crq-&gt;valid
)paren
(brace
r_case
l_int|0xC0
suffix:colon
multiline_comment|/* initialization */
r_switch
c_cond
(paren
id|crq-&gt;format
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* Initialization message */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ibmvscsi: partner initialized&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Send back a response */
r_if
c_cond
(paren
id|ibmvscsi_send_crq
c_func
(paren
id|hostdata
comma
l_int|0xC002000000000000LL
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Now login */
id|send_srp_login
c_func
(paren
id|hostdata
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: Unable to send init rsp&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* Initialization response */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ibmvscsi: partner initialization complete&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Now login */
id|send_srp_login
c_func
(paren
id|hostdata
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: unknown crq message type&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
r_case
l_int|0xFF
suffix:colon
multiline_comment|/* Hypervisor telling us the connection is closed */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ibmvscsi: Virtual adapter failed!&bslash;n&quot;
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|purge_requests
c_func
(paren
id|hostdata
)paren
suffix:semicolon
id|ibmvscsi_reset_crq_queue
c_func
(paren
op_amp
id|hostdata-&gt;queue
comma
id|hostdata
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x80
suffix:colon
multiline_comment|/* real payload */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: got an invalid message type 0x%02x&bslash;n&quot;
comma
id|crq-&gt;valid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* The only kind of payload CRQs we should get are responses to&n;&t; * things we send. Make sure this response is to something we&n;&t; * actually sent&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|valid_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
comma
id|evt_struct
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: returned correlation_token 0x%p is invalid!&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|crq-&gt;IU_data_ptr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|crq-&gt;format
op_eq
id|VIOSRP_SRP_FORMAT
)paren
id|atomic_add
c_func
(paren
id|evt_struct-&gt;xfer_iu-&gt;srp.rsp.request_limit_delta
comma
op_amp
id|hostdata-&gt;request_limit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|evt_struct-&gt;done
)paren
id|evt_struct
op_member_access_from_pointer
id|done
c_func
(paren
id|evt_struct
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: returned done() is NULL; not running it!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Lock the host_lock before messing with these structures, since we&n;&t; * are running in a task context&n;&t; */
id|spin_lock_irqsave
c_func
(paren
id|evt_struct-&gt;hostdata-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|evt_struct-&gt;list
)paren
suffix:semicolon
id|free_event_struct
c_func
(paren
op_amp
id|evt_struct-&gt;hostdata-&gt;pool
comma
id|evt_struct
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|evt_struct-&gt;hostdata-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ibmvscsi_get_host_config: Send the command to the server to get host&n; * configuration data.  The data is opaque to us.&n; */
DECL|function|ibmvscsi_do_host_config
r_static
r_int
id|ibmvscsi_do_host_config
c_func
(paren
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
comma
r_int
r_char
op_star
id|buffer
comma
r_int
id|length
)paren
(brace
r_struct
id|viosrp_host_config
op_star
id|host_config
suffix:semicolon
r_struct
id|srp_event_struct
op_star
id|evt_struct
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|evt_struct
op_assign
id|get_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|evt_struct
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: could&squot;t allocate event for HOST_CONFIG!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|init_event_struct
c_func
(paren
id|evt_struct
comma
id|sync_completion
comma
id|VIOSRP_MAD_FORMAT
comma
id|init_timeout
op_star
id|HZ
)paren
suffix:semicolon
id|host_config
op_assign
op_amp
id|evt_struct-&gt;iu.mad.host_config
suffix:semicolon
multiline_comment|/* Set up a lun reset SRP command */
id|memset
c_func
(paren
id|host_config
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|host_config
)paren
)paren
suffix:semicolon
id|host_config-&gt;common.type
op_assign
id|VIOSRP_HOST_CONFIG_TYPE
suffix:semicolon
id|host_config-&gt;common.length
op_assign
id|length
suffix:semicolon
id|host_config-&gt;buffer
op_assign
id|dma_map_single
c_func
(paren
id|hostdata-&gt;dev
comma
id|buffer
comma
id|length
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_mapping_error
c_func
(paren
id|host_config-&gt;buffer
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: dma_mapping error &quot;
l_string|&quot;getting host config&bslash;n&quot;
)paren
suffix:semicolon
id|free_event_struct
c_func
(paren
op_amp
id|hostdata-&gt;pool
comma
id|evt_struct
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|init_completion
c_func
(paren
op_amp
id|evt_struct-&gt;comp
)paren
suffix:semicolon
id|rc
op_assign
id|ibmvscsi_send_srp_event
c_func
(paren
id|evt_struct
comma
id|hostdata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|wait_for_completion
c_func
(paren
op_amp
id|evt_struct-&gt;comp
)paren
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|hostdata-&gt;dev
comma
id|host_config-&gt;buffer
comma
id|length
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------&n; * sysfs attributes&n; */
DECL|function|show_host_srp_version
r_static
id|ssize_t
id|show_host_srp_version
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|hostdata-&gt;madapter_info.srp_version
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|ibmvscsi_host_srp_version
r_static
r_struct
id|class_device_attribute
id|ibmvscsi_host_srp_version
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;srp_version&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
)brace
comma
dot
id|show
op_assign
id|show_host_srp_version
comma
)brace
suffix:semicolon
DECL|function|show_host_partition_name
r_static
id|ssize_t
id|show_host_partition_name
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|hostdata-&gt;madapter_info.partition_name
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|ibmvscsi_host_partition_name
r_static
r_struct
id|class_device_attribute
id|ibmvscsi_host_partition_name
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;partition_name&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
)brace
comma
dot
id|show
op_assign
id|show_host_partition_name
comma
)brace
suffix:semicolon
DECL|function|show_host_partition_number
r_static
id|ssize_t
id|show_host_partition_number
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|hostdata-&gt;madapter_info.partition_number
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|ibmvscsi_host_partition_number
r_static
r_struct
id|class_device_attribute
id|ibmvscsi_host_partition_number
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;partition_number&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
)brace
comma
dot
id|show
op_assign
id|show_host_partition_number
comma
)brace
suffix:semicolon
DECL|function|show_host_mad_version
r_static
id|ssize_t
id|show_host_mad_version
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|hostdata-&gt;madapter_info.mad_version
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|ibmvscsi_host_mad_version
r_static
r_struct
id|class_device_attribute
id|ibmvscsi_host_mad_version
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;mad_version&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
)brace
comma
dot
id|show
op_assign
id|show_host_mad_version
comma
)brace
suffix:semicolon
DECL|function|show_host_os_type
r_static
id|ssize_t
id|show_host_os_type
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|hostdata-&gt;madapter_info.os_type
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|ibmvscsi_host_os_type
r_static
r_struct
id|class_device_attribute
id|ibmvscsi_host_os_type
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;os_type&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
)brace
comma
dot
id|show
op_assign
id|show_host_os_type
comma
)brace
suffix:semicolon
DECL|function|show_host_config
r_static
id|ssize_t
id|show_host_config
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
multiline_comment|/* returns null-terminated host config data */
r_if
c_cond
(paren
id|ibmvscsi_do_host_config
c_func
(paren
id|hostdata
comma
id|buf
comma
id|PAGE_SIZE
)paren
op_eq
l_int|0
)paren
r_return
id|strlen
c_func
(paren
id|buf
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ibmvscsi_host_config
r_static
r_struct
id|class_device_attribute
id|ibmvscsi_host_config
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;config&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
)brace
comma
dot
id|show
op_assign
id|show_host_config
comma
)brace
suffix:semicolon
DECL|variable|ibmvscsi_attrs
r_static
r_struct
id|class_device_attribute
op_star
id|ibmvscsi_attrs
(braket
)braket
op_assign
(brace
op_amp
id|ibmvscsi_host_srp_version
comma
op_amp
id|ibmvscsi_host_partition_name
comma
op_amp
id|ibmvscsi_host_partition_number
comma
op_amp
id|ibmvscsi_host_mad_version
comma
op_amp
id|ibmvscsi_host_os_type
comma
op_amp
id|ibmvscsi_host_config
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------&n; * SCSI driver registration&n; */
DECL|variable|driver_template
r_static
r_struct
id|scsi_host_template
id|driver_template
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;IBM POWER Virtual SCSI Adapter &quot;
id|IBMVSCSI_VERSION
comma
dot
id|proc_name
op_assign
l_string|&quot;ibmvscsi&quot;
comma
dot
id|queuecommand
op_assign
id|ibmvscsi_queuecommand
comma
dot
id|eh_abort_handler
op_assign
id|ibmvscsi_eh_abort_handler
comma
dot
id|eh_device_reset_handler
op_assign
id|ibmvscsi_eh_device_reset_handler
comma
dot
id|cmd_per_lun
op_assign
l_int|16
comma
dot
id|can_queue
op_assign
l_int|1
comma
multiline_comment|/* Updated after SRP_LOGIN */
dot
id|this_id
op_assign
op_minus
l_int|1
comma
dot
id|sg_tablesize
op_assign
id|MAX_INDIRECT_BUFS
comma
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
dot
id|shost_attrs
op_assign
id|ibmvscsi_attrs
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * Called by bus code for each adapter&n; */
DECL|function|ibmvscsi_probe
r_static
r_int
id|ibmvscsi_probe
c_func
(paren
r_struct
id|vio_dev
op_star
id|vdev
comma
r_const
r_struct
id|vio_device_id
op_star
id|id
)paren
(brace
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|vdev-&gt;dev
suffix:semicolon
r_int
r_int
id|wait_switch
op_assign
l_int|0
suffix:semicolon
id|vdev-&gt;dev.driver_data
op_assign
l_int|NULL
suffix:semicolon
id|host
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|driver_template
comma
r_sizeof
(paren
op_star
id|hostdata
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: couldn&squot;t allocate host data&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|scsi_host_alloc_failed
suffix:semicolon
)brace
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|memset
c_func
(paren
id|hostdata
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|hostdata
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hostdata-&gt;sent
)paren
suffix:semicolon
id|hostdata-&gt;host
op_assign
id|host
suffix:semicolon
id|hostdata-&gt;dev
op_assign
id|dev
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmvscsi_init_crq_queue
c_func
(paren
op_amp
id|hostdata-&gt;queue
comma
id|hostdata
comma
id|max_requests
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: couldn&squot;t initialize crq&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|init_crq_failed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|initialize_event_pool
c_func
(paren
op_amp
id|hostdata-&gt;pool
comma
id|max_requests
comma
id|hostdata
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: couldn&squot;t initialize event pool&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|init_pool_failed
suffix:semicolon
)brace
id|host-&gt;max_lun
op_assign
l_int|8
suffix:semicolon
id|host-&gt;max_id
op_assign
id|max_id
suffix:semicolon
id|host-&gt;max_channel
op_assign
id|max_channel
suffix:semicolon
r_if
c_cond
(paren
id|scsi_add_host
c_func
(paren
id|hostdata-&gt;host
comma
id|hostdata-&gt;dev
)paren
)paren
r_goto
id|add_host_failed
suffix:semicolon
multiline_comment|/* Try to send an initialization message.  Note that this is allowed&n;&t; * to fail if the other end is not acive.  In that case we don&squot;t&n;&t; * want to scan&n;&t; */
r_if
c_cond
(paren
id|ibmvscsi_send_crq
c_func
(paren
id|hostdata
comma
l_int|0xC001000000000000LL
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Wait around max init_timeout secs for the adapter to finish&n;&t;&t; * initializing. When we are done initializing, we will have a&n;&t;&t; * valid request_limit.  We don&squot;t want Linux scanning before&n;&t;&t; * we are ready.&n;&t;&t; */
r_for
c_loop
(paren
id|wait_switch
op_assign
id|jiffies
op_plus
(paren
id|init_timeout
op_star
id|HZ
)paren
suffix:semicolon
id|time_before
c_func
(paren
id|jiffies
comma
id|wait_switch
)paren
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
)paren
OL
l_int|0
suffix:semicolon
)paren
(brace
id|msleep
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* if we now have a valid request_limit, initiate a scan */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|hostdata-&gt;request_limit
)paren
OG
l_int|0
)paren
id|scsi_scan_host
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
id|vdev-&gt;dev.driver_data
op_assign
id|hostdata
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|add_host_failed
suffix:colon
id|release_event_pool
c_func
(paren
op_amp
id|hostdata-&gt;pool
comma
id|hostdata
)paren
suffix:semicolon
id|init_pool_failed
suffix:colon
id|ibmvscsi_release_crq_queue
c_func
(paren
op_amp
id|hostdata-&gt;queue
comma
id|hostdata
comma
id|max_requests
)paren
suffix:semicolon
id|init_crq_failed
suffix:colon
id|scsi_host_put
c_func
(paren
id|host
)paren
suffix:semicolon
id|scsi_host_alloc_failed
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|ibmvscsi_remove
r_static
r_int
id|ibmvscsi_remove
c_func
(paren
r_struct
id|vio_dev
op_star
id|vdev
)paren
(brace
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
id|vdev-&gt;dev.driver_data
suffix:semicolon
id|release_event_pool
c_func
(paren
op_amp
id|hostdata-&gt;pool
comma
id|hostdata
)paren
suffix:semicolon
id|ibmvscsi_release_crq_queue
c_func
(paren
op_amp
id|hostdata-&gt;queue
comma
id|hostdata
comma
id|max_requests
)paren
suffix:semicolon
id|scsi_remove_host
c_func
(paren
id|hostdata-&gt;host
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|hostdata-&gt;host
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * ibmvscsi_device_table: Used by vio.c to match devices in the device tree we &n; * support.&n; */
DECL|variable|__devinitdata
r_static
r_struct
id|vio_device_id
id|ibmvscsi_device_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_string|&quot;vscsi&quot;
comma
l_string|&quot;IBM,v-scsi&quot;
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|vio
comma
id|ibmvscsi_device_table
)paren
suffix:semicolon
DECL|variable|ibmvscsi_driver
r_static
r_struct
id|vio_driver
id|ibmvscsi_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ibmvscsi&quot;
comma
dot
id|id_table
op_assign
id|ibmvscsi_device_table
comma
dot
id|probe
op_assign
id|ibmvscsi_probe
comma
dot
id|remove
op_assign
id|ibmvscsi_remove
)brace
suffix:semicolon
DECL|function|ibmvscsi_module_init
r_int
id|__init
id|ibmvscsi_module_init
c_func
(paren
r_void
)paren
(brace
r_return
id|vio_register_driver
c_func
(paren
op_amp
id|ibmvscsi_driver
)paren
suffix:semicolon
)brace
DECL|function|ibmvscsi_module_exit
r_void
id|__exit
id|ibmvscsi_module_exit
c_func
(paren
r_void
)paren
(brace
id|vio_unregister_driver
c_func
(paren
op_amp
id|ibmvscsi_driver
)paren
suffix:semicolon
)brace
DECL|variable|ibmvscsi_module_init
id|module_init
c_func
(paren
id|ibmvscsi_module_init
)paren
suffix:semicolon
DECL|variable|ibmvscsi_module_exit
id|module_exit
c_func
(paren
id|ibmvscsi_module_exit
)paren
suffix:semicolon
eof
