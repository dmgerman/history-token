multiline_comment|/* ------------------------------------------------------------&n; * rpa_vscsi.c&n; * (C) Copyright IBM Corporation 1994, 2003&n; * Authors: Colin DeVilbiss (devilbis@us.ibm.com)&n; *          Santiago Leon (santil@us.ibm.com)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307&n; * USA&n; *&n; * ------------------------------------------------------------&n; * RPA-specific functions of the SCSI host adapter for Virtual I/O devices&n; *&n; * This driver allows the Linux SCSI peripheral drivers to directly&n; * access devices in the hosting partition, either on an iSeries&n; * hypervisor system or a converged hypervisor system.&n; */
macro_line|#include &lt;asm/vio.h&gt;
macro_line|#include &lt;asm/iommu.h&gt;
macro_line|#include &lt;asm/hvcall.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &quot;ibmvscsi.h&quot;
multiline_comment|/* ------------------------------------------------------------&n; * Routines for managing the command/response queue&n; */
multiline_comment|/**&n; * ibmvscsi_handle_event: - Interrupt handler for crq events&n; * @irq:&t;number of irq to handle, not used&n; * @dev_instance: ibmvscsi_host_data of host that received interrupt&n; * @regs:&t;pt_regs with registers&n; *&n; * Disables interrupts and schedules srp_task&n; * Always returns IRQ_HANDLED&n; */
DECL|function|ibmvscsi_handle_event
r_static
id|irqreturn_t
id|ibmvscsi_handle_event
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
id|dev_instance
suffix:semicolon
id|vio_disable_interrupts
c_func
(paren
id|to_vio_dev
c_func
(paren
id|hostdata-&gt;dev
)paren
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|hostdata-&gt;srp_task
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/**&n; * release_crq_queue: - Deallocates data and unregisters CRQ&n; * @queue:&t;crq_queue to initialize and register&n; * @host_data:&t;ibmvscsi_host_data of host&n; *&n; * Frees irq, deallocates a page for messages, unmaps dma, and unregisters&n; * the crq with the hypervisor.&n; */
DECL|function|ibmvscsi_release_crq_queue
r_void
id|ibmvscsi_release_crq_queue
c_func
(paren
r_struct
id|crq_queue
op_star
id|queue
comma
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
comma
r_int
id|max_requests
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|vio_dev
op_star
id|vdev
op_assign
id|to_vio_dev
c_func
(paren
id|hostdata-&gt;dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|vdev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|hostdata
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|hostdata-&gt;srp_task
)paren
suffix:semicolon
r_do
(brace
id|rc
op_assign
id|plpar_hcall_norets
c_func
(paren
id|H_FREE_CRQ
comma
id|vdev-&gt;unit_address
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|rc
op_eq
id|H_Busy
)paren
op_logical_or
(paren
id|H_isLongBusy
c_func
(paren
id|rc
)paren
)paren
)paren
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|hostdata-&gt;dev
comma
id|queue-&gt;msg_token
comma
id|queue-&gt;size
op_star
r_sizeof
(paren
op_star
id|queue-&gt;msgs
)paren
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|queue-&gt;msgs
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * crq_queue_next_crq: - Returns the next entry in message queue&n; * @queue:&t;crq_queue to use&n; *&n; * Returns pointer to next entry in queue, or NULL if there are no new &n; * entried in the CRQ.&n; */
DECL|function|crq_queue_next_crq
r_static
r_struct
id|viosrp_crq
op_star
id|crq_queue_next_crq
c_func
(paren
r_struct
id|crq_queue
op_star
id|queue
)paren
(brace
r_struct
id|viosrp_crq
op_star
id|crq
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|queue-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|crq
op_assign
op_amp
id|queue-&gt;msgs
(braket
id|queue-&gt;cur
)braket
suffix:semicolon
r_if
c_cond
(paren
id|crq-&gt;valid
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
op_increment
id|queue-&gt;cur
op_eq
id|queue-&gt;size
)paren
id|queue-&gt;cur
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|crq
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|queue-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|crq
suffix:semicolon
)brace
multiline_comment|/**&n; * ibmvscsi_send_crq: - Send a CRQ&n; * @hostdata:&t;the adapter&n; * @word1:&t;the first 64 bits of the data&n; * @word2:&t;the second 64 bits of the data&n; */
DECL|function|ibmvscsi_send_crq
r_int
id|ibmvscsi_send_crq
c_func
(paren
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
comma
id|u64
id|word1
comma
id|u64
id|word2
)paren
(brace
r_struct
id|vio_dev
op_star
id|vdev
op_assign
id|to_vio_dev
c_func
(paren
id|hostdata-&gt;dev
)paren
suffix:semicolon
r_return
id|plpar_hcall_norets
c_func
(paren
id|H_SEND_CRQ
comma
id|vdev-&gt;unit_address
comma
id|word1
comma
id|word2
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ibmvscsi_task: - Process srps asynchronously&n; * @data:&t;ibmvscsi_host_data of host&n; */
DECL|function|ibmvscsi_task
r_static
r_void
id|ibmvscsi_task
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
op_assign
(paren
r_struct
id|ibmvscsi_host_data
op_star
)paren
id|data
suffix:semicolon
r_struct
id|vio_dev
op_star
id|vdev
op_assign
id|to_vio_dev
c_func
(paren
id|hostdata-&gt;dev
)paren
suffix:semicolon
r_struct
id|viosrp_crq
op_star
id|crq
suffix:semicolon
r_int
id|done
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
(brace
multiline_comment|/* Pull all the valid messages off the CRQ */
r_while
c_loop
(paren
(paren
id|crq
op_assign
id|crq_queue_next_crq
c_func
(paren
op_amp
id|hostdata-&gt;queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|ibmvscsi_handle_crq
c_func
(paren
id|crq
comma
id|hostdata
)paren
suffix:semicolon
id|crq-&gt;valid
op_assign
l_int|0x00
suffix:semicolon
)brace
id|vio_enable_interrupts
c_func
(paren
id|vdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|crq
op_assign
id|crq_queue_next_crq
c_func
(paren
op_amp
id|hostdata-&gt;queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|vio_disable_interrupts
c_func
(paren
id|vdev
)paren
suffix:semicolon
id|ibmvscsi_handle_crq
c_func
(paren
id|crq
comma
id|hostdata
)paren
suffix:semicolon
id|crq-&gt;valid
op_assign
l_int|0x00
suffix:semicolon
)brace
r_else
(brace
id|done
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * initialize_crq_queue: - Initializes and registers CRQ with hypervisor&n; * @queue:&t;crq_queue to initialize and register&n; * @hostdata:&t;ibmvscsi_host_data of host&n; *&n; * Allocates a page for messages, maps it for dma, and registers&n; * the crq with the hypervisor.&n; * Returns zero on success.&n; */
DECL|function|ibmvscsi_init_crq_queue
r_int
id|ibmvscsi_init_crq_queue
c_func
(paren
r_struct
id|crq_queue
op_star
id|queue
comma
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
comma
r_int
id|max_requests
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|vio_dev
op_star
id|vdev
op_assign
id|to_vio_dev
c_func
(paren
id|hostdata-&gt;dev
)paren
suffix:semicolon
id|queue-&gt;msgs
op_assign
(paren
r_struct
id|viosrp_crq
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue-&gt;msgs
)paren
r_goto
id|malloc_failed
suffix:semicolon
id|queue-&gt;size
op_assign
id|PAGE_SIZE
op_div
r_sizeof
(paren
op_star
id|queue-&gt;msgs
)paren
suffix:semicolon
id|queue-&gt;msg_token
op_assign
id|dma_map_single
c_func
(paren
id|hostdata-&gt;dev
comma
id|queue-&gt;msgs
comma
id|queue-&gt;size
op_star
r_sizeof
(paren
op_star
id|queue-&gt;msgs
)paren
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_mapping_error
c_func
(paren
id|queue-&gt;msg_token
)paren
)paren
r_goto
id|map_failed
suffix:semicolon
id|rc
op_assign
id|plpar_hcall_norets
c_func
(paren
id|H_REG_CRQ
comma
id|vdev-&gt;unit_address
comma
id|queue-&gt;msg_token
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|2
)paren
(brace
multiline_comment|/* Adapter is good, but other end is not ready */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ibmvscsi: Partner adapter not ready&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ibmvscsi: Error %d opening adapter&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_goto
id|reg_crq_failed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|vdev-&gt;irq
comma
id|ibmvscsi_handle_event
comma
l_int|0
comma
l_string|&quot;ibmvscsi&quot;
comma
(paren
r_void
op_star
)paren
id|hostdata
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi: couldn&squot;t register irq 0x%x&bslash;n&quot;
comma
id|vdev-&gt;irq
)paren
suffix:semicolon
r_goto
id|req_irq_failed
suffix:semicolon
)brace
id|rc
op_assign
id|vio_enable_interrupts
c_func
(paren
id|vdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ibmvscsi:  Error %d enabling interrupts!!!&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_goto
id|req_irq_failed
suffix:semicolon
)brace
id|queue-&gt;cur
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|queue-&gt;lock
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|hostdata-&gt;srp_task
comma
(paren
r_void
op_star
)paren
id|ibmvscsi_task
comma
(paren
r_int
r_int
)paren
id|hostdata
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|req_irq_failed
suffix:colon
r_do
(brace
id|rc
op_assign
id|plpar_hcall_norets
c_func
(paren
id|H_FREE_CRQ
comma
id|vdev-&gt;unit_address
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|rc
op_eq
id|H_Busy
)paren
op_logical_or
(paren
id|H_isLongBusy
c_func
(paren
id|rc
)paren
)paren
)paren
suffix:semicolon
id|reg_crq_failed
suffix:colon
id|dma_unmap_single
c_func
(paren
id|hostdata-&gt;dev
comma
id|queue-&gt;msg_token
comma
id|queue-&gt;size
op_star
r_sizeof
(paren
op_star
id|queue-&gt;msgs
)paren
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|map_failed
suffix:colon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|queue-&gt;msgs
)paren
suffix:semicolon
id|malloc_failed
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * reset_crq_queue: - resets a crq after a failure&n; * @queue:&t;crq_queue to initialize and register&n; * @hostdata:&t;ibmvscsi_host_data of host&n; *&n; */
DECL|function|ibmvscsi_reset_crq_queue
r_void
id|ibmvscsi_reset_crq_queue
c_func
(paren
r_struct
id|crq_queue
op_star
id|queue
comma
r_struct
id|ibmvscsi_host_data
op_star
id|hostdata
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|vio_dev
op_star
id|vdev
op_assign
id|to_vio_dev
c_func
(paren
id|hostdata-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* Close the CRQ */
r_do
(brace
id|rc
op_assign
id|plpar_hcall_norets
c_func
(paren
id|H_FREE_CRQ
comma
id|vdev-&gt;unit_address
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|rc
op_eq
id|H_Busy
)paren
op_logical_or
(paren
id|H_isLongBusy
c_func
(paren
id|rc
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Clean out the queue */
id|memset
c_func
(paren
id|queue-&gt;msgs
comma
l_int|0x00
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|queue-&gt;cur
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* And re-open it again */
id|rc
op_assign
id|plpar_hcall_norets
c_func
(paren
id|H_REG_CRQ
comma
id|vdev-&gt;unit_address
comma
id|queue-&gt;msg_token
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|2
)paren
(brace
multiline_comment|/* Adapter is good, but other end is not ready */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ibmvscsi: Partner adapter not ready&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ibmvscsi: couldn&squot;t register crq--rc 0x%x&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
eof
