multiline_comment|/*&n; *  ahci.c - AHCI SATA support&n; *&n; *  Copyright 2004 Red Hat, Inc.&n; *&n; *  The contents of this file are subject to the Open&n; *  Software License version 1.1 that can be found at&n; *  http://www.opensource.org/licenses/osl-1.1.txt and is included herein&n; *  by reference.&n; *&n; *  Alternatively, the contents of this file may be used under the terms&n; *  of the GNU General Public License version 2 (the &quot;GPL&quot;) as distributed&n; *  in the kernel source COPYING file, in which case the provisions of&n; *  the GPL are applicable instead of the above.  If you wish to allow&n; *  the use of your version of this file only under the terms of the&n; *  GPL and not to allow others to use your version of this file under&n; *  the OSL, indicate your decision by deleting the provisions above and&n; *  replace them with the notice and other provisions required by the GPL.&n; *  If you do not delete the provisions above, a recipient may use your&n; *  version of this file under either the OSL or the GPL.&n; *&n; * Version 1.0 of the AHCI specification:&n; * http://www.intel.com/technology/serialata/pdf/rev1_0.pdf&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;linux/libata.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME&t;&quot;ahci&quot;
DECL|macro|DRV_VERSION
mdefine_line|#define DRV_VERSION&t;&quot;0.11&quot;
r_enum
(brace
DECL|enumerator|AHCI_PCI_BAR
id|AHCI_PCI_BAR
op_assign
l_int|5
comma
DECL|enumerator|AHCI_MAX_SG
id|AHCI_MAX_SG
op_assign
l_int|168
comma
multiline_comment|/* hardware max is 64K */
DECL|enumerator|AHCI_DMA_BOUNDARY
id|AHCI_DMA_BOUNDARY
op_assign
l_int|0xffffffff
comma
DECL|enumerator|AHCI_USE_CLUSTERING
id|AHCI_USE_CLUSTERING
op_assign
l_int|0
comma
DECL|enumerator|AHCI_CMD_SLOT_SZ
id|AHCI_CMD_SLOT_SZ
op_assign
l_int|32
op_star
l_int|32
comma
DECL|enumerator|AHCI_RX_FIS_SZ
id|AHCI_RX_FIS_SZ
op_assign
l_int|256
comma
DECL|enumerator|AHCI_CMD_TBL_HDR
id|AHCI_CMD_TBL_HDR
op_assign
l_int|0x80
comma
DECL|enumerator|AHCI_CMD_TBL_SZ
id|AHCI_CMD_TBL_SZ
op_assign
id|AHCI_CMD_TBL_HDR
op_plus
(paren
id|AHCI_MAX_SG
op_star
l_int|16
)paren
comma
DECL|enumerator|AHCI_PORT_PRIV_DMA_SZ
id|AHCI_PORT_PRIV_DMA_SZ
op_assign
id|AHCI_CMD_SLOT_SZ
op_plus
id|AHCI_CMD_TBL_SZ
op_plus
id|AHCI_RX_FIS_SZ
comma
DECL|enumerator|AHCI_IRQ_ON_SG
id|AHCI_IRQ_ON_SG
op_assign
(paren
l_int|1
op_lshift
l_int|31
)paren
comma
DECL|enumerator|AHCI_CMD_ATAPI
id|AHCI_CMD_ATAPI
op_assign
(paren
l_int|1
op_lshift
l_int|5
)paren
comma
DECL|enumerator|AHCI_CMD_WRITE
id|AHCI_CMD_WRITE
op_assign
(paren
l_int|1
op_lshift
l_int|6
)paren
comma
DECL|enumerator|RX_FIS_D2H_REG
id|RX_FIS_D2H_REG
op_assign
l_int|0x40
comma
multiline_comment|/* offset of D2H Register FIS data */
DECL|enumerator|board_ahci
id|board_ahci
op_assign
l_int|0
comma
multiline_comment|/* global controller registers */
DECL|enumerator|HOST_CAP
id|HOST_CAP
op_assign
l_int|0x00
comma
multiline_comment|/* host capabilities */
DECL|enumerator|HOST_CTL
id|HOST_CTL
op_assign
l_int|0x04
comma
multiline_comment|/* global host control */
DECL|enumerator|HOST_IRQ_STAT
id|HOST_IRQ_STAT
op_assign
l_int|0x08
comma
multiline_comment|/* interrupt status */
DECL|enumerator|HOST_PORTS_IMPL
id|HOST_PORTS_IMPL
op_assign
l_int|0x0c
comma
multiline_comment|/* bitmap of implemented ports */
DECL|enumerator|HOST_VERSION
id|HOST_VERSION
op_assign
l_int|0x10
comma
multiline_comment|/* AHCI spec. version compliancy */
multiline_comment|/* HOST_CTL bits */
DECL|enumerator|HOST_RESET
id|HOST_RESET
op_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
comma
multiline_comment|/* reset controller; self-clear */
DECL|enumerator|HOST_IRQ_EN
id|HOST_IRQ_EN
op_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
comma
multiline_comment|/* global IRQ enable */
DECL|enumerator|HOST_AHCI_EN
id|HOST_AHCI_EN
op_assign
(paren
l_int|1
op_lshift
l_int|31
)paren
comma
multiline_comment|/* AHCI enabled */
multiline_comment|/* HOST_CAP bits */
DECL|enumerator|HOST_CAP_64
id|HOST_CAP_64
op_assign
(paren
l_int|1
op_lshift
l_int|31
)paren
comma
multiline_comment|/* PCI DAC (64-bit DMA) support */
multiline_comment|/* registers for each SATA port */
DECL|enumerator|PORT_LST_ADDR
id|PORT_LST_ADDR
op_assign
l_int|0x00
comma
multiline_comment|/* command list DMA addr */
DECL|enumerator|PORT_LST_ADDR_HI
id|PORT_LST_ADDR_HI
op_assign
l_int|0x04
comma
multiline_comment|/* command list DMA addr hi */
DECL|enumerator|PORT_FIS_ADDR
id|PORT_FIS_ADDR
op_assign
l_int|0x08
comma
multiline_comment|/* FIS rx buf addr */
DECL|enumerator|PORT_FIS_ADDR_HI
id|PORT_FIS_ADDR_HI
op_assign
l_int|0x0c
comma
multiline_comment|/* FIS rx buf addr hi */
DECL|enumerator|PORT_IRQ_STAT
id|PORT_IRQ_STAT
op_assign
l_int|0x10
comma
multiline_comment|/* interrupt status */
DECL|enumerator|PORT_IRQ_MASK
id|PORT_IRQ_MASK
op_assign
l_int|0x14
comma
multiline_comment|/* interrupt enable/disable mask */
DECL|enumerator|PORT_CMD
id|PORT_CMD
op_assign
l_int|0x18
comma
multiline_comment|/* port command */
DECL|enumerator|PORT_TFDATA
id|PORT_TFDATA
op_assign
l_int|0x20
comma
multiline_comment|/* taskfile data */
DECL|enumerator|PORT_SIG
id|PORT_SIG
op_assign
l_int|0x24
comma
multiline_comment|/* device TF signature */
DECL|enumerator|PORT_CMD_ISSUE
id|PORT_CMD_ISSUE
op_assign
l_int|0x38
comma
multiline_comment|/* command issue */
DECL|enumerator|PORT_SCR
id|PORT_SCR
op_assign
l_int|0x28
comma
multiline_comment|/* SATA phy register block */
DECL|enumerator|PORT_SCR_STAT
id|PORT_SCR_STAT
op_assign
l_int|0x28
comma
multiline_comment|/* SATA phy register: SStatus */
DECL|enumerator|PORT_SCR_CTL
id|PORT_SCR_CTL
op_assign
l_int|0x2c
comma
multiline_comment|/* SATA phy register: SControl */
DECL|enumerator|PORT_SCR_ERR
id|PORT_SCR_ERR
op_assign
l_int|0x30
comma
multiline_comment|/* SATA phy register: SError */
multiline_comment|/* PORT_IRQ_{STAT,MASK} bits */
DECL|enumerator|PORT_IRQ_COLD_PRES
id|PORT_IRQ_COLD_PRES
op_assign
(paren
l_int|1
op_lshift
l_int|31
)paren
comma
multiline_comment|/* cold presence detect */
DECL|enumerator|PORT_IRQ_TF_ERR
id|PORT_IRQ_TF_ERR
op_assign
(paren
l_int|1
op_lshift
l_int|30
)paren
comma
multiline_comment|/* task file error */
DECL|enumerator|PORT_IRQ_HBUS_ERR
id|PORT_IRQ_HBUS_ERR
op_assign
(paren
l_int|1
op_lshift
l_int|29
)paren
comma
multiline_comment|/* host bus fatal error */
DECL|enumerator|PORT_IRQ_HBUS_DATA_ERR
id|PORT_IRQ_HBUS_DATA_ERR
op_assign
(paren
l_int|1
op_lshift
l_int|28
)paren
comma
multiline_comment|/* host bus data error */
DECL|enumerator|PORT_IRQ_IF_ERR
id|PORT_IRQ_IF_ERR
op_assign
(paren
l_int|1
op_lshift
l_int|27
)paren
comma
multiline_comment|/* interface fatal error */
DECL|enumerator|PORT_IRQ_IF_NONFATAL
id|PORT_IRQ_IF_NONFATAL
op_assign
(paren
l_int|1
op_lshift
l_int|26
)paren
comma
multiline_comment|/* interface non-fatal error */
DECL|enumerator|PORT_IRQ_OVERFLOW
id|PORT_IRQ_OVERFLOW
op_assign
(paren
l_int|1
op_lshift
l_int|24
)paren
comma
multiline_comment|/* xfer exhausted available S/G */
DECL|enumerator|PORT_IRQ_BAD_PMP
id|PORT_IRQ_BAD_PMP
op_assign
(paren
l_int|1
op_lshift
l_int|23
)paren
comma
multiline_comment|/* incorrect port multiplier */
DECL|enumerator|PORT_IRQ_PHYRDY
id|PORT_IRQ_PHYRDY
op_assign
(paren
l_int|1
op_lshift
l_int|22
)paren
comma
multiline_comment|/* PhyRdy changed */
DECL|enumerator|PORT_IRQ_DEV_ILCK
id|PORT_IRQ_DEV_ILCK
op_assign
(paren
l_int|1
op_lshift
l_int|7
)paren
comma
multiline_comment|/* device interlock */
DECL|enumerator|PORT_IRQ_CONNECT
id|PORT_IRQ_CONNECT
op_assign
(paren
l_int|1
op_lshift
l_int|6
)paren
comma
multiline_comment|/* port connect change status */
DECL|enumerator|PORT_IRQ_SG_DONE
id|PORT_IRQ_SG_DONE
op_assign
(paren
l_int|1
op_lshift
l_int|5
)paren
comma
multiline_comment|/* descriptor processed */
DECL|enumerator|PORT_IRQ_UNK_FIS
id|PORT_IRQ_UNK_FIS
op_assign
(paren
l_int|1
op_lshift
l_int|4
)paren
comma
multiline_comment|/* unknown FIS rx&squot;d */
DECL|enumerator|PORT_IRQ_SDB_FIS
id|PORT_IRQ_SDB_FIS
op_assign
(paren
l_int|1
op_lshift
l_int|3
)paren
comma
multiline_comment|/* Set Device Bits FIS rx&squot;d */
DECL|enumerator|PORT_IRQ_DMAS_FIS
id|PORT_IRQ_DMAS_FIS
op_assign
(paren
l_int|1
op_lshift
l_int|2
)paren
comma
multiline_comment|/* DMA Setup FIS rx&squot;d */
DECL|enumerator|PORT_IRQ_PIOS_FIS
id|PORT_IRQ_PIOS_FIS
op_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
comma
multiline_comment|/* PIO Setup FIS rx&squot;d */
DECL|enumerator|PORT_IRQ_D2H_REG_FIS
id|PORT_IRQ_D2H_REG_FIS
op_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
comma
multiline_comment|/* D2H Register FIS rx&squot;d */
DECL|enumerator|PORT_IRQ_FATAL
id|PORT_IRQ_FATAL
op_assign
id|PORT_IRQ_TF_ERR
op_or
id|PORT_IRQ_HBUS_ERR
op_or
id|PORT_IRQ_HBUS_DATA_ERR
op_or
id|PORT_IRQ_IF_ERR
comma
DECL|enumerator|DEF_PORT_IRQ
id|DEF_PORT_IRQ
op_assign
id|PORT_IRQ_FATAL
op_or
id|PORT_IRQ_PHYRDY
op_or
id|PORT_IRQ_D2H_REG_FIS
comma
multiline_comment|/* PORT_CMD bits */
DECL|enumerator|PORT_CMD_LIST_ON
id|PORT_CMD_LIST_ON
op_assign
(paren
l_int|1
op_lshift
l_int|15
)paren
comma
multiline_comment|/* cmd list DMA engine running */
DECL|enumerator|PORT_CMD_FIS_ON
id|PORT_CMD_FIS_ON
op_assign
(paren
l_int|1
op_lshift
l_int|14
)paren
comma
multiline_comment|/* FIS DMA engine running */
DECL|enumerator|PORT_CMD_FIS_RX
id|PORT_CMD_FIS_RX
op_assign
(paren
l_int|1
op_lshift
l_int|4
)paren
comma
multiline_comment|/* Enable FIS receive DMA engine */
DECL|enumerator|PORT_CMD_POWER_ON
id|PORT_CMD_POWER_ON
op_assign
(paren
l_int|1
op_lshift
l_int|2
)paren
comma
multiline_comment|/* Power up device */
DECL|enumerator|PORT_CMD_SPIN_UP
id|PORT_CMD_SPIN_UP
op_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
comma
multiline_comment|/* Spin up device */
DECL|enumerator|PORT_CMD_START
id|PORT_CMD_START
op_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
comma
multiline_comment|/* Enable port DMA engine */
DECL|enumerator|PORT_CMD_ICC_ACTIVE
id|PORT_CMD_ICC_ACTIVE
op_assign
(paren
l_int|0x1
op_lshift
l_int|28
)paren
comma
multiline_comment|/* Put i/f in active state */
DECL|enumerator|PORT_CMD_ICC_PARTIAL
id|PORT_CMD_ICC_PARTIAL
op_assign
(paren
l_int|0x2
op_lshift
l_int|28
)paren
comma
multiline_comment|/* Put i/f in partial state */
DECL|enumerator|PORT_CMD_ICC_SLUMBER
id|PORT_CMD_ICC_SLUMBER
op_assign
(paren
l_int|0x6
op_lshift
l_int|28
)paren
comma
multiline_comment|/* Put i/f in slumber state */
)brace
suffix:semicolon
DECL|struct|ahci_cmd_hdr
r_struct
id|ahci_cmd_hdr
(brace
DECL|member|opts
id|u32
id|opts
suffix:semicolon
DECL|member|status
id|u32
id|status
suffix:semicolon
DECL|member|tbl_addr
id|u32
id|tbl_addr
suffix:semicolon
DECL|member|tbl_addr_hi
id|u32
id|tbl_addr_hi
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
(braket
l_int|4
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ahci_sg
r_struct
id|ahci_sg
(brace
DECL|member|addr
id|u32
id|addr
suffix:semicolon
DECL|member|addr_hi
id|u32
id|addr_hi
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
suffix:semicolon
DECL|member|flags_size
id|u32
id|flags_size
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ahci_host_priv
r_struct
id|ahci_host_priv
(brace
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|member|cap
id|u32
id|cap
suffix:semicolon
multiline_comment|/* cache of HOST_CAP register */
DECL|member|port_map
id|u32
id|port_map
suffix:semicolon
multiline_comment|/* cache of HOST_PORTS_IMPL reg */
)brace
suffix:semicolon
DECL|struct|ahci_port_priv
r_struct
id|ahci_port_priv
(brace
DECL|member|cmd_slot
r_struct
id|ahci_cmd_hdr
op_star
id|cmd_slot
suffix:semicolon
DECL|member|cmd_slot_dma
id|dma_addr_t
id|cmd_slot_dma
suffix:semicolon
DECL|member|cmd_tbl
r_void
op_star
id|cmd_tbl
suffix:semicolon
DECL|member|cmd_tbl_dma
id|dma_addr_t
id|cmd_tbl_dma
suffix:semicolon
DECL|member|cmd_tbl_sg
r_struct
id|ahci_sg
op_star
id|cmd_tbl_sg
suffix:semicolon
DECL|member|rx_fis
r_void
op_star
id|rx_fis
suffix:semicolon
DECL|member|rx_fis_dma
id|dma_addr_t
id|rx_fis_dma
suffix:semicolon
)brace
suffix:semicolon
r_static
id|u32
id|ahci_scr_read
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|sc_reg
)paren
suffix:semicolon
r_static
r_void
id|ahci_scr_write
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|sc_reg
comma
id|u32
id|val
)paren
suffix:semicolon
r_static
r_int
id|ahci_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
suffix:semicolon
r_static
r_int
id|ahci_qc_issue
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|ahci_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|ahci_phy_reset
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_void
id|ahci_irq_clear
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_void
id|ahci_eng_timeout
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_int
id|ahci_port_start
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_void
id|ahci_port_stop
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_void
id|ahci_host_stop
c_func
(paren
r_struct
id|ata_host_set
op_star
id|host_set
)paren
suffix:semicolon
r_static
r_void
id|ahci_qc_prep
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
suffix:semicolon
r_static
id|u8
id|ahci_check_status
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
suffix:semicolon
r_static
r_inline
r_int
id|ahci_host_intr
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
suffix:semicolon
DECL|variable|ahci_sht
r_static
id|Scsi_Host_Template
id|ahci_sht
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|DRV_NAME
comma
dot
id|queuecommand
op_assign
id|ata_scsi_queuecmd
comma
dot
id|eh_strategy_handler
op_assign
id|ata_scsi_error
comma
dot
id|can_queue
op_assign
id|ATA_DEF_QUEUE
comma
dot
id|this_id
op_assign
id|ATA_SHT_THIS_ID
comma
dot
id|sg_tablesize
op_assign
id|AHCI_MAX_SG
comma
dot
id|max_sectors
op_assign
id|ATA_MAX_SECTORS
comma
dot
id|cmd_per_lun
op_assign
id|ATA_SHT_CMD_PER_LUN
comma
dot
id|emulated
op_assign
id|ATA_SHT_EMULATED
comma
dot
id|use_clustering
op_assign
id|AHCI_USE_CLUSTERING
comma
dot
id|proc_name
op_assign
id|DRV_NAME
comma
dot
id|dma_boundary
op_assign
id|AHCI_DMA_BOUNDARY
comma
dot
id|slave_configure
op_assign
id|ata_scsi_slave_config
comma
dot
id|bios_param
op_assign
id|ata_std_bios_param
comma
)brace
suffix:semicolon
DECL|variable|ahci_ops
r_static
r_struct
id|ata_port_operations
id|ahci_ops
op_assign
(brace
dot
id|port_disable
op_assign
id|ata_port_disable
comma
dot
id|check_status
op_assign
id|ahci_check_status
comma
dot
id|dev_select
op_assign
id|ata_noop_dev_select
comma
dot
id|phy_reset
op_assign
id|ahci_phy_reset
comma
dot
id|qc_prep
op_assign
id|ahci_qc_prep
comma
dot
id|qc_issue
op_assign
id|ahci_qc_issue
comma
dot
id|eng_timeout
op_assign
id|ahci_eng_timeout
comma
dot
id|irq_handler
op_assign
id|ahci_interrupt
comma
dot
id|irq_clear
op_assign
id|ahci_irq_clear
comma
dot
id|scr_read
op_assign
id|ahci_scr_read
comma
dot
id|scr_write
op_assign
id|ahci_scr_write
comma
dot
id|port_start
op_assign
id|ahci_port_start
comma
dot
id|port_stop
op_assign
id|ahci_port_stop
comma
dot
id|host_stop
op_assign
id|ahci_host_stop
comma
)brace
suffix:semicolon
DECL|variable|ahci_port_info
r_static
r_struct
id|ata_port_info
id|ahci_port_info
(braket
)braket
op_assign
(brace
multiline_comment|/* board_ahci */
(brace
dot
id|sht
op_assign
op_amp
id|ahci_sht
comma
dot
id|host_flags
op_assign
id|ATA_FLAG_SATA
op_or
id|ATA_FLAG_NO_LEGACY
op_or
id|ATA_FLAG_SATA_RESET
op_or
id|ATA_FLAG_MMIO
comma
dot
id|pio_mask
op_assign
l_int|0x03
comma
multiline_comment|/* pio3-4 */
dot
id|udma_mask
op_assign
l_int|0x7f
comma
multiline_comment|/* udma0-6 ; FIXME */
dot
id|port_ops
op_assign
op_amp
id|ahci_ops
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|ahci_pci_tbl
r_static
r_struct
id|pci_device_id
id|ahci_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_INTEL
comma
l_int|0x2652
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|board_ahci
)brace
comma
(brace
id|PCI_VENDOR_ID_INTEL
comma
l_int|0x2653
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|board_ahci
)brace
comma
(brace
)brace
multiline_comment|/* terminate list */
)brace
suffix:semicolon
DECL|variable|ahci_pci_driver
r_static
r_struct
id|pci_driver
id|ahci_pci_driver
op_assign
(brace
dot
id|name
op_assign
id|DRV_NAME
comma
dot
id|id_table
op_assign
id|ahci_pci_tbl
comma
dot
id|probe
op_assign
id|ahci_init_one
comma
dot
id|remove
op_assign
id|ata_pci_remove_one
comma
)brace
suffix:semicolon
DECL|function|ahci_port_base_ul
r_static
r_inline
r_int
r_int
id|ahci_port_base_ul
(paren
r_int
r_int
id|base
comma
r_int
r_int
id|port
)paren
(brace
r_return
id|base
op_plus
l_int|0x100
op_plus
(paren
id|port
op_star
l_int|0x80
)paren
suffix:semicolon
)brace
DECL|function|ahci_port_base
r_static
r_inline
r_void
op_star
id|ahci_port_base
(paren
r_void
op_star
id|base
comma
r_int
r_int
id|port
)paren
(brace
r_return
(paren
r_void
op_star
)paren
id|ahci_port_base_ul
c_func
(paren
(paren
r_int
r_int
)paren
id|base
comma
id|port
)paren
suffix:semicolon
)brace
DECL|function|ahci_host_stop
r_static
r_void
id|ahci_host_stop
c_func
(paren
r_struct
id|ata_host_set
op_star
id|host_set
)paren
(brace
r_struct
id|ahci_host_priv
op_star
id|hpriv
op_assign
id|host_set-&gt;private_data
suffix:semicolon
id|kfree
c_func
(paren
id|hpriv
)paren
suffix:semicolon
)brace
DECL|function|ahci_port_start
r_static
r_int
id|ahci_port_start
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|ap-&gt;host_set-&gt;pdev
suffix:semicolon
r_struct
id|ahci_host_priv
op_star
id|hpriv
op_assign
id|ap-&gt;host_set-&gt;private_data
suffix:semicolon
r_struct
id|ahci_port_priv
op_star
id|pp
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_void
op_star
id|mem
comma
op_star
id|mmio
op_assign
id|ap-&gt;host_set-&gt;mmio_base
suffix:semicolon
r_void
op_star
id|port_mmio
op_assign
id|ahci_port_base
c_func
(paren
id|mmio
comma
id|ap-&gt;port_no
)paren
suffix:semicolon
id|dma_addr_t
id|mem_dma
suffix:semicolon
id|rc
op_assign
id|ata_port_start
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|pp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pp
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|pp
)paren
)paren
suffix:semicolon
id|mem
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|AHCI_PORT_PRIV_DMA_SZ
comma
op_amp
id|mem_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_kfree
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|AHCI_PORT_PRIV_DMA_SZ
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * First item in chunk of DMA memory: 32-slot command table,&n;&t; * 32 bytes each in size&n;&t; */
id|pp-&gt;cmd_slot
op_assign
id|mem
suffix:semicolon
id|pp-&gt;cmd_slot_dma
op_assign
id|mem_dma
suffix:semicolon
id|mem
op_add_assign
id|AHCI_CMD_SLOT_SZ
suffix:semicolon
id|mem_dma
op_add_assign
id|AHCI_CMD_SLOT_SZ
suffix:semicolon
multiline_comment|/*&n;&t; * Second item: Received-FIS area&n;&t; */
id|pp-&gt;rx_fis
op_assign
id|mem
suffix:semicolon
id|pp-&gt;rx_fis_dma
op_assign
id|mem_dma
suffix:semicolon
id|mem
op_add_assign
id|AHCI_RX_FIS_SZ
suffix:semicolon
id|mem_dma
op_add_assign
id|AHCI_RX_FIS_SZ
suffix:semicolon
multiline_comment|/*&n;&t; * Third item: data area for storing a single command&n;&t; * and its scatter-gather table&n;&t; */
id|pp-&gt;cmd_tbl
op_assign
id|mem
suffix:semicolon
id|pp-&gt;cmd_tbl_dma
op_assign
id|mem_dma
suffix:semicolon
id|pp-&gt;cmd_tbl_sg
op_assign
id|mem
op_plus
id|AHCI_CMD_TBL_HDR
suffix:semicolon
id|ap-&gt;private_data
op_assign
id|pp
suffix:semicolon
r_if
c_cond
(paren
id|hpriv-&gt;cap
op_amp
id|HOST_CAP_64
)paren
id|writel
c_func
(paren
(paren
id|pp-&gt;cmd_slot_dma
op_rshift
l_int|16
)paren
op_rshift
l_int|16
comma
id|port_mmio
op_plus
id|PORT_LST_ADDR_HI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|pp-&gt;cmd_slot_dma
op_amp
l_int|0xffffffff
comma
id|port_mmio
op_plus
id|PORT_LST_ADDR
)paren
suffix:semicolon
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_LST_ADDR
)paren
suffix:semicolon
multiline_comment|/* flush */
r_if
c_cond
(paren
id|hpriv-&gt;cap
op_amp
id|HOST_CAP_64
)paren
id|writel
c_func
(paren
(paren
id|pp-&gt;rx_fis_dma
op_rshift
l_int|16
)paren
op_rshift
l_int|16
comma
id|port_mmio
op_plus
id|PORT_FIS_ADDR_HI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|pp-&gt;rx_fis_dma
op_amp
l_int|0xffffffff
comma
id|port_mmio
op_plus
id|PORT_LST_ADDR
)paren
suffix:semicolon
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_LST_ADDR
)paren
suffix:semicolon
multiline_comment|/* flush */
id|writel
c_func
(paren
id|PORT_CMD_ICC_ACTIVE
op_or
id|PORT_CMD_FIS_RX
op_or
id|PORT_CMD_POWER_ON
op_or
id|PORT_CMD_SPIN_UP
op_or
id|PORT_CMD_START
comma
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
multiline_comment|/* flush */
r_return
l_int|0
suffix:semicolon
id|err_out_kfree
suffix:colon
id|kfree
c_func
(paren
id|pp
)paren
suffix:semicolon
id|err_out
suffix:colon
id|ata_port_stop
c_func
(paren
id|ap
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ahci_port_stop
r_static
r_void
id|ahci_port_stop
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|ap-&gt;host_set-&gt;pdev
suffix:semicolon
r_struct
id|ahci_port_priv
op_star
id|pp
op_assign
id|ap-&gt;private_data
suffix:semicolon
r_void
op_star
id|mmio
op_assign
id|ap-&gt;host_set-&gt;mmio_base
suffix:semicolon
r_void
op_star
id|port_mmio
op_assign
id|ahci_port_base
c_func
(paren
id|mmio
comma
id|ap-&gt;port_no
)paren
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|PORT_CMD_START
op_or
id|PORT_CMD_FIS_RX
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
multiline_comment|/* flush */
multiline_comment|/* spec says 500 msecs for each PORT_CMD_{START,FIS_RX} bit, so&n;&t; * this is slightly incorrect.&n;&t; */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
(paren
id|HZ
op_div
l_int|2
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|ap-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|AHCI_PORT_PRIV_DMA_SZ
comma
id|pp-&gt;cmd_slot
comma
id|pp-&gt;cmd_slot_dma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pp
)paren
suffix:semicolon
id|ata_port_stop
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
DECL|function|ahci_scr_read
r_static
id|u32
id|ahci_scr_read
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|sc_reg_in
)paren
(brace
r_int
r_int
id|sc_reg
suffix:semicolon
r_switch
c_cond
(paren
id|sc_reg_in
)paren
(brace
r_case
id|SCR_STATUS
suffix:colon
id|sc_reg
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCR_CONTROL
suffix:colon
id|sc_reg
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCR_ERROR
suffix:colon
id|sc_reg
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCR_ACTIVE
suffix:colon
id|sc_reg
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0xffffffffU
suffix:semicolon
)brace
r_return
id|readl
c_func
(paren
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.scr_addr
op_plus
(paren
id|sc_reg
op_star
l_int|4
)paren
)paren
suffix:semicolon
)brace
DECL|function|ahci_scr_write
r_static
r_void
id|ahci_scr_write
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_int
r_int
id|sc_reg_in
comma
id|u32
id|val
)paren
(brace
r_int
r_int
id|sc_reg
suffix:semicolon
r_switch
c_cond
(paren
id|sc_reg_in
)paren
(brace
r_case
id|SCR_STATUS
suffix:colon
id|sc_reg
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCR_CONTROL
suffix:colon
id|sc_reg
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCR_ERROR
suffix:colon
id|sc_reg
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCR_ACTIVE
suffix:colon
id|sc_reg
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
id|writel
c_func
(paren
id|val
comma
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.scr_addr
op_plus
(paren
id|sc_reg
op_star
l_int|4
)paren
)paren
suffix:semicolon
)brace
DECL|function|ahci_phy_reset
r_static
r_void
id|ahci_phy_reset
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_void
id|__iomem
op_star
id|port_mmio
op_assign
(paren
r_void
id|__iomem
op_star
)paren
id|ap-&gt;ioaddr.cmd_addr
suffix:semicolon
r_struct
id|ata_taskfile
id|tf
suffix:semicolon
r_struct
id|ata_device
op_star
id|dev
op_assign
op_amp
id|ap-&gt;device
(braket
l_int|0
)braket
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|__sata_phy_reset
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;flags
op_amp
id|ATA_FLAG_PORT_DISABLED
)paren
r_return
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_SIG
)paren
suffix:semicolon
id|tf.lbah
op_assign
(paren
id|tmp
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
id|tf.lbam
op_assign
(paren
id|tmp
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|tf.lbal
op_assign
(paren
id|tmp
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|tf.nsect
op_assign
(paren
id|tmp
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dev
op_member_access_from_pointer
r_class
op_assign
id|ata_dev_classify
c_func
(paren
op_amp
id|tf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ata_dev_present
c_func
(paren
id|dev
)paren
)paren
id|ata_port_disable
c_func
(paren
id|ap
)paren
suffix:semicolon
)brace
DECL|function|ahci_check_status
r_static
id|u8
id|ahci_check_status
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_void
op_star
id|mmio
op_assign
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.cmd_addr
suffix:semicolon
r_return
id|readl
c_func
(paren
id|mmio
op_plus
id|PORT_TFDATA
)paren
op_amp
l_int|0xFF
suffix:semicolon
)brace
DECL|function|ahci_fill_sg
r_static
r_void
id|ahci_fill_sg
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|ahci_port_priv
op_star
id|pp
op_assign
id|qc-&gt;ap-&gt;private_data
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Next, the S/G list.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|qc-&gt;n_elem
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|sg_len
suffix:semicolon
id|dma_addr_t
id|addr
suffix:semicolon
id|addr
op_assign
id|sg_dma_address
c_func
(paren
op_amp
id|qc-&gt;sg
(braket
id|i
)braket
)paren
suffix:semicolon
id|sg_len
op_assign
id|sg_dma_len
c_func
(paren
op_amp
id|qc-&gt;sg
(braket
id|i
)braket
)paren
suffix:semicolon
id|pp-&gt;cmd_tbl_sg
(braket
id|i
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|addr
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|pp-&gt;cmd_tbl_sg
(braket
id|i
)braket
dot
id|addr_hi
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|addr
op_rshift
l_int|16
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|pp-&gt;cmd_tbl_sg
(braket
id|i
)braket
dot
id|flags_size
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_len
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
DECL|function|ahci_qc_prep
r_static
r_void
id|ahci_qc_prep
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|ahci_port_priv
op_star
id|pp
op_assign
id|qc-&gt;ap-&gt;private_data
suffix:semicolon
id|u32
id|opts
suffix:semicolon
r_const
id|u32
id|cmd_fis_len
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* five dwords */
multiline_comment|/*&n;&t; * Fill in command slot information (currently only one slot,&n;&t; * slot 0, is currently since we don&squot;t do queueing)&n;&t; */
id|opts
op_assign
(paren
id|qc-&gt;n_elem
op_lshift
l_int|16
)paren
op_or
id|cmd_fis_len
suffix:semicolon
r_if
c_cond
(paren
id|qc-&gt;tf.flags
op_amp
id|ATA_TFLAG_WRITE
)paren
id|opts
op_or_assign
id|AHCI_CMD_WRITE
suffix:semicolon
r_switch
c_cond
(paren
id|qc-&gt;tf.protocol
)paren
(brace
r_case
id|ATA_PROT_ATAPI
suffix:colon
r_case
id|ATA_PROT_ATAPI_NODATA
suffix:colon
r_case
id|ATA_PROT_ATAPI_DMA
suffix:colon
id|opts
op_or_assign
id|AHCI_CMD_ATAPI
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
)brace
id|pp-&gt;cmd_slot
(braket
l_int|0
)braket
dot
id|opts
op_assign
id|cpu_to_le32
c_func
(paren
id|opts
)paren
suffix:semicolon
id|pp-&gt;cmd_slot
(braket
l_int|0
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|pp-&gt;cmd_slot
(braket
l_int|0
)braket
dot
id|tbl_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|pp-&gt;cmd_tbl_dma
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|pp-&gt;cmd_slot
(braket
l_int|0
)braket
dot
id|tbl_addr_hi
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|pp-&gt;cmd_tbl_dma
op_rshift
l_int|16
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Fill in command table information.  First, the header,&n;&t; * a SATA Register - Host to Device command FIS.&n;&t; */
id|ata_tf_to_fis
c_func
(paren
op_amp
id|qc-&gt;tf
comma
id|pp-&gt;cmd_tbl
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|qc-&gt;flags
op_amp
id|ATA_QCFLAG_DMAMAP
)paren
)paren
r_return
suffix:semicolon
id|ahci_fill_sg
c_func
(paren
id|qc
)paren
suffix:semicolon
)brace
DECL|function|ahci_dma_complete
r_static
r_inline
r_void
id|ahci_dma_complete
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_queued_cmd
op_star
id|qc
comma
r_int
id|have_err
)paren
(brace
multiline_comment|/* get drive status; clear intr; complete txn */
id|ata_qc_complete
c_func
(paren
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|ap-&gt;active_tag
)paren
comma
id|have_err
ques
c_cond
id|ATA_ERR
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|ahci_intr_error
r_static
r_void
id|ahci_intr_error
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
id|u32
id|irq_stat
)paren
(brace
r_void
op_star
id|mmio
op_assign
id|ap-&gt;host_set-&gt;mmio_base
suffix:semicolon
r_void
op_star
id|port_mmio
op_assign
id|ahci_port_base
c_func
(paren
id|mmio
comma
id|ap-&gt;port_no
)paren
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
r_int
id|work
suffix:semicolon
multiline_comment|/* stop DMA */
id|tmp
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
id|tmp
op_and_assign
id|PORT_CMD_START
op_or
id|PORT_CMD_FIS_RX
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
multiline_comment|/* wait for engine to stop.  TODO: this could be&n;&t; * as long as 500 msec&n;&t; */
id|work
op_assign
l_int|1000
suffix:semicolon
r_while
c_loop
(paren
id|work
op_decrement
OG
l_int|0
)paren
(brace
id|tmp
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|PORT_CMD_LIST_ON
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* clear SATA phy error, if any */
id|tmp
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_SCR_ERR
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|port_mmio
op_plus
id|PORT_SCR_ERR
)paren
suffix:semicolon
multiline_comment|/* if DRQ/BSY is set, device needs to be reset.&n;&t; * if so, issue COMRESET&n;&t; */
id|tmp
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_TFDATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
(paren
id|ATA_BUSY
op_or
id|ATA_DRQ
)paren
)paren
(brace
id|writel
c_func
(paren
l_int|0x301
comma
id|port_mmio
op_plus
id|PORT_SCR_CTL
)paren
suffix:semicolon
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_SCR_CTL
)paren
suffix:semicolon
multiline_comment|/* flush */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x300
comma
id|port_mmio
op_plus
id|PORT_SCR_CTL
)paren
suffix:semicolon
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_SCR_CTL
)paren
suffix:semicolon
multiline_comment|/* flush */
)brace
multiline_comment|/* re-start DMA */
id|tmp
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
id|tmp
op_or_assign
id|PORT_CMD_START
op_or
id|PORT_CMD_FIS_RX
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
multiline_comment|/* flush */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ata%u: error occurred, port reset&bslash;n&quot;
comma
id|ap-&gt;port_no
)paren
suffix:semicolon
)brace
DECL|function|ahci_eng_timeout
r_static
r_void
id|ahci_eng_timeout
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
r_void
op_star
id|mmio
op_assign
id|ap-&gt;host_set-&gt;mmio_base
suffix:semicolon
r_void
op_star
id|port_mmio
op_assign
id|ahci_port_base
c_func
(paren
id|mmio
comma
id|ap-&gt;port_no
)paren
suffix:semicolon
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|ahci_intr_error
c_func
(paren
id|ap
comma
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_IRQ_STAT
)paren
)paren
suffix:semicolon
id|qc
op_assign
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|ap-&gt;active_tag
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ata%u: BUG: timeout without command&bslash;n&quot;
comma
id|ap-&gt;id
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* hack alert!  We cannot use the supplied completion&n;&t; &t; * function from inside the -&gt;eh_strategy_handler() thread.&n;&t; &t; * libata is the only user of -&gt;eh_strategy_handler() in&n;&t; &t; * any kernel, so the default scsi_done() assumes it is&n;&t; &t; * not being called from the SCSI EH.&n;&t; &t; */
id|qc-&gt;scsidone
op_assign
id|scsi_finish_command
suffix:semicolon
id|ata_qc_complete
c_func
(paren
id|qc
comma
id|ATA_ERR
)paren
suffix:semicolon
)brace
)brace
DECL|function|ahci_host_intr
r_static
r_inline
r_int
id|ahci_host_intr
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
comma
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_void
op_star
id|mmio
op_assign
id|ap-&gt;host_set-&gt;mmio_base
suffix:semicolon
r_void
op_star
id|port_mmio
op_assign
id|ahci_port_base
c_func
(paren
id|mmio
comma
id|ap-&gt;port_no
)paren
suffix:semicolon
id|u32
id|status
comma
id|serr
comma
id|ci
suffix:semicolon
id|serr
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_SCR_ERR
)paren
suffix:semicolon
id|writel
c_func
(paren
id|serr
comma
id|port_mmio
op_plus
id|PORT_SCR_ERR
)paren
suffix:semicolon
id|status
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_IRQ_STAT
)paren
suffix:semicolon
id|writel
c_func
(paren
id|status
comma
id|port_mmio
op_plus
id|PORT_IRQ_STAT
)paren
suffix:semicolon
id|ci
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_CMD_ISSUE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
(paren
id|ci
op_amp
l_int|0x1
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|qc
)paren
(brace
id|ata_qc_complete
c_func
(paren
id|qc
comma
l_int|0
)paren
suffix:semicolon
id|qc
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
id|PORT_IRQ_FATAL
)paren
(brace
id|ahci_intr_error
c_func
(paren
id|ap
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qc
)paren
id|ata_qc_complete
c_func
(paren
id|qc
comma
id|ATA_ERR
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ahci_irq_clear
r_static
r_void
id|ahci_irq_clear
c_func
(paren
r_struct
id|ata_port
op_star
id|ap
)paren
(brace
multiline_comment|/* TODO */
)brace
DECL|function|ahci_interrupt
r_static
id|irqreturn_t
id|ahci_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ata_host_set
op_star
id|host_set
op_assign
id|dev_instance
suffix:semicolon
r_struct
id|ahci_host_priv
op_star
id|hpriv
suffix:semicolon
r_int
r_int
id|i
comma
id|handled
op_assign
l_int|0
suffix:semicolon
r_void
op_star
id|mmio
suffix:semicolon
id|u32
id|irq_stat
comma
id|irq_ack
op_assign
l_int|0
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|hpriv
op_assign
id|host_set-&gt;private_data
suffix:semicolon
id|mmio
op_assign
id|host_set-&gt;mmio_base
suffix:semicolon
multiline_comment|/* sigh.  0xffffffff is a valid return from h/w */
id|irq_stat
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_IRQ_STAT
)paren
suffix:semicolon
id|irq_stat
op_and_assign
id|hpriv-&gt;port_map
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq_stat
)paren
r_return
id|IRQ_NONE
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|host_set-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|host_set-&gt;n_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;port %u&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|ap
op_assign
id|host_set-&gt;ports
(braket
id|i
)braket
suffix:semicolon
id|tmp
op_assign
id|irq_stat
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_logical_and
id|ap
)paren
(brace
r_struct
id|ata_queued_cmd
op_star
id|qc
suffix:semicolon
id|qc
op_assign
id|ata_qc_from_tag
c_func
(paren
id|ap
comma
id|ap-&gt;active_tag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ahci_host_intr
c_func
(paren
id|ap
comma
id|qc
)paren
)paren
id|irq_ack
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|irq_ack
)paren
(brace
id|writel
c_func
(paren
id|irq_ack
comma
id|mmio
op_plus
id|HOST_IRQ_STAT
)paren
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|host_set-&gt;lock
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
DECL|function|ahci_qc_issue
r_static
r_int
id|ahci_qc_issue
c_func
(paren
r_struct
id|ata_queued_cmd
op_star
id|qc
)paren
(brace
r_struct
id|ata_port
op_star
id|ap
op_assign
id|qc-&gt;ap
suffix:semicolon
r_void
op_star
id|mmio
op_assign
(paren
r_void
op_star
)paren
id|ap-&gt;ioaddr.cmd_addr
suffix:semicolon
id|writel
c_func
(paren
l_int|1
comma
id|mmio
op_plus
id|PORT_CMD_ISSUE
)paren
suffix:semicolon
id|readl
c_func
(paren
id|mmio
op_plus
id|PORT_CMD_ISSUE
)paren
suffix:semicolon
multiline_comment|/* flush */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ahci_setup_port
r_static
r_void
id|ahci_setup_port
c_func
(paren
r_struct
id|ata_ioports
op_star
id|port
comma
r_int
r_int
id|base
comma
r_int
r_int
id|port_idx
)paren
(brace
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER, base==0x%lx, port_idx %u&bslash;n&quot;
comma
id|base
comma
id|port_idx
)paren
suffix:semicolon
id|base
op_assign
id|ahci_port_base_ul
c_func
(paren
id|base
comma
id|port_idx
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;base now==0x%lx&bslash;n&quot;
comma
id|base
)paren
suffix:semicolon
id|port-&gt;cmd_addr
op_assign
id|base
suffix:semicolon
id|port-&gt;scr_addr
op_assign
id|base
op_plus
id|PORT_SCR
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ahci_host_init
r_static
r_int
id|ahci_host_init
c_func
(paren
r_struct
id|ata_probe_ent
op_star
id|probe_ent
)paren
(brace
r_struct
id|ahci_host_priv
op_star
id|hpriv
op_assign
id|probe_ent-&gt;private_data
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|probe_ent-&gt;pdev
suffix:semicolon
r_void
id|__iomem
op_star
id|mmio
op_assign
id|probe_ent-&gt;mmio_base
suffix:semicolon
id|u32
id|tmp
comma
id|cap_save
suffix:semicolon
id|u16
id|tmp16
suffix:semicolon
r_int
r_int
id|i
comma
id|j
comma
id|using_dac
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_void
id|__iomem
op_star
id|port_mmio
suffix:semicolon
id|cap_save
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_CAP
)paren
suffix:semicolon
id|cap_save
op_and_assign
(paren
(paren
l_int|1
op_lshift
l_int|28
)paren
op_or
(paren
l_int|1
op_lshift
l_int|17
)paren
)paren
suffix:semicolon
id|cap_save
op_or_assign
(paren
l_int|1
op_lshift
l_int|27
)paren
suffix:semicolon
multiline_comment|/* global controller reset */
id|tmp
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|HOST_RESET
)paren
op_eq
l_int|0
)paren
(brace
id|writel
c_func
(paren
id|tmp
op_or
id|HOST_RESET
comma
id|mmio
op_plus
id|HOST_CTL
)paren
suffix:semicolon
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_CTL
)paren
suffix:semicolon
multiline_comment|/* flush */
)brace
multiline_comment|/* reset must complete within 1 second, or&n;&t; * the hardware should be considered fried.&n;&t; */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_plus
l_int|1
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|HOST_RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): controller reset failed (0x%x)&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
comma
id|tmp
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|writel
c_func
(paren
id|HOST_AHCI_EN
comma
id|mmio
op_plus
id|HOST_CTL
)paren
suffix:semicolon
(paren
r_void
)paren
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_CTL
)paren
suffix:semicolon
multiline_comment|/* flush */
id|writel
c_func
(paren
id|cap_save
comma
id|mmio
op_plus
id|HOST_CAP
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xf
comma
id|mmio
op_plus
id|HOST_PORTS_IMPL
)paren
suffix:semicolon
(paren
r_void
)paren
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_PORTS_IMPL
)paren
suffix:semicolon
multiline_comment|/* flush */
id|pci_read_config_word
c_func
(paren
id|pdev
comma
l_int|0x92
comma
op_amp
id|tmp16
)paren
suffix:semicolon
id|tmp16
op_or_assign
l_int|0xf
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pdev
comma
l_int|0x92
comma
id|tmp16
)paren
suffix:semicolon
id|hpriv-&gt;cap
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_CAP
)paren
suffix:semicolon
id|hpriv-&gt;port_map
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_PORTS_IMPL
)paren
suffix:semicolon
id|probe_ent-&gt;n_ports
op_assign
(paren
id|hpriv-&gt;cap
op_amp
l_int|0x1f
)paren
op_plus
l_int|1
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;cap 0x%x  port_map 0x%x  n_ports %d&bslash;n&quot;
comma
id|hpriv-&gt;cap
comma
id|hpriv-&gt;port_map
comma
id|probe_ent-&gt;n_ports
)paren
suffix:semicolon
id|using_dac
op_assign
id|hpriv-&gt;cap
op_amp
id|HOST_CAP_64
suffix:semicolon
r_if
c_cond
(paren
id|using_dac
op_logical_and
op_logical_neg
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffffffffffffULL
)paren
)paren
(brace
id|rc
op_assign
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffffffffffffULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|rc
op_assign
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffffULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): 64-bit DMA enable failed&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
id|hpriv-&gt;flags
op_or_assign
id|HOST_CAP_64
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffffULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): 32-bit DMA enable failed&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffffULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): 32-bit consistent DMA enable failed&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|probe_ent-&gt;n_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hpriv-&gt;port_map
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
)paren
r_continue
suffix:semicolon
id|port_mmio
op_assign
id|ahci_port_base
c_func
(paren
id|mmio
comma
id|i
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;mmio %p  port_mmio %p&bslash;n&quot;
comma
id|mmio
comma
id|port_mmio
)paren
suffix:semicolon
id|ahci_setup_port
c_func
(paren
op_amp
id|probe_ent-&gt;port
(braket
id|i
)braket
comma
(paren
r_int
r_int
)paren
id|mmio
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* make sure port is not active */
id|tmp
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;PORT_CMD 0x%x&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
(paren
id|PORT_CMD_LIST_ON
op_or
id|PORT_CMD_FIS_ON
op_or
id|PORT_CMD_FIS_RX
op_or
id|PORT_CMD_START
)paren
)paren
(brace
id|tmp
op_and_assign
op_complement
(paren
id|PORT_CMD_LIST_ON
op_or
id|PORT_CMD_FIS_ON
op_or
id|PORT_CMD_FIS_RX
op_or
id|PORT_CMD_START
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
multiline_comment|/* flush */
multiline_comment|/* spec says 500 msecs for each bit, so&n;&t;&t;&t; * this is slightly incorrect.&n;&t;&t;&t; */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
(paren
id|HZ
op_div
l_int|2
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|PORT_CMD_SPIN_UP
comma
id|port_mmio
op_plus
id|PORT_CMD
)paren
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|j
OL
l_int|100
)paren
(brace
id|msleep
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_SCR_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0xf
)paren
op_eq
l_int|0x3
)paren
r_break
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
id|tmp
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_SCR_ERR
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;PORT_SCR_ERR 0x%x&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|port_mmio
op_plus
id|PORT_SCR_ERR
)paren
suffix:semicolon
multiline_comment|/* ack any pending irq events for this port */
id|tmp
op_assign
id|readl
c_func
(paren
id|port_mmio
op_plus
id|PORT_IRQ_STAT
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;PORT_IRQ_STAT 0x%x&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
)paren
id|writel
c_func
(paren
id|tmp
comma
id|port_mmio
op_plus
id|PORT_IRQ_STAT
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|1
op_lshift
id|i
comma
id|mmio
op_plus
id|HOST_IRQ_STAT
)paren
suffix:semicolon
multiline_comment|/* set irq mask (enables interrupts) */
id|writel
c_func
(paren
id|DEF_PORT_IRQ
comma
id|port_mmio
op_plus
id|PORT_IRQ_MASK
)paren
suffix:semicolon
)brace
id|tmp
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_CTL
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;HOST_CTL 0x%x&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
op_or
id|HOST_IRQ_EN
comma
id|mmio
op_plus
id|HOST_CTL
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_CTL
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;HOST_CTL 0x%x&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* move to PCI layer, integrate w/ MSI stuff */
DECL|function|pci_enable_intx
r_static
r_void
id|pci_enable_intx
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|u16
id|pci_command
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_command
op_amp
id|PCI_COMMAND_INTX_DISABLE
)paren
(brace
id|pci_command
op_and_assign
op_complement
id|PCI_COMMAND_INTX_DISABLE
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
id|pci_command
)paren
suffix:semicolon
)brace
)brace
DECL|function|ahci_print_info
r_static
r_void
id|ahci_print_info
c_func
(paren
r_struct
id|ata_probe_ent
op_star
id|probe_ent
)paren
(brace
r_struct
id|ahci_host_priv
op_star
id|hpriv
op_assign
id|probe_ent-&gt;private_data
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|probe_ent-&gt;pdev
suffix:semicolon
r_void
op_star
id|mmio
op_assign
id|probe_ent-&gt;mmio_base
suffix:semicolon
id|u32
id|vers
comma
id|cap
comma
id|impl
comma
id|speed
suffix:semicolon
r_const
r_char
op_star
id|speed_s
suffix:semicolon
id|vers
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|HOST_VERSION
)paren
suffix:semicolon
id|cap
op_assign
id|hpriv-&gt;cap
suffix:semicolon
id|impl
op_assign
id|hpriv-&gt;port_map
suffix:semicolon
id|speed
op_assign
(paren
id|cap
op_rshift
l_int|20
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_eq
l_int|1
)paren
id|speed_s
op_assign
l_string|&quot;1.5&quot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|speed
op_eq
l_int|2
)paren
id|speed_s
op_assign
l_string|&quot;3&quot;
suffix:semicolon
r_else
id|speed_s
op_assign
l_string|&quot;?&quot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DRV_NAME
l_string|&quot;(%s) AHCI %02x%02x.%02x%02x &quot;
l_string|&quot;%u slots %u ports %s Gbps 0x%x impl&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
comma
(paren
id|vers
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
comma
(paren
id|vers
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
comma
(paren
id|vers
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|vers
op_amp
l_int|0xff
comma
(paren
(paren
id|cap
op_rshift
l_int|8
)paren
op_amp
l_int|0x1f
)paren
op_plus
l_int|1
comma
(paren
id|cap
op_amp
l_int|0x1f
)paren
op_plus
l_int|1
comma
id|speed_s
comma
id|impl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DRV_NAME
l_string|&quot;(%s) flags: &quot;
l_string|&quot;%s%s%s%s%s%s&quot;
l_string|&quot;%s%s%s%s%s%s%s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|31
)paren
ques
c_cond
l_string|&quot;64bit &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|30
)paren
ques
c_cond
l_string|&quot;ncq &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|28
)paren
ques
c_cond
l_string|&quot;ilck &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|27
)paren
ques
c_cond
l_string|&quot;stag &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|26
)paren
ques
c_cond
l_string|&quot;pm &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|25
)paren
ques
c_cond
l_string|&quot;led &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|24
)paren
ques
c_cond
l_string|&quot;clo &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|19
)paren
ques
c_cond
l_string|&quot;nz &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|18
)paren
ques
c_cond
l_string|&quot;only &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|17
)paren
ques
c_cond
l_string|&quot;pmp &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|15
)paren
ques
c_cond
l_string|&quot;pio &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|14
)paren
ques
c_cond
l_string|&quot;slum &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
(paren
l_int|1
op_lshift
l_int|13
)paren
ques
c_cond
l_string|&quot;part &quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
DECL|function|ahci_init_one
r_static
r_int
id|ahci_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_static
r_int
id|printed_version
suffix:semicolon
r_struct
id|ata_probe_ent
op_star
id|probe_ent
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ahci_host_priv
op_star
id|hpriv
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
r_void
op_star
id|mmio_base
suffix:semicolon
r_int
r_int
id|board_idx
op_assign
(paren
r_int
r_int
)paren
id|ent-&gt;driver_data
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|printed_version
op_increment
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
id|DRV_NAME
l_string|&quot; version &quot;
id|DRV_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If this driver happens to only be useful on Apple&squot;s K2, then&n;&t; * we should check that here as it has a normal Serverworks ID&n;&t; */
id|rc
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|DRV_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out
suffix:semicolon
id|pci_enable_intx
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|probe_ent
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|probe_ent
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|probe_ent
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_regions
suffix:semicolon
)brace
id|memset
c_func
(paren
id|probe_ent
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|probe_ent
)paren
)paren
suffix:semicolon
id|probe_ent-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|probe_ent-&gt;node
)paren
suffix:semicolon
id|mmio_base
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|AHCI_PCI_BAR
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
id|AHCI_PCI_BAR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mmio_base
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_free_ent
suffix:semicolon
)brace
id|base
op_assign
(paren
r_int
r_int
)paren
id|mmio_base
suffix:semicolon
id|hpriv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|hpriv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpriv
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_iounmap
suffix:semicolon
)brace
id|memset
c_func
(paren
id|hpriv
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|hpriv
)paren
)paren
suffix:semicolon
id|probe_ent-&gt;sht
op_assign
id|ahci_port_info
(braket
id|board_idx
)braket
dot
id|sht
suffix:semicolon
id|probe_ent-&gt;host_flags
op_assign
id|ahci_port_info
(braket
id|board_idx
)braket
dot
id|host_flags
suffix:semicolon
id|probe_ent-&gt;pio_mask
op_assign
id|ahci_port_info
(braket
id|board_idx
)braket
dot
id|pio_mask
suffix:semicolon
id|probe_ent-&gt;udma_mask
op_assign
id|ahci_port_info
(braket
id|board_idx
)braket
dot
id|udma_mask
suffix:semicolon
id|probe_ent-&gt;port_ops
op_assign
id|ahci_port_info
(braket
id|board_idx
)braket
dot
id|port_ops
suffix:semicolon
id|probe_ent-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|probe_ent-&gt;irq_flags
op_assign
id|SA_SHIRQ
suffix:semicolon
id|probe_ent-&gt;mmio_base
op_assign
id|mmio_base
suffix:semicolon
id|probe_ent-&gt;private_data
op_assign
id|hpriv
suffix:semicolon
multiline_comment|/* initialize adapter */
id|rc
op_assign
id|ahci_host_init
c_func
(paren
id|probe_ent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out_hpriv
suffix:semicolon
id|ahci_print_info
c_func
(paren
id|probe_ent
)paren
suffix:semicolon
multiline_comment|/* FIXME: check ata_device_add return value */
id|ata_device_add
c_func
(paren
id|probe_ent
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|probe_ent
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_hpriv
suffix:colon
id|kfree
c_func
(paren
id|hpriv
)paren
suffix:semicolon
id|err_out_iounmap
suffix:colon
id|iounmap
c_func
(paren
id|mmio_base
)paren
suffix:semicolon
id|err_out_free_ent
suffix:colon
id|kfree
c_func
(paren
id|probe_ent
)paren
suffix:semicolon
id|err_out_regions
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ahci_init
r_static
r_int
id|__init
id|ahci_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|ahci_pci_driver
)paren
suffix:semicolon
)brace
DECL|function|ahci_exit
r_static
r_void
id|__exit
id|ahci_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|ahci_pci_driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jeff Garzik&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;AHCI SATA low-level driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|ahci_pci_tbl
)paren
suffix:semicolon
DECL|variable|ahci_init
id|module_init
c_func
(paren
id|ahci_init
)paren
suffix:semicolon
DECL|variable|ahci_exit
id|module_exit
c_func
(paren
id|ahci_exit
)paren
suffix:semicolon
eof
