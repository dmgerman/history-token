multiline_comment|/*****************************************************************************/
multiline_comment|/* ips.c -- driver for the IBM ServeRAID controller                          */
multiline_comment|/*                                                                           */
multiline_comment|/* Written By: Keith Mitchell, IBM Corporation                               */
multiline_comment|/*                                                                           */
multiline_comment|/* Copyright (C) 2000 IBM Corporation                                        */
multiline_comment|/*                                                                           */
multiline_comment|/* This program is free software; you can redistribute it and/or modify      */
multiline_comment|/* it under the terms of the GNU General Public License as published by      */
multiline_comment|/* the Free Software Foundation; either version 2 of the License, or         */
multiline_comment|/* (at your option) any later version.                                       */
multiline_comment|/*                                                                           */
multiline_comment|/* This program is distributed in the hope that it will be useful,           */
multiline_comment|/* but WITHOUT ANY WARRANTY; without even the implied warranty of            */
multiline_comment|/* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             */
multiline_comment|/* GNU General Public License for more details.                              */
multiline_comment|/*                                                                           */
multiline_comment|/* NO WARRANTY                                                               */
multiline_comment|/* THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR        */
multiline_comment|/* CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT      */
multiline_comment|/* LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,      */
multiline_comment|/* MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is    */
multiline_comment|/* solely responsible for determining the appropriateness of using and       */
multiline_comment|/* distributing the Program and assumes all risks associated with its        */
multiline_comment|/* exercise of rights under this Agreement, including but not limited to     */
multiline_comment|/* the risks and costs of program errors, damage to or loss of data,         */
multiline_comment|/* programs or equipment, and unavailability or interruption of operations.  */
multiline_comment|/*                                                                           */
multiline_comment|/* DISCLAIMER OF LIABILITY                                                   */
multiline_comment|/* NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY   */
multiline_comment|/* DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL        */
multiline_comment|/* DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND   */
multiline_comment|/* ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR     */
multiline_comment|/* TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE    */
multiline_comment|/* USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED  */
multiline_comment|/* HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES             */
multiline_comment|/*                                                                           */
multiline_comment|/* You should have received a copy of the GNU General Public License         */
multiline_comment|/* along with this program; if not, write to the Free Software               */
multiline_comment|/* Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA */
multiline_comment|/*                                                                           */
multiline_comment|/* Bugs/Comments/Suggestions about this driver should be mailed to:          */
multiline_comment|/*      ipslinux@us.ibm.com          &t;                                      */
multiline_comment|/*                                                                           */
multiline_comment|/* For system support issues, contact your local IBM Customer support.       */
multiline_comment|/* Directions to find IBM Customer Support for each country can be found at: */
multiline_comment|/*      http://www.ibm.com/planetwide/                                       */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
multiline_comment|/*****************************************************************************/
multiline_comment|/* Change Log                                                                */
multiline_comment|/*                                                                           */
multiline_comment|/* 0.99.02  - Breakup commands that are bigger than 8 * the stripe size      */
multiline_comment|/* 0.99.03  - Make interrupt routine handle all completed request on the     */
multiline_comment|/*            adapter not just the first one                                 */
multiline_comment|/*          - Make sure passthru commands get woken up if we run out of      */
multiline_comment|/*            SCBs                                                           */
multiline_comment|/*          - Send all of the commands on the queue at once rather than      */
multiline_comment|/*            one at a time since the card will support it.                  */
multiline_comment|/* 0.99.04  - Fix race condition in the passthru mechanism -- this required  */
multiline_comment|/*            the interface to the utilities to change                       */
multiline_comment|/*          - Fix error recovery code                                        */
multiline_comment|/* 0.99.05  - Fix an oops when we get certain passthru commands              */
multiline_comment|/* 1.00.00  - Initial Public Release                                         */
multiline_comment|/*            Functionally equivalent to 0.99.05                             */
multiline_comment|/* 3.60.00  - Bump max commands to 128 for use with ServeRAID firmware 3.60  */
multiline_comment|/*          - Change version to 3.60 to coincide with ServeRAID release      */
multiline_comment|/*            numbering.                                                     */
multiline_comment|/* 3.60.01  - Remove bogus error check in passthru routine                   */
multiline_comment|/* 3.60.02  - Make DCDB direction based on lookup table                      */
multiline_comment|/*          - Only allow one DCDB command to a SCSI ID at a time             */
multiline_comment|/* 4.00.00  - Add support for ServeRAID 4                                    */
multiline_comment|/* 4.00.01  - Add support for First Failure Data Capture                     */
multiline_comment|/* 4.00.02  - Fix problem with PT DCDB with no buffer                        */
multiline_comment|/* 4.00.03  - Add alternative passthru interface                             */
multiline_comment|/*          - Add ability to flash ServeRAID BIOS                            */
multiline_comment|/* 4.00.04  - Rename structures/constants to be prefixed with IPS_           */
multiline_comment|/* 4.00.05  - Remove wish_block from init routine                            */
multiline_comment|/*          - Use linux/spinlock.h instead of asm/spinlock.h for kernels     */
multiline_comment|/*            2.3.18 and later                                               */
multiline_comment|/*          - Sync with other changes from the 2.3 kernels                   */
multiline_comment|/* 4.00.06  - Fix timeout with initial FFDC command                          */
multiline_comment|/* 4.00.06a - Port to 2.4 (trivial) -- Christoph Hellwig &lt;hch@caldera.de&gt;    */
multiline_comment|/* 4.10.00  - Add support for ServeRAID 4M/4L                                */
multiline_comment|/* 4.10.13  - Fix for dynamic unload and proc file system                    */
multiline_comment|/* 4.20.03  - Rename version to coincide with new release schedules          */
multiline_comment|/*            Performance fixes                                              */
multiline_comment|/*            Fix truncation of /proc files with cat                         */
multiline_comment|/*            Merge in changes through kernel 2.4.0test1ac21                 */
multiline_comment|/* 4.20.13  - Fix some failure cases / reset code                            */
multiline_comment|/*          - Hook into the reboot_notifier to flush the controller cache    */
multiline_comment|/* 4.50.01  - Fix problem when there is a hole in logical drive numbering    */
multiline_comment|/* 4.70.09  - Use a Common ( Large Buffer ) for Flashing from the JCRM CD    */
multiline_comment|/*          - Add IPSSEND Flash Support                                      */
multiline_comment|/*          - Set Sense Data for Unknown SCSI Command                        */
multiline_comment|/*          - Use Slot Number from NVRAM Page 5                              */
multiline_comment|/*          - Restore caller&squot;s DCDB Structure                                */
multiline_comment|/* 4.70.12  - Corrective actions for bad controller ( during initialization )*/
multiline_comment|/* 4.70.13  - Don&squot;t Send CDB&squot;s if we already know the device is not present  */
multiline_comment|/*          - Don&squot;t release HA Lock in ips_next() until SC taken off queue   */
multiline_comment|/*          - Unregister SCSI device in ips_release()                        */
multiline_comment|/* 4.70.15  - Fix Breakup for very large ( non-SG ) requests in ips_done()   */
multiline_comment|/* 4.71.00  - Change all memory allocations to not use GFP_DMA flag          */
multiline_comment|/*            Code Clean-Up for 2.4.x kernel                                 */
multiline_comment|/* 4.72.00  - Allow for a Scatter-Gather Element to exceed MAX_XFER Size     */
multiline_comment|/* 4.72.01  - I/O Mapped Memory release ( so &quot;insmod ips&quot; does not Fail )    */
multiline_comment|/*            Don&squot;t Issue Internal FFDC Command if there are Active Commands */
multiline_comment|/*            Close Window for getting too many IOCTL&squot;s active               */
multiline_comment|/* 4.80.00    Make ia64 Safe                                                 */
multiline_comment|/* 4.80.04    Eliminate calls to strtok() if 2.4.x or greater                */
multiline_comment|/*            Adjustments to Device Queue Depth                              */
multiline_comment|/* 4.80.14    Take all semaphores off stack                                  */
multiline_comment|/*            Clean Up New_IOCTL path                                        */
multiline_comment|/* 4.80.20    Set max_sectors in Scsi_Host structure ( if &gt;= 2.4.7 kernel )  */
multiline_comment|/*            5 second delay needed after resetting an i960 adapter          */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * Conditional Compilation directives for this driver:&n; *&n; * IPS_DEBUG            - Turn on debugging info&n; *&n; *&n; * Parameters:&n; *&n; * debug:&lt;number&gt;       - Set debug level to &lt;number&gt;&n; *                        NOTE: only works when IPS_DEBUG compile directive&n; *                              is used.&n; *&n; *       1              - Normal debug messages&n; *       2              - Verbose debug messages&n; *       11             - Method trace (non interrupt)&n; *       12             - Method trace (includes interrupt)&n; *&n; * noreset              - Don&squot;t reset the controller&n; * nocmdline            - Turn off passthru support&n; * noi2o                - Don&squot;t use I2O Queues (ServeRAID 4 only)&n; * nommap               - Don&squot;t use memory mapped I/O&n; * ioctlsize            - Initial size of the IOCTL buffer&n; */
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#ifndef NO_IPS_CMDLINE
macro_line|#include &lt;scsi/sg.h&gt;
macro_line|#endif
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ips.h&quot;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,3,18)
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#else
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,3,13)
macro_line|#include &lt;linux/init.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#ifdef MODULE
DECL|variable|ips
r_static
r_char
op_star
id|ips
op_assign
l_int|NULL
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ips
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * DRIVER_VER&n; */
DECL|macro|IPS_VERSION_HIGH
mdefine_line|#define IPS_VERSION_HIGH        &quot;4.80&quot;
DECL|macro|IPS_VERSION_LOW
mdefine_line|#define IPS_VERSION_LOW         &quot;.26 &quot;
macro_line|#if LINUX_VERSION_CODE &lt; LinuxVersionCode(2,3,27)
DECL|variable|proc_scsi_ips
r_struct
id|proc_dir_entry
id|proc_scsi_ips
op_assign
(brace
l_int|0
comma
l_int|3
comma
l_string|&quot;ips&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
macro_line|#endif
macro_line|#if !defined(__i386__) &amp;&amp; !defined(__ia64__)
macro_line|#error &quot;This driver has only been tested on the x86/ia64 platforms&quot;
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; LinuxVersionCode(2,2,0)
macro_line|#error &quot;This driver only works with kernel 2.2.0 and later&quot;
macro_line|#endif
macro_line|#if !defined(NO_IPS_CMDLINE) &amp;&amp; ((SG_BIG_BUFF &lt; 8192) || !defined(SG_BIG_BUFF))
macro_line|#error &quot;To use the command-line interface you need to define SG_BIG_BUFF&quot;
macro_line|#endif
macro_line|#ifdef IPS_DEBUG
DECL|macro|METHOD_TRACE
mdefine_line|#define METHOD_TRACE(s, i)    if (ips_debug &gt;= (i+10)) printk(KERN_NOTICE s &quot;&bslash;n&quot;);
DECL|macro|DEBUG
mdefine_line|#define DEBUG(i, s)           if (ips_debug &gt;= i) printk(KERN_NOTICE s &quot;&bslash;n&quot;);
DECL|macro|DEBUG_VAR
mdefine_line|#define DEBUG_VAR(i, s, v...) if (ips_debug &gt;= i) printk(KERN_NOTICE s &quot;&bslash;n&quot;, v);
macro_line|#else
DECL|macro|METHOD_TRACE
mdefine_line|#define METHOD_TRACE(s, i)
DECL|macro|DEBUG
mdefine_line|#define DEBUG(i, s)
DECL|macro|DEBUG_VAR
mdefine_line|#define DEBUG_VAR(i, s, v...)
macro_line|#endif
multiline_comment|/*&n; * global variables&n; */
DECL|variable|ips_name
r_static
r_const
r_char
id|ips_name
(braket
)braket
op_assign
l_string|&quot;ips&quot;
suffix:semicolon
DECL|variable|ips_sh
r_static
r_struct
id|Scsi_Host
op_star
id|ips_sh
(braket
id|IPS_MAX_ADAPTERS
)braket
suffix:semicolon
multiline_comment|/* Array of host controller structures */
DECL|variable|ips_ha
r_static
id|ips_ha_t
op_star
id|ips_ha
(braket
id|IPS_MAX_ADAPTERS
)braket
suffix:semicolon
multiline_comment|/* Array of HA structures */
DECL|variable|ips_next_controller
r_static
r_int
r_int
id|ips_next_controller
op_assign
l_int|0
suffix:semicolon
DECL|variable|ips_num_controllers
r_static
r_int
r_int
id|ips_num_controllers
op_assign
l_int|0
suffix:semicolon
DECL|variable|ips_released_controllers
r_static
r_int
r_int
id|ips_released_controllers
op_assign
l_int|0
suffix:semicolon
DECL|variable|ips_cmd_timeout
r_static
r_int
id|ips_cmd_timeout
op_assign
l_int|60
suffix:semicolon
DECL|variable|ips_reset_timeout
r_static
r_int
id|ips_reset_timeout
op_assign
l_int|60
op_star
l_int|5
suffix:semicolon
DECL|variable|ips_force_memio
r_static
r_int
id|ips_force_memio
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Always use Memory Mapped I/O    */
DECL|variable|ips_force_i2o
r_static
r_int
id|ips_force_i2o
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Always use I2O command delivery */
DECL|variable|ips_resetcontroller
r_static
r_int
id|ips_resetcontroller
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Reset the controller            */
DECL|variable|ips_cmdline
r_static
r_int
id|ips_cmdline
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Support for passthru            */
DECL|variable|ips_ioctlsize
r_static
r_int
id|ips_ioctlsize
op_assign
id|IPS_IOCTL_SIZE
suffix:semicolon
multiline_comment|/* Size of the ioctl buffer        */
DECL|variable|ips_cd_boot
r_static
r_int
id|ips_cd_boot
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Booting from ServeRAID Manager CD */
DECL|variable|ips_FlashData
r_static
r_char
op_star
id|ips_FlashData
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* CD Boot - Flash Data Buffer      */
DECL|variable|ips_FlashDataInUse
r_static
r_int
id|ips_FlashDataInUse
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CD Boot - Flash Data In Use Flag */
macro_line|#ifdef IPS_DEBUG
DECL|variable|ips_debug
r_static
r_int
id|ips_debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Debug mode                      */
macro_line|#endif
multiline_comment|/*&n; * Necessary forward function protoypes&n; */
r_static
r_int
id|ips_halt
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
id|ulong
id|event
comma
r_void
op_star
id|buf
)paren
suffix:semicolon
DECL|macro|MAX_ADAPTER_NAME
mdefine_line|#define MAX_ADAPTER_NAME 11
DECL|variable|ips_adapter_name
r_static
r_char
id|ips_adapter_name
(braket
)braket
(braket
l_int|30
)braket
op_assign
(brace
l_string|&quot;ServeRAID&quot;
comma
l_string|&quot;ServeRAID II&quot;
comma
l_string|&quot;ServeRAID on motherboard&quot;
comma
l_string|&quot;ServeRAID on motherboard&quot;
comma
l_string|&quot;ServeRAID 3H&quot;
comma
l_string|&quot;ServeRAID 3L&quot;
comma
l_string|&quot;ServeRAID 4H&quot;
comma
l_string|&quot;ServeRAID 4M&quot;
comma
l_string|&quot;ServeRAID 4L&quot;
comma
l_string|&quot;ServeRAID 4Mx&quot;
comma
l_string|&quot;ServeRAID 4Lx&quot;
)brace
suffix:semicolon
DECL|variable|ips_notifier
r_static
r_struct
id|notifier_block
id|ips_notifier
op_assign
(brace
id|ips_halt
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n; * Direction table&n; */
DECL|variable|ips_command_direction
r_static
r_char
id|ips_command_direction
(braket
)braket
op_assign
(brace
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_NONE
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_IN
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_OUT
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
comma
id|IPS_DATA_UNK
)brace
suffix:semicolon
multiline_comment|/*&n; * Function prototypes&n; */
r_int
id|ips_detect
c_func
(paren
id|Scsi_Host_Template
op_star
)paren
suffix:semicolon
r_int
id|ips_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
r_int
id|ips_eh_abort
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_int
id|ips_eh_reset
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_int
id|ips_queue
c_func
(paren
id|Scsi_Cmnd
op_star
comma
r_void
(paren
op_star
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
suffix:semicolon
r_int
id|ips_biosparam
c_func
(paren
id|Disk
op_star
comma
id|kdev_t
comma
r_int
op_star
)paren
suffix:semicolon
r_const
r_char
op_star
id|ips_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
r_void
id|do_ipsintr
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_hainit
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_map_status
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
comma
id|ips_stat_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_send
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
comma
id|ips_scb_callback
)paren
suffix:semicolon
r_static
r_int
id|ips_send_wait
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_send_cmd
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_online
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_inquiry
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_rdcap
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_msense
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_reqsen
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_allocatescbs
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_reset_copperhead
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_reset_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_reset_morpheus
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_issue_copperhead
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_issue_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_issue_i2o
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_issue_i2o_memio
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_isintr_copperhead
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_isintr_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_isintr_morpheus
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_wait
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_write_driver_status
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_read_adapter_status
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_read_subsystem_parameters
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_read_config
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_clear_adapter
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_readwrite_page5
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_init_copperhead
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_init_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_init_morpheus
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_isinit_copperhead
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_isinit_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_isinit_morpheus
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_erase_bios
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_program_bios
c_func
(paren
id|ips_ha_t
op_star
comma
r_char
op_star
comma
id|u_int32_t
comma
id|u_int32_t
)paren
suffix:semicolon
r_static
r_int
id|ips_verify_bios
c_func
(paren
id|ips_ha_t
op_star
comma
r_char
op_star
comma
id|u_int32_t
comma
id|u_int32_t
)paren
suffix:semicolon
r_static
r_int
id|ips_erase_bios_memio
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_program_bios_memio
c_func
(paren
id|ips_ha_t
op_star
comma
r_char
op_star
comma
id|u_int32_t
comma
id|u_int32_t
)paren
suffix:semicolon
r_static
r_int
id|ips_verify_bios_memio
c_func
(paren
id|ips_ha_t
op_star
comma
r_char
op_star
comma
id|u_int32_t
comma
id|u_int32_t
)paren
suffix:semicolon
r_static
r_void
id|ips_flash_bios_section
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_flash_bios_segment
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_scheduled_flash_bios
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_create_nvrampage5
c_func
(paren
id|ips_ha_t
op_star
comma
id|IPS_NVRAM_P5
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_get_bios_version
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ips_identify_controller
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_select_queue_depth
c_func
(paren
r_struct
id|Scsi_Host
op_star
comma
id|Scsi_Device
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_chkstatus
c_func
(paren
id|ips_ha_t
op_star
comma
id|IPS_STATUS
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_enable_int_copperhead
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_enable_int_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_enable_int_morpheus
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_intr_copperhead
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_intr_morpheus
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_next
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ipsintr_blocking
c_func
(paren
id|ips_ha_t
op_star
comma
r_struct
id|ips_scb
op_star
)paren
suffix:semicolon
r_static
r_void
id|ipsintr_done
c_func
(paren
id|ips_ha_t
op_star
comma
r_struct
id|ips_scb
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_done
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_free
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_init_scb
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_freescb
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_statinit
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_statinit_memio
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_fix_ffdc_time
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
comma
id|time_t
)paren
suffix:semicolon
r_static
r_void
id|ips_ffdc_reset
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ips_ffdc_time
c_func
(paren
id|ips_ha_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
id|u_int32_t
id|ips_statupd_copperhead
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
id|u_int32_t
id|ips_statupd_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
id|u_int32_t
id|ips_statupd_morpheus
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
id|ips_scb_t
op_star
id|ips_getscb
c_func
(paren
id|ips_ha_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ips_putq_scb_head
c_func
(paren
id|ips_scb_queue_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ips_putq_scb_tail
c_func
(paren
id|ips_scb_queue_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ips_putq_wait_head
c_func
(paren
id|ips_wait_queue_t
op_star
comma
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ips_putq_wait_tail
c_func
(paren
id|ips_wait_queue_t
op_star
comma
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ips_putq_copp_head
c_func
(paren
id|ips_copp_queue_t
op_star
comma
id|ips_copp_wait_item_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|ips_putq_copp_tail
c_func
(paren
id|ips_copp_queue_t
op_star
comma
id|ips_copp_wait_item_t
op_star
)paren
suffix:semicolon
r_static
r_inline
id|ips_scb_t
op_star
id|ips_removeq_scb_head
c_func
(paren
id|ips_scb_queue_t
op_star
)paren
suffix:semicolon
r_static
r_inline
id|ips_scb_t
op_star
id|ips_removeq_scb
c_func
(paren
id|ips_scb_queue_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_inline
id|Scsi_Cmnd
op_star
id|ips_removeq_wait_head
c_func
(paren
id|ips_wait_queue_t
op_star
)paren
suffix:semicolon
r_static
r_inline
id|Scsi_Cmnd
op_star
id|ips_removeq_wait
c_func
(paren
id|ips_wait_queue_t
op_star
comma
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_inline
id|ips_copp_wait_item_t
op_star
id|ips_removeq_copp
c_func
(paren
id|ips_copp_queue_t
op_star
comma
id|ips_copp_wait_item_t
op_star
)paren
suffix:semicolon
r_static
r_inline
id|ips_copp_wait_item_t
op_star
id|ips_removeq_copp_head
c_func
(paren
id|ips_copp_queue_t
op_star
)paren
suffix:semicolon
macro_line|#ifndef NO_IPS_CMDLINE
r_static
r_int
id|ips_is_passthru
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_make_passthru
c_func
(paren
id|ips_ha_t
op_star
comma
id|Scsi_Cmnd
op_star
comma
id|ips_scb_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_usrcmd
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_passthru_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ips_newusrcmd
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_passthru_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|ips_cleanup_passthru
c_func
(paren
id|ips_ha_t
op_star
comma
id|ips_scb_t
op_star
)paren
suffix:semicolon
macro_line|#endif
r_int
id|ips_proc_info
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|ips_host_info
c_func
(paren
id|ips_ha_t
op_star
comma
r_char
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|copy_mem_info
c_func
(paren
id|IPS_INFOSTR
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|copy_info
c_func
(paren
id|IPS_INFOSTR
op_star
comma
r_char
op_star
comma
dot
dot
dot
)paren
suffix:semicolon
multiline_comment|/*--------------------------------------------------------------------------*/
multiline_comment|/* Exported Functions                                                       */
multiline_comment|/*--------------------------------------------------------------------------*/
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_setup                                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   setup parameters to the driver                                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,3,13)
r_static
r_int
DECL|function|ips_setup
id|ips_setup
c_func
(paren
r_char
op_star
id|ips_str
)paren
(brace
macro_line|#else
r_void
id|ips_setup
c_func
(paren
r_char
op_star
id|ips_str
comma
r_int
op_star
id|dummy
)paren
(brace
macro_line|#endif
r_int
id|i
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; LinuxVersionCode(2,4,0)
r_char
op_star
id|p
suffix:semicolon
r_char
id|tokens
(braket
l_int|3
)braket
op_assign
(brace
l_char|&squot;,&squot;
comma
l_char|&squot;.&squot;
comma
l_int|0
)brace
suffix:semicolon
macro_line|#endif
r_char
op_star
id|key
suffix:semicolon
r_char
op_star
id|value
suffix:semicolon
id|IPS_OPTION
id|options
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;noreset&quot;
comma
op_amp
id|ips_resetcontroller
comma
l_int|0
)brace
comma
macro_line|#ifdef IPS_DEBUG
(brace
l_string|&quot;debug&quot;
comma
op_amp
id|ips_debug
comma
l_int|1
)brace
comma
macro_line|#endif
(brace
l_string|&quot;noi2o&quot;
comma
op_amp
id|ips_force_i2o
comma
l_int|0
)brace
comma
(brace
l_string|&quot;nommap&quot;
comma
op_amp
id|ips_force_memio
comma
l_int|0
)brace
comma
(brace
l_string|&quot;nocmdline&quot;
comma
op_amp
id|ips_cmdline
comma
l_int|0
)brace
comma
(brace
l_string|&quot;ioctlsize&quot;
comma
op_amp
id|ips_ioctlsize
comma
id|IPS_IOCTL_SIZE
)brace
comma
(brace
l_string|&quot;cdboot&quot;
comma
op_amp
id|ips_cd_boot
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_setup&quot;
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t use strtok() anymore ( if 2.4 Kernel or beyond ) */
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,4,0)
multiline_comment|/* Search for value */
r_while
c_loop
(paren
(paren
id|key
op_assign
id|strsep
c_func
(paren
op_amp
id|ips_str
comma
l_string|&quot;,.&quot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|key
)paren
r_continue
suffix:semicolon
id|value
op_assign
id|strchr
c_func
(paren
id|key
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
op_star
id|value
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/*&n;      * We now have key/value pairs.&n;      * Update the variables&n;      */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|options
)paren
op_div
r_sizeof
(paren
id|options
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|key
comma
id|options
(braket
id|i
)braket
dot
id|option_name
comma
id|strlen
c_func
(paren
id|options
(braket
id|i
)braket
dot
id|option_name
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
)paren
op_star
id|options
(braket
id|i
)braket
dot
id|option_flag
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
op_star
id|options
(braket
id|i
)braket
dot
id|option_flag
op_assign
id|options
(braket
id|i
)braket
dot
id|option_value
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#else
r_for
c_loop
(paren
id|key
op_assign
id|strtok
c_func
(paren
id|ips_str
comma
id|tokens
)paren
suffix:semicolon
id|key
suffix:semicolon
id|key
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
id|tokens
)paren
)paren
(brace
id|p
op_assign
id|key
suffix:semicolon
multiline_comment|/* Search for value */
r_while
c_loop
(paren
(paren
id|p
)paren
op_logical_and
(paren
op_star
id|p
op_ne
l_char|&squot;:&squot;
)paren
)paren
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
op_star
id|p
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|value
op_assign
id|p
op_plus
l_int|1
suffix:semicolon
)brace
r_else
id|value
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;       * We now have key/value pairs.&n;       * Update the variables&n;       */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|options
)paren
op_div
r_sizeof
(paren
id|options
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|key
comma
id|options
(braket
id|i
)braket
dot
id|option_name
comma
id|strlen
c_func
(paren
id|ips_str
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
)paren
op_star
id|options
(braket
id|i
)braket
dot
id|option_flag
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
op_star
id|options
(braket
id|i
)braket
dot
id|option_flag
op_assign
id|options
(braket
id|i
)braket
dot
id|option_value
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,3,13)
r_return
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,3,13)
id|__setup
c_func
(paren
l_string|&quot;ips=&quot;
comma
id|ips_setup
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_detect                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Detect and initialize the driver                                       */
multiline_comment|/*                                                                          */
multiline_comment|/* NOTE: this routine is called under the io_request_lock spinlock          */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_detect
id|ips_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|SHT
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|u_int32_t
id|io_addr
suffix:semicolon
id|u_int32_t
id|mem_addr
suffix:semicolon
id|u_int32_t
id|io_len
suffix:semicolon
id|u_int32_t
id|mem_len
suffix:semicolon
id|u_int16_t
id|planer
suffix:semicolon
id|u_int8_t
id|revision_id
suffix:semicolon
id|u_int8_t
id|bus
suffix:semicolon
id|u_int8_t
id|func
suffix:semicolon
id|u_int8_t
id|irq
suffix:semicolon
id|u_int16_t
id|deviceID
(braket
l_int|2
)braket
suffix:semicolon
id|u_int16_t
id|subdevice_id
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|j
suffix:semicolon
id|u_int32_t
id|count
suffix:semicolon
r_char
op_star
id|ioremap_ptr
suffix:semicolon
r_char
op_star
id|mem_ptr
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|pci_dev
op_star
id|morpheus
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|pci_dev
op_star
id|trombone
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; LinuxVersionCode(2,3,14)
id|u_int32_t
id|currbar
suffix:semicolon
id|u_int32_t
id|maskbar
suffix:semicolon
id|u_int8_t
id|barnum
suffix:semicolon
macro_line|#endif
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_detect&quot;
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_if
c_cond
(paren
id|ips
)paren
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,3,13)
id|ips_setup
c_func
(paren
id|ips
)paren
suffix:semicolon
macro_line|#else
id|ips_setup
c_func
(paren
id|ips
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
multiline_comment|/* If Booting from the ServeRAID Manager CD, Allocate a large Flash  */
multiline_comment|/* Buffer ( so we won&squot;t need to allocate one for each adapter ).     */
r_if
c_cond
(paren
id|ips_cd_boot
)paren
(brace
id|ips_FlashData
op_assign
(paren
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ips_FlashData
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* The validity of this pointer is checked in ips_make_passthru() before it is used */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ERROR: Can&squot;t Allocate Large Buffer for Flashing&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|SHT-&gt;proc_info
op_assign
id|ips_proc_info
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; LinuxVersionCode(2,3,27)
id|SHT-&gt;proc_dir
op_assign
op_amp
id|proc_scsi_ips
suffix:semicolon
macro_line|#else
id|SHT-&gt;proc_name
op_assign
l_string|&quot;ips&quot;
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_PCI)
multiline_comment|/* initalize number of controllers */
id|ips_num_controllers
op_assign
l_int|0
suffix:semicolon
id|ips_next_controller
op_assign
l_int|0
suffix:semicolon
id|ips_released_controllers
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|morpheus
op_assign
id|pci_find_device
c_func
(paren
id|IPS_VENDORID
comma
id|IPS_DEVICEID_MORPHEUS
comma
id|morpheus
)paren
suffix:semicolon
id|trombone
op_assign
id|pci_find_device
c_func
(paren
id|IPS_VENDORID
comma
id|IPS_DEVICEID_COPPERHEAD
comma
id|trombone
)paren
suffix:semicolon
multiline_comment|/* determine which controller to probe first */
r_if
c_cond
(paren
op_logical_neg
id|morpheus
)paren
(brace
multiline_comment|/* we only have trombone */
id|dev
(braket
l_int|0
)braket
op_assign
id|trombone
suffix:semicolon
id|dev
(braket
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
id|deviceID
(braket
l_int|0
)braket
op_assign
id|IPS_DEVICEID_COPPERHEAD
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|trombone
)paren
(brace
multiline_comment|/* we only have morpheus */
id|dev
(braket
l_int|0
)braket
op_assign
id|morpheus
suffix:semicolon
id|dev
(braket
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
id|deviceID
(braket
l_int|0
)braket
op_assign
id|IPS_DEVICEID_MORPHEUS
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* we have both in the system */
r_if
c_cond
(paren
id|trombone-&gt;bus-&gt;number
OL
id|morpheus-&gt;bus-&gt;number
)paren
(brace
id|dev
(braket
l_int|0
)braket
op_assign
id|trombone
suffix:semicolon
id|dev
(braket
l_int|1
)braket
op_assign
id|morpheus
suffix:semicolon
id|deviceID
(braket
l_int|0
)braket
op_assign
id|IPS_DEVICEID_COPPERHEAD
suffix:semicolon
id|deviceID
(braket
l_int|1
)braket
op_assign
id|IPS_DEVICEID_MORPHEUS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|trombone-&gt;bus-&gt;number
OG
id|morpheus-&gt;bus-&gt;number
)paren
(brace
id|dev
(braket
l_int|0
)braket
op_assign
id|morpheus
suffix:semicolon
id|dev
(braket
l_int|1
)braket
op_assign
id|trombone
suffix:semicolon
id|deviceID
(braket
l_int|0
)braket
op_assign
id|IPS_DEVICEID_MORPHEUS
suffix:semicolon
id|deviceID
(braket
l_int|1
)braket
op_assign
id|IPS_DEVICEID_COPPERHEAD
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* further detection required */
r_if
c_cond
(paren
id|trombone-&gt;devfn
OL
id|morpheus-&gt;devfn
)paren
(brace
id|dev
(braket
l_int|0
)braket
op_assign
id|trombone
suffix:semicolon
id|dev
(braket
l_int|1
)braket
op_assign
id|morpheus
suffix:semicolon
id|deviceID
(braket
l_int|0
)braket
op_assign
id|IPS_DEVICEID_COPPERHEAD
suffix:semicolon
id|deviceID
(braket
l_int|1
)braket
op_assign
id|IPS_DEVICEID_MORPHEUS
suffix:semicolon
)brace
r_else
(brace
id|dev
(braket
l_int|0
)braket
op_assign
id|morpheus
suffix:semicolon
id|dev
(braket
l_int|1
)braket
op_assign
id|trombone
suffix:semicolon
id|deviceID
(braket
l_int|0
)braket
op_assign
id|IPS_DEVICEID_MORPHEUS
suffix:semicolon
id|deviceID
(braket
l_int|1
)braket
op_assign
id|IPS_DEVICEID_COPPERHEAD
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Now scan the controllers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|ips_next_controller
op_ge
id|IPS_MAX_ADAPTERS
)paren
r_break
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,4,0)
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
(braket
id|i
)braket
)paren
)paren
r_break
suffix:semicolon
macro_line|#endif
multiline_comment|/* stuff that we get in dev */
id|irq
op_assign
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|irq
suffix:semicolon
id|bus
op_assign
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|bus-&gt;number
suffix:semicolon
id|func
op_assign
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|devfn
suffix:semicolon
multiline_comment|/* Init MEM/IO addresses to 0 */
id|mem_addr
op_assign
l_int|0
suffix:semicolon
id|io_addr
op_assign
l_int|0
suffix:semicolon
id|mem_len
op_assign
l_int|0
suffix:semicolon
id|io_len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,4,0)
r_if
c_cond
(paren
op_logical_neg
id|pci_resource_start
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|j
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|pci_resource_flags
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|j
)paren
op_amp
id|IORESOURCE_IO
)paren
(brace
id|io_addr
op_assign
id|pci_resource_start
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|j
)paren
suffix:semicolon
id|io_len
op_assign
id|pci_resource_len
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|j
)paren
suffix:semicolon
)brace
r_else
(brace
id|mem_addr
op_assign
id|pci_resource_start
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|j
)paren
suffix:semicolon
id|mem_len
op_assign
id|pci_resource_len
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|j
)paren
suffix:semicolon
)brace
macro_line|#elif LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,3,14)
r_if
c_cond
(paren
op_logical_neg
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|resource
(braket
id|j
)braket
dot
id|start
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|resource
(braket
id|j
)braket
dot
id|start
op_amp
id|PCI_BASE_ADDRESS_SPACE
)paren
op_eq
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
id|io_addr
op_assign
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|resource
(braket
id|j
)braket
dot
id|start
suffix:semicolon
id|io_len
op_assign
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|resource
(braket
id|j
)braket
dot
id|end
op_minus
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|resource
(braket
id|j
)braket
dot
id|start
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|mem_addr
op_assign
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|resource
(braket
id|j
)braket
dot
id|start
suffix:semicolon
id|mem_len
op_assign
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|resource
(braket
id|j
)braket
dot
id|end
op_minus
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|resource
(braket
id|j
)braket
dot
id|start
op_plus
l_int|1
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|base_address
(braket
id|j
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|base_address
(braket
id|j
)braket
op_amp
id|PCI_BASE_ADDRESS_SPACE
)paren
op_eq
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
id|barnum
op_assign
id|PCI_BASE_ADDRESS_0
op_plus
(paren
id|j
op_star
l_int|4
)paren
suffix:semicolon
id|io_addr
op_assign
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|base_address
(braket
id|j
)braket
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
multiline_comment|/* Get Size */
id|pci_read_config_dword
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|barnum
comma
op_amp
id|currbar
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|barnum
comma
op_complement
l_int|0
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|barnum
comma
op_amp
id|maskbar
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|barnum
comma
id|currbar
)paren
suffix:semicolon
id|io_len
op_assign
op_complement
(paren
id|maskbar
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|barnum
op_assign
id|PCI_BASE_ADDRESS_0
op_plus
(paren
id|j
op_star
l_int|4
)paren
suffix:semicolon
id|mem_addr
op_assign
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|base_address
(braket
id|j
)braket
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
multiline_comment|/* Get Size */
id|pci_read_config_dword
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|barnum
comma
op_amp
id|currbar
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|barnum
comma
op_complement
l_int|0
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|barnum
comma
op_amp
id|maskbar
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|barnum
comma
id|currbar
)paren
suffix:semicolon
id|mem_len
op_assign
op_complement
(paren
id|maskbar
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
)paren
op_plus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* setup memory mapped area (if applicable) */
r_if
c_cond
(paren
id|mem_addr
)paren
(brace
id|u_int32_t
id|base
suffix:semicolon
id|u_int32_t
id|offs
suffix:semicolon
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) detect, Memory region %x, size: %d&quot;
comma
id|ips_name
comma
id|ips_next_controller
comma
id|mem_addr
comma
id|mem_len
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,3,17)
r_if
c_cond
(paren
id|check_mem_region
c_func
(paren
id|mem_addr
comma
id|mem_len
)paren
)paren
(brace
multiline_comment|/* Couldn&squot;t allocate io space */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) couldn&squot;t allocate IO space %x len %d.&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
comma
id|io_addr
comma
id|io_len
)paren
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|request_mem_region
c_func
(paren
id|mem_addr
comma
id|mem_len
comma
l_string|&quot;ips&quot;
)paren
suffix:semicolon
macro_line|#endif
id|base
op_assign
id|mem_addr
op_amp
id|PAGE_MASK
suffix:semicolon
id|offs
op_assign
id|mem_addr
op_minus
id|base
suffix:semicolon
id|ioremap_ptr
op_assign
id|ioremap
c_func
(paren
id|base
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|mem_ptr
op_assign
id|ioremap_ptr
op_plus
id|offs
suffix:semicolon
)brace
r_else
(brace
id|ioremap_ptr
op_assign
l_int|NULL
suffix:semicolon
id|mem_ptr
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* setup I/O mapped area (if applicable) */
r_if
c_cond
(paren
id|io_addr
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) detect, IO region %x, size: %d&quot;
comma
id|ips_name
comma
id|ips_next_controller
comma
id|io_addr
comma
id|io_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|io_addr
comma
id|io_len
)paren
)paren
(brace
multiline_comment|/* Couldn&squot;t allocate io space */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) couldn&squot;t allocate IO space %x len %d.&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
comma
id|io_addr
comma
id|io_len
)paren
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|io_addr
comma
id|io_len
comma
l_string|&quot;ips&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* get planer status */
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|dev
(braket
id|i
)braket
comma
l_int|0x04
comma
op_amp
id|planer
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) can&squot;t get planer status.&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* check to see if an onboard planer controller is disabled */
r_if
c_cond
(paren
op_logical_neg
(paren
id|planer
op_amp
l_int|0x000C
)paren
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) detect, Onboard ServeRAID disabled by BIOS&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) detect bus %d, func %x, irq %d, io %x, mem: %x, ptr: %p&quot;
comma
id|ips_name
comma
id|ips_next_controller
comma
id|bus
comma
id|func
comma
id|irq
comma
id|io_addr
comma
id|mem_addr
comma
id|mem_ptr
)paren
suffix:semicolon
multiline_comment|/* get the revision ID */
r_if
c_cond
(paren
id|pci_read_config_byte
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|PCI_REVISION_ID
comma
op_amp
id|revision_id
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) can&squot;t get revision id.&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; LinuxVersionCode(2,3,15)
multiline_comment|/* get the subdevice id */
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|dev
(braket
id|i
)braket
comma
id|PCI_SUBSYSTEM_ID
comma
op_amp
id|subdevice_id
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) can&squot;t get subdevice id.&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#else
id|subdevice_id
op_assign
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|subsystem_device
suffix:semicolon
macro_line|#endif
multiline_comment|/* found a controller */
id|sh
op_assign
id|scsi_register
c_func
(paren
id|SHT
comma
r_sizeof
(paren
id|ips_ha_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to register controller with SCSI subsystem - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha
op_assign
id|IPS_HA
c_func
(paren
id|sh
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ha
comma
l_int|0
comma
r_sizeof
(paren
id|ips_ha_t
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize spin lock */
id|spin_lock_init
c_func
(paren
op_amp
id|ha-&gt;scb_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ha-&gt;copp_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ha-&gt;ips_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist.lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist.lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ha-&gt;scb_activelist.lock
)paren
suffix:semicolon
id|ips_sh
(braket
id|ips_next_controller
)braket
op_assign
id|sh
suffix:semicolon
id|ips_ha
(braket
id|ips_next_controller
)braket
op_assign
id|ha
suffix:semicolon
id|ips_num_controllers
op_increment
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|1
suffix:semicolon
id|ha-&gt;enq
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|IPS_ENQ
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;enq
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host inquiry structure - skipping contoller&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_sh
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;adapt
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|IPS_ADAPTER
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;adapt
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host adapt structure - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_sh
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;conf
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|IPS_CONF
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;conf
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host conf structure - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_sh
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;nvram
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|IPS_NVRAM_P5
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;nvram
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host nvram structure - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_sh
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;subsys
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|IPS_SUBSYS
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;subsys
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host subsystem structure - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_sh
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;dummy
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|IPS_IO_CMD
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;dummy
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate host dummy structure - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_sh
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_for
c_loop
(paren
id|count
op_assign
id|PAGE_SIZE
comma
id|ha-&gt;ioctl_order
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|ips_ioctlsize
suffix:semicolon
id|ha-&gt;ioctl_order
op_increment
comma
id|count
op_lshift_assign
l_int|1
)paren
suffix:semicolon
id|ha-&gt;ioctl_data
op_assign
(paren
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|ha-&gt;ioctl_order
)paren
suffix:semicolon
id|ha-&gt;ioctl_datasize
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;ioctl_data
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Unable to allocate ioctl data&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ha-&gt;ioctl_data
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;ioctl_order
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;ioctl_datasize
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Store away needed values for later use */
id|sh-&gt;io_port
op_assign
id|io_addr
suffix:semicolon
id|sh-&gt;n_io_port
op_assign
id|io_addr
ques
c_cond
l_int|255
suffix:colon
l_int|0
suffix:semicolon
id|sh-&gt;unique_id
op_assign
(paren
id|io_addr
)paren
ques
c_cond
id|io_addr
suffix:colon
id|mem_addr
suffix:semicolon
id|sh-&gt;irq
op_assign
id|irq
suffix:semicolon
id|sh-&gt;select_queue_depths
op_assign
id|ips_select_queue_depth
suffix:semicolon
id|sh-&gt;sg_tablesize
op_assign
id|sh-&gt;hostt-&gt;sg_tablesize
suffix:semicolon
id|sh-&gt;can_queue
op_assign
id|sh-&gt;hostt-&gt;can_queue
suffix:semicolon
id|sh-&gt;cmd_per_lun
op_assign
id|sh-&gt;hostt-&gt;cmd_per_lun
suffix:semicolon
id|sh-&gt;unchecked_isa_dma
op_assign
id|sh-&gt;hostt-&gt;unchecked_isa_dma
suffix:semicolon
id|sh-&gt;use_clustering
op_assign
id|sh-&gt;hostt-&gt;use_clustering
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,4,7)
id|sh-&gt;max_sectors
op_assign
l_int|128
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; LinuxVersionCode(2,3,32)
id|sh-&gt;wish_block
op_assign
id|FALSE
suffix:semicolon
macro_line|#endif
multiline_comment|/* Store info in HA structure */
id|ha-&gt;irq
op_assign
id|irq
suffix:semicolon
id|ha-&gt;io_addr
op_assign
id|io_addr
suffix:semicolon
id|ha-&gt;io_len
op_assign
id|io_len
suffix:semicolon
id|ha-&gt;mem_addr
op_assign
id|mem_addr
suffix:semicolon
id|ha-&gt;mem_len
op_assign
id|mem_len
suffix:semicolon
id|ha-&gt;mem_ptr
op_assign
id|mem_ptr
suffix:semicolon
id|ha-&gt;ioremap_ptr
op_assign
id|ioremap_ptr
suffix:semicolon
id|ha-&gt;host_num
op_assign
id|ips_next_controller
suffix:semicolon
id|ha-&gt;revision_id
op_assign
id|revision_id
suffix:semicolon
id|ha-&gt;slot_num
op_assign
id|PCI_SLOT
c_func
(paren
id|dev
(braket
id|i
)braket
op_member_access_from_pointer
id|devfn
)paren
suffix:semicolon
id|ha-&gt;device_id
op_assign
id|deviceID
(braket
id|i
)braket
suffix:semicolon
id|ha-&gt;subdevice_id
op_assign
id|subdevice_id
suffix:semicolon
id|ha-&gt;pcidev
op_assign
id|dev
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/*&n;          * Setup Functions&n;          */
r_if
c_cond
(paren
id|IPS_IS_MORPHEUS
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* morpheus */
id|ha-&gt;func.isintr
op_assign
id|ips_isintr_morpheus
suffix:semicolon
id|ha-&gt;func.isinit
op_assign
id|ips_isinit_morpheus
suffix:semicolon
id|ha-&gt;func.issue
op_assign
id|ips_issue_i2o_memio
suffix:semicolon
id|ha-&gt;func.init
op_assign
id|ips_init_morpheus
suffix:semicolon
id|ha-&gt;func.statupd
op_assign
id|ips_statupd_morpheus
suffix:semicolon
id|ha-&gt;func.reset
op_assign
id|ips_reset_morpheus
suffix:semicolon
id|ha-&gt;func.intr
op_assign
id|ips_intr_morpheus
suffix:semicolon
id|ha-&gt;func.enableint
op_assign
id|ips_enable_int_morpheus
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|IPS_USE_MEMIO
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* copperhead w/MEMIO */
id|ha-&gt;func.isintr
op_assign
id|ips_isintr_copperhead_memio
suffix:semicolon
id|ha-&gt;func.isinit
op_assign
id|ips_isinit_copperhead_memio
suffix:semicolon
id|ha-&gt;func.init
op_assign
id|ips_init_copperhead_memio
suffix:semicolon
id|ha-&gt;func.statupd
op_assign
id|ips_statupd_copperhead_memio
suffix:semicolon
id|ha-&gt;func.statinit
op_assign
id|ips_statinit_memio
suffix:semicolon
id|ha-&gt;func.reset
op_assign
id|ips_reset_copperhead_memio
suffix:semicolon
id|ha-&gt;func.intr
op_assign
id|ips_intr_copperhead
suffix:semicolon
id|ha-&gt;func.erasebios
op_assign
id|ips_erase_bios_memio
suffix:semicolon
id|ha-&gt;func.programbios
op_assign
id|ips_program_bios_memio
suffix:semicolon
id|ha-&gt;func.verifybios
op_assign
id|ips_verify_bios_memio
suffix:semicolon
id|ha-&gt;func.enableint
op_assign
id|ips_enable_int_copperhead_memio
suffix:semicolon
r_if
c_cond
(paren
id|IPS_USE_I2O_DELIVER
c_func
(paren
id|ha
)paren
)paren
id|ha-&gt;func.issue
op_assign
id|ips_issue_i2o_memio
suffix:semicolon
r_else
id|ha-&gt;func.issue
op_assign
id|ips_issue_copperhead_memio
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* copperhead */
id|ha-&gt;func.isintr
op_assign
id|ips_isintr_copperhead
suffix:semicolon
id|ha-&gt;func.isinit
op_assign
id|ips_isinit_copperhead
suffix:semicolon
id|ha-&gt;func.init
op_assign
id|ips_init_copperhead
suffix:semicolon
id|ha-&gt;func.statupd
op_assign
id|ips_statupd_copperhead
suffix:semicolon
id|ha-&gt;func.statinit
op_assign
id|ips_statinit
suffix:semicolon
id|ha-&gt;func.reset
op_assign
id|ips_reset_copperhead
suffix:semicolon
id|ha-&gt;func.intr
op_assign
id|ips_intr_copperhead
suffix:semicolon
id|ha-&gt;func.erasebios
op_assign
id|ips_erase_bios
suffix:semicolon
id|ha-&gt;func.programbios
op_assign
id|ips_program_bios
suffix:semicolon
id|ha-&gt;func.verifybios
op_assign
id|ips_verify_bios
suffix:semicolon
id|ha-&gt;func.enableint
op_assign
id|ips_enable_int_copperhead
suffix:semicolon
r_if
c_cond
(paren
id|IPS_USE_I2O_DELIVER
c_func
(paren
id|ha
)paren
)paren
id|ha-&gt;func.issue
op_assign
id|ips_issue_i2o
suffix:semicolon
r_else
id|ha-&gt;func.issue
op_assign
id|ips_issue_copperhead
suffix:semicolon
)brace
multiline_comment|/*&n;          * Initialize the card if it isn&squot;t already&n;          */
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|ha-&gt;func.isinit
)paren
(paren
id|ha
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|ha-&gt;func.init
)paren
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/*&n;                * Initialization failed&n;                */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to initialize controller - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_sh
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/* install the interrupt handler */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|do_ipsintr
comma
id|SA_SHIRQ
comma
id|ips_name
comma
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to install interrupt handler - skipping controller&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_sh
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;          * Allocate a temporary SCB for initialization&n;          */
id|ha-&gt;scbs
op_assign
(paren
id|ips_scb_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ips_scb_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;scbs
)paren
(brace
multiline_comment|/* couldn&squot;t allocate a temp SCB */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to allocate CCBs - skipping contoller&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_sh
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|free_irq
c_func
(paren
id|ha-&gt;irq
comma
id|ha
)paren
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ha-&gt;scbs
comma
l_int|0
comma
r_sizeof
(paren
id|ips_scb_t
)paren
)paren
suffix:semicolon
id|ha-&gt;scbs-&gt;sg_list
op_assign
(paren
id|IPS_SG_LIST
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|IPS_SG_LIST
)paren
op_star
id|IPS_MAX_SG
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;scbs-&gt;sg_list
)paren
(brace
multiline_comment|/* couldn&squot;t allocate a temp SCB S/G list */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to allocate CCBs - skipping contoller&bslash;n&quot;
comma
id|ips_name
comma
id|ips_next_controller
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|ips_sh
(braket
id|ips_next_controller
)braket
op_assign
l_int|0
suffix:semicolon
id|free_irq
c_func
(paren
id|ha-&gt;irq
comma
id|ha
)paren
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;max_cmds
op_assign
l_int|1
suffix:semicolon
id|ips_next_controller
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|dev
(braket
id|i
)braket
op_assign
id|pci_find_device
c_func
(paren
id|IPS_VENDORID
comma
id|deviceID
(braket
id|i
)braket
comma
id|dev
(braket
id|i
)braket
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    * Do Phase 2 Initialization&n;    * Controller init&n;    */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ips_next_controller
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ips_ha
(braket
id|i
)braket
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) ignoring bad controller&bslash;n&quot;
comma
id|ips_name
comma
id|i
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha
op_assign
id|ips_ha
(braket
id|i
)braket
suffix:semicolon
id|sh
op_assign
id|ips_sh
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
(brace
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ips_sh
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ips_hainit
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to initialize controller - skipping&bslash;n&quot;
comma
id|ips_name
comma
id|i
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|ha-&gt;irq
comma
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ips_sh
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;       * Free the temporary SCB&n;       */
id|kfree
c_func
(paren
id|ha-&gt;scbs-&gt;sg_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ha-&gt;scbs
)paren
suffix:semicolon
id|ha-&gt;scbs
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* allocate CCBs */
r_if
c_cond
(paren
op_logical_neg
id|ips_allocatescbs
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to allocate CCBs - skipping contoller&bslash;n&quot;
comma
id|ips_name
comma
id|i
)paren
suffix:semicolon
id|ha-&gt;active
op_assign
l_int|0
suffix:semicolon
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|ha-&gt;irq
comma
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_ha
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ips_sh
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ips_num_controllers
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* finish setting values */
id|sh-&gt;max_id
op_assign
id|ha-&gt;ntargets
suffix:semicolon
id|sh-&gt;max_lun
op_assign
id|ha-&gt;nlun
suffix:semicolon
id|sh-&gt;max_channel
op_assign
id|ha-&gt;nbus
op_minus
l_int|1
suffix:semicolon
id|sh-&gt;can_queue
op_assign
id|ha-&gt;max_cmds
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ips_num_controllers
OG
l_int|0
)paren
id|register_reboot_notifier
c_func
(paren
op_amp
id|ips_notifier
)paren
suffix:semicolon
r_return
(paren
id|ips_num_controllers
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* No PCI -- No ServeRAID */
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PCI */
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_release                                                */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove a driver                                                        */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_release
id|ips_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|sh
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|ips_ha_t
op_star
id|ha
suffix:semicolon
r_int
id|i
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_release&quot;
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPS_MAX_ADAPTERS
op_logical_and
id|ips_sh
(braket
id|i
)braket
op_ne
id|sh
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|IPS_MAX_ADAPTERS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s) release, invalid Scsi_Host pointer.&bslash;n&quot;
comma
id|ips_name
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,4,0)
id|BUG
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
id|ha
op_assign
id|IPS_HA
c_func
(paren
id|sh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* flush the cache on the controller */
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPS_CMD_FLUSH
suffix:semicolon
id|scb-&gt;cmd.flush_cache.op_code
op_assign
id|IPS_CMD_FLUSH
suffix:semicolon
id|scb-&gt;cmd.flush_cache.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.flush_cache.state
op_assign
id|IPS_NORM_STATE
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved2
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved3
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved4
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Flushing Cache.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
multiline_comment|/* send command */
r_if
c_cond
(paren
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
comma
id|IPS_INTR_ON
)paren
op_eq
id|IPS_FAILURE
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Incomplete Flush.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Flushing Complete.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|ips_sh
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ips_ha
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* free extra memory */
id|ips_free
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Free I/O Region */
r_if
c_cond
(paren
id|ha-&gt;io_addr
)paren
id|release_region
c_func
(paren
id|ha-&gt;io_addr
comma
id|ha-&gt;io_len
)paren
suffix:semicolon
multiline_comment|/* free IRQ */
id|free_irq
c_func
(paren
id|ha-&gt;irq
comma
id|ha
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|sh
)paren
suffix:semicolon
id|ips_released_controllers
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ips_num_controllers
op_eq
id|ips_released_controllers
)paren
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|ips_notifier
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_halt                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Perform cleanup when the system reboots                                */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_halt
id|ips_halt
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
id|ulong
id|event
comma
r_void
op_star
id|buf
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|ips_ha_t
op_star
id|ha
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|event
op_ne
id|SYS_RESTART
)paren
op_logical_and
(paren
id|event
op_ne
id|SYS_HALT
)paren
op_logical_and
(paren
id|event
op_ne
id|SYS_POWER_OFF
)paren
)paren
r_return
(paren
id|NOTIFY_DONE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ips_next_controller
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|ips_ha
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_continue
suffix:semicolon
multiline_comment|/* flush the cache on the controller */
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPS_CMD_FLUSH
suffix:semicolon
id|scb-&gt;cmd.flush_cache.op_code
op_assign
id|IPS_CMD_FLUSH
suffix:semicolon
id|scb-&gt;cmd.flush_cache.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.flush_cache.state
op_assign
id|IPS_NORM_STATE
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved2
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved3
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.flush_cache.reserved4
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Flushing Cache.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
multiline_comment|/* send command */
r_if
c_cond
(paren
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
comma
id|IPS_INTR_ON
)paren
op_eq
id|IPS_FAILURE
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Incomplete Flush.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Flushing Complete.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
)brace
r_return
(paren
id|NOTIFY_OK
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_eh_abort                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Abort a command (using the new error code stuff)                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_eh_abort
id|ips_eh_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SC
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|ips_copp_wait_item_t
op_star
id|item
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_eh_abort&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SC
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|SC-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SC-&gt;serial_number
op_ne
id|SC-&gt;serial_number_at_timeout
)paren
(brace
multiline_comment|/* HMM, looks like a bogus command */
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Abort called with bogus scsi command&quot;
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
multiline_comment|/* See if the command is on the copp queue */
id|IPS_QUEUE_LOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
id|item
op_assign
id|ha-&gt;copp_waitlist.head
suffix:semicolon
r_while
c_loop
(paren
(paren
id|item
)paren
op_logical_and
(paren
id|item-&gt;scsi_cmd
op_ne
id|SC
)paren
)paren
id|item
op_assign
id|item-&gt;next
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|item
)paren
(brace
multiline_comment|/* Found it */
id|ips_removeq_copp
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
comma
id|item
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/* See if the command is on the wait queue */
r_if
c_cond
(paren
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
comma
id|SC
)paren
)paren
(brace
multiline_comment|/* command not sent yet */
id|clear_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* command must have already been sent */
id|clear_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_eh_reset                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Reset the controller (with new eh error code)                          */
multiline_comment|/*                                                                          */
multiline_comment|/* NOTE: this routine is called under the io_request_lock spinlock          */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_eh_reset
id|ips_eh_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SC
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|ips_copp_wait_item_t
op_star
id|item
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_eh_reset&quot;
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef NO_IPS_RESET
r_return
(paren
id|FAILED
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
id|SC
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Reset called with NULL scsi command&quot;
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|SC-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Reset called with NULL ha struct&quot;
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
)paren
r_return
(paren
id|FAILED
)paren
suffix:semicolon
multiline_comment|/* See if the command is on the copp queue */
id|IPS_QUEUE_LOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
id|item
op_assign
id|ha-&gt;copp_waitlist.head
suffix:semicolon
r_while
c_loop
(paren
(paren
id|item
)paren
op_logical_and
(paren
id|item-&gt;scsi_cmd
op_ne
id|SC
)paren
)paren
id|item
op_assign
id|item-&gt;next
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|item
)paren
(brace
multiline_comment|/* Found it */
id|ips_removeq_copp
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
comma
id|item
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/* See if the command is on the wait queue */
r_if
c_cond
(paren
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
comma
id|SC
)paren
)paren
(brace
multiline_comment|/* command not sent yet */
id|clear_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    * command must have already been sent&n;    * reset the controller&n;    */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Resetting controller.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|ret
op_assign
(paren
op_star
id|ha-&gt;func.reset
)paren
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|Scsi_Cmnd
op_star
id|scsi_cmd
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Controller reset failed - controller now offline.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
multiline_comment|/* Now fail all of the active commands */
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Failing active commands&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|scb
op_assign
id|ips_removeq_scb_head
c_func
(paren
op_amp
id|ha-&gt;scb_activelist
)paren
)paren
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
)brace
multiline_comment|/* Now fail all of the pending commands */
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Failing pending commands&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|scsi_cmd
op_assign
id|ips_removeq_wait_head
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
)paren
)paren
)paren
(brace
id|scsi_cmd-&gt;result
op_assign
id|DID_ERROR
suffix:semicolon
id|scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scsi_cmd
)paren
suffix:semicolon
)brace
id|ha-&gt;active
op_assign
id|FALSE
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ips_clear_adapter
c_func
(paren
id|ha
comma
id|IPS_INTR_IORL
)paren
)paren
(brace
id|Scsi_Cmnd
op_star
id|scsi_cmd
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;(%s%d) Controller reset failed - controller now offline.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
multiline_comment|/* Now fail all of the active commands */
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Failing active commands&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|scb
op_assign
id|ips_removeq_scb_head
c_func
(paren
op_amp
id|ha-&gt;scb_activelist
)paren
)paren
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
)brace
multiline_comment|/* Now fail all of the pending commands */
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Failing pending commands&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|scsi_cmd
op_assign
id|ips_removeq_wait_head
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
)paren
)paren
)paren
(brace
id|scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scsi_cmd
)paren
suffix:semicolon
)brace
id|ha-&gt;active
op_assign
id|FALSE
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|FAILED
)paren
suffix:semicolon
)brace
multiline_comment|/* FFDC */
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|ha-&gt;subsys-&gt;param
(braket
l_int|3
)braket
)paren
op_amp
l_int|0x300000
)paren
(brace
r_struct
id|timeval
id|tv
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|ha-&gt;last_ffdc
op_assign
id|tv.tv_sec
suffix:semicolon
id|ha-&gt;reset_count
op_increment
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|ips_ffdc_reset
c_func
(paren
id|ha
comma
id|IPS_INTR_IORL
)paren
suffix:semicolon
)brace
multiline_comment|/* Now fail all of the active commands */
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Failing active commands&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|scb
op_assign
id|ips_removeq_scb_head
c_func
(paren
op_amp
id|ha-&gt;scb_activelist
)paren
)paren
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
op_or
(paren
id|SUGGEST_RETRY
op_lshift
l_int|24
)paren
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset DCDB active command bits */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|ha-&gt;nbus
suffix:semicolon
id|i
op_increment
)paren
id|ha-&gt;dcdb_active
(braket
id|i
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset the number of active IOCTLs */
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|ha-&gt;num_ioctl
op_assign
l_int|0
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
)paren
(brace
multiline_comment|/*&n;       * Only execute the next command when&n;       * we are not being called from the&n;       * interrupt handler.  The interrupt&n;       * handler wants to do this and since&n;       * interrupts are turned off here....&n;       */
id|ips_next
c_func
(paren
id|ha
comma
id|IPS_INTR_IORL
)paren
suffix:semicolon
)brace
r_return
(paren
id|SUCCESS
)paren
suffix:semicolon
macro_line|#endif /* NO_IPS_RESET */
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_queue                                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Send a command to the controller                                       */
multiline_comment|/*                                                                          */
multiline_comment|/* NOTE:                                                                    */
multiline_comment|/*    Linux obtains io_request_lock before calling this function            */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_queue
id|ips_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|SC
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_queue&quot;
comma
l_int|1
)paren
suffix:semicolon
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|SC-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
(paren
id|DID_ERROR
)paren
suffix:semicolon
macro_line|#ifndef NO_IPS_CMDLINE
r_if
c_cond
(paren
id|ips_is_passthru
c_func
(paren
id|SC
)paren
)paren
(brace
id|IPS_QUEUE_LOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;copp_waitlist.count
op_eq
id|IPS_MAX_IOCTL_QUEUE
)paren
(brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SC
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#endif
id|IPS_QUEUE_LOCK
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;scb_waitlist.count
op_eq
id|IPS_MAX_QUEUE
)paren
(brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
)paren
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SC
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
)paren
suffix:semicolon
)brace
macro_line|#ifndef NO_IPS_CMDLINE
)brace
macro_line|#endif
id|SC-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;(%s%d): ips_queue: cmd 0x%X (%d %d %d)&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|SC-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SC-&gt;channel
comma
id|SC-&gt;target
comma
id|SC-&gt;lun
)paren
suffix:semicolon
multiline_comment|/* Check for command to initiator IDs */
r_if
c_cond
(paren
(paren
id|SC-&gt;channel
OG
l_int|0
)paren
op_logical_and
(paren
id|SC-&gt;target
op_eq
id|ha-&gt;ha_id
(braket
id|SC-&gt;channel
)braket
)paren
)paren
(brace
id|SC-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SC
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#ifndef NO_IPS_CMDLINE
r_if
c_cond
(paren
id|ips_is_passthru
c_func
(paren
id|SC
)paren
)paren
(brace
id|ips_copp_wait_item_t
op_star
id|scratch
suffix:semicolon
multiline_comment|/* The IPS_IOCTL_NEW_COMMAND is only used to flash an adapter.  This should */
multiline_comment|/* never happen when the adapter is active.  Just in case, check here, and  */
multiline_comment|/* reject the command if anything else is going on.                         */
r_if
c_cond
(paren
id|SC-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IPS_IOCTL_NEW_COMMAND
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;scb_activelist.count
op_ne
l_int|0
)paren
(brace
multiline_comment|/* printk( KERN_WARNING &quot;New IOCTL Cmd Return BUSY: %d Cmds Active&bslash;n&quot;, */
multiline_comment|/*                       ha-&gt;scb_activelist.count );                   */
id|SC-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SC
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* allocate space for the scribble */
id|scratch
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ips_copp_wait_item_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scratch
)paren
(brace
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SC
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|scratch-&gt;scsi_cmd
op_assign
id|SC
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|ha-&gt;ioctl_sem
comma
l_int|0
)paren
suffix:semicolon
id|scratch-&gt;sem
op_assign
op_amp
id|ha-&gt;ioctl_sem
suffix:semicolon
id|scratch-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|ips_putq_copp_tail
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
comma
id|scratch
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
id|ips_putq_wait_tail
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
comma
id|SC
)paren
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IPS_IN_ABORT
comma
op_amp
id|ha-&gt;flags
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IPS_IN_RESET
comma
op_amp
id|ha-&gt;flags
)paren
)paren
)paren
(brace
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|ips_next
c_func
(paren
id|ha
comma
id|IPS_INTR_IORL
)paren
suffix:semicolon
)brace
r_else
(brace
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    * If this request was a new style IOCTL wait&n;    * for it to finish.&n;    *&n;    * NOTE: we relinquished the lock above so this should&n;    * not cause contention problems&n;    */
r_if
c_cond
(paren
id|ips_is_passthru
c_func
(paren
id|SC
)paren
op_logical_and
id|SC-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IPS_IOCTL_NEW_COMMAND
)paren
(brace
r_char
op_star
id|user_area
suffix:semicolon
r_char
op_star
id|kern_area
suffix:semicolon
id|u_int32_t
id|datasize
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|SC-&gt;host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/* wait for the command to finish */
id|down
c_func
(paren
op_amp
id|ha-&gt;ioctl_sem
)paren
suffix:semicolon
multiline_comment|/* reobtain the lock */
id|spin_lock_irq
c_func
(paren
op_amp
id|SC-&gt;host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/* command finished -- copy back */
id|user_area
op_assign
op_star
(paren
(paren
r_char
op_star
op_star
)paren
op_amp
id|SC-&gt;cmnd
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|kern_area
op_assign
id|ha-&gt;ioctl_data
suffix:semicolon
id|datasize
op_assign
op_star
(paren
(paren
id|u_int32_t
op_star
)paren
op_amp
id|SC-&gt;cmnd
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datasize
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user_area
comma
id|kern_area
comma
id|datasize
)paren
OG
l_int|0
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) passthru failed - unable to copy out user data&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
)brace
id|SC
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SC
)paren
suffix:semicolon
)brace
multiline_comment|/* If We were using the CD Boot Flash Buffer, Restore the Old Values */
r_if
c_cond
(paren
id|ips_FlashData
op_eq
id|ha-&gt;ioctl_data
)paren
(brace
id|ha-&gt;ioctl_data
op_assign
id|ha-&gt;save_ioctl_data
suffix:semicolon
id|ha-&gt;ioctl_order
op_assign
id|ha-&gt;save_ioctl_order
suffix:semicolon
id|ha-&gt;ioctl_datasize
op_assign
id|ha-&gt;save_ioctl_datasize
suffix:semicolon
id|ips_FlashDataInUse
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_biosparam                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Set bios geometry for the controller                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_biosparam
id|ips_biosparam
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
id|geom
(braket
)braket
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
r_int
id|heads
suffix:semicolon
r_int
id|sectors
suffix:semicolon
r_int
id|cylinders
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_biosparam&quot;
comma
l_int|1
)paren
suffix:semicolon
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|disk-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
multiline_comment|/* ?!?! host adater info invalid */
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ips_read_adapter_status
c_func
(paren
id|ha
comma
id|IPS_INTR_ON
)paren
)paren
multiline_comment|/* ?!?! Enquiry command failed */
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|disk-&gt;capacity
OG
l_int|0x400000
)paren
op_logical_and
(paren
(paren
id|ha-&gt;enq-&gt;ucMiscFlag
op_amp
l_int|0x8
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|heads
op_assign
id|IPS_NORM_HEADS
suffix:semicolon
id|sectors
op_assign
id|IPS_NORM_SECTORS
suffix:semicolon
)brace
r_else
(brace
id|heads
op_assign
id|IPS_COMP_HEADS
suffix:semicolon
id|sectors
op_assign
id|IPS_COMP_SECTORS
suffix:semicolon
)brace
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;Geometry: heads: %d, sectors: %d, cylinders: %d&quot;
comma
id|heads
comma
id|sectors
comma
id|cylinders
)paren
suffix:semicolon
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_select_queue_depth                                     */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Select queue depths for the devices on the contoller                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_select_queue_depth
id|ips_select_queue_depth
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|Scsi_Device
op_star
id|scsi_devs
)paren
(brace
id|Scsi_Device
op_star
id|device
suffix:semicolon
id|ips_ha_t
op_star
id|ha
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|min
suffix:semicolon
id|ha
op_assign
id|IPS_HA
c_func
(paren
id|host
)paren
suffix:semicolon
id|min
op_assign
id|ha-&gt;max_cmds
op_div
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|device
op_assign
id|scsi_devs
suffix:semicolon
id|device
suffix:semicolon
id|device
op_assign
id|device-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|device-&gt;host
op_eq
id|host
)paren
(brace
r_if
c_cond
(paren
(paren
id|device-&gt;channel
op_eq
l_int|0
)paren
op_logical_and
(paren
id|device-&gt;type
op_eq
l_int|0
)paren
)paren
id|count
op_increment
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|device
op_assign
id|scsi_devs
suffix:semicolon
id|device
suffix:semicolon
id|device
op_assign
id|device-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|device-&gt;host
op_eq
id|host
)paren
(brace
r_if
c_cond
(paren
(paren
id|device-&gt;channel
op_eq
l_int|0
)paren
op_logical_and
(paren
id|device-&gt;type
op_eq
l_int|0
)paren
)paren
(brace
id|device-&gt;queue_depth
op_assign
(paren
id|ha-&gt;max_cmds
op_minus
l_int|1
)paren
op_div
id|count
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;queue_depth
OL
id|min
)paren
id|device-&gt;queue_depth
op_assign
id|min
suffix:semicolon
)brace
r_else
(brace
id|device-&gt;queue_depth
op_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device-&gt;queue_depth
OL
l_int|2
)paren
id|device-&gt;queue_depth
op_assign
l_int|2
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: do_ipsintr                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Wrapper for the interrupt handler                                      */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_void
DECL|function|do_ipsintr
id|do_ipsintr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|ips_ha_t
op_star
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|ips_sh
(braket
id|ha-&gt;host_num
)braket
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;do_ipsintr&quot;
comma
l_int|2
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;host_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;host_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
(brace
id|clear_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;host_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
(brace
id|clear_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;host_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
(paren
op_star
id|ha-&gt;func.intr
)paren
(paren
id|ha
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;host_lock
comma
id|cpu_flags
)paren
suffix:semicolon
multiline_comment|/* start the next command */
id|ips_next
c_func
(paren
id|ha
comma
id|IPS_INTR_ON
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_intr_copperhead                                        */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Polling interrupt handler                                              */
multiline_comment|/*                                                                          */
multiline_comment|/*   ASSUMES interrupts are disabled                                        */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_void
DECL|function|ips_intr_copperhead
id|ips_intr_copperhead
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_stat_t
op_star
id|sp
suffix:semicolon
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|IPS_STATUS
id|cstatus
suffix:semicolon
r_int
id|intrstatus
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_intr&quot;
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|intrstatus
op_assign
(paren
op_star
id|ha-&gt;func.isintr
)paren
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrstatus
)paren
(brace
multiline_comment|/*&n;       * Unexpected/Shared interrupt&n;       */
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|TRUE
)paren
(brace
id|sp
op_assign
op_amp
id|ha-&gt;sp
suffix:semicolon
id|intrstatus
op_assign
(paren
op_star
id|ha-&gt;func.isintr
)paren
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrstatus
)paren
r_break
suffix:semicolon
r_else
id|cstatus.value
op_assign
(paren
op_star
id|ha-&gt;func.statupd
)paren
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cstatus.fields.command_id
OG
(paren
id|IPS_MAX_CMDS
op_minus
l_int|1
)paren
)paren
(brace
multiline_comment|/* Spurious Interupt ? */
r_continue
suffix:semicolon
)brace
id|ips_chkstatus
c_func
(paren
id|ha
comma
op_amp
id|cstatus
)paren
suffix:semicolon
id|scb
op_assign
(paren
id|ips_scb_t
op_star
)paren
id|sp-&gt;scb_addr
suffix:semicolon
multiline_comment|/*&n;       * use the callback function to finish things up&n;       * NOTE: interrupts are OFF for this&n;       */
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
(paren
op_star
id|scb-&gt;callback
)paren
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/* end while */
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_intr_morpheus                                          */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Polling interrupt handler                                              */
multiline_comment|/*                                                                          */
multiline_comment|/*   ASSUMES interrupts are disabled                                        */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_void
DECL|function|ips_intr_morpheus
id|ips_intr_morpheus
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_stat_t
op_star
id|sp
suffix:semicolon
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|IPS_STATUS
id|cstatus
suffix:semicolon
r_int
id|intrstatus
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_intr_morpheus&quot;
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;active
)paren
r_return
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|intrstatus
op_assign
(paren
op_star
id|ha-&gt;func.isintr
)paren
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrstatus
)paren
(brace
multiline_comment|/*&n;       * Unexpected/Shared interrupt&n;       */
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|TRUE
)paren
(brace
id|sp
op_assign
op_amp
id|ha-&gt;sp
suffix:semicolon
id|intrstatus
op_assign
(paren
op_star
id|ha-&gt;func.isintr
)paren
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrstatus
)paren
r_break
suffix:semicolon
r_else
id|cstatus.value
op_assign
(paren
op_star
id|ha-&gt;func.statupd
)paren
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cstatus.value
op_eq
l_int|0xffffffff
)paren
multiline_comment|/* No more to process */
r_break
suffix:semicolon
r_if
c_cond
(paren
id|cstatus.fields.command_id
OG
(paren
id|IPS_MAX_CMDS
op_minus
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Spurious interrupt; no ccb.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ips_chkstatus
c_func
(paren
id|ha
comma
op_amp
id|cstatus
)paren
suffix:semicolon
id|scb
op_assign
(paren
id|ips_scb_t
op_star
)paren
id|sp-&gt;scb_addr
suffix:semicolon
multiline_comment|/*&n;       * use the callback function to finish things up&n;       * NOTE: interrupts are OFF for this&n;       */
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
(paren
op_star
id|scb-&gt;callback
)paren
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/* end while */
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_info                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Return info about the driver                                           */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_const
r_char
op_star
DECL|function|ips_info
id|ips_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|SH
)paren
(brace
r_static
r_char
id|buffer
(braket
l_int|256
)braket
suffix:semicolon
r_char
op_star
id|bp
suffix:semicolon
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_info&quot;
comma
l_int|1
)paren
suffix:semicolon
id|ha
op_assign
id|IPS_HA
c_func
(paren
id|SH
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|bp
op_assign
op_amp
id|buffer
(braket
l_int|0
)braket
suffix:semicolon
id|memset
c_func
(paren
id|bp
comma
l_int|0
comma
r_sizeof
(paren
id|buffer
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|bp
comma
l_string|&quot;%s%s%s&quot;
comma
l_string|&quot;IBM PCI ServeRAID &quot;
comma
id|IPS_VERSION_HIGH
comma
id|IPS_VERSION_LOW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;ad_type
OG
l_int|0
op_logical_and
id|ha-&gt;ad_type
op_le
id|MAX_ADAPTER_NAME
)paren
(brace
id|strcat
c_func
(paren
id|bp
comma
l_string|&quot; &lt;&quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|bp
comma
id|ips_adapter_name
(braket
id|ha-&gt;ad_type
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|bp
comma
l_string|&quot;&gt;&quot;
)paren
suffix:semicolon
)brace
r_return
(paren
id|bp
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_proc_info                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   The passthru interface for the driver                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_int
DECL|function|ips_proc_info
id|ips_proc_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|func
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ips_ha_t
op_star
id|ha
op_assign
l_int|NULL
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_proc_info&quot;
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Find our host structure */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ips_next_controller
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ips_sh
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|ips_sh
(braket
id|i
)braket
op_member_access_from_pointer
id|host_no
op_eq
id|hostno
)paren
(brace
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|ips_sh
(braket
id|i
)braket
op_member_access_from_pointer
id|hostdata
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func
)paren
(brace
multiline_comment|/* write */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* read */
r_if
c_cond
(paren
id|start
)paren
op_star
id|start
op_assign
id|buffer
suffix:semicolon
id|ret
op_assign
id|ips_host_info
c_func
(paren
id|ha
comma
id|buffer
comma
id|offset
comma
id|length
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*--------------------------------------------------------------------------*/
multiline_comment|/* Helper Functions                                                         */
multiline_comment|/*--------------------------------------------------------------------------*/
macro_line|#ifndef NO_IPS_CMDLINE
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_is_passthru                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Determine if the specified SCSI command is really a passthru command   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_is_passthru
id|ips_is_passthru
c_func
(paren
id|Scsi_Cmnd
op_star
id|SC
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_is_passthru&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SC
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|SC-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IPS_IOCTL_COMMAND
)paren
op_logical_or
(paren
id|SC-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IPS_IOCTL_NEW_COMMAND
)paren
)paren
op_logical_and
(paren
id|SC-&gt;channel
op_eq
l_int|0
)paren
op_logical_and
(paren
id|SC-&gt;target
op_eq
id|IPS_ADAPTER_ID
)paren
op_logical_and
(paren
id|SC-&gt;lun
op_eq
l_int|0
)paren
op_logical_and
(paren
id|SC-&gt;request_bufflen
)paren
op_logical_and
(paren
op_logical_neg
id|SC-&gt;use_sg
)paren
op_logical_and
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|0
)braket
op_eq
l_char|&squot;C&squot;
)paren
op_logical_and
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|1
)braket
op_eq
l_char|&squot;O&squot;
)paren
op_logical_and
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|2
)braket
op_eq
l_char|&squot;P&squot;
)paren
op_logical_and
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|3
)braket
op_eq
l_char|&squot;P&squot;
)paren
)paren
(brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_make_passthru                                          */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Make a passthru command out of the info in the Scsi block              */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_make_passthru
id|ips_make_passthru
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|Scsi_Cmnd
op_star
id|SC
comma
id|ips_scb_t
op_star
id|scb
comma
r_int
id|intr
)paren
(brace
id|IPS_NVRAM_P5
id|nvram
suffix:semicolon
id|ips_passthru_t
op_star
id|pt
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_make_passthru&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SC-&gt;request_bufflen
op_logical_or
op_logical_neg
id|SC-&gt;request_buffer
)paren
(brace
multiline_comment|/* no data */
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) No passthru structure&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SC-&gt;request_bufflen
OL
r_sizeof
(paren
id|ips_passthru_t
)paren
)paren
(brace
multiline_comment|/* wrong size */
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Passthru structure wrong size&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|0
)braket
op_ne
l_char|&squot;C&squot;
)paren
op_logical_or
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|1
)braket
op_ne
l_char|&squot;O&squot;
)paren
op_logical_or
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|2
)braket
op_ne
l_char|&squot;P&squot;
)paren
op_logical_or
(paren
(paren
(paren
r_char
op_star
)paren
id|SC-&gt;request_buffer
)paren
(braket
l_int|3
)braket
op_ne
l_char|&squot;P&squot;
)paren
)paren
(brace
multiline_comment|/* signature doesn&squot;t match */
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Wrong signature on passthru structure.&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
id|pt
op_assign
(paren
id|ips_passthru_t
op_star
)paren
id|SC-&gt;request_buffer
suffix:semicolon
multiline_comment|/*&n;    * Some notes about the passthru interface used&n;    *&n;    * IF the scsi op_code == 0x0d then we assume&n;    * that the data came along with/goes with the&n;    * packet we received from the sg driver. In this&n;    * case the CmdBSize field of the pt structure is&n;    * used for the size of the buffer.&n;    *&n;    * IF the scsi op_code == 0x81 then we assume that&n;    * we will need our own buffer and we will copy the&n;    * data to/from the user buffer passed in the scsi&n;    * command.  The data address resides at offset 4&n;    * in the scsi command.  The length of the data resides&n;    * at offset 8 in the scsi command.&n;    */
r_switch
c_cond
(paren
id|pt-&gt;CoppCmd
)paren
(brace
r_case
id|IPS_NUMCTRLS
suffix:colon
id|memcpy
c_func
(paren
id|SC-&gt;request_buffer
op_plus
r_sizeof
(paren
id|ips_passthru_t
)paren
comma
op_amp
id|ips_num_controllers
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS_IMM
)paren
suffix:semicolon
r_case
id|IPS_CTRLINFO
suffix:colon
id|memcpy
c_func
(paren
id|SC-&gt;request_buffer
op_plus
r_sizeof
(paren
id|ips_passthru_t
)paren
comma
id|ha
comma
r_sizeof
(paren
id|ips_ha_t
)paren
)paren
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS_IMM
)paren
suffix:semicolon
r_case
id|IPS_COPPUSRCMD
suffix:colon
r_case
id|IPS_COPPIOCCMD
suffix:colon
r_if
c_cond
(paren
id|SC-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IPS_IOCTL_COMMAND
)paren
(brace
r_if
c_cond
(paren
id|SC-&gt;request_bufflen
OL
(paren
r_sizeof
(paren
id|ips_passthru_t
)paren
op_plus
id|pt-&gt;CmdBSize
)paren
)paren
(brace
multiline_comment|/* wrong size */
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Passthru structure wrong size&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ips_usrcmd
c_func
(paren
id|ha
comma
id|pt
comma
id|scb
)paren
)paren
r_return
(paren
id|IPS_SUCCESS
)paren
suffix:semicolon
r_else
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SC-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IPS_IOCTL_NEW_COMMAND
)paren
(brace
r_char
op_star
id|user_area
suffix:semicolon
r_char
op_star
id|kern_area
suffix:semicolon
id|u_int32_t
id|datasize
suffix:semicolon
r_if
c_cond
(paren
id|SC-&gt;request_bufflen
OL
(paren
r_sizeof
(paren
id|ips_passthru_t
)paren
)paren
)paren
(brace
multiline_comment|/* wrong size */
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Passthru structure wrong size&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/* IF it&squot;s OK to Use the &quot;CD BOOT&quot; Flash Buffer, then you can     */
multiline_comment|/* avoid allocating a huge buffer per adapter ( which can fail ). */
r_if
c_cond
(paren
(paren
id|ips_FlashData
)paren
op_logical_and
(paren
id|pt-&gt;CmdBSize
op_eq
id|IPS_IMAGE_SIZE
)paren
op_logical_and
(paren
id|ips_FlashDataInUse
op_eq
l_int|0
)paren
)paren
(brace
id|ips_FlashDataInUse
op_assign
l_int|1
suffix:semicolon
id|ha-&gt;save_ioctl_data
op_assign
id|ha-&gt;ioctl_data
suffix:semicolon
id|ha-&gt;save_ioctl_order
op_assign
id|ha-&gt;ioctl_order
suffix:semicolon
id|ha-&gt;save_ioctl_datasize
op_assign
id|ha-&gt;ioctl_datasize
suffix:semicolon
id|ha-&gt;ioctl_data
op_assign
id|ips_FlashData
suffix:semicolon
id|ha-&gt;ioctl_order
op_assign
l_int|7
suffix:semicolon
id|ha-&gt;ioctl_datasize
op_assign
id|IPS_IMAGE_SIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pt-&gt;CoppCP.cmd.nvram.op_code
op_eq
id|IPS_CMD_RW_NVRAM_PAGE
)paren
op_logical_and
(paren
id|pt-&gt;CoppCP.cmd.nvram.page
op_eq
l_int|5
)paren
op_logical_and
(paren
id|pt-&gt;CoppCP.cmd.nvram.write
op_eq
l_int|0
)paren
)paren
(brace
id|datasize
op_assign
op_star
(paren
(paren
id|u_int32_t
op_star
)paren
op_amp
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datasize
OL
r_sizeof
(paren
id|IPS_NVRAM_P5
)paren
)paren
(brace
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
id|ips_get_bios_version
c_func
(paren
id|ha
comma
id|IPS_INTR_IORL
)paren
suffix:semicolon
id|ips_create_nvrampage5
c_func
(paren
id|ha
comma
op_amp
id|nvram
)paren
suffix:semicolon
id|user_area
op_assign
op_star
(paren
(paren
r_char
op_star
op_star
)paren
op_amp
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|kern_area
op_assign
(paren
r_char
op_star
)paren
op_amp
id|nvram
suffix:semicolon
id|datasize
op_assign
op_star
(paren
(paren
id|u_int32_t
op_star
)paren
op_amp
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datasize
OG
r_sizeof
(paren
id|IPS_NVRAM_P5
)paren
)paren
id|datasize
op_assign
r_sizeof
(paren
id|IPS_NVRAM_P5
)paren
suffix:semicolon
multiline_comment|/* Copy out the buffer */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|user_area
comma
(paren
r_void
op_star
)paren
id|kern_area
comma
id|datasize
)paren
OG
l_int|0
)paren
(brace
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|EFAULT
)paren
suffix:semicolon
)brace
id|pt-&gt;BasicStatus
op_assign
l_int|0x00
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS_IMM
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;          * IPSSEND flashing BIOS&n;          */
r_if
c_cond
(paren
(paren
id|pt-&gt;CoppCP.cmd.flashfw.op_code
op_eq
id|IPS_CMD_RW_BIOSFW
)paren
op_logical_and
(paren
id|pt-&gt;CoppCP.cmd.flashfw.type
op_eq
l_int|1
)paren
op_logical_and
(paren
id|pt-&gt;CoppCP.cmd.flashfw.direction
op_eq
l_int|2
)paren
op_logical_and
(paren
id|ha-&gt;device_id
op_eq
id|IPS_DEVICEID_COPPERHEAD
)paren
)paren
(brace
r_struct
id|tq_struct
id|task
suffix:semicolon
id|IPS_FLASH_DATA
id|flash_data
suffix:semicolon
multiline_comment|/* We only support one packet */
r_if
c_cond
(paren
id|pt-&gt;CoppCP.cmd.flashfw.total_packets
op_ne
l_int|1
)paren
(brace
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/* copy in the size/buffer ptr from the scsi command */
id|memcpy
c_func
(paren
op_amp
id|pt-&gt;CmdBuffer
comma
op_amp
id|SC-&gt;cmnd
(braket
l_int|4
)braket
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|pt-&gt;CmdBSize
comma
op_amp
id|SC-&gt;cmnd
(braket
l_int|8
)braket
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pt-&gt;CmdBSize
OG
id|le32_to_cpu
c_func
(paren
id|pt-&gt;CoppCP.cmd.flashfw.count
)paren
)paren
(brace
id|pt-&gt;CmdBSize
op_assign
id|le32_to_cpu
c_func
(paren
id|pt-&gt;CoppCP.cmd.flashfw.count
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ERROR: Command/Buffer mismatch */
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|ha-&gt;func.programbios
)paren
op_logical_or
(paren
op_logical_neg
id|ha-&gt;func.erasebios
)paren
op_logical_or
(paren
op_logical_neg
id|ha-&gt;func.verifybios
)paren
)paren
(brace
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/* must have a buffer */
r_if
c_cond
(paren
(paren
op_logical_neg
id|pt-&gt;CmdBSize
)paren
op_logical_or
(paren
op_logical_neg
id|pt-&gt;CmdBuffer
)paren
)paren
(brace
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/* make sure buffer is big enough */
r_if
c_cond
(paren
id|pt-&gt;CmdBSize
OG
id|ha-&gt;ioctl_datasize
)paren
(brace
r_void
op_star
id|bigger_struct
suffix:semicolon
id|u_int32_t
id|count
suffix:semicolon
id|u_int32_t
id|order
suffix:semicolon
multiline_comment|/* try to allocate a bigger struct */
r_for
c_loop
(paren
id|count
op_assign
id|PAGE_SIZE
comma
id|order
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|pt-&gt;CmdBSize
suffix:semicolon
id|order
op_increment
comma
id|count
op_lshift_assign
l_int|1
)paren
suffix:semicolon
id|bigger_struct
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bigger_struct
)paren
(brace
multiline_comment|/* free the old memory */
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ha-&gt;ioctl_data
comma
id|ha-&gt;ioctl_order
)paren
suffix:semicolon
multiline_comment|/* use the new memory */
id|ha-&gt;ioctl_data
op_assign
(paren
r_char
op_star
)paren
id|bigger_struct
suffix:semicolon
id|ha-&gt;ioctl_order
op_assign
id|order
suffix:semicolon
id|ha-&gt;ioctl_datasize
op_assign
id|count
suffix:semicolon
)brace
r_else
(brace
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;ips_lock
)paren
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* copy in the buffer */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|ha-&gt;ioctl_data
comma
id|pt-&gt;CmdBuffer
comma
id|pt-&gt;CmdBSize
)paren
OG
l_int|0
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) flash bios failed - unable to copy user buffer&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
id|flash_data.userbuffer
op_assign
id|pt-&gt;CmdBuffer
suffix:semicolon
id|flash_data.usersize
op_assign
id|pt-&gt;CmdBSize
suffix:semicolon
id|flash_data.kernbuffer
op_assign
id|ha-&gt;ioctl_data
suffix:semicolon
id|flash_data.kernsize
op_assign
id|ha-&gt;ioctl_datasize
suffix:semicolon
id|flash_data.offset
op_assign
l_int|0
suffix:semicolon
id|flash_data.SC
op_assign
(paren
r_void
op_star
)paren
id|SC
suffix:semicolon
id|flash_data.pt
op_assign
(paren
r_void
op_star
)paren
id|pt
suffix:semicolon
id|flash_data.ha
op_assign
(paren
r_void
op_star
)paren
id|ha
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|ha-&gt;flash_ioctl_sem
comma
l_int|0
)paren
suffix:semicolon
id|flash_data.sem
op_assign
op_amp
id|ha-&gt;flash_ioctl_sem
suffix:semicolon
id|task.sync
op_assign
l_int|0
suffix:semicolon
id|task.routine
op_assign
id|ips_scheduled_flash_bios
suffix:semicolon
id|task.data
op_assign
(paren
r_void
op_star
)paren
op_amp
id|flash_data
suffix:semicolon
multiline_comment|/* Unlock the per-board lock */
id|spin_unlock_irq
c_func
(paren
op_amp
id|SC-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
multiline_comment|/* Wait for the flash to complete */
id|down
c_func
(paren
op_amp
id|ha-&gt;flash_ioctl_sem
)paren
suffix:semicolon
multiline_comment|/* Obtain the per-board lock */
id|spin_lock_irq
c_func
(paren
op_amp
id|SC-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
(paren
id|flash_data.retcode
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;          * IPSSEND flashing BIOS in sectioned mode&n;          */
r_if
c_cond
(paren
(paren
id|pt-&gt;CoppCP.cmd.flashbios.op_code
op_eq
id|IPS_CMD_RW_BIOSFW
)paren
op_logical_and
(paren
id|pt-&gt;CoppCP.cmd.flashbios.type
op_eq
l_int|1
)paren
op_logical_and
(paren
id|pt-&gt;CoppCP.cmd.flashbios.direction
op_eq
l_int|4
)paren
op_logical_and
(paren
id|ha-&gt;device_id
op_eq
id|IPS_DEVICEID_COPPERHEAD
)paren
)paren
(brace
r_struct
id|tq_struct
id|task
suffix:semicolon
id|IPS_FLASH_DATA
id|flash_data
suffix:semicolon
multiline_comment|/* copy in the size/buffer ptr from the scsi command */
id|memcpy
c_func
(paren
op_amp
id|pt-&gt;CmdBuffer
comma
op_amp
id|SC-&gt;cmnd
(braket
l_int|4
)braket
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|pt-&gt;CmdBSize
comma
op_amp
id|SC-&gt;cmnd
(braket
l_int|8
)braket
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pt-&gt;CmdBSize
OG
id|le32_to_cpu
c_func
(paren
id|pt-&gt;CoppCP.cmd.flashbios.count
)paren
)paren
(brace
id|pt-&gt;CmdBSize
op_assign
id|le32_to_cpu
c_func
(paren
id|pt-&gt;CoppCP.cmd.flashbios.count
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ERROR: Command/Buffer mismatch */
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/* Update the Card BIOS */
r_if
c_cond
(paren
(paren
op_logical_neg
id|ha-&gt;func.programbios
)paren
op_logical_or
(paren
op_logical_neg
id|ha-&gt;func.erasebios
)paren
op_logical_or
(paren
op_logical_neg
id|ha-&gt;func.verifybios
)paren
)paren
(brace
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/* must have a buffer */
r_if
c_cond
(paren
(paren
op_logical_neg
id|pt-&gt;CmdBSize
)paren
op_logical_or
(paren
op_logical_neg
id|pt-&gt;CmdBuffer
)paren
)paren
(brace
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/* make sure buffer is big enough */
r_if
c_cond
(paren
id|pt-&gt;CmdBSize
OG
id|ha-&gt;ioctl_datasize
)paren
(brace
r_void
op_star
id|bigger_struct
suffix:semicolon
id|u_int32_t
id|count
suffix:semicolon
id|u_int32_t
id|order
suffix:semicolon
multiline_comment|/* try to allocate a bigger struct */
r_for
c_loop
(paren
id|count
op_assign
id|PAGE_SIZE
comma
id|order
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|pt-&gt;CmdBSize
suffix:semicolon
id|order
op_increment
comma
id|count
op_lshift_assign
l_int|1
)paren
suffix:semicolon
id|bigger_struct
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bigger_struct
)paren
(brace
multiline_comment|/* free the old memory */
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ha-&gt;ioctl_data
comma
id|ha-&gt;ioctl_order
)paren
suffix:semicolon
multiline_comment|/* use the new memory */
id|ha-&gt;ioctl_data
op_assign
(paren
r_char
op_star
)paren
id|bigger_struct
suffix:semicolon
id|ha-&gt;ioctl_order
op_assign
id|order
suffix:semicolon
id|ha-&gt;ioctl_datasize
op_assign
id|count
suffix:semicolon
)brace
r_else
(brace
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;ips_lock
)paren
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* copy in the buffer */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|ha-&gt;ioctl_data
comma
id|pt-&gt;CmdBuffer
comma
id|pt-&gt;CmdBSize
)paren
OG
l_int|0
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) flash bios failed - unable to copy user buffer&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|EFAULT
)paren
suffix:semicolon
)brace
id|flash_data.userbuffer
op_assign
id|pt-&gt;CmdBuffer
suffix:semicolon
id|flash_data.usersize
op_assign
id|pt-&gt;CmdBSize
suffix:semicolon
id|flash_data.kernbuffer
op_assign
id|ha-&gt;ioctl_data
suffix:semicolon
id|flash_data.kernsize
op_assign
id|ha-&gt;ioctl_datasize
suffix:semicolon
id|flash_data.offset
op_assign
id|le32_to_cpu
c_func
(paren
id|pt-&gt;CoppCP.cmd.flashbios.offset
)paren
suffix:semicolon
id|flash_data.SC
op_assign
(paren
r_void
op_star
)paren
id|SC
suffix:semicolon
id|flash_data.pt
op_assign
(paren
r_void
op_star
)paren
id|pt
suffix:semicolon
id|flash_data.ha
op_assign
(paren
r_void
op_star
)paren
id|ha
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|ha-&gt;flash_ioctl_sem
comma
l_int|0
)paren
suffix:semicolon
id|flash_data.sem
op_assign
op_amp
id|ha-&gt;flash_ioctl_sem
suffix:semicolon
id|task.sync
op_assign
l_int|0
suffix:semicolon
id|task.routine
op_assign
id|ips_flash_bios_section
suffix:semicolon
id|task.data
op_assign
(paren
r_void
op_star
)paren
op_amp
id|flash_data
suffix:semicolon
multiline_comment|/* Unlock the per-board lock */
id|spin_unlock_irq
c_func
(paren
op_amp
id|SC-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
multiline_comment|/* Wait for the flash to complete */
id|down
c_func
(paren
op_amp
id|ha-&gt;flash_ioctl_sem
)paren
suffix:semicolon
multiline_comment|/* Obtain the per-board lock */
id|spin_lock_irq
c_func
(paren
op_amp
id|SC-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
(paren
id|flash_data.retcode
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pt-&gt;CoppCP.cmd.flashfw.op_code
op_eq
id|IPS_CMD_RW_BIOSFW
)paren
op_logical_and
(paren
id|pt-&gt;CoppCP.cmd.flashfw.type
op_eq
l_int|1
)paren
op_logical_and
(paren
id|pt-&gt;CoppCP.cmd.flashfw.direction
op_eq
l_int|3
)paren
op_logical_and
(paren
id|ha-&gt;device_id
op_eq
id|IPS_DEVICEID_COPPERHEAD
)paren
)paren
(brace
multiline_comment|/* Erase the Card BIOS */
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;func.erasebios
)paren
(brace
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|ha-&gt;func.erasebios
)paren
(paren
id|ha
)paren
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) flash bios failed - unable to erase flash&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
id|SC-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|pt-&gt;BasicStatus
op_assign
l_int|0x00
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS_IMM
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ips_newusrcmd
c_func
(paren
id|ha
comma
id|pt
comma
id|scb
)paren
)paren
r_return
(paren
id|IPS_SUCCESS
)paren
suffix:semicolon
r_else
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch */
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_scheduled_flash_bios                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Flash the BIOS on a Copperhead style controller                        */
multiline_comment|/*   To be called from a task queue                                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_scheduled_flash_bios
id|ips_scheduled_flash_bios
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SC
suffix:semicolon
id|ips_passthru_t
op_star
id|pt
suffix:semicolon
id|IPS_FLASH_DATA
op_star
id|fd
suffix:semicolon
id|fd
op_assign
(paren
id|IPS_FLASH_DATA
op_star
)paren
id|data
suffix:semicolon
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|fd-&gt;ha
suffix:semicolon
id|pt
op_assign
(paren
id|ips_passthru_t
op_star
)paren
id|fd-&gt;pt
suffix:semicolon
id|SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|fd-&gt;SC
suffix:semicolon
multiline_comment|/*&n;    * Set initial return codes&n;    */
id|SC-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|pt-&gt;BasicStatus
op_assign
l_int|0x00
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|fd-&gt;retcode
op_assign
id|IPS_SUCCESS_IMM
suffix:semicolon
multiline_comment|/*&n;    * Fix the size/ptr to account for the&n;    * flash header&n;    */
id|fd-&gt;kernbuffer
op_add_assign
l_int|0xC0
suffix:semicolon
id|fd-&gt;kernsize
op_sub_assign
l_int|0xC0
suffix:semicolon
id|fd-&gt;userbuffer
op_add_assign
l_int|0xC0
suffix:semicolon
id|fd-&gt;usersize
op_sub_assign
l_int|0xC0
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|ha-&gt;func.erasebios
)paren
(paren
id|ha
)paren
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) flash bios failed - unable to erase flash&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|fd-&gt;retcode
op_assign
id|IPS_FAILURE
suffix:semicolon
id|up
c_func
(paren
id|fd-&gt;sem
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ips_flash_bios_segment
c_func
(paren
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd-&gt;retcode
op_eq
id|IPS_FAILURE
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|ha-&gt;func.verifybios
)paren
(paren
id|ha
comma
id|fd-&gt;kernbuffer
comma
id|fd-&gt;usersize
comma
id|fd-&gt;offset
)paren
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) flash bios failed - unable to verify flash&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|fd-&gt;retcode
op_assign
id|IPS_FAILURE
suffix:semicolon
id|up
c_func
(paren
id|fd-&gt;sem
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Tell them we are done */
r_if
c_cond
(paren
id|fd-&gt;retcode
op_ne
id|IPS_FAILURE
)paren
id|up
c_func
(paren
id|fd-&gt;sem
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_flash_bios_section                                     */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   wrapper for ips_flash_bios_segment that raises the semaphore           */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_flash_bios_section
id|ips_flash_bios_section
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SC
suffix:semicolon
id|ips_passthru_t
op_star
id|pt
suffix:semicolon
id|IPS_FLASH_DATA
op_star
id|fd
suffix:semicolon
id|fd
op_assign
(paren
id|IPS_FLASH_DATA
op_star
)paren
id|data
suffix:semicolon
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|fd-&gt;ha
suffix:semicolon
id|pt
op_assign
(paren
id|ips_passthru_t
op_star
)paren
id|fd-&gt;pt
suffix:semicolon
id|SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|fd-&gt;SC
suffix:semicolon
multiline_comment|/*&n;    * Set initial return codes&n;    */
id|SC-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|pt-&gt;BasicStatus
op_assign
l_int|0x00
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|fd-&gt;retcode
op_assign
id|IPS_SUCCESS_IMM
suffix:semicolon
id|ips_flash_bios_segment
c_func
(paren
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd-&gt;retcode
op_ne
id|IPS_FAILURE
)paren
id|up
c_func
(paren
id|fd-&gt;sem
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_flash_bios_segment                                     */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Flash a portion of the BIOS on a Copperhead style controller           */
multiline_comment|/*   To be called from a task queue                                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_flash_bios_segment
id|ips_flash_bios_segment
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|ips_ha_t
op_star
id|ha
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SC
suffix:semicolon
id|ips_passthru_t
op_star
id|pt
suffix:semicolon
id|IPS_FLASH_DATA
op_star
id|fd
suffix:semicolon
id|fd
op_assign
(paren
id|IPS_FLASH_DATA
op_star
)paren
id|data
suffix:semicolon
id|ha
op_assign
(paren
id|ips_ha_t
op_star
)paren
id|fd-&gt;ha
suffix:semicolon
id|pt
op_assign
(paren
id|ips_passthru_t
op_star
)paren
id|fd-&gt;pt
suffix:semicolon
id|SC
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|fd-&gt;SC
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|ha-&gt;func.programbios
)paren
(paren
id|ha
comma
id|fd-&gt;kernbuffer
comma
id|fd-&gt;usersize
comma
id|fd-&gt;offset
)paren
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) flash bios failed - unable to program flash&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|pt-&gt;BasicStatus
op_assign
l_int|0x0B
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
l_int|0x00
suffix:semicolon
id|SC-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|fd-&gt;retcode
op_assign
id|IPS_FAILURE
suffix:semicolon
id|up
c_func
(paren
id|fd-&gt;sem
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_usrcmd                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Process a user command and make it ready to send                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_usrcmd
id|ips_usrcmd
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_passthru_t
op_star
id|pt
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|IPS_SG_LIST
op_star
id|sg_list
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_usrcmd&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|scb
)paren
op_logical_or
(paren
op_logical_neg
id|pt
)paren
op_logical_or
(paren
op_logical_neg
id|ha
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Save the S/G list pointer so it doesn&squot;t get clobbered */
id|sg_list
op_assign
id|scb-&gt;sg_list
suffix:semicolon
multiline_comment|/* copy in the CP */
id|memcpy
c_func
(paren
op_amp
id|scb-&gt;cmd
comma
op_amp
id|pt-&gt;CoppCP.cmd
comma
r_sizeof
(paren
id|IPS_IOCTL_CMD
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|scb-&gt;dcdb
comma
op_amp
id|pt-&gt;CoppCP.dcdb
comma
r_sizeof
(paren
id|IPS_DCDB_TABLE
)paren
)paren
suffix:semicolon
multiline_comment|/* FIX stuff that might be wrong */
id|scb-&gt;sg_list
op_assign
id|sg_list
suffix:semicolon
id|scb-&gt;scb_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb
)paren
suffix:semicolon
id|scb-&gt;bus
op_assign
id|scb-&gt;scsi_cmd-&gt;channel
suffix:semicolon
id|scb-&gt;target_id
op_assign
id|scb-&gt;scsi_cmd-&gt;target
suffix:semicolon
id|scb-&gt;lun
op_assign
id|scb-&gt;scsi_cmd-&gt;lun
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;data_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;op_code
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;callback
op_assign
id|ipsintr_done
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
multiline_comment|/* we don&squot;t support DCDB/READ/WRITE Scatter Gather */
r_if
c_cond
(paren
(paren
id|scb-&gt;cmd.basic_io.op_code
op_eq
id|IPS_CMD_READ_SG
)paren
op_logical_or
(paren
id|scb-&gt;cmd.basic_io.op_code
op_eq
id|IPS_CMD_WRITE_SG
)paren
op_logical_or
(paren
id|scb-&gt;cmd.basic_io.op_code
op_eq
id|IPS_CMD_DCDB_SG
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pt-&gt;CmdBSize
)paren
(brace
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
op_plus
r_sizeof
(paren
id|ips_passthru_t
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;data_busaddr
op_assign
l_int|0L
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scb-&gt;cmd.dcdb.op_code
op_eq
id|IPS_CMD_DCDB
)paren
id|scb-&gt;cmd.dcdb.dcdb_address
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
op_amp
id|scb-&gt;dcdb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pt-&gt;CmdBSize
)paren
(brace
r_if
c_cond
(paren
id|scb-&gt;cmd.dcdb.op_code
op_eq
id|IPS_CMD_DCDB
)paren
id|scb-&gt;dcdb.buffer_pointer
op_assign
id|cpu_to_le32
c_func
(paren
id|scb-&gt;data_busaddr
)paren
suffix:semicolon
r_else
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|scb-&gt;data_busaddr
)paren
suffix:semicolon
)brace
multiline_comment|/* set timeouts */
r_if
c_cond
(paren
id|pt-&gt;TimeOut
)paren
(brace
id|scb-&gt;timeout
op_assign
id|pt-&gt;TimeOut
suffix:semicolon
r_if
c_cond
(paren
id|pt-&gt;TimeOut
op_le
l_int|10
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TIMEOUT10
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pt-&gt;TimeOut
op_le
l_int|60
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TIMEOUT60
suffix:semicolon
r_else
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TIMEOUT20M
suffix:semicolon
)brace
multiline_comment|/* assume success */
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* success */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_newusrcmd                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Process a user command and make it ready to send                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_newusrcmd
id|ips_newusrcmd
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_passthru_t
op_star
id|pt
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|IPS_SG_LIST
op_star
id|sg_list
suffix:semicolon
r_char
op_star
id|user_area
suffix:semicolon
r_char
op_star
id|kern_area
suffix:semicolon
id|u_int32_t
id|datasize
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_usrcmd&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|scb
)paren
op_logical_or
(paren
op_logical_neg
id|pt
)paren
op_logical_or
(paren
op_logical_neg
id|ha
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Save the S/G list pointer so it doesn&squot;t get clobbered */
id|sg_list
op_assign
id|scb-&gt;sg_list
suffix:semicolon
multiline_comment|/* copy in the CP */
id|memcpy
c_func
(paren
op_amp
id|scb-&gt;cmd
comma
op_amp
id|pt-&gt;CoppCP.cmd
comma
r_sizeof
(paren
id|IPS_IOCTL_CMD
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|scb-&gt;dcdb
comma
op_amp
id|pt-&gt;CoppCP.dcdb
comma
r_sizeof
(paren
id|IPS_DCDB_TABLE
)paren
)paren
suffix:semicolon
multiline_comment|/* FIX stuff that might be wrong */
id|scb-&gt;sg_list
op_assign
id|sg_list
suffix:semicolon
id|scb-&gt;scb_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb
)paren
suffix:semicolon
id|scb-&gt;bus
op_assign
id|scb-&gt;scsi_cmd-&gt;channel
suffix:semicolon
id|scb-&gt;target_id
op_assign
id|scb-&gt;scsi_cmd-&gt;target
suffix:semicolon
id|scb-&gt;lun
op_assign
id|scb-&gt;scsi_cmd-&gt;lun
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;data_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;op_code
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;callback
op_assign
id|ipsintr_done
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
multiline_comment|/* we don&squot;t support DCDB/READ/WRITE Scatter Gather */
r_if
c_cond
(paren
(paren
id|scb-&gt;cmd.basic_io.op_code
op_eq
id|IPS_CMD_READ_SG
)paren
op_logical_or
(paren
id|scb-&gt;cmd.basic_io.op_code
op_eq
id|IPS_CMD_WRITE_SG
)paren
op_logical_or
(paren
id|scb-&gt;cmd.basic_io.op_code
op_eq
id|IPS_CMD_DCDB_SG
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pt-&gt;CmdBSize
)paren
(brace
r_if
c_cond
(paren
id|pt-&gt;CmdBSize
OG
id|ha-&gt;ioctl_datasize
)paren
(brace
r_void
op_star
id|bigger_struct
suffix:semicolon
id|u_int32_t
id|count
suffix:semicolon
id|u_int32_t
id|order
suffix:semicolon
multiline_comment|/* try to allocate a bigger struct */
r_for
c_loop
(paren
id|count
op_assign
id|PAGE_SIZE
comma
id|order
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|pt-&gt;CmdBSize
suffix:semicolon
id|order
op_increment
comma
id|count
op_lshift_assign
l_int|1
)paren
suffix:semicolon
id|bigger_struct
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bigger_struct
)paren
(brace
multiline_comment|/* free the old memory */
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ha-&gt;ioctl_data
comma
id|ha-&gt;ioctl_order
)paren
suffix:semicolon
multiline_comment|/* use the new memory */
id|ha-&gt;ioctl_data
op_assign
(paren
r_char
op_star
)paren
id|bigger_struct
suffix:semicolon
id|ha-&gt;ioctl_order
op_assign
id|order
suffix:semicolon
id|ha-&gt;ioctl_datasize
op_assign
id|count
suffix:semicolon
)brace
r_else
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;ioctl_data
)paren
suffix:semicolon
multiline_comment|/* Attempt to copy in the data */
id|user_area
op_assign
op_star
(paren
(paren
r_char
op_star
op_star
)paren
op_amp
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|kern_area
op_assign
id|ha-&gt;ioctl_data
suffix:semicolon
id|datasize
op_assign
op_star
(paren
(paren
id|u_int32_t
op_star
)paren
op_amp
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|kern_area
comma
id|user_area
comma
id|datasize
)paren
OG
l_int|0
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) passthru failed - unable to copy in user data&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|scb-&gt;data_busaddr
op_assign
l_int|0L
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scb-&gt;cmd.dcdb.op_code
op_eq
id|IPS_CMD_DCDB
)paren
id|scb-&gt;cmd.dcdb.dcdb_address
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
op_amp
id|scb-&gt;dcdb
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pt-&gt;CmdBSize
)paren
(brace
r_if
c_cond
(paren
id|scb-&gt;cmd.dcdb.op_code
op_eq
id|IPS_CMD_DCDB
)paren
id|scb-&gt;dcdb.buffer_pointer
op_assign
id|cpu_to_le32
c_func
(paren
id|scb-&gt;data_busaddr
)paren
suffix:semicolon
r_else
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|scb-&gt;data_busaddr
)paren
suffix:semicolon
)brace
multiline_comment|/* set timeouts */
r_if
c_cond
(paren
id|pt-&gt;TimeOut
)paren
(brace
id|scb-&gt;timeout
op_assign
id|pt-&gt;TimeOut
suffix:semicolon
r_if
c_cond
(paren
id|pt-&gt;TimeOut
op_le
l_int|10
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TIMEOUT10
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pt-&gt;TimeOut
op_le
l_int|60
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TIMEOUT60
suffix:semicolon
r_else
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TIMEOUT20M
suffix:semicolon
)brace
multiline_comment|/* assume success */
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* success */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_cleanup_passthru                                       */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Cleanup after a passthru command                                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_cleanup_passthru
id|ips_cleanup_passthru
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|ips_passthru_t
op_star
id|pt
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_cleanup_passthru&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|scb
)paren
op_logical_or
(paren
op_logical_neg
id|scb-&gt;scsi_cmd
)paren
op_logical_or
(paren
op_logical_neg
id|scb-&gt;scsi_cmd-&gt;request_buffer
)paren
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) couldn&squot;t cleanup after passthru&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pt
op_assign
(paren
id|ips_passthru_t
op_star
)paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
suffix:semicolon
multiline_comment|/* Copy data back to the user */
r_if
c_cond
(paren
id|scb-&gt;cmd.dcdb.op_code
op_eq
id|IPS_CMD_DCDB
)paren
multiline_comment|/* Copy DCDB Back to Caller&squot;s Area */
id|memcpy
c_func
(paren
op_amp
id|pt-&gt;CoppCP.dcdb
comma
op_amp
id|scb-&gt;dcdb
comma
r_sizeof
(paren
id|IPS_DCDB_TABLE
)paren
)paren
suffix:semicolon
id|pt-&gt;BasicStatus
op_assign
id|scb-&gt;basic_status
suffix:semicolon
id|pt-&gt;ExtendedStatus
op_assign
id|scb-&gt;extended_status
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IPS_IOCTL_NEW_COMMAND
)paren
id|up
c_func
(paren
op_amp
id|ha-&gt;ioctl_sem
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_host_info                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   The passthru interface for the driver                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_host_info
id|ips_host_info
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_char
op_star
id|ptr
comma
id|off_t
id|offset
comma
r_int
id|len
)paren
(brace
id|IPS_INFOSTR
id|info
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_host_info&quot;
comma
l_int|1
)paren
suffix:semicolon
id|info.buffer
op_assign
id|ptr
suffix:semicolon
id|info.length
op_assign
id|len
suffix:semicolon
id|info.offset
op_assign
id|offset
suffix:semicolon
id|info.pos
op_assign
l_int|0
suffix:semicolon
id|info.localpos
op_assign
l_int|0
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;nIBM ServeRAID General Information:&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|le32_to_cpu
c_func
(paren
id|ha-&gt;nvram-&gt;signature
)paren
op_eq
id|IPS_NVRAM_P5_SIG
)paren
op_logical_and
(paren
id|le16_to_cpu
c_func
(paren
id|ha-&gt;nvram-&gt;adapter_type
)paren
op_ne
l_int|0
)paren
)paren
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tController Type                   : %s&bslash;n&quot;
comma
id|ips_adapter_name
(braket
id|ha-&gt;ad_type
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_else
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tController Type                   : Unknown&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;io_addr
)paren
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tIO region                         : 0x%lx (%d bytes)&bslash;n&quot;
comma
id|ha-&gt;io_addr
comma
id|ha-&gt;io_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;mem_addr
)paren
(brace
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tMemory region                     : 0x%lx (%d bytes)&bslash;n&quot;
comma
id|ha-&gt;mem_addr
comma
id|ha-&gt;mem_len
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tShared memory address             : 0x%lx&bslash;n&quot;
comma
id|ha-&gt;mem_ptr
)paren
suffix:semicolon
)brace
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tIRQ number                        : %d&bslash;n&quot;
comma
id|ha-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|ha-&gt;nvram-&gt;signature
)paren
op_eq
id|IPS_NVRAM_P5_SIG
)paren
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tBIOS Version                      : %c%c%c%c%c%c%c%c&bslash;n&quot;
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|0
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|1
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|2
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|3
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|0
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|1
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|2
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tFirmware Version                  : %c%c%c%c%c%c%c%c&bslash;n&quot;
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|0
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|1
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|2
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|3
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|4
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|5
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|6
)braket
comma
id|ha-&gt;enq-&gt;CodeBlkVersion
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tBoot Block Version                : %c%c%c%c%c%c%c%c&bslash;n&quot;
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|0
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|1
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|2
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|3
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|4
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|5
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|6
)braket
comma
id|ha-&gt;enq-&gt;BootBlkVersion
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tDriver Version                    : %s%s&bslash;n&quot;
comma
id|IPS_VERSION_HIGH
comma
id|IPS_VERSION_LOW
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tMax Physical Devices              : %d&bslash;n&quot;
comma
id|ha-&gt;enq-&gt;ucMaxPhysicalDevices
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tMax Active Commands               : %d&bslash;n&quot;
comma
id|ha-&gt;max_cmds
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tCurrent Queued Commands           : %d&bslash;n&quot;
comma
id|ha-&gt;scb_waitlist.count
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tCurrent Active Commands           : %d&bslash;n&quot;
comma
id|ha-&gt;scb_activelist.count
op_minus
id|ha-&gt;num_ioctl
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tCurrent Queued PT Commands        : %d&bslash;n&quot;
comma
id|ha-&gt;copp_waitlist.count
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;tCurrent Active PT Commands        : %d&bslash;n&quot;
comma
id|ha-&gt;num_ioctl
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|info.localpos
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: copy_mem_info                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Copy data into an IPS_INFOSTR structure                                */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|copy_mem_info
id|copy_mem_info
c_func
(paren
id|IPS_INFOSTR
op_star
id|info
comma
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;copy_mem_info&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;pos
op_plus
id|len
OL
id|info-&gt;offset
)paren
(brace
id|info-&gt;pos
op_add_assign
id|len
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;pos
OL
id|info-&gt;offset
)paren
(brace
id|data
op_add_assign
(paren
id|info-&gt;offset
op_minus
id|info-&gt;pos
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|info-&gt;offset
op_minus
id|info-&gt;pos
)paren
suffix:semicolon
id|info-&gt;pos
op_add_assign
(paren
id|info-&gt;offset
op_minus
id|info-&gt;pos
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;localpos
op_plus
id|len
OG
id|info-&gt;length
)paren
id|len
op_assign
id|info-&gt;length
op_minus
id|info-&gt;localpos
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|info-&gt;buffer
op_plus
id|info-&gt;localpos
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|info-&gt;pos
op_add_assign
id|len
suffix:semicolon
id|info-&gt;localpos
op_add_assign
id|len
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: copy_info                                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   printf style wrapper for an info structure                             */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|copy_info
id|copy_info
c_func
(paren
id|IPS_INFOSTR
op_star
id|info
comma
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_char
id|buf
(braket
l_int|128
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;copy_info&quot;
comma
l_int|1
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|len
op_assign
id|vsprintf
c_func
(paren
id|buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
id|copy_mem_info
c_func
(paren
id|info
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_identify_controller                                    */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Identify this controller                                               */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_identify_controller
id|ips_identify_controller
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_identify_controller&quot;
comma
l_int|1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ha-&gt;device_id
)paren
(brace
r_case
id|IPS_DEVICEID_COPPERHEAD
suffix:colon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_le
id|IPS_REVID_SERVERAID
)paren
(brace
id|ha-&gt;ad_type
op_assign
id|IPS_ADTYPE_SERVERAID
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_SERVERAID2
)paren
(brace
id|ha-&gt;ad_type
op_assign
id|IPS_ADTYPE_SERVERAID2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_NAVAJO
)paren
(brace
id|ha-&gt;ad_type
op_assign
id|IPS_ADTYPE_NAVAJO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_SERVERAID2
)paren
op_logical_and
(paren
id|ha-&gt;slot_num
op_eq
l_int|0
)paren
)paren
(brace
id|ha-&gt;ad_type
op_assign
id|IPS_ADTYPE_KIOWA
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ha-&gt;revision_id
op_ge
id|IPS_REVID_CLARINETP1
)paren
op_logical_and
(paren
id|ha-&gt;revision_id
op_le
id|IPS_REVID_CLARINETP3
)paren
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;enq-&gt;ucMaxPhysicalDevices
op_eq
l_int|15
)paren
id|ha-&gt;ad_type
op_assign
id|IPS_ADTYPE_SERVERAID3L
suffix:semicolon
r_else
id|ha-&gt;ad_type
op_assign
id|IPS_ADTYPE_SERVERAID3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ha-&gt;revision_id
op_ge
id|IPS_REVID_TROMBONE32
)paren
op_logical_and
(paren
id|ha-&gt;revision_id
op_le
id|IPS_REVID_TROMBONE64
)paren
)paren
(brace
id|ha-&gt;ad_type
op_assign
id|IPS_ADTYPE_SERVERAID4H
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IPS_DEVICEID_MORPHEUS
suffix:colon
r_switch
c_cond
(paren
id|ha-&gt;subdevice_id
)paren
(brace
r_case
id|IPS_SUBDEVICEID_4L
suffix:colon
id|ha-&gt;ad_type
op_assign
id|IPS_ADTYPE_SERVERAID4L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_SUBDEVICEID_4M
suffix:colon
id|ha-&gt;ad_type
op_assign
id|IPS_ADTYPE_SERVERAID4M
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_SUBDEVICEID_4MX
suffix:colon
id|ha-&gt;ad_type
op_assign
id|IPS_ADTYPE_SERVERAID4MX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_SUBDEVICEID_4LX
suffix:colon
id|ha-&gt;ad_type
op_assign
id|IPS_ADTYPE_SERVERAID4LX
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_create_nvrampage5                                      */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Create a pseudo nvram page 5                                           */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_create_nvrampage5
id|ips_create_nvrampage5
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|IPS_NVRAM_P5
op_star
id|nvram
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_create_nvrampage5&quot;
comma
l_int|1
)paren
suffix:semicolon
id|memset
c_func
(paren
id|nvram
comma
l_int|0
comma
r_sizeof
(paren
id|IPS_NVRAM_P5
)paren
)paren
suffix:semicolon
id|nvram-&gt;signature
op_assign
id|IPS_NVRAM_P5_SIG
suffix:semicolon
id|nvram-&gt;adapter_slot
op_assign
id|ha-&gt;slot_num
suffix:semicolon
id|nvram-&gt;adapter_type
op_assign
id|ha-&gt;ad_type
suffix:semicolon
id|nvram-&gt;operating_system
op_assign
id|IPS_OS_LINUX
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_char
op_star
)paren
id|nvram-&gt;driver_high
comma
id|IPS_VERSION_HIGH
comma
l_int|4
)paren
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_char
op_star
)paren
id|nvram-&gt;driver_low
comma
id|IPS_VERSION_LOW
comma
l_int|4
)paren
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_char
op_star
)paren
id|nvram-&gt;bios_high
comma
id|ha-&gt;bios_version
comma
l_int|4
)paren
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_char
op_star
)paren
id|nvram-&gt;bios_low
comma
id|ha-&gt;bios_version
op_plus
l_int|4
comma
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_get_bios_version                                       */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Get the BIOS revision number                                           */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_get_bios_version
id|ips_get_bios_version
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|intr
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|u_int8_t
id|major
suffix:semicolon
id|u_int8_t
id|minor
suffix:semicolon
id|u_int8_t
id|subminor
suffix:semicolon
id|u_int8_t
op_star
id|buffer
suffix:semicolon
r_char
id|hexDigits
(braket
)braket
op_assign
(brace
l_char|&squot;0&squot;
comma
l_char|&squot;1&squot;
comma
l_char|&squot;2&squot;
comma
l_char|&squot;3&squot;
comma
l_char|&squot;4&squot;
comma
l_char|&squot;5&squot;
comma
l_char|&squot;6&squot;
comma
l_char|&squot;7&squot;
comma
l_char|&squot;8&squot;
comma
l_char|&squot;9&squot;
comma
l_char|&squot;A&squot;
comma
l_char|&squot;B&squot;
comma
l_char|&squot;C&squot;
comma
l_char|&squot;D&squot;
comma
l_char|&squot;E&squot;
comma
l_char|&squot;F&squot;
)brace
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_get_bios_version&quot;
comma
l_int|1
)paren
suffix:semicolon
id|major
op_assign
l_int|0
suffix:semicolon
id|minor
op_assign
l_int|0
suffix:semicolon
id|strncpy
c_func
(paren
id|ha-&gt;bios_version
comma
l_string|&quot;       ?&quot;
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;device_id
op_eq
id|IPS_DEVICEID_COPPERHEAD
)paren
(brace
r_if
c_cond
(paren
id|IPS_USE_MEMIO
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* Memory Mapped I/O */
multiline_comment|/* test 1st byte */
id|writel
c_func
(paren
l_int|0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
op_ne
l_int|0x55
)paren
r_return
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|1
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
op_ne
l_int|0xAA
)paren
r_return
suffix:semicolon
multiline_comment|/* Get Major version */
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|0x1FF
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|major
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
multiline_comment|/* Get Minor version */
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|0x1FE
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|minor
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
multiline_comment|/* Get SubMinor version */
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|0x1FD
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|subminor
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Programmed I/O */
multiline_comment|/* test 1st byte */
id|outl
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
op_ne
l_int|0x55
)paren
r_return
suffix:semicolon
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|1
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
op_ne
l_int|0xAA
)paren
r_return
suffix:semicolon
multiline_comment|/* Get Major version */
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|0x1FF
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|major
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
multiline_comment|/* Get Minor version */
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|0x1FE
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|minor
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
multiline_comment|/* Get SubMinor version */
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|0x1FD
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|subminor
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Morpheus Family - Send Command to the card */
id|buffer
op_assign
id|kmalloc
c_func
(paren
l_int|0x1000
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|buffer
comma
l_int|0
comma
l_int|0x1000
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPS_CMD_RW_BIOSFW
suffix:semicolon
id|scb-&gt;cmd.flashfw.op_code
op_assign
id|IPS_CMD_RW_BIOSFW
suffix:semicolon
id|scb-&gt;cmd.flashfw.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.flashfw.type
op_assign
l_int|1
suffix:semicolon
id|scb-&gt;cmd.flashfw.direction
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.flashfw.count
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x800
)paren
suffix:semicolon
id|scb-&gt;cmd.flashfw.buffer_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|buffer
)paren
)paren
suffix:semicolon
id|scb-&gt;cmd.flashfw.total_packets
op_assign
l_int|1
suffix:semicolon
id|scb-&gt;cmd.flashfw.packet_num
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* issue the command */
r_if
c_cond
(paren
(paren
(paren
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
comma
id|intr
)paren
)paren
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
op_logical_or
(paren
(paren
id|scb-&gt;basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
OG
l_int|1
)paren
)paren
(brace
multiline_comment|/* Error occurred */
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|buffer
(braket
l_int|0xC0
)braket
op_eq
l_int|0x55
)paren
op_logical_and
(paren
id|buffer
(braket
l_int|0xC1
)braket
op_eq
l_int|0xAA
)paren
)paren
(brace
id|major
op_assign
id|buffer
(braket
l_int|0x1ff
op_plus
l_int|0xC0
)braket
suffix:semicolon
multiline_comment|/* Offset 0x1ff after the header (0xc0) */
id|minor
op_assign
id|buffer
(braket
l_int|0x1fe
op_plus
l_int|0xC0
)braket
suffix:semicolon
multiline_comment|/* Offset 0x1fe after the header (0xc0) */
id|subminor
op_assign
id|buffer
(braket
l_int|0x1fd
op_plus
l_int|0xC0
)braket
suffix:semicolon
multiline_comment|/* Offset 0x1fd after the header (0xc0) */
)brace
r_else
(brace
r_return
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
)brace
id|ha-&gt;bios_version
(braket
l_int|0
)braket
op_assign
id|hexDigits
(braket
(paren
id|major
op_amp
l_int|0xF0
)paren
op_rshift
l_int|4
)braket
suffix:semicolon
id|ha-&gt;bios_version
(braket
l_int|1
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|ha-&gt;bios_version
(braket
l_int|2
)braket
op_assign
id|hexDigits
(braket
id|major
op_amp
l_int|0x0F
)braket
suffix:semicolon
id|ha-&gt;bios_version
(braket
l_int|3
)braket
op_assign
id|hexDigits
(braket
id|subminor
)braket
suffix:semicolon
id|ha-&gt;bios_version
(braket
l_int|4
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|ha-&gt;bios_version
(braket
l_int|5
)braket
op_assign
id|hexDigits
(braket
(paren
id|minor
op_amp
l_int|0xF0
)paren
op_rshift
l_int|4
)braket
suffix:semicolon
id|ha-&gt;bios_version
(braket
l_int|6
)braket
op_assign
id|hexDigits
(braket
id|minor
op_amp
l_int|0x0F
)braket
suffix:semicolon
id|ha-&gt;bios_version
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_hainit                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize the controller                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* NOTE: Assumes to be called from with a lock                              */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_hainit
id|ips_hainit
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_hainit&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;func.statinit
)paren
(paren
op_star
id|ha-&gt;func.statinit
)paren
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;func.enableint
)paren
(paren
op_star
id|ha-&gt;func.enableint
)paren
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Send FFDC */
id|ha-&gt;reset_count
op_assign
l_int|1
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|ha-&gt;last_ffdc
op_assign
id|tv.tv_sec
suffix:semicolon
id|ips_ffdc_reset
c_func
(paren
id|ha
comma
id|IPS_INTR_IORL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ips_read_config
c_func
(paren
id|ha
comma
id|IPS_INTR_IORL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to read config from controller.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* end if */
r_if
c_cond
(paren
op_logical_neg
id|ips_read_adapter_status
c_func
(paren
id|ha
comma
id|IPS_INTR_IORL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to read controller status.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Identify this controller */
id|ips_identify_controller
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ips_read_subsystem_parameters
c_func
(paren
id|ha
comma
id|IPS_INTR_IORL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to read subsystem parameters.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* write nvram user page 5 */
r_if
c_cond
(paren
op_logical_neg
id|ips_write_driver_status
c_func
(paren
id|ha
comma
id|IPS_INTR_IORL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to write driver info to controller.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* set limits on SID, LUN, BUS */
id|ha-&gt;ntargets
op_assign
id|IPS_MAX_TARGETS
op_plus
l_int|1
suffix:semicolon
id|ha-&gt;nlun
op_assign
l_int|1
suffix:semicolon
id|ha-&gt;nbus
op_assign
(paren
id|ha-&gt;enq-&gt;ucMaxPhysicalDevices
op_div
id|IPS_MAX_TARGETS
)paren
op_plus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|ha-&gt;conf-&gt;logical_drive
(braket
l_int|0
)braket
dot
id|ucStripeSize
)paren
(brace
r_case
l_int|4
suffix:colon
id|ha-&gt;max_xfer
op_assign
l_int|0x10000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|ha-&gt;max_xfer
op_assign
l_int|0x20000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|ha-&gt;max_xfer
op_assign
l_int|0x40000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
r_default
suffix:colon
id|ha-&gt;max_xfer
op_assign
l_int|0x80000
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* setup max concurrent commands */
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|ha-&gt;subsys-&gt;param
(braket
l_int|4
)braket
)paren
op_amp
l_int|0x1
)paren
(brace
multiline_comment|/* Use the new method */
id|ha-&gt;max_cmds
op_assign
id|ha-&gt;enq-&gt;ucConcurrentCmdCount
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* use the old method */
r_switch
c_cond
(paren
id|ha-&gt;conf-&gt;logical_drive
(braket
l_int|0
)braket
dot
id|ucStripeSize
)paren
(brace
r_case
l_int|4
suffix:colon
id|ha-&gt;max_cmds
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|ha-&gt;max_cmds
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|ha-&gt;max_cmds
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
r_default
suffix:colon
id|ha-&gt;max_cmds
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* set controller IDs */
id|ha-&gt;ha_id
(braket
l_int|0
)braket
op_assign
id|IPS_ADAPTER_ID
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|ha-&gt;nbus
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ha-&gt;ha_id
(braket
id|i
)braket
op_assign
id|ha-&gt;conf-&gt;init_id
(braket
id|i
op_minus
l_int|1
)braket
op_amp
l_int|0x1f
suffix:semicolon
id|ha-&gt;dcdb_active
(braket
id|i
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_next                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Take the next command off the queue and send it to the controller      */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_next
id|ips_next
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|intr
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SC
suffix:semicolon
id|Scsi_Cmnd
op_star
id|p
suffix:semicolon
id|Scsi_Cmnd
op_star
id|q
suffix:semicolon
id|ips_copp_wait_item_t
op_star
id|item
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|intr_status
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
r_int
r_int
id|cpu_flags2
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_next&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
r_return
suffix:semicolon
id|host
op_assign
id|ips_sh
(braket
id|ha-&gt;host_num
)braket
suffix:semicolon
multiline_comment|/*&n;    * Block access to the queue function so&n;    * this command won&squot;t time out&n;    */
r_if
c_cond
(paren
id|intr
op_eq
id|IPS_INTR_ON
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;host_lock
comma
id|cpu_flags2
)paren
suffix:semicolon
id|intr_status
op_assign
id|IPS_INTR_IORL
suffix:semicolon
)brace
r_else
(brace
id|intr_status
op_assign
id|intr
suffix:semicolon
multiline_comment|/* Quiet the compiler */
id|cpu_flags2
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ha-&gt;subsys-&gt;param
(braket
l_int|3
)braket
op_amp
l_int|0x300000
)paren
op_logical_and
(paren
id|ha-&gt;scb_activelist.count
op_eq
l_int|0
)paren
)paren
(brace
r_struct
id|timeval
id|tv
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tv.tv_sec
op_minus
id|ha-&gt;last_ffdc
OG
id|IPS_SECS_8HOURS
)paren
(brace
id|ha-&gt;last_ffdc
op_assign
id|tv.tv_sec
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|ips_ffdc_time
c_func
(paren
id|ha
comma
id|intr_status
)paren
suffix:semicolon
)brace
r_else
(brace
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intr
op_eq
id|IPS_INTR_ON
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;host_lock
comma
id|cpu_flags2
)paren
suffix:semicolon
macro_line|#ifndef NO_IPS_CMDLINE
multiline_comment|/*&n;    * Send passthru commands&n;    * These have priority over normal I/O&n;    * but shouldn&squot;t affect performance too much&n;    * since we limit the number that can be active&n;    * on the card at any one time&n;    */
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ha-&gt;num_ioctl
OL
id|IPS_MAX_IOCTL
)paren
op_logical_and
(paren
id|ha-&gt;copp_waitlist.head
)paren
op_logical_and
(paren
id|scb
op_assign
id|ips_getscb
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
id|item
op_assign
id|ips_removeq_copp_head
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
id|ha-&gt;num_ioctl
op_increment
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|scb-&gt;scsi_cmd
op_assign
id|item-&gt;scsi_cmd
suffix:semicolon
id|scb-&gt;sem
op_assign
id|item-&gt;sem
suffix:semicolon
id|kfree
c_func
(paren
id|item
)paren
suffix:semicolon
id|ret
op_assign
id|ips_make_passthru
c_func
(paren
id|ha
comma
id|scb-&gt;scsi_cmd
comma
id|scb
comma
id|intr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|IPS_FAILURE
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* raise the semaphore */
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IPS_IOCTL_NEW_COMMAND
)paren
(brace
id|u_int32_t
id|datasize
suffix:semicolon
id|datasize
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|8
)braket
comma
op_amp
id|datasize
comma
l_int|4
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ha-&gt;ioctl_sem
)paren
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
)brace
)brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_SUCCESS_IMM
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* raise the semaphore */
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IPS_IOCTL_NEW_COMMAND
)paren
(brace
id|u_int32_t
id|datasize
suffix:semicolon
id|datasize
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|8
)braket
comma
op_amp
id|datasize
comma
l_int|4
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ha-&gt;ioctl_sem
)paren
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
)brace
)brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* end case */
r_if
c_cond
(paren
id|ret
op_ne
id|IPS_SUCCESS
)paren
(brace
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
id|ha-&gt;num_ioctl
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ret
op_assign
id|ips_send_cmd
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|IPS_SUCCESS
)paren
id|ips_putq_scb_head
c_func
(paren
op_amp
id|ha-&gt;scb_activelist
comma
id|scb
)paren
suffix:semicolon
r_else
id|ha-&gt;num_ioctl
op_decrement
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|IPS_FAILURE
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
multiline_comment|/* raise the semaphore */
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IPS_IOCTL_NEW_COMMAND
)paren
id|up
c_func
(paren
op_amp
id|ha-&gt;ioctl_sem
)paren
suffix:semicolon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_SUCCESS_IMM
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
multiline_comment|/* raise the semaphore */
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|IPS_IOCTL_NEW_COMMAND
)paren
id|up
c_func
(paren
op_amp
id|ha-&gt;ioctl_sem
)paren
suffix:semicolon
)brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* end case */
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
)brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
op_amp
id|ha-&gt;copp_waitlist
)paren
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;    * Send &quot;Normal&quot; I/O commands&n;    */
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
)paren
suffix:semicolon
id|p
op_assign
id|ha-&gt;scb_waitlist.head
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
)paren
op_logical_and
(paren
id|scb
op_assign
id|ips_getscb
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|p-&gt;channel
OG
l_int|0
)paren
op_logical_and
(paren
id|ha-&gt;dcdb_active
(braket
id|p-&gt;channel
op_minus
l_int|1
)braket
op_amp
(paren
l_int|1
op_lshift
id|p-&gt;target
)paren
)paren
)paren
(brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|p
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|p-&gt;host_scribble
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|q
op_assign
id|p
suffix:semicolon
id|SC
op_assign
id|ips_removeq_wait
c_func
(paren
op_amp
id|ha-&gt;scb_waitlist
comma
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SC
op_eq
l_int|NULL
)paren
multiline_comment|/* Should never happen, but good to check anyway */
r_continue
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
multiline_comment|/* Unlock HA after command is taken off queue */
id|SC-&gt;result
op_assign
id|DID_OK
suffix:semicolon
id|SC-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|SC-&gt;sense_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|SC-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|scb-&gt;target_id
op_assign
id|SC-&gt;target
suffix:semicolon
id|scb-&gt;lun
op_assign
id|SC-&gt;lun
suffix:semicolon
id|scb-&gt;bus
op_assign
id|SC-&gt;channel
suffix:semicolon
id|scb-&gt;scsi_cmd
op_assign
id|SC
suffix:semicolon
id|scb-&gt;breakup
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;data_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;callback
op_assign
id|ipsintr_done
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|scb-&gt;cmd
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* copy in the CDB */
id|memcpy
c_func
(paren
id|scb-&gt;cdb
comma
id|SC-&gt;cmnd
comma
id|SC-&gt;cmd_len
)paren
suffix:semicolon
multiline_comment|/* Now handle the data buffer */
r_if
c_cond
(paren
id|SC-&gt;use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sg
op_assign
id|SC-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|SC-&gt;use_sg
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|sg
(braket
l_int|0
)braket
dot
id|length
OG
id|ha-&gt;max_xfer
)paren
(brace
id|scb-&gt;breakup
op_assign
l_int|1
suffix:semicolon
id|scb-&gt;data_len
op_assign
id|ha-&gt;max_xfer
suffix:semicolon
)brace
r_else
id|scb-&gt;data_len
op_assign
id|sg
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
id|scb-&gt;dcdb.transfer_length
op_assign
id|scb-&gt;data_len
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|sg
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Check for the first Element being bigger than MAX_XFER */
r_if
c_cond
(paren
id|sg
(braket
l_int|0
)braket
dot
id|length
OG
id|ha-&gt;max_xfer
)paren
(brace
id|scb-&gt;sg_list
(braket
l_int|0
)braket
dot
id|address
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|sg
(braket
l_int|0
)braket
dot
id|address
)paren
)paren
suffix:semicolon
id|scb-&gt;sg_list
(braket
l_int|0
)braket
dot
id|length
op_assign
id|ha-&gt;max_xfer
suffix:semicolon
id|scb-&gt;data_len
op_assign
id|ha-&gt;max_xfer
suffix:semicolon
id|scb-&gt;breakup
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;sg_break
op_assign
l_int|1
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SC-&gt;use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|scb-&gt;sg_list
(braket
id|i
)braket
dot
id|address
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|address
)paren
)paren
suffix:semicolon
id|scb-&gt;sg_list
(braket
id|i
)braket
dot
id|length
op_assign
id|cpu_to_le32
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;data_len
op_plus
id|sg
(braket
id|i
)braket
dot
id|length
OG
id|ha-&gt;max_xfer
)paren
(brace
multiline_comment|/*&n;                      * Data Breakup required&n;                      */
id|scb-&gt;breakup
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
id|scb-&gt;data_len
op_add_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;breakup
)paren
id|scb-&gt;sg_len
op_assign
id|SC-&gt;use_sg
suffix:semicolon
r_else
id|scb-&gt;sg_len
op_assign
id|scb-&gt;breakup
suffix:semicolon
)brace
id|scb-&gt;dcdb.transfer_length
op_assign
id|scb-&gt;data_len
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb-&gt;sg_list
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|SC-&gt;request_bufflen
)paren
(brace
r_if
c_cond
(paren
id|SC-&gt;request_bufflen
OG
id|ha-&gt;max_xfer
)paren
(brace
multiline_comment|/*&n;                * Data breakup required&n;                */
id|scb-&gt;breakup
op_assign
l_int|1
suffix:semicolon
id|scb-&gt;data_len
op_assign
id|ha-&gt;max_xfer
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;data_len
op_assign
id|SC-&gt;request_bufflen
suffix:semicolon
)brace
id|scb-&gt;dcdb.transfer_length
op_assign
id|scb-&gt;data_len
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|SC-&gt;request_buffer
)paren
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;data_busaddr
op_assign
l_int|0L
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;data_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;dcdb.transfer_length
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|ips_command_direction
(braket
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;dcdb.cmd_attribute
op_amp
l_int|0x3
)paren
id|scb-&gt;dcdb.transfer_length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;data_len
op_ge
id|IPS_MAX_XFER
)paren
(brace
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TRANSFER64K
suffix:semicolon
id|scb-&gt;dcdb.transfer_length
op_assign
l_int|0
suffix:semicolon
)brace
id|ret
op_assign
id|ips_send_cmd
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|IPS_SUCCESS
)paren
id|ips_putq_scb_head
c_func
(paren
op_amp
id|ha-&gt;scb_activelist
comma
id|scb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|IPS_FAILURE
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
id|ha-&gt;dcdb_active
(braket
id|scb-&gt;bus
op_minus
l_int|1
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|scb-&gt;target_id
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_SUCCESS_IMM
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
id|ha-&gt;dcdb_active
(braket
id|scb-&gt;bus
op_minus
l_int|1
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|scb-&gt;target_id
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* end case */
id|p
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|p-&gt;host_scribble
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/* end while */
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_putq_scb_head                                          */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Add an item to the head of the queue                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
r_void
DECL|function|ips_putq_scb_head
id|ips_putq_scb_head
c_func
(paren
id|ips_scb_queue_t
op_star
id|queue
comma
id|ips_scb_t
op_star
id|item
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_putq_scb_head&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
id|item-&gt;q_next
op_assign
id|queue-&gt;head
suffix:semicolon
id|queue-&gt;head
op_assign
id|item
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue-&gt;tail
)paren
id|queue-&gt;tail
op_assign
id|item
suffix:semicolon
id|queue-&gt;count
op_increment
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_putq_scb_tail                                          */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Add an item to the tail of the queue                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
r_void
DECL|function|ips_putq_scb_tail
id|ips_putq_scb_tail
c_func
(paren
id|ips_scb_queue_t
op_star
id|queue
comma
id|ips_scb_t
op_star
id|item
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_putq_scb_tail&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
id|item-&gt;q_next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|queue-&gt;tail
)paren
id|queue-&gt;tail-&gt;q_next
op_assign
id|item
suffix:semicolon
id|queue-&gt;tail
op_assign
id|item
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue-&gt;head
)paren
id|queue-&gt;head
op_assign
id|item
suffix:semicolon
id|queue-&gt;count
op_increment
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_removeq_scb_head                                       */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove the head of the queue                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
id|ips_scb_t
op_star
DECL|function|ips_removeq_scb_head
id|ips_removeq_scb_head
c_func
(paren
id|ips_scb_queue_t
op_star
id|queue
)paren
(brace
id|ips_scb_t
op_star
id|item
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_removeq_scb_head&quot;
comma
l_int|1
)paren
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
id|item
op_assign
id|queue-&gt;head
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
(brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|queue-&gt;head
op_assign
id|item-&gt;q_next
suffix:semicolon
id|item-&gt;q_next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|queue-&gt;tail
op_eq
id|item
)paren
id|queue-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
id|queue-&gt;count
op_decrement
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
id|item
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_removeq_scb                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove an item from a queue                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
id|ips_scb_t
op_star
DECL|function|ips_removeq_scb
id|ips_removeq_scb
c_func
(paren
id|ips_scb_queue_t
op_star
id|queue
comma
id|ips_scb_t
op_star
id|item
)paren
(brace
id|ips_scb_t
op_star
id|p
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_removeq_scb&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|item
op_eq
id|queue-&gt;head
)paren
(brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
id|ips_removeq_scb_head
c_func
(paren
id|queue
)paren
)paren
suffix:semicolon
)brace
id|p
op_assign
id|queue-&gt;head
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
)paren
op_logical_and
(paren
id|item
op_ne
id|p-&gt;q_next
)paren
)paren
id|p
op_assign
id|p-&gt;q_next
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
multiline_comment|/* found a match */
id|p-&gt;q_next
op_assign
id|item-&gt;q_next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item-&gt;q_next
)paren
id|queue-&gt;tail
op_assign
id|p
suffix:semicolon
id|item-&gt;q_next
op_assign
l_int|NULL
suffix:semicolon
id|queue-&gt;count
op_decrement
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
id|item
)paren
suffix:semicolon
)brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_putq_wait_head                                         */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Add an item to the head of the queue                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
r_void
DECL|function|ips_putq_wait_head
id|ips_putq_wait_head
c_func
(paren
id|ips_wait_queue_t
op_star
id|queue
comma
id|Scsi_Cmnd
op_star
id|item
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_putq_wait_head&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
id|item-&gt;host_scribble
op_assign
(paren
r_char
op_star
)paren
id|queue-&gt;head
suffix:semicolon
id|queue-&gt;head
op_assign
id|item
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue-&gt;tail
)paren
id|queue-&gt;tail
op_assign
id|item
suffix:semicolon
id|queue-&gt;count
op_increment
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_putq_wait_tail                                         */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Add an item to the tail of the queue                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
r_void
DECL|function|ips_putq_wait_tail
id|ips_putq_wait_tail
c_func
(paren
id|ips_wait_queue_t
op_star
id|queue
comma
id|Scsi_Cmnd
op_star
id|item
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_putq_wait_tail&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
id|item-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|queue-&gt;tail
)paren
id|queue-&gt;tail-&gt;host_scribble
op_assign
(paren
r_char
op_star
)paren
id|item
suffix:semicolon
id|queue-&gt;tail
op_assign
id|item
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue-&gt;head
)paren
id|queue-&gt;head
op_assign
id|item
suffix:semicolon
id|queue-&gt;count
op_increment
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_removeq_wait_head                                      */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove the head of the queue                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
id|Scsi_Cmnd
op_star
DECL|function|ips_removeq_wait_head
id|ips_removeq_wait_head
c_func
(paren
id|ips_wait_queue_t
op_star
id|queue
)paren
(brace
id|Scsi_Cmnd
op_star
id|item
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_removeq_wait_head&quot;
comma
l_int|1
)paren
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
id|item
op_assign
id|queue-&gt;head
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
(brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|queue-&gt;head
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|item-&gt;host_scribble
suffix:semicolon
id|item-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|queue-&gt;tail
op_eq
id|item
)paren
id|queue-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
id|queue-&gt;count
op_decrement
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
id|item
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_removeq_wait                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove an item from a queue                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
id|Scsi_Cmnd
op_star
DECL|function|ips_removeq_wait
id|ips_removeq_wait
c_func
(paren
id|ips_wait_queue_t
op_star
id|queue
comma
id|Scsi_Cmnd
op_star
id|item
)paren
(brace
id|Scsi_Cmnd
op_star
id|p
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_removeq_wait&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|item
op_eq
id|queue-&gt;head
)paren
(brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
id|ips_removeq_wait_head
c_func
(paren
id|queue
)paren
)paren
suffix:semicolon
)brace
id|p
op_assign
id|queue-&gt;head
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
)paren
op_logical_and
(paren
id|item
op_ne
(paren
id|Scsi_Cmnd
op_star
)paren
id|p-&gt;host_scribble
)paren
)paren
id|p
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|p-&gt;host_scribble
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
multiline_comment|/* found a match */
id|p-&gt;host_scribble
op_assign
id|item-&gt;host_scribble
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item-&gt;host_scribble
)paren
id|queue-&gt;tail
op_assign
id|p
suffix:semicolon
id|item-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|queue-&gt;count
op_decrement
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
id|item
)paren
suffix:semicolon
)brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_putq_copp_head                                         */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Add an item to the head of the queue                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
r_void
DECL|function|ips_putq_copp_head
id|ips_putq_copp_head
c_func
(paren
id|ips_copp_queue_t
op_star
id|queue
comma
id|ips_copp_wait_item_t
op_star
id|item
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_putq_copp_head&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
id|item-&gt;next
op_assign
id|queue-&gt;head
suffix:semicolon
id|queue-&gt;head
op_assign
id|item
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue-&gt;tail
)paren
id|queue-&gt;tail
op_assign
id|item
suffix:semicolon
id|queue-&gt;count
op_increment
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_putq_copp_tail                                         */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Add an item to the tail of the queue                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
r_void
DECL|function|ips_putq_copp_tail
id|ips_putq_copp_tail
c_func
(paren
id|ips_copp_queue_t
op_star
id|queue
comma
id|ips_copp_wait_item_t
op_star
id|item
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_putq_copp_tail&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
id|item-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|queue-&gt;tail
)paren
id|queue-&gt;tail-&gt;next
op_assign
id|item
suffix:semicolon
id|queue-&gt;tail
op_assign
id|item
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue-&gt;head
)paren
id|queue-&gt;head
op_assign
id|item
suffix:semicolon
id|queue-&gt;count
op_increment
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_removeq_copp_head                                      */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove the head of the queue                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
id|ips_copp_wait_item_t
op_star
DECL|function|ips_removeq_copp_head
id|ips_removeq_copp_head
c_func
(paren
id|ips_copp_queue_t
op_star
id|queue
)paren
(brace
id|ips_copp_wait_item_t
op_star
id|item
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_removeq_copp_head&quot;
comma
l_int|1
)paren
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
id|item
op_assign
id|queue-&gt;head
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
(brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|queue-&gt;head
op_assign
id|item-&gt;next
suffix:semicolon
id|item-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|queue-&gt;tail
op_eq
id|item
)paren
id|queue-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
id|queue-&gt;count
op_decrement
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
id|item
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_removeq_copp                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove an item from a queue                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_inline
id|ips_copp_wait_item_t
op_star
DECL|function|ips_removeq_copp
id|ips_removeq_copp
c_func
(paren
id|ips_copp_queue_t
op_star
id|queue
comma
id|ips_copp_wait_item_t
op_star
id|item
)paren
(brace
id|ips_copp_wait_item_t
op_star
id|p
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_removeq_copp&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|IPS_QUEUE_LOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|item
op_eq
id|queue-&gt;head
)paren
(brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
id|ips_removeq_copp_head
c_func
(paren
id|queue
)paren
)paren
suffix:semicolon
)brace
id|p
op_assign
id|queue-&gt;head
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
)paren
op_logical_and
(paren
id|item
op_ne
id|p-&gt;next
)paren
)paren
id|p
op_assign
id|p-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
multiline_comment|/* found a match */
id|p-&gt;next
op_assign
id|item-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|item-&gt;next
)paren
id|queue-&gt;tail
op_assign
id|p
suffix:semicolon
id|item-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|queue-&gt;count
op_decrement
suffix:semicolon
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
id|item
)paren
suffix:semicolon
)brace
id|IPS_QUEUE_UNLOCK
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ipsintr_blocking                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Finalize an interrupt for internal commands                            */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ipsintr_blocking
id|ipsintr_blocking
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ipsintr_blocking&quot;
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ha-&gt;waitflag
op_eq
id|TRUE
)paren
op_logical_and
(paren
id|ha-&gt;cmd_in_progress
op_eq
id|scb-&gt;cdb
(braket
l_int|0
)braket
)paren
)paren
(brace
id|ha-&gt;waitflag
op_assign
id|FALSE
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ipsintr_done                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Finalize an interrupt for non-internal commands                        */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ipsintr_done
id|ipsintr_done
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ipsintr_done&quot;
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Spurious interrupt; scb NULL.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* unexpected interrupt */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) Spurious interrupt; scsi_cmd not set.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ips_done
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_done                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Do housekeeping on completed commands                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_done
id|ips_done
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_done&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb
)paren
r_return
suffix:semicolon
macro_line|#ifndef NO_IPS_CMDLINE
r_if
c_cond
(paren
(paren
id|scb-&gt;scsi_cmd
)paren
op_logical_and
(paren
id|ips_is_passthru
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
)paren
)paren
(brace
id|ips_cleanup_passthru
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|ha-&gt;num_ioctl
op_decrement
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#endif
multiline_comment|/*&n;       * Check to see if this command had too much&n;       * data and had to be broke up.  If so, queue&n;       * the rest of the data and continue.&n;       */
r_if
c_cond
(paren
id|scb-&gt;breakup
)paren
(brace
multiline_comment|/* we had a data breakup */
id|u_int8_t
id|bk_save
suffix:semicolon
id|bk_save
op_assign
id|scb-&gt;breakup
suffix:semicolon
id|scb-&gt;breakup
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;use_sg
)paren
(brace
multiline_comment|/* S/G request */
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sg
op_assign
id|scb-&gt;scsi_cmd-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;use_sg
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|sg
(braket
l_int|0
)braket
dot
id|length
op_minus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
OG
id|ha-&gt;max_xfer
)paren
(brace
multiline_comment|/* Further breakup required */
id|scb-&gt;data_len
op_assign
id|ha-&gt;max_xfer
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|sg
(braket
l_int|0
)braket
dot
id|address
op_plus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
)paren
suffix:semicolon
id|scb-&gt;breakup
op_assign
id|bk_save
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;data_len
op_assign
id|sg
(braket
l_int|0
)braket
dot
id|length
op_minus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|sg
(braket
l_int|0
)braket
dot
id|address
op_plus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
)paren
suffix:semicolon
)brace
id|scb-&gt;dcdb.transfer_length
op_assign
id|scb-&gt;data_len
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We&squot;re here because there was MORE than one s/g unit. */
multiline_comment|/* bk_save points to which sg unit to look at           */
multiline_comment|/* sg_break points to how far through this unit we are  */
multiline_comment|/* NOTE: We will not move from one sg to another here,  */
multiline_comment|/*    just finish the one we are in.  Not the most      */
multiline_comment|/*    efficient, but it keeps it from getting too hacky */
multiline_comment|/* IF sg_break is non-zero, then just work on this current sg piece, */
multiline_comment|/* pointed to by bk_save                                             */
r_if
c_cond
(paren
id|scb-&gt;sg_break
)paren
(brace
id|scb-&gt;sg_len
op_assign
l_int|1
suffix:semicolon
id|scb-&gt;sg_list
(braket
l_int|0
)braket
dot
id|address
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|sg
(braket
id|bk_save
)braket
dot
id|address
op_plus
id|ha-&gt;max_xfer
op_star
id|scb-&gt;sg_break
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;max_xfer
OG
id|sg
(braket
id|bk_save
)braket
dot
id|length
op_minus
id|ha-&gt;max_xfer
op_star
id|scb-&gt;sg_break
)paren
id|scb-&gt;sg_list
(braket
l_int|0
)braket
dot
id|length
op_assign
id|sg
(braket
id|bk_save
)braket
dot
id|length
op_minus
id|ha-&gt;max_xfer
op_star
id|scb-&gt;sg_break
suffix:semicolon
r_else
id|scb-&gt;sg_list
(braket
l_int|0
)braket
dot
id|length
op_assign
id|ha-&gt;max_xfer
suffix:semicolon
id|scb-&gt;sg_break
op_increment
suffix:semicolon
multiline_comment|/* MUST GO HERE for math below to work */
id|scb-&gt;data_len
op_assign
id|scb-&gt;sg_list
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
suffix:semicolon
r_if
c_cond
(paren
id|sg
(braket
id|bk_save
)braket
dot
id|length
op_le
id|ha-&gt;max_xfer
op_star
id|scb-&gt;sg_break
)paren
(brace
id|scb-&gt;sg_break
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No more work in this unit */
r_if
c_cond
(paren
(paren
id|bk_save
op_plus
l_int|1
)paren
op_ge
id|scb-&gt;scsi_cmd-&gt;use_sg
)paren
id|scb-&gt;breakup
op_assign
l_int|0
suffix:semicolon
r_else
id|scb-&gt;breakup
op_assign
id|bk_save
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ( sg_break == 0 ), so this is our first look at a new sg piece */
r_if
c_cond
(paren
id|sg
(braket
id|bk_save
)braket
dot
id|length
OG
id|ha-&gt;max_xfer
)paren
(brace
id|scb-&gt;sg_list
(braket
l_int|0
)braket
dot
id|address
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|sg
(braket
id|bk_save
)braket
dot
id|address
)paren
)paren
suffix:semicolon
id|scb-&gt;sg_list
(braket
l_int|0
)braket
dot
id|length
op_assign
id|ha-&gt;max_xfer
suffix:semicolon
id|scb-&gt;breakup
op_assign
id|bk_save
suffix:semicolon
id|scb-&gt;sg_break
op_assign
l_int|1
suffix:semicolon
id|scb-&gt;data_len
op_assign
id|ha-&gt;max_xfer
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* OK, the next sg is a short one, so loop until full */
id|scb-&gt;data_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;sg_break
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*   We&squot;re only doing full units here */
r_for
c_loop
(paren
id|i
op_assign
id|bk_save
suffix:semicolon
id|i
OL
id|scb-&gt;scsi_cmd-&gt;use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|scb-&gt;sg_list
(braket
id|i
op_minus
id|bk_save
)braket
dot
id|address
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|address
)paren
)paren
suffix:semicolon
id|scb-&gt;sg_list
(braket
id|i
op_minus
id|bk_save
)braket
dot
id|length
op_assign
id|cpu_to_le32
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;data_len
op_plus
id|sg
(braket
id|i
)braket
dot
id|length
OG
id|ha-&gt;max_xfer
)paren
(brace
id|scb-&gt;breakup
op_assign
id|i
suffix:semicolon
multiline_comment|/* sneaky, if not more work, than breakup is 0 */
r_break
suffix:semicolon
)brace
id|scb-&gt;data_len
op_add_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|scb-&gt;sg_len
op_increment
suffix:semicolon
multiline_comment|/* only if we didn&squot;t get too big */
)brace
)brace
)brace
multiline_comment|/* Also, we need to be sure we don&squot;t queue work ( breakup != 0 )&n;                  if no more sg units for next time */
id|scb-&gt;dcdb.transfer_length
op_assign
id|scb-&gt;data_len
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb-&gt;sg_list
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Non S/G Request */
r_if
c_cond
(paren
(paren
id|scb-&gt;scsi_cmd-&gt;request_bufflen
op_minus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
)paren
OG
id|ha-&gt;max_xfer
)paren
(brace
multiline_comment|/* Further breakup required */
id|scb-&gt;data_len
op_assign
id|ha-&gt;max_xfer
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
op_plus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
)paren
suffix:semicolon
id|scb-&gt;breakup
op_assign
id|bk_save
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;data_len
op_assign
id|scb-&gt;scsi_cmd-&gt;request_bufflen
op_minus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
suffix:semicolon
id|scb-&gt;data_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
op_plus
(paren
id|bk_save
op_star
id|ha-&gt;max_xfer
)paren
)paren
suffix:semicolon
)brace
id|scb-&gt;dcdb.transfer_length
op_assign
id|scb-&gt;data_len
suffix:semicolon
id|scb-&gt;sg_len
op_assign
l_int|0
suffix:semicolon
)brace
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|ips_command_direction
(braket
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;dcdb.cmd_attribute
op_amp
l_int|0x3
)paren
id|scb-&gt;dcdb.transfer_length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;data_len
op_ge
id|IPS_MAX_XFER
)paren
(brace
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TRANSFER64K
suffix:semicolon
id|scb-&gt;dcdb.transfer_length
op_assign
l_int|0
suffix:semicolon
)brace
id|ret
op_assign
id|ips_send_cmd
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|IPS_FAILURE
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
)brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_SUCCESS_IMM
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
)brace
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* end case */
r_return
suffix:semicolon
)brace
macro_line|#ifndef NO_IPS_CMDLINE
)brace
multiline_comment|/* end if passthru */
macro_line|#endif
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
(brace
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|ha-&gt;dcdb_active
(braket
id|scb-&gt;bus
op_minus
l_int|1
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|scb-&gt;target_id
)paren
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/* call back to SCSI layer */
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
op_logical_and
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|IPS_IOCTL_NEW_COMMAND
)paren
id|scb-&gt;scsi_cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
suffix:semicolon
id|ips_freescb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_map_status                                             */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Map ServeRAID error codes to Linux Error Codes                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_map_status
id|ips_map_status
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
comma
id|ips_stat_t
op_star
id|sp
)paren
(brace
r_int
id|errcode
suffix:semicolon
r_int
id|device_error
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_map_status&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;(%s%d) Physical device error (%d %d %d): %x %x, Sense Key: %x, ASC: %x, ASCQ: %x&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;scsi_cmd-&gt;channel
comma
id|scb-&gt;scsi_cmd-&gt;target
comma
id|scb-&gt;scsi_cmd-&gt;lun
comma
id|scb-&gt;basic_status
comma
id|scb-&gt;extended_status
comma
id|scb-&gt;extended_status
op_eq
id|IPS_ERR_CKCOND
ques
c_cond
id|scb-&gt;dcdb.sense_info
(braket
l_int|2
)braket
op_amp
l_int|0xf
suffix:colon
l_int|0
comma
id|scb-&gt;extended_status
op_eq
id|IPS_ERR_CKCOND
ques
c_cond
id|scb-&gt;dcdb.sense_info
(braket
l_int|12
)braket
suffix:colon
l_int|0
comma
id|scb-&gt;extended_status
op_eq
id|IPS_ERR_CKCOND
ques
c_cond
id|scb-&gt;dcdb.sense_info
(braket
l_int|13
)braket
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* default driver error */
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
id|device_error
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|scb-&gt;basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
(brace
r_case
id|IPS_CMD_TIMEOUT
suffix:colon
id|errcode
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_INVAL_OPCO
suffix:colon
r_case
id|IPS_INVAL_CMD_BLK
suffix:colon
r_case
id|IPS_INVAL_PARM_BLK
suffix:colon
r_case
id|IPS_LD_ERROR
suffix:colon
r_case
id|IPS_CMD_CMPLT_WERROR
suffix:colon
r_break
suffix:semicolon
r_case
id|IPS_PHYS_DRV_ERROR
suffix:colon
r_switch
c_cond
(paren
id|scb-&gt;extended_status
)paren
(brace
r_case
id|IPS_ERR_SEL_TO
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
id|errcode
op_assign
id|DID_NO_CONNECT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_ERR_OU_RUN
suffix:colon
r_if
c_cond
(paren
(paren
id|scb-&gt;bus
)paren
op_logical_and
(paren
id|scb-&gt;dcdb.transfer_length
OL
id|scb-&gt;data_len
)paren
)paren
(brace
multiline_comment|/* Underrun - set default to no error */
id|errcode
op_assign
id|DID_OK
suffix:semicolon
multiline_comment|/* Restrict access to physical DASD */
r_if
c_cond
(paren
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_and
(paren
(paren
(paren
(paren
r_char
op_star
)paren
id|scb-&gt;scsi_cmd-&gt;buffer
)paren
(braket
l_int|0
)braket
op_amp
l_int|0x1f
)paren
op_eq
id|TYPE_DISK
)paren
)paren
(brace
multiline_comment|/* underflow -- no error               */
multiline_comment|/* restrict access to physical DASD    */
id|errcode
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_ERR_RECOVERY
suffix:colon
multiline_comment|/* don&squot;t fail recovered errors */
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
id|errcode
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_ERR_HOST_RESET
suffix:colon
r_case
id|IPS_ERR_DEV_RESET
suffix:colon
id|errcode
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPS_ERR_CKCOND
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;bus
)paren
(brace
id|memcpy
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;sense_buffer
comma
id|scb-&gt;dcdb.sense_info
comma
r_sizeof
(paren
id|scb-&gt;scsi_cmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|device_error
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* check condition */
)brace
id|errcode
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch */
)brace
multiline_comment|/* end switch */
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|device_error
op_or
(paren
id|errcode
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_send                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Wrapper for ips_send_cmd                                               */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_send
id|ips_send
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
comma
id|ips_scb_callback
id|callback
)paren
(brace
r_int
id|ret
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_send&quot;
comma
l_int|1
)paren
suffix:semicolon
id|scb-&gt;callback
op_assign
id|callback
suffix:semicolon
id|ret
op_assign
id|ips_send_cmd
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_send_wait                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Send a command to the controller and wait for it to return             */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_send_wait
id|ips_send_wait
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
comma
r_int
id|timeout
comma
r_int
id|intr
)paren
(brace
r_int
id|ret
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_send_wait&quot;
comma
l_int|1
)paren
suffix:semicolon
id|ha-&gt;waitflag
op_assign
id|TRUE
suffix:semicolon
id|ha-&gt;cmd_in_progress
op_assign
id|scb-&gt;cdb
(braket
l_int|0
)braket
suffix:semicolon
id|ret
op_assign
id|ips_send
c_func
(paren
id|ha
comma
id|scb
comma
id|ipsintr_blocking
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
)paren
r_return
(paren
id|ret
)paren
suffix:semicolon
id|ret
op_assign
id|ips_wait
c_func
(paren
id|ha
comma
id|timeout
comma
id|intr
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_send_cmd                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Map SCSI commands to ServeRAID commands for logical drives             */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_send_cmd
id|ips_send_cmd
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
r_int
id|ret
suffix:semicolon
r_char
op_star
id|sp
suffix:semicolon
r_int
id|device_error
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_send_cmd&quot;
comma
l_int|1
)paren
suffix:semicolon
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;scsi_cmd
)paren
(brace
multiline_comment|/* internal command */
r_if
c_cond
(paren
id|scb-&gt;bus
OG
l_int|0
)paren
(brace
multiline_comment|/* ServeRAID commands can&squot;t be issued */
multiline_comment|/* to real devices -- fail them       */
r_if
c_cond
(paren
(paren
id|ha-&gt;waitflag
op_eq
id|TRUE
)paren
op_logical_and
(paren
id|ha-&gt;cmd_in_progress
op_eq
id|scb-&gt;cdb
(braket
l_int|0
)braket
)paren
)paren
(brace
id|ha-&gt;waitflag
op_assign
id|FALSE
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#ifndef NO_IPS_CMDLINE
)brace
r_else
r_if
c_cond
(paren
(paren
id|scb-&gt;bus
op_eq
l_int|0
)paren
op_logical_and
(paren
op_logical_neg
id|ips_is_passthru
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
)paren
)paren
(brace
macro_line|#else
)brace
r_else
r_if
c_cond
(paren
id|scb-&gt;bus
op_eq
l_int|0
)paren
(brace
macro_line|#endif
multiline_comment|/* command to logical bus -- interpret */
id|ret
op_assign
id|IPS_SUCCESS_IMM
suffix:semicolon
r_switch
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|ALLOW_MEDIUM_REMOVAL
suffix:colon
r_case
id|REZERO_UNIT
suffix:colon
r_case
id|ERASE
suffix:colon
r_case
id|WRITE_FILEMARKS
suffix:colon
r_case
id|SPACE
suffix:colon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|START_STOP
suffix:colon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
r_case
id|INQUIRY
suffix:colon
r_if
c_cond
(paren
id|scb-&gt;target_id
op_eq
id|IPS_ADAPTER_ID
)paren
(brace
multiline_comment|/*&n;             * Either we have a TUR&n;             * or we have a SCSI inquiry&n;             */
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|TEST_UNIT_READY
)paren
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
(brace
id|IPS_SCSI_INQ_DATA
id|inquiry
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|inquiry
comma
l_int|0
comma
r_sizeof
(paren
id|IPS_SCSI_INQ_DATA
)paren
)paren
suffix:semicolon
id|inquiry.DeviceType
op_assign
id|IPS_SCSI_INQ_TYPE_PROCESSOR
suffix:semicolon
id|inquiry.DeviceTypeQualifier
op_assign
id|IPS_SCSI_INQ_LU_CONNECTED
suffix:semicolon
id|inquiry.Version
op_assign
id|IPS_SCSI_INQ_REV2
suffix:semicolon
id|inquiry.ResponseDataFormat
op_assign
id|IPS_SCSI_INQ_RD_REV2
suffix:semicolon
id|inquiry.AdditionalLength
op_assign
l_int|31
suffix:semicolon
id|inquiry.Flags
(braket
l_int|0
)braket
op_assign
id|IPS_SCSI_INQ_Address16
suffix:semicolon
id|inquiry.Flags
(braket
l_int|1
)braket
op_assign
id|IPS_SCSI_INQ_WBus16
op_or
id|IPS_SCSI_INQ_Sync
suffix:semicolon
id|strncpy
c_func
(paren
id|inquiry.VendorId
comma
l_string|&quot;IBM     &quot;
comma
l_int|8
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|inquiry.ProductId
comma
l_string|&quot;SERVERAID       &quot;
comma
l_int|16
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|inquiry.ProductRevisionLevel
comma
l_string|&quot;1.00&quot;
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
comma
op_amp
id|inquiry
comma
id|scb-&gt;scsi_cmd-&gt;request_bufflen
)paren
suffix:semicolon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
)brace
)brace
r_else
(brace
id|scb-&gt;cmd.logical_info.op_code
op_assign
id|IPS_CMD_GET_LD_INFO
suffix:semicolon
id|scb-&gt;cmd.logical_info.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.logical_info.buffer_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
op_amp
id|ha-&gt;adapt-&gt;logical_drive_info
)paren
)paren
suffix:semicolon
id|scb-&gt;cmd.logical_info.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.logical_info.reserved2
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|REQUEST_SENSE
suffix:colon
id|ips_reqsen
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;sg_len
)paren
(brace
id|scb-&gt;cmd.basic_io.op_code
op_assign
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
)paren
ques
c_cond
id|IPS_CMD_READ
suffix:colon
id|IPS_CMD_WRITE
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;cmd.basic_io.op_code
op_assign
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
)paren
ques
c_cond
id|IPS_CMD_READ_SG
suffix:colon
id|IPS_CMD_WRITE_SG
suffix:semicolon
)brace
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.log_drv
op_assign
id|scb-&gt;target_id
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_count
op_assign
id|scb-&gt;sg_len
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|scb-&gt;data_busaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;cmd.basic_io.lba
)paren
id|scb-&gt;cmd.basic_io.lba
op_assign
id|cpu_to_le32
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|scb-&gt;cmd.basic_io.lba
)paren
op_plus
id|le16_to_cpu
c_func
(paren
id|scb-&gt;cmd.basic_io.sector_count
)paren
)paren
suffix:semicolon
r_else
id|scb-&gt;cmd.basic_io.lba
op_assign
(paren
(paren
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|3
)braket
)paren
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sector_count
op_assign
id|cpu_to_le16
c_func
(paren
id|scb-&gt;data_len
op_div
id|IPS_BLKSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|scb-&gt;cmd.basic_io.sector_count
)paren
op_eq
l_int|0
)paren
id|scb-&gt;cmd.basic_io.sector_count
op_assign
id|cpu_to_le16
c_func
(paren
l_int|256
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.reserved
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_10
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;sg_len
)paren
(brace
id|scb-&gt;cmd.basic_io.op_code
op_assign
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_10
)paren
ques
c_cond
id|IPS_CMD_READ
suffix:colon
id|IPS_CMD_WRITE
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;cmd.basic_io.op_code
op_assign
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_10
)paren
ques
c_cond
id|IPS_CMD_READ_SG
suffix:colon
id|IPS_CMD_WRITE_SG
suffix:semicolon
)brace
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.log_drv
op_assign
id|scb-&gt;target_id
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_count
op_assign
id|scb-&gt;sg_len
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|scb-&gt;data_busaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;cmd.basic_io.lba
)paren
id|scb-&gt;cmd.basic_io.lba
op_assign
id|cpu_to_le32
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|scb-&gt;cmd.basic_io.lba
)paren
op_plus
id|le16_to_cpu
c_func
(paren
id|scb-&gt;cmd.basic_io.sector_count
)paren
)paren
suffix:semicolon
r_else
id|scb-&gt;cmd.basic_io.lba
op_assign
(paren
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sector_count
op_assign
id|cpu_to_le16
c_func
(paren
id|scb-&gt;data_len
op_div
id|IPS_BLKSIZE
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.reserved
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cpu_to_le16
c_func
(paren
id|scb-&gt;cmd.basic_io.sector_count
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;             * This is a null condition&n;             * we don&squot;t have to do anything&n;             * so just return&n;             */
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RESERVE
suffix:colon
r_case
id|RELEASE
suffix:colon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
id|scb-&gt;cmd.basic_io.op_code
op_assign
id|IPS_CMD_ENQUIRY
suffix:semicolon
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;enq
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
id|scb-&gt;cmd.logical_info.op_code
op_assign
id|IPS_CMD_GET_LD_INFO
suffix:semicolon
id|scb-&gt;cmd.logical_info.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.logical_info.buffer_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
op_amp
id|ha-&gt;adapt-&gt;logical_drive_info
)paren
)paren
suffix:semicolon
id|scb-&gt;cmd.logical_info.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.logical_info.reserved2
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.logical_info.reserved3
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEND_DIAGNOSTIC
suffix:colon
r_case
id|REASSIGN_BLOCKS
suffix:colon
r_case
id|FORMAT_UNIT
suffix:colon
r_case
id|SEEK_10
suffix:colon
r_case
id|VERIFY
suffix:colon
r_case
id|READ_DEFECT_DATA
suffix:colon
r_case
id|READ_BUFFER
suffix:colon
r_case
id|WRITE_BUFFER
suffix:colon
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Set the Return Info to appear like the Command was */
multiline_comment|/* attempted, a Check Condition occurred, and Sense   */
multiline_comment|/* Data indicating an Invalid CDB OpCode is returned. */
id|sp
op_assign
(paren
r_char
op_star
)paren
id|scb-&gt;scsi_cmd-&gt;sense_buffer
suffix:semicolon
id|memset
c_func
(paren
id|sp
comma
l_int|0
comma
r_sizeof
(paren
id|scb-&gt;scsi_cmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|sp
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
multiline_comment|/* Error Code               */
id|sp
(braket
l_int|2
)braket
op_assign
id|ILLEGAL_REQUEST
suffix:semicolon
multiline_comment|/* Sense Key 5 Illegal Req. */
id|sp
(braket
l_int|7
)braket
op_assign
l_int|0x0A
suffix:semicolon
multiline_comment|/* Additional Sense Length  */
id|sp
(braket
l_int|12
)braket
op_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* ASC = Invalid OpCode     */
id|sp
(braket
l_int|13
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* ASCQ                     */
id|device_error
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Indicate Check Condition */
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|device_error
op_or
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch */
)brace
multiline_comment|/* end if */
r_if
c_cond
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
r_return
(paren
id|ret
)paren
suffix:semicolon
multiline_comment|/* setup DCDB */
r_if
c_cond
(paren
id|scb-&gt;bus
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;sg_len
)paren
id|scb-&gt;cmd.dcdb.op_code
op_assign
id|IPS_CMD_DCDB
suffix:semicolon
r_else
id|scb-&gt;cmd.dcdb.op_code
op_assign
id|IPS_CMD_DCDB_SG
suffix:semicolon
multiline_comment|/* If we already know the Device is Not there, no need to attempt a Command   */
multiline_comment|/* This also protects an NT FailOver Controller from getting CDB&squot;s sent to it */
r_if
c_cond
(paren
id|ha-&gt;conf-&gt;dev
(braket
id|scb-&gt;bus
op_minus
l_int|1
)braket
(braket
id|scb-&gt;target_id
)braket
dot
id|ucState
op_eq
l_int|0
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS_IMM
)paren
suffix:semicolon
)brace
id|ha-&gt;dcdb_active
(braket
id|scb-&gt;bus
op_minus
l_int|1
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|scb-&gt;target_id
)paren
suffix:semicolon
id|scb-&gt;cmd.dcdb.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.dcdb.dcdb_address
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
op_amp
id|scb-&gt;dcdb
)paren
)paren
suffix:semicolon
id|scb-&gt;cmd.dcdb.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.dcdb.reserved2
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.dcdb.reserved3
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;dcdb.device_address
op_assign
(paren
(paren
id|scb-&gt;bus
op_minus
l_int|1
)paren
op_lshift
l_int|4
)paren
op_or
id|scb-&gt;target_id
suffix:semicolon
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_DISCONNECT_ALLOWED
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;timeout
)paren
(brace
r_if
c_cond
(paren
id|scb-&gt;timeout
op_le
l_int|10
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TIMEOUT10
suffix:semicolon
r_else
r_if
c_cond
(paren
id|scb-&gt;timeout
op_le
l_int|60
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TIMEOUT60
suffix:semicolon
r_else
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TIMEOUT20M
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|scb-&gt;dcdb.cmd_attribute
op_amp
id|IPS_TIMEOUT20M
)paren
)paren
id|scb-&gt;dcdb.cmd_attribute
op_or_assign
id|IPS_TIMEOUT20M
suffix:semicolon
id|scb-&gt;dcdb.sense_length
op_assign
r_sizeof
(paren
id|scb-&gt;scsi_cmd-&gt;sense_buffer
)paren
suffix:semicolon
id|scb-&gt;dcdb.buffer_pointer
op_assign
id|cpu_to_le32
c_func
(paren
id|scb-&gt;data_busaddr
)paren
suffix:semicolon
id|scb-&gt;dcdb.sg_count
op_assign
id|scb-&gt;sg_len
suffix:semicolon
id|scb-&gt;dcdb.cdb_length
op_assign
id|scb-&gt;scsi_cmd-&gt;cmd_len
suffix:semicolon
id|memcpy
c_func
(paren
id|scb-&gt;dcdb.scsi_cdb
comma
id|scb-&gt;scsi_cmd-&gt;cmnd
comma
id|scb-&gt;scsi_cmd-&gt;cmd_len
)paren
suffix:semicolon
)brace
r_return
(paren
(paren
op_star
id|ha-&gt;func.issue
)paren
(paren
id|ha
comma
id|scb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_chk_status                                             */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Check the status of commands to logical drives                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_chkstatus
id|ips_chkstatus
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|IPS_STATUS
op_star
id|pstatus
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|ips_stat_t
op_star
id|sp
suffix:semicolon
id|u_int8_t
id|basic_status
suffix:semicolon
id|u_int8_t
id|ext_status
suffix:semicolon
r_int
id|errcode
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_chkstatus&quot;
comma
l_int|1
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|pstatus-&gt;fields.command_id
)braket
suffix:semicolon
id|scb-&gt;basic_status
op_assign
id|basic_status
op_assign
id|pstatus-&gt;fields.basic_status
op_amp
id|IPS_BASIC_STATUS_MASK
suffix:semicolon
id|scb-&gt;extended_status
op_assign
id|ext_status
op_assign
id|pstatus-&gt;fields.extended_status
suffix:semicolon
id|sp
op_assign
op_amp
id|ha-&gt;sp
suffix:semicolon
id|sp-&gt;residue_len
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;scb_addr
op_assign
(paren
r_void
op_star
)paren
id|scb
suffix:semicolon
multiline_comment|/* Remove the item from the active queue */
id|ips_removeq_scb
c_func
(paren
op_amp
id|ha-&gt;scb_activelist
comma
id|scb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb-&gt;scsi_cmd
)paren
multiline_comment|/* internal commands are handled in do_ipsintr */
r_return
suffix:semicolon
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;(%s%d) ips_chkstatus: cmd 0x%X id %d (%d %d %d)&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cdb
(braket
l_int|0
)braket
comma
id|scb-&gt;cmd.basic_io.command_id
comma
id|scb-&gt;bus
comma
id|scb-&gt;target_id
comma
id|scb-&gt;lun
)paren
suffix:semicolon
macro_line|#ifndef NO_IPS_CMDLINE
r_if
c_cond
(paren
(paren
id|scb-&gt;scsi_cmd
)paren
op_logical_and
(paren
id|ips_is_passthru
c_func
(paren
id|scb-&gt;scsi_cmd
)paren
)paren
)paren
multiline_comment|/* passthru - just returns the raw result */
r_return
suffix:semicolon
macro_line|#endif
id|errcode
op_assign
id|DID_OK
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
op_eq
id|IPS_CMD_SUCCESS
)paren
op_logical_or
(paren
(paren
id|basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
op_eq
id|IPS_CMD_RECOVERED_ERROR
)paren
)paren
(brace
r_if
c_cond
(paren
id|scb-&gt;bus
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
op_eq
id|IPS_CMD_RECOVERED_ERROR
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Recovered Logical Drive Error OpCode: %x, BSB: %x, ESB: %x&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cmd.basic_io.op_code
comma
id|basic_status
comma
id|ext_status
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|ALLOW_MEDIUM_REMOVAL
suffix:colon
r_case
id|REZERO_UNIT
suffix:colon
r_case
id|ERASE
suffix:colon
r_case
id|WRITE_FILEMARKS
suffix:colon
r_case
id|SPACE
suffix:colon
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|START_STOP
suffix:colon
r_break
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|ips_online
c_func
(paren
id|ha
comma
id|scb
)paren
)paren
(brace
id|errcode
op_assign
id|DID_TIME_OUT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
r_if
c_cond
(paren
id|ips_online
c_func
(paren
id|ha
comma
id|scb
)paren
)paren
(brace
id|ips_inquiry
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
)brace
r_else
(brace
id|errcode
op_assign
id|DID_TIME_OUT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|REQUEST_SENSE
suffix:colon
id|ips_reqsen
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|RESERVE
suffix:colon
r_case
id|RELEASE
suffix:colon
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|ips_online
c_func
(paren
id|ha
comma
id|scb
)paren
op_logical_or
op_logical_neg
id|ips_msense
c_func
(paren
id|ha
comma
id|scb
)paren
)paren
(brace
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
r_if
c_cond
(paren
id|ips_online
c_func
(paren
id|ha
comma
id|scb
)paren
)paren
id|ips_rdcap
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_else
(brace
id|errcode
op_assign
id|DID_TIME_OUT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SEND_DIAGNOSTIC
suffix:colon
r_case
id|REASSIGN_BLOCKS
suffix:colon
r_break
suffix:semicolon
r_case
id|FORMAT_UNIT
suffix:colon
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEEK_10
suffix:colon
r_case
id|VERIFY
suffix:colon
r_case
id|READ_DEFECT_DATA
suffix:colon
r_case
id|READ_BUFFER
suffix:colon
r_case
id|WRITE_BUFFER
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|errcode
op_assign
id|DID_ERROR
suffix:semicolon
)brace
multiline_comment|/* end switch */
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|errcode
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* bus == 0 */
multiline_comment|/* restrict access to physical drives */
r_if
c_cond
(paren
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_and
(paren
(paren
(paren
(paren
r_char
op_star
)paren
id|scb-&gt;scsi_cmd-&gt;buffer
)paren
(braket
l_int|0
)braket
op_amp
l_int|0x1f
)paren
op_eq
id|TYPE_DISK
)paren
)paren
(brace
id|scb-&gt;scsi_cmd-&gt;result
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
)brace
)brace
multiline_comment|/* else */
)brace
r_else
(brace
multiline_comment|/* recovered error / success */
r_if
c_cond
(paren
id|scb-&gt;bus
op_eq
l_int|0
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Unrecovered Logical Drive Error OpCode: %x, BSB: %x, ESB: %x&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cmd.basic_io.op_code
comma
id|basic_status
comma
id|ext_status
)paren
suffix:semicolon
)brace
id|ips_map_status
c_func
(paren
id|ha
comma
id|scb
comma
id|sp
)paren
suffix:semicolon
)brace
multiline_comment|/* else */
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_online                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Determine if a logical drive is online                                 */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_online
id|ips_online
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_online&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;target_id
op_ge
id|IPS_MAX_LD
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|scb-&gt;basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
OG
l_int|1
)paren
(brace
id|memset
c_func
(paren
op_amp
id|ha-&gt;adapt-&gt;logical_drive_info
comma
l_int|0
comma
r_sizeof
(paren
id|ha-&gt;adapt-&gt;logical_drive_info
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;adapt-&gt;logical_drive_info.drive_info
(braket
id|scb-&gt;target_id
)braket
dot
id|state
op_ne
id|IPS_LD_OFFLINE
op_logical_and
id|ha-&gt;adapt-&gt;logical_drive_info.drive_info
(braket
id|scb-&gt;target_id
)braket
dot
id|state
op_ne
id|IPS_LD_FREE
op_logical_and
id|ha-&gt;adapt-&gt;logical_drive_info.drive_info
(braket
id|scb-&gt;target_id
)braket
dot
id|state
op_ne
id|IPS_LD_CRS
op_logical_and
id|ha-&gt;adapt-&gt;logical_drive_info.drive_info
(braket
id|scb-&gt;target_id
)braket
dot
id|state
op_ne
id|IPS_LD_SYS
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_else
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_inquiry                                                */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Simulate an inquiry command to a logical drive                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_inquiry
id|ips_inquiry
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|IPS_SCSI_INQ_DATA
id|inquiry
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_inquiry&quot;
comma
l_int|1
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|inquiry
comma
l_int|0
comma
r_sizeof
(paren
id|IPS_SCSI_INQ_DATA
)paren
)paren
suffix:semicolon
id|inquiry.DeviceType
op_assign
id|IPS_SCSI_INQ_TYPE_DASD
suffix:semicolon
id|inquiry.DeviceTypeQualifier
op_assign
id|IPS_SCSI_INQ_LU_CONNECTED
suffix:semicolon
id|inquiry.Version
op_assign
id|IPS_SCSI_INQ_REV2
suffix:semicolon
id|inquiry.ResponseDataFormat
op_assign
id|IPS_SCSI_INQ_RD_REV2
suffix:semicolon
id|inquiry.AdditionalLength
op_assign
l_int|31
suffix:semicolon
id|inquiry.Flags
(braket
l_int|0
)braket
op_assign
id|IPS_SCSI_INQ_Address16
suffix:semicolon
id|inquiry.Flags
(braket
l_int|1
)braket
op_assign
id|IPS_SCSI_INQ_WBus16
op_or
id|IPS_SCSI_INQ_Sync
suffix:semicolon
id|strncpy
c_func
(paren
id|inquiry.VendorId
comma
l_string|&quot;IBM     &quot;
comma
l_int|8
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|inquiry.ProductId
comma
l_string|&quot;SERVERAID       &quot;
comma
l_int|16
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|inquiry.ProductRevisionLevel
comma
l_string|&quot;1.00&quot;
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
comma
op_amp
id|inquiry
comma
id|scb-&gt;scsi_cmd-&gt;request_bufflen
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_rdcap                                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Simulate a read capacity command to a logical drive                    */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_rdcap
id|ips_rdcap
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|IPS_SCSI_CAPACITY
op_star
id|cap
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_rdcap&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;bufflen
OL
l_int|8
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|cap
op_assign
(paren
id|IPS_SCSI_CAPACITY
op_star
)paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
suffix:semicolon
id|cap-&gt;lba
op_assign
id|cpu_to_be32
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|ha-&gt;adapt-&gt;logical_drive_info.drive_info
(braket
id|scb-&gt;target_id
)braket
dot
id|sector_count
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|cap-&gt;len
op_assign
id|cpu_to_be32
c_func
(paren
(paren
id|u_int32_t
)paren
id|IPS_BLKSIZE
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_msense                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Simulate a mode sense command to a logical drive                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_msense
id|ips_msense
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|u_int16_t
id|heads
suffix:semicolon
id|u_int16_t
id|sectors
suffix:semicolon
id|u_int32_t
id|cylinders
suffix:semicolon
id|IPS_SCSI_MODE_PAGE_DATA
id|mdata
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_msense&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|ha-&gt;enq-&gt;ulDriveSize
(braket
id|scb-&gt;target_id
)braket
)paren
OG
l_int|0x400000
op_logical_and
(paren
id|ha-&gt;enq-&gt;ucMiscFlag
op_amp
l_int|0x8
)paren
op_eq
l_int|0
)paren
(brace
id|heads
op_assign
id|IPS_NORM_HEADS
suffix:semicolon
id|sectors
op_assign
id|IPS_NORM_SECTORS
suffix:semicolon
)brace
r_else
(brace
id|heads
op_assign
id|IPS_COMP_HEADS
suffix:semicolon
id|sectors
op_assign
id|IPS_COMP_SECTORS
suffix:semicolon
)brace
id|cylinders
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|ha-&gt;enq-&gt;ulDriveSize
(braket
id|scb-&gt;target_id
)braket
)paren
op_minus
l_int|1
)paren
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mdata
comma
l_int|0
comma
r_sizeof
(paren
id|IPS_SCSI_MODE_PAGE_DATA
)paren
)paren
suffix:semicolon
id|mdata.hdr.BlockDescLength
op_assign
l_int|8
suffix:semicolon
r_switch
c_cond
(paren
id|scb-&gt;scsi_cmd-&gt;cmnd
(braket
l_int|2
)braket
op_amp
l_int|0x3f
)paren
(brace
r_case
l_int|0x03
suffix:colon
multiline_comment|/* page 3 */
id|mdata.pdata.pg3.PageCode
op_assign
l_int|3
suffix:semicolon
id|mdata.pdata.pg3.PageLength
op_assign
r_sizeof
(paren
id|IPS_SCSI_MODE_PAGE3
)paren
suffix:semicolon
id|mdata.hdr.DataLength
op_assign
l_int|3
op_plus
id|mdata.hdr.BlockDescLength
op_plus
id|mdata.pdata.pg3.PageLength
suffix:semicolon
id|mdata.pdata.pg3.TracksPerZone
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.AltSectorsPerZone
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.AltTracksPerZone
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.AltTracksPerVolume
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.SectorsPerTrack
op_assign
id|cpu_to_be16
c_func
(paren
id|sectors
)paren
suffix:semicolon
id|mdata.pdata.pg3.BytesPerSector
op_assign
id|cpu_to_be16
c_func
(paren
id|IPS_BLKSIZE
)paren
suffix:semicolon
id|mdata.pdata.pg3.Interleave
op_assign
id|cpu_to_be16
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|mdata.pdata.pg3.TrackSkew
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.CylinderSkew
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg3.flags
op_assign
id|IPS_SCSI_MP3_SoftSector
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x4
suffix:colon
id|mdata.pdata.pg4.PageCode
op_assign
l_int|4
suffix:semicolon
id|mdata.pdata.pg4.PageLength
op_assign
r_sizeof
(paren
id|IPS_SCSI_MODE_PAGE4
)paren
suffix:semicolon
id|mdata.hdr.DataLength
op_assign
l_int|3
op_plus
id|mdata.hdr.BlockDescLength
op_plus
id|mdata.pdata.pg4.PageLength
suffix:semicolon
id|mdata.pdata.pg4.CylindersHigh
op_assign
id|cpu_to_be16
c_func
(paren
(paren
id|cylinders
op_rshift
l_int|8
)paren
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|mdata.pdata.pg4.CylindersLow
op_assign
(paren
id|cylinders
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|mdata.pdata.pg4.Heads
op_assign
id|heads
suffix:semicolon
id|mdata.pdata.pg4.WritePrecompHigh
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.WritePrecompLow
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.ReducedWriteCurrentHigh
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.ReducedWriteCurrentLow
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.StepRate
op_assign
id|cpu_to_be16
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|mdata.pdata.pg4.LandingZoneHigh
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.LandingZoneLow
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.flags
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.RotationalOffset
op_assign
l_int|0
suffix:semicolon
id|mdata.pdata.pg4.MediumRotationRate
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* end switch */
id|memcpy
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
comma
op_amp
id|mdata
comma
id|scb-&gt;scsi_cmd-&gt;request_bufflen
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_reqsen                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Simulate a request sense command to a logical drive                    */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_reqsen
id|ips_reqsen
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|IPS_SCSI_REQSEN
id|reqsen
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_reqsen&quot;
comma
l_int|1
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|reqsen
comma
l_int|0
comma
r_sizeof
(paren
id|IPS_SCSI_REQSEN
)paren
)paren
suffix:semicolon
id|reqsen.ResponseCode
op_assign
id|IPS_SCSI_REQSEN_VALID
op_or
id|IPS_SCSI_REQSEN_CURRENT_ERR
suffix:semicolon
id|reqsen.AdditionalLength
op_assign
l_int|10
suffix:semicolon
id|reqsen.AdditionalSenseCode
op_assign
id|IPS_SCSI_REQSEN_NO_SENSE
suffix:semicolon
id|reqsen.AdditionalSenseCodeQual
op_assign
id|IPS_SCSI_REQSEN_NO_SENSE
suffix:semicolon
id|memcpy
c_func
(paren
id|scb-&gt;scsi_cmd-&gt;request_buffer
comma
op_amp
id|reqsen
comma
id|scb-&gt;scsi_cmd-&gt;request_bufflen
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_free                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Free any allocated space for this controller                           */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_free
id|ips_free
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
r_int
id|i
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_free&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;enq
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;enq
)paren
suffix:semicolon
id|ha-&gt;enq
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;conf
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;conf
)paren
suffix:semicolon
id|ha-&gt;conf
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;adapt
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;adapt
)paren
suffix:semicolon
id|ha-&gt;adapt
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;nvram
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;nvram
)paren
suffix:semicolon
id|ha-&gt;nvram
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;subsys
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;subsys
)paren
suffix:semicolon
id|ha-&gt;subsys
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;dummy
)paren
(brace
id|kfree
c_func
(paren
id|ha-&gt;dummy
)paren
suffix:semicolon
id|ha-&gt;dummy
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;ioctl_data
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ha-&gt;ioctl_data
comma
id|ha-&gt;ioctl_order
)paren
suffix:semicolon
id|ha-&gt;ioctl_data
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;ioctl_datasize
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;ioctl_order
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;scbs
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ha-&gt;max_cmds
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;scbs
(braket
id|i
)braket
dot
id|sg_list
)paren
id|kfree
c_func
(paren
id|ha-&gt;scbs
(braket
id|i
)braket
dot
id|sg_list
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ha-&gt;scbs
)paren
suffix:semicolon
id|ha-&gt;scbs
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* end if */
multiline_comment|/* free memory mapped (if applicable) */
r_if
c_cond
(paren
id|ha-&gt;mem_ptr
)paren
(brace
id|iounmap
c_func
(paren
id|ha-&gt;ioremap_ptr
)paren
suffix:semicolon
id|ha-&gt;ioremap_ptr
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;mem_ptr
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,3,17)
r_if
c_cond
(paren
id|ha-&gt;mem_addr
)paren
id|release_mem_region
c_func
(paren
id|ha-&gt;mem_addr
comma
id|ha-&gt;mem_len
)paren
suffix:semicolon
macro_line|#endif
id|ha-&gt;mem_addr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_allocatescbs                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Allocate the command blocks                                            */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_allocatescbs
id|ips_allocatescbs
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_scb_t
op_star
id|scb_p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_allocatescbs&quot;
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Allocate memory for the CCBs */
id|ha-&gt;scbs
op_assign
(paren
id|ips_scb_t
op_star
)paren
id|kmalloc
c_func
(paren
id|ha-&gt;max_cmds
op_star
r_sizeof
(paren
id|ips_scb_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;scbs
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|ha-&gt;scbs
comma
l_int|0
comma
id|ha-&gt;max_cmds
op_star
r_sizeof
(paren
id|ips_scb_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ha-&gt;max_cmds
suffix:semicolon
id|i
op_increment
)paren
(brace
id|scb_p
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* allocate S/G list */
id|scb_p-&gt;sg_list
op_assign
(paren
id|IPS_SG_LIST
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|IPS_SG_LIST
)paren
op_star
id|IPS_MAX_SG
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb_p-&gt;sg_list
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* add to the free list */
r_if
c_cond
(paren
id|i
OL
id|ha-&gt;max_cmds
op_minus
l_int|1
)paren
(brace
id|scb_p-&gt;q_next
op_assign
id|ha-&gt;scb_freelist
suffix:semicolon
id|ha-&gt;scb_freelist
op_assign
id|scb_p
suffix:semicolon
)brace
)brace
multiline_comment|/* success */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_init_scb                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize a CCB to default values                                     */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_init_scb
id|ips_init_scb
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|IPS_SG_LIST
op_star
id|sg_list
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_init_scb&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|sg_list
op_assign
id|scb-&gt;sg_list
suffix:semicolon
multiline_comment|/* zero fill */
id|memset
c_func
(paren
id|scb
comma
l_int|0
comma
r_sizeof
(paren
id|ips_scb_t
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ha-&gt;dummy
comma
l_int|0
comma
r_sizeof
(paren
id|IPS_IO_CMD
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize dummy command bucket */
id|ha-&gt;dummy-&gt;op_code
op_assign
l_int|0xFF
suffix:semicolon
id|ha-&gt;dummy-&gt;ccsar
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;dummy
)paren
)paren
suffix:semicolon
id|ha-&gt;dummy-&gt;command_id
op_assign
id|IPS_MAX_CMDS
suffix:semicolon
multiline_comment|/* set bus address of scb */
id|scb-&gt;scb_busaddr
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|scb
)paren
suffix:semicolon
id|scb-&gt;sg_list
op_assign
id|sg_list
suffix:semicolon
multiline_comment|/* Neptune Fix */
id|scb-&gt;cmd.basic_io.cccr
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u_int32_t
)paren
id|IPS_BIT_ILE
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.ccsar
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;dummy
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_get_scb                                                */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize a CCB to default values                                     */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be callled from within a lock                                 */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
id|ips_scb_t
op_star
DECL|function|ips_getscb
id|ips_getscb
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_getscb&quot;
comma
l_int|1
)paren
suffix:semicolon
id|IPS_SCB_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|scb
op_assign
id|ha-&gt;scb_freelist
)paren
op_eq
l_int|NULL
)paren
(brace
id|IPS_SCB_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|ha-&gt;scb_freelist
op_assign
id|scb-&gt;q_next
suffix:semicolon
id|scb-&gt;q_next
op_assign
l_int|NULL
suffix:semicolon
id|IPS_SCB_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
r_return
(paren
id|scb
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_free_scb                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Return an unused CCB back to the free list                             */
multiline_comment|/*                                                                          */
multiline_comment|/* ASSUMED to be called from within a lock                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_freescb
id|ips_freescb
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_freescb&quot;
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* check to make sure this is not our &quot;special&quot; scb */
r_if
c_cond
(paren
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
OL
(paren
id|ha-&gt;max_cmds
op_minus
l_int|1
)paren
)paren
(brace
id|IPS_SCB_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|scb-&gt;q_next
op_assign
id|ha-&gt;scb_freelist
suffix:semicolon
id|ha-&gt;scb_freelist
op_assign
id|scb
suffix:semicolon
id|IPS_SCB_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_isinit_copperhead                                      */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Reset the controller                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_isinit_copperhead
id|ips_isinit_copperhead
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int8_t
id|scpr
suffix:semicolon
id|u_int8_t
id|isr
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_isinit_copperhead&quot;
comma
l_int|1
)paren
suffix:semicolon
id|isr
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
id|scpr
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_SCPR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|isr
op_amp
id|IPS_BIT_EI
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|scpr
op_amp
id|IPS_BIT_EBM
)paren
op_eq
l_int|0
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_else
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_isinit_copperhead_memio                                */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Reset the controller                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_isinit_copperhead_memio
id|ips_isinit_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int8_t
id|isr
op_assign
l_int|0
suffix:semicolon
id|u_int8_t
id|scpr
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_is_init_copperhead_memio&quot;
comma
l_int|1
)paren
suffix:semicolon
id|isr
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
id|scpr
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_SCPR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|isr
op_amp
id|IPS_BIT_EI
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|scpr
op_amp
id|IPS_BIT_EBM
)paren
op_eq
l_int|0
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_else
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_isinit_morpheus                                        */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Reset the controller                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_isinit_morpheus
id|ips_isinit_morpheus
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int32_t
id|post
suffix:semicolon
id|u_int32_t
id|bits
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_is_init_morpheus&quot;
comma
l_int|1
)paren
suffix:semicolon
id|post
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I960_MSG0
)paren
)paren
suffix:semicolon
id|bits
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I2O_HIR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|post
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bits
op_amp
l_int|0x3
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_else
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_enable_int_copperhead                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*   Turn on interrupts                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_enable_int_copperhead
id|ips_enable_int_copperhead
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_enable_int_copperhead&quot;
comma
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_HISR
comma
id|IPS_BIT_EI
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_enable_int_copperhead_memio                            */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*   Turn on interrupts                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_enable_int_copperhead_memio
id|ips_enable_int_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_enable_int_copperhead_memio&quot;
comma
l_int|1
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|IPS_BIT_EI
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_enable_int_morpheus                                    */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*   Turn on interrupts                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_enable_int_morpheus
id|ips_enable_int_morpheus
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int32_t
id|Oimr
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_enable_int_morpheus&quot;
comma
l_int|1
)paren
suffix:semicolon
id|Oimr
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I960_OIMR
)paren
)paren
suffix:semicolon
id|Oimr
op_and_assign
op_complement
l_int|0x08
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|Oimr
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I960_OIMR
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_init_copperhead                                        */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize a copperhead controller                                     */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_init_copperhead
id|ips_init_copperhead
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int8_t
id|Isr
suffix:semicolon
id|u_int8_t
id|Cbsp
suffix:semicolon
id|u_int8_t
id|PostByte
(braket
id|IPS_MAX_POST_BYTES
)braket
suffix:semicolon
id|u_int8_t
id|ConfigByte
(braket
id|IPS_MAX_CONFIG_BYTES
)braket
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_init_copperhead&quot;
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPS_MAX_POST_BYTES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|45
suffix:semicolon
id|j
op_increment
)paren
(brace
id|Isr
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|IPS_BIT_GHI
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_ge
l_int|45
)paren
multiline_comment|/* error occurred */
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|PostByte
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_ISPR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|Isr
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|PostByte
(braket
l_int|0
)braket
OL
id|IPS_GOOD_POST_STATUS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) reset controller fails (post status %x %x).&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|PostByte
(braket
l_int|0
)braket
comma
id|PostByte
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPS_MAX_CONFIG_BYTES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|240
suffix:semicolon
id|j
op_increment
)paren
(brace
id|Isr
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|IPS_BIT_GHI
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
multiline_comment|/* 1 sec */
)brace
r_if
c_cond
(paren
id|j
op_ge
l_int|240
)paren
multiline_comment|/* error occurred */
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|ConfigByte
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_ISPR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|Isr
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|240
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Cbsp
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_CBSP
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Cbsp
op_amp
id|IPS_BIT_OP
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
l_int|240
)paren
multiline_comment|/* reset failed */
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* setup CCCR */
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|0x1010
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_CCCR
)paren
suffix:semicolon
multiline_comment|/* Enable busmastering */
id|outb
c_func
(paren
id|IPS_BIT_EBM
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_SCPR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
multiline_comment|/* fix for anaconda64 */
id|outl
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_NDAE
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts */
id|outb
c_func
(paren
id|IPS_BIT_EI
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_init_copperhead_memio                                  */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize a copperhead controller with memory mapped I/O              */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_init_copperhead_memio
id|ips_init_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int8_t
id|Isr
op_assign
l_int|0
suffix:semicolon
id|u_int8_t
id|Cbsp
suffix:semicolon
id|u_int8_t
id|PostByte
(braket
id|IPS_MAX_POST_BYTES
)braket
suffix:semicolon
id|u_int8_t
id|ConfigByte
(braket
id|IPS_MAX_CONFIG_BYTES
)braket
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_init_copperhead_memio&quot;
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPS_MAX_POST_BYTES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|45
suffix:semicolon
id|j
op_increment
)paren
(brace
id|Isr
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|IPS_BIT_GHI
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_ge
l_int|45
)paren
multiline_comment|/* error occurred */
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|PostByte
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_ISPR
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|Isr
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|PostByte
(braket
l_int|0
)braket
OL
id|IPS_GOOD_POST_STATUS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) reset controller fails (post status %x %x).&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|PostByte
(braket
l_int|0
)braket
comma
id|PostByte
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPS_MAX_CONFIG_BYTES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|240
suffix:semicolon
id|j
op_increment
)paren
(brace
id|Isr
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|IPS_BIT_GHI
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
multiline_comment|/* 100 msec */
)brace
r_if
c_cond
(paren
id|j
op_ge
l_int|240
)paren
multiline_comment|/* error occurred */
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|ConfigByte
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_ISPR
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|Isr
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|240
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Cbsp
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_CBSP
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Cbsp
op_amp
id|IPS_BIT_OP
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
l_int|240
)paren
multiline_comment|/* error occurred */
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* setup CCCR */
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|0x1010
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_CCCR
)paren
suffix:semicolon
multiline_comment|/* Enable busmastering */
id|writeb
c_func
(paren
id|IPS_BIT_EBM
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_SCPR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
multiline_comment|/* fix for anaconda64 */
id|writel
c_func
(paren
l_int|0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_NDAE
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts */
id|writeb
c_func
(paren
id|IPS_BIT_EI
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
multiline_comment|/* if we get here then everything went OK */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_init_morpheus                                          */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize a morpheus controller                                       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_init_morpheus
id|ips_init_morpheus
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int32_t
id|Post
suffix:semicolon
id|u_int32_t
id|Config
suffix:semicolon
id|u_int32_t
id|Isr
suffix:semicolon
id|u_int32_t
id|Oimr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_init_morpheus&quot;
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Wait up to 45 secs for Post */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|45
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Isr
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I2O_HIR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|IPS_BIT_I960_MSG0I
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
l_int|45
)paren
(brace
multiline_comment|/* error occurred */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) timeout waiting for post.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|Post
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I960_MSG0
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear the interrupt bit */
id|Isr
op_assign
(paren
id|u_int32_t
)paren
id|IPS_BIT_I960_MSG0I
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|Isr
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I2O_HIR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Post
OL
(paren
id|IPS_GOOD_POST_STATUS
op_lshift
l_int|8
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) reset controller fails (post status %x).&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|Post
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Wait up to 240 secs for config bytes */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|240
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Isr
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I2O_HIR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|IPS_BIT_I960_MSG1I
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
multiline_comment|/* 100 msec */
)brace
r_if
c_cond
(paren
id|i
op_ge
l_int|240
)paren
(brace
multiline_comment|/* error occurred */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) timeout waiting for config.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|Config
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I960_MSG1
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt bit */
id|Isr
op_assign
(paren
id|u_int32_t
)paren
id|IPS_BIT_I960_MSG1I
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|Isr
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I2O_HIR
)paren
suffix:semicolon
multiline_comment|/* Turn on the interrupts */
id|Oimr
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I960_OIMR
)paren
)paren
suffix:semicolon
id|Oimr
op_and_assign
op_complement
l_int|0x8
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|Oimr
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I960_OIMR
)paren
suffix:semicolon
multiline_comment|/* if we get here then everything went OK */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_reset_copperhead                                       */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Reset the controller                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_reset_copperhead
id|ips_reset_copperhead
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
r_int
id|reset_counter
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_reset_copperhead&quot;
comma
l_int|1
)paren
suffix:semicolon
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) ips_reset_copperhead: io addr: %x, irq: %d&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|ha-&gt;io_addr
comma
id|ha-&gt;irq
)paren
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|reset_counter
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|reset_counter
OL
l_int|2
)paren
(brace
id|reset_counter
op_increment
suffix:semicolon
id|outb
c_func
(paren
id|IPS_BIT_RST
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_SCPR
)paren
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_SCPR
)paren
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|ha-&gt;func.init
)paren
(paren
id|ha
)paren
)paren
r_break
suffix:semicolon
r_else
r_if
c_cond
(paren
id|reset_counter
op_ge
l_int|2
)paren
(brace
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_reset_copperhead_memio                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Reset the controller                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_reset_copperhead_memio
id|ips_reset_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
r_int
id|reset_counter
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_reset_copperhead_memio&quot;
comma
l_int|1
)paren
suffix:semicolon
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) ips_reset_copperhead_memio: mem addr: %x, irq: %d&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|ha-&gt;mem_addr
comma
id|ha-&gt;irq
)paren
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|reset_counter
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|reset_counter
OL
l_int|2
)paren
(brace
id|reset_counter
op_increment
suffix:semicolon
id|writeb
c_func
(paren
id|IPS_BIT_RST
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_SCPR
)paren
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_SCPR
)paren
suffix:semicolon
id|MDELAY
c_func
(paren
id|IPS_ONE_SEC
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|ha-&gt;func.init
)paren
(paren
id|ha
)paren
)paren
r_break
suffix:semicolon
r_else
r_if
c_cond
(paren
id|reset_counter
op_ge
l_int|2
)paren
(brace
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_reset_morpheus                                         */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Reset the controller                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_reset_morpheus
id|ips_reset_morpheus
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
r_int
id|reset_counter
suffix:semicolon
id|u_int8_t
id|junk
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_reset_morpheus&quot;
comma
l_int|1
)paren
suffix:semicolon
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) ips_reset_morpheus: mem addr: %x, irq: %d&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|ha-&gt;mem_addr
comma
id|ha-&gt;irq
)paren
suffix:semicolon
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|reset_counter
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|reset_counter
OL
l_int|2
)paren
(brace
id|reset_counter
op_increment
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|0x80000000
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I960_IDR
)paren
suffix:semicolon
multiline_comment|/* Delay for 5 sec */
id|MDELAY
c_func
(paren
l_int|5
op_star
id|IPS_ONE_SEC
)paren
suffix:semicolon
multiline_comment|/* Do a PCI config read to wait for adapter */
id|pci_read_config_byte
c_func
(paren
id|ha-&gt;pcidev
comma
l_int|4
comma
op_amp
id|junk
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|ha-&gt;func.init
)paren
(paren
id|ha
)paren
)paren
r_break
suffix:semicolon
r_else
r_if
c_cond
(paren
id|reset_counter
op_ge
l_int|2
)paren
(brace
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_statinit                                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize the status queues on the controller                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_statinit
id|ips_statinit
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int32_t
id|phys_status_start
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_statinit&quot;
comma
l_int|1
)paren
suffix:semicolon
id|ha-&gt;adapt-&gt;p_status_start
op_assign
id|ha-&gt;adapt-&gt;status
suffix:semicolon
id|ha-&gt;adapt-&gt;p_status_end
op_assign
id|ha-&gt;adapt-&gt;status
op_plus
id|IPS_MAX_CMDS
suffix:semicolon
id|ha-&gt;adapt-&gt;p_status_tail
op_assign
id|ha-&gt;adapt-&gt;status
suffix:semicolon
id|phys_status_start
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;adapt-&gt;status
)paren
suffix:semicolon
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|phys_status_start
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_SQSR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|phys_status_start
op_plus
id|IPS_STATUS_Q_SIZE
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_SQER
)paren
suffix:semicolon
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|phys_status_start
op_plus
id|IPS_STATUS_SIZE
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_SQHR
)paren
suffix:semicolon
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|phys_status_start
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_SQTR
)paren
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_start
op_assign
id|phys_status_start
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_tail
op_assign
id|phys_status_start
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_statinit_memio                                         */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Initialize the status queues on the controller                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_statinit_memio
id|ips_statinit_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int32_t
id|phys_status_start
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_statinit_memio&quot;
comma
l_int|1
)paren
suffix:semicolon
id|ha-&gt;adapt-&gt;p_status_start
op_assign
id|ha-&gt;adapt-&gt;status
suffix:semicolon
id|ha-&gt;adapt-&gt;p_status_end
op_assign
id|ha-&gt;adapt-&gt;status
op_plus
id|IPS_MAX_CMDS
suffix:semicolon
id|ha-&gt;adapt-&gt;p_status_tail
op_assign
id|ha-&gt;adapt-&gt;status
suffix:semicolon
id|phys_status_start
op_assign
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;adapt-&gt;status
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|phys_status_start
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_SQSR
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|phys_status_start
op_plus
id|IPS_STATUS_Q_SIZE
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_SQER
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|phys_status_start
op_plus
id|IPS_STATUS_SIZE
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_SQHR
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|phys_status_start
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_SQTR
)paren
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_start
op_assign
id|phys_status_start
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_tail
op_assign
id|phys_status_start
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_statupd_copperhead                                     */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove an element from the status queue                                */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
id|u_int32_t
DECL|function|ips_statupd_copperhead
id|ips_statupd_copperhead
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_statupd_copperhead&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;adapt-&gt;p_status_tail
op_ne
id|ha-&gt;adapt-&gt;p_status_end
)paren
(brace
id|ha-&gt;adapt-&gt;p_status_tail
op_increment
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_tail
op_add_assign
r_sizeof
(paren
id|IPS_STATUS
)paren
suffix:semicolon
)brace
r_else
(brace
id|ha-&gt;adapt-&gt;p_status_tail
op_assign
id|ha-&gt;adapt-&gt;p_status_start
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_tail
op_assign
id|ha-&gt;adapt-&gt;hw_status_start
suffix:semicolon
)brace
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|ha-&gt;adapt-&gt;hw_status_tail
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_SQTR
)paren
suffix:semicolon
r_return
(paren
id|ha-&gt;adapt-&gt;p_status_tail-&gt;value
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_statupd_copperhead_memio                               */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove an element from the status queue                                */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
id|u_int32_t
DECL|function|ips_statupd_copperhead_memio
id|ips_statupd_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_statupd_copperhead_memio&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;adapt-&gt;p_status_tail
op_ne
id|ha-&gt;adapt-&gt;p_status_end
)paren
(brace
id|ha-&gt;adapt-&gt;p_status_tail
op_increment
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_tail
op_add_assign
r_sizeof
(paren
id|IPS_STATUS
)paren
suffix:semicolon
)brace
r_else
(brace
id|ha-&gt;adapt-&gt;p_status_tail
op_assign
id|ha-&gt;adapt-&gt;p_status_start
suffix:semicolon
id|ha-&gt;adapt-&gt;hw_status_tail
op_assign
id|ha-&gt;adapt-&gt;hw_status_start
suffix:semicolon
)brace
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|ha-&gt;adapt-&gt;hw_status_tail
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_SQTR
)paren
suffix:semicolon
r_return
(paren
id|ha-&gt;adapt-&gt;p_status_tail-&gt;value
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_statupd_morpheus                                       */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Remove an element from the status queue                                */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
id|u_int32_t
DECL|function|ips_statupd_morpheus
id|ips_statupd_morpheus
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int32_t
id|val
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_statupd_morpheus&quot;
comma
l_int|1
)paren
suffix:semicolon
id|val
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I2O_OUTMSGQ
)paren
)paren
suffix:semicolon
r_return
(paren
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_issue_copperhead                                       */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Send a command down to the controller                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_issue_copperhead
id|ips_issue_copperhead
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|u_int32_t
id|TimeOut
suffix:semicolon
id|u_int32_t
id|val
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_issue_copperhead&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;(%s%d) ips_issue: cmd 0x%X id %d (%d %d %d)&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cdb
(braket
l_int|0
)braket
comma
id|scb-&gt;cmd.basic_io.command_id
comma
id|scb-&gt;bus
comma
id|scb-&gt;target_id
comma
id|scb-&gt;lun
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
id|KERN_NOTICE
l_string|&quot;(%s%d) ips_issue: logical cmd id %d&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cmd.basic_io.command_id
)paren
suffix:semicolon
)brace
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|TimeOut
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|val
op_assign
id|le32_to_cpu
c_func
(paren
id|inl
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_CCCR
)paren
)paren
)paren
op_amp
id|IPS_BIT_SEM
)paren
(brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|TimeOut
op_ge
id|IPS_SEM_TIMEOUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|IPS_BIT_START_STOP
)paren
)paren
r_break
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) ips_issue val [0x%x].&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|val
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) ips_issue semaphore chk timeout.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/* end if */
)brace
multiline_comment|/* end while */
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|scb-&gt;scb_busaddr
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_CCSAR
)paren
suffix:semicolon
id|outw
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|IPS_BIT_START_CMD
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_CCCR
)paren
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_issue_copperhead_memio                                 */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Send a command down to the controller                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_issue_copperhead_memio
id|ips_issue_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
id|u_int32_t
id|TimeOut
suffix:semicolon
id|u_int32_t
id|val
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_issue_copperhead_memio&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;(%s%d) ips_issue: cmd 0x%X id %d (%d %d %d)&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cdb
(braket
l_int|0
)braket
comma
id|scb-&gt;cmd.basic_io.command_id
comma
id|scb-&gt;bus
comma
id|scb-&gt;target_id
comma
id|scb-&gt;lun
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;(%s%d) ips_issue: logical cmd id %d&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cmd.basic_io.command_id
)paren
suffix:semicolon
)brace
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|TimeOut
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|val
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_CCCR
)paren
)paren
)paren
op_amp
id|IPS_BIT_SEM
)paren
(brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|TimeOut
op_ge
id|IPS_SEM_TIMEOUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|IPS_BIT_START_STOP
)paren
)paren
r_break
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) ips_issue val [0x%x].&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|val
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) ips_issue semaphore chk timeout.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
id|IPS_FAILURE
)paren
suffix:semicolon
)brace
multiline_comment|/* end if */
)brace
multiline_comment|/* end while */
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|scb-&gt;scb_busaddr
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_CCSAR
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|IPS_BIT_START_CMD
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_CCCR
)paren
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_issue_i2o                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Send a command down to the controller                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_issue_i2o
id|ips_issue_i2o
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_issue_i2o&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;(%s%d) ips_issue: cmd 0x%X id %d (%d %d %d)&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cdb
(braket
l_int|0
)braket
comma
id|scb-&gt;cmd.basic_io.command_id
comma
id|scb-&gt;bus
comma
id|scb-&gt;target_id
comma
id|scb-&gt;lun
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;(%s%d) ips_issue: logical cmd id %d&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cmd.basic_io.command_id
)paren
suffix:semicolon
)brace
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|scb-&gt;scb_busaddr
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_I2O_INMSGQ
)paren
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_issue_i2o_memio                                        */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Send a command down to the controller                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_issue_i2o_memio
id|ips_issue_i2o_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
)paren
(brace
r_int
r_int
id|cpu_flags
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_issue_i2o_memio&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scb-&gt;scsi_cmd
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;(%s%d) ips_issue: cmd 0x%X id %d (%d %d %d)&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cdb
(braket
l_int|0
)braket
comma
id|scb-&gt;cmd.basic_io.command_id
comma
id|scb-&gt;bus
comma
id|scb-&gt;target_id
comma
id|scb-&gt;lun
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;(%s%d) ips_issue: logical cmd id %d&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|scb-&gt;cmd.basic_io.command_id
)paren
suffix:semicolon
)brace
id|IPS_HA_LOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|scb-&gt;scb_busaddr
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I2O_INMSGQ
)paren
suffix:semicolon
id|IPS_HA_UNLOCK
c_func
(paren
id|cpu_flags
)paren
suffix:semicolon
r_return
(paren
id|IPS_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_isintr_copperhead                                      */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Test to see if an interrupt is for us                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_isintr_copperhead
id|ips_isintr_copperhead
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int8_t
id|Isr
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_isintr_copperhead&quot;
comma
l_int|2
)paren
suffix:semicolon
id|Isr
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_eq
l_int|0xFF
)paren
multiline_comment|/* ?!?! Nothing really there */
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|IPS_BIT_SCE
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Isr
op_amp
(paren
id|IPS_BIT_SQO
op_or
id|IPS_BIT_GHI
)paren
)paren
(brace
multiline_comment|/* status queue overflow or GHI */
multiline_comment|/* just clear the interrupt */
id|outb
c_func
(paren
id|Isr
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_isintr_copperhead_memio                                */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Test to see if an interrupt is for us                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_isintr_copperhead_memio
id|ips_isintr_copperhead_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int8_t
id|Isr
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_isintr_memio&quot;
comma
l_int|2
)paren
suffix:semicolon
id|Isr
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_eq
l_int|0xFF
)paren
multiline_comment|/* ?!?! Nothing really there */
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|IPS_BIT_SCE
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Isr
op_amp
(paren
id|IPS_BIT_SQO
op_or
id|IPS_BIT_GHI
)paren
)paren
(brace
multiline_comment|/* status queue overflow or GHI */
multiline_comment|/* just clear the interrupt */
id|writeb
c_func
(paren
id|Isr
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_HISR
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_isintr_morpheus                                        */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Test to see if an interrupt is for us                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_isintr_morpheus
id|ips_isintr_morpheus
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
id|u_int32_t
id|Isr
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_isintr_morpheus&quot;
comma
l_int|2
)paren
suffix:semicolon
id|Isr
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_I2O_HIR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Isr
op_amp
id|IPS_BIT_I2O_OPQI
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_else
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_wait                                                   */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Wait for a command to complete                                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_wait
id|ips_wait
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|time
comma
r_int
id|intr
)paren
(brace
r_int
id|ret
suffix:semicolon
id|u_int8_t
id|done
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_wait&quot;
comma
l_int|1
)paren
suffix:semicolon
id|ret
op_assign
id|IPS_FAILURE
suffix:semicolon
id|done
op_assign
id|FALSE
suffix:semicolon
id|time
op_mul_assign
id|IPS_ONE_SEC
suffix:semicolon
multiline_comment|/* convert seconds to milliseconds */
r_while
c_loop
(paren
(paren
id|time
OG
l_int|0
)paren
op_logical_and
(paren
op_logical_neg
id|done
)paren
)paren
(brace
r_if
c_cond
(paren
id|intr
op_eq
id|IPS_INTR_ON
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;waitflag
op_eq
id|FALSE
)paren
(brace
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
id|done
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|intr
op_eq
id|IPS_INTR_IORL
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;waitflag
op_eq
id|FALSE
)paren
(brace
multiline_comment|/*&n;             * controller generated an interrupt to&n;             * acknowledge completion of the command&n;             * and ips_intr() has serviced the interrupt.&n;             */
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
id|done
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;          * NOTE: we already have the io_request_lock so&n;          * even if we get an interrupt it won&squot;t get serviced&n;          * until after we finish.&n;          */
r_while
c_loop
(paren
id|test_and_set_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
)paren
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
(paren
op_star
id|ha-&gt;func.intr
)paren
(paren
id|ha
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|intr
op_eq
id|IPS_INTR_HAL
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|ips_sh
(braket
id|ha-&gt;host_num
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;waitflag
op_eq
id|FALSE
)paren
(brace
multiline_comment|/*&n;             * controller generated an interrupt to&n;             * acknowledge completion of the command&n;             * and ips_intr() has serviced the interrupt.&n;             */
id|ret
op_assign
id|IPS_SUCCESS
suffix:semicolon
id|done
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;          * NOTE: since we were not called with the iorequest lock&n;          * we must obtain it before we can call the interrupt handler.&n;          * We were called under the HA lock so we can assume that interrupts&n;          * are masked.&n;          */
id|spin_lock
c_func
(paren
op_amp
id|host-&gt;host_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|test_and_set_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
)paren
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
(paren
op_star
id|ha-&gt;func.intr
)paren
(paren
id|ha
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|IPS_IN_INTR
comma
op_amp
id|ha-&gt;flags
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|host-&gt;host_lock
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* 1 milisecond */
id|time
op_decrement
suffix:semicolon
)brace
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_write_driver_status                                    */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Write OS/Driver version to Page 5 of the nvram on the controller       */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_write_driver_status
id|ips_write_driver_status
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|intr
)paren
(brace
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_write_driver_status&quot;
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ips_readwrite_page5
c_func
(paren
id|ha
comma
id|FALSE
comma
id|intr
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to read NVRAM page 5.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* check to make sure the page has a valid */
multiline_comment|/* signature */
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|ha-&gt;nvram-&gt;signature
)paren
op_ne
id|IPS_NVRAM_P5_SIG
)paren
(brace
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) NVRAM page 5 has an invalid signature: %X.&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|ha-&gt;nvram-&gt;signature
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|DEBUG_VAR
c_func
(paren
l_int|2
comma
l_string|&quot;(%s%d) Ad Type: %d, Ad Slot: %d, BIOS: %c%c%c%c %c%c%c%c.&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
comma
id|le16_to_cpu
c_func
(paren
id|ha-&gt;nvram-&gt;adapter_type
)paren
comma
id|ha-&gt;nvram-&gt;adapter_slot
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|0
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|1
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|2
)braket
comma
id|ha-&gt;nvram-&gt;bios_high
(braket
l_int|3
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|0
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|1
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|2
)braket
comma
id|ha-&gt;nvram-&gt;bios_low
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|ips_get_bios_version
c_func
(paren
id|ha
comma
id|intr
)paren
suffix:semicolon
multiline_comment|/* change values (as needed) */
id|ha-&gt;nvram-&gt;operating_system
op_assign
id|IPS_OS_LINUX
suffix:semicolon
id|ha-&gt;nvram-&gt;adapter_type
op_assign
id|ha-&gt;ad_type
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_char
op_star
)paren
id|ha-&gt;nvram-&gt;driver_high
comma
id|IPS_VERSION_HIGH
comma
l_int|4
)paren
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_char
op_star
)paren
id|ha-&gt;nvram-&gt;driver_low
comma
id|IPS_VERSION_LOW
comma
l_int|4
)paren
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_char
op_star
)paren
id|ha-&gt;nvram-&gt;bios_high
comma
id|ha-&gt;bios_version
comma
l_int|4
)paren
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_char
op_star
)paren
id|ha-&gt;nvram-&gt;bios_low
comma
id|ha-&gt;bios_version
op_plus
l_int|4
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* now update the page */
r_if
c_cond
(paren
op_logical_neg
id|ips_readwrite_page5
c_func
(paren
id|ha
comma
id|TRUE
comma
id|intr
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(%s%d) unable to write NVRAM page 5.&bslash;n&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* IF NVRAM Page 5 is OK, Use it for Slot Number Info Because Linux Doesn&squot;t Do Slots */
id|ha-&gt;slot_num
op_assign
id|ha-&gt;nvram-&gt;adapter_slot
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_read_adapter_status                                    */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Do an Inquiry command to the adapter                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_read_adapter_status
id|ips_read_adapter_status
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|intr
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_read_adapter_status&quot;
comma
l_int|1
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPS_CMD_ENQUIRY
suffix:semicolon
id|scb-&gt;cmd.basic_io.op_code
op_assign
id|IPS_CMD_ENQUIRY
suffix:semicolon
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_count
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;enq
)paren
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.lba
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.sector_count
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.log_drv
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.reserved
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* send command */
r_if
c_cond
(paren
(paren
(paren
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
comma
id|intr
)paren
)paren
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
op_logical_or
(paren
(paren
id|scb-&gt;basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
OG
l_int|1
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_read_subsystem_parameters                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Read subsystem parameters from the adapter                             */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_read_subsystem_parameters
id|ips_read_subsystem_parameters
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|intr
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_read_subsystem_parameters&quot;
comma
l_int|1
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPS_CMD_GET_SUBSYS
suffix:semicolon
id|scb-&gt;cmd.basic_io.op_code
op_assign
id|IPS_CMD_GET_SUBSYS
suffix:semicolon
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_count
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;subsys
)paren
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.lba
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.sector_count
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.log_drv
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.basic_io.reserved
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* send command */
r_if
c_cond
(paren
(paren
(paren
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
comma
id|intr
)paren
)paren
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
op_logical_or
(paren
(paren
id|scb-&gt;basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
OG
l_int|1
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_read_config                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Read the configuration on the adapter                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_read_config
id|ips_read_config
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|intr
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_read_config&quot;
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set defaults for initiator IDs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|ha-&gt;conf-&gt;init_id
(braket
id|i
)braket
op_assign
l_int|7
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPS_CMD_READ_CONF
suffix:semicolon
id|scb-&gt;cmd.basic_io.op_code
op_assign
id|IPS_CMD_READ_CONF
suffix:semicolon
id|scb-&gt;cmd.basic_io.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.basic_io.sg_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;conf
)paren
)paren
suffix:semicolon
multiline_comment|/* send command */
r_if
c_cond
(paren
(paren
(paren
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
comma
id|intr
)paren
)paren
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
op_logical_or
(paren
(paren
id|scb-&gt;basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
OG
l_int|1
)paren
)paren
(brace
id|memset
c_func
(paren
id|ha-&gt;conf
comma
l_int|0
comma
r_sizeof
(paren
id|IPS_CONF
)paren
)paren
suffix:semicolon
multiline_comment|/* reset initiator IDs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|ha-&gt;conf-&gt;init_id
(braket
id|i
)braket
op_assign
l_int|7
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_readwrite_page5                                        */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Read nvram page 5 from the adapter                                     */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_readwrite_page5
id|ips_readwrite_page5
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|write
comma
r_int
id|intr
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_readwrite_page5&quot;
comma
l_int|1
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPS_CMD_RW_NVRAM_PAGE
suffix:semicolon
id|scb-&gt;cmd.nvram.op_code
op_assign
id|IPS_CMD_RW_NVRAM_PAGE
suffix:semicolon
id|scb-&gt;cmd.nvram.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.nvram.page
op_assign
l_int|5
suffix:semicolon
id|scb-&gt;cmd.nvram.write
op_assign
id|write
suffix:semicolon
id|scb-&gt;cmd.nvram.buffer_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|VIRT_TO_BUS
c_func
(paren
id|ha-&gt;nvram
)paren
)paren
suffix:semicolon
id|scb-&gt;cmd.nvram.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.nvram.reserved2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* issue the command */
r_if
c_cond
(paren
(paren
(paren
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
comma
id|intr
)paren
)paren
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
op_logical_or
(paren
(paren
id|scb-&gt;basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
OG
l_int|1
)paren
)paren
(brace
id|memset
c_func
(paren
id|ha-&gt;nvram
comma
l_int|0
comma
r_sizeof
(paren
id|IPS_NVRAM_P5
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_clear_adapter                                          */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   Clear the stripe lock tables                                           */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_clear_adapter
id|ips_clear_adapter
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|intr
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_clear_adapter&quot;
comma
l_int|1
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_reset_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPS_CMD_CONFIG_SYNC
suffix:semicolon
id|scb-&gt;cmd.config_sync.op_code
op_assign
id|IPS_CMD_CONFIG_SYNC
suffix:semicolon
id|scb-&gt;cmd.config_sync.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.config_sync.channel
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.config_sync.source_target
op_assign
id|IPS_POCL
suffix:semicolon
id|scb-&gt;cmd.config_sync.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.config_sync.reserved2
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.config_sync.reserved3
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* issue command */
r_if
c_cond
(paren
(paren
(paren
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_reset_timeout
comma
id|intr
)paren
)paren
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
op_logical_or
(paren
(paren
id|scb-&gt;basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
OG
l_int|1
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* send unlock stripe command */
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPS_CMD_ERROR_TABLE
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_reset_timeout
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.op_code
op_assign
id|IPS_CMD_ERROR_TABLE
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.log_drv
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.control
op_assign
id|IPS_CSL
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.reserved
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.reserved2
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.unlock_stripe.reserved3
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* issue command */
r_if
c_cond
(paren
(paren
(paren
id|ret
op_assign
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
comma
id|intr
)paren
)paren
op_eq
id|IPS_FAILURE
)paren
op_logical_or
(paren
id|ret
op_eq
id|IPS_SUCCESS_IMM
)paren
op_logical_or
(paren
(paren
id|scb-&gt;basic_status
op_amp
id|IPS_GSC_STATUS_MASK
)paren
OG
l_int|1
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_ffdc_reset                                             */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   FFDC: write reset info                                                 */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_ffdc_reset
id|ips_ffdc_reset
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|intr
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_ffdc_reset&quot;
comma
l_int|1
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPS_CMD_FFDC
suffix:semicolon
id|scb-&gt;cmd.ffdc.op_code
op_assign
id|IPS_CMD_FFDC
suffix:semicolon
id|scb-&gt;cmd.ffdc.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.ffdc.reset_count
op_assign
id|ha-&gt;reset_count
suffix:semicolon
id|scb-&gt;cmd.ffdc.reset_type
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* convert time to what the card wants */
id|ips_fix_ffdc_time
c_func
(paren
id|ha
comma
id|scb
comma
id|ha-&gt;last_ffdc
)paren
suffix:semicolon
multiline_comment|/* issue command */
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
comma
id|intr
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_ffdc_time                                              */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*                                                                          */
multiline_comment|/*   FFDC: write time info                                                  */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_ffdc_time
id|ips_ffdc_time
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_int
id|intr
)paren
(brace
id|ips_scb_t
op_star
id|scb
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_ffdc_time&quot;
comma
l_int|1
)paren
suffix:semicolon
id|DEBUG_VAR
c_func
(paren
l_int|1
comma
l_string|&quot;(%s%d) Sending time update.&quot;
comma
id|ips_name
comma
id|ha-&gt;host_num
)paren
suffix:semicolon
id|scb
op_assign
op_amp
id|ha-&gt;scbs
(braket
id|ha-&gt;max_cmds
op_minus
l_int|1
)braket
suffix:semicolon
id|ips_init_scb
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;timeout
op_assign
id|ips_cmd_timeout
suffix:semicolon
id|scb-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|IPS_CMD_FFDC
suffix:semicolon
id|scb-&gt;cmd.ffdc.op_code
op_assign
id|IPS_CMD_FFDC
suffix:semicolon
id|scb-&gt;cmd.ffdc.command_id
op_assign
id|IPS_COMMAND_ID
c_func
(paren
id|ha
comma
id|scb
)paren
suffix:semicolon
id|scb-&gt;cmd.ffdc.reset_count
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;cmd.ffdc.reset_type
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* convert time to what the card wants */
id|ips_fix_ffdc_time
c_func
(paren
id|ha
comma
id|scb
comma
id|ha-&gt;last_ffdc
)paren
suffix:semicolon
multiline_comment|/* issue command */
id|ips_send_wait
c_func
(paren
id|ha
comma
id|scb
comma
id|ips_cmd_timeout
comma
id|intr
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_fix_ffdc_time                                          */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*   Adjust time_t to what the card wants                                   */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_void
DECL|function|ips_fix_ffdc_time
id|ips_fix_ffdc_time
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
id|ips_scb_t
op_star
id|scb
comma
id|time_t
id|current_time
)paren
(brace
r_int
id|days
suffix:semicolon
r_int
id|rem
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|year
suffix:semicolon
r_int
id|yleap
suffix:semicolon
r_int
id|year_lengths
(braket
l_int|2
)braket
op_assign
(brace
id|IPS_DAYS_NORMAL_YEAR
comma
id|IPS_DAYS_LEAP_YEAR
)brace
suffix:semicolon
r_int
id|month_lengths
(braket
l_int|12
)braket
(braket
l_int|2
)braket
op_assign
(brace
(brace
l_int|31
comma
l_int|31
)brace
comma
(brace
l_int|28
comma
l_int|29
)brace
comma
(brace
l_int|31
comma
l_int|31
)brace
comma
(brace
l_int|30
comma
l_int|30
)brace
comma
(brace
l_int|31
comma
l_int|31
)brace
comma
(brace
l_int|30
comma
l_int|30
)brace
comma
(brace
l_int|31
comma
l_int|31
)brace
comma
(brace
l_int|31
comma
l_int|31
)brace
comma
(brace
l_int|30
comma
l_int|30
)brace
comma
(brace
l_int|31
comma
l_int|31
)brace
comma
(brace
l_int|30
comma
l_int|30
)brace
comma
(brace
l_int|31
comma
l_int|31
)brace
)brace
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_fix_ffdc_time&quot;
comma
l_int|1
)paren
suffix:semicolon
id|days
op_assign
id|current_time
op_div
id|IPS_SECS_DAY
suffix:semicolon
id|rem
op_assign
id|current_time
op_mod
id|IPS_SECS_DAY
suffix:semicolon
id|scb-&gt;cmd.ffdc.hour
op_assign
(paren
id|rem
op_div
id|IPS_SECS_HOUR
)paren
suffix:semicolon
id|rem
op_assign
id|rem
op_mod
id|IPS_SECS_HOUR
suffix:semicolon
id|scb-&gt;cmd.ffdc.minute
op_assign
(paren
id|rem
op_div
id|IPS_SECS_MIN
)paren
suffix:semicolon
id|scb-&gt;cmd.ffdc.second
op_assign
(paren
id|rem
op_mod
id|IPS_SECS_MIN
)paren
suffix:semicolon
id|year
op_assign
id|IPS_EPOCH_YEAR
suffix:semicolon
r_while
c_loop
(paren
id|days
OL
l_int|0
op_logical_or
id|days
op_ge
id|year_lengths
(braket
id|yleap
op_assign
id|IPS_IS_LEAP_YEAR
c_func
(paren
id|year
)paren
)braket
)paren
(brace
r_int
id|newy
suffix:semicolon
id|newy
op_assign
id|year
op_plus
(paren
id|days
op_div
id|IPS_DAYS_NORMAL_YEAR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|days
OL
l_int|0
)paren
op_decrement
id|newy
suffix:semicolon
id|days
op_sub_assign
(paren
id|newy
op_minus
id|year
)paren
op_star
id|IPS_DAYS_NORMAL_YEAR
op_plus
id|IPS_NUM_LEAP_YEARS_THROUGH
c_func
(paren
id|newy
op_minus
l_int|1
)paren
op_minus
id|IPS_NUM_LEAP_YEARS_THROUGH
c_func
(paren
id|year
op_minus
l_int|1
)paren
suffix:semicolon
id|year
op_assign
id|newy
suffix:semicolon
)brace
id|scb-&gt;cmd.ffdc.yearH
op_assign
id|year
op_div
l_int|100
suffix:semicolon
id|scb-&gt;cmd.ffdc.yearL
op_assign
id|year
op_mod
l_int|100
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|days
op_ge
id|month_lengths
(braket
id|i
)braket
(braket
id|yleap
)braket
suffix:semicolon
op_increment
id|i
)paren
id|days
op_sub_assign
id|month_lengths
(braket
id|i
)braket
(braket
id|yleap
)braket
suffix:semicolon
id|scb-&gt;cmd.ffdc.month
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
id|scb-&gt;cmd.ffdc.day
op_assign
id|days
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * BIOS Flash Routines                                                      *&n; ****************************************************************************/
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_erase_bios                                             */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*   Erase the BIOS on the adapter                                          */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_erase_bios
id|ips_erase_bios
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|u_int8_t
id|status
op_assign
l_int|0
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_erase_bios&quot;
comma
l_int|1
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear the status register */
id|outl
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|outb
c_func
(paren
l_int|0x50
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* Erase Setup */
id|outb
c_func
(paren
l_int|0x20
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* Erase Confirm */
id|outb
c_func
(paren
l_int|0xD0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* Erase Status */
id|outb
c_func
(paren
l_int|0x70
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|timeout
op_assign
l_int|80000
suffix:semicolon
multiline_comment|/* 80 seconds */
r_while
c_loop
(paren
id|timeout
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
(brace
id|outl
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
)brace
id|status
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x80
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|timeout
op_decrement
suffix:semicolon
)brace
multiline_comment|/* check for timeout */
r_if
c_cond
(paren
id|timeout
op_le
l_int|0
)paren
(brace
multiline_comment|/* timeout */
multiline_comment|/* try to suspend the erase */
id|outb
c_func
(paren
l_int|0xB0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* wait for 10 seconds */
id|timeout
op_assign
l_int|10000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
(brace
id|outl
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
)brace
id|status
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0xC0
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|timeout
op_decrement
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* check for valid VPP */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x08
)paren
multiline_comment|/* VPP failure */
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* check for succesful flash */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x30
)paren
multiline_comment|/* sequence error */
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Otherwise, we were successful */
multiline_comment|/* clear status */
id|outb
c_func
(paren
l_int|0x50
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* enable reads */
id|outb
c_func
(paren
l_int|0xFF
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_erase_bios_memio                                       */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*   Erase the BIOS on the adapter                                          */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_erase_bios_memio
id|ips_erase_bios_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
)paren
(brace
r_int
id|timeout
suffix:semicolon
id|u_int8_t
id|status
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_erase_bios_memio&quot;
comma
l_int|1
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear the status register */
id|writel
c_func
(paren
l_int|0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|writeb
c_func
(paren
l_int|0x50
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* Erase Setup */
id|writeb
c_func
(paren
l_int|0x20
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* Erase Confirm */
id|writeb
c_func
(paren
l_int|0xD0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* Erase Status */
id|writeb
c_func
(paren
l_int|0x70
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|timeout
op_assign
l_int|80000
suffix:semicolon
multiline_comment|/* 80 seconds */
r_while
c_loop
(paren
id|timeout
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
(brace
id|writel
c_func
(paren
l_int|0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
)brace
id|status
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x80
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|timeout
op_decrement
suffix:semicolon
)brace
multiline_comment|/* check for timeout */
r_if
c_cond
(paren
id|timeout
op_le
l_int|0
)paren
(brace
multiline_comment|/* timeout */
multiline_comment|/* try to suspend the erase */
id|writeb
c_func
(paren
l_int|0xB0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* wait for 10 seconds */
id|timeout
op_assign
l_int|10000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
(brace
id|writel
c_func
(paren
l_int|0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
)brace
id|status
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0xC0
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|timeout
op_decrement
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* check for valid VPP */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x08
)paren
multiline_comment|/* VPP failure */
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* check for succesful flash */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x30
)paren
multiline_comment|/* sequence error */
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Otherwise, we were successful */
multiline_comment|/* clear status */
id|writeb
c_func
(paren
l_int|0x50
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* enable reads */
id|writeb
c_func
(paren
l_int|0xFF
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_program_bios                                           */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*   Program the BIOS on the adapter                                        */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_program_bios
id|ips_program_bios
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_char
op_star
id|buffer
comma
id|u_int32_t
id|buffersize
comma
id|u_int32_t
id|offset
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|u_int8_t
id|status
op_assign
l_int|0
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_program_bios&quot;
comma
l_int|1
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|buffersize
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* write a byte */
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|i
op_plus
id|offset
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|outb
c_func
(paren
l_int|0x40
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|outb
c_func
(paren
id|buffer
(braket
id|i
)braket
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* wait up to one second */
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
(brace
id|outl
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
)brace
id|status
op_assign
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x80
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|timeout
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timeout
op_eq
l_int|0
)paren
(brace
multiline_comment|/* timeout error */
id|outl
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|outb
c_func
(paren
l_int|0xFF
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* check the status */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x18
)paren
(brace
multiline_comment|/* programming error */
id|outl
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|outb
c_func
(paren
l_int|0xFF
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end for */
multiline_comment|/* Enable reading */
id|outl
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|outb
c_func
(paren
l_int|0xFF
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_program_bios_memio                                     */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*   Program the BIOS on the adapter                                        */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_program_bios_memio
id|ips_program_bios_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_char
op_star
id|buffer
comma
id|u_int32_t
id|buffersize
comma
id|u_int32_t
id|offset
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|u_int8_t
id|status
op_assign
l_int|0
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_program_bios_memio&quot;
comma
l_int|1
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|buffersize
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* write a byte */
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|i
op_plus
id|offset
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|writeb
c_func
(paren
l_int|0x40
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|writeb
c_func
(paren
id|buffer
(braket
id|i
)braket
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
multiline_comment|/* wait up to one second */
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
(brace
id|writel
c_func
(paren
l_int|0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
)brace
id|status
op_assign
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x80
)paren
r_break
suffix:semicolon
id|MDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|timeout
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timeout
op_eq
l_int|0
)paren
(brace
multiline_comment|/* timeout error */
id|writel
c_func
(paren
l_int|0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|writeb
c_func
(paren
l_int|0xFF
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* check the status */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x18
)paren
(brace
multiline_comment|/* programming error */
id|writel
c_func
(paren
l_int|0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|writeb
c_func
(paren
l_int|0xFF
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end for */
multiline_comment|/* Enable reading */
id|writel
c_func
(paren
l_int|0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|writeb
c_func
(paren
l_int|0xFF
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_verify_bios                                            */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*   Verify the BIOS on the adapter                                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_verify_bios
id|ips_verify_bios
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_char
op_star
id|buffer
comma
id|u_int32_t
id|buffersize
comma
id|u_int32_t
id|offset
)paren
(brace
id|u_int8_t
id|checksum
suffix:semicolon
r_int
id|i
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_verify_bios&quot;
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* test 1st byte */
id|outl
c_func
(paren
l_int|0
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
op_ne
l_int|0x55
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
l_int|1
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
op_ne
l_int|0xAA
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
id|checksum
op_assign
l_int|0xff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
id|buffersize
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outl
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|i
op_plus
id|offset
)paren
comma
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|checksum
op_assign
(paren
id|u_int8_t
)paren
id|checksum
op_plus
id|inb
c_func
(paren
id|ha-&gt;io_addr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|checksum
op_ne
l_int|0
)paren
multiline_comment|/* failure */
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_else
multiline_comment|/* success */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Name: ips_verify_bios_memio                                      */
multiline_comment|/*                                                                          */
multiline_comment|/* Routine Description:                                                     */
multiline_comment|/*   Verify the BIOS on the adapter                                         */
multiline_comment|/*                                                                          */
multiline_comment|/****************************************************************************/
r_static
r_int
DECL|function|ips_verify_bios_memio
id|ips_verify_bios_memio
c_func
(paren
id|ips_ha_t
op_star
id|ha
comma
r_char
op_star
id|buffer
comma
id|u_int32_t
id|buffersize
comma
id|u_int32_t
id|offset
)paren
(brace
id|u_int8_t
id|checksum
suffix:semicolon
r_int
id|i
suffix:semicolon
id|METHOD_TRACE
c_func
(paren
l_string|&quot;ips_verify_bios_memio&quot;
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* test 1st byte */
id|writel
c_func
(paren
l_int|0
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
op_ne
l_int|0x55
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|1
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
op_ne
l_int|0xAA
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
id|checksum
op_assign
l_int|0xff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
id|buffersize
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|i
op_plus
id|offset
)paren
comma
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;revision_id
op_eq
id|IPS_REVID_TROMBONE64
)paren
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 5 us */
id|checksum
op_assign
(paren
id|u_int8_t
)paren
id|checksum
op_plus
id|readb
c_func
(paren
id|ha-&gt;mem_ptr
op_plus
id|IPS_REG_FLDP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|checksum
op_ne
l_int|0
)paren
multiline_comment|/* failure */
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_else
multiline_comment|/* success */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#if defined (MODULE) || (LINUX_VERSION_CODE &gt;= LinuxVersionCode(2,4,0))
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|IPS
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we almost follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 2&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -2&n; * c-argdecl-indent: 2&n; * c-label-offset: -2&n; * c-continued-statement-offset: 2&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
