multiline_comment|/* &n;   3w-xxxx.c -- 3ware Storage Controller device driver for Linux.&n;&n;   Written By: Adam Radford &lt;linuxraid@amcc.com&gt;&n;   Modifications By: Joel Jacobson &lt;linux@3ware.com&gt;&n;   &t;&t;     Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n;                     Brad Strand &lt;linux@3ware.com&gt;&n;&n;   Copyright (C) 1999-2004 3ware Inc.&n;&n;   Kernel compatiblity By: &t;Andre Hedrick &lt;andre@suse.com&gt;&n;   Non-Copyright (C) 2000&t;Andre Hedrick &lt;andre@suse.com&gt;&n;   &n;   Further tiny build fixes and trivial hoovering    Alan Cox&n;&n;   This program is free software; you can redistribute it and/or modify&n;   it under the terms of the GNU General Public License as published by&n;   the Free Software Foundation; version 2 of the License.&n;&n;   This program is distributed in the hope that it will be useful,           &n;   but WITHOUT ANY WARRANTY; without even the implied warranty of            &n;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the             &n;   GNU General Public License for more details.                              &n;&n;   NO WARRANTY                                                               &n;   THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR        &n;   CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT      &n;   LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,      &n;   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is    &n;   solely responsible for determining the appropriateness of using and       &n;   distributing the Program and assumes all risks associated with its        &n;   exercise of rights under this Agreement, including but not limited to     &n;   the risks and costs of program errors, damage to or loss of data,         &n;   programs or equipment, and unavailability or interruption of operations.  &n;&n;   DISCLAIMER OF LIABILITY                                                   &n;   NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY   &n;   DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL        &n;   DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND   &n;   ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR     &n;   TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE    &n;   USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED  &n;   HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES             &n;&n;   You should have received a copy of the GNU General Public License         &n;   along with this program; if not, write to the Free Software               &n;   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA &n;&n;   Bugs/Comments/Suggestions should be mailed to:                            &n;   linuxraid@amcc.com&n;&n;   For more information, goto:&n;   http://www.amcc.com&n;&n;   History&n;   -------&n;   0.1.000 -     Initial release.&n;   0.4.000 -     Added support for Asynchronous Event Notification through&n;                 ioctls for 3DM.&n;   1.0.000 -     Added DPO &amp; FUA bit support for WRITE_10 &amp; WRITE_6 cdb&n;                 to disable drive write-cache before writes.&n;   1.1.000 -     Fixed performance bug with DPO &amp; FUA not existing for WRITE_6.&n;   1.2.000 -     Added support for clean shutdown notification/feature table.&n;   1.02.00.001 - Added support for full command packet posts through ioctls&n;                 for 3DM.&n;                 Bug fix so hot spare drives don&squot;t show up.&n;   1.02.00.002 - Fix bug with tw_setfeature() call that caused oops on some&n;                 systems.&n;   08/21/00    - release previously allocated resources on failure at&n;                 tw_allocate_memory (acme)&n;   1.02.00.003 - Fix tw_interrupt() to report error to scsi layer when&n;                 controller status is non-zero.&n;                 Added handling of request_sense opcode.&n;                 Fix possible null pointer dereference in &n;                 tw_reset_device_extension()&n;   1.02.00.004 - Add support for device id of 3ware 7000 series controllers.&n;                 Make tw_setfeature() call with interrupts disabled.&n;                 Register interrupt handler before enabling interrupts.&n;                 Clear attention interrupt before draining aen queue.&n;   1.02.00.005 - Allocate bounce buffers and custom queue depth for raid5 for&n;                 6000 and 5000 series controllers.&n;                 Reduce polling mdelays causing problems on some systems.&n;                 Fix use_sg = 1 calculation bug.&n;                 Check for scsi_register returning NULL.&n;                 Add aen count to /proc/scsi/3w-xxxx.&n;                 Remove aen code unit masking in tw_aen_complete().&n;   1.02.00.006 - Remove unit from printk in tw_scsi_eh_abort(), causing&n;                 possible oops.&n;                 Fix possible null pointer dereference in tw_scsi_queue()&n;                 if done function pointer was invalid.&n;   1.02.00.007 - Fix possible null pointer dereferences in tw_ioctl().&n;                 Remove check for invalid done function pointer from&n;                 tw_scsi_queue().&n;   1.02.00.008 - Set max sectors per io to TW_MAX_SECTORS in tw_findcards().&n;                 Add tw_decode_error() for printing readable error messages.&n;                 Print some useful information on certain aen codes.&n;                 Add tw_decode_bits() for interpreting status register output.&n;                 Make scsi_set_pci_device() for kernels &gt;= 2.4.4&n;                 Fix bug where aen&squot;s could be lost before a reset.&n;                 Re-add spinlocks in tw_scsi_detect().&n;                 Fix possible null pointer dereference in tw_aen_drain_queue()&n;                 during initialization.&n;                 Clear pci parity errors during initialization and during io.&n;   1.02.00.009 - Remove redundant increment in tw_state_request_start().&n;                 Add ioctl support for direct ATA command passthru.&n;                 Add entire aen code string list.&n;   1.02.00.010 - Cleanup queueing code, fix jbod thoughput.&n;                 Fix get_param for specific units.&n;   1.02.00.011 - Fix bug in tw_aen_complete() where aen&squot;s could be lost.&n;                 Fix tw_aen_drain_queue() to display useful info at init.&n;                 Set tw_host-&gt;max_id for 12 port cards.&n;                 Add ioctl support for raw command packet post from userspace&n;                 with sglist fragments (parameter and io).&n;   1.02.00.012 - Fix read capacity to under report by 1 sector to fix get&n;                 last sector ioctl.&n;   1.02.00.013 - Fix bug where more AEN codes weren&squot;t coming out during&n;                 driver initialization.&n;                 Improved handling of PCI aborts.&n;   1.02.00.014 - Fix bug in tw_findcards() where AEN code could be lost.&n;                 Increase timeout in tw_aen_drain_queue() to 30 seconds.&n;   1.02.00.015 - Re-write raw command post with data ioctl method.&n;                 Remove raid5 bounce buffers for raid5 for 6XXX for kernel 2.5&n;                 Add tw_map/unmap_scsi_sg/single_data() for kernel 2.5&n;                 Replace io_request_lock with host_lock for kernel 2.5&n;                 Set max_cmd_len to 16 for 3dm for kernel 2.5&n;   1.02.00.016 - Set host-&gt;max_sectors back up to 256.&n;   1.02.00.017 - Modified pci parity error handling/clearing from config space&n;                 during initialization.&n;   1.02.00.018 - Better handling of request sense opcode and sense information&n;                 for failed commands.  Add tw_decode_sense().&n;                 Replace all mdelay()&squot;s with scsi_sleep().&n;   1.02.00.019 - Revert mdelay&squot;s and scsi_sleep&squot;s, this caused problems on&n;                 some SMP systems.&n;   1.02.00.020 - Add pci_set_dma_mask(), rewrite kmalloc()/virt_to_bus() to&n;                 pci_alloc/free_consistent().&n;                 Better alignment checking in tw_allocate_memory().&n;                 Cleanup tw_initialize_device_extension().&n;   1.02.00.021 - Bump cmd_per_lun in SHT to 255 for better jbod performance.&n;                 Improve handling of errors in tw_interrupt().&n;                 Add handling/clearing of controller queue error.&n;                 Empty stale responses before draining aen queue.&n;                 Fix tw_scsi_eh_abort() to not reset on every io abort.&n;                 Set can_queue in SHT to 255 to prevent hang from AEN.&n;   1.02.00.022 - Fix possible null pointer dereference in tw_scsi_release().&n;   1.02.00.023 - Fix bug in tw_aen_drain_queue() where unit # was always zero.&n;   1.02.00.024 - Add severity levels to AEN strings.&n;   1.02.00.025 - Fix command interrupt spurious error messages.&n;                 Fix bug in raw command post with data ioctl method.&n;                 Fix bug where rollcall sometimes failed with cable errors.&n;                 Print unit # on all command timeouts.&n;   1.02.00.026 - Fix possible infinite retry bug with power glitch induced&n;                 drive timeouts.&n;                 Cleanup some AEN severity levels.&n;   1.02.00.027 - Add drive not supported AEN code for SATA controllers.&n;                 Remove spurious unknown ioctl error message.&n;   1.02.00.028 - Fix bug where multiple controllers with no units were the&n;                 same card number.&n;                 Fix bug where cards were being shut down more than once.&n;   1.02.00.029 - Add missing pci_free_consistent() in tw_allocate_memory().&n;                 Replace pci_map_single() with pci_map_page() for highmem.&n;                 Check for tw_setfeature() failure.&n;   1.02.00.030 - Make driver 64-bit clean.&n;   1.02.00.031 - Cleanup polling timeouts/routines in several places.&n;                 Add support for mode sense opcode.&n;                 Add support for cache mode page.&n;                 Add support for synchronize cache opcode.&n;   1.02.00.032 - Fix small multicard rollcall bug.&n;                 Make driver stay loaded with no units for hot add/swap.&n;                 Add support for &quot;twe&quot; character device for ioctls.&n;                 Clean up request_id queueing code.&n;                 Fix tw_scsi_queue() spinlocks.&n;   1.02.00.033 - Fix tw_aen_complete() to not queue &squot;queue empty&squot; AEN&squot;s.&n;                 Initialize queues correctly when loading with no valid units.&n;   1.02.00.034 - Fix tw_decode_bits() to handle multiple errors.&n;                 Add support for user configurable cmd_per_lun.&n;                 Add support for sht-&gt;slave_configure().&n;   1.02.00.035 - Improve tw_allocate_memory() memory allocation.&n;                 Fix tw_chrdev_ioctl() to sleep correctly.&n;   1.02.00.036 - Increase character ioctl timeout to 60 seconds.&n;   1.02.00.037 - Fix tw_ioctl() to handle all non-data ATA passthru cmds&n;                 for &squot;smartmontools&squot; support.&n;   1.26.00.038 - Roll driver minor version to 26 to denote kernel 2.6.&n;                 Add support for cmds_per_lun module parameter.&n;   1.26.00.039 - Fix bug in tw_chrdev_ioctl() polling code.&n;                 Fix data_buffer_length usage in tw_chrdev_ioctl().&n;                 Update contact information.&n;   1.26.02.000 - Convert driver to pci_driver format.&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsi_tcq.h&gt;
macro_line|#include &lt;scsi/scsi_cmnd.h&gt;
macro_line|#include &quot;3w-xxxx.h&quot;
multiline_comment|/* Globals */
DECL|macro|TW_DRIVER_VERSION
mdefine_line|#define TW_DRIVER_VERSION &quot;1.26.02.000&quot;
DECL|variable|tw_device_extension_list
r_static
id|TW_Device_Extension
op_star
id|tw_device_extension_list
(braket
id|TW_MAX_SLOT
)braket
suffix:semicolon
DECL|variable|tw_device_extension_count
r_static
r_int
id|tw_device_extension_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|twe_major
r_static
r_int
id|twe_major
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Module parameters */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;AMCC&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;3ware Storage Controller Linux Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|TW_DRIVER_VERSION
id|MODULE_VERSION
c_func
(paren
id|TW_DRIVER_VERSION
)paren
suffix:semicolon
multiline_comment|/* Function prototypes */
r_static
r_int
id|tw_reset_device_extension
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|ioctl_reset
)paren
suffix:semicolon
multiline_comment|/* Functions */
multiline_comment|/* This function will check the status register for unexpected bits */
DECL|function|tw_check_bits
r_static
r_int
id|tw_check_bits
c_func
(paren
id|u32
id|status_reg_value
)paren
(brace
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_EXPECTED_BITS
)paren
op_ne
id|TW_STATUS_EXPECTED_BITS
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_check_bits(): No expected bits (0x%x).&bslash;n&quot;
comma
id|status_reg_value
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_UNEXPECTED_BITS
)paren
op_ne
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_check_bits(): Found unexpected bits (0x%x).&bslash;n&quot;
comma
id|status_reg_value
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_check_bits() */
multiline_comment|/* This function will print readable messages from status register errors */
DECL|function|tw_decode_bits
r_static
r_int
id|tw_decode_bits
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
id|u32
id|status_reg_value
comma
r_int
id|print_host
)paren
(brace
r_char
id|host
(braket
l_int|16
)braket
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_decode_bits()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|print_host
)paren
id|sprintf
c_func
(paren
id|host
comma
l_string|&quot; scsi%d:&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_else
id|host
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_PCI_PARITY_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx:%s PCI Parity Error: clearing.&bslash;n&quot;
comma
id|host
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TW_CONTROL_CLEAR_PARITY_ERROR
comma
id|TW_CONTROL_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_PCI_ABORT
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx:%s PCI Abort: clearing.&bslash;n&quot;
comma
id|host
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TW_CONTROL_CLEAR_PCI_ABORT
comma
id|TW_CONTROL_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|PCI_STATUS
comma
id|TW_PCI_CLEAR_PCI_ABORT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_QUEUE_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx:%s Controller Queue Error: clearing.&bslash;n&quot;
comma
id|host
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TW_CONTROL_CLEAR_QUEUE_ERROR
comma
id|TW_CONTROL_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_SBUF_WRITE_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx:%s SBUF Write Error: clearing.&bslash;n&quot;
comma
id|host
)paren
suffix:semicolon
id|outl
c_func
(paren
id|TW_CONTROL_CLEAR_SBUF_WRITE_ERROR
comma
id|TW_CONTROL_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_MICROCONTROLLER_ERROR
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;reset_print
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx:%s Microcontroller Error: clearing.&bslash;n&quot;
comma
id|host
)paren
suffix:semicolon
id|tw_dev-&gt;reset_print
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_decode_bits() */
multiline_comment|/* This function will poll the status register for a flag */
DECL|function|tw_poll_status
r_static
r_int
id|tw_poll_status
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
id|u32
id|flag
comma
r_int
id|seconds
)paren
(brace
id|u32
id|status_reg_value
suffix:semicolon
r_int
r_int
id|before
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|before
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
id|tw_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status_reg_value
op_amp
id|flag
)paren
op_ne
id|flag
)paren
(brace
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
id|tw_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|before
op_plus
id|HZ
op_star
id|seconds
)paren
)paren
r_goto
id|out
suffix:semicolon
id|msleep
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End tw_poll_status() */
multiline_comment|/* This function will poll the status register for disappearance of a flag */
DECL|function|tw_poll_status_gone
r_static
r_int
id|tw_poll_status_gone
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
id|u32
id|flag
comma
r_int
id|seconds
)paren
(brace
id|u32
id|status_reg_value
suffix:semicolon
r_int
r_int
id|before
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|before
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
id|tw_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status_reg_value
op_amp
id|flag
)paren
op_ne
l_int|0
)paren
(brace
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
id|tw_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|before
op_plus
id|HZ
op_star
id|seconds
)paren
)paren
r_goto
id|out
suffix:semicolon
id|msleep
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End tw_poll_status_gone() */
multiline_comment|/* This function will attempt to post a command packet to the board */
DECL|function|tw_post_command_packet
r_static
r_int
id|tw_post_command_packet
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|u32
id|status_reg_value
suffix:semicolon
r_int
r_int
id|command_que_value
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_post_command_packet()&bslash;n&quot;
)paren
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_post_command_packet(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_COMMAND_QUEUE_FULL
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* We successfully posted the command packet */
id|outl
c_func
(paren
id|command_que_value
comma
id|TW_COMMAND_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_POSTED
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;posted_request_count
OG
id|tw_dev-&gt;max_posted_request_count
)paren
(brace
id|tw_dev-&gt;max_posted_request_count
op_assign
id|tw_dev-&gt;posted_request_count
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Couldn&squot;t post the command packet, so we do it in the isr */
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_ne
id|TW_S_PENDING
)paren
(brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_PENDING
suffix:semicolon
id|tw_dev-&gt;pending_request_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;pending_request_count
OG
id|tw_dev-&gt;max_pending_request_count
)paren
(brace
id|tw_dev-&gt;max_pending_request_count
op_assign
id|tw_dev-&gt;pending_request_count
suffix:semicolon
)brace
id|tw_dev-&gt;pending_queue
(braket
id|tw_dev-&gt;pending_tail
)braket
op_assign
id|request_id
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;pending_tail
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;pending_tail
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;pending_tail
op_assign
id|tw_dev-&gt;pending_tail
op_plus
l_int|1
suffix:semicolon
)brace
)brace
id|TW_UNMASK_COMMAND_INTERRUPT
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_post_command_packet() */
multiline_comment|/* This function will return valid sense buffer information for failed cmds */
DECL|function|tw_decode_sense
r_static
r_int
id|tw_decode_sense
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
comma
r_int
id|fill_sense
)paren
(brace
r_int
id|i
suffix:semicolon
id|TW_Command
op_star
id|command
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_decode_sense()&bslash;n&quot;
)paren
suffix:semicolon
id|command
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Command failed: status = 0x%x, flags = 0x%x, unit #%d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
comma
id|command-&gt;status
comma
id|command-&gt;flags
comma
id|TW_UNIT_OUT
c_func
(paren
id|command-&gt;unit__hostid
)paren
)paren
suffix:semicolon
multiline_comment|/* Attempt to return intelligent sense information */
r_if
c_cond
(paren
id|fill_sense
)paren
(brace
r_if
c_cond
(paren
(paren
id|command-&gt;status
op_eq
l_int|0xc7
)paren
op_logical_or
(paren
id|command-&gt;status
op_eq
l_int|0xcb
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|tw_sense_table
)paren
op_div
r_sizeof
(paren
id|tw_sense_table
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|command-&gt;flags
op_eq
id|tw_sense_table
(braket
id|i
)braket
(braket
l_int|0
)braket
)paren
(brace
multiline_comment|/* Valid bit and &squot;current errors&squot; */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|sense_buffer
(braket
l_int|0
)braket
op_assign
(paren
l_int|0x1
op_lshift
l_int|7
op_or
l_int|0x70
)paren
suffix:semicolon
multiline_comment|/* Sense key */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|sense_buffer
(braket
l_int|2
)braket
op_assign
id|tw_sense_table
(braket
id|i
)braket
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Additional sense length */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|sense_buffer
(braket
l_int|7
)braket
op_assign
l_int|0xa
suffix:semicolon
multiline_comment|/* 10 bytes */
multiline_comment|/* Additional sense code */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|sense_buffer
(braket
l_int|12
)braket
op_assign
id|tw_sense_table
(braket
id|i
)braket
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Additional sense code qualifier */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|sense_buffer
(braket
l_int|13
)braket
op_assign
id|tw_sense_table
(braket
id|i
)braket
(braket
l_int|3
)braket
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
r_return
id|TW_ISR_DONT_RESULT
suffix:semicolon
multiline_comment|/* Special case for isr to not over-write result */
)brace
)brace
)brace
multiline_comment|/* If no table match, error so we get a reset */
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_decode_sense() */
multiline_comment|/* This function will report controller error status */
DECL|function|tw_check_errors
r_static
r_int
id|tw_check_errors
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|status_reg_value
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TW_STATUS_ERRORS
c_func
(paren
id|status_reg_value
)paren
op_logical_or
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|tw_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_check_errors() */
multiline_comment|/* This function will empty the response que */
DECL|function|tw_empty_response_que
r_static
r_void
id|tw_empty_response_que
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|status_reg_value
comma
id|response_que_value
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
id|response_que_value
op_assign
id|inl
c_func
(paren
id|TW_RESPONSE_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* End tw_empty_response_que() */
multiline_comment|/* This function will free a request_id */
DECL|function|tw_state_request_finish
r_static
r_void
id|tw_state_request_finish
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|tw_dev-&gt;free_queue
(braket
id|tw_dev-&gt;free_tail
)braket
op_assign
id|request_id
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_FINISHED
suffix:semicolon
id|tw_dev-&gt;free_tail
op_assign
(paren
id|tw_dev-&gt;free_tail
op_plus
l_int|1
)paren
op_mod
id|TW_Q_LENGTH
suffix:semicolon
)brace
multiline_comment|/* End tw_state_request_finish() */
multiline_comment|/* This function will assign an available request_id */
DECL|function|tw_state_request_start
r_static
r_void
id|tw_state_request_start
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
op_star
id|request_id
)paren
(brace
op_star
id|request_id
op_assign
id|tw_dev-&gt;free_queue
(braket
id|tw_dev-&gt;free_head
)braket
suffix:semicolon
id|tw_dev-&gt;free_head
op_assign
(paren
id|tw_dev-&gt;free_head
op_plus
l_int|1
)paren
op_mod
id|TW_Q_LENGTH
suffix:semicolon
id|tw_dev-&gt;state
(braket
op_star
id|request_id
)braket
op_assign
id|TW_S_STARTED
suffix:semicolon
)brace
multiline_comment|/* End tw_state_request_start() */
multiline_comment|/* Show some statistics about the card */
DECL|function|tw_show_stats
r_static
id|ssize_t
id|tw_show_stats
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|ssize_t
id|len
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|len
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;3w-xxxx Driver version: %s&bslash;n&quot;
l_string|&quot;Current commands posted:   %4d&bslash;n&quot;
l_string|&quot;Max commands posted:       %4d&bslash;n&quot;
l_string|&quot;Current pending commands:  %4d&bslash;n&quot;
l_string|&quot;Max pending commands:      %4d&bslash;n&quot;
l_string|&quot;Last sgl length:           %4d&bslash;n&quot;
l_string|&quot;Max sgl length:            %4d&bslash;n&quot;
l_string|&quot;Last sector count:         %4d&bslash;n&quot;
l_string|&quot;Max sector count:          %4d&bslash;n&quot;
l_string|&quot;SCSI Host Resets:          %4d&bslash;n&quot;
l_string|&quot;AEN&squot;s:                     %4d&bslash;n&quot;
comma
id|TW_DRIVER_VERSION
comma
id|tw_dev-&gt;posted_request_count
comma
id|tw_dev-&gt;max_posted_request_count
comma
id|tw_dev-&gt;pending_request_count
comma
id|tw_dev-&gt;max_pending_request_count
comma
id|tw_dev-&gt;sgl_entries
comma
id|tw_dev-&gt;max_sgl_entries
comma
id|tw_dev-&gt;sector_count
comma
id|tw_dev-&gt;max_sector_count
comma
id|tw_dev-&gt;num_resets
comma
id|tw_dev-&gt;aen_count
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* End tw_show_stats() */
multiline_comment|/* This function will set a devices queue depth */
DECL|function|tw_store_queue_depth
r_static
id|ssize_t
id|tw_store_queue_depth
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|queue_depth
suffix:semicolon
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|queue_depth
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|queue_depth
OG
id|TW_Q_LENGTH
op_minus
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|scsi_adjust_queue_depth
c_func
(paren
id|sdev
comma
id|MSG_ORDERED_TAG
comma
id|queue_depth
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* End tw_store_queue_depth() */
multiline_comment|/* Create sysfs &squot;queue_depth&squot; entry */
DECL|variable|tw_queue_depth_attr
r_static
r_struct
id|device_attribute
id|tw_queue_depth_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;queue_depth&quot;
comma
dot
id|mode
op_assign
id|S_IRUSR
op_or
id|S_IWUSR
comma
)brace
comma
dot
id|store
op_assign
id|tw_store_queue_depth
)brace
suffix:semicolon
multiline_comment|/* Device attributes initializer */
DECL|variable|tw_dev_attrs
r_static
r_struct
id|device_attribute
op_star
id|tw_dev_attrs
(braket
)braket
op_assign
(brace
op_amp
id|tw_queue_depth_attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
multiline_comment|/* Create sysfs &squot;stats&squot; entry */
DECL|variable|tw_host_stats_attr
r_static
r_struct
id|class_device_attribute
id|tw_host_stats_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;stats&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
)brace
comma
dot
id|show
op_assign
id|tw_show_stats
)brace
suffix:semicolon
multiline_comment|/* Host attributes initializer */
DECL|variable|tw_host_attrs
r_static
r_struct
id|class_device_attribute
op_star
id|tw_host_attrs
(braket
)braket
op_assign
(brace
op_amp
id|tw_host_stats_attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
multiline_comment|/* This function will read the aen queue from the isr */
DECL|function|tw_aen_read_queue
r_static
r_int
id|tw_aen_read_queue
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
r_int
r_int
id|command_que_value
suffix:semicolon
id|u32
id|status_reg_value
suffix:semicolon
r_int
r_int
id|param_value
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_read_queue()&bslash;n&quot;
)paren
suffix:semicolon
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|2
comma
id|TW_OP_GET_PARAM
)paren
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now setup the param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
l_int|0x401
suffix:semicolon
multiline_comment|/* AEN table */
id|param-&gt;parameter_id
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Unit code */
id|param-&gt;parameter_size_bytes
op_assign
l_int|2
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
multiline_comment|/* Now post the command packet */
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_COMMAND_QUEUE_FULL
)paren
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Post succeeded.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Flag internal command */
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_POSTED
suffix:semicolon
id|outl
c_func
(paren
id|command_que_value
comma
id|TW_COMMAND_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_read_queue(): Post failed, will retry.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_aen_read_queue() */
multiline_comment|/* This function will complete an aen request from the isr */
DECL|function|tw_aen_complete
r_static
r_int
id|tw_aen_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Param
op_star
id|param
suffix:semicolon
r_int
r_int
id|aen
suffix:semicolon
r_int
id|error
op_assign
l_int|0
comma
id|table_max
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_complete()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_complete(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|aen
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|param-&gt;data
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_complete(): Queue&squot;d code 0x%x&bslash;n&quot;
comma
id|aen
)paren
suffix:semicolon
multiline_comment|/* Print some useful info when certain aen codes come out */
r_if
c_cond
(paren
id|aen
op_eq
l_int|0x0ff
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: AEN: INFO: AEN queue overflow.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
)brace
r_else
(brace
id|table_max
op_assign
r_sizeof
(paren
id|tw_aen_string
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|aen
op_amp
l_int|0x0ff
)paren
OL
id|table_max
)paren
(brace
r_if
c_cond
(paren
(paren
id|tw_aen_string
(braket
id|aen
op_amp
l_int|0xff
)braket
(braket
id|strlen
c_func
(paren
id|tw_aen_string
(braket
id|aen
op_amp
l_int|0xff
)braket
)paren
op_minus
l_int|1
)braket
)paren
op_eq
l_char|&squot;#&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: AEN: %s%d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
comma
id|tw_aen_string
(braket
id|aen
op_amp
l_int|0xff
)braket
comma
id|aen
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|aen
op_ne
l_int|0x0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: AEN: %s.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
comma
id|tw_aen_string
(braket
id|aen
op_amp
l_int|0xff
)braket
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Received AEN %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
comma
id|aen
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|aen
op_ne
id|TW_AEN_QUEUE_EMPTY
)paren
(brace
id|tw_dev-&gt;aen_count
op_increment
suffix:semicolon
multiline_comment|/* Now queue the code */
id|tw_dev-&gt;aen_queue
(braket
id|tw_dev-&gt;aen_tail
)braket
op_assign
id|aen
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;aen_tail
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_tail
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;aen_tail
op_assign
id|tw_dev-&gt;aen_tail
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|tw_dev-&gt;aen_tail
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_head
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;aen_head
op_assign
id|tw_dev-&gt;aen_head
op_plus
l_int|1
suffix:semicolon
)brace
)brace
id|error
op_assign
id|tw_aen_read_queue
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Error completing AEN.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_aen_complete() */
multiline_comment|/* This function will drain the aen queue after a soft reset */
DECL|function|tw_aen_drain_queue
r_static
r_int
id|tw_aen_drain_queue
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
r_int
id|request_id
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|command_que_value
suffix:semicolon
r_int
r_int
id|param_value
suffix:semicolon
id|TW_Response_Queue
id|response_queue
suffix:semicolon
r_int
r_int
id|aen
suffix:semicolon
r_int
r_int
id|aen_code
suffix:semicolon
r_int
id|finished
op_assign
l_int|0
suffix:semicolon
r_int
id|first_reset
op_assign
l_int|0
suffix:semicolon
r_int
id|queue
op_assign
l_int|0
suffix:semicolon
r_int
id|found
op_assign
l_int|0
comma
id|table_max
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_aen_drain_queue()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_poll_status
c_func
(paren
id|tw_dev
comma
id|TW_STATUS_ATTENTION_INTERRUPT
op_or
id|TW_STATUS_MICROCONTROLLER_READY
comma
l_int|30
)paren
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): No attention interrupt for card %d.&bslash;n&quot;
comma
id|tw_device_extension_count
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|TW_CLEAR_ATTENTION_INTERRUPT
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Empty response queue */
id|tw_empty_response_que
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Initialize command packet */
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|2
comma
id|TW_OP_GET_PARAM
)paren
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now setup the param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
l_int|0x401
suffix:semicolon
multiline_comment|/* AEN table */
id|param-&gt;parameter_id
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Unit code */
id|param-&gt;parameter_size_bytes
op_assign
l_int|2
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
multiline_comment|/* Now drain the controller&squot;s aen queue */
r_do
(brace
multiline_comment|/* Post command packet */
id|outl
c_func
(paren
id|command_que_value
comma
id|TW_COMMAND_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
multiline_comment|/* Now poll for completion */
r_if
c_cond
(paren
id|tw_poll_status_gone
c_func
(paren
id|tw_dev
comma
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
comma
l_int|30
)paren
op_eq
l_int|0
)paren
(brace
id|response_queue.value
op_assign
id|inl
c_func
(paren
id|TW_RESPONSE_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|request_id
op_assign
id|TW_RESID_OUT
c_func
(paren
id|response_queue.response_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_id
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Unexpected request id */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Unexpected request id.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command_packet-&gt;status
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|command_packet-&gt;flags
op_ne
id|TW_AEN_TABLE_UNDEFINED
)paren
(brace
multiline_comment|/* Bad response */
id|tw_decode_sense
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We know this is a 3w-1x00, and doesn&squot;t support aen&squot;s */
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Now check the aen */
id|aen
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|param-&gt;data
)paren
suffix:semicolon
id|aen_code
op_assign
(paren
id|aen
op_amp
l_int|0x0ff
)paren
suffix:semicolon
id|queue
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|aen_code
)paren
(brace
r_case
id|TW_AEN_QUEUE_EMPTY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: AEN: %s.&bslash;n&quot;
comma
id|tw_aen_string
(braket
id|aen
op_amp
l_int|0xff
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_reset
op_ne
l_int|1
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|finished
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TW_AEN_SOFT_RESET
suffix:colon
r_if
c_cond
(paren
id|first_reset
op_eq
l_int|0
)paren
(brace
id|first_reset
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: AEN: %s.&bslash;n&quot;
comma
id|tw_aen_string
(braket
id|aen
op_amp
l_int|0xff
)braket
)paren
suffix:semicolon
id|tw_dev-&gt;aen_count
op_increment
suffix:semicolon
id|queue
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|aen
op_eq
l_int|0x0ff
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: AEN: INFO: AEN queue overflow.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|table_max
op_assign
r_sizeof
(paren
id|tw_aen_string
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|aen
op_amp
l_int|0x0ff
)paren
OL
id|table_max
)paren
(brace
r_if
c_cond
(paren
(paren
id|tw_aen_string
(braket
id|aen
op_amp
l_int|0xff
)braket
(braket
id|strlen
c_func
(paren
id|tw_aen_string
(braket
id|aen
op_amp
l_int|0xff
)braket
)paren
op_minus
l_int|1
)braket
)paren
op_eq
l_char|&squot;#&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: AEN: %s%d.&bslash;n&quot;
comma
id|tw_aen_string
(braket
id|aen
op_amp
l_int|0xff
)braket
comma
id|aen
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: AEN: %s.&bslash;n&quot;
comma
id|tw_aen_string
(braket
id|aen
op_amp
l_int|0xff
)braket
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Received AEN %d.&bslash;n&quot;
comma
id|aen
)paren
suffix:semicolon
)brace
id|tw_dev-&gt;aen_count
op_increment
suffix:semicolon
id|queue
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now put the aen on the aen_queue */
r_if
c_cond
(paren
id|queue
op_eq
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_queue
(braket
id|tw_dev-&gt;aen_tail
)braket
op_assign
id|aen
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;aen_tail
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_tail
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;aen_tail
op_assign
id|tw_dev-&gt;aen_tail
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|tw_dev-&gt;aen_tail
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_head
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;aen_head
op_assign
id|tw_dev-&gt;aen_head
op_plus
l_int|1
suffix:semicolon
)brace
)brace
)brace
id|found
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_aen_drain_queue(): Response never received.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|finished
op_eq
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_aen_drain_queue() */
multiline_comment|/* This function will allocate memory */
DECL|function|tw_allocate_memory
r_static
r_int
id|tw_allocate_memory
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|size
comma
r_int
id|which
)paren
(brace
r_int
id|i
suffix:semicolon
id|dma_addr_t
id|dma_handle
suffix:semicolon
r_int
r_int
op_star
id|cpu_addr
op_assign
l_int|NULL
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_allocate_memory()&bslash;n&quot;
)paren
suffix:semicolon
id|cpu_addr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|size
op_star
id|TW_Q_LENGTH
comma
op_amp
id|dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_addr
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: pci_alloc_consistent() failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|cpu_addr
op_mod
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;device
op_eq
id|TW_DEVICE_ID
ques
c_cond
id|TW_ALIGNMENT_6000
suffix:colon
id|TW_ALIGNMENT_7000
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Couldn&squot;t allocate correctly aligned memory.&bslash;n&quot;
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|size
op_star
id|TW_Q_LENGTH
comma
id|cpu_addr
comma
id|dma_handle
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cpu_addr
comma
l_int|0
comma
id|size
op_star
id|TW_Q_LENGTH
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_Q_LENGTH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|which
)paren
(brace
r_case
l_int|0
suffix:colon
id|tw_dev-&gt;command_packet_physical_address
(braket
id|i
)braket
op_assign
id|dma_handle
op_plus
(paren
id|i
op_star
id|size
)paren
suffix:semicolon
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|i
)braket
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|cpu_addr
op_plus
(paren
id|i
op_star
id|size
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|tw_dev-&gt;alignment_physical_address
(braket
id|i
)braket
op_assign
id|dma_handle
op_plus
(paren
id|i
op_star
id|size
)paren
suffix:semicolon
id|tw_dev-&gt;alignment_virtual_address
(braket
id|i
)braket
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|cpu_addr
op_plus
(paren
id|i
op_star
id|size
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_allocate_memory(): case slip in tw_allocate_memory()&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_allocate_memory() */
multiline_comment|/* This function handles ioctl for the character device */
DECL|function|tw_chrdev_ioctl
r_static
r_int
id|tw_chrdev_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|request_id
suffix:semicolon
id|dma_addr_t
id|dma_handle
suffix:semicolon
r_int
r_int
id|tw_aen_code
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|data_buffer_length
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|data_buffer_length_adjusted
op_assign
l_int|0
suffix:semicolon
r_int
r_int
op_star
id|cpu_addr
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|TW_New_Ioctl
op_star
id|tw_ioctl
suffix:semicolon
id|TW_Passthru
op_star
id|passthru
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
id|tw_device_extension_list
(braket
id|iminor
c_func
(paren
id|inode
)paren
)braket
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_chrdev_ioctl()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Only let one of these through at a time */
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|tw_dev-&gt;ioctl_sem
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
multiline_comment|/* First copy down the buffer length */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|data_buffer_length
comma
id|argp
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Check size */
r_if
c_cond
(paren
id|data_buffer_length
OG
id|TW_MAX_SECTORS
op_star
l_int|512
)paren
(brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Hardware can only do multiple of 512 byte transfers */
id|data_buffer_length_adjusted
op_assign
(paren
id|data_buffer_length
op_plus
l_int|511
)paren
op_amp
op_complement
l_int|511
suffix:semicolon
multiline_comment|/* Now allocate ioctl buf memory */
id|cpu_addr
op_assign
id|dma_alloc_coherent
c_func
(paren
op_amp
id|tw_dev-&gt;tw_pci_dev-&gt;dev
comma
id|data_buffer_length_adjusted
op_plus
r_sizeof
(paren
id|TW_New_Ioctl
)paren
op_minus
l_int|1
comma
op_amp
id|dma_handle
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpu_addr
op_eq
l_int|NULL
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|tw_ioctl
op_assign
(paren
id|TW_New_Ioctl
op_star
)paren
id|cpu_addr
suffix:semicolon
multiline_comment|/* Now copy down the entire ioctl */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|tw_ioctl
comma
id|argp
comma
id|data_buffer_length
op_plus
r_sizeof
(paren
id|TW_New_Ioctl
)paren
op_minus
l_int|1
)paren
)paren
r_goto
id|out2
suffix:semicolon
id|passthru
op_assign
(paren
id|TW_Passthru
op_star
)paren
op_amp
id|tw_ioctl-&gt;firmware_command
suffix:semicolon
multiline_comment|/* See which ioctl we are doing */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TW_OP_NOP
suffix:colon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_chrdev_ioctl(): caught TW_OP_NOP.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_OP_AEN_LISTEN
suffix:colon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_chrdev_ioctl(): caught TW_AEN_LISTEN.&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|tw_ioctl-&gt;data_buffer
comma
l_int|0
comma
id|data_buffer_length
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|tw_dev-&gt;aen_tail
)paren
(brace
id|tw_aen_code
op_assign
id|TW_AEN_QUEUE_EMPTY
suffix:semicolon
)brace
r_else
(brace
id|tw_aen_code
op_assign
id|tw_dev-&gt;aen_queue
(braket
id|tw_dev-&gt;aen_head
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;aen_head
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;aen_head
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;aen_head
op_assign
id|tw_dev-&gt;aen_head
op_plus
l_int|1
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tw_ioctl-&gt;data_buffer
comma
op_amp
id|tw_aen_code
comma
r_sizeof
(paren
id|tw_aen_code
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_CMD_PACKET_WITH_DATA
suffix:colon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_chrdev_ioctl(): caught TW_CMD_PACKET_WITH_DATA.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|tw_state_request_start
c_func
(paren
id|tw_dev
comma
op_amp
id|request_id
)paren
suffix:semicolon
multiline_comment|/* Flag internal command */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Flag chrdev ioctl */
id|tw_dev-&gt;chrdev_request_id
op_assign
id|request_id
suffix:semicolon
id|tw_ioctl-&gt;firmware_command.request_id
op_assign
id|request_id
suffix:semicolon
multiline_comment|/* Load the sg list */
r_switch
c_cond
(paren
id|TW_SGL_OUT
c_func
(paren
id|tw_ioctl-&gt;firmware_command.opcode__sgloffset
)paren
)paren
(brace
r_case
l_int|2
suffix:colon
id|tw_ioctl-&gt;firmware_command.byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|dma_handle
op_plus
r_sizeof
(paren
id|TW_New_Ioctl
)paren
op_minus
l_int|1
suffix:semicolon
id|tw_ioctl-&gt;firmware_command.byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
id|data_buffer_length_adjusted
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|tw_ioctl-&gt;firmware_command.byte8.io.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|dma_handle
op_plus
r_sizeof
(paren
id|TW_New_Ioctl
)paren
op_minus
l_int|1
suffix:semicolon
id|tw_ioctl-&gt;firmware_command.byte8.io.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
id|data_buffer_length_adjusted
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|passthru-&gt;sg_list
(braket
l_int|0
)braket
dot
id|address
op_assign
id|dma_handle
op_plus
r_sizeof
(paren
id|TW_New_Ioctl
)paren
op_minus
l_int|1
suffix:semicolon
id|passthru-&gt;sg_list
(braket
l_int|0
)braket
dot
id|length
op_assign
id|data_buffer_length_adjusted
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
comma
op_amp
(paren
id|tw_ioctl-&gt;firmware_command
)paren
comma
r_sizeof
(paren
id|TW_Command
)paren
)paren
suffix:semicolon
multiline_comment|/* Now post the command packet to the controller */
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|timeout
op_assign
id|TW_IOCTL_CHRDEV_TIMEOUT
op_star
id|HZ
suffix:semicolon
multiline_comment|/* Now wait for the command to complete */
id|timeout
op_assign
id|wait_event_interruptible_timeout
c_func
(paren
id|tw_dev-&gt;ioctl_wqueue
comma
id|tw_dev-&gt;chrdev_request_id
op_eq
id|TW_IOCTL_CHRDEV_FREE
comma
id|timeout
)paren
suffix:semicolon
multiline_comment|/* See if we reset while waiting for the ioctl to complete */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|TW_IN_RESET
comma
op_amp
id|tw_dev-&gt;flags
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|TW_IN_RESET
comma
op_amp
id|tw_dev-&gt;flags
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
multiline_comment|/* Check if we timed out, got a signal, or didn&squot;t get&n;&t;&t;&t;   an interrupt */
r_if
c_cond
(paren
(paren
id|timeout
op_le
l_int|0
)paren
op_logical_and
(paren
id|tw_dev-&gt;chrdev_request_id
op_ne
id|TW_IOCTL_CHRDEV_FREE
)paren
)paren
(brace
multiline_comment|/* Now we need to reset the board */
r_if
c_cond
(paren
id|timeout
op_eq
op_minus
id|ERESTARTSYS
)paren
(brace
id|retval
op_assign
id|timeout
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Character ioctl (0x%x) timed out, resetting card.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
comma
id|cmd
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_reset_device_extension
c_func
(paren
id|tw_dev
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_chrdev_ioctl(): Reset failed for card %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
)brace
r_goto
id|out2
suffix:semicolon
)brace
multiline_comment|/* Now copy in the command packet response */
id|memcpy
c_func
(paren
op_amp
(paren
id|tw_ioctl-&gt;firmware_command
)paren
comma
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
comma
r_sizeof
(paren
id|TW_Command
)paren
)paren
suffix:semicolon
multiline_comment|/* Now complete the io */
id|spin_lock_irqsave
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
id|ENOTTY
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
multiline_comment|/* Now copy the response to userspace */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
id|tw_ioctl
comma
r_sizeof
(paren
id|TW_New_Ioctl
)paren
op_plus
id|data_buffer_length
op_minus
l_int|1
)paren
)paren
r_goto
id|out2
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|out2
suffix:colon
multiline_comment|/* Now free ioctl buf memory */
id|dma_free_coherent
c_func
(paren
op_amp
id|tw_dev-&gt;tw_pci_dev-&gt;dev
comma
id|data_buffer_length_adjusted
op_plus
r_sizeof
(paren
id|TW_New_Ioctl
)paren
op_minus
l_int|1
comma
id|cpu_addr
comma
id|dma_handle
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|tw_dev-&gt;ioctl_sem
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End tw_chrdev_ioctl() */
multiline_comment|/* This function handles open for the character device */
DECL|function|tw_chrdev_open
r_static
r_int
id|tw_chrdev_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
r_int
id|minor_number
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_ioctl_open()&bslash;n&quot;
)paren
suffix:semicolon
id|minor_number
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor_number
op_ge
id|tw_device_extension_count
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_chrdev_open() */
multiline_comment|/* File operations struct for character device */
DECL|variable|tw_fops
r_static
r_struct
id|file_operations
id|tw_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|ioctl
op_assign
id|tw_chrdev_ioctl
comma
dot
id|open
op_assign
id|tw_chrdev_open
comma
dot
id|release
op_assign
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* This function will free up device extension resources */
DECL|function|tw_free_device_extension
r_static
r_void
id|tw_free_device_extension
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_free_device_extension()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Free command packet and generic buffer memory */
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
l_int|0
)braket
)paren
id|pci_free_consistent
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
r_sizeof
(paren
id|TW_Command
)paren
op_star
id|TW_Q_LENGTH
comma
id|tw_dev-&gt;command_packet_virtual_address
(braket
l_int|0
)braket
comma
id|tw_dev-&gt;command_packet_physical_address
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
l_int|0
)braket
)paren
id|pci_free_consistent
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
r_sizeof
(paren
id|TW_Sector
)paren
op_star
id|TW_Q_LENGTH
comma
id|tw_dev-&gt;alignment_virtual_address
(braket
l_int|0
)braket
comma
id|tw_dev-&gt;alignment_physical_address
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_free_device_extension() */
multiline_comment|/* This function will send an initconnection command to controller */
DECL|function|tw_initconnection
r_static
r_int
id|tw_initconnection
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|message_credits
)paren
(brace
r_int
r_int
id|command_que_value
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Response_Queue
id|response_queue
suffix:semicolon
r_int
id|request_id
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_initconnection()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Initialize InitConnection command packet */
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initconnection(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|0
comma
id|TW_OP_INIT_CONNECTION
)paren
suffix:semicolon
id|command_packet-&gt;size
op_assign
id|TW_INIT_COMMAND_PACKET_SIZE
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0x0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0x0
suffix:semicolon
id|command_packet-&gt;byte6.message_credits
op_assign
id|message_credits
suffix:semicolon
id|command_packet-&gt;byte8.init_connection.response_queue_pointer
op_assign
l_int|0x0
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initconnection(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Send command packet to the board */
id|outl
c_func
(paren
id|command_que_value
comma
id|TW_COMMAND_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
multiline_comment|/* Poll for completion */
r_if
c_cond
(paren
id|tw_poll_status_gone
c_func
(paren
id|tw_dev
comma
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
comma
l_int|30
)paren
op_eq
l_int|0
)paren
(brace
id|response_queue.value
op_assign
id|inl
c_func
(paren
id|TW_RESPONSE_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|request_id
op_assign
id|TW_RESID_OUT
c_func
(paren
id|response_queue.response_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_id
op_ne
l_int|0
)paren
(brace
multiline_comment|/* unexpected request id */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_initconnection(): Unexpected request id.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command_packet-&gt;status
op_ne
l_int|0
)paren
(brace
multiline_comment|/* bad response */
id|tw_decode_sense
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_initconnection() */
multiline_comment|/* Set a value in the features table */
DECL|function|tw_setfeature
r_static
r_int
id|tw_setfeature
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|parm
comma
r_int
id|param_size
comma
r_int
r_char
op_star
id|val
)paren
(brace
id|TW_Param
op_star
id|param
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Response_Queue
id|response_queue
suffix:semicolon
r_int
id|request_id
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|command_que_value
suffix:semicolon
r_int
r_int
id|param_value
suffix:semicolon
multiline_comment|/* Initialize SetParam command packet */
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_setfeature(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|2
comma
id|TW_OP_SET_PARAM
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
l_int|0x404
suffix:semicolon
multiline_comment|/* Features table */
id|param-&gt;parameter_id
op_assign
id|parm
suffix:semicolon
id|param-&gt;parameter_size_bytes
op_assign
id|param_size
suffix:semicolon
id|memcpy
c_func
(paren
id|param-&gt;data
comma
id|val
comma
id|param_size
)paren
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_setfeature(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_setfeature(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Send command packet to the board */
id|outl
c_func
(paren
id|command_que_value
comma
id|TW_COMMAND_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
multiline_comment|/* Poll for completion */
r_if
c_cond
(paren
id|tw_poll_status_gone
c_func
(paren
id|tw_dev
comma
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
comma
l_int|30
)paren
op_eq
l_int|0
)paren
(brace
id|response_queue.value
op_assign
id|inl
c_func
(paren
id|TW_RESPONSE_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|request_id
op_assign
id|TW_RESID_OUT
c_func
(paren
id|response_queue.response_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_id
op_ne
l_int|0
)paren
(brace
multiline_comment|/* unexpected request id */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_setfeature(): Unexpected request id.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command_packet-&gt;status
op_ne
l_int|0
)paren
(brace
multiline_comment|/* bad response */
id|tw_decode_sense
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_setfeature() */
multiline_comment|/* This function will reset a controller */
DECL|function|tw_reset_sequence
r_static
r_int
id|tw_reset_sequence
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_int
id|tries
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|c
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Reset the board */
r_while
c_loop
(paren
id|tries
OL
id|TW_MAX_RESET_TRIES
)paren
(brace
id|TW_SOFT_RESET
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|error
op_assign
id|tw_aen_drain_queue
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: AEN drain failed, retrying.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Check for controller errors */
r_if
c_cond
(paren
id|tw_check_errors
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Controller errors found, retrying.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Now the controller is in a good state */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tries
op_ge
id|TW_MAX_RESET_TRIES
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Controller errors, card not responding, check all cabling.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|error
op_assign
id|tw_initconnection
c_func
(paren
id|tw_dev
comma
id|TW_INIT_MESSAGE_CREDITS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Connection initialization failed.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|error
op_assign
id|tw_setfeature
c_func
(paren
id|tw_dev
comma
l_int|2
comma
l_int|1
comma
op_amp
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Unable to set features for card, probable old firmware or card.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_reset_sequence() */
multiline_comment|/* This function will initialize the fields of a device extension */
DECL|function|tw_initialize_device_extension
r_static
r_int
id|tw_initialize_device_extension
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_int
id|i
comma
id|error
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_initialize_device_extension()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Initialize command packet buffers */
id|error
op_assign
id|tw_allocate_memory
c_func
(paren
id|tw_dev
comma
r_sizeof
(paren
id|TW_Command
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Command packet memory allocation failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Initialize generic buffer */
id|error
op_assign
id|tw_allocate_memory
c_func
(paren
id|tw_dev
comma
r_sizeof
(paren
id|TW_Sector
)paren
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Generic memory allocation failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_Q_LENGTH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tw_dev-&gt;free_queue
(braket
id|i
)braket
op_assign
id|i
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|i
)braket
op_assign
id|TW_S_INITIAL
suffix:semicolon
)brace
id|tw_dev-&gt;pending_head
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;pending_tail
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;chrdev_request_id
op_assign
id|TW_IOCTL_CHRDEV_FREE
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|tw_dev-&gt;ioctl_sem
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|tw_dev-&gt;ioctl_wqueue
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_initialize_device_extension() */
DECL|function|tw_map_scsi_sg_data
r_static
r_int
id|tw_map_scsi_sg_data
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_int
id|use_sg
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_map_scsi_sg_data()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|use_sg
op_assign
id|pci_map_sg
c_func
(paren
id|pdev
comma
id|cmd-&gt;buffer
comma
id|cmd-&gt;use_sg
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|use_sg
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_map_scsi_sg_data(): pci_map_sg() failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cmd-&gt;SCp.phase
op_assign
id|TW_PHASE_SGLIST
suffix:semicolon
id|cmd-&gt;SCp.have_data_in
op_assign
id|use_sg
suffix:semicolon
r_return
id|use_sg
suffix:semicolon
)brace
multiline_comment|/* End tw_map_scsi_sg_data() */
DECL|function|tw_map_scsi_single_data
r_static
id|u32
id|tw_map_scsi_single_data
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
id|dma_addr_t
id|mapping
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_map_scsi_single_data()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|mapping
op_assign
id|pci_map_page
c_func
(paren
id|pdev
comma
id|virt_to_page
c_func
(paren
id|cmd-&gt;request_buffer
)paren
comma
id|offset_in_page
c_func
(paren
id|cmd-&gt;request_buffer
)paren
comma
id|cmd-&gt;request_bufflen
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mapping
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_map_scsi_single_data(): pci_map_page() failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cmd-&gt;SCp.phase
op_assign
id|TW_PHASE_SINGLE
suffix:semicolon
id|cmd-&gt;SCp.have_data_in
op_assign
id|mapping
suffix:semicolon
r_return
id|mapping
suffix:semicolon
)brace
multiline_comment|/* End tw_map_scsi_single_data() */
DECL|function|tw_unmap_scsi_data
r_static
r_void
id|tw_unmap_scsi_data
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_unmap_scsi_data()&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd-&gt;SCp.phase
)paren
(brace
r_case
id|TW_PHASE_SINGLE
suffix:colon
id|pci_unmap_page
c_func
(paren
id|pdev
comma
id|cmd-&gt;SCp.have_data_in
comma
id|cmd-&gt;request_bufflen
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_PHASE_SGLIST
suffix:colon
id|pci_unmap_sg
c_func
(paren
id|pdev
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;use_sg
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* End tw_unmap_scsi_data() */
multiline_comment|/* This function will reset a device extension */
DECL|function|tw_reset_device_extension
r_static
r_int
id|tw_reset_device_extension
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|ioctl_reset
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|srb
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_reset_device_extension()&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|TW_IN_RESET
comma
op_amp
id|tw_dev-&gt;flags
)paren
suffix:semicolon
id|TW_DISABLE_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|TW_MASK_COMMAND_INTERRUPT
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Abort all requests that are in progress */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_Q_LENGTH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_ne
id|TW_S_FINISHED
)paren
op_logical_and
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_ne
id|TW_S_INITIAL
)paren
op_logical_and
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_ne
id|TW_S_COMPLETED
)paren
)paren
(brace
id|srb
op_assign
id|tw_dev-&gt;srb
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|srb
op_ne
l_int|NULL
)paren
(brace
id|srb-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|i
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|i
)braket
)paren
suffix:semicolon
id|tw_unmap_scsi_data
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|tw_dev-&gt;srb
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Reset queues and counts */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_Q_LENGTH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tw_dev-&gt;free_queue
(braket
id|i
)braket
op_assign
id|i
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|i
)braket
op_assign
id|TW_S_INITIAL
suffix:semicolon
)brace
id|tw_dev-&gt;free_head
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;free_tail
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;pending_request_count
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;pending_head
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;pending_tail
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;reset_print
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_reset_sequence
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Reset sequence failed.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|TW_ENABLE_AND_CLEAR_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Wake up any ioctl that was pending before the reset */
r_if
c_cond
(paren
(paren
id|tw_dev-&gt;chrdev_request_id
op_eq
id|TW_IOCTL_CHRDEV_FREE
)paren
op_logical_or
(paren
id|ioctl_reset
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|TW_IN_RESET
comma
op_amp
id|tw_dev-&gt;flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;chrdev_request_id
op_assign
id|TW_IOCTL_CHRDEV_FREE
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|tw_dev-&gt;ioctl_wqueue
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_reset_device_extension() */
multiline_comment|/* This funciton returns unit geometry in cylinders/heads/sectors */
DECL|function|tw_scsi_biosparam
r_static
r_int
id|tw_scsi_biosparam
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
comma
r_struct
id|block_device
op_star
id|bdev
comma
id|sector_t
id|capacity
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_biosparam()&bslash;n&quot;
)paren
suffix:semicolon
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|sector_div
c_func
(paren
id|capacity
comma
id|heads
op_star
id|sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|capacity
op_ge
l_int|0x200000
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
id|sector_div
c_func
(paren
id|capacity
comma
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_biosparam(): heads = %d, sectors = %d, cylinders = %d&bslash;n&quot;
comma
id|heads
comma
id|sectors
comma
id|cylinders
)paren
suffix:semicolon
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsi_biosparam() */
multiline_comment|/* This is the new scsi eh reset function */
DECL|function|tw_scsi_eh_reset
r_static
r_int
id|tw_scsi_eh_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
)paren
(brace
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
op_assign
id|FAILED
suffix:semicolon
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|tw_dev-&gt;num_resets
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: WARNING: Unit #%d: Command (0x%x) timed out, resetting card.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
comma
id|SCpnt-&gt;device-&gt;id
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Now reset the card and some of the device extension data */
r_if
c_cond
(paren
id|tw_reset_device_extension
c_func
(paren
id|tw_dev
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Reset failed.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|out
suffix:colon
id|spin_lock_irq
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End tw_scsi_eh_reset() */
multiline_comment|/* This function handles scsi inquiry commands */
DECL|function|tw_scsiop_inquiry
r_static
r_int
id|tw_scsiop_inquiry
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Param
op_star
id|param
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
r_int
r_int
id|command_que_value
suffix:semicolon
r_int
r_int
id|param_value
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_inquiry()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Initialize command packet */
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|2
comma
id|TW_OP_GET_PARAM
)paren
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now setup the param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* unit summary table */
id|param-&gt;parameter_id
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* unitsstatus parameter */
id|param-&gt;parameter_size_bytes
op_assign
id|TW_MAX_UNITS
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now try to post the command packet */
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_inquiry() */
multiline_comment|/* This function is called by the isr to complete an inquiry command */
DECL|function|tw_scsiop_inquiry_complete
r_static
r_int
id|tw_scsiop_inquiry_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
r_int
r_char
op_star
id|is_unit_present
suffix:semicolon
r_int
r_char
op_star
id|request_buffer
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_inquiry_complete()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Fill request buffer */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry_complete(): Request buffer NULL.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|request_buffer
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
suffix:semicolon
id|memset
c_func
(paren
id|request_buffer
comma
l_int|0
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
)paren
suffix:semicolon
id|request_buffer
(braket
l_int|0
)braket
op_assign
id|TYPE_DISK
suffix:semicolon
multiline_comment|/* Peripheral device type */
id|request_buffer
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Device type modifier */
id|request_buffer
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No ansi/iso compliance */
id|request_buffer
(braket
l_int|4
)braket
op_assign
l_int|31
suffix:semicolon
multiline_comment|/* Additional length */
id|memcpy
c_func
(paren
op_amp
id|request_buffer
(braket
l_int|8
)braket
comma
l_string|&quot;3ware   &quot;
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Vendor ID */
id|sprintf
c_func
(paren
op_amp
id|request_buffer
(braket
l_int|16
)braket
comma
l_string|&quot;Logical Disk %-2d &quot;
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|device-&gt;id
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|request_buffer
(braket
l_int|32
)braket
comma
id|TW_DRIVER_VERSION
comma
l_int|3
)paren
suffix:semicolon
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_inquiry_complete(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|is_unit_present
op_assign
op_amp
(paren
id|param-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_unit_present
(braket
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|device-&gt;id
)braket
op_amp
id|TW_UNIT_ONLINE
)paren
(brace
id|tw_dev-&gt;is_unit_present
(braket
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|device-&gt;id
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;is_unit_present
(braket
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|device-&gt;id
)braket
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
id|TW_ISR_DONT_RESULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_inquiry_complete() */
multiline_comment|/* This function handles scsi mode_sense commands */
DECL|function|tw_scsiop_mode_sense
r_static
r_int
id|tw_scsiop_mode_sense
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Param
op_star
id|param
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
r_int
r_int
id|command_que_value
suffix:semicolon
r_int
r_int
id|param_value
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_mode_sense()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Only page control = 0, page code = 0x8 (cache page) supported */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|cmnd
(braket
l_int|2
)braket
op_ne
l_int|0x8
)paren
(brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Now read firmware cache setting for this unit */
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_mode_sense(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Setup the command packet */
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|2
comma
id|TW_OP_GET_PARAM
)paren
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Setup the param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_mode_sense(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
id|TW_UNIT_INFORMATION_TABLE_BASE
op_plus
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|device-&gt;id
suffix:semicolon
id|param-&gt;parameter_id
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* unit flags */
id|param-&gt;parameter_size_bytes
op_assign
l_int|1
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_mode_sense(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_mode_sense(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now try to post the command packet */
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_mode_sense() */
multiline_comment|/* This function is called by the isr to complete a mode sense command */
DECL|function|tw_scsiop_mode_sense_complete
r_static
r_int
id|tw_scsiop_mode_sense_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Param
op_star
id|param
suffix:semicolon
r_int
r_char
op_star
id|flags
suffix:semicolon
r_int
r_char
op_star
id|request_buffer
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_mode_sense_complete()&bslash;n&quot;
)paren
suffix:semicolon
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_mode_sense_complete(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|flags
op_assign
(paren
r_char
op_star
)paren
op_amp
(paren
id|param-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|request_buffer
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|buffer
suffix:semicolon
id|memset
c_func
(paren
id|request_buffer
comma
l_int|0
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
)paren
suffix:semicolon
id|request_buffer
(braket
l_int|0
)braket
op_assign
l_int|0xf
suffix:semicolon
multiline_comment|/* mode data length */
id|request_buffer
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default medium type */
id|request_buffer
(braket
l_int|2
)braket
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* dpo/fua support on */
id|request_buffer
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no block descriptors */
id|request_buffer
(braket
l_int|4
)braket
op_assign
l_int|0x8
suffix:semicolon
multiline_comment|/* caching page */
id|request_buffer
(braket
l_int|5
)braket
op_assign
l_int|0xa
suffix:semicolon
multiline_comment|/* page length */
r_if
c_cond
(paren
op_star
id|flags
op_amp
l_int|0x1
)paren
id|request_buffer
(braket
l_int|6
)braket
op_assign
l_int|0x4
suffix:semicolon
multiline_comment|/* WCE on */
r_else
id|request_buffer
(braket
l_int|6
)braket
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* WCE off */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_mode_sense_complete() */
multiline_comment|/* This function handles scsi read_capacity commands */
DECL|function|tw_scsiop_read_capacity
r_static
r_int
id|tw_scsiop_read_capacity
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Param
op_star
id|param
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
r_int
r_int
id|command_que_value
suffix:semicolon
r_int
r_int
id|param_value
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Initialize command packet */
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|2
comma
id|TW_OP_GET_PARAM
)paren
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;unit__hostid
op_assign
id|TW_UNITHOST_IN
c_func
(paren
l_int|0
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|device-&gt;id
)paren
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.block_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now setup the param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
id|TW_UNIT_INFORMATION_TABLE_BASE
op_plus
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|device-&gt;id
suffix:semicolon
id|param-&gt;parameter_id
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* unitcapacity parameter */
id|param-&gt;parameter_size_bytes
op_assign
l_int|4
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now try to post the command to the board */
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_read_capacity() */
multiline_comment|/* This function is called by the isr to complete a readcapacity command */
DECL|function|tw_scsiop_read_capacity_complete
r_static
r_int
id|tw_scsiop_read_capacity_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
r_int
r_char
op_star
id|param_data
suffix:semicolon
id|u32
id|capacity
suffix:semicolon
r_char
op_star
id|buff
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity_complete()&bslash;n&quot;
)paren
suffix:semicolon
id|buff
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
suffix:semicolon
r_if
c_cond
(paren
id|buff
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity_complete(): Request buffer NULL.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
)paren
suffix:semicolon
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity_complete(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param_data
op_assign
op_amp
(paren
id|param-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|capacity
op_assign
(paren
id|param_data
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|param_data
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|param_data
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|param_data
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Subtract one sector to fix get last sector ioctl */
id|capacity
op_sub_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_capacity_complete(): Capacity = 0x%x.&bslash;n&quot;
comma
id|capacity
)paren
suffix:semicolon
multiline_comment|/* Number of LBA&squot;s */
id|buff
(braket
l_int|0
)braket
op_assign
(paren
id|capacity
op_rshift
l_int|24
)paren
suffix:semicolon
id|buff
(braket
l_int|1
)braket
op_assign
(paren
id|capacity
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|2
)braket
op_assign
(paren
id|capacity
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|3
)braket
op_assign
id|capacity
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* Block size in bytes (512) */
id|buff
(braket
l_int|4
)braket
op_assign
(paren
id|TW_BLOCK_SIZE
op_rshift
l_int|24
)paren
suffix:semicolon
id|buff
(braket
l_int|5
)braket
op_assign
(paren
id|TW_BLOCK_SIZE
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|6
)braket
op_assign
(paren
id|TW_BLOCK_SIZE
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|7
)braket
op_assign
id|TW_BLOCK_SIZE
op_amp
l_int|0xff
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_read_capacity_complete() */
multiline_comment|/* This function handles scsi read or write commands */
DECL|function|tw_scsiop_read_write
r_static
r_int
id|tw_scsiop_read_write
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Command
op_star
id|command_packet
suffix:semicolon
r_int
r_int
id|command_que_value
suffix:semicolon
id|u32
id|lba
op_assign
l_int|0x0
comma
id|num_sectors
op_assign
l_int|0x0
comma
id|buffaddr
op_assign
l_int|0x0
suffix:semicolon
r_int
id|i
comma
id|use_sg
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|srb
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sglist
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_write()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_read_write(): Request buffer NULL.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|sglist
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
suffix:semicolon
id|srb
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
suffix:semicolon
multiline_comment|/* Initialize command packet */
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_write(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
op_logical_or
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_10
)paren
(brace
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|3
comma
id|TW_OP_READ
)paren
suffix:semicolon
)brace
r_else
(brace
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|3
comma
id|TW_OP_WRITE
)paren
suffix:semicolon
)brace
id|command_packet-&gt;size
op_assign
l_int|3
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;unit__hostid
op_assign
id|TW_UNITHOST_IN
c_func
(paren
l_int|0
comma
id|srb-&gt;device-&gt;id
)paren
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_10
)paren
(brace
r_if
c_cond
(paren
(paren
id|srb-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x8
)paren
op_logical_or
(paren
id|srb-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x10
)paren
)paren
id|command_packet-&gt;flags
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
op_logical_or
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
(brace
id|lba
op_assign
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|3
)braket
suffix:semicolon
id|num_sectors
op_assign
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_else
(brace
id|lba
op_assign
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|5
)braket
suffix:semicolon
id|num_sectors
op_assign
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|8
)braket
op_or
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/* Update sector statistic */
id|tw_dev-&gt;sector_count
op_assign
id|num_sectors
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;sector_count
OG
id|tw_dev-&gt;max_sector_count
)paren
id|tw_dev-&gt;max_sector_count
op_assign
id|tw_dev-&gt;sector_count
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_write(): lba = 0x%x num_sectors = 0x%x&bslash;n&quot;
comma
id|lba
comma
id|num_sectors
)paren
suffix:semicolon
id|command_packet-&gt;byte8.io.lba
op_assign
id|lba
suffix:semicolon
id|command_packet-&gt;byte6.block_count
op_assign
id|num_sectors
suffix:semicolon
multiline_comment|/* Do this if there are no sg list entries */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_read_write(): SG = 0&bslash;n&quot;
)paren
suffix:semicolon
id|buffaddr
op_assign
id|tw_map_scsi_single_data
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffaddr
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|command_packet-&gt;byte8.io.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|buffaddr
suffix:semicolon
id|command_packet-&gt;byte8.io.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
suffix:semicolon
id|command_packet-&gt;size
op_add_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Do this if we have multiple sg list entries */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
OG
l_int|0
)paren
(brace
id|use_sg
op_assign
id|tw_map_scsi_sg_data
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|use_sg
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|command_packet-&gt;byte8.io.sgl
(braket
id|i
)braket
dot
id|address
op_assign
id|sg_dma_address
c_func
(paren
op_amp
id|sglist
(braket
id|i
)braket
)paren
suffix:semicolon
id|command_packet-&gt;byte8.io.sgl
(braket
id|i
)braket
dot
id|length
op_assign
id|sg_dma_len
c_func
(paren
op_amp
id|sglist
(braket
id|i
)braket
)paren
suffix:semicolon
id|command_packet-&gt;size
op_add_assign
l_int|2
suffix:semicolon
)brace
)brace
multiline_comment|/* Update SG statistics */
id|tw_dev-&gt;sgl_entries
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;sgl_entries
OG
id|tw_dev-&gt;max_sgl_entries
)paren
id|tw_dev-&gt;max_sgl_entries
op_assign
id|tw_dev-&gt;sgl_entries
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_read_write(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now try to post the command to the board */
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_read_write() */
multiline_comment|/* This function will handle the request sense scsi command */
DECL|function|tw_scsiop_request_sense
r_static
r_int
id|tw_scsiop_request_sense
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_request_sense()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* For now we just zero the request buffer */
id|memset
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
comma
l_int|0
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
multiline_comment|/* If we got a request_sense, we probably want a reset, return error */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_request_sense() */
multiline_comment|/* This function will handle synchronize cache scsi command */
DECL|function|tw_scsiop_synchronize_cache
r_static
r_int
id|tw_scsiop_synchronize_cache
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Command
op_star
id|command_packet
suffix:semicolon
r_int
r_int
id|command_que_value
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_synchronize_cache()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Send firmware flush command for this unit */
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_synchronize_cache(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Setup the command packet */
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|0
comma
id|TW_OP_FLUSH_CACHE
)paren
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|2
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;unit__hostid
op_assign
id|TW_UNITHOST_IN
c_func
(paren
l_int|0
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|device-&gt;id
)paren
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_synchronize_cache(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now try to post the command packet */
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_synchronize_cache() */
multiline_comment|/* This function will handle test unit ready scsi command */
DECL|function|tw_scsiop_test_unit_ready
r_static
r_int
id|tw_scsiop_test_unit_ready
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Param
op_star
id|param
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
r_int
r_int
id|command_que_value
suffix:semicolon
r_int
r_int
id|param_value
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsiop_test_unit_ready()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Initialize command packet */
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_packet
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_test_unit_ready(): Bad command packet virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|2
comma
id|TW_OP_GET_PARAM
)paren
suffix:semicolon
id|command_packet-&gt;size
op_assign
l_int|4
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;byte6.parameter_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now setup the param */
r_if
c_cond
(paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_test_unit_ready(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Sector
)paren
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* unit summary table */
id|param-&gt;parameter_id
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* unitsstatus parameter */
id|param-&gt;parameter_size_bytes
op_assign
id|TW_MAX_UNITS
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;alignment_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_test_unit_ready(): Bad alignment physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|TW_Sector
)paren
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_physical_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|command_que_value
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_test_unit_ready(): Bad command packet physical address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now try to post the command packet */
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_test_unit_ready() */
multiline_comment|/* This function is called by the isr to complete a testunitready command */
DECL|function|tw_scsiop_test_unit_ready_complete
r_static
r_int
id|tw_scsiop_test_unit_ready_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
r_int
r_char
op_star
id|is_unit_present
suffix:semicolon
id|TW_Param
op_star
id|param
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_test_unit_ready_complete()&bslash;n&quot;
)paren
suffix:semicolon
id|param
op_assign
(paren
id|TW_Param
op_star
)paren
id|tw_dev-&gt;alignment_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|param
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_scsiop_test_unit_ready_complete(): Bad alignment virtual address.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|is_unit_present
op_assign
op_amp
(paren
id|param-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_unit_present
(braket
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|device-&gt;id
)braket
op_amp
id|TW_UNIT_ONLINE
)paren
(brace
id|tw_dev-&gt;is_unit_present
(braket
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|device-&gt;id
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;is_unit_present
(braket
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|device-&gt;id
)braket
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
r_return
id|TW_ISR_DONT_RESULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End tw_scsiop_test_unit_ready_complete() */
multiline_comment|/* This is the main scsi queue function to handle scsi opcodes */
DECL|function|tw_scsi_queue
r_static
r_int
id|tw_scsi_queue
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
r_int
r_char
op_star
id|command
op_assign
id|SCpnt-&gt;cmnd
suffix:semicolon
r_int
id|request_id
op_assign
l_int|0
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
multiline_comment|/* Save done function into Scsi_Cmnd struct */
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
multiline_comment|/* Queue the command and get a request id */
id|tw_state_request_start
c_func
(paren
id|tw_dev
comma
op_amp
id|request_id
)paren
suffix:semicolon
multiline_comment|/* Save the scsi command for use by the ISR */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_assign
id|SCpnt
suffix:semicolon
multiline_comment|/* Initialize phase to zero */
id|SCpnt-&gt;SCp.phase
op_assign
id|TW_PHASE_INITIAL
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|command
)paren
(brace
r_case
id|READ_10
suffix:colon
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_6
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught READ/WRITE.&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|tw_scsiop_read_write
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught TEST_UNIT_READY.&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|tw_scsiop_test_unit_ready
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught INQUIRY.&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|tw_scsiop_inquiry
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught READ_CAPACITY.&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|tw_scsiop_read_capacity
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQUEST_SENSE
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught REQUEST_SENSE.&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|tw_scsiop_request_sense
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught MODE_SENSE.&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|tw_scsiop_mode_sense
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNCHRONIZE_CACHE
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_scsi_queue(): caught SYNCHRONIZE_CACHE.&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|tw_scsiop_synchronize_cache
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_IOCTL
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: SCSI_IOCTL_SEND_COMMAND deprecated, please update your 3ware tools.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: scsi%d: Unknown scsi opcode: 0x%x&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
comma
op_star
id|command
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retval
)paren
(brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End tw_scsi_queue() */
multiline_comment|/* This function is the interrupt service routine */
DECL|function|tw_interrupt
r_static
id|irqreturn_t
id|tw_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|request_id
suffix:semicolon
id|u32
id|status_reg_value
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|dev_instance
suffix:semicolon
id|TW_Response_Queue
id|response_que
suffix:semicolon
r_int
id|error
op_assign
l_int|0
comma
id|retval
op_assign
l_int|0
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Get the host lock for io completions */
id|spin_lock
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/* See if the interrupt matches this instance */
r_if
c_cond
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;irq
op_eq
(paren
r_int
r_int
)paren
id|irq
)paren
(brace
id|handled
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Read the registers */
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
multiline_comment|/* Check if this is our interrupt, otherwise bail */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status_reg_value
op_amp
id|TW_STATUS_VALID_INTERRUPT
)paren
)paren
r_goto
id|tw_interrupt_bail
suffix:semicolon
multiline_comment|/* Check controller for errors */
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
comma
l_int|1
)paren
)paren
(brace
id|TW_CLEAR_ALL_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_goto
id|tw_interrupt_bail
suffix:semicolon
)brace
)brace
multiline_comment|/* Handle host interrupt */
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_HOST_INTERRUPT
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): Received host interrupt.&bslash;n&quot;
)paren
suffix:semicolon
id|TW_CLEAR_HOST_INTERRUPT
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle attention interrupt */
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_ATTENTION_INTERRUPT
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): Received attention interrupt.&bslash;n&quot;
)paren
suffix:semicolon
id|TW_CLEAR_ATTENTION_INTERRUPT
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|tw_state_request_start
c_func
(paren
id|tw_dev
comma
op_amp
id|request_id
)paren
suffix:semicolon
id|error
op_assign
id|tw_aen_read_queue
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Error reading aen queue.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Handle command interrupt */
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_COMMAND_INTERRUPT
)paren
(brace
multiline_comment|/* Drain as many pending commands as we can */
r_while
c_loop
(paren
id|tw_dev-&gt;pending_request_count
OG
l_int|0
)paren
(brace
id|request_id
op_assign
id|tw_dev-&gt;pending_queue
(braket
id|tw_dev-&gt;pending_head
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_ne
id|TW_S_PENDING
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Found request id that wasn&squot;t pending.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tw_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;pending_head
op_eq
id|TW_Q_LENGTH
op_minus
l_int|1
)paren
(brace
id|tw_dev-&gt;pending_head
op_assign
id|TW_Q_START
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;pending_head
op_assign
id|tw_dev-&gt;pending_head
op_plus
l_int|1
suffix:semicolon
)brace
id|tw_dev-&gt;pending_request_count
op_decrement
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If we get here, we will continue re-posting on the next command interrupt */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* If there are no more pending requests, we mask command interrupt */
r_if
c_cond
(paren
id|tw_dev-&gt;pending_request_count
op_eq
l_int|0
)paren
id|TW_MASK_COMMAND_INTERRUPT
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle response interrupt */
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_INTERRUPT
)paren
(brace
multiline_comment|/* Drain the response queue from the board */
r_while
c_loop
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Read response queue register */
id|response_que.value
op_assign
id|inl
c_func
(paren
id|TW_RESPONSE_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|request_id
op_assign
id|TW_RESID_OUT
c_func
(paren
id|response_que.response_id
)paren
suffix:semicolon
id|command_packet
op_assign
(paren
id|TW_Command
op_star
)paren
id|tw_dev-&gt;command_packet_virtual_address
(braket
id|request_id
)braket
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check for bad response */
r_if
c_cond
(paren
id|command_packet-&gt;status
op_ne
l_int|0
)paren
(brace
multiline_comment|/* If internal command, don&squot;t error, don&squot;t fill sense */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|tw_decode_sense
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|error
op_assign
id|tw_decode_sense
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Check for correct state */
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_ne
id|TW_S_POSTED
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Received a request id that wasn&squot;t posted.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|error
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): Response queue request id: %d.&bslash;n&quot;
comma
id|request_id
)paren
suffix:semicolon
multiline_comment|/* Check for internal command completion */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Found internally posted command.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Check for chrdev ioctl completion */
r_if
c_cond
(paren
id|request_id
op_ne
id|tw_dev-&gt;chrdev_request_id
)paren
(brace
id|retval
op_assign
id|tw_aen_complete
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Error completing aen.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|tw_dev-&gt;chrdev_request_id
op_assign
id|TW_IOCTL_CHRDEV_FREE
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|tw_dev-&gt;ioctl_wqueue
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|READ_10
suffix:colon
r_case
id|READ_6
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught READ_10/READ_6&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_6
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught WRITE_10/WRITE_6&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught TEST_UNIT_READY&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_scsiop_test_unit_ready_complete
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught INQUIRY&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_scsiop_inquiry_complete
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught READ_CAPACITY&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_scsiop_read_capacity_complete
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught MODE_SENSE&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|tw_scsiop_mode_sense_complete
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYNCHRONIZE_CACHE
suffix:colon
id|dprintk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;3w-xxxx: tw_interrupt(): caught SYNCHRONIZE_CACHE&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: case slip in tw_interrupt()&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* If no error command was a success */
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/* If error, command failed */
r_if
c_cond
(paren
id|error
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Ask for a host reset */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Now complete the io */
r_if
c_cond
(paren
(paren
id|error
op_ne
id|TW_ISR_DONT_COMPLETE
)paren
)paren
(brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|tw_state_request_finish
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
id|tw_unmap_scsi_data
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Check for valid status after each drain */
id|status_reg_value
op_assign
id|inl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: tw_interrupt(): Unexpected bits.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
comma
l_int|1
)paren
)paren
(brace
id|TW_CLEAR_ALL_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_goto
id|tw_interrupt_bail
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
id|tw_interrupt_bail
suffix:colon
id|spin_unlock
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_interrupt() */
multiline_comment|/* This function tells the controller to shut down */
DECL|function|__tw_shutdown
r_static
r_void
id|__tw_shutdown
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
multiline_comment|/* Disable interrupts */
id|TW_DISABLE_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Shutting down host %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
multiline_comment|/* Tell the card we are shutting down */
r_if
c_cond
(paren
id|tw_initconnection
c_func
(paren
id|tw_dev
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Connection shutdown failed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Shutdown complete.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear all interrupts just before exit */
id|TW_ENABLE_AND_CLEAR_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
)brace
multiline_comment|/* End __tw_shutdown() */
multiline_comment|/* Wrapper for __tw_shutdown */
DECL|function|tw_shutdown
r_static
r_void
id|tw_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|pci_get_drvdata
c_func
(paren
id|to_pci_dev
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|__tw_shutdown
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_shutdown() */
DECL|variable|driver_template
r_static
r_struct
id|scsi_host_template
id|driver_template
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;3ware Storage Controller&quot;
comma
dot
id|queuecommand
op_assign
id|tw_scsi_queue
comma
dot
id|eh_host_reset_handler
op_assign
id|tw_scsi_eh_reset
comma
dot
id|bios_param
op_assign
id|tw_scsi_biosparam
comma
dot
id|can_queue
op_assign
id|TW_Q_LENGTH
op_minus
l_int|2
comma
dot
id|this_id
op_assign
op_minus
l_int|1
comma
dot
id|sg_tablesize
op_assign
id|TW_MAX_SGL_LENGTH
comma
dot
id|max_sectors
op_assign
id|TW_MAX_SECTORS
comma
dot
id|cmd_per_lun
op_assign
id|TW_MAX_CMDS_PER_LUN
comma
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
dot
id|shost_attrs
op_assign
id|tw_host_attrs
comma
dot
id|sdev_attrs
op_assign
id|tw_dev_attrs
comma
dot
id|emulated
op_assign
l_int|1
)brace
suffix:semicolon
multiline_comment|/* This function will probe and initialize a card */
DECL|function|tw_probe
r_static
r_int
id|__devinit
id|tw_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|dev_id
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
l_int|NULL
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|retval
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Failed to enable pci device.&quot;
)paren
suffix:semicolon
r_goto
id|out_disable_device
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|retval
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|TW_DMA_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Failed to set dma mask.&quot;
)paren
suffix:semicolon
r_goto
id|out_disable_device
suffix:semicolon
)brace
id|host
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|driver_template
comma
r_sizeof
(paren
id|TW_Device_Extension
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Failed to allocate memory for device extension.&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_disable_device
suffix:semicolon
)brace
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|memset
c_func
(paren
id|tw_dev
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Device_Extension
)paren
)paren
suffix:semicolon
multiline_comment|/* Save values to device extension */
id|tw_dev-&gt;host
op_assign
id|host
suffix:semicolon
id|tw_dev-&gt;tw_pci_dev
op_assign
id|pdev
suffix:semicolon
r_if
c_cond
(paren
id|tw_initialize_device_extension
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Failed to initialize device extension.&quot;
)paren
suffix:semicolon
r_goto
id|out_free_device_extension
suffix:semicolon
)brace
multiline_comment|/* Request IO regions */
id|retval
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
l_string|&quot;3w-xxxx&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Failed to get mem region.&quot;
)paren
suffix:semicolon
r_goto
id|out_free_device_extension
suffix:semicolon
)brace
multiline_comment|/* Save base address */
id|tw_dev-&gt;base_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tw_dev-&gt;base_addr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Failed to get io address.&quot;
)paren
suffix:semicolon
r_goto
id|out_release_mem_region
suffix:semicolon
)brace
multiline_comment|/* Disable interrupts on the card */
id|TW_DISABLE_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Initialize the card */
r_if
c_cond
(paren
id|tw_reset_sequence
c_func
(paren
id|tw_dev
)paren
)paren
r_goto
id|out_release_mem_region
suffix:semicolon
multiline_comment|/* Set host specific parameters */
id|host-&gt;max_id
op_assign
id|TW_MAX_UNITS
suffix:semicolon
id|host-&gt;max_cmd_len
op_assign
id|TW_MAX_CDB_LEN
suffix:semicolon
multiline_comment|/* Luns and channels aren&squot;t supported by adapter */
id|host-&gt;max_lun
op_assign
l_int|0
suffix:semicolon
id|host-&gt;max_channel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Register the card with the kernel SCSI layer */
id|retval
op_assign
id|scsi_add_host
c_func
(paren
id|host
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi add host failed&quot;
)paren
suffix:semicolon
r_goto
id|out_release_mem_region
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|host
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: scsi%d: Found a 3ware Storage Controller at 0x%x, IRQ: %d.&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|tw_dev-&gt;base_addr
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Now setup the interrupt handler */
id|retval
op_assign
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|tw_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;3w-xxxx&quot;
comma
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Error requesting IRQ.&quot;
)paren
suffix:semicolon
r_goto
id|out_remove_host
suffix:semicolon
)brace
id|tw_device_extension_list
(braket
id|tw_device_extension_count
)braket
op_assign
id|tw_dev
suffix:semicolon
id|tw_device_extension_count
op_increment
suffix:semicolon
multiline_comment|/* Re-enable interrupts on the card */
id|TW_ENABLE_AND_CLEAR_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Finally, scan the host */
id|scsi_scan_host
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|twe_major
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|twe_major
op_assign
id|register_chrdev
(paren
l_int|0
comma
l_string|&quot;twe&quot;
comma
op_amp
id|tw_fops
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-xxxx: Failed to register character device.&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_remove_host
suffix:colon
id|scsi_remove_host
c_func
(paren
id|host
)paren
suffix:semicolon
id|out_release_mem_region
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|out_free_device_extension
suffix:colon
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|host
)paren
suffix:semicolon
id|out_disable_device
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End tw_probe() */
multiline_comment|/* This function is called to remove a device */
DECL|function|tw_remove
r_static
r_void
id|tw_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|scsi_remove_host
c_func
(paren
id|tw_dev-&gt;host
)paren
suffix:semicolon
id|__tw_shutdown
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Free up the IRQ */
id|free_irq
c_func
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;irq
comma
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Free up the mem region */
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* Free up device extension resources */
id|tw_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Unregister character device */
r_if
c_cond
(paren
id|twe_major
op_ge
l_int|0
)paren
(brace
id|unregister_chrdev
c_func
(paren
id|twe_major
comma
l_string|&quot;twe&quot;
)paren
suffix:semicolon
id|twe_major
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|scsi_host_put
c_func
(paren
id|tw_dev-&gt;host
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|tw_device_extension_count
op_decrement
suffix:semicolon
)brace
multiline_comment|/* End tw_remove() */
multiline_comment|/* PCI Devices supported by this driver */
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|tw_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_3WARE
comma
id|PCI_DEVICE_ID_3WARE_1000
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_3WARE
comma
id|PCI_DEVICE_ID_3WARE_7000
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|tw_pci_tbl
)paren
suffix:semicolon
multiline_comment|/* pci_driver initializer */
DECL|variable|tw_driver
r_static
r_struct
id|pci_driver
id|tw_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;3w-xxxx&quot;
comma
dot
id|id_table
op_assign
id|tw_pci_tbl
comma
dot
id|probe
op_assign
id|tw_probe
comma
dot
id|remove
op_assign
id|tw_remove
comma
dot
id|driver
op_assign
(brace
dot
id|shutdown
op_assign
id|tw_shutdown
)brace
)brace
suffix:semicolon
multiline_comment|/* This function is called on driver initialization */
DECL|function|tw_init
r_static
r_int
id|__init
id|tw_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3ware Storage Controller device driver for Linux v%s.&bslash;n&quot;
comma
id|TW_DRIVER_VERSION
)paren
suffix:semicolon
r_return
id|pci_module_init
c_func
(paren
op_amp
id|tw_driver
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_init() */
multiline_comment|/* This function is called on driver exit */
DECL|function|tw_exit
r_static
r_void
id|__exit
id|tw_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|tw_driver
)paren
suffix:semicolon
)brace
multiline_comment|/* End tw_exit() */
DECL|variable|tw_init
id|module_init
c_func
(paren
id|tw_init
)paren
suffix:semicolon
DECL|variable|tw_exit
id|module_exit
c_func
(paren
id|tw_exit
)paren
suffix:semicolon
eof
