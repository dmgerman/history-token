multiline_comment|/* -*- mode: c; c-basic-offset: 8 -*- */
multiline_comment|/* NCR (or Symbios) 53c700 and 53c700-66 Driver&n; *&n; * Copyright (C) 2001 by James.Bottomley@HansenPartnership.com&n;**-----------------------------------------------------------------------------&n;**  &n;**  This program is free software; you can redistribute it and/or modify&n;**  it under the terms of the GNU General Public License as published by&n;**  the Free Software Foundation; either version 2 of the License, or&n;**  (at your option) any later version.&n;**&n;**  This program is distributed in the hope that it will be useful,&n;**  but WITHOUT ANY WARRANTY; without even the implied warranty of&n;**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;**  GNU General Public License for more details.&n;**&n;**  You should have received a copy of the GNU General Public License&n;**  along with this program; if not, write to the Free Software&n;**  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;**&n;**-----------------------------------------------------------------------------&n; */
multiline_comment|/* Notes:&n; *&n; * This driver is designed exclusively for these chips (virtually the&n; * earliest of the scripts engine chips).  They need their own drivers&n; * because they are missing so many of the scripts and snazzy register&n; * features of their elder brothers (the 710, 720 and 770).&n; *&n; * The 700 is the lowliest of the line, it can only do async SCSI.&n; * The 700-66 can at least do synchronous SCSI up to 10MHz.&n; * &n; * The 700 chip has no host bus interface logic of its own.  However,&n; * it is usually mapped to a location with well defined register&n; * offsets.  Therefore, if you can determine the base address and the&n; * irq your board incorporating this chip uses, you can probably use&n; * this driver to run it (although you&squot;ll probably have to write a&n; * minimal wrapper for the purpose---see the NCR_D700 driver for&n; * details about how to do this).&n; *&n; *&n; * TODO List:&n; *&n; * 1. Better statistics in the proc fs&n; *&n; * 2. Implement message queue (queues SCSI messages like commands) and make&n; *    the abort and device reset functions use them.&n; * */
multiline_comment|/* CHANGELOG&n; *&n; * Version 2.6&n; *&n; * Following test of the 64 bit parisc kernel by Richard Hirst,&n; * several problems have now been corrected.  Also adds support for&n; * consistent memory allocation.&n; *&n; * Version 2.5&n; * &n; * More Compatibility changes for 710 (now actually works).  Enhanced&n; * support for odd clock speeds which constrain SDTR negotiations.&n; * correct cacheline separation for scsi messages and status for&n; * incoherent architectures.  Use of the pci mapping functions on&n; * buffers to begin support for 64 bit drivers.&n; *&n; * Version 2.4&n; *&n; * Added support for the 53c710 chip (in 53c700 emulation mode only---no &n; * special 53c710 instructions or registers are used).&n; *&n; * Version 2.3&n; *&n; * More endianness/cache coherency changes.&n; *&n; * Better bad device handling (handles devices lying about tag&n; * queueing support and devices which fail to provide sense data on&n; * contingent allegiance conditions)&n; *&n; * Many thanks to Richard Hirst &lt;rhirst@linuxcare.com&gt; for patiently&n; * debugging this driver on the parisc architecture and suggesting&n; * many improvements and bug fixes.&n; *&n; * Thanks also go to Linuxcare Inc. for providing several PARISC&n; * machines for me to debug the driver on.&n; *&n; * Version 2.2&n; *&n; * Made the driver mem or io mapped; added endian invariance; added&n; * dma cache flushing operations for architectures which need it;&n; * added support for more varied clocking speeds.&n; *&n; * Version 2.1&n; *&n; * Initial modularisation from the D700.  See NCR_D700.c for the rest of&n; * the changelog.&n; * */
DECL|macro|NCR_700_VERSION
mdefine_line|#define NCR_700_VERSION &quot;2.6&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mca.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;constants.h&quot;
macro_line|#include &quot;53c700.h&quot;
multiline_comment|/* NOTE: For 64 bit drivers there are points in the code where we use&n; * a non dereferenceable pointer to point to a structure in dma-able&n; * memory (which is 32 bits) so that we can use all of the structure&n; * operations but take the address at the end.  This macro allows us&n; * to truncate the 64 bit pointer down to 32 bits without the compiler&n; * complaining */
DECL|macro|to32bit
mdefine_line|#define to32bit(x)&t;((__u32)((unsigned long)(x)))
macro_line|#ifdef NCR_700_DEBUG
DECL|macro|STATIC
mdefine_line|#define STATIC
macro_line|#else
DECL|macro|STATIC
mdefine_line|#define STATIC static
macro_line|#endif
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;James Bottomley&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;53c700 and 53c700-66 Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* This is the script */
macro_line|#include &quot;53c700_d.h&quot;
id|STATIC
r_int
id|NCR_700_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
suffix:semicolon
id|STATIC
r_int
id|NCR_700_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
suffix:semicolon
id|STATIC
r_int
id|NCR_700_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
suffix:semicolon
id|STATIC
r_int
id|NCR_700_dev_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
suffix:semicolon
id|STATIC
r_int
id|NCR_700_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
suffix:semicolon
id|STATIC
r_int
id|NCR_700_proc_directory_info
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
id|STATIC
r_void
id|NCR_700_chip_setup
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
suffix:semicolon
id|STATIC
r_void
id|NCR_700_chip_reset
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
suffix:semicolon
DECL|variable|NCR_700_phase
r_static
r_char
op_star
id|NCR_700_phase
(braket
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
l_string|&quot;after selection&quot;
comma
l_string|&quot;before command phase&quot;
comma
l_string|&quot;after command phase&quot;
comma
l_string|&quot;after status phase&quot;
comma
l_string|&quot;after data in phase&quot;
comma
l_string|&quot;after data out phase&quot;
comma
l_string|&quot;during data phase&quot;
comma
)brace
suffix:semicolon
DECL|variable|NCR_700_condition
r_static
r_char
op_star
id|NCR_700_condition
(braket
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
l_string|&quot;NOT MSG_OUT&quot;
comma
l_string|&quot;UNEXPECTED PHASE&quot;
comma
l_string|&quot;NOT MSG_IN&quot;
comma
l_string|&quot;UNEXPECTED MSG&quot;
comma
l_string|&quot;MSG_IN&quot;
comma
l_string|&quot;SDTR_MSG RECEIVED&quot;
comma
l_string|&quot;REJECT_MSG RECEIVED&quot;
comma
l_string|&quot;DISCONNECT_MSG RECEIVED&quot;
comma
l_string|&quot;MSG_OUT&quot;
comma
l_string|&quot;DATA_IN&quot;
comma
)brace
suffix:semicolon
DECL|variable|NCR_700_fatal_messages
r_static
r_char
op_star
id|NCR_700_fatal_messages
(braket
)braket
op_assign
(brace
l_string|&quot;unexpected message after reselection&quot;
comma
l_string|&quot;still MSG_OUT after message injection&quot;
comma
l_string|&quot;not MSG_IN after selection&quot;
comma
l_string|&quot;Illegal message length received&quot;
comma
)brace
suffix:semicolon
DECL|variable|NCR_700_SBCL_bits
r_static
r_char
op_star
id|NCR_700_SBCL_bits
(braket
)braket
op_assign
(brace
l_string|&quot;IO &quot;
comma
l_string|&quot;CD &quot;
comma
l_string|&quot;MSG &quot;
comma
l_string|&quot;ATN &quot;
comma
l_string|&quot;SEL &quot;
comma
l_string|&quot;BSY &quot;
comma
l_string|&quot;ACK &quot;
comma
l_string|&quot;REQ &quot;
comma
)brace
suffix:semicolon
DECL|variable|NCR_700_SBCL_to_phase
r_static
r_char
op_star
id|NCR_700_SBCL_to_phase
(braket
)braket
op_assign
(brace
l_string|&quot;DATA_OUT&quot;
comma
l_string|&quot;DATA_IN&quot;
comma
l_string|&quot;CMD_OUT&quot;
comma
l_string|&quot;STATE&quot;
comma
l_string|&quot;ILLEGAL PHASE&quot;
comma
l_string|&quot;ILLEGAL PHASE&quot;
comma
l_string|&quot;MSG OUT&quot;
comma
l_string|&quot;MSG IN&quot;
comma
)brace
suffix:semicolon
DECL|variable|NCR_700_SDTR_msg
r_static
id|__u8
id|NCR_700_SDTR_msg
(braket
)braket
op_assign
(brace
l_int|0x01
comma
multiline_comment|/* Extended message */
l_int|0x03
comma
multiline_comment|/* Extended message Length */
l_int|0x01
comma
multiline_comment|/* SDTR Extended message */
id|NCR_700_MIN_PERIOD
comma
id|NCR_700_MAX_OFFSET
)brace
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|__init
DECL|function|NCR_700_detect
id|NCR_700_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
comma
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
)paren
(brace
id|dma_addr_t
id|pScript
comma
id|pMemory
comma
id|pSlots
suffix:semicolon
id|__u8
op_star
id|memory
suffix:semicolon
id|__u32
op_star
id|script
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_static
r_int
id|banner
op_assign
l_int|0
suffix:semicolon
r_int
id|j
suffix:semicolon
macro_line|#ifdef CONFIG_53C700_USE_CONSISTENT
id|memory
op_assign
id|pci_alloc_consistent
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|TOTAL_MEM_SIZE
comma
op_amp
id|pMemory
)paren
suffix:semicolon
id|hostdata-&gt;consistent
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|memory
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;53c700: consistent memory allocation failed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memory
op_assign
id|kmalloc
c_func
(paren
id|TOTAL_MEM_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memory
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;53c700: Failed to allocate memory for driver, detatching&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|pMemory
op_assign
id|pci_map_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|memory
comma
id|TOTAL_MEM_SIZE
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_53C700_USE_CONSISTENT
id|hostdata-&gt;consistent
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|script
op_assign
(paren
id|__u32
op_star
)paren
id|memory
suffix:semicolon
id|pScript
op_assign
id|pMemory
suffix:semicolon
id|hostdata-&gt;msgin
op_assign
id|memory
op_plus
id|MSGIN_OFFSET
suffix:semicolon
id|hostdata-&gt;msgout
op_assign
id|memory
op_plus
id|MSGOUT_OFFSET
suffix:semicolon
id|hostdata-&gt;status
op_assign
id|memory
op_plus
id|STATUS_OFFSET
suffix:semicolon
id|hostdata-&gt;slots
op_assign
(paren
r_struct
id|NCR_700_command_slot
op_star
)paren
(paren
id|memory
op_plus
id|SLOTS_OFFSET
)paren
suffix:semicolon
id|pSlots
op_assign
id|pMemory
op_plus
id|SLOTS_OFFSET
suffix:semicolon
multiline_comment|/* Fill in the missing routines from the host template */
id|tpnt-&gt;queuecommand
op_assign
id|NCR_700_queuecommand
suffix:semicolon
id|tpnt-&gt;eh_abort_handler
op_assign
id|NCR_700_abort
suffix:semicolon
id|tpnt-&gt;eh_device_reset_handler
op_assign
id|NCR_700_dev_reset
suffix:semicolon
id|tpnt-&gt;eh_bus_reset_handler
op_assign
id|NCR_700_bus_reset
suffix:semicolon
id|tpnt-&gt;eh_host_reset_handler
op_assign
id|NCR_700_host_reset
suffix:semicolon
id|tpnt-&gt;can_queue
op_assign
id|NCR_700_COMMAND_SLOTS_PER_HOST
suffix:semicolon
id|tpnt-&gt;sg_tablesize
op_assign
id|NCR_700_SG_SEGMENTS
suffix:semicolon
id|tpnt-&gt;cmd_per_lun
op_assign
id|NCR_700_MAX_TAGS
suffix:semicolon
id|tpnt-&gt;use_clustering
op_assign
id|DISABLE_CLUSTERING
suffix:semicolon
id|tpnt-&gt;proc_info
op_assign
id|NCR_700_proc_directory_info
suffix:semicolon
r_if
c_cond
(paren
id|tpnt-&gt;name
op_eq
l_int|NULL
)paren
(brace
id|tpnt-&gt;name
op_assign
l_string|&quot;53c700&quot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tpnt-&gt;proc_name
op_eq
l_int|NULL
)paren
(brace
id|tpnt-&gt;proc_name
op_assign
l_string|&quot;53c700&quot;
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|host
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
l_int|4
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|hostdata-&gt;slots
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|NCR_700_command_slot
)paren
op_star
id|NCR_700_COMMAND_SLOTS_PER_HOST
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NCR_700_COMMAND_SLOTS_PER_HOST
suffix:semicolon
id|j
op_increment
)paren
(brace
id|dma_addr_t
id|offset
op_assign
(paren
id|dma_addr_t
)paren
(paren
(paren
r_int
r_int
)paren
op_amp
id|hostdata-&gt;slots
(braket
id|j
)braket
dot
id|SG
(braket
l_int|0
)braket
op_minus
(paren
r_int
r_int
)paren
op_amp
id|hostdata-&gt;slots
(braket
l_int|0
)braket
dot
id|SG
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|hostdata-&gt;slots
(braket
id|j
)braket
dot
id|pSG
op_assign
(paren
r_struct
id|NCR_700_SG_List
op_star
)paren
(paren
(paren
r_int
r_int
)paren
(paren
id|pSlots
op_plus
id|offset
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
(brace
id|hostdata-&gt;free_list
op_assign
op_amp
id|hostdata-&gt;slots
(braket
id|j
)braket
suffix:semicolon
)brace
r_else
id|hostdata-&gt;slots
(braket
id|j
op_minus
l_int|1
)braket
dot
id|ITL_forw
op_assign
op_amp
id|hostdata-&gt;slots
(braket
id|j
)braket
suffix:semicolon
id|hostdata-&gt;slots
(braket
id|j
)braket
dot
id|state
op_assign
id|NCR_700_SLOT_FREE
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
r_sizeof
(paren
id|SCRIPT
)paren
op_div
r_sizeof
(paren
id|SCRIPT
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
id|script
(braket
id|j
)braket
op_assign
id|bS_to_host
c_func
(paren
id|SCRIPT
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* adjust all labels to be bus physical */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|PATCHES
suffix:semicolon
id|j
op_increment
)paren
(brace
id|script
(braket
id|LABELPATCHES
(braket
id|j
)braket
)braket
op_assign
id|bS_to_host
c_func
(paren
id|pScript
op_plus
id|SCRIPT
(braket
id|LABELPATCHES
(braket
id|j
)braket
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* now patch up fixed addresses. */
id|script_patch_32
c_func
(paren
id|script
comma
id|MessageLocation
comma
id|pScript
op_plus
id|MSGOUT_OFFSET
)paren
suffix:semicolon
id|script_patch_32
c_func
(paren
id|script
comma
id|StatusAddress
comma
id|pScript
op_plus
id|STATUS_OFFSET
)paren
suffix:semicolon
id|script_patch_32
c_func
(paren
id|script
comma
id|ReceiveMsgAddress
comma
id|pScript
op_plus
id|MSGIN_OFFSET
)paren
suffix:semicolon
id|hostdata-&gt;script
op_assign
id|script
suffix:semicolon
id|hostdata-&gt;pScript
op_assign
id|pScript
suffix:semicolon
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|script
comma
r_sizeof
(paren
id|SCRIPT
)paren
)paren
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|NCR_700_HOST_FREE
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|hostdata-&gt;lock
)paren
suffix:semicolon
id|hostdata-&gt;cmd
op_assign
l_int|NULL
suffix:semicolon
id|host-&gt;max_id
op_assign
l_int|7
suffix:semicolon
id|host-&gt;max_lun
op_assign
id|NCR_700_MAX_LUNS
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|hostdata-&gt;base
suffix:semicolon
id|host-&gt;base
op_assign
id|hostdata-&gt;base
suffix:semicolon
id|host-&gt;hostdata
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_int
)paren
id|hostdata
suffix:semicolon
multiline_comment|/* kick the chip */
id|NCR_700_writeb
c_func
(paren
l_int|0xff
comma
id|host
comma
id|CTEST9_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;chip710
)paren
(brace
id|hostdata-&gt;rev
op_assign
(paren
id|NCR_700_readb
c_func
(paren
id|host
comma
id|CTEST8_REG
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
suffix:semicolon
)brace
r_else
id|hostdata-&gt;rev
op_assign
(paren
id|NCR_700_readb
c_func
(paren
id|host
comma
id|CTEST7_REG
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|hostdata-&gt;fast
op_assign
(paren
id|NCR_700_readb
c_func
(paren
id|host
comma
id|CTEST9_REG
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|banner
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;53c700: Version &quot;
id|NCR_700_VERSION
l_string|&quot; By James.Bottomley@HansenPartnership.com&bslash;n&quot;
)paren
suffix:semicolon
id|banner
op_assign
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;scsi%d: %s rev %d %s&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|hostdata-&gt;chip710
ques
c_cond
l_string|&quot;53c710&quot;
suffix:colon
(paren
id|hostdata-&gt;fast
ques
c_cond
l_string|&quot;53c700-66&quot;
suffix:colon
l_string|&quot;53c700&quot;
)paren
comma
id|hostdata-&gt;rev
comma
id|hostdata-&gt;differential
ques
c_cond
l_string|&quot;(Differential)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* reset the chip */
id|NCR_700_chip_reset
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
id|host
suffix:semicolon
)brace
r_int
DECL|function|NCR_700_release
id|NCR_700_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_53C700_USE_CONSISTENT
r_if
c_cond
(paren
id|hostdata-&gt;consistent
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|TOTAL_MEM_SIZE
comma
id|hostdata-&gt;script
comma
id|hostdata-&gt;pScript
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#endif
id|pci_unmap_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|hostdata-&gt;pScript
comma
id|TOTAL_MEM_SIZE
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hostdata-&gt;script
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_53C700_USE_CONSISTENT
)brace
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_inline
id|__u8
DECL|function|NCR_700_identify
id|NCR_700_identify
c_func
(paren
r_int
id|can_disconnect
comma
id|__u8
id|lun
)paren
(brace
r_return
id|IDENTIFY_BASE
op_or
(paren
(paren
id|can_disconnect
)paren
ques
c_cond
l_int|0x40
suffix:colon
l_int|0
)paren
op_or
(paren
id|lun
op_amp
id|NCR_700_LUN_MASK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function : static int data_residual (Scsi_Host *host)&n; *&n; * Purpose : return residual data count of what&squot;s in the chip.  If you&n; * really want to know what this function is doing, it&squot;s almost a&n; * direct transcription of the algorithm described in the 53c710&n; * guide, except that the DBC and DFIFO registers are only 6 bits&n; * wide on a 53c700.&n; *&n; * Inputs : host - SCSI host */
r_static
r_inline
r_int
DECL|function|NCR_700_data_residual
id|NCR_700_data_residual
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|count
comma
id|synchronous
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ddir
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;chip710
)paren
(brace
id|count
op_assign
(paren
(paren
id|NCR_700_readb
c_func
(paren
id|host
comma
id|DFIFO_REG
)paren
op_amp
l_int|0x7f
)paren
op_minus
(paren
id|NCR_700_readl
c_func
(paren
id|host
comma
id|DBC_REG
)paren
op_amp
l_int|0x7f
)paren
)paren
op_amp
l_int|0x7f
suffix:semicolon
)brace
r_else
(brace
id|count
op_assign
(paren
(paren
id|NCR_700_readb
c_func
(paren
id|host
comma
id|DFIFO_REG
)paren
op_amp
l_int|0x3f
)paren
op_minus
(paren
id|NCR_700_readl
c_func
(paren
id|host
comma
id|DBC_REG
)paren
op_amp
l_int|0x3f
)paren
)paren
op_amp
l_int|0x3f
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;fast
)paren
(brace
id|synchronous
op_assign
id|NCR_700_readb
c_func
(paren
id|host
comma
id|SXFER_REG
)paren
op_amp
l_int|0x0f
suffix:semicolon
)brace
multiline_comment|/* get the data direction */
id|ddir
op_assign
id|NCR_700_readb
c_func
(paren
id|host
comma
id|CTEST0_REG
)paren
op_amp
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|ddir
)paren
(brace
multiline_comment|/* Receive */
r_if
c_cond
(paren
id|synchronous
)paren
id|count
op_add_assign
(paren
id|NCR_700_readb
c_func
(paren
id|host
comma
id|SSTAT2_REG
)paren
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
suffix:semicolon
r_else
r_if
c_cond
(paren
id|NCR_700_readb
c_func
(paren
id|host
comma
id|SSTAT1_REG
)paren
op_amp
id|SIDL_REG_FULL
)paren
op_increment
id|count
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Send */
id|__u8
id|sstat
op_assign
id|NCR_700_readb
c_func
(paren
id|host
comma
id|SSTAT1_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sstat
op_amp
id|SODL_REG_FULL
)paren
op_increment
id|count
suffix:semicolon
r_if
c_cond
(paren
id|synchronous
op_logical_and
(paren
id|sstat
op_amp
id|SODR_REG_FULL
)paren
)paren
op_increment
id|count
suffix:semicolon
)brace
macro_line|#ifdef NCR_700_DEBUG
r_if
c_cond
(paren
id|count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;RESIDUAL IS %d (ddir %d)&bslash;n&quot;
comma
id|count
comma
id|ddir
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* print out the SCSI wires and corresponding phase from the SBCL register&n; * in the chip */
r_static
r_inline
r_char
op_star
DECL|function|sbcl_to_string
id|sbcl_to_string
c_func
(paren
id|__u8
id|sbcl
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_char
id|ret
(braket
l_int|256
)braket
suffix:semicolon
id|ret
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|i
)paren
op_amp
id|sbcl
)paren
(brace
id|strcat
c_func
(paren
id|ret
comma
id|NCR_700_SBCL_bits
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|strcat
c_func
(paren
id|ret
comma
id|NCR_700_SBCL_to_phase
(braket
id|sbcl
op_amp
l_int|0x07
)braket
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_inline
id|__u8
DECL|function|bitmap_to_number
id|bitmap_to_number
c_func
(paren
id|__u8
id|bitmap
)paren
(brace
id|__u8
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
op_logical_and
op_logical_neg
(paren
id|bitmap
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* Pull a slot off the free list */
id|STATIC
r_struct
id|NCR_700_command_slot
op_star
DECL|function|find_empty_slot
id|find_empty_slot
c_func
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
)paren
(brace
r_struct
id|NCR_700_command_slot
op_star
id|slot
op_assign
id|hostdata-&gt;free_list
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|hostdata-&gt;command_slot_count
op_ne
id|NCR_700_COMMAND_SLOTS_PER_HOST
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SLOTS FULL, but count is %d, should be %d&bslash;n&quot;
comma
id|hostdata-&gt;command_slot_count
comma
id|NCR_700_COMMAND_SLOTS_PER_HOST
)paren
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;state
op_ne
id|NCR_700_SLOT_FREE
)paren
(brace
multiline_comment|/* should panic! */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BUSY SLOT ON FREE LIST!!!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|hostdata-&gt;free_list
op_assign
id|slot-&gt;ITL_forw
suffix:semicolon
id|slot-&gt;ITL_forw
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* NOTE: set the state to busy here, not queued, since this&n;&t; * indicates the slot is in use and cannot be run by the IRQ&n;&t; * finish routine.  If we cannot queue the command when it&n;&t; * is properly build, we then change to NCR_700_SLOT_QUEUED */
id|slot-&gt;state
op_assign
id|NCR_700_SLOT_BUSY
suffix:semicolon
id|hostdata-&gt;command_slot_count
op_increment
suffix:semicolon
r_return
id|slot
suffix:semicolon
)brace
id|STATIC
r_void
DECL|function|free_slot
id|free_slot
c_func
(paren
r_struct
id|NCR_700_command_slot
op_star
id|slot
comma
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|NCR_700_command_slot
op_star
op_star
id|forw
comma
op_star
op_star
id|back
suffix:semicolon
r_if
c_cond
(paren
(paren
id|slot-&gt;state
op_amp
id|NCR_700_SLOT_MASK
)paren
op_ne
id|NCR_700_SLOT_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;53c700: SLOT %p is not MAGIC!!!&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot-&gt;state
op_eq
id|NCR_700_SLOT_FREE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;53c700: SLOT %p is FREE!!!&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
)brace
multiline_comment|/* remove from queues */
r_if
c_cond
(paren
id|slot-&gt;tag
op_ne
id|NCR_700_NO_TAG
)paren
(brace
id|hash
op_assign
id|hash_ITLQ
c_func
(paren
id|slot-&gt;cmnd-&gt;target
comma
id|slot-&gt;cmnd-&gt;lun
comma
id|slot-&gt;tag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;ITLQ_forw
op_eq
l_int|NULL
)paren
(brace
id|back
op_assign
op_amp
id|hostdata-&gt;ITLQ_Hash_back
(braket
id|hash
)braket
suffix:semicolon
)brace
r_else
id|back
op_assign
op_amp
id|slot-&gt;ITLQ_forw-&gt;ITLQ_back
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;ITLQ_back
op_eq
l_int|NULL
)paren
(brace
id|forw
op_assign
op_amp
id|hostdata-&gt;ITLQ_Hash_forw
(braket
id|hash
)braket
suffix:semicolon
)brace
r_else
id|forw
op_assign
op_amp
id|slot-&gt;ITLQ_back-&gt;ITLQ_forw
suffix:semicolon
op_star
id|forw
op_assign
id|slot-&gt;ITLQ_forw
suffix:semicolon
op_star
id|back
op_assign
id|slot-&gt;ITLQ_back
suffix:semicolon
)brace
id|hash
op_assign
id|hash_ITL
c_func
(paren
id|slot-&gt;cmnd-&gt;target
comma
id|slot-&gt;cmnd-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;ITL_forw
op_eq
l_int|NULL
)paren
(brace
id|back
op_assign
op_amp
id|hostdata-&gt;ITL_Hash_back
(braket
id|hash
)braket
suffix:semicolon
)brace
r_else
id|back
op_assign
op_amp
id|slot-&gt;ITL_forw-&gt;ITL_back
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;ITL_back
op_eq
l_int|NULL
)paren
(brace
id|forw
op_assign
op_amp
id|hostdata-&gt;ITL_Hash_forw
(braket
id|hash
)braket
suffix:semicolon
)brace
r_else
id|forw
op_assign
op_amp
id|slot-&gt;ITL_back-&gt;ITL_forw
suffix:semicolon
op_star
id|forw
op_assign
id|slot-&gt;ITL_forw
suffix:semicolon
op_star
id|back
op_assign
id|slot-&gt;ITL_back
suffix:semicolon
id|slot-&gt;resume_offset
op_assign
l_int|0
suffix:semicolon
id|slot-&gt;cmnd
op_assign
l_int|NULL
suffix:semicolon
id|slot-&gt;state
op_assign
id|NCR_700_SLOT_FREE
suffix:semicolon
id|slot-&gt;ITL_forw
op_assign
id|hostdata-&gt;free_list
suffix:semicolon
id|hostdata-&gt;free_list
op_assign
id|slot
suffix:semicolon
id|hostdata-&gt;command_slot_count
op_decrement
suffix:semicolon
)brace
multiline_comment|/* This routine really does very little.  The command is indexed on&n;   the ITL and (if tagged) the ITLQ lists in _queuecommand */
id|STATIC
r_void
DECL|function|save_for_reselection
id|save_for_reselection
c_func
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
comma
id|Scsi_Cmnd
op_star
id|SCp
comma
id|__u32
id|dsp
)paren
(brace
multiline_comment|/* Its just possible that this gets executed twice */
r_if
c_cond
(paren
id|SCp
op_ne
l_int|NULL
)paren
(brace
r_struct
id|NCR_700_command_slot
op_star
id|slot
op_assign
(paren
r_struct
id|NCR_700_command_slot
op_star
)paren
id|SCp-&gt;host_scribble
suffix:semicolon
id|slot-&gt;resume_offset
op_assign
id|dsp
suffix:semicolon
)brace
id|hostdata-&gt;state
op_assign
id|NCR_700_HOST_FREE
suffix:semicolon
id|hostdata-&gt;cmd
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Most likely nexus is the oldest in each case */
id|STATIC
r_inline
r_struct
id|NCR_700_command_slot
op_star
DECL|function|find_ITL_Nexus
id|find_ITL_Nexus
c_func
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
comma
id|__u8
id|pun
comma
id|__u8
id|lun
)paren
(brace
r_int
id|hash
op_assign
id|hash_ITL
c_func
(paren
id|pun
comma
id|lun
)paren
suffix:semicolon
r_struct
id|NCR_700_command_slot
op_star
id|slot
op_assign
id|hostdata-&gt;ITL_Hash_back
(braket
id|hash
)braket
suffix:semicolon
r_while
c_loop
(paren
id|slot
op_ne
l_int|NULL
op_logical_and
op_logical_neg
(paren
id|slot-&gt;cmnd-&gt;target
op_eq
id|pun
op_logical_and
id|slot-&gt;cmnd-&gt;lun
op_eq
id|lun
)paren
)paren
(brace
id|slot
op_assign
id|slot-&gt;ITL_back
suffix:semicolon
)brace
r_return
id|slot
suffix:semicolon
)brace
id|STATIC
r_inline
r_struct
id|NCR_700_command_slot
op_star
DECL|function|find_ITLQ_Nexus
id|find_ITLQ_Nexus
c_func
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
comma
id|__u8
id|pun
comma
id|__u8
id|lun
comma
id|__u8
id|tag
)paren
(brace
r_int
id|hash
op_assign
id|hash_ITLQ
c_func
(paren
id|pun
comma
id|lun
comma
id|tag
)paren
suffix:semicolon
r_struct
id|NCR_700_command_slot
op_star
id|slot
op_assign
id|hostdata-&gt;ITLQ_Hash_back
(braket
id|hash
)braket
suffix:semicolon
r_while
c_loop
(paren
id|slot
op_ne
l_int|NULL
op_logical_and
op_logical_neg
(paren
id|slot-&gt;cmnd-&gt;target
op_eq
id|pun
op_logical_and
id|slot-&gt;cmnd-&gt;lun
op_eq
id|lun
op_logical_and
id|slot-&gt;tag
op_eq
id|tag
)paren
)paren
(brace
id|slot
op_assign
id|slot-&gt;ITLQ_back
suffix:semicolon
)brace
macro_line|#ifdef NCR_700_TAG_DEBUG
r_if
c_cond
(paren
id|slot
op_ne
l_int|NULL
)paren
(brace
r_struct
id|NCR_700_command_slot
op_star
id|n
op_assign
id|slot-&gt;ITLQ_back
suffix:semicolon
r_while
c_loop
(paren
id|n
op_ne
l_int|NULL
op_logical_and
id|n-&gt;cmnd-&gt;target
op_ne
id|pun
op_logical_and
id|n-&gt;cmnd-&gt;lun
op_ne
id|lun
op_logical_and
id|n-&gt;tag
op_ne
id|tag
)paren
(brace
id|n
op_assign
id|n-&gt;ITLQ_back
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
op_ne
l_int|NULL
op_logical_and
id|n-&gt;cmnd-&gt;target
op_eq
id|pun
op_logical_and
id|n-&gt;cmnd-&gt;lun
op_eq
id|lun
op_logical_and
id|n-&gt;tag
op_eq
id|tag
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;53c700: WARNING: DUPLICATE tag %d&bslash;n&quot;
comma
id|tag
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
id|slot
suffix:semicolon
)brace
multiline_comment|/* This translates the SDTR message offset and period to a value&n; * which can be loaded into the SXFER_REG.&n; *&n; * NOTE: According to SCSI-2, the true transfer period (in ns) is&n; *       actually four times this period value */
id|STATIC
r_inline
id|__u8
DECL|function|NCR_700_offset_period_to_sxfer
id|NCR_700_offset_period_to_sxfer
c_func
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
comma
id|__u8
id|offset
comma
id|__u8
id|period
)paren
(brace
r_int
id|XFERP
suffix:semicolon
id|__u8
id|min_xferp
op_assign
(paren
id|hostdata-&gt;chip710
ques
c_cond
id|NCR_710_MIN_XFERP
suffix:colon
id|NCR_700_MIN_XFERP
)paren
suffix:semicolon
id|__u8
id|max_offset
op_assign
(paren
id|hostdata-&gt;chip710
ques
c_cond
id|NCR_710_MAX_OFFSET
suffix:colon
id|NCR_700_MAX_OFFSET
)paren
suffix:semicolon
multiline_comment|/* NOTE: NCR_700_SDTR_msg[3] contains our offer of the minimum&n;&t; * period.  It is set in NCR_700_chip_setup() */
r_if
c_cond
(paren
id|period
OL
id|NCR_700_SDTR_msg
(braket
l_int|3
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;53c700: Period %dns is less than this chip&squot;s minimum, setting to %d&bslash;n&quot;
comma
id|period
op_star
l_int|4
comma
id|NCR_700_SDTR_msg
(braket
l_int|3
)braket
op_star
l_int|4
)paren
suffix:semicolon
id|period
op_assign
id|NCR_700_SDTR_msg
(braket
l_int|3
)braket
suffix:semicolon
)brace
id|XFERP
op_assign
(paren
id|period
op_star
l_int|4
op_star
id|hostdata-&gt;sync_clock
)paren
op_div
l_int|1000
op_minus
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|offset
OG
id|max_offset
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;53c700: Offset %d exceeds chip maximum, setting to %d&bslash;n&quot;
comma
id|offset
comma
id|max_offset
)paren
suffix:semicolon
id|offset
op_assign
id|max_offset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|XFERP
OL
id|min_xferp
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;53c700: XFERP %d is less than minium, setting to %d&bslash;n&quot;
comma
id|XFERP
comma
id|min_xferp
)paren
suffix:semicolon
id|XFERP
op_assign
id|min_xferp
suffix:semicolon
)brace
r_return
(paren
id|offset
op_amp
l_int|0x0f
)paren
op_or
(paren
id|XFERP
op_amp
l_int|0x07
)paren
op_lshift
l_int|4
suffix:semicolon
)brace
id|STATIC
r_inline
r_void
DECL|function|NCR_700_unmap
id|NCR_700_unmap
c_func
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
comma
id|Scsi_Cmnd
op_star
id|SCp
comma
r_struct
id|NCR_700_command_slot
op_star
id|slot
)paren
(brace
r_if
c_cond
(paren
id|SCp-&gt;sc_data_direction
op_ne
id|SCSI_DATA_NONE
op_logical_and
id|SCp-&gt;sc_data_direction
op_ne
id|SCSI_DATA_UNKNOWN
)paren
(brace
r_int
id|pci_direction
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|SCp-&gt;sc_data_direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCp-&gt;use_sg
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|SCp-&gt;buffer
comma
id|SCp-&gt;use_sg
comma
id|pci_direction
)paren
suffix:semicolon
)brace
r_else
(brace
id|pci_unmap_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|slot-&gt;dma_handle
comma
id|SCp-&gt;request_bufflen
comma
id|pci_direction
)paren
suffix:semicolon
)brace
)brace
)brace
id|STATIC
r_inline
r_void
DECL|function|NCR_700_scsi_done
id|NCR_700_scsi_done
c_func
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
comma
id|Scsi_Cmnd
op_star
id|SCp
comma
r_int
id|result
)paren
(brace
id|hostdata-&gt;state
op_assign
id|NCR_700_HOST_FREE
suffix:semicolon
id|hostdata-&gt;cmd
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|SCp
op_ne
l_int|NULL
)paren
(brace
r_struct
id|NCR_700_command_slot
op_star
id|slot
op_assign
(paren
r_struct
id|NCR_700_command_slot
op_star
)paren
id|SCp-&gt;host_scribble
suffix:semicolon
id|NCR_700_unmap
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|slot
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|slot-&gt;pCmd
comma
r_sizeof
(paren
id|SCp-&gt;cmnd
)paren
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCp-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
op_logical_and
id|SCp-&gt;cmnd
(braket
l_int|6
)braket
op_eq
id|NCR_700_INTERNAL_SENSE_MAGIC
)paren
(brace
macro_line|#ifdef NCR_700_DEBUG
id|printk
c_func
(paren
l_string|&quot; ORIGINAL CMD %p RETURNED %d, new return is %d sense is&bslash;n&quot;
comma
id|SCp
comma
id|SCp-&gt;cmnd
(braket
l_int|7
)braket
comma
id|result
)paren
suffix:semicolon
id|print_sense
c_func
(paren
l_string|&quot;53c700&quot;
comma
id|SCp
)paren
suffix:semicolon
macro_line|#endif
id|SCp-&gt;use_sg
op_assign
id|SCp-&gt;cmnd
(braket
l_int|8
)braket
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
(brace
id|result
op_assign
id|SCp-&gt;cmnd
(braket
l_int|7
)braket
suffix:semicolon
)brace
)brace
id|free_slot
c_func
(paren
id|slot
comma
id|hostdata
)paren
suffix:semicolon
id|SCp-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|SCp-&gt;result
op_assign
id|result
suffix:semicolon
id|SCp
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NCR_700_get_depth
c_func
(paren
id|SCp-&gt;device
)paren
op_eq
l_int|0
op_logical_or
id|NCR_700_get_depth
c_func
(paren
id|SCp-&gt;device
)paren
OG
id|NCR_700_MAX_TAGS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Invalid depth in NCR_700_scsi_done(): %d&bslash;n&quot;
comma
id|NCR_700_get_depth
c_func
(paren
id|SCp-&gt;device
)paren
)paren
suffix:semicolon
)brace
id|NCR_700_set_depth
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_get_depth
c_func
(paren
id|SCp-&gt;device
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;53c700: SCSI DONE HAS NULL SCp&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|STATIC
r_void
DECL|function|NCR_700_internal_bus_reset
id|NCR_700_internal_bus_reset
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
multiline_comment|/* Bus reset */
id|NCR_700_writeb
c_func
(paren
id|ASSERT_RST
comma
id|host
comma
id|SCNTL1_REG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
l_int|0
comma
id|host
comma
id|SCNTL1_REG
)paren
suffix:semicolon
)brace
id|STATIC
r_void
DECL|function|NCR_700_chip_setup
id|NCR_700_chip_setup
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|__u32
id|dcntl_extra
op_assign
l_int|0
suffix:semicolon
id|__u8
id|min_period
suffix:semicolon
id|__u8
id|min_xferp
op_assign
(paren
id|hostdata-&gt;chip710
ques
c_cond
id|NCR_710_MIN_XFERP
suffix:colon
id|NCR_700_MIN_XFERP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;chip710
)paren
(brace
id|__u8
id|burst_disable
op_assign
id|hostdata-&gt;burst_disable
ques
c_cond
id|BURST_DISABLE
suffix:colon
l_int|0
suffix:semicolon
id|dcntl_extra
op_assign
id|COMPAT_700_MODE
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|dcntl_extra
comma
id|host
comma
id|DCNTL_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|BURST_LENGTH_8
op_or
id|hostdata-&gt;dmode_extra
comma
id|host
comma
id|DMODE_710_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|burst_disable
op_or
(paren
id|hostdata-&gt;differential
ques
c_cond
id|DIFF
suffix:colon
l_int|0
)paren
comma
id|host
comma
id|CTEST7_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|BTB_TIMER_DISABLE
comma
id|host
comma
id|CTEST0_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|FULL_ARBITRATION
op_or
id|ENABLE_PARITY
op_or
id|PARITY
op_or
id|AUTO_ATN
comma
id|host
comma
id|SCNTL0_REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|NCR_700_writeb
c_func
(paren
id|BURST_LENGTH_8
op_or
id|hostdata-&gt;dmode_extra
comma
id|host
comma
id|DMODE_700_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|hostdata-&gt;differential
ques
c_cond
id|DIFF
suffix:colon
l_int|0
comma
id|host
comma
id|CTEST7_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;fast
)paren
(brace
multiline_comment|/* this is for 700-66, does nothing on 700 */
id|NCR_700_writeb
c_func
(paren
id|LAST_DIS_ENBL
op_or
id|ENABLE_ACTIVE_NEGATION
op_or
id|GENERATE_RECEIVE_PARITY
comma
id|host
comma
id|CTEST8_REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|NCR_700_writeb
c_func
(paren
id|FULL_ARBITRATION
op_or
id|ENABLE_PARITY
op_or
id|PARITY
op_or
id|AUTO_ATN
comma
id|host
comma
id|SCNTL0_REG
)paren
suffix:semicolon
)brace
)brace
id|NCR_700_writeb
c_func
(paren
l_int|1
op_lshift
id|host-&gt;this_id
comma
id|host
comma
id|SCID_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
l_int|0
comma
id|host
comma
id|SBCL_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|ASYNC_OPERATION
comma
id|host
comma
id|SXFER_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|PHASE_MM_INT
op_or
id|SEL_TIMEOUT_INT
op_or
id|GROSS_ERR_INT
op_or
id|UX_DISC_INT
op_or
id|RST_INT
op_or
id|PAR_ERR_INT
op_or
id|SELECT_INT
comma
id|host
comma
id|SIEN_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|ABORT_INT
op_or
id|INT_INST_INT
op_or
id|ILGL_INST_INT
comma
id|host
comma
id|DIEN_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|ENABLE_SELECT
comma
id|host
comma
id|SCNTL1_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;clock
OG
l_int|75
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;53c700: Clock speed %dMHz is too high: 75Mhz is the maximum this chip can be driven at&bslash;n&quot;
comma
id|hostdata-&gt;clock
)paren
suffix:semicolon
multiline_comment|/* do the best we can, but the async clock will be out&n;&t;&t; * of spec: sync divider 2, async divider 3 */
id|DEBUG
c_func
(paren
(paren
l_string|&quot;53c700: sync 2 async 3&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|SYNC_DIV_2_0
comma
id|host
comma
id|SBCL_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|ASYNC_DIV_3_0
op_or
id|dcntl_extra
comma
id|host
comma
id|DCNTL_REG
)paren
suffix:semicolon
id|hostdata-&gt;sync_clock
op_assign
id|hostdata-&gt;clock
op_div
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hostdata-&gt;clock
OG
l_int|50
op_logical_and
id|hostdata-&gt;clock
op_le
l_int|75
)paren
(brace
multiline_comment|/* sync divider 1.5, async divider 3 */
id|DEBUG
c_func
(paren
(paren
l_string|&quot;53c700: sync 1.5 async 3&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|SYNC_DIV_1_5
comma
id|host
comma
id|SBCL_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|ASYNC_DIV_3_0
op_or
id|dcntl_extra
comma
id|host
comma
id|DCNTL_REG
)paren
suffix:semicolon
id|hostdata-&gt;sync_clock
op_assign
id|hostdata-&gt;clock
op_star
l_int|2
suffix:semicolon
id|hostdata-&gt;sync_clock
op_div_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hostdata-&gt;clock
OG
l_int|37
op_logical_and
id|hostdata-&gt;clock
op_le
l_int|50
)paren
(brace
multiline_comment|/* sync divider 1, async divider 2 */
id|DEBUG
c_func
(paren
(paren
l_string|&quot;53c700: sync 1 async 2&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|SYNC_DIV_1_0
comma
id|host
comma
id|SBCL_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|ASYNC_DIV_2_0
op_or
id|dcntl_extra
comma
id|host
comma
id|DCNTL_REG
)paren
suffix:semicolon
id|hostdata-&gt;sync_clock
op_assign
id|hostdata-&gt;clock
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hostdata-&gt;clock
OG
l_int|25
op_logical_and
id|hostdata-&gt;clock
op_le
l_int|37
)paren
(brace
multiline_comment|/* sync divider 1, async divider 1.5 */
id|DEBUG
c_func
(paren
(paren
l_string|&quot;53c700: sync 1 async 1.5&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|SYNC_DIV_1_0
comma
id|host
comma
id|SBCL_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|ASYNC_DIV_1_5
op_or
id|dcntl_extra
comma
id|host
comma
id|DCNTL_REG
)paren
suffix:semicolon
id|hostdata-&gt;sync_clock
op_assign
id|hostdata-&gt;clock
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
(paren
l_string|&quot;53c700: sync 1 async 1&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|SYNC_DIV_1_0
comma
id|host
comma
id|SBCL_REG
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|ASYNC_DIV_1_0
op_or
id|dcntl_extra
comma
id|host
comma
id|DCNTL_REG
)paren
suffix:semicolon
multiline_comment|/* sync divider 1, async divider 1 */
id|hostdata-&gt;sync_clock
op_assign
id|hostdata-&gt;clock
suffix:semicolon
)brace
multiline_comment|/* Calculate the actual minimum period that can be supported&n;&t; * by our synchronous clock speed.  See the 710 manual for&n;&t; * exact details of this calculation which is based on a&n;&t; * setting of the SXFER register */
id|min_period
op_assign
l_int|1000
op_star
(paren
l_int|4
op_plus
id|min_xferp
)paren
op_div
(paren
l_int|4
op_star
id|hostdata-&gt;sync_clock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|min_period
OG
id|NCR_700_MIN_PERIOD
)paren
(brace
id|NCR_700_SDTR_msg
(braket
l_int|3
)braket
op_assign
id|min_period
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;chip710
)paren
(brace
id|NCR_700_SDTR_msg
(braket
l_int|4
)braket
op_assign
id|NCR_710_MAX_OFFSET
suffix:semicolon
)brace
)brace
id|STATIC
r_void
DECL|function|NCR_700_chip_reset
id|NCR_700_chip_reset
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;chip710
)paren
(brace
id|NCR_700_writeb
c_func
(paren
id|SOFTWARE_RESET_710
comma
id|host
comma
id|ISTAT_REG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
l_int|0
comma
id|host
comma
id|ISTAT_REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|NCR_700_writeb
c_func
(paren
id|SOFTWARE_RESET
comma
id|host
comma
id|DCNTL_REG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
l_int|0
comma
id|host
comma
id|DCNTL_REG
)paren
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|NCR_700_chip_setup
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
multiline_comment|/* The heart of the message processing engine is that the instruction&n; * immediately after the INT is the normal case (and so must be CLEAR&n; * ACK).  If we want to do something else, we call that routine in&n; * scripts and set temp to be the normal case + 8 (skipping the CLEAR&n; * ACK) so that the routine returns correctly to resume its activity&n; * */
id|STATIC
id|__u32
DECL|function|process_extended_message
id|process_extended_message
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
comma
id|Scsi_Cmnd
op_star
id|SCp
comma
id|__u32
id|dsp
comma
id|__u32
id|dsps
)paren
(brace
id|__u32
id|resume_offset
op_assign
id|dsp
comma
id|temp
op_assign
id|dsp
op_plus
l_int|8
suffix:semicolon
id|__u8
id|pun
op_assign
l_int|0xff
comma
id|lun
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|SCp
op_ne
l_int|NULL
)paren
(brace
id|pun
op_assign
id|SCp-&gt;target
suffix:semicolon
id|lun
op_assign
id|SCp-&gt;lun
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|hostdata-&gt;msgin
(braket
l_int|2
)braket
)paren
(brace
r_case
id|A_SDTR_MSG
suffix:colon
r_if
c_cond
(paren
id|SCp
op_ne
l_int|NULL
op_logical_and
id|NCR_700_is_flag_set
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_BEGIN_SYNC_NEGOTIATION
)paren
)paren
(brace
id|__u8
id|period
op_assign
id|hostdata-&gt;msgin
(braket
l_int|3
)braket
suffix:semicolon
id|__u8
id|offset
op_assign
id|hostdata-&gt;msgin
(braket
l_int|4
)braket
suffix:semicolon
id|__u8
id|sxfer
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_ne
l_int|0
op_logical_and
id|period
op_ne
l_int|0
)paren
(brace
id|sxfer
op_assign
id|NCR_700_offset_period_to_sxfer
c_func
(paren
id|hostdata
comma
id|offset
comma
id|period
)paren
suffix:semicolon
)brace
r_else
id|sxfer
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sxfer
op_ne
id|NCR_700_get_SXFER
c_func
(paren
id|SCp-&gt;device
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi%d: (%d:%d) Synchronous at offset %d, period %dns&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|offset
comma
id|period
op_star
l_int|4
)paren
suffix:semicolon
id|NCR_700_set_SXFER
c_func
(paren
id|SCp-&gt;device
comma
id|sxfer
)paren
suffix:semicolon
)brace
id|NCR_700_set_flag
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_NEGOTIATED_SYNC
)paren
suffix:semicolon
id|NCR_700_clear_flag
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_BEGIN_SYNC_NEGOTIATION
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
id|NCR_700_get_SXFER
c_func
(paren
id|SCp-&gt;device
)paren
comma
id|host
comma
id|SXFER_REG
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* SDTR message out of the blue, reject it */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d Unexpected SDTR msg&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|A_REJECT_MSG
suffix:semicolon
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;msgout
comma
l_int|1
)paren
suffix:semicolon
id|script_patch_16
c_func
(paren
id|hostdata-&gt;script
comma
id|MessageCount
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* SendMsgOut returns, so set up the return&n;&t;&t;&t; * address */
id|resume_offset
op_assign
id|hostdata-&gt;pScript
op_plus
id|Ent_SendMessageWithATN
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|A_WDTR_MSG
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi%d: (%d:%d), Unsolicited WDTR after CMD, Rejecting&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
)paren
suffix:semicolon
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|A_REJECT_MSG
suffix:semicolon
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;msgout
comma
l_int|1
)paren
suffix:semicolon
id|script_patch_16
c_func
(paren
id|hostdata-&gt;script
comma
id|MessageCount
comma
l_int|1
)paren
suffix:semicolon
id|resume_offset
op_assign
id|hostdata-&gt;pScript
op_plus
id|Ent_SendMessageWithATN
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi%d (%d:%d): Unexpected message %s: &quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|NCR_700_phase
(braket
(paren
id|dsps
op_amp
l_int|0xf00
)paren
op_rshift
l_int|8
)braket
)paren
suffix:semicolon
id|print_msg
c_func
(paren
id|hostdata-&gt;msgin
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* just reject it */
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|A_REJECT_MSG
suffix:semicolon
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;msgout
comma
l_int|1
)paren
suffix:semicolon
id|script_patch_16
c_func
(paren
id|hostdata-&gt;script
comma
id|MessageCount
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* SendMsgOut returns, so set up the return&n;&t;&t; * address */
id|resume_offset
op_assign
id|hostdata-&gt;pScript
op_plus
id|Ent_SendMessageWithATN
suffix:semicolon
)brace
id|NCR_700_writel
c_func
(paren
id|temp
comma
id|host
comma
id|TEMP_REG
)paren
suffix:semicolon
r_return
id|resume_offset
suffix:semicolon
)brace
id|STATIC
id|__u32
DECL|function|process_message
id|process_message
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
comma
id|Scsi_Cmnd
op_star
id|SCp
comma
id|__u32
id|dsp
comma
id|__u32
id|dsps
)paren
(brace
multiline_comment|/* work out where to return to */
id|__u32
id|temp
op_assign
id|dsp
op_plus
l_int|8
comma
id|resume_offset
op_assign
id|dsp
suffix:semicolon
id|__u8
id|pun
op_assign
l_int|0xff
comma
id|lun
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|SCp
op_ne
l_int|NULL
)paren
(brace
id|pun
op_assign
id|SCp-&gt;target
suffix:semicolon
id|lun
op_assign
id|SCp-&gt;lun
suffix:semicolon
)brace
macro_line|#ifdef NCR_700_DEBUG
id|printk
c_func
(paren
l_string|&quot;scsi%d (%d:%d): message %s: &quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|NCR_700_phase
(braket
(paren
id|dsps
op_amp
l_int|0xf00
)paren
op_rshift
l_int|8
)braket
)paren
suffix:semicolon
id|print_msg
c_func
(paren
id|hostdata-&gt;msgin
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|hostdata-&gt;msgin
(braket
l_int|0
)braket
)paren
(brace
r_case
id|A_EXTENDED_MSG
suffix:colon
id|resume_offset
op_assign
id|process_extended_message
c_func
(paren
id|host
comma
id|hostdata
comma
id|SCp
comma
id|dsp
comma
id|dsps
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A_REJECT_MSG
suffix:colon
r_if
c_cond
(paren
id|SCp
op_ne
l_int|NULL
op_logical_and
id|NCR_700_is_flag_set
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_BEGIN_SYNC_NEGOTIATION
)paren
)paren
(brace
multiline_comment|/* Rejected our sync negotiation attempt */
id|NCR_700_set_SXFER
c_func
(paren
id|SCp-&gt;device
comma
l_int|0
)paren
suffix:semicolon
id|NCR_700_set_flag
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_NEGOTIATED_SYNC
)paren
suffix:semicolon
id|NCR_700_clear_flag
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_BEGIN_SYNC_NEGOTIATION
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SCp
op_ne
l_int|NULL
op_logical_and
id|NCR_700_is_flag_set
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_BEGIN_TAG_QUEUEING
)paren
)paren
(brace
multiline_comment|/* rejected our first simple tag message */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d (%d:%d) Rejected first tag queue attempt, turning off tag queueing&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
)paren
suffix:semicolon
id|NCR_700_clear_flag
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_BEGIN_TAG_QUEUEING
)paren
suffix:semicolon
id|hostdata-&gt;tag_negotiated
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|SCp-&gt;target
)paren
suffix:semicolon
id|SCp-&gt;device-&gt;tagged_queue
op_assign
l_int|0
suffix:semicolon
id|SCp-&gt;device-&gt;tagged_supported
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d (%d:%d) Unexpected REJECT Message %s&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|NCR_700_phase
(braket
(paren
id|dsps
op_amp
l_int|0xf00
)paren
op_rshift
l_int|8
)braket
)paren
suffix:semicolon
multiline_comment|/* however, just ignore it */
)brace
r_break
suffix:semicolon
r_case
id|A_PARITY_ERROR_MSG
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d (%d:%d) Parity Error!&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
)paren
suffix:semicolon
id|NCR_700_internal_bus_reset
c_func
(paren
id|host
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A_SIMPLE_TAG_MSG
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi%d (%d:%d) SIMPLE TAG %d %s&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|hostdata-&gt;msgin
(braket
l_int|1
)braket
comma
id|NCR_700_phase
(braket
(paren
id|dsps
op_amp
l_int|0xf00
)paren
op_rshift
l_int|8
)braket
)paren
suffix:semicolon
multiline_comment|/* just ignore it */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi%d (%d:%d): Unexpected message %s: &quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|NCR_700_phase
(braket
(paren
id|dsps
op_amp
l_int|0xf00
)paren
op_rshift
l_int|8
)braket
)paren
suffix:semicolon
id|print_msg
c_func
(paren
id|hostdata-&gt;msgin
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* just reject it */
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|A_REJECT_MSG
suffix:semicolon
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;msgout
comma
l_int|1
)paren
suffix:semicolon
id|script_patch_16
c_func
(paren
id|hostdata-&gt;script
comma
id|MessageCount
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* SendMsgOut returns, so set up the return&n;&t;&t; * address */
id|resume_offset
op_assign
id|hostdata-&gt;pScript
op_plus
id|Ent_SendMessageWithATN
suffix:semicolon
r_break
suffix:semicolon
)brace
id|NCR_700_writel
c_func
(paren
id|temp
comma
id|host
comma
id|TEMP_REG
)paren
suffix:semicolon
multiline_comment|/* set us up to receive another message */
id|NCR_700_dma_cache_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;msgin
comma
id|MSG_ARRAY_SIZE
)paren
suffix:semicolon
r_return
id|resume_offset
suffix:semicolon
)brace
id|STATIC
id|__u32
DECL|function|process_script_interrupt
id|process_script_interrupt
c_func
(paren
id|__u32
id|dsps
comma
id|__u32
id|dsp
comma
id|Scsi_Cmnd
op_star
id|SCp
comma
r_struct
id|Scsi_Host
op_star
id|host
comma
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
)paren
(brace
id|__u32
id|resume_offset
op_assign
l_int|0
suffix:semicolon
id|__u8
id|pun
op_assign
l_int|0xff
comma
id|lun
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|SCp
op_ne
l_int|NULL
)paren
(brace
id|pun
op_assign
id|SCp-&gt;target
suffix:semicolon
id|lun
op_assign
id|SCp-&gt;lun
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dsps
op_eq
id|A_GOOD_STATUS_AFTER_STATUS
)paren
(brace
id|DEBUG
c_func
(paren
(paren
l_string|&quot;  COMMAND COMPLETE, status=%02x&bslash;n&quot;
comma
id|hostdata-&gt;status
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* OK, if TCQ still on, we know it works */
id|NCR_700_clear_flag
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_BEGIN_TAG_QUEUEING
)paren
suffix:semicolon
multiline_comment|/* check for contingent allegiance contitions */
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|hostdata-&gt;status
(braket
l_int|0
)braket
)paren
op_eq
id|CHECK_CONDITION
op_logical_or
id|status_byte
c_func
(paren
id|hostdata-&gt;status
(braket
l_int|0
)braket
)paren
op_eq
id|COMMAND_TERMINATED
)paren
(brace
r_struct
id|NCR_700_command_slot
op_star
id|slot
op_assign
(paren
r_struct
id|NCR_700_command_slot
op_star
)paren
id|SCp-&gt;host_scribble
suffix:semicolon
r_if
c_cond
(paren
id|SCp-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
(brace
multiline_comment|/* OOPS: bad device, returning another&n;&t;&t;&t;&t; * contingent allegiance condition */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d (%d:%d) broken device is looping in contingent allegiance: ignoring&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
)paren
suffix:semicolon
id|NCR_700_scsi_done
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|hostdata-&gt;status
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef NCR_DEBUG
id|print_command
c_func
(paren
id|SCp-&gt;cmnd
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  cmd %p has status %d, requesting sense&bslash;n&quot;
comma
id|SCp
comma
id|hostdata-&gt;status
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* we can destroy the command here&n;&t;&t;&t;&t; * because the contingent allegiance&n;&t;&t;&t;&t; * condition will cause a retry which&n;&t;&t;&t;&t; * will re-copy the command from the&n;&t;&t;&t;&t; * saved data_cmnd.  We also unmap any&n;&t;&t;&t;&t; * data associated with the command&n;&t;&t;&t;&t; * here */
id|NCR_700_unmap
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|slot
)paren
suffix:semicolon
id|SCp-&gt;cmnd
(braket
l_int|0
)braket
op_assign
id|REQUEST_SENSE
suffix:semicolon
id|SCp-&gt;cmnd
(braket
l_int|1
)braket
op_assign
(paren
id|SCp-&gt;lun
op_amp
l_int|0x7
)paren
op_lshift
l_int|5
suffix:semicolon
id|SCp-&gt;cmnd
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|SCp-&gt;cmnd
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|SCp-&gt;cmnd
(braket
l_int|4
)braket
op_assign
r_sizeof
(paren
id|SCp-&gt;sense_buffer
)paren
suffix:semicolon
id|SCp-&gt;cmnd
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|SCp-&gt;cmd_len
op_assign
l_int|6
suffix:semicolon
multiline_comment|/* Here&squot;s a quiet hack: the&n;&t;&t;&t;&t; * REQUEST_SENSE command is six bytes,&n;&t;&t;&t;&t; * so store a flag indicating that&n;&t;&t;&t;&t; * this was an internal sense request&n;&t;&t;&t;&t; * and the original status at the end&n;&t;&t;&t;&t; * of the command */
id|SCp-&gt;cmnd
(braket
l_int|6
)braket
op_assign
id|NCR_700_INTERNAL_SENSE_MAGIC
suffix:semicolon
id|SCp-&gt;cmnd
(braket
l_int|7
)braket
op_assign
id|hostdata-&gt;status
(braket
l_int|0
)braket
suffix:semicolon
id|SCp-&gt;cmnd
(braket
l_int|8
)braket
op_assign
id|SCp-&gt;use_sg
suffix:semicolon
id|SCp-&gt;use_sg
op_assign
l_int|0
suffix:semicolon
id|SCp-&gt;sc_data_direction
op_assign
id|SCSI_DATA_READ
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|slot-&gt;pCmd
comma
id|SCp-&gt;cmd_len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|slot-&gt;dma_handle
op_assign
id|pci_map_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|SCp-&gt;sense_buffer
comma
r_sizeof
(paren
id|SCp-&gt;sense_buffer
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|slot-&gt;SG
(braket
l_int|0
)braket
dot
id|ins
op_assign
id|bS_to_host
c_func
(paren
id|SCRIPT_MOVE_DATA_IN
op_or
r_sizeof
(paren
id|SCp-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|slot-&gt;SG
(braket
l_int|0
)braket
dot
id|pAddr
op_assign
id|bS_to_host
c_func
(paren
id|slot-&gt;dma_handle
)paren
suffix:semicolon
id|slot-&gt;SG
(braket
l_int|1
)braket
dot
id|ins
op_assign
id|bS_to_host
c_func
(paren
id|SCRIPT_RETURN
)paren
suffix:semicolon
id|slot-&gt;SG
(braket
l_int|1
)braket
dot
id|pAddr
op_assign
l_int|0
suffix:semicolon
id|slot-&gt;resume_offset
op_assign
id|hostdata-&gt;pScript
suffix:semicolon
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|slot-&gt;SG
comma
r_sizeof
(paren
id|slot-&gt;SG
(braket
l_int|0
)braket
)paren
op_star
l_int|2
)paren
suffix:semicolon
id|NCR_700_dma_cache_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|SCp-&gt;sense_buffer
comma
r_sizeof
(paren
id|SCp-&gt;sense_buffer
)paren
)paren
suffix:semicolon
multiline_comment|/* queue the command for reissue */
id|slot-&gt;state
op_assign
id|NCR_700_SLOT_QUEUED
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|NCR_700_HOST_FREE
suffix:semicolon
id|hostdata-&gt;cmd
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// Currently rely on the mid layer evaluation
singleline_comment|// of the tag queuing capability
singleline_comment|//
singleline_comment|//if(status_byte(hostdata-&gt;status[0]) == GOOD &amp;&amp;
singleline_comment|//   SCp-&gt;cmnd[0] == INQUIRY &amp;&amp; SCp-&gt;use_sg == 0) {
singleline_comment|//&t;/* Piggy back the tag queueing support
singleline_comment|//&t; * on this command */
singleline_comment|//&t;pci_dma_sync_single(hostdata-&gt;pci_dev,
singleline_comment|//&t;&t;&t;    slot-&gt;dma_handle,
singleline_comment|//&t;&t;&t;    SCp-&gt;request_bufflen,
singleline_comment|//&t;&t;&t;    PCI_DMA_FROMDEVICE);
singleline_comment|//&t;if(((char *)SCp-&gt;request_buffer)[7] &amp; 0x02) {
singleline_comment|//&t;&t;printk(KERN_INFO &quot;scsi%d: (%d:%d) Enabling Tag Command Queuing&bslash;n&quot;, host-&gt;host_no, pun, lun);
singleline_comment|//&t;&t;hostdata-&gt;tag_negotiated |= (1&lt;&lt;SCp-&gt;target);
singleline_comment|//&t;&t;NCR_700_set_flag(SCp-&gt;device, NCR_700_DEV_BEGIN_TAG_QUEUEING);
singleline_comment|//&t;} else {
singleline_comment|//&t;&t;NCR_700_clear_flag(SCp-&gt;device, NCR_700_DEV_BEGIN_TAG_QUEUEING);
singleline_comment|//&t;&t;hostdata-&gt;tag_negotiated &amp;= ~(1&lt;&lt;SCp-&gt;target);
singleline_comment|//&t;}
singleline_comment|//}
id|NCR_700_scsi_done
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|hostdata-&gt;status
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|dsps
op_amp
l_int|0xfffff0f0
)paren
op_eq
id|A_UNEXPECTED_PHASE
)paren
(brace
id|__u8
id|i
op_assign
(paren
id|dsps
op_amp
l_int|0xf00
)paren
op_rshift
l_int|8
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: (%d:%d), UNEXPECTED PHASE %s (%s)&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|NCR_700_phase
(braket
id|i
)braket
comma
id|sbcl_to_string
c_func
(paren
id|NCR_700_readb
c_func
(paren
id|host
comma
id|SBCL_REG
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;         len = %d, cmd =&quot;
comma
id|SCp-&gt;cmd_len
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCp-&gt;cmnd
)paren
suffix:semicolon
id|NCR_700_internal_bus_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dsps
op_amp
l_int|0xfffff000
)paren
op_eq
id|A_FATAL
)paren
(brace
r_int
id|i
op_assign
(paren
id|dsps
op_amp
l_int|0xfff
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: (%d:%d) FATAL ERROR: %s&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|NCR_700_fatal_messages
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsps
op_eq
id|A_FATAL_ILLEGAL_MSG_LENGTH
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;     msg begins %02x %02x&bslash;n&quot;
comma
id|hostdata-&gt;msgin
(braket
l_int|0
)braket
comma
id|hostdata-&gt;msgin
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|NCR_700_internal_bus_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dsps
op_amp
l_int|0xfffff0f0
)paren
op_eq
id|A_DISCONNECT
)paren
(brace
macro_line|#ifdef NCR_700_DEBUG
id|__u8
id|i
op_assign
(paren
id|dsps
op_amp
l_int|0xf00
)paren
op_rshift
l_int|8
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: (%d:%d), DISCONNECTED (%d) %s&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|i
comma
id|NCR_700_phase
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
id|save_for_reselection
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|dsp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dsps
op_eq
id|A_RESELECTION_IDENTIFIED
)paren
(brace
id|__u8
id|lun
suffix:semicolon
r_struct
id|NCR_700_command_slot
op_star
id|slot
suffix:semicolon
id|__u8
id|reselection_id
op_assign
id|hostdata-&gt;reselection_id
suffix:semicolon
id|lun
op_assign
id|hostdata-&gt;msgin
(braket
l_int|0
)braket
op_amp
l_int|0x1f
suffix:semicolon
id|hostdata-&gt;reselection_id
op_assign
l_int|0xff
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;scsi%d: (%d:%d) RESELECTED!&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|reselection_id
comma
id|lun
)paren
)paren
suffix:semicolon
multiline_comment|/* clear the reselection indicator */
r_if
c_cond
(paren
id|hostdata-&gt;msgin
(braket
l_int|1
)braket
op_eq
id|A_SIMPLE_TAG_MSG
)paren
(brace
id|slot
op_assign
id|find_ITLQ_Nexus
c_func
(paren
id|hostdata
comma
id|reselection_id
comma
id|lun
comma
id|hostdata-&gt;msgin
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|slot
op_assign
id|find_ITL_Nexus
c_func
(paren
id|hostdata
comma
id|reselection_id
comma
id|lun
)paren
suffix:semicolon
)brace
id|retry
suffix:colon
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
r_struct
id|NCR_700_command_slot
op_star
id|s
op_assign
id|find_ITL_Nexus
c_func
(paren
id|hostdata
comma
id|reselection_id
comma
id|lun
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: (%d:%d) RESELECTED but no saved command (MSG = %02x %02x %02x)!!&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|reselection_id
comma
id|lun
comma
id|hostdata-&gt;msgin
(braket
l_int|0
)braket
comma
id|hostdata-&gt;msgin
(braket
l_int|1
)braket
comma
id|hostdata-&gt;msgin
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot; OUTSTANDING TAGS:&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|s
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;cmnd-&gt;target
op_eq
id|reselection_id
op_logical_and
id|s-&gt;cmnd-&gt;lun
op_eq
id|lun
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%d &quot;
comma
id|s-&gt;tag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;tag
op_eq
id|hostdata-&gt;msgin
(braket
l_int|2
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; ***FOUND*** &bslash;n&quot;
)paren
suffix:semicolon
id|slot
op_assign
id|s
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
)brace
id|s
op_assign
id|s-&gt;ITL_back
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hostdata-&gt;state
op_ne
id|NCR_700_HOST_BUSY
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: FATAL, host not busy during valid reselection!&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
)brace
id|resume_offset
op_assign
id|slot-&gt;resume_offset
suffix:semicolon
id|hostdata-&gt;cmd
op_assign
id|slot-&gt;cmnd
suffix:semicolon
multiline_comment|/* re-patch for this command */
id|script_patch_32_abs
c_func
(paren
id|hostdata-&gt;script
comma
id|CommandAddress
comma
id|slot-&gt;pCmd
)paren
suffix:semicolon
id|script_patch_16
c_func
(paren
id|hostdata-&gt;script
comma
id|CommandCount
comma
id|slot-&gt;cmnd-&gt;cmd_len
)paren
suffix:semicolon
id|script_patch_32_abs
c_func
(paren
id|hostdata-&gt;script
comma
id|SGScriptStartAddress
comma
id|to32bit
c_func
(paren
op_amp
id|slot-&gt;pSG
(braket
l_int|0
)braket
dot
id|ins
)paren
)paren
suffix:semicolon
multiline_comment|/* Note: setting SXFER only works if we&squot;re&n;&t;&t;&t; * still in the MESSAGE phase, so it is vital&n;&t;&t;&t; * that ACK is still asserted when we process&n;&t;&t;&t; * the reselection message.  The resume offset&n;&t;&t;&t; * should therefore always clear ACK */
id|NCR_700_writeb
c_func
(paren
id|NCR_700_get_SXFER
c_func
(paren
id|hostdata-&gt;cmd-&gt;device
)paren
comma
id|host
comma
id|SXFER_REG
)paren
suffix:semicolon
id|NCR_700_dma_cache_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;msgin
comma
id|MSG_ARRAY_SIZE
)paren
suffix:semicolon
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;msgout
comma
id|MSG_ARRAY_SIZE
)paren
suffix:semicolon
multiline_comment|/* I&squot;m just being paranoid here, the command should&n;&t;&t;&t; * already have been flushed from the cache */
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|slot-&gt;cmnd-&gt;cmnd
comma
id|slot-&gt;cmnd-&gt;cmd_len
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|dsps
op_eq
id|A_RESELECTED_DURING_SELECTION
)paren
(brace
multiline_comment|/* This section is full of debugging code because I&squot;ve&n;&t;&t; * never managed to reach it.  I think what happens is&n;&t;&t; * that, because the 700 runs with selection&n;&t;&t; * interrupts enabled the whole time that we take a&n;&t;&t; * selection interrupt before we manage to get to the&n;&t;&t; * reselected script interrupt */
id|__u8
id|reselection_id
op_assign
id|NCR_700_readb
c_func
(paren
id|host
comma
id|SFBR_REG
)paren
suffix:semicolon
r_struct
id|NCR_700_command_slot
op_star
id|slot
suffix:semicolon
multiline_comment|/* Take out our own ID */
id|reselection_id
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|host-&gt;this_id
)paren
suffix:semicolon
multiline_comment|/* I&squot;ve never seen this happen, so keep this as a printk rather&n;&t;&t; * than a debug */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi%d: (%d:%d) RESELECTION DURING SELECTION, dsp=%08x[%04x] state=%d, count=%d&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|reselection_id
comma
id|lun
comma
id|dsp
comma
id|dsp
op_minus
id|hostdata-&gt;pScript
comma
id|hostdata-&gt;state
comma
id|hostdata-&gt;command_slot_count
)paren
suffix:semicolon
(brace
multiline_comment|/* FIXME: DEBUGGING CODE */
id|__u32
id|SG
op_assign
(paren
id|__u32
)paren
id|bS_to_cpu
c_func
(paren
id|hostdata-&gt;script
(braket
id|A_SGScriptStartAddress_used
(braket
l_int|0
)braket
)braket
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NCR_700_COMMAND_SLOTS_PER_HOST
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|SG
op_ge
id|to32bit
c_func
(paren
op_amp
id|hostdata-&gt;slots
(braket
id|i
)braket
dot
id|pSG
(braket
l_int|0
)braket
)paren
op_logical_and
id|SG
op_le
id|to32bit
c_func
(paren
op_amp
id|hostdata-&gt;slots
(braket
id|i
)braket
dot
id|pSG
(braket
id|NCR_700_SG_SEGMENTS
)braket
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IDENTIFIED SG segment as being %08x in slot %p, cmd %p, slot-&gt;resume_offset=%08x&bslash;n&quot;
comma
id|SG
comma
op_amp
id|hostdata-&gt;slots
(braket
id|i
)braket
comma
id|hostdata-&gt;slots
(braket
id|i
)braket
dot
id|cmnd
comma
id|hostdata-&gt;slots
(braket
id|i
)braket
dot
id|resume_offset
)paren
suffix:semicolon
id|SCp
op_assign
id|hostdata-&gt;slots
(braket
id|i
)braket
dot
id|cmnd
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCp
op_ne
l_int|NULL
)paren
(brace
id|slot
op_assign
(paren
r_struct
id|NCR_700_command_slot
op_star
)paren
id|SCp-&gt;host_scribble
suffix:semicolon
multiline_comment|/* change slot from busy to queued to redo command */
id|slot-&gt;state
op_assign
id|NCR_700_SLOT_QUEUED
suffix:semicolon
)brace
id|hostdata-&gt;cmd
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|reselection_id
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|hostdata-&gt;reselection_id
op_eq
l_int|0xff
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: Invalid reselection during selection!!&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: script reselected and we took a selection interrupt&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
id|reselection_id
op_assign
id|hostdata-&gt;reselection_id
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* convert to real ID */
id|reselection_id
op_assign
id|bitmap_to_number
c_func
(paren
id|reselection_id
)paren
suffix:semicolon
)brace
id|hostdata-&gt;reselection_id
op_assign
id|reselection_id
suffix:semicolon
multiline_comment|/* just in case we have a stale simple tag message, clear it */
id|hostdata-&gt;msgin
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|NCR_700_dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;msgin
comma
id|MSG_ARRAY_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;tag_negotiated
op_amp
(paren
l_int|1
op_lshift
id|reselection_id
)paren
)paren
(brace
id|resume_offset
op_assign
id|hostdata-&gt;pScript
op_plus
id|Ent_GetReselectionWithTag
suffix:semicolon
)brace
r_else
(brace
id|resume_offset
op_assign
id|hostdata-&gt;pScript
op_plus
id|Ent_GetReselectionData
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|dsps
op_eq
id|A_COMPLETED_SELECTION_AS_TARGET
)paren
(brace
multiline_comment|/* we&squot;ve just disconnected from the bus, do nothing since&n;&t;&t; * a return here will re-run the queued command slot&n;&t;&t; * that may have been interrupted by the initial selection */
id|DEBUG
c_func
(paren
(paren
l_string|&quot; SELECTION COMPLETED&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dsps
op_amp
l_int|0xfffff0f0
)paren
op_eq
id|A_MSG_IN
)paren
(brace
id|resume_offset
op_assign
id|process_message
c_func
(paren
id|host
comma
id|hostdata
comma
id|SCp
comma
id|dsp
comma
id|dsps
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dsps
op_amp
l_int|0xfffff000
)paren
op_eq
l_int|0
)paren
(brace
id|__u8
id|i
op_assign
(paren
id|dsps
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
comma
id|j
op_assign
(paren
id|dsps
op_amp
l_int|0xf00
)paren
op_rshift
l_int|8
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: (%d:%d), unhandled script condition %s %s at %04x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|NCR_700_condition
(braket
id|i
)braket
comma
id|NCR_700_phase
(braket
id|j
)braket
comma
id|dsp
op_minus
id|hostdata-&gt;pScript
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCp
op_ne
l_int|NULL
)paren
(brace
id|print_command
c_func
(paren
id|SCp-&gt;cmnd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCp-&gt;use_sg
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCp-&gt;use_sg
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot; SG[%d].length = %d, move_insn=%08x, addr %08x&bslash;n&quot;
comma
id|i
comma
(paren
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCp-&gt;buffer
)paren
(braket
id|i
)braket
dot
id|length
comma
(paren
(paren
r_struct
id|NCR_700_command_slot
op_star
)paren
id|SCp-&gt;host_scribble
)paren
op_member_access_from_pointer
id|SG
(braket
id|i
)braket
dot
id|ins
comma
(paren
(paren
r_struct
id|NCR_700_command_slot
op_star
)paren
id|SCp-&gt;host_scribble
)paren
op_member_access_from_pointer
id|SG
(braket
id|i
)braket
dot
id|pAddr
)paren
suffix:semicolon
)brace
)brace
)brace
id|NCR_700_internal_bus_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dsps
op_amp
l_int|0xfffff000
)paren
op_eq
id|A_DEBUG_INTERRUPT
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;scsi%d (%d:%d) DEBUG INTERRUPT %d AT %08x[%04x], continuing&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|dsps
op_amp
l_int|0xfff
comma
id|dsp
comma
id|dsp
op_minus
id|hostdata-&gt;pScript
)paren
suffix:semicolon
id|resume_offset
op_assign
id|dsp
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: (%d:%d), unidentified script interrupt 0x%x at %04x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|dsps
comma
id|dsp
op_minus
id|hostdata-&gt;pScript
)paren
suffix:semicolon
id|NCR_700_internal_bus_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
r_return
id|resume_offset
suffix:semicolon
)brace
multiline_comment|/* We run the 53c700 with selection interrupts always enabled.  This&n; * means that the chip may be selected as soon as the bus frees.  On a&n; * busy bus, this can be before the scripts engine finishes its&n; * processing.  Therefore, part of the selection processing has to be&n; * to find out what the scripts engine is doing and complete the&n; * function if necessary (i.e. process the pending disconnect or save&n; * the interrupted initial selection */
id|STATIC
r_inline
id|__u32
DECL|function|process_selection
id|process_selection
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|__u32
id|dsp
)paren
(brace
id|__u8
id|id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Squash compiler warning */
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|__u32
id|resume_offset
op_assign
l_int|0
suffix:semicolon
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCp
op_assign
id|hostdata-&gt;cmd
suffix:semicolon
id|__u8
id|sbcl
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|5
suffix:semicolon
id|count
op_increment
)paren
(brace
id|id
op_assign
id|NCR_700_readb
c_func
(paren
id|host
comma
id|hostdata-&gt;chip710
ques
c_cond
id|CTEST9_REG
suffix:colon
id|SFBR_REG
)paren
suffix:semicolon
multiline_comment|/* Take out our own ID */
id|id
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|host-&gt;this_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
op_ne
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
id|sbcl
op_assign
id|NCR_700_readb
c_func
(paren
id|host
comma
id|SBCL_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sbcl
op_amp
id|SBCL_IO
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* mark as having been selected rather than reselected */
id|id
op_assign
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* convert to real ID */
id|hostdata-&gt;reselection_id
op_assign
id|id
op_assign
id|bitmap_to_number
c_func
(paren
id|id
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;scsi%d:  Reselected by %d&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|id
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;state
op_eq
id|NCR_700_HOST_BUSY
op_logical_and
id|SCp
op_ne
l_int|NULL
)paren
(brace
r_struct
id|NCR_700_command_slot
op_star
id|slot
op_assign
(paren
r_struct
id|NCR_700_command_slot
op_star
)paren
id|SCp-&gt;host_scribble
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;  ID %d WARNING: RESELECTION OF BUSY HOST, saving cmd %p, slot %p, addr %x [%04x], resume %x!&bslash;n&quot;
comma
id|id
comma
id|hostdata-&gt;cmd
comma
id|slot
comma
id|dsp
comma
id|dsp
op_minus
id|hostdata-&gt;pScript
comma
id|resume_offset
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dsp
op_minus
id|hostdata-&gt;pScript
)paren
(brace
r_case
id|Ent_Disconnect1
suffix:colon
r_case
id|Ent_Disconnect2
suffix:colon
id|save_for_reselection
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|Ent_Disconnect2
op_plus
id|hostdata-&gt;pScript
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Ent_Disconnect3
suffix:colon
r_case
id|Ent_Disconnect4
suffix:colon
id|save_for_reselection
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|Ent_Disconnect4
op_plus
id|hostdata-&gt;pScript
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Ent_Disconnect5
suffix:colon
r_case
id|Ent_Disconnect6
suffix:colon
id|save_for_reselection
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|Ent_Disconnect6
op_plus
id|hostdata-&gt;pScript
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Ent_Disconnect7
suffix:colon
r_case
id|Ent_Disconnect8
suffix:colon
id|save_for_reselection
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|Ent_Disconnect8
op_plus
id|hostdata-&gt;pScript
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Ent_Finish1
suffix:colon
r_case
id|Ent_Finish2
suffix:colon
id|process_script_interrupt
c_func
(paren
id|A_GOOD_STATUS_AFTER_STATUS
comma
id|dsp
comma
id|SCp
comma
id|host
comma
id|hostdata
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|slot-&gt;state
op_assign
id|NCR_700_SLOT_QUEUED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|hostdata-&gt;state
op_assign
id|NCR_700_HOST_BUSY
suffix:semicolon
id|hostdata-&gt;cmd
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* clear any stale simple tag message */
id|hostdata-&gt;msgin
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|NCR_700_dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;msgin
comma
id|MSG_ARRAY_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
l_int|0xff
)paren
(brace
multiline_comment|/* Selected as target, Ignore */
id|resume_offset
op_assign
id|hostdata-&gt;pScript
op_plus
id|Ent_SelectedAsTarget
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hostdata-&gt;tag_negotiated
op_amp
(paren
l_int|1
op_lshift
id|id
)paren
)paren
(brace
id|resume_offset
op_assign
id|hostdata-&gt;pScript
op_plus
id|Ent_GetReselectionWithTag
suffix:semicolon
)brace
r_else
(brace
id|resume_offset
op_assign
id|hostdata-&gt;pScript
op_plus
id|Ent_GetReselectionData
suffix:semicolon
)brace
r_return
id|resume_offset
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|NCR_700_clear_fifo
id|NCR_700_clear_fifo
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_const
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;chip710
)paren
(brace
id|NCR_700_writeb
c_func
(paren
id|CLR_FIFO_710
comma
id|host
comma
id|CTEST8_REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|NCR_700_writeb
c_func
(paren
id|CLR_FIFO
comma
id|host
comma
id|DFIFO_REG
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|NCR_700_flush_fifo
id|NCR_700_flush_fifo
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_const
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;chip710
)paren
(brace
id|NCR_700_writeb
c_func
(paren
id|FLUSH_DMA_FIFO_710
comma
id|host
comma
id|CTEST8_REG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
l_int|0
comma
id|host
comma
id|CTEST8_REG
)paren
suffix:semicolon
)brace
r_else
(brace
id|NCR_700_writeb
c_func
(paren
id|FLUSH_DMA_FIFO
comma
id|host
comma
id|DFIFO_REG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|NCR_700_writeb
c_func
(paren
l_int|0
comma
id|host
comma
id|DFIFO_REG
)paren
suffix:semicolon
)brace
)brace
id|STATIC
r_int
DECL|function|NCR_700_start_command
id|NCR_700_start_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCp
)paren
(brace
r_struct
id|NCR_700_command_slot
op_star
id|slot
op_assign
(paren
r_struct
id|NCR_700_command_slot
op_star
)paren
id|SCp-&gt;host_scribble
suffix:semicolon
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|SCp-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__u16
id|count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* for IDENTIFY message */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;state
op_ne
id|NCR_700_HOST_FREE
)paren
(brace
multiline_comment|/* keep this inside the lock to close the race window where&n;&t;&t; * the running command finishes on another CPU while we don&squot;t&n;&t;&t; * change the state to queued on this one */
id|slot-&gt;state
op_assign
id|NCR_700_SLOT_QUEUED
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;scsi%d: host busy, queueing command %p, slot %p&bslash;n&quot;
comma
id|SCp-&gt;host-&gt;host_no
comma
id|slot-&gt;cmnd
comma
id|slot
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|hostdata-&gt;state
op_assign
id|NCR_700_HOST_BUSY
suffix:semicolon
id|hostdata-&gt;cmd
op_assign
id|SCp
suffix:semicolon
id|slot-&gt;state
op_assign
id|NCR_700_SLOT_BUSY
suffix:semicolon
multiline_comment|/* keep interrupts disabled until we have the command correctly&n;&t; * set up so we cannot take a selection interrupt */
id|hostdata-&gt;msgout
(braket
l_int|0
)braket
op_assign
id|NCR_700_identify
c_func
(paren
id|SCp-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|REQUEST_SENSE
comma
id|SCp-&gt;lun
)paren
suffix:semicolon
multiline_comment|/* for INQUIRY or REQUEST_SENSE commands, we cannot be sure&n;&t; * if the negotiated transfer parameters still hold, so&n;&t; * always renegotiate them */
r_if
c_cond
(paren
id|SCp-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_or
id|SCp-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
(brace
id|NCR_700_clear_flag
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_NEGOTIATED_SYNC
)paren
suffix:semicolon
)brace
multiline_comment|/* REQUEST_SENSE is asking for contingent I_T_L(_Q) status.&n;&t; * If a contingent allegiance condition exists, the device&n;&t; * will refuse all tags, so send the request sense as untagged&n;&t; * */
r_if
c_cond
(paren
(paren
id|hostdata-&gt;tag_negotiated
op_amp
(paren
l_int|1
op_lshift
id|SCp-&gt;target
)paren
)paren
op_logical_and
(paren
id|slot-&gt;tag
op_ne
id|NCR_700_NO_TAG
op_logical_and
id|SCp-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|REQUEST_SENSE
)paren
)paren
(brace
id|hostdata-&gt;msgout
(braket
id|count
op_increment
)braket
op_assign
id|A_SIMPLE_TAG_MSG
suffix:semicolon
id|hostdata-&gt;msgout
(braket
id|count
op_increment
)braket
op_assign
id|slot-&gt;tag
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;fast
op_logical_and
id|NCR_700_is_flag_clear
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_NEGOTIATED_SYNC
)paren
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|hostdata-&gt;msgout
(braket
id|count
)braket
comma
id|NCR_700_SDTR_msg
comma
r_sizeof
(paren
id|NCR_700_SDTR_msg
)paren
)paren
suffix:semicolon
id|count
op_add_assign
r_sizeof
(paren
id|NCR_700_SDTR_msg
)paren
suffix:semicolon
id|NCR_700_set_flag
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_BEGIN_SYNC_NEGOTIATION
)paren
suffix:semicolon
)brace
id|script_patch_16
c_func
(paren
id|hostdata-&gt;script
comma
id|MessageCount
comma
id|count
)paren
suffix:semicolon
id|script_patch_ID
c_func
(paren
id|hostdata-&gt;script
comma
id|Device_ID
comma
l_int|1
op_lshift
id|SCp-&gt;target
)paren
suffix:semicolon
id|script_patch_32_abs
c_func
(paren
id|hostdata-&gt;script
comma
id|CommandAddress
comma
id|slot-&gt;pCmd
)paren
suffix:semicolon
id|script_patch_16
c_func
(paren
id|hostdata-&gt;script
comma
id|CommandCount
comma
id|SCp-&gt;cmd_len
)paren
suffix:semicolon
multiline_comment|/* finally plumb the beginning of the SG list into the script&n;&t; * */
id|script_patch_32_abs
c_func
(paren
id|hostdata-&gt;script
comma
id|SGScriptStartAddress
comma
id|to32bit
c_func
(paren
op_amp
id|slot-&gt;pSG
(braket
l_int|0
)braket
dot
id|ins
)paren
)paren
suffix:semicolon
id|NCR_700_clear_fifo
c_func
(paren
id|SCp-&gt;host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;resume_offset
op_eq
l_int|0
)paren
(brace
id|slot-&gt;resume_offset
op_assign
id|hostdata-&gt;pScript
suffix:semicolon
)brace
multiline_comment|/* now perform all the writebacks and invalidates */
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;msgout
comma
id|count
)paren
suffix:semicolon
id|NCR_700_dma_cache_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;msgin
comma
id|MSG_ARRAY_SIZE
)paren
suffix:semicolon
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|SCp-&gt;cmnd
comma
id|SCp-&gt;cmd_len
)paren
suffix:semicolon
id|NCR_700_dma_cache_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|hostdata-&gt;status
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set the synchronous period/offset */
id|NCR_700_writeb
c_func
(paren
id|NCR_700_get_SXFER
c_func
(paren
id|SCp-&gt;device
)paren
comma
id|SCp-&gt;host
comma
id|SXFER_REG
)paren
suffix:semicolon
id|NCR_700_writel
c_func
(paren
id|slot-&gt;temp
comma
id|SCp-&gt;host
comma
id|TEMP_REG
)paren
suffix:semicolon
id|NCR_700_writel
c_func
(paren
id|slot-&gt;resume_offset
comma
id|SCp-&gt;host
comma
id|DSP_REG
)paren
suffix:semicolon
multiline_comment|/* allow interrupts here so that if we&squot;re selected we can take&n;&t; * a selection interrupt.  The script start may not be&n;&t; * effective in this case, but the selection interrupt will&n;&t; * save our command in that case */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_void
DECL|function|NCR_700_intr
id|NCR_700_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
(paren
r_struct
id|Scsi_Host
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|__u8
id|istat
suffix:semicolon
id|__u32
id|resume_offset
op_assign
l_int|0
suffix:semicolon
id|__u8
id|pun
op_assign
l_int|0xff
comma
id|lun
op_assign
l_int|0xff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|istat
op_assign
id|NCR_700_readb
c_func
(paren
id|host
comma
id|ISTAT_REG
)paren
)paren
op_amp
(paren
id|SCSI_INT_PENDING
op_or
id|DMA_INT_PENDING
)paren
)paren
(brace
id|__u32
id|dsps
suffix:semicolon
id|__u8
id|sstat0
op_assign
l_int|0
comma
id|dstat
op_assign
l_int|0
suffix:semicolon
id|__u32
id|dsp
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCp
op_assign
id|hostdata-&gt;cmd
suffix:semicolon
r_enum
id|NCR_700_Host_State
id|state
suffix:semicolon
id|state
op_assign
id|hostdata-&gt;state
suffix:semicolon
id|SCp
op_assign
id|hostdata-&gt;cmd
suffix:semicolon
r_if
c_cond
(paren
id|istat
op_amp
id|SCSI_INT_PENDING
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|sstat0
op_assign
id|NCR_700_readb
c_func
(paren
id|host
comma
id|SSTAT0_REG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istat
op_amp
id|DMA_INT_PENDING
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|dstat
op_assign
id|NCR_700_readb
c_func
(paren
id|host
comma
id|DSTAT_REG
)paren
suffix:semicolon
)brace
id|dsps
op_assign
id|NCR_700_readl
c_func
(paren
id|host
comma
id|DSPS_REG
)paren
suffix:semicolon
id|dsp
op_assign
id|NCR_700_readl
c_func
(paren
id|host
comma
id|DSP_REG
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;scsi%d: istat %02x sstat0 %02x dstat %02x dsp %04x[%08x] dsps 0x%x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|istat
comma
id|sstat0
comma
id|dstat
comma
(paren
id|dsp
op_minus
(paren
id|__u32
)paren
(paren
id|hostdata-&gt;pScript
)paren
)paren
op_div
l_int|4
comma
id|dsp
comma
id|dsps
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCp
op_ne
l_int|NULL
)paren
(brace
id|pun
op_assign
id|SCp-&gt;target
suffix:semicolon
id|lun
op_assign
id|SCp-&gt;lun
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sstat0
op_amp
id|SCSI_RESET_DETECTED
)paren
(brace
id|Scsi_Device
op_star
id|SDp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|NCR_700_HOST_BUSY
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: Bus Reset detected, executing command %p, slot %p, dsp %08x[%04x]&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|SCp
comma
id|SCp
op_eq
l_int|NULL
ques
c_cond
l_int|NULL
suffix:colon
id|SCp-&gt;host_scribble
comma
id|dsp
comma
id|dsp
op_minus
id|hostdata-&gt;pScript
)paren
suffix:semicolon
multiline_comment|/* clear all the negotiated parameters */
r_for
c_loop
(paren
id|SDp
op_assign
id|host-&gt;host_queue
suffix:semicolon
id|SDp
op_ne
l_int|NULL
suffix:semicolon
id|SDp
op_assign
id|SDp-&gt;next
)paren
(brace
id|SDp-&gt;hostdata
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* clear all the slots and their pending commands */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NCR_700_COMMAND_SLOTS_PER_HOST
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCp
suffix:semicolon
r_struct
id|NCR_700_command_slot
op_star
id|slot
op_assign
op_amp
id|hostdata-&gt;slots
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|slot-&gt;state
op_eq
id|NCR_700_SLOT_FREE
)paren
(brace
r_continue
suffix:semicolon
)brace
id|SCp
op_assign
id|slot-&gt;cmnd
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot; failing command because of reset, slot %p, cmnd %p&bslash;n&quot;
comma
id|slot
comma
id|SCp
)paren
suffix:semicolon
id|free_slot
c_func
(paren
id|slot
comma
id|hostdata
)paren
suffix:semicolon
id|SCp-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|NCR_700_set_depth
c_func
(paren
id|SCp-&gt;device
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* NOTE: deadlock potential here: we&n;&t;&t;&t;&t; * rely on mid-layer guarantees that&n;&t;&t;&t;&t; * scsi_done won&squot;t try to issue the&n;&t;&t;&t;&t; * command again otherwise we&squot;ll&n;&t;&t;&t;&t; * deadlock on the&n;&t;&t;&t;&t; * hostdata-&gt;state_lock */
id|SCp-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|SCp
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|SCp
)paren
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|25
)paren
suffix:semicolon
id|NCR_700_chip_setup
c_func
(paren
id|host
)paren
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|NCR_700_HOST_FREE
suffix:semicolon
id|hostdata-&gt;cmd
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sstat0
op_amp
id|SELECTION_TIMEOUT
)paren
(brace
id|DEBUG
c_func
(paren
(paren
l_string|&quot;scsi%d: (%d:%d) selection timeout&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
)paren
)paren
suffix:semicolon
id|NCR_700_scsi_done
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sstat0
op_amp
id|PHASE_MISMATCH
)paren
(brace
r_struct
id|NCR_700_command_slot
op_star
id|slot
op_assign
(paren
id|SCp
op_eq
l_int|NULL
)paren
ques
c_cond
l_int|NULL
suffix:colon
(paren
r_struct
id|NCR_700_command_slot
op_star
)paren
id|SCp-&gt;host_scribble
suffix:semicolon
r_if
c_cond
(paren
id|dsp
op_eq
id|Ent_SendMessage
op_plus
l_int|8
op_plus
id|hostdata-&gt;pScript
)paren
(brace
multiline_comment|/* It wants to reply to some part of&n;&t;&t;&t;&t; * our message */
macro_line|#ifdef NCR_700_DEBUG
id|__u32
id|temp
op_assign
id|NCR_700_readl
c_func
(paren
id|host
comma
id|TEMP_REG
)paren
suffix:semicolon
r_int
id|count
op_assign
(paren
id|hostdata-&gt;script
(braket
id|Ent_SendMessage
op_div
l_int|4
)braket
op_amp
l_int|0xffffff
)paren
op_minus
(paren
(paren
id|NCR_700_readl
c_func
(paren
id|host
comma
id|DBC_REG
)paren
op_amp
l_int|0xffffff
)paren
op_plus
id|NCR_700_data_residual
c_func
(paren
id|host
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d (%d:%d) PHASE MISMATCH IN SEND MESSAGE %d remain, return %p[%04x], phase %s&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|count
comma
(paren
r_void
op_star
)paren
id|temp
comma
id|temp
op_minus
id|hostdata-&gt;pScript
comma
id|sbcl_to_string
c_func
(paren
id|NCR_700_readb
c_func
(paren
id|host
comma
id|SBCL_REG
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|resume_offset
op_assign
id|hostdata-&gt;pScript
op_plus
id|Ent_SendMessagePhaseMismatch
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dsp
op_ge
id|to32bit
c_func
(paren
op_amp
id|slot-&gt;pSG
(braket
l_int|0
)braket
dot
id|ins
)paren
op_logical_and
id|dsp
op_le
id|to32bit
c_func
(paren
op_amp
id|slot-&gt;pSG
(braket
id|NCR_700_SG_SEGMENTS
)braket
dot
id|ins
)paren
)paren
(brace
r_int
id|data_transfer
op_assign
id|NCR_700_readl
c_func
(paren
id|host
comma
id|DBC_REG
)paren
op_amp
l_int|0xffffff
suffix:semicolon
r_int
id|SGcount
op_assign
(paren
id|dsp
op_minus
id|to32bit
c_func
(paren
op_amp
id|slot-&gt;pSG
(braket
l_int|0
)braket
dot
id|ins
)paren
)paren
op_div
r_sizeof
(paren
r_struct
id|NCR_700_SG_List
)paren
suffix:semicolon
r_int
id|residual
op_assign
id|NCR_700_data_residual
c_func
(paren
id|host
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef NCR_700_DEBUG
id|__u32
id|naddr
op_assign
id|NCR_700_readl
c_func
(paren
id|host
comma
id|DNAD_REG
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;scsi%d: (%d:%d) Expected phase mismatch in slot-&gt;SG[%d], transferred 0x%x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|SGcount
comma
id|data_transfer
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCp-&gt;cmnd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|residual
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d: (%d:%d) Expected phase mismatch in slot-&gt;SG[%d], transferred 0x%x, residual %d&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|SGcount
comma
id|data_transfer
comma
id|residual
)paren
suffix:semicolon
)brace
macro_line|#endif
id|data_transfer
op_add_assign
id|residual
suffix:semicolon
r_if
c_cond
(paren
id|data_transfer
op_ne
l_int|0
)paren
(brace
r_int
id|count
suffix:semicolon
id|__u32
id|pAddr
suffix:semicolon
id|SGcount
op_decrement
suffix:semicolon
id|count
op_assign
(paren
id|bS_to_cpu
c_func
(paren
id|slot-&gt;SG
(braket
id|SGcount
)braket
dot
id|ins
)paren
op_amp
l_int|0x00ffffff
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot;DATA TRANSFER MISMATCH, count = %d, transferred %d&bslash;n&quot;
comma
id|count
comma
id|count
op_minus
id|data_transfer
)paren
)paren
suffix:semicolon
id|slot-&gt;SG
(braket
id|SGcount
)braket
dot
id|ins
op_and_assign
id|bS_to_host
c_func
(paren
l_int|0xff000000
)paren
suffix:semicolon
id|slot-&gt;SG
(braket
id|SGcount
)braket
dot
id|ins
op_or_assign
id|bS_to_host
c_func
(paren
id|data_transfer
)paren
suffix:semicolon
id|pAddr
op_assign
id|bS_to_cpu
c_func
(paren
id|slot-&gt;SG
(braket
id|SGcount
)braket
dot
id|pAddr
)paren
suffix:semicolon
id|pAddr
op_add_assign
(paren
id|count
op_minus
id|data_transfer
)paren
suffix:semicolon
macro_line|#ifdef NCR_700_DEBUG
r_if
c_cond
(paren
id|pAddr
op_ne
id|naddr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%d (%d:%d) transfer mismatch pAddr=%lx, naddr=%lx, data_transfer=%d, residual=%d&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
(paren
r_int
r_int
)paren
id|pAddr
comma
(paren
r_int
r_int
)paren
id|naddr
comma
id|data_transfer
comma
id|residual
)paren
suffix:semicolon
)brace
macro_line|#endif
id|slot-&gt;SG
(braket
id|SGcount
)braket
dot
id|pAddr
op_assign
id|bS_to_host
c_func
(paren
id|pAddr
)paren
suffix:semicolon
)brace
multiline_comment|/* set the executed moves to nops */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SGcount
suffix:semicolon
id|i
op_increment
)paren
(brace
id|slot-&gt;SG
(braket
id|i
)braket
dot
id|ins
op_assign
id|bS_to_host
c_func
(paren
id|SCRIPT_NOP
)paren
suffix:semicolon
id|slot-&gt;SG
(braket
id|i
)braket
dot
id|pAddr
op_assign
l_int|0
suffix:semicolon
)brace
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|slot-&gt;SG
comma
r_sizeof
(paren
id|slot-&gt;SG
)paren
)paren
suffix:semicolon
multiline_comment|/* and pretend we disconnected after&n;&t;&t;&t;&t; * the command phase */
id|resume_offset
op_assign
id|hostdata-&gt;pScript
op_plus
id|Ent_MsgInDuringData
suffix:semicolon
multiline_comment|/* make sure all the data is flushed */
id|NCR_700_flush_fifo
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
r_else
(brace
id|__u8
id|sbcl
op_assign
id|NCR_700_readb
c_func
(paren
id|host
comma
id|SBCL_REG
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: (%d:%d) phase mismatch at %04x, phase %s&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|dsp
op_minus
id|hostdata-&gt;pScript
comma
id|sbcl_to_string
c_func
(paren
id|sbcl
)paren
)paren
suffix:semicolon
id|NCR_700_internal_bus_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|sstat0
op_amp
id|SCSI_GROSS_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: (%d:%d) GROSS ERROR&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
)paren
suffix:semicolon
id|NCR_700_scsi_done
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sstat0
op_amp
id|PARITY_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: (%d:%d) PARITY ERROR&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
)paren
suffix:semicolon
id|NCR_700_scsi_done
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dstat
op_amp
id|SCRIPT_INT_RECEIVED
)paren
(brace
id|DEBUG
c_func
(paren
(paren
l_string|&quot;scsi%d: (%d:%d) ====&gt;SCRIPT INTERRUPT&lt;====&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
)paren
)paren
suffix:semicolon
id|resume_offset
op_assign
id|process_script_interrupt
c_func
(paren
id|dsps
comma
id|dsp
comma
id|SCp
comma
id|host
comma
id|hostdata
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dstat
op_amp
(paren
id|ILGL_INST_DETECTED
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: (%d:%d) Illegal Instruction detected at 0x%08x[0x%x]!!!&bslash;n&quot;
l_string|&quot;         Please email James.Bottomley@HansenPartnership.com with the details&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|dsp
comma
id|dsp
op_minus
id|hostdata-&gt;pScript
)paren
suffix:semicolon
id|NCR_700_scsi_done
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dstat
op_amp
(paren
id|WATCH_DOG_INTERRUPT
op_or
id|ABORTED
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: (%d:%d) serious DMA problem, dstat=%02x&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|pun
comma
id|lun
comma
id|dstat
)paren
suffix:semicolon
id|NCR_700_scsi_done
c_func
(paren
id|hostdata
comma
id|SCp
comma
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/* NOTE: selection interrupt processing MUST occur&n;&t;&t; * after script interrupt processing to correctly cope&n;&t;&t; * with the case where we process a disconnect and&n;&t;&t; * then get reselected before we process the&n;&t;&t; * disconnection */
r_if
c_cond
(paren
id|sstat0
op_amp
id|SELECTED
)paren
(brace
multiline_comment|/* FIXME: It currently takes at least FOUR&n;&t;&t;&t; * interrupts to complete a command that&n;&t;&t;&t; * disconnects: one for the disconnect, one&n;&t;&t;&t; * for the reselection, one to get the&n;&t;&t;&t; * reselection data and one to complete the&n;&t;&t;&t; * command.  If we guess the reselected&n;&t;&t;&t; * command here and prepare it, we only need&n;&t;&t;&t; * to get a reselection data interrupt if we&n;&t;&t;&t; * guessed wrongly.  Since the interrupt&n;&t;&t;&t; * overhead is much greater than the command&n;&t;&t;&t; * setup, this would be an efficient&n;&t;&t;&t; * optimisation particularly as we probably&n;&t;&t;&t; * only have one outstanding command on a&n;&t;&t;&t; * target most of the time */
id|resume_offset
op_assign
id|process_selection
c_func
(paren
id|host
comma
id|dsp
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|resume_offset
)paren
(brace
r_if
c_cond
(paren
id|hostdata-&gt;state
op_ne
id|NCR_700_HOST_BUSY
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d: Driver error: resume at 0x%08x [0x%04x] with non busy host!&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|resume_offset
comma
id|resume_offset
op_minus
id|hostdata-&gt;pScript
)paren
suffix:semicolon
id|hostdata-&gt;state
op_assign
id|NCR_700_HOST_BUSY
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
(paren
l_string|&quot;Attempting to resume at %x&bslash;n&quot;
comma
id|resume_offset
)paren
)paren
suffix:semicolon
id|NCR_700_clear_fifo
c_func
(paren
id|host
)paren
suffix:semicolon
id|NCR_700_writel
c_func
(paren
id|resume_offset
comma
id|host
comma
id|DSP_REG
)paren
suffix:semicolon
)brace
multiline_comment|/* There is probably a technical no-no about this: If we&squot;re a&n;&t; * shared interrupt and we got this interrupt because the&n;&t; * other device needs servicing not us, we&squot;re still going to&n;&t; * check our queued commands here---of course, there shouldn&squot;t&n;&t; * be any outstanding.... */
r_if
c_cond
(paren
id|hostdata-&gt;state
op_eq
id|NCR_700_HOST_FREE
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NCR_700_COMMAND_SLOTS_PER_HOST
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* fairness: always run the queue from the last&n;&t;&t;&t; * position we left off */
r_int
id|j
op_assign
(paren
id|i
op_plus
id|hostdata-&gt;saved_slot_position
)paren
op_mod
id|NCR_700_COMMAND_SLOTS_PER_HOST
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;slots
(braket
id|j
)braket
dot
id|state
op_ne
id|NCR_700_SLOT_QUEUED
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|NCR_700_start_command
c_func
(paren
id|hostdata-&gt;slots
(braket
id|j
)braket
dot
id|cmnd
)paren
)paren
(brace
id|DEBUG
c_func
(paren
(paren
l_string|&quot;scsi%d: Issuing saved command slot %p, cmd %p&bslash;t&bslash;n&quot;
comma
id|host-&gt;host_no
comma
op_amp
id|hostdata-&gt;slots
(braket
id|j
)braket
comma
id|hostdata-&gt;slots
(braket
id|j
)braket
dot
id|cmnd
)paren
)paren
suffix:semicolon
id|hostdata-&gt;saved_slot_position
op_assign
id|j
op_plus
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|out_unlock
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
id|host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME: Need to put some proc information in and plumb it&n; * into the scsi proc system */
id|STATIC
r_int
DECL|function|NCR_700_proc_directory_info
id|NCR_700_proc_directory_info
c_func
(paren
r_char
op_star
id|proc_buf
comma
r_char
op_star
op_star
id|startp
comma
id|off_t
id|offset
comma
r_int
id|bytes_available
comma
r_int
id|host_no
comma
r_int
id|write
)paren
(brace
r_static
r_char
id|buf
(braket
l_int|4096
)braket
suffix:semicolon
multiline_comment|/* 1 page should be sufficient */
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|scsi_hostlist
suffix:semicolon
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
suffix:semicolon
id|Scsi_Device
op_star
id|SDp
suffix:semicolon
r_while
c_loop
(paren
id|host
op_ne
l_int|NULL
op_logical_and
id|host-&gt;host_no
op_ne
id|host_no
)paren
(brace
id|host
op_assign
id|host-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|write
)paren
(brace
multiline_comment|/* FIXME: Clear internal statistics here */
r_return
l_int|0
suffix:semicolon
)brace
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
op_amp
id|buf
(braket
id|len
)braket
comma
l_string|&quot;Total commands outstanding: %d&bslash;n&quot;
comma
id|hostdata-&gt;command_slot_count
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
op_amp
id|buf
(braket
id|len
)braket
comma
l_string|&quot;&bslash;&n;Target&t;Depth  Active  Next Tag&bslash;n&bslash;&n;======&t;=====  ======  ========&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|SDp
op_assign
id|host-&gt;host_queue
suffix:semicolon
id|SDp
op_ne
l_int|NULL
suffix:semicolon
id|SDp
op_assign
id|SDp-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
op_amp
id|buf
(braket
id|len
)braket
comma
l_string|&quot; %2d:%2d   %4d    %4d      %4d&bslash;n&quot;
comma
id|SDp-&gt;id
comma
id|SDp-&gt;lun
comma
id|SDp-&gt;queue_depth
comma
id|NCR_700_get_depth
c_func
(paren
id|SDp
)paren
comma
id|SDp-&gt;current_tag
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|len
op_sub_assign
id|offset
)paren
op_le
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
id|bytes_available
)paren
(brace
id|len
op_assign
id|bytes_available
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|proc_buf
comma
id|buf
op_plus
id|offset
comma
id|len
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
id|STATIC
r_int
DECL|function|NCR_700_queuecommand
id|NCR_700_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCp
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|SCp-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|__u32
id|move_ins
suffix:semicolon
r_int
id|pci_direction
suffix:semicolon
r_struct
id|NCR_700_command_slot
op_star
id|slot
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_if
c_cond
(paren
id|hostdata-&gt;command_slot_count
op_ge
id|NCR_700_COMMAND_SLOTS_PER_HOST
)paren
(brace
multiline_comment|/* We&squot;re over our allocation, this should never happen&n;&t;&t; * since we report the max allocation to the mid layer */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d: Command depth has gone over queue depth&bslash;n&quot;
comma
id|SCp-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|NCR_700_get_depth
c_func
(paren
id|SCp-&gt;device
)paren
op_ne
l_int|0
op_logical_and
op_logical_neg
(paren
id|hostdata-&gt;tag_negotiated
op_amp
(paren
l_int|1
op_lshift
id|SCp-&gt;target
)paren
)paren
)paren
(brace
id|DEBUG
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;scsi%d (%d:%d) has non zero depth %d&bslash;n&quot;
comma
id|SCp-&gt;host-&gt;host_no
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
comma
id|NCR_700_get_depth
c_func
(paren
id|SCp-&gt;device
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|NCR_700_get_depth
c_func
(paren
id|SCp-&gt;device
)paren
op_ge
id|NCR_700_MAX_TAGS
)paren
(brace
id|DEBUG
c_func
(paren
(paren
id|KERN_ERR
l_string|&quot;scsi%d (%d:%d) has max tag depth %d&bslash;n&quot;
comma
id|SCp-&gt;host-&gt;host_no
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
comma
id|NCR_700_get_depth
c_func
(paren
id|SCp-&gt;device
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|NCR_700_set_depth
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_get_depth
c_func
(paren
id|SCp-&gt;device
)paren
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* begin the command here */
multiline_comment|/* no need to check for NULL, test for command_slot_cound above&n;&t; * ensures a slot is free */
id|slot
op_assign
id|find_empty_slot
c_func
(paren
id|hostdata
)paren
suffix:semicolon
id|slot-&gt;cmnd
op_assign
id|SCp
suffix:semicolon
id|SCp-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|SCp-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|slot
suffix:semicolon
id|SCp-&gt;SCp.ptr
op_assign
l_int|NULL
suffix:semicolon
id|SCp-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef NCR_700_DEBUG
id|printk
c_func
(paren
l_string|&quot;53c700: scsi%d, command &quot;
comma
id|SCp-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCp-&gt;cmnd
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|SCp-&gt;device-&gt;tagged_supported
op_logical_and
op_logical_neg
id|SCp-&gt;device-&gt;tagged_queue
op_logical_and
(paren
id|hostdata-&gt;tag_negotiated
op_amp
(paren
l_int|1
op_lshift
id|SCp-&gt;target
)paren
)paren
op_eq
l_int|0
op_logical_and
id|NCR_700_is_flag_clear
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_BEGIN_TAG_QUEUEING
)paren
)paren
(brace
multiline_comment|/* upper layer has indicated tags are supported.  We don&squot;t&n;&t;&t; * necessarily believe it yet.&n;&t;&t; *&n;&t;&t; * NOTE: There is a danger here: the mid layer supports&n;&t;&t; * tag queuing per LUN.  We only support it per PUN because&n;&t;&t; * of potential reselection issues */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi%d: (%d:%d) Enabling Tag Command Queuing&bslash;n&quot;
comma
id|SCp-&gt;device-&gt;host-&gt;host_no
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
)paren
suffix:semicolon
id|hostdata-&gt;tag_negotiated
op_or_assign
(paren
l_int|1
op_lshift
id|SCp-&gt;target
)paren
suffix:semicolon
id|NCR_700_set_flag
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_BEGIN_TAG_QUEUEING
)paren
suffix:semicolon
id|SCp-&gt;device-&gt;tagged_queue
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hostdata-&gt;tag_negotiated
op_amp
(paren
l_int|1
op_lshift
id|SCp-&gt;target
)paren
)paren
(brace
r_struct
id|NCR_700_command_slot
op_star
id|old
op_assign
id|find_ITL_Nexus
c_func
(paren
id|hostdata
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
)paren
suffix:semicolon
macro_line|#ifdef NCR_700_TAG_DEBUG
r_struct
id|NCR_700_command_slot
op_star
id|found
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|old
op_ne
l_int|NULL
op_logical_and
id|old-&gt;tag
op_eq
id|SCp-&gt;device-&gt;current_tag
)paren
(brace
multiline_comment|/* On some badly starving drives, this can be&n;&t;&t;&t; * a frequent occurance, so print the message&n;&t;&t;&t; * only once */
r_if
c_cond
(paren
id|NCR_700_is_flag_clear
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_TAG_STARVATION_WARNED
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi%d (%d:%d) Target is suffering from tag starvation.&bslash;n&quot;
comma
id|SCp-&gt;host-&gt;host_no
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
)paren
suffix:semicolon
id|NCR_700_set_flag
c_func
(paren
id|SCp-&gt;device
comma
id|NCR_700_DEV_TAG_STARVATION_WARNED
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
id|slot-&gt;tag
op_assign
id|SCp-&gt;device-&gt;current_tag
op_increment
suffix:semicolon
macro_line|#ifdef NCR_700_TAG_DEBUG
r_while
c_loop
(paren
(paren
id|found
op_assign
id|find_ITLQ_Nexus
c_func
(paren
id|hostdata
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
comma
id|slot-&gt;tag
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&bslash;n**ERROR** already using tag %d, but oldest is %d&bslash;n&quot;
comma
id|slot-&gt;tag
comma
(paren
id|old
op_eq
l_int|NULL
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
id|old-&gt;tag
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  FOUND = %p, tag = %d, pun = %d, lun = %d&bslash;n&quot;
comma
id|found
comma
id|found-&gt;tag
comma
id|found-&gt;cmnd-&gt;target
comma
id|found-&gt;cmnd-&gt;lun
)paren
suffix:semicolon
id|slot-&gt;tag
op_assign
id|SCp-&gt;device-&gt;current_tag
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Tag list is: &quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|old
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|old-&gt;cmnd-&gt;target
op_eq
id|SCp-&gt;target
op_logical_and
id|old-&gt;cmnd-&gt;lun
op_eq
id|SCp-&gt;lun
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%d &quot;
comma
id|old-&gt;tag
)paren
suffix:semicolon
)brace
id|old
op_assign
id|old-&gt;ITL_back
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|hash
op_assign
id|hash_ITLQ
c_func
(paren
id|SCp-&gt;target
comma
id|SCp-&gt;lun
comma
id|slot-&gt;tag
)paren
suffix:semicolon
multiline_comment|/* link into the ITLQ hash queues */
id|slot-&gt;ITLQ_forw
op_assign
id|hostdata-&gt;ITLQ_Hash_forw
(braket
id|hash
)braket
suffix:semicolon
id|hostdata-&gt;ITLQ_Hash_forw
(braket
id|hash
)braket
op_assign
id|slot
suffix:semicolon
macro_line|#ifdef NCR_700_TAG_DEBUG
r_if
c_cond
(paren
id|slot-&gt;ITLQ_forw
op_ne
l_int|NULL
op_logical_and
id|slot-&gt;ITLQ_forw-&gt;ITLQ_back
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d (%d:%d) ITLQ_back is not NULL!!!!&bslash;n&quot;
comma
id|SCp-&gt;host-&gt;host_no
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|slot-&gt;ITLQ_forw
op_ne
l_int|NULL
)paren
(brace
id|slot-&gt;ITLQ_forw-&gt;ITLQ_back
op_assign
id|slot
suffix:semicolon
)brace
r_else
id|hostdata-&gt;ITLQ_Hash_back
(braket
id|hash
)braket
op_assign
id|slot
suffix:semicolon
id|slot-&gt;ITLQ_back
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|slot-&gt;tag
op_assign
id|NCR_700_NO_TAG
suffix:semicolon
)brace
multiline_comment|/* link into the ITL hash queues */
id|hash
op_assign
id|hash_ITL
c_func
(paren
id|SCp-&gt;target
comma
id|SCp-&gt;lun
)paren
suffix:semicolon
id|slot-&gt;ITL_forw
op_assign
id|hostdata-&gt;ITL_Hash_forw
(braket
id|hash
)braket
suffix:semicolon
id|hostdata-&gt;ITL_Hash_forw
(braket
id|hash
)braket
op_assign
id|slot
suffix:semicolon
macro_line|#ifdef NCR_700_TAG_DEBUG
r_if
c_cond
(paren
id|slot-&gt;ITL_forw
op_ne
l_int|NULL
op_logical_and
id|slot-&gt;ITL_forw-&gt;ITL_back
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi%d (%d:%d) ITL_back is not NULL!!!!&bslash;n&quot;
comma
id|SCp-&gt;host-&gt;host_no
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|slot-&gt;ITL_forw
op_ne
l_int|NULL
)paren
(brace
id|slot-&gt;ITL_forw-&gt;ITL_back
op_assign
id|slot
suffix:semicolon
)brace
r_else
id|hostdata-&gt;ITL_Hash_back
(braket
id|hash
)braket
op_assign
id|slot
suffix:semicolon
id|slot-&gt;ITL_back
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* sanity check: some of the commands generated by the mid-layer&n;&t; * have an eccentric idea of their sc_data_direction */
r_if
c_cond
(paren
op_logical_neg
id|SCp-&gt;use_sg
op_logical_and
op_logical_neg
id|SCp-&gt;request_bufflen
op_logical_and
id|SCp-&gt;sc_data_direction
op_ne
id|SCSI_DATA_NONE
)paren
(brace
macro_line|#ifdef NCR_700_DEBUG
id|printk
c_func
(paren
l_string|&quot;53c700: Command&quot;
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCp-&gt;cmnd
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Has wrong data direction %d&bslash;n&quot;
comma
id|SCp-&gt;sc_data_direction
)paren
suffix:semicolon
macro_line|#endif
id|SCp-&gt;sc_data_direction
op_assign
id|SCSI_DATA_NONE
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|SCp-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|REQUEST_SENSE
suffix:colon
multiline_comment|/* clear the internal sense magic */
id|SCp-&gt;cmnd
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fall through */
r_default
suffix:colon
(brace
)brace
multiline_comment|/* OK, get it from the command */
r_switch
c_cond
(paren
id|SCp-&gt;sc_data_direction
)paren
(brace
r_case
id|SCSI_DATA_UNKNOWN
suffix:colon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;53c700: Unknown command for data direction &quot;
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCp-&gt;cmnd
)paren
suffix:semicolon
id|move_ins
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSI_DATA_NONE
suffix:colon
id|move_ins
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSI_DATA_READ
suffix:colon
id|move_ins
op_assign
id|SCRIPT_MOVE_DATA_IN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSI_DATA_WRITE
suffix:colon
id|move_ins
op_assign
id|SCRIPT_MOVE_DATA_OUT
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* now build the scatter gather list */
id|pci_direction
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|SCp-&gt;sc_data_direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|move_ins
op_ne
l_int|0
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|sg_count
suffix:semicolon
id|dma_addr_t
id|vPtr
op_assign
l_int|0
suffix:semicolon
id|__u32
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|SCp-&gt;use_sg
)paren
(brace
id|sg_count
op_assign
id|pci_map_sg
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|SCp-&gt;buffer
comma
id|SCp-&gt;use_sg
comma
id|pci_direction
)paren
suffix:semicolon
)brace
r_else
(brace
id|vPtr
op_assign
id|pci_map_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|SCp-&gt;request_buffer
comma
id|SCp-&gt;request_bufflen
comma
id|pci_direction
)paren
suffix:semicolon
id|count
op_assign
id|SCp-&gt;request_bufflen
suffix:semicolon
id|slot-&gt;dma_handle
op_assign
id|vPtr
suffix:semicolon
id|sg_count
op_assign
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sg_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|SCp-&gt;use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
id|SCp-&gt;buffer
suffix:semicolon
id|vPtr
op_assign
id|sg_dma_address
c_func
(paren
op_amp
id|sg
(braket
id|i
)braket
)paren
suffix:semicolon
id|count
op_assign
id|sg_dma_len
c_func
(paren
op_amp
id|sg
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|slot-&gt;SG
(braket
id|i
)braket
dot
id|ins
op_assign
id|bS_to_host
c_func
(paren
id|move_ins
op_or
id|count
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot; scatter block %d: move %d[%08x] from 0x%lx&bslash;n&quot;
comma
id|i
comma
id|count
comma
id|slot-&gt;SG
(braket
id|i
)braket
dot
id|ins
comma
(paren
r_int
r_int
)paren
id|vPtr
)paren
)paren
suffix:semicolon
id|slot-&gt;SG
(braket
id|i
)braket
dot
id|pAddr
op_assign
id|bS_to_host
c_func
(paren
id|vPtr
)paren
suffix:semicolon
)brace
id|slot-&gt;SG
(braket
id|i
)braket
dot
id|ins
op_assign
id|bS_to_host
c_func
(paren
id|SCRIPT_RETURN
)paren
suffix:semicolon
id|slot-&gt;SG
(braket
id|i
)braket
dot
id|pAddr
op_assign
l_int|0
suffix:semicolon
id|NCR_700_dma_cache_wback
c_func
(paren
(paren
r_int
r_int
)paren
id|slot-&gt;SG
comma
r_sizeof
(paren
id|slot-&gt;SG
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
(paren
l_string|&quot; SETTING %08lx to %x&bslash;n&quot;
comma
(paren
op_amp
id|slot-&gt;pSG
(braket
id|i
)braket
dot
id|ins
)paren
comma
id|slot-&gt;SG
(braket
id|i
)braket
dot
id|ins
)paren
)paren
suffix:semicolon
)brace
id|slot-&gt;resume_offset
op_assign
l_int|0
suffix:semicolon
id|slot-&gt;pCmd
op_assign
id|pci_map_single
c_func
(paren
id|hostdata-&gt;pci_dev
comma
id|SCp-&gt;cmnd
comma
r_sizeof
(paren
id|SCp-&gt;cmnd
)paren
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|NCR_700_start_command
c_func
(paren
id|SCp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|STATIC
r_int
DECL|function|NCR_700_abort
id|NCR_700_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCp
)paren
(brace
r_struct
id|NCR_700_command_slot
op_star
id|slot
suffix:semicolon
r_struct
id|NCR_700_Host_Parameters
op_star
id|hostdata
op_assign
(paren
r_struct
id|NCR_700_Host_Parameters
op_star
)paren
id|SCp-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi%d (%d:%d) New error handler wants to abort command&bslash;n&bslash;t&quot;
comma
id|SCp-&gt;host-&gt;host_no
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCp-&gt;cmnd
)paren
suffix:semicolon
id|slot
op_assign
id|find_ITL_Nexus
c_func
(paren
id|hostdata
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
)paren
suffix:semicolon
r_while
c_loop
(paren
id|slot
op_ne
l_int|NULL
op_logical_and
id|slot-&gt;cmnd
op_ne
id|SCp
)paren
(brace
id|slot
op_assign
id|slot-&gt;ITL_back
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* no outstanding command to abort */
r_return
id|SUCCESS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCp-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|TEST_UNIT_READY
)paren
(brace
multiline_comment|/* FIXME: This is because of a problem in the new&n;&t;&t; * error handler.  When it is in error recovery, it&n;&t;&t; * will send a TUR to a device it thinks may still be&n;&t;&t; * showing a problem.  If the TUR isn&squot;t responded to,&n;&t;&t; * it will abort it and mark the device off line.&n;&t;&t; * Unfortunately, it does no other error recovery, so&n;&t;&t; * this would leave us with an outstanding command&n;&t;&t; * occupying a slot.  Rather than allow this to&n;&t;&t; * happen, we issue a bus reset to force all&n;&t;&t; * outstanding commands to terminate here. */
id|NCR_700_internal_bus_reset
c_func
(paren
id|SCp-&gt;host
)paren
suffix:semicolon
multiline_comment|/* still drop through and return failed */
)brace
r_return
id|FAILED
suffix:semicolon
)brace
id|STATIC
r_int
DECL|function|NCR_700_bus_reset
id|NCR_700_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCp
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi%d (%d:%d) New error handler wants BUS reset, cmd %p&bslash;n&bslash;t&quot;
comma
id|SCp-&gt;host-&gt;host_no
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
comma
id|SCp
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCp-&gt;cmnd
)paren
suffix:semicolon
id|NCR_700_internal_bus_reset
c_func
(paren
id|SCp-&gt;host
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
id|STATIC
r_int
DECL|function|NCR_700_dev_reset
id|NCR_700_dev_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCp
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi%d (%d:%d) New error handler wants device reset&bslash;n&bslash;t&quot;
comma
id|SCp-&gt;host-&gt;host_no
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCp-&gt;cmnd
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|STATIC
r_int
DECL|function|NCR_700_host_reset
id|NCR_700_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCp
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi%d (%d:%d) New error handler wants HOST reset&bslash;n&bslash;t&quot;
comma
id|SCp-&gt;host-&gt;host_no
comma
id|SCp-&gt;target
comma
id|SCp-&gt;lun
)paren
suffix:semicolon
id|print_command
c_func
(paren
id|SCp-&gt;cmnd
)paren
suffix:semicolon
id|NCR_700_internal_bus_reset
c_func
(paren
id|SCp-&gt;host
)paren
suffix:semicolon
id|NCR_700_chip_reset
c_func
(paren
id|SCp-&gt;host
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
DECL|variable|NCR_700_detect
id|EXPORT_SYMBOL
c_func
(paren
id|NCR_700_detect
)paren
suffix:semicolon
DECL|variable|NCR_700_release
id|EXPORT_SYMBOL
c_func
(paren
id|NCR_700_release
)paren
suffix:semicolon
DECL|variable|NCR_700_intr
id|EXPORT_SYMBOL
c_func
(paren
id|NCR_700_intr
)paren
suffix:semicolon
eof
