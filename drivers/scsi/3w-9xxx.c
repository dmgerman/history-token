multiline_comment|/*&n;   3w-9xxx.c -- 3ware 9000 Storage Controller device driver for Linux.&n;&n;   Written By: Adam Radford &lt;linuxraid@amcc.com&gt;&n;&n;   Copyright (C) 2004 Applied Micro Circuits Corporation.&n;&n;   This program is free software; you can redistribute it and/or modify&n;   it under the terms of the GNU General Public License as published by&n;   the Free Software Foundation; version 2 of the License.&n;&n;   This program is distributed in the hope that it will be useful,&n;   but WITHOUT ANY WARRANTY; without even the implied warranty of&n;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;   GNU General Public License for more details.&n;&n;   NO WARRANTY&n;   THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR&n;   CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT&n;   LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,&n;   MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is&n;   solely responsible for determining the appropriateness of using and&n;   distributing the Program and assumes all risks associated with its&n;   exercise of rights under this Agreement, including but not limited to&n;   the risks and costs of program errors, damage to or loss of data,&n;   programs or equipment, and unavailability or interruption of operations.&n;&n;   DISCLAIMER OF LIABILITY&n;   NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY&n;   DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n;   DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND&n;   ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n;   TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n;   USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED&n;   HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES&n;&n;   You should have received a copy of the GNU General Public License&n;   along with this program; if not, write to the Free Software&n;   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;&n;   Bugs/Comments/Suggestions should be mailed to:&n;   linuxraid@amcc.com&n;&n;   For more information, goto:&n;   http://www.amcc.com&n;&n;   Note: This version of the driver does not contain a bundled firmware&n;         image.&n;&n;   History&n;   -------&n;   2.26.02.000 - Driver cleanup for kernel submission.&n;   2.26.02.001 - Replace schedule_timeout() calls with msleep().&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsi_tcq.h&gt;
macro_line|#include &lt;scsi/scsi_cmnd.h&gt;
macro_line|#include &quot;3w-9xxx.h&quot;
multiline_comment|/* Globals */
DECL|variable|twa_driver_version
r_static
r_const
r_char
op_star
id|twa_driver_version
op_assign
l_string|&quot;2.26.02.001&quot;
suffix:semicolon
DECL|variable|twa_device_extension_list
r_static
id|TW_Device_Extension
op_star
id|twa_device_extension_list
(braket
id|TW_MAX_SLOT
)braket
suffix:semicolon
DECL|variable|twa_device_extension_count
r_static
r_int
r_int
id|twa_device_extension_count
suffix:semicolon
DECL|variable|twa_major
r_static
r_int
id|twa_major
op_assign
op_minus
l_int|1
suffix:semicolon
r_extern
r_struct
id|timezone
id|sys_tz
suffix:semicolon
multiline_comment|/* Module parameters */
id|MODULE_AUTHOR
(paren
l_string|&quot;AMCC&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;3ware 9000 Storage Controller Linux Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* Function prototypes */
r_static
r_void
id|twa_aen_queue_event
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
id|TW_Command_Apache_Header
op_star
id|header
)paren
suffix:semicolon
r_static
r_int
id|twa_aen_read_queue
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
suffix:semicolon
r_static
r_char
op_star
id|twa_aen_severity_lookup
c_func
(paren
r_int
r_char
id|severity_code
)paren
suffix:semicolon
r_static
r_void
id|twa_aen_sync_time
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
suffix:semicolon
r_static
r_int
id|twa_chrdev_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|twa_chrdev_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|twa_fill_sense
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
comma
r_int
id|copy_sense
comma
r_int
id|print_host
)paren
suffix:semicolon
r_static
r_void
id|twa_free_request_id
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
suffix:semicolon
r_static
r_void
id|twa_get_request_id
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
op_star
id|request_id
)paren
suffix:semicolon
r_static
r_int
id|twa_initconnection
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|message_credits
comma
id|u32
id|set_features
comma
r_int
r_int
id|current_fw_srl
comma
r_int
r_int
id|current_fw_arch_id
comma
r_int
r_int
id|current_fw_branch
comma
r_int
r_int
id|current_fw_build
comma
r_int
r_int
op_star
id|fw_on_ctlr_srl
comma
r_int
r_int
op_star
id|fw_on_ctlr_arch_id
comma
r_int
r_int
op_star
id|fw_on_ctlr_branch
comma
r_int
r_int
op_star
id|fw_on_ctlr_build
comma
id|u32
op_star
id|init_connect_result
)paren
suffix:semicolon
r_static
r_void
id|twa_load_sgl
c_func
(paren
id|TW_Command_Full
op_star
id|full_command_packet
comma
r_int
id|request_id
comma
id|dma_addr_t
id|dma_handle
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_int
id|twa_poll_response
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
comma
r_int
id|seconds
)paren
suffix:semicolon
r_static
r_int
id|twa_poll_status_gone
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
id|u32
id|flag
comma
r_int
id|seconds
)paren
suffix:semicolon
r_static
r_int
id|twa_post_command_packet
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
comma
r_char
id|internal
)paren
suffix:semicolon
r_static
r_int
id|twa_reset_device_extension
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
suffix:semicolon
r_static
r_int
id|twa_reset_sequence
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|soft_reset
)paren
suffix:semicolon
r_static
r_int
id|twa_scsiop_execute_scsi
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
comma
r_char
op_star
id|cdb
comma
r_int
id|use_sg
comma
id|TW_SG_Apache
op_star
id|sglistarg
)paren
suffix:semicolon
r_static
r_void
id|twa_scsiop_execute_scsi_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
suffix:semicolon
r_static
r_char
op_star
id|twa_string_lookup
c_func
(paren
id|twa_message_type
op_star
id|table
comma
r_int
r_int
id|aen_code
)paren
suffix:semicolon
r_static
r_void
id|twa_unmap_scsi_data
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
suffix:semicolon
multiline_comment|/* Functions */
multiline_comment|/* Show some statistics about the card */
DECL|function|twa_show_stats
r_static
id|ssize_t
id|twa_show_stats
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|class_to_shost
c_func
(paren
id|class_dev
)paren
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|ssize_t
id|len
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|len
op_assign
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;Driver version: %s&bslash;n&quot;
l_string|&quot;Current commands posted:   %4d&bslash;n&quot;
l_string|&quot;Max commands posted:       %4d&bslash;n&quot;
l_string|&quot;Current pending commands:  %4d&bslash;n&quot;
l_string|&quot;Max pending commands:      %4d&bslash;n&quot;
l_string|&quot;Last sgl length:           %4d&bslash;n&quot;
l_string|&quot;Max sgl length:            %4d&bslash;n&quot;
l_string|&quot;Last sector count:         %4d&bslash;n&quot;
l_string|&quot;Max sector count:          %4d&bslash;n&quot;
l_string|&quot;SCSI Host Resets:          %4d&bslash;n&quot;
l_string|&quot;SCSI Aborts/Timeouts:      %4d&bslash;n&quot;
l_string|&quot;AEN&squot;s:                     %4d&bslash;n&quot;
comma
id|twa_driver_version
comma
id|tw_dev-&gt;posted_request_count
comma
id|tw_dev-&gt;max_posted_request_count
comma
id|tw_dev-&gt;pending_request_count
comma
id|tw_dev-&gt;max_pending_request_count
comma
id|tw_dev-&gt;sgl_entries
comma
id|tw_dev-&gt;max_sgl_entries
comma
id|tw_dev-&gt;sector_count
comma
id|tw_dev-&gt;max_sector_count
comma
id|tw_dev-&gt;num_resets
comma
id|tw_dev-&gt;num_aborts
comma
id|tw_dev-&gt;aen_count
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* End twa_show_stats() */
multiline_comment|/* This function will set a devices queue depth */
DECL|function|twa_store_queue_depth
r_static
id|ssize_t
id|twa_store_queue_depth
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|queue_depth
suffix:semicolon
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|queue_depth
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|queue_depth
OG
id|TW_Q_LENGTH
op_minus
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|scsi_adjust_queue_depth
c_func
(paren
id|sdev
comma
id|MSG_ORDERED_TAG
comma
id|queue_depth
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* End twa_store_queue_depth() */
multiline_comment|/* Create sysfs &squot;queue_depth&squot; entry */
DECL|variable|twa_queue_depth_attr
r_static
r_struct
id|device_attribute
id|twa_queue_depth_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;queue_depth&quot;
comma
dot
id|mode
op_assign
id|S_IRUSR
op_or
id|S_IWUSR
comma
)brace
comma
dot
id|store
op_assign
id|twa_store_queue_depth
)brace
suffix:semicolon
multiline_comment|/* Device attributes initializer */
DECL|variable|twa_dev_attrs
r_static
r_struct
id|device_attribute
op_star
id|twa_dev_attrs
(braket
)braket
op_assign
(brace
op_amp
id|twa_queue_depth_attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
multiline_comment|/* Create sysfs &squot;stats&squot; entry */
DECL|variable|twa_host_stats_attr
r_static
r_struct
id|class_device_attribute
id|twa_host_stats_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;stats&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
)brace
comma
dot
id|show
op_assign
id|twa_show_stats
)brace
suffix:semicolon
multiline_comment|/* Host attributes initializer */
DECL|variable|twa_host_attrs
r_static
r_struct
id|class_device_attribute
op_star
id|twa_host_attrs
(braket
)braket
op_assign
(brace
op_amp
id|twa_host_stats_attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
multiline_comment|/* File operations struct for character device */
DECL|variable|twa_fops
r_static
r_struct
id|file_operations
id|twa_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|ioctl
op_assign
id|twa_chrdev_ioctl
comma
dot
id|open
op_assign
id|twa_chrdev_open
comma
dot
id|release
op_assign
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* This function will complete an aen request from the isr */
DECL|function|twa_aen_complete
r_static
r_int
id|twa_aen_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|TW_Command_Full
op_star
id|full_command_packet
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Command_Apache_Header
op_star
id|header
suffix:semicolon
r_int
r_int
id|aen
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
id|header
op_assign
(paren
id|TW_Command_Apache_Header
op_star
)paren
id|tw_dev-&gt;generic_buffer_virt
(braket
id|request_id
)braket
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
id|aen
op_assign
id|header-&gt;status_block.error
suffix:semicolon
id|full_command_packet
op_assign
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
suffix:semicolon
id|command_packet
op_assign
op_amp
id|full_command_packet-&gt;command.oldcommand
suffix:semicolon
multiline_comment|/* First check for internal completion of set param for time sync */
r_if
c_cond
(paren
id|TW_OP_OUT
c_func
(paren
id|command_packet-&gt;opcode__sgloffset
)paren
op_eq
id|TW_OP_SET_PARAM
)paren
(brace
multiline_comment|/* Keep reading the queue in case there are more aen&squot;s */
r_if
c_cond
(paren
id|twa_aen_read_queue
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
)paren
r_goto
id|out2
suffix:semicolon
r_else
(brace
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|aen
)paren
(brace
r_case
id|TW_AEN_QUEUE_EMPTY
suffix:colon
multiline_comment|/* Quit reading the queue if this is the last one */
r_break
suffix:semicolon
r_case
id|TW_AEN_SYNC_TIME_WITH_HOST
suffix:colon
id|twa_aen_sync_time
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_default
suffix:colon
id|twa_aen_queue_event
c_func
(paren
id|tw_dev
comma
id|header
)paren
suffix:semicolon
multiline_comment|/* If there are more aen&squot;s, keep reading the queue */
r_if
c_cond
(paren
id|twa_aen_read_queue
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
)paren
r_goto
id|out2
suffix:semicolon
r_else
(brace
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out2
suffix:colon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|twa_free_request_id
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|TW_IN_ATTENTION_LOOP
comma
op_amp
id|tw_dev-&gt;flags
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_aen_complete() */
multiline_comment|/* This function will drain aen queue */
DECL|function|twa_aen_drain_queue
r_static
r_int
id|twa_aen_drain_queue
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|no_check_reset
)paren
(brace
r_int
id|request_id
op_assign
l_int|0
suffix:semicolon
r_char
id|cdb
(braket
id|TW_MAX_CDB_LEN
)braket
suffix:semicolon
id|TW_SG_Apache
id|sglist
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|finished
op_assign
l_int|0
comma
id|count
op_assign
l_int|0
suffix:semicolon
id|TW_Command_Full
op_star
id|full_command_packet
suffix:semicolon
id|TW_Command_Apache_Header
op_star
id|header
suffix:semicolon
r_int
r_int
id|aen
suffix:semicolon
r_int
id|first_reset
op_assign
l_int|0
comma
id|queue
op_assign
l_int|0
comma
id|retval
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|no_check_reset
)paren
id|first_reset
op_assign
l_int|0
suffix:semicolon
r_else
id|first_reset
op_assign
l_int|1
suffix:semicolon
id|full_command_packet
op_assign
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|full_command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Command_Full
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize cdb */
id|memset
c_func
(paren
op_amp
id|cdb
comma
l_int|0
comma
id|TW_MAX_CDB_LEN
)paren
suffix:semicolon
id|cdb
(braket
l_int|0
)braket
op_assign
id|REQUEST_SENSE
suffix:semicolon
multiline_comment|/* opcode */
id|cdb
(braket
l_int|4
)braket
op_assign
id|TW_ALLOCATION_LENGTH
suffix:semicolon
multiline_comment|/* allocation length */
multiline_comment|/* Initialize sglist */
id|memset
c_func
(paren
op_amp
id|sglist
comma
l_int|0
comma
r_sizeof
(paren
id|TW_SG_Apache
)paren
)paren
suffix:semicolon
id|sglist
(braket
l_int|0
)braket
dot
id|length
op_assign
id|TW_SECTOR_SIZE
suffix:semicolon
id|sglist
(braket
l_int|0
)braket
dot
id|address
op_assign
id|tw_dev-&gt;generic_buffer_phys
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sglist
(braket
l_int|0
)braket
dot
id|address
op_amp
id|TW_ALIGNMENT_9000_SGL
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x1
comma
l_string|&quot;Found unaligned address during AEN drain&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Mark internal command */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_assign
l_int|NULL
suffix:semicolon
r_do
(brace
multiline_comment|/* Send command to the board */
r_if
c_cond
(paren
id|twa_scsiop_execute_scsi
c_func
(paren
id|tw_dev
comma
id|request_id
comma
id|cdb
comma
l_int|1
comma
id|sglist
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x2
comma
l_string|&quot;Error posting request sense&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Now poll for completion */
r_if
c_cond
(paren
id|twa_poll_response
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|30
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x3
comma
l_string|&quot;No valid response while draining AEN queue&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
id|header
op_assign
(paren
id|TW_Command_Apache_Header
op_star
)paren
id|tw_dev-&gt;generic_buffer_virt
(braket
id|request_id
)braket
suffix:semicolon
id|aen
op_assign
id|header-&gt;status_block.error
suffix:semicolon
id|queue
op_assign
l_int|0
suffix:semicolon
id|count
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|aen
)paren
(brace
r_case
id|TW_AEN_QUEUE_EMPTY
suffix:colon
r_if
c_cond
(paren
id|first_reset
op_ne
l_int|1
)paren
r_goto
id|out
suffix:semicolon
r_else
id|finished
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_AEN_SOFT_RESET
suffix:colon
r_if
c_cond
(paren
id|first_reset
op_eq
l_int|0
)paren
id|first_reset
op_assign
l_int|1
suffix:semicolon
r_else
id|queue
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_AEN_SYNC_TIME_WITH_HOST
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|queue
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now queue an event info */
r_if
c_cond
(paren
id|queue
)paren
id|twa_aen_queue_event
c_func
(paren
id|tw_dev
comma
id|header
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|finished
op_eq
l_int|0
)paren
op_logical_and
(paren
id|count
OL
id|TW_MAX_AEN_DRAIN
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
id|TW_MAX_AEN_DRAIN
)paren
r_goto
id|out
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_INITIAL
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_aen_drain_queue() */
multiline_comment|/* This function will queue an event */
DECL|function|twa_aen_queue_event
r_static
r_void
id|twa_aen_queue_event
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
id|TW_Command_Apache_Header
op_star
id|header
)paren
(brace
id|u32
id|local_time
suffix:semicolon
r_struct
id|timeval
id|time
suffix:semicolon
id|TW_Event
op_star
id|event
suffix:semicolon
r_int
r_int
id|aen
suffix:semicolon
r_char
id|host
(braket
l_int|16
)braket
suffix:semicolon
id|tw_dev-&gt;aen_count
op_increment
suffix:semicolon
multiline_comment|/* Fill out event info */
id|event
op_assign
id|tw_dev-&gt;event_queue
(braket
id|tw_dev-&gt;error_index
)braket
suffix:semicolon
multiline_comment|/* Check for clobber */
id|host
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;host
)paren
(brace
id|sprintf
c_func
(paren
id|host
comma
l_string|&quot; scsi%d:&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event-&gt;retrieved
op_eq
id|TW_AEN_NOT_RETRIEVED
)paren
id|tw_dev-&gt;aen_clobber
op_assign
l_int|1
suffix:semicolon
)brace
id|aen
op_assign
id|header-&gt;status_block.error
suffix:semicolon
id|memset
c_func
(paren
id|event
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Event
)paren
)paren
suffix:semicolon
id|event-&gt;severity
op_assign
id|TW_SEV_OUT
c_func
(paren
id|header-&gt;status_block.severity__reserved
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|time
)paren
suffix:semicolon
id|local_time
op_assign
(paren
id|u32
)paren
(paren
id|time.tv_sec
op_minus
(paren
id|sys_tz.tz_minuteswest
op_star
l_int|60
)paren
)paren
suffix:semicolon
id|event-&gt;time_stamp_sec
op_assign
id|local_time
suffix:semicolon
id|event-&gt;aen_code
op_assign
id|aen
suffix:semicolon
id|event-&gt;retrieved
op_assign
id|TW_AEN_NOT_RETRIEVED
suffix:semicolon
id|event-&gt;sequence_id
op_assign
id|tw_dev-&gt;error_sequence_id
suffix:semicolon
id|tw_dev-&gt;error_sequence_id
op_increment
suffix:semicolon
id|header-&gt;err_specific_desc
(braket
r_sizeof
(paren
id|header-&gt;err_specific_desc
)paren
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|event-&gt;parameter_len
op_assign
id|strlen
c_func
(paren
id|header-&gt;err_specific_desc
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|event-&gt;parameter_data
comma
id|header-&gt;err_specific_desc
comma
id|event-&gt;parameter_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event-&gt;severity
op_ne
id|TW_AEN_SEVERITY_DEBUG
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-9xxx:%s AEN: %s (0x%02X:0x%04X): %s:%s.&bslash;n&quot;
comma
id|host
comma
id|twa_aen_severity_lookup
c_func
(paren
id|TW_SEV_OUT
c_func
(paren
id|header-&gt;status_block.severity__reserved
)paren
)paren
comma
id|TW_MESSAGE_SOURCE_CONTROLLER_EVENT
comma
id|aen
comma
id|twa_string_lookup
c_func
(paren
id|twa_aen_table
comma
id|aen
)paren
comma
id|header-&gt;err_specific_desc
)paren
suffix:semicolon
r_else
id|tw_dev-&gt;aen_count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tw_dev-&gt;error_index
op_plus
l_int|1
)paren
op_eq
id|TW_Q_LENGTH
)paren
id|tw_dev-&gt;event_queue_wrapped
op_assign
l_int|1
suffix:semicolon
id|tw_dev-&gt;error_index
op_assign
(paren
id|tw_dev-&gt;error_index
op_plus
l_int|1
)paren
op_mod
id|TW_Q_LENGTH
suffix:semicolon
)brace
multiline_comment|/* End twa_aen_queue_event() */
multiline_comment|/* This function will read the aen queue from the isr */
DECL|function|twa_aen_read_queue
r_static
r_int
id|twa_aen_read_queue
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
r_char
id|cdb
(braket
id|TW_MAX_CDB_LEN
)braket
suffix:semicolon
id|TW_SG_Apache
id|sglist
(braket
l_int|1
)braket
suffix:semicolon
id|TW_Command_Full
op_star
id|full_command_packet
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
id|full_command_packet
op_assign
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|full_command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Command_Full
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize cdb */
id|memset
c_func
(paren
op_amp
id|cdb
comma
l_int|0
comma
id|TW_MAX_CDB_LEN
)paren
suffix:semicolon
id|cdb
(braket
l_int|0
)braket
op_assign
id|REQUEST_SENSE
suffix:semicolon
multiline_comment|/* opcode */
id|cdb
(braket
l_int|4
)braket
op_assign
id|TW_ALLOCATION_LENGTH
suffix:semicolon
multiline_comment|/* allocation length */
multiline_comment|/* Initialize sglist */
id|memset
c_func
(paren
op_amp
id|sglist
comma
l_int|0
comma
r_sizeof
(paren
id|TW_SG_Apache
)paren
)paren
suffix:semicolon
id|sglist
(braket
l_int|0
)braket
dot
id|length
op_assign
id|TW_SECTOR_SIZE
suffix:semicolon
id|sglist
(braket
l_int|0
)braket
dot
id|address
op_assign
id|tw_dev-&gt;generic_buffer_phys
(braket
id|request_id
)braket
suffix:semicolon
multiline_comment|/* Mark internal command */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Now post the command packet */
r_if
c_cond
(paren
id|twa_scsiop_execute_scsi
c_func
(paren
id|tw_dev
comma
id|request_id
comma
id|cdb
comma
l_int|1
comma
id|sglist
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x4
comma
l_string|&quot;Post failed while reading AEN queue&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_aen_read_queue() */
multiline_comment|/* This function will look up an AEN severity string */
DECL|function|twa_aen_severity_lookup
r_static
r_char
op_star
id|twa_aen_severity_lookup
c_func
(paren
r_int
r_char
id|severity_code
)paren
(brace
r_char
op_star
id|retval
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|severity_code
OL
(paren
r_int
r_char
)paren
id|TW_AEN_SEVERITY_ERROR
)paren
op_logical_or
(paren
id|severity_code
OG
(paren
r_int
r_char
)paren
id|TW_AEN_SEVERITY_DEBUG
)paren
)paren
r_goto
id|out
suffix:semicolon
id|retval
op_assign
id|twa_aen_severity_table
(braket
id|severity_code
)braket
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_aen_severity_lookup() */
multiline_comment|/* This function will sync firmware time with the host time */
DECL|function|twa_aen_sync_time
r_static
r_void
id|twa_aen_sync_time
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|u32
id|schedulertime
suffix:semicolon
r_struct
id|timeval
id|utc
suffix:semicolon
id|TW_Command_Full
op_star
id|full_command_packet
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Param_Apache
op_star
id|param
suffix:semicolon
id|u32
id|local_time
suffix:semicolon
multiline_comment|/* Fill out the command packet */
id|full_command_packet
op_assign
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|full_command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Command_Full
)paren
)paren
suffix:semicolon
id|command_packet
op_assign
op_amp
id|full_command_packet-&gt;command.oldcommand
suffix:semicolon
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|2
comma
id|TW_OP_SET_PARAM
)paren
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte8_offset.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|tw_dev-&gt;generic_buffer_phys
(braket
id|request_id
)braket
suffix:semicolon
id|command_packet-&gt;byte8_offset.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
id|TW_SECTOR_SIZE
suffix:semicolon
id|command_packet-&gt;size
op_assign
id|TW_COMMAND_SIZE
suffix:semicolon
id|command_packet-&gt;byte6_offset.parameter_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Setup the param */
id|param
op_assign
(paren
id|TW_Param_Apache
op_star
)paren
id|tw_dev-&gt;generic_buffer_virt
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
id|TW_SECTOR_SIZE
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
id|TW_TIMEKEEP_TABLE
op_or
l_int|0x8000
suffix:semicolon
multiline_comment|/* Controller time keep table */
id|param-&gt;parameter_id
op_assign
l_int|0x3
suffix:semicolon
multiline_comment|/* SchedulerTime */
id|param-&gt;parameter_size_bytes
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* Convert system time in UTC to local time seconds since last &n;           Sunday 12:00AM */
id|do_gettimeofday
c_func
(paren
op_amp
id|utc
)paren
suffix:semicolon
id|local_time
op_assign
(paren
id|u32
)paren
(paren
id|utc.tv_sec
op_minus
(paren
id|sys_tz.tz_minuteswest
op_star
l_int|60
)paren
)paren
suffix:semicolon
id|schedulertime
op_assign
id|local_time
op_minus
(paren
l_int|3
op_star
l_int|86400
)paren
suffix:semicolon
id|schedulertime
op_assign
id|schedulertime
op_mod
l_int|604800
suffix:semicolon
id|memcpy
c_func
(paren
id|param-&gt;data
comma
op_amp
id|schedulertime
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* Mark internal command */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Now post the command */
id|twa_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* End twa_aen_sync_time() */
multiline_comment|/* This function will allocate memory and check if it is correctly aligned */
DECL|function|twa_allocate_memory
r_static
r_int
id|twa_allocate_memory
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|size
comma
r_int
id|which
)paren
(brace
r_int
id|i
suffix:semicolon
id|dma_addr_t
id|dma_handle
suffix:semicolon
r_int
r_int
op_star
id|cpu_addr
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
id|cpu_addr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|size
op_star
id|TW_Q_LENGTH
comma
op_amp
id|dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_addr
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x5
comma
l_string|&quot;Memory allocation failed&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|cpu_addr
op_mod
(paren
id|TW_ALIGNMENT_9000
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x6
comma
l_string|&quot;Failed to allocate correctly aligned memory&quot;
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|size
op_star
id|TW_Q_LENGTH
comma
id|cpu_addr
comma
id|dma_handle
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cpu_addr
comma
l_int|0
comma
id|size
op_star
id|TW_Q_LENGTH
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_Q_LENGTH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|which
)paren
(brace
r_case
l_int|0
suffix:colon
id|tw_dev-&gt;command_packet_phys
(braket
id|i
)braket
op_assign
id|dma_handle
op_plus
(paren
id|i
op_star
id|size
)paren
suffix:semicolon
id|tw_dev-&gt;command_packet_virt
(braket
id|i
)braket
op_assign
(paren
id|TW_Command_Full
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|cpu_addr
op_plus
(paren
id|i
op_star
id|size
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|tw_dev-&gt;generic_buffer_phys
(braket
id|i
)braket
op_assign
id|dma_handle
op_plus
(paren
id|i
op_star
id|size
)paren
suffix:semicolon
id|tw_dev-&gt;generic_buffer_virt
(braket
id|i
)braket
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|cpu_addr
op_plus
(paren
id|i
op_star
id|size
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_allocate_memory() */
multiline_comment|/* This function will check the status register for unexpected bits */
DECL|function|twa_check_bits
r_static
r_int
id|twa_check_bits
c_func
(paren
id|u32
id|status_reg_value
)paren
(brace
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_EXPECTED_BITS
)paren
op_ne
id|TW_STATUS_EXPECTED_BITS
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_UNEXPECTED_BITS
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_check_bits() */
multiline_comment|/* This function will check the srl and decide if we are compatible  */
DECL|function|twa_check_srl
r_static
r_int
id|twa_check_srl
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
op_star
id|flashed
)paren
(brace
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
r_int
r_int
id|fw_on_ctlr_srl
op_assign
l_int|0
comma
id|fw_on_ctlr_arch_id
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|fw_on_ctlr_branch
op_assign
l_int|0
comma
id|fw_on_ctlr_build
op_assign
l_int|0
suffix:semicolon
id|u32
id|init_connect_result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|twa_initconnection
c_func
(paren
id|tw_dev
comma
id|TW_INIT_MESSAGE_CREDITS
comma
id|TW_EXTENDED_INIT_CONNECT
comma
id|TW_CURRENT_FW_SRL
comma
id|TW_9000_ARCH_ID
comma
id|TW_CURRENT_FW_BRANCH
comma
id|TW_CURRENT_FW_BUILD
comma
op_amp
id|fw_on_ctlr_srl
comma
op_amp
id|fw_on_ctlr_arch_id
comma
op_amp
id|fw_on_ctlr_branch
comma
op_amp
id|fw_on_ctlr_build
comma
op_amp
id|init_connect_result
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x7
comma
l_string|&quot;Initconnection failed while checking SRL&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|tw_dev-&gt;working_srl
op_assign
id|TW_CURRENT_FW_SRL
suffix:semicolon
id|tw_dev-&gt;working_branch
op_assign
id|TW_CURRENT_FW_BRANCH
suffix:semicolon
id|tw_dev-&gt;working_build
op_assign
id|TW_CURRENT_FW_BUILD
suffix:semicolon
multiline_comment|/* Try base mode compatibility */
r_if
c_cond
(paren
op_logical_neg
(paren
id|init_connect_result
op_amp
id|TW_CTLR_FW_COMPATIBLE
)paren
)paren
(brace
r_if
c_cond
(paren
id|twa_initconnection
c_func
(paren
id|tw_dev
comma
id|TW_INIT_MESSAGE_CREDITS
comma
id|TW_EXTENDED_INIT_CONNECT
comma
id|TW_BASE_FW_SRL
comma
id|TW_9000_ARCH_ID
comma
id|TW_BASE_FW_BRANCH
comma
id|TW_BASE_FW_BUILD
comma
op_amp
id|fw_on_ctlr_srl
comma
op_amp
id|fw_on_ctlr_arch_id
comma
op_amp
id|fw_on_ctlr_branch
comma
op_amp
id|fw_on_ctlr_build
comma
op_amp
id|init_connect_result
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0xa
comma
l_string|&quot;Initconnection (base mode) failed while checking SRL&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|init_connect_result
op_amp
id|TW_CTLR_FW_COMPATIBLE
)paren
)paren
(brace
r_if
c_cond
(paren
id|TW_CURRENT_FW_SRL
OG
id|fw_on_ctlr_srl
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x32
comma
l_string|&quot;Firmware and driver incompatibility: please upgrade firmware&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x33
comma
l_string|&quot;Firmware and driver incompatibility: please upgrade driver&quot;
)paren
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
id|tw_dev-&gt;working_srl
op_assign
id|TW_BASE_FW_SRL
suffix:semicolon
id|tw_dev-&gt;working_branch
op_assign
id|TW_BASE_FW_BRANCH
suffix:semicolon
id|tw_dev-&gt;working_build
op_assign
id|TW_BASE_FW_BUILD
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_check_srl() */
multiline_comment|/* This function handles ioctl for the character device */
DECL|function|twa_chrdev_ioctl
r_static
r_int
id|twa_chrdev_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
r_int
op_star
id|cpu_addr
comma
id|data_buffer_length_adjusted
op_assign
l_int|0
comma
id|flags
op_assign
l_int|0
suffix:semicolon
id|dma_addr_t
id|dma_handle
suffix:semicolon
r_int
id|request_id
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|sequence_id
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|event_index
comma
id|start_index
suffix:semicolon
id|TW_Ioctl_Driver_Command
id|driver_command
suffix:semicolon
id|TW_Ioctl_Buf_Apache
op_star
id|tw_ioctl
suffix:semicolon
id|TW_Lock
op_star
id|tw_lock
suffix:semicolon
id|TW_Command_Full
op_star
id|full_command_packet
suffix:semicolon
id|TW_Compatibility_Info
op_star
id|tw_compat_info
suffix:semicolon
id|TW_Event
op_star
id|event
suffix:semicolon
r_struct
id|timeval
id|current_time
suffix:semicolon
id|u32
id|current_time_ms
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
id|twa_device_extension_list
(braket
id|iminor
c_func
(paren
id|inode
)paren
)braket
suffix:semicolon
r_int
id|retval
op_assign
id|TW_IOCTL_ERROR_OS_EFAULT
suffix:semicolon
multiline_comment|/* Only let one of these through at a time */
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|tw_dev-&gt;ioctl_sem
)paren
)paren
(brace
id|retval
op_assign
id|TW_IOCTL_ERROR_OS_EINTR
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* First copy down the driver command */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|driver_command
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|TW_Ioctl_Driver_Command
)paren
)paren
)paren
r_goto
id|out2
suffix:semicolon
multiline_comment|/* Check data buffer size */
r_if
c_cond
(paren
id|driver_command.buffer_length
OG
id|TW_MAX_SECTORS
op_star
l_int|512
)paren
(brace
id|retval
op_assign
id|TW_IOCTL_ERROR_OS_EINVAL
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
multiline_comment|/* Hardware can only do multiple of 512 byte transfers */
id|data_buffer_length_adjusted
op_assign
(paren
id|driver_command.buffer_length
op_plus
l_int|511
)paren
op_amp
op_complement
l_int|511
suffix:semicolon
multiline_comment|/* Now allocate ioctl buf memory */
id|cpu_addr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|data_buffer_length_adjusted
op_plus
r_sizeof
(paren
id|TW_Ioctl_Buf_Apache
)paren
op_minus
l_int|1
comma
op_amp
id|dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_addr
)paren
(brace
id|retval
op_assign
id|TW_IOCTL_ERROR_OS_ENOMEM
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|tw_ioctl
op_assign
(paren
id|TW_Ioctl_Buf_Apache
op_star
)paren
id|cpu_addr
suffix:semicolon
multiline_comment|/* Now copy down the entire ioctl */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|tw_ioctl
comma
(paren
r_void
op_star
)paren
id|arg
comma
id|driver_command.buffer_length
op_plus
r_sizeof
(paren
id|TW_Ioctl_Buf_Apache
)paren
op_minus
l_int|1
)paren
)paren
r_goto
id|out3
suffix:semicolon
multiline_comment|/* See which ioctl we are doing */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TW_IOCTL_FIRMWARE_PASS_THROUGH
suffix:colon
id|spin_lock_irqsave
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|twa_get_request_id
c_func
(paren
id|tw_dev
comma
op_amp
id|request_id
)paren
suffix:semicolon
multiline_comment|/* Flag internal command */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Flag chrdev ioctl */
id|tw_dev-&gt;chrdev_request_id
op_assign
id|request_id
suffix:semicolon
id|full_command_packet
op_assign
op_amp
id|tw_ioctl-&gt;firmware_command
suffix:semicolon
multiline_comment|/* Load request id and sglist for both command types */
id|twa_load_sgl
c_func
(paren
id|full_command_packet
comma
id|request_id
comma
id|dma_handle
comma
id|data_buffer_length_adjusted
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
comma
op_amp
(paren
id|tw_ioctl-&gt;firmware_command
)paren
comma
r_sizeof
(paren
id|TW_Command_Full
)paren
)paren
suffix:semicolon
multiline_comment|/* Now post the command packet to the controller */
id|twa_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|timeout
op_assign
id|TW_IOCTL_CHRDEV_TIMEOUT
op_star
id|HZ
suffix:semicolon
multiline_comment|/* Now wait for command to complete */
id|timeout
op_assign
id|wait_event_interruptible_timeout
c_func
(paren
id|tw_dev-&gt;ioctl_wqueue
comma
id|tw_dev-&gt;chrdev_request_id
op_eq
id|TW_IOCTL_CHRDEV_FREE
comma
id|timeout
)paren
suffix:semicolon
multiline_comment|/* Check if we timed out, got a signal, or didn&squot;t get&n;                   an interrupt */
r_if
c_cond
(paren
(paren
id|timeout
op_le
l_int|0
)paren
op_logical_and
(paren
id|tw_dev-&gt;chrdev_request_id
op_ne
id|TW_IOCTL_CHRDEV_FREE
)paren
)paren
(brace
multiline_comment|/* Now we need to reset the board */
r_if
c_cond
(paren
id|timeout
op_eq
id|TW_IOCTL_ERROR_OS_ERESTARTSYS
)paren
(brace
id|retval
op_assign
id|timeout
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-9xxx: scsi%d: WARNING: (0x%02X:0x%04X): Character ioctl (0x%x) timed out, resetting card.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
comma
id|TW_DRIVER
comma
l_int|0xc
comma
id|cmd
)paren
suffix:semicolon
id|retval
op_assign
id|TW_IOCTL_ERROR_OS_EIO
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|twa_free_request_id
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
id|twa_reset_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
multiline_comment|/* Now copy in the command packet response */
id|memcpy
c_func
(paren
op_amp
(paren
id|tw_ioctl-&gt;firmware_command
)paren
comma
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
comma
r_sizeof
(paren
id|TW_Command_Full
)paren
)paren
suffix:semicolon
multiline_comment|/* Now complete the io */
id|spin_lock_irqsave
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|twa_free_request_id
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_IOCTL_GET_COMPATIBILITY_INFO
suffix:colon
id|tw_ioctl-&gt;driver_command.status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Copy compatiblity struct into ioctl data buffer */
id|tw_compat_info
op_assign
(paren
id|TW_Compatibility_Info
op_star
)paren
id|tw_ioctl-&gt;data_buffer
suffix:semicolon
id|strncpy
c_func
(paren
id|tw_compat_info-&gt;driver_version
comma
id|twa_driver_version
comma
id|strlen
c_func
(paren
id|twa_driver_version
)paren
)paren
suffix:semicolon
id|tw_compat_info-&gt;working_srl
op_assign
id|tw_dev-&gt;working_srl
suffix:semicolon
id|tw_compat_info-&gt;working_branch
op_assign
id|tw_dev-&gt;working_branch
suffix:semicolon
id|tw_compat_info-&gt;working_build
op_assign
id|tw_dev-&gt;working_build
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_IOCTL_GET_LAST_EVENT
suffix:colon
r_if
c_cond
(paren
id|tw_dev-&gt;event_queue_wrapped
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_clobber
)paren
(brace
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_AEN_CLOBBER
suffix:semicolon
id|tw_dev-&gt;aen_clobber
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|tw_ioctl-&gt;driver_command.status
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|tw_dev-&gt;error_index
)paren
(brace
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tw_ioctl-&gt;driver_command.status
op_assign
l_int|0
suffix:semicolon
)brace
id|event_index
op_assign
(paren
id|tw_dev-&gt;error_index
op_minus
l_int|1
op_plus
id|TW_Q_LENGTH
)paren
op_mod
id|TW_Q_LENGTH
suffix:semicolon
id|memcpy
c_func
(paren
id|tw_ioctl-&gt;data_buffer
comma
id|tw_dev-&gt;event_queue
(braket
id|event_index
)braket
comma
r_sizeof
(paren
id|TW_Event
)paren
)paren
suffix:semicolon
id|tw_dev-&gt;event_queue
(braket
id|event_index
)braket
op_member_access_from_pointer
id|retrieved
op_assign
id|TW_AEN_RETRIEVED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_IOCTL_GET_FIRST_EVENT
suffix:colon
r_if
c_cond
(paren
id|tw_dev-&gt;event_queue_wrapped
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_clobber
)paren
(brace
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_AEN_CLOBBER
suffix:semicolon
id|tw_dev-&gt;aen_clobber
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|tw_ioctl-&gt;driver_command.status
op_assign
l_int|0
suffix:semicolon
id|event_index
op_assign
id|tw_dev-&gt;error_index
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|tw_dev-&gt;error_index
)paren
(brace
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tw_ioctl-&gt;driver_command.status
op_assign
l_int|0
suffix:semicolon
id|event_index
op_assign
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|tw_ioctl-&gt;data_buffer
comma
id|tw_dev-&gt;event_queue
(braket
id|event_index
)braket
comma
r_sizeof
(paren
id|TW_Event
)paren
)paren
suffix:semicolon
id|tw_dev-&gt;event_queue
(braket
id|event_index
)braket
op_member_access_from_pointer
id|retrieved
op_assign
id|TW_AEN_RETRIEVED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_IOCTL_GET_NEXT_EVENT
suffix:colon
id|event
op_assign
(paren
id|TW_Event
op_star
)paren
id|tw_ioctl-&gt;data_buffer
suffix:semicolon
id|sequence_id
op_assign
id|event-&gt;sequence_id
suffix:semicolon
id|tw_ioctl-&gt;driver_command.status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;event_queue_wrapped
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_clobber
)paren
(brace
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_AEN_CLOBBER
suffix:semicolon
id|tw_dev-&gt;aen_clobber
op_assign
l_int|0
suffix:semicolon
)brace
id|start_index
op_assign
id|tw_dev-&gt;error_index
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|tw_dev-&gt;error_index
)paren
(brace
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|start_index
op_assign
l_int|0
suffix:semicolon
)brace
id|event_index
op_assign
(paren
id|start_index
op_plus
id|sequence_id
op_minus
id|tw_dev-&gt;event_queue
(braket
id|start_index
)braket
op_member_access_from_pointer
id|sequence_id
op_plus
l_int|1
)paren
op_mod
id|TW_Q_LENGTH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tw_dev-&gt;event_queue
(braket
id|event_index
)braket
op_member_access_from_pointer
id|sequence_id
OG
id|sequence_id
)paren
)paren
(brace
r_if
c_cond
(paren
id|tw_ioctl-&gt;driver_command.status
op_eq
id|TW_IOCTL_ERROR_STATUS_AEN_CLOBBER
)paren
id|tw_dev-&gt;aen_clobber
op_assign
l_int|1
suffix:semicolon
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|tw_ioctl-&gt;data_buffer
comma
id|tw_dev-&gt;event_queue
(braket
id|event_index
)braket
comma
r_sizeof
(paren
id|TW_Event
)paren
)paren
suffix:semicolon
id|tw_dev-&gt;event_queue
(braket
id|event_index
)braket
op_member_access_from_pointer
id|retrieved
op_assign
id|TW_AEN_RETRIEVED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_IOCTL_GET_PREVIOUS_EVENT
suffix:colon
id|event
op_assign
(paren
id|TW_Event
op_star
)paren
id|tw_ioctl-&gt;data_buffer
suffix:semicolon
id|sequence_id
op_assign
id|event-&gt;sequence_id
suffix:semicolon
id|tw_ioctl-&gt;driver_command.status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;event_queue_wrapped
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;aen_clobber
)paren
(brace
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_AEN_CLOBBER
suffix:semicolon
id|tw_dev-&gt;aen_clobber
op_assign
l_int|0
suffix:semicolon
)brace
id|start_index
op_assign
id|tw_dev-&gt;error_index
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|tw_dev-&gt;error_index
)paren
(brace
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|start_index
op_assign
l_int|0
suffix:semicolon
)brace
id|event_index
op_assign
(paren
id|start_index
op_plus
id|sequence_id
op_minus
id|tw_dev-&gt;event_queue
(braket
id|start_index
)braket
op_member_access_from_pointer
id|sequence_id
op_minus
l_int|1
)paren
op_mod
id|TW_Q_LENGTH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tw_dev-&gt;event_queue
(braket
id|event_index
)braket
op_member_access_from_pointer
id|sequence_id
OL
id|sequence_id
)paren
)paren
(brace
r_if
c_cond
(paren
id|tw_ioctl-&gt;driver_command.status
op_eq
id|TW_IOCTL_ERROR_STATUS_AEN_CLOBBER
)paren
id|tw_dev-&gt;aen_clobber
op_assign
l_int|1
suffix:semicolon
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_NO_MORE_EVENTS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|tw_ioctl-&gt;data_buffer
comma
id|tw_dev-&gt;event_queue
(braket
id|event_index
)braket
comma
r_sizeof
(paren
id|TW_Event
)paren
)paren
suffix:semicolon
id|tw_dev-&gt;event_queue
(braket
id|event_index
)braket
op_member_access_from_pointer
id|retrieved
op_assign
id|TW_AEN_RETRIEVED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_IOCTL_GET_LOCK
suffix:colon
id|tw_lock
op_assign
(paren
id|TW_Lock
op_star
)paren
id|tw_ioctl-&gt;data_buffer
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|current_time
)paren
suffix:semicolon
id|current_time_ms
op_assign
(paren
id|current_time.tv_sec
op_star
l_int|1000
)paren
op_plus
(paren
id|current_time.tv_usec
op_div
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tw_lock-&gt;force_flag
op_eq
l_int|1
)paren
op_logical_or
(paren
id|tw_dev-&gt;ioctl_sem_lock
op_eq
l_int|0
)paren
op_logical_or
(paren
id|current_time_ms
op_ge
id|tw_dev-&gt;ioctl_msec
)paren
)paren
(brace
id|tw_dev-&gt;ioctl_sem_lock
op_assign
l_int|1
suffix:semicolon
id|tw_dev-&gt;ioctl_msec
op_assign
id|current_time_ms
op_plus
id|tw_lock-&gt;timeout_msec
suffix:semicolon
id|tw_ioctl-&gt;driver_command.status
op_assign
l_int|0
suffix:semicolon
id|tw_lock-&gt;time_remaining_msec
op_assign
id|tw_lock-&gt;timeout_msec
suffix:semicolon
)brace
r_else
(brace
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_LOCKED
suffix:semicolon
id|tw_lock-&gt;time_remaining_msec
op_assign
id|tw_dev-&gt;ioctl_msec
op_minus
id|current_time_ms
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TW_IOCTL_RELEASE_LOCK
suffix:colon
r_if
c_cond
(paren
id|tw_dev-&gt;ioctl_sem_lock
op_eq
l_int|1
)paren
(brace
id|tw_dev-&gt;ioctl_sem_lock
op_assign
l_int|0
suffix:semicolon
id|tw_ioctl-&gt;driver_command.status
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|tw_ioctl-&gt;driver_command.status
op_assign
id|TW_IOCTL_ERROR_STATUS_NOT_LOCKED
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
id|TW_IOCTL_ERROR_OS_ENOTTY
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
multiline_comment|/* Now copy the entire response to userspace */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|tw_ioctl
comma
r_sizeof
(paren
id|TW_Ioctl_Buf_Apache
)paren
op_plus
id|driver_command.buffer_length
op_minus
l_int|1
)paren
op_eq
l_int|0
)paren
id|retval
op_assign
l_int|0
suffix:semicolon
id|out3
suffix:colon
multiline_comment|/* Now free ioctl buf memory */
id|pci_free_consistent
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|data_buffer_length_adjusted
op_plus
r_sizeof
(paren
id|TW_Ioctl_Buf_Apache
)paren
op_minus
l_int|1
comma
id|cpu_addr
comma
id|dma_handle
)paren
suffix:semicolon
id|out2
suffix:colon
id|up
c_func
(paren
op_amp
id|tw_dev-&gt;ioctl_sem
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_chrdev_ioctl() */
multiline_comment|/* This function handles open for the character device */
DECL|function|twa_chrdev_open
r_static
r_int
id|twa_chrdev_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
r_int
id|minor_number
suffix:semicolon
r_int
id|retval
op_assign
id|TW_IOCTL_ERROR_OS_ENODEV
suffix:semicolon
id|minor_number
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor_number
op_ge
id|twa_device_extension_count
)paren
r_goto
id|out
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_chrdev_open() */
multiline_comment|/* This function will print readable messages from status register errors */
DECL|function|twa_decode_bits
r_static
r_int
id|twa_decode_bits
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
id|u32
id|status_reg_value
)paren
(brace
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Check for various error conditions and handle them appropriately */
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_PCI_PARITY_ERROR
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0xc
comma
l_string|&quot;PCI Parity Error: clearing&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TW_CONTROL_CLEAR_PARITY_ERROR
comma
id|TW_CONTROL_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_PCI_ABORT
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0xd
comma
l_string|&quot;PCI Abort: clearing&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TW_CONTROL_CLEAR_PCI_ABORT
comma
id|TW_CONTROL_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|PCI_STATUS
comma
id|TW_PCI_CLEAR_PCI_ABORT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_QUEUE_ERROR
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0xe
comma
l_string|&quot;Controller Queue Error: clearing&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TW_CONTROL_CLEAR_QUEUE_ERROR
comma
id|TW_CONTROL_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_SBUF_WRITE_ERROR
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0xf
comma
l_string|&quot;SBUF Write Error: clearing&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TW_CONTROL_CLEAR_SBUF_WRITE_ERROR
comma
id|TW_CONTROL_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_MICROCONTROLLER_ERROR
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;reset_print
op_eq
l_int|0
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x10
comma
l_string|&quot;Microcontroller Error: clearing&quot;
)paren
suffix:semicolon
id|tw_dev-&gt;reset_print
op_assign
l_int|1
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_decode_bits() */
multiline_comment|/* This function will empty the response queue */
DECL|function|twa_empty_response_queue
r_static
r_int
id|twa_empty_response_queue
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
id|u32
id|status_reg_value
comma
id|response_que_value
suffix:semicolon
r_int
id|count
op_assign
l_int|0
comma
id|retval
op_assign
l_int|1
suffix:semicolon
id|status_reg_value
op_assign
id|readl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|count
OL
id|TW_MAX_RESPONSE_DRAIN
)paren
)paren
(brace
id|response_que_value
op_assign
id|readl
c_func
(paren
id|TW_RESPONSE_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|status_reg_value
op_assign
id|readl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
id|TW_MAX_RESPONSE_DRAIN
)paren
r_goto
id|out
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_empty_response_queue() */
multiline_comment|/* This function passes sense keys from firmware to scsi layer */
DECL|function|twa_fill_sense
r_static
r_int
id|twa_fill_sense
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
comma
r_int
id|copy_sense
comma
r_int
id|print_host
)paren
(brace
id|TW_Command_Full
op_star
id|full_command_packet
suffix:semicolon
r_int
r_int
id|error
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
id|full_command_packet
op_assign
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
suffix:semicolon
multiline_comment|/* Don&squot;t print error for Logical unit not supported during rollcall */
id|error
op_assign
id|full_command_packet-&gt;header.status_block.error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_ne
id|TW_ERROR_LOGICAL_UNIT_NOT_SUPPORTED
)paren
op_logical_and
(paren
id|error
op_ne
id|TW_ERROR_UNIT_OFFLINE
)paren
)paren
(brace
r_if
c_cond
(paren
id|print_host
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-9xxx: scsi%d: ERROR: (0x%02X:0x%04X): %s:%s.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
comma
id|TW_MESSAGE_SOURCE_CONTROLLER_ERROR
comma
id|full_command_packet-&gt;header.status_block.error
comma
id|twa_string_lookup
c_func
(paren
id|twa_error_table
comma
id|full_command_packet-&gt;header.status_block.error
)paren
comma
id|full_command_packet-&gt;header.err_specific_desc
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-9xxx: ERROR: (0x%02X:0x%04X): %s:%s.&bslash;n&quot;
comma
id|TW_MESSAGE_SOURCE_CONTROLLER_ERROR
comma
id|full_command_packet-&gt;header.status_block.error
comma
id|twa_string_lookup
c_func
(paren
id|twa_error_table
comma
id|full_command_packet-&gt;header.status_block.error
)paren
comma
id|full_command_packet-&gt;header.err_specific_desc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_sense
)paren
(brace
id|memcpy
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|sense_buffer
comma
id|full_command_packet-&gt;header.sense_data
comma
id|TW_SENSE_DATA_LENGTH
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|full_command_packet-&gt;command.newcommand.status
op_lshift
l_int|1
)paren
suffix:semicolon
id|retval
op_assign
id|TW_ISR_DONT_RESULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_fill_sense() */
multiline_comment|/* This function will free up device extension resources */
DECL|function|twa_free_device_extension
r_static
r_void
id|twa_free_device_extension
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;command_packet_virt
(braket
l_int|0
)braket
)paren
id|pci_free_consistent
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
r_sizeof
(paren
id|TW_Command_Full
)paren
op_star
id|TW_Q_LENGTH
comma
id|tw_dev-&gt;command_packet_virt
(braket
l_int|0
)braket
comma
id|tw_dev-&gt;command_packet_phys
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;generic_buffer_virt
(braket
l_int|0
)braket
)paren
id|pci_free_consistent
c_func
(paren
id|tw_dev-&gt;tw_pci_dev
comma
id|TW_SECTOR_SIZE
op_star
id|TW_Q_LENGTH
comma
id|tw_dev-&gt;generic_buffer_virt
(braket
l_int|0
)braket
comma
id|tw_dev-&gt;generic_buffer_phys
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;event_queue
(braket
l_int|0
)braket
)paren
id|kfree
c_func
(paren
id|tw_dev-&gt;event_queue
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* End twa_free_device_extension() */
multiline_comment|/* This function will free a request id */
DECL|function|twa_free_request_id
r_static
r_void
id|twa_free_request_id
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|tw_dev-&gt;free_queue
(braket
id|tw_dev-&gt;free_tail
)braket
op_assign
id|request_id
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_FINISHED
suffix:semicolon
id|tw_dev-&gt;free_tail
op_assign
(paren
id|tw_dev-&gt;free_tail
op_plus
l_int|1
)paren
op_mod
id|TW_Q_LENGTH
suffix:semicolon
)brace
multiline_comment|/* End twa_free_request_id() */
multiline_comment|/* This function will get parameter table entires from the firmware */
DECL|function|twa_get_param
r_static
r_void
op_star
id|twa_get_param
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
comma
r_int
id|table_id
comma
r_int
id|parameter_id
comma
r_int
id|parameter_size_bytes
)paren
(brace
id|TW_Command_Full
op_star
id|full_command_packet
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Param_Apache
op_star
id|param
suffix:semicolon
r_int
r_int
id|param_value
suffix:semicolon
r_void
op_star
id|retval
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Setup the command packet */
id|full_command_packet
op_assign
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|full_command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Command_Full
)paren
)paren
suffix:semicolon
id|command_packet
op_assign
op_amp
id|full_command_packet-&gt;command.oldcommand
suffix:semicolon
id|command_packet-&gt;opcode__sgloffset
op_assign
id|TW_OPSGL_IN
c_func
(paren
l_int|2
comma
id|TW_OP_GET_PARAM
)paren
suffix:semicolon
id|command_packet-&gt;size
op_assign
id|TW_COMMAND_SIZE
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;byte6_offset.block_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now setup the param */
id|param
op_assign
(paren
id|TW_Param_Apache
op_star
)paren
id|tw_dev-&gt;generic_buffer_virt
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|param
comma
l_int|0
comma
id|TW_SECTOR_SIZE
)paren
suffix:semicolon
id|param-&gt;table_id
op_assign
id|table_id
op_or
l_int|0x8000
suffix:semicolon
id|param-&gt;parameter_id
op_assign
id|parameter_id
suffix:semicolon
id|param-&gt;parameter_size_bytes
op_assign
id|parameter_size_bytes
suffix:semicolon
id|param_value
op_assign
id|tw_dev-&gt;generic_buffer_phys
(braket
id|request_id
)braket
suffix:semicolon
id|command_packet-&gt;byte8_offset.param.sgl
(braket
l_int|0
)braket
dot
id|address
op_assign
id|param_value
suffix:semicolon
id|command_packet-&gt;byte8_offset.param.sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
id|TW_SECTOR_SIZE
suffix:semicolon
multiline_comment|/* Post the command packet to the board */
id|twa_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Poll for completion */
r_if
c_cond
(paren
id|twa_poll_response
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|30
)paren
)paren
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x13
comma
l_string|&quot;No valid response during get param&quot;
)paren
r_else
id|retval
op_assign
(paren
r_void
op_star
)paren
op_amp
(paren
id|param-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_INITIAL
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_get_param() */
multiline_comment|/* This function will assign an available request id */
DECL|function|twa_get_request_id
r_static
r_void
id|twa_get_request_id
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
op_star
id|request_id
)paren
(brace
op_star
id|request_id
op_assign
id|tw_dev-&gt;free_queue
(braket
id|tw_dev-&gt;free_head
)braket
suffix:semicolon
id|tw_dev-&gt;free_head
op_assign
(paren
id|tw_dev-&gt;free_head
op_plus
l_int|1
)paren
op_mod
id|TW_Q_LENGTH
suffix:semicolon
id|tw_dev-&gt;state
(braket
op_star
id|request_id
)braket
op_assign
id|TW_S_STARTED
suffix:semicolon
)brace
multiline_comment|/* End twa_get_request_id() */
multiline_comment|/* This function will send an initconnection command to controller */
DECL|function|twa_initconnection
r_static
r_int
id|twa_initconnection
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|message_credits
comma
id|u32
id|set_features
comma
r_int
r_int
id|current_fw_srl
comma
r_int
r_int
id|current_fw_arch_id
comma
r_int
r_int
id|current_fw_branch
comma
r_int
r_int
id|current_fw_build
comma
r_int
r_int
op_star
id|fw_on_ctlr_srl
comma
r_int
r_int
op_star
id|fw_on_ctlr_arch_id
comma
r_int
r_int
op_star
id|fw_on_ctlr_branch
comma
r_int
r_int
op_star
id|fw_on_ctlr_build
comma
id|u32
op_star
id|init_connect_result
)paren
(brace
id|TW_Command_Full
op_star
id|full_command_packet
suffix:semicolon
id|TW_Initconnect
op_star
id|tw_initconnect
suffix:semicolon
r_int
id|request_id
op_assign
l_int|0
comma
id|retval
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Initialize InitConnection command packet */
id|full_command_packet
op_assign
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
suffix:semicolon
id|memset
c_func
(paren
id|full_command_packet
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Command_Full
)paren
)paren
suffix:semicolon
id|full_command_packet-&gt;header.header_desc.size_header
op_assign
l_int|128
suffix:semicolon
id|tw_initconnect
op_assign
(paren
id|TW_Initconnect
op_star
)paren
op_amp
id|full_command_packet-&gt;command.oldcommand
suffix:semicolon
id|tw_initconnect-&gt;opcode__reserved
op_assign
id|TW_OPRES_IN
c_func
(paren
l_int|0
comma
id|TW_OP_INIT_CONNECTION
)paren
suffix:semicolon
id|tw_initconnect-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|tw_initconnect-&gt;message_credits
op_assign
id|message_credits
suffix:semicolon
id|tw_initconnect-&gt;features
op_assign
id|set_features
suffix:semicolon
macro_line|#if BITS_PER_LONG &gt; 32
multiline_comment|/* Turn on 64-bit sgl support */
id|tw_initconnect-&gt;features
op_or_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|set_features
op_amp
id|TW_EXTENDED_INIT_CONNECT
)paren
(brace
id|tw_initconnect-&gt;size
op_assign
id|TW_INIT_COMMAND_PACKET_SIZE_EXTENDED
suffix:semicolon
id|tw_initconnect-&gt;fw_srl
op_assign
id|current_fw_srl
suffix:semicolon
id|tw_initconnect-&gt;fw_arch_id
op_assign
id|current_fw_arch_id
suffix:semicolon
id|tw_initconnect-&gt;fw_branch
op_assign
id|current_fw_branch
suffix:semicolon
id|tw_initconnect-&gt;fw_build
op_assign
id|current_fw_build
suffix:semicolon
)brace
r_else
id|tw_initconnect-&gt;size
op_assign
id|TW_INIT_COMMAND_PACKET_SIZE
suffix:semicolon
multiline_comment|/* Send command packet to the board */
id|twa_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Poll for completion */
r_if
c_cond
(paren
id|twa_poll_response
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|30
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x15
comma
l_string|&quot;No valid response during init connection&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|set_features
op_amp
id|TW_EXTENDED_INIT_CONNECT
)paren
(brace
op_star
id|fw_on_ctlr_srl
op_assign
id|tw_initconnect-&gt;fw_srl
suffix:semicolon
op_star
id|fw_on_ctlr_arch_id
op_assign
id|tw_initconnect-&gt;fw_arch_id
suffix:semicolon
op_star
id|fw_on_ctlr_branch
op_assign
id|tw_initconnect-&gt;fw_branch
suffix:semicolon
op_star
id|fw_on_ctlr_build
op_assign
id|tw_initconnect-&gt;fw_build
suffix:semicolon
op_star
id|init_connect_result
op_assign
id|tw_initconnect-&gt;result
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_INITIAL
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_initconnection() */
multiline_comment|/* This function will initialize the fields of a device extension */
DECL|function|twa_initialize_device_extension
r_static
r_int
id|twa_initialize_device_extension
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_int
id|i
comma
id|retval
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Initialize command packet buffers */
r_if
c_cond
(paren
id|twa_allocate_memory
c_func
(paren
id|tw_dev
comma
r_sizeof
(paren
id|TW_Command_Full
)paren
comma
l_int|0
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x16
comma
l_string|&quot;Command packet memory allocation failed&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Initialize generic buffer */
r_if
c_cond
(paren
id|twa_allocate_memory
c_func
(paren
id|tw_dev
comma
id|TW_SECTOR_SIZE
comma
l_int|1
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x17
comma
l_string|&quot;Generic memory allocation failed&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Allocate event info space */
id|tw_dev-&gt;event_queue
(braket
l_int|0
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|TW_Event
)paren
op_star
id|TW_Q_LENGTH
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tw_dev-&gt;event_queue
(braket
l_int|0
)braket
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x18
comma
l_string|&quot;Event info memory allocation failed&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tw_dev-&gt;event_queue
(braket
l_int|0
)braket
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Event
)paren
op_star
id|TW_Q_LENGTH
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_Q_LENGTH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tw_dev-&gt;event_queue
(braket
id|i
)braket
op_assign
(paren
id|TW_Event
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|tw_dev-&gt;event_queue
(braket
l_int|0
)braket
op_plus
(paren
id|i
op_star
r_sizeof
(paren
id|TW_Event
)paren
)paren
)paren
suffix:semicolon
id|tw_dev-&gt;free_queue
(braket
id|i
)braket
op_assign
id|i
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|i
)braket
op_assign
id|TW_S_INITIAL
suffix:semicolon
)brace
id|tw_dev-&gt;pending_head
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;pending_tail
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;free_head
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;free_tail
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;error_sequence_id
op_assign
l_int|1
suffix:semicolon
id|tw_dev-&gt;chrdev_request_id
op_assign
id|TW_IOCTL_CHRDEV_FREE
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|tw_dev-&gt;ioctl_sem
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|tw_dev-&gt;ioctl_wqueue
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_initialize_device_extension() */
multiline_comment|/* This function is the interrupt service routine */
DECL|function|twa_interrupt
r_static
id|irqreturn_t
id|twa_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|request_id
comma
id|error
op_assign
l_int|0
suffix:semicolon
id|u32
id|status_reg_value
suffix:semicolon
id|TW_Response_Queue
id|response_que
suffix:semicolon
id|TW_Command_Full
op_star
id|full_command_packet
suffix:semicolon
id|TW_Command
op_star
id|command_packet
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|dev_instance
suffix:semicolon
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Get the per adapter lock */
id|spin_lock
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/* See if the interrupt matches this instance */
r_if
c_cond
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;irq
op_eq
(paren
r_int
r_int
)paren
id|irq
)paren
(brace
id|handled
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Read the registers */
id|status_reg_value
op_assign
id|readl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
multiline_comment|/* Check if this is our interrupt, otherwise bail */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status_reg_value
op_amp
id|TW_STATUS_VALID_INTERRUPT
)paren
)paren
r_goto
id|twa_interrupt_bail
suffix:semicolon
multiline_comment|/* Check controller for errors */
r_if
c_cond
(paren
id|twa_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
r_if
c_cond
(paren
id|twa_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
)paren
)paren
(brace
id|TW_CLEAR_ALL_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_goto
id|twa_interrupt_bail
suffix:semicolon
)brace
)brace
multiline_comment|/* Handle host interrupt */
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_HOST_INTERRUPT
)paren
id|TW_CLEAR_HOST_INTERRUPT
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Handle attention interrupt */
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_ATTENTION_INTERRUPT
)paren
(brace
id|TW_CLEAR_ATTENTION_INTERRUPT
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|test_and_set_bit
c_func
(paren
id|TW_IN_ATTENTION_LOOP
comma
op_amp
id|tw_dev-&gt;flags
)paren
)paren
)paren
(brace
id|twa_get_request_id
c_func
(paren
id|tw_dev
comma
op_amp
id|request_id
)paren
suffix:semicolon
id|error
op_assign
id|twa_aen_read_queue
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|twa_free_request_id
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|TW_IN_ATTENTION_LOOP
comma
op_amp
id|tw_dev-&gt;flags
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Handle command interrupt */
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_COMMAND_INTERRUPT
)paren
(brace
id|TW_MASK_COMMAND_INTERRUPT
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Drain as many pending commands as we can */
r_while
c_loop
(paren
id|tw_dev-&gt;pending_request_count
OG
l_int|0
)paren
(brace
id|request_id
op_assign
id|tw_dev-&gt;pending_queue
(braket
id|tw_dev-&gt;pending_head
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_ne
id|TW_S_PENDING
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x19
comma
l_string|&quot;Found request id that wasn&squot;t pending&quot;
)paren
suffix:semicolon
id|TW_CLEAR_ALL_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_goto
id|twa_interrupt_bail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|twa_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|tw_dev-&gt;pending_head
op_assign
(paren
id|tw_dev-&gt;pending_head
op_plus
l_int|1
)paren
op_mod
id|TW_Q_LENGTH
suffix:semicolon
id|tw_dev-&gt;pending_request_count
op_decrement
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If we get here, we will continue re-posting on the next command interrupt */
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Handle response interrupt */
r_if
c_cond
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_INTERRUPT
)paren
(brace
multiline_comment|/* Drain the response queue from the board */
r_while
c_loop
(paren
(paren
id|status_reg_value
op_amp
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Complete the response */
id|response_que.value
op_assign
id|readl
c_func
(paren
id|TW_RESPONSE_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|request_id
op_assign
id|TW_RESID_OUT
c_func
(paren
id|response_que.response_id
)paren
suffix:semicolon
id|full_command_packet
op_assign
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
id|command_packet
op_assign
op_amp
id|full_command_packet-&gt;command.oldcommand
suffix:semicolon
multiline_comment|/* Check for command packet errors */
r_if
c_cond
(paren
id|full_command_packet-&gt;command.newcommand.status
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_ne
l_int|0
)paren
(brace
id|error
op_assign
id|twa_fill_sense
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Skip ioctl error prints */
r_if
c_cond
(paren
id|request_id
op_ne
id|tw_dev-&gt;chrdev_request_id
)paren
(brace
id|error
op_assign
id|twa_fill_sense
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Check for correct state */
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_ne
id|TW_S_POSTED
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_ne
l_int|0
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x1a
comma
l_string|&quot;Received a request id that wasn&squot;t posted&quot;
)paren
suffix:semicolon
id|TW_CLEAR_ALL_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_goto
id|twa_interrupt_bail
suffix:semicolon
)brace
)brace
multiline_comment|/* Check for internal command completion */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|request_id
op_ne
id|tw_dev-&gt;chrdev_request_id
)paren
(brace
r_if
c_cond
(paren
id|twa_aen_complete
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
)paren
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x1b
comma
l_string|&quot;Error completing AEN during attention interrupt&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|tw_dev-&gt;chrdev_request_id
op_assign
id|TW_IOCTL_CHRDEV_FREE
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|tw_dev-&gt;ioctl_wqueue
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|twa_scsiop_execute_scsi_complete
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
multiline_comment|/* If no error command was a success */
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/* If error, command failed */
r_if
c_cond
(paren
id|error
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Ask for a host reset */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Now complete the io */
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|twa_free_request_id
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_decrement
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
suffix:semicolon
id|twa_unmap_scsi_data
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
)brace
multiline_comment|/* Check for valid status after each drain */
id|status_reg_value
op_assign
id|readl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|twa_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
(brace
r_if
c_cond
(paren
id|twa_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
)paren
)paren
(brace
id|TW_CLEAR_ALL_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_goto
id|twa_interrupt_bail
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
id|twa_interrupt_bail
suffix:colon
id|spin_unlock
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
multiline_comment|/* End twa_interrupt() */
multiline_comment|/* This function will load the request id and various sgls for ioctls */
DECL|function|twa_load_sgl
r_static
r_void
id|twa_load_sgl
c_func
(paren
id|TW_Command_Full
op_star
id|full_command_packet
comma
r_int
id|request_id
comma
id|dma_addr_t
id|dma_handle
comma
r_int
id|length
)paren
(brace
id|TW_Command
op_star
id|oldcommand
suffix:semicolon
id|TW_Command_Apache
op_star
id|newcommand
suffix:semicolon
id|TW_SG_Entry
op_star
id|sgl
suffix:semicolon
r_if
c_cond
(paren
id|TW_OP_OUT
c_func
(paren
id|full_command_packet-&gt;command.newcommand.opcode__reserved
)paren
op_eq
id|TW_OP_EXECUTE_SCSI
)paren
(brace
id|newcommand
op_assign
op_amp
id|full_command_packet-&gt;command.newcommand
suffix:semicolon
id|newcommand-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|newcommand-&gt;sg_list
(braket
l_int|0
)braket
dot
id|address
op_assign
id|dma_handle
op_plus
r_sizeof
(paren
id|TW_Ioctl_Buf_Apache
)paren
op_minus
l_int|1
suffix:semicolon
id|newcommand-&gt;sg_list
(braket
l_int|0
)braket
dot
id|length
op_assign
id|length
suffix:semicolon
)brace
r_else
(brace
id|oldcommand
op_assign
op_amp
id|full_command_packet-&gt;command.oldcommand
suffix:semicolon
id|oldcommand-&gt;request_id
op_assign
id|request_id
suffix:semicolon
r_if
c_cond
(paren
id|TW_SGL_OUT
c_func
(paren
id|oldcommand-&gt;opcode__sgloffset
)paren
)paren
(brace
multiline_comment|/* Load the sg list */
id|sgl
op_assign
(paren
id|TW_SG_Entry
op_star
)paren
(paren
(paren
id|u32
op_star
)paren
id|oldcommand
op_plus
id|TW_SGL_OUT
c_func
(paren
id|oldcommand-&gt;opcode__sgloffset
)paren
)paren
suffix:semicolon
id|sgl-&gt;address
op_assign
id|dma_handle
op_plus
r_sizeof
(paren
id|TW_Ioctl_Buf_Apache
)paren
op_minus
l_int|1
suffix:semicolon
id|sgl-&gt;length
op_assign
id|length
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* End twa_load_sgl() */
multiline_comment|/* This function will perform a pci-dma mapping for a scatter gather list */
DECL|function|twa_map_scsi_sg_data
r_static
r_int
id|twa_map_scsi_sg_data
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
r_int
id|use_sg
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmd
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|tw_dev-&gt;tw_pci_dev
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|use_sg
op_assign
id|pci_map_sg
c_func
(paren
id|pdev
comma
id|cmd-&gt;buffer
comma
id|cmd-&gt;use_sg
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|use_sg
op_eq
l_int|0
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x1c
comma
l_string|&quot;Failed to map scatter gather list&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|cmd-&gt;SCp.phase
op_assign
id|TW_PHASE_SGLIST
suffix:semicolon
id|cmd-&gt;SCp.have_data_in
op_assign
id|use_sg
suffix:semicolon
id|retval
op_assign
id|use_sg
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_map_scsi_sg_data() */
multiline_comment|/* This function will perform a pci-dma map for a single buffer */
DECL|function|twa_map_scsi_single_data
r_static
id|dma_addr_t
id|twa_map_scsi_single_data
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
id|dma_addr_t
id|mapping
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmd
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|tw_dev-&gt;tw_pci_dev
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
op_eq
l_int|0
)paren
(brace
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|mapping
op_assign
id|pci_map_single
c_func
(paren
id|pdev
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;request_bufflen
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mapping
op_eq
l_int|0
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x1d
comma
l_string|&quot;Failed to map page&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|cmd-&gt;SCp.phase
op_assign
id|TW_PHASE_SINGLE
suffix:semicolon
id|cmd-&gt;SCp.have_data_in
op_assign
id|mapping
suffix:semicolon
id|retval
op_assign
id|mapping
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_map_scsi_single_data() */
multiline_comment|/* This function will poll for a response interrupt of a request */
DECL|function|twa_poll_response
r_static
r_int
id|twa_poll_response
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
comma
r_int
id|seconds
)paren
(brace
r_int
id|retval
op_assign
l_int|1
comma
id|found
op_assign
l_int|0
comma
id|response_request_id
suffix:semicolon
id|TW_Response_Queue
id|response_queue
suffix:semicolon
id|TW_Command_Full
op_star
id|full_command_packet
op_assign
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
suffix:semicolon
r_if
c_cond
(paren
id|twa_poll_status_gone
c_func
(paren
id|tw_dev
comma
id|TW_STATUS_RESPONSE_QUEUE_EMPTY
comma
id|seconds
)paren
op_eq
l_int|0
)paren
(brace
id|response_queue.value
op_assign
id|readl
c_func
(paren
id|TW_RESPONSE_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|response_request_id
op_assign
id|TW_RESID_OUT
c_func
(paren
id|response_queue.response_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_id
op_ne
id|response_request_id
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x1e
comma
l_string|&quot;Found unexpected request id while polling for response&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TW_OP_OUT
c_func
(paren
id|full_command_packet-&gt;command.newcommand.opcode__reserved
)paren
op_eq
id|TW_OP_EXECUTE_SCSI
)paren
(brace
r_if
c_cond
(paren
id|full_command_packet-&gt;command.newcommand.status
op_ne
l_int|0
)paren
(brace
multiline_comment|/* bad response */
id|twa_fill_sense
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|found
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|full_command_packet-&gt;command.oldcommand.status
op_ne
l_int|0
)paren
(brace
multiline_comment|/* bad response */
id|twa_fill_sense
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|found
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|found
)paren
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_poll_response() */
multiline_comment|/* This function will poll the status register for a flag */
DECL|function|twa_poll_status
r_static
r_int
id|twa_poll_status
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
id|u32
id|flag
comma
r_int
id|seconds
)paren
(brace
id|u32
id|status_reg_value
suffix:semicolon
r_int
r_int
id|before
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
id|status_reg_value
op_assign
id|readl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|before
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|twa_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
id|twa_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status_reg_value
op_amp
id|flag
)paren
op_ne
id|flag
)paren
(brace
id|status_reg_value
op_assign
id|readl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|twa_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
id|twa_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|before
op_plus
id|HZ
op_star
id|seconds
)paren
)paren
r_goto
id|out
suffix:semicolon
id|msleep
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_poll_status() */
multiline_comment|/* This function will poll the status register for disappearance of a flag */
DECL|function|twa_poll_status_gone
r_static
r_int
id|twa_poll_status_gone
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
id|u32
id|flag
comma
r_int
id|seconds
)paren
(brace
id|u32
id|status_reg_value
suffix:semicolon
r_int
r_int
id|before
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
id|status_reg_value
op_assign
id|readl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
id|before
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|twa_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
id|twa_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status_reg_value
op_amp
id|flag
)paren
op_ne
l_int|0
)paren
(brace
id|status_reg_value
op_assign
id|readl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|twa_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
id|twa_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|before
op_plus
id|HZ
op_star
id|seconds
)paren
)paren
r_goto
id|out
suffix:semicolon
id|msleep
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_poll_status_gone() */
multiline_comment|/* This function will attempt to post a command packet to the board */
DECL|function|twa_post_command_packet
r_static
r_int
id|twa_post_command_packet
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
comma
r_char
id|internal
)paren
(brace
id|u32
id|status_reg_value
suffix:semicolon
r_int
r_int
id|command_que_value
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
id|command_que_value
op_assign
id|tw_dev-&gt;command_packet_phys
(braket
id|request_id
)braket
suffix:semicolon
id|status_reg_value
op_assign
id|readl
c_func
(paren
id|TW_STATUS_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|twa_check_bits
c_func
(paren
id|status_reg_value
)paren
)paren
id|twa_decode_bits
c_func
(paren
id|tw_dev
comma
id|status_reg_value
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|tw_dev-&gt;pending_request_count
OG
l_int|0
)paren
op_logical_and
(paren
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_ne
id|TW_S_PENDING
)paren
)paren
op_logical_or
(paren
id|status_reg_value
op_amp
id|TW_STATUS_COMMAND_QUEUE_FULL
)paren
)paren
(brace
multiline_comment|/* Only pend internal driver commands */
r_if
c_cond
(paren
op_logical_neg
id|internal
)paren
(brace
id|retval
op_assign
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Couldn&squot;t post the command packet, so we do it later */
r_if
c_cond
(paren
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_ne
id|TW_S_PENDING
)paren
(brace
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_PENDING
suffix:semicolon
id|tw_dev-&gt;pending_request_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;pending_request_count
OG
id|tw_dev-&gt;max_pending_request_count
)paren
(brace
id|tw_dev-&gt;max_pending_request_count
op_assign
id|tw_dev-&gt;pending_request_count
suffix:semicolon
)brace
id|tw_dev-&gt;pending_queue
(braket
id|tw_dev-&gt;pending_tail
)braket
op_assign
id|request_id
suffix:semicolon
id|tw_dev-&gt;pending_tail
op_assign
(paren
id|tw_dev-&gt;pending_tail
op_plus
l_int|1
)paren
op_mod
id|TW_Q_LENGTH
suffix:semicolon
)brace
id|TW_UNMASK_COMMAND_INTERRUPT
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We successfully posted the command packet */
macro_line|#if BITS_PER_LONG &gt; 32
id|writeq
c_func
(paren
id|TW_COMMAND_OFFSET
op_plus
id|command_que_value
comma
id|TW_COMMAND_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
macro_line|#else
id|writel
c_func
(paren
id|TW_COMMAND_OFFSET
op_plus
id|command_que_value
comma
id|TW_COMMAND_QUEUE_REG_ADDR
c_func
(paren
id|tw_dev
)paren
)paren
suffix:semicolon
macro_line|#endif
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_POSTED
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;posted_request_count
OG
id|tw_dev-&gt;max_posted_request_count
)paren
(brace
id|tw_dev-&gt;max_posted_request_count
op_assign
id|tw_dev-&gt;posted_request_count
suffix:semicolon
)brace
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_post_command_packet() */
multiline_comment|/* This function will reset a device extension */
DECL|function|twa_reset_device_extension
r_static
r_int
id|twa_reset_device_extension
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Abort all requests that are in progress */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_Q_LENGTH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_ne
id|TW_S_FINISHED
)paren
op_logical_and
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_ne
id|TW_S_INITIAL
)paren
op_logical_and
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_ne
id|TW_S_COMPLETED
)paren
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|i
)braket
)paren
(brace
id|tw_dev-&gt;srb
(braket
id|i
)braket
op_member_access_from_pointer
id|result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
id|tw_dev-&gt;srb
(braket
id|i
)braket
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|i
)braket
)paren
suffix:semicolon
id|twa_unmap_scsi_data
c_func
(paren
id|tw_dev
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Reset queues and counts */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_Q_LENGTH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tw_dev-&gt;free_queue
(braket
id|i
)braket
op_assign
id|i
suffix:semicolon
id|tw_dev-&gt;state
(braket
id|i
)braket
op_assign
id|TW_S_INITIAL
suffix:semicolon
)brace
id|tw_dev-&gt;free_head
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;free_tail
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;posted_request_count
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;pending_request_count
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;pending_head
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;pending_tail
op_assign
id|TW_Q_START
suffix:semicolon
id|tw_dev-&gt;reset_print
op_assign
l_int|0
suffix:semicolon
id|tw_dev-&gt;chrdev_request_id
op_assign
id|TW_IOCTL_CHRDEV_FREE
suffix:semicolon
id|tw_dev-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|TW_DISABLE_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|twa_reset_sequence
c_func
(paren
id|tw_dev
comma
l_int|1
)paren
)paren
r_goto
id|out
suffix:semicolon
id|TW_ENABLE_AND_CLEAR_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_reset_device_extension() */
multiline_comment|/* This function will reset a controller */
DECL|function|twa_reset_sequence
r_static
r_int
id|twa_reset_sequence
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|soft_reset
)paren
(brace
r_int
id|tries
op_assign
l_int|0
comma
id|retval
op_assign
l_int|1
comma
id|flashed
op_assign
l_int|0
comma
id|do_soft_reset
op_assign
id|soft_reset
suffix:semicolon
r_while
c_loop
(paren
id|tries
OL
id|TW_MAX_RESET_TRIES
)paren
(brace
r_if
c_cond
(paren
id|do_soft_reset
)paren
id|TW_SOFT_RESET
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Make sure controller is in a good state */
r_if
c_cond
(paren
id|twa_poll_status
c_func
(paren
id|tw_dev
comma
id|TW_STATUS_MICROCONTROLLER_READY
op_or
(paren
id|do_soft_reset
op_eq
l_int|1
ques
c_cond
id|TW_STATUS_ATTENTION_INTERRUPT
suffix:colon
l_int|0
)paren
comma
l_int|30
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x1f
comma
l_string|&quot;Microcontroller not ready during reset sequence&quot;
)paren
suffix:semicolon
id|do_soft_reset
op_assign
l_int|1
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Empty response queue */
r_if
c_cond
(paren
id|twa_empty_response_queue
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x20
comma
l_string|&quot;Response queue empty failed during reset sequence&quot;
)paren
suffix:semicolon
id|do_soft_reset
op_assign
l_int|1
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|flashed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check for compatibility/flash */
r_if
c_cond
(paren
id|twa_check_srl
c_func
(paren
id|tw_dev
comma
op_amp
id|flashed
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x21
comma
l_string|&quot;Compatibility check failed during reset sequence&quot;
)paren
suffix:semicolon
id|do_soft_reset
op_assign
l_int|1
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|flashed
)paren
(brace
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/* Drain the AEN queue */
r_if
c_cond
(paren
id|twa_aen_drain_queue
c_func
(paren
id|tw_dev
comma
id|soft_reset
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x22
comma
l_string|&quot;AEN drain failed during reset sequence&quot;
)paren
suffix:semicolon
id|do_soft_reset
op_assign
l_int|1
suffix:semicolon
id|tries
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* If we got here, controller is in a good state */
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_reset_sequence() */
multiline_comment|/* This funciton returns unit geometry in cylinders/heads/sectors */
DECL|function|twa_scsi_biosparam
r_static
r_int
id|twa_scsi_biosparam
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
comma
r_struct
id|block_device
op_star
id|bdev
comma
id|sector_t
id|capacity
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
suffix:semicolon
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|capacity
op_ge
l_int|0x200000
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
id|sector_div
c_func
(paren
id|capacity
comma
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
r_else
(brace
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|sector_div
c_func
(paren
id|capacity
comma
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End twa_scsi_biosparam() */
multiline_comment|/* This is the new scsi eh abort function */
DECL|function|twa_scsi_eh_abort
r_static
r_int
id|twa_scsi_eh_abort
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
)paren
(brace
r_int
id|i
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
op_assign
id|FAILED
suffix:semicolon
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|tw_dev-&gt;num_aborts
op_increment
suffix:semicolon
multiline_comment|/* If we find any IO&squot;s in process, we have to reset the card */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TW_Q_LENGTH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_ne
id|TW_S_FINISHED
)paren
op_logical_and
(paren
id|tw_dev-&gt;state
(braket
id|i
)braket
op_ne
id|TW_S_INITIAL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-9xxx: scsi%d: WARNING: (0x%02X:0x%04X): Unit #%d: Command (0x%x) timed out, resetting card.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
comma
id|TW_DRIVER
comma
l_int|0x2c
comma
id|SCpnt-&gt;device-&gt;id
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|twa_reset_device_extension
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x2a
comma
l_string|&quot;Controller reset failed during scsi abort&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|out
suffix:colon
id|spin_lock_irq
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_scsi_eh_abort() */
multiline_comment|/* This is the new scsi eh reset function */
DECL|function|twa_scsi_eh_reset
r_static
r_int
id|twa_scsi_eh_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
)paren
(brace
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
op_assign
id|FAILED
suffix:semicolon
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|tw_dev-&gt;num_resets
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-9xxx: scsi%d: SCSI host reset started.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
multiline_comment|/* Now reset the card and some of the device extension data */
r_if
c_cond
(paren
id|twa_reset_device_extension
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x2b
comma
l_string|&quot;Controller reset failed during scsi host reset&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-9xxx: scsi%d: SCSI host reset succeeded.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|out
suffix:colon
id|spin_lock_irq
c_func
(paren
id|tw_dev-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_scsi_eh_reset() */
multiline_comment|/* This is the main scsi queue function to handle scsi opcodes */
DECL|function|twa_scsi_queue
r_static
r_int
id|twa_scsi_queue
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
r_int
id|request_id
comma
id|retval
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
multiline_comment|/* Save done function into scsi_cmnd struct */
id|SCpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
multiline_comment|/* Get a free request id */
id|twa_get_request_id
c_func
(paren
id|tw_dev
comma
op_amp
id|request_id
)paren
suffix:semicolon
multiline_comment|/* Save the scsi command for use by the ISR */
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_assign
id|SCpnt
suffix:semicolon
multiline_comment|/* Initialize phase to zero */
id|SCpnt-&gt;SCp.phase
op_assign
id|TW_PHASE_INITIAL
suffix:semicolon
id|retval
op_assign
id|twa_scsiop_execute_scsi
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|retval
)paren
(brace
r_case
id|SCSI_MLQUEUE_HOST_BUSY
suffix:colon
id|twa_free_request_id
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|tw_dev-&gt;state
(braket
id|request_id
)braket
op_assign
id|TW_S_COMPLETED
suffix:semicolon
id|twa_free_request_id
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_scsi_queue() */
multiline_comment|/* This function hands scsi cdb&squot;s to the firmware */
DECL|function|twa_scsiop_execute_scsi
r_static
r_int
id|twa_scsiop_execute_scsi
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
comma
r_char
op_star
id|cdb
comma
r_int
id|use_sg
comma
id|TW_SG_Apache
op_star
id|sglistarg
)paren
(brace
id|TW_Command_Full
op_star
id|full_command_packet
suffix:semicolon
id|TW_Command_Apache
op_star
id|command_packet
suffix:semicolon
id|u32
id|num_sectors
op_assign
l_int|0x0
suffix:semicolon
r_int
id|i
comma
id|sg_count
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|srb
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sglist
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|buffaddr
op_assign
l_int|0x0
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
)paren
(brace
id|sglist
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
suffix:semicolon
)brace
id|srb
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
suffix:semicolon
)brace
multiline_comment|/* Initialize command packet */
id|full_command_packet
op_assign
id|tw_dev-&gt;command_packet_virt
(braket
id|request_id
)braket
suffix:semicolon
id|full_command_packet-&gt;header.header_desc.size_header
op_assign
l_int|128
suffix:semicolon
id|full_command_packet-&gt;header.status_block.error
op_assign
l_int|0
suffix:semicolon
id|full_command_packet-&gt;header.status_block.severity__reserved
op_assign
l_int|0
suffix:semicolon
id|command_packet
op_assign
op_amp
id|full_command_packet-&gt;command.newcommand
suffix:semicolon
id|command_packet-&gt;status
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;opcode__reserved
op_assign
id|TW_OPRES_IN
c_func
(paren
l_int|0
comma
id|TW_OP_EXECUTE_SCSI
)paren
suffix:semicolon
multiline_comment|/* We forced 16 byte cdb use earlier */
r_if
c_cond
(paren
op_logical_neg
id|cdb
)paren
id|memcpy
c_func
(paren
id|command_packet-&gt;cdb
comma
id|srb-&gt;cmnd
comma
id|TW_MAX_CDB_LEN
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|command_packet-&gt;cdb
comma
id|cdb
comma
id|TW_MAX_CDB_LEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb
)paren
id|command_packet-&gt;unit
op_assign
id|srb-&gt;device-&gt;id
suffix:semicolon
r_else
id|command_packet-&gt;unit
op_assign
l_int|0
suffix:semicolon
id|command_packet-&gt;request_id
op_assign
id|request_id
suffix:semicolon
id|command_packet-&gt;sgl_offset
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sglistarg
)paren
(brace
multiline_comment|/* Map sglist from scsi layer to cmd packet */
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
OL
id|TW_MIN_SGL_LENGTH
)paren
(brace
id|command_packet-&gt;sg_list
(braket
l_int|0
)braket
dot
id|address
op_assign
id|tw_dev-&gt;generic_buffer_phys
(braket
id|request_id
)braket
suffix:semicolon
id|command_packet-&gt;sg_list
(braket
l_int|0
)braket
dot
id|length
op_assign
id|TW_MIN_SGL_LENGTH
suffix:semicolon
)brace
r_else
(brace
id|buffaddr
op_assign
id|twa_map_scsi_single_data
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffaddr
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|command_packet-&gt;sg_list
(braket
l_int|0
)braket
dot
id|address
op_assign
id|buffaddr
suffix:semicolon
id|command_packet-&gt;sg_list
(braket
l_int|0
)braket
dot
id|length
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
suffix:semicolon
)brace
id|command_packet-&gt;sgl_entries
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|command_packet-&gt;sg_list
(braket
l_int|0
)braket
dot
id|address
op_amp
id|TW_ALIGNMENT_9000_SGL
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x2d
comma
l_string|&quot;Found unaligned address during execute scsi&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
OG
l_int|0
)paren
(brace
id|sg_count
op_assign
id|twa_map_scsi_sg_data
c_func
(paren
id|tw_dev
comma
id|request_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_count
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sg_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|command_packet-&gt;sg_list
(braket
id|i
)braket
dot
id|address
op_assign
id|sg_dma_address
c_func
(paren
op_amp
id|sglist
(braket
id|i
)braket
)paren
suffix:semicolon
id|command_packet-&gt;sg_list
(braket
id|i
)braket
dot
id|length
op_assign
id|sg_dma_len
c_func
(paren
op_amp
id|sglist
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command_packet-&gt;sg_list
(braket
id|i
)braket
dot
id|address
op_amp
id|TW_ALIGNMENT_9000_SGL
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x2e
comma
l_string|&quot;Found unaligned sgl address during execute scsi&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|command_packet-&gt;sgl_entries
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Internal cdb post */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|command_packet-&gt;sg_list
(braket
id|i
)braket
dot
id|address
op_assign
id|sglistarg
(braket
id|i
)braket
dot
id|address
suffix:semicolon
id|command_packet-&gt;sg_list
(braket
id|i
)braket
dot
id|length
op_assign
id|sglistarg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|command_packet-&gt;sg_list
(braket
id|i
)braket
dot
id|address
op_amp
id|TW_ALIGNMENT_9000_SGL
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x2f
comma
l_string|&quot;Found unaligned sgl address during internal post&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|command_packet-&gt;sgl_entries
op_assign
id|use_sg
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srb
)paren
(brace
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_6
op_logical_or
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
id|num_sectors
op_assign
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_10
op_logical_or
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_10
)paren
id|num_sectors
op_assign
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|8
)braket
op_or
(paren
(paren
id|u32
)paren
id|srb-&gt;cmnd
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/* Update sector statistic */
id|tw_dev-&gt;sector_count
op_assign
id|num_sectors
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;sector_count
OG
id|tw_dev-&gt;max_sector_count
)paren
id|tw_dev-&gt;max_sector_count
op_assign
id|tw_dev-&gt;sector_count
suffix:semicolon
multiline_comment|/* Update SG statistics */
r_if
c_cond
(paren
id|srb
)paren
(brace
id|tw_dev-&gt;sgl_entries
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|use_sg
suffix:semicolon
r_if
c_cond
(paren
id|tw_dev-&gt;sgl_entries
OG
id|tw_dev-&gt;max_sgl_entries
)paren
id|tw_dev-&gt;max_sgl_entries
op_assign
id|tw_dev-&gt;sgl_entries
suffix:semicolon
)brace
multiline_comment|/* Now post the command to the board */
r_if
c_cond
(paren
id|srb
)paren
(brace
id|retval
op_assign
id|twa_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|twa_post_command_packet
c_func
(paren
id|tw_dev
comma
id|request_id
comma
l_int|1
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_scsiop_execute_scsi() */
multiline_comment|/* This function completes an execute scsi operation */
DECL|function|twa_scsiop_execute_scsi_complete
r_static
r_void
id|twa_scsiop_execute_scsi_complete
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
multiline_comment|/* Copy the response if too small */
r_if
c_cond
(paren
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
)paren
op_logical_and
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
OL
id|TW_MIN_SGL_LENGTH
)paren
)paren
(brace
id|memcpy
c_func
(paren
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_buffer
comma
id|tw_dev-&gt;generic_buffer_virt
(braket
id|request_id
)braket
comma
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
op_member_access_from_pointer
id|request_bufflen
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* End twa_scsiop_execute_scsi_complete() */
multiline_comment|/* This function tells the controller to shut down */
DECL|function|__twa_shutdown
r_static
r_void
id|__twa_shutdown
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
)paren
(brace
multiline_comment|/* Disable interrupts */
id|TW_DISABLE_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-9xxx: Shutting down host %d.&bslash;n&quot;
comma
id|tw_dev-&gt;host-&gt;host_no
)paren
suffix:semicolon
multiline_comment|/* Tell the card we are shutting down */
r_if
c_cond
(paren
id|twa_initconnection
c_func
(paren
id|tw_dev
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x31
comma
l_string|&quot;Connection shutdown failed&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-9xxx: Shutdown complete.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear all interrupts just before exit */
id|TW_ENABLE_AND_CLEAR_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
)brace
multiline_comment|/* End __twa_shutdown() */
multiline_comment|/* Wrapper for __twa_shutdown */
DECL|function|twa_shutdown
r_static
r_void
id|twa_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|pci_get_drvdata
c_func
(paren
id|to_pci_dev
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|__twa_shutdown
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
)brace
multiline_comment|/* End twa_shutdown() */
multiline_comment|/* This function will look up a string */
DECL|function|twa_string_lookup
r_static
r_char
op_star
id|twa_string_lookup
c_func
(paren
id|twa_message_type
op_star
id|table
comma
r_int
r_int
id|code
)paren
(brace
r_int
id|index
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|code
op_ne
id|table
(braket
id|index
)braket
dot
id|code
)paren
op_logical_and
(paren
id|table
(braket
id|index
)braket
dot
id|text
op_ne
(paren
r_char
op_star
)paren
l_int|0
)paren
)paren
suffix:semicolon
id|index
op_increment
)paren
suffix:semicolon
r_return
id|table
(braket
id|index
)braket
dot
id|text
suffix:semicolon
)brace
multiline_comment|/* End twa_string_lookup() */
multiline_comment|/* This function will perform a pci-dma unmap */
DECL|function|twa_unmap_scsi_data
r_static
r_void
id|twa_unmap_scsi_data
c_func
(paren
id|TW_Device_Extension
op_star
id|tw_dev
comma
r_int
id|request_id
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|cmd
op_assign
id|tw_dev-&gt;srb
(braket
id|request_id
)braket
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|tw_dev-&gt;tw_pci_dev
suffix:semicolon
r_switch
c_cond
(paren
id|cmd-&gt;SCp.phase
)paren
(brace
r_case
id|TW_PHASE_SINGLE
suffix:colon
id|pci_unmap_single
c_func
(paren
id|pdev
comma
id|cmd-&gt;SCp.have_data_in
comma
id|cmd-&gt;request_bufflen
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TW_PHASE_SGLIST
suffix:colon
id|pci_unmap_sg
c_func
(paren
id|pdev
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;use_sg
comma
id|DMA_BIDIRECTIONAL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* End twa_unmap_scsi_data() */
multiline_comment|/* scsi_host_template initializer */
DECL|variable|driver_template
r_static
r_struct
id|scsi_host_template
id|driver_template
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;3ware 9000 Storage Controller&quot;
comma
dot
id|queuecommand
op_assign
id|twa_scsi_queue
comma
dot
id|eh_abort_handler
op_assign
id|twa_scsi_eh_abort
comma
dot
id|eh_host_reset_handler
op_assign
id|twa_scsi_eh_reset
comma
dot
id|bios_param
op_assign
id|twa_scsi_biosparam
comma
dot
id|can_queue
op_assign
id|TW_Q_LENGTH
op_minus
l_int|2
comma
dot
id|this_id
op_assign
op_minus
l_int|1
comma
dot
id|sg_tablesize
op_assign
id|TW_APACHE_MAX_SGL_LENGTH
comma
dot
id|max_sectors
op_assign
id|TW_MAX_SECTORS
comma
dot
id|cmd_per_lun
op_assign
id|TW_MAX_CMDS_PER_LUN
comma
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
dot
id|shost_attrs
op_assign
id|twa_host_attrs
comma
dot
id|sdev_attrs
op_assign
id|twa_dev_attrs
comma
dot
id|emulated
op_assign
l_int|1
)brace
suffix:semicolon
multiline_comment|/* This function will probe and initialize a card */
DECL|function|twa_probe
r_static
r_int
id|__devinit
id|twa_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|dev_id
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
l_int|NULL
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
suffix:semicolon
id|u32
id|mem_addr
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|retval
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|host
comma
id|TW_DRIVER
comma
l_int|0x34
comma
l_string|&quot;Failed to enable pci device&quot;
)paren
suffix:semicolon
r_goto
id|out_disable_device
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|retval
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|TW_DMA_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|host
comma
id|TW_DRIVER
comma
l_int|0x23
comma
l_string|&quot;Failed to set dma mask&quot;
)paren
suffix:semicolon
r_goto
id|out_disable_device
suffix:semicolon
)brace
id|host
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|driver_template
comma
r_sizeof
(paren
id|TW_Device_Extension
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|host
comma
id|TW_DRIVER
comma
l_int|0x24
comma
l_string|&quot;Failed to allocate memory for device extension&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_disable_device
suffix:semicolon
)brace
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|memset
c_func
(paren
id|tw_dev
comma
l_int|0
comma
r_sizeof
(paren
id|TW_Device_Extension
)paren
)paren
suffix:semicolon
multiline_comment|/* Save values to device extension */
id|tw_dev-&gt;host
op_assign
id|host
suffix:semicolon
id|tw_dev-&gt;tw_pci_dev
op_assign
id|pdev
suffix:semicolon
r_if
c_cond
(paren
id|twa_initialize_device_extension
c_func
(paren
id|tw_dev
)paren
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x25
comma
l_string|&quot;Failed to initialize device extension&quot;
)paren
suffix:semicolon
r_goto
id|out_free_device_extension
suffix:semicolon
)brace
multiline_comment|/* Request IO regions */
id|retval
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
l_string|&quot;3w-9xxx&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x26
comma
l_string|&quot;Failed to get mem region&quot;
)paren
suffix:semicolon
r_goto
id|out_free_device_extension
suffix:semicolon
)brace
id|mem_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Save base address */
id|tw_dev-&gt;base_addr
op_assign
id|ioremap
c_func
(paren
id|mem_addr
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tw_dev-&gt;base_addr
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x35
comma
l_string|&quot;Failed to ioremap&quot;
)paren
suffix:semicolon
r_goto
id|out_release_mem_region
suffix:semicolon
)brace
multiline_comment|/* Disable interrupts on the card */
id|TW_DISABLE_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Initialize the card */
r_if
c_cond
(paren
id|twa_reset_sequence
c_func
(paren
id|tw_dev
comma
l_int|0
)paren
)paren
r_goto
id|out_release_mem_region
suffix:semicolon
multiline_comment|/* Set host specific parameters */
id|host-&gt;max_id
op_assign
id|TW_MAX_UNITS
suffix:semicolon
id|host-&gt;max_cmd_len
op_assign
id|TW_MAX_CDB_LEN
suffix:semicolon
multiline_comment|/* Luns and channels aren&squot;t supported by adapter */
id|host-&gt;max_lun
op_assign
l_int|0
suffix:semicolon
id|host-&gt;max_channel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Register the card with the kernel SCSI layer */
id|retval
op_assign
id|scsi_add_host
c_func
(paren
id|host
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x27
comma
l_string|&quot;scsi add host failed&quot;
)paren
suffix:semicolon
r_goto
id|out_release_mem_region
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|host
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-9xxx: scsi%d: Found a 3ware 9000 Storage Controller at 0x%x, IRQ: %d.&bslash;n&quot;
comma
id|host-&gt;host_no
comma
id|mem_addr
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3w-9xxx: scsi%d: Firmware %s, BIOS %s, Ports: %d.&bslash;n&quot;
comma
id|host-&gt;host_no
comma
(paren
r_char
op_star
)paren
id|twa_get_param
c_func
(paren
id|tw_dev
comma
l_int|0
comma
id|TW_VERSION_TABLE
comma
id|TW_PARAM_FWVER
comma
id|TW_PARAM_FWVER_LENGTH
)paren
comma
(paren
r_char
op_star
)paren
id|twa_get_param
c_func
(paren
id|tw_dev
comma
l_int|1
comma
id|TW_VERSION_TABLE
comma
id|TW_PARAM_BIOSVER
comma
id|TW_PARAM_BIOSVER_LENGTH
)paren
comma
op_star
(paren
r_int
op_star
)paren
id|twa_get_param
c_func
(paren
id|tw_dev
comma
l_int|2
comma
id|TW_INFORMATION_TABLE
comma
id|TW_PARAM_PORTCOUNT
comma
id|TW_PARAM_PORTCOUNT_LENGTH
)paren
)paren
suffix:semicolon
multiline_comment|/* Now setup the interrupt handler */
id|retval
op_assign
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|twa_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;3w-9xxx&quot;
comma
id|tw_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|TW_PRINTK
c_func
(paren
id|tw_dev-&gt;host
comma
id|TW_DRIVER
comma
l_int|0x30
comma
l_string|&quot;Error requesting IRQ&quot;
)paren
suffix:semicolon
r_goto
id|out_remove_host
suffix:semicolon
)brace
id|twa_device_extension_list
(braket
id|twa_device_extension_count
)braket
op_assign
id|tw_dev
suffix:semicolon
id|twa_device_extension_count
op_increment
suffix:semicolon
multiline_comment|/* Re-enable interrupts on the card */
id|TW_ENABLE_AND_CLEAR_INTERRUPTS
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Finally, scan the host */
id|scsi_scan_host
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|twa_major
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|twa_major
op_assign
id|register_chrdev
(paren
l_int|0
comma
l_string|&quot;twa&quot;
comma
op_amp
id|twa_fops
)paren
)paren
OL
l_int|0
)paren
id|TW_PRINTK
c_func
(paren
id|host
comma
id|TW_DRIVER
comma
l_int|0x29
comma
l_string|&quot;Failed to register character device&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_remove_host
suffix:colon
id|scsi_remove_host
c_func
(paren
id|host
)paren
suffix:semicolon
id|out_release_mem_region
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|out_free_device_extension
suffix:colon
id|twa_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|host
)paren
suffix:semicolon
id|out_disable_device
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* End twa_probe() */
multiline_comment|/* This function is called to remove a device */
DECL|function|twa_remove
r_static
r_void
id|twa_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|TW_Device_Extension
op_star
id|tw_dev
op_assign
(paren
id|TW_Device_Extension
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|scsi_remove_host
c_func
(paren
id|tw_dev-&gt;host
)paren
suffix:semicolon
id|__twa_shutdown
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Free up the IRQ */
id|free_irq
c_func
(paren
id|tw_dev-&gt;tw_pci_dev-&gt;irq
comma
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Free up the mem region */
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* Free up device extension resources */
id|twa_free_device_extension
c_func
(paren
id|tw_dev
)paren
suffix:semicolon
multiline_comment|/* Unregister character device */
r_if
c_cond
(paren
id|twa_major
op_ge
l_int|0
)paren
(brace
id|unregister_chrdev
c_func
(paren
id|twa_major
comma
l_string|&quot;twa&quot;
)paren
suffix:semicolon
id|twa_major
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|scsi_host_put
c_func
(paren
id|tw_dev-&gt;host
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|twa_device_extension_count
op_decrement
suffix:semicolon
)brace
multiline_comment|/* End twa_remove() */
multiline_comment|/* PCI Devices supported by this driver */
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|twa_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_3WARE
comma
id|PCI_DEVICE_ID_3WARE_9000
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|twa_pci_tbl
)paren
suffix:semicolon
multiline_comment|/* pci_driver initializer */
DECL|variable|twa_driver
r_static
r_struct
id|pci_driver
id|twa_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;3w-9xxx&quot;
comma
dot
id|id_table
op_assign
id|twa_pci_tbl
comma
dot
id|probe
op_assign
id|twa_probe
comma
dot
id|remove
op_assign
id|twa_remove
comma
dot
id|driver
op_assign
(brace
dot
id|shutdown
op_assign
id|twa_shutdown
)brace
)brace
suffix:semicolon
multiline_comment|/* This function is called on driver initialization */
DECL|function|twa_init
r_static
r_int
id|__init
id|twa_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;3ware 9000 Storage Controller device driver for Linux v%s.&bslash;n&quot;
comma
id|twa_driver_version
)paren
suffix:semicolon
r_return
id|pci_module_init
c_func
(paren
op_amp
id|twa_driver
)paren
suffix:semicolon
)brace
multiline_comment|/* End twa_init() */
multiline_comment|/* This function is called on driver exit */
DECL|function|twa_exit
r_static
r_void
id|__exit
id|twa_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|twa_driver
)paren
suffix:semicolon
)brace
multiline_comment|/* End twa_exit() */
DECL|variable|twa_init
id|module_init
c_func
(paren
id|twa_init
)paren
suffix:semicolon
DECL|variable|twa_exit
id|module_exit
c_func
(paren
id|twa_exit
)paren
suffix:semicolon
eof
