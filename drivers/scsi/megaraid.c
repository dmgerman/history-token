multiline_comment|/*===================================================================&n; *&n; *                    Linux MegaRAID device driver&n; *&n; * Copyright 2001  American Megatrends Inc.&n; *&n; *              This program is free software; you can redistribute it and/or&n; *              modify it under the terms of the GNU General Public License&n; *              as published by the Free Software Foundation; either version&n; *              2 of the License, or (at your option) any later version.&n; *&n; * Version : v1.18 (Oct 11, 2001)&n; *&n; * Description: Linux device driver for LSI Logic MegaRAID controller&n; *&n; * Supported controllers: MegaRAID 418, 428, 438, 466, 762, 467, 471, 490&n; *                                      493.&n; * History:&n; *&n; * Version 0.90:&n; *     Original source contributed by Dell; integrated it into the kernel and&n; *     cleaned up some things.  Added support for 438/466 controllers.&n; * Version 0.91:&n; *     Aligned mailbox area on 16-byte boundary.&n; *     Added schedule() at the end to properly clean up.&n; *     Made improvements for conformity to linux driver standards.&n; *&n; * Version 0.92:&n; *     Added support for 2.1 kernels.&n; *         Reads from pci_dev struct, so it&squot;s not dependent on pcibios.&n; *         Added some missing virt_to_bus() translations.&n; *     Added support for SMP.&n; *         Changed global cli()&squot;s to spinlocks for 2.1, and simulated&n; *          spinlocks for 2.0.&n; *     Removed setting of SA_INTERRUPT flag when requesting Irq.&n; *&n; * Version 0.92ac:&n; *     Small changes to the comments/formatting. Plus a couple of&n; *      added notes. Returned to the authors. No actual code changes&n; *      save printk levels.&n; *     8 Oct 98        Alan Cox &lt;alan.cox@linux.org&gt;&n; *&n; *     Merged with 2.1.131 source tree.&n; *     12 Dec 98       K. Baranowski &lt;kgb@knm.org.pl&gt;&n; *&n; * Version 0.93:&n; *     Added support for vendor specific ioctl commands (M_RD_IOCTL_CMD+xxh)&n; *     Changed some fields in MEGARAID struct to better values.&n; *     Added signature check for Rp controllers under 2.0 kernels&n; *     Changed busy-wait loop to be time-based&n; *     Fixed SMP race condition in isr&n; *     Added kfree (sgList) on release&n; *     Added #include linux/version.h to megaraid.h for hosts.h&n; *     Changed max_id to represent max logical drives instead of targets.&n; *&n; * Version 0.94:&n; *     Got rid of some excess locking/unlocking&n; *     Fixed slight memory corruption problem while memcpy&squot;ing into mailbox&n; *     Changed logical drives to be reported as luns rather than targets&n; *     Changed max_id to 16 since it is now max targets/chan again.&n; *     Improved ioctl interface for upcoming megamgr&n; *&n; * Version 0.95:&n; *     Fixed problem of queueing multiple commands to adapter;&n; *       still has some strange problems on some setups, so still&n; *       defaults to single.  To enable parallel commands change&n; *       #define MULTI_IO in megaraid.h&n; *     Changed kmalloc allocation to be done in beginning.&n; *     Got rid of C++ style comments&n; *&n; * Version 0.96:&n; *     762 fully supported.&n; *&n; * Version 0.97:&n; *     Changed megaraid_command to use wait_queue.&n; *&n; * Version 1.00:&n; *     Checks to see if an irq occurred while in isr, and runs through&n; *       routine again.&n; *     Copies mailbox to temp area before processing in isr&n; *     Added barrier() in busy wait to fix volatility bug&n; *     Uses separate list for freed Scbs, keeps track of cmd state&n; *     Put spinlocks around entire queue function for now...&n; *     Full multi-io commands working stablely without previous problems&n; *     Added skipXX LILO option for Madrona motherboard support&n; *&n; * Version 1.01:&n; *     Fixed bug in mega_cmd_done() for megamgr control commands,&n; *       the host_byte in the result code from the scsi request to&n; *       scsi midlayer is set to DID_BAD_TARGET when adapter&squot;s&n; *       returned codes are 0xF0 and 0xF4.&n; *&n; * Version 1.02:&n; *     Fixed the tape drive bug by extending the adapter timeout value&n; *       for passthrough command to 60 seconds in mega_build_cmd().&n; *&n; * Version 1.03:&n; *    Fixed Madrona support.&n; *    Changed the adapter timeout value from 60 sec in 1.02 to 10 min&n; *      for bigger and slower tape drive.&n; *    Added driver version printout at driver loadup time&n; *&n; * Version 1.04&n; *    Added code for 40 ld FW support.&n; *    Added new ioctl command 0x81 to support NEW_READ/WRITE_CONFIG with&n; *      data area greater than 4 KB, which is the upper bound for data&n; *      tranfer through scsi_ioctl interface.&n; *    The additional 32 bit field for 64bit address in the newly defined&n; *      mailbox64 structure is set to 0 at this point.&n; *&n; * Version 1.05&n; *    Changed the queing implementation for handling SCBs and completed&n; *      commands.&n; *    Added spinlocks in the interrupt service routine to enable the driver&n; *      function in the SMP environment.&n; *    Fixed the problem of unnecessary aborts in the abort entry point, which&n; *      also enables the driver to handle large amount of I/O requests for&n; *      long duration of time.&n; * Version 1.06&n; *              Intel Release&n; * Version 1.07&n; *    Removed the usage of uaccess.h file for kernel versions less than&n; *    2.0.36, as this file is not present in those versions.&n; *&n; * Version 108&n; *    Modified mega_ioctl so that 40LD megamanager would run&n; *    Made some changes for 2.3.XX compilation , esp wait structures&n; *    Code merge between 1.05 and 1.06 .&n; *    Bug fixed problem with ioctl interface for concurrency between&n; *    8ld and 40ld firwmare&n; *    Removed the flawed semaphore logic for handling new config command&n; *    Added support for building own scatter / gather list for big user&n; *    mode buffers&n; *    Added /proc file system support ,so that information is available in&n; *    human readable format&n; *&n; * Version 1a08&n; *    Changes for IA64 kernels. Checked for CONFIG_PROC_FS flag&n; *&n; * Version 1b08&n; *    Include file changes.&n; * Version 1b08b&n; *    Change PCI ID value for the 471 card, use #defines when searching&n; *    for megaraid cards.&n; *&n; * Version 1.10&n; *&n; *      I) Changes made to make following ioctl commands work in 0x81 interface&n; *              a)DCMD_DELETE_LOGDRV&n; *              b)DCMD_GET_DISK_CONFIG&n; *              c)DCMD_DELETE_DRIVEGROUP&n; *              d)NC_SUBOP_ENQUIRY3&n; *              e)DCMD_CHANGE_LDNO&n; *              f)DCMD_CHANGE_LOOPID&n; *              g)DCMD_FC_READ_NVRAM_CONFIG&n; *      h)DCMD_WRITE_CONFIG&n; *      II) Added mega_build_kernel_sg function&n; *  III)Firmware flashing option added&n; *&n; * Version 1.10a&n; *&n; *      I)Dell updates included in the source code.&n; *              Note:   This change is not tested due to the unavailability of IA64 kernel&n; *      and it is in the #ifdef DELL_MODIFICATION macro which is not defined&n; *&n; * Version 1.10b&n; *&n; *      I)In M_RD_IOCTL_CMD_NEW command the wrong way of copying the data&n; *    to the user address corrected&n; *&n; * Version 1.10c&n; *&n; *      I) DCMD_GET_DISK_CONFIG opcode updated for the firmware changes.&n; *&n; * Version 1.11&n; *      I)  Version number changed from 1.10c to 1.11&n; *  II) DCMD_WRITE_CONFIG(0x0D) command in the driver changed from&n; *      scatter/gather list mode to direct pointer mode..&n; *     Fixed bug of undesirably detecting HP onboard controllers which&n; *       are disabled.&n; *&n; *      Version 1.12 (Sep 21, 2000)&n; *&n; *     I. Changes have been made for Dynamic DMA mapping in IA64 platform.&n; *                To enable all these changes define M_RD_DYNAMIC_DMA_SUPPORT in megaraid.h&n; *        II. Got rid of windows mode comments&n; *       III. Removed unwanted code segments&n; *    IV. Fixed bug of HP onboard controller information (commented with&n; *                 MEGA_HP_FIX)&n; *&n; *      Version 1a12&n; *      I.      reboot notifier and new ioctl changes ported from 1c09&n; *&n; *      Version 1b12&n; *      I.      Changes in new ioctl interface routines ( Nov 06, 2000 )&n; *&n; *      Version 1c12&n; *      I.      Changes in new ioctl interface routines ( Nov 07, 2000 )&n; *&n; *      Version 1d12&n; *      I.      Compilation error under kernel 2.4.0 for 32-bit machine in mega_ioctl&n; *&n; *      Version 1e12, 1f12&n; *      1.  Fixes for pci_map_single, pci_alloc_consistent along with mailbox&n; *          alignment&n; *&n; *&t;Version 1.13beta&n; *&t;Added Support for Full 64bit address space support. If firmware&n; *&t;supports 64bit, it goes to 64 bit mode even on x86 32bit &n; *&t;systems. Data Corruption Issues while running on test9 kernel&n; *&t;on IA64 systems. This issue not seen on test11 on x86 system&n; *&n; *&t;Version 1.13c&n; *&t;1. Resolved Memory Leak when using M_RD_IOCTL_CMD interface&n; *&t;2. Resolved Queuing problem when MailBox Blocks&n; *&t;3. Added unregister_reboot_notifier support&n; * &n; *&t;Version 1.13d&n; *&t;Experimental changes in interfacing with the controller in ISR&n; *&n; *&t;Version 1.13e&n; *&t;Fixed Broken 2.2.XX compilation changes + misc changes&n; *&n; *&t;Version 1.13f to 1.13i&n; *&t;misc changes + code clean up&n; *&t;Cleaned up the ioctl code and added set_mbox_xfer_addr()&n; *&t;Support for START_DEV (6)&n; * &t;&n; *&t;Version 1.13j&n; *&t;Moved some code to megaraid.h file, replaced some hard coded values &n; *      with respective macros. Changed some functions to static&n; *&n; *&t;Version 1.13k&n; *&t;Only some idendation correction to 1.13j &n; *&n; *&t;Version 1.13l , 1.13m, 1.13n, 1.13o&n; *&t;Minor Identation changes + misc changes&n; *&n; *&t;Version 1.13q&n; *&t;Paded the new uioctl_t MIMD structure for maintaining alignment &n; *&t;and size across 32 / 64 bit platforms&n; *&t;Changed the way MIMD IOCTL interface used virt_to_bus() to use pci&n; *&t;memory location&n; *&n; *&t;Version 1.13r&n; *&t;2.4.xx SCSI Changes.&n; *&n; *&t;Version 1.13s&n; *&t;Stats counter fixes&n; *&t;Temporary fix for some 64 bit firmwares in 2.4.XX kernels&n; *&n; *&t;Version&t;1.13t&n; *&t;Support for 64bit version of READ/WRITE/VIEW DISK CONFIG&n; *&n; *&t;Version 1.14&n; *&t;Did away with MEGADEV_IOCTL flag. It is now standard part of driver&n; *&t;without need for a special #define flag&n; *&t;Disabled old scsi ioctl path for kernel versions &gt; 2.3.xx. This is due&n; *&t;to the nature in which the new scsi code queues a new scsi command to &n; *&t;controller during SCSI IO Completion&n; *&t;Driver now checks for sub-system vendor id before taking ownership of&n; *&t;the controller&n; *&n; *&t;Version 1.14a&n; *&t;Added Host re-ordering&n; *&n; *&t;Version 1.14b&n; *&t;Corrected some issue which caused the older cards not to work&n; *&t;&n; *&t;Version 1.14c&n; *&t;IOCTL changes for not handling the non-64bit firmwares under 2.4.XX&n; *&t;kernel&n; *&n; *&t;Version 1.14d&n; *&t;Fixed Various MIMD Synchronization Issues&n; *&t;&n; *&t;Version 1.14e&n; *&t;Fixed the error handling during card initialization&n; *&n; *&t;Version 1.14f&n; *&t;Multiple invocations of mimd phase I ioctl stalls the cpu. Replaced&n; *&t;spinlock with semaphore(mutex)&n; *&n; *&t;Version 1.14g&n; *&t;Fixed running out of scbs issues while running MIMD apps under heavy IO&n; *&n; *&t;Version 1.14g-ac - 02/03/01&n; *&t;Reformatted to Linux format so I could compare to old one and cross&n; *&t;check bug fixes&n; *&t;Re fixed the assorted missing &squot;static&squot; cases&n; *&t;Removed some unneeded version checks&n; *&t;Cleaned up some of the VERSION checks in the code&n; *&t;Left 2.0 support but removed 2.1.x support.&n; *&t;Collected much of the compat glue into one spot&n; *&n; *&t;Version 1.14g-ac2 - 22/03/01&n; *&t;Fixed a non obvious dereference after free in the driver unload path&n; *&n; *&t;Version 1.14i&n; *&t;changes for making 32bit application run on IA64&n; *&n; *&t;Version 1.14j&n; *&t;Tue Mar 13 14:27:54 EST 2001 - AM&n; *&t;Changes made in the driver to be able to run applications if the&n; *&t;system has memory &gt;4GB.&n; *&n; *&n; *&t;Version 1.14k&n; *&t;Thu Mar 15 18:38:11 EST 2001 - AM&n; *&n; *&t;Firmware version check removed if subsysid==0x1111 and&n; *&t;subsysvid==0x1111, since its not yet initialized.&n; *&n; *&t;changes made to correctly calculate the base in mega_findCard.&n; *&n; *&t;Driver informational messages now appear on the console as well as&n; *&t;with dmesg&n; *&n; *&t;Older ioctl interface is returned failure on newer(2.4.xx) kernels.&n; *&n; *&t;Inclusion of &quot;modversions.h&quot; is still a debatable question. It is&n; *&t;included anyway with this release.&n; *&n; *&t;Version 1.14l&n; *&t;Mon Mar 19 17:39:46 EST 2001 - AM&n; *&n; *&t;Assorted changes to remove compilation error in 1.14k when compiled&n; *&t;with kernel &lt; 2.4.0&n; *&n; *&t;Version 1.14m&n; *&t;Tue Mar 27 12:09:22 EST 2001 - AM&n; *&n; *&t;Added support for extended CDBs ( &gt; 10 bytes ) and OBDR ( One Button&n; *&t;Disaster Recovery ) feature.&n; *&n; *&n; *&t;Version 1.14n&n; *&t;Tue Apr 10 14:28:13 EDT 2001 - AM&n; *&n; *&t;&quot;modeversions.h&quot; is no longer included in the code.&n; *&t;2.4.xx style mutex initialization used for older kernels also&n; *&n; *&t;Version 1.14o&n; *&t;Wed Apr 18 17:47:26 EDT 2001 - PJ&n; *&n; *&t;Before returning status for &squot;inquiry&squot;, we first check if request buffer&n; *&t;is SG list, and then return appropriate status&n; *&n; *&t;Version 1.14p&n; *&t;Wed Apr 25 13:44:48 EDT 2001 - PJ&n; *&n; *&t;SCSI result made appropriate in case of check conditions for extended&n; *&t;passthru commands&n; *&n; *&t;Do not support lun &gt;7 for physically accessed devices &n; *&n; *&t;&n; *&t;Version 1.15&n; *&t;Thu Apr 19 09:38:38 EDT 2001 - AM&n; *&n; *&t;1.14l rollover to 1.15 - merged with main trunk after 1.15d&n; *&n; *&t;Version 1.15b&n; *  Wed May 16 20:10:01 EDT 2001 - AM&n; *&n; *&t;&quot;modeversions.h&quot; is no longer included in the code.&n; *&t;2.4.xx style mutex initialization used for older kernels also&n; *&t;Brought in-sync with Alan&squot;s changes in 2.4.4&n; *&t;Note: 1.15a is on OBDR branch(main trunk), and is not merged with yet.&n; *&n; * Version 1.15c&n; * Mon May 21 23:10:42 EDT 2001 - AM&n; *&n; * ioctl interface uses 2.4.x conforming pci dma calls&n; * similar calls used for older kernels&n; *&n; * Version 1.15d&n; * Wed May 30 17:30:41 EDT 2001 - AM&n; *&n; * NULL is not a valid first argument for pci_alloc_consistent() on&n; * IA64(2.4.3-2.10.1). Code shuffling done in ioctl interface to get&n; * &quot;pci_dev&quot; before making calls to pci interface routines.&n; *&n; * Version 1.16pre&n; * Fri Jun  1 19:40:48 EDT 2001 - AM&n; *&n; * 1.14p and 1.15d merged&n; * ROMB support added&n; *&n; * Version 1.16-pre1&n; * Mon Jun  4 15:01:01 EDT 2001 - AM&n; *&n; * Non-ROMB firmware do no DMA support 0xA9 command. Value 0xFF&n; * (all channels are raid ) is chosen for those firmware.&n; *&n; * Version 1.16-pre2&n; * Mon Jun 11 18:15:31 EDT 2001 - AM&n; *&n; * Changes for boot from any logical drive&n; *&n; * Version 1.16&n; * Tue Jun 26 18:07:02 EDT 2001 - AM&n; *&n; * branched at 1.14p&n; *&n; * Check added for HP 1M/2M controllers if having firmware H.01.07 or&n; * H.01.08. If found, disable 64 bit support since these firmware have&n; * limitations for 64 bit addressing&n; *&n; *&n; * Version 1.17&n; * Thu Jul 12 11:14:09 EDT 2001 - AM&n; *&n; * 1.16pre2 and 1.16 merged.&n; *&n; * init_MUTEX and init_MUTEX_LOCKED are defined in 2.2.19. Pre-processor&n; * statements are added for them&n; *&n; * Linus&squot;s 2.4.7pre3 kernel introduces a new field &squot;max_sectors&squot; in Scsi_Host&n; * structure, to improve IO performance.&n; *&n; *&n; * Version 1.17a&n; * Fri Jul 13 18:44:01 EDT 2001 - AM&n; *&n; * Starting from kernel 2.4.x, LUN is not &lt; 8 - following SCSI-III. So to have&n; * our current formula working to calculate logical drive number, return&n; * failure for LUN &gt; 7&n; *&n; *&n; * Version 1.17b&n; * Mon Jul 30 19:24:02 EDT 2001 - AM&n; *&n; * Added support for random deletion of logical drives&n; *&n; * Version 1.17c&n; * Tue Sep 25 09:37:49 EDT 2001 - Atul Mukker &lt;atulm@lsil.com&gt;&n; *&n; * With single and dual channel controllers, some virtaul channels are&n; * displayed negative.&n; *&n; * Version 1.17a-ac&n; * Mon Aug 6 14:59:29 BST 2001 - &quot;Michael Johnson&quot; &lt;johnsom@home.com&gt;&n; *&n; * Make the HP print formatting and check for buggy firmware runtime not&n; * ifdef dependant.&n; *&n; *&n; * Version 1.17d&n; * Thu Oct 11 10:48:45 EDT 2001 - Atul Mukker &lt;atulm@lsil.com&gt;&n; *&n; * Driver 1.17c oops when loaded without controller.&n; *&n; * Special case for &quot;use_sg == 1&quot; removed while building the scatter gather&n; * list.&n; *&n; * Version 1.18&n; * Thu Oct 11 15:02:53 EDT 2001 - Atul Mukker &lt;atulm@lsil.com&gt;&n; *&n; * References to AMI have been changed to LSI Logic.&n; *&n; *&n; * BUGS:&n; *     Some older 2.1 kernels (eg. 2.1.90) have a bug in pci.c that&n; *     fails to detect the controller as a pci device on the system.&n; *&n; *     Timeout period for upper scsi layer, i.e. SD_TIMEOUT in&n; *     /drivers/scsi/sd.c, is too short for this controller. SD_TIMEOUT&n; *     value must be increased to (30 * HZ) otherwise false timeouts&n; *     will occur in the upper layer.&n; *&n; *     Never set skip_id. The existing PCI code the megaraid uses fails&n; *     to properly check the vendor subid in some cases. Setting this then&n; *     makes it steal other i960&squot;s and crashes some boxes&n; *&n; *     Far too many ifdefs for versions.&n; *&n; *===================================================================*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/slab.h&gt;&t;/* for kmalloc() */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,0)&t;/* 0x20100 */
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#else
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0)&t;/* 0x20300 */
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#else
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#endif
macro_line|#endif
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,0,24)&t;/* 0x020024 */
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#endif
multiline_comment|/*&n; * These header files are required for Shutdown Notification routines&n; */
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &lt;scsi/scsicam.h&gt;
macro_line|#include &quot;megaraid.h&quot;
multiline_comment|/*&n; *================================================================&n; *  #Defines&n; *================================================================&n; */
DECL|macro|MAX_SERBUF
mdefine_line|#define MAX_SERBUF 160
DECL|macro|COM_BASE
mdefine_line|#define COM_BASE 0x2f8
DECL|function|RDINDOOR
r_static
id|ulong
id|RDINDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_return
id|readl
(paren
id|megaCfg-&gt;base
op_plus
l_int|0x20
)paren
suffix:semicolon
)brace
DECL|function|WRINDOOR
r_static
r_void
id|WRINDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|ulong
id|value
)paren
(brace
id|writel
(paren
id|value
comma
id|megaCfg-&gt;base
op_plus
l_int|0x20
)paren
suffix:semicolon
)brace
DECL|function|RDOUTDOOR
r_static
id|ulong
id|RDOUTDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_return
id|readl
(paren
id|megaCfg-&gt;base
op_plus
l_int|0x2C
)paren
suffix:semicolon
)brace
DECL|function|WROUTDOOR
r_static
r_void
id|WROUTDOOR
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|ulong
id|value
)paren
(brace
id|writel
(paren
id|value
comma
id|megaCfg-&gt;base
op_plus
l_int|0x2C
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,2,0)&t;/* 0x020200 */
macro_line|#include &lt;linux/smp.h&gt;
DECL|macro|cpuid
mdefine_line|#define cpuid smp_processor_id()
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,4,4)
DECL|macro|scsi_set_pci_device
mdefine_line|#define scsi_set_pci_device(x,y)
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)&t;/* 0x020400 */
multiline_comment|/*&n; *&t;Linux 2.4 and higher&n; *&n; *&t;No driver private lock&n; *&t;Use the io_request_lock not cli/sti&n; *&t;queue task is a simple api without irq forms&n; */
id|MODULE_AUTHOR
(paren
l_string|&quot;LSI Logic Corporation&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;LSI Logic MegaRAID driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|DRIVER_LOCK_T
mdefine_line|#define DRIVER_LOCK_T
DECL|macro|DRIVER_LOCK_INIT
mdefine_line|#define DRIVER_LOCK_INIT(p)
DECL|macro|DRIVER_LOCK
mdefine_line|#define DRIVER_LOCK(p)
DECL|macro|DRIVER_UNLOCK
mdefine_line|#define DRIVER_UNLOCK(p)
DECL|macro|IO_LOCK_T
mdefine_line|#define IO_LOCK_T unsigned long io_flags = 0
DECL|macro|IO_LOCK
mdefine_line|#define IO_LOCK(host) spin_lock_irqsave(host-&gt;host_lock,io_flags)
DECL|macro|IO_UNLOCK
mdefine_line|#define IO_UNLOCK(host) spin_unlock_irqrestore(host-&gt;host_lock,io_flags)
DECL|macro|IO_LOCK_IRQ
mdefine_line|#define IO_LOCK_IRQ(host) spin_lock_irq(host-&gt;host_lock)
DECL|macro|IO_UNLOCK_IRQ
mdefine_line|#define IO_UNLOCK_IRQ(host) spin_unlock_irq(host-&gt;host_lock)
DECL|macro|queue_task_irq
mdefine_line|#define queue_task_irq(a,b)     queue_task(a,b)
DECL|macro|queue_task_irq_off
mdefine_line|#define queue_task_irq_off(a,b) queue_task(a,b)
macro_line|#elif LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,2,0)&t;/* 0x020200 */
multiline_comment|/*&n; *&t;Linux 2.2 and higher&n; *&n; *&t;No driver private lock&n; *&t;Use the io_request_lock not cli/sti&n; *&t;No pci region api&n; *&t;queue_task is now a single simple API&n; */
DECL|variable|kernel_version
r_static
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
id|MODULE_AUTHOR
(paren
l_string|&quot;LSI Logic Corporation&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;LSI Logic MegaRAID driver&quot;
)paren
suffix:semicolon
DECL|macro|DRIVER_LOCK_T
mdefine_line|#define DRIVER_LOCK_T
DECL|macro|DRIVER_LOCK_INIT
mdefine_line|#define DRIVER_LOCK_INIT(p)
DECL|macro|DRIVER_LOCK
mdefine_line|#define DRIVER_LOCK(p)
DECL|macro|DRIVER_UNLOCK
mdefine_line|#define DRIVER_UNLOCK(p)
DECL|macro|IO_LOCK_T
mdefine_line|#define IO_LOCK_T unsigned long io_flags = 0
DECL|macro|IO_LOCK
mdefine_line|#define IO_LOCK(host) spin_lock_irqsave(host-&gt;host_lock,io_flags);
DECL|macro|IO_UNLOCK
mdefine_line|#define IO_UNLOCK(host) spin_unlock_irqrestore(host-&gt;host_lock,io_flags);
DECL|macro|pci_free_consistent
mdefine_line|#define pci_free_consistent(a,b,c,d)
DECL|macro|pci_unmap_single
mdefine_line|#define pci_unmap_single(a,b,c,d)
DECL|macro|pci_enable_device
mdefine_line|#define pci_enable_device(x) (0)
DECL|macro|queue_task_irq
mdefine_line|#define queue_task_irq(a,b)     queue_task(a,b)
DECL|macro|queue_task_irq_off
mdefine_line|#define queue_task_irq_off(a,b) queue_task(a,b)
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,2,19)&t;/* 0x020219 */
DECL|macro|init_MUTEX_LOCKED
mdefine_line|#define init_MUTEX_LOCKED(x)    (*(x)=MUTEX_LOCKED)
DECL|macro|init_MUTEX
mdefine_line|#define init_MUTEX(x)           (*(x)=MUTEX)
DECL|macro|DECLARE_WAIT_QUEUE_HEAD
mdefine_line|#define DECLARE_WAIT_QUEUE_HEAD(x)&t;struct wait_queue *x = NULL
macro_line|#endif
macro_line|#else
multiline_comment|/*&n; *&t;Linux 2.0 macros. Here we have to provide some of our own&n; *&t;functionality. We also only work little endian 32bit.&n; *&t;Again no pci_alloc/free api&n; *&t;IO_LOCK/IO_LOCK_T were never used in 2.0 so now are empty &n; */
DECL|macro|cpuid
mdefine_line|#define cpuid 0
DECL|macro|DRIVER_LOCK_T
mdefine_line|#define DRIVER_LOCK_T long cpu_flags;
DECL|macro|DRIVER_LOCK_INIT
mdefine_line|#define DRIVER_LOCK_INIT(p)
DECL|macro|DRIVER_LOCK
mdefine_line|#define DRIVER_LOCK(p) &bslash;&n;       &t;&t;save_flags(cpu_flags); &bslash;&n;       &t;&t;cli();
DECL|macro|DRIVER_UNLOCK
mdefine_line|#define DRIVER_UNLOCK(p) &bslash;&n;       &t;&t;restore_flags(cpu_flags);
DECL|macro|IO_LOCK_T
mdefine_line|#define IO_LOCK_T
DECL|macro|IO_LOCK
mdefine_line|#define IO_LOCK(p)
DECL|macro|IO_UNLOCK
mdefine_line|#define IO_UNLOCK(p)
DECL|macro|le32_to_cpu
mdefine_line|#define le32_to_cpu(x) (x)
DECL|macro|cpu_to_le32
mdefine_line|#define cpu_to_le32(x) (x)
DECL|macro|pci_free_consistent
mdefine_line|#define pci_free_consistent(a,b,c,d)
DECL|macro|pci_unmap_single
mdefine_line|#define pci_unmap_single(a,b,c,d)
DECL|macro|init_MUTEX_LOCKED
mdefine_line|#define init_MUTEX_LOCKED(x)    (*(x)=MUTEX_LOCKED)
DECL|macro|init_MUTEX
mdefine_line|#define init_MUTEX(x)           (*(x)=MUTEX)
DECL|macro|pci_enable_device
mdefine_line|#define pci_enable_device(x) (0)
multiline_comment|/*&n; *&t;2.0 lacks spinlocks, iounmap/ioremap&n; */
DECL|macro|ioremap
mdefine_line|#define ioremap vremap
DECL|macro|iounmap
mdefine_line|#define iounmap vfree
multiline_comment|/* simulate spin locks */
r_typedef
r_struct
(brace
DECL|member|lock
r_volatile
r_char
id|lock
suffix:semicolon
DECL|typedef|spinlock_t
)brace
id|spinlock_t
suffix:semicolon
DECL|macro|spin_lock_init
mdefine_line|#define spin_lock_init(x) { (x)-&gt;lock = 0;}
DECL|macro|spin_lock_irqsave
mdefine_line|#define spin_lock_irqsave(x,flags) { while ((x)-&gt;lock) barrier();&bslash;&n;                                        (x)-&gt;lock=1; save_flags(flags);&bslash;&n;                                        cli();}
DECL|macro|spin_unlock_irqrestore
mdefine_line|#define spin_unlock_irqrestore(x,flags) { (x)-&gt;lock=0; restore_flags(flags);}
DECL|macro|DECLARE_WAIT_QUEUE_HEAD
mdefine_line|#define DECLARE_WAIT_QUEUE_HEAD(x)&t;struct wait_queue *x = NULL
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)&t;/* 0x020400 */
DECL|macro|dma_alloc_consistent
mdefine_line|#define dma_alloc_consistent pci_alloc_consistent
DECL|macro|dma_free_consistent
mdefine_line|#define dma_free_consistent pci_free_consistent
macro_line|#else
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,2,19)&t;/* 0x020219 */
DECL|typedef|dma_addr_t
r_typedef
r_int
r_int
id|dma_addr_t
suffix:semicolon
macro_line|#endif
r_void
op_star
id|dma_alloc_consistent
c_func
(paren
r_void
op_star
comma
r_int
comma
id|dma_addr_t
op_star
)paren
suffix:semicolon
r_void
id|dma_free_consistent
c_func
(paren
r_void
op_star
comma
r_int
comma
r_void
op_star
comma
id|dma_addr_t
)paren
suffix:semicolon
r_int
id|mega_get_order
c_func
(paren
r_int
)paren
suffix:semicolon
r_int
id|pow_2
c_func
(paren
r_int
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* set SERDEBUG to 1 to enable serial debugging */
DECL|macro|SERDEBUG
mdefine_line|#define SERDEBUG 0
macro_line|#if SERDEBUG
r_static
r_void
id|ser_init
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|ser_puts
(paren
r_char
op_star
id|str
)paren
suffix:semicolon
r_static
r_void
id|ser_putc
(paren
r_char
id|c
)paren
suffix:semicolon
r_static
r_int
id|ser_printk
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PROC_FS
DECL|macro|COPY_BACK
mdefine_line|#define COPY_BACK if (offset &gt; megaCfg-&gt;procidx) { &bslash;&n;&t;&t;*eof = TRUE; &bslash;&n;        megaCfg-&gt;procidx = 0; &bslash;&n;        megaCfg-&gt;procbuf[0] = 0; &bslash;&n;        return 0;} &bslash;&n; if ((count + offset) &gt; megaCfg-&gt;procidx) { &bslash;&n;      count = megaCfg-&gt;procidx - offset; &bslash;&n;      *eof = TRUE; } &bslash;&n;      memcpy(page, &amp;megaCfg-&gt;procbuf[offset], count); &bslash;&n;      megaCfg-&gt;procidx = 0; &bslash;&n;      megaCfg-&gt;procbuf[0] = 0;
macro_line|#endif
multiline_comment|/*&n; * ================================================================&n; *                    Global variables&n; *================================================================&n; */
multiline_comment|/*  Use &quot;megaraid=skipXX&quot; as LILO option to prohibit driver from scanning&n;    XX scsi id on each channel.  Used for Madrona motherboard, where SAF_TE&n;    processor id cannot be scanned */
DECL|variable|megaraid
r_static
r_char
op_star
id|megaraid
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,1,0)&t;/* 0x20100 */
macro_line|#ifdef MODULE
id|MODULE_PARM
(paren
id|megaraid
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
DECL|variable|skip_id
r_static
r_int
id|skip_id
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|numCtlrs
r_static
r_int
id|numCtlrs
op_assign
l_int|0
suffix:semicolon
DECL|variable|megaCtlrs
r_static
id|mega_host_config
op_star
id|megaCtlrs
(braket
id|FC_MAX_CHANNELS
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|mega_proc_dir_entry
r_static
r_struct
id|proc_dir_entry
op_star
id|mega_proc_dir_entry
suffix:semicolon
macro_line|#if DEBUG
DECL|variable|maxCmdTime
r_static
id|u32
id|maxCmdTime
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|variable|pLastScb
r_static
id|mega_scb
op_star
id|pLastScb
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mega_notifier
r_static
r_struct
id|notifier_block
id|mega_notifier
op_assign
(brace
id|megaraid_reboot_notify
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* For controller re-ordering */
DECL|variable|mega_hbas
r_struct
id|mega_hbas
id|mega_hbas
(braket
id|MAX_CONTROLLERS
)braket
suffix:semicolon
multiline_comment|/*&n; * The File Operations structure for the serial/ioctl interface of the driver&n; */
multiline_comment|/* For controller re-ordering */
DECL|variable|megadev_fops
r_static
r_struct
id|file_operations
id|megadev_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|ioctl
op_assign
id|megadev_ioctl_entry
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Array to structures for storing the information about the controllers. This&n; * information is sent to the user level applications, when they do an ioctl&n; * for this information.&n; */
DECL|variable|mcontroller
r_static
r_struct
id|mcontroller
id|mcontroller
(braket
id|MAX_CONTROLLERS
)braket
suffix:semicolon
multiline_comment|/* The current driver version */
DECL|variable|driver_ver
r_static
id|u32
id|driver_ver
op_assign
l_int|114
suffix:semicolon
multiline_comment|/* major number used by the device for character interface */
DECL|variable|major
r_static
r_int
id|major
suffix:semicolon
DECL|variable|mimd_ioctl_sem
r_static
r_struct
id|semaphore
id|mimd_ioctl_sem
suffix:semicolon
DECL|variable|mimd_entry_mtx
r_static
r_struct
id|semaphore
id|mimd_entry_mtx
suffix:semicolon
macro_line|#if SERDEBUG
DECL|variable|serial_lock
r_volatile
r_static
id|spinlock_t
id|serial_lock
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,4,0)&t;/* 0x20300 */
DECL|variable|proc_scsi_megaraid
r_static
r_struct
id|proc_dir_entry
id|proc_scsi_megaraid
op_assign
(brace
id|PROC_SCSI_MEGARAID
comma
l_int|8
comma
l_string|&quot;megaraid&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PROC_FS
r_extern
r_struct
id|proc_dir_entry
id|proc_root
suffix:semicolon
macro_line|#endif
DECL|variable|mega_ch_class
r_static
r_char
id|mega_ch_class
suffix:semicolon
multiline_comment|/* channels are raid or scsi */
DECL|macro|IS_RAID_CH
mdefine_line|#define&t;IS_RAID_CH(ch)&t;( (mega_ch_class &gt;&gt; (ch)) &amp; 0x01 )
macro_line|#if SERDEBUG
DECL|variable|strbuf
r_static
r_char
id|strbuf
(braket
id|MAX_SERBUF
op_plus
l_int|1
)braket
suffix:semicolon
DECL|function|ser_init
r_static
r_void
id|ser_init
(paren
r_void
)paren
(brace
r_int
id|port
op_assign
id|COM_BASE
suffix:semicolon
id|outb
(paren
l_int|0x80
comma
id|port
op_plus
l_int|3
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 9600 Baud, if 19200: outb(6,port) */
id|outb
(paren
l_int|12
comma
id|port
)paren
suffix:semicolon
id|outb
(paren
l_int|3
comma
id|port
op_plus
l_int|3
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ser_puts
r_static
r_void
id|ser_puts
(paren
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|ptr
suffix:semicolon
id|ser_init
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
id|str
suffix:semicolon
op_star
id|ptr
suffix:semicolon
op_increment
id|ptr
)paren
id|ser_putc
(paren
op_star
id|ptr
)paren
suffix:semicolon
)brace
DECL|function|ser_putc
r_static
r_void
id|ser_putc
(paren
r_char
id|c
)paren
(brace
r_int
id|port
op_assign
id|COM_BASE
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
(paren
id|port
op_plus
l_int|5
)paren
op_amp
l_int|0x20
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|outb
(paren
id|c
comma
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_int|0x0a
)paren
(brace
r_while
c_loop
(paren
(paren
id|inb
(paren
id|port
op_plus
l_int|5
)paren
op_amp
l_int|0x20
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|outb
(paren
l_int|0x0d
comma
id|port
)paren
suffix:semicolon
)brace
)brace
DECL|function|ser_printk
r_static
r_int
id|ser_printk
(paren
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|serial_lock
comma
id|flags
)paren
suffix:semicolon
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|i
op_assign
id|vsprintf
(paren
id|strbuf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|ser_puts
(paren
id|strbuf
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|serial_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|macro|TRACE
mdefine_line|#define TRACE(a)    { ser_printk a;}
macro_line|#else
DECL|macro|TRACE
mdefine_line|#define TRACE(A)
macro_line|#endif
DECL|macro|TRACE1
mdefine_line|#define TRACE1(a)
DECL|function|callDone
r_static
r_void
id|callDone
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_if
c_cond
(paren
id|SCpnt-&gt;result
)paren
(brace
id|TRACE
(paren
(paren
l_string|&quot;*** %.08lx %.02x &lt;%d.%d.%d&gt; = %x&bslash;n&quot;
comma
id|SCpnt-&gt;serial_number
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;device-&gt;channel
comma
id|SCpnt-&gt;device-&gt;id
comma
id|SCpnt-&gt;device-&gt;lun
comma
id|SCpnt-&gt;result
)paren
)paren
suffix:semicolon
)brace
id|SCpnt-&gt;scsi_done
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------&n; *&n; *                      Local functions&n; *&n; *-------------------------------------------------------------------------*/
multiline_comment|/*=======================&n; * Free a SCB structure&n; *=======================&n; */
DECL|function|mega_freeSCB
r_static
r_void
id|mega_freeSCB
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|pScb
)paren
(brace
id|mega_scb
op_star
id|pScbtmp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pScb
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|pScb-&gt;idx
op_ge
l_int|0xFE
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
r_switch
c_cond
(paren
id|pScb-&gt;dma_type
)paren
(brace
r_case
id|M_RD_DMA_TYPE_NONE
suffix:colon
r_break
suffix:semicolon
r_case
id|M_RD_PTHRU_WITH_BULK_DATA
suffix:colon
id|pci_unmap_single
(paren
id|megaCfg-&gt;dev
comma
id|pScb-&gt;dma_h_bulkdata
comma
id|pScb-&gt;pthru-&gt;dataxferlen
comma
id|pScb-&gt;dma_direction
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|M_RD_EPTHRU_WITH_BULK_DATA
suffix:colon
id|pci_unmap_single
(paren
id|megaCfg-&gt;dev
comma
id|pScb-&gt;dma_h_bulkdata
comma
id|pScb-&gt;epthru-&gt;dataxferlen
comma
id|pScb-&gt;dma_direction
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|M_RD_PTHRU_WITH_SGLIST
suffix:colon
(brace
r_int
id|count
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|pScb-&gt;sglist_count
suffix:semicolon
id|count
op_increment
)paren
(brace
id|pci_unmap_single
(paren
id|megaCfg-&gt;dev
comma
id|pScb-&gt;dma_h_sglist
(braket
id|count
)braket
comma
id|pScb-&gt;sgList
(braket
id|count
)braket
dot
id|length
comma
id|pScb-&gt;dma_direction
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|M_RD_BULK_DATA_ONLY
suffix:colon
id|pci_unmap_single
(paren
id|megaCfg-&gt;dev
comma
id|pScb-&gt;dma_h_bulkdata
comma
id|pScb-&gt;iDataSize
comma
id|pScb-&gt;dma_direction
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|M_RD_SGLIST_ONLY
suffix:colon
id|pci_unmap_sg
(paren
id|megaCfg-&gt;dev
comma
id|pScb-&gt;SCpnt-&gt;request_buffer
comma
id|pScb-&gt;SCpnt-&gt;use_sg
comma
id|pScb-&gt;dma_direction
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Unlink from pending queue */
r_if
c_cond
(paren
id|pScb
op_eq
id|megaCfg-&gt;qPendingH
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;qPendingH
op_eq
id|megaCfg-&gt;qPendingT
)paren
id|megaCfg-&gt;qPendingH
op_assign
id|megaCfg-&gt;qPendingT
op_assign
l_int|NULL
suffix:semicolon
r_else
id|megaCfg-&gt;qPendingH
op_assign
id|megaCfg-&gt;qPendingH-&gt;next
suffix:semicolon
id|megaCfg-&gt;qPcnt
op_decrement
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|pScbtmp
op_assign
id|megaCfg-&gt;qPendingH
suffix:semicolon
id|pScbtmp
suffix:semicolon
id|pScbtmp
op_assign
id|pScbtmp-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pScbtmp-&gt;next
op_eq
id|pScb
)paren
(brace
id|pScbtmp-&gt;next
op_assign
id|pScb-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|pScb
op_eq
id|megaCfg-&gt;qPendingT
)paren
(brace
id|megaCfg-&gt;qPendingT
op_assign
id|pScbtmp
suffix:semicolon
)brace
id|megaCfg-&gt;qPcnt
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Link back into free list */
id|pScb-&gt;state
op_assign
id|SCB_FREE
suffix:semicolon
id|pScb-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;qFreeH
op_eq
(paren
id|mega_scb
op_star
)paren
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qFreeH
op_assign
id|megaCfg-&gt;qFreeT
op_assign
id|pScb
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qFreeT-&gt;next
op_assign
id|pScb
suffix:semicolon
id|megaCfg-&gt;qFreeT
op_assign
id|pScb
suffix:semicolon
)brace
id|megaCfg-&gt;qFreeT-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qFcnt
op_increment
suffix:semicolon
)brace
multiline_comment|/*===========================&n; * Allocate a SCB structure&n; *===========================&n; */
DECL|function|mega_allocateSCB
r_static
id|mega_scb
op_star
id|mega_allocateSCB
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
multiline_comment|/* Unlink command from Free List */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|megaCfg-&gt;qFreeH
)paren
op_ne
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qFreeH
op_assign
id|pScb-&gt;next
suffix:semicolon
id|megaCfg-&gt;qFcnt
op_decrement
suffix:semicolon
id|pScb-&gt;isrcount
op_assign
id|jiffies
suffix:semicolon
id|pScb-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|pScb-&gt;state
op_assign
id|SCB_ACTIVE
suffix:semicolon
id|pScb-&gt;SCpnt
op_assign
id|SCpnt
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|pScb-&gt;dma_type
op_assign
id|M_RD_DMA_TYPE_NONE
suffix:semicolon
macro_line|#endif
r_return
id|pScb
suffix:semicolon
)brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;Megaraid: Could not allocate free SCB!!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Run through the list of completed requests  and finish it */
DECL|function|mega_rundoneq
r_static
r_void
id|mega_rundoneq
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
r_while
c_loop
(paren
(paren
id|SCpnt
op_assign
id|megaCfg-&gt;qCompletedH
)paren
op_ne
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|SCpnt-&gt;host_scribble
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_decrement
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
multiline_comment|/* XC : sep 14 */
multiline_comment|/* Callback */
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Runs through the list of pending requests&n; * Assumes that mega_lock spin_lock has been acquired.&n; */
DECL|function|mega_runpendq
r_static
r_int
id|mega_runpendq
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* Issue any pending commands to the card */
r_for
c_loop
(paren
id|pScb
op_assign
id|megaCfg-&gt;qPendingH
suffix:semicolon
id|pScb
suffix:semicolon
id|pScb
op_assign
id|pScb-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pScb-&gt;state
op_eq
id|SCB_ACTIVE
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|megaIssueCmd
(paren
id|megaCfg
comma
id|pScb-&gt;mboxData
comma
id|pScb
comma
l_int|1
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
id|rc
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Add command to the list of completed requests */
DECL|function|mega_cmd_done
r_static
r_void
id|mega_cmd_done
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|pScb
comma
r_int
id|status
)paren
(brace
r_int
id|islogical
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|mega_passthru
op_star
id|pthru
suffix:semicolon
id|mega_ext_passthru
op_star
id|epthru
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sgList
suffix:semicolon
id|u8
id|c
suffix:semicolon
r_if
c_cond
(paren
id|pScb
op_eq
l_int|NULL
)paren
(brace
id|TRACE
(paren
(paren
l_string|&quot;NULL pScb in mega_cmd_done!&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;NULL pScb in mega_cmd_done!&quot;
)paren
suffix:semicolon
)brace
id|SCpnt
op_assign
id|pScb-&gt;SCpnt
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|pthru
op_assign
id|pScb-&gt;pthru
suffix:semicolon
id|epthru
op_assign
id|pScb-&gt;epthru
suffix:semicolon
macro_line|#else
id|pthru
op_assign
op_amp
id|pScb-&gt;pthru
suffix:semicolon
id|epthru
op_assign
op_amp
id|pScb-&gt;epthru
suffix:semicolon
macro_line|#endif
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_eq
l_int|NULL
)paren
(brace
id|TRACE
(paren
(paren
l_string|&quot;NULL SCpnt in mega_cmd_done!&quot;
)paren
)paren
suffix:semicolon
id|TRACE
(paren
(paren
l_string|&quot;pScb-&gt;idx = &quot;
comma
id|pScb-&gt;idx
)paren
)paren
suffix:semicolon
id|TRACE
(paren
(paren
l_string|&quot;pScb-&gt;state = &quot;
comma
id|pScb-&gt;state
)paren
)paren
suffix:semicolon
id|TRACE
(paren
(paren
l_string|&quot;pScb-&gt;state = &quot;
comma
id|pScb-&gt;state
)paren
)paren
suffix:semicolon
id|panic
c_func
(paren
id|KERN_ERR
l_string|&quot;megaraid:Problem...!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|islogical
op_assign
(paren
(paren
id|SCpnt-&gt;device-&gt;channel
op_ge
id|megaCfg-&gt;productInfo.SCSIChanPresent
)paren
op_logical_and
(paren
id|SCpnt-&gt;device-&gt;channel
op_le
id|megaCfg-&gt;host-&gt;max_channel
)paren
)paren
suffix:semicolon
macro_line|#if 0
id|islogical
op_assign
(paren
id|SCpnt-&gt;device-&gt;channel
op_eq
id|megaCfg-&gt;host-&gt;max_channel
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
multiline_comment|/* Special Case to handle PassThrough-&gt;XferAddrress &gt; 4GB */
r_switch
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|INQUIRY
suffix:colon
r_case
id|READ_CAPACITY
suffix:colon
id|memcpy
(paren
id|SCpnt-&gt;request_buffer
comma
id|pScb-&gt;bounce_buffer
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
id|mega_freeSCB
(paren
id|megaCfg
comma
id|pScb
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Do not return the presence of hard disk on the channel so, inquiry&n;&t; * sent, and returned data==hard disk or removable hard disk and not&n;&t; * logical, request should return failure! - PJ&n;&t; */
macro_line|#if 0
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
(paren
(paren
(paren
(paren
id|u_char
op_star
)paren
id|SCpnt-&gt;request_buffer
)paren
(braket
l_int|0
)braket
op_amp
l_int|0x1F
)paren
op_eq
id|TYPE_DISK
)paren
op_logical_and
op_logical_neg
id|islogical
)paren
(brace
id|status
op_assign
l_int|0xF0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
op_logical_neg
id|islogical
)paren
(brace
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|sgList
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|c
comma
id|cpu_to_le32
c_func
(paren
id|sg_dma_address
c_func
(paren
op_amp
id|sgList
(braket
l_int|0
)braket
)paren
)paren
comma
l_int|0x1
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
op_amp
id|c
comma
id|SCpnt-&gt;request_buffer
comma
l_int|0x1
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
(paren
id|c
op_amp
l_int|0x1F
)paren
op_eq
id|TYPE_DISK
)paren
(brace
id|status
op_assign
l_int|0xF0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|IS_RAID_CH
c_func
(paren
id|SCpnt-&gt;device-&gt;channel
)paren
op_logical_and
(paren
(paren
id|c
op_amp
l_int|0x1F
)paren
op_eq
id|TYPE_DISK
)paren
)paren
(brace
id|status
op_assign
l_int|0xF0
suffix:semicolon
)brace
)brace
multiline_comment|/* clear result; otherwise, success returns corrupt value */
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_amp
id|M_RD_IOCTL_CMD
)paren
)paren
(brace
multiline_comment|/* i.e. ioctl cmd such as M_RD_IOCTL_CMD, M_RD_IOCTL_CMD_NEW of megamgr */
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
l_int|2
suffix:colon
r_case
l_int|0xF0
suffix:colon
r_case
l_int|0xF4
suffix:colon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
op_or
id|status
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SCpnt-&gt;result
op_or_assign
id|status
suffix:semicolon
)brace
multiline_comment|/*end of switch */
)brace
r_else
(brace
multiline_comment|/* Convert MegaRAID status to Linux error code */
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* SUCCESS , i.e. SCSI_STATUS_GOOD */
id|SCpnt-&gt;result
op_or_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* ERROR_ABORTED, i.e. SCSI_STATUS_CHECK_CONDITION */
multiline_comment|/*set sense_buffer and result fields */
r_if
c_cond
(paren
id|mbox-&gt;cmd
op_eq
id|MEGA_MBOXCMD_PASSTHRU
)paren
(brace
id|memcpy
(paren
id|SCpnt-&gt;sense_buffer
comma
id|pthru-&gt;reqsensearea
comma
l_int|14
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mbox-&gt;cmd
op_eq
id|MEGA_MBOXCMD_EXTPASSTHRU
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DRIVER_SENSE
op_lshift
l_int|24
)paren
op_or
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
(paren
id|CHECK_CONDITION
OL
l_int|1
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|SCpnt-&gt;sense_buffer
comma
id|epthru-&gt;reqsensearea
comma
l_int|14
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DRIVER_SENSE
op_lshift
l_int|24
)paren
op_or
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
(paren
id|CHECK_CONDITION
OL
l_int|1
)paren
suffix:semicolon
multiline_comment|/*SCpnt-&gt;result =&n;&t;&t;&t;&t;&t;(DRIVER_SENSE &lt;&lt; 24) |&n;&t;&t;&t;&t;&t;(DID_ERROR &lt;&lt; 16) | status;*/
)brace
r_else
(brace
id|SCpnt-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_assign
id|ABORTED_COMMAND
suffix:semicolon
id|SCpnt-&gt;result
op_or_assign
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
multiline_comment|/* ERR_DEST_DRIVE_FAILED, i.e. SCSI_STATUS_BUSY */
id|SCpnt-&gt;result
op_or_assign
(paren
id|DID_BUS_BUSY
op_lshift
l_int|16
)paren
op_or
id|status
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SCpnt-&gt;result
op_or_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
op_or
id|status
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Add Scsi_Command to end of completed queue */
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_increment
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------&n; *&n; *                 Build a SCB from a Scsi_Cmnd&n; *&n; * Returns a SCB pointer, or NULL&n; * If NULL is returned, the scsi_done function MUST have been called&n; *&n; *-------------------------------------------------------------------*/
DECL|function|mega_build_cmd
r_static
id|mega_scb
op_star
id|mega_build_cmd
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|mega_passthru
op_star
id|pthru
suffix:semicolon
id|mega_ext_passthru
op_star
id|epthru
suffix:semicolon
r_int
id|seg
suffix:semicolon
r_char
id|islogical
suffix:semicolon
r_int
id|lun
op_assign
id|SCpnt-&gt;device-&gt;lun
suffix:semicolon
r_int
id|max_lun
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|MEGADEVIOC
)paren
)paren
r_return
id|megadev_doioctl
(paren
id|megaCfg
comma
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|M_RD_IOCTL_CMD
)paren
op_logical_or
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|M_RD_IOCTL_CMD_NEW
)paren
)paren
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0)  
r_return
id|mega_ioctl
(paren
id|megaCfg
comma
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* Handle IOCTL command */
macro_line|#else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;megaraid ioctl: older interface - &quot;
l_string|&quot;not supported.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
id|islogical
op_assign
(paren
(paren
id|SCpnt-&gt;device-&gt;channel
op_ge
id|megaCfg-&gt;productInfo.SCSIChanPresent
)paren
op_logical_and
(paren
id|SCpnt-&gt;device-&gt;channel
op_le
id|megaCfg-&gt;host-&gt;max_channel
)paren
)paren
suffix:semicolon
macro_line|#if 0
id|islogical
op_assign
(paren
id|IS_RAID_CH
c_func
(paren
id|SCpnt-&gt;device-&gt;channel
)paren
op_logical_and
multiline_comment|/* virtual ch is raid - AM */
(paren
id|SCpnt-&gt;device-&gt;channel
op_eq
id|megaCfg-&gt;host-&gt;max_channel
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|megaCfg-&gt;support_ext_cdb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|islogical
op_logical_and
id|lun
op_ne
l_int|0
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|islogical
op_logical_and
id|SCpnt-&gt;device-&gt;id
op_eq
id|skip_id
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|islogical
)paren
(brace
multiline_comment|/* have just LUN 0 for each target on virtual channels */
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;lun
op_ne
l_int|0
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|lun
op_assign
id|mega_get_lun
c_func
(paren
id|megaCfg
comma
id|SCpnt
)paren
suffix:semicolon
id|max_lun
op_assign
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_40LD
)paren
ques
c_cond
id|FC_MAX_LOGICAL_DRIVES
suffix:colon
id|MAX_LOGICAL_DRIVES
suffix:semicolon
multiline_comment|/*&n;&t;&t;  * max_lun increases by 0x80 if some logical drive was deleted.&n;&t;&t;  */
r_if
c_cond
(paren
id|megaCfg-&gt;read_ldidmap
)paren
(brace
id|max_lun
op_add_assign
l_int|0x80
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lun
OG
id|max_lun
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * If we have a logical drive with boot enabled, project it first&n;&t;&t; */
r_if
c_cond
(paren
id|megaCfg-&gt;boot_ldrv_enabled
)paren
(brace
r_if
c_cond
(paren
id|lun
op_eq
l_int|0
)paren
(brace
id|lun
op_assign
id|megaCfg-&gt;boot_ldrv
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|lun
op_le
id|megaCfg-&gt;boot_ldrv
)paren
(brace
id|lun
op_decrement
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|lun
OG
l_int|7
)paren
(brace
multiline_comment|/* Do not support lun &gt;7 for physically accessed devices */
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*-----------------------------------------------------&n;&t; *&n;&t; *               Logical drive commands&n;&t; *&n;&t; *-----------------------------------------------------*/
r_if
c_cond
(paren
id|islogical
)paren
(brace
r_switch
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|TEST_UNIT_READY
suffix:colon
id|memset
(paren
id|SCpnt-&gt;request_buffer
comma
l_int|0
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
id|memset
(paren
id|SCpnt-&gt;request_buffer
comma
l_int|0
comma
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
r_case
id|INQUIRY
suffix:colon
multiline_comment|/* Allocate a SCB and initialize passthru */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|mega_allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|pthru
op_assign
id|pScb-&gt;pthru
suffix:semicolon
macro_line|#else
id|pthru
op_assign
op_amp
id|pScb-&gt;pthru
suffix:semicolon
macro_line|#endif
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
id|memset
(paren
id|pthru
comma
l_int|0
comma
r_sizeof
(paren
id|mega_passthru
)paren
)paren
suffix:semicolon
id|pthru-&gt;timeout
op_assign
l_int|0
suffix:semicolon
id|pthru-&gt;ars
op_assign
l_int|1
suffix:semicolon
id|pthru-&gt;reqsenselen
op_assign
l_int|14
suffix:semicolon
id|pthru-&gt;islogical
op_assign
l_int|1
suffix:semicolon
id|pthru-&gt;logdrv
op_assign
id|lun
suffix:semicolon
id|pthru-&gt;cdblen
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
multiline_comment|/*Not sure about the direction */
id|pScb-&gt;dma_direction
op_assign
id|PCI_DMA_BIDIRECTIONAL
suffix:semicolon
id|pScb-&gt;dma_type
op_assign
id|M_RD_PTHRU_WITH_BULK_DATA
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Normal Code w/o the need for bounce buffer */
id|pScb-&gt;dma_h_bulkdata
op_assign
id|pci_map_single
(paren
id|megaCfg-&gt;dev
comma
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;request_bufflen
comma
id|pScb-&gt;dma_direction
)paren
suffix:semicolon
id|pthru-&gt;dataxferaddr
op_assign
id|pScb-&gt;dma_h_bulkdata
suffix:semicolon
macro_line|#else
multiline_comment|/* Special Code to use bounce buffer for READ_CAPA/INQ */
id|pthru-&gt;dataxferaddr
op_assign
id|pScb-&gt;dma_bounce_buffer
suffix:semicolon
id|pScb-&gt;dma_type
op_assign
id|M_RD_DMA_TYPE_NONE
suffix:semicolon
macro_line|#endif
macro_line|#else
id|pthru-&gt;dataxferaddr
op_assign
id|virt_to_bus
(paren
id|SCpnt-&gt;request_buffer
)paren
suffix:semicolon
macro_line|#endif
id|pthru-&gt;dataxferlen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
id|memcpy
(paren
id|pthru-&gt;cdb
comma
id|SCpnt-&gt;cmnd
comma
id|SCpnt-&gt;cmd_len
)paren
suffix:semicolon
multiline_comment|/* Initialize mailbox area */
id|mbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_PASSTHRU
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|mbox-&gt;xferaddr
op_assign
id|pScb-&gt;dma_passthruhandle64
suffix:semicolon
id|TRACE1
(paren
(paren
l_string|&quot;M_RD_PTHRU_WITH_BULK_DATA Enabled &bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#else
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
id|pthru
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pScb
suffix:semicolon
r_case
id|READ_6
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|WRITE_10
suffix:colon
multiline_comment|/* Allocate a SCB and initialize mailbox */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|mega_allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
id|mbox-&gt;logdrv
op_assign
id|lun
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_64BIT
)paren
(brace
id|mbox-&gt;cmd
op_assign
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_6
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_10
)paren
ques
c_cond
id|MEGA_MBOXCMD_LREAD64
suffix:colon
id|MEGA_MBOXCMD_LWRITE64
suffix:semicolon
)brace
r_else
(brace
id|mbox-&gt;cmd
op_assign
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_6
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_10
)paren
ques
c_cond
id|MEGA_MBOXCMD_LREAD
suffix:colon
id|MEGA_MBOXCMD_LWRITE
suffix:semicolon
)brace
multiline_comment|/* 6-byte */
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_6
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|WRITE_6
)paren
(brace
id|mbox-&gt;numsectors
op_assign
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
id|mbox-&gt;lba
op_assign
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|3
)braket
suffix:semicolon
id|mbox-&gt;lba
op_and_assign
l_int|0x1FFFFF
suffix:semicolon
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_6
)paren
(brace
id|megaCfg-&gt;nReads
(braket
(paren
r_int
)paren
id|lun
)braket
op_increment
suffix:semicolon
id|megaCfg-&gt;nReadBlocks
(braket
(paren
r_int
)paren
id|lun
)braket
op_add_assign
id|mbox-&gt;numsectors
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;nWrites
(braket
(paren
r_int
)paren
id|lun
)braket
op_increment
suffix:semicolon
id|megaCfg-&gt;nWriteBlocks
(braket
(paren
r_int
)paren
id|lun
)braket
op_add_assign
id|mbox-&gt;numsectors
suffix:semicolon
)brace
)brace
multiline_comment|/* 10-byte */
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_10
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|WRITE_10
)paren
(brace
id|mbox-&gt;numsectors
op_assign
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|8
)braket
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|mbox-&gt;lba
op_assign
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|5
)braket
suffix:semicolon
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_10
)paren
(brace
id|megaCfg-&gt;nReads
(braket
(paren
r_int
)paren
id|lun
)braket
op_increment
suffix:semicolon
id|megaCfg-&gt;nReadBlocks
(braket
(paren
r_int
)paren
id|lun
)braket
op_add_assign
id|mbox-&gt;numsectors
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;nWrites
(braket
(paren
r_int
)paren
id|lun
)braket
op_increment
suffix:semicolon
id|megaCfg-&gt;nWriteBlocks
(braket
(paren
r_int
)paren
id|lun
)braket
op_add_assign
id|mbox-&gt;numsectors
suffix:semicolon
)brace
)brace
multiline_comment|/* 12-byte */
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_12
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|WRITE_12
)paren
(brace
id|mbox-&gt;lba
op_assign
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|5
)braket
suffix:semicolon
id|mbox-&gt;numsectors
op_assign
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|6
)braket
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|7
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|8
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|u32
)paren
id|SCpnt-&gt;cmnd
(braket
l_int|9
)braket
suffix:semicolon
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_12
)paren
(brace
id|megaCfg-&gt;nReads
(braket
(paren
r_int
)paren
id|lun
)braket
op_increment
suffix:semicolon
id|megaCfg-&gt;nReadBlocks
(braket
(paren
r_int
)paren
id|lun
)braket
op_add_assign
id|mbox-&gt;numsectors
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;nWrites
(braket
(paren
r_int
)paren
id|lun
)braket
op_increment
suffix:semicolon
id|megaCfg-&gt;nWriteBlocks
(braket
(paren
r_int
)paren
id|lun
)braket
op_add_assign
id|mbox-&gt;numsectors
suffix:semicolon
)brace
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
r_if
c_cond
(paren
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_6
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_10
op_logical_or
op_star
id|SCpnt-&gt;cmnd
op_eq
id|READ_12
)paren
(brace
id|pScb-&gt;dma_direction
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*WRITE_6 or WRITE_10 */
id|pScb-&gt;dma_direction
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Calculate Scatter-Gather info */
id|mbox-&gt;numsgelements
op_assign
id|mega_build_sglist
(paren
id|megaCfg
comma
id|pScb
comma
(paren
id|u32
op_star
)paren
op_amp
id|mbox-&gt;xferaddr
comma
(paren
id|u32
op_star
)paren
op_amp
id|seg
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|pScb-&gt;iDataSize
op_assign
id|seg
suffix:semicolon
r_if
c_cond
(paren
id|mbox-&gt;numsgelements
)paren
(brace
id|pScb-&gt;dma_type
op_assign
id|M_RD_SGLIST_ONLY
suffix:semicolon
id|TRACE1
(paren
(paren
l_string|&quot;M_RD_SGLIST_ONLY Enabled &bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|pScb-&gt;dma_type
op_assign
id|M_RD_BULK_DATA_ONLY
suffix:semicolon
id|TRACE1
(paren
(paren
l_string|&quot;M_RD_BULK_DATA_ONLY Enabled &bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|pScb
suffix:semicolon
r_default
suffix:colon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_BAD_TARGET
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*-----------------------------------------------------&n;&t; *&n;&t; *               Passthru drive commands&n;&t; *&n;&t; *-----------------------------------------------------*/
r_else
(brace
multiline_comment|/* Allocate a SCB and initialize passthru */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|mega_allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;support_ext_cdb
op_logical_and
id|SCpnt-&gt;cmd_len
OG
l_int|10
)paren
(brace
id|epthru
op_assign
id|mega_prepare_extpassthru
c_func
(paren
id|megaCfg
comma
id|pScb
comma
id|SCpnt
)paren
suffix:semicolon
id|mbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_EXTPASSTHRU
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|mbox-&gt;xferaddr
op_assign
id|pScb-&gt;dma_ext_passthruhandle64
suffix:semicolon
r_if
c_cond
(paren
id|epthru-&gt;numsgelements
)paren
(brace
id|pScb-&gt;dma_type
op_assign
id|M_RD_PTHRU_WITH_SGLIST
suffix:semicolon
)brace
r_else
(brace
id|pScb-&gt;dma_type
op_assign
id|M_RD_EPTHRU_WITH_BULK_DATA
suffix:semicolon
)brace
macro_line|#else
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
c_func
(paren
id|epthru
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|pthru
op_assign
id|mega_prepare_passthru
c_func
(paren
id|megaCfg
comma
id|pScb
comma
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* Initialize mailbox */
id|mbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_PASSTHRU
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|mbox-&gt;xferaddr
op_assign
id|pScb-&gt;dma_passthruhandle64
suffix:semicolon
r_if
c_cond
(paren
id|pthru-&gt;numsgelements
)paren
(brace
id|pScb-&gt;dma_type
op_assign
id|M_RD_PTHRU_WITH_SGLIST
suffix:semicolon
)brace
r_else
(brace
id|pScb-&gt;dma_type
op_assign
id|M_RD_PTHRU_WITH_BULK_DATA
suffix:semicolon
)brace
macro_line|#else
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
c_func
(paren
id|pthru
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
id|pScb
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
DECL|function|mega_get_lun
id|mega_get_lun
c_func
(paren
id|mega_host_config
op_star
id|this_hba
comma
id|Scsi_Cmnd
op_star
id|sc
)paren
(brace
r_int
id|tgt
suffix:semicolon
r_int
id|lun
suffix:semicolon
r_int
id|virt_chan
suffix:semicolon
id|tgt
op_assign
id|sc-&gt;device-&gt;id
suffix:semicolon
r_if
c_cond
(paren
id|tgt
OG
l_int|7
)paren
id|tgt
op_decrement
suffix:semicolon
multiline_comment|/* we do not get inquires for tgt 7 */
id|virt_chan
op_assign
id|sc-&gt;device-&gt;channel
op_minus
id|this_hba-&gt;productInfo.SCSIChanPresent
suffix:semicolon
id|lun
op_assign
(paren
id|virt_chan
op_star
l_int|15
)paren
op_plus
id|tgt
suffix:semicolon
multiline_comment|/*&n;&t; * If &quot;delete logical drive&quot; feature is enabled on this controller.&n;&t; * Do only if at least one delete logical drive operation was done.&n;&t; *&n;&t; * Also, after logical drive deletion, instead of logical drive number,&n;&t; * the value returned should be 0x80+logical drive id.&n;&t; *&n;&t; * These is valid only for IO commands.&n;&t; */
r_if
c_cond
(paren
id|this_hba-&gt;support_random_del
op_logical_and
id|this_hba-&gt;read_ldidmap
)paren
(brace
r_switch
c_cond
(paren
id|sc-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|READ_6
suffix:colon
multiline_comment|/* fall through */
r_case
id|WRITE_6
suffix:colon
multiline_comment|/* fall through */
r_case
id|READ_10
suffix:colon
multiline_comment|/* fall through */
r_case
id|WRITE_10
suffix:colon
id|lun
op_add_assign
l_int|0x80
suffix:semicolon
)brace
)brace
r_return
id|lun
suffix:semicolon
)brace
r_static
id|mega_passthru
op_star
DECL|function|mega_prepare_passthru
id|mega_prepare_passthru
c_func
(paren
id|mega_host_config
op_star
id|megacfg
comma
id|mega_scb
op_star
id|scb
comma
id|Scsi_Cmnd
op_star
id|sc
)paren
(brace
id|mega_passthru
op_star
id|pthru
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|pthru
op_assign
id|scb-&gt;pthru
suffix:semicolon
macro_line|#else
id|pthru
op_assign
op_amp
id|scb-&gt;pthru
suffix:semicolon
macro_line|#endif
id|memset
(paren
id|pthru
comma
l_int|0
comma
r_sizeof
(paren
id|mega_passthru
)paren
)paren
suffix:semicolon
multiline_comment|/* set adapter timeout value to 10 min. for tape drive&t;*/
multiline_comment|/* 0=6sec/1=60sec/2=10min/3=3hrs &t;&t;&t;*/
id|pthru-&gt;timeout
op_assign
l_int|2
suffix:semicolon
id|pthru-&gt;ars
op_assign
l_int|1
suffix:semicolon
id|pthru-&gt;reqsenselen
op_assign
l_int|14
suffix:semicolon
id|pthru-&gt;islogical
op_assign
l_int|0
suffix:semicolon
id|pthru-&gt;channel
op_assign
(paren
id|megacfg-&gt;flag
op_amp
id|BOARD_40LD
)paren
ques
c_cond
l_int|0
suffix:colon
id|sc-&gt;device-&gt;channel
suffix:semicolon
id|pthru-&gt;target
op_assign
(paren
id|megacfg-&gt;flag
op_amp
id|BOARD_40LD
)paren
ques
c_cond
(paren
id|sc-&gt;device-&gt;channel
op_lshift
l_int|4
)paren
op_or
id|sc-&gt;device-&gt;id
suffix:colon
id|sc-&gt;device-&gt;id
suffix:semicolon
id|pthru-&gt;cdblen
op_assign
id|sc-&gt;cmd_len
suffix:semicolon
id|pthru-&gt;logdrv
op_assign
id|sc-&gt;device-&gt;lun
suffix:semicolon
id|memcpy
(paren
id|pthru-&gt;cdb
comma
id|sc-&gt;cmnd
comma
id|sc-&gt;cmd_len
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
multiline_comment|/* Not sure about the direction */
id|scb-&gt;dma_direction
op_assign
id|PCI_DMA_BIDIRECTIONAL
suffix:semicolon
multiline_comment|/* Special Code for Handling READ_CAPA/ INQ using bounce buffers */
r_switch
c_cond
(paren
id|sc-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|INQUIRY
suffix:colon
r_case
id|READ_CAPACITY
suffix:colon
id|pthru-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
id|pthru-&gt;dataxferaddr
op_assign
id|scb-&gt;dma_bounce_buffer
suffix:semicolon
id|pthru-&gt;dataxferlen
op_assign
id|sc-&gt;request_bufflen
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|pthru-&gt;numsgelements
op_assign
id|mega_build_sglist
c_func
(paren
id|megacfg
comma
id|scb
comma
(paren
id|u32
op_star
)paren
op_amp
id|pthru-&gt;dataxferaddr
comma
(paren
id|u32
op_star
)paren
op_amp
id|pthru-&gt;dataxferlen
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#else
id|pthru-&gt;numsgelements
op_assign
id|mega_build_sglist
c_func
(paren
id|megacfg
comma
id|scb
comma
(paren
id|u32
op_star
)paren
op_amp
id|pthru-&gt;dataxferaddr
comma
(paren
id|u32
op_star
)paren
op_amp
id|pthru-&gt;dataxferlen
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pthru
suffix:semicolon
)brace
r_static
id|mega_ext_passthru
op_star
DECL|function|mega_prepare_extpassthru
id|mega_prepare_extpassthru
c_func
(paren
id|mega_host_config
op_star
id|megacfg
comma
id|mega_scb
op_star
id|scb
comma
id|Scsi_Cmnd
op_star
id|sc
)paren
(brace
id|mega_ext_passthru
op_star
id|epthru
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|epthru
op_assign
id|scb-&gt;epthru
suffix:semicolon
macro_line|#else
id|epthru
op_assign
op_amp
id|scb-&gt;epthru
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
id|epthru
comma
l_int|0
comma
r_sizeof
(paren
id|mega_ext_passthru
)paren
)paren
suffix:semicolon
multiline_comment|/* set adapter timeout value to 10 min. for tape drive&t;*/
multiline_comment|/* 0=6sec/1=60sec/2=10min/3=3hrs &t;&t;&t;*/
id|epthru-&gt;timeout
op_assign
l_int|2
suffix:semicolon
id|epthru-&gt;ars
op_assign
l_int|1
suffix:semicolon
id|epthru-&gt;reqsenselen
op_assign
l_int|14
suffix:semicolon
id|epthru-&gt;islogical
op_assign
l_int|0
suffix:semicolon
id|epthru-&gt;channel
op_assign
(paren
id|megacfg-&gt;flag
op_amp
id|BOARD_40LD
)paren
ques
c_cond
l_int|0
suffix:colon
id|sc-&gt;device-&gt;channel
suffix:semicolon
id|epthru-&gt;target
op_assign
(paren
id|megacfg-&gt;flag
op_amp
id|BOARD_40LD
)paren
ques
c_cond
(paren
id|sc-&gt;device-&gt;channel
op_lshift
l_int|4
)paren
op_or
id|sc-&gt;device-&gt;id
suffix:colon
id|sc-&gt;device-&gt;id
suffix:semicolon
id|epthru-&gt;cdblen
op_assign
id|sc-&gt;cmd_len
suffix:semicolon
id|epthru-&gt;logdrv
op_assign
id|sc-&gt;device-&gt;lun
suffix:semicolon
id|memcpy
c_func
(paren
id|epthru-&gt;cdb
comma
id|sc-&gt;cmnd
comma
id|sc-&gt;cmd_len
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
multiline_comment|/* Not sure about the direction */
id|scb-&gt;dma_direction
op_assign
id|PCI_DMA_BIDIRECTIONAL
suffix:semicolon
multiline_comment|/* Special Code for Handling READ_CAPA/ INQ using bounce buffers */
r_switch
c_cond
(paren
id|sc-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|INQUIRY
suffix:colon
r_case
id|READ_CAPACITY
suffix:colon
id|epthru-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
id|epthru-&gt;dataxferaddr
op_assign
id|scb-&gt;dma_bounce_buffer
suffix:semicolon
id|epthru-&gt;dataxferlen
op_assign
id|sc-&gt;request_bufflen
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|epthru-&gt;numsgelements
op_assign
id|mega_build_sglist
c_func
(paren
id|megacfg
comma
id|scb
comma
(paren
id|u32
op_star
)paren
op_amp
id|epthru-&gt;dataxferaddr
comma
(paren
id|u32
op_star
)paren
op_amp
id|epthru-&gt;dataxferlen
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#else
id|epthru-&gt;numsgelements
op_assign
id|mega_build_sglist
c_func
(paren
id|megacfg
comma
id|scb
comma
(paren
id|u32
op_star
)paren
op_amp
id|epthru-&gt;dataxferaddr
comma
(paren
id|u32
op_star
)paren
op_amp
id|epthru-&gt;dataxferlen
)paren
suffix:semicolon
macro_line|#endif
r_return
id|epthru
suffix:semicolon
)brace
multiline_comment|/* Handle Driver Level IOCTLs&n; * Return value of 0 indicates this function could not handle , so continue&n; * processing&n;*/
DECL|function|mega_driver_ioctl
r_static
r_int
id|mega_driver_ioctl
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
r_char
op_star
id|data
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|mega_driver_info
id|driver_info
suffix:semicolon
multiline_comment|/* If this is not our command dont do anything */
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|M_RD_DRIVER_IOCTL_INTERFACE
)paren
r_return
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|1
)braket
)paren
(brace
r_case
id|GET_DRIVER_INFO
suffix:colon
r_if
c_cond
(paren
id|SCpnt-&gt;request_bufflen
OL
r_sizeof
(paren
id|driver_info
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|driver_info.size
op_assign
r_sizeof
(paren
id|driver_info
)paren
op_minus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|driver_info.version
op_assign
id|MEGARAID_IOCTL_VERSION
suffix:semicolon
id|memcpy
(paren
id|data
comma
op_amp
id|driver_info
comma
r_sizeof
(paren
id|driver_info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SCpnt-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
)brace
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|set_mbox_xfer_addr
r_static
r_inline
r_void
id|set_mbox_xfer_addr
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|pScb
comma
id|mega_ioctl_mbox
op_star
id|mbox
comma
id|u32
id|direction
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
r_switch
c_cond
(paren
id|direction
)paren
(brace
r_case
id|TO_DEVICE
suffix:colon
id|pScb-&gt;dma_direction
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FROM_DEVICE
suffix:colon
id|pScb-&gt;dma_direction
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FROMTO_DEVICE
suffix:colon
id|pScb-&gt;dma_direction
op_assign
id|PCI_DMA_BIDIRECTIONAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pScb-&gt;dma_h_bulkdata
op_assign
id|pci_map_single
(paren
id|megaCfg-&gt;dev
comma
id|pScb-&gt;buff_ptr
comma
id|pScb-&gt;iDataSize
comma
id|pScb-&gt;dma_direction
)paren
suffix:semicolon
id|mbox-&gt;xferaddr
op_assign
id|pScb-&gt;dma_h_bulkdata
suffix:semicolon
id|pScb-&gt;dma_type
op_assign
id|M_RD_BULK_DATA_ONLY
suffix:semicolon
id|TRACE1
(paren
(paren
l_string|&quot;M_RD_BULK_DATA_ONLY Enabled &bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#else
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
id|pScb-&gt;buff_ptr
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0)
multiline_comment|/*--------------------------------------------------------------------&n; * build RAID commands for controller, passed down through ioctl()&n; *--------------------------------------------------------------------*/
DECL|function|mega_ioctl
r_static
id|mega_scb
op_star
id|mega_ioctl
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|mega_ioctl_mbox
op_star
id|mbox
suffix:semicolon
id|mega_mailbox
op_star
id|mailbox
suffix:semicolon
id|mega_passthru
op_star
id|pthru
suffix:semicolon
id|u8
op_star
id|mboxdata
suffix:semicolon
r_int
id|seg
comma
id|i
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|mega_allocateSCB
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|pthru
op_assign
op_amp
id|pScb-&gt;pthru
suffix:semicolon
id|mboxdata
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_ioctl_mbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|mailbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
op_amp
id|pScb-&gt;mboxData
suffix:semicolon
id|memset
(paren
id|mailbox
comma
l_int|0
comma
r_sizeof
(paren
id|pScb-&gt;mboxData
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
l_int|0x03
)paren
(brace
multiline_comment|/* passthrough command */
r_int
r_char
id|cdblen
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|memset
(paren
id|pthru
comma
l_int|0
comma
r_sizeof
(paren
id|mega_passthru
)paren
)paren
suffix:semicolon
id|pthru-&gt;islogical
op_assign
(paren
id|data
(braket
id|cdblen
op_plus
l_int|3
)braket
op_amp
l_int|0x80
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|pthru-&gt;timeout
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|3
)braket
op_amp
l_int|0x07
suffix:semicolon
id|pthru-&gt;reqsenselen
op_assign
l_int|14
suffix:semicolon
id|pthru-&gt;ars
op_assign
(paren
id|data
(braket
id|cdblen
op_plus
l_int|3
)braket
op_amp
l_int|0x08
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|pthru-&gt;logdrv
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|4
)braket
suffix:semicolon
id|pthru-&gt;channel
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|5
)braket
suffix:semicolon
id|pthru-&gt;target
op_assign
id|data
(braket
id|cdblen
op_plus
l_int|6
)braket
suffix:semicolon
id|pthru-&gt;cdblen
op_assign
id|cdblen
suffix:semicolon
id|memcpy
(paren
id|pthru-&gt;cdb
comma
op_amp
id|data
(braket
l_int|3
)braket
comma
id|cdblen
)paren
suffix:semicolon
id|mailbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_PASSTHRU
suffix:semicolon
id|pthru-&gt;numsgelements
op_assign
id|mega_build_sglist
(paren
id|megaCfg
comma
id|pScb
comma
(paren
id|u32
op_star
)paren
op_amp
id|pthru
op_member_access_from_pointer
id|dataxferaddr
comma
(paren
id|u32
op_star
)paren
op_amp
id|pthru
op_member_access_from_pointer
id|dataxferlen
)paren
suffix:semicolon
id|mailbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
id|pthru
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SCpnt-&gt;request_bufflen
op_minus
id|cdblen
op_minus
l_int|7
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
(braket
id|i
)braket
op_assign
id|data
(braket
id|i
op_plus
id|cdblen
op_plus
l_int|7
)braket
suffix:semicolon
)brace
r_return
id|pScb
suffix:semicolon
)brace
multiline_comment|/* else normal (nonpassthru) command */
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,0,24)&t;/*0x020024 */
multiline_comment|/*&n;&t; *usage of the function copy from user is used in case of data more than&n;&t; *4KB.This is used only with adapters which supports more than 8 logical&n;&t; * drives.This feature is disabled on kernels earlier or same as 2.0.36&n;&t; * as the uaccess.h file is not available with those kernels.&n;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|M_RD_IOCTL_CMD_NEW
)paren
(brace
multiline_comment|/* use external data area for large xfers  */
multiline_comment|/* If cmnd[0] is set to M_RD_IOCTL_CMD_NEW then *&n;&t;&t; *   cmnd[4..7] = external user buffer     *&n;&t;&t; *   cmnd[8..11] = length of buffer        *&n;&t;&t; *                                         */
r_char
op_star
id|user_area
op_assign
(paren
r_char
op_star
)paren
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|SCpnt-&gt;cmnd
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|u32
id|xfer_size
op_assign
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|SCpnt-&gt;cmnd
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|data
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FW_FIRE_WRITE
suffix:colon
r_case
id|FW_FIRE_FLASH
suffix:colon
r_if
c_cond
(paren
(paren
id|ulong
)paren
id|user_area
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;megaraid:user address not aligned on 4K boundary.Error.&bslash;n&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pScb-&gt;buff_ptr
op_assign
id|kmalloc
(paren
id|xfer_size
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;megaraid: Insufficient mem for M_RD_IOCTL_CMD_NEW.&bslash;n&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|copy_from_user
(paren
id|pScb-&gt;buff_ptr
comma
id|user_area
comma
id|xfer_size
)paren
suffix:semicolon
id|pScb-&gt;iDataSize
op_assign
id|xfer_size
suffix:semicolon
r_switch
c_cond
(paren
id|data
(braket
l_int|0
)braket
)paren
(brace
r_case
id|DCMD_FC_CMD
suffix:colon
r_switch
c_cond
(paren
id|data
(braket
l_int|1
)braket
)paren
(brace
r_case
id|DCMD_FC_READ_NVRAM_CONFIG
suffix:colon
r_case
id|DCMD_GET_DISK_CONFIG
suffix:colon
(brace
r_if
c_cond
(paren
(paren
id|ulong
)paren
id|pScb
op_member_access_from_pointer
id|buff_ptr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;megaraid:user address not sufficient Error.&bslash;n&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*building SG list */
id|mega_build_kernel_sg
(paren
id|pScb-&gt;buff_ptr
comma
id|xfer_size
comma
id|pScb
comma
id|mbox
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/*switch (data[1]) */
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
id|mbox-&gt;cmd
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|mbox-&gt;channel
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|mbox-&gt;param
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|mbox-&gt;pad
(braket
l_int|0
)braket
op_assign
id|data
(braket
l_int|3
)braket
suffix:semicolon
id|mbox-&gt;logdrv
op_assign
id|data
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|M_RD_IOCTL_CMD_NEW
)paren
(brace
r_switch
c_cond
(paren
id|data
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FW_FIRE_WRITE
suffix:colon
id|mbox-&gt;cmd
op_assign
id|FW_FIRE_WRITE
suffix:semicolon
id|mbox-&gt;channel
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Current Block Number */
id|set_mbox_xfer_addr
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox
comma
id|TO_DEVICE
)paren
suffix:semicolon
id|mbox-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FW_FIRE_FLASH
suffix:colon
id|mbox-&gt;cmd
op_assign
id|FW_FIRE_FLASH
suffix:semicolon
id|mbox-&gt;channel
op_assign
id|data
(braket
l_int|1
)braket
op_or
l_int|0x80
suffix:semicolon
multiline_comment|/* Origin */
id|set_mbox_xfer_addr
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox
comma
id|TO_DEVICE
)paren
suffix:semicolon
id|mbox-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DCMD_FC_CMD
suffix:colon
op_star
(paren
id|mboxdata
op_plus
l_int|0
)paren
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/*mailbox byte 0: DCMD_FC_CMD */
op_star
(paren
id|mboxdata
op_plus
l_int|2
)paren
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/*sub command */
r_switch
c_cond
(paren
id|data
(braket
l_int|1
)braket
)paren
(brace
r_case
id|DCMD_FC_READ_NVRAM_CONFIG
suffix:colon
r_case
id|DCMD_FC_READ_NVRAM_CONFIG_64
suffix:colon
multiline_comment|/* number of elements in SG list */
op_star
(paren
id|mboxdata
op_plus
l_int|3
)paren
op_assign
id|mbox-&gt;numsgelements
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_64BIT
)paren
op_star
(paren
id|mboxdata
op_plus
l_int|2
)paren
op_assign
id|DCMD_FC_READ_NVRAM_CONFIG_64
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DCMD_WRITE_CONFIG
suffix:colon
r_case
id|DCMD_WRITE_CONFIG_64
suffix:colon
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_64BIT
)paren
op_star
(paren
id|mboxdata
op_plus
l_int|2
)paren
op_assign
id|DCMD_WRITE_CONFIG_64
suffix:semicolon
id|set_mbox_xfer_addr
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox
comma
id|TO_DEVICE
)paren
suffix:semicolon
id|mbox-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DCMD_GET_DISK_CONFIG
suffix:colon
r_case
id|DCMD_GET_DISK_CONFIG_64
suffix:colon
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_64BIT
)paren
op_star
(paren
id|mboxdata
op_plus
l_int|2
)paren
op_assign
id|DCMD_GET_DISK_CONFIG_64
suffix:semicolon
op_star
(paren
id|mboxdata
op_plus
l_int|3
)paren
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/*number of elements in SG list */
multiline_comment|/*nr of elements in SG list */
op_star
(paren
id|mboxdata
op_plus
l_int|4
)paren
op_assign
id|mbox-&gt;numsgelements
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DCMD_DELETE_LOGDRV
suffix:colon
r_case
id|DCMD_DELETE_DRIVEGROUP
suffix:colon
r_case
id|NC_SUBOP_ENQUIRY3
suffix:colon
op_star
(paren
id|mboxdata
op_plus
l_int|3
)paren
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|set_mbox_xfer_addr
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox
comma
id|FROMTO_DEVICE
)paren
suffix:semicolon
id|mbox-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DCMD_CHANGE_LDNO
suffix:colon
r_case
id|DCMD_CHANGE_LOOPID
suffix:colon
op_star
(paren
id|mboxdata
op_plus
l_int|3
)paren
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
op_star
(paren
id|mboxdata
op_plus
l_int|4
)paren
op_assign
id|data
(braket
l_int|3
)braket
suffix:semicolon
id|set_mbox_xfer_addr
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox
comma
id|TO_DEVICE
)paren
suffix:semicolon
id|mbox-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|set_mbox_xfer_addr
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox
comma
id|FROMTO_DEVICE
)paren
suffix:semicolon
id|mbox-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*switch */
r_break
suffix:semicolon
r_default
suffix:colon
id|set_mbox_xfer_addr
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox
comma
id|FROMTO_DEVICE
)paren
suffix:semicolon
id|mbox-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|mbox-&gt;numsgelements
op_assign
id|mega_build_sglist
(paren
id|megaCfg
comma
id|pScb
comma
(paren
id|u32
op_star
)paren
op_amp
id|mbox
op_member_access_from_pointer
id|xferaddr
comma
(paren
id|u32
op_star
)paren
op_amp
id|seg
)paren
suffix:semicolon
multiline_comment|/* Handling some of the fw special commands */
r_switch
c_cond
(paren
id|data
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|6
suffix:colon
multiline_comment|/* START_DEV */
id|mbox-&gt;xferaddr
op_assign
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|data
(braket
id|i
op_plus
l_int|6
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|SCpnt-&gt;request_bufflen
op_minus
l_int|6
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
(braket
id|i
)braket
op_assign
id|data
(braket
id|i
op_plus
l_int|6
)braket
suffix:semicolon
)brace
)brace
r_return
(paren
id|pScb
)paren
suffix:semicolon
)brace
DECL|function|mega_build_kernel_sg
r_static
r_void
id|mega_build_kernel_sg
(paren
r_char
op_star
id|barea
comma
id|ulong
id|xfersize
comma
id|mega_scb
op_star
id|pScb
comma
id|mega_ioctl_mbox
op_star
id|mbox
)paren
(brace
id|ulong
id|i
comma
id|buffer_area
comma
id|len
comma
id|end
comma
id|end_page
comma
id|x
comma
id|idx
op_assign
l_int|0
suffix:semicolon
id|buffer_area
op_assign
(paren
id|ulong
)paren
id|barea
suffix:semicolon
id|i
op_assign
id|buffer_area
suffix:semicolon
id|end
op_assign
id|buffer_area
op_plus
id|xfersize
suffix:semicolon
id|end_page
op_assign
(paren
id|end
)paren
op_amp
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_do
(brace
id|len
op_assign
id|PAGE_SIZE
op_minus
(paren
id|i
op_mod
id|PAGE_SIZE
)paren
suffix:semicolon
id|x
op_assign
id|pScb-&gt;sgList
(braket
id|idx
)braket
dot
id|address
op_assign
id|virt_to_bus
(paren
(paren
r_volatile
r_void
op_star
)paren
id|i
)paren
suffix:semicolon
id|pScb-&gt;sgList
(braket
id|idx
)braket
dot
id|length
op_assign
id|len
suffix:semicolon
id|i
op_add_assign
id|len
suffix:semicolon
id|idx
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|end_page
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|end
op_minus
id|i
)paren
OL
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;megaraid:Error in user address&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|end
op_minus
id|i
)paren
(brace
id|pScb-&gt;sgList
(braket
id|idx
)braket
dot
id|address
op_assign
id|virt_to_bus
(paren
(paren
r_volatile
r_void
op_star
)paren
id|i
)paren
suffix:semicolon
id|pScb-&gt;sgList
(braket
id|idx
)braket
dot
id|length
op_assign
id|end
op_minus
id|i
suffix:semicolon
id|idx
op_increment
suffix:semicolon
)brace
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
id|pScb-&gt;sgList
)paren
suffix:semicolon
id|mbox-&gt;numsgelements
op_assign
id|idx
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if DEBUG
DECL|variable|cum_time
r_static
r_int
r_int
id|cum_time
op_assign
l_int|0
suffix:semicolon
DECL|variable|cum_time_cnt
r_static
r_int
r_int
id|cum_time_cnt
op_assign
l_int|0
suffix:semicolon
DECL|function|showMbox
r_static
r_void
id|showMbox
(paren
id|mega_scb
op_star
id|pScb
)paren
(brace
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
r_if
c_cond
(paren
id|pScb
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|pScb-&gt;mboxData
suffix:semicolon
id|printk
(paren
l_string|&quot;%u cmd:%x id:%x #scts:%x lba:%x addr:%x logdrv:%x #sg:%x&bslash;n&quot;
comma
id|pScb-&gt;SCpnt-&gt;pid
comma
id|mbox-&gt;cmd
comma
id|mbox-&gt;cmdid
comma
id|mbox-&gt;numsectors
comma
id|mbox-&gt;lba
comma
id|mbox-&gt;xferaddr
comma
id|mbox-&gt;logdrv
comma
id|mbox-&gt;numsgelements
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*--------------------------------------------------------------------&n; * Interrupt service routine&n; *--------------------------------------------------------------------*/
DECL|function|megaraid_isr
r_static
r_void
id|megaraid_isr
(paren
r_int
id|irq
comma
r_void
op_star
id|devp
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|IO_LOCK_T
suffix:semicolon
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|u_char
id|byte
comma
id|idx
comma
id|sIdx
comma
id|tmpBox
(braket
id|MAILBOX_SIZE
)braket
suffix:semicolon
id|u32
id|dword
op_assign
l_int|0
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|u_char
id|qCnt
comma
id|qStatus
suffix:semicolon
id|u_char
id|completed
(braket
id|MAX_FIRMWARE_STATUS
)braket
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|devp
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|tmpBox
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;host-&gt;irq
op_eq
id|irq
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_ISR
)paren
(brace
id|TRACE
(paren
(paren
l_string|&quot;ISR called reentrantly!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;ISR called reentrantly!!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|megaCfg-&gt;flag
op_or_assign
id|IN_ISR
suffix:semicolon
r_if
c_cond
(paren
id|mega_busyWaitMbox
(paren
id|megaCfg
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;Error: mailbox busy in isr!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Check if a valid interrupt is pending */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|dword
op_assign
id|RDOUTDOOR
(paren
id|megaCfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dword
op_ne
l_int|0x10001234
)paren
(brace
multiline_comment|/* Spurious interrupt */
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ISR
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
id|byte
op_assign
id|READ_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|byte
op_amp
id|VALID_INTR_BYTE
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Spurious interrupt */
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ISR
suffix:semicolon
r_return
suffix:semicolon
)brace
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
comma
id|byte
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|MAX_FIRMWARE_STATUS
suffix:semicolon
id|idx
op_increment
)paren
id|completed
(braket
id|idx
)braket
op_assign
l_int|0
suffix:semicolon
id|IO_LOCK
c_func
(paren
id|megaCfg-&gt;host
)paren
suffix:semicolon
id|megaCfg-&gt;nInterrupts
op_increment
suffix:semicolon
id|qCnt
op_assign
l_int|0xff
suffix:semicolon
r_while
c_loop
(paren
(paren
id|qCnt
op_assign
id|megaCfg-&gt;mbox-&gt;numstatus
)paren
op_eq
l_int|0xFF
)paren
suffix:semicolon
id|qStatus
op_assign
l_int|0xff
suffix:semicolon
r_while
c_loop
(paren
(paren
id|qStatus
op_assign
id|megaCfg-&gt;mbox-&gt;status
)paren
op_eq
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* Get list of completed requests */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|qCnt
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|sIdx
op_assign
id|megaCfg-&gt;mbox-&gt;completed
(braket
id|idx
)braket
)paren
op_eq
l_int|0xFF
)paren
(brace
id|printk
(paren
l_string|&quot;p&quot;
)paren
suffix:semicolon
)brace
id|completed
(braket
id|idx
)braket
op_assign
id|sIdx
suffix:semicolon
id|sIdx
op_assign
l_int|0xFF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|WROUTDOOR
(paren
id|megaCfg
comma
id|dword
)paren
suffix:semicolon
multiline_comment|/* Acknowledge interrupt */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
multiline_comment|/* In this case mbox contains physical address */
macro_line|#if 0
id|WRINDOOR
(paren
id|megaCfg
comma
id|megaCfg-&gt;adjdmahandle64
op_or
l_int|0x2
)paren
suffix:semicolon
macro_line|#else
id|WRINDOOR
(paren
id|megaCfg
comma
l_int|0x2
)paren
suffix:semicolon
macro_line|#endif
macro_line|#else
macro_line|#if 0
id|WRINDOOR
(paren
id|megaCfg
comma
id|virt_to_bus
(paren
id|megaCfg-&gt;mbox
)paren
op_or
l_int|0x2
)paren
suffix:semicolon
macro_line|#else
id|WRINDOOR
(paren
id|megaCfg
comma
l_int|0x2
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
macro_line|#if 0
r_while
c_loop
(paren
id|RDINDOOR
(paren
id|megaCfg
)paren
op_amp
l_int|0x02
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|CLEAR_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG
r_if
c_cond
(paren
id|qCnt
op_ge
id|MAX_FIRMWARE_STATUS
)paren
(brace
id|printk
(paren
l_string|&quot;megaraid_isr: cmplt=%d &quot;
comma
id|qCnt
)paren
suffix:semicolon
)brace
macro_line|#endif
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|qCnt
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|sIdx
op_assign
id|completed
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sIdx
OG
l_int|0
)paren
op_logical_and
(paren
id|sIdx
op_le
id|MAX_COMMANDS
)paren
)paren
(brace
id|pScb
op_assign
op_amp
id|megaCfg-&gt;scbList
(braket
id|sIdx
op_minus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* ASSERT(pScb-&gt;state == SCB_ISSUED); */
macro_line|#if DEBUG
r_if
c_cond
(paren
(paren
(paren
id|jiffies
)paren
op_minus
id|pScb-&gt;isrcount
)paren
OG
id|maxCmdTime
)paren
(brace
id|maxCmdTime
op_assign
(paren
id|jiffies
)paren
op_minus
id|pScb-&gt;isrcount
suffix:semicolon
id|printk
(paren
l_string|&quot;megaraid_isr : cmd time = %u&bslash;n&quot;
comma
id|maxCmdTime
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t;&t;&t;&t; * Assuming that the scsi command, for which &n;&t;&t;&t;&t; * an abort request was received earlier, has &n;&t;&t;&t;&t; * completed.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|pScb-&gt;state
op_eq
id|SCB_ABORTED
)paren
(brace
id|SCpnt
op_assign
id|pScb-&gt;SCpnt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pScb-&gt;state
op_eq
id|SCB_RESET
)paren
(brace
id|SCpnt
op_assign
id|pScb-&gt;SCpnt
suffix:semicolon
id|mega_freeSCB
(paren
id|megaCfg
comma
id|pScb
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qCompletedT
op_member_access_from_pointer
id|host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* We don&squot;t want the ISR routine to touch M_RD_IOCTL_CMD_NEW commands, so&n;&t;&t;&t;&t; * don&squot;t mark them as complete, instead we pop their semaphore so&n;&t;&t;&t;&t; * that the queue routine can finish them off&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|pScb-&gt;SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|M_RD_IOCTL_CMD_NEW
)paren
(brace
multiline_comment|/* save the status byte for the queue routine to use */
id|pScb-&gt;SCpnt-&gt;result
op_assign
id|qStatus
suffix:semicolon
id|up
(paren
op_amp
id|pScb-&gt;ioctl_sem
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Mark command as completed */
id|mega_cmd_done
(paren
id|megaCfg
comma
id|pScb
comma
id|qStatus
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;megaraid: wrong cmd id completed from firmware:id=%x&bslash;n&quot;
comma
id|sIdx
)paren
suffix:semicolon
)brace
)brace
id|mega_rundoneq
(paren
id|megaCfg
)paren
suffix:semicolon
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ISR
suffix:semicolon
multiline_comment|/* Loop through any pending requests */
id|mega_runpendq
(paren
id|megaCfg
)paren
suffix:semicolon
id|IO_UNLOCK
c_func
(paren
id|megaCfg-&gt;host
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*==================================================*/
multiline_comment|/* Wait until the controller&squot;s mailbox is available */
multiline_comment|/*==================================================*/
DECL|function|mega_busyWaitMbox
r_static
r_int
id|mega_busyWaitMbox
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
id|mega_mailbox
op_star
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|megaCfg-&gt;mbox
suffix:semicolon
r_int
id|counter
suffix:semicolon
r_for
c_loop
(paren
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
OL
l_int|10000
suffix:semicolon
id|counter
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mbox-&gt;busy
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
id|barrier
(paren
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* give up after 1 second */
)brace
multiline_comment|/*=====================================================&n; * Post a command to the card&n; *&n; * Arguments:&n; *   mega_host_config *megaCfg - Controller structure&n; *   u_char *mboxData - Mailbox area, 16 bytes&n; *   mega_scb *pScb   - SCB posting (or NULL if N/A)&n; *   int intr         - if 1, interrupt, 0 is blocking&n; * Return Value: (added on 7/26 for 40ld/64bit)&n; *   -1: the command was not actually issued out&n; *   other cases:&n; *     intr==0, return ScsiStatus, i.e. mbox-&gt;status&n; *     intr==1, return 0&n; *=====================================================&n; */
DECL|function|megaIssueCmd
r_static
r_int
id|megaIssueCmd
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u_char
op_star
id|mboxData
comma
id|mega_scb
op_star
id|pScb
comma
r_int
id|intr
)paren
(brace
r_volatile
id|mega_mailbox
op_star
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|megaCfg-&gt;mbox
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
r_volatile
id|mega_mailbox64
op_star
id|mbox64
op_assign
(paren
id|mega_mailbox64
op_star
)paren
id|megaCfg-&gt;mbox64
suffix:semicolon
macro_line|#endif
id|u_char
id|byte
suffix:semicolon
macro_line|#ifdef __LP64__
id|u64
id|phys_mbox
suffix:semicolon
macro_line|#else
id|u32
id|phys_mbox
suffix:semicolon
macro_line|#endif
id|u8
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
id|mboxData
(braket
l_int|0x1
)braket
op_assign
(paren
id|pScb
ques
c_cond
id|pScb-&gt;idx
op_plus
l_int|1
suffix:colon
l_int|0xFE
)paren
suffix:semicolon
multiline_comment|/* Set cmdid */
id|mboxData
(braket
l_int|0xF
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Set busy */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
multiline_comment|/* In this case mbox contains physical address */
id|phys_mbox
op_assign
id|megaCfg-&gt;adjdmahandle64
suffix:semicolon
macro_line|#else
id|phys_mbox
op_assign
id|virt_to_bus
(paren
id|megaCfg-&gt;mbox
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if DEBUG
id|ShowMbox
(paren
id|pScb
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Wait until mailbox is free */
r_if
c_cond
(paren
id|mega_busyWaitMbox
(paren
id|megaCfg
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;Blocked mailbox......!!&bslash;n&quot;
)paren
suffix:semicolon
id|udelay
(paren
l_int|1000
)paren
suffix:semicolon
macro_line|#if DEBUG
id|showMbox
(paren
id|pLastScb
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Abort command */
r_if
c_cond
(paren
id|pScb
op_eq
l_int|NULL
)paren
(brace
id|TRACE
(paren
(paren
l_string|&quot;NULL pScb in megaIssue&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;NULL pScb in megaIssue&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|mega_cmd_done
(paren
id|megaCfg
comma
id|pScb
comma
l_int|0x08
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pLastScb
op_assign
id|pScb
suffix:semicolon
multiline_comment|/* Copy mailbox data into host structure */
id|megaCfg-&gt;mbox64-&gt;xferSegment_lo
op_assign
l_int|0
suffix:semicolon
id|megaCfg-&gt;mbox64-&gt;xferSegment_hi
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
(paren
r_char
op_star
)paren
id|mbox
comma
id|mboxData
comma
l_int|16
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
r_switch
c_cond
(paren
id|mboxData
(braket
l_int|0
)braket
)paren
(brace
r_case
id|MEGA_MBOXCMD_LREAD64
suffix:colon
r_case
id|MEGA_MBOXCMD_LWRITE64
suffix:colon
id|mbox64-&gt;xferSegment_lo
op_assign
id|mbox-&gt;xferaddr
suffix:semicolon
id|mbox64-&gt;xferSegment_hi
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;xferaddr
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Kick IO */
r_if
c_cond
(paren
id|intr
)paren
(brace
multiline_comment|/* Issue interrupt (non-blocking) command */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|mbox-&gt;mraid_poll
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;mraid_ack
op_assign
l_int|0
suffix:semicolon
id|WRINDOOR
(paren
id|megaCfg
comma
id|phys_mbox
op_or
l_int|0x1
)paren
suffix:semicolon
)brace
r_else
(brace
id|ENABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|ISSUE_COMMAND
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
)brace
id|pScb-&gt;state
op_assign
id|SCB_ISSUED
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Issue non-ISR (blocking) command */
id|disable_irq
(paren
id|megaCfg-&gt;host-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|mbox-&gt;mraid_poll
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;mraid_ack
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;numstatus
op_assign
l_int|0xFF
suffix:semicolon
id|mbox-&gt;status
op_assign
l_int|0xFF
suffix:semicolon
id|WRINDOOR
(paren
id|megaCfg
comma
id|phys_mbox
op_or
l_int|0x1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|mbox-&gt;numstatus
op_eq
l_int|0xFF
)paren
suffix:semicolon
r_while
c_loop
(paren
id|mbox-&gt;status
op_eq
l_int|0xFF
)paren
suffix:semicolon
r_while
c_loop
(paren
id|mbox-&gt;mraid_poll
op_ne
l_int|0x77
)paren
suffix:semicolon
id|mbox-&gt;mraid_poll
op_assign
l_int|0
suffix:semicolon
id|mbox-&gt;mraid_ack
op_assign
l_int|0x77
suffix:semicolon
multiline_comment|/* while ((cmdDone = RDOUTDOOR (megaCfg)) != 0x10001234);&n;&t;&t;&t;   WROUTDOOR (megaCfg, cmdDone); */
r_if
c_cond
(paren
id|pScb
)paren
(brace
id|mega_cmd_done
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox-&gt;status
)paren
suffix:semicolon
)brace
id|WRINDOOR
(paren
id|megaCfg
comma
id|phys_mbox
op_or
l_int|0x2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|RDINDOOR
(paren
id|megaCfg
)paren
op_amp
l_int|0x2
)paren
suffix:semicolon
)brace
r_else
(brace
id|DISABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|ISSUE_COMMAND
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|byte
op_assign
id|READ_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
)paren
)paren
op_amp
id|INTR_VALID
)paren
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|INTR_PORT
comma
id|byte
)paren
suffix:semicolon
id|ENABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|CLEAR_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pScb
)paren
(brace
id|mega_cmd_done
(paren
id|megaCfg
comma
id|pScb
comma
id|mbox-&gt;status
)paren
suffix:semicolon
)brace
r_else
(brace
id|TRACE
(paren
(paren
l_string|&quot;Error: NULL pScb!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
id|enable_irq
(paren
id|megaCfg-&gt;host-&gt;irq
)paren
suffix:semicolon
id|retval
op_assign
id|mbox-&gt;status
suffix:semicolon
)brace
macro_line|#if DEBUG
r_while
c_loop
(paren
id|mega_busyWaitMbox
(paren
id|megaCfg
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Blocked mailbox on exit......!&bslash;n&quot;
)paren
suffix:semicolon
id|udelay
(paren
l_int|1000
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------&n; * Copies data to SGLIST&n; *-------------------------------------------------------------------*/
multiline_comment|/* Note:&n;&t;For 64 bit cards, we need a minimum of one SG element for read/write&n;*/
r_static
r_int
DECL|function|mega_build_sglist
id|mega_build_sglist
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|mega_scb
op_star
id|scb
comma
id|u32
op_star
id|buffer
comma
id|u32
op_star
id|length
)paren
(brace
r_struct
id|scatterlist
op_star
id|sgList
suffix:semicolon
r_int
id|idx
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
r_int
id|sgcnt
suffix:semicolon
macro_line|#endif
id|mega_mailbox
op_star
id|mbox
op_assign
l_int|NULL
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|scb-&gt;mboxData
suffix:semicolon
multiline_comment|/* Scatter-gather not used */
r_if
c_cond
(paren
id|scb-&gt;SCpnt-&gt;use_sg
op_eq
l_int|0
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|scb-&gt;dma_h_bulkdata
op_assign
id|pci_map_single
(paren
id|megaCfg-&gt;dev
comma
id|scb-&gt;SCpnt-&gt;request_buffer
comma
id|scb-&gt;SCpnt-&gt;request_bufflen
comma
id|scb-&gt;dma_direction
)paren
suffix:semicolon
multiline_comment|/* We need to handle special commands like READ64, WRITE64&n;&t;&t;   as they need a minimum of 1 SG irrespective of actually SG&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_64BIT
)paren
op_logical_and
(paren
(paren
id|mbox-&gt;cmd
op_eq
id|MEGA_MBOXCMD_LREAD64
)paren
op_logical_or
(paren
id|mbox-&gt;cmd
op_eq
id|MEGA_MBOXCMD_LWRITE64
)paren
)paren
)paren
(brace
id|scb-&gt;sg64List
(braket
l_int|0
)braket
dot
id|address
op_assign
id|scb-&gt;dma_h_bulkdata
suffix:semicolon
id|scb-&gt;sg64List
(braket
l_int|0
)braket
dot
id|length
op_assign
id|scb-&gt;SCpnt-&gt;request_bufflen
suffix:semicolon
op_star
id|buffer
op_assign
id|scb-&gt;dma_sghandle64
suffix:semicolon
op_star
id|length
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;sglist_count
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
op_star
id|buffer
op_assign
id|scb-&gt;dma_h_bulkdata
suffix:semicolon
op_star
id|length
op_assign
(paren
id|u32
)paren
id|scb-&gt;SCpnt-&gt;request_bufflen
suffix:semicolon
)brace
macro_line|#else
op_star
id|buffer
op_assign
id|virt_to_bus
(paren
id|scb-&gt;SCpnt-&gt;request_buffer
)paren
suffix:semicolon
op_star
id|length
op_assign
(paren
id|u32
)paren
id|scb-&gt;SCpnt-&gt;request_bufflen
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|sgList
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|scb-&gt;SCpnt-&gt;request_buffer
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|scb-&gt;SCpnt-&gt;use_sg
op_eq
l_int|1
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|scb-&gt;dma_h_bulkdata
op_assign
id|pci_map_single
(paren
id|megaCfg-&gt;dev
comma
id|sgList
(braket
l_int|0
)braket
dot
id|address
comma
id|sgList
(braket
l_int|0
)braket
dot
id|length
comma
id|scb-&gt;dma_direction
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_64BIT
)paren
op_logical_and
(paren
(paren
id|mbox-&gt;cmd
op_eq
id|MEGA_MBOXCMD_LREAD64
)paren
op_logical_or
(paren
id|mbox-&gt;cmd
op_eq
id|MEGA_MBOXCMD_LWRITE64
)paren
)paren
)paren
(brace
id|scb-&gt;sg64List
(braket
l_int|0
)braket
dot
id|address
op_assign
id|scb-&gt;dma_h_bulkdata
suffix:semicolon
id|scb-&gt;sg64List
(braket
l_int|0
)braket
dot
id|length
op_assign
id|scb-&gt;SCpnt-&gt;request_bufflen
suffix:semicolon
op_star
id|buffer
op_assign
id|scb-&gt;dma_sghandle64
suffix:semicolon
op_star
id|length
op_assign
l_int|0
suffix:semicolon
id|scb-&gt;sglist_count
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
op_star
id|buffer
op_assign
id|scb-&gt;dma_h_bulkdata
suffix:semicolon
op_star
id|length
op_assign
(paren
id|u32
)paren
id|sgList
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
)brace
macro_line|#else
op_star
id|buffer
op_assign
id|virt_to_bus
(paren
id|sgList
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
op_star
id|length
op_assign
(paren
id|u32
)paren
id|sgList
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Copy Scatter-Gather list info into controller structure */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|sgcnt
op_assign
id|pci_map_sg
(paren
id|megaCfg-&gt;dev
comma
id|sgList
comma
id|scb-&gt;SCpnt-&gt;use_sg
comma
id|scb-&gt;dma_direction
)paren
suffix:semicolon
multiline_comment|/* Determine the validity of the new count  */
r_if
c_cond
(paren
id|sgcnt
op_eq
l_int|0
)paren
id|printk
(paren
l_string|&quot;pci_map_sg returned zero!!! &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|sgcnt
suffix:semicolon
id|idx
op_increment
comma
id|sgList
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_64BIT
)paren
op_logical_and
(paren
(paren
id|mbox-&gt;cmd
op_eq
id|MEGA_MBOXCMD_LREAD64
)paren
op_logical_or
(paren
id|mbox-&gt;cmd
op_eq
id|MEGA_MBOXCMD_LWRITE64
)paren
)paren
)paren
(brace
id|scb-&gt;sg64List
(braket
id|idx
)braket
dot
id|address
op_assign
id|sg_dma_address
(paren
id|sgList
)paren
suffix:semicolon
id|scb-&gt;sg64List
(braket
id|idx
)braket
dot
id|length
op_assign
id|sg_dma_len
(paren
id|sgList
)paren
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;sgList
(braket
id|idx
)braket
dot
id|address
op_assign
id|sg_dma_address
(paren
id|sgList
)paren
suffix:semicolon
id|scb-&gt;sgList
(braket
id|idx
)braket
dot
id|length
op_assign
id|sg_dma_len
(paren
id|sgList
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|scb-&gt;SCpnt-&gt;use_sg
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|scb-&gt;sgList
(braket
id|idx
)braket
dot
id|address
op_assign
id|virt_to_bus
(paren
id|sgList
(braket
id|idx
)braket
dot
id|address
)paren
suffix:semicolon
id|scb-&gt;sgList
(braket
id|idx
)braket
dot
id|length
op_assign
(paren
id|u32
)paren
id|sgList
(braket
id|idx
)braket
dot
id|length
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Reset pointer and length fields */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
op_star
id|buffer
op_assign
id|scb-&gt;dma_sghandle64
suffix:semicolon
id|scb-&gt;sglist_count
op_assign
id|scb-&gt;SCpnt-&gt;use_sg
suffix:semicolon
macro_line|#else
op_star
id|buffer
op_assign
id|virt_to_bus
(paren
id|scb-&gt;sgList
)paren
suffix:semicolon
macro_line|#endif
op_star
id|length
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
multiline_comment|/* Return count of SG requests */
r_return
id|sgcnt
suffix:semicolon
macro_line|#else
multiline_comment|/* Return count of SG requests */
r_return
id|scb-&gt;SCpnt-&gt;use_sg
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*--------------------------------------------------------------------&n; * Initializes the address of the controller&squot;s mailbox register&n; *  The mailbox register is used to issue commands to the card.&n; *  Format of the mailbox area:&n; *   00 01 command&n; *   01 01 command id&n; *   02 02 # of sectors&n; *   04 04 logical bus address&n; *   08 04 physical buffer address&n; *   0C 01 logical drive #&n; *   0D 01 length of scatter/gather list&n; *   0E 01 reserved&n; *   0F 01 mailbox busy&n; *   10 01 numstatus byte&n; *   11 01 status byte&n; *--------------------------------------------------------------------*/
r_static
r_int
DECL|function|mega_register_mailbox
id|mega_register_mailbox
(paren
id|mega_host_config
op_star
id|megaCfg
comma
id|u32
id|paddr
)paren
(brace
multiline_comment|/* align on 16-byte boundary */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|megaCfg-&gt;mbox
op_assign
op_amp
id|megaCfg-&gt;mailbox64ptr-&gt;mailbox
suffix:semicolon
macro_line|#else
id|megaCfg-&gt;mbox
op_assign
op_amp
id|megaCfg-&gt;mailbox64.mailbox
suffix:semicolon
macro_line|#endif
macro_line|#ifdef __LP64__
id|megaCfg-&gt;mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
(paren
(paren
(paren
(paren
id|u64
)paren
id|megaCfg-&gt;mbox
)paren
op_plus
l_int|16
)paren
op_amp
(paren
(paren
id|u64
)paren
(paren
op_minus
l_int|1
)paren
op_xor
l_int|0x0F
)paren
)paren
suffix:semicolon
id|megaCfg-&gt;adjdmahandle64
op_assign
(paren
id|megaCfg-&gt;dma_handle64
op_plus
l_int|16
)paren
op_amp
(paren
(paren
id|u64
)paren
(paren
op_minus
l_int|1
)paren
op_xor
l_int|0x0F
)paren
suffix:semicolon
id|megaCfg-&gt;mbox64
op_assign
(paren
id|mega_mailbox64
op_star
)paren
(paren
(paren
id|u_char
op_star
)paren
id|megaCfg-&gt;mbox
op_minus
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|paddr
op_assign
(paren
id|paddr
op_plus
l_int|4
op_plus
l_int|16
)paren
op_amp
(paren
(paren
id|u64
)paren
(paren
op_minus
l_int|1
)paren
op_xor
l_int|0x0F
)paren
suffix:semicolon
macro_line|#else
id|megaCfg-&gt;mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
(paren
(paren
(paren
(paren
id|u32
)paren
id|megaCfg-&gt;mbox
)paren
op_plus
l_int|16
)paren
op_amp
l_int|0xFFFFFFF0
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|megaCfg-&gt;adjdmahandle64
op_assign
(paren
(paren
id|megaCfg-&gt;dma_handle64
op_plus
l_int|16
)paren
op_amp
l_int|0xFFFFFFF0
)paren
suffix:semicolon
macro_line|#endif
id|megaCfg-&gt;mbox64
op_assign
(paren
id|mega_mailbox64
op_star
)paren
(paren
(paren
id|u_char
op_star
)paren
id|megaCfg-&gt;mbox
op_minus
l_int|8
)paren
suffix:semicolon
id|paddr
op_assign
(paren
id|paddr
op_plus
l_int|4
op_plus
l_int|16
)paren
op_amp
l_int|0xFFFFFFF0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Register mailbox area with the firmware */
r_if
c_cond
(paren
op_logical_neg
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
)paren
(brace
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT0
comma
id|paddr
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT1
comma
(paren
id|paddr
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT2
comma
(paren
id|paddr
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|MBOX_PORT3
comma
(paren
id|paddr
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|WRITE_PORT
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
id|ENABLE_MBOX_REGION
comma
id|ENABLE_MBOX_BYTE
)paren
suffix:semicolon
id|CLEAR_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|ENABLE_INTR
(paren
id|megaCfg-&gt;host-&gt;io_port
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n; * mega_Convert8ldTo40ld() -- takes all info in AdapterInquiry structure and&n; * puts it into ProductInfo and Enquiry3 structures for later use&n; *---------------------------------------------------------------------------*/
DECL|function|mega_Convert8ldTo40ld
r_static
r_void
id|mega_Convert8ldTo40ld
(paren
id|mega_RAIDINQ
op_star
id|inquiry
comma
id|mega_Enquiry3
op_star
id|enquiry3
comma
id|megaRaidProductInfo
op_star
id|productInfo
)paren
(brace
r_int
id|i
suffix:semicolon
id|productInfo-&gt;MaxConcCmds
op_assign
id|inquiry-&gt;AdpInfo.MaxConcCmds
suffix:semicolon
id|enquiry3-&gt;rbldRate
op_assign
id|inquiry-&gt;AdpInfo.RbldRate
suffix:semicolon
id|productInfo-&gt;SCSIChanPresent
op_assign
id|inquiry-&gt;AdpInfo.ChanPresent
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|productInfo-&gt;FwVer
(braket
id|i
)braket
op_assign
id|inquiry-&gt;AdpInfo.FwVer
(braket
id|i
)braket
suffix:semicolon
id|productInfo-&gt;BiosVer
(braket
id|i
)braket
op_assign
id|inquiry-&gt;AdpInfo.BiosVer
(braket
id|i
)braket
suffix:semicolon
)brace
id|enquiry3-&gt;cacheFlushInterval
op_assign
id|inquiry-&gt;AdpInfo.CacheFlushInterval
suffix:semicolon
id|productInfo-&gt;DramSize
op_assign
id|inquiry-&gt;AdpInfo.DramSize
suffix:semicolon
id|enquiry3-&gt;numLDrv
op_assign
id|inquiry-&gt;LogdrvInfo.NumLDrv
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_LOGICAL_DRIVES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|enquiry3-&gt;lDrvSize
(braket
id|i
)braket
op_assign
id|inquiry-&gt;LogdrvInfo.LDrvSize
(braket
id|i
)braket
suffix:semicolon
id|enquiry3-&gt;lDrvProp
(braket
id|i
)braket
op_assign
id|inquiry-&gt;LogdrvInfo.LDrvProp
(braket
id|i
)braket
suffix:semicolon
id|enquiry3-&gt;lDrvState
(braket
id|i
)braket
op_assign
id|inquiry-&gt;LogdrvInfo.LDrvState
(braket
id|i
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|MAX_PHYSICAL_DRIVES
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|enquiry3-&gt;pDrvState
(braket
id|i
)braket
op_assign
id|inquiry-&gt;PhysdrvInfo.PDrvState
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------&n; * Issue an adapter info query to the controller&n; *-------------------------------------------------------------------*/
DECL|function|mega_i_query_adapter
r_static
r_int
id|mega_i_query_adapter
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
id|mega_Enquiry3
op_star
id|enquiry3Pnt
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|u_char
id|mboxData
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|dma_addr_t
id|raid_inq_dma_handle
op_assign
l_int|0
comma
id|prod_info_dma_handle
op_assign
l_int|0
comma
id|enquiry3_dma_handle
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|u8
id|retval
suffix:semicolon
multiline_comment|/* Initialize adapter inquiry mailbox */
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mboxData
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
id|megaCfg-&gt;mega_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|megaCfg-&gt;mega_buffer
)paren
)paren
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/*&n; * Try to issue Enquiry3 command&n; * if not succeeded, then issue MEGA_MBOXCMD_ADAPTERINQ command and&n; * update enquiry3 structure&n; */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|enquiry3_dma_handle
op_assign
id|pci_map_single
(paren
id|megaCfg-&gt;dev
comma
(paren
r_void
op_star
)paren
id|megaCfg-&gt;mega_buffer
comma
(paren
l_int|2
op_star
l_int|1024L
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|mbox-&gt;xferaddr
op_assign
id|enquiry3_dma_handle
suffix:semicolon
macro_line|#else
multiline_comment|/*Taken care */
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
(paren
r_void
op_star
)paren
id|megaCfg-&gt;mega_buffer
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Initialize mailbox databuffer addr */
id|enquiry3Pnt
op_assign
(paren
id|mega_Enquiry3
op_star
)paren
id|megaCfg-&gt;mega_buffer
suffix:semicolon
multiline_comment|/* point mega_Enguiry3 to the data buf */
id|mboxData
(braket
l_int|0
)braket
op_assign
id|FC_NEW_CONFIG
suffix:semicolon
multiline_comment|/* i.e. mbox-&gt;cmd=0xA1 */
id|mboxData
(braket
l_int|2
)braket
op_assign
id|NC_SUBOP_ENQUIRY3
suffix:semicolon
multiline_comment|/* i.e. 0x0F */
id|mboxData
(braket
l_int|3
)braket
op_assign
id|ENQ3_GET_SOLICITED_FULL
suffix:semicolon
multiline_comment|/* i.e. 0x02 */
multiline_comment|/* Issue a blocking command to the card */
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|megaIssueCmd
(paren
id|megaCfg
comma
id|mboxData
comma
l_int|NULL
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* the adapter does not support 40ld */
id|mega_RAIDINQ
id|adapterInquiryData
suffix:semicolon
id|mega_RAIDINQ
op_star
id|adapterInquiryPnt
op_assign
op_amp
id|adapterInquiryData
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|raid_inq_dma_handle
op_assign
id|pci_map_single
(paren
id|megaCfg-&gt;dev
comma
(paren
r_void
op_star
)paren
id|adapterInquiryPnt
comma
r_sizeof
(paren
id|mega_RAIDINQ
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|mbox-&gt;xferaddr
op_assign
id|raid_inq_dma_handle
suffix:semicolon
macro_line|#else
multiline_comment|/*taken care */
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
(paren
r_void
op_star
)paren
id|adapterInquiryPnt
)paren
suffix:semicolon
macro_line|#endif
id|mbox-&gt;cmd
op_assign
id|MEGA_MBOXCMD_ADAPTERINQ
suffix:semicolon
multiline_comment|/*issue old 0x05 command to adapter */
multiline_comment|/* Issue a blocking command to the card */
suffix:semicolon
id|retval
op_assign
id|megaIssueCmd
(paren
id|megaCfg
comma
id|mboxData
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|pci_unmap_single
(paren
id|megaCfg-&gt;dev
comma
id|raid_inq_dma_handle
comma
r_sizeof
(paren
id|mega_RAIDINQ
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
multiline_comment|/*update Enquiry3 and ProductInfo structures with mega_RAIDINQ structure*/
id|mega_Convert8ldTo40ld
(paren
id|adapterInquiryPnt
comma
id|enquiry3Pnt
comma
(paren
id|megaRaidProductInfo
op_star
)paren
op_amp
id|megaCfg
op_member_access_from_pointer
id|productInfo
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* adapter supports 40ld */
id|megaCfg-&gt;flag
op_or_assign
id|BOARD_40LD
suffix:semicolon
id|pci_unmap_single
(paren
id|megaCfg-&gt;dev
comma
id|enquiry3_dma_handle
comma
(paren
l_int|2
op_star
l_int|1024L
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
multiline_comment|/*get productInfo, which is static information and will be unchanged*/
id|prod_info_dma_handle
op_assign
id|pci_map_single
(paren
id|megaCfg-&gt;dev
comma
(paren
r_void
op_star
)paren
op_amp
id|megaCfg-&gt;productInfo
comma
r_sizeof
(paren
id|megaRaidProductInfo
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|mbox-&gt;xferaddr
op_assign
id|prod_info_dma_handle
suffix:semicolon
macro_line|#else
multiline_comment|/*taken care */
id|mbox-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
(paren
r_void
op_star
)paren
op_amp
id|megaCfg-&gt;productInfo
)paren
suffix:semicolon
macro_line|#endif
id|mboxData
(braket
l_int|0
)braket
op_assign
id|FC_NEW_CONFIG
suffix:semicolon
multiline_comment|/* i.e. mbox-&gt;cmd=0xA1 */
id|mboxData
(braket
l_int|2
)braket
op_assign
id|NC_SUBOP_PRODUCT_INFO
suffix:semicolon
multiline_comment|/* i.e. 0x0E */
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|megaIssueCmd
(paren
id|megaCfg
comma
id|mboxData
comma
l_int|NULL
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
id|printk
(paren
l_string|&quot;megaraid: Product_info cmd failed with error: %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
id|pci_unmap_single
(paren
id|megaCfg-&gt;dev
comma
id|prod_info_dma_handle
comma
r_sizeof
(paren
id|megaRaidProductInfo
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * kernel scans the channels from 0 to &lt;= max_channel&n;&t; */
id|megaCfg-&gt;host-&gt;max_channel
op_assign
id|megaCfg-&gt;productInfo.SCSIChanPresent
op_plus
id|NVIRT_CHAN
op_minus
l_int|1
suffix:semicolon
id|megaCfg-&gt;host-&gt;max_id
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* max targets per channel */
multiline_comment|/*(megaCfg-&gt;flag &amp; BOARD_40LD)?FC_MAX_TARGETS_PER_CHANNEL:MAX_TARGET+1; */
macro_line|#if 0
id|megaCfg-&gt;host-&gt;max_lun
op_assign
multiline_comment|/* max lun */
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_40LD
)paren
ques
c_cond
id|FC_MAX_LOGICAL_DRIVES
suffix:colon
id|MAX_LOGICAL_DRIVES
suffix:semicolon
macro_line|#endif
id|megaCfg-&gt;host-&gt;max_lun
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* Upto 7 luns for non disk devices */
id|megaCfg-&gt;host-&gt;cmd_per_lun
op_assign
id|MAX_CMD_PER_LUN
suffix:semicolon
id|megaCfg-&gt;numldrv
op_assign
id|enquiry3Pnt-&gt;numLDrv
suffix:semicolon
id|megaCfg-&gt;max_cmds
op_assign
id|megaCfg-&gt;productInfo.MaxConcCmds
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;max_cmds
OG
id|MAX_COMMANDS
)paren
id|megaCfg-&gt;max_cmds
op_assign
id|MAX_COMMANDS
op_minus
l_int|1
suffix:semicolon
id|megaCfg-&gt;host-&gt;can_queue
op_assign
id|megaCfg-&gt;max_cmds
op_minus
l_int|1
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|megaCfg-&gt;host-&gt;can_queue
op_ge
id|MAX_COMMANDS
)paren
(brace
id|megaCfg-&gt;host-&gt;can_queue
op_assign
id|MAX_COMMANDS
op_minus
l_int|16
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* use HP firmware and bios version encoding */
r_if
c_cond
(paren
id|megaCfg-&gt;productInfo.subSystemVendorID
op_eq
id|HP_SUBSYS_ID
)paren
(brace
id|sprintf
(paren
id|megaCfg-&gt;fwVer
comma
l_string|&quot;%c%d%d.%d%d&quot;
comma
id|megaCfg-&gt;productInfo.FwVer
(braket
l_int|2
)braket
comma
id|megaCfg-&gt;productInfo.FwVer
(braket
l_int|1
)braket
op_rshift
l_int|8
comma
id|megaCfg-&gt;productInfo.FwVer
(braket
l_int|1
)braket
op_amp
l_int|0x0f
comma
id|megaCfg-&gt;productInfo.FwVer
(braket
l_int|0
)braket
op_rshift
l_int|8
comma
id|megaCfg-&gt;productInfo.FwVer
(braket
l_int|0
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|sprintf
(paren
id|megaCfg-&gt;biosVer
comma
l_string|&quot;%c%d%d.%d%d&quot;
comma
id|megaCfg-&gt;productInfo.BiosVer
(braket
l_int|2
)braket
comma
id|megaCfg-&gt;productInfo.BiosVer
(braket
l_int|1
)braket
op_rshift
l_int|8
comma
id|megaCfg-&gt;productInfo.BiosVer
(braket
l_int|1
)braket
op_amp
l_int|0x0f
comma
id|megaCfg-&gt;productInfo.BiosVer
(braket
l_int|0
)braket
op_rshift
l_int|8
comma
id|megaCfg-&gt;productInfo.BiosVer
(braket
l_int|0
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
(paren
id|megaCfg-&gt;fwVer
comma
(paren
r_char
op_star
)paren
id|megaCfg-&gt;productInfo.FwVer
comma
l_int|4
)paren
suffix:semicolon
id|megaCfg-&gt;fwVer
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
id|megaCfg-&gt;biosVer
comma
(paren
r_char
op_star
)paren
id|megaCfg-&gt;productInfo.BiosVer
comma
l_int|4
)paren
suffix:semicolon
id|megaCfg-&gt;biosVer
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|megaCfg-&gt;support_ext_cdb
op_assign
id|mega_support_ext_cdb
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;megaraid: [%s:%s] detected %d logical drives&quot;
id|M_RD_CRLFSTR
comma
id|megaCfg-&gt;fwVer
comma
id|megaCfg-&gt;biosVer
comma
id|megaCfg-&gt;numldrv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;support_ext_cdb
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;megaraid: supports extended CDBs.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * I hope that I can unmap here, reason DMA transaction is not required any more&n;&t; * after this&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------&n; *&n; *                      Driver interface functions&n; *&n; *-------------------------------------------------------------------------*/
multiline_comment|/*----------------------------------------------------------&n; * Returns data to be displayed in /proc/scsi/megaraid/X&n; *----------------------------------------------------------*/
DECL|function|megaraid_proc_info
r_int
id|megaraid_proc_info
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|host_no
comma
r_int
id|inout
)paren
(brace
op_star
id|start
op_assign
id|buffer
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mega_findCard
r_static
r_int
id|mega_findCard
(paren
id|Scsi_Host_Template
op_star
id|pHostTmpl
comma
id|u16
id|pciVendor
comma
id|u16
id|pciDev
comma
r_int
id|flag
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
l_int|NULL
suffix:semicolon
id|u_char
id|pciBus
comma
id|pciDevFun
comma
id|megaIrq
suffix:semicolon
id|u16
id|magic
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|u32
id|magic64
suffix:semicolon
macro_line|#endif
r_int
id|i
suffix:semicolon
macro_line|#ifdef __LP64__
id|u64
id|megaBase
suffix:semicolon
macro_line|#else
id|u32
id|megaBase
suffix:semicolon
macro_line|#endif
id|u16
id|pciIdx
op_assign
l_int|0
suffix:semicolon
id|u16
id|numFound
op_assign
l_int|0
suffix:semicolon
id|u16
id|subsysid
comma
id|subsysvid
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,0)&t;/* 0x20100 */
r_while
c_loop
(paren
op_logical_neg
id|pcibios_find_device
(paren
id|pciVendor
comma
id|pciDev
comma
id|pciIdx
comma
op_amp
id|pciBus
comma
op_amp
id|pciDevFun
)paren
)paren
(brace
macro_line|#else
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,0)&t;/*0x20300 */
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#else
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_devices
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
(paren
id|pciVendor
comma
id|pciDev
comma
id|pdev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
(paren
id|pdev
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|pciBus
op_assign
id|pdev-&gt;bus-&gt;number
suffix:semicolon
id|pciDevFun
op_assign
id|pdev-&gt;devfn
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|flag
op_amp
id|BOARD_QUARTZ
)paren
op_logical_and
(paren
id|skip_id
op_eq
op_minus
l_int|1
)paren
)paren
(brace
id|pci_read_config_word
(paren
id|pdev
comma
id|PCI_CONF_AMISIG
comma
op_amp
id|magic
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|magic
op_ne
id|AMI_SIGNATURE
)paren
op_logical_and
(paren
id|magic
op_ne
id|AMI_SIGNATURE_471
)paren
)paren
(brace
id|pciIdx
op_increment
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* not an AMI board */
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|pci_read_config_dword
(paren
id|pdev
comma
id|PCI_CONF_AMISIG64
comma
op_amp
id|magic64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|magic64
op_eq
id|AMI_64BIT_SIGNATURE
)paren
id|flag
op_or_assign
id|BOARD_64BIT
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Hmmm...Should we not make this more modularized so that in future we dont add&n;&t;&t;   for each firmware */
r_if
c_cond
(paren
id|flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
multiline_comment|/* Check to see if this is a Dell PERC RAID controller model 466 */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,0)&t;/* 0x20100 */
id|pcibios_read_config_word
(paren
id|pciBus
comma
id|pciDevFun
comma
id|PCI_SUBSYSTEM_VENDOR_ID
comma
op_amp
id|subsysvid
)paren
suffix:semicolon
id|pcibios_read_config_word
(paren
id|pciBus
comma
id|pciDevFun
comma
id|PCI_SUBSYSTEM_ID
comma
op_amp
id|subsysid
)paren
suffix:semicolon
macro_line|#else
id|pci_read_config_word
(paren
id|pdev
comma
id|PCI_SUBSYSTEM_VENDOR_ID
comma
op_amp
id|subsysvid
)paren
suffix:semicolon
id|pci_read_config_word
(paren
id|pdev
comma
id|PCI_SUBSYSTEM_ID
comma
op_amp
id|subsysid
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 0
multiline_comment|/*&n;&t;&t;&t; * This routine is called with well know values and we&n;&t;&t;&t; * should not be getting what we have not asked.&n;&t;&t;&t; * Also, the check is not right. It should have been for&n;&t;&t;&t; * pci_vendor_id not subsysvid - AM&n;&t;&t;&t; */
multiline_comment|/* If we dont detect this valid subsystem vendor id&squot;s &n;&t;&t;&t;   we refuse to load the driver &n;&t;&t;&t;   PART of PC200X compliance&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|subsysvid
op_ne
id|AMI_SUBSYS_ID
)paren
op_logical_and
(paren
id|subsysvid
op_ne
id|DELL_SUBSYS_ID
)paren
op_logical_and
(paren
id|subsysvid
op_ne
id|HP_SUBSYS_ID
)paren
)paren
r_continue
suffix:semicolon
macro_line|#endif
)brace
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;megaraid: found 0x%4.04x:0x%4.04x:idx %d:bus %d:slot %d:func %d&bslash;n&quot;
comma
id|pciVendor
comma
id|pciDev
comma
id|pciIdx
comma
id|pciBus
comma
id|PCI_SLOT
(paren
id|pciDevFun
)paren
comma
id|PCI_FUNC
(paren
id|pciDevFun
)paren
)paren
suffix:semicolon
multiline_comment|/* Read the base port and IRQ from PCI */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,0)&t;/* 0x20100 */
id|pcibios_read_config_dword
(paren
id|pciBus
comma
id|pciDevFun
comma
id|PCI_BASE_ADDRESS_0
comma
(paren
id|u_int
op_star
)paren
op_amp
id|megaBase
)paren
suffix:semicolon
id|pcibios_read_config_byte
(paren
id|pciBus
comma
id|pciDevFun
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|megaIrq
)paren
suffix:semicolon
macro_line|#elif LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0)&t;/*0x20300 */
id|megaBase
op_assign
id|pdev-&gt;base_address
(braket
l_int|0
)braket
suffix:semicolon
id|megaIrq
op_assign
id|pdev-&gt;irq
suffix:semicolon
macro_line|#else
id|megaBase
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|megaIrq
op_assign
id|pdev-&gt;irq
suffix:semicolon
macro_line|#endif
id|pciIdx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|megaBase
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|megaBase
op_assign
(paren
r_int
)paren
id|ioremap
(paren
id|megaBase
comma
l_int|128
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|megaBase
)paren
r_continue
suffix:semicolon
)brace
r_else
(brace
id|megaBase
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|megaBase
op_add_assign
l_int|0x10
suffix:semicolon
)brace
multiline_comment|/* Initialize SCSI Host structure */
id|host
op_assign
id|scsi_register
(paren
id|pHostTmpl
comma
r_sizeof
(paren
id|mega_host_config
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_goto
id|err_unmap
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Comment the following initialization if you know &squot;max_sectors&squot; is&n;&t;&t; * not defined for this kernel.&n;&t;&t; * This field was introduced in Linus&squot;s kernel 2.4.7pre3 and it&n;&t;&t; * greatly increases the IO performance - AM&n;&t;&t; */
id|host-&gt;max_sectors
op_assign
l_int|1024
suffix:semicolon
id|scsi_set_pci_device
c_func
(paren
id|host
comma
id|pdev
)paren
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|memset
(paren
id|megaCfg
comma
l_int|0
comma
r_sizeof
(paren
id|mega_host_config
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;scsi%d : Found a MegaRAID controller at 0x%x, IRQ: %d&quot;
id|M_RD_CRLFSTR
comma
id|host-&gt;host_no
comma
(paren
id|u_int
)paren
id|megaBase
comma
id|megaIrq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|BOARD_64BIT
)paren
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;scsi%d : Enabling 64 bit support&bslash;n&quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
multiline_comment|/* Copy resource info into structure */
id|megaCfg-&gt;qCompletedH
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qPendingH
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qPendingT
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qFreeH
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qFreeT
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qFcnt
op_assign
l_int|0
suffix:semicolon
id|megaCfg-&gt;qPcnt
op_assign
l_int|0
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_assign
l_int|0
suffix:semicolon
id|megaCfg-&gt;lock_free
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|megaCfg-&gt;lock_pend
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|megaCfg-&gt;lock_scsicmd
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|megaCfg-&gt;flag
op_assign
id|flag
suffix:semicolon
id|megaCfg-&gt;int_qh
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;int_qt
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;int_qlen
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|megaCfg-&gt;dev
op_assign
id|pdev
suffix:semicolon
macro_line|#endif
id|megaCfg-&gt;host
op_assign
id|host
suffix:semicolon
id|megaCfg-&gt;base
op_assign
id|megaBase
suffix:semicolon
id|megaCfg-&gt;host-&gt;irq
op_assign
id|megaIrq
suffix:semicolon
id|megaCfg-&gt;host-&gt;io_port
op_assign
id|megaBase
suffix:semicolon
id|megaCfg-&gt;host-&gt;n_io_port
op_assign
l_int|16
suffix:semicolon
id|megaCfg-&gt;host-&gt;unique_id
op_assign
(paren
id|pciBus
op_lshift
l_int|8
)paren
op_or
id|pciDevFun
suffix:semicolon
id|megaCtlrs
(braket
id|numCtlrs
)braket
op_assign
id|megaCfg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flag
op_amp
id|BOARD_QUARTZ
)paren
)paren
(brace
multiline_comment|/* Request our IO Range */
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|megaBase
comma
l_int|16
comma
l_string|&quot;megaraid&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;megaraid: Couldn&squot;t register I/O range!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_unregister
suffix:semicolon
)brace
)brace
multiline_comment|/* Request our IRQ */
r_if
c_cond
(paren
id|request_irq
(paren
id|megaIrq
comma
id|megaraid_isr
comma
id|SA_SHIRQ
comma
l_string|&quot;megaraid&quot;
comma
id|megaCfg
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;megaraid: Couldn&squot;t register IRQ %d!&bslash;n&quot;
comma
id|megaIrq
)paren
suffix:semicolon
r_goto
id|err_release
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
multiline_comment|/*&n;&t;&t; * unmap while releasing the driver, Is it required to be &n;&t;&t; * PCI_DMA_BIDIRECTIONAL &n;&t;&t;*/
id|megaCfg-&gt;mailbox64ptr
op_assign
id|pci_alloc_consistent
(paren
id|megaCfg-&gt;dev
comma
r_sizeof
(paren
id|mega_mailbox64
)paren
comma
op_amp
(paren
id|megaCfg-&gt;dma_handle64
)paren
)paren
suffix:semicolon
id|mega_register_mailbox
(paren
id|megaCfg
comma
id|megaCfg-&gt;dma_handle64
)paren
suffix:semicolon
macro_line|#else
id|mega_register_mailbox
(paren
id|megaCfg
comma
id|virt_to_bus
(paren
(paren
r_void
op_star
)paren
op_amp
id|megaCfg
op_member_access_from_pointer
id|mailbox64
)paren
)paren
suffix:semicolon
macro_line|#endif
id|mega_i_query_adapter
(paren
id|megaCfg
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|subsysid
op_eq
l_int|0x1111
)paren
op_logical_and
(paren
id|subsysvid
op_eq
l_int|0x1111
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Which firmware&n;&t;&t;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|megaCfg-&gt;fwVer
comma
l_string|&quot;3.00&quot;
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
c_func
(paren
id|megaCfg-&gt;fwVer
comma
l_string|&quot;3.01&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;megaraid: Your  card is a Dell PERC 2/SC RAID controller &quot;
l_string|&quot;with  firmware&bslash;nmegaraid: 3.00 or 3.01.  This driver is &quot;
l_string|&quot;known to have corruption issues&bslash;nmegaraid: with those &quot;
l_string|&quot;firmware versions on this specific card.  In order&bslash;n&quot;
l_string|&quot;megaraid: to protect your data, please upgrade your &quot;
l_string|&quot;firmware to version&bslash;nmegaraid: 3.10 or later, available &quot;
l_string|&quot;from the Dell Technical Support web&bslash;nmegaraid: site at&bslash;n&quot;
l_string|&quot;http://support.dell.com/us/en/filelib/download/&quot;
l_string|&quot;index.asp?fileid=2940&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * If we have a HP 1M(0x60E7)/2M(0x60E8) controller with&n;&t;&t; * firmware H.01.07 or H.01.08, disable 64 bit support,&n;&t;&t; * since this firmware cannot handle 64 bit addressing&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|subsysvid
op_eq
id|HP_SUBSYS_ID
)paren
op_logical_and
(paren
(paren
id|subsysid
op_eq
l_int|0x60E7
)paren
op_logical_or
(paren
id|subsysid
op_eq
l_int|0x60E8
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * which firmware&n;&t;&t;&t; */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|megaCfg-&gt;fwVer
comma
l_string|&quot;H01.07&quot;
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
c_func
(paren
id|megaCfg-&gt;fwVer
comma
l_string|&quot;H01.08&quot;
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;megaraid: Firmware H.01.07 or H.01.08 on 1M/2M &quot;
l_string|&quot;controllers&bslash;nmegaraid: do not support 64 bit &quot;
l_string|&quot;addressing.&bslash;n&quot;
l_string|&quot;megaraid: DISABLING 64 bit support.&bslash;n&quot;
)paren
suffix:semicolon
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|BOARD_64BIT
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mega_is_bios_enabled
(paren
id|megaCfg
)paren
)paren
(brace
id|mega_hbas
(braket
id|numCtlrs
)braket
dot
id|is_bios_enabled
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Find out which channel is raid and which is scsi&n;&t;&t; */
id|mega_enum_raid_scsi
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|megaCfg-&gt;productInfo.SCSIChanPresent
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|IS_RAID_CH
c_func
(paren
id|i
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;megaraid: channel[%d] is raid.&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;megaraid: channel[%d] is scsi.&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Find out if a logical drive is set as the boot drive. If there is&n;&t;&t; * one, will make that as the first logical drive.&n;&t;&t; */
id|mega_get_boot_ldrv
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
id|mega_hbas
(braket
id|numCtlrs
)braket
dot
id|hostdata_addr
op_assign
id|megaCfg
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Do we support random deletion and addition of logical drives&n;&t;&t; */
id|megaCfg-&gt;read_ldidmap
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set it after first logdrv delete cmd */
id|megaCfg-&gt;support_random_del
op_assign
id|mega_support_random_del
c_func
(paren
id|megaCfg
)paren
suffix:semicolon
multiline_comment|/* Initialize SCBs */
r_if
c_cond
(paren
id|mega_init_scb
(paren
id|megaCfg
)paren
)paren
(brace
id|pci_free_consistent
(paren
id|megaCfg-&gt;dev
comma
r_sizeof
(paren
id|mega_mailbox64
)paren
comma
(paren
r_void
op_star
)paren
id|megaCfg-&gt;mailbox64ptr
comma
id|megaCfg-&gt;dma_handle64
)paren
suffix:semicolon
id|scsi_unregister
(paren
id|host
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Fill in the structure which needs to be passed back to the&n;&t;&t; * application when it does an ioctl() for controller related&n;&t;&t; * information.&n;&t;&t; */
id|i
op_assign
id|numCtlrs
suffix:semicolon
id|numCtlrs
op_increment
suffix:semicolon
id|mcontroller
(braket
id|i
)braket
dot
id|base
op_assign
id|megaBase
suffix:semicolon
id|mcontroller
(braket
id|i
)braket
dot
id|irq
op_assign
id|megaIrq
suffix:semicolon
id|mcontroller
(braket
id|i
)braket
dot
id|numldrv
op_assign
id|megaCfg-&gt;numldrv
suffix:semicolon
id|mcontroller
(braket
id|i
)braket
dot
id|pcibus
op_assign
id|pciBus
suffix:semicolon
id|mcontroller
(braket
id|i
)braket
dot
id|pcidev
op_assign
id|pciDev
suffix:semicolon
id|mcontroller
(braket
id|i
)braket
dot
id|pcifun
op_assign
id|PCI_FUNC
(paren
id|pciDevFun
)paren
suffix:semicolon
id|mcontroller
(braket
id|i
)braket
dot
id|pciid
op_assign
id|pciIdx
suffix:semicolon
id|mcontroller
(braket
id|i
)braket
dot
id|pcivendor
op_assign
id|pciVendor
suffix:semicolon
id|mcontroller
(braket
id|i
)braket
dot
id|pcislot
op_assign
id|PCI_SLOT
(paren
id|pciDevFun
)paren
suffix:semicolon
id|mcontroller
(braket
id|i
)braket
dot
id|uid
op_assign
(paren
id|pciBus
op_lshift
l_int|8
)paren
op_or
id|pciDevFun
suffix:semicolon
id|numFound
op_increment
suffix:semicolon
multiline_comment|/* Set the Mode of addressing to 64 bit */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
r_if
c_cond
(paren
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_64BIT
)paren
op_logical_and
id|BITS_PER_LONG
op_eq
l_int|64
)paren
macro_line|#ifdef __LP64__
id|pdev-&gt;dma_mask
op_assign
l_int|0xffffffffffffffff
suffix:semicolon
macro_line|#else
id|pdev-&gt;dma_mask
op_assign
l_int|0xffffffff
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_continue
suffix:semicolon
id|err_release
suffix:colon
r_if
c_cond
(paren
id|flag
op_amp
id|BOARD_QUARTZ
)paren
id|release_region
(paren
id|megaBase
comma
l_int|16
)paren
suffix:semicolon
id|err_unregister
suffix:colon
id|scsi_unregister
(paren
id|host
)paren
suffix:semicolon
id|err_unmap
suffix:colon
r_if
c_cond
(paren
id|flag
op_amp
id|BOARD_QUARTZ
)paren
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|megaBase
)paren
suffix:semicolon
)brace
r_return
id|numFound
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------&n; * Detects if a megaraid controller exists in this system&n; *---------------------------------------------------------*/
DECL|function|megaraid_detect
r_int
id|megaraid_detect
(paren
id|Scsi_Host_Template
op_star
id|pHostTmpl
)paren
(brace
r_int
id|ctlridx
op_assign
l_int|0
comma
id|count
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0)&t;/*0x20300 */
id|pHostTmpl-&gt;proc_dir
op_assign
op_amp
id|proc_scsi_megaraid
suffix:semicolon
macro_line|#else
id|pHostTmpl-&gt;proc_name
op_assign
l_string|&quot;megaraid&quot;
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,0)&t;/* 0x20100 */
r_if
c_cond
(paren
op_logical_neg
id|pcibios_present
(paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;megaraid: PCI bios not present.&quot;
id|M_RD_CRLFSTR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|skip_id
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|megaraid
op_logical_and
op_logical_neg
id|strncmp
(paren
id|megaraid
comma
l_string|&quot;skip&quot;
comma
id|strlen
(paren
l_string|&quot;skip&quot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|megaraid
(braket
l_int|4
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|skip_id
op_assign
id|megaraid
(braket
l_int|4
)braket
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|megaraid
(braket
l_int|5
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|skip_id
op_assign
(paren
id|skip_id
op_star
l_int|10
)paren
op_plus
(paren
id|megaraid
(braket
l_int|5
)braket
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
)brace
)brace
id|skip_id
op_assign
(paren
id|skip_id
OG
l_int|15
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
id|skip_id
suffix:semicolon
)brace
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;megaraid: &quot;
id|MEGARAID_VERSION
)paren
suffix:semicolon
id|memset
(paren
id|mega_hbas
comma
l_int|0
comma
r_sizeof
(paren
id|mega_hbas
)paren
)paren
suffix:semicolon
id|count
op_add_assign
id|mega_findCard
(paren
id|pHostTmpl
comma
id|PCI_VENDOR_ID_AMI
comma
id|PCI_DEVICE_ID_AMI_MEGARAID
comma
l_int|0
)paren
suffix:semicolon
id|count
op_add_assign
id|mega_findCard
(paren
id|pHostTmpl
comma
id|PCI_VENDOR_ID_AMI
comma
id|PCI_DEVICE_ID_AMI_MEGARAID2
comma
l_int|0
)paren
suffix:semicolon
id|count
op_add_assign
id|mega_findCard
(paren
id|pHostTmpl
comma
l_int|0x8086
comma
id|PCI_DEVICE_ID_AMI_MEGARAID3
comma
id|BOARD_QUARTZ
)paren
suffix:semicolon
id|count
op_add_assign
id|mega_findCard
(paren
id|pHostTmpl
comma
id|PCI_VENDOR_ID_AMI
comma
id|PCI_DEVICE_ID_AMI_MEGARAID3
comma
id|BOARD_QUARTZ
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_if
c_cond
(paren
id|count
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,0)&t;/*0x20300 */
id|mega_proc_dir_entry
op_assign
id|proc_mkdir
(paren
l_string|&quot;megaraid&quot;
comma
op_amp
id|proc_root
)paren
suffix:semicolon
macro_line|#else
id|mega_proc_dir_entry
op_assign
id|create_proc_entry
(paren
l_string|&quot;megaraid&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
op_amp
id|proc_root
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|mega_proc_dir_entry
)paren
id|printk
(paren
l_string|&quot;megaraid: failed to create megaraid root&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|ctlridx
op_assign
l_int|0
suffix:semicolon
id|ctlridx
OL
id|count
suffix:semicolon
id|ctlridx
op_increment
)paren
id|mega_create_proc_entry
(paren
id|ctlridx
comma
id|mega_proc_dir_entry
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Register the driver as a character device, for applications to access&n;&t; * it for ioctls.&n;&t; * Ideally, this should go in the init_module() routine, but since it is&n;&t; * hidden in the file &quot;scsi_module.c&quot; ( included in the end ), we define&n;&t; * it here&n;&t; * First argument (major) to register_chrdev implies a dynamic major&n;&t; * number allocation.&n;&t; */
r_if
c_cond
(paren
id|count
)paren
(brace
id|major
op_assign
id|register_chrdev
(paren
l_int|0
comma
l_string|&quot;megadev&quot;
comma
op_amp
id|megadev_fops
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Register the Shutdown Notification hook in kernel&n;&t;&t; */
r_if
c_cond
(paren
id|register_reboot_notifier
(paren
op_amp
id|mega_notifier
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;MegaRAID Shutdown routine not registered!!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|init_MUTEX
(paren
op_amp
id|mimd_entry_mtx
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------&n; * Release the controller&squot;s resources&n; *---------------------------------------------------------------------*/
DECL|function|megaraid_release
r_int
id|megaraid_release
(paren
r_struct
id|Scsi_Host
op_star
id|pSHost
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|u_char
id|mboxData
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|pSHost-&gt;hostdata
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mboxData
suffix:semicolon
multiline_comment|/* Flush cache to disk */
id|memset
(paren
id|mbox
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|mboxData
(braket
l_int|0
)braket
op_assign
l_int|0xA
suffix:semicolon
id|free_irq
(paren
id|megaCfg-&gt;host-&gt;irq
comma
id|megaCfg
)paren
suffix:semicolon
multiline_comment|/* Must be freed first, otherwise&n;&t;&t;&t;&t;&t;&t;   extra interrupt is generated */
multiline_comment|/* Issue a blocking (interrupts disabled) command to the card */
id|megaIssueCmd
(paren
id|megaCfg
comma
id|mboxData
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Free our resources */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
(brace
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|megaCfg-&gt;base
)paren
suffix:semicolon
)brace
r_else
(brace
id|release_region
(paren
id|megaCfg-&gt;host-&gt;io_port
comma
l_int|16
)paren
suffix:semicolon
)brace
id|mega_freeSgList
(paren
id|megaCfg
)paren
suffix:semicolon
id|pci_free_consistent
(paren
id|megaCfg-&gt;dev
comma
r_sizeof
(paren
id|mega_mailbox64
)paren
comma
(paren
r_void
op_star
)paren
id|megaCfg-&gt;mailbox64ptr
comma
id|megaCfg-&gt;dma_handle64
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_if
c_cond
(paren
id|megaCfg-&gt;controller_proc_dir_entry
)paren
(brace
id|remove_proc_entry
(paren
l_string|&quot;stat&quot;
comma
id|megaCfg-&gt;controller_proc_dir_entry
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;status&quot;
comma
id|megaCfg-&gt;controller_proc_dir_entry
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;config&quot;
comma
id|megaCfg-&gt;controller_proc_dir_entry
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;mailbox&quot;
comma
id|megaCfg-&gt;controller_proc_dir_entry
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numCtlrs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|buf
(braket
l_int|12
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
id|sprintf
(paren
id|buf
comma
l_string|&quot;%d&quot;
comma
id|i
)paren
suffix:semicolon
id|remove_proc_entry
(paren
id|buf
comma
id|mega_proc_dir_entry
)paren
suffix:semicolon
)brace
id|remove_proc_entry
(paren
l_string|&quot;megaraid&quot;
comma
op_amp
id|proc_root
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; *&t;Release the controller memory. A word of warning this frees&n;&t; *&t;hostdata and that includes megaCfg-&gt; so be careful what you&n;&t; *&t;dereference beyond this point&n;&t; */
id|scsi_unregister
(paren
id|pSHost
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Unregister the character device interface to the driver. Ideally this&n;&t; * should have been done in cleanup_module routine. Since this is hidden&n;&t; * in file &quot;scsi_module.c&quot;, we do it here.&n;&t; * major is the major number of the character device returned by call to&n;&t; * register_chrdev() routine.&n;&t; */
id|unregister_chrdev
(paren
id|major
comma
l_string|&quot;megadev&quot;
)paren
suffix:semicolon
id|unregister_reboot_notifier
(paren
op_amp
id|mega_notifier
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mega_is_bios_enabled
r_static
r_int
id|mega_is_bios_enabled
(paren
id|mega_host_config
op_star
id|megacfg
)paren
(brace
id|mega_mailbox
op_star
id|mboxpnt
suffix:semicolon
r_int
r_char
id|mbox
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|mboxpnt
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mbox
suffix:semicolon
id|memset
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|mbox
)paren
)paren
suffix:semicolon
id|memset
(paren
(paren
r_void
op_star
)paren
id|megacfg-&gt;mega_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|megacfg-&gt;mega_buffer
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * issue command to find out if the BIOS is enabled for this controller&n;&t; */
id|mbox
(braket
l_int|0
)braket
op_assign
id|IS_BIOS_ENABLED
suffix:semicolon
id|mbox
(braket
l_int|2
)braket
op_assign
id|GET_BIOS
suffix:semicolon
id|mboxpnt-&gt;xferaddr
op_assign
id|virt_to_bus
(paren
(paren
r_void
op_star
)paren
id|megacfg-&gt;mega_buffer
)paren
suffix:semicolon
id|ret
op_assign
id|megaIssueCmd
(paren
id|megacfg
comma
id|mbox
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_return
(paren
op_star
(paren
r_char
op_star
)paren
id|megacfg-&gt;mega_buffer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Find out what channels are RAID/SCSI&n; */
r_void
DECL|function|mega_enum_raid_scsi
id|mega_enum_raid_scsi
c_func
(paren
id|mega_host_config
op_star
id|megacfg
)paren
(brace
id|mega_mailbox
op_star
id|mboxp
suffix:semicolon
r_int
r_char
id|mbox
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|dma_addr_t
id|dma_handle
suffix:semicolon
macro_line|#endif
id|mboxp
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mbox
suffix:semicolon
id|memset
c_func
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|mbox
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * issue command to find out what channels are raid/scsi&n;&t; */
id|mbox
(braket
l_int|0
)braket
op_assign
id|CHNL_CLASS
suffix:semicolon
id|mbox
(braket
l_int|2
)braket
op_assign
id|GET_CHNL_CLASS
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|megacfg-&gt;mega_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|megacfg-&gt;mega_buffer
)paren
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|dma_handle
op_assign
id|pci_map_single
c_func
(paren
id|megacfg-&gt;dev
comma
(paren
r_void
op_star
)paren
id|megacfg-&gt;mega_buffer
comma
(paren
l_int|2
op_star
l_int|1024L
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|mboxp-&gt;xferaddr
op_assign
id|dma_handle
suffix:semicolon
macro_line|#else
id|mboxp-&gt;xferaddr
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|megacfg-&gt;mega_buffer
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Non-ROMB firware fail this command, so all channels&n;&t; * must be shown RAID&n;&t; */
r_if
c_cond
(paren
id|megaIssueCmd
c_func
(paren
id|megacfg
comma
id|mbox
comma
l_int|NULL
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|mega_ch_class
op_assign
op_star
(paren
(paren
r_char
op_star
)paren
id|megacfg-&gt;mega_buffer
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NVIRT_CHAN
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* logical drives channel is RAID */
id|mega_ch_class
op_or_assign
(paren
l_int|0x01
op_lshift
(paren
id|megacfg-&gt;productInfo.SCSIChanPresent
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|mega_ch_class
op_assign
l_int|0xFF
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|pci_unmap_single
c_func
(paren
id|megacfg-&gt;dev
comma
id|dma_handle
comma
(paren
l_int|2
op_star
l_int|1024L
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * get the boot logical drive number if enabled&n; */
r_void
DECL|function|mega_get_boot_ldrv
id|mega_get_boot_ldrv
c_func
(paren
id|mega_host_config
op_star
id|megacfg
)paren
(brace
id|mega_mailbox
op_star
id|mboxp
suffix:semicolon
r_int
r_char
id|mbox
(braket
l_int|16
)braket
suffix:semicolon
r_struct
id|private_bios_data
op_star
id|prv_bios_data
suffix:semicolon
id|u16
id|cksum
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|cksum_p
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|dma_addr_t
id|dma_handle
suffix:semicolon
macro_line|#endif
id|mboxp
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mbox
suffix:semicolon
id|memset
c_func
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|mbox
)paren
)paren
suffix:semicolon
id|mbox
(braket
l_int|0
)braket
op_assign
id|BIOS_PVT_DATA
suffix:semicolon
id|mbox
(braket
l_int|2
)braket
op_assign
id|GET_BIOS_PVT_DATA
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|megacfg-&gt;mega_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|megacfg-&gt;mega_buffer
)paren
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|dma_handle
op_assign
id|pci_map_single
c_func
(paren
id|megacfg-&gt;dev
comma
(paren
r_void
op_star
)paren
id|megacfg-&gt;mega_buffer
comma
(paren
l_int|2
op_star
l_int|1024L
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|mboxp-&gt;xferaddr
op_assign
id|dma_handle
suffix:semicolon
macro_line|#else
id|mboxp-&gt;xferaddr
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|megacfg-&gt;mega_buffer
)paren
suffix:semicolon
macro_line|#endif
id|megacfg-&gt;boot_ldrv_enabled
op_assign
l_int|0
suffix:semicolon
id|megacfg-&gt;boot_ldrv
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|megaIssueCmd
c_func
(paren
id|megacfg
comma
id|mbox
comma
l_int|NULL
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|prv_bios_data
op_assign
(paren
r_struct
id|private_bios_data
op_star
)paren
id|megacfg-&gt;mega_buffer
suffix:semicolon
id|cksum
op_assign
l_int|0
suffix:semicolon
id|cksum_p
op_assign
(paren
r_char
op_star
)paren
id|prv_bios_data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|14
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cksum
op_add_assign
(paren
id|u16
)paren
(paren
op_star
id|cksum_p
op_increment
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|prv_bios_data-&gt;cksum
op_eq
(paren
id|u16
)paren
(paren
l_int|0
op_minus
id|cksum
)paren
)paren
(brace
id|megacfg-&gt;boot_ldrv_enabled
op_assign
l_int|1
suffix:semicolon
id|megacfg-&gt;boot_ldrv
op_assign
id|prv_bios_data-&gt;boot_ldrv
suffix:semicolon
)brace
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|pci_unmap_single
c_func
(paren
id|megacfg-&gt;dev
comma
id|dma_handle
comma
(paren
l_int|2
op_star
l_int|1024L
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|mega_freeSgList
r_static
r_inline
r_void
id|mega_freeSgList
(paren
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|megaCfg-&gt;max_cmds
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;scbList
(braket
id|i
)braket
dot
id|sgList
)paren
id|pci_free_consistent
(paren
id|megaCfg-&gt;dev
comma
r_sizeof
(paren
id|mega_64sglist
)paren
op_star
id|MAX_SGLIST
comma
id|megaCfg-&gt;scbList
(braket
id|i
)braket
dot
id|sgList
comma
id|megaCfg-&gt;scbList
(braket
id|i
)braket
dot
id|dma_sghandle64
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,4,0)&t;/* 0x020400 */
id|kfree
(paren
id|megaCfg-&gt;scbList
(braket
id|i
)braket
dot
id|sgList
)paren
suffix:semicolon
multiline_comment|/* free sgList */
macro_line|#endif
)brace
)brace
multiline_comment|/*----------------------------------------------&n; * Get information about the card/driver&n; *----------------------------------------------*/
DECL|function|megaraid_info
r_const
r_char
op_star
id|megaraid_info
(paren
r_struct
id|Scsi_Host
op_star
id|pSHost
)paren
(brace
r_static
r_char
id|buffer
(braket
l_int|512
)braket
suffix:semicolon
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|pSHost-&gt;hostdata
suffix:semicolon
id|sprintf
(paren
id|buffer
comma
l_string|&quot;LSI Logic MegaRAID %s %d commands %d targs %d chans %d luns&quot;
comma
id|megaCfg-&gt;fwVer
comma
id|megaCfg-&gt;productInfo.MaxConcCmds
comma
id|megaCfg-&gt;host-&gt;max_id
comma
id|megaCfg-&gt;host-&gt;max_channel
comma
id|megaCfg-&gt;host-&gt;max_lun
)paren
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * Perform a SCSI command&n; * Mailbox area:&n; *   00 01 command&n; *   01 01 command id&n; *   02 02 # of sectors&n; *   04 04 logical bus address&n; *   08 04 physical buffer address&n; *   0C 01 logical drive #&n; *   0D 01 length of scatter/gather list&n; *   0E 01 reserved&n; *   0F 01 mailbox busy&n; *   10 01 numstatus byte&n; *   11 01 status byte&n; *-----------------------------------------------------------------*/
DECL|function|megaraid_queue
r_int
id|megaraid_queue
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|pktComp
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|DRIVER_LOCK_T
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|mega_scb
op_star
id|pScb
suffix:semicolon
r_char
op_star
id|user_area
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|DRIVER_LOCK
(paren
id|megaCfg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|megaCfg-&gt;flag
op_amp
(paren
l_int|1L
op_lshift
id|SCpnt-&gt;device-&gt;channel
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;channel
OL
id|megaCfg-&gt;productInfo.SCSIChanPresent
)paren
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;scsi%d: scanning channel %d for devices.&bslash;n&quot;
comma
id|megaCfg-&gt;host-&gt;host_no
comma
id|SCpnt-&gt;device-&gt;channel
)paren
suffix:semicolon
r_else
id|printk
(paren
id|KERN_NOTICE
l_string|&quot;scsi%d: scanning virtual channel %d for logical drives.&bslash;n&quot;
comma
id|megaCfg-&gt;host-&gt;host_no
comma
id|SCpnt-&gt;device-&gt;channel
op_minus
id|megaCfg-&gt;productInfo.SCSIChanPresent
op_plus
l_int|1
)paren
suffix:semicolon
id|megaCfg-&gt;flag
op_or_assign
(paren
l_int|1L
op_lshift
id|SCpnt-&gt;device-&gt;channel
)paren
suffix:semicolon
)brace
id|SCpnt-&gt;scsi_done
op_assign
id|pktComp
suffix:semicolon
r_if
c_cond
(paren
id|mega_driver_ioctl
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* If driver in abort or reset.. cancel this command */
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_ABORT
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ABORT
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Add Scsi_Command to end of completed queue */
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_increment
suffix:semicolon
id|DRIVER_UNLOCK
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_RESET
)paren
(brace
id|SCpnt-&gt;result
op_assign
(paren
id|DID_RESET
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Add Scsi_Command to end of completed queue */
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_increment
suffix:semicolon
id|DRIVER_UNLOCK
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|megaCfg-&gt;flag
op_or_assign
id|IN_QUEUE
suffix:semicolon
multiline_comment|/* Allocate and build a SCB request */
r_if
c_cond
(paren
(paren
id|pScb
op_assign
id|mega_build_cmd
(paren
id|megaCfg
comma
id|SCpnt
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t; * Check if the HBA is in quiescent state, e.g., during a delete&n;&t;&t; * logical drive opertion. If it is, queue the commands in the&n;&t;&t; * internal queue until the delete operation is complete.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|megaCfg-&gt;quiescent
)paren
(brace
multiline_comment|/* Add SCB to the head of the pending queue */
r_if
c_cond
(paren
id|megaCfg-&gt;qPendingH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qPendingH
op_assign
id|megaCfg-&gt;qPendingT
op_assign
id|pScb
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qPendingT-&gt;next
op_assign
id|pScb
suffix:semicolon
id|megaCfg-&gt;qPendingT
op_assign
id|pScb
suffix:semicolon
)brace
id|megaCfg-&gt;qPendingT-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qPcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mega_runpendq
(paren
id|megaCfg
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|DRIVER_UNLOCK
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Add SCB to the internal queue */
r_if
c_cond
(paren
id|megaCfg-&gt;int_qh
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;int_qh
op_assign
id|megaCfg-&gt;int_qt
op_assign
id|pScb
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;int_qt-&gt;next
op_assign
id|pScb
suffix:semicolon
id|megaCfg-&gt;int_qt
op_assign
id|pScb
suffix:semicolon
)brace
id|megaCfg-&gt;int_qt-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;int_qlen
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pScb-&gt;SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|M_RD_IOCTL_CMD_NEW
)paren
(brace
id|init_MUTEX_LOCKED
(paren
op_amp
id|pScb-&gt;ioctl_sem
)paren
suffix:semicolon
id|IO_UNLOCK_IRQ
c_func
(paren
id|megaCfg-&gt;host
)paren
suffix:semicolon
id|down
(paren
op_amp
id|pScb-&gt;ioctl_sem
)paren
suffix:semicolon
id|user_area
op_assign
(paren
r_char
op_star
)paren
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|pScb-&gt;SCpnt-&gt;cmnd
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|user_area
comma
id|pScb-&gt;buff_ptr
comma
id|pScb-&gt;iDataSize
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;megaraid: Error copying ioctl return value to user buffer.&bslash;n&quot;
)paren
suffix:semicolon
id|pScb-&gt;SCpnt-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
id|IO_LOCK_IRQ
c_func
(paren
id|megaCfg-&gt;host
)paren
suffix:semicolon
id|DRIVER_LOCK
(paren
id|megaCfg
)paren
suffix:semicolon
id|kfree
(paren
id|pScb-&gt;buff_ptr
)paren
suffix:semicolon
id|pScb-&gt;buff_ptr
op_assign
l_int|NULL
suffix:semicolon
id|mega_cmd_done
(paren
id|megaCfg
comma
id|pScb
comma
id|pScb-&gt;SCpnt-&gt;result
)paren
suffix:semicolon
id|mega_rundoneq
(paren
id|megaCfg
)paren
suffix:semicolon
id|mega_runpendq
(paren
id|megaCfg
)paren
suffix:semicolon
id|DRIVER_UNLOCK
(paren
id|megaCfg
)paren
suffix:semicolon
)brace
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_QUEUE
suffix:semicolon
)brace
id|DRIVER_UNLOCK
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n; * Issue a blocking command to the controller&n; *----------------------------------------------------------------------*/
DECL|variable|internal_done_flag
r_volatile
r_static
r_int
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
DECL|variable|internal_done_errcode
r_volatile
r_static
r_int
id|internal_done_errcode
op_assign
l_int|0
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
(paren
id|internal_wait
)paren
suffix:semicolon
DECL|function|internal_done
r_static
r_void
id|internal_done
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|internal_done_errcode
op_assign
id|SCpnt-&gt;result
suffix:semicolon
id|internal_done_flag
op_increment
suffix:semicolon
id|wake_up
(paren
op_amp
id|internal_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* shouldn&squot;t be used, but included for completeness */
DECL|function|megaraid_command
r_int
id|megaraid_command
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|internal_done_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Queue command, and wait until it has completed */
id|megaraid_queue
(paren
id|SCpnt
comma
id|internal_done
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|internal_done_flag
)paren
(brace
id|interruptible_sleep_on
(paren
op_amp
id|internal_wait
)paren
suffix:semicolon
)brace
r_return
id|internal_done_errcode
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------&n; * Abort a previous SCSI request&n; *---------------------------------------------------------------------*/
DECL|function|megaraid_abort
r_int
id|megaraid_abort
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/*, idx; */
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|rc
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|megaCfg-&gt;flag
op_or_assign
id|IN_ABORT
suffix:semicolon
r_for
c_loop
(paren
id|pScb
op_assign
id|megaCfg-&gt;qPendingH
suffix:semicolon
id|pScb
suffix:semicolon
id|pScb
op_assign
id|pScb-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pScb-&gt;SCpnt
op_eq
id|SCpnt
)paren
(brace
multiline_comment|/* Found an aborting command */
macro_line|#if DEBUG
id|showMbox
(paren
id|pScb
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * If the command is queued to be issued to the firmware, abort the scsi cmd,&n;&t; * If the command is already aborted in a previous call to the _abort entry&n;&t; *  point, return SCSI_ABORT_SNOOZE, suggesting a reset.&n;&t; * If the command is issued to the firmware, which might complete after&n;&t; *  some time, we will mark the scb as aborted, and return to the mid layer,&n;&t; *  that abort could not be done.&n;&t; *  In the ISR, when this command actually completes, we will perform a normal&n;&t; *  completion.&n;&t; *&n;&t; * Oct 27, 1999&n;&t; */
r_switch
c_cond
(paren
id|pScb-&gt;state
)paren
(brace
r_case
id|SCB_ABORTED
suffix:colon
multiline_comment|/* Already aborted */
id|rc
op_assign
id|SCSI_ABORT_SNOOZE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCB_ISSUED
suffix:colon
multiline_comment|/* Waiting on ISR result */
id|rc
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
id|pScb-&gt;state
op_assign
id|SCB_ABORTED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCB_ACTIVE
suffix:colon
multiline_comment|/* still on the pending queue */
id|mega_freeSCB
(paren
id|megaCfg
comma
id|pScb
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|DID_ABORT
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
(brace
id|megaCfg-&gt;qCompletedH
op_assign
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
r_else
(brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt
suffix:semicolon
id|megaCfg-&gt;qCompletedT
op_assign
id|SCpnt
suffix:semicolon
)brace
id|megaCfg-&gt;qCompletedT-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_increment
suffix:semicolon
id|rc
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;megaraid_abort: unknown command state!!&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_ABORT
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|IN_QUEUE
)paren
id|printk
(paren
l_string|&quot;ma:flag is in queue&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
op_eq
l_int|NULL
)paren
id|printk
(paren
l_string|&quot;ma:qchead == null&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * This is required here to complete any completed requests to be communicated&n;&t; * over to the mid layer.&n;&t; * Calling just mega_rundoneq() did not work.&n;&t; */
r_if
c_cond
(paren
id|megaCfg-&gt;qCompletedH
)paren
(brace
id|SCpnt
op_assign
id|megaCfg-&gt;qCompletedH
suffix:semicolon
id|megaCfg-&gt;qCompletedH
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|SCpnt-&gt;host_scribble
suffix:semicolon
id|megaCfg-&gt;qCcnt
op_decrement
suffix:semicolon
id|SCpnt-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
multiline_comment|/* Callback */
id|callDone
(paren
id|SCpnt
)paren
suffix:semicolon
)brace
id|mega_rundoneq
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------&n; * Reset a previous SCSI request&n; *---------------------------------------------------------------------*/
DECL|function|megaraid_reset
r_int
id|megaraid_reset
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
r_int
id|rstflags
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|mega_scb
op_star
id|pScb
suffix:semicolon
id|rc
op_assign
id|SCSI_RESET_NOT_RUNNING
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|megaCfg-&gt;flag
op_or_assign
id|IN_RESET
suffix:semicolon
id|printk
(paren
l_string|&quot;megaraid_RESET: %.08lx cmd=%.02x &lt;c=%d.t=%d.l=%d&gt;, flag = %x&bslash;n&quot;
comma
id|SCpnt-&gt;serial_number
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;device-&gt;channel
comma
id|SCpnt-&gt;device-&gt;id
comma
id|SCpnt-&gt;device-&gt;lun
comma
id|rstflags
)paren
suffix:semicolon
id|TRACE
(paren
(paren
l_string|&quot;RESET: %.08lx %.02x &lt;%d.%d.%d&gt;&bslash;n&quot;
comma
id|SCpnt-&gt;serial_number
comma
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
comma
id|SCpnt-&gt;device-&gt;channel
comma
id|SCpnt-&gt;device-&gt;id
comma
id|SCpnt-&gt;device-&gt;lun
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Walk list of SCBs for any that are still outstanding&n;&t; */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|megaCfg-&gt;max_cmds
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|state
op_ne
id|SCB_FREE
)paren
(brace
id|SCpnt
op_assign
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
dot
id|SCpnt
suffix:semicolon
id|pScb
op_assign
op_amp
id|megaCfg-&gt;scbList
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_ne
l_int|NULL
)paren
(brace
id|pScb-&gt;state
op_assign
id|SCB_RESET
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|megaCfg-&gt;flag
op_and_assign
op_complement
id|IN_RESET
suffix:semicolon
id|mega_rundoneq
(paren
id|megaCfg
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/* Following code handles /proc fs  */
DECL|function|proc_printf
r_static
r_int
id|proc_printf
(paren
id|mega_host_config
op_star
id|megaCfg
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;procidx
OG
id|PROCBUFSIZE
)paren
r_return
l_int|0
suffix:semicolon
id|va_start
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|i
op_assign
id|vsprintf
(paren
(paren
id|megaCfg-&gt;procbuf
op_plus
id|megaCfg-&gt;procidx
)paren
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
(paren
id|args
)paren
suffix:semicolon
id|megaCfg-&gt;procidx
op_add_assign
id|i
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|proc_read_config
r_static
r_int
id|proc_read_config
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|data
suffix:semicolon
op_star
id|start
op_assign
id|page
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;productInfo.ProductName
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|megaCfg-&gt;productInfo.ProductName
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;Controller Type: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_QUARTZ
)paren
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;438/466/467/471/493&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;418/428/434&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_40LD
)paren
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;Controller Supports 40 Logical Drives&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megaCfg-&gt;flag
op_amp
id|BOARD_64BIT
)paren
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;Controller / Driver uses 64 bit memory addressing&bslash;n&quot;
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;Base = %08x, Irq = %d, &quot;
comma
id|megaCfg-&gt;base
comma
id|megaCfg-&gt;host-&gt;irq
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;Logical Drives = %d, Channels = %d&bslash;n&quot;
comma
id|megaCfg-&gt;numldrv
comma
id|megaCfg-&gt;productInfo.SCSIChanPresent
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;Version =%s:%s, DRAM = %dMb&bslash;n&quot;
comma
id|megaCfg-&gt;fwVer
comma
id|megaCfg-&gt;biosVer
comma
id|megaCfg-&gt;productInfo.DramSize
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;Controller Queue Depth = %d, Driver Queue Depth = %d&bslash;n&quot;
comma
id|megaCfg-&gt;productInfo.MaxConcCmds
comma
id|megaCfg-&gt;max_cmds
)paren
suffix:semicolon
id|COPY_BACK
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_read_stat
r_static
r_int
id|proc_read_stat
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
id|mega_host_config
op_star
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|data
suffix:semicolon
op_star
id|start
op_assign
id|page
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;Statistical Information for this controller&bslash;n&quot;
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;Interrupts Collected = %lu&bslash;n&quot;
comma
id|megaCfg-&gt;nInterrupts
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|megaCfg-&gt;numldrv
suffix:semicolon
id|i
op_increment
)paren
(brace
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;Logical Drive %d:&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;&bslash;tReads Issued = %lu, Writes Issued = %lu&bslash;n&quot;
comma
id|megaCfg-&gt;nReads
(braket
id|i
)braket
comma
id|megaCfg-&gt;nWrites
(braket
id|i
)braket
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;&bslash;tSectors Read = %lu, Sectors Written = %lu&bslash;n&bslash;n&quot;
comma
id|megaCfg-&gt;nReadBlocks
(braket
id|i
)braket
comma
id|megaCfg-&gt;nWriteBlocks
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|COPY_BACK
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_read_status
r_static
r_int
id|proc_read_status
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|data
suffix:semicolon
op_star
id|start
op_assign
id|page
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;TBD&bslash;n&quot;
)paren
suffix:semicolon
id|COPY_BACK
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|proc_read_mbox
r_static
r_int
id|proc_read_mbox
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|mega_host_config
op_star
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|data
suffix:semicolon
r_volatile
id|mega_mailbox
op_star
id|mbox
op_assign
id|megaCfg-&gt;mbox
suffix:semicolon
op_star
id|start
op_assign
id|page
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;Contents of Mail Box Structure&bslash;n&quot;
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;  Fw Command   = 0x%02x&bslash;n&quot;
comma
id|mbox-&gt;cmd
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;  Cmd Sequence = 0x%02x&bslash;n&quot;
comma
id|mbox-&gt;cmdid
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;  No of Sectors= %04d&bslash;n&quot;
comma
id|mbox-&gt;numsectors
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;  LBA          = 0x%02x&bslash;n&quot;
comma
id|mbox-&gt;lba
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;  DTA          = 0x%08x&bslash;n&quot;
comma
id|mbox-&gt;xferaddr
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;  Logical Drive= 0x%02x&bslash;n&quot;
comma
id|mbox-&gt;logdrv
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;  No of SG Elmt= 0x%02x&bslash;n&quot;
comma
id|mbox-&gt;numsgelements
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;  Busy         = %01x&bslash;n&quot;
comma
id|mbox-&gt;busy
)paren
suffix:semicolon
id|proc_printf
(paren
id|megaCfg
comma
l_string|&quot;  Status       = 0x%02x&bslash;n&quot;
comma
id|mbox-&gt;status
)paren
suffix:semicolon
multiline_comment|/* proc_printf(megaCfg, &quot;Dump of MailBox&bslash;n&quot;);&n;&t;for (i = 0; i &lt; 16; i++)&n;        &t;proc_printf(megaCfg, &quot;%02x &quot;,*(mbox + i));&n;&n;&t;proc_printf(megaCfg, &quot;&bslash;n&bslash;nNumber of Status = %02d&bslash;n&quot;,mbox-&gt;numstatus);&n;&n;&t;for (i = 0; i &lt; 46; i++) {&n;        &t;proc_printf(megaCfg,&quot;%02d &quot;,*(mbox + 16 + i));&n;        if (i%16)&n;                proc_printf(megaCfg,&quot;&bslash;n&quot;);&n;&t;}&n;&n;&t;if (!mbox-&gt;numsgelements) {&n;&t;        dta = phys_to_virt(mbox-&gt;xferaddr);&n;&t;        for (i = 0; i &lt; mbox-&gt;numsgelements; i++)&n;&t;                if (dta) {&n;&t;                        proc_printf(megaCfg,&quot;Addr = %08x&bslash;n&quot;, (ulong)*(dta + i));                        proc_printf(megaCfg,&quot;Length = %08x&bslash;n&quot;,&n;&t;                                (ulong)*(dta + i + 4));&n;&t;                }&n;&t;}*/
id|COPY_BACK
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,0)&t;/*0x20300 */
DECL|macro|CREATE_READ_PROC
mdefine_line|#define CREATE_READ_PROC(string, fxn) create_proc_read_entry(string, &bslash;&n;                                         S_IRUSR | S_IFREG,&bslash;&n;                                         controller_proc_dir_entry,&bslash;&n;                                         fxn, megaCfg)
macro_line|#else
DECL|macro|CREATE_READ_PROC
mdefine_line|#define CREATE_READ_PROC(string, fxn) create_proc_read_entry(string,S_IRUSR | S_IFREG, controller_proc_dir_entry, fxn, megaCfg)
r_static
r_struct
id|proc_dir_entry
op_star
DECL|function|create_proc_read_entry
id|create_proc_read_entry
(paren
r_const
r_char
op_star
id|string
comma
r_int
id|mode
comma
r_struct
id|proc_dir_entry
op_star
id|parent
comma
id|read_proc_t
op_star
id|fxn
comma
id|mega_host_config
op_star
id|megaCfg
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|temp
op_assign
l_int|NULL
suffix:semicolon
id|temp
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|proc_dir_entry
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|temp
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
(paren
id|temp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|proc_dir_entry
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp-&gt;name
op_assign
id|kmalloc
(paren
id|strlen
(paren
id|string
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|kfree
(paren
id|temp
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|strcpy
(paren
(paren
r_char
op_star
)paren
id|temp-&gt;name
comma
id|string
)paren
suffix:semicolon
id|temp-&gt;namelen
op_assign
id|strlen
(paren
id|string
)paren
suffix:semicolon
id|temp-&gt;mode
op_assign
id|mode
suffix:semicolon
multiline_comment|/*S_IFREG | S_IRUSR */
suffix:semicolon
id|temp-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|megaCfg
suffix:semicolon
id|temp-&gt;read_proc
op_assign
id|fxn
suffix:semicolon
id|proc_register
(paren
id|parent
comma
id|temp
)paren
suffix:semicolon
r_return
id|temp
suffix:semicolon
)brace
macro_line|#endif
DECL|function|mega_create_proc_entry
r_static
r_void
id|mega_create_proc_entry
(paren
r_int
id|index
comma
r_struct
id|proc_dir_entry
op_star
id|parent
)paren
(brace
id|u_char
id|string
(braket
l_int|64
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
id|mega_host_config
op_star
id|megaCfg
op_assign
id|megaCtlrs
(braket
id|index
)braket
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|controller_proc_dir_entry
op_assign
l_int|NULL
suffix:semicolon
id|sprintf
(paren
id|string
comma
l_string|&quot;%d&quot;
comma
id|index
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,0)&t;/*0x20300 */
id|controller_proc_dir_entry
op_assign
id|megaCfg-&gt;controller_proc_dir_entry
op_assign
id|proc_mkdir
(paren
id|string
comma
id|parent
)paren
suffix:semicolon
macro_line|#else
id|controller_proc_dir_entry
op_assign
id|megaCfg-&gt;controller_proc_dir_entry
op_assign
id|create_proc_entry
(paren
id|string
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
id|parent
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|controller_proc_dir_entry
)paren
id|printk
(paren
l_string|&quot;&bslash;nmegaraid: proc_mkdir failed&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|megaCfg-&gt;proc_read
op_assign
id|CREATE_READ_PROC
(paren
l_string|&quot;config&quot;
comma
id|proc_read_config
)paren
suffix:semicolon
id|megaCfg-&gt;proc_status
op_assign
id|CREATE_READ_PROC
(paren
l_string|&quot;status&quot;
comma
id|proc_read_status
)paren
suffix:semicolon
id|megaCfg-&gt;proc_stat
op_assign
id|CREATE_READ_PROC
(paren
l_string|&quot;stat&quot;
comma
id|proc_read_stat
)paren
suffix:semicolon
id|megaCfg-&gt;proc_mbox
op_assign
id|CREATE_READ_PROC
(paren
l_string|&quot;mailbox&quot;
comma
id|proc_read_mbox
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_PROC_FS */
multiline_comment|/*-------------------------------------------------------------&n; * Return the disk geometry for a particular disk&n; * Input:&n; *   Disk *disk - Disk geometry&n; *   struct block_device *dev - Device node&n; *   int *geom  - Returns geometry fields&n; *     geom[0] = heads&n; *     geom[1] = sectors&n; *     geom[2] = cylinders&n; *-------------------------------------------------------------*/
DECL|function|megaraid_biosparam
r_int
id|megaraid_biosparam
(paren
r_struct
id|scsi_device
op_star
id|sdev
comma
r_struct
id|block_device
op_star
id|bdev
comma
id|sector_t
id|capacity
comma
r_int
op_star
id|geom
)paren
(brace
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
multiline_comment|/* Get pointer to host config structure */
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|IS_RAID_CH
c_func
(paren
id|sdev-&gt;channel
)paren
)paren
(brace
multiline_comment|/* Default heads (64) &amp; sectors (32) */
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
(paren
r_int
r_int
)paren
id|capacity
op_rshift
l_int|11
suffix:semicolon
multiline_comment|/* Handle extended translation size for logical drives &gt; 1Gb */
r_if
c_cond
(paren
id|capacity
op_ge
l_int|0x200000
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
(paren
r_int
r_int
)paren
id|capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
multiline_comment|/* return result */
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|mega_partsize
c_func
(paren
id|bdev
comma
id|capacity
comma
id|geom
)paren
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;megaraid: invalid partition on this disk on channel %d&bslash;n&quot;
comma
id|sdev-&gt;channel
)paren
suffix:semicolon
multiline_comment|/* Default heads (64) &amp; sectors (32) */
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|capacity
op_rshift
l_int|11
suffix:semicolon
multiline_comment|/* Handle extended translation size for logical drives &gt; 1Gb */
r_if
c_cond
(paren
id|capacity
op_ge
l_int|0x200000
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
(paren
r_int
r_int
)paren
id|capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
multiline_comment|/* return result */
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function : static int mega_partsize(Disk * disk, struct block_device *bdev, int *geom)&n; *&n; * Purpose : to determine the BIOS mapping used to create the partition&n; *&t;&t;&t;table, storing the results (cyls, hds, and secs) in geom&n; *&n; * Note:&t;Code is picked from scsicam.h&n; *&n; * Returns : -1 on failure, 0 on success.&n; */
r_static
r_int
DECL|function|mega_partsize
id|mega_partsize
c_func
(paren
r_struct
id|block_device
op_star
id|bdev
comma
id|sector_t
id|capacity
comma
r_int
op_star
id|geom
)paren
(brace
r_struct
id|partition
op_star
id|p
comma
op_star
id|largest
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|largest_cyl
suffix:semicolon
r_int
id|heads
comma
id|cyls
comma
id|sectors
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf
op_assign
id|scsi_bios_ptable
c_func
(paren
id|bdev
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|buf
op_plus
l_int|64
)paren
op_eq
l_int|0xAA55
)paren
(brace
r_for
c_loop
(paren
id|largest_cyl
op_assign
op_minus
l_int|1
comma
id|p
op_assign
(paren
r_struct
id|partition
op_star
)paren
id|buf
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
op_increment
id|i
comma
op_increment
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;sys_ind
)paren
r_continue
suffix:semicolon
id|cyls
op_assign
id|p-&gt;end_cyl
op_plus
(paren
(paren
id|p-&gt;end_sector
op_amp
l_int|0xc0
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cyls
op_ge
id|largest_cyl
)paren
(brace
id|largest_cyl
op_assign
id|cyls
suffix:semicolon
id|largest
op_assign
id|p
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|largest
)paren
(brace
id|heads
op_assign
id|largest-&gt;end_head
op_plus
l_int|1
suffix:semicolon
id|sectors
op_assign
id|largest-&gt;end_sector
op_amp
l_int|0x3f
suffix:semicolon
r_if
c_cond
(paren
id|heads
op_eq
l_int|0
op_logical_or
id|sectors
op_eq
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|cyls
op_assign
(paren
r_int
r_int
)paren
id|capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cyls
suffix:semicolon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine will be called when the use has done a forced shutdown on the&n; * system. Flush the Adapter cache, that&squot;s the most we can do.&n; */
DECL|function|megaraid_reboot_notify
r_static
r_int
id|megaraid_reboot_notify
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|code
comma
r_void
op_star
id|unused
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|pSHost
suffix:semicolon
id|mega_host_config
op_star
id|megaCfg
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
suffix:semicolon
id|u_char
id|mboxData
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|SYS_DOWN
op_logical_or
id|code
op_eq
id|SYS_HALT
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numCtlrs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pSHost
op_assign
id|megaCtlrs
(braket
id|i
)braket
op_member_access_from_pointer
id|host
suffix:semicolon
id|megaCfg
op_assign
(paren
id|mega_host_config
op_star
)paren
id|pSHost-&gt;hostdata
suffix:semicolon
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mboxData
suffix:semicolon
multiline_comment|/* Flush cache to disk */
id|memset
(paren
id|mbox
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|mboxData
(braket
l_int|0
)braket
op_assign
l_int|0xA
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Free irq, otherwise extra interrupt is generated&n;&t;&t;&t; */
id|free_irq
(paren
id|megaCfg-&gt;host-&gt;irq
comma
id|megaCfg
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;   * Issue a blocking (interrupts disabled) command to&n;&t;&t;&t;   * the card&n;&t;&t;&t; */
id|megaIssueCmd
(paren
id|megaCfg
comma
id|mboxData
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|function|mega_init_scb
r_static
r_int
id|mega_init_scb
(paren
id|mega_host_config
op_star
id|megacfg
)paren
(brace
r_int
id|idx
suffix:semicolon
macro_line|#if DEBUG
r_if
c_cond
(paren
id|megacfg-&gt;max_cmds
op_ge
id|MAX_COMMANDS
)paren
(brace
id|printk
(paren
l_string|&quot;megaraid:ctlr max cmds = %x : MAX_CMDS = %x&quot;
comma
id|megacfg-&gt;max_cmds
comma
id|MAX_COMMANDS
)paren
suffix:semicolon
)brace
macro_line|#endif
r_for
c_loop
(paren
id|idx
op_assign
id|megacfg-&gt;max_cmds
op_minus
l_int|1
suffix:semicolon
id|idx
op_ge
l_int|0
suffix:semicolon
id|idx
op_decrement
)paren
(brace
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|idx
op_assign
id|idx
suffix:semicolon
multiline_comment|/*&n;&t;&t; * ISR will make this flag zero to indicate the command has been&n;&t;&t; * completed. This is only for user ioctl calls. Rest of the driver&n;&t;&t; * and the mid-layer operations are not connected with this flag.&n;&t;&t; */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|sgList
op_assign
id|pci_alloc_consistent
(paren
id|megacfg-&gt;dev
comma
r_sizeof
(paren
id|mega_64sglist
)paren
op_star
id|MAX_SGLIST
comma
op_amp
(paren
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|dma_sghandle64
)paren
)paren
suffix:semicolon
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|sg64List
op_assign
(paren
id|mega_64sglist
op_star
)paren
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|sgList
suffix:semicolon
macro_line|#else
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|sgList
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|mega_sglist
)paren
op_star
id|MAX_SGLIST
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|sgList
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t allocate sglist for id %d&bslash;n&quot;
comma
id|idx
)paren
suffix:semicolon
id|mega_freeSgList
(paren
id|megacfg
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|pthru
op_assign
id|pci_alloc_consistent
(paren
id|megacfg-&gt;dev
comma
r_sizeof
(paren
id|mega_passthru
)paren
comma
op_amp
(paren
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|dma_passthruhandle64
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|pthru
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t allocate passthru for id %d&bslash;n&quot;
comma
id|idx
)paren
suffix:semicolon
)brace
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|epthru
op_assign
id|pci_alloc_consistent
c_func
(paren
id|megacfg-&gt;dev
comma
r_sizeof
(paren
id|mega_ext_passthru
)paren
comma
op_amp
(paren
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|dma_ext_passthruhandle64
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|epthru
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t allocate extended passthru for id %d&bslash;n&quot;
comma
id|idx
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t; * Allocate a 256 Byte Bounce Buffer for handling INQ/RD_CAPA &n;&t;&t; */
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|bounce_buffer
op_assign
id|pci_alloc_consistent
(paren
id|megacfg-&gt;dev
comma
l_int|256
comma
op_amp
(paren
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|dma_bounce_buffer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|bounce_buffer
)paren
id|printk
(paren
l_string|&quot;megaraid: allocation for bounce buffer failed&bslash;n&quot;
)paren
suffix:semicolon
id|megacfg-&gt;scbList
(braket
id|idx
)braket
dot
id|dma_type
op_assign
id|M_RD_DMA_TYPE_NONE
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|idx
OL
id|MAX_COMMANDS
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Link to free list&n;&t;&t;&t; * lock not required since we are loading the driver, so no&n;&t;&t;&t; * commands possible right now.&n;&t;&t;&t; */
id|enq_scb_freelist
(paren
id|megacfg
comma
op_amp
id|megacfg-&gt;scbList
(braket
id|idx
)braket
comma
id|NO_LOCK
comma
id|INTR_ENB
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Enqueues a SCB&n; */
DECL|function|enq_scb_freelist
r_static
r_void
id|enq_scb_freelist
(paren
id|mega_host_config
op_star
id|megacfg
comma
id|mega_scb
op_star
id|scb
comma
r_int
id|lock
comma
r_int
id|intr
)paren
(brace
r_if
c_cond
(paren
id|lock
op_eq
id|INTERNAL_LOCK
op_logical_or
id|intr
op_eq
id|INTR_DIS
)paren
(brace
r_if
c_cond
(paren
id|intr
op_eq
id|INTR_DIS
)paren
id|spin_lock_irq
(paren
op_amp
id|megacfg-&gt;lock_free
)paren
suffix:semicolon
r_else
id|spin_lock
(paren
op_amp
id|megacfg-&gt;lock_free
)paren
suffix:semicolon
)brace
id|scb-&gt;state
op_assign
id|SCB_FREE
suffix:semicolon
id|scb-&gt;SCpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|megacfg-&gt;qFreeH
op_eq
(paren
id|mega_scb
op_star
)paren
l_int|NULL
)paren
(brace
id|megacfg-&gt;qFreeH
op_assign
id|megacfg-&gt;qFreeT
op_assign
id|scb
suffix:semicolon
)brace
r_else
(brace
id|megacfg-&gt;qFreeT-&gt;next
op_assign
id|scb
suffix:semicolon
id|megacfg-&gt;qFreeT
op_assign
id|scb
suffix:semicolon
)brace
id|megacfg-&gt;qFreeT-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|megacfg-&gt;qFcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lock
op_eq
id|INTERNAL_LOCK
op_logical_or
id|intr
op_eq
id|INTR_DIS
)paren
(brace
r_if
c_cond
(paren
id|intr
op_eq
id|INTR_DIS
)paren
id|spin_unlock_irq
(paren
op_amp
id|megacfg-&gt;lock_free
)paren
suffix:semicolon
r_else
id|spin_unlock
(paren
op_amp
id|megacfg-&gt;lock_free
)paren
suffix:semicolon
)brace
)brace
DECL|function|megadev_ioctl_entry
r_static
r_int
id|megadev_ioctl_entry
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filep
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * We do not allow parallel ioctls to the driver as of now.&n;&t; */
id|down
(paren
op_amp
id|mimd_entry_mtx
)paren
suffix:semicolon
id|ret
op_assign
id|megadev_ioctl
(paren
id|inode
comma
id|filep
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
id|up
(paren
op_amp
id|mimd_entry_mtx
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|megadev_ioctl
r_static
r_int
id|megadev_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filep
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|adapno
suffix:semicolon
id|u32
id|inlen
suffix:semicolon
r_struct
id|uioctl_t
id|ioc
suffix:semicolon
r_char
op_star
id|kvaddr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|nadap
op_assign
id|numCtlrs
suffix:semicolon
id|u8
id|opcode
suffix:semicolon
id|u32
id|outlen
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|u8
id|subopcode
suffix:semicolon
id|Scsi_Cmnd
op_star
id|scsicmd
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shpnt
suffix:semicolon
r_char
op_star
id|uaddr
suffix:semicolon
r_struct
id|uioctl_t
op_star
id|uioc
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|u32
id|length
suffix:semicolon
id|mega_host_config
op_star
id|megacfg
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)&t;/* 0x020400 */
r_struct
id|pci_dev
id|pdev
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdevp
op_assign
op_amp
id|pdev
suffix:semicolon
macro_line|#else
r_char
op_star
id|pdevp
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|IO_LOCK_T
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_TYPE
(paren
id|cmd
)paren
op_ne
id|MEGAIOC_MAGIC
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Get the user ioctl structure&n;&t; */
id|ret
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|uioctl_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|ioc
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|uioctl_t
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The first call the applications should make is to find out the&n;&t; * number of controllers in the system. The next logical call should&n;&t; * be for getting the list of controllers in the system as detected&n;&t; * by the driver.&n;&t; */
multiline_comment|/*&n;&t; * Get the opcode and subopcode for the commands&n;&t; */
id|opcode
op_assign
id|ioc.ui.fcs.opcode
suffix:semicolon
id|subopcode
op_assign
id|ioc.ui.fcs.subopcode
suffix:semicolon
r_switch
c_cond
(paren
id|opcode
)paren
(brace
r_case
id|M_RD_DRIVER_IOCTL_INTERFACE
suffix:colon
r_switch
c_cond
(paren
id|subopcode
)paren
(brace
r_case
id|MEGAIOC_QDRVRVER
suffix:colon
multiline_comment|/* Query driver version */
id|put_user
(paren
id|driver_ver
comma
(paren
id|u32
op_star
)paren
id|ioc.data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|MEGAIOC_QNADAP
suffix:colon
multiline_comment|/* Get # of adapters */
id|put_user
(paren
id|nadap
comma
(paren
r_int
op_star
)paren
id|ioc.data
)paren
suffix:semicolon
r_return
id|nadap
suffix:semicolon
r_case
id|MEGAIOC_QADAPINFO
suffix:colon
multiline_comment|/* Get adapter information */
multiline_comment|/*&n;&t;&t;&t; * which adapter?&n;&t;&t;&t; */
id|adapno
op_assign
id|ioc.ui.fcs.adapno
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * The adapter numbers do not start with 0, at least in&n;&t;&t;&t; * the user space. This is just to make sure, 0 is not the&n;&t;&t;&t; * default value which will refer to adapter 1. So the&n;&t;&t;&t; * user needs to make use of macros MKADAP() and GETADAP()&n;&t;&t;&t; * (See megaraid.h) while making ioctl() call.&n;&t;&t;&t; */
id|adapno
op_assign
id|GETADAP
(paren
id|adapno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapno
op_ge
id|numCtlrs
)paren
r_return
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|ret
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|ioc.data
comma
r_sizeof
(paren
r_struct
id|mcontroller
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Copy struct mcontroller to user area&n;&t;&t;&t; */
id|copy_to_user
(paren
id|ioc.data
comma
id|mcontroller
op_plus
id|adapno
comma
r_sizeof
(paren
r_struct
id|mcontroller
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/* inner switch */
r_break
suffix:semicolon
r_case
id|M_RD_IOCTL_CMD_NEW
suffix:colon
multiline_comment|/*&n;&t;&t; * Deletion of logical drives is only handled in 0x80 commands&n;&t;&t; */
r_if
c_cond
(paren
id|ioc.mbox
(braket
l_int|0
)braket
op_eq
id|FC_DEL_LOGDRV
op_logical_and
id|ioc.mbox
(braket
l_int|2
)braket
op_eq
id|OP_DEL_LOGDRV
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* which adapter?  */
id|adapno
op_assign
id|ioc.ui.fcs.adapno
suffix:semicolon
multiline_comment|/* See comment above: MEGAIOC_QADAPINFO */
id|adapno
op_assign
id|GETADAP
c_func
(paren
id|adapno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapno
op_ge
id|numCtlrs
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|length
op_assign
id|ioc.ui.fcs.length
suffix:semicolon
multiline_comment|/* Check for zero length buffer or very large buffers */
r_if
c_cond
(paren
op_logical_neg
id|length
op_logical_or
id|length
OG
l_int|32
op_star
l_int|1024
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* save the user address */
id|uaddr
op_assign
id|ioc.ui.fcs.buffer
suffix:semicolon
multiline_comment|/*&n;&t;&t; * For M_RD_IOCTL_CMD_NEW commands, the fields outlen and inlen of&n;&t;&t; * uioctl_t structure are treated as flags. If outlen is 1, the&n;&t;&t; * data is transferred from the device and if inlen is 1, the data&n;&t;&t; * is transferred to the device.&n;&t;&t; */
id|outlen
op_assign
id|ioc.outlen
suffix:semicolon
id|inlen
op_assign
id|ioc.inlen
suffix:semicolon
r_if
c_cond
(paren
id|outlen
)paren
(brace
id|ret
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_char
op_star
)paren
id|ioc.ui.fcs.buffer
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inlen
)paren
(brace
id|ret
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_char
op_star
)paren
id|ioc.ui.fcs.buffer
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Find this host&n;&t;&t; */
id|shpnt
op_assign
id|megaCtlrs
(braket
id|adapno
)braket
op_member_access_from_pointer
id|host
suffix:semicolon
r_if
c_cond
(paren
id|shpnt
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|scsicmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|Scsi_Cmnd
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
macro_line|#else
id|scsicmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|scsi_init_malloc
c_func
(paren
r_sizeof
(paren
id|Scsi_Cmnd
)paren
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|scsicmd
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|scsicmd
comma
l_int|0
comma
r_sizeof
(paren
id|Scsi_Cmnd
)paren
)paren
suffix:semicolon
id|scsicmd-&gt;device-&gt;host
op_assign
id|shpnt
suffix:semicolon
r_if
c_cond
(paren
id|outlen
op_logical_or
id|inlen
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|pdevp
op_assign
op_amp
id|pdev
suffix:semicolon
id|memcpy
c_func
(paren
id|pdevp
comma
id|megacfg-&gt;dev
comma
r_sizeof
(paren
r_struct
id|pci_dev
)paren
)paren
suffix:semicolon
id|pdevp-&gt;dma_mask
op_assign
l_int|0xffffffff
suffix:semicolon
macro_line|#else
id|pdevp
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|kvaddr
op_assign
id|dma_alloc_consistent
c_func
(paren
id|pdevp
comma
id|length
comma
op_amp
id|dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kvaddr
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;megaraid:allocation failed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)&t;/*0x20400 */
id|kfree
c_func
(paren
id|scsicmd
)paren
suffix:semicolon
macro_line|#else
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|scsicmd
comma
r_sizeof
(paren
id|Scsi_Cmnd
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ioc.ui.fcs.buffer
op_assign
id|kvaddr
suffix:semicolon
r_if
c_cond
(paren
id|inlen
)paren
(brace
multiline_comment|/* copyin the user data */
id|copy_from_user
c_func
(paren
id|kvaddr
comma
(paren
r_char
op_star
)paren
id|uaddr
comma
id|length
)paren
suffix:semicolon
)brace
)brace
id|scsicmd-&gt;cmnd
(braket
l_int|0
)braket
op_assign
id|MEGADEVIOC
suffix:semicolon
id|scsicmd-&gt;request_buffer
op_assign
(paren
r_void
op_star
)paren
op_amp
id|ioc
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|mimd_ioctl_sem
)paren
suffix:semicolon
id|IO_LOCK
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|megaraid_queue
c_func
(paren
id|scsicmd
comma
id|megadev_ioctl_done
)paren
suffix:semicolon
id|IO_UNLOCK
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|mimd_ioctl_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsicmd-&gt;result
op_logical_and
id|outlen
)paren
(brace
id|copy_to_user
c_func
(paren
id|uaddr
comma
id|kvaddr
comma
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * copyout the result&n;&t;&t; */
id|uioc
op_assign
(paren
r_struct
id|uioctl_t
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|ioc.mbox
(braket
l_int|0
)braket
op_eq
id|MEGA_MBOXCMD_PASSTHRU
)paren
(brace
id|put_user
c_func
(paren
id|scsicmd-&gt;result
comma
op_amp
id|uioc-&gt;pthru.scsistatus
)paren
suffix:semicolon
)brace
r_else
(brace
id|put_user
c_func
(paren
l_int|1
comma
op_amp
id|uioc-&gt;mbox
(braket
l_int|16
)braket
)paren
suffix:semicolon
multiline_comment|/* numstatus */
multiline_comment|/* status */
id|put_user
(paren
id|scsicmd-&gt;result
comma
op_amp
id|uioc-&gt;mbox
(braket
l_int|17
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kvaddr
)paren
(brace
id|dma_free_consistent
c_func
(paren
id|pdevp
comma
id|length
comma
id|kvaddr
comma
id|dma_addr
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)&t;/*0x20400 */
id|kfree
(paren
id|scsicmd
)paren
suffix:semicolon
macro_line|#else
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|scsicmd
comma
r_sizeof
(paren
id|Scsi_Cmnd
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* restore the user address */
id|ioc.ui.fcs.buffer
op_assign
id|uaddr
suffix:semicolon
r_return
id|ret
suffix:semicolon
r_case
id|M_RD_IOCTL_CMD
suffix:colon
multiline_comment|/* which adapter?  */
id|adapno
op_assign
id|ioc.ui.fcs.adapno
suffix:semicolon
multiline_comment|/* See comment above: MEGAIOC_QADAPINFO */
id|adapno
op_assign
id|GETADAP
(paren
id|adapno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapno
op_ge
id|numCtlrs
)paren
r_return
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
multiline_comment|/* save the user address */
id|uaddr
op_assign
id|ioc.data
suffix:semicolon
id|outlen
op_assign
id|ioc.outlen
suffix:semicolon
id|inlen
op_assign
id|ioc.inlen
suffix:semicolon
r_if
c_cond
(paren
(paren
id|outlen
op_ge
id|IOCTL_MAX_DATALEN
)paren
op_logical_or
(paren
id|inlen
op_ge
id|IOCTL_MAX_DATALEN
)paren
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|outlen
)paren
(brace
id|ret
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|ioc.data
comma
id|outlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inlen
)paren
(brace
id|ret
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
id|ioc.data
comma
id|inlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Find this host&n;&t;&t; */
id|shpnt
op_assign
id|megaCtlrs
(braket
id|adapno
)braket
op_member_access_from_pointer
id|host
suffix:semicolon
r_if
c_cond
(paren
id|shpnt
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * ioctls for deleting logical drives is a special case, so check&n;&t;&t; * for it first&n;&t;&t; */
r_if
c_cond
(paren
id|ioc.mbox
(braket
l_int|0
)braket
op_eq
id|FC_DEL_LOGDRV
op_logical_and
id|ioc.mbox
(braket
l_int|2
)braket
op_eq
id|OP_DEL_LOGDRV
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|megacfg-&gt;support_random_del
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;megaraid: logdrv delete on non supporting f/w.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|uioc
op_assign
(paren
r_struct
id|uioctl_t
op_star
)paren
id|arg
suffix:semicolon
id|ret
op_assign
id|mega_del_logdrv
c_func
(paren
id|megacfg
comma
id|ioc.mbox
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|put_user
c_func
(paren
l_int|1
comma
op_amp
id|uioc-&gt;mbox
(braket
l_int|16
)braket
)paren
suffix:semicolon
multiline_comment|/* numstatus */
id|put_user
c_func
(paren
id|ret
comma
op_amp
id|uioc-&gt;mbox
(braket
l_int|17
)braket
)paren
suffix:semicolon
multiline_comment|/* status */
multiline_comment|/* if deletion failed, let the user know by failing ioctl */
r_return
id|ret
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|scsicmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|Scsi_Cmnd
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
macro_line|#else
id|scsicmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|scsi_init_malloc
c_func
(paren
r_sizeof
(paren
id|Scsi_Cmnd
)paren
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|scsicmd
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|scsicmd
comma
l_int|0
comma
r_sizeof
(paren
id|Scsi_Cmnd
)paren
)paren
suffix:semicolon
id|scsicmd-&gt;device-&gt;host
op_assign
id|shpnt
suffix:semicolon
r_if
c_cond
(paren
id|outlen
op_logical_or
id|inlen
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|pdevp
op_assign
op_amp
id|pdev
suffix:semicolon
id|memcpy
c_func
(paren
id|pdevp
comma
id|megacfg-&gt;dev
comma
r_sizeof
(paren
r_struct
id|pci_dev
)paren
)paren
suffix:semicolon
id|pdevp-&gt;dma_mask
op_assign
l_int|0xffffffff
suffix:semicolon
macro_line|#else
id|pdevp
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t;&t; * Allocate a page of kernel space.&n;&t;&t;&t; */
id|kvaddr
op_assign
id|dma_alloc_consistent
c_func
(paren
id|pdevp
comma
id|PAGE_SIZE
comma
op_amp
id|dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kvaddr
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;megaraid:allocation failed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)&t;/*0x20400 */
id|kfree
c_func
(paren
id|scsicmd
)paren
suffix:semicolon
macro_line|#else
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|scsicmd
comma
r_sizeof
(paren
id|Scsi_Cmnd
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ioc.data
op_assign
id|kvaddr
suffix:semicolon
r_if
c_cond
(paren
id|inlen
)paren
(brace
r_if
c_cond
(paren
id|ioc.mbox
(braket
l_int|0
)braket
op_eq
id|MEGA_MBOXCMD_PASSTHRU
)paren
(brace
multiline_comment|/* copyin the user data */
id|copy_from_user
(paren
id|kvaddr
comma
id|uaddr
comma
id|ioc.pthru.dataxferlen
)paren
suffix:semicolon
)brace
r_else
(brace
id|copy_from_user
(paren
id|kvaddr
comma
id|uaddr
comma
id|inlen
)paren
suffix:semicolon
)brace
)brace
)brace
id|scsicmd-&gt;cmnd
(braket
l_int|0
)braket
op_assign
id|MEGADEVIOC
suffix:semicolon
id|scsicmd-&gt;request_buffer
op_assign
(paren
r_void
op_star
)paren
op_amp
id|ioc
suffix:semicolon
id|init_MUTEX_LOCKED
(paren
op_amp
id|mimd_ioctl_sem
)paren
suffix:semicolon
id|IO_LOCK
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|megaraid_queue
(paren
id|scsicmd
comma
id|megadev_ioctl_done
)paren
suffix:semicolon
id|IO_UNLOCK
c_func
(paren
id|shpnt
)paren
suffix:semicolon
id|down
(paren
op_amp
id|mimd_ioctl_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsicmd-&gt;result
op_logical_and
id|outlen
)paren
(brace
r_if
c_cond
(paren
id|ioc.mbox
(braket
l_int|0
)braket
op_eq
id|MEGA_MBOXCMD_PASSTHRU
)paren
(brace
id|copy_to_user
(paren
id|uaddr
comma
id|kvaddr
comma
id|ioc.pthru.dataxferlen
)paren
suffix:semicolon
)brace
r_else
(brace
id|copy_to_user
(paren
id|uaddr
comma
id|kvaddr
comma
id|outlen
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * copyout the result&n;&t;&t; */
id|uioc
op_assign
(paren
r_struct
id|uioctl_t
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|ioc.mbox
(braket
l_int|0
)braket
op_eq
id|MEGA_MBOXCMD_PASSTHRU
)paren
(brace
id|put_user
(paren
id|scsicmd-&gt;result
comma
op_amp
id|uioc-&gt;pthru.scsistatus
)paren
suffix:semicolon
)brace
r_else
(brace
id|put_user
(paren
l_int|1
comma
op_amp
id|uioc-&gt;mbox
(braket
l_int|16
)braket
)paren
suffix:semicolon
multiline_comment|/* numstatus */
id|put_user
(paren
id|scsicmd-&gt;result
comma
op_amp
id|uioc-&gt;mbox
(braket
l_int|17
)braket
)paren
suffix:semicolon
multiline_comment|/* status */
)brace
r_if
c_cond
(paren
id|kvaddr
)paren
(brace
id|dma_free_consistent
c_func
(paren
id|pdevp
comma
id|PAGE_SIZE
comma
id|kvaddr
comma
id|dma_addr
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|kfree
(paren
id|scsicmd
)paren
suffix:semicolon
macro_line|#else
id|scsi_init_free
c_func
(paren
(paren
r_char
op_star
)paren
id|scsicmd
comma
r_sizeof
(paren
id|Scsi_Cmnd
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* restore user pointer */
id|ioc.data
op_assign
id|uaddr
suffix:semicolon
r_return
id|ret
suffix:semicolon
r_default
suffix:colon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/* Outer switch */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|megadev_ioctl_done
id|megadev_ioctl_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
)paren
(brace
id|up
(paren
op_amp
id|mimd_ioctl_sem
)paren
suffix:semicolon
)brace
r_static
id|mega_scb
op_star
DECL|function|megadev_doioctl
id|megadev_doioctl
(paren
id|mega_host_config
op_star
id|megacfg
comma
id|Scsi_Cmnd
op_star
id|sc
)paren
(brace
id|u8
id|cmd
suffix:semicolon
r_struct
id|uioctl_t
op_star
id|ioc
op_assign
l_int|NULL
suffix:semicolon
id|mega_mailbox
op_star
id|mbox
op_assign
l_int|NULL
suffix:semicolon
id|mega_ioctl_mbox
op_star
id|mboxioc
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|mbox_passthru
op_star
id|mboxpthru
op_assign
l_int|NULL
suffix:semicolon
id|mega_scb
op_star
id|scb
op_assign
l_int|NULL
suffix:semicolon
id|mega_passthru
op_star
id|pthru
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|scb
op_assign
id|mega_allocateSCB
(paren
id|megacfg
comma
id|sc
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|sc-&gt;result
op_assign
(paren
id|DID_ERROR
op_lshift
l_int|16
)paren
suffix:semicolon
id|callDone
(paren
id|sc
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ioc
op_assign
(paren
r_struct
id|uioctl_t
op_star
)paren
id|sc-&gt;request_buffer
suffix:semicolon
id|memcpy
(paren
id|scb-&gt;mboxData
comma
id|ioc-&gt;mbox
comma
r_sizeof
(paren
id|scb-&gt;mboxData
)paren
)paren
suffix:semicolon
multiline_comment|/* The generic mailbox */
id|mbox
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|ioc-&gt;mbox
suffix:semicolon
multiline_comment|/*&n;&t; * Get the user command&n;&t; */
id|cmd
op_assign
id|ioc-&gt;mbox
(braket
l_int|0
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MEGA_MBOXCMD_PASSTHRU
suffix:colon
multiline_comment|/*&n;&t;&t;   * prepare the SCB with information from the user ioctl structure&n;&t;&t; */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|pthru
op_assign
id|scb-&gt;pthru
suffix:semicolon
macro_line|#else
id|pthru
op_assign
op_amp
id|scb-&gt;pthru
suffix:semicolon
macro_line|#endif
id|memcpy
(paren
id|pthru
comma
op_amp
id|ioc-&gt;pthru
comma
r_sizeof
(paren
id|mega_passthru
)paren
)paren
suffix:semicolon
id|mboxpthru
op_assign
(paren
r_struct
id|mbox_passthru
op_star
)paren
id|scb-&gt;mboxData
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
r_if
c_cond
(paren
id|megacfg-&gt;flag
op_amp
id|BOARD_64BIT
)paren
(brace
multiline_comment|/* This is just a sample with one element &n;&t;&t;&t;   * This if executes onlu on 2.4 kernels&n;&t;&t;&t; */
id|mboxpthru-&gt;dataxferaddr
op_assign
id|scb-&gt;dma_passthruhandle64
suffix:semicolon
id|scb-&gt;sg64List
(braket
l_int|0
)braket
dot
id|address
op_assign
id|pci_map_single
(paren
id|megacfg-&gt;dev
comma
id|ioc-&gt;data
comma
l_int|4096
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|scb-&gt;sg64List
(braket
l_int|0
)braket
dot
id|length
op_assign
l_int|4096
suffix:semicolon
singleline_comment|// TODO: Check this
id|pthru-&gt;dataxferaddr
op_assign
id|scb-&gt;dma_sghandle64
suffix:semicolon
id|pthru-&gt;numsgelements
op_assign
l_int|1
suffix:semicolon
id|mboxpthru-&gt;cmd
op_assign
l_int|0xC3
suffix:semicolon
)brace
r_else
(brace
id|mboxpthru-&gt;dataxferaddr
op_assign
id|scb-&gt;dma_passthruhandle64
suffix:semicolon
id|pthru-&gt;dataxferaddr
op_assign
id|pci_map_single
(paren
id|megacfg-&gt;dev
comma
id|ioc-&gt;data
comma
l_int|4096
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|pthru-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#else
(brace
id|mboxpthru-&gt;dataxferaddr
op_assign
id|virt_to_bus
(paren
op_amp
id|scb-&gt;pthru
)paren
suffix:semicolon
id|pthru-&gt;dataxferaddr
op_assign
id|virt_to_bus
(paren
id|ioc-&gt;data
)paren
suffix:semicolon
id|pthru-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|pthru-&gt;reqsenselen
op_assign
l_int|14
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Normal command */
id|mboxioc
op_assign
(paren
id|mega_ioctl_mbox
op_star
)paren
id|scb-&gt;mboxData
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;ui.fcs.opcode
op_eq
id|M_RD_IOCTL_CMD_NEW
)paren
(brace
id|scb-&gt;buff_ptr
op_assign
id|ioc-&gt;ui.fcs.buffer
suffix:semicolon
id|scb-&gt;iDataSize
op_assign
id|ioc-&gt;ui.fcs.length
suffix:semicolon
)brace
r_else
(brace
id|scb-&gt;buff_ptr
op_assign
id|ioc-&gt;data
suffix:semicolon
id|scb-&gt;iDataSize
op_assign
l_int|4096
suffix:semicolon
singleline_comment|// TODO:check it
)brace
id|set_mbox_xfer_addr
(paren
id|megacfg
comma
id|scb
comma
id|mboxioc
comma
id|FROMTO_DEVICE
)paren
suffix:semicolon
id|mboxioc-&gt;numsgelements
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|scb
suffix:semicolon
)brace
r_static
r_int
DECL|function|mega_support_ext_cdb
id|mega_support_ext_cdb
c_func
(paren
id|mega_host_config
op_star
id|this_hba
)paren
(brace
id|mega_mailbox
op_star
id|mboxpnt
suffix:semicolon
r_int
r_char
id|mbox
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|mboxpnt
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mbox
suffix:semicolon
id|memset
c_func
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|mbox
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * issue command to find out if controller supports extended CDBs.&n;&t; */
id|mbox
(braket
l_int|0
)braket
op_assign
l_int|0xA4
suffix:semicolon
id|mbox
(braket
l_int|2
)braket
op_assign
l_int|0x16
suffix:semicolon
id|ret
op_assign
id|megaIssueCmd
c_func
(paren
id|this_hba
comma
id|mbox
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_return
op_logical_neg
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Find out if this controller supports random deletion and addition of&n; * logical drives&n; */
r_static
r_int
DECL|function|mega_support_random_del
id|mega_support_random_del
c_func
(paren
id|mega_host_config
op_star
id|this_hba
)paren
(brace
id|mega_mailbox
op_star
id|mboxpnt
suffix:semicolon
r_int
r_char
id|mbox
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|mboxpnt
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mbox
suffix:semicolon
id|memset
c_func
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|mbox
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * issue command&n;&t; */
id|mbox
(braket
l_int|0
)braket
op_assign
id|FC_DEL_LOGDRV
suffix:semicolon
id|mbox
(braket
l_int|2
)braket
op_assign
id|OP_SUP_DEL_LOGDRV
suffix:semicolon
id|ret
op_assign
id|megaIssueCmd
c_func
(paren
id|this_hba
comma
id|mbox
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_return
op_logical_neg
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|mega_del_logdrv
id|mega_del_logdrv
c_func
(paren
id|mega_host_config
op_star
id|this_hba
comma
r_int
id|logdrv
)paren
(brace
r_int
id|rval
suffix:semicolon
id|IO_LOCK_T
suffix:semicolon
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|wq
)paren
suffix:semicolon
id|mega_scb
op_star
id|scbp
suffix:semicolon
multiline_comment|/*&n;&t; * Stop sending commands to the controller, queue them internally.&n;&t; * When deletion is complete, ISR will flush the queue.&n;&t; */
id|IO_LOCK
c_func
(paren
id|this_hba-&gt;host
)paren
suffix:semicolon
id|this_hba-&gt;quiescent
op_assign
l_int|1
suffix:semicolon
id|IO_UNLOCK
c_func
(paren
id|this_hba-&gt;host
)paren
suffix:semicolon
r_while
c_loop
(paren
id|this_hba-&gt;qPcnt
)paren
(brace
id|sleep_on_timeout
c_func
(paren
op_amp
id|wq
comma
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* sleep for 1s */
)brace
id|rval
op_assign
id|mega_do_del_logdrv
c_func
(paren
id|this_hba
comma
id|logdrv
)paren
suffix:semicolon
id|IO_LOCK
c_func
(paren
id|this_hba-&gt;host
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Attach the internal queue to the pending queue&n;&t; */
r_if
c_cond
(paren
id|this_hba-&gt;qPendingH
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t; * If pending queue head is null, make internal queue as&n;&t;&t; * pending queue&n;&t;&t; */
id|this_hba-&gt;qPendingH
op_assign
id|this_hba-&gt;int_qh
suffix:semicolon
id|this_hba-&gt;qPendingT
op_assign
id|this_hba-&gt;int_qt
suffix:semicolon
id|this_hba-&gt;qPcnt
op_assign
id|this_hba-&gt;int_qlen
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Append pending queue to internal queue&n;&t;&t; */
r_if
c_cond
(paren
id|this_hba-&gt;int_qt
)paren
(brace
id|this_hba-&gt;int_qt-&gt;next
op_assign
id|this_hba-&gt;qPendingH
suffix:semicolon
id|this_hba-&gt;qPendingH
op_assign
id|this_hba-&gt;int_qh
suffix:semicolon
id|this_hba-&gt;qPcnt
op_add_assign
id|this_hba-&gt;int_qlen
suffix:semicolon
)brace
)brace
id|this_hba-&gt;int_qh
op_assign
id|this_hba-&gt;int_qt
op_assign
l_int|NULL
suffix:semicolon
id|this_hba-&gt;int_qlen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * If delete operation was successful, add 0x80 to the logical drive&n;&t; * ids for commands in the pending queue.&n;&t; */
r_if
c_cond
(paren
id|this_hba-&gt;read_ldidmap
)paren
(brace
r_for
c_loop
(paren
id|scbp
op_assign
id|this_hba-&gt;qPendingH
suffix:semicolon
id|scbp
suffix:semicolon
id|scbp
op_assign
id|scbp-&gt;next
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
r_if
c_cond
(paren
id|scbp-&gt;pthru-&gt;logdrv
OL
l_int|0x80
)paren
(brace
id|scbp-&gt;pthru-&gt;logdrv
op_add_assign
l_int|0x80
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|scbp-&gt;pthru.logdrv
OL
l_int|0x80
)paren
(brace
id|scbp-&gt;pthru.logdrv
op_add_assign
l_int|0x80
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
id|this_hba-&gt;quiescent
op_assign
l_int|0
suffix:semicolon
id|IO_UNLOCK
c_func
(paren
id|this_hba-&gt;host
)paren
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
r_static
r_int
DECL|function|mega_do_del_logdrv
id|mega_do_del_logdrv
c_func
(paren
id|mega_host_config
op_star
id|this_hba
comma
r_int
id|logdrv
)paren
(brace
id|mega_mailbox
op_star
id|mboxpnt
suffix:semicolon
r_int
r_char
id|mbox
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|rval
suffix:semicolon
id|mboxpnt
op_assign
(paren
id|mega_mailbox
op_star
)paren
id|mbox
suffix:semicolon
id|memset
c_func
(paren
id|mbox
comma
l_int|0
comma
r_sizeof
(paren
id|mbox
)paren
)paren
suffix:semicolon
id|mbox
(braket
l_int|0
)braket
op_assign
id|FC_DEL_LOGDRV
suffix:semicolon
id|mbox
(braket
l_int|2
)braket
op_assign
id|OP_DEL_LOGDRV
suffix:semicolon
id|mbox
(braket
l_int|3
)braket
op_assign
id|logdrv
suffix:semicolon
id|rval
op_assign
id|megaIssueCmd
c_func
(paren
id|this_hba
comma
id|mbox
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* log this event */
r_if
c_cond
(paren
id|rval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;megaraid: Attempt to delete logical drive %d failed.&quot;
comma
id|logdrv
)paren
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;megaraid: logical drive %d deleted.&bslash;n&quot;
comma
id|logdrv
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * After deleting first logical drive, the logical drives must be&n;&t; * addressed by adding 0x80 to the logical drive id.&n;&t; */
id|this_hba-&gt;read_ldidmap
op_assign
l_int|1
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,4,0)
r_void
op_star
DECL|function|dma_alloc_consistent
id|dma_alloc_consistent
c_func
(paren
r_void
op_star
id|dev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_addr
)paren
(brace
r_void
op_star
id|_tv
suffix:semicolon
r_int
id|npages
suffix:semicolon
r_int
id|order
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * How many pages application needs&n;&t; */
id|npages
op_assign
id|size
op_div
id|PAGE_SIZE
suffix:semicolon
multiline_comment|/* Do we need one more page */
r_if
c_cond
(paren
id|size
op_mod
id|PAGE_SIZE
)paren
(brace
id|npages
op_increment
suffix:semicolon
)brace
id|order
op_assign
id|mega_get_order
c_func
(paren
id|npages
)paren
suffix:semicolon
id|_tv
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_DMA
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_tv
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|_tv
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
op_star
(paren
id|dma_addr
)paren
op_assign
id|virt_to_bus
c_func
(paren
id|_tv
)paren
suffix:semicolon
)brace
r_return
id|_tv
suffix:semicolon
)brace
multiline_comment|/*&n; * int mega_get_order(int)&n; *&n; * returns the order to be used as 2nd argument to __get_free_pages() - which&n; * return pages equal to pow(2, order) - AM&n; */
r_int
DECL|function|mega_get_order
id|mega_get_order
c_func
(paren
r_int
id|n
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|pow_2
c_func
(paren
id|i
op_increment
)paren
OL
id|n
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* null statement */
r_return
id|i
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * int pow_2(int)&n; *&n; * calculates pow(2, i)&n; */
r_int
DECL|function|pow_2
id|pow_2
c_func
(paren
r_int
id|i
)paren
(brace
r_int
r_int
id|v
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
id|v
op_lshift_assign
l_int|1
suffix:semicolon
)brace
r_return
id|v
suffix:semicolon
)brace
r_void
DECL|function|dma_free_consistent
id|dma_free_consistent
c_func
(paren
r_void
op_star
id|dev
comma
r_int
id|size
comma
r_void
op_star
id|vaddr
comma
id|dma_addr_t
id|dma_addr
)paren
(brace
r_int
id|npages
suffix:semicolon
r_int
id|order
op_assign
l_int|0
suffix:semicolon
id|npages
op_assign
id|size
op_div
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
op_mod
id|PAGE_SIZE
)paren
(brace
id|npages
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|npages
op_eq
l_int|1
)paren
id|order
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|npages
op_eq
l_int|2
)paren
id|order
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|npages
op_le
l_int|4
)paren
id|order
op_assign
l_int|2
suffix:semicolon
r_else
id|order
op_assign
l_int|3
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|vaddr
comma
id|order
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
r_static
macro_line|#endif&t;&t;&t;&t;/* LINUX VERSION 2.4.XX */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0) || defined(MODULE)
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|MEGARAID
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif&t;&t;&t;&t;/* LINUX VERSION 2.4.XX || MODULE */
multiline_comment|/* vi: set ts=4: */
eof
