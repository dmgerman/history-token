multiline_comment|/*&n; *                  QLOGIC LINUX SOFTWARE&n; *&n; * QLogic ISP2x00 device driver for Linux 2.6.x&n; * Copyright (C) 2003-2004 QLogic Corporation&n; * (www.qlogic.com)&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; */
macro_line|#include &quot;qla_def.h&quot;
multiline_comment|/**&n; * IO descriptor handle definitions.&n; *&n; * Signature form:&n; *&n; *&t;|31------28|27-------------------12|11-------0|&n; *&t;|   Type   |   Rolling Signature   |   Index  |&n; *&t;|----------|-----------------------|----------|&n; *&n; **/
DECL|macro|HDL_TYPE_SCSI
mdefine_line|#define HDL_TYPE_SCSI&t;&t;0
DECL|macro|HDL_TYPE_ASYNC_IOCB
mdefine_line|#define HDL_TYPE_ASYNC_IOCB&t;0x0A
DECL|macro|HDL_INDEX_BITS
mdefine_line|#define HDL_INDEX_BITS&t;12
DECL|macro|HDL_ITER_BITS
mdefine_line|#define HDL_ITER_BITS&t;16
DECL|macro|HDL_TYPE_BITS
mdefine_line|#define HDL_TYPE_BITS&t;4
DECL|macro|HDL_INDEX_MASK
mdefine_line|#define HDL_INDEX_MASK&t;((1UL &lt;&lt; HDL_INDEX_BITS) - 1)
DECL|macro|HDL_ITER_MASK
mdefine_line|#define HDL_ITER_MASK&t;((1UL &lt;&lt; HDL_ITER_BITS) - 1)
DECL|macro|HDL_TYPE_MASK
mdefine_line|#define HDL_TYPE_MASK&t;((1UL &lt;&lt; HDL_TYPE_BITS) - 1)
DECL|macro|HDL_INDEX_SHIFT
mdefine_line|#define HDL_INDEX_SHIFT&t;0
DECL|macro|HDL_ITER_SHIFT
mdefine_line|#define HDL_ITER_SHIFT&t;(HDL_INDEX_SHIFT + HDL_INDEX_BITS)
DECL|macro|HDL_TYPE_SHIFT
mdefine_line|#define HDL_TYPE_SHIFT&t;(HDL_ITER_SHIFT + HDL_ITER_BITS)
multiline_comment|/* Local Prototypes. */
r_static
r_inline
r_uint32
id|qla2x00_to_handle
c_func
(paren
r_uint16
comma
r_uint16
comma
r_uint16
)paren
suffix:semicolon
r_static
r_inline
r_uint16
id|qla2x00_handle_to_idx
c_func
(paren
r_uint32
)paren
suffix:semicolon
r_static
r_inline
r_uint16
id|qla2x00_handle_to_iter
c_func
(paren
r_uint32
)paren
suffix:semicolon
r_static
r_inline
r_uint16
id|qla2x00_handle_to_type
c_func
(paren
r_uint32
)paren
suffix:semicolon
r_static
r_inline
r_uint32
id|qla2x00_iodesc_to_handle
c_func
(paren
r_struct
id|io_descriptor
op_star
)paren
suffix:semicolon
r_static
r_inline
r_struct
id|io_descriptor
op_star
id|qla2x00_handle_to_iodesc
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint32
)paren
suffix:semicolon
r_static
r_inline
r_struct
id|io_descriptor
op_star
id|qla2x00_alloc_iodesc
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|qla2x00_free_iodesc
c_func
(paren
r_struct
id|io_descriptor
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|qla2x00_init_io_descriptors
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_iodesc_timeout
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_inline
r_void
id|qla2x00_add_iodesc_timer
c_func
(paren
r_struct
id|io_descriptor
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|qla2x00_remove_iodesc_timer
c_func
(paren
r_struct
id|io_descriptor
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|qla2x00_update_login_fcport
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|mbx_entry
op_star
comma
id|fc_port_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_send_abort_iocb
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|io_descriptor
op_star
comma
r_uint32
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_send_abort_iocb_cb
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|io_descriptor
op_star
comma
r_struct
id|mbx_entry
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_send_adisc_iocb
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|io_descriptor
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_send_adisc_iocb_cb
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|io_descriptor
op_star
comma
r_struct
id|mbx_entry
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_send_logout_iocb
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|io_descriptor
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_send_logout_iocb_cb
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|io_descriptor
op_star
comma
r_struct
id|mbx_entry
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_send_login_iocb
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|io_descriptor
op_star
comma
id|port_id_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_send_login_iocb_cb
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|io_descriptor
op_star
comma
r_struct
id|mbx_entry
op_star
)paren
suffix:semicolon
multiline_comment|/** &n; * Mailbox IOCB callback array.&n; **/
DECL|variable|iocb_function_cb_list
r_static
r_int
(paren
op_star
id|iocb_function_cb_list
(braket
id|LAST_IOCB_CB
)braket
)paren
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|io_descriptor
op_star
comma
r_struct
id|mbx_entry
op_star
)paren
op_assign
(brace
id|qla2x00_send_abort_iocb_cb
comma
id|qla2x00_send_adisc_iocb_cb
comma
id|qla2x00_send_logout_iocb_cb
comma
id|qla2x00_send_login_iocb_cb
comma
)brace
suffix:semicolon
multiline_comment|/** &n; * Generic IO descriptor handle routines.&n; **/
multiline_comment|/**&n; * qla2x00_to_handle() - Create a descriptor handle.&n; * @type: descriptor type&n; * @iter: descriptor rolling signature&n; * @idx: index to the descriptor array&n; *&n; * Returns a composite handle based in the @type, @iter, and @idx.&n; */
r_static
r_inline
r_uint32
DECL|function|qla2x00_to_handle
id|qla2x00_to_handle
c_func
(paren
r_uint16
id|type
comma
r_uint16
id|iter
comma
r_uint16
id|idx
)paren
(brace
r_return
(paren
(paren
r_uint32
)paren
(paren
(paren
(paren
r_uint32
)paren
id|type
op_lshift
id|HDL_TYPE_SHIFT
)paren
op_or
(paren
(paren
r_uint32
)paren
id|iter
op_lshift
id|HDL_ITER_SHIFT
)paren
op_or
(paren
(paren
r_uint32
)paren
id|idx
op_lshift
id|HDL_INDEX_SHIFT
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_handle_to_idx() - Retrive the index for a given handle.&n; * @handle: descriptor handle&n; *&n; * Returns the index specified by the @handle.&n; */
r_static
r_inline
r_uint16
DECL|function|qla2x00_handle_to_idx
id|qla2x00_handle_to_idx
c_func
(paren
r_uint32
id|handle
)paren
(brace
r_return
(paren
(paren
r_uint16
)paren
(paren
(paren
(paren
id|handle
)paren
op_rshift
id|HDL_INDEX_SHIFT
)paren
op_amp
id|HDL_INDEX_MASK
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_handle_to_type() - Retrive the descriptor type for a given handle.&n; * @handle: descriptor handle&n; *&n; * Returns the descriptor type specified by the @handle.&n; */
r_static
r_inline
r_uint16
DECL|function|qla2x00_handle_to_type
id|qla2x00_handle_to_type
c_func
(paren
r_uint32
id|handle
)paren
(brace
r_return
(paren
(paren
r_uint16
)paren
(paren
(paren
(paren
id|handle
)paren
op_rshift
id|HDL_TYPE_SHIFT
)paren
op_amp
id|HDL_TYPE_MASK
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_handle_to_iter() - Retrive the rolling signature for a given handle.&n; * @handle: descriptor handle&n; *&n; * Returns the signature specified by the @handle.&n; */
r_static
r_inline
r_uint16
DECL|function|qla2x00_handle_to_iter
id|qla2x00_handle_to_iter
c_func
(paren
r_uint32
id|handle
)paren
(brace
r_return
(paren
(paren
r_uint16
)paren
(paren
(paren
(paren
id|handle
)paren
op_rshift
id|HDL_ITER_SHIFT
)paren
op_amp
id|HDL_ITER_MASK
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_iodesc_to_handle() - Convert an IO descriptor to a unique handle.&n; * @iodesc: io descriptor&n; *&n; * Returns a unique handle for @iodesc.&n; */
r_static
r_inline
r_uint32
DECL|function|qla2x00_iodesc_to_handle
id|qla2x00_iodesc_to_handle
c_func
(paren
r_struct
id|io_descriptor
op_star
id|iodesc
)paren
(brace
r_uint32
id|handle
suffix:semicolon
id|handle
op_assign
id|qla2x00_to_handle
c_func
(paren
id|HDL_TYPE_ASYNC_IOCB
comma
op_increment
id|iodesc-&gt;ha-&gt;iodesc_signature
comma
id|iodesc-&gt;idx
)paren
suffix:semicolon
id|iodesc-&gt;signature
op_assign
id|handle
suffix:semicolon
r_return
(paren
id|handle
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_handle_to_iodesc() - Retrieve an IO descriptor given a unique handle.&n; * @ha: HA context&n; * @handle: handle to io descriptor&n; *&n; * Returns a pointer to the io descriptor, or NULL, if the io descriptor does&n; * not exist or the io descriptors signature does not @handle.&n; */
r_static
r_inline
r_struct
id|io_descriptor
op_star
DECL|function|qla2x00_handle_to_iodesc
id|qla2x00_handle_to_iodesc
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint32
id|handle
)paren
(brace
r_uint16
id|idx
suffix:semicolon
r_struct
id|io_descriptor
op_star
id|iodesc
suffix:semicolon
id|idx
op_assign
id|qla2x00_handle_to_idx
c_func
(paren
id|handle
)paren
suffix:semicolon
id|iodesc
op_assign
op_amp
id|ha-&gt;io_descriptors
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|iodesc
)paren
r_if
c_cond
(paren
id|iodesc-&gt;signature
op_ne
id|handle
)paren
id|iodesc
op_assign
l_int|NULL
suffix:semicolon
r_return
(paren
id|iodesc
)paren
suffix:semicolon
)brace
multiline_comment|/** &n; * IO descriptor allocation routines.&n; **/
multiline_comment|/**&n; * qla2x00_alloc_iodesc() - Allocate an IO descriptor from the pool.&n; * @ha: HA context&n; *&n; * Returns a pointer to the allocated io descriptor, or NULL, if none available.&n; */
r_static
r_inline
r_struct
id|io_descriptor
op_star
DECL|function|qla2x00_alloc_iodesc
id|qla2x00_alloc_iodesc
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint16
id|iter
suffix:semicolon
r_struct
id|io_descriptor
op_star
id|iodesc
suffix:semicolon
id|iodesc
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|iter
op_assign
l_int|0
suffix:semicolon
id|iter
OL
id|MAX_IO_DESCRIPTORS
suffix:semicolon
id|iter
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;io_descriptors
(braket
id|iter
)braket
dot
id|used
)paren
r_continue
suffix:semicolon
id|iodesc
op_assign
op_amp
id|ha-&gt;io_descriptors
(braket
id|iter
)braket
suffix:semicolon
id|iodesc-&gt;used
op_assign
l_int|1
suffix:semicolon
id|iodesc-&gt;idx
op_assign
id|iter
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|iodesc-&gt;timer
)paren
suffix:semicolon
id|iodesc-&gt;ha
op_assign
id|ha
suffix:semicolon
id|iodesc-&gt;signature
op_assign
id|qla2x00_iodesc_to_handle
c_func
(paren
id|iodesc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
id|iodesc
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_free_iodesc() - Free an IO descriptor.&n; * @iodesc: io descriptor&n; *&n; * NOTE: The io descriptors timer *must* be stopped before it can be free&squot;d.&n; */
r_static
r_inline
r_void
DECL|function|qla2x00_free_iodesc
id|qla2x00_free_iodesc
c_func
(paren
r_struct
id|io_descriptor
op_star
id|iodesc
)paren
(brace
id|iodesc-&gt;used
op_assign
l_int|0
suffix:semicolon
id|iodesc-&gt;signature
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_remove_iodesc_timer() - Remove an active timer from an IO descriptor.&n; * @iodesc: io descriptor&n; */
r_static
r_inline
r_void
DECL|function|qla2x00_remove_iodesc_timer
id|qla2x00_remove_iodesc_timer
c_func
(paren
r_struct
id|io_descriptor
op_star
id|iodesc
)paren
(brace
r_if
c_cond
(paren
id|iodesc-&gt;timer.function
op_ne
l_int|NULL
)paren
(brace
id|del_timer_sync
c_func
(paren
op_amp
id|iodesc-&gt;timer
)paren
suffix:semicolon
id|iodesc-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
l_int|NULL
suffix:semicolon
id|iodesc-&gt;timer.function
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * qla2x00_init_io_descriptors() - Initialize the pool of IO descriptors.&n; * @ha: HA context&n; */
r_static
r_inline
r_void
DECL|function|qla2x00_init_io_descriptors
id|qla2x00_init_io_descriptors
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint16
id|iter
suffix:semicolon
r_for
c_loop
(paren
id|iter
op_assign
l_int|0
suffix:semicolon
id|iter
OL
id|MAX_IO_DESCRIPTORS
suffix:semicolon
id|iter
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;io_descriptors
(braket
id|iter
)braket
dot
id|used
)paren
r_continue
suffix:semicolon
id|qla2x00_remove_iodesc_timer
c_func
(paren
op_amp
id|ha-&gt;io_descriptors
(braket
id|iter
)braket
)paren
suffix:semicolon
id|qla2x00_free_iodesc
c_func
(paren
op_amp
id|ha-&gt;io_descriptors
(braket
id|iter
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/** &n; * IO descriptor timer routines.&n; **/
multiline_comment|/**&n; * qla2x00_iodesc_timeout() - Timeout IO descriptor handler.&n; * @data: io descriptor&n; */
r_static
r_void
DECL|function|qla2x00_iodesc_timeout
id|qla2x00_iodesc_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|io_descriptor
op_star
id|iodesc
suffix:semicolon
id|iodesc
op_assign
(paren
r_struct
id|io_descriptor
op_star
)paren
id|data
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): IO descriptor timeout, index=%x &quot;
l_string|&quot;signature=%08x, scheduling ISP abort.&bslash;n&quot;
comma
id|iodesc-&gt;ha-&gt;host_no
comma
id|iodesc-&gt;idx
comma
id|iodesc-&gt;signature
)paren
)paren
suffix:semicolon
id|qla2x00_free_iodesc
c_func
(paren
id|iodesc
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|iodesc-&gt;ha
comma
l_string|&quot;IO descriptor timeout. Scheduling ISP abort.&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|iodesc-&gt;ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_add_iodesc_timer() - Add and start a timer for an IO descriptor.&n; * @iodesc: io descriptor&n; *&n; * NOTE:&n; * The firmware shall timeout an outstanding mailbox IOCB in 2 * R_A_TOV (in&n; * tenths of a second) after it hits the wire.  But, if there are any request&n; * resource contraints (i.e. during heavy I/O), exchanges can be held off for&n; * at most R_A_TOV.  Therefore, the driver will wait 4 * R_A_TOV before&n; * scheduling a recovery (big hammer).&n; */
r_static
r_inline
r_void
DECL|function|qla2x00_add_iodesc_timer
id|qla2x00_add_iodesc_timer
c_func
(paren
r_struct
id|io_descriptor
op_star
id|iodesc
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
id|timeout
op_assign
(paren
id|iodesc-&gt;ha-&gt;r_a_tov
op_star
l_int|4
)paren
op_div
l_int|10
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|iodesc-&gt;timer
)paren
suffix:semicolon
id|iodesc-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|iodesc
suffix:semicolon
id|iodesc-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|timeout
op_star
id|HZ
)paren
suffix:semicolon
id|iodesc-&gt;timer.function
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|qla2x00_iodesc_timeout
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|iodesc-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/** &n; * IO descriptor support routines.&n; **/
multiline_comment|/**&n; * qla2x00_update_login_fcport() - Update fcport data after login processing.&n; * @ha: HA context&n; * @mbxstat: Mailbox command status IOCB&n; * @fcport: port to update&n; */
r_static
r_inline
r_void
DECL|function|qla2x00_update_login_fcport
id|qla2x00_update_login_fcport
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|mbx_entry
op_star
id|mbxstat
comma
id|fc_port_t
op_star
id|fcport
)paren
(brace
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;mb1
)paren
op_amp
id|BIT_0
)paren
(brace
id|fcport-&gt;port_type
op_assign
id|FCT_INITIATOR
suffix:semicolon
)brace
r_else
(brace
id|fcport-&gt;port_type
op_assign
id|FCT_TARGET
suffix:semicolon
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;mb1
)paren
op_amp
id|BIT_1
)paren
(brace
id|fcport-&gt;flags
op_or_assign
id|FCF_TAPE_PRESENT
suffix:semicolon
)brace
)brace
id|fcport-&gt;login_retry
op_assign
l_int|0
suffix:semicolon
id|fcport-&gt;port_login_retry_count
op_assign
id|ha-&gt;port_down_retry_count
op_star
id|PORT_RETRY_TIME
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;port_down_timer
comma
id|ha-&gt;port_down_retry_count
op_star
id|PORT_RETRY_TIME
)paren
suffix:semicolon
id|fcport-&gt;flags
op_or_assign
id|FCF_FABRIC_DEVICE
suffix:semicolon
id|fcport-&gt;flags
op_and_assign
op_complement
id|FCF_FAILOVER_NEEDED
suffix:semicolon
id|fcport-&gt;iodesc_idx_sent
op_assign
id|IODESC_INVALID_INDEX
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_ONLINE
)paren
suffix:semicolon
)brace
multiline_comment|/** &n; * Mailbox IOCB commands.&n; **/
multiline_comment|/**&n; * qla2x00_get_mbx_iocb_entry() - Retrieve an IOCB from the request queue.&n; * @ha: HA context&n; * @handle: handle to io descriptor&n; *&n; * Returns a pointer to the reqest entry, or NULL, if none were available.&n; */
r_static
r_inline
r_struct
id|mbx_entry
op_star
DECL|function|qla2x00_get_mbx_iocb_entry
id|qla2x00_get_mbx_iocb_entry
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint32
id|handle
)paren
(brace
r_uint16
id|cnt
suffix:semicolon
id|device_reg_t
id|__iomem
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_struct
id|mbx_entry
op_star
id|mbxentry
suffix:semicolon
id|mbxentry
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_q_cnt
OL
l_int|3
)paren
(brace
id|cnt
op_assign
id|qla2x00_debounce_register
c_func
(paren
id|ISP_REQ_Q_OUT
c_func
(paren
id|ha
comma
id|reg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
OL
id|cnt
)paren
id|ha-&gt;req_q_cnt
op_assign
id|cnt
op_minus
id|ha-&gt;req_ring_index
suffix:semicolon
r_else
id|ha-&gt;req_q_cnt
op_assign
id|ha-&gt;request_q_length
op_minus
(paren
id|ha-&gt;req_ring_index
op_minus
id|cnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;req_q_cnt
op_ge
l_int|3
)paren
(brace
id|mbxentry
op_assign
(paren
r_struct
id|mbx_entry
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
id|memset
c_func
(paren
id|mbxentry
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mbx_entry
)paren
)paren
suffix:semicolon
id|mbxentry-&gt;entry_type
op_assign
id|MBX_IOCB_TYPE
suffix:semicolon
id|mbxentry-&gt;entry_count
op_assign
l_int|1
suffix:semicolon
id|mbxentry-&gt;sys_define1
op_assign
id|SOURCE_ASYNC_IOCB
suffix:semicolon
id|mbxentry-&gt;handle
op_assign
id|handle
suffix:semicolon
)brace
r_return
(paren
id|mbxentry
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_send_abort_iocb() - Issue an abort IOCB to the firmware.&n; * @ha: HA context&n; * @iodesc: io descriptor&n; * @handle_to_abort: firmware handle to abort&n; * @ha_locked: is function called with the hardware lock&n; *&n; * Returns QLA_SUCCESS if the IOCB was issued.&n; */
r_static
r_int
DECL|function|qla2x00_send_abort_iocb
id|qla2x00_send_abort_iocb
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|io_descriptor
op_star
id|iodesc
comma
r_uint32
id|handle_to_abort
comma
r_int
id|ha_locked
)paren
(brace
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|mbx_entry
op_star
id|mbxentry
suffix:semicolon
multiline_comment|/* Send marker if required. */
r_if
c_cond
(paren
id|qla2x00_issue_marker
c_func
(paren
id|ha
comma
id|ha_locked
)paren
op_ne
id|QLA_SUCCESS
)paren
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Build abort mailbox IOCB. */
id|mbxentry
op_assign
id|qla2x00_get_mbx_iocb_entry
c_func
(paren
id|ha
comma
id|iodesc-&gt;signature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbxentry
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
)brace
id|mbxentry-&gt;mb0
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|MBC_ABORT_COMMAND
)paren
suffix:semicolon
id|mbxentry-&gt;mb1
op_assign
id|mbxentry-&gt;loop_id.extended
op_assign
id|cpu_to_le16
c_func
(paren
id|iodesc-&gt;remote_fcport-&gt;loop_id
)paren
suffix:semicolon
id|mbxentry-&gt;mb2
op_assign
id|LSW
c_func
(paren
id|handle_to_abort
)paren
suffix:semicolon
id|mbxentry-&gt;mb3
op_assign
id|MSW
c_func
(paren
id|handle_to_abort
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|qla2x00_add_iodesc_timer
c_func
(paren
id|iodesc
)paren
suffix:semicolon
multiline_comment|/* Issue command to ISP. */
id|qla2x00_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Sending Abort IOCB (%08x) to [%x], aborting &quot;
l_string|&quot;%08x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|iodesc-&gt;signature
comma
id|iodesc-&gt;remote_fcport-&gt;loop_id
comma
id|handle_to_abort
)paren
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_send_abort_iocb_cb() - Abort IOCB callback.&n; * @ha: HA context&n; * @iodesc: io descriptor&n; * @mbxstat: mailbox status IOCB&n; *&n; * Returns QLA_SUCCESS if @iodesc can be freed by the caller, else, @iodesc&n; * will be used for a retry.&n; */
r_static
r_int
DECL|function|qla2x00_send_abort_iocb_cb
id|qla2x00_send_abort_iocb_cb
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|io_descriptor
op_star
id|iodesc
comma
r_struct
id|mbx_entry
op_star
id|mbxstat
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Abort IOCB -- sent to [%x/%02x%02x%02x], &quot;
l_string|&quot;status=%x mb0=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|iodesc-&gt;remote_fcport-&gt;loop_id
comma
id|iodesc-&gt;d_id.b.domain
comma
id|iodesc-&gt;d_id.b.area
comma
id|iodesc-&gt;d_id.b.al_pa
comma
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;status
)paren
comma
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;mb0
)paren
)paren
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_send_adisc_iocb() - Issue a Get Port Database IOCB to the firmware.&n; * @ha: HA context&n; * @iodesc: io descriptor&n; * @ha_locked: is function called with the hardware lock&n; *&n; * Returns QLA_SUCCESS if the IOCB was issued.&n; */
r_static
r_int
DECL|function|qla2x00_send_adisc_iocb
id|qla2x00_send_adisc_iocb
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|io_descriptor
op_star
id|iodesc
comma
r_int
id|ha_locked
)paren
(brace
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|mbx_entry
op_star
id|mbxentry
suffix:semicolon
multiline_comment|/* Send marker if required. */
r_if
c_cond
(paren
id|qla2x00_issue_marker
c_func
(paren
id|ha
comma
id|ha_locked
)paren
op_ne
id|QLA_SUCCESS
)paren
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Build Get Port Database IOCB. */
id|mbxentry
op_assign
id|qla2x00_get_mbx_iocb_entry
c_func
(paren
id|ha
comma
id|iodesc-&gt;signature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbxentry
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
)brace
id|mbxentry-&gt;mb0
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|MBC_GET_PORT_DATABASE
)paren
suffix:semicolon
id|mbxentry-&gt;mb1
op_assign
id|mbxentry-&gt;loop_id.extended
op_assign
id|cpu_to_le16
c_func
(paren
id|iodesc-&gt;remote_fcport-&gt;loop_id
)paren
suffix:semicolon
id|mbxentry-&gt;mb2
op_assign
id|cpu_to_le16
c_func
(paren
id|MSW
c_func
(paren
id|LSD
c_func
(paren
id|ha-&gt;iodesc_pd_dma
)paren
)paren
)paren
suffix:semicolon
id|mbxentry-&gt;mb3
op_assign
id|cpu_to_le16
c_func
(paren
id|LSW
c_func
(paren
id|LSD
c_func
(paren
id|ha-&gt;iodesc_pd_dma
)paren
)paren
)paren
suffix:semicolon
id|mbxentry-&gt;mb6
op_assign
id|cpu_to_le16
c_func
(paren
id|MSW
c_func
(paren
id|MSD
c_func
(paren
id|ha-&gt;iodesc_pd_dma
)paren
)paren
)paren
suffix:semicolon
id|mbxentry-&gt;mb7
op_assign
id|cpu_to_le16
c_func
(paren
id|LSW
c_func
(paren
id|MSD
c_func
(paren
id|ha-&gt;iodesc_pd_dma
)paren
)paren
)paren
suffix:semicolon
id|mbxentry-&gt;mb10
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|BIT_0
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|qla2x00_add_iodesc_timer
c_func
(paren
id|iodesc
)paren
suffix:semicolon
multiline_comment|/* Issue command to ISP. */
id|qla2x00_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Sending Adisc IOCB (%08x) to [%x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|iodesc-&gt;signature
comma
id|iodesc-&gt;remote_fcport-&gt;loop_id
)paren
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_send_adisc_iocb_cb() - Get Port Database IOCB callback.&n; * @ha: HA context&n; * @iodesc: io descriptor&n; * @mbxstat: mailbox status IOCB&n; *&n; * Returns QLA_SUCCESS if @iodesc can be freed by the caller, else, @iodesc&n; * will be used for a retry.&n; */
r_static
r_int
DECL|function|qla2x00_send_adisc_iocb_cb
id|qla2x00_send_adisc_iocb_cb
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|io_descriptor
op_star
id|iodesc
comma
r_struct
id|mbx_entry
op_star
id|mbxstat
)paren
(brace
id|fc_port_t
op_star
id|remote_fcport
suffix:semicolon
id|remote_fcport
op_assign
id|iodesc-&gt;remote_fcport
suffix:semicolon
multiline_comment|/* Ensure the port IDs are consistent. */
r_if
c_cond
(paren
id|remote_fcport-&gt;d_id.b24
op_ne
id|iodesc-&gt;d_id.b24
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Adisc IOCB -- ignoring, remote port &quot;
l_string|&quot;id changed from [%02x%02x%02x] to [%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;d_id.b.domain
comma
id|remote_fcport-&gt;d_id.b.area
comma
id|remote_fcport-&gt;d_id.b.al_pa
comma
id|iodesc-&gt;d_id.b.domain
comma
id|iodesc-&gt;d_id.b.area
comma
id|iodesc-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/* Only process the last command. */
r_if
c_cond
(paren
id|remote_fcport-&gt;iodesc_idx_sent
op_ne
id|iodesc-&gt;idx
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Adisc IOCB -- ignoring, sent to &quot;
l_string|&quot;[%02x%02x%02x], expected %x, received %x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|iodesc-&gt;d_id.b.domain
comma
id|iodesc-&gt;d_id.b.area
comma
id|iodesc-&gt;d_id.b.al_pa
comma
id|remote_fcport-&gt;iodesc_idx_sent
comma
id|iodesc-&gt;idx
)paren
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;status
)paren
op_eq
id|CS_COMPLETE
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Adisc IOCB -- marking &quot;
l_string|&quot;[%x/%02x%02x%02x] online.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|remote_fcport-&gt;d_id.b.domain
comma
id|remote_fcport-&gt;d_id.b.area
comma
id|remote_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|remote_fcport-&gt;state
comma
id|FCS_ONLINE
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Adisc IOCB -- marking &quot;
l_string|&quot;[%x/%02x%02x%02x] lost, status=%x mb0=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|remote_fcport-&gt;d_id.b.domain
comma
id|remote_fcport-&gt;d_id.b.area
comma
id|remote_fcport-&gt;d_id.b.al_pa
comma
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;status
)paren
comma
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;mb0
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|remote_fcport-&gt;state
)paren
op_ne
id|FCS_DEVICE_DEAD
)paren
id|atomic_set
c_func
(paren
op_amp
id|remote_fcport-&gt;state
comma
id|FCS_DEVICE_LOST
)paren
suffix:semicolon
)brace
id|remote_fcport-&gt;iodesc_idx_sent
op_assign
id|IODESC_INVALID_INDEX
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_send_logout_iocb() - Issue a fabric port logout IOCB to the firmware.&n; * @ha: HA context&n; * @iodesc: io descriptor&n; * @ha_locked: is function called with the hardware lock&n; *&n; * Returns QLA_SUCCESS if the IOCB was issued.&n; */
r_static
r_int
DECL|function|qla2x00_send_logout_iocb
id|qla2x00_send_logout_iocb
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|io_descriptor
op_star
id|iodesc
comma
r_int
id|ha_locked
)paren
(brace
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|mbx_entry
op_star
id|mbxentry
suffix:semicolon
multiline_comment|/* Send marker if required. */
r_if
c_cond
(paren
id|qla2x00_issue_marker
c_func
(paren
id|ha
comma
id|ha_locked
)paren
op_ne
id|QLA_SUCCESS
)paren
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Build fabric port logout mailbox IOCB. */
id|mbxentry
op_assign
id|qla2x00_get_mbx_iocb_entry
c_func
(paren
id|ha
comma
id|iodesc-&gt;signature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbxentry
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
)brace
id|mbxentry-&gt;mb0
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|MBC_LOGOUT_FABRIC_PORT
)paren
suffix:semicolon
id|mbxentry-&gt;mb1
op_assign
id|mbxentry-&gt;loop_id.extended
op_assign
id|cpu_to_le16
c_func
(paren
id|iodesc-&gt;remote_fcport-&gt;loop_id
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|qla2x00_add_iodesc_timer
c_func
(paren
id|iodesc
)paren
suffix:semicolon
multiline_comment|/* Issue command to ISP. */
id|qla2x00_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Sending Logout IOCB (%08x) to [%x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|iodesc-&gt;signature
comma
id|iodesc-&gt;remote_fcport-&gt;loop_id
)paren
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_send_logout_iocb_cb() - Fabric port logout IOCB callback.&n; * @ha: HA context&n; * @iodesc: io descriptor&n; * @mbxstat: mailbox status IOCB&n; *&n; * Returns QLA_SUCCESS if @iodesc can be freed by the caller, else, @iodesc&n; * will be used for a retry.&n; */
r_static
r_int
DECL|function|qla2x00_send_logout_iocb_cb
id|qla2x00_send_logout_iocb_cb
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|io_descriptor
op_star
id|iodesc
comma
r_struct
id|mbx_entry
op_star
id|mbxstat
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Logout IOCB -- sent to [%x/%02x%02x%02x], &quot;
l_string|&quot;status=%x mb0=%x mb1=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|iodesc-&gt;remote_fcport-&gt;loop_id
comma
id|iodesc-&gt;remote_fcport-&gt;d_id.b.domain
comma
id|iodesc-&gt;remote_fcport-&gt;d_id.b.area
comma
id|iodesc-&gt;remote_fcport-&gt;d_id.b.al_pa
comma
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;status
)paren
comma
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;mb0
)paren
comma
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;mb1
)paren
)paren
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_send_login_iocb() - Issue a fabric port login IOCB to the firmware.&n; * @ha: HA context&n; * @iodesc: io descriptor&n; * @d_id: port id for device&n; * @ha_locked: is function called with the hardware lock&n; *&n; * Returns QLA_SUCCESS if the IOCB was issued.&n; */
r_static
r_int
DECL|function|qla2x00_send_login_iocb
id|qla2x00_send_login_iocb
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|io_descriptor
op_star
id|iodesc
comma
id|port_id_t
op_star
id|d_id
comma
r_int
id|ha_locked
)paren
(brace
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|mbx_entry
op_star
id|mbxentry
suffix:semicolon
multiline_comment|/* Send marker if required. */
r_if
c_cond
(paren
id|qla2x00_issue_marker
c_func
(paren
id|ha
comma
id|ha_locked
)paren
op_ne
id|QLA_SUCCESS
)paren
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Build fabric port login mailbox IOCB. */
id|mbxentry
op_assign
id|qla2x00_get_mbx_iocb_entry
c_func
(paren
id|ha
comma
id|iodesc-&gt;signature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbxentry
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
)brace
id|mbxentry-&gt;mb0
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|MBC_LOGIN_FABRIC_PORT
)paren
suffix:semicolon
id|mbxentry-&gt;mb1
op_assign
id|mbxentry-&gt;loop_id.extended
op_assign
id|cpu_to_le16
c_func
(paren
id|iodesc-&gt;remote_fcport-&gt;loop_id
)paren
suffix:semicolon
id|mbxentry-&gt;mb2
op_assign
id|cpu_to_le16
c_func
(paren
id|d_id-&gt;b.domain
)paren
suffix:semicolon
id|mbxentry-&gt;mb3
op_assign
id|cpu_to_le16
c_func
(paren
id|d_id-&gt;b.area
op_lshift
l_int|8
op_or
id|d_id-&gt;b.al_pa
)paren
suffix:semicolon
id|mbxentry-&gt;mb10
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|BIT_0
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|qla2x00_add_iodesc_timer
c_func
(paren
id|iodesc
)paren
suffix:semicolon
multiline_comment|/* Issue command to ISP. */
id|qla2x00_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha_locked
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Sending Login IOCB (%08x) to &quot;
l_string|&quot;[%x/%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|iodesc-&gt;signature
comma
id|iodesc-&gt;remote_fcport-&gt;loop_id
comma
id|d_id-&gt;b.domain
comma
id|d_id-&gt;b.area
comma
id|d_id-&gt;b.al_pa
)paren
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_send_login_iocb_cb() - Fabric port logout IOCB callback.&n; * @ha: HA context&n; * @iodesc: io descriptor&n; * @mbxstat: mailbox status IOCB&n; *&n; * Returns QLA_SUCCESS if @iodesc can be freed by the caller, else, @iodesc&n; * will be used for a retry.&n; */
r_static
r_int
DECL|function|qla2x00_send_login_iocb_cb
id|qla2x00_send_login_iocb_cb
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|io_descriptor
op_star
id|iodesc
comma
r_struct
id|mbx_entry
op_star
id|mbxstat
)paren
(brace
r_int
id|rval
suffix:semicolon
id|fc_port_t
op_star
id|fcport
comma
op_star
id|remote_fcport
comma
op_star
id|exist_fcport
suffix:semicolon
r_struct
id|io_descriptor
op_star
id|abort_iodesc
comma
op_star
id|login_iodesc
suffix:semicolon
r_uint16
id|status
comma
id|mb
(braket
l_int|8
)braket
suffix:semicolon
r_uint16
id|reuse
suffix:semicolon
r_uint16
id|remote_loopid
suffix:semicolon
id|port_id_t
id|remote_did
comma
id|inuse_did
suffix:semicolon
id|remote_fcport
op_assign
id|iodesc-&gt;remote_fcport
suffix:semicolon
multiline_comment|/* Only process the last command. */
r_if
c_cond
(paren
id|remote_fcport-&gt;iodesc_idx_sent
op_ne
id|iodesc-&gt;idx
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- ignoring, sent to &quot;
l_string|&quot;[%02x%02x%02x], expected %x, received %x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|iodesc-&gt;d_id.b.domain
comma
id|iodesc-&gt;d_id.b.area
comma
id|iodesc-&gt;d_id.b.al_pa
comma
id|remote_fcport-&gt;iodesc_idx_sent
comma
id|iodesc-&gt;idx
)paren
)paren
suffix:semicolon
multiline_comment|/* Free RSCN fcport resources. */
r_if
c_cond
(paren
id|remote_fcport-&gt;port_type
op_eq
id|FCT_RSCN
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- Freeing RSCN &quot;
l_string|&quot;fcport %p [%x/%02x%02x%02x] given ignored Login &quot;
l_string|&quot;IOCB.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport
comma
id|remote_fcport-&gt;loop_id
comma
id|remote_fcport-&gt;d_id.b.domain
comma
id|remote_fcport-&gt;d_id.b.area
comma
id|remote_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|remote_fcport-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|remote_fcport
)paren
suffix:semicolon
)brace
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
id|status
op_assign
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;status
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;mb0
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;mb1
)paren
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;mb2
)paren
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;mb6
)paren
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|mbxstat-&gt;mb7
)paren
suffix:semicolon
multiline_comment|/* Good status? */
r_if
c_cond
(paren
(paren
id|status
op_eq
id|CS_COMPLETE
op_logical_or
id|status
op_eq
id|CS_COMPLETE_CHKCOND
)paren
op_logical_and
id|mb
(braket
l_int|0
)braket
op_eq
id|MBS_COMMAND_COMPLETE
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- status=%x mb1=%x pn=&quot;
l_string|&quot;%02x%02x%02x%02x%02x%02x%02x%02x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|status
comma
id|mb
(braket
l_int|1
)braket
comma
id|mbxstat-&gt;port_name
(braket
l_int|0
)braket
comma
id|mbxstat-&gt;port_name
(braket
l_int|1
)braket
comma
id|mbxstat-&gt;port_name
(braket
l_int|2
)braket
comma
id|mbxstat-&gt;port_name
(braket
l_int|3
)braket
comma
id|mbxstat-&gt;port_name
(braket
l_int|4
)braket
comma
id|mbxstat-&gt;port_name
(braket
l_int|5
)braket
comma
id|mbxstat-&gt;port_name
(braket
l_int|6
)braket
comma
id|mbxstat-&gt;port_name
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|remote_fcport-&gt;node_name
comma
id|mbxstat-&gt;node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|remote_fcport-&gt;port_name
comma
id|mbxstat-&gt;port_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
multiline_comment|/* Is the device already in our fcports list? */
r_if
c_cond
(paren
id|remote_fcport-&gt;port_type
op_ne
id|FCT_RSCN
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- marking &quot;
l_string|&quot;[%x/%02x%02x%02x] online.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|remote_fcport-&gt;d_id.b.domain
comma
id|remote_fcport-&gt;d_id.b.area
comma
id|remote_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|qla2x00_update_login_fcport
c_func
(paren
id|ha
comma
id|mbxstat
comma
id|remote_fcport
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/* Does the RSCN portname already exist in our fcports list? */
id|exist_fcport
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|remote_fcport-&gt;port_name
comma
id|fcport-&gt;port_name
comma
id|WWN_SIZE
)paren
op_eq
l_int|0
)paren
(brace
id|exist_fcport
op_assign
id|fcport
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|exist_fcport
op_ne
l_int|NULL
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- found RSCN &quot;
l_string|&quot;fcport in fcports list [%p].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|exist_fcport
)paren
)paren
suffix:semicolon
multiline_comment|/* Abort any ADISC that could have been sent. */
r_if
c_cond
(paren
id|exist_fcport-&gt;iodesc_idx_sent
op_ne
id|iodesc-&gt;idx
op_logical_and
id|exist_fcport-&gt;iodesc_idx_sent
OL
id|MAX_IO_DESCRIPTORS
op_logical_and
id|ha-&gt;io_descriptors
(braket
id|exist_fcport-&gt;iodesc_idx_sent
)braket
dot
id|cb_idx
op_eq
id|ADISC_PORT_IOCB_CB
)paren
(brace
id|abort_iodesc
op_assign
id|qla2x00_alloc_iodesc
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|abort_iodesc
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB &quot;
l_string|&quot;-- issuing abort to outstanding &quot;
l_string|&quot;Adisc [%x/%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|exist_fcport-&gt;d_id.b.domain
comma
id|exist_fcport-&gt;d_id.b.area
comma
id|exist_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|abort_iodesc-&gt;cb_idx
op_assign
id|ABORT_IOCB_CB
suffix:semicolon
id|abort_iodesc-&gt;d_id.b24
op_assign
id|exist_fcport-&gt;d_id.b24
suffix:semicolon
id|abort_iodesc-&gt;remote_fcport
op_assign
id|exist_fcport
suffix:semicolon
id|exist_fcport-&gt;iodesc_idx_sent
op_assign
id|abort_iodesc-&gt;idx
suffix:semicolon
id|qla2x00_send_abort_iocb
c_func
(paren
id|ha
comma
id|abort_iodesc
comma
id|ha-&gt;io_descriptors
(braket
id|exist_fcport-&gt;iodesc_idx_sent
)braket
dot
id|signature
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB &quot;
l_string|&quot;-- unable to abort outstanding &quot;
l_string|&quot;Adisc [%x/%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|exist_fcport-&gt;d_id.b.domain
comma
id|exist_fcport-&gt;d_id.b.area
comma
id|exist_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t;&t; * If the existing fcport is waiting to send an ADISC&n;&t;&t;&t; * or LOGIN, then reuse remote fcport (RSCN) to&n;&t;&t;&t; * continue waiting.&n;&t;&t;&t; */
id|reuse
op_assign
l_int|0
suffix:semicolon
id|remote_loopid
op_assign
id|remote_fcport-&gt;loop_id
suffix:semicolon
id|remote_did.b24
op_assign
id|remote_fcport-&gt;d_id.b24
suffix:semicolon
r_if
c_cond
(paren
id|exist_fcport-&gt;iodesc_idx_sent
op_eq
id|IODESC_ADISC_NEEDED
op_logical_or
id|exist_fcport-&gt;iodesc_idx_sent
op_eq
id|IODESC_LOGIN_NEEDED
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- &quot;
l_string|&quot;existing fcport [%x/%02x%02x%02x] &quot;
l_string|&quot;waiting for IO descriptor, reuse RSCN &quot;
l_string|&quot;fcport.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|exist_fcport-&gt;loop_id
comma
id|exist_fcport-&gt;d_id.b.domain
comma
id|exist_fcport-&gt;d_id.b.area
comma
id|exist_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|reuse
op_increment
suffix:semicolon
id|remote_fcport-&gt;iodesc_idx_sent
op_assign
id|exist_fcport-&gt;iodesc_idx_sent
suffix:semicolon
id|exist_fcport-&gt;iodesc_idx_sent
op_assign
id|IODESC_INVALID_INDEX
suffix:semicolon
id|remote_fcport-&gt;loop_id
op_assign
id|exist_fcport-&gt;loop_id
suffix:semicolon
id|remote_fcport-&gt;d_id.b24
op_assign
id|exist_fcport-&gt;d_id.b24
suffix:semicolon
)brace
multiline_comment|/* Logout the old loopid. */
r_if
c_cond
(paren
op_logical_neg
id|reuse
op_logical_and
id|exist_fcport-&gt;loop_id
op_ne
id|remote_fcport-&gt;loop_id
op_logical_and
id|exist_fcport-&gt;loop_id
op_ne
id|FC_NO_LOOP_ID
)paren
(brace
id|login_iodesc
op_assign
id|qla2x00_alloc_iodesc
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|login_iodesc
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB &quot;
l_string|&quot;-- issuing logout to free old &quot;
l_string|&quot;loop id [%x/%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|exist_fcport-&gt;loop_id
comma
id|exist_fcport-&gt;d_id.b.domain
comma
id|exist_fcport-&gt;d_id.b.area
comma
id|exist_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|login_iodesc-&gt;cb_idx
op_assign
id|LOGOUT_PORT_IOCB_CB
suffix:semicolon
id|login_iodesc-&gt;d_id.b24
op_assign
id|exist_fcport-&gt;d_id.b24
suffix:semicolon
id|login_iodesc-&gt;remote_fcport
op_assign
id|exist_fcport
suffix:semicolon
id|exist_fcport-&gt;iodesc_idx_sent
op_assign
id|login_iodesc-&gt;idx
suffix:semicolon
id|qla2x00_send_logout_iocb
c_func
(paren
id|ha
comma
id|login_iodesc
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Ran out of IO descriptiors. */
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB &quot;
l_string|&quot;-- unable to logout to free old &quot;
l_string|&quot;loop id [%x/%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|exist_fcport-&gt;loop_id
comma
id|exist_fcport-&gt;d_id.b.domain
comma
id|exist_fcport-&gt;d_id.b.area
comma
id|exist_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|exist_fcport-&gt;iodesc_idx_sent
op_assign
id|IODESC_INVALID_INDEX
suffix:semicolon
)brace
)brace
multiline_comment|/* Update existing fcport with remote fcport info. */
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- marking &quot;
l_string|&quot;existing fcport [%x/%02x%02x%02x] online.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_loopid
comma
id|remote_did.b.domain
comma
id|remote_did.b.area
comma
id|remote_did.b.al_pa
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|exist_fcport-&gt;node_name
comma
id|remote_fcport-&gt;node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|exist_fcport-&gt;loop_id
op_assign
id|remote_loopid
suffix:semicolon
id|exist_fcport-&gt;d_id.b24
op_assign
id|remote_did.b24
suffix:semicolon
id|qla2x00_update_login_fcport
c_func
(paren
id|ha
comma
id|mbxstat
comma
id|exist_fcport
)paren
suffix:semicolon
multiline_comment|/* Finally, free the remote (RSCN) fcport. */
r_if
c_cond
(paren
op_logical_neg
id|reuse
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- &quot;
l_string|&quot;Freeing RSCN fcport %p &quot;
l_string|&quot;[%x/%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport
comma
id|remote_fcport-&gt;loop_id
comma
id|remote_fcport-&gt;d_id.b.domain
comma
id|remote_fcport-&gt;d_id.b.area
comma
id|remote_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|remote_fcport-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|remote_fcport
)paren
suffix:semicolon
)brace
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * A new device has been added, move the RSCN fcport to our&n;&t;&t; * fcports list.&n;&t;&t; */
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- adding RSCN fcport &quot;
l_string|&quot;[%x/%02x%02x%02x] to fcports list.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|remote_fcport-&gt;d_id.b.domain
comma
id|remote_fcport-&gt;d_id.b.area
comma
id|remote_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|remote_fcport-&gt;list
)paren
suffix:semicolon
id|remote_fcport-&gt;flags
op_assign
(paren
id|FCF_RLC_SUPPORT
op_or
id|FCF_RESCAN_NEEDED
)paren
suffix:semicolon
id|qla2x00_update_login_fcport
c_func
(paren
id|ha
comma
id|mbxstat
comma
id|remote_fcport
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|remote_fcport-&gt;list
comma
op_amp
id|ha-&gt;fcports
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|FCPORT_RESCAN_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Handle login failure. */
r_if
c_cond
(paren
id|remote_fcport-&gt;login_retry
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|mb
(braket
l_int|0
)braket
op_eq
id|MBS_LOOP_ID_USED
)paren
(brace
id|inuse_did.b.domain
op_assign
id|LSB
c_func
(paren
id|mb
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|inuse_did.b.area
op_assign
id|MSB
c_func
(paren
id|mb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|inuse_did.b.al_pa
op_assign
id|LSB
c_func
(paren
id|mb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- loop &quot;
l_string|&quot;id [%x] used by port id [%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|inuse_did.b.domain
comma
id|inuse_did.b.area
comma
id|inuse_did.b.al_pa
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remote_fcport-&gt;d_id.b24
op_eq
id|INVALID_PORT_ID
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Invalid port id means we are trying&n;&t;&t;&t;&t;&t; * to login to a remote port with just&n;&t;&t;&t;&t;&t; * a loop id without knowing about the&n;&t;&t;&t;&t;&t; * port id.  Copy the port id and try&n;&t;&t;&t;&t;&t; * again.&n;&t;&t;&t;&t;&t; */
id|remote_fcport-&gt;d_id.b24
op_assign
id|inuse_did.b24
suffix:semicolon
id|iodesc-&gt;d_id.b24
op_assign
id|inuse_did.b24
suffix:semicolon
)brace
r_else
(brace
id|remote_fcport-&gt;loop_id
op_increment
suffix:semicolon
id|rval
op_assign
id|qla2x00_find_new_loop_id
c_func
(paren
id|ha
comma
id|remote_fcport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_FUNCTION_FAILED
)paren
(brace
multiline_comment|/* No more loop ids. */
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|mb
(braket
l_int|0
)braket
op_eq
id|MBS_PORT_ID_USED
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Device has another loop ID.  The firmware&n;&t;&t;&t;&t; * group recommends the driver perform an&n;&t;&t;&t;&t; * implicit login with the specified ID.&n;&t;&t;&t;&t; */
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- port &quot;
l_string|&quot;id [%02x%02x%02x] already assigned to &quot;
l_string|&quot;loop id [%x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|iodesc-&gt;d_id.b.domain
comma
id|iodesc-&gt;d_id.b.area
comma
id|iodesc-&gt;d_id.b.al_pa
comma
id|mb
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|remote_fcport-&gt;loop_id
op_assign
id|mb
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Unable to perform login, try again. */
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- &quot;
l_string|&quot;failed login [%x/%02x%02x%02x], status=%x &quot;
l_string|&quot;mb0=%x mb1=%x mb2=%x mb6=%x mb7=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|iodesc-&gt;d_id.b.domain
comma
id|iodesc-&gt;d_id.b.area
comma
id|iodesc-&gt;d_id.b.al_pa
comma
id|status
comma
id|mb
(braket
l_int|0
)braket
comma
id|mb
(braket
l_int|1
)braket
comma
id|mb
(braket
l_int|2
)braket
comma
id|mb
(braket
l_int|6
)braket
comma
id|mb
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Reissue Login with the same IO descriptor. */
id|iodesc-&gt;signature
op_assign
id|qla2x00_iodesc_to_handle
c_func
(paren
id|iodesc
)paren
suffix:semicolon
id|iodesc-&gt;cb_idx
op_assign
id|LOGIN_PORT_IOCB_CB
suffix:semicolon
id|iodesc-&gt;d_id.b24
op_assign
id|remote_fcport-&gt;d_id.b24
suffix:semicolon
id|remote_fcport-&gt;iodesc_idx_sent
op_assign
id|iodesc-&gt;idx
suffix:semicolon
id|remote_fcport-&gt;login_retry
op_decrement
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- retrying &quot;
l_string|&quot;login to [%x/%02x%02x%02x] (%d).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|remote_fcport-&gt;d_id.b.domain
comma
id|remote_fcport-&gt;d_id.b.area
comma
id|remote_fcport-&gt;d_id.b.al_pa
comma
id|remote_fcport-&gt;login_retry
)paren
)paren
suffix:semicolon
id|qla2x00_send_login_iocb
c_func
(paren
id|ha
comma
id|iodesc
comma
op_amp
id|remote_fcport-&gt;d_id
comma
l_int|1
)paren
suffix:semicolon
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No more logins, mark device dead. */
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- failed &quot;
l_string|&quot;login [%x/%02x%02x%02x] after retries, status=%x &quot;
l_string|&quot;mb0=%x mb1=%x mb2=%x mb6=%x mb7=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|iodesc-&gt;d_id.b.domain
comma
id|iodesc-&gt;d_id.b.area
comma
id|iodesc-&gt;d_id.b.al_pa
comma
id|status
comma
id|mb
(braket
l_int|0
)braket
comma
id|mb
(braket
l_int|1
)braket
comma
id|mb
(braket
l_int|2
)braket
comma
id|mb
(braket
l_int|6
)braket
comma
id|mb
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|remote_fcport-&gt;state
comma
id|FCS_DEVICE_DEAD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remote_fcport-&gt;port_type
op_eq
id|FCT_RSCN
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Login IOCB -- &quot;
l_string|&quot;Freeing dead RSCN fcport %p &quot;
l_string|&quot;[%x/%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport
comma
id|remote_fcport-&gt;loop_id
comma
id|remote_fcport-&gt;d_id.b.domain
comma
id|remote_fcport-&gt;d_id.b.area
comma
id|remote_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|remote_fcport-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|remote_fcport
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/** &n; * IO descriptor processing routines.&n; **/
multiline_comment|/**&n; * qla2x00_alloc_rscn_fcport() - Allocate an RSCN type fcport.&n; * @ha: HA context&n; * @flags: allocation flags&n; *&n; * Returns a pointer to the allocated RSCN fcport, or NULL, if none available.&n; */
id|fc_port_t
op_star
DECL|function|qla2x00_alloc_rscn_fcport
id|qla2x00_alloc_rscn_fcport
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_int
id|flags
)paren
(brace
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|fcport
op_assign
id|qla2x00_alloc_fcport
c_func
(paren
id|ha
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fcport
op_eq
l_int|NULL
)paren
r_return
(paren
id|fcport
)paren
suffix:semicolon
multiline_comment|/* Setup RSCN fcport structure. */
id|fcport-&gt;port_type
op_assign
id|FCT_RSCN
suffix:semicolon
r_return
(paren
id|fcport
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_handle_port_rscn() - Handle port RSCN.&n; * @ha: HA context&n; * @rscn_entry: RSCN entry&n; * @fcport: fcport entry to updated&n; *&n; * Returns QLA_SUCCESS if the port RSCN was handled.&n; */
r_int
DECL|function|qla2x00_handle_port_rscn
id|qla2x00_handle_port_rscn
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint32
id|rscn_entry
comma
id|fc_port_t
op_star
id|known_fcport
comma
r_int
id|ha_locked
)paren
(brace
r_int
id|rval
suffix:semicolon
id|port_id_t
id|rscn_pid
suffix:semicolon
id|fc_port_t
op_star
id|fcport
comma
op_star
id|remote_fcport
comma
op_star
id|rscn_fcport
suffix:semicolon
r_struct
id|io_descriptor
op_star
id|iodesc
suffix:semicolon
id|remote_fcport
op_assign
l_int|NULL
suffix:semicolon
id|rscn_fcport
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Prepare port id based on incoming entries. */
r_if
c_cond
(paren
id|known_fcport
)paren
(brace
id|rscn_pid.b24
op_assign
id|known_fcport-&gt;d_id.b24
suffix:semicolon
id|remote_fcport
op_assign
id|known_fcport
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Handle RSCN -- process RSCN for &quot;
l_string|&quot;fcport [%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;d_id.b.domain
comma
id|remote_fcport-&gt;d_id.b.area
comma
id|remote_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|rscn_pid.b.domain
op_assign
id|LSB
c_func
(paren
id|MSW
c_func
(paren
id|rscn_entry
)paren
)paren
suffix:semicolon
id|rscn_pid.b.area
op_assign
id|MSB
c_func
(paren
id|LSW
c_func
(paren
id|rscn_entry
)paren
)paren
suffix:semicolon
id|rscn_pid.b.al_pa
op_assign
id|LSB
c_func
(paren
id|LSW
c_func
(paren
id|rscn_entry
)paren
)paren
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Handle RSCN -- process RSCN for &quot;
l_string|&quot;port id [%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rscn_pid.b.domain
comma
id|rscn_pid.b.area
comma
id|rscn_pid.b.al_pa
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Search fcport lists for a known entry at the specified port&n;&t;&t; * ID.&n;&t;&t; */
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|rscn_pid.b24
op_eq
id|fcport-&gt;d_id.b24
)paren
(brace
id|remote_fcport
op_assign
id|fcport
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;rscn_fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|rscn_pid.b24
op_eq
id|fcport-&gt;d_id.b24
)paren
(brace
id|rscn_fcport
op_assign
id|fcport
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|remote_fcport
op_eq
l_int|NULL
)paren
id|remote_fcport
op_assign
id|rscn_fcport
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * If the port is already in our fcport list and online, send an ADISC&n;&t; * to see if it&squot;s still alive.  Issue login if a new fcport or the known&n;&t; * fcport is currently offline.&n;&t; */
r_if
c_cond
(paren
id|remote_fcport
)paren
(brace
multiline_comment|/*&n;&t;&t; * No need to send request if the remote fcport is currently&n;&t;&t; * waiting for an available io descriptor.&n;&t;&t; */
r_if
c_cond
(paren
id|known_fcport
op_eq
l_int|NULL
op_logical_and
(paren
id|remote_fcport-&gt;iodesc_idx_sent
op_eq
id|IODESC_ADISC_NEEDED
op_logical_or
id|remote_fcport-&gt;iodesc_idx_sent
op_eq
id|IODESC_LOGIN_NEEDED
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * If previous waiting io descriptor is an ADISC, then&n;&t;&t;&t; * the new RSCN may come from a new remote fcport being&n;&t;&t;&t; * plugged into the same location.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|remote_fcport-&gt;port_type
op_eq
id|FCT_RSCN
)paren
(brace
id|remote_fcport-&gt;iodesc_idx_sent
op_assign
id|IODESC_LOGIN_NEEDED
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|remote_fcport-&gt;iodesc_idx_sent
op_eq
id|IODESC_ADISC_NEEDED
)paren
(brace
id|fc_port_t
op_star
id|new_fcport
suffix:semicolon
id|remote_fcport-&gt;iodesc_idx_sent
op_assign
id|IODESC_INVALID_INDEX
suffix:semicolon
multiline_comment|/* Create new fcport for later login. */
id|new_fcport
op_assign
id|qla2x00_alloc_rscn_fcport
c_func
(paren
id|ha
comma
id|ha_locked
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_fcport
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Handle RSCN &quot;
l_string|&quot;-- creating RSCN fcport %p for &quot;
l_string|&quot;future login.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|new_fcport
)paren
)paren
suffix:semicolon
id|new_fcport-&gt;d_id.b24
op_assign
id|remote_fcport-&gt;d_id.b24
suffix:semicolon
id|new_fcport-&gt;iodesc_idx_sent
op_assign
id|IODESC_LOGIN_NEEDED
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|new_fcport-&gt;list
comma
op_amp
id|ha-&gt;rscn_fcports
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|IODESC_PROCESS_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Handle RSCN &quot;
l_string|&quot;-- unable to allocate RSCN fcport &quot;
l_string|&quot;for future login.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/* Send ADISC if the fcport is online */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|remote_fcport-&gt;state
)paren
op_eq
id|FCS_ONLINE
op_logical_or
id|remote_fcport-&gt;iodesc_idx_sent
op_eq
id|IODESC_ADISC_NEEDED
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|remote_fcport-&gt;state
comma
id|FCS_DEVICE_LOST
)paren
suffix:semicolon
id|iodesc
op_assign
id|qla2x00_alloc_iodesc
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iodesc
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Mark fcport for later adisc processing */
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Handle RSCN -- not &quot;
l_string|&quot;enough IO descriptors for Adisc, flag &quot;
l_string|&quot;for later processing.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|remote_fcport-&gt;iodesc_idx_sent
op_assign
id|IODESC_ADISC_NEEDED
suffix:semicolon
id|set_bit
c_func
(paren
id|IODESC_PROCESS_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
id|iodesc-&gt;cb_idx
op_assign
id|ADISC_PORT_IOCB_CB
suffix:semicolon
id|iodesc-&gt;d_id.b24
op_assign
id|rscn_pid.b24
suffix:semicolon
id|iodesc-&gt;remote_fcport
op_assign
id|remote_fcport
suffix:semicolon
id|remote_fcport-&gt;iodesc_idx_sent
op_assign
id|iodesc-&gt;idx
suffix:semicolon
id|qla2x00_send_adisc_iocb
c_func
(paren
id|ha
comma
id|iodesc
comma
id|ha_locked
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|remote_fcport-&gt;iodesc_idx_sent
OL
id|MAX_IO_DESCRIPTORS
op_logical_and
id|ha-&gt;io_descriptors
(braket
id|remote_fcport-&gt;iodesc_idx_sent
)braket
dot
id|cb_idx
op_eq
id|ADISC_PORT_IOCB_CB
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Receiving another RSCN while an ADISC is pending,&n;&t;&t;&t; * abort the IOCB.  Use the same descriptor for the&n;&t;&t;&t; * abort.&n;&t;&t;&t; */
r_uint32
id|handle_to_abort
suffix:semicolon
id|iodesc
op_assign
op_amp
id|ha-&gt;io_descriptors
(braket
id|remote_fcport-&gt;iodesc_idx_sent
)braket
suffix:semicolon
id|qla2x00_remove_iodesc_timer
c_func
(paren
id|iodesc
)paren
suffix:semicolon
id|handle_to_abort
op_assign
id|iodesc-&gt;signature
suffix:semicolon
id|iodesc-&gt;signature
op_assign
id|qla2x00_iodesc_to_handle
c_func
(paren
id|iodesc
)paren
suffix:semicolon
id|iodesc-&gt;cb_idx
op_assign
id|ABORT_IOCB_CB
suffix:semicolon
id|iodesc-&gt;d_id.b24
op_assign
id|remote_fcport-&gt;d_id.b24
suffix:semicolon
id|iodesc-&gt;remote_fcport
op_assign
id|remote_fcport
suffix:semicolon
id|remote_fcport-&gt;iodesc_idx_sent
op_assign
id|iodesc-&gt;idx
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Handle RSCN -- issuing &quot;
l_string|&quot;abort to outstanding Adisc [%x/%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|iodesc-&gt;d_id.b.domain
comma
id|iodesc-&gt;d_id.b.area
comma
id|iodesc-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|qla2x00_send_abort_iocb
c_func
(paren
id|ha
comma
id|iodesc
comma
id|handle_to_abort
comma
id|ha_locked
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* We need to login to the remote port, find it. */
r_if
c_cond
(paren
id|known_fcport
)paren
(brace
id|remote_fcport
op_assign
id|known_fcport
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rscn_fcport
op_logical_and
id|rscn_fcport-&gt;d_id.b24
op_ne
id|INVALID_PORT_ID
op_logical_and
id|rscn_fcport-&gt;iodesc_idx_sent
OL
id|MAX_IO_DESCRIPTORS
op_logical_and
id|ha-&gt;io_descriptors
(braket
id|rscn_fcport-&gt;iodesc_idx_sent
)braket
dot
id|cb_idx
op_eq
id|LOGIN_PORT_IOCB_CB
)paren
(brace
multiline_comment|/*&n;&t;&t; * Ignore duplicate RSCN on fcport which has already&n;&t;&t; * initiated a login IOCB.&n;&t;&t; */
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Handle RSCN -- ignoring, login &quot;
l_string|&quot;already sent to [%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rscn_fcport-&gt;d_id.b.domain
comma
id|rscn_fcport-&gt;d_id.b.area
comma
id|rscn_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rscn_fcport
op_logical_and
id|rscn_fcport-&gt;d_id.b24
op_ne
id|INVALID_PORT_ID
op_logical_and
id|rscn_fcport
op_ne
id|remote_fcport
)paren
(brace
multiline_comment|/* Reuse same rscn fcport. */
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Handle RSCN -- reusing RSCN fcport &quot;
l_string|&quot;[%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rscn_fcport-&gt;d_id.b.domain
comma
id|rscn_fcport-&gt;d_id.b.area
comma
id|rscn_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|remote_fcport
op_assign
id|rscn_fcport
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Create new fcport for later login. */
id|remote_fcport
op_assign
id|qla2x00_alloc_rscn_fcport
c_func
(paren
id|ha
comma
id|ha_locked
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|remote_fcport-&gt;list
comma
op_amp
id|ha-&gt;rscn_fcports
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|remote_fcport
op_eq
l_int|NULL
)paren
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
multiline_comment|/* Prepare fcport for login. */
id|atomic_set
c_func
(paren
op_amp
id|remote_fcport-&gt;state
comma
id|FCS_DEVICE_LOST
)paren
suffix:semicolon
id|remote_fcport-&gt;login_retry
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* ha-&gt;login_retry_count; */
id|remote_fcport-&gt;d_id.b24
op_assign
id|rscn_pid.b24
suffix:semicolon
id|iodesc
op_assign
id|qla2x00_alloc_iodesc
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iodesc
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Mark fcport for later adisc processing. */
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Handle RSCN -- not enough IO &quot;
l_string|&quot;descriptors for Login, flag for later processing.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|remote_fcport-&gt;iodesc_idx_sent
op_assign
id|IODESC_LOGIN_NEEDED
suffix:semicolon
id|set_bit
c_func
(paren
id|IODESC_PROCESS_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|known_fcport
op_eq
l_int|NULL
op_logical_or
id|rscn_pid.b24
op_ne
id|INVALID_PORT_ID
)paren
(brace
id|remote_fcport-&gt;loop_id
op_assign
id|ha-&gt;min_external_loopid
suffix:semicolon
id|rval
op_assign
id|qla2x00_find_new_loop_id
c_func
(paren
id|ha
comma
id|remote_fcport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_FUNCTION_FAILED
)paren
(brace
multiline_comment|/* No more loop ids, failed. */
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Handle RSCN -- no available &quot;
l_string|&quot;loop id to perform Login, failed.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
)brace
id|iodesc-&gt;cb_idx
op_assign
id|LOGIN_PORT_IOCB_CB
suffix:semicolon
id|iodesc-&gt;d_id.b24
op_assign
id|rscn_pid.b24
suffix:semicolon
id|iodesc-&gt;remote_fcport
op_assign
id|remote_fcport
suffix:semicolon
id|remote_fcport-&gt;iodesc_idx_sent
op_assign
id|iodesc-&gt;idx
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Handle RSCN -- attempting login to &quot;
l_string|&quot;[%x/%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|remote_fcport-&gt;loop_id
comma
id|iodesc-&gt;d_id.b.domain
comma
id|iodesc-&gt;d_id.b.area
comma
id|iodesc-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|qla2x00_send_login_iocb
c_func
(paren
id|ha
comma
id|iodesc
comma
op_amp
id|rscn_pid
comma
id|ha_locked
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_process_iodesc() - Complete IO descriptor processing.&n; * @ha: HA context&n; * @mbxstat: Mailbox IOCB status&n; */
r_void
DECL|function|qla2x00_process_iodesc
id|qla2x00_process_iodesc
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|mbx_entry
op_star
id|mbxstat
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint32
id|signature
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
r_struct
id|io_descriptor
op_star
id|iodesc
suffix:semicolon
id|signature
op_assign
id|mbxstat-&gt;handle
suffix:semicolon
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Process IODesc -- processing %08x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|signature
)paren
)paren
suffix:semicolon
multiline_comment|/* Retrieve proper IO descriptor. */
id|iodesc
op_assign
id|qla2x00_handle_to_iodesc
c_func
(paren
id|ha
comma
id|signature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iodesc
op_eq
l_int|NULL
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Process IODesc -- ignoring, &quot;
l_string|&quot;incorrect signature %08x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|signature
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Stop IO descriptor timer. */
id|qla2x00_remove_iodesc_timer
c_func
(paren
id|iodesc
)paren
suffix:semicolon
multiline_comment|/* Verify signature match. */
r_if
c_cond
(paren
id|iodesc-&gt;signature
op_ne
id|signature
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Process IODesc -- ignoring, &quot;
l_string|&quot;signature mismatch, sent %08x, received %08x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|iodesc-&gt;signature
comma
id|signature
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Go with IOCB callback. */
id|rval
op_assign
id|iocb_function_cb_list
(braket
id|iodesc-&gt;cb_idx
)braket
(paren
id|ha
comma
id|iodesc
comma
id|mbxstat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* IO descriptor reused by callback. */
r_return
suffix:semicolon
)brace
id|qla2x00_free_iodesc
c_func
(paren
id|iodesc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|IODESC_PROCESS_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
multiline_comment|/* Scan our fcports list for any RSCN requests. */
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|fcport-&gt;iodesc_idx_sent
op_eq
id|IODESC_ADISC_NEEDED
op_logical_or
id|fcport-&gt;iodesc_idx_sent
op_eq
id|IODESC_LOGIN_NEEDED
)paren
(brace
id|qla2x00_handle_port_rscn
c_func
(paren
id|ha
comma
l_int|0
comma
id|fcport
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Scan our RSCN fcports list for any RSCN requests. */
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;rscn_fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|fcport-&gt;iodesc_idx_sent
op_eq
id|IODESC_ADISC_NEEDED
op_logical_or
id|fcport-&gt;iodesc_idx_sent
op_eq
id|IODESC_LOGIN_NEEDED
)paren
(brace
id|qla2x00_handle_port_rscn
c_func
(paren
id|ha
comma
l_int|0
comma
id|fcport
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
id|clear_bit
c_func
(paren
id|IODESC_PROCESS_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_cancel_io_descriptors() - Cancel all outstanding io descriptors.&n; * @ha: HA context&n; *&n; * This routine will also delete any RSCN entries related to the outstanding&n; * IO descriptors.&n; */
r_void
DECL|function|qla2x00_cancel_io_descriptors
id|qla2x00_cancel_io_descriptors
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|fc_port_t
op_star
id|fcport
comma
op_star
id|fcptemp
suffix:semicolon
id|clear_bit
c_func
(paren
id|IODESC_PROCESS_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
multiline_comment|/* Abort all IO descriptors. */
id|qla2x00_init_io_descriptors
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Reset all pending IO descriptors in fcports list. */
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
id|fcport-&gt;iodesc_idx_sent
op_assign
id|IODESC_INVALID_INDEX
suffix:semicolon
)brace
multiline_comment|/* Reset all pending IO descriptors in rscn fcports list. */
id|list_for_each_entry_safe
c_func
(paren
id|fcport
comma
id|fcptemp
comma
op_amp
id|ha-&gt;rscn_fcports
comma
id|list
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Cancel IOs -- Freeing RSCN fcport &quot;
l_string|&quot;%p [%x/%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport
comma
id|fcport-&gt;loop_id
comma
id|fcport-&gt;d_id.b.domain
comma
id|fcport-&gt;d_id.b.area
comma
id|fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|fcport-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fcport
)paren
suffix:semicolon
)brace
)brace
eof
