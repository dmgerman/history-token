multiline_comment|/*&n; *                  QLOGIC LINUX SOFTWARE&n; *&n; * QLogic ISP2x00 device driver for Linux 2.6.x&n; * Copyright (C) 2003-2004 QLogic Corporation&n; * (www.qlogic.com)&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; */
macro_line|#include &quot;qla_def.h&quot;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;scsi/scsi_tcq.h&gt;
macro_line|#include &lt;scsi/scsicam.h&gt;
macro_line|#include &lt;scsi/scsi_transport.h&gt;
macro_line|#include &lt;scsi/scsi_transport_fc.h&gt;
multiline_comment|/*&n; * Driver version&n; */
DECL|variable|qla2x00_version_str
r_char
id|qla2x00_version_str
(braket
l_int|40
)braket
suffix:semicolon
multiline_comment|/*&n; * SRB allocation cache&n; */
DECL|variable|srb_cachep_name
r_char
id|srb_cachep_name
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|srb_cachep
id|kmem_cache_t
op_star
id|srb_cachep
suffix:semicolon
multiline_comment|/*&n; * Stats for all adpaters.&n; */
DECL|variable|qla2x00_stats
r_struct
id|_qla2x00stats
id|qla2x00_stats
suffix:semicolon
multiline_comment|/*&n; * Ioctl related information.&n; */
DECL|variable|num_hosts
r_int
id|num_hosts
suffix:semicolon
DECL|variable|apiHBAInstance
r_int
id|apiHBAInstance
suffix:semicolon
multiline_comment|/*&n; * Module parameter information and variables&n; */
DECL|variable|ql2xmaxqdepth
r_int
id|ql2xmaxqdepth
suffix:semicolon
id|module_param
c_func
(paren
id|ql2xmaxqdepth
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ql2xmaxqdepth
comma
l_string|&quot;Maximum queue depth to report for target devices.&quot;
)paren
suffix:semicolon
DECL|variable|ql2xlogintimeout
r_int
id|ql2xlogintimeout
op_assign
l_int|20
suffix:semicolon
id|module_param
c_func
(paren
id|ql2xlogintimeout
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IRUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ql2xlogintimeout
comma
l_string|&quot;Login timeout value in seconds.&quot;
)paren
suffix:semicolon
DECL|variable|qlport_down_retry
r_int
id|qlport_down_retry
suffix:semicolon
id|module_param
c_func
(paren
id|qlport_down_retry
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IRUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|qlport_down_retry
comma
l_string|&quot;Maximum number of command retries to a port that returns&quot;
l_string|&quot;a PORT-DOWN status.&quot;
)paren
suffix:semicolon
DECL|variable|ql2xretrycount
r_int
id|ql2xretrycount
op_assign
l_int|20
suffix:semicolon
id|module_param
c_func
(paren
id|ql2xretrycount
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ql2xretrycount
comma
l_string|&quot;Maximum number of mid-layer retries allowed for a command.  &quot;
l_string|&quot;Default value is 20, &quot;
)paren
suffix:semicolon
DECL|variable|displayConfig
r_int
id|displayConfig
suffix:semicolon
id|module_param
c_func
(paren
id|displayConfig
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|displayConfig
comma
l_string|&quot;If 1 then display the configuration used in /etc/modprobe.conf.&quot;
)paren
suffix:semicolon
DECL|variable|ql2xplogiabsentdevice
r_int
id|ql2xplogiabsentdevice
suffix:semicolon
id|module_param
c_func
(paren
id|ql2xplogiabsentdevice
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ql2xplogiabsentdevice
comma
l_string|&quot;Option to enable PLOGI to devices that are not present after &quot;
l_string|&quot;a Fabric scan.  This is needed for several broken switches.&quot;
l_string|&quot;Default is 0 - no PLOGI. 1 - perfom PLOGI.&quot;
)paren
suffix:semicolon
DECL|variable|ql2xenablezio
r_int
id|ql2xenablezio
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|ql2xenablezio
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IRUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ql2xenablezio
comma
l_string|&quot;Option to enable ZIO:If 1 then enable it otherwise&quot;
l_string|&quot; use the default set in the NVRAM.&quot;
l_string|&quot; Default is 0 : disabled&quot;
)paren
suffix:semicolon
DECL|variable|ql2xintrdelaytimer
r_int
id|ql2xintrdelaytimer
op_assign
l_int|10
suffix:semicolon
id|module_param
c_func
(paren
id|ql2xintrdelaytimer
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IRUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ql2xintrdelaytimer
comma
l_string|&quot;ZIO: Waiting time for Firmware before it generates an &quot;
l_string|&quot;interrupt to the host to notify completion of request.&quot;
)paren
suffix:semicolon
DECL|variable|ConfigRequired
r_int
id|ConfigRequired
suffix:semicolon
id|module_param
c_func
(paren
id|ConfigRequired
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IRUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ConfigRequired
comma
l_string|&quot;If 1, then only configured devices passed in through the&quot;
l_string|&quot;ql2xopts parameter will be presented to the OS&quot;
)paren
suffix:semicolon
DECL|variable|Bind
r_int
id|Bind
op_assign
id|BIND_BY_PORT_NAME
suffix:semicolon
id|module_param
c_func
(paren
id|Bind
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IRUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|Bind
comma
l_string|&quot;Target persistent binding method: &quot;
l_string|&quot;0 by Portname (default); 1 by PortID; 2 by Nodename. &quot;
)paren
suffix:semicolon
DECL|variable|ql2xsuspendcount
r_int
id|ql2xsuspendcount
op_assign
id|SUSPEND_COUNT
suffix:semicolon
id|module_param
c_func
(paren
id|ql2xsuspendcount
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ql2xsuspendcount
comma
l_string|&quot;Number of 6-second suspend iterations to perform while a &quot;
l_string|&quot;target returns a &lt;NOT READY&gt; status.  Default is 10 &quot;
l_string|&quot;iterations.&quot;
)paren
suffix:semicolon
DECL|variable|ql2xdoinitscan
r_int
id|ql2xdoinitscan
op_assign
l_int|1
suffix:semicolon
id|module_param
c_func
(paren
id|ql2xdoinitscan
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ql2xdoinitscan
comma
l_string|&quot;Signal mid-layer to perform scan after driver load: 0 -- no &quot;
l_string|&quot;signal sent to mid-layer.&quot;
)paren
suffix:semicolon
DECL|variable|ql2xloginretrycount
r_int
id|ql2xloginretrycount
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|ql2xloginretrycount
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IRUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ql2xloginretrycount
comma
l_string|&quot;Specify an alternate value for the NVRAM login retry count.&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Proc structures and functions&n; */
DECL|struct|info_str
r_struct
id|info_str
(brace
DECL|member|buffer
r_char
op_star
id|buffer
suffix:semicolon
DECL|member|length
r_int
id|length
suffix:semicolon
DECL|member|offset
id|off_t
id|offset
suffix:semicolon
DECL|member|pos
r_int
id|pos
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|copy_mem_info
c_func
(paren
r_struct
id|info_str
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|copy_info
c_func
(paren
r_struct
id|info_str
op_star
comma
r_char
op_star
comma
dot
dot
dot
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_free_device
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_config_dma_addressing
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
suffix:semicolon
multiline_comment|/*&n; * SCSI host template entry points &n; */
r_static
r_int
id|qla2xxx_slave_configure
c_func
(paren
r_struct
id|scsi_device
op_star
id|device
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_queuecommand
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|fn
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
suffix:semicolon
r_static
r_int
id|qla2xxx_eh_abort
c_func
(paren
r_struct
id|scsi_cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2xxx_eh_device_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2xxx_eh_bus_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2xxx_eh_host_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_loop_reset
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_device_reset
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|fc_port_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_proc_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
comma
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
comma
r_int
)paren
suffix:semicolon
DECL|variable|qla2x00_driver_template
r_static
r_struct
id|scsi_host_template
id|qla2x00_driver_template
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;qla2xxx&quot;
comma
dot
id|proc_name
op_assign
l_string|&quot;qla2xxx&quot;
comma
dot
id|proc_info
op_assign
id|qla2x00_proc_info
comma
dot
id|queuecommand
op_assign
id|qla2x00_queuecommand
comma
dot
id|eh_abort_handler
op_assign
id|qla2xxx_eh_abort
comma
dot
id|eh_device_reset_handler
op_assign
id|qla2xxx_eh_device_reset
comma
dot
id|eh_bus_reset_handler
op_assign
id|qla2xxx_eh_bus_reset
comma
dot
id|eh_host_reset_handler
op_assign
id|qla2xxx_eh_host_reset
comma
dot
id|slave_configure
op_assign
id|qla2xxx_slave_configure
comma
dot
id|this_id
op_assign
op_minus
l_int|1
comma
dot
id|cmd_per_lun
op_assign
l_int|3
comma
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
dot
id|sg_tablesize
op_assign
id|SG_ALL
comma
multiline_comment|/*&n;&t; * The RISC allows for each command to transfer (2^32-1) bytes of data,&n;&t; * which equates to 0x800000 sectors.&n;&t; */
dot
id|max_sectors
op_assign
l_int|0xFFFF
comma
)brace
suffix:semicolon
DECL|variable|qla2xxx_transport_template
r_static
r_struct
id|scsi_transport_template
op_star
id|qla2xxx_transport_template
op_assign
l_int|NULL
suffix:semicolon
r_static
r_void
id|qla2x00_display_fc_names
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
multiline_comment|/* TODO Convert to inlines&n; *&n; * Timer routines&n; */
DECL|macro|WATCH_INTERVAL
mdefine_line|#define&t;WATCH_INTERVAL&t;&t;1       /* number of seconds */
r_static
r_void
id|qla2x00_timer
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|qla2x00_start_timer
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_void
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|qla2x00_restart_timer
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|qla2x00_stop_timer
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
DECL|function|qla2x00_start_timer
id|qla2x00_start_timer
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_void
op_star
id|func
comma
r_int
r_int
id|interval
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|ha-&gt;timer
)paren
suffix:semicolon
id|ha-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|interval
op_star
id|HZ
suffix:semicolon
id|ha-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|ha
suffix:semicolon
id|ha-&gt;timer.function
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|func
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ha-&gt;timer
)paren
suffix:semicolon
id|ha-&gt;timer_active
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|qla2x00_restart_timer
id|qla2x00_restart_timer
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_int
r_int
id|interval
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|ha-&gt;timer
comma
id|jiffies
op_plus
id|interval
op_star
id|HZ
)paren
suffix:semicolon
)brace
r_static
id|__inline__
r_void
DECL|function|qla2x00_stop_timer
id|qla2x00_stop_timer
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|del_timer_sync
c_func
(paren
op_amp
id|ha-&gt;timer
)paren
suffix:semicolon
id|ha-&gt;timer_active
op_assign
l_int|0
suffix:semicolon
)brace
r_void
id|qla2x00_cmd_timeout
c_func
(paren
id|srb_t
op_star
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|qla2x00_callback
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|scsi_cmnd
op_star
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|sp_put
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|sp_get
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|qla2x00_delete_from_done_queue
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|srb_t
op_star
)paren
suffix:semicolon
multiline_comment|/*&n;* qla2x00_callback&n;*      Returns the completed SCSI command to LINUX.&n;*&n;* Input:&n;*&t;ha -- Host adapter structure&n;*&t;cmd -- SCSI mid-level command structure.&n;* Returns:&n;*      None&n;* Note:From failover point of view we always get the sp&n;*      from vis_ha pool in queuecommand.So when we put it &n;*      back to the pool it has to be the vis_ha.&t; &n;*      So rely on struct scsi_cmnd to get the vis_ha and not on sp. &t;&t; &t;&n;*/
r_static
r_inline
r_void
DECL|function|qla2x00_callback
id|qla2x00_callback
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
id|srb_t
op_star
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|scsi_qla_host_t
op_star
id|vis_ha
suffix:semicolon
id|os_lun_t
op_star
id|lq
suffix:semicolon
r_int
id|got_sense
suffix:semicolon
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|vis_ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;%s(): **** CMD derives a NULL SP&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
)paren
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If command status is not DID_BUS_BUSY then go ahead and freed sp.&n;&t; */
multiline_comment|/*&n;&t; * Cancel command timeout&n;&t; */
id|qla2x00_delete_timer_from_cmd
c_func
(paren
id|sp
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Put SP back in the free queue&n;&t; */
id|sp-&gt;cmd
op_assign
l_int|NULL
suffix:semicolon
id|CMD_SP
c_func
(paren
id|cmd
)paren
op_assign
l_int|NULL
suffix:semicolon
id|lq
op_assign
id|sp-&gt;lun_queue
suffix:semicolon
id|got_sense
op_assign
(paren
id|sp-&gt;flags
op_amp
id|SRB_GOT_SENSE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|add_to_free_queue
c_func
(paren
id|vis_ha
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host_byte
c_func
(paren
id|cmd-&gt;result
)paren
op_eq
id|DID_OK
)paren
(brace
multiline_comment|/* device ok */
id|ha-&gt;total_bytes
op_add_assign
id|cmd-&gt;bufflen
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|got_sense
)paren
(brace
multiline_comment|/* If lun was suspended then clear retry count */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lq-&gt;q_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|LUN_EXEC_DELAYED
comma
op_amp
id|lq-&gt;q_flag
)paren
)paren
id|lq-&gt;q_state
op_assign
id|LUN_STATE_READY
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lq-&gt;q_lock
comma
id|cpu_flags
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|host_byte
c_func
(paren
id|cmd-&gt;result
)paren
op_eq
id|DID_ERROR
)paren
(brace
multiline_comment|/* device error */
id|ha-&gt;total_dev_errs
op_increment
suffix:semicolon
)brace
multiline_comment|/* Call the mid-level driver interrupt handler */
(paren
op_star
(paren
id|cmd
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* sp_put&n;*&n;* Description:&n;*   Decrement reference count and call the callback if we&squot;re the last&n;*   owner of the specified sp. Will get the host_lock before calling&n;*   the callback.&n;*&n;* Input:&n;*   ha - pointer to the scsi_qla_host_t where the callback is to occur.&n;*   sp - pointer to srb_t structure to use.&n;*&n;* Returns:&n;*&n;**************************************************************************/
r_static
r_inline
r_void
DECL|function|sp_put
id|sp_put
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sp-&gt;ref_count
)paren
op_eq
l_int|0
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;%s(): **** SP-&gt;ref_count not zero&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
)paren
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|atomic_dec_and_test
c_func
(paren
op_amp
id|sp-&gt;ref_count
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|qla2x00_callback
c_func
(paren
id|ha
comma
id|sp-&gt;cmd
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* sp_get&n;*&n;* Description:&n;*   Increment reference count of the specified sp.&n;*&n;* Input:&n;*   sp - pointer to srb_t structure to use.&n;*&n;* Returns:&n;*&n;**************************************************************************/
r_static
r_inline
r_void
DECL|function|sp_get
id|sp_get
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|sp-&gt;ref_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sp-&gt;ref_count
)paren
OG
l_int|2
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;%s(): **** SP-&gt;ref_count greater than two&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
)paren
r_return
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|qla2x00_delete_from_done_queue
id|qla2x00_delete_from_done_queue
c_func
(paren
id|scsi_qla_host_t
op_star
id|dest_ha
comma
id|srb_t
op_star
id|sp
)paren
(brace
multiline_comment|/* remove command from done list */
id|list_del_init
c_func
(paren
op_amp
id|sp-&gt;list
)paren
suffix:semicolon
id|dest_ha-&gt;done_q_cnt
op_decrement
suffix:semicolon
id|sp-&gt;state
op_assign
id|SRB_NO_QUEUE_STATE
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_DMA_VALID
)paren
(brace
id|sp-&gt;flags
op_and_assign
op_complement
id|SRB_DMA_VALID
suffix:semicolon
multiline_comment|/* Release memory used for this I/O */
r_if
c_cond
(paren
id|sp-&gt;cmd-&gt;use_sg
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|dest_ha-&gt;pdev
comma
id|sp-&gt;cmd-&gt;request_buffer
comma
id|sp-&gt;cmd-&gt;use_sg
comma
id|sp-&gt;cmd-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sp-&gt;cmd-&gt;request_bufflen
)paren
(brace
id|pci_unmap_page
c_func
(paren
id|dest_ha-&gt;pdev
comma
id|sp-&gt;dma_handle
comma
id|sp-&gt;cmd-&gt;request_bufflen
comma
id|sp-&gt;cmd-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_int
id|qla2x00_do_dpc
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_rst_aen
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_uint8
id|qla2x00_mem_alloc
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_mem_free
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_allocate_sp_pool
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_free_sp_pool
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
suffix:semicolon
r_static
id|srb_t
op_star
id|qla2x00_get_new_sp
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
suffix:semicolon
r_static
id|ssize_t
id|qla2x00_sysfs_read_fw_dump
c_func
(paren
r_struct
id|kobject
op_star
comma
r_char
op_star
comma
id|loff_t
comma
r_int
)paren
suffix:semicolon
r_static
id|ssize_t
id|qla2x00_sysfs_write_fw_dump
c_func
(paren
r_struct
id|kobject
op_star
comma
r_char
op_star
comma
id|loff_t
comma
r_int
)paren
suffix:semicolon
DECL|variable|sysfs_fw_dump_attr
r_static
r_struct
id|bin_attribute
id|sysfs_fw_dump_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;fw_dump&quot;
comma
dot
id|mode
op_assign
id|S_IRUSR
op_or
id|S_IWUSR
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
comma
dot
id|size
op_assign
l_int|0
comma
dot
id|read
op_assign
id|qla2x00_sysfs_read_fw_dump
comma
dot
id|write
op_assign
id|qla2x00_sysfs_write_fw_dump
comma
)brace
suffix:semicolon
r_static
id|ssize_t
id|qla2x00_sysfs_read_nvram
c_func
(paren
r_struct
id|kobject
op_star
comma
r_char
op_star
comma
id|loff_t
comma
r_int
)paren
suffix:semicolon
r_static
id|ssize_t
id|qla2x00_sysfs_write_nvram
c_func
(paren
r_struct
id|kobject
op_star
comma
r_char
op_star
comma
id|loff_t
comma
r_int
)paren
suffix:semicolon
DECL|variable|sysfs_nvram_attr
r_static
r_struct
id|bin_attribute
id|sysfs_nvram_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;nvram&quot;
comma
dot
id|mode
op_assign
id|S_IRUSR
op_or
id|S_IWUSR
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
comma
dot
id|size
op_assign
r_sizeof
(paren
id|nvram_t
)paren
comma
dot
id|read
op_assign
id|qla2x00_sysfs_read_nvram
comma
dot
id|write
op_assign
id|qla2x00_sysfs_write_nvram
comma
)brace
suffix:semicolon
multiline_comment|/* -------------------------------------------------------------------------- */
multiline_comment|/* SysFS attributes. */
DECL|function|qla2x00_sysfs_read_fw_dump
r_static
id|ssize_t
id|qla2x00_sysfs_read_fw_dump
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|buf
comma
id|loff_t
id|off
comma
r_int
id|count
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
id|to_qla_host
c_func
(paren
id|dev_to_shost
c_func
(paren
id|container_of
c_func
(paren
id|kobj
comma
r_struct
id|device
comma
id|kobj
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;fw_dump_reading
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|off
OG
id|ha-&gt;fw_dump_buffer_len
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|off
op_plus
id|count
OG
id|ha-&gt;fw_dump_buffer_len
)paren
id|count
op_assign
id|ha-&gt;fw_dump_buffer_len
op_minus
id|off
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
op_amp
id|ha-&gt;fw_dump_buffer
(braket
id|off
)braket
comma
id|count
)paren
suffix:semicolon
r_return
(paren
id|count
)paren
suffix:semicolon
)brace
DECL|function|qla2x00_sysfs_write_fw_dump
r_static
id|ssize_t
id|qla2x00_sysfs_write_fw_dump
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|buf
comma
id|loff_t
id|off
comma
r_int
id|count
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
id|to_qla_host
c_func
(paren
id|dev_to_shost
c_func
(paren
id|container_of
c_func
(paren
id|kobj
comma
r_struct
id|device
comma
id|kobj
)paren
)paren
)paren
suffix:semicolon
r_int
id|reading
suffix:semicolon
r_uint32
id|dump_size
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ne
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|reading
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|reading
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|ha-&gt;fw_dump_reading
op_eq
l_int|1
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Firmware dump cleared on (%ld).&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|ha-&gt;fw_dump_buffer
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ha-&gt;fw_dump
comma
id|ha-&gt;fw_dump_order
)paren
suffix:semicolon
id|ha-&gt;fw_dump_reading
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;fw_dump_buffer
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;fw_dump
op_assign
l_int|NULL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|ha-&gt;fw_dump
op_ne
l_int|NULL
op_logical_and
op_logical_neg
id|ha-&gt;fw_dump_reading
)paren
(brace
id|ha-&gt;fw_dump_reading
op_assign
l_int|1
suffix:semicolon
id|dump_size
op_assign
id|FW_DUMP_SIZE_1M
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;fw_memory_size
OL
l_int|0x20000
)paren
id|dump_size
op_assign
id|FW_DUMP_SIZE_128K
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ha-&gt;fw_memory_size
OL
l_int|0x80000
)paren
id|dump_size
op_assign
id|FW_DUMP_SIZE_512K
suffix:semicolon
id|ha-&gt;fw_dump_buffer
op_assign
(paren
r_char
op_star
)paren
id|vmalloc
c_func
(paren
id|dump_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;fw_dump_buffer
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Unable to allocate memory for firmware &quot;
l_string|&quot;dump buffer (%d).&bslash;n&quot;
comma
id|dump_size
)paren
suffix:semicolon
id|ha-&gt;fw_dump_reading
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|count
)paren
suffix:semicolon
)brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Firmware dump ready for read on (%ld).&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ha-&gt;fw_dump_buffer
comma
l_int|0
comma
id|dump_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
id|qla2100_ascii_fw_dump
c_func
(paren
id|ha
)paren
suffix:semicolon
r_else
id|qla2300_ascii_fw_dump
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ha-&gt;fw_dump_buffer_len
op_assign
id|strlen
c_func
(paren
id|ha-&gt;fw_dump_buffer
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
(paren
id|count
)paren
suffix:semicolon
)brace
DECL|function|qla2x00_sysfs_read_nvram
r_static
id|ssize_t
id|qla2x00_sysfs_read_nvram
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|buf
comma
id|loff_t
id|off
comma
r_int
id|count
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
id|to_qla_host
c_func
(paren
id|dev_to_shost
c_func
(paren
id|container_of
c_func
(paren
id|kobj
comma
r_struct
id|device
comma
id|kobj
)paren
)paren
)paren
suffix:semicolon
r_uint16
op_star
id|witer
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_uint16
id|cnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_or
id|off
op_ne
l_int|0
op_logical_or
id|count
op_ne
r_sizeof
(paren
id|nvram_t
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Read NVRAM. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|qla2x00_lock_nvram_access
c_func
(paren
id|ha
)paren
suffix:semicolon
id|witer
op_assign
(paren
r_uint16
op_star
)paren
id|buf
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|count
op_div
l_int|2
suffix:semicolon
id|cnt
op_increment
)paren
(brace
op_star
id|witer
op_assign
id|cpu_to_le16
c_func
(paren
id|qla2x00_get_nvram_word
c_func
(paren
id|ha
comma
id|cnt
op_plus
id|ha-&gt;nvram_base
)paren
)paren
suffix:semicolon
id|witer
op_increment
suffix:semicolon
)brace
id|qla2x00_unlock_nvram_access
c_func
(paren
id|ha
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|count
)paren
suffix:semicolon
)brace
DECL|function|qla2x00_sysfs_write_nvram
r_static
id|ssize_t
id|qla2x00_sysfs_write_nvram
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|buf
comma
id|loff_t
id|off
comma
r_int
id|count
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
id|to_qla_host
c_func
(paren
id|dev_to_shost
c_func
(paren
id|container_of
c_func
(paren
id|kobj
comma
r_struct
id|device
comma
id|kobj
)paren
)paren
)paren
suffix:semicolon
r_uint8
op_star
id|iter
suffix:semicolon
r_uint16
op_star
id|witer
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_uint16
id|cnt
suffix:semicolon
r_uint8
id|chksum
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_or
id|off
op_ne
l_int|0
op_logical_or
id|count
op_ne
r_sizeof
(paren
id|nvram_t
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Checksum NVRAM. */
id|iter
op_assign
(paren
r_uint8
op_star
)paren
id|buf
suffix:semicolon
id|chksum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|count
op_minus
l_int|1
suffix:semicolon
id|cnt
op_increment
)paren
id|chksum
op_add_assign
op_star
id|iter
op_increment
suffix:semicolon
id|chksum
op_assign
op_complement
id|chksum
op_plus
l_int|1
suffix:semicolon
op_star
id|iter
op_assign
id|chksum
suffix:semicolon
multiline_comment|/* Write NVRAM. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|qla2x00_lock_nvram_access
c_func
(paren
id|ha
)paren
suffix:semicolon
id|qla2x00_release_nvram_protection
c_func
(paren
id|ha
)paren
suffix:semicolon
id|witer
op_assign
(paren
r_uint16
op_star
)paren
id|buf
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|count
op_div
l_int|2
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|qla2x00_write_nvram_word
c_func
(paren
id|ha
comma
id|cnt
op_plus
id|ha-&gt;nvram_base
comma
id|cpu_to_le16
c_func
(paren
op_star
id|witer
)paren
)paren
suffix:semicolon
id|witer
op_increment
suffix:semicolon
)brace
id|qla2x00_unlock_nvram_access
c_func
(paren
id|ha
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|count
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------- */
r_static
r_char
op_star
DECL|function|qla2x00_get_pci_info_str
id|qla2x00_get_pci_info_str
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_char
op_star
id|str
)paren
(brace
r_static
r_char
op_star
id|pci_bus_modes
(braket
)braket
op_assign
(brace
l_string|&quot;33&quot;
comma
l_string|&quot;66&quot;
comma
l_string|&quot;100&quot;
comma
l_string|&quot;133&quot;
comma
)brace
suffix:semicolon
r_uint16
id|pci_bus
suffix:semicolon
id|strcpy
c_func
(paren
id|str
comma
l_string|&quot;PCI&quot;
)paren
suffix:semicolon
id|pci_bus
op_assign
(paren
id|ha-&gt;pci_attr
op_amp
(paren
id|BIT_9
op_or
id|BIT_10
)paren
)paren
op_rshift
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|pci_bus
)paren
(brace
id|strcat
c_func
(paren
id|str
comma
l_string|&quot;-X (&quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|str
comma
id|pci_bus_modes
(braket
id|pci_bus
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|pci_bus
op_assign
(paren
id|ha-&gt;pci_attr
op_amp
id|BIT_8
)paren
op_rshift
l_int|8
suffix:semicolon
id|strcat
c_func
(paren
id|str
comma
l_string|&quot; (&quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|str
comma
id|pci_bus_modes
(braket
id|pci_bus
)braket
)paren
suffix:semicolon
)brace
id|strcat
c_func
(paren
id|str
comma
l_string|&quot; MHz)&quot;
)paren
suffix:semicolon
r_return
(paren
id|str
)paren
suffix:semicolon
)brace
r_char
op_star
DECL|function|qla2x00_get_fw_version_str
id|qla2x00_get_fw_version_str
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_char
op_star
id|str
)paren
(brace
r_char
id|un_str
(braket
l_int|10
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;%d.%02d.%02d &quot;
comma
id|ha-&gt;fw_major_version
comma
id|ha-&gt;fw_minor_version
comma
id|ha-&gt;fw_subminor_version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;fw_attributes
op_amp
id|BIT_9
)paren
(brace
id|strcat
c_func
(paren
id|str
comma
l_string|&quot;FLX&quot;
)paren
suffix:semicolon
r_return
(paren
id|str
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ha-&gt;fw_attributes
op_amp
l_int|0xFF
)paren
(brace
r_case
l_int|0x7
suffix:colon
id|strcat
c_func
(paren
id|str
comma
l_string|&quot;EF&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x17
suffix:colon
id|strcat
c_func
(paren
id|str
comma
l_string|&quot;TP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x37
suffix:colon
id|strcat
c_func
(paren
id|str
comma
l_string|&quot;IP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x77
suffix:colon
id|strcat
c_func
(paren
id|str
comma
l_string|&quot;VI&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
c_func
(paren
id|un_str
comma
l_string|&quot;(%x)&quot;
comma
id|ha-&gt;fw_attributes
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|str
comma
id|un_str
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;fw_attributes
op_amp
l_int|0x100
)paren
id|strcat
c_func
(paren
id|str
comma
l_string|&quot;X&quot;
)paren
suffix:semicolon
r_return
(paren
id|str
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* qla2x00_queuecommand&n;*&n;* Description:&n;*     Queue a command to the controller.&n;*&n;* Input:&n;*     cmd - pointer to Scsi cmd structure&n;*     fn - pointer to Scsi done function&n;*&n;* Returns:&n;*   0 - Always&n;*&n;* Note:&n;* The mid-level driver tries to ensures that queuecommand never gets invoked&n;* concurrently with itself or the interrupt handler (although the&n;* interrupt handler may call this routine as part of request-completion&n;* handling).&n;**************************************************************************/
r_static
r_int
DECL|function|qla2x00_queuecommand
id|qla2x00_queuecommand
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|fn
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|os_lun_t
op_star
id|lq
suffix:semicolon
id|os_tgt_t
op_star
id|tq
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
comma
op_star
id|ha2
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_int
r_int
id|b
comma
id|t
comma
id|l
suffix:semicolon
r_int
r_int
id|handle
suffix:semicolon
r_int
id|was_empty
suffix:semicolon
id|host
op_assign
id|cmd-&gt;device-&gt;host
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|was_empty
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|fn
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate a command packet from the &quot;sp&quot; pool.  If we cant get back&n;&t; * one then let scsi layer come back later.&n;&t; */
r_if
c_cond
(paren
(paren
id|sp
op_assign
id|qla2x00_get_new_sp
c_func
(paren
id|ha
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Couldn&squot;t allocate memory for sp - retried.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|sp-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|CMD_SP
c_func
(paren
id|cmd
)paren
op_assign
(paren
r_void
op_star
)paren
id|sp
suffix:semicolon
id|sp-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|CMD_RESID_LEN
c_func
(paren
id|cmd
)paren
op_amp
id|SRB_IOCTL
)paren
(brace
multiline_comment|/* Need to set sp-&gt;flags */
id|sp-&gt;flags
op_or_assign
id|SRB_IOCTL
suffix:semicolon
id|CMD_RESID_LEN
c_func
(paren
id|cmd
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear it since no more use. */
)brace
id|sp-&gt;fo_retry_cnt
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;err_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Generate LU queue on bus, target, LUN */
id|b
op_assign
id|cmd-&gt;device-&gt;channel
suffix:semicolon
id|t
op_assign
id|cmd-&gt;device-&gt;id
suffix:semicolon
id|l
op_assign
id|cmd-&gt;device-&gt;lun
suffix:semicolon
multiline_comment|/*&n;&t; * Start Command Timer. Typically it will be 2 seconds less than what&n;&t; * is requested by the Host such that we can return the IO before&n;&t; * aborts are called.&n;&t; */
r_if
c_cond
(paren
(paren
id|cmd-&gt;timeout_per_command
op_div
id|HZ
)paren
OG
id|QLA_CMD_TIMER_DELTA
)paren
id|qla2x00_add_timer_to_cmd
c_func
(paren
id|sp
comma
(paren
id|cmd-&gt;timeout_per_command
op_div
id|HZ
)paren
op_minus
id|QLA_CMD_TIMER_DELTA
)paren
suffix:semicolon
r_else
id|qla2x00_add_timer_to_cmd
c_func
(paren
id|sp
comma
id|cmd-&gt;timeout_per_command
op_div
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l
op_ge
id|ha-&gt;max_luns
)paren
(brace
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|sp-&gt;err_id
op_assign
id|SRB_ERR_PORT
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|sp_put
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tq
op_assign
(paren
id|os_tgt_t
op_star
)paren
id|TGT_Q
c_func
(paren
id|ha
comma
id|t
)paren
)paren
op_ne
l_int|NULL
op_logical_and
(paren
id|lq
op_assign
(paren
id|os_lun_t
op_star
)paren
id|LUN_Q
c_func
(paren
id|ha
comma
id|t
comma
id|l
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|fcport
op_assign
id|lq-&gt;fclun-&gt;fcport
suffix:semicolon
id|ha2
op_assign
id|fcport-&gt;ha
suffix:semicolon
)brace
r_else
(brace
id|lq
op_assign
l_int|NULL
suffix:semicolon
id|fcport
op_assign
l_int|NULL
suffix:semicolon
id|ha2
op_assign
id|ha
suffix:semicolon
)brace
multiline_comment|/* Set an invalid handle until we issue the command to ISP */
multiline_comment|/* then we will set the real handle value.                 */
id|handle
op_assign
id|INVALID_HANDLE
suffix:semicolon
id|cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|handle
suffix:semicolon
multiline_comment|/* Bookkeeping information */
id|sp-&gt;r_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Time the request was recieved. */
id|sp-&gt;u_start
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Setup device queue pointers. */
id|sp-&gt;tgt_queue
op_assign
id|tq
suffix:semicolon
id|sp-&gt;lun_queue
op_assign
id|lq
suffix:semicolon
multiline_comment|/*&n;&t; * NOTE : q is NULL&n;&t; *&n;&t; * 1. When device is added from persistent binding but has not been&n;&t; *    discovered yet.The state of loopid == PORT_AVAIL.&n;&t; * 2. When device is never found on the bus.(loopid == UNUSED)&n;&t; *&n;&t; * IF Device Queue is not created, or device is not in a valid state&n;&t; * and link down error reporting is enabled, reject IO.&n;&t; */
r_if
c_cond
(paren
id|fcport
op_eq
l_int|NULL
)paren
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld:%2d:%2d): port unavailable&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|t
comma
id|l
)paren
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|sp-&gt;err_id
op_assign
id|SRB_ERR_PORT
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|sp_put
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Only modify the allowed count if the target is a *non* tape device */
r_if
c_cond
(paren
(paren
id|fcport-&gt;flags
op_amp
id|FCF_TAPE_PRESENT
)paren
op_eq
l_int|0
)paren
(brace
id|sp-&gt;flags
op_and_assign
op_complement
id|SRB_TAPE
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;allowed
OL
id|ql2xretrycount
)paren
(brace
id|cmd-&gt;allowed
op_assign
id|ql2xretrycount
suffix:semicolon
)brace
)brace
r_else
id|sp-&gt;flags
op_or_assign
id|SRB_TAPE
suffix:semicolon
id|DEBUG5
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld:%2d:%2d): (queuecmd) queue sp = %p, &quot;
l_string|&quot;flags=0x%x fo retry=%d, pid=%ld&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|t
comma
id|l
comma
id|sp
comma
id|sp-&gt;flags
comma
id|sp-&gt;fo_retry_cnt
comma
id|cmd-&gt;serial_number
)paren
)paren
suffix:semicolon
id|DEBUG5
c_func
(paren
id|qla2x00_print_scsi_cmd
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|sp-&gt;fclun
op_assign
id|lq-&gt;fclun
suffix:semicolon
id|sp-&gt;ha
op_assign
id|ha2
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;sc_data_direction
op_eq
id|DMA_BIDIRECTIONAL
op_logical_and
id|cmd-&gt;request_bufflen
op_ne
l_int|0
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(%ld): Incorrect data direction - transfer &quot;
l_string|&quot;length=%d, direction=%d, pid=%ld, opcode=%x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|cmd-&gt;request_bufflen
comma
id|cmd-&gt;sc_data_direction
comma
id|cmd-&gt;serial_number
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Final pre-check :&n;&t; *&n;&t; *&t;Either PORT_DOWN_TIMER OR LINK_DOWN_TIMER Expired.&n;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_DEVICE_DEAD
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|ha2-&gt;loop_state
)paren
op_eq
id|LOOP_DEAD
)paren
(brace
multiline_comment|/*&n;&t;&t; * Add the command to the done-queue for later failover&n;&t;&t; * processing.&n;&t;&t; */
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha2-&gt;loop_state
)paren
op_eq
id|LOOP_DOWN
)paren
id|sp-&gt;err_id
op_assign
id|SRB_ERR_LOOP
suffix:semicolon
r_else
id|sp-&gt;err_id
op_assign
id|SRB_ERR_PORT
suffix:semicolon
id|add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|qla2x00_done
c_func
(paren
id|ha
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tq
op_logical_and
id|test_bit
c_func
(paren
id|TQF_SUSPENDED
comma
op_amp
id|tq-&gt;flags
)paren
op_logical_and
(paren
id|sp-&gt;flags
op_amp
id|SRB_TAPE
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* If target suspended put incoming I/O in retry_q. */
id|qla2x00_extend_timeout
c_func
(paren
id|sp-&gt;cmd
comma
l_int|10
)paren
suffix:semicolon
id|add_to_scsi_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
r_else
id|was_empty
op_assign
id|add_to_pending_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
op_logical_and
id|ha-&gt;flags.online
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;response_ring_ptr-&gt;signature
op_ne
id|RESPONSE_PROCESSED
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|qla2x00_process_response_queue
c_func
(paren
id|ha
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* We submit to the hardware if:&n;&t; *&n;&t; *&t;1) we&squot;re on the cpu the irq&squot;s arrive on or&n;&t; *&t;2) there are very few io&squot;s outstanding.&n;&t; *&n;&t; * In all other cases we&squot;ll let an irq pick up our IO and submit it&n;&t; * to the controller to improve affinity.&n;&t; */
r_if
c_cond
(paren
id|smp_processor_id
c_func
(paren
)paren
op_eq
id|ha-&gt;last_irq_cpu
op_logical_or
id|was_empty
)paren
id|qla2x00_next
c_func
(paren
id|ha
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_eh_wait_on_command&n; *    Waits for the command to be returned by the Firmware for some&n; *    max time.&n; *&n; * Input:&n; *    ha = actual ha whose done queue will contain the command&n; *&t;      returned by firmware.&n; *    cmd = Scsi Command to wait on.&n; *    flag = Abort/Reset(Bus or Device Reset)&n; *&n; * Return:&n; *    Not Found : 0&n; *    Found : 1&n; */
r_static
r_int
DECL|function|qla2x00_eh_wait_on_command
id|qla2x00_eh_wait_on_command
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
DECL|macro|ABORT_POLLING_PERIOD
mdefine_line|#define ABORT_POLLING_PERIOD&t;HZ
DECL|macro|ABORT_WAIT_TIME
mdefine_line|#define ABORT_WAIT_TIME&t;&t;((10 * HZ) / (ABORT_POLLING_PERIOD))
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_int
id|done
op_assign
l_int|0
suffix:semicolon
id|srb_t
op_star
id|rp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|list
comma
op_star
id|temp
suffix:semicolon
id|u_long
id|max_wait_time
op_assign
id|ABORT_WAIT_TIME
suffix:semicolon
r_do
(brace
multiline_comment|/* Check on done queue */
id|spin_lock
c_func
(paren
op_amp
id|ha-&gt;list_lock
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|list
comma
id|temp
comma
op_amp
id|ha-&gt;done_queue
)paren
(brace
id|rp
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|srb_t
comma
id|list
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Found command. Just exit and wait for the cmd sent&n;&t;&t;&t; * to OS.&n;&t;&t;&t;*/
r_if
c_cond
(paren
id|cmd
op_eq
id|rp-&gt;cmd
)paren
(brace
id|found
op_increment
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s: found in done queue.&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
)paren
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;list_lock
)paren
suffix:semicolon
multiline_comment|/* Complete the cmd right away. */
r_if
c_cond
(paren
id|found
)paren
(brace
id|qla2x00_delete_from_done_queue
c_func
(paren
id|ha
comma
id|rp
)paren
suffix:semicolon
id|sp_put
c_func
(paren
id|ha
comma
id|rp
)paren
suffix:semicolon
id|done
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|ABORT_POLLING_PERIOD
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|max_wait_time
op_decrement
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: found cmd=%p.&bslash;n&quot;
comma
id|__func__
comma
id|cmd
)paren
)paren
suffix:semicolon
r_return
(paren
id|done
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_wait_for_hba_online&n; *    Wait till the HBA is online after going through &n; *    &lt;= MAX_RETRIES_OF_ISP_ABORT  or&n; *    finally HBA is disabled ie marked offline&n; *&n; * Input:&n; *     ha - pointer to host adapter structure&n; * &n; * Note:    &n; *    Does context switching-Release SPIN_LOCK&n; *    (if any) before calling this routine.&n; *&n; * Return:&n; *    Success (Adapter is online) : 0&n; *    Failed  (Adapter is offline/disabled) : 1&n; */
r_static
r_int
DECL|function|qla2x00_wait_for_hba_online
id|qla2x00_wait_for_hba_online
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|return_status
suffix:semicolon
r_int
r_int
id|wait_online
suffix:semicolon
id|wait_online
op_assign
id|jiffies
op_plus
(paren
id|MAX_LOOP_TIMEOUT
op_star
id|HZ
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|test_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
op_logical_or
id|test_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
op_logical_or
id|test_bit
c_func
(paren
id|ISP_ABORT_RETRY
comma
op_amp
id|ha-&gt;dpc_flags
)paren
op_logical_or
id|ha-&gt;dpc_active
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|wait_online
)paren
)paren
(brace
id|msleep
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;flags.online
)paren
id|return_status
op_assign
id|QLA_SUCCESS
suffix:semicolon
r_else
id|return_status
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s return_status=%d&bslash;n&quot;
comma
id|__func__
comma
id|return_status
)paren
)paren
suffix:semicolon
r_return
(paren
id|return_status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_wait_for_loop_ready&n; *    Wait for MAX_LOOP_TIMEOUT(5 min) value for loop&n; *    to be in LOOP_READY state.&t; &n; * Input:&n; *     ha - pointer to host adapter structure&n; * &n; * Note:    &n; *    Does context switching-Release SPIN_LOCK&n; *    (if any) before calling this routine.&n; *    &n; *&n; * Return:&n; *    Success (LOOP_READY) : 0&n; *    Failed  (LOOP_NOT_READY) : 1&n; */
r_static
r_inline
r_int
DECL|function|qla2x00_wait_for_loop_ready
id|qla2x00_wait_for_loop_ready
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|return_status
op_assign
id|QLA_SUCCESS
suffix:semicolon
r_int
r_int
id|loop_timeout
suffix:semicolon
multiline_comment|/* wait for 5 min at the max for loop to be ready */
id|loop_timeout
op_assign
id|jiffies
op_plus
(paren
id|MAX_LOOP_TIMEOUT
op_star
id|HZ
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_eq
id|LOOP_DOWN
)paren
op_logical_or
id|test_bit
c_func
(paren
id|CFG_ACTIVE
comma
op_amp
id|ha-&gt;cfg_flags
)paren
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_ne
id|LOOP_READY
)paren
(brace
id|msleep
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|loop_timeout
)paren
)paren
(brace
id|return_status
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
(paren
id|return_status
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* qla2xxx_eh_abort&n;*&n;* Description:&n;*    The abort function will abort the specified command.&n;*&n;* Input:&n;*    cmd = Linux SCSI command packet to be aborted.&n;*&n;* Returns:&n;*    Either SUCCESS or FAILED.&n;*&n;* Note:&n;**************************************************************************/
r_int
DECL|function|qla2xxx_eh_abort
id|qla2xxx_eh_abort
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|return_status
op_assign
id|FAILED
suffix:semicolon
id|os_lun_t
op_star
id|q
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|scsi_qla_host_t
op_star
id|vis_ha
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
id|srb_t
op_star
id|rp
suffix:semicolon
r_struct
id|list_head
op_star
id|list
comma
op_star
id|temp
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_uint8
id|found
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|b
comma
id|t
comma
id|l
suffix:semicolon
multiline_comment|/* Get the SCSI request ptr */
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If sp is NULL, command is already returned.&n;&t; * sp is NULLED just before we call back scsi_done&n;&t; *&n;&t; */
r_if
c_cond
(paren
(paren
id|sp
op_eq
l_int|NULL
)paren
)paren
(brace
multiline_comment|/* no action - we don&squot;t have command */
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|to_qla_host
c_func
(paren
id|cmd-&gt;device-&gt;host
)paren
comma
l_string|&quot;qla2xxx_eh_abort: cmd already done sp=%p&bslash;n&quot;
comma
id|sp
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort: cmd already done sp=%p&bslash;n&quot;
comma
id|sp
)paren
suffix:semicolon
)paren
r_return
id|SUCCESS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sp
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort: refcount %i &bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|sp-&gt;ref_count
)paren
)paren
suffix:semicolon
)paren
)brace
id|vis_ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|host
op_assign
id|ha-&gt;host
suffix:semicolon
multiline_comment|/* Generate LU queue on bus, target, LUN */
id|b
op_assign
id|cmd-&gt;device-&gt;channel
suffix:semicolon
id|t
op_assign
id|cmd-&gt;device-&gt;id
suffix:semicolon
id|l
op_assign
id|cmd-&gt;device-&gt;lun
suffix:semicolon
id|q
op_assign
id|GET_LU_Q
c_func
(paren
id|vis_ha
comma
id|t
comma
id|l
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;%s scsi(%ld:%d:%d:%d): cmd_timeout_in_sec=0x%x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
(paren
r_int
)paren
id|b
comma
(paren
r_int
)paren
id|t
comma
(paren
r_int
)paren
id|l
comma
id|cmd-&gt;timeout_per_command
op_div
id|HZ
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * if no LUN queue then something is very wrong!!!&n;&t; */
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;qla2x00: (%x:%x:%x) No LUN queue.&bslash;n&quot;
comma
id|b
comma
id|t
comma
id|l
)paren
suffix:semicolon
multiline_comment|/* no action - we don&squot;t have command */
r_return
id|FAILED
suffix:semicolon
)brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): ABORTing cmd=%p sp=%p jiffies = 0x%lx, &quot;
l_string|&quot;timeout=%x, dpc_flags=%lx, vis_ha-&gt;dpc_flags=%lx q-&gt;flag=%lx&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|cmd
comma
id|sp
comma
id|jiffies
comma
id|cmd-&gt;timeout_per_command
op_div
id|HZ
comma
id|ha-&gt;dpc_flags
comma
id|vis_ha-&gt;dpc_flags
comma
id|q-&gt;q_flag
)paren
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|qla2x00_print_scsi_cmd
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla2x00_wait_for_hba_online
c_func
(paren
id|ha
)paren
op_ne
id|QLA_SUCCESS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s failed:board disabled&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
)paren
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/* Search done queue */
id|spin_lock
c_func
(paren
op_amp
id|ha-&gt;list_lock
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|list
comma
id|temp
comma
op_amp
id|ha-&gt;done_queue
)paren
(brace
id|rp
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|srb_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|rp-&gt;cmd
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Found command.Remove it from done list.&n;&t;&t; * And proceed to post completion to scsi mid layer.&n;&t;&t; */
id|return_status
op_assign
id|SUCCESS
suffix:semicolon
id|found
op_increment
suffix:semicolon
id|qla2x00_delete_from_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* list_for_each_safe() */
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;list_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Return immediately if the aborted command was already in the done&n;&t; * queue&n;&t; */
r_if
c_cond
(paren
id|found
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;qla2xxx_eh_abort: Returning completed command=%p sp=%p&bslash;n&quot;
comma
id|cmd
comma
id|sp
)paren
suffix:semicolon
id|sp_put
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_return
(paren
id|return_status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * See if this command is in the retry queue&n;&t; */
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort: searching sp %p in retry &quot;
l_string|&quot;queue.&bslash;n&quot;
comma
id|sp
)paren
suffix:semicolon
)paren
id|spin_lock
c_func
(paren
op_amp
id|ha-&gt;list_lock
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|list
comma
id|temp
comma
op_amp
id|ha-&gt;retry_queue
)paren
(brace
id|rp
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|srb_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|rp-&gt;cmd
)paren
r_continue
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort: found &quot;
l_string|&quot;in retry queue. SP=%p&bslash;n&quot;
comma
id|sp
)paren
suffix:semicolon
)paren
id|__del_from_retry_queue
c_func
(paren
id|ha
comma
id|rp
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|__add_to_done_queue
c_func
(paren
id|ha
comma
id|rp
)paren
suffix:semicolon
id|return_status
op_assign
id|SUCCESS
suffix:semicolon
id|found
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;list_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Our SP pointer points at the command we want to remove from the&n;&t; * pending queue providing we haven&squot;t already sent it to the adapter.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort: searching sp %p &quot;
l_string|&quot;in pending queue.&bslash;n&quot;
comma
id|sp
)paren
suffix:semicolon
)paren
id|spin_lock
c_func
(paren
op_amp
id|vis_ha-&gt;list_lock
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|list
comma
id|temp
comma
op_amp
id|vis_ha-&gt;pending_queue
)paren
(brace
id|rp
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|srb_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;cmd
op_ne
id|cmd
)paren
r_continue
suffix:semicolon
multiline_comment|/* Remove srb from LUN queue. */
id|rp-&gt;flags
op_or_assign
id|SRB_ABORTED
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort: Cmd in pending queue.&quot;
l_string|&quot; serial_number %ld.&bslash;n&quot;
comma
id|sp-&gt;cmd-&gt;serial_number
)paren
suffix:semicolon
)paren
id|__del_from_pending_queue
c_func
(paren
id|vis_ha
comma
id|rp
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|__add_to_done_queue
c_func
(paren
id|vis_ha
comma
id|rp
)paren
suffix:semicolon
id|return_status
op_assign
id|SUCCESS
suffix:semicolon
id|found
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* list_for_each_safe() */
id|spin_unlock
c_func
(paren
op_amp
id|vis_ha-&gt;list_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*End of if !found */
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
multiline_comment|/* find the command in our active list */
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort: searching sp %p &quot;
l_string|&quot;in outstanding queue.&bslash;n&quot;
comma
id|sp
)paren
suffix:semicolon
)paren
id|spin_lock
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;cmd
op_ne
id|cmd
)paren
r_continue
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort(%ld): aborting sp %p &quot;
l_string|&quot;from RISC. pid=%ld sp-&gt;state=%x q-&gt;q_flag=%lx&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|sp
comma
id|sp-&gt;cmd-&gt;serial_number
comma
id|sp-&gt;state
comma
id|q-&gt;q_flag
)paren
suffix:semicolon
)paren
id|DEBUG
c_func
(paren
id|qla2x00_print_scsi_cmd
c_func
(paren
id|cmd
)paren
suffix:semicolon
)paren
multiline_comment|/* Get a reference to the sp and drop the lock.*/
id|sp_get
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla2x00_abort_command
c_func
(paren
id|ha
comma
id|sp
)paren
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort: abort_command &quot;
l_string|&quot;mbx failed.&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|return_status
op_assign
id|FAILED
suffix:semicolon
)brace
r_else
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort: abort_command &quot;
l_string|&quot; mbx success.&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|return_status
op_assign
id|SUCCESS
suffix:semicolon
)brace
id|sp_put
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Regardless of mailbox command status, go check on&n;&t;&t;&t; * done queue just in case the sp is already done.&n;&t;&t;&t; */
r_break
suffix:semicolon
)brace
multiline_comment|/*End of for loop */
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*End of if !found */
multiline_comment|/* Waiting for our command in done_queue to be returned to OS.*/
r_if
c_cond
(paren
id|qla2x00_eh_wait_on_command
c_func
(paren
id|ha
comma
id|cmd
)paren
op_ne
l_int|0
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort: cmd returned back to OS.&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|return_status
op_assign
id|SUCCESS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|return_status
op_eq
id|FAILED
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;qla2xxx_eh_abort Exiting: status=Failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_abort: Exiting. return_status=0x%x.&bslash;n&quot;
comma
id|return_status
)paren
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* qla2x00_eh_wait_for_pending_target_commands&n;*&n;* Description:&n;*    Waits for all the commands to come back from the specified target.&n;*&n;* Input:&n;*    ha - pointer to scsi_qla_host structure.&n;*    t  - target &t;&n;* Returns:&n;*    Either SUCCESS or FAILED.&n;*&n;* Note:&n;**************************************************************************/
r_static
r_int
DECL|function|qla2x00_eh_wait_for_pending_target_commands
id|qla2x00_eh_wait_for_pending_target_commands
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_int
r_int
id|t
)paren
(brace
r_int
id|cnt
suffix:semicolon
r_int
id|status
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmd
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Waiting for all commands for the designated target in the active&n;&t; * array&n;&t; */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
)paren
suffix:semicolon
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;id
op_eq
id|t
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|qla2x00_eh_wait_on_command
c_func
(paren
id|ha
comma
id|cmd
)paren
)paren
(brace
id|status
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* qla2xxx_eh_device_reset&n;*&n;* Description:&n;*    The device reset function will reset the target and abort any&n;*    executing commands.&n;*&n;*    NOTE: The use of SP is undefined within this context.  Do *NOT*&n;*          attempt to use this value, even if you determine it is &n;*          non-null.&n;*&n;* Input:&n;*    cmd = Linux SCSI command packet of the command that cause the&n;*          bus device reset.&n;*&n;* Returns:&n;*    SUCCESS/FAILURE (defined as macro in scsi.h).&n;*&n;**************************************************************************/
r_int
DECL|function|qla2xxx_eh_device_reset
id|qla2xxx_eh_device_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_int
id|return_status
suffix:semicolon
r_int
r_int
id|b
comma
id|t
comma
id|l
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|os_tgt_t
op_star
id|tq
suffix:semicolon
id|os_lun_t
op_star
id|lq
suffix:semicolon
id|fc_port_t
op_star
id|fcport_to_reset
suffix:semicolon
id|srb_t
op_star
id|rp
suffix:semicolon
r_struct
id|list_head
op_star
id|list
comma
op_star
id|temp
suffix:semicolon
id|return_status
op_assign
id|FAILED
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s(): **** SCSI mid-layer passing in NULL cmd&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_return
(paren
id|return_status
)paren
suffix:semicolon
)brace
id|b
op_assign
id|cmd-&gt;device-&gt;channel
suffix:semicolon
id|t
op_assign
id|cmd-&gt;device-&gt;id
suffix:semicolon
id|l
op_assign
id|cmd-&gt;device-&gt;lun
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|tq
op_assign
id|TGT_Q
c_func
(paren
id|ha
comma
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tq
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;%s(): **** CMD derives a NULL TGT_Q&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_return
(paren
id|return_status
)paren
suffix:semicolon
)brace
id|lq
op_assign
(paren
id|os_lun_t
op_star
)paren
id|LUN_Q
c_func
(paren
id|ha
comma
id|t
comma
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lq
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s(): **** CMD derives a NULL LUN_Q&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_return
(paren
id|return_status
)paren
suffix:semicolon
)brace
id|fcport_to_reset
op_assign
id|lq-&gt;fclun-&gt;fcport
suffix:semicolon
multiline_comment|/* If we are coming in from the back-door, stall I/O until complete. */
r_if
c_cond
(paren
op_logical_neg
id|cmd-&gt;device-&gt;host-&gt;eh_active
)paren
id|set_bit
c_func
(paren
id|TQF_SUSPENDED
comma
op_amp
id|tq-&gt;flags
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi(%ld:%d:%d:%d): DEVICE RESET ISSUED.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|b
comma
id|t
comma
id|l
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): DEVICE_RESET cmd=%p jiffies = 0x%lx, timeout=%x, &quot;
l_string|&quot;dpc_flags=%lx, status=%x allowed=%d cmd.state=%x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|cmd
comma
id|jiffies
comma
id|cmd-&gt;timeout_per_command
op_div
id|HZ
comma
id|ha-&gt;dpc_flags
comma
id|cmd-&gt;result
comma
id|cmd-&gt;allowed
comma
id|cmd-&gt;state
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear commands from the retry queue. */
id|spin_lock
c_func
(paren
op_amp
id|ha-&gt;list_lock
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|list
comma
id|temp
comma
op_amp
id|ha-&gt;retry_queue
)paren
(brace
id|rp
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|srb_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
op_ne
id|rp-&gt;cmd-&gt;device-&gt;id
)paren
r_continue
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla2xxx_eh_reset: found in retry queue. SP=%p&bslash;n&quot;
comma
id|rp
)paren
)paren
suffix:semicolon
id|__del_from_retry_queue
c_func
(paren
id|ha
comma
id|rp
)paren
suffix:semicolon
id|rp-&gt;cmd-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|__add_to_done_queue
c_func
(paren
id|ha
comma
id|rp
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;list_lock
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla2x00_wait_for_hba_online
c_func
(paren
id|ha
)paren
op_ne
id|QLA_SUCCESS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s failed:board disabled&bslash;n&quot;
comma
id|__func__
)paren
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_goto
id|eh_dev_reset_done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qla2x00_wait_for_loop_ready
c_func
(paren
id|ha
)paren
op_eq
id|QLA_SUCCESS
)paren
(brace
r_if
c_cond
(paren
id|qla2x00_device_reset
c_func
(paren
id|ha
comma
id|fcport_to_reset
)paren
op_eq
l_int|0
)paren
(brace
id|return_status
op_assign
id|SUCCESS
suffix:semicolon
)brace
macro_line|#if defined(LOGOUT_AFTER_DEVICE_RESET)
r_if
c_cond
(paren
id|return_status
op_eq
id|SUCCESS
)paren
(brace
r_if
c_cond
(paren
id|fcport_to_reset-&gt;flags
op_amp
id|FC_FABRIC_DEVICE
)paren
(brace
id|qla2x00_fabric_logout
c_func
(paren
id|ha
comma
id|fcport_to_reset-&gt;loop_id
)paren
suffix:semicolon
id|qla2x00_mark_device_lost
c_func
(paren
id|ha
comma
id|fcport_to_reset
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
r_else
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s failed: loop not ready&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
)paren
)brace
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|return_status
op_eq
id|FAILED
)paren
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): device reset failed&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;%s: device reset failed&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_goto
id|eh_dev_reset_done
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If we are coming down the EH path, wait for all commands to&n;&t; * complete for the device.&n;&t; */
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;host-&gt;eh_active
)paren
(brace
r_if
c_cond
(paren
id|qla2x00_eh_wait_for_pending_target_commands
c_func
(paren
id|ha
comma
id|t
)paren
)paren
id|return_status
op_assign
id|FAILED
suffix:semicolon
r_if
c_cond
(paren
id|return_status
op_eq
id|FAILED
)paren
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): failed while waiting for &quot;
l_string|&quot;commands&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;%s: failed while waiting for commands&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_goto
id|eh_dev_reset_done
suffix:semicolon
)brace
)brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi(%ld:%d:%d:%d): DEVICE RESET SUCCEEDED.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|b
comma
id|t
comma
id|l
)paren
suffix:semicolon
id|eh_dev_reset_done
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|cmd-&gt;device-&gt;host-&gt;eh_active
)paren
id|clear_bit
c_func
(paren
id|TQF_SUSPENDED
comma
op_amp
id|tq-&gt;flags
)paren
suffix:semicolon
r_return
(paren
id|return_status
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* qla2x00_eh_wait_for_pending_commands&n;*&n;* Description:&n;*    Waits for all the commands to come back from the specified host.&n;*&n;* Input:&n;*    ha - pointer to scsi_qla_host structure.&n;*&n;* Returns:&n;*    1 : SUCCESS&n;*    0 : FAILED&n;*&n;* Note:&n;**************************************************************************/
r_static
r_int
DECL|function|qla2x00_eh_wait_for_pending_commands
id|qla2x00_eh_wait_for_pending_commands
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|cnt
suffix:semicolon
r_int
id|status
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmd
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Waiting for all commands for the designated target in the active&n;&t; * array&n;&t; */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
)paren
suffix:semicolon
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
)paren
suffix:semicolon
id|status
op_assign
id|qla2x00_eh_wait_on_command
c_func
(paren
id|ha
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* qla2xxx_eh_bus_reset&n;*&n;* Description:&n;*    The bus reset function will reset the bus and abort any executing&n;*    commands.&n;*&n;* Input:&n;*    cmd = Linux SCSI command packet of the command that cause the&n;*          bus reset.&n;*&n;* Returns:&n;*    SUCCESS/FAILURE (defined as macro in scsi.h).&n;*&n;**************************************************************************/
r_int
DECL|function|qla2xxx_eh_bus_reset
id|qla2xxx_eh_bus_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_int
id|rval
op_assign
id|FAILED
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi(%ld:%d:%d:%d): LOOP RESET ISSUED.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|cmd-&gt;device-&gt;channel
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla2x00_wait_for_hba_online
c_func
(paren
id|ha
)paren
op_ne
id|QLA_SUCCESS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s failed:board disabled&bslash;n&quot;
comma
id|__func__
)paren
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qla2x00_wait_for_loop_ready
c_func
(paren
id|ha
)paren
op_eq
id|QLA_SUCCESS
)paren
(brace
r_if
c_cond
(paren
id|qla2x00_loop_reset
c_func
(paren
id|ha
)paren
op_eq
id|QLA_SUCCESS
)paren
id|rval
op_assign
id|SUCCESS
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|FAILED
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Waiting for our command in done_queue to be returned to OS.*/
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;host-&gt;eh_active
)paren
r_if
c_cond
(paren
op_logical_neg
id|qla2x00_eh_wait_for_pending_commands
c_func
(paren
id|ha
)paren
)paren
id|rval
op_assign
id|FAILED
suffix:semicolon
id|out
suffix:colon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;%s: reset %s&bslash;n&quot;
comma
id|__func__
comma
(paren
id|rval
op_eq
id|FAILED
)paren
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeded&quot;
)paren
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* qla2xxx_eh_host_reset&n;*&n;* Description:&n;*    The reset function will reset the Adapter.&n;*&n;* Input:&n;*      cmd = Linux SCSI command packet of the command that cause the&n;*            adapter reset.&n;*&n;* Returns:&n;*      Either SUCCESS or FAILED.&n;*&n;* Note:&n;**************************************************************************/
r_int
DECL|function|qla2xxx_eh_host_reset
id|qla2xxx_eh_host_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_int
id|rval
op_assign
id|SUCCESS
suffix:semicolon
multiline_comment|/* Display which one we&squot;re actually resetting for debug. */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2xxx_eh_host_reset:Resetting scsi(%ld).&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Now issue reset.&n;&t; */
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi(%ld:%d:%d:%d): ADAPTER RESET issued.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|cmd-&gt;device-&gt;channel
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla2x00_wait_for_hba_online
c_func
(paren
id|ha
)paren
op_ne
id|QLA_SUCCESS
)paren
r_goto
id|board_disabled
suffix:semicolon
multiline_comment|/*&n;&t; * Fixme-may be dpc thread is active and processing&n;&t; * loop_resync,so wait a while for it to &n;&t; * be completed and then issue big hammer.Otherwise&n;&t; * it may cause I/O failure as big hammer marks the&n;&t; * devices as lost kicking of the port_down_timer&n;&t; * while dpc is stuck for the mailbox to complete.&n;&t; */
multiline_comment|/* Blocking call-Does context switching if loop is Not Ready */
id|qla2x00_wait_for_loop_ready
c_func
(paren
id|ha
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla2x00_abort_isp
c_func
(paren
id|ha
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
multiline_comment|/* failed. schedule dpc to try */
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla2x00_wait_for_hba_online
c_func
(paren
id|ha
)paren
op_ne
id|QLA_SUCCESS
)paren
r_goto
id|board_disabled
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|FAILED
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Waiting for our command in done_queue to be returned to OS.*/
r_if
c_cond
(paren
op_logical_neg
id|qla2x00_eh_wait_for_pending_commands
c_func
(paren
id|ha
)paren
)paren
id|rval
op_assign
id|FAILED
suffix:semicolon
id|out
suffix:colon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;%s: reset %s&bslash;n&quot;
comma
id|__func__
comma
(paren
id|rval
op_eq
id|FAILED
)paren
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeded&quot;
)paren
suffix:semicolon
r_return
id|rval
suffix:semicolon
id|board_disabled
suffix:colon
id|spin_lock_irq
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;%s: failed:board disabled&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/*&n;* qla2x00_loop_reset&n;*      Issue loop reset.&n;*&n;* Input:&n;*      ha = adapter block pointer.&n;*&n;* Returns:&n;*      0 = success&n;*/
r_static
r_int
DECL|function|qla2x00_loop_reset
id|qla2x00_loop_reset
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|status
op_assign
id|QLA_SUCCESS
suffix:semicolon
r_uint16
id|t
suffix:semicolon
id|os_tgt_t
op_star
id|tq
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.enable_lip_reset
)paren
(brace
id|status
op_assign
id|qla2x00_lip_reset
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_eq
id|QLA_SUCCESS
op_logical_and
id|ha-&gt;flags.enable_target_reset
)paren
(brace
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_FIBRE_DEVICES
suffix:semicolon
id|t
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tq
op_assign
id|TGT_Q
c_func
(paren
id|ha
comma
id|t
)paren
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|tq-&gt;fcport
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|status
op_assign
id|qla2x00_target_reset
c_func
(paren
id|ha
comma
l_int|0
comma
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|QLA_SUCCESS
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|status
op_eq
id|QLA_SUCCESS
op_logical_and
(paren
(paren
op_logical_neg
id|ha-&gt;flags.enable_target_reset
op_logical_and
op_logical_neg
id|ha-&gt;flags.enable_lip_reset
)paren
op_logical_or
id|ha-&gt;flags.enable_lip_full_login
)paren
)paren
(brace
id|status
op_assign
id|qla2x00_full_login_lip
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
multiline_comment|/* Issue marker command only when we are going to start the I/O */
id|ha-&gt;marker_needed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/* Empty */
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): **** FAILED ****&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/* Empty */
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): exiting normally.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_device_reset&n; *&t;Issue bus device reset message to the target.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;t = SCSI ID.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_int
DECL|function|qla2x00_device_reset
id|qla2x00_device_reset
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|reset_fcport
)paren
(brace
multiline_comment|/* Abort Target command will clear Reservation */
r_return
id|qla2x00_abort_target
c_func
(paren
id|reset_fcport
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;* qla2xxx_slave_configure&n;*&n;* Description:&n;**************************************************************************/
r_int
DECL|function|qla2xxx_slave_configure
id|qla2xxx_slave_configure
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
op_assign
id|to_qla_host
c_func
(paren
id|sdev-&gt;host
)paren
suffix:semicolon
r_int
id|queue_depth
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
id|queue_depth
op_assign
l_int|16
suffix:semicolon
r_else
id|queue_depth
op_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|sdev-&gt;tagged_supported
)paren
(brace
r_if
c_cond
(paren
id|ql2xmaxqdepth
op_ne
l_int|0
op_logical_and
id|ql2xmaxqdepth
op_le
l_int|0xffffU
)paren
id|queue_depth
op_assign
id|ql2xmaxqdepth
suffix:semicolon
id|ql2xmaxqdepth
op_assign
id|queue_depth
suffix:semicolon
id|scsi_activate_tcq
c_func
(paren
id|sdev
comma
id|queue_depth
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi(%d:%d:%d:%d): Enabled tagged queuing, queue &quot;
l_string|&quot;depth %d.&bslash;n&quot;
comma
id|sdev-&gt;host-&gt;host_no
comma
id|sdev-&gt;channel
comma
id|sdev-&gt;id
comma
id|sdev-&gt;lun
comma
id|sdev-&gt;queue_depth
)paren
suffix:semicolon
)brace
r_else
(brace
id|scsi_adjust_queue_depth
c_func
(paren
id|sdev
comma
l_int|0
multiline_comment|/* TCQ off */
comma
id|sdev-&gt;host-&gt;hostt-&gt;cmd_per_lun
multiline_comment|/* 3 */
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_config_dma_addressing() - Configure OS DMA addressing method.&n; * @ha: HA context&n; *&n; * At exit, the @ha&squot;s flags.enable_64bit_addressing set to indicated&n; * supported addressing method.&n; */
r_static
r_void
DECL|function|qla2x00_config_dma_addressing
id|qla2x00_config_dma_addressing
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
multiline_comment|/* Assume 32bit DMA address */
id|ha-&gt;flags.enable_64bit_addressing
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;calc_request_entries
op_assign
id|qla2x00_calc_iocbs_32
suffix:semicolon
id|ha-&gt;build_scsi_iocbs
op_assign
id|qla2x00_build_scsi_iocbs_32
suffix:semicolon
multiline_comment|/*&n;&t; * Given the two variants pci_set_dma_mask(), allow the compiler to&n;&t; * assist in setting the proper dma mask.&n;&t; */
r_if
c_cond
(paren
r_sizeof
(paren
id|dma_addr_t
)paren
OG
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|ha-&gt;pdev
comma
id|DMA_64BIT_MASK
)paren
op_eq
l_int|0
)paren
(brace
id|ha-&gt;flags.enable_64bit_addressing
op_assign
l_int|1
suffix:semicolon
id|ha-&gt;calc_request_entries
op_assign
id|qla2x00_calc_iocbs_64
suffix:semicolon
id|ha-&gt;build_scsi_iocbs
op_assign
id|qla2x00_build_scsi_iocbs_64
suffix:semicolon
r_if
c_cond
(paren
id|pci_set_consistent_dma_mask
c_func
(paren
id|ha-&gt;pdev
comma
id|DMA_64BIT_MASK
)paren
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_DEBUG
comma
id|ha
comma
l_string|&quot;Failed to set 64 bit PCI consistent mask; &quot;
l_string|&quot;using 32 bit.&bslash;n&quot;
)paren
suffix:semicolon
id|pci_set_consistent_dma_mask
c_func
(paren
id|ha-&gt;pdev
comma
id|DMA_32BIT_MASK
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|qla_printk
c_func
(paren
id|KERN_DEBUG
comma
id|ha
comma
l_string|&quot;Failed to set 64 bit PCI DMA mask, falling back &quot;
l_string|&quot;to 32 bit MASK.&bslash;n&quot;
)paren
suffix:semicolon
id|pci_set_dma_mask
c_func
(paren
id|ha-&gt;pdev
comma
id|DMA_32BIT_MASK
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|pci_set_dma_mask
c_func
(paren
id|ha-&gt;pdev
comma
id|DMA_32BIT_MASK
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|qla2x00_iospace_config
id|qla2x00_iospace_config
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
r_int
id|pio
comma
id|pio_len
comma
id|pio_flags
suffix:semicolon
r_int
r_int
id|mmio
comma
id|mmio_len
comma
id|mmio_flags
suffix:semicolon
multiline_comment|/* We only need PIO for Flash operations on ISP2312 v2 chips. */
id|pio
op_assign
id|pci_resource_start
c_func
(paren
id|ha-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
id|pio_len
op_assign
id|pci_resource_len
c_func
(paren
id|ha-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
id|pio_flags
op_assign
id|pci_resource_flags
c_func
(paren
id|ha-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pio_flags
op_amp
id|IORESOURCE_IO
)paren
(brace
r_if
c_cond
(paren
id|pio_len
OL
id|MIN_IOBASE_LEN
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Invalid PCI I/O region size (%s)...&bslash;n&quot;
comma
id|ha-&gt;pdev-&gt;slot_name
)paren
suffix:semicolon
id|pio
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;region #0 not a PIO resource (%s)...&bslash;n&quot;
comma
id|ha-&gt;pdev-&gt;slot_name
)paren
suffix:semicolon
id|pio
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Use MMIO operations for all accesses. */
id|mmio
op_assign
id|pci_resource_start
c_func
(paren
id|ha-&gt;pdev
comma
l_int|1
)paren
suffix:semicolon
id|mmio_len
op_assign
id|pci_resource_len
c_func
(paren
id|ha-&gt;pdev
comma
l_int|1
)paren
suffix:semicolon
id|mmio_flags
op_assign
id|pci_resource_flags
c_func
(paren
id|ha-&gt;pdev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mmio_flags
op_amp
id|IORESOURCE_MEM
)paren
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_ERR
comma
id|ha
comma
l_string|&quot;region #0 not an MMIO resource (%s), aborting&bslash;n&quot;
comma
id|ha-&gt;pdev-&gt;slot_name
)paren
suffix:semicolon
r_goto
id|iospace_error_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mmio_len
OL
id|MIN_IOBASE_LEN
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_ERR
comma
id|ha
comma
l_string|&quot;Invalid PCI mem region size (%s), aborting&bslash;n&quot;
comma
id|ha-&gt;pdev-&gt;slot_name
)paren
suffix:semicolon
r_goto
id|iospace_error_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_request_regions
c_func
(paren
id|ha-&gt;pdev
comma
id|ha-&gt;brd_info-&gt;drv_name
)paren
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Failed to reserve PIO/MMIO regions (%s)&bslash;n&quot;
comma
id|ha-&gt;pdev-&gt;slot_name
)paren
suffix:semicolon
r_goto
id|iospace_error_exit
suffix:semicolon
)brace
id|ha-&gt;pio_address
op_assign
id|pio
suffix:semicolon
id|ha-&gt;pio_length
op_assign
id|pio_len
suffix:semicolon
id|ha-&gt;iobase
op_assign
id|ioremap
c_func
(paren
id|mmio
comma
id|MIN_IOBASE_LEN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;iobase
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_ERR
comma
id|ha
comma
l_string|&quot;cannot remap MMIO (%s), aborting&bslash;n&quot;
comma
id|ha-&gt;pdev-&gt;slot_name
)paren
suffix:semicolon
r_goto
id|iospace_error_exit
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|iospace_error_exit
suffix:colon
r_return
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * PCI driver interface&n; */
DECL|function|qla2x00_probe_one
r_int
id|qla2x00_probe_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_struct
id|qla_board_info
op_star
id|brd_info
)paren
(brace
r_int
id|ret
suffix:semicolon
id|device_reg_t
id|__iomem
op_star
id|reg
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|wait_switch
op_assign
l_int|0
suffix:semicolon
r_char
id|pci_info
(braket
l_int|20
)braket
suffix:semicolon
r_char
id|fw_str
(braket
l_int|30
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|host
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|qla2x00_driver_template
comma
r_sizeof
(paren
id|scsi_qla_host_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla2xxx: Couldn&squot;t allocate host from scsi layer!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|probe_disable_device
suffix:semicolon
)brace
multiline_comment|/* Clear our data area */
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|memset
c_func
(paren
id|ha
comma
l_int|0
comma
r_sizeof
(paren
id|scsi_qla_host_t
)paren
)paren
suffix:semicolon
id|ha-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|ha-&gt;host
op_assign
id|host
suffix:semicolon
id|ha-&gt;host_no
op_assign
id|host-&gt;host_no
suffix:semicolon
id|ha-&gt;brd_info
op_assign
id|brd_info
suffix:semicolon
id|sprintf
c_func
(paren
id|ha-&gt;host_str
comma
l_string|&quot;%s_%ld&quot;
comma
id|ha-&gt;brd_info-&gt;drv_name
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
multiline_comment|/* Configure PCI I/O space */
id|ret
op_assign
id|qla2x00_iospace_config
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
r_goto
id|probe_failed
suffix:semicolon
)brace
multiline_comment|/* Sanitize the information from PCI BIOS. */
id|host-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Found an %s, irq %d, iobase 0x%p&bslash;n&quot;
comma
id|ha-&gt;brd_info-&gt;isp_name
comma
id|host-&gt;irq
comma
id|ha-&gt;iobase
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
)paren
suffix:semicolon
multiline_comment|/* 4.23 Initialize /proc/scsi/qla2x00 counters */
id|ha-&gt;actthreads
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;qthreads
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;total_isr_cnt
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;total_isp_aborts
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;total_lip_cnt
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;total_dev_errs
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;total_ios
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;total_bytes
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;prev_topology
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;ports
op_assign
id|MAX_BUSES
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
)paren
(brace
id|ha-&gt;max_targets
op_assign
id|MAX_TARGETS_2100
suffix:semicolon
id|ha-&gt;mbx_count
op_assign
id|MAILBOX_REGISTER_COUNT_2100
suffix:semicolon
id|ha-&gt;request_q_length
op_assign
id|REQUEST_ENTRY_CNT_2100
suffix:semicolon
id|ha-&gt;response_q_length
op_assign
id|RESPONSE_ENTRY_CNT_2100
suffix:semicolon
id|ha-&gt;last_loop_id
op_assign
id|SNS_LAST_LOOP_ID_2100
suffix:semicolon
id|host-&gt;sg_tablesize
op_assign
l_int|32
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
id|ha-&gt;max_targets
op_assign
id|MAX_TARGETS_2200
suffix:semicolon
id|ha-&gt;mbx_count
op_assign
id|MAILBOX_REGISTER_COUNT
suffix:semicolon
id|ha-&gt;request_q_length
op_assign
id|REQUEST_ENTRY_CNT_2200
suffix:semicolon
id|ha-&gt;response_q_length
op_assign
id|RESPONSE_ENTRY_CNT_2100
suffix:semicolon
id|ha-&gt;last_loop_id
op_assign
id|SNS_LAST_LOOP_ID_2100
suffix:semicolon
)brace
r_else
multiline_comment|/*if (IS_QLA2300(ha))*/
(brace
id|ha-&gt;max_targets
op_assign
id|MAX_TARGETS_2200
suffix:semicolon
id|ha-&gt;mbx_count
op_assign
id|MAILBOX_REGISTER_COUNT
suffix:semicolon
id|ha-&gt;request_q_length
op_assign
id|REQUEST_ENTRY_CNT_2200
suffix:semicolon
id|ha-&gt;response_q_length
op_assign
id|RESPONSE_ENTRY_CNT_2300
suffix:semicolon
id|ha-&gt;last_loop_id
op_assign
id|SNS_LAST_LOOP_ID_2300
suffix:semicolon
)brace
id|host-&gt;can_queue
op_assign
id|ha-&gt;request_q_length
op_plus
l_int|128
suffix:semicolon
multiline_comment|/* load the F/W, read paramaters, and init the H/W */
id|ha-&gt;instance
op_assign
id|num_hosts
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|ha-&gt;mbx_cmd_sem
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|ha-&gt;mbx_intr_sem
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ha-&gt;list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ha-&gt;fcports
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ha-&gt;rscn_fcports
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ha-&gt;done_queue
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ha-&gt;retry_queue
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ha-&gt;scsi_retry_queue
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ha-&gt;pending_queue
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * These locks are used to prevent more than one CPU&n;&t; * from modifying the queue at the same time. The&n;&t; * higher level &quot;host_lock&quot; will reduce most&n;&t; * contention for these locks.&n;&t; */
id|spin_lock_init
c_func
(paren
op_amp
id|ha-&gt;mbx_reg_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ha-&gt;list_lock
)paren
suffix:semicolon
id|ha-&gt;dpc_pid
op_assign
op_minus
l_int|1
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|ha-&gt;dpc_inited
)paren
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|ha-&gt;dpc_exited
)paren
suffix:semicolon
id|qla2x00_config_dma_addressing
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla2x00_mem_alloc
c_func
(paren
id|ha
)paren
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;[ERROR] Failed to allocate memory for adapter&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|probe_failed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qla2x00_initialize_adapter
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
(paren
id|ha-&gt;device_flags
op_amp
id|DFLG_NO_CABLE
)paren
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Failed to initialize adapter&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Failed to initialize adapter - &quot;
l_string|&quot;Adapter flags %x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|ha-&gt;device_flags
)paren
)paren
suffix:semicolon
r_goto
id|probe_failed
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Startup the kernel thread for this host adapter&n;&t; */
id|ha-&gt;dpc_should_die
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;dpc_pid
op_assign
id|kernel_thread
c_func
(paren
id|qla2x00_do_dpc
comma
id|ha
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;dpc_pid
OL
l_int|0
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Unable to start DPC thread!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|probe_failed
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|ha-&gt;dpc_inited
)paren
suffix:semicolon
id|host-&gt;this_id
op_assign
l_int|255
suffix:semicolon
id|host-&gt;cmd_per_lun
op_assign
l_int|3
suffix:semicolon
id|host-&gt;max_cmd_len
op_assign
id|MAX_CMDSZ
suffix:semicolon
id|host-&gt;max_channel
op_assign
id|ha-&gt;ports
op_minus
l_int|1
suffix:semicolon
id|host-&gt;max_lun
op_assign
id|ha-&gt;max_luns
suffix:semicolon
id|BUG_ON
c_func
(paren
id|qla2xxx_transport_template
op_eq
l_int|NULL
)paren
suffix:semicolon
id|host-&gt;transportt
op_assign
id|qla2xxx_transport_template
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|ha-&gt;instance
suffix:semicolon
id|host-&gt;max_id
op_assign
id|ha-&gt;max_targets
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
id|ret
op_assign
id|request_irq
c_func
(paren
id|host-&gt;irq
comma
id|qla2100_intr_handler
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
id|ha-&gt;brd_info-&gt;drv_name
comma
id|ha
)paren
suffix:semicolon
r_else
id|ret
op_assign
id|request_irq
c_func
(paren
id|host-&gt;irq
comma
id|qla2300_intr_handler
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
id|ha-&gt;brd_info-&gt;drv_name
comma
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Failed to reserve interrupt %d already in use.&bslash;n&quot;
comma
id|host-&gt;irq
)paren
suffix:semicolon
r_goto
id|probe_failed
suffix:semicolon
)brace
multiline_comment|/* Initialized the timer */
id|qla2x00_start_timer
c_func
(paren
id|ha
comma
id|qla2x00_timer
comma
id|WATCH_INTERVAL
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DEBUG: detect hba %ld at address = %p&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|ha
)paren
)paren
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* Disable ISP interrupts. */
id|qla2x00_disable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Ensure mailbox registers are free. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
comma
l_int|0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_CLR_RISC_INT
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_CLR_HOST_INT
)paren
suffix:semicolon
multiline_comment|/* Enable proper parity */
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
r_if
c_cond
(paren
id|IS_QLA2300
c_func
(paren
id|ha
)paren
)paren
multiline_comment|/* SRAM parity */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
(paren
id|HCCR_ENABLE_PARITY
op_plus
l_int|0x1
)paren
)paren
suffix:semicolon
r_else
multiline_comment|/* SRAM, Instruction RAM and GP RAM parity */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
(paren
id|HCCR_ENABLE_PARITY
op_plus
l_int|0x7
)paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Enable chip interrupts. */
id|qla2x00_enable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* v2.19.5b6 */
multiline_comment|/*&n;&t; * Wait around max loop_reset_delay secs for the devices to come&n;&t; * on-line. We don&squot;t want Linux scanning before we are ready.&n;&t; *&n;&t; */
r_for
c_loop
(paren
id|wait_switch
op_assign
id|jiffies
op_plus
(paren
id|ha-&gt;loop_reset_delay
op_star
id|HZ
)paren
suffix:semicolon
id|time_before
c_func
(paren
id|jiffies
comma
id|wait_switch
)paren
op_logical_and
op_logical_neg
(paren
id|ha-&gt;device_flags
op_amp
(paren
id|DFLG_NO_CABLE
op_or
id|DFLG_FABRIC_DEVICES
)paren
)paren
op_logical_and
(paren
id|ha-&gt;device_flags
op_amp
id|SWITCH_FOUND
)paren
suffix:semicolon
)paren
(brace
id|qla2x00_check_fabric_devices
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|ha
)paren
suffix:semicolon
id|ha-&gt;flags.init_done
op_assign
l_int|1
suffix:semicolon
id|num_hosts
op_increment
suffix:semicolon
multiline_comment|/* List the target we have found */
r_if
c_cond
(paren
id|displayConfig
)paren
(brace
id|qla2x00_display_fc_names
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_add_host
c_func
(paren
id|host
comma
op_amp
id|pdev-&gt;dev
)paren
)paren
r_goto
id|probe_failed
suffix:semicolon
id|sysfs_create_bin_file
c_func
(paren
op_amp
id|host-&gt;shost_gendev.kobj
comma
op_amp
id|sysfs_fw_dump_attr
)paren
suffix:semicolon
id|sysfs_create_bin_file
c_func
(paren
op_amp
id|host-&gt;shost_gendev.kobj
comma
op_amp
id|sysfs_nvram_attr
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;&bslash;n&quot;
l_string|&quot; QLogic Fibre Channel HBA Driver: %s&bslash;n&quot;
l_string|&quot;  QLogic %s - %s&bslash;n&quot;
l_string|&quot;  %s: %s @ %s hdma%c, host#=%ld, fw=%s&bslash;n&quot;
comma
id|qla2x00_version_str
comma
id|ha-&gt;model_number
comma
id|ha-&gt;model_desc
ques
c_cond
id|ha-&gt;model_desc
suffix:colon
l_string|&quot;&quot;
comma
id|ha-&gt;brd_info-&gt;isp_name
comma
id|qla2x00_get_pci_info_str
c_func
(paren
id|ha
comma
id|pci_info
)paren
comma
id|pci_name
c_func
(paren
id|ha-&gt;pdev
)paren
comma
id|ha-&gt;flags.enable_64bit_addressing
ques
c_cond
l_char|&squot;+&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|ha-&gt;host_no
comma
id|qla2x00_get_fw_version_str
c_func
(paren
id|ha
comma
id|fw_str
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ql2xdoinitscan
)paren
id|scsi_scan_host
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|probe_failed
suffix:colon
id|qla2x00_free_device
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|host
)paren
suffix:semicolon
id|probe_disable_device
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|variable|qla2x00_probe_one
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|qla2x00_probe_one
)paren
suffix:semicolon
DECL|function|qla2x00_remove_one
r_void
id|qla2x00_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|ha
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|sysfs_remove_bin_file
c_func
(paren
op_amp
id|ha-&gt;host-&gt;shost_gendev.kobj
comma
op_amp
id|sysfs_fw_dump_attr
)paren
suffix:semicolon
id|sysfs_remove_bin_file
c_func
(paren
op_amp
id|ha-&gt;host-&gt;shost_gendev.kobj
comma
op_amp
id|sysfs_nvram_attr
)paren
suffix:semicolon
id|scsi_remove_host
c_func
(paren
id|ha-&gt;host
)paren
suffix:semicolon
id|qla2x00_free_device
c_func
(paren
id|ha
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|ha-&gt;host
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|qla2x00_remove_one
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|qla2x00_remove_one
)paren
suffix:semicolon
r_static
r_void
DECL|function|qla2x00_free_device
id|qla2x00_free_device
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/* Abort any outstanding IO descriptors. */
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
id|qla2x00_cancel_io_descriptors
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* turn-off interrupts on the card */
r_if
c_cond
(paren
id|ha-&gt;interrupts_on
)paren
id|qla2x00_disable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Disable timer */
r_if
c_cond
(paren
id|ha-&gt;timer_active
)paren
id|qla2x00_stop_timer
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Kill the kernel thread for this host */
r_if
c_cond
(paren
id|ha-&gt;dpc_pid
op_ge
l_int|0
)paren
(brace
id|ha-&gt;dpc_should_die
op_assign
l_int|1
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|kill_proc
c_func
(paren
id|ha-&gt;dpc_pid
comma
id|SIGHUP
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_ERR
comma
id|ha
comma
l_string|&quot;Unable to signal DPC thread -- (%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
multiline_comment|/* TODO: SOMETHING MORE??? */
)brace
r_else
(brace
id|wait_for_completion
c_func
(paren
op_amp
id|ha-&gt;dpc_exited
)paren
suffix:semicolon
)brace
)brace
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ha-&gt;flags.online
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Detach interrupts */
r_if
c_cond
(paren
id|ha-&gt;pdev-&gt;irq
)paren
id|free_irq
c_func
(paren
id|ha-&gt;pdev-&gt;irq
comma
id|ha
)paren
suffix:semicolon
multiline_comment|/* release io space registers  */
r_if
c_cond
(paren
id|ha-&gt;iobase
)paren
id|iounmap
c_func
(paren
id|ha-&gt;iobase
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|ha-&gt;pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|ha-&gt;pdev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The following support functions are adopted to handle&n; * the re-entrant qla2x00_proc_info correctly.&n; */
r_static
r_void
DECL|function|copy_mem_info
id|copy_mem_info
c_func
(paren
r_struct
id|info_str
op_star
id|info
comma
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;pos
op_plus
id|len
OG
id|info-&gt;offset
op_plus
id|info-&gt;length
)paren
id|len
op_assign
id|info-&gt;offset
op_plus
id|info-&gt;length
op_minus
id|info-&gt;pos
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;pos
op_plus
id|len
OL
id|info-&gt;offset
)paren
(brace
id|info-&gt;pos
op_add_assign
id|len
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;pos
OL
id|info-&gt;offset
)paren
(brace
id|off_t
id|partial
suffix:semicolon
id|partial
op_assign
id|info-&gt;offset
op_minus
id|info-&gt;pos
suffix:semicolon
id|data
op_add_assign
id|partial
suffix:semicolon
id|info-&gt;pos
op_add_assign
id|partial
suffix:semicolon
id|len
op_sub_assign
id|partial
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|info-&gt;buffer
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|info-&gt;pos
op_add_assign
id|len
suffix:semicolon
id|info-&gt;buffer
op_add_assign
id|len
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|copy_info
id|copy_info
c_func
(paren
r_struct
id|info_str
op_star
id|info
comma
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
r_char
id|buf
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|len
op_assign
id|vsprintf
c_func
(paren
id|buf
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
id|copy_mem_info
c_func
(paren
id|info
comma
id|buf
comma
id|len
)paren
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*************************************************************************&n;* qla2x00_proc_info&n;*&n;* Description:&n;*   Return information to handle /proc support for the driver.&n;*&n;* inout : decides the direction of the dataflow and the meaning of the&n;*         variables&n;* buffer: If inout==0 data is being written to it else read from it&n;*         (ptr to a page buffer)&n;* *start: If inout==0 start of the valid data in the buffer&n;* offset: If inout==0 starting offset from the beginning of all&n;*         possible data to return.&n;* length: If inout==0 max number of bytes to be written into the buffer&n;*         else number of bytes in &quot;buffer&quot;&n;* Returns:&n;*         &lt; 0:  error. errno value.&n;*         &gt;= 0: sizeof data returned.&n;*************************************************************************/
r_int
DECL|function|qla2x00_proc_info
id|qla2x00_proc_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shost
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|inout
)paren
(brace
r_struct
id|info_str
id|info
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|os_lun_t
op_star
id|up
suffix:semicolon
id|os_tgt_t
op_star
id|tq
suffix:semicolon
r_int
r_int
id|t
comma
id|l
suffix:semicolon
r_uint32
id|tmp_sn
suffix:semicolon
r_uint32
op_star
id|flags
suffix:semicolon
r_uint8
op_star
id|loop_state
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
r_char
id|fw_info
(braket
l_int|30
)braket
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Entering proc_info buff_in=%p, offset=0x%lx, length=0x%x&bslash;n&quot;
comma
id|buffer
comma
id|offset
comma
id|length
)paren
suffix:semicolon
)paren
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|inout
)paren
(brace
multiline_comment|/* Has data been written to the file? */
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s: has data been written to the file. &bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
)paren
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|start
)paren
(brace
op_star
id|start
op_assign
id|buffer
suffix:semicolon
)brace
id|info.buffer
op_assign
id|buffer
suffix:semicolon
id|info.length
op_assign
id|length
suffix:semicolon
id|info.offset
op_assign
id|offset
suffix:semicolon
id|info.pos
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* start building the print buffer */
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;QLogic PCI to Fibre Channel Host Adapter for %s:&bslash;n&quot;
l_string|&quot;        Firmware version %s, &quot;
comma
id|ha-&gt;model_number
comma
id|qla2x00_get_fw_version_str
c_func
(paren
id|ha
comma
id|fw_info
)paren
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Driver version %s&bslash;n&quot;
comma
id|qla2x00_version_str
)paren
suffix:semicolon
id|tmp_sn
op_assign
(paren
(paren
id|ha-&gt;serial0
op_amp
l_int|0x1f
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|ha-&gt;serial2
op_lshift
l_int|8
)paren
op_or
id|ha-&gt;serial1
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;ISP: %s, Serial# %c%05d&bslash;n&quot;
comma
id|ha-&gt;brd_info-&gt;isp_name
comma
(paren
l_char|&squot;A&squot;
op_plus
id|tmp_sn
op_div
l_int|100000
)paren
comma
(paren
id|tmp_sn
op_mod
l_int|100000
)paren
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Request Queue = 0x%llx, Response Queue = 0x%llx&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|ha-&gt;request_dma
comma
(paren
r_int
r_int
r_int
)paren
id|ha-&gt;response_dma
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Request Queue count = %d, Response Queue count = %d&bslash;n&quot;
comma
id|ha-&gt;request_q_length
comma
id|ha-&gt;response_q_length
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Total number of active commands = %ld&bslash;n&quot;
comma
id|ha-&gt;actthreads
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Total number of interrupts = %ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;total_isr_cnt
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;    Device queue depth = 0x%x&bslash;n&quot;
comma
(paren
id|ql2xmaxqdepth
op_eq
l_int|0
)paren
ques
c_cond
l_int|16
suffix:colon
id|ql2xmaxqdepth
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Number of free request entries = %d&bslash;n&quot;
comma
id|ha-&gt;req_q_cnt
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Number of mailbox timeouts = %ld&bslash;n&quot;
comma
id|ha-&gt;total_mbx_timeout
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Number of ISP aborts = %ld&bslash;n&quot;
comma
id|ha-&gt;total_isp_aborts
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Number of loop resyncs = %ld&bslash;n&quot;
comma
id|ha-&gt;total_loop_resync
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Number of retries for empty slots = %ld&bslash;n&quot;
comma
id|qla2x00_stats.outarray_full
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Number of reqs in pending_q= %ld, retry_q= %d, &quot;
l_string|&quot;done_q= %ld, scsi_retry_q= %d&bslash;n&quot;
comma
id|ha-&gt;qthreads
comma
id|ha-&gt;retry_q_cnt
comma
id|ha-&gt;done_q_cnt
comma
id|ha-&gt;scsi_retry_q_cnt
)paren
suffix:semicolon
id|flags
op_assign
(paren
r_uint32
op_star
)paren
op_amp
id|ha-&gt;flags
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_eq
id|LOOP_DOWN
)paren
(brace
id|loop_state
op_assign
l_string|&quot;DOWN&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_eq
id|LOOP_UP
)paren
(brace
id|loop_state
op_assign
l_string|&quot;UP&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_eq
id|LOOP_READY
)paren
(brace
id|loop_state
op_assign
l_string|&quot;READY&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_eq
id|LOOP_TIMEOUT
)paren
(brace
id|loop_state
op_assign
l_string|&quot;TIMEOUT&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_eq
id|LOOP_UPDATE
)paren
(brace
id|loop_state
op_assign
l_string|&quot;UPDATE&quot;
suffix:semicolon
)brace
r_else
(brace
id|loop_state
op_assign
l_string|&quot;UNKNOWN&quot;
suffix:semicolon
)brace
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Host adapter:loop state = &lt;%s&gt;, flags = 0x%lx&bslash;n&quot;
comma
id|loop_state
comma
op_star
id|flags
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Dpc flags = 0x%lx&bslash;n&quot;
comma
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;MBX flags = 0x%x&bslash;n&quot;
comma
id|ha-&gt;mbx_flags
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Link down Timeout = %3.3d&bslash;n&quot;
comma
id|ha-&gt;link_down_timeout
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Port down retry = %3.3d&bslash;n&quot;
comma
id|ha-&gt;port_down_retry_count
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Login retry count = %3.3d&bslash;n&quot;
comma
id|ha-&gt;login_retry_count
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Commands retried with dropped frame(s) = %d&bslash;n&quot;
comma
id|ha-&gt;dropped_frame_error_cnt
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;Product ID = %04x %04x %04x %04x&bslash;n&quot;
comma
id|ha-&gt;product_id
(braket
l_int|0
)braket
comma
id|ha-&gt;product_id
(braket
l_int|1
)braket
comma
id|ha-&gt;product_id
(braket
l_int|2
)braket
comma
id|ha-&gt;product_id
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* 2.25 node/port display to proc */
multiline_comment|/* Display the node name for adapter */
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;nSCSI Device Information:&bslash;n&quot;
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;scsi-qla%d-adapter-node=&quot;
l_string|&quot;%02x%02x%02x%02x%02x%02x%02x%02x;&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|0
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|1
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|2
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|3
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|4
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|5
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|6
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|7
)braket
)paren
suffix:semicolon
multiline_comment|/* display the port name for adapter */
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;scsi-qla%d-adapter-port=&quot;
l_string|&quot;%02x%02x%02x%02x%02x%02x%02x%02x;&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|0
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|1
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|2
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|3
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|4
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|5
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|6
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|7
)braket
)paren
suffix:semicolon
multiline_comment|/* Print out device port names */
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_FIBRE_DEVICES
suffix:semicolon
id|t
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tq
op_assign
id|TGT_Q
c_func
(paren
id|ha
comma
id|t
)paren
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;scsi-qla%d-target-%d=&quot;
l_string|&quot;%02x%02x%02x%02x%02x%02x%02x%02x;&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
comma
id|t
comma
id|tq-&gt;port_name
(braket
l_int|0
)braket
comma
id|tq-&gt;port_name
(braket
l_int|1
)braket
comma
id|tq-&gt;port_name
(braket
l_int|2
)braket
comma
id|tq-&gt;port_name
(braket
l_int|3
)braket
comma
id|tq-&gt;port_name
(braket
l_int|4
)braket
comma
id|tq-&gt;port_name
(braket
l_int|5
)braket
comma
id|tq-&gt;port_name
(braket
l_int|6
)braket
comma
id|tq-&gt;port_name
(braket
l_int|7
)braket
)paren
suffix:semicolon
)brace
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;nSCSI LUN Information:&bslash;n&quot;
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;(Id:Lun)  * - indicates lun is not registered with the OS.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* scan for all equipment stats */
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_FIBRE_DEVICES
suffix:semicolon
id|t
op_increment
)paren
(brace
multiline_comment|/* scan all luns */
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|ha-&gt;max_luns
suffix:semicolon
id|l
op_increment
)paren
(brace
id|up
op_assign
(paren
id|os_lun_t
op_star
)paren
id|GET_LU_Q
c_func
(paren
id|ha
comma
id|t
comma
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
id|up
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|up-&gt;fclun
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;(%2d:%2d): Total reqs %ld,&quot;
comma
id|t
comma
id|l
comma
id|up-&gt;io_cnt
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot; Pending reqs %ld,&quot;
comma
id|up-&gt;out_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|up-&gt;io_cnt
OL
l_int|4
)paren
(brace
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot; flags 0x%x*,&quot;
comma
(paren
r_int
)paren
id|up-&gt;q_flag
)paren
suffix:semicolon
)brace
r_else
(brace
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot; flags 0x%x,&quot;
comma
(paren
r_int
)paren
id|up-&gt;q_flag
)paren
suffix:semicolon
)brace
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot; %ld:%d:%02x %02x&quot;
comma
id|up-&gt;fclun-&gt;fcport-&gt;ha-&gt;instance
comma
id|up-&gt;fclun-&gt;fcport-&gt;cur_path
comma
id|up-&gt;fclun-&gt;fcport-&gt;loop_id
comma
id|up-&gt;fclun-&gt;device_type
)paren
suffix:semicolon
id|copy_info
c_func
(paren
op_amp
id|info
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info.pos
op_ge
id|info.offset
op_plus
id|info.length
)paren
(brace
multiline_comment|/* No need to continue */
r_goto
id|profile_stop
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|info.pos
op_ge
id|info.offset
op_plus
id|info.length
)paren
(brace
multiline_comment|/* No need to continue */
r_break
suffix:semicolon
)brace
)brace
id|profile_stop
suffix:colon
id|retval
op_assign
id|info.pos
OG
id|info.offset
ques
c_cond
id|info.pos
op_minus
id|info.offset
suffix:colon
l_int|0
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Exiting proc_info: info.pos=%d, offset=0x%lx, &quot;
l_string|&quot;length=0x%x&bslash;n&quot;
comma
id|info.pos
comma
id|offset
comma
id|length
)paren
suffix:semicolon
)paren
r_return
(paren
id|retval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;* qla2x00_display_fc_names&n;*      This routine will the node names of the different devices found&n;*      after port inquiry.&n;*&n;* Input:&n;*      cmd = SCSI command structure&n;*&n;* Returns:&n;*      None.&n;*/
r_static
r_void
DECL|function|qla2x00_display_fc_names
id|qla2x00_display_fc_names
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint16
id|tgt
suffix:semicolon
id|os_tgt_t
op_star
id|tq
suffix:semicolon
multiline_comment|/* Display the node name for adapter */
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi-qla%d-adapter-node=%02x%02x%02x%02x%02x%02x%02x%02x&bslash;&bslash;;&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|0
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|1
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|2
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|3
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|4
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|5
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|6
)braket
comma
id|ha-&gt;init_cb-&gt;node_name
(braket
l_int|7
)braket
)paren
suffix:semicolon
multiline_comment|/* display the port name for adapter */
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi-qla%d-adapter-port=%02x%02x%02x%02x%02x%02x%02x%02x&bslash;&bslash;;&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|0
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|1
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|2
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|3
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|4
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|5
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|6
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|7
)braket
)paren
suffix:semicolon
multiline_comment|/* Print out device port names */
r_for
c_loop
(paren
id|tgt
op_assign
l_int|0
suffix:semicolon
id|tgt
OL
id|MAX_TARGETS
suffix:semicolon
id|tgt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tq
op_assign
id|ha-&gt;otgt
(braket
id|tgt
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|tq-&gt;fcport
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|ha-&gt;binding_type
)paren
(brace
r_case
id|BIND_BY_PORT_NAME
suffix:colon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi-qla%d-tgt-%d-di-0-port=&quot;
l_string|&quot;%02x%02x%02x%02x%02x%02x%02x%02x&bslash;&bslash;;&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
comma
id|tgt
comma
id|tq-&gt;port_name
(braket
l_int|0
)braket
comma
id|tq-&gt;port_name
(braket
l_int|1
)braket
comma
id|tq-&gt;port_name
(braket
l_int|2
)braket
comma
id|tq-&gt;port_name
(braket
l_int|3
)braket
comma
id|tq-&gt;port_name
(braket
l_int|4
)braket
comma
id|tq-&gt;port_name
(braket
l_int|5
)braket
comma
id|tq-&gt;port_name
(braket
l_int|6
)braket
comma
id|tq-&gt;port_name
(braket
l_int|7
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BIND_BY_PORT_ID
suffix:colon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi-qla%d-tgt-%d-di-0-pid=&quot;
l_string|&quot;%02x%02x%02x&bslash;&bslash;;&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
comma
id|tgt
comma
id|tq-&gt;d_id.b.domain
comma
id|tq-&gt;d_id.b.area
comma
id|tq-&gt;d_id.b.al_pa
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if VSA
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi-qla%d-target-%d-vsa=01;&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
comma
id|tgt
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/*&n; *  qla2x00_suspend_lun&n; *&t;Suspend lun and start port down timer&n; *&n; * Input:&n; *&t;ha = visable adapter block pointer.&n; *  lq = lun queue&n; *  cp = Scsi command pointer &n; *  time = time in seconds&n; *  count = number of times to let time expire&n; *  delay_lun = non-zero, if lun should be delayed rather than suspended&n; *&n; * Return:&n; *     QLA_SUCCESS  -- suspended lun &n; *     QLA_FUNCTION_FAILED  -- Didn&squot;t suspend lun&n; *&n; * Context:&n; *&t;Interrupt context.&n; */
r_int
DECL|function|__qla2x00_suspend_lun
id|__qla2x00_suspend_lun
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|os_lun_t
op_star
id|lq
comma
r_int
id|time
comma
r_int
id|count
comma
r_int
id|delay_lun
)paren
(brace
r_int
id|rval
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_struct
id|list_head
op_star
id|list
comma
op_star
id|temp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
multiline_comment|/* if the lun_q is already suspended then don&squot;t do it again */
r_if
c_cond
(paren
id|lq-&gt;q_state
op_eq
id|LUN_STATE_READY
op_logical_or
id|lq-&gt;q_state
op_eq
id|LUN_STATE_RUN
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lq-&gt;q_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lq-&gt;q_state
op_eq
id|LUN_STATE_READY
)paren
(brace
id|lq-&gt;q_max
op_assign
id|count
suffix:semicolon
id|lq-&gt;q_count
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set the suspend time usually 6 secs */
id|atomic_set
c_func
(paren
op_amp
id|lq-&gt;q_timer
comma
id|time
)paren
suffix:semicolon
multiline_comment|/* now suspend the lun */
id|lq-&gt;q_state
op_assign
id|LUN_STATE_WAIT
suffix:semicolon
r_if
c_cond
(paren
id|delay_lun
)paren
(brace
id|set_bit
c_func
(paren
id|LUN_EXEC_DELAYED
comma
op_amp
id|lq-&gt;q_flag
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): Delay lun execution for %d secs, &quot;
l_string|&quot;count=%d, max count=%d, state=%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|time
comma
id|lq-&gt;q_count
comma
id|lq-&gt;q_max
comma
id|lq-&gt;q_state
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): Suspend lun for %d secs, count=%d, &quot;
l_string|&quot;max count=%d, state=%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|time
comma
id|lq-&gt;q_count
comma
id|lq-&gt;q_max
comma
id|lq-&gt;q_state
)paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lq-&gt;q_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Remove all pending commands from request queue and  put them&n;&t;&t; * in the scsi_retry queue.&n;&t;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|list
comma
id|temp
comma
op_amp
id|ha-&gt;pending_queue
)paren
(brace
id|sp
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|srb_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;lun_queue
op_ne
id|lq
)paren
r_continue
suffix:semicolon
id|__del_from_pending_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;cmd-&gt;allowed
OL
id|count
)paren
id|sp-&gt;cmd-&gt;allowed
op_assign
id|count
suffix:semicolon
id|__add_to_scsi_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
multiline_comment|/* list_for_each_safe */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
)brace
r_else
(brace
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_mark_device_lost Updates fcport state when device goes offline.&n; *&n; * Input: ha = adapter block pointer.  fcport = port structure pointer.&n; *&n; * Return: None.&n; *&n; * Context:&n; */
DECL|function|qla2x00_mark_device_lost
r_void
id|qla2x00_mark_device_lost
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
comma
r_int
id|do_login
)paren
(brace
multiline_comment|/* &n;&t; * We may need to retry the login, so don&squot;t change the state of the&n;&t; * port but do the retries.&n;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_ne
id|FCS_DEVICE_DEAD
)paren
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_DEVICE_LOST
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|do_login
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|fcport-&gt;login_retry
op_eq
l_int|0
)paren
(brace
id|fcport-&gt;login_retry
op_assign
id|ha-&gt;login_retry_count
suffix:semicolon
id|set_bit
c_func
(paren
id|RELOGIN_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Port login retry: &quot;
l_string|&quot;%02x%02x%02x%02x%02x%02x%02x%02x, &quot;
l_string|&quot;id = 0x%04x retry cnt=%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;port_name
(braket
l_int|0
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|1
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|2
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|3
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|4
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|5
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|6
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|7
)braket
comma
id|fcport-&gt;loop_id
comma
id|fcport-&gt;login_retry
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * qla2x00_mark_all_devices_lost&n; *&t;Updates fcport state when device goes offline.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;fcport = port structure pointer.&n; *&n; * Return:&n; *&t;None.&n; *&n; * Context:&n; */
r_void
DECL|function|qla2x00_mark_all_devices_lost
id|qla2x00_mark_all_devices_lost
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|fcport-&gt;port_type
op_ne
id|FCT_TARGET
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t; * No point in marking the device as lost, if the device is&n;&t;&t; * already DEAD.&n;&t;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_DEVICE_DEAD
)paren
r_continue
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_DEVICE_LOST
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;* qla2x00_mem_alloc&n;*      Allocates adapter memory.&n;*&n;* Returns:&n;*      0  = success.&n;*      1  = failure.&n;*/
r_static
r_uint8
DECL|function|qla2x00_mem_alloc
id|qla2x00_mem_alloc
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_char
id|name
(braket
l_int|16
)braket
suffix:semicolon
r_uint8
id|status
op_assign
l_int|1
suffix:semicolon
r_int
id|retry
op_assign
l_int|10
suffix:semicolon
r_do
(brace
multiline_comment|/*&n;&t;&t; * This will loop only once if everything goes well, else some&n;&t;&t; * number of retries will be performed to get around a kernel&n;&t;&t; * bug where available mem is not allocated until after a&n;&t;&t; * little delay and a retry.&n;&t;&t; */
id|ha-&gt;request_ring
op_assign
id|dma_alloc_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
(paren
id|ha-&gt;request_q_length
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
id|request_t
)paren
comma
op_amp
id|ha-&gt;request_dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;request_ring
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - request_ring&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;response_ring
op_assign
id|dma_alloc_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
(paren
id|ha-&gt;response_q_length
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
id|response_t
)paren
comma
op_amp
id|ha-&gt;response_dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;response_ring
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - response_ring&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;gid_list
op_assign
id|dma_alloc_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
id|GID_LIST_SIZE
comma
op_amp
id|ha-&gt;gid_list_dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;gid_list
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - gid_list&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ha-&gt;rlc_rsp
op_assign
id|dma_alloc_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
r_sizeof
(paren
id|rpt_lun_cmd_rsp_t
)paren
comma
op_amp
id|ha-&gt;rlc_rsp_dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;rlc_rsp
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - rlc&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|snprintf
c_func
(paren
id|name
comma
r_sizeof
(paren
id|name
)paren
comma
l_string|&quot;qla2xxx_%ld&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|ha-&gt;s_dma_pool
op_assign
id|dma_pool_create
c_func
(paren
id|name
comma
op_amp
id|ha-&gt;pdev-&gt;dev
comma
id|DMA_POOL_SIZE
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;s_dma_pool
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - s_dma_pool&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* get consistent memory allocated for init control block */
id|ha-&gt;init_cb
op_assign
id|dma_pool_alloc
c_func
(paren
id|ha-&gt;s_dma_pool
comma
id|GFP_KERNEL
comma
op_amp
id|ha-&gt;init_cb_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;init_cb
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - init_cb&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ha-&gt;init_cb
comma
l_int|0
comma
r_sizeof
(paren
id|init_cb_t
)paren
)paren
suffix:semicolon
multiline_comment|/* Get consistent memory allocated for Get Port Database cmd */
id|ha-&gt;iodesc_pd
op_assign
id|dma_pool_alloc
c_func
(paren
id|ha-&gt;s_dma_pool
comma
id|GFP_KERNEL
comma
op_amp
id|ha-&gt;iodesc_pd_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;iodesc_pd
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* error */
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - iodesc_pd&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ha-&gt;iodesc_pd
comma
l_int|0
comma
id|PORT_DATABASE_SIZE
)paren
suffix:semicolon
multiline_comment|/* Allocate ioctl related memory. */
r_if
c_cond
(paren
id|qla2x00_alloc_ioctl_mem
c_func
(paren
id|ha
)paren
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - ioctl_mem&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qla2x00_allocate_sp_pool
c_func
(paren
id|ha
)paren
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - &quot;
l_string|&quot;qla2x00_allocate_sp_pool()&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Allocate memory for SNS commands */
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* Get consistent memory allocated for SNS commands */
id|ha-&gt;sns_cmd
op_assign
id|dma_alloc_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
r_sizeof
(paren
r_struct
id|sns_cmd_pkt
)paren
comma
op_amp
id|ha-&gt;sns_cmd_dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;sns_cmd
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* error */
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - sns_cmd&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ha-&gt;sns_cmd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sns_cmd_pkt
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Get consistent memory allocated for MS IOCB */
id|ha-&gt;ms_iocb
op_assign
id|dma_pool_alloc
c_func
(paren
id|ha-&gt;s_dma_pool
comma
id|GFP_KERNEL
comma
op_amp
id|ha-&gt;ms_iocb_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;ms_iocb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* error */
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - ms_iocb&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ha-&gt;ms_iocb
comma
l_int|0
comma
r_sizeof
(paren
id|ms_iocb_entry_t
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Get consistent memory allocated for CT SNS&n;&t;&t;&t; * commands&n;&t;&t;&t; */
id|ha-&gt;ct_sns
op_assign
id|dma_alloc_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
r_sizeof
(paren
r_struct
id|ct_sns_pkt
)paren
comma
op_amp
id|ha-&gt;ct_sns_dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;ct_sns
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* error */
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - ct_sns&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ha-&gt;ct_sns
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ct_sns_pkt
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Done all allocations without any error. */
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|retry
op_decrement
op_logical_and
id|status
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s(): **** FAILED ****&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n;* qla2x00_mem_free&n;*      Frees all adapter allocated memory.&n;*&n;* Input:&n;*      ha = adapter block pointer.&n;*/
r_static
r_void
DECL|function|qla2x00_mem_free
id|qla2x00_mem_free
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint32
id|t
suffix:semicolon
r_struct
id|list_head
op_star
id|fcpl
comma
op_star
id|fcptemp
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
r_struct
id|list_head
op_star
id|fcll
comma
op_star
id|fcltemp
suffix:semicolon
id|fc_lun_t
op_star
id|fclun
suffix:semicolon
r_int
r_int
id|wtime
suffix:semicolon
multiline_comment|/* max wait time if mbx cmd is busy. */
r_if
c_cond
(paren
id|ha
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* error */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): ERROR invalid ha pointer.&bslash;n&quot;
comma
id|__func__
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Free the target queues */
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_TARGETS
suffix:semicolon
id|t
op_increment
)paren
(brace
id|qla2x00_tgt_free
c_func
(paren
id|ha
comma
id|t
)paren
suffix:semicolon
)brace
multiline_comment|/* Make sure all other threads are stopped. */
id|wtime
op_assign
l_int|60
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|ha-&gt;dpc_wait
op_logical_and
id|wtime
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|wtime
op_assign
id|schedule_timeout
c_func
(paren
id|wtime
)paren
suffix:semicolon
)brace
multiline_comment|/* free ioctl memory */
id|qla2x00_free_ioctl_mem
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* free sp pool */
id|qla2x00_free_sp_pool
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;sns_cmd
)paren
id|dma_free_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
r_sizeof
(paren
r_struct
id|sns_cmd_pkt
)paren
comma
id|ha-&gt;sns_cmd
comma
id|ha-&gt;sns_cmd_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;ct_sns
)paren
id|dma_free_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
r_sizeof
(paren
r_struct
id|ct_sns_pkt
)paren
comma
id|ha-&gt;ct_sns
comma
id|ha-&gt;ct_sns_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;ms_iocb
)paren
id|dma_pool_free
c_func
(paren
id|ha-&gt;s_dma_pool
comma
id|ha-&gt;ms_iocb
comma
id|ha-&gt;ms_iocb_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;iodesc_pd
)paren
id|dma_pool_free
c_func
(paren
id|ha-&gt;s_dma_pool
comma
id|ha-&gt;iodesc_pd
comma
id|ha-&gt;iodesc_pd_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;init_cb
)paren
id|dma_pool_free
c_func
(paren
id|ha-&gt;s_dma_pool
comma
id|ha-&gt;init_cb
comma
id|ha-&gt;init_cb_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;s_dma_pool
)paren
id|dma_pool_destroy
c_func
(paren
id|ha-&gt;s_dma_pool
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;rlc_rsp
)paren
id|dma_free_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
r_sizeof
(paren
id|rpt_lun_cmd_rsp_t
)paren
comma
id|ha-&gt;rlc_rsp
comma
id|ha-&gt;rlc_rsp_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;gid_list
)paren
id|dma_free_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
id|GID_LIST_SIZE
comma
id|ha-&gt;gid_list
comma
id|ha-&gt;gid_list_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;response_ring
)paren
id|dma_free_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
(paren
id|ha-&gt;response_q_length
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
id|response_t
)paren
comma
id|ha-&gt;response_ring
comma
id|ha-&gt;response_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;request_ring
)paren
id|dma_free_coherent
c_func
(paren
op_amp
id|ha-&gt;pdev-&gt;dev
comma
(paren
id|ha-&gt;request_q_length
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
id|request_t
)paren
comma
id|ha-&gt;request_ring
comma
id|ha-&gt;request_dma
)paren
suffix:semicolon
id|ha-&gt;sns_cmd
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;sns_cmd_dma
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;ct_sns
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;ct_sns_dma
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;ms_iocb
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;ms_iocb_dma
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;iodesc_pd
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;iodesc_pd_dma
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;init_cb
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;init_cb_dma
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;s_dma_pool
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;rlc_rsp
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;rlc_rsp_dma
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;gid_list
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;gid_list_dma
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;response_ring
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;response_dma
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;request_dma
op_assign
l_int|0
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|fcpl
comma
id|fcptemp
comma
op_amp
id|ha-&gt;fcports
)paren
(brace
id|fcport
op_assign
id|list_entry
c_func
(paren
id|fcpl
comma
id|fc_port_t
comma
id|list
)paren
suffix:semicolon
multiline_comment|/* fc luns */
id|list_for_each_safe
c_func
(paren
id|fcll
comma
id|fcltemp
comma
op_amp
id|fcport-&gt;fcluns
)paren
(brace
id|fclun
op_assign
id|list_entry
c_func
(paren
id|fcll
comma
id|fc_lun_t
comma
id|list
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|fclun-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fclun
)paren
suffix:semicolon
)brace
multiline_comment|/* fc ports */
id|list_del_init
c_func
(paren
op_amp
id|fcport-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fcport
)paren
suffix:semicolon
)brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ha-&gt;fcports
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;fw_dump
)paren
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ha-&gt;fw_dump
comma
id|ha-&gt;fw_dump_order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;fw_dump_buffer
)paren
id|vfree
c_func
(paren
id|ha-&gt;fw_dump_buffer
)paren
suffix:semicolon
id|ha-&gt;fw_dump
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;fw_dump_reading
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;fw_dump_buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_allocate_sp_pool&n; * &t; This routine is called during initialization to allocate&n; *  &t; memory for local srb_t.&n; *&n; * Input:&n; *&t; ha   = adapter block pointer.&n; *&n; * Context:&n; *      Kernel context.&n; * &n; * Note: Sets the ref_count for non Null sp to one.&n; */
r_static
r_int
DECL|function|qla2x00_allocate_sp_pool
id|qla2x00_allocate_sp_pool
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
id|ha-&gt;srb_mempool
op_assign
id|mempool_create
c_func
(paren
id|SRB_MIN_REQ
comma
id|mempool_alloc_slab
comma
id|mempool_free_slab
comma
id|srb_cachep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;srb_mempool
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Unable to allocate SRB mempool.&bslash;n&quot;
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  This routine frees all adapter allocated memory.&n; *  &n; */
r_static
r_void
DECL|function|qla2x00_free_sp_pool
id|qla2x00_free_sp_pool
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;srb_mempool
)paren
(brace
id|mempool_destroy
c_func
(paren
id|ha-&gt;srb_mempool
)paren
suffix:semicolon
id|ha-&gt;srb_mempool
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/**************************************************************************&n;* qla2x00_do_dpc&n;*   This kernel thread is a task that is schedule by the interrupt handler&n;*   to perform the background processing for interrupts.&n;*&n;* Notes:&n;* This task always run in the context of a kernel thread.  It&n;* is kick-off by the driver&squot;s detect code and starts up&n;* up one per adapter. It immediately goes to sleep and waits for&n;* some fibre event.  When either the interrupt handler or&n;* the timer routine detects a event it will one of the task&n;* bits then wake us up.&n;**************************************************************************/
r_static
r_int
DECL|function|qla2x00_do_dpc
id|qla2x00_do_dpc
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|DECLARE_MUTEX_LOCKED
c_func
(paren
id|sem
)paren
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|os_lun_t
op_star
id|q
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_uint8
id|status
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|list_head
op_star
id|list
comma
op_star
id|templist
suffix:semicolon
r_int
id|dead_cnt
comma
id|online_cnt
suffix:semicolon
r_int
id|retry_cmds
op_assign
l_int|0
suffix:semicolon
r_uint16
id|next_loopid
suffix:semicolon
r_int
id|t
suffix:semicolon
id|os_tgt_t
op_star
id|tq
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|data
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;%s_dpc&quot;
comma
id|ha-&gt;host_str
)paren
suffix:semicolon
id|allow_signal
c_func
(paren
id|SIGHUP
)paren
suffix:semicolon
id|ha-&gt;dpc_wait
op_assign
op_amp
id|sem
suffix:semicolon
id|set_user_nice
c_func
(paren
id|current
comma
op_minus
l_int|20
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|ha-&gt;dpc_inited
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00: DPC handler sleeping&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|sem
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;dpc_should_die
)paren
r_break
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00: DPC handler waking up&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialization not yet finished. Don&squot;t do anything yet. */
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.init_done
op_logical_or
id|ha-&gt;dpc_active
)paren
r_continue
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): DPC handler&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|ha-&gt;dpc_active
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ha-&gt;done_queue
)paren
)paren
id|qla2x00_done
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Process commands in retry queue */
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|PORT_RESTART_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): DPC checking retry_q. &quot;
l_string|&quot;total=%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|ha-&gt;retry_q_cnt
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|dead_cnt
op_assign
id|online_cnt
op_assign
l_int|0
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|list
comma
id|templist
comma
op_amp
id|ha-&gt;retry_queue
)paren
(brace
id|sp
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|srb_t
comma
id|list
)paren
suffix:semicolon
id|q
op_assign
id|sp-&gt;lun_queue
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): pid=%ld sp=%p, &quot;
l_string|&quot;spflags=0x%x, q_flag= 0x%lx&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|sp-&gt;cmd-&gt;serial_number
comma
id|sp
comma
id|sp-&gt;flags
comma
id|q-&gt;q_flag
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|fcport
op_assign
id|q-&gt;fclun-&gt;fcport
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_DEVICE_DEAD
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;ha-&gt;loop_state
)paren
op_eq
id|LOOP_DEAD
)paren
(brace
id|__del_from_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;ha-&gt;loop_state
)paren
op_eq
id|LOOP_DOWN
)paren
id|sp-&gt;err_id
op_assign
id|SRB_ERR_LOOP
suffix:semicolon
r_else
id|sp-&gt;err_id
op_assign
id|SRB_ERR_PORT
suffix:semicolon
id|sp-&gt;cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|__add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|dead_cnt
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_ne
id|FCS_DEVICE_LOST
)paren
(brace
id|__del_from_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|sp-&gt;cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|__add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|online_cnt
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* list_for_each_safe() */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): done processing retry queue &quot;
l_string|&quot;- dead=%d, online=%d&bslash;n &quot;
comma
id|ha-&gt;host_no
comma
id|dead_cnt
comma
id|online_cnt
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Process commands in scsi retry queue */
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|SCSI_RESTART_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Any requests we want to delay for some period is put&n;&t;&t;&t; * in the scsi retry queue with a delay added. The&n;&t;&t;&t; * timer will schedule a &quot;scsi_restart_needed&quot; every &n;&t;&t;&t; * second as long as there are requests in the scsi&n;&t;&t;&t; * queue. &n;&t;&t;&t; */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): DPC checking scsi &quot;
l_string|&quot;retry_q.total=%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|ha-&gt;scsi_retry_q_cnt
)paren
)paren
suffix:semicolon
id|online_cnt
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|list
comma
id|templist
comma
op_amp
id|ha-&gt;scsi_retry_queue
)paren
(brace
id|sp
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|srb_t
comma
id|list
)paren
suffix:semicolon
id|q
op_assign
id|sp-&gt;lun_queue
suffix:semicolon
id|tq
op_assign
id|sp-&gt;tgt_queue
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): scsi_retry_q: &quot;
l_string|&quot;pid=%ld sp=%p, spflags=0x%x, &quot;
l_string|&quot;q_flag= 0x%lx,q_state=%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|sp-&gt;cmd-&gt;serial_number
comma
id|sp
comma
id|sp-&gt;flags
comma
id|q-&gt;q_flag
comma
id|q-&gt;q_state
)paren
)paren
suffix:semicolon
multiline_comment|/* Was this lun suspended */
r_if
c_cond
(paren
id|q-&gt;q_state
op_ne
id|LUN_STATE_WAIT
)paren
(brace
id|online_cnt
op_increment
suffix:semicolon
id|__del_from_scsi_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|TQF_RETRY_CMDS
comma
op_amp
id|tq-&gt;flags
)paren
)paren
(brace
id|qla2x00_extend_timeout
c_func
(paren
id|sp-&gt;cmd
comma
(paren
id|sp-&gt;cmd-&gt;timeout_per_command
op_div
id|HZ
)paren
op_minus
id|QLA_CMD_TIMER_DELTA
)paren
suffix:semicolon
id|__add_to_pending_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|retry_cmds
op_increment
suffix:semicolon
)brace
r_else
id|__add_to_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
multiline_comment|/* Was this command suspended for N secs */
r_if
c_cond
(paren
id|sp-&gt;delay
op_ne
l_int|0
)paren
(brace
id|sp-&gt;delay
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;delay
op_eq
l_int|0
)paren
(brace
id|online_cnt
op_increment
suffix:semicolon
id|__del_from_scsi_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|__add_to_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Clear all Target Unsuspended bits */
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|ha-&gt;max_targets
suffix:semicolon
id|t
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tq
op_assign
id|ha-&gt;otgt
(braket
id|t
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|TQF_RETRY_CMDS
comma
op_amp
id|tq-&gt;flags
)paren
)paren
id|clear_bit
c_func
(paren
id|TQF_RETRY_CMDS
comma
op_amp
id|tq-&gt;flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retry_cmds
)paren
id|qla2x00_next
c_func
(paren
id|ha
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
r_if
(paren
id|online_cnt
OG
l_int|0
)paren
)paren
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): dpc() found scsi reqs to &quot;
l_string|&quot;restart= %d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|online_cnt
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;flags.mbox_busy
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ha-&gt;done_queue
)paren
)paren
id|qla2x00_done
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ha-&gt;dpc_active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): dpc: sched &quot;
l_string|&quot;qla2x00_abort_isp ha = %p&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|ha
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|test_and_set_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|qla2x00_abort_isp
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* failed. retry later */
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): dpc: qla2x00_abort_isp end&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|RESET_MARKER_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|test_and_set_bit
c_func
(paren
id|RESET_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): qla2x00_reset_marker()&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla2x00_rst_aen
c_func
(paren
id|ha
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|RESET_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Retry each device up to login retry count */
r_if
c_cond
(paren
(paren
id|test_and_clear_bit
c_func
(paren
id|RELOGIN_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_ne
id|LOOP_DOWN
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): qla2x00_port_login()&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|next_loopid
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|fcport-&gt;port_type
op_ne
id|FCT_TARGET
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * If the port is not ONLINE then try to login&n;&t;&t;&t;&t; * to it if we haven&squot;t run out of retries.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_ne
id|FCS_ONLINE
op_logical_and
id|fcport-&gt;login_retry
)paren
(brace
id|fcport-&gt;login_retry
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|fcport-&gt;flags
op_amp
id|FCF_FABRIC_DEVICE
)paren
(brace
r_if
c_cond
(paren
id|fcport-&gt;flags
op_amp
id|FCF_TAPE_PRESENT
)paren
id|qla2x00_fabric_logout
c_func
(paren
id|ha
comma
id|fcport-&gt;loop_id
)paren
suffix:semicolon
id|status
op_assign
id|qla2x00_fabric_login
c_func
(paren
id|ha
comma
id|fcport
comma
op_amp
id|next_loopid
)paren
suffix:semicolon
)brace
r_else
id|status
op_assign
id|qla2x00_local_device_login
c_func
(paren
id|ha
comma
id|fcport-&gt;loop_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|QLA_SUCCESS
)paren
(brace
id|fcport-&gt;old_loop_id
op_assign
id|fcport-&gt;loop_id
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): port login OK: logged in ID 0x%x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;loop_id
)paren
)paren
suffix:semicolon
id|fcport-&gt;port_login_retry_count
op_assign
id|ha-&gt;port_down_retry_count
op_star
id|PORT_RETRY_TIME
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_ONLINE
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;port_down_timer
comma
id|ha-&gt;port_down_retry_count
op_star
id|PORT_RETRY_TIME
)paren
suffix:semicolon
id|fcport-&gt;login_retry
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_eq
l_int|1
)paren
(brace
id|set_bit
c_func
(paren
id|RELOGIN_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
multiline_comment|/* retry the login again */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Retrying %d login again loop_id 0x%x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;login_retry
comma
id|fcport-&gt;loop_id
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|fcport-&gt;login_retry
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
r_break
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): qla2x00_port_login - end&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|test_bit
c_func
(paren
id|LOGIN_RETRY_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_ne
id|LOOP_DOWN
)paren
(brace
id|clear_bit
c_func
(paren
id|LOGIN_RETRY_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): qla2x00_login_retry()&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): qla2x00_login_retry - end&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): qla2x00_loop_resync()&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|test_and_set_bit
c_func
(paren
id|LOOP_RESYNC_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
(brace
id|qla2x00_loop_resync
c_func
(paren
id|ha
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|LOOP_RESYNC_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): qla2x00_loop_resync - end&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|RESTART_QUEUES_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): qla2x00_restart_queues()&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla2x00_restart_queues
c_func
(paren
id|ha
comma
l_int|0
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): qla2x00_restart_queues - end&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|ABORT_QUEUES_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): qla2x00_abort_queues()&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla2x00_abort_queues
c_func
(paren
id|ha
comma
l_int|0
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): qla2x00_abort_queues - end&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FCPORT_RESCAN_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Rescan flagged fcports...&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla2x00_rescan_fcports
c_func
(paren
id|ha
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Rescan flagged fcports...&quot;
l_string|&quot;end.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;interrupts_on
)paren
id|qla2x00_enable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ha-&gt;done_queue
)paren
)paren
id|qla2x00_done
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ha-&gt;dpc_active
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* End of while(1) */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): DPC handler exiting&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure that nobody tries to wake us up again.&n;&t; */
id|ha-&gt;dpc_wait
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;dpc_active
op_assign
l_int|0
suffix:semicolon
id|complete_and_exit
c_func
(paren
op_amp
id|ha-&gt;dpc_exited
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla2x00_abort_queues&n; *&t;Abort all commands on queues on device&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&n; * Context:&n; *&t;Interrupt context.&n; */
r_void
DECL|function|qla2x00_abort_queues
id|qla2x00_abort_queues
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
id|doneqflg
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
r_struct
id|list_head
op_star
id|list
comma
op_star
id|temp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|clear_bit
c_func
(paren
id|ABORT_QUEUES_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
multiline_comment|/* Return all commands device queues. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|list
comma
id|temp
comma
op_amp
id|ha-&gt;pending_queue
)paren
(brace
id|sp
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|srb_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_ABORTED
)paren
r_continue
suffix:semicolon
multiline_comment|/* Remove srb from LUN queue. */
id|__del_from_pending_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
multiline_comment|/* Set ending status. */
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|__add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;*  qla2x00_rst_aen&n;*      Processes asynchronous reset.&n;*&n;* Input:&n;*      ha  = adapter block pointer.&n;*/
r_static
r_void
DECL|function|qla2x00_rst_aen
id|qla2x00_rst_aen
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;flags.online
op_logical_and
op_logical_neg
id|ha-&gt;flags.reset_active
op_logical_and
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_and
op_logical_neg
(paren
id|test_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
(brace
r_do
(brace
id|clear_bit
c_func
(paren
id|RESET_MARKER_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Issue marker command only when we are going to start&n;&t;&t;&t; * the I/O.&n;&t;&t;&t; */
id|ha-&gt;marker_needed
op_assign
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_and
(paren
id|test_bit
c_func
(paren
id|RESET_MARKER_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * This routine will allocate SP from the free queue&n; * input:&n; *        scsi_qla_host_t *&n; * output:&n; *        srb_t * or NULL&n; */
r_static
id|srb_t
op_star
DECL|function|qla2x00_get_new_sp
id|qla2x00_get_new_sp
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
id|sp
op_assign
id|mempool_alloc
c_func
(paren
id|ha-&gt;srb_mempool
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
id|atomic_set
c_func
(paren
op_amp
id|sp-&gt;ref_count
comma
l_int|1
)paren
suffix:semicolon
r_return
(paren
id|sp
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;*   qla2x00_timer&n;*&n;* Description:&n;*   One second timer&n;*&n;* Context: Interrupt&n;***************************************************************************/
r_static
r_void
DECL|function|qla2x00_timer
id|qla2x00_timer
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|t
comma
id|l
suffix:semicolon
r_int
r_int
id|cpu_flags
op_assign
l_int|0
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|os_lun_t
op_star
id|lq
suffix:semicolon
id|os_tgt_t
op_star
id|tq
suffix:semicolon
r_int
id|start_dpc
op_assign
l_int|0
suffix:semicolon
r_int
id|index
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
multiline_comment|/*&n;&t; * We try and restart any request in the retry queue every second.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ha-&gt;retry_queue
)paren
)paren
(brace
id|set_bit
c_func
(paren
id|PORT_RESTART_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|start_dpc
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We try and restart any request in the scsi_retry queue every second.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ha-&gt;scsi_retry_queue
)paren
)paren
(brace
id|set_bit
c_func
(paren
id|SCSI_RESTART_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|start_dpc
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Ports - Port down timer.&n;&t; *&n;&t; * Whenever, a port is in the LOST state we start decrementing its port&n;&t; * down timer every second until it reaches zero. Once  it reaches zero&n;&t; * the port it marked DEAD. &n;&t; */
id|t
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|fcport-&gt;port_type
op_ne
id|FCT_TARGET
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_DEVICE_LOST
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;port_down_timer
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|fcport-&gt;port_down_timer
)paren
op_ne
l_int|0
)paren
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_DEVICE_DEAD
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): fcport-%d - port retry count: &quot;
l_string|&quot;%d remainning&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|t
comma
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;port_down_timer
)paren
)paren
)paren
suffix:semicolon
)brace
id|t
op_increment
suffix:semicolon
)brace
multiline_comment|/* End of for fcport  */
multiline_comment|/*&n;&t; * LUNS - lun suspend timer.&n;&t; *&n;&t; * Whenever, a lun is suspended the timer starts decrementing its&n;&t; * suspend timer every second until it reaches zero. Once  it reaches&n;&t; * zero the lun retry count is decremented. &n;&t; */
multiline_comment|/*&n;&t; * FIXME(dg) - Need to convert this linear search of luns into a search&n;&t; * of a list of suspended luns.&n;&t; */
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|ha-&gt;max_targets
suffix:semicolon
id|t
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tq
op_assign
id|ha-&gt;otgt
(braket
id|t
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|ha-&gt;max_luns
suffix:semicolon
id|l
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|lq
op_assign
(paren
id|os_lun_t
op_star
)paren
id|tq-&gt;olun
(braket
id|l
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lq-&gt;q_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lq-&gt;q_state
op_eq
id|LUN_STATE_WAIT
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|lq-&gt;q_timer
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|lq-&gt;q_timer
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * A delay should immediately&n;&t;&t;&t;&t;&t; * transition to a READY state&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|LUN_EXEC_DELAYED
comma
op_amp
id|lq-&gt;q_flag
)paren
)paren
(brace
id|lq-&gt;q_state
op_assign
id|LUN_STATE_READY
suffix:semicolon
)brace
r_else
(brace
id|lq-&gt;q_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lq-&gt;q_count
op_eq
id|lq-&gt;q_max
)paren
id|lq-&gt;q_state
op_assign
id|LUN_STATE_TIMEOUT
suffix:semicolon
r_else
id|lq-&gt;q_state
op_assign
id|LUN_STATE_RUN
suffix:semicolon
)brace
)brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): lun%d - timer %d, &quot;
l_string|&quot;count=%d, max=%d, state=%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|l
comma
id|atomic_read
c_func
(paren
op_amp
id|lq-&gt;q_timer
)paren
comma
id|lq-&gt;q_count
comma
id|lq-&gt;q_max
comma
id|lq-&gt;q_state
)paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lq-&gt;q_lock
comma
id|cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/* End of for luns  */
)brace
multiline_comment|/* End of for targets  */
multiline_comment|/* Loop down handler. */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
OG
l_int|0
op_logical_and
op_logical_neg
(paren
id|test_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
op_logical_and
id|ha-&gt;flags.online
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_eq
id|ha-&gt;loop_down_abort_time
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Loop Down - aborting the &quot;
l_string|&quot;queues before time expire&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_and
id|ha-&gt;link_down_timeout
)paren
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_DEAD
)paren
suffix:semicolon
multiline_comment|/* Schedule an ISP abort to return any tape commands. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|1
suffix:semicolon
id|index
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|index
op_increment
)paren
(brace
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sp
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;fclun-&gt;fcport-&gt;flags
op_amp
id|FCF_TAPE_PRESENT
)paren
)paren
r_continue
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|cpu_flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ABORT_QUEUES_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|start_dpc
op_increment
suffix:semicolon
)brace
multiline_comment|/* if the loop has been down for 4 minutes, reinit adapter */
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_ne
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Loop down exceed 4 mins - &quot;
l_string|&quot;restarting queues.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|RESTART_QUEUES_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|start_dpc
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ha-&gt;device_flags
op_amp
id|DFLG_NO_CABLE
)paren
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Loop down - &quot;
l_string|&quot;aborting ISP.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Loop down - aborting ISP.&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
)brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Loop Down - seconds remainning %d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Done Q Handler -- dgFIXME This handler will kick off doneq if we&n;&t; * haven&squot;t process it in 2 seconds.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ha-&gt;done_queue
)paren
)paren
id|qla2x00_done
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Schedule the DPC routine if needed */
r_if
c_cond
(paren
(paren
id|test_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
op_logical_or
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
op_logical_or
id|start_dpc
op_logical_or
id|test_bit
c_func
(paren
id|LOGIN_RETRY_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
op_logical_or
id|test_bit
c_func
(paren
id|RELOGIN_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
op_logical_and
id|ha-&gt;dpc_wait
op_logical_and
op_logical_neg
id|ha-&gt;dpc_active
)paren
(brace
id|up
c_func
(paren
id|ha-&gt;dpc_wait
)paren
suffix:semicolon
)brace
id|qla2x00_restart_timer
c_func
(paren
id|ha
comma
id|WATCH_INTERVAL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_extend_timeout&n; *      This routine will extend the timeout to the specified value.&n; *&n; * Input:&n; *      cmd = SCSI command structure&n; *&n; * Returns:&n; *      None.&n; */
r_void
DECL|function|qla2x00_extend_timeout
id|qla2x00_extend_timeout
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_int
id|timeout
)paren
(brace
id|srb_t
op_star
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|u_long
id|our_jiffies
op_assign
(paren
id|timeout
op_star
id|HZ
)paren
op_plus
id|jiffies
suffix:semicolon
id|sp-&gt;ext_history
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;e_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;eh_timeout.function
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|cmd-&gt;eh_timeout
comma
id|our_jiffies
)paren
suffix:semicolon
id|sp-&gt;ext_history
op_or_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sp-&gt;timer.function
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* &n;&t;&t; * Our internal timer should timeout before the midlayer has a&n;&t;&t; * chance begin the abort process&n;&t;&t; */
id|mod_timer
c_func
(paren
op_amp
id|sp-&gt;timer
comma
id|our_jiffies
op_minus
(paren
id|QLA_CMD_TIMER_DELTA
op_star
id|HZ
)paren
)paren
suffix:semicolon
id|sp-&gt;ext_history
op_or_assign
l_int|2
suffix:semicolon
)brace
)brace
multiline_comment|/**************************************************************************&n;*   qla2x00_cmd_timeout&n;*&n;* Description:&n;*       Handles the command if it times out in any state.&n;*&n;* Input:&n;*     sp - pointer to validate&n;*&n;* Returns:&n;* None.&n;* Note:Need to add the support for if( sp-&gt;state == SRB_FAILOVER_STATE).&n;**************************************************************************/
r_void
DECL|function|qla2x00_cmd_timeout
id|qla2x00_cmd_timeout
c_func
(paren
id|srb_t
op_star
id|sp
)paren
(brace
r_int
id|t
comma
id|l
suffix:semicolon
r_int
id|processed
suffix:semicolon
id|scsi_qla_host_t
op_star
id|vis_ha
comma
op_star
id|dest_ha
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmd
suffix:semicolon
r_int
r_int
id|flags
comma
id|cpu_flags
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|vis_ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;cmd_timeout: Entering sp-&gt;state = %x&bslash;n&quot;
comma
id|sp-&gt;state
)paren
)paren
suffix:semicolon
id|t
op_assign
id|cmd-&gt;device-&gt;id
suffix:semicolon
id|l
op_assign
id|cmd-&gt;device-&gt;lun
suffix:semicolon
id|fcport
op_assign
id|sp-&gt;fclun-&gt;fcport
suffix:semicolon
id|dest_ha
op_assign
id|sp-&gt;ha
suffix:semicolon
multiline_comment|/*&n;&t; * If IO is found either in retry Queue &n;&t; *    OR in Lun Queue&n;&t; * Return this IO back to host&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|vis_ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|processed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;state
op_eq
id|SRB_PENDING_STATE
)paren
(brace
id|__del_from_pending_queue
c_func
(paren
id|vis_ha
comma
id|sp
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Found in Pending queue pid %ld, &quot;
l_string|&quot;State = %x., fcport state=%d sjiffs=%lx njiffs=%lx&bslash;n&quot;
comma
id|vis_ha-&gt;host_no
comma
id|cmd-&gt;serial_number
comma
id|sp-&gt;state
comma
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
comma
id|sp-&gt;r_start
comma
id|jiffies
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If FC_DEVICE is marked as dead return the cmd with&n;&t;&t; * DID_NO_CONNECT status.  Otherwise set the host_byte to&n;&t;&t; * DID_BUS_BUSY to let the OS  retry this cmd.&n;&t;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_DEVICE_DEAD
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;ha-&gt;loop_state
)paren
op_eq
id|LOOP_DEAD
)paren
(brace
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;ha-&gt;loop_state
)paren
op_eq
id|LOOP_DOWN
)paren
id|sp-&gt;err_id
op_assign
id|SRB_ERR_LOOP
suffix:semicolon
r_else
id|sp-&gt;err_id
op_assign
id|SRB_ERR_PORT
suffix:semicolon
)brace
r_else
(brace
id|cmd-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
)brace
id|__add_to_done_queue
c_func
(paren
id|vis_ha
comma
id|sp
)paren
suffix:semicolon
id|processed
op_increment
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|vis_ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|processed
)paren
(brace
id|qla2x00_done
c_func
(paren
id|vis_ha
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dest_ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sp-&gt;state
op_eq
id|SRB_RETRY_STATE
)paren
op_logical_or
(paren
id|sp-&gt;state
op_eq
id|SRB_SCSI_RETRY_STATE
)paren
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Found in (Scsi) Retry queue or &quot;
l_string|&quot;failover Q pid %ld, State = %x., fcport state=%d &quot;
l_string|&quot;jiffies=%lx retried=%d&bslash;n&quot;
comma
id|dest_ha-&gt;host_no
comma
id|cmd-&gt;serial_number
comma
id|sp-&gt;state
comma
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
comma
id|jiffies
comma
id|cmd-&gt;retries
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sp-&gt;state
op_eq
id|SRB_RETRY_STATE
)paren
)paren
(brace
id|__del_from_retry_queue
c_func
(paren
id|dest_ha
comma
id|sp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|sp-&gt;state
op_eq
id|SRB_SCSI_RETRY_STATE
)paren
)paren
(brace
id|__del_from_scsi_retry_queue
c_func
(paren
id|dest_ha
comma
id|sp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * If FC_DEVICE is marked as dead return the cmd with&n;&t;&t; * DID_NO_CONNECT status.  Otherwise set the host_byte to&n;&t;&t; * DID_BUS_BUSY to let the OS  retry this cmd.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_DEVICE_DEAD
)paren
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|dest_ha-&gt;loop_state
)paren
op_eq
id|LOOP_DEAD
)paren
(brace
id|qla2x00_extend_timeout
c_func
(paren
id|cmd
comma
id|EXTEND_CMD_TIMEOUT
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dest_ha-&gt;loop_state
)paren
op_eq
id|LOOP_DOWN
)paren
id|sp-&gt;err_id
op_assign
id|SRB_ERR_LOOP
suffix:semicolon
r_else
id|sp-&gt;err_id
op_assign
id|SRB_ERR_PORT
suffix:semicolon
)brace
r_else
(brace
id|cmd-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
)brace
id|__add_to_done_queue
c_func
(paren
id|dest_ha
comma
id|sp
)paren
suffix:semicolon
id|processed
op_increment
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dest_ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|processed
)paren
(brace
id|qla2x00_done
c_func
(paren
id|dest_ha
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dest_ha-&gt;list_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;state
op_eq
id|SRB_DONE_STATE
)paren
(brace
multiline_comment|/* IO in done_q  -- leave it */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Found in Done queue pid %ld sp=%p.&bslash;n&quot;
comma
id|dest_ha-&gt;host_no
comma
id|cmd-&gt;serial_number
comma
id|sp
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sp-&gt;state
op_eq
id|SRB_SUSPENDED_STATE
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Found SP %p in suspended state  &quot;
l_string|&quot;- pid %ld:&bslash;n&quot;
comma
id|dest_ha-&gt;host_no
comma
id|sp
comma
id|cmd-&gt;serial_number
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
id|sp
comma
r_sizeof
(paren
id|srb_t
)paren
)paren
suffix:semicolon
)paren
)brace
r_else
r_if
c_cond
(paren
id|sp-&gt;state
op_eq
id|SRB_ACTIVE_STATE
)paren
(brace
multiline_comment|/*&n;&t;&t; * IO is with ISP find the command in our active list.&n;&t;&t; */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dest_ha-&gt;list_lock
comma
id|cpu_flags
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dest_ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
id|dest_ha-&gt;outstanding_cmds
(braket
(paren
r_int
r_int
)paren
id|sp-&gt;cmd-&gt;host_scribble
)braket
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;cmd_timeout: Found in ISP &bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_TAPE
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * We cannot allow the midlayer error handler&n;&t;&t;&t;&t; * to wakeup and begin the abort process.&n;&t;&t;&t;&t; * Extend the timer so that the firmware can&n;&t;&t;&t;&t; * properly return the IOCB.&n;&t;&t;&t;&t; */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;cmd_timeout: Extending timeout &quot;
l_string|&quot;of FCP2 tape command!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|qla2x00_extend_timeout
c_func
(paren
id|sp-&gt;cmd
comma
id|EXTEND_CMD_TIMEOUT
)paren
suffix:semicolon
)brace
id|sp-&gt;state
op_assign
id|SRB_ACTIVE_TIMEOUT_STATE
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dest_ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dest_ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla_cmd_timeout: State indicates it is with &quot;
l_string|&quot;ISP, But not in active array&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dest_ha-&gt;list_lock
comma
id|cpu_flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sp-&gt;state
op_eq
id|SRB_ACTIVE_TIMEOUT_STATE
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2100%ld: Found in Active timeout state&quot;
l_string|&quot;pid %ld, State = %x., &bslash;n&quot;
comma
id|dest_ha-&gt;host_no
comma
id|sp-&gt;cmd-&gt;serial_number
comma
id|sp-&gt;state
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/* EMPTY */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;cmd_timeout%ld: LOST command state = &quot;
l_string|&quot;0x%x, sp=%p&bslash;n&quot;
comma
id|vis_ha-&gt;host_no
comma
id|sp-&gt;state
comma
id|sp
)paren
suffix:semicolon
)paren
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|vis_ha
comma
l_string|&quot;cmd_timeout: LOST command state = 0x%x&bslash;n&quot;
comma
id|sp-&gt;state
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dest_ha-&gt;list_lock
comma
id|cpu_flags
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;cmd_timeout: Leaving&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
multiline_comment|/**************************************************************************&n;* qla2x00_done&n;*      Process completed commands.&n;*&n;* Input:&n;*      old_ha           = adapter block pointer.&n;*&n;**************************************************************************/
r_void
DECL|function|qla2x00_done
id|qla2x00_done
c_func
(paren
id|scsi_qla_host_t
op_star
id|old_ha
)paren
(brace
id|os_lun_t
op_star
id|lq
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmd
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|scsi_qla_host_t
op_star
id|vis_ha
suffix:semicolon
r_int
id|send_marker_once
op_assign
l_int|0
suffix:semicolon
id|srb_t
op_star
id|sp
comma
op_star
id|sptemp
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|local_sp_list
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Get into local queue such that we do not wind up calling done queue&n;&t; * tasklet for the same IOs from DPC or any other place.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|old_ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_splice_init
c_func
(paren
op_amp
id|old_ha-&gt;done_queue
comma
op_amp
id|local_sp_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|old_ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * All done commands are in the local queue, now do the call back.&n;&t; */
id|list_for_each_entry_safe
c_func
(paren
id|sp
comma
id|sptemp
comma
op_amp
id|local_sp_list
comma
id|list
)paren
(brace
id|old_ha-&gt;done_q_cnt
op_decrement
suffix:semicolon
id|sp-&gt;state
op_assign
id|SRB_NO_QUEUE_STATE
suffix:semicolon
multiline_comment|/* remove command from local list */
id|list_del_init
c_func
(paren
op_amp
id|sp-&gt;list
)paren
suffix:semicolon
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|vis_ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|lq
op_assign
id|sp-&gt;lun_queue
suffix:semicolon
id|ha
op_assign
id|sp-&gt;ha
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_DMA_VALID
)paren
(brace
id|sp-&gt;flags
op_and_assign
op_complement
id|SRB_DMA_VALID
suffix:semicolon
multiline_comment|/* Release memory used for this I/O */
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|ha-&gt;pdev
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;use_sg
comma
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
)paren
(brace
id|pci_unmap_page
c_func
(paren
id|ha-&gt;pdev
comma
id|sp-&gt;dma_handle
comma
id|cmd-&gt;request_bufflen
comma
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|host_byte
c_func
(paren
id|cmd-&gt;result
)paren
)paren
(brace
r_case
id|DID_OK
suffix:colon
r_case
id|DID_ERROR
suffix:colon
r_break
suffix:semicolon
r_case
id|DID_RESET
suffix:colon
multiline_comment|/*&n;&t;&t;&t;&t; * Set marker needed, so we don&squot;t have to&n;&t;&t;&t;&t; * send multiple markers&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|send_marker_once
)paren
(brace
id|ha-&gt;marker_needed
op_assign
l_int|1
suffix:semicolon
id|send_marker_once
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t; * WORKAROUND&n;&t;&t;&t;&t; *&n;&t;&t;&t;&t; * A backdoor device-reset requires different&n;&t;&t;&t;&t; * error handling.  This code differentiates&n;&t;&t;&t;&t; * between normal error handling and the&n;&t;&t;&t;&t; * backdoor method.&n;&t;&t;&t;&t; *&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ha-&gt;host-&gt;eh_active
op_ne
id|EH_ACTIVE
)paren
id|cmd-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DID_ABORT
suffix:colon
id|sp-&gt;flags
op_and_assign
op_complement
id|SRB_ABORT_PENDING
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_ABORTED
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_TIMEOUT
)paren
id|cmd-&gt;result
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld:%d:%d) %s: did_error &quot;
l_string|&quot;= %d, comp-scsi= 0x%x-0x%x pid=%ld.&bslash;n&quot;
comma
id|vis_ha-&gt;host_no
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
comma
id|__func__
comma
id|host_byte
c_func
(paren
id|cmd-&gt;result
)paren
comma
id|CMD_COMPL_STATUS
c_func
(paren
id|cmd
)paren
comma
id|CMD_SCSI_STATUS
c_func
(paren
id|cmd
)paren
comma
id|cmd-&gt;serial_number
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Call the mid-level driver interrupt handler -- via sp_put()&n;&t;&t; */
id|sp_put
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
multiline_comment|/* end of while */
)brace
multiline_comment|/*&n; * qla2x00_process_response_queue_in_zio_mode&n; *&t;Process response queue completion as fast as possible&n; *&t;to achieve Zero Interrupt Opertions-ZIO&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_inline
r_void
DECL|function|qla2x00_process_response_queue_in_zio_mode
id|qla2x00_process_response_queue_in_zio_mode
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Check for unprocessed commands in response queue. */
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.process_response_queue
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.online
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;response_ring_ptr-&gt;signature
op_eq
id|RESPONSE_PROCESSED
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|qla2x00_process_response_queue
c_func
(paren
id|ha
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_next&n; *&t;Retrieve and process next job in the LUN queue.&n; *&n; * Input:&n; *&t;tq = SCSI target queue pointer.&n; *&t;lq = SCSI LUN queue pointer.&n; *&t;TGT_LOCK must be already obtained.&n; *&n; * Output:&n; *&t;Releases TGT_LOCK upon exit.&n; *&n; * Context:&n; *&t;Kernel/Interrupt context.&n; * &n; * Note: This routine will always try to start I/O from visible HBA.&n; */
r_void
DECL|function|qla2x00_next
id|qla2x00_next
c_func
(paren
id|scsi_qla_host_t
op_star
id|vis_ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|scsi_qla_host_t
op_star
id|dest_ha
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|srb_t
op_star
id|sp
comma
op_star
id|sptemp
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|local_sp_list
)paren
suffix:semicolon
id|dest_ha
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|vis_ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_splice_init
c_func
(paren
op_amp
id|vis_ha-&gt;pending_queue
comma
op_amp
id|local_sp_list
)paren
suffix:semicolon
id|vis_ha-&gt;qthreads
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|vis_ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|sp
comma
id|sptemp
comma
op_amp
id|local_sp_list
comma
id|list
)paren
(brace
id|list_del_init
c_func
(paren
op_amp
id|sp-&gt;list
)paren
suffix:semicolon
id|sp-&gt;state
op_assign
id|SRB_NO_QUEUE_STATE
suffix:semicolon
id|fcport
op_assign
id|sp-&gt;fclun-&gt;fcport
suffix:semicolon
id|dest_ha
op_assign
id|fcport-&gt;ha
suffix:semicolon
multiline_comment|/* If device is dead then send request back to OS */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_DEVICE_DEAD
)paren
(brace
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dest_ha-&gt;loop_state
)paren
op_eq
id|LOOP_DOWN
)paren
id|sp-&gt;err_id
op_assign
id|SRB_ERR_LOOP
suffix:semicolon
r_else
id|sp-&gt;err_id
op_assign
id|SRB_ERR_PORT
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): loop/port is down - pid=%ld, &quot;
l_string|&quot;sp=%p err_id=%d loopid=0x%x queued to dest HBA &quot;
l_string|&quot;scsi%ld.&bslash;n&quot;
comma
id|dest_ha-&gt;host_no
comma
id|sp-&gt;cmd-&gt;serial_number
comma
id|sp
comma
id|sp-&gt;err_id
comma
id|fcport-&gt;loop_id
comma
id|dest_ha-&gt;host_no
)paren
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * Initiate a failover - done routine will initiate.&n;&t;&t;&t; */
id|add_to_done_queue
c_func
(paren
id|vis_ha
comma
id|sp
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * SCSI Kluge: Whenever, we need to wait for an event such as&n;&t;&t; * loop down (i.e. loop_down_timer ) or port down (i.e.  LUN&n;&t;&t; * request qeueue is suspended) then we will recycle new&n;&t;&t; * commands back to the SCSI layer.  We do this because this is&n;&t;&t; * normally a temporary condition and we don&squot;t want the&n;&t;&t; * mid-level scsi.c driver to get upset and start aborting&n;&t;&t; * commands.  The timeout value is extracted from the command&n;&t;&t; * minus 1-second and put on a retry queue (watchdog). Once the&n;&t;&t; * command timeout it is returned to the mid-level with a BUSY&n;&t;&t; * status, so the mid-level will retry it. This process&n;&t;&t; * continues until the LOOP DOWN time expires or the condition&n;&t;&t; * goes away.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;flags
op_amp
(paren
id|SRB_IOCTL
op_or
id|SRB_TAPE
)paren
)paren
op_logical_and
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_ne
id|FCS_ONLINE
op_logical_or
id|test_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|dest_ha-&gt;dpc_flags
)paren
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|dest_ha-&gt;loop_state
)paren
op_ne
id|LOOP_READY
)paren
)paren
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): pid=%ld port=0x%x state=%d &quot;
l_string|&quot;loop state=%d, loop counter=0x%x &quot;
l_string|&quot;dpc_flags=0x%lx&bslash;n&quot;
comma
id|sp-&gt;cmd-&gt;serial_number
comma
id|dest_ha-&gt;host_no
comma
id|fcport-&gt;loop_id
comma
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dest_ha-&gt;loop_state
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dest_ha-&gt;loop_down_timer
)paren
comma
id|dest_ha-&gt;dpc_flags
)paren
)paren
suffix:semicolon
id|qla2x00_extend_timeout
c_func
(paren
id|sp-&gt;cmd
comma
id|EXTEND_CMD_TIMEOUT
)paren
suffix:semicolon
id|add_to_retry_queue
c_func
(paren
id|vis_ha
comma
id|sp
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * If this request&squot;s lun is suspended then put the request on&n;&t;&t; * the  scsi_retry queue. &n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;flags
op_amp
(paren
id|SRB_IOCTL
op_or
id|SRB_TAPE
)paren
)paren
op_logical_and
id|sp-&gt;lun_queue-&gt;q_state
op_eq
id|LUN_STATE_WAIT
)paren
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): lun wait state - pid=%ld, &quot;
l_string|&quot;opcode=%d, allowed=%d, retries=%d&bslash;n&quot;
comma
id|dest_ha-&gt;host_no
comma
id|sp-&gt;cmd-&gt;serial_number
comma
id|sp-&gt;cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|sp-&gt;cmd-&gt;allowed
comma
id|sp-&gt;cmd-&gt;retries
)paren
)paren
suffix:semicolon
id|add_to_scsi_retry_queue
c_func
(paren
id|vis_ha
comma
id|sp
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|sp-&gt;lun_queue-&gt;io_cnt
op_increment
suffix:semicolon
id|rval
op_assign
id|qla2x00_start_scsi
c_func
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* Place request back on top of device queue */
multiline_comment|/* add to the top of queue */
id|add_to_pending_queue_head
c_func
(paren
id|vis_ha
comma
id|sp
)paren
suffix:semicolon
id|sp-&gt;lun_queue-&gt;io_cnt
op_decrement
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|vis_ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA2200
c_func
(paren
id|vis_ha
)paren
)paren
(brace
multiline_comment|/* Process response_queue if ZIO support is enabled*/
id|qla2x00_process_response_queue_in_zio_mode
c_func
(paren
id|vis_ha
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* XXX(hch): crude hack to emulate a down_timeout() */
r_int
DECL|function|qla2x00_down_timeout
id|qla2x00_down_timeout
c_func
(paren
r_struct
id|semaphore
op_star
id|sema
comma
r_int
r_int
id|timeout
)paren
(brace
r_const
r_int
r_int
id|step
op_assign
id|HZ
op_div
l_int|10
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
id|down_trylock
c_func
(paren
id|sema
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|schedule_timeout
c_func
(paren
id|step
)paren
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|timeout
op_sub_assign
id|step
)paren
OG
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_static
r_void
DECL|function|qla2xxx_get_port_id
id|qla2xxx_get_port_id
c_func
(paren
r_struct
id|scsi_target
op_star
id|starget
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|dev_to_shost
c_func
(paren
id|starget-&gt;dev.parent
)paren
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
op_assign
id|to_qla_host
c_func
(paren
id|shost
)paren
suffix:semicolon
r_struct
id|fc_port
op_star
id|fc
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fc
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|fc-&gt;os_target_id
op_eq
id|starget-&gt;id
)paren
(brace
id|fc_starget_port_id
c_func
(paren
id|starget
)paren
op_assign
id|fc-&gt;d_id.b.domain
op_lshift
l_int|16
op_or
id|fc-&gt;d_id.b.area
op_lshift
l_int|8
op_or
id|fc-&gt;d_id.b.al_pa
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|fc_starget_port_id
c_func
(paren
id|starget
)paren
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|qla2xxx_get_port_name
id|qla2xxx_get_port_name
c_func
(paren
r_struct
id|scsi_target
op_star
id|starget
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|dev_to_shost
c_func
(paren
id|starget-&gt;dev.parent
)paren
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
op_assign
id|to_qla_host
c_func
(paren
id|shost
)paren
suffix:semicolon
r_struct
id|fc_port
op_star
id|fc
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fc
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|fc-&gt;os_target_id
op_eq
id|starget-&gt;id
)paren
(brace
id|fc_starget_port_name
c_func
(paren
id|starget
)paren
op_assign
id|__be64_to_cpu
c_func
(paren
op_star
(paren
r_uint64
op_star
)paren
id|fc-&gt;port_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|fc_starget_port_name
c_func
(paren
id|starget
)paren
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|qla2xxx_get_node_name
id|qla2xxx_get_node_name
c_func
(paren
r_struct
id|scsi_target
op_star
id|starget
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
op_assign
id|dev_to_shost
c_func
(paren
id|starget-&gt;dev.parent
)paren
suffix:semicolon
id|scsi_qla_host_t
op_star
id|ha
op_assign
id|to_qla_host
c_func
(paren
id|shost
)paren
suffix:semicolon
r_struct
id|fc_port
op_star
id|fc
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fc
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|fc-&gt;os_target_id
op_eq
id|starget-&gt;id
)paren
(brace
id|fc_starget_node_name
c_func
(paren
id|starget
)paren
op_assign
id|__be64_to_cpu
c_func
(paren
op_star
(paren
r_uint64
op_star
)paren
id|fc-&gt;node_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|fc_starget_node_name
c_func
(paren
id|starget
)paren
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
DECL|variable|qla2xxx_transport_functions
r_static
r_struct
id|fc_function_template
id|qla2xxx_transport_functions
op_assign
(brace
dot
id|get_starget_port_id
op_assign
id|qla2xxx_get_port_id
comma
dot
id|show_starget_port_id
op_assign
l_int|1
comma
dot
id|get_starget_port_name
op_assign
id|qla2xxx_get_port_name
comma
dot
id|show_starget_port_name
op_assign
l_int|1
comma
dot
id|get_starget_node_name
op_assign
id|qla2xxx_get_node_name
comma
dot
id|show_starget_node_name
op_assign
l_int|1
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * qla2x00_module_init - Module initialization.&n; **/
r_static
r_int
id|__init
DECL|function|qla2x00_module_init
id|qla2x00_module_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Allocate cache for SRBs. */
id|sprintf
c_func
(paren
id|srb_cachep_name
comma
l_string|&quot;qla2xxx_srbs&quot;
)paren
suffix:semicolon
id|srb_cachep
op_assign
id|kmem_cache_create
c_func
(paren
id|srb_cachep_name
comma
r_sizeof
(paren
id|srb_t
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb_cachep
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;qla2xxx: Unable to allocate SRB cache...Failing load!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Derive version string. */
id|strcpy
c_func
(paren
id|qla2x00_version_str
comma
id|QLA2XXX_VERSION
)paren
suffix:semicolon
macro_line|#if DEBUG_QLA2100
id|strcat
c_func
(paren
id|qla2x00_version_str
comma
l_string|&quot;-debug&quot;
)paren
suffix:semicolon
macro_line|#endif
id|qla2xxx_transport_template
op_assign
id|fc_attach_transport
c_func
(paren
op_amp
id|qla2xxx_transport_functions
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qla2xxx_transport_template
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;QLogic Fibre Channel HBA Driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_module_exit - Module cleanup.&n; **/
r_static
r_void
id|__exit
DECL|function|qla2x00_module_exit
id|qla2x00_module_exit
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Free SRBs cache. */
r_if
c_cond
(paren
id|srb_cachep
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|srb_cachep
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;qla2xxx: Unable to free SRB cache...Memory pools &quot;
l_string|&quot;still active?&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|srb_cachep
op_assign
l_int|NULL
suffix:semicolon
)brace
id|fc_release_transport
c_func
(paren
id|qla2xxx_transport_template
)paren
suffix:semicolon
)brace
DECL|variable|qla2x00_module_init
id|module_init
c_func
(paren
id|qla2x00_module_init
)paren
suffix:semicolon
DECL|variable|qla2x00_module_exit
id|module_exit
c_func
(paren
id|qla2x00_module_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;QLogic Corporation&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;QLogic Fibre Channel HBA Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|QLA2XXX_VERSION
id|MODULE_VERSION
c_func
(paren
id|QLA2XXX_VERSION
)paren
suffix:semicolon
eof
