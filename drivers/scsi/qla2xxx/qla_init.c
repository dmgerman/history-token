multiline_comment|/*&n; *                  QLOGIC LINUX SOFTWARE&n; *&n; * QLogic ISP2x00 device driver for Linux 2.6.x&n; * Copyright (C) 2003-2004 QLogic Corporation&n; * (www.qlogic.com)&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; */
macro_line|#include &quot;qla_os.h&quot;
macro_line|#include &quot;qla_def.h&quot;
macro_line|#include &quot;qla_devtbl.h&quot;
multiline_comment|/* XXX(hch): this is ugly, but we don&squot;t want to pull in exioctl.h */
macro_line|#ifndef EXT_IS_LUN_BIT_SET
DECL|macro|EXT_IS_LUN_BIT_SET
mdefine_line|#define EXT_IS_LUN_BIT_SET(P,L) &bslash;&n;    (((P)-&gt;mask[L/8] &amp; (0x80 &gt;&gt; (L%8)))?1:0)
DECL|macro|EXT_SET_LUN_BIT
mdefine_line|#define EXT_SET_LUN_BIT(P,L) &bslash;&n;    ((P)-&gt;mask[L/8] |= (0x80 &gt;&gt; (L%8)))
macro_line|#endif
multiline_comment|/*&n;*  QLogic ISP2x00 Hardware Support Function Prototypes.&n;*/
r_static
r_int
id|qla2x00_pci_config
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_isp_firmware
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_reset_chip
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_chip_diag
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_setup_chip
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_init_response_q_entries
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_init_rings
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_fw_ready
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_configure_hba
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_nvram_config
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_init_tgt_map
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_configure_loop
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_configure_local_loop
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_update_fcport
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|fc_port_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_lun_discovery
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|fc_port_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_rpt_lun_discovery
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|fc_port_t
op_star
comma
id|inq_cmd_rsp_t
op_star
comma
id|dma_addr_t
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_report_lun
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|fc_port_t
op_star
comma
id|rpt_lun_cmd_rsp_t
op_star
comma
id|dma_addr_t
)paren
suffix:semicolon
r_static
id|fc_lun_t
op_star
id|qla2x00_cfg_lun
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|fc_port_t
op_star
comma
r_uint16
comma
id|inq_cmd_rsp_t
op_star
comma
id|dma_addr_t
)paren
suffix:semicolon
r_static
id|fc_lun_t
op_star
id|qla2x00_add_lun
c_func
(paren
id|fc_port_t
op_star
comma
r_uint16
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_inquiry
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|fc_port_t
op_star
comma
r_uint16
comma
id|inq_cmd_rsp_t
op_star
comma
id|dma_addr_t
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_configure_fabric
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_find_all_fabric_devs
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_struct
id|list_head
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_device_resync
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_fabric_dev_login
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|fc_port_t
op_star
comma
r_uint16
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_config_os
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
suffix:semicolon
r_static
r_uint16
id|qla2x00_fcport_bind
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
)paren
suffix:semicolon
r_static
id|os_lun_t
op_star
id|qla2x00_fclun_bind
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|fc_port_t
op_star
comma
id|fc_lun_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_lun_free
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint16
comma
r_uint16
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_bstr_to_hex
c_func
(paren
r_char
op_star
comma
r_uint8
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_find_propname
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_char
op_star
comma
r_char
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_void
id|qla2x00_get_lun_mask_from_config
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|fc_port_t
op_star
comma
r_uint16
comma
r_uint16
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_get_prop_16chars
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_char
op_star
comma
r_char
op_star
comma
r_char
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_get_properties
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_char
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_cfg_persistent_binding
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
id|os_tgt_t
op_star
id|qla2x00_persistent_bind
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint8
op_star
comma
r_uint8
op_star
comma
id|port_id_t
op_star
comma
r_uint16
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|qla2x00_restart_isp
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_reset_adapter
c_func
(paren
id|scsi_qla_host_t
op_star
)paren
suffix:semicolon
multiline_comment|/****************************************************************************/
multiline_comment|/*                QLogic ISP2x00 Hardware Support Functions.                */
multiline_comment|/****************************************************************************/
multiline_comment|/*&n;* qla2x00_initialize_adapter&n;*      Initialize board.&n;*&n;* Input:&n;*      ha = adapter block pointer.&n;*&n;* Returns:&n;*      0 = success&n;*/
r_int
DECL|function|qla2x00_initialize_adapter
id|qla2x00_initialize_adapter
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint8
id|restart_risc
op_assign
l_int|0
suffix:semicolon
r_uint8
id|retry
suffix:semicolon
r_uint32
id|wait_time
suffix:semicolon
multiline_comment|/* Clear adapter flags. */
id|ha-&gt;flags.online
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.reset_active
op_assign
id|FALSE
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
comma
id|LOOP_DOWN_TIME
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_DOWN
)paren
suffix:semicolon
id|ha-&gt;device_flags
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;sns_retry_cnt
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;dpc_flags
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;failback_delay
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;flags.management_server_logged_in
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;marker_needed
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;mbx_flags
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;isp_abort_cnt
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;beacon_blink_led
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_pci_config
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Unable to configure PCI space=n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
id|qla2x00_reset_chip
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Initialize target map database. */
id|qla2x00_init_tgt_map
c_func
(paren
id|ha
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Configure NVRAM parameters...&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_nvram_config
c_func
(paren
id|ha
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Verifying loaded RISC code...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/*&n;&t; * If the user specified a device configuration on the command line&n;&t; * then use it as the configuration.  Otherwise, we scan for all&n;&t; * devices.&n;&t; */
r_if
c_cond
(paren
id|ql2xdevconf
)paren
(brace
id|ha-&gt;cmdline
op_assign
id|ql2xdevconf
suffix:semicolon
id|qla2x00_get_properties
c_func
(paren
id|ha
comma
id|ql2xdevconf
)paren
suffix:semicolon
)brace
macro_line|#endif
id|retry
op_assign
l_int|10
suffix:semicolon
multiline_comment|/*&n;&t; * Try to configure the loop.&n;&t; */
r_do
(brace
id|restart_risc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If firmware needs to be loaded */
r_if
c_cond
(paren
id|qla2x00_isp_firmware
c_func
(paren
id|ha
)paren
op_ne
id|QLA_SUCCESS
)paren
(brace
r_if
c_cond
(paren
(paren
id|rval
op_assign
id|qla2x00_chip_diag
c_func
(paren
id|ha
)paren
)paren
op_eq
id|QLA_SUCCESS
)paren
(brace
id|rval
op_assign
id|qla2x00_setup_chip
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
op_logical_and
(paren
id|rval
op_assign
id|qla2x00_init_rings
c_func
(paren
id|ha
)paren
)paren
op_eq
id|QLA_SUCCESS
)paren
(brace
id|check_fw_ready_again
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * Wait for a successful LIP up to a maximum &n;&t;&t;&t; * of (in seconds): RISC login timeout value,&n;&t;&t;&t; * RISC retry count value, and port down retry&n;&t;&t;&t; * value OR a minimum of 4 seconds OR If no &n;&t;&t;&t; * cable, only 5 seconds.&n;&t;&t;&t; */
id|rval
op_assign
id|qla2x00_fw_ready
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
(brace
id|clear_bit
c_func
(paren
id|RESET_MARKER_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Wait at most MAX_TARGET RSCNs for a stable&n;&t;&t;&t;&t; * link.&n;&t;&t;&t;&t; */
id|wait_time
op_assign
l_int|256
suffix:semicolon
r_do
(brace
id|clear_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_configure_loop
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
id|restart_risc
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * If loop state change while we were&n;&t;&t;&t;&t;&t; * discoverying devices then wait for&n;&t;&t;&t;&t;&t; * LIP to complete&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_eq
id|LOOP_DOWN
op_logical_and
id|retry
op_decrement
)paren
(brace
r_goto
id|check_fw_ready_again
suffix:semicolon
)brace
id|wait_time
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_and
id|retry
op_logical_and
id|wait_time
op_logical_and
(paren
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_time
op_eq
l_int|0
)paren
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;mem_err
)paren
id|restart_risc
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|restart_risc
op_logical_and
id|retry
op_decrement
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* Retrieve firmware information */
id|qla2x00_get_fw_version
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;fw_major_version
comma
op_amp
id|ha-&gt;fw_minor_version
comma
op_amp
id|ha-&gt;fw_subminor_version
comma
op_amp
id|ha-&gt;fw_attributes
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|RESET_MARKER_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|ha-&gt;marker_needed
op_assign
l_int|1
suffix:semicolon
id|qla2x00_marker
c_func
(paren
id|ha
comma
l_int|0
comma
l_int|0
comma
id|MK_SYNC_ALL
)paren
suffix:semicolon
id|ha-&gt;marker_needed
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;flags.online
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): **** FAILED ****&bslash;n&quot;
comma
id|__func__
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_pci_config() - Setup device PCI configuration registers.&n; * @ha: HA context&n; *&n; * Returns 0 on success.&n; */
r_static
r_int
DECL|function|qla2x00_pci_config
id|qla2x00_pci_config
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint16
id|w
comma
id|mwi
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_uint32
id|cnt
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Configuring PCI space...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Turn on PCI master; for system BIOSes that don&squot;t turn it on by&n;&t; * default.&n;&t; */
id|pci_set_master
c_func
(paren
id|ha-&gt;pdev
)paren
suffix:semicolon
id|mwi
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pci_set_mwi
c_func
(paren
id|ha-&gt;pdev
)paren
)paren
id|mwi
op_assign
id|PCI_COMMAND_INVALIDATE
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|PCI_REVISION_ID
comma
op_amp
id|ha-&gt;revision
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;iobase
)paren
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We want to respect framework&squot;s setting of PCI configuration space&n;&t; * command register and also want to make sure that all bits of&n;&t; * interest to us are properly set in command register.&n;&t; */
id|pci_read_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|PCI_COMMAND
comma
op_amp
id|w
)paren
suffix:semicolon
id|w
op_or_assign
id|mwi
op_or
(paren
id|PCI_COMMAND_PARITY
op_or
id|PCI_COMMAND_SERR
)paren
suffix:semicolon
multiline_comment|/* Get PCI bus information. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|ha-&gt;pci_attr
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;ctrl_status
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|ha-&gt;pdev
comma
id|PCI_LATENCY_TIMER
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* PCI Specification Revision 2.3 changes */
r_if
c_cond
(paren
id|IS_QLA2322
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA6322
c_func
(paren
id|ha
)paren
)paren
multiline_comment|/* Command Register - Reset Interrupt Disable. */
id|w
op_and_assign
op_complement
id|BIT_10
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If this is a 2300 card and not 2312, reset the&n;&t;&t; * COMMAND_INVALIDATE due to a bug in the 2300. Unfortunately,&n;&t;&t; * the 2310 also reports itself as a 2300 so we need to get the&n;&t;&t; * fb revision level -- a 6 indicates it really is a 2300 and&n;&t;&t; * not a 2310.&n;&t;&t; */
r_if
c_cond
(paren
id|IS_QLA2300
c_func
(paren
id|ha
)paren
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Pause RISC. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;hccr
comma
id|HCCR_PAUSE_RISC
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|30000
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;hccr
)paren
op_amp
id|HCCR_RISC_PAUSE
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* Select FPM registers. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;ctrl_status
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* Get the fb rev level */
id|ha-&gt;fb_rev
op_assign
id|RD_FB_CMD_REG
c_func
(paren
id|ha
comma
id|ha-&gt;iobase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;fb_rev
op_eq
id|FPM_2300
)paren
id|w
op_and_assign
op_complement
id|PCI_COMMAND_INVALIDATE
suffix:semicolon
multiline_comment|/* Deselect FPM registers. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;ctrl_status
comma
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* Release RISC module. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;hccr
comma
id|HCCR_RELEASE_RISC
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|30000
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;hccr
)paren
op_amp
id|HCCR_RISC_PAUSE
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
id|pci_write_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|PCI_COMMAND
comma
id|w
)paren
suffix:semicolon
multiline_comment|/* Reset expansion ROM address decode enable */
id|pci_read_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|PCI_ROM_ADDRESS
comma
op_amp
id|w
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
id|PCI_ROM_ADDRESS_ENABLE
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|PCI_ROM_ADDRESS
comma
id|w
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_isp_firmware() - Choose firmware image.&n; * @ha: HA context&n; *&n; * Returns 0 on success.&n; */
r_static
r_int
DECL|function|qla2x00_isp_firmware
id|qla2x00_isp_firmware
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
multiline_comment|/* Assume loading risc code */
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.disable_risc_code_load
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RISC CODE NOT loaded&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;RISC CODE NOT loaded&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Verify checksum of loaded RISC code. */
id|rval
op_assign
id|qla2x00_verify_checksum
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): **** Load RISC code ****&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_reset_chip() - Reset ISP chip.&n; * @ha: HA context&n; *&n; * Returns 0 on success.&n; */
r_static
r_void
DECL|function|qla2x00_reset_chip
id|qla2x00_reset_chip
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint32
id|cnt
suffix:semicolon
r_int
r_int
id|mbx_flags
op_assign
l_int|0
suffix:semicolon
r_uint16
id|cmd
suffix:semicolon
multiline_comment|/* Disable ISP interrupts. */
id|qla2x00_disable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Turn off master enable */
id|cmd
op_assign
l_int|0
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_and_assign
op_complement
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* Pause RISC. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_PAUSE_RISC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2200
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2300
c_func
(paren
id|ha
)paren
)paren
(brace
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|30000
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
)paren
op_amp
id|HCCR_RISC_PAUSE
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* Select FPM registers. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ctrl_status
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* FPM Soft Reset. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;fpm_diag_config
comma
l_int|0x100
)paren
suffix:semicolon
multiline_comment|/* Toggle Fpm Reset. */
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;fpm_diag_config
comma
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* Select frame buffer registers. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ctrl_status
comma
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* Reset frame buffer FIFOs. */
r_if
c_cond
(paren
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
id|WRT_FB_CMD_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|0xa000
)paren
suffix:semicolon
)brace
r_else
(brace
id|WRT_FB_CMD_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|0x00fc
)paren
suffix:semicolon
multiline_comment|/* Read back fb_cmd until zero or 3 seconds max */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|3000
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|RD_FB_CMD_REG
c_func
(paren
id|ha
comma
id|reg
)paren
op_amp
l_int|0xff
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Select RISC module registers. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ctrl_status
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset RISC processor. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_RESET_RISC
)paren
suffix:semicolon
multiline_comment|/* Release RISC processor. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_RELEASE_RISC
)paren
suffix:semicolon
)brace
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_CLR_RISC_INT
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_CLR_HOST_INT
)paren
suffix:semicolon
multiline_comment|/* Reset ISP chip. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ctrl_status
comma
id|CSR_ISP_SOFT_RESET
)paren
suffix:semicolon
multiline_comment|/* Wait for RISC to recover from reset. */
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2300
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * It is necessary to for a delay here since the card doesn&squot;t&n;&t;&t; * respond to PCI reads during a reset. On some architectures&n;&t;&t; * this will result in an MCA.&n;&t;&t; */
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|30000
suffix:semicolon
id|cnt
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ctrl_status
)paren
op_amp
id|CSR_ISP_SOFT_RESET
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
)brace
r_else
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Reset RISC processor. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_RESET_RISC
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Release RISC processor. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_RELEASE_RISC
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
)paren
suffix:semicolon
multiline_comment|/* PCI Posting. */
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2300
c_func
(paren
id|ha
)paren
)paren
(brace
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|30000
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|test_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;mbx_reg_lock
comma
id|mbx_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|0
)paren
op_ne
id|MBS_BUSY
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|test_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;mbx_reg_lock
comma
id|mbx_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|test_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;mbx_reg_lock
comma
id|mbx_flags
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
)brace
r_else
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* Turn on master enable */
id|cmd
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|ha-&gt;pdev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Disable RISC pause on FPM parity error. */
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
)paren
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_DISABLE_PARITY_PAUSE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_chip_diag() - Test chip for proper operation.&n; * @ha: HA context&n; *&n; * Returns 0 on success.&n; */
r_static
r_int
DECL|function|qla2x00_chip_diag
id|qla2x00_chip_diag
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_uint16
id|data
suffix:semicolon
r_uint32
id|cnt
suffix:semicolon
r_uint16
id|mb
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* Assume a failed state */
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Testing device at %lx.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
(paren
id|u_long
)paren
op_amp
id|reg-&gt;flash_address
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Reset ISP chip. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ctrl_status
comma
id|CSR_ISP_SOFT_RESET
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We need to have a delay here since the card will not respond while&n;&t; * in reset causing an MCA on some architectures.&n;&t; */
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|data
op_assign
id|qla2x00_debounce_register
c_func
(paren
op_amp
id|reg-&gt;ctrl_status
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|6000000
suffix:semicolon
id|cnt
op_logical_and
(paren
id|data
op_amp
id|CSR_ISP_SOFT_RESET
)paren
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ctrl_status
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cnt
)paren
r_goto
id|chip_diag_failed
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Reset register cleared by chip reset&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
multiline_comment|/* Reset RISC processor. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_RESET_RISC
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_RELEASE_RISC
)paren
suffix:semicolon
multiline_comment|/* Workaround for QLA2312 PCI parity error */
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2300
c_func
(paren
id|ha
)paren
)paren
(brace
id|data
op_assign
id|qla2x00_debounce_register
c_func
(paren
id|MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|0
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|6000000
suffix:semicolon
id|cnt
op_logical_and
(paren
id|data
op_eq
id|MBS_BUSY
)paren
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|data
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|0
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_else
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cnt
)paren
r_goto
id|chip_diag_failed
suffix:semicolon
multiline_comment|/* Check product ID of chip */
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Checking product ID of chip&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|2
)paren
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|3
)paren
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
id|qla2x00_debounce_register
c_func
(paren
id|MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|4
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
l_int|1
)braket
op_ne
id|PROD_ID_1
op_logical_or
(paren
id|mb
(braket
l_int|2
)braket
op_ne
id|PROD_ID_2
op_logical_and
id|mb
(braket
l_int|2
)braket
op_ne
id|PROD_ID_2a
)paren
op_logical_or
id|mb
(braket
l_int|3
)braket
op_ne
id|PROD_ID_3
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Wrong product ID = 0x%x,0x%x,0x%x&bslash;n&quot;
comma
id|mb
(braket
l_int|1
)braket
comma
id|mb
(braket
l_int|2
)braket
comma
id|mb
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_goto
id|chip_diag_failed
suffix:semicolon
)brace
id|ha-&gt;product_id
(braket
l_int|0
)braket
op_assign
id|mb
(braket
l_int|1
)braket
suffix:semicolon
id|ha-&gt;product_id
(braket
l_int|1
)braket
op_assign
id|mb
(braket
l_int|2
)braket
suffix:semicolon
id|ha-&gt;product_id
(braket
l_int|2
)braket
op_assign
id|mb
(braket
l_int|3
)braket
suffix:semicolon
id|ha-&gt;product_id
(braket
l_int|3
)braket
op_assign
id|mb
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Adjust fw RISC transfer size */
r_if
c_cond
(paren
id|ha-&gt;request_q_length
OG
l_int|1024
)paren
id|ha-&gt;fw_transfer_size
op_assign
id|REQUEST_ENTRY_SIZE
op_star
l_int|1024
suffix:semicolon
r_else
id|ha-&gt;fw_transfer_size
op_assign
id|REQUEST_ENTRY_SIZE
op_star
id|ha-&gt;request_q_length
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2200
c_func
(paren
id|ha
)paren
op_logical_and
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|7
)paren
op_eq
id|QLA2200A_RISC_ROM_VER
)paren
(brace
multiline_comment|/* Limit firmware transfer size with a 2200A */
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Found QLA2200A chip.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|ha-&gt;fw_transfer_size
op_assign
l_int|128
suffix:semicolon
)brace
multiline_comment|/* Wrap Incoming Mailboxes Test. */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Checking mailboxes.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_mbx_reg_test
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Failed mailbox send register test&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Failed mailbox send register test&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Flag a successful rval */
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|chip_diag_failed
suffix:colon
r_if
c_cond
(paren
id|rval
)paren
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Chip diagnostics **** FAILED &quot;
l_string|&quot;****&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_setup_chip() - Load and start RISC firmware.&n; * @ha: HA context&n; *&n; * Returns 0 on success.&n; */
r_static
r_int
DECL|function|qla2x00_setup_chip
id|qla2x00_setup_chip
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint16
id|cnt
suffix:semicolon
r_uint16
op_star
id|risc_code
suffix:semicolon
r_int
r_int
id|risc_address
suffix:semicolon
r_int
r_int
id|risc_code_size
suffix:semicolon
r_int
id|num
suffix:semicolon
r_int
id|i
suffix:semicolon
r_uint16
op_star
id|req_ring
suffix:semicolon
r_struct
id|qla_fw_info
op_star
id|fw_iter
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
multiline_comment|/* Load firmware sequences */
id|fw_iter
op_assign
id|ha-&gt;brd_info-&gt;fw_info
suffix:semicolon
r_while
c_loop
(paren
id|fw_iter-&gt;addressing
op_ne
id|FW_INFO_ADDR_NOMORE
)paren
(brace
id|risc_code
op_assign
id|fw_iter-&gt;fwcode
suffix:semicolon
id|risc_code_size
op_assign
op_star
id|fw_iter-&gt;fwlen
suffix:semicolon
r_if
c_cond
(paren
id|fw_iter-&gt;addressing
op_eq
id|FW_INFO_ADDR_NORMAL
)paren
(brace
id|risc_address
op_assign
op_star
id|fw_iter-&gt;fwstart
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Extended address */
id|risc_address
op_assign
op_star
id|fw_iter-&gt;lfwstart
suffix:semicolon
)brace
id|num
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|risc_code_size
OG
l_int|0
op_logical_and
op_logical_neg
id|rval
)paren
(brace
id|cnt
op_assign
(paren
r_uint16
)paren
(paren
id|ha-&gt;fw_transfer_size
op_rshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|risc_code_size
)paren
id|cnt
op_assign
id|risc_code_size
suffix:semicolon
id|DEBUG7
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Loading risc segment@ &quot;
l_string|&quot;addr %p, number of bytes 0x%x, offset 0x%lx.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|risc_code
comma
id|cnt
comma
id|risc_address
)paren
)paren
suffix:semicolon
id|req_ring
op_assign
(paren
r_uint16
op_star
)paren
id|ha-&gt;request_ring
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
id|req_ring
(braket
id|i
)braket
op_assign
id|cpu_to_le16
c_func
(paren
id|risc_code
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fw_iter-&gt;addressing
op_eq
id|FW_INFO_ADDR_NORMAL
)paren
(brace
id|rval
op_assign
id|qla2x00_load_ram
c_func
(paren
id|ha
comma
id|ha-&gt;request_dma
comma
id|risc_address
comma
id|cnt
)paren
suffix:semicolon
)brace
r_else
(brace
id|rval
op_assign
id|qla2x00_load_ram_ext
c_func
(paren
id|ha
comma
id|ha-&gt;request_dma
comma
id|risc_address
comma
id|cnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): [ERROR] Failed to &quot;
l_string|&quot;load segment %d of firmware&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|num
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;[ERROR] Failed to load &quot;
l_string|&quot;segment %d of firmware&bslash;n&quot;
comma
id|num
)paren
suffix:semicolon
id|qla2x00_dump_regs
c_func
(paren
id|ha
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|risc_code
op_add_assign
id|cnt
suffix:semicolon
id|risc_address
op_add_assign
id|cnt
suffix:semicolon
id|risc_code_size
op_sub_assign
id|cnt
suffix:semicolon
id|num
op_increment
suffix:semicolon
)brace
multiline_comment|/* Next firmware sequence */
id|fw_iter
op_increment
suffix:semicolon
)brace
multiline_comment|/* Verify checksum of loaded RISC code. */
r_if
c_cond
(paren
op_logical_neg
id|rval
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Verifying Checksum of loaded RISC &quot;
l_string|&quot;code.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_verify_checksum
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* Start firmware execution. */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Checksum OK, start &quot;
l_string|&quot;firmware.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_execute_fw
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): ISP Firmware failed checksum.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Setup chip **** FAILED ****.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_init_response_q_entries() - Initializes response queue entries.&n; * @ha: HA context&n; *&n; * Beginning of request ring has initialization control block already built&n; * by nvram config routine.&n; *&n; * Returns 0 on success.&n; */
r_static
r_void
DECL|function|qla2x00_init_response_q_entries
id|qla2x00_init_response_q_entries
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint16
id|cnt
suffix:semicolon
id|response_t
op_star
id|pkt
suffix:semicolon
id|pkt
op_assign
id|ha-&gt;response_ring_ptr
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|ha-&gt;response_q_length
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|pkt-&gt;signature
op_assign
id|RESPONSE_PROCESSED
suffix:semicolon
id|pkt
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * qla2x00_update_fw_options() - Read and process firmware options.&n; * @ha: HA context&n; *&n; * Returns 0 on success.&n; */
r_static
r_void
DECL|function|qla2x00_update_fw_options
id|qla2x00_update_fw_options
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
multiline_comment|/* Setup seriallink options */
r_uint16
id|swing
comma
id|emphasis
suffix:semicolon
id|memset
c_func
(paren
id|ha-&gt;fw_options
comma
l_int|0
comma
r_sizeof
(paren
id|ha-&gt;fw_options
)paren
)paren
suffix:semicolon
id|qla2x00_get_fw_options
c_func
(paren
id|ha
comma
id|ha-&gt;fw_options
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Serial Link options. */
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Serial link options:&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|ha-&gt;fw_seriallink_options
comma
r_sizeof
(paren
id|ha-&gt;fw_seriallink_options
)paren
)paren
)paren
suffix:semicolon
id|ha-&gt;fw_options
(braket
l_int|1
)braket
op_and_assign
op_complement
id|FO1_SET_EMPHASIS_SWING
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;fw_seriallink_options
(braket
l_int|1
)braket
op_amp
id|BIT_2
)paren
id|ha-&gt;fw_options
(braket
l_int|1
)braket
op_or_assign
id|FO1_SET_EMPHASIS_SWING
suffix:semicolon
multiline_comment|/*  1G settings */
id|swing
op_assign
id|ha-&gt;fw_seriallink_options
(braket
l_int|0
)braket
op_amp
(paren
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
)paren
suffix:semicolon
id|emphasis
op_assign
id|ha-&gt;fw_seriallink_options
(braket
l_int|0
)braket
op_amp
(paren
id|BIT_4
op_or
id|BIT_3
)paren
suffix:semicolon
id|emphasis
op_rshift_assign
l_int|3
suffix:semicolon
id|ha-&gt;fw_options
(braket
l_int|10
)braket
op_assign
(paren
id|emphasis
op_lshift
l_int|14
)paren
op_or
(paren
id|swing
op_lshift
l_int|8
)paren
op_or
l_int|0x3
suffix:semicolon
multiline_comment|/*  2G settings */
id|swing
op_assign
id|ha-&gt;fw_seriallink_options
(braket
l_int|0
)braket
op_amp
(paren
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_5
)paren
suffix:semicolon
id|swing
op_rshift_assign
l_int|5
suffix:semicolon
id|emphasis
op_assign
id|ha-&gt;fw_seriallink_options
(braket
l_int|1
)braket
op_amp
(paren
id|BIT_1
op_or
id|BIT_0
)paren
suffix:semicolon
id|ha-&gt;fw_options
(braket
l_int|11
)braket
op_assign
(paren
id|emphasis
op_lshift
l_int|14
)paren
op_or
(paren
id|swing
op_lshift
l_int|8
)paren
op_or
l_int|0x3
suffix:semicolon
multiline_comment|/* FCP2 options. */
multiline_comment|/*  Return command IOCBs without waiting for an ABTS to complete. */
id|ha-&gt;fw_options
(braket
l_int|3
)braket
op_or_assign
id|BIT_13
suffix:semicolon
multiline_comment|/* Update Serial Link options. */
id|qla2x00_set_fw_options
c_func
(paren
id|ha
comma
id|ha-&gt;fw_options
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_init_rings() - Initializes firmware.&n; * @ha: HA context&n; *&n; * Beginning of request ring has initialization control block already built&n; * by nvram config routine.&n; *&n; * Returns 0 on success.&n; */
r_static
r_int
DECL|function|qla2x00_init_rings
id|qla2x00_init_rings
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Clear outstanding commands array. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|cnt
op_increment
)paren
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;current_outstanding_cmd
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear RSCN queue. */
id|ha-&gt;rscn_in_ptr
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;rscn_out_ptr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize firmware. */
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;req_q_cnt
op_assign
id|ha-&gt;request_q_length
suffix:semicolon
id|ha-&gt;response_ring_ptr
op_assign
id|ha-&gt;response_ring
suffix:semicolon
id|ha-&gt;rsp_ring_index
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize response queue entries */
id|qla2x00_init_response_q_entries
c_func
(paren
id|ha
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
id|ISP_REQ_Q_IN
c_func
(paren
id|ha
comma
id|reg
)paren
comma
l_int|0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
id|ISP_REQ_Q_OUT
c_func
(paren
id|ha
comma
id|reg
)paren
comma
l_int|0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
id|ISP_RSP_Q_IN
c_func
(paren
id|ha
comma
id|reg
)paren
comma
l_int|0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
id|ISP_RSP_Q_OUT
c_func
(paren
id|ha
comma
id|reg
)paren
comma
l_int|0
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
id|ISP_RSP_Q_OUT
c_func
(paren
id|ha
comma
id|reg
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Issue init firmware.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_init_firmware
c_func
(paren
id|ha
comma
r_sizeof
(paren
id|init_cb_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Init firmware **** FAILED ****.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Update any ISP specific firmware options. */
id|qla2x00_update_fw_options
c_func
(paren
id|ha
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Init firmware -- success.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_fw_ready() - Waits for firmware ready.&n; * @ha: HA context&n; *&n; * Returns 0 on success.&n; */
r_static
r_int
DECL|function|qla2x00_fw_ready
id|qla2x00_fw_ready
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_int
r_int
id|wtime
comma
id|mtime
suffix:semicolon
r_uint16
id|min_wait
suffix:semicolon
multiline_comment|/* Minimum wait time if loop is down */
r_uint16
id|wait_time
suffix:semicolon
multiline_comment|/* Wait time if loop is coming ready */
r_uint16
id|fw_state
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
multiline_comment|/* 20 seconds for loop down. */
id|min_wait
op_assign
l_int|20
suffix:semicolon
multiline_comment|/*&n;&t; * Firmware should take at most one RATOV to login, plus 5 seconds for&n;&t; * our own processing.&n;&t; */
r_if
c_cond
(paren
(paren
id|wait_time
op_assign
(paren
id|ha-&gt;retry_count
op_star
id|ha-&gt;login_timeout
)paren
op_plus
l_int|5
)paren
OL
id|min_wait
)paren
(brace
id|wait_time
op_assign
id|min_wait
suffix:semicolon
)brace
multiline_comment|/* Min wait time if loop down */
id|mtime
op_assign
id|jiffies
op_plus
(paren
id|min_wait
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* wait time before firmware ready */
id|wtime
op_assign
id|jiffies
op_plus
(paren
id|wait_time
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* Wait for ISP to finish LIP */
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.init_done
)paren
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Waiting for LIP to complete...&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Waiting for LIP to complete...&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
r_do
(brace
id|rval
op_assign
id|qla2x00_get_firmware_state
c_func
(paren
id|ha
comma
op_amp
id|fw_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
(brace
r_if
c_cond
(paren
id|fw_state
OL
id|FSTATE_LOSS_OF_SYNC
)paren
(brace
id|ha-&gt;device_flags
op_and_assign
op_complement
id|DFLG_NO_CABLE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fw_state
op_eq
id|FSTATE_READY
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): F/W Ready - OK &bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla2x00_get_retry_cnt
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;retry_count
comma
op_amp
id|ha-&gt;login_timeout
comma
op_amp
id|ha-&gt;r_a_tov
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_and
id|fw_state
op_ge
id|FSTATE_LOSS_OF_SYNC
)paren
(brace
multiline_comment|/* Loop down. Timeout on min_wait for states&n;&t;&t;&t;&t; * other than Wait for Login. &n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|mtime
)paren
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Cable is unplugged...&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;device_flags
op_or_assign
id|DFLG_NO_CABLE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Mailbox cmd failed. Timeout on min_wait. */
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|mtime
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|wtime
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Delay for a while */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): fw_state=%x curr time=%lx.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fw_state
comma
id|jiffies
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): fw_state=%x curr time=%lx.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fw_state
comma
id|jiffies
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Firmware ready **** FAILED ****.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;*  qla2x00_configure_hba&n;*      Setup adapter context.&n;*&n;* Input:&n;*      ha = adapter state pointer.&n;*&n;* Returns:&n;*      0 = success&n;*&n;* Context:&n;*      Kernel context.&n;*/
r_static
r_int
DECL|function|qla2x00_configure_hba
id|qla2x00_configure_hba
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint16
id|loop_id
suffix:semicolon
r_uint16
id|topo
suffix:semicolon
r_uint8
id|al_pa
suffix:semicolon
r_uint8
id|area
suffix:semicolon
r_uint8
id|domain
suffix:semicolon
r_char
id|connect_type
(braket
l_int|22
)braket
suffix:semicolon
multiline_comment|/* Get host addresses. */
id|rval
op_assign
id|qla2x00_get_adapter_id
c_func
(paren
id|ha
comma
op_amp
id|loop_id
comma
op_amp
id|al_pa
comma
op_amp
id|area
comma
op_amp
id|domain
comma
op_amp
id|topo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;ERROR -- Unable to get host loop ID.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|topo
op_eq
l_int|4
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Cannot get topology - retrying.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
)brace
id|ha-&gt;loop_id
op_assign
id|loop_id
suffix:semicolon
multiline_comment|/* Make sure 2100 only has loop, in case of any firmware bug. */
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
)paren
id|topo
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initialize */
id|ha-&gt;min_external_loopid
op_assign
id|SNS_FIRST_LOOP_ID
suffix:semicolon
id|ha-&gt;operating_mode
op_assign
id|LOOP
suffix:semicolon
r_switch
c_cond
(paren
id|topo
)paren
(brace
r_case
l_int|0
suffix:colon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): HBA in NL topology.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|ha-&gt;current_topology
op_assign
id|ISP_CFG_NL
suffix:semicolon
id|strcpy
c_func
(paren
id|connect_type
comma
l_string|&quot;(Loop)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): HBA in FL topology.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|ha-&gt;current_topology
op_assign
id|ISP_CFG_FL
suffix:semicolon
id|strcpy
c_func
(paren
id|connect_type
comma
l_string|&quot;(FL_Port)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): HBA in N P2P topology.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|ha-&gt;operating_mode
op_assign
id|P2P
suffix:semicolon
id|ha-&gt;current_topology
op_assign
id|ISP_CFG_N
suffix:semicolon
id|strcpy
c_func
(paren
id|connect_type
comma
l_string|&quot;(N_Port-to-N_Port)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): HBA in F P2P topology.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|ha-&gt;operating_mode
op_assign
id|P2P
suffix:semicolon
id|ha-&gt;current_topology
op_assign
id|ISP_CFG_F
suffix:semicolon
id|strcpy
c_func
(paren
id|connect_type
comma
l_string|&quot;(F_Port)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): HBA in unknown topology %x. &quot;
l_string|&quot;Using NL.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|topo
)paren
)paren
suffix:semicolon
id|ha-&gt;current_topology
op_assign
id|ISP_CFG_NL
suffix:semicolon
id|strcpy
c_func
(paren
id|connect_type
comma
l_string|&quot;(Loop)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Save Host port and loop ID. */
multiline_comment|/* byte order - Big Endian */
id|ha-&gt;d_id.b.domain
op_assign
id|domain
suffix:semicolon
id|ha-&gt;d_id.b.area
op_assign
id|area
suffix:semicolon
id|ha-&gt;d_id.b.al_pa
op_assign
id|al_pa
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.init_done
)paren
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Topology - %s, Host Loop address 0x%x&bslash;n&quot;
comma
id|connect_type
comma
id|ha-&gt;loop_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): FAILED.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): exiting normally.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n;* NVRAM configuration for ISP 2xxx&n;*&n;* Input:&n;*      ha                = adapter block pointer.&n;*&n;* Output:&n;*      initialization control block in response_ring&n;*      host adapters parameters in host adapter block&n;*&n;* Returns:&n;*      0 = success.&n;*/
r_static
r_int
DECL|function|qla2x00_nvram_config
id|qla2x00_nvram_config
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint8
id|chksum
op_assign
l_int|0
suffix:semicolon
r_uint16
id|cnt
suffix:semicolon
r_uint8
op_star
id|dptr1
comma
op_star
id|dptr2
suffix:semicolon
id|init_cb_t
op_star
id|icb
op_assign
id|ha-&gt;init_cb
suffix:semicolon
id|nvram_t
op_star
id|nv
op_assign
(paren
id|nvram_t
op_star
)paren
id|ha-&gt;request_ring
suffix:semicolon
r_uint16
op_star
id|wptr
op_assign
(paren
r_uint16
op_star
)paren
id|ha-&gt;request_ring
suffix:semicolon
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint16
id|timer_mode
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.init_done
)paren
r_return
(paren
id|rval
)paren
suffix:semicolon
multiline_comment|/* Determine NVRAM starting address. */
id|ha-&gt;nvram_base
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA2200
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA2300
c_func
(paren
id|ha
)paren
)paren
r_if
c_cond
(paren
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ctrl_status
)paren
op_rshift
l_int|14
)paren
op_eq
l_int|1
)paren
id|ha-&gt;nvram_base
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Get NVRAM data and calculate checksum. */
id|qla2x00_lock_nvram_access
c_func
(paren
id|ha
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
r_sizeof
(paren
id|nvram_t
)paren
op_div
l_int|2
suffix:semicolon
id|cnt
op_increment
)paren
(brace
op_star
id|wptr
op_assign
id|cpu_to_le16
c_func
(paren
id|qla2x00_get_nvram_word
c_func
(paren
id|ha
comma
(paren
id|cnt
op_plus
id|ha-&gt;nvram_base
)paren
)paren
)paren
suffix:semicolon
id|chksum
op_add_assign
(paren
r_uint8
)paren
op_star
id|wptr
suffix:semicolon
id|chksum
op_add_assign
(paren
r_uint8
)paren
(paren
op_star
id|wptr
op_rshift
l_int|8
)paren
suffix:semicolon
id|wptr
op_increment
suffix:semicolon
)brace
id|qla2x00_unlock_nvram_access
c_func
(paren
id|ha
)paren
suffix:semicolon
id|DEBUG5
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Contents of NVRAM&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG5
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
id|ha-&gt;request_ring
comma
r_sizeof
(paren
id|nvram_t
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Bad NVRAM data, set defaults parameters. */
r_if
c_cond
(paren
id|chksum
op_logical_or
id|nv-&gt;id
(braket
l_int|0
)braket
op_ne
l_char|&squot;I&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|1
)braket
op_ne
l_char|&squot;S&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|2
)braket
op_ne
l_char|&squot;P&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|3
)braket
op_ne
l_char|&squot; &squot;
op_logical_or
id|nv-&gt;nvram_version
OL
l_int|1
)paren
(brace
multiline_comment|/* Reset NVRAM data. */
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Inconsistent NVRAM detected: &quot;
l_string|&quot;checksum=0x%x id=%c version=0x%x.&bslash;n&quot;
comma
id|chksum
comma
id|nv-&gt;id
(braket
l_int|0
)braket
comma
id|nv-&gt;nvram_version
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Falling back to functioning (yet &quot;
l_string|&quot;invalid -- WWPN) defaults.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Set default initialization control block.&n;&t;&t; */
id|memset
c_func
(paren
id|nv
comma
l_int|0
comma
r_sizeof
(paren
id|nvram_t
)paren
)paren
suffix:semicolon
id|nv-&gt;parameter_block_version
op_assign
id|ICB_VERSION
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA23XX
c_func
(paren
id|ha
)paren
)paren
(brace
id|nv-&gt;firmware_options
(braket
l_int|0
)braket
op_assign
id|BIT_2
op_or
id|BIT_1
suffix:semicolon
id|nv-&gt;firmware_options
(braket
l_int|1
)braket
op_assign
id|BIT_7
op_or
id|BIT_5
suffix:semicolon
id|nv-&gt;add_firmware_options
(braket
l_int|0
)braket
op_assign
id|BIT_5
suffix:semicolon
id|nv-&gt;add_firmware_options
(braket
l_int|1
)braket
op_assign
id|BIT_5
op_or
id|BIT_4
suffix:semicolon
id|nv-&gt;frame_payload_size
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|2048
)paren
suffix:semicolon
id|nv-&gt;special_options
(braket
l_int|1
)braket
op_assign
id|BIT_7
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
id|nv-&gt;firmware_options
(braket
l_int|0
)braket
op_assign
id|BIT_2
op_or
id|BIT_1
suffix:semicolon
id|nv-&gt;firmware_options
(braket
l_int|1
)braket
op_assign
id|BIT_7
op_or
id|BIT_5
suffix:semicolon
id|nv-&gt;add_firmware_options
(braket
l_int|0
)braket
op_assign
id|BIT_5
op_or
id|BIT_4
suffix:semicolon
id|nv-&gt;add_firmware_options
(braket
l_int|1
)braket
op_assign
id|BIT_5
op_or
id|BIT_4
suffix:semicolon
id|nv-&gt;frame_payload_size
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|1024
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
)paren
(brace
id|nv-&gt;firmware_options
(braket
l_int|0
)braket
op_assign
id|BIT_3
op_or
id|BIT_1
suffix:semicolon
id|nv-&gt;firmware_options
(braket
l_int|1
)braket
op_assign
id|BIT_5
suffix:semicolon
id|nv-&gt;frame_payload_size
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|1024
)paren
suffix:semicolon
)brace
id|nv-&gt;max_iocb_allocation
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|256
)paren
suffix:semicolon
id|nv-&gt;execution_throttle
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|16
)paren
suffix:semicolon
id|nv-&gt;retry_count
op_assign
l_int|8
suffix:semicolon
id|nv-&gt;retry_delay
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;port_name
(braket
l_int|0
)braket
op_assign
l_int|33
suffix:semicolon
id|nv-&gt;port_name
(braket
l_int|3
)braket
op_assign
l_int|224
suffix:semicolon
id|nv-&gt;port_name
(braket
l_int|4
)braket
op_assign
l_int|139
suffix:semicolon
id|nv-&gt;login_timeout
op_assign
l_int|4
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Set default host adapter parameters&n;&t;&t; */
id|nv-&gt;host_p
(braket
l_int|1
)braket
op_assign
id|BIT_2
suffix:semicolon
id|nv-&gt;reset_delay
op_assign
l_int|5
suffix:semicolon
id|nv-&gt;port_down_retry_count
op_assign
l_int|8
suffix:semicolon
id|nv-&gt;max_luns_per_target
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|8
)paren
suffix:semicolon
id|nv-&gt;link_down_timeout
op_assign
l_int|60
suffix:semicolon
id|rval
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_IA64_GENERIC) || defined(CONFIG_IA64_SGI_SN2)
multiline_comment|/*&n;&t; * The SN2 does not provide BIOS emulation which means you can&squot;t change&n;&t; * potentially bogus BIOS settings. Force the use of default settings&n;&t; * for link rate and frame size.  Hope that the rest of the settings&n;&t; * are valid.&n;&t; */
r_if
c_cond
(paren
id|ia64_platform_is
c_func
(paren
l_string|&quot;sn2&quot;
)paren
)paren
(brace
id|nv-&gt;frame_payload_size
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|2048
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA23XX
c_func
(paren
id|ha
)paren
)paren
id|nv-&gt;special_options
(braket
l_int|1
)braket
op_assign
id|BIT_7
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Reset Initialization control block */
id|memset
c_func
(paren
id|icb
comma
l_int|0
comma
r_sizeof
(paren
id|init_cb_t
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setup driver NVRAM options.&n;&t; */
id|nv-&gt;firmware_options
(braket
l_int|0
)braket
op_or_assign
(paren
id|BIT_6
op_or
id|BIT_1
)paren
suffix:semicolon
id|nv-&gt;firmware_options
(braket
l_int|0
)braket
op_and_assign
op_complement
(paren
id|BIT_5
op_or
id|BIT_4
)paren
suffix:semicolon
id|nv-&gt;firmware_options
(braket
l_int|1
)braket
op_or_assign
(paren
id|BIT_5
op_or
id|BIT_0
)paren
suffix:semicolon
id|nv-&gt;firmware_options
(braket
l_int|1
)braket
op_and_assign
op_complement
id|BIT_4
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA23XX
c_func
(paren
id|ha
)paren
)paren
(brace
id|nv-&gt;firmware_options
(braket
l_int|0
)braket
op_or_assign
id|BIT_2
suffix:semicolon
id|nv-&gt;firmware_options
(braket
l_int|0
)braket
op_and_assign
op_complement
id|BIT_3
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2300
c_func
(paren
id|ha
)paren
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;fb_rev
op_eq
id|FPM_2310
)paren
(brace
id|strcpy
c_func
(paren
id|ha-&gt;model_number
comma
l_string|&quot;QLA2310&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|strcpy
c_func
(paren
id|ha-&gt;model_number
comma
l_string|&quot;QLA2300&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|rval
op_eq
l_int|0
op_logical_and
id|memcmp
c_func
(paren
id|nv-&gt;model_number
comma
id|BINZERO
comma
r_sizeof
(paren
id|nv-&gt;model_number
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_char
op_star
id|st
comma
op_star
id|en
suffix:semicolon
id|strncpy
c_func
(paren
id|ha-&gt;model_number
comma
id|nv-&gt;model_number
comma
r_sizeof
(paren
id|nv-&gt;model_number
)paren
)paren
suffix:semicolon
id|st
op_assign
id|en
op_assign
id|ha-&gt;model_number
suffix:semicolon
id|en
op_add_assign
r_sizeof
(paren
id|nv-&gt;model_number
)paren
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|en
OG
id|st
)paren
(brace
r_if
c_cond
(paren
op_star
id|en
op_ne
l_int|0x20
op_logical_and
op_star
id|en
op_ne
l_int|0x00
)paren
r_break
suffix:semicolon
op_star
id|en
op_decrement
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
)brace
r_else
(brace
r_uint16
id|index
suffix:semicolon
id|index
op_assign
(paren
id|ha-&gt;pdev-&gt;subsystem_device
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
OL
id|QLA_MODEL_NAMES
)paren
(brace
id|strcpy
c_func
(paren
id|ha-&gt;model_number
comma
id|qla2x00_model_name
(braket
id|index
)braket
)paren
suffix:semicolon
id|ha-&gt;model_desc
op_assign
id|qla2x00_model_desc
(braket
id|index
)braket
suffix:semicolon
)brace
r_else
(brace
id|strcpy
c_func
(paren
id|ha-&gt;model_number
comma
l_string|&quot;QLA23xx&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
id|nv-&gt;firmware_options
(braket
l_int|0
)braket
op_or_assign
id|BIT_2
suffix:semicolon
id|strcpy
c_func
(paren
id|ha-&gt;model_number
comma
l_string|&quot;QLA22xx&quot;
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/*if (IS_QLA2100(ha))*/
(brace
id|strcpy
c_func
(paren
id|ha-&gt;model_number
comma
l_string|&quot;QLA2100&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Copy over NVRAM RISC parameter block to initialization control block.&n;&t; */
id|dptr1
op_assign
(paren
r_uint8
op_star
)paren
id|icb
suffix:semicolon
id|dptr2
op_assign
(paren
r_uint8
op_star
)paren
op_amp
id|nv-&gt;parameter_block_version
suffix:semicolon
id|cnt
op_assign
(paren
r_uint8
op_star
)paren
op_amp
id|icb-&gt;request_q_outpointer
op_minus
(paren
r_uint8
op_star
)paren
op_amp
id|icb-&gt;version
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_decrement
)paren
op_star
id|dptr1
op_increment
op_assign
op_star
id|dptr2
op_increment
suffix:semicolon
multiline_comment|/* Copy 2nd half. */
id|dptr1
op_assign
(paren
r_uint8
op_star
)paren
id|icb-&gt;add_firmware_options
suffix:semicolon
id|cnt
op_assign
(paren
r_uint8
op_star
)paren
id|icb-&gt;reserved_3
op_minus
(paren
r_uint8
op_star
)paren
id|icb-&gt;add_firmware_options
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_decrement
)paren
op_star
id|dptr1
op_increment
op_assign
op_star
id|dptr2
op_increment
suffix:semicolon
multiline_comment|/* Prepare nodename */
r_if
c_cond
(paren
(paren
id|icb-&gt;firmware_options
(braket
l_int|1
)braket
op_amp
id|BIT_6
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Firmware will apply the following mask if the nodename was&n;&t;&t; * not provided.&n;&t;&t; */
id|memcpy
c_func
(paren
id|icb-&gt;node_name
comma
id|icb-&gt;port_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|icb-&gt;node_name
(braket
l_int|0
)braket
op_and_assign
l_int|0xF0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set host adapter parameters.&n;&t; */
id|ha-&gt;nvram_version
op_assign
id|nv-&gt;nvram_version
suffix:semicolon
id|ha-&gt;flags.disable_risc_code_load
op_assign
(paren
(paren
id|nv-&gt;host_p
(braket
l_int|0
)braket
op_amp
id|BIT_4
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Always load RISC code on non ISP2[12]00 chips. */
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
id|ha-&gt;flags.disable_risc_code_load
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;flags.enable_lip_reset
op_assign
(paren
(paren
id|nv-&gt;host_p
(braket
l_int|1
)braket
op_amp
id|BIT_1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|ha-&gt;flags.enable_lip_full_login
op_assign
(paren
(paren
id|nv-&gt;host_p
(braket
l_int|1
)braket
op_amp
id|BIT_2
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|ha-&gt;flags.enable_target_reset
op_assign
(paren
(paren
id|nv-&gt;host_p
(braket
l_int|1
)braket
op_amp
id|BIT_3
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|ha-&gt;operating_mode
op_assign
(paren
id|icb-&gt;add_firmware_options
(braket
l_int|0
)braket
op_amp
(paren
id|BIT_6
op_or
id|BIT_5
op_or
id|BIT_4
)paren
)paren
op_rshift
l_int|4
suffix:semicolon
id|ha-&gt;fw_seriallink_options
(braket
l_int|0
)braket
op_assign
id|nv-&gt;seriallink_options
(braket
l_int|0
)braket
suffix:semicolon
id|ha-&gt;fw_seriallink_options
(braket
l_int|1
)braket
op_assign
id|nv-&gt;seriallink_options
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* save HBA serial number */
id|ha-&gt;serial0
op_assign
id|icb-&gt;port_name
(braket
l_int|5
)braket
suffix:semicolon
id|ha-&gt;serial1
op_assign
id|icb-&gt;port_name
(braket
l_int|6
)braket
suffix:semicolon
id|ha-&gt;serial2
op_assign
id|icb-&gt;port_name
(braket
l_int|7
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|ha-&gt;node_name
comma
id|icb-&gt;node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|icb-&gt;execution_throttle
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|0xFFFF
)paren
suffix:semicolon
id|ha-&gt;retry_count
op_assign
id|nv-&gt;retry_count
suffix:semicolon
multiline_comment|/* Set minimum login_timeout to 4 seconds. */
r_if
c_cond
(paren
id|nv-&gt;login_timeout
OL
id|ql2xlogintimeout
)paren
id|nv-&gt;login_timeout
op_assign
id|ql2xlogintimeout
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;login_timeout
OL
l_int|4
)paren
id|nv-&gt;login_timeout
op_assign
l_int|4
suffix:semicolon
id|ha-&gt;login_timeout
op_assign
id|nv-&gt;login_timeout
suffix:semicolon
id|icb-&gt;login_timeout
op_assign
id|nv-&gt;login_timeout
suffix:semicolon
multiline_comment|/* Set minimum RATOV to 200 tenths of a second. */
id|ha-&gt;r_a_tov
op_assign
l_int|200
suffix:semicolon
id|ha-&gt;minimum_timeout
op_assign
(paren
id|ha-&gt;login_timeout
op_star
id|ha-&gt;retry_count
)paren
op_plus
id|nv-&gt;port_down_retry_count
suffix:semicolon
id|ha-&gt;loop_reset_delay
op_assign
id|nv-&gt;reset_delay
suffix:semicolon
multiline_comment|/* Will get the value from NVRAM. */
id|ha-&gt;loop_down_timeout
op_assign
id|LOOP_DOWN_TIMEOUT
suffix:semicolon
multiline_comment|/* Link Down Timeout = 0:&n;&t; *&n;&t; * &t;When Port Down timer expires we will start returning&n;&t; *&t;I/O&squot;s to OS with &quot;DID_NO_CONNECT&quot;.&n;&t; *&n;&t; * Link Down Timeout != 0:&n;&t; *&n;&t; *&t; The driver waits for the link to come up after link down&n;&t; *&t; before returning I/Os to OS with &quot;DID_NO_CONNECT&quot;.&n;&t; */
r_if
c_cond
(paren
id|nv-&gt;link_down_timeout
op_eq
l_int|0
)paren
(brace
id|ha-&gt;loop_down_abort_time
op_assign
(paren
id|LOOP_DOWN_TIME
op_minus
id|ha-&gt;loop_down_timeout
)paren
suffix:semicolon
)brace
r_else
(brace
id|ha-&gt;link_down_timeout
op_assign
id|nv-&gt;link_down_timeout
suffix:semicolon
id|ha-&gt;loop_down_abort_time
op_assign
(paren
id|LOOP_DOWN_TIME
op_minus
id|ha-&gt;link_down_timeout
)paren
suffix:semicolon
)brace
id|ha-&gt;max_luns
op_assign
id|MAX_LUNS
suffix:semicolon
id|ha-&gt;max_probe_luns
op_assign
id|le16_to_cpu
c_func
(paren
id|nv-&gt;max_luns_per_target
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;max_probe_luns
op_eq
l_int|0
)paren
id|ha-&gt;max_probe_luns
op_assign
id|MIN_LUNS
suffix:semicolon
multiline_comment|/*&n;&t; * Need enough time to try and get the port back.&n;&t; */
id|ha-&gt;port_down_retry_count
op_assign
id|nv-&gt;port_down_retry_count
suffix:semicolon
r_if
c_cond
(paren
id|qlport_down_retry
)paren
id|ha-&gt;port_down_retry_count
op_assign
id|qlport_down_retry
suffix:semicolon
multiline_comment|/* Set login_retry_count */
id|ha-&gt;login_retry_count
op_assign
id|nv-&gt;retry_count
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;port_down_retry_count
op_eq
id|nv-&gt;port_down_retry_count
op_logical_and
id|ha-&gt;port_down_retry_count
OG
l_int|3
)paren
id|ha-&gt;login_retry_count
op_assign
id|ha-&gt;port_down_retry_count
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ha-&gt;port_down_retry_count
OG
(paren
r_int
)paren
id|ha-&gt;login_retry_count
)paren
id|ha-&gt;login_retry_count
op_assign
id|ha-&gt;port_down_retry_count
suffix:semicolon
r_if
c_cond
(paren
id|ql2xloginretrycount
)paren
id|ha-&gt;login_retry_count
op_assign
id|ql2xloginretrycount
suffix:semicolon
id|ha-&gt;binding_type
op_assign
id|Bind
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;binding_type
op_ne
id|BIND_BY_PORT_NAME
op_logical_and
id|ha-&gt;binding_type
op_ne
id|BIND_BY_PORT_ID
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Invalid binding type specified (%d), &quot;
l_string|&quot;defaulting to BIND_BY_PORT_NAME!!!&bslash;n&quot;
comma
id|ha-&gt;binding_type
)paren
suffix:semicolon
id|ha-&gt;binding_type
op_assign
id|BIND_BY_PORT_NAME
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Setup ring parameters in initialization control block&n;&t; */
id|icb-&gt;request_q_outpointer
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|icb-&gt;response_q_inpointer
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|icb-&gt;request_q_length
op_assign
id|cpu_to_le16
c_func
(paren
id|ha-&gt;request_q_length
)paren
suffix:semicolon
id|icb-&gt;response_q_length
op_assign
id|cpu_to_le16
c_func
(paren
id|ha-&gt;response_q_length
)paren
suffix:semicolon
id|icb-&gt;request_q_address
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|LSD
c_func
(paren
id|ha-&gt;request_dma
)paren
)paren
suffix:semicolon
id|icb-&gt;request_q_address
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MSD
c_func
(paren
id|ha-&gt;request_dma
)paren
)paren
suffix:semicolon
id|icb-&gt;response_q_address
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|LSD
c_func
(paren
id|ha-&gt;response_dma
)paren
)paren
suffix:semicolon
id|icb-&gt;response_q_address
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MSD
c_func
(paren
id|ha-&gt;response_dma
)paren
)paren
suffix:semicolon
id|icb-&gt;lun_enables
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|icb-&gt;command_resource_count
op_assign
l_int|0
suffix:semicolon
id|icb-&gt;immediate_notify_resource_count
op_assign
l_int|0
suffix:semicolon
id|icb-&gt;timeout
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* Enable RIO */
id|icb-&gt;firmware_options
(braket
l_int|0
)braket
op_and_assign
op_complement
id|BIT_3
suffix:semicolon
id|icb-&gt;add_firmware_options
(braket
l_int|0
)braket
op_and_assign
op_complement
(paren
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
)paren
suffix:semicolon
id|icb-&gt;add_firmware_options
(braket
l_int|0
)braket
op_or_assign
id|BIT_2
suffix:semicolon
id|icb-&gt;response_accumulation_timer
op_assign
l_int|3
suffix:semicolon
id|icb-&gt;interrupt_delay_timer
op_assign
l_int|5
suffix:semicolon
id|ha-&gt;flags.process_response_queue
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* TEST ZIO:&n;&t;&t; *&n;&t;&t; * icb-&gt;add_firmware_options[0] &amp;=&n;&t;&t; *    ~(BIT_3 | BIT_2 | BIT_1 | BIT_0);&n;&t;&t; * icb-&gt;add_firmware_options[0] |= (BIT_2 | BIT_0);&n;&t;&t; */
id|timer_mode
op_assign
id|icb-&gt;add_firmware_options
(braket
l_int|0
)braket
op_amp
(paren
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_mode
op_eq
l_int|5
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): ZIO enabled; timer delay &quot;
l_string|&quot;(%d).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|ql2xintrdelaytimer
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;ZIO enabled; timer delay (%d).&bslash;n&quot;
comma
id|ql2xintrdelaytimer
)paren
suffix:semicolon
id|icb-&gt;interrupt_delay_timer
op_assign
id|ql2xintrdelaytimer
suffix:semicolon
id|ha-&gt;flags.process_response_queue
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(%ld): NVRAM configuration failed!&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;* qla2x00_init_tgt_map&n;*      Initializes target map.&n;*&n;* Input:&n;*      ha = adapter block pointer.&n;*&n;* Output:&n;*      TGT_Q initialized&n;*/
r_static
r_void
DECL|function|qla2x00_init_tgt_map
id|qla2x00_init_tgt_map
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint32
id|t
suffix:semicolon
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_TARGETS
suffix:semicolon
id|t
op_increment
)paren
id|TGT_Q
c_func
(paren
id|ha
comma
id|t
)paren
op_assign
(paren
id|os_tgt_t
op_star
)paren
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_alloc_fcport() - Allocate a generic fcport.&n; * @ha: HA context&n; * @flags: allocation flags&n; *&n; * Returns a pointer to the allocated fcport, or NULL, if none available.&n; */
id|fc_port_t
op_star
DECL|function|qla2x00_alloc_fcport
id|qla2x00_alloc_fcport
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_int
id|flags
)paren
(brace
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|fcport
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|fc_port_t
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fcport
op_eq
l_int|NULL
)paren
r_return
(paren
id|fcport
)paren
suffix:semicolon
multiline_comment|/* Setup fcport template structure. */
id|memset
c_func
(paren
id|fcport
comma
l_int|0
comma
r_sizeof
(paren
id|fc_port_t
)paren
)paren
suffix:semicolon
id|fcport-&gt;ha
op_assign
id|ha
suffix:semicolon
id|fcport-&gt;port_type
op_assign
id|FCT_UNKNOWN
suffix:semicolon
id|fcport-&gt;loop_id
op_assign
id|FC_NO_LOOP_ID
suffix:semicolon
id|fcport-&gt;iodesc_idx_sent
op_assign
id|IODESC_INVALID_INDEX
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_UNCONFIGURED
)paren
suffix:semicolon
id|fcport-&gt;flags
op_assign
id|FCF_RLC_SUPPORT
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|fcport-&gt;fcluns
)paren
suffix:semicolon
r_return
(paren
id|fcport
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_configure_loop&n; *      Updates Fibre Channel Device Database with what is actually on loop.&n; *&n; * Input:&n; *      ha                = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success.&n; *      1 = error.&n; *      2 = database was full and device was not configured.&n; */
r_static
r_int
DECL|function|qla2x00_configure_loop
id|qla2x00_configure_loop
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_int
r_int
id|flags
comma
id|save_flags
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
multiline_comment|/* Get Initiator ID */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|LOCAL_LOOP_UPDATE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
id|rval
op_assign
id|qla2x00_configure_hba
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Unable to configure HBA.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
)brace
id|save_flags
op_assign
id|flags
op_assign
id|ha-&gt;dpc_flags
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Configure loop -- dpc flags =0x%lx&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|flags
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we have both an RSCN and PORT UPDATE pending then handle them&n;&t; * both at the same time.&n;&t; */
id|clear_bit
c_func
(paren
id|LOCAL_LOOP_UPDATE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|RSCN_UPDATE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|ha-&gt;mem_err
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Determine what we need to do */
r_if
c_cond
(paren
id|ha-&gt;current_topology
op_eq
id|ISP_CFG_FL
op_logical_and
(paren
id|test_bit
c_func
(paren
id|LOCAL_LOOP_UPDATE
comma
op_amp
id|flags
)paren
)paren
)paren
(brace
id|ha-&gt;flags.rscn_queue_overflow
op_assign
id|TRUE
suffix:semicolon
id|set_bit
c_func
(paren
id|RSCN_UPDATE
comma
op_amp
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ha-&gt;current_topology
op_eq
id|ISP_CFG_F
op_logical_and
(paren
id|test_bit
c_func
(paren
id|LOCAL_LOOP_UPDATE
comma
op_amp
id|flags
)paren
)paren
)paren
(brace
id|ha-&gt;flags.rscn_queue_overflow
op_assign
id|TRUE
suffix:semicolon
id|set_bit
c_func
(paren
id|RSCN_UPDATE
comma
op_amp
id|flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|LOCAL_LOOP_UPDATE
comma
op_amp
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.online
op_logical_or
(paren
id|test_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|flags
)paren
)paren
)paren
(brace
id|ha-&gt;flags.rscn_queue_overflow
op_assign
id|TRUE
suffix:semicolon
id|set_bit
c_func
(paren
id|RSCN_UPDATE
comma
op_amp
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|LOCAL_LOOP_UPDATE
comma
op_amp
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|LOCAL_LOOP_UPDATE
comma
op_amp
id|flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
id|rval
op_assign
id|qla2x00_configure_local_loop
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
op_logical_and
id|test_bit
c_func
(paren
id|RSCN_UPDATE
comma
op_amp
id|flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
id|rval
op_assign
id|qla2x00_configure_fabric
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_or
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
id|qla2x00_config_os
c_func
(paren
id|ha
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_READY
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): LOOP READY&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): *** FAILED ***&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s: exiting normally&bslash;n&quot;
comma
id|__func__
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Restore state if a resync event occured during processing */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|LOCAL_LOOP_UPDATE
comma
op_amp
id|save_flags
)paren
)paren
id|set_bit
c_func
(paren
id|LOCAL_LOOP_UPDATE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|RSCN_UPDATE
comma
op_amp
id|save_flags
)paren
)paren
id|set_bit
c_func
(paren
id|RSCN_UPDATE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_configure_local_loop&n; *&t;Updates Fibre Channel Device Database with local loop devices.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&n; * Returns:&n; *&t;0 = success.&n; */
r_static
r_int
DECL|function|qla2x00_configure_local_loop
id|qla2x00_configure_local_loop
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
comma
id|rval2
suffix:semicolon
r_int
id|found_devs
suffix:semicolon
r_int
id|found
suffix:semicolon
id|fc_port_t
op_star
id|fcport
comma
op_star
id|new_fcport
suffix:semicolon
r_uint16
id|index
suffix:semicolon
r_uint16
id|entries
suffix:semicolon
r_struct
id|dev_id
(brace
r_uint8
id|al_pa
suffix:semicolon
r_uint8
id|area
suffix:semicolon
r_uint8
id|domain
suffix:semicolon
r_uint8
id|loop_id_2100
suffix:semicolon
multiline_comment|/* ISP2100/ISP2200 -- 4 bytes. */
r_uint16
id|loop_id
suffix:semicolon
multiline_comment|/* ISP23XX         -- 6 bytes. */
)brace
op_star
id|id_list
suffix:semicolon
DECL|macro|MAX_ID_LIST_SIZE
mdefine_line|#define MAX_ID_LIST_SIZE (sizeof(struct dev_id) * MAX_FIBRE_DEVICES)
id|dma_addr_t
id|id_list_dma
suffix:semicolon
r_char
op_star
id|id_iter
suffix:semicolon
r_uint16
id|loop_id
suffix:semicolon
r_uint8
id|domain
comma
id|area
comma
id|al_pa
suffix:semicolon
id|found_devs
op_assign
l_int|0
suffix:semicolon
id|new_fcport
op_assign
l_int|NULL
suffix:semicolon
id|entries
op_assign
id|MAX_FIBRE_DEVICES
suffix:semicolon
id|id_list
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ha-&gt;pdev
comma
id|MAX_ID_LIST_SIZE
comma
op_amp
id|id_list_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id_list
op_eq
l_int|NULL
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Failed to allocate memory, No local &quot;
l_string|&quot;loop&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - port_list&quot;
)paren
suffix:semicolon
id|ha-&gt;mem_err
op_increment
suffix:semicolon
r_return
(paren
id|QLA_MEMORY_ALLOC_FAILED
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|id_list
comma
l_int|0
comma
id|MAX_ID_LIST_SIZE
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Getting FCAL position map&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|qla2x00_get_fcal_position_map
c_func
(paren
id|ha
comma
l_int|NULL
)paren
)paren
suffix:semicolon
multiline_comment|/* Get list of logged in devices. */
id|rval
op_assign
id|qla2x00_get_id_list
c_func
(paren
id|ha
comma
id|id_list
comma
id|id_list_dma
comma
op_amp
id|entries
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
r_goto
id|cleanup_allocation
suffix:semicolon
)brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Entries in ID list (%d)&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|entries
)paren
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
id|id_list
comma
id|entries
op_star
r_sizeof
(paren
r_struct
id|dev_id
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Allocate temporary fcport for any new fcports discovered. */
id|new_fcport
op_assign
id|qla2x00_alloc_fcport
c_func
(paren
id|ha
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_fcport
op_eq
l_int|NULL
)paren
(brace
id|rval
op_assign
id|QLA_MEMORY_ALLOC_FAILED
suffix:semicolon
r_goto
id|cleanup_allocation
suffix:semicolon
)brace
id|new_fcport-&gt;flags
op_and_assign
op_complement
id|FCF_FABRIC_DEVICE
suffix:semicolon
multiline_comment|/*&n;&t; * Mark local devices that were present with FCF_DEVICE_LOST for now.&n;&t; */
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_ONLINE
op_logical_and
id|fcport-&gt;port_type
op_ne
id|FCT_BROADCAST
op_logical_and
(paren
id|fcport-&gt;flags
op_amp
id|FCF_FABRIC_DEVICE
)paren
op_eq
l_int|0
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Marking port lost, &quot;
l_string|&quot;loop_id=0x%04x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;loop_id
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_DEVICE_LOST
)paren
suffix:semicolon
id|fcport-&gt;flags
op_and_assign
op_complement
id|FCF_FARP_DONE
suffix:semicolon
)brace
)brace
multiline_comment|/* Add devices to port list. */
id|id_iter
op_assign
(paren
r_char
op_star
)paren
id|id_list
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|entries
suffix:semicolon
id|index
op_increment
)paren
(brace
id|domain
op_assign
(paren
(paren
r_struct
id|dev_id
op_star
)paren
id|id_iter
)paren
op_member_access_from_pointer
id|domain
suffix:semicolon
id|area
op_assign
(paren
(paren
r_struct
id|dev_id
op_star
)paren
id|id_iter
)paren
op_member_access_from_pointer
id|area
suffix:semicolon
id|al_pa
op_assign
(paren
(paren
r_struct
id|dev_id
op_star
)paren
id|id_iter
)paren
op_member_access_from_pointer
id|al_pa
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
id|loop_id
op_assign
(paren
r_uint16
)paren
(paren
(paren
r_struct
id|dev_id
op_star
)paren
id|id_iter
)paren
op_member_access_from_pointer
id|loop_id_2100
suffix:semicolon
id|id_iter
op_add_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|loop_id
op_assign
id|le16_to_cpu
c_func
(paren
(paren
(paren
r_struct
id|dev_id
op_star
)paren
id|id_iter
)paren
op_member_access_from_pointer
id|loop_id
)paren
suffix:semicolon
id|id_iter
op_add_assign
l_int|6
suffix:semicolon
)brace
multiline_comment|/* Bypass reserved domain fields. */
r_if
c_cond
(paren
(paren
id|domain
op_amp
l_int|0xf0
)paren
op_eq
l_int|0xf0
)paren
r_continue
suffix:semicolon
multiline_comment|/* Bypass if not same domain and area of adapter. */
r_if
c_cond
(paren
id|area
op_ne
id|ha-&gt;d_id.b.area
op_logical_or
id|domain
op_ne
id|ha-&gt;d_id.b.domain
)paren
r_continue
suffix:semicolon
multiline_comment|/* Bypass invalid local loop ID. */
r_if
c_cond
(paren
id|loop_id
OG
id|LAST_LOCAL_LOOP_ID
)paren
r_continue
suffix:semicolon
multiline_comment|/* Fill in member data. */
id|new_fcport-&gt;d_id.b.domain
op_assign
id|domain
suffix:semicolon
id|new_fcport-&gt;d_id.b.area
op_assign
id|area
suffix:semicolon
id|new_fcport-&gt;d_id.b.al_pa
op_assign
id|al_pa
suffix:semicolon
id|new_fcport-&gt;loop_id
op_assign
id|loop_id
suffix:semicolon
id|rval2
op_assign
id|qla2x00_get_port_database
c_func
(paren
id|ha
comma
id|new_fcport
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval2
op_ne
id|QLA_SUCCESS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Failed to retrieve fcport &quot;
l_string|&quot;information -- get_port_database=%x, &quot;
l_string|&quot;loop_id=0x%04x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval2
comma
id|new_fcport-&gt;loop_id
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Check for matching device in port list. */
id|found
op_assign
l_int|0
suffix:semicolon
id|fcport
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|new_fcport-&gt;port_name
comma
id|fcport-&gt;port_name
comma
id|WWN_SIZE
)paren
)paren
r_continue
suffix:semicolon
id|fcport-&gt;flags
op_and_assign
op_complement
(paren
id|FCF_FABRIC_DEVICE
op_or
id|FCF_PERSISTENT_BOUND
)paren
suffix:semicolon
id|fcport-&gt;loop_id
op_assign
id|new_fcport-&gt;loop_id
suffix:semicolon
id|fcport-&gt;port_type
op_assign
id|new_fcport-&gt;port_type
suffix:semicolon
id|fcport-&gt;d_id.b24
op_assign
id|new_fcport-&gt;d_id.b24
suffix:semicolon
id|memcpy
c_func
(paren
id|fcport-&gt;node_name
comma
id|new_fcport-&gt;node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|found
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
multiline_comment|/* New device, add to fcports list. */
id|new_fcport-&gt;flags
op_and_assign
op_complement
id|FCF_PERSISTENT_BOUND
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|new_fcport-&gt;list
comma
op_amp
id|ha-&gt;fcports
)paren
suffix:semicolon
multiline_comment|/* Allocate a new replacement fcport. */
id|fcport
op_assign
id|new_fcport
suffix:semicolon
id|new_fcport
op_assign
id|qla2x00_alloc_fcport
c_func
(paren
id|ha
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_fcport
op_eq
l_int|NULL
)paren
(brace
id|rval
op_assign
id|QLA_MEMORY_ALLOC_FAILED
suffix:semicolon
r_goto
id|cleanup_allocation
suffix:semicolon
)brace
id|new_fcport-&gt;flags
op_and_assign
op_complement
id|FCF_FABRIC_DEVICE
suffix:semicolon
)brace
id|qla2x00_update_fcport
c_func
(paren
id|ha
comma
id|fcport
)paren
suffix:semicolon
id|found_devs
op_increment
suffix:semicolon
)brace
id|cleanup_allocation
suffix:colon
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
id|MAX_ID_LIST_SIZE
comma
id|id_list
comma
id|id_list_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_fcport
)paren
id|kfree
c_func
(paren
id|new_fcport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Configure local loop error exit: &quot;
l_string|&quot;rval=%x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found_devs
)paren
(brace
id|ha-&gt;device_flags
op_or_assign
id|DFLG_LOCAL_DEVICES
suffix:semicolon
id|ha-&gt;device_flags
op_and_assign
op_complement
id|DFLG_RETRY_LOCAL_DEVICES
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|qla2x00_probe_for_all_luns
id|qla2x00_probe_for_all_luns
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|qla2x00_mark_all_devices_lost
c_func
(paren
id|ha
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|fcport-&gt;port_type
op_ne
id|FCT_TARGET
)paren
r_continue
suffix:semicolon
id|qla2x00_update_fcport
c_func
(paren
id|ha
comma
id|fcport
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * qla2x00_update_fcport&n; *&t;Updates device on list.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;fcport = port structure pointer.&n; *&n; * Return:&n; *&t;0  - Success&n; *  BIT_0 - error&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_void
DECL|function|qla2x00_update_fcport
id|qla2x00_update_fcport
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
)paren
(brace
r_uint16
id|index
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
id|fcport-&gt;ha
op_assign
id|ha
suffix:semicolon
id|fcport-&gt;login_retry
op_assign
l_int|0
suffix:semicolon
id|fcport-&gt;port_login_retry_count
op_assign
id|ha-&gt;port_down_retry_count
op_star
id|PORT_RETRY_TIME
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;port_down_timer
comma
id|ha-&gt;port_down_retry_count
op_star
id|PORT_RETRY_TIME
)paren
suffix:semicolon
id|fcport-&gt;flags
op_and_assign
op_complement
id|FCF_LOGIN_NEEDED
suffix:semicolon
multiline_comment|/*&n;&t; * Check for outstanding cmd on tape Bypass LUN discovery if active&n;&t; * command on tape.&n;&t; */
r_if
c_cond
(paren
id|fcport-&gt;flags
op_amp
id|FCF_TAPE_PRESENT
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|1
suffix:semicolon
id|index
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|index
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|index
)braket
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;fclun-&gt;fcport
op_eq
id|fcport
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_ONLINE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Do LUN discovery. */
r_if
c_cond
(paren
id|fcport-&gt;port_type
op_eq
id|FCT_INITIATOR
op_logical_or
id|fcport-&gt;port_type
op_eq
id|FCT_BROADCAST
)paren
(brace
id|fcport-&gt;device_type
op_assign
id|TYPE_PROCESSOR
suffix:semicolon
)brace
r_else
(brace
id|qla2x00_lun_discovery
c_func
(paren
id|ha
comma
id|fcport
)paren
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_ONLINE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_lun_discovery&n; *&t;Issue SCSI inquiry command for LUN discovery.&n; *&n; * Input:&n; *&t;ha:&t;&t;adapter state pointer.&n; *&t;fcport:&t;&t;FC port structure pointer.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_void
DECL|function|qla2x00_lun_discovery
id|qla2x00_lun_discovery
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
)paren
(brace
id|inq_cmd_rsp_t
op_star
id|inq
suffix:semicolon
id|dma_addr_t
id|inq_dma
suffix:semicolon
r_uint16
id|lun
suffix:semicolon
id|inq
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ha-&gt;pdev
comma
r_sizeof
(paren
id|inq_cmd_rsp_t
)paren
comma
op_amp
id|inq_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inq
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - INQ&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* If report LUN works, exit. */
r_if
c_cond
(paren
id|qla2x00_rpt_lun_discovery
c_func
(paren
id|ha
comma
id|fcport
comma
id|inq
comma
id|inq_dma
)paren
op_ne
id|QLA_SUCCESS
)paren
(brace
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
id|ha-&gt;max_probe_luns
suffix:semicolon
id|lun
op_increment
)paren
(brace
multiline_comment|/* Configure LUN. */
id|qla2x00_cfg_lun
c_func
(paren
id|ha
comma
id|fcport
comma
id|lun
comma
id|inq
comma
id|inq_dma
)paren
suffix:semicolon
)brace
)brace
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
r_sizeof
(paren
id|inq_cmd_rsp_t
)paren
comma
id|inq
comma
id|inq_dma
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_rpt_lun_discovery&n; *&t;Issue SCSI report LUN command for LUN discovery.&n; *&n; * Input:&n; *&t;ha:&t;&t;adapter state pointer.&n; *&t;fcport:&t;&t;FC port structure pointer.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_int
DECL|function|qla2x00_rpt_lun_discovery
id|qla2x00_rpt_lun_discovery
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
comma
id|inq_cmd_rsp_t
op_star
id|inq
comma
id|dma_addr_t
id|inq_dma
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint32
id|len
comma
id|cnt
suffix:semicolon
r_uint16
id|lun
suffix:semicolon
id|rpt_lun_cmd_rsp_t
op_star
id|rlc
suffix:semicolon
id|dma_addr_t
id|rlc_dma
suffix:semicolon
multiline_comment|/* Assume a failed status */
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
multiline_comment|/* No point in continuing if the device doesn&squot;t support RLC */
r_if
c_cond
(paren
(paren
id|fcport-&gt;flags
op_amp
id|FCF_RLC_SUPPORT
)paren
op_eq
l_int|0
)paren
r_return
(paren
id|rval
)paren
suffix:semicolon
id|rlc
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ha-&gt;pdev
comma
r_sizeof
(paren
id|rpt_lun_cmd_rsp_t
)paren
comma
op_amp
id|rlc_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rlc
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Memory Allocation failed - RLC&quot;
)paren
suffix:semicolon
r_return
id|QLA_MEMORY_ALLOC_FAILED
suffix:semicolon
)brace
id|rval
op_assign
id|qla2x00_report_lun
c_func
(paren
id|ha
comma
id|fcport
comma
id|rlc
comma
id|rlc_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
r_sizeof
(paren
id|rpt_lun_cmd_rsp_t
)paren
comma
id|rlc
comma
id|rlc_dma
)paren
suffix:semicolon
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/* Always add a fc_lun_t structure for lun 0 -- mid-layer requirement */
id|qla2x00_add_lun
c_func
(paren
id|fcport
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Configure LUN list. */
id|len
op_assign
id|be32_to_cpu
c_func
(paren
id|rlc-&gt;list.hdr.len
)paren
suffix:semicolon
id|len
op_div_assign
l_int|8
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|len
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|lun
op_assign
id|CHAR_TO_SHORT
c_func
(paren
id|rlc-&gt;list.lst
(braket
id|cnt
)braket
dot
id|lsb
comma
id|rlc-&gt;list.lst
(braket
id|cnt
)braket
dot
id|msb.b
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RLC lun = (%d)&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|lun
)paren
)paren
suffix:semicolon
multiline_comment|/* We only support 0 through MAX_LUNS-1 range */
r_if
c_cond
(paren
id|lun
OL
id|MAX_LUNS
)paren
(brace
id|qla2x00_cfg_lun
c_func
(paren
id|ha
comma
id|fcport
comma
id|lun
comma
id|inq
comma
id|inq_dma
)paren
suffix:semicolon
)brace
)brace
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_ONLINE
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
r_sizeof
(paren
id|rpt_lun_cmd_rsp_t
)paren
comma
id|rlc
comma
id|rlc_dma
)paren
suffix:semicolon
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_report_lun&n; *&t;Issue SCSI report LUN command.&n; *&n; * Input:&n; *&t;ha:&t;&t;adapter state pointer.&n; *&t;fcport:&t;&t;FC port structure pointer.&n; *&t;mem:&t;&t;pointer to dma memory object for report LUN IOCB&n; *&t;&t;&t;packet.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_int
DECL|function|qla2x00_report_lun
id|qla2x00_report_lun
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
comma
id|rpt_lun_cmd_rsp_t
op_star
id|rlc
comma
id|dma_addr_t
id|rlc_dma
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint16
id|retries
suffix:semicolon
r_uint16
id|comp_status
suffix:semicolon
r_uint16
id|scsi_status
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
r_for
c_loop
(paren
id|retries
op_assign
l_int|3
suffix:semicolon
id|retries
suffix:semicolon
id|retries
op_decrement
)paren
(brace
id|memset
c_func
(paren
id|rlc
comma
l_int|0
comma
r_sizeof
(paren
id|rpt_lun_cmd_rsp_t
)paren
)paren
suffix:semicolon
id|rlc-&gt;p.cmd.entry_type
op_assign
id|COMMAND_A64_TYPE
suffix:semicolon
id|rlc-&gt;p.cmd.entry_count
op_assign
l_int|1
suffix:semicolon
id|SET_TARGET_ID
c_func
(paren
id|ha
comma
id|rlc-&gt;p.cmd.target
comma
id|fcport-&gt;loop_id
)paren
suffix:semicolon
id|rlc-&gt;p.cmd.control_flags
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|CF_READ
op_or
id|CF_SIMPLE_TAG
)paren
suffix:semicolon
id|rlc-&gt;p.cmd.scsi_cdb
(braket
l_int|0
)braket
op_assign
id|REPORT_LUNS
suffix:semicolon
id|rlc-&gt;p.cmd.scsi_cdb
(braket
l_int|8
)braket
op_assign
id|MSB
c_func
(paren
r_sizeof
(paren
id|rpt_lun_lst_t
)paren
)paren
suffix:semicolon
id|rlc-&gt;p.cmd.scsi_cdb
(braket
l_int|9
)braket
op_assign
id|LSB
c_func
(paren
r_sizeof
(paren
id|rpt_lun_lst_t
)paren
)paren
suffix:semicolon
id|rlc-&gt;p.cmd.dseg_count
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|rlc-&gt;p.cmd.timeout
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|rlc-&gt;p.cmd.byte_count
op_assign
id|__constant_cpu_to_le32
c_func
(paren
r_sizeof
(paren
id|rpt_lun_lst_t
)paren
)paren
suffix:semicolon
id|rlc-&gt;p.cmd.dseg_0_address
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|LSD
c_func
(paren
id|rlc_dma
op_plus
r_sizeof
(paren
id|sts_entry_t
)paren
)paren
)paren
suffix:semicolon
id|rlc-&gt;p.cmd.dseg_0_address
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MSD
c_func
(paren
id|rlc_dma
op_plus
r_sizeof
(paren
id|sts_entry_t
)paren
)paren
)paren
suffix:semicolon
id|rlc-&gt;p.cmd.dseg_0_length
op_assign
id|__constant_cpu_to_le32
c_func
(paren
r_sizeof
(paren
id|rpt_lun_lst_t
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_issue_iocb
c_func
(paren
id|ha
comma
id|rlc
comma
id|rlc_dma
comma
r_sizeof
(paren
id|rpt_lun_cmd_rsp_t
)paren
)paren
suffix:semicolon
id|comp_status
op_assign
id|le16_to_cpu
c_func
(paren
id|rlc-&gt;p.rsp.comp_status
)paren
suffix:semicolon
id|scsi_status
op_assign
id|le16_to_cpu
c_func
(paren
id|rlc-&gt;p.rsp.scsi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
op_logical_or
id|comp_status
op_ne
id|CS_COMPLETE
op_logical_or
id|scsi_status
op_amp
id|SS_CHECK_CONDITION
)paren
(brace
multiline_comment|/* Device underrun, treat as OK. */
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
op_logical_and
id|comp_status
op_eq
id|CS_DATA_UNDERRUN
op_logical_and
id|scsi_status
op_amp
id|SS_RESIDUAL_UNDER
)paren
(brace
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RLC failed to issue iocb! &quot;
l_string|&quot;fcport=[%04x/%p] rval=%x cs=%x ss=%x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;loop_id
comma
id|fcport
comma
id|rval
comma
id|comp_status
comma
id|scsi_status
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
r_if
c_cond
(paren
id|scsi_status
op_amp
id|SS_CHECK_CONDITION
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RLC &quot;
l_string|&quot;SS_CHECK_CONDITION Sense Data &quot;
l_string|&quot;%02x %02x %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rlc-&gt;p.rsp.req_sense_data
(braket
l_int|0
)braket
comma
id|rlc-&gt;p.rsp.req_sense_data
(braket
l_int|1
)braket
comma
id|rlc-&gt;p.rsp.req_sense_data
(braket
l_int|2
)braket
comma
id|rlc-&gt;p.rsp.req_sense_data
(braket
l_int|3
)braket
comma
id|rlc-&gt;p.rsp.req_sense_data
(braket
l_int|4
)braket
comma
id|rlc-&gt;p.rsp.req_sense_data
(braket
l_int|5
)braket
comma
id|rlc-&gt;p.rsp.req_sense_data
(braket
l_int|6
)braket
comma
id|rlc-&gt;p.rsp.req_sense_data
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rlc-&gt;p.rsp.req_sense_data
(braket
l_int|2
)braket
op_eq
id|ILLEGAL_REQUEST
)paren
(brace
id|fcport-&gt;flags
op_and_assign
op_complement
(paren
id|FCF_RLC_SUPPORT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_cfg_lun&n; *&t;Configures LUN into fcport LUN list.&n; *&n; * Input:&n; *&t;fcport:&t;&t;FC port structure pointer.&n; *&t;lun:&t;&t;LUN number.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
id|fc_lun_t
op_star
DECL|function|qla2x00_cfg_lun
id|qla2x00_cfg_lun
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
comma
r_uint16
id|lun
comma
id|inq_cmd_rsp_t
op_star
id|inq
comma
id|dma_addr_t
id|inq_dma
)paren
(brace
id|fc_lun_t
op_star
id|fclun
suffix:semicolon
multiline_comment|/* Bypass LUNs that failed. */
r_if
c_cond
(paren
id|qla2x00_inquiry
c_func
(paren
id|ha
comma
id|fcport
comma
id|lun
comma
id|inq
comma
id|inq_dma
)paren
op_ne
id|QLA_SUCCESS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Failed inquiry - loop id=0x%04x &quot;
l_string|&quot;lun=%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;loop_id
comma
id|lun
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|inq-&gt;inq
(braket
l_int|0
)braket
)paren
(brace
r_case
id|TYPE_DISK
suffix:colon
r_case
id|TYPE_PROCESSOR
suffix:colon
r_case
id|TYPE_WORM
suffix:colon
r_case
id|TYPE_ROM
suffix:colon
r_case
id|TYPE_SCANNER
suffix:colon
r_case
id|TYPE_MOD
suffix:colon
r_case
id|TYPE_MEDIUM_CHANGER
suffix:colon
r_case
id|TYPE_ENCLOSURE
suffix:colon
r_case
l_int|0x20
suffix:colon
r_case
l_int|0x0C
suffix:colon
r_break
suffix:semicolon
r_case
id|TYPE_TAPE
suffix:colon
id|fcport-&gt;flags
op_or_assign
id|FCF_TAPE_PRESENT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Unsupported lun type -- &quot;
l_string|&quot;loop id=0x%04x lun=%d type=%x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;loop_id
comma
id|lun
comma
id|inq-&gt;inq
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|fcport-&gt;device_type
op_assign
id|inq-&gt;inq
(braket
l_int|0
)braket
suffix:semicolon
id|fclun
op_assign
id|qla2x00_add_lun
c_func
(paren
id|fcport
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fclun
op_ne
l_int|NULL
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_ONLINE
)paren
suffix:semicolon
)brace
r_return
(paren
id|fclun
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_add_lun&n; *&t;Adds LUN to database&n; *&n; * Input:&n; *&t;fcport:&t;&t;FC port structure pointer.&n; *&t;lun:&t;&t;LUN number.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
id|fc_lun_t
op_star
DECL|function|qla2x00_add_lun
id|qla2x00_add_lun
c_func
(paren
id|fc_port_t
op_star
id|fcport
comma
r_uint16
id|lun
)paren
(brace
r_int
id|found
suffix:semicolon
id|fc_lun_t
op_star
id|fclun
suffix:semicolon
r_if
c_cond
(paren
id|fcport
op_eq
l_int|NULL
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi: Unable to add lun to NULL port&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Allocate LUN if not already allocated. */
id|found
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fclun
comma
op_amp
id|fcport-&gt;fcluns
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|fclun-&gt;lun
op_eq
id|lun
)paren
(brace
id|found
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|found
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|fclun
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|fc_lun_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fclun
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s(): Memory Allocation failed - FCLUN&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup LUN structure. */
id|memset
c_func
(paren
id|fclun
comma
l_int|0
comma
r_sizeof
(paren
id|fc_lun_t
)paren
)paren
suffix:semicolon
id|fclun-&gt;lun
op_assign
id|lun
suffix:semicolon
id|fclun-&gt;fcport
op_assign
id|fcport
suffix:semicolon
id|fclun-&gt;o_fcport
op_assign
id|fcport
suffix:semicolon
id|fclun-&gt;device_type
op_assign
id|fcport-&gt;device_type
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_UNCONFIGURED
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|fclun-&gt;list
comma
op_amp
id|fcport-&gt;fcluns
)paren
suffix:semicolon
r_return
(paren
id|fclun
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_inquiry&n; *&t;Issue SCSI inquiry command.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;fcport = FC port structure pointer.&n; *&n; * Return:&n; *&t;0  - Success&n; *  BIT_0 - error&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_int
DECL|function|qla2x00_inquiry
id|qla2x00_inquiry
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
comma
r_uint16
id|lun
comma
id|inq_cmd_rsp_t
op_star
id|inq
comma
id|dma_addr_t
id|inq_dma
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint16
id|retries
suffix:semicolon
r_uint16
id|comp_status
suffix:semicolon
r_uint16
id|scsi_status
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
r_for
c_loop
(paren
id|retries
op_assign
l_int|3
suffix:semicolon
id|retries
suffix:semicolon
id|retries
op_decrement
)paren
(brace
id|memset
c_func
(paren
id|inq
comma
l_int|0
comma
r_sizeof
(paren
id|inq_cmd_rsp_t
)paren
)paren
suffix:semicolon
id|inq-&gt;p.cmd.entry_type
op_assign
id|COMMAND_A64_TYPE
suffix:semicolon
id|inq-&gt;p.cmd.entry_count
op_assign
l_int|1
suffix:semicolon
id|inq-&gt;p.cmd.lun
op_assign
id|cpu_to_le16
c_func
(paren
id|lun
)paren
suffix:semicolon
id|SET_TARGET_ID
c_func
(paren
id|ha
comma
id|inq-&gt;p.cmd.target
comma
id|fcport-&gt;loop_id
)paren
suffix:semicolon
id|inq-&gt;p.cmd.control_flags
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|CF_READ
op_or
id|CF_SIMPLE_TAG
)paren
suffix:semicolon
id|inq-&gt;p.cmd.scsi_cdb
(braket
l_int|0
)braket
op_assign
id|INQUIRY
suffix:semicolon
id|inq-&gt;p.cmd.scsi_cdb
(braket
l_int|4
)braket
op_assign
id|INQ_DATA_SIZE
suffix:semicolon
id|inq-&gt;p.cmd.dseg_count
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|inq-&gt;p.cmd.timeout
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|inq-&gt;p.cmd.byte_count
op_assign
id|__constant_cpu_to_le32
c_func
(paren
id|INQ_DATA_SIZE
)paren
suffix:semicolon
id|inq-&gt;p.cmd.dseg_0_address
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|LSD
c_func
(paren
id|inq_dma
op_plus
r_sizeof
(paren
id|sts_entry_t
)paren
)paren
)paren
suffix:semicolon
id|inq-&gt;p.cmd.dseg_0_address
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MSD
c_func
(paren
id|inq_dma
op_plus
r_sizeof
(paren
id|sts_entry_t
)paren
)paren
)paren
suffix:semicolon
id|inq-&gt;p.cmd.dseg_0_length
op_assign
id|__constant_cpu_to_le32
c_func
(paren
id|INQ_DATA_SIZE
)paren
suffix:semicolon
id|DEBUG5
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Lun Inquiry - fcport=[%04x/%p],&quot;
l_string|&quot; lun (%d)&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;loop_id
comma
id|fcport
comma
id|lun
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_issue_iocb
c_func
(paren
id|ha
comma
id|inq
comma
id|inq_dma
comma
r_sizeof
(paren
id|inq_cmd_rsp_t
)paren
)paren
suffix:semicolon
id|comp_status
op_assign
id|le16_to_cpu
c_func
(paren
id|inq-&gt;p.rsp.comp_status
)paren
suffix:semicolon
id|scsi_status
op_assign
id|le16_to_cpu
c_func
(paren
id|inq-&gt;p.rsp.scsi_status
)paren
suffix:semicolon
id|DEBUG5
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): lun (%d) inquiry - &quot;
l_string|&quot;inq[0]= 0x%x, comp status 0x%x, scsi status 0x%x, &quot;
l_string|&quot;rval=%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|lun
comma
id|inq-&gt;inq
(braket
l_int|0
)braket
comma
id|comp_status
comma
id|scsi_status
comma
id|rval
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
op_logical_or
id|comp_status
op_ne
id|CS_COMPLETE
op_logical_or
id|scsi_status
op_amp
id|SS_CHECK_CONDITION
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): INQ failed to issue iocb! &quot;
l_string|&quot;fcport=[%04x/%p] rval=%x cs=%x ss=%x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;loop_id
comma
id|fcport
comma
id|rval
comma
id|comp_status
comma
id|scsi_status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
r_if
c_cond
(paren
id|scsi_status
op_amp
id|SS_CHECK_CONDITION
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): INQ &quot;
l_string|&quot;SS_CHECK_CONDITION Sense Data &quot;
l_string|&quot;%02x %02x %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|inq-&gt;p.rsp.req_sense_data
(braket
l_int|0
)braket
comma
id|inq-&gt;p.rsp.req_sense_data
(braket
l_int|1
)braket
comma
id|inq-&gt;p.rsp.req_sense_data
(braket
l_int|2
)braket
comma
id|inq-&gt;p.rsp.req_sense_data
(braket
l_int|3
)braket
comma
id|inq-&gt;p.rsp.req_sense_data
(braket
l_int|4
)braket
comma
id|inq-&gt;p.rsp.req_sense_data
(braket
l_int|5
)braket
comma
id|inq-&gt;p.rsp.req_sense_data
(braket
l_int|6
)braket
comma
id|inq-&gt;p.rsp.req_sense_data
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Device underrun drop LUN. */
r_if
c_cond
(paren
id|comp_status
op_eq
id|CS_DATA_UNDERRUN
op_logical_and
id|scsi_status
op_amp
id|SS_RESIDUAL_UNDER
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_configure_fabric&n; *      Setup SNS devices with loop ID&squot;s.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success.&n; *      BIT_0 = error&n; */
r_static
r_int
DECL|function|qla2x00_configure_fabric
id|qla2x00_configure_fabric
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
comma
id|rval2
suffix:semicolon
id|fc_port_t
op_star
id|fcport
comma
op_star
id|fcptemp
suffix:semicolon
r_uint16
id|next_loopid
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|new_fcports
)paren
suffix:semicolon
multiline_comment|/* If FL port exists, then SNS is present */
id|rval
op_assign
id|qla2x00_get_port_name
c_func
(paren
id|ha
comma
id|SNS_FL_PORT
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): MBC_GET_PORT_NAME Failed, No FL &quot;
l_string|&quot;Port&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|ha-&gt;device_flags
op_and_assign
op_complement
id|SWITCH_FOUND
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
multiline_comment|/* Mark devices that need re-synchronization. */
id|rval2
op_assign
id|qla2x00_device_resync
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval2
op_eq
id|QLA_RSCNS_HANDLED
)paren
(brace
multiline_comment|/* No point doing the scan, just continue. */
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
r_do
(brace
multiline_comment|/* Ensure we are logged into the SNS. */
id|qla2x00_login_fabric
c_func
(paren
id|ha
comma
id|SIMPLE_NAME_SERVER
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xfc
comma
id|mb
comma
id|BIT_0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
l_int|0
)braket
op_ne
id|MBS_COMMAND_COMPLETE
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Failed SNS login: loop_id=%x mb[0]=%x mb[1]=%x &quot;
l_string|&quot;mb[2]=%x mb[6]=%x mb[7]=%x&bslash;n&quot;
comma
id|SIMPLE_NAME_SERVER
comma
id|mb
(braket
l_int|0
)braket
comma
id|mb
(braket
l_int|1
)braket
comma
id|mb
(braket
l_int|2
)braket
comma
id|mb
(braket
l_int|6
)braket
comma
id|mb
(braket
l_int|7
)braket
)paren
suffix:semicolon
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|REGISTER_FC4_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|qla2x00_rft_id
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* EMPTY */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Register FC-4 &quot;
l_string|&quot;TYPE failed.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qla2x00_rff_id
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* EMPTY */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Register FC-4 &quot;
l_string|&quot;Features failed.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qla2x00_rnn_id
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* EMPTY */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Register Node Name &quot;
l_string|&quot;failed.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|qla2x00_rsnn_nn
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* EMPTY */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Register Symbolic &quot;
l_string|&quot;Node Name failed.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
)brace
id|rval
op_assign
id|qla2x00_find_all_fabric_devs
c_func
(paren
id|ha
comma
op_amp
id|new_fcports
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Logout all previous fabric devices marked lost, except&n;&t;&t; * tape devices.&n;&t;&t; */
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fcport-&gt;flags
op_amp
id|FCF_FABRIC_DEVICE
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_DEVICE_LOST
)paren
(brace
id|qla2x00_mark_device_lost
c_func
(paren
id|ha
comma
id|fcport
comma
id|ql2xplogiabsentdevice
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fcport-&gt;loop_id
op_ne
id|FC_NO_LOOP_ID
op_logical_and
(paren
id|fcport-&gt;flags
op_amp
id|FCF_TAPE_PRESENT
)paren
op_eq
l_int|0
op_logical_and
id|fcport-&gt;port_type
op_ne
id|FCT_INITIATOR
op_logical_and
id|fcport-&gt;port_type
op_ne
id|FCT_BROADCAST
)paren
(brace
id|qla2x00_fabric_logout
c_func
(paren
id|ha
comma
id|fcport-&gt;loop_id
)paren
suffix:semicolon
id|fcport-&gt;loop_id
op_assign
id|FC_NO_LOOP_ID
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Starting free loop ID. */
id|next_loopid
op_assign
id|ha-&gt;min_external_loopid
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Scan through our port list and login entries that need to be&n;&t;&t; * logged in.&n;&t;&t; */
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_or
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fcport-&gt;flags
op_amp
id|FCF_FABRIC_DEVICE
)paren
op_eq
l_int|0
op_logical_or
(paren
id|fcport-&gt;flags
op_amp
id|FCF_LOGIN_NEEDED
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|fcport-&gt;loop_id
op_eq
id|FC_NO_LOOP_ID
)paren
(brace
id|fcport-&gt;loop_id
op_assign
id|next_loopid
suffix:semicolon
id|rval
op_assign
id|qla2x00_find_new_loop_id
c_func
(paren
id|ha
comma
id|fcport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* Ran out of IDs to use */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Login and update database */
id|qla2x00_fabric_dev_login
c_func
(paren
id|ha
comma
id|fcport
comma
op_amp
id|next_loopid
)paren
suffix:semicolon
)brace
multiline_comment|/* Exit if out of loop IDs. */
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Login and add the new devices to our port list.&n;&t;&t; */
id|list_for_each_entry_safe
c_func
(paren
id|fcport
comma
id|fcptemp
comma
op_amp
id|new_fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_or
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Find a new loop ID to use. */
id|fcport-&gt;loop_id
op_assign
id|next_loopid
suffix:semicolon
id|rval
op_assign
id|qla2x00_find_new_loop_id
c_func
(paren
id|ha
comma
id|fcport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* Ran out of IDs to use */
r_break
suffix:semicolon
)brace
multiline_comment|/* Login and update database */
id|qla2x00_fabric_dev_login
c_func
(paren
id|ha
comma
id|fcport
comma
op_amp
id|next_loopid
)paren
suffix:semicolon
multiline_comment|/* Remove device from the new list and add it to DB */
id|list_del
c_func
(paren
op_amp
id|fcport-&gt;list
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|fcport-&gt;list
comma
op_amp
id|ha-&gt;fcports
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Free all new device structures not processed. */
id|list_for_each_entry_safe
c_func
(paren
id|fcport
comma
id|fcptemp
comma
op_amp
id|new_fcports
comma
id|list
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|fcport-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fcport
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Configure fabric error exit: &quot;
l_string|&quot;rval=%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_find_all_fabric_devs&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;dev = database device entry pointer.&n; *&n; * Returns:&n; *&t;0 = success.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_int
DECL|function|qla2x00_find_all_fabric_devs
id|qla2x00_find_all_fabric_devs
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_struct
id|list_head
op_star
id|new_fcports
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint16
id|loop_id
suffix:semicolon
id|fc_port_t
op_star
id|fcport
comma
op_star
id|new_fcport
suffix:semicolon
r_int
id|found
suffix:semicolon
id|sw_info_t
op_star
id|swl
suffix:semicolon
r_int
id|swl_idx
suffix:semicolon
r_int
id|first_dev
comma
id|last_dev
suffix:semicolon
id|port_id_t
id|wrap
comma
id|nxt_d_id
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
multiline_comment|/* Try GID_PT to get device list, else GAN. */
id|swl
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|sw_info_t
)paren
op_star
id|MAX_FIBRE_DEVICES
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|swl
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GID_PT allocations failed, fallback &quot;
l_string|&quot;on GA_NXT&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|swl
comma
l_int|0
comma
r_sizeof
(paren
id|sw_info_t
)paren
op_star
id|MAX_FIBRE_DEVICES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla2x00_gid_pt
c_func
(paren
id|ha
comma
id|swl
)paren
op_ne
id|QLA_SUCCESS
)paren
(brace
id|kfree
c_func
(paren
id|swl
)paren
suffix:semicolon
id|swl
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|qla2x00_gpn_id
c_func
(paren
id|ha
comma
id|swl
)paren
op_ne
id|QLA_SUCCESS
)paren
(brace
id|kfree
c_func
(paren
id|swl
)paren
suffix:semicolon
id|swl
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|qla2x00_gnn_id
c_func
(paren
id|ha
comma
id|swl
)paren
op_ne
id|QLA_SUCCESS
)paren
(brace
id|kfree
c_func
(paren
id|swl
)paren
suffix:semicolon
id|swl
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|swl_idx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allocate temporary fcport for any new fcports discovered. */
id|new_fcport
op_assign
id|qla2x00_alloc_fcport
c_func
(paren
id|ha
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_fcport
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|swl
)paren
id|kfree
c_func
(paren
id|swl
)paren
suffix:semicolon
r_return
(paren
id|QLA_MEMORY_ALLOC_FAILED
)paren
suffix:semicolon
)brace
id|new_fcport-&gt;flags
op_or_assign
(paren
id|FCF_FABRIC_DEVICE
op_or
id|FCF_LOGIN_NEEDED
)paren
suffix:semicolon
multiline_comment|/* Set start port ID scan at adapter ID. */
id|first_dev
op_assign
l_int|1
suffix:semicolon
id|last_dev
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Starting free loop ID. */
id|loop_id
op_assign
id|ha-&gt;min_external_loopid
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|loop_id
op_le
id|ha-&gt;last_loop_id
suffix:semicolon
id|loop_id
op_increment
)paren
(brace
r_if
c_cond
(paren
id|RESERVED_LOOP_ID
c_func
(paren
id|loop_id
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_or
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|swl
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|last_dev
)paren
(brace
id|wrap.b24
op_assign
id|new_fcport-&gt;d_id.b24
suffix:semicolon
)brace
r_else
(brace
id|new_fcport-&gt;d_id.b24
op_assign
id|swl
(braket
id|swl_idx
)braket
dot
id|d_id.b24
suffix:semicolon
id|memcpy
c_func
(paren
id|new_fcport-&gt;node_name
comma
id|swl
(braket
id|swl_idx
)braket
dot
id|node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|new_fcport-&gt;port_name
comma
id|swl
(braket
id|swl_idx
)braket
dot
id|port_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|swl
(braket
id|swl_idx
)braket
dot
id|d_id.b.rsvd_1
op_ne
l_int|0
)paren
(brace
id|last_dev
op_assign
l_int|1
suffix:semicolon
)brace
id|swl_idx
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Send GA_NXT to the switch */
id|rval
op_assign
id|qla2x00_ga_nxt
c_func
(paren
id|ha
comma
id|new_fcport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* If wrap on switch device list, exit. */
r_if
c_cond
(paren
id|first_dev
)paren
(brace
id|wrap.b24
op_assign
id|new_fcport-&gt;d_id.b24
suffix:semicolon
id|first_dev
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|new_fcport-&gt;d_id.b24
op_eq
id|wrap.b24
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): device wrap (%02x%02x%02x)&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|new_fcport-&gt;d_id.b.domain
comma
id|new_fcport-&gt;d_id.b.area
comma
id|new_fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Bypass if host adapter. */
r_if
c_cond
(paren
id|new_fcport-&gt;d_id.b24
op_eq
id|ha-&gt;d_id.b24
)paren
r_continue
suffix:semicolon
multiline_comment|/* Bypass reserved domain fields. */
r_if
c_cond
(paren
(paren
id|new_fcport-&gt;d_id.b.domain
op_amp
l_int|0xf0
)paren
op_eq
l_int|0xf0
)paren
r_continue
suffix:semicolon
multiline_comment|/* Bypass if same domain and area of adapter. */
r_if
c_cond
(paren
(paren
id|new_fcport-&gt;d_id.b24
op_amp
l_int|0xffff00
)paren
op_eq
(paren
id|ha-&gt;d_id.b24
op_amp
l_int|0xffff00
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Locate matching device in database. */
id|found
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|new_fcport-&gt;port_name
comma
id|fcport-&gt;port_name
comma
id|WWN_SIZE
)paren
)paren
r_continue
suffix:semicolon
id|found
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * If device was not a fabric device before.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|fcport-&gt;flags
op_amp
id|FCF_FABRIC_DEVICE
)paren
op_eq
l_int|0
)paren
(brace
id|fcport-&gt;d_id.b24
op_assign
id|new_fcport-&gt;d_id.b24
suffix:semicolon
id|fcport-&gt;loop_id
op_assign
id|FC_NO_LOOP_ID
suffix:semicolon
id|fcport-&gt;flags
op_or_assign
(paren
id|FCF_FABRIC_DEVICE
op_or
id|FCF_LOGIN_NEEDED
)paren
suffix:semicolon
id|fcport-&gt;flags
op_and_assign
op_complement
id|FCF_PERSISTENT_BOUND
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * If address the same and state FCS_ONLINE, nothing&n;&t;&t;&t; * changed.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|fcport-&gt;d_id.b24
op_eq
id|new_fcport-&gt;d_id.b24
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_ONLINE
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Port ID changed or device was marked to be updated;&n;&t;&t;&t; * Log it out if still logged in and mark it for&n;&t;&t;&t; * relogin later.&n;&t;&t;&t; */
id|fcport-&gt;d_id.b24
op_assign
id|new_fcport-&gt;d_id.b24
suffix:semicolon
id|fcport-&gt;flags
op_or_assign
id|FCF_LOGIN_NEEDED
suffix:semicolon
r_if
c_cond
(paren
id|fcport-&gt;loop_id
op_ne
id|FC_NO_LOOP_ID
op_logical_and
(paren
id|fcport-&gt;flags
op_amp
id|FCF_TAPE_PRESENT
)paren
op_eq
l_int|0
op_logical_and
id|fcport-&gt;port_type
op_ne
id|FCT_INITIATOR
op_logical_and
id|fcport-&gt;port_type
op_ne
id|FCT_BROADCAST
)paren
(brace
id|qla2x00_fabric_logout
c_func
(paren
id|ha
comma
id|fcport-&gt;loop_id
)paren
suffix:semicolon
id|fcport-&gt;loop_id
op_assign
id|FC_NO_LOOP_ID
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
)paren
r_continue
suffix:semicolon
multiline_comment|/* If device was not in our fcports list, then add it. */
id|list_add_tail
c_func
(paren
op_amp
id|new_fcport-&gt;list
comma
id|new_fcports
)paren
suffix:semicolon
multiline_comment|/* Allocate a new replacement fcport. */
id|nxt_d_id.b24
op_assign
id|new_fcport-&gt;d_id.b24
suffix:semicolon
id|new_fcport
op_assign
id|qla2x00_alloc_fcport
c_func
(paren
id|ha
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_fcport
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|swl
)paren
id|kfree
c_func
(paren
id|swl
)paren
suffix:semicolon
r_return
(paren
id|QLA_MEMORY_ALLOC_FAILED
)paren
suffix:semicolon
)brace
id|new_fcport-&gt;flags
op_or_assign
(paren
id|FCF_FABRIC_DEVICE
op_or
id|FCF_LOGIN_NEEDED
)paren
suffix:semicolon
id|new_fcport-&gt;d_id.b24
op_assign
id|nxt_d_id.b24
suffix:semicolon
)brace
r_if
c_cond
(paren
id|swl
)paren
id|kfree
c_func
(paren
id|swl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_fcport
)paren
id|kfree
c_func
(paren
id|new_fcport
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
id|new_fcports
)paren
)paren
id|ha-&gt;device_flags
op_or_assign
id|DFLG_FABRIC_DEVICES
suffix:semicolon
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_find_new_loop_id&n; *&t;Scan through our port list and find a new usable loop ID.&n; *&n; * Input:&n; *&t;ha:&t;adapter state pointer.&n; *&t;dev:&t;port structure pointer.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_find_new_loop_id
id|qla2x00_find_new_loop_id
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|dev
)paren
(brace
r_int
id|rval
suffix:semicolon
r_int
id|found
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
r_uint16
id|first_loop_id
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
multiline_comment|/* Save starting loop ID. */
id|first_loop_id
op_assign
id|dev-&gt;loop_id
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* Skip loop ID if already used by adapter. */
r_if
c_cond
(paren
id|dev-&gt;loop_id
op_eq
id|ha-&gt;loop_id
)paren
(brace
id|dev-&gt;loop_id
op_increment
suffix:semicolon
)brace
multiline_comment|/* Skip reserved loop IDs. */
r_while
c_loop
(paren
id|RESERVED_LOOP_ID
c_func
(paren
id|dev-&gt;loop_id
)paren
)paren
(brace
id|dev-&gt;loop_id
op_increment
suffix:semicolon
)brace
multiline_comment|/* Reset loop ID if passed the end. */
r_if
c_cond
(paren
id|dev-&gt;loop_id
OG
id|ha-&gt;last_loop_id
)paren
(brace
multiline_comment|/* first loop ID. */
id|dev-&gt;loop_id
op_assign
id|ha-&gt;min_external_loopid
suffix:semicolon
)brace
multiline_comment|/* Check for loop ID being already in use. */
id|found
op_assign
l_int|0
suffix:semicolon
id|fcport
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|fcport-&gt;loop_id
op_eq
id|dev-&gt;loop_id
op_logical_and
id|fcport
op_ne
id|dev
)paren
(brace
multiline_comment|/* ID possibly in use */
id|found
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* If not in use then it is free to use. */
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* ID in use. Try next value. */
id|dev-&gt;loop_id
op_increment
suffix:semicolon
multiline_comment|/* If wrap around. No free ID to use. */
r_if
c_cond
(paren
id|dev-&gt;loop_id
op_eq
id|first_loop_id
)paren
(brace
id|dev-&gt;loop_id
op_assign
id|FC_NO_LOOP_ID
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_device_resync&n; *&t;Marks devices in the database that needs resynchronization.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_int
DECL|function|qla2x00_device_resync
id|qla2x00_device_resync
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_int
id|rval2
suffix:semicolon
r_uint32
id|mask
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
r_uint32
id|rscn_entry
suffix:semicolon
r_uint8
id|rscn_out_iter
suffix:semicolon
r_uint8
id|format
suffix:semicolon
id|port_id_t
id|d_id
suffix:semicolon
id|rval
op_assign
id|QLA_RSCNS_HANDLED
suffix:semicolon
r_while
c_loop
(paren
id|ha-&gt;rscn_out_ptr
op_ne
id|ha-&gt;rscn_in_ptr
op_logical_or
id|ha-&gt;flags.rscn_queue_overflow
)paren
(brace
id|rscn_entry
op_assign
id|ha-&gt;rscn_queue
(braket
id|ha-&gt;rscn_out_ptr
)braket
suffix:semicolon
id|format
op_assign
id|MSB
c_func
(paren
id|MSW
c_func
(paren
id|rscn_entry
)paren
)paren
suffix:semicolon
id|d_id.b.domain
op_assign
id|LSB
c_func
(paren
id|MSW
c_func
(paren
id|rscn_entry
)paren
)paren
suffix:semicolon
id|d_id.b.area
op_assign
id|MSB
c_func
(paren
id|LSW
c_func
(paren
id|rscn_entry
)paren
)paren
suffix:semicolon
id|d_id.b.al_pa
op_assign
id|LSB
c_func
(paren
id|LSW
c_func
(paren
id|rscn_entry
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RSCN queue entry[%d] = &quot;
l_string|&quot;[%02x/%02x%02x%02x].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|ha-&gt;rscn_out_ptr
comma
id|format
comma
id|d_id.b.domain
comma
id|d_id.b.area
comma
id|d_id.b.al_pa
)paren
)paren
suffix:semicolon
id|ha-&gt;rscn_out_ptr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;rscn_out_ptr
op_eq
id|MAX_RSCN_COUNT
)paren
id|ha-&gt;rscn_out_ptr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Skip duplicate entries. */
r_for
c_loop
(paren
id|rscn_out_iter
op_assign
id|ha-&gt;rscn_out_ptr
suffix:semicolon
op_logical_neg
id|ha-&gt;flags.rscn_queue_overflow
op_logical_and
id|rscn_out_iter
op_ne
id|ha-&gt;rscn_in_ptr
suffix:semicolon
id|rscn_out_iter
op_assign
(paren
id|rscn_out_iter
op_eq
(paren
id|MAX_RSCN_COUNT
op_minus
l_int|1
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
id|rscn_out_iter
op_plus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|rscn_entry
op_ne
id|ha-&gt;rscn_queue
(braket
id|rscn_out_iter
)braket
)paren
r_break
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Skipping duplicate RSCN queue &quot;
l_string|&quot;entry found at [%d].&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rscn_out_iter
)paren
)paren
suffix:semicolon
id|ha-&gt;rscn_out_ptr
op_assign
id|rscn_out_iter
suffix:semicolon
)brace
multiline_comment|/* Queue overflow, set switch default case. */
r_if
c_cond
(paren
id|ha-&gt;flags.rscn_queue_overflow
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): device_resync: rscn &quot;
l_string|&quot;overflow.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|format
op_assign
l_int|3
suffix:semicolon
id|ha-&gt;flags.rscn_queue_overflow
op_assign
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|format
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA2200
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA6312
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA6322
c_func
(paren
id|ha
)paren
op_logical_and
id|ha-&gt;flags.init_done
)paren
(brace
multiline_comment|/* Handle port RSCN via asyncronous IOCBs */
id|rval2
op_assign
id|qla2x00_handle_port_rscn
c_func
(paren
id|ha
comma
id|rscn_entry
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval2
op_eq
id|QLA_SUCCESS
)paren
r_continue
suffix:semicolon
)brace
id|mask
op_assign
l_int|0xffffff
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|mask
op_assign
l_int|0xffff00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|mask
op_assign
l_int|0xff0000
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mask
op_assign
l_int|0x0
suffix:semicolon
id|d_id.b24
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;rscn_out_ptr
op_assign
id|ha-&gt;rscn_in_ptr
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
multiline_comment|/* Abort any outstanding IO descriptors. */
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
id|qla2x00_cancel_io_descriptors
c_func
(paren
id|ha
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
(paren
id|fcport-&gt;flags
op_amp
id|FCF_FABRIC_DEVICE
)paren
op_eq
l_int|0
op_logical_or
(paren
id|fcport-&gt;d_id.b24
op_amp
id|mask
)paren
op_ne
id|d_id.b24
op_logical_or
id|fcport-&gt;port_type
op_eq
id|FCT_BROADCAST
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_ONLINE
)paren
(brace
r_if
c_cond
(paren
id|format
op_ne
l_int|3
op_logical_or
id|fcport-&gt;port_type
op_ne
id|FCT_INITIATOR
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_DEVICE_LOST
)paren
suffix:semicolon
)brace
)brace
id|fcport-&gt;flags
op_and_assign
op_complement
id|FCF_FARP_DONE
suffix:semicolon
)brace
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_fabric_dev_login&n; *&t;Login fabric target device and update FC port database.&n; *&n; * Input:&n; *&t;ha:&t;&t;adapter state pointer.&n; *&t;fcport:&t;&t;port structure list pointer.&n; *&t;next_loopid:&t;contains value of a new loop ID that can be used&n; *&t;&t;&t;by the next login attempt.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_int
DECL|function|qla2x00_fabric_dev_login
id|qla2x00_fabric_dev_login
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
comma
r_uint16
op_star
id|next_loopid
)paren
(brace
r_int
id|rval
suffix:semicolon
r_int
id|retry
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
id|retry
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_fabric_login
c_func
(paren
id|ha
comma
id|fcport
comma
id|next_loopid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
(brace
id|rval
op_assign
id|qla2x00_get_port_database
c_func
(paren
id|ha
comma
id|fcport
comma
id|BIT_1
op_or
id|BIT_0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
id|qla2x00_fabric_logout
c_func
(paren
id|ha
comma
id|fcport-&gt;loop_id
)paren
suffix:semicolon
)brace
r_else
(brace
id|qla2x00_update_fcport
c_func
(paren
id|ha
comma
id|fcport
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_fabric_login&n; *&t;Issue fabric login command.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;device = pointer to FC device type structure.&n; *&n; * Returns:&n; *      0 - Login successfully&n; *      1 - Login failed&n; *      2 - Initiator device&n; *      3 - Fatal error&n; */
r_int
DECL|function|qla2x00_fabric_login
id|qla2x00_fabric_login
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
comma
r_uint16
op_star
id|next_loopid
)paren
(brace
r_int
id|rval
suffix:semicolon
r_int
id|retry
suffix:semicolon
r_uint16
id|tmp_loopid
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
id|retry
op_assign
l_int|0
suffix:semicolon
id|tmp_loopid
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Trying Fabric Login w/loop id 0x%04x &quot;
l_string|&quot;for port %02x%02x%02x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;loop_id
comma
id|fcport-&gt;d_id.b.domain
comma
id|fcport-&gt;d_id.b.area
comma
id|fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
multiline_comment|/* Login fcport on switch. */
id|qla2x00_login_fabric
c_func
(paren
id|ha
comma
id|fcport-&gt;loop_id
comma
id|fcport-&gt;d_id.b.domain
comma
id|fcport-&gt;d_id.b.area
comma
id|fcport-&gt;d_id.b.al_pa
comma
id|mb
comma
id|BIT_0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
l_int|0
)braket
op_eq
id|MBS_PORT_ID_USED
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Device has another loop ID.  The firmware team&n;&t;&t;&t; * recommends us to perform an implicit login with the&n;&t;&t;&t; * specified ID again. The ID we just used is save here&n;&t;&t;&t; * so we return with an ID that can be tried by the&n;&t;&t;&t; * next login.&n;&t;&t;&t; */
id|retry
op_increment
suffix:semicolon
id|tmp_loopid
op_assign
id|fcport-&gt;loop_id
suffix:semicolon
id|fcport-&gt;loop_id
op_assign
id|mb
(braket
l_int|1
)braket
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Fabric Login: port in use - next &quot;
l_string|&quot;loop id=0x%04x, port Id=%02x%02x%02x.&bslash;n&quot;
comma
id|fcport-&gt;loop_id
comma
id|fcport-&gt;d_id.b.domain
comma
id|fcport-&gt;d_id.b.area
comma
id|fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mb
(braket
l_int|0
)braket
op_eq
id|MBS_COMMAND_COMPLETE
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Login succeeded.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|retry
)paren
(brace
multiline_comment|/* A retry occurred before. */
op_star
id|next_loopid
op_assign
id|tmp_loopid
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * No retry occurred before. Just increment the&n;&t;&t;&t;&t; * ID value for next login.&n;&t;&t;&t;&t; */
op_star
id|next_loopid
op_assign
(paren
id|fcport-&gt;loop_id
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mb
(braket
l_int|1
)braket
op_amp
id|BIT_0
)paren
(brace
id|fcport-&gt;port_type
op_assign
id|FCT_INITIATOR
suffix:semicolon
)brace
r_else
(brace
id|fcport-&gt;port_type
op_assign
id|FCT_TARGET
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
l_int|1
)braket
op_amp
id|BIT_1
)paren
(brace
id|fcport-&gt;flags
op_or_assign
id|FCF_TAPE_PRESENT
suffix:semicolon
)brace
)brace
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mb
(braket
l_int|0
)braket
op_eq
id|MBS_LOOP_ID_USED
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Loop ID already used, try next loop ID.&n;&t;&t;&t; */
id|fcport-&gt;loop_id
op_increment
suffix:semicolon
id|rval
op_assign
id|qla2x00_find_new_loop_id
c_func
(paren
id|ha
comma
id|fcport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* Ran out of loop IDs to use */
r_break
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|mb
(braket
l_int|0
)braket
op_eq
id|MBS_COMMAND_ERROR
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Firmware possibly timed out during login. If NO&n;&t;&t;&t; * retries are left to do then the device is declared&n;&t;&t;&t; * dead.&n;&t;&t;&t; */
op_star
id|next_loopid
op_assign
id|fcport-&gt;loop_id
suffix:semicolon
id|qla2x00_fabric_logout
c_func
(paren
id|ha
comma
id|fcport-&gt;loop_id
)paren
suffix:semicolon
id|fcport-&gt;loop_id
op_assign
id|FC_NO_LOOP_ID
suffix:semicolon
id|rval
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * unrecoverable / not handled error&n;&t;&t;&t; */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): failed=%x port_id=%02x%02x%02x &quot;
l_string|&quot;loop_id=%x jiffies=%lx.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|mb
(braket
l_int|0
)braket
comma
id|fcport-&gt;d_id.b.domain
comma
id|fcport-&gt;d_id.b.area
comma
id|fcport-&gt;d_id.b.al_pa
comma
id|fcport-&gt;loop_id
comma
id|jiffies
)paren
)paren
suffix:semicolon
op_star
id|next_loopid
op_assign
id|fcport-&gt;loop_id
suffix:semicolon
id|qla2x00_fabric_logout
c_func
(paren
id|ha
comma
id|fcport-&gt;loop_id
)paren
suffix:semicolon
id|fcport-&gt;loop_id
op_assign
id|FC_NO_LOOP_ID
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|fcport-&gt;state
comma
id|FCS_DEVICE_DEAD
)paren
suffix:semicolon
id|rval
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_local_device_login&n; *&t;Issue local device login command.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;loop_id = loop id of device to login to.&n; *&n; * Returns (Where&squot;s the #define!!!!):&n; *      0 - Login successfully&n; *      1 - Login failed&n; *      3 - Fatal error&n; */
r_int
DECL|function|qla2x00_local_device_login
id|qla2x00_local_device_login
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|loop_id
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
id|memset
c_func
(paren
id|mb
comma
l_int|0
comma
r_sizeof
(paren
id|mb
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_login_local_device
c_func
(paren
id|ha
comma
id|loop_id
comma
id|mb
comma
id|BIT_0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* Interrogate mailbox registers for any errors */
r_if
c_cond
(paren
id|mb
(braket
l_int|0
)braket
op_eq
id|MBS_COMMAND_ERROR
)paren
id|rval
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mb
(braket
l_int|0
)braket
op_eq
id|MBS_COMMAND_PARAMETER_ERROR
)paren
multiline_comment|/* device not in PCB table */
id|rval
op_assign
l_int|3
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla2x00_loop_resync&n; *      Resync with fibre channel devices.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success&n; */
r_int
DECL|function|qla2x00_loop_resync
id|qla2x00_loop_resync
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint32
id|wait_time
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_UPDATE
)paren
suffix:semicolon
id|qla2x00_stats.loop_resync
op_increment
suffix:semicolon
id|clear_bit
c_func
(paren
id|ISP_ABORT_RETRY
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.online
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|rval
op_assign
id|qla2x00_fw_ready
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
multiline_comment|/* Wait at most MAX_TARGET RSCNs for a stable link. */
id|wait_time
op_assign
l_int|256
suffix:semicolon
r_do
(brace
multiline_comment|/* v2.19.05b6 */
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_UPDATE
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Issue marker command only when we are going&n;&t;&t;&t;&t; * to start the I/O .&n;&t;&t;&t;&t; */
id|ha-&gt;marker_needed
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Remap devices on Loop. */
id|clear_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|qla2x00_configure_loop
c_func
(paren
id|ha
)paren
suffix:semicolon
id|wait_time
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_and
op_logical_neg
(paren
id|test_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
op_logical_and
id|wait_time
op_logical_and
(paren
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
suffix:semicolon
)brace
id|qla2x00_restart_queues
c_func
(paren
id|ha
comma
id|TRUE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): **** FAILED ****&bslash;n&quot;
comma
id|__func__
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla2x00_restart_queues&n; *&t;Restart device queues.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&n; * Context:&n; *&t;Kernel/Interrupt context.&n; */
r_void
DECL|function|qla2x00_restart_queues
id|qla2x00_restart_queues
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
id|flush
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
r_int
id|retry_q_cnt
op_assign
l_int|0
suffix:semicolon
r_int
id|pending_q_cnt
op_assign
l_int|0
suffix:semicolon
r_struct
id|list_head
op_star
id|list
comma
op_star
id|temp
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
id|RESTART_QUEUES_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
multiline_comment|/* start pending queue */
id|pending_q_cnt
op_assign
id|ha-&gt;qthreads
suffix:semicolon
r_if
c_cond
(paren
id|flush
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|list
comma
id|temp
comma
op_amp
id|ha-&gt;pending_queue
)paren
(brace
id|sp
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|srb_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sp-&gt;flags
op_amp
id|SRB_TAPE
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * When time expire return request back to OS as BUSY &n;&t;&t;&t; */
id|__del_from_pending_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|sp-&gt;cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|__add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ha-&gt;pending_queue
)paren
)paren
id|qla2x00_next
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Clear out our retry queue&n;&t; */
r_if
c_cond
(paren
id|flush
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|retry_q_cnt
op_assign
id|ha-&gt;retry_q_cnt
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|list
comma
id|temp
comma
op_amp
id|ha-&gt;retry_queue
)paren
(brace
id|sp
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|srb_t
comma
id|list
)paren
suffix:semicolon
multiline_comment|/* when time expire return request back to OS as BUSY */
id|__del_from_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|sp-&gt;cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|__add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;list_lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): callback %d commands.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|retry_q_cnt
)paren
suffix:semicolon
)paren
)brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): active=%ld, retry=%d, pending=%d, &quot;
l_string|&quot;done=%ld, scsi retry=%d commands.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|ha-&gt;actthreads
comma
id|ha-&gt;retry_q_cnt
comma
id|pending_q_cnt
comma
id|ha-&gt;done_q_cnt
comma
id|ha-&gt;scsi_retry_q_cnt
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ha-&gt;done_queue
)paren
)paren
id|qla2x00_done
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_void
DECL|function|qla2x00_rescan_fcports
id|qla2x00_rescan_fcports
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rescan_done
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|rescan_done
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
(paren
id|fcport-&gt;flags
op_amp
id|FCF_RESCAN_NEEDED
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|qla2x00_update_fcport
c_func
(paren
id|ha
comma
id|fcport
)paren
suffix:semicolon
id|fcport-&gt;flags
op_and_assign
op_complement
id|FCF_RESCAN_NEEDED
suffix:semicolon
id|rescan_done
op_assign
l_int|1
suffix:semicolon
)brace
id|qla2x00_probe_for_all_luns
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Update OS target and lun structures if necessary. */
r_if
c_cond
(paren
id|rescan_done
)paren
(brace
id|qla2x00_config_os
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * qla2x00_config_os&n; *&t;Setup OS target and LUN structures.&n; *&n; * Input:&n; *&t;ha = adapter state pointer.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_void
DECL|function|qla2x00_config_os
id|qla2x00_config_os
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|fc_lun_t
op_star
id|fclun
suffix:semicolon
id|os_tgt_t
op_star
id|tq
suffix:semicolon
r_uint16
id|tgt
suffix:semicolon
r_for
c_loop
(paren
id|tgt
op_assign
l_int|0
suffix:semicolon
id|tgt
OL
id|MAX_TARGETS
suffix:semicolon
id|tgt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tq
op_assign
id|TGT_Q
c_func
(paren
id|ha
comma
id|tgt
)paren
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|clear_bit
c_func
(paren
id|TQF_ONLINE
comma
op_amp
id|tq-&gt;flags
)paren
suffix:semicolon
)brace
id|list_for_each_entry
c_func
(paren
id|fcport
comma
op_amp
id|ha-&gt;fcports
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_ne
id|FCS_ONLINE
op_logical_or
id|fcport-&gt;port_type
op_eq
id|FCT_INITIATOR
op_logical_or
id|fcport-&gt;port_type
op_eq
id|FCT_BROADCAST
)paren
(brace
id|fcport-&gt;os_target_id
op_assign
id|MAX_TARGETS
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fcport-&gt;flags
op_amp
id|FCF_FO_MASKED
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* Bind FC port to OS target number. */
r_if
c_cond
(paren
id|qla2x00_fcport_bind
c_func
(paren
id|ha
comma
id|fcport
)paren
op_eq
id|MAX_TARGETS
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* Bind FC LUN to OS LUN number. */
id|list_for_each_entry
c_func
(paren
id|fclun
comma
op_amp
id|fcport-&gt;fcluns
comma
id|list
)paren
(brace
id|qla2x00_fclun_bind
c_func
(paren
id|ha
comma
id|fcport
comma
id|fclun
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * qla2x00_fcport_bind&n; *&t;Locates a target number for FC port.&n; *&n; * Input:&n; *&t;ha = adapter state pointer.&n; *&t;fcport = FC port structure pointer.&n; *&n; * Returns:&n; *&t;target number&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_uint16
DECL|function|qla2x00_fcport_bind
id|qla2x00_fcport_bind
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
)paren
(brace
r_int
id|found
suffix:semicolon
r_uint16
id|tgt
suffix:semicolon
id|os_tgt_t
op_star
id|tq
suffix:semicolon
multiline_comment|/* Check for persistent binding. */
r_for
c_loop
(paren
id|tgt
op_assign
l_int|0
suffix:semicolon
id|tgt
OL
id|MAX_TARGETS
suffix:semicolon
id|tgt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tq
op_assign
id|TGT_Q
c_func
(paren
id|ha
comma
id|tgt
)paren
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|ha-&gt;binding_type
)paren
(brace
r_case
id|BIND_BY_PORT_ID
suffix:colon
r_if
c_cond
(paren
id|fcport-&gt;d_id.b24
op_eq
id|tq-&gt;d_id.b24
)paren
(brace
id|memcpy
c_func
(paren
id|tq-&gt;node_name
comma
id|fcport-&gt;node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tq-&gt;port_name
comma
id|fcport-&gt;port_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|found
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BIND_BY_PORT_NAME
suffix:colon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|fcport-&gt;port_name
comma
id|tq-&gt;port_name
comma
id|WWN_SIZE
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * In case of persistent binding, update the&n;&t;&t;&t;&t; * WWNN.&n;&t;&t;&t;&t; */
id|memcpy
c_func
(paren
id|tq-&gt;node_name
comma
id|fcport-&gt;node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|found
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* TODO: honor the ConfigRequired flag */
r_if
c_cond
(paren
id|tgt
op_eq
id|MAX_TARGETS
)paren
(brace
multiline_comment|/* Check if targetID 0 available. */
id|tgt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|TGT_Q
c_func
(paren
id|ha
comma
id|tgt
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Locate first free target for device. */
r_for
c_loop
(paren
id|tgt
op_assign
l_int|0
suffix:semicolon
id|tgt
OL
id|MAX_TARGETS
suffix:semicolon
id|tgt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|TGT_Q
c_func
(paren
id|ha
comma
id|tgt
)paren
op_eq
l_int|NULL
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|tgt
op_ne
id|MAX_TARGETS
)paren
(brace
r_if
c_cond
(paren
(paren
id|tq
op_assign
id|qla2x00_tgt_alloc
c_func
(paren
id|ha
comma
id|tgt
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|memcpy
c_func
(paren
id|tq-&gt;node_name
comma
id|fcport-&gt;node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tq-&gt;port_name
comma
id|fcport-&gt;port_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|tq-&gt;d_id.b24
op_assign
id|fcport-&gt;d_id.b24
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Reset target numbers incase it changed. */
id|fcport-&gt;os_target_id
op_assign
id|tgt
suffix:semicolon
r_if
c_cond
(paren
id|tgt
op_ne
id|MAX_TARGETS
op_logical_and
id|tq
op_ne
l_int|NULL
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Assigning target ID=%02d @ %p to &quot;
l_string|&quot;loop id=0x%04x, port state=0x%x, port down retry=%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|tgt
comma
id|tq
comma
id|fcport-&gt;loop_id
comma
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;port_down_timer
)paren
)paren
)paren
suffix:semicolon
id|fcport-&gt;tgt_queue
op_assign
id|tq
suffix:semicolon
id|fcport-&gt;flags
op_or_assign
id|FCF_PERSISTENT_BOUND
suffix:semicolon
id|tq-&gt;fcport
op_assign
id|fcport
suffix:semicolon
id|set_bit
c_func
(paren
id|TQF_ONLINE
comma
op_amp
id|tq-&gt;flags
)paren
suffix:semicolon
id|tq-&gt;port_down_retry_count
op_assign
id|ha-&gt;port_down_retry_count
suffix:semicolon
macro_line|#if 0
id|qla2x00_get_lun_mask_from_config
c_func
(paren
id|ha
comma
id|fcport
comma
id|tgt
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|tgt
op_eq
id|MAX_TARGETS
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Unable to bind fcport, loop_id=%x&bslash;n&quot;
comma
id|fcport-&gt;loop_id
)paren
suffix:semicolon
)brace
r_return
(paren
id|tgt
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_fclun_bind&n; *&t;Binds all FC device LUNS to OS LUNS.&n; *&n; * Input:&n; *&t;ha:&t;&t;adapter state pointer.&n; *&t;fcport:&t;&t;FC port structure pointer.&n; *&n; * Returns:&n; *&t;target number&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
id|os_lun_t
op_star
DECL|function|qla2x00_fclun_bind
id|qla2x00_fclun_bind
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
comma
id|fc_lun_t
op_star
id|fclun
)paren
(brace
id|os_lun_t
op_star
id|lq
suffix:semicolon
r_uint16
id|tgt
suffix:semicolon
r_uint16
id|lun
suffix:semicolon
id|tgt
op_assign
id|fcport-&gt;os_target_id
suffix:semicolon
id|lun
op_assign
id|fclun-&gt;lun
suffix:semicolon
multiline_comment|/* Allocate LUNs */
r_if
c_cond
(paren
id|lun
op_ge
id|MAX_LUNS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Unable to bind lun, invalid &quot;
l_string|&quot;lun=(%x).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|lun
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Always alloc LUN 0 so kernel will scan past LUN 0. */
r_if
c_cond
(paren
id|lun
op_ne
l_int|0
op_logical_and
(paren
id|EXT_IS_LUN_BIT_SET
c_func
(paren
op_amp
(paren
id|fcport-&gt;lun_mask
)paren
comma
id|lun
)paren
)paren
)paren
(brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|lq
op_assign
id|qla2x00_lun_alloc
c_func
(paren
id|ha
comma
id|tgt
comma
id|lun
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Unable to bind fclun, loop_id=%x lun=%x&bslash;n&quot;
comma
id|fcport-&gt;loop_id
comma
id|lun
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|lq-&gt;fclun
op_assign
id|fclun
suffix:semicolon
r_return
(paren
id|lq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_tgt_alloc&n; *&t;Allocate and pre-initialize target queue.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;t = SCSI target number.&n; *&n; * Returns:&n; *&t;NULL = failure&n; *&n; * Context:&n; *&t;Kernel context.&n; */
id|os_tgt_t
op_star
DECL|function|qla2x00_tgt_alloc
id|qla2x00_tgt_alloc
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|tgt
)paren
(brace
id|os_tgt_t
op_star
id|tq
suffix:semicolon
multiline_comment|/*&n;&t; * If SCSI addressing OK, allocate TGT queue and lock.&n;&t; */
r_if
c_cond
(paren
id|tgt
op_ge
id|MAX_TARGETS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Unable to allocate target, invalid &quot;
l_string|&quot;target number %d.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|tgt
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|tq
op_assign
id|TGT_Q
c_func
(paren
id|ha
comma
id|tgt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tq
op_eq
l_int|NULL
)paren
(brace
id|tq
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|os_tgt_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tq
op_ne
l_int|NULL
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Alloc Target %d @ %p&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|tgt
comma
id|tq
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|tq
comma
l_int|0
comma
r_sizeof
(paren
id|os_tgt_t
)paren
)paren
suffix:semicolon
id|tq-&gt;ha
op_assign
id|ha
suffix:semicolon
id|TGT_Q
c_func
(paren
id|ha
comma
id|tgt
)paren
op_assign
id|tq
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tq
op_ne
l_int|NULL
)paren
(brace
id|tq-&gt;port_down_retry_count
op_assign
id|ha-&gt;port_down_retry_count
suffix:semicolon
)brace
r_else
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Unable to allocate target.&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;mem_err
op_increment
suffix:semicolon
)brace
r_return
(paren
id|tq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_tgt_free&n; *&t;Frees target and LUN queues.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;t = SCSI target number.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_void
DECL|function|qla2x00_tgt_free
id|qla2x00_tgt_free
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|tgt
)paren
(brace
id|os_tgt_t
op_star
id|tq
suffix:semicolon
r_uint16
id|lun
suffix:semicolon
multiline_comment|/*&n;&t; * If SCSI addressing OK, allocate TGT queue and lock.&n;&t; */
r_if
c_cond
(paren
id|tgt
op_ge
id|MAX_TARGETS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Unable to de-allocate target, &quot;
l_string|&quot;invalid target number %d.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|tgt
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tq
op_assign
id|TGT_Q
c_func
(paren
id|ha
comma
id|tgt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tq
op_ne
l_int|NULL
)paren
(brace
id|TGT_Q
c_func
(paren
id|ha
comma
id|tgt
)paren
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Free LUN structures. */
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
id|MAX_LUNS
suffix:semicolon
id|lun
op_increment
)paren
id|qla2x00_lun_free
c_func
(paren
id|ha
comma
id|tgt
comma
id|lun
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tq
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_lun_alloc&n; *&t;Allocate and initialize LUN queue.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;t = SCSI target number.&n; *&t;l = LUN number.&n; *&n; * Returns:&n; *&t;NULL = failure&n; *&n; * Context:&n; *&t;Kernel context.&n; */
id|os_lun_t
op_star
DECL|function|qla2x00_lun_alloc
id|qla2x00_lun_alloc
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|tgt
comma
r_uint16
id|lun
)paren
(brace
id|os_lun_t
op_star
id|lq
suffix:semicolon
multiline_comment|/*&n;&t; * If SCSI addressing OK, allocate LUN queue.&n;&t; */
r_if
c_cond
(paren
id|tgt
op_ge
id|MAX_TARGETS
op_logical_or
id|lun
op_ge
id|MAX_LUNS
op_logical_or
id|TGT_Q
c_func
(paren
id|ha
comma
id|tgt
)paren
op_eq
l_int|NULL
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Unable to allocate lun, invalid &quot;
l_string|&quot;parameter.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|lq
op_assign
id|LUN_Q
c_func
(paren
id|ha
comma
id|tgt
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lq
op_eq
l_int|NULL
)paren
(brace
id|lq
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|os_lun_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lq
op_ne
l_int|NULL
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Alloc Lun %d @ tgt %d.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|lun
comma
id|tgt
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|lq
comma
l_int|0
comma
r_sizeof
(paren
id|os_lun_t
)paren
)paren
suffix:semicolon
id|LUN_Q
c_func
(paren
id|ha
comma
id|tgt
comma
id|lun
)paren
op_assign
id|lq
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * The following lun queue initialization code&n;&t;&t;&t; * must be duplicated in alloc_ioctl_mem function&n;&t;&t;&t; * for ioctl_lq.&n;&t;&t;&t; */
id|lq-&gt;q_state
op_assign
id|LUN_STATE_READY
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lq-&gt;q_lock
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|lq
op_eq
l_int|NULL
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Unable to allocate lun.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
(paren
id|lq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_lun_free&n; *&t;Frees LUN queue.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;t = SCSI target number.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_void
DECL|function|qla2x00_lun_free
id|qla2x00_lun_free
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|tgt
comma
r_uint16
id|lun
)paren
(brace
id|os_lun_t
op_star
id|lq
suffix:semicolon
multiline_comment|/*&n;&t; * If SCSI addressing OK, allocate TGT queue and lock.&n;&t; */
r_if
c_cond
(paren
id|tgt
op_ge
id|MAX_TARGETS
op_logical_or
id|lun
op_ge
id|MAX_LUNS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Unable to deallocate lun, invalid &quot;
l_string|&quot;parameter.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TGT_Q
c_func
(paren
id|ha
comma
id|tgt
)paren
op_ne
l_int|NULL
op_logical_and
(paren
id|lq
op_assign
id|LUN_Q
c_func
(paren
id|ha
comma
id|tgt
comma
id|lun
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|LUN_Q
c_func
(paren
id|ha
comma
id|tgt
comma
id|lun
)paren
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|lq
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n; * qla2x00_get_lun_mask_from_config&n; *      Get lun mask from the configuration parameters.&n; *      Bit order is little endian.&n; *&n; * Input:&n; * ha  -- Host adapter&n; * tgt  -- target/device number&n; * port -- pointer to port&n; */
r_static
r_void
id|qla2x00_get_lun_mask_from_config
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
comma
r_uint16
id|tgt
comma
r_uint16
id|dev_no
)paren
(brace
r_char
id|propbuf
(braket
l_int|60
)braket
suffix:semicolon
multiline_comment|/* size of search string */
r_int
id|rval
comma
id|lun
comma
id|bit
suffix:semicolon
id|lun_bit_mask_t
id|lun_mask
comma
op_star
id|mask_ptr
op_assign
op_amp
id|lun_mask
suffix:semicolon
multiline_comment|/* Get &quot;target-N-device-N-lun-mask&quot; as a 256 bit lun_mask*/
id|sprintf
c_func
(paren
id|propbuf
comma
l_string|&quot;scsi-qla%ld-tgt-%d-di-%d-lun-disabled&quot;
comma
id|ha-&gt;instance
comma
id|tgt
comma
id|dev_no
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_get_prop_xstr
c_func
(paren
id|ha
comma
id|propbuf
comma
(paren
r_uint8
op_star
)paren
op_amp
id|lun_mask
comma
r_sizeof
(paren
id|lun_bit_mask_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
r_sizeof
(paren
id|lun_bit_mask_t
)paren
)paren
(brace
id|memset
c_func
(paren
op_amp
id|fcport-&gt;lun_mask
comma
l_int|0
comma
r_sizeof
(paren
id|lun_bit_mask_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|lun
op_assign
l_int|8
op_star
r_sizeof
(paren
id|lun_bit_mask_t
)paren
op_minus
l_int|1
comma
id|bit
op_assign
l_int|0
suffix:semicolon
id|lun
op_ge
l_int|0
suffix:semicolon
id|lun
op_decrement
comma
id|bit
op_increment
)paren
(brace
r_if
c_cond
(paren
id|EXT_IS_LUN_BIT_SET
c_func
(paren
id|mask_ptr
comma
id|lun
)paren
)paren
id|EXT_SET_LUN_BIT
c_func
(paren
(paren
op_amp
id|fcport-&gt;lun_mask
)paren
comma
id|bit
)paren
suffix:semicolon
)brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): returning lun mask for fcport &quot;
l_string|&quot;%02x%02x%02x%02x%02x%02x%02x%02x:&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;port_name
(braket
l_int|0
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|1
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|2
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|3
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|4
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|5
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|6
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|fcport-&gt;lun_mask
comma
r_sizeof
(paren
id|lun_bit_mask_t
)paren
)paren
suffix:semicolon
)paren
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; * qla2x00_bstr_to_hex&n; *&t;Convert hex byte string to number.&n; *&n; * Input:&n; *&t;s = byte string pointer.&n; *&t;bp = byte pointer for number.&n; *&t;size = number of bytes.&n; *&n; * Context:&n; *&t;Kernel/Interrupt context.&n; */
r_static
r_int
DECL|function|qla2x00_bstr_to_hex
id|qla2x00_bstr_to_hex
c_func
(paren
r_char
op_star
id|s
comma
r_uint8
op_star
id|bp
comma
r_int
id|size
)paren
(brace
r_int
id|cnt
suffix:semicolon
r_uint8
id|n
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
op_star
id|s
op_ne
l_char|&squot;&bslash;0&squot;
op_logical_and
id|cnt
op_div
l_int|2
OL
id|size
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|s
op_ge
l_char|&squot;A&squot;
op_logical_and
op_star
id|s
op_le
l_char|&squot;F&squot;
)paren
(brace
id|n
op_assign
(paren
op_star
id|s
op_increment
op_minus
l_char|&squot;A&squot;
)paren
op_plus
l_int|10
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|s
op_ge
l_char|&squot;a&squot;
op_logical_and
op_star
id|s
op_le
l_char|&squot;f&squot;
)paren
(brace
id|n
op_assign
(paren
op_star
id|s
op_increment
op_minus
l_char|&squot;a&squot;
)paren
op_plus
l_int|10
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|s
op_ge
l_char|&squot;0&squot;
op_logical_and
op_star
id|s
op_le
l_char|&squot;9&squot;
)paren
(brace
id|n
op_assign
op_star
id|s
op_increment
op_minus
l_char|&squot;0&squot;
suffix:semicolon
)brace
r_else
(brace
id|cnt
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
op_amp
id|BIT_0
)paren
op_star
id|bp
op_increment
op_or_assign
id|n
suffix:semicolon
r_else
op_star
id|bp
op_assign
id|n
op_lshift
l_int|4
suffix:semicolon
)brace
multiline_comment|/* fixme(dg) Need to swap data little endian */
r_return
(paren
id|cnt
op_div
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_get_prop_xstr&n; *      Get a string property value for the specified property name and&n; *      convert from the property string found in the configuration file,&n; *      which are ASCII characters representing nibbles, 2 characters represent&n; *      the hexdecimal value for a byte in the byte array.&n; *      The byte array is initialized to zero.&n; *      The resulting converted value is in big endian format (MSB at byte0).&n; *&n; * Input:&n; *      ha = adapter state pointer.&n; *      propname = property name pointer.&n; *      propval  = pointer where to store converted property val.&n; *      size = max or expected size of &squot;propval&squot; array.&n; *&n; * Returns:&n; *      0 = empty value string or invalid character in string&n; *      &gt;0 = count of characters converted&n; *      -1 = property not found&n; *&n; * Context:&n; *      Kernel context.&n; */
r_int
DECL|function|qla2x00_get_prop_xstr
id|qla2x00_get_prop_xstr
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_char
op_star
id|propname
comma
r_uint8
op_star
id|propval
comma
r_int
id|size
)paren
(brace
r_char
op_star
id|propstr
suffix:semicolon
r_int
id|rval
op_assign
op_minus
l_int|1
suffix:semicolon
r_static
r_char
id|buf
(braket
id|LINESIZE
)braket
suffix:semicolon
multiline_comment|/* Get the requested property string */
id|rval
op_assign
id|qla2x00_find_propname
c_func
(paren
id|ha
comma
id|propname
comma
id|buf
comma
id|ha-&gt;cmdline
comma
id|size
op_star
l_int|2
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Ret rval from find propname = %d&bslash;n&quot;
comma
id|__func__
comma
id|rval
)paren
suffix:semicolon
)paren
id|propstr
op_assign
op_amp
id|buf
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_star
id|propstr
op_eq
l_char|&squot;=&squot;
)paren
id|propstr
op_increment
suffix:semicolon
multiline_comment|/* ignore equal sign */
r_if
c_cond
(paren
id|rval
op_eq
l_int|0
)paren
(brace
multiline_comment|/* not found */
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|rval
op_assign
id|qla2x00_bstr_to_hex
c_func
(paren
id|propstr
comma
(paren
r_uint8
op_star
)paren
id|propval
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Invalid character in value string */
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;%s(): %s Invalid hex string for property&bslash;n&quot;
comma
id|__func__
comma
id|propname
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot; Invalid string - %s&bslash;n&quot;
comma
id|propstr
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_find_propname&n; *&t;Get property in database.&n; *&n; * Input:&n; *&t;ha = adapter structure pointer.&n; *      db = pointer to database&n; *      propstr = pointer to dest array for string&n; *&t;propname = name of property to search for.&n; *&t;siz = size of property&n; *&n; * Returns:&n; *&t;0 = no property&n; *      size = index of property&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_int
DECL|function|qla2x00_find_propname
id|qla2x00_find_propname
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_char
op_star
id|propname
comma
r_char
op_star
id|propstr
comma
r_char
op_star
id|db
comma
r_int
id|siz
)paren
(brace
r_char
op_star
id|cp
suffix:semicolon
multiline_comment|/* find the specified string */
r_if
c_cond
(paren
id|db
)paren
(brace
multiline_comment|/* find the property name */
r_if
c_cond
(paren
(paren
id|cp
op_assign
id|strstr
c_func
(paren
id|db
comma
id|propname
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_while
c_loop
(paren
(paren
op_star
id|cp
)paren
op_logical_and
op_star
id|cp
op_ne
l_char|&squot;=&squot;
)paren
id|cp
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cp
)paren
(brace
id|strncpy
c_func
(paren
id|propstr
comma
id|cp
comma
id|siz
op_plus
l_int|1
)paren
suffix:semicolon
id|propstr
(braket
id|siz
op_plus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_find_propname: found &quot;
l_string|&quot;property = {%s}&bslash;n&quot;
comma
id|propstr
)paren
suffix:semicolon
)paren
r_return
(paren
id|siz
)paren
suffix:semicolon
multiline_comment|/* match */
)brace
)brace
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n; * qla2x00_get_prop_16chars&n; *&t;Get an 8-byte property value for the specified property name by&n; *      converting from the property string found in the configuration file.&n; *      The resulting converted value is in big endian format (MSB at byte0).&n; *&n; * Input:&n; *&t;ha = adapter state pointer.&n; *&t;propname = property name pointer.&n; *&t;propval  = pointer to location for the converted property val.&n; *      db = pointer to database&n; *&n; * Returns:&n; *&t;0 = value returned successfully.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_int
id|qla2x00_get_prop_16chars
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_char
op_star
id|propname
comma
r_char
op_star
id|propval
comma
r_char
op_star
id|db
)paren
(brace
r_char
op_star
id|propstr
suffix:semicolon
r_int
id|i
comma
id|k
suffix:semicolon
r_int
id|rval
suffix:semicolon
r_uint8
id|nval
suffix:semicolon
r_uint8
op_star
id|pchar
suffix:semicolon
r_uint8
op_star
id|ret_byte
suffix:semicolon
r_uint8
op_star
id|tmp_byte
suffix:semicolon
r_uint8
op_star
id|retval
op_assign
(paren
r_uint8
op_star
)paren
id|propval
suffix:semicolon
r_uint8
id|tmpval
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_uint16
id|max_byte_cnt
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* 16 chars = 8 bytes */
r_uint16
id|max_strlen
op_assign
l_int|16
suffix:semicolon
r_static
r_char
id|buf
(braket
id|LINESIZE
)braket
suffix:semicolon
id|rval
op_assign
id|qla2x00_find_propname
c_func
(paren
id|ha
comma
id|propname
comma
id|buf
comma
id|db
comma
id|max_strlen
)paren
suffix:semicolon
id|propstr
op_assign
op_amp
id|buf
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_star
id|propstr
op_eq
l_char|&squot;=&squot;
)paren
id|propstr
op_increment
suffix:semicolon
multiline_comment|/* ignore equal sign */
r_if
c_cond
(paren
id|rval
op_eq
l_int|0
)paren
(brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Convert string to numbers. */
id|pchar
op_assign
(paren
r_uint8
op_star
)paren
id|propstr
suffix:semicolon
id|tmp_byte
op_assign
(paren
r_uint8
op_star
)paren
id|tmpval
suffix:semicolon
id|rval
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max_strlen
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t; * Check for invalid character, two at a time,&n;&t;&t; * then convert them starting with first byte.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|pchar
(braket
id|i
)braket
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
id|pchar
(braket
id|i
)braket
op_le
l_char|&squot;9&squot;
)paren
)paren
(brace
id|nval
op_assign
id|pchar
(braket
id|i
)braket
op_minus
l_char|&squot;0&squot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|pchar
(braket
id|i
)braket
op_ge
l_char|&squot;A&squot;
)paren
op_logical_and
(paren
id|pchar
(braket
id|i
)braket
op_le
l_char|&squot;F&squot;
)paren
)paren
(brace
id|nval
op_assign
id|pchar
(braket
id|i
)braket
op_minus
l_char|&squot;A&squot;
op_plus
l_int|10
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|pchar
(braket
id|i
)braket
op_ge
l_char|&squot;a&squot;
)paren
op_logical_and
(paren
id|pchar
(braket
id|i
)braket
op_le
l_char|&squot;f&squot;
)paren
)paren
(brace
id|nval
op_assign
id|pchar
(braket
id|i
)braket
op_minus
l_char|&squot;a&squot;
op_plus
l_int|10
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* invalid character */
id|rval
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_amp
id|BIT_0
)paren
(brace
op_star
id|tmp_byte
op_assign
op_star
id|tmp_byte
op_or
id|nval
suffix:semicolon
id|tmp_byte
op_increment
suffix:semicolon
)brace
r_else
(brace
op_star
id|tmp_byte
op_assign
op_star
id|tmp_byte
op_or
id|nval
op_lshift
l_int|4
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rval
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Encountered invalid character. */
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/* Copy over the converted value. */
id|ret_byte
op_assign
id|retval
suffix:semicolon
id|tmp_byte
op_assign
id|tmpval
suffix:semicolon
id|i
op_assign
id|max_byte_cnt
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
op_star
id|ret_byte
op_increment
op_assign
op_star
id|tmp_byte
op_increment
suffix:semicolon
)brace
multiline_comment|/* big endian retval[0]; */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;* qla2x00_get_properties&n;*&t;Find all properties for the specified adapeter in&n;*      command line.&n;*&n;* Input:&n;*&t;ha = adapter block pointer.&n;*&t;cmdline = pointer to command line string&n;*&n;* Context:&n;*&t;Kernel context.&n;*/
r_static
r_void
id|qla2x00_get_properties
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_char
op_star
id|cmdline
)paren
(brace
r_int
id|rval
suffix:semicolon
r_static
r_char
id|propbuf
(braket
id|LINESIZE
)braket
suffix:semicolon
r_uint8
id|fc_name
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* Adapter FC node names. */
id|sprintf
c_func
(paren
id|propbuf
comma
l_string|&quot;scsi-qla%d-adapter-node&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_get_prop_16chars
c_func
(paren
id|ha
comma
id|propbuf
comma
id|fc_name
comma
id|cmdline
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
id|memcpy
c_func
(paren
id|ha-&gt;init_cb-&gt;node_name
comma
id|fc_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
multiline_comment|/* DG 04/07 check portname of adapter */
id|sprintf
c_func
(paren
id|propbuf
comma
l_string|&quot;scsi-qla%d-adapter-port&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_get_prop_16chars
c_func
(paren
id|ha
comma
id|propbuf
comma
id|fc_name
comma
id|cmdline
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
op_logical_and
id|memcmp
c_func
(paren
id|ha-&gt;init_cb-&gt;port_name
comma
id|fc_name
comma
id|WWN_SIZE
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Adapter port name is WWN, and cannot be changed.&n;&t;&t; * Inform users of the mismatch, then just continue driver&n;&t;&t; * loading using the original adapter port name in NVRAM.&n;&t;&t; */
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Found mismatch in adapter port names.&bslash;n&quot;
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;       qla%ld port name found in NVRAM -&gt; &quot;
l_string|&quot;%02x%02x%02x%02x%02x%02x%02x%02x&bslash;n&quot;
comma
id|ha-&gt;instance
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|0
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|1
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|2
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|3
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|4
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|5
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|6
)braket
comma
id|ha-&gt;init_cb-&gt;port_name
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;      qla%ld port name found on command line -&gt; &quot;
l_string|&quot;%02x%02x%02x%02x%02x%02x%02x%02x&bslash;n&quot;
comma
id|ha-&gt;instance
comma
id|fc_name
(braket
l_int|0
)braket
comma
id|fc_name
(braket
l_int|1
)braket
comma
id|fc_name
(braket
l_int|2
)braket
comma
id|fc_name
(braket
l_int|3
)braket
comma
id|fc_name
(braket
l_int|4
)braket
comma
id|fc_name
(braket
l_int|5
)braket
comma
id|fc_name
(braket
l_int|6
)braket
comma
id|fc_name
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;      Using port name from NVRAM.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|qla2x00_cfg_persistent_binding
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_cfg_persistent_binding&n; *&t;Get driver configuration file target persistent binding entries.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_void
id|qla2x00_cfg_persistent_binding
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_static
r_char
id|propbuf
(braket
id|LINESIZE
)braket
suffix:semicolon
r_char
op_star
id|cmdline
op_assign
id|ha-&gt;cmdline
suffix:semicolon
r_uint16
id|tgt
suffix:semicolon
id|port_id_t
id|d_id
suffix:semicolon
r_uint8
id|portid
(braket
l_int|3
)braket
suffix:semicolon
r_uint8
id|port_name
(braket
l_int|8
)braket
suffix:semicolon
r_for
c_loop
(paren
id|tgt
op_assign
l_int|0
suffix:semicolon
id|tgt
OL
id|MAX_TARGETS
suffix:semicolon
id|tgt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;binding_type
op_eq
id|BIND_BY_PORT_ID
)paren
(brace
id|sprintf
c_func
(paren
id|propbuf
comma
l_string|&quot;scsi-qla%d-tgt-%d-di-0-pid&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
comma
id|tgt
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_get_prop_xstr
c_func
(paren
id|ha
comma
id|propbuf
comma
id|portid
comma
r_sizeof
(paren
id|portid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
r_sizeof
(paren
id|portid
)paren
)paren
r_continue
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|d_id
comma
l_int|0
comma
r_sizeof
(paren
id|port_id_t
)paren
)paren
suffix:semicolon
id|d_id.r.d_id
(braket
l_int|0
)braket
op_assign
id|portid
(braket
l_int|2
)braket
suffix:semicolon
id|d_id.r.d_id
(braket
l_int|1
)braket
op_assign
id|portid
(braket
l_int|1
)braket
suffix:semicolon
id|d_id.r.d_id
(braket
l_int|2
)braket
op_assign
id|portid
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|propbuf
comma
l_string|&quot;scsi-qla%d-tgt-%d-di-0-port&quot;
comma
(paren
r_int
)paren
id|ha-&gt;instance
comma
id|tgt
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_get_prop_16chars
c_func
(paren
id|ha
comma
id|propbuf
comma
id|port_name
comma
id|cmdline
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
r_continue
suffix:semicolon
multiline_comment|/* Fallthru since port_name already populated */
)brace
multiline_comment|/*&n;&t;&t; * Create target context for device.&n;&t;&t; */
r_if
c_cond
(paren
id|ha-&gt;binding_type
op_eq
id|BIND_BY_PORT_ID
)paren
(brace
id|qla2x00_persistent_bind
c_func
(paren
id|ha
comma
l_int|NULL
comma
l_int|NULL
comma
op_amp
id|d_id
comma
id|tgt
)paren
suffix:semicolon
)brace
r_else
(brace
id|qla2x00_persistent_bind
c_func
(paren
id|ha
comma
l_int|NULL
comma
id|port_name
comma
l_int|NULL
comma
id|tgt
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * qla2x00_persistent_bind&n; *&t;Allocates target and fcport.&n; *&n; * Input:&n; *&t;ha:&t;&t;adapter state pointer.&n; *&t;node_name:&t;node name pointer.&n; *&t;port_name:&t;port name pointer.&n; *&t;d_id:&t;&t;port ID pointer.&n; *&t;tgt:&t;&t;OS target number.&n; *&n; * Returns:&n; *&t;success = target queue pointer.&n; *&t;failure = NULL.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
id|os_tgt_t
op_star
id|qla2x00_persistent_bind
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
op_star
id|node_name
comma
r_uint8
op_star
id|port_name
comma
id|port_id_t
op_star
id|d_id
comma
r_uint16
id|tgt
)paren
(brace
id|os_tgt_t
op_star
id|tq
suffix:semicolon
r_uint16
id|tgt2
suffix:semicolon
multiline_comment|/*&n;&t; * Check for duplicates.&n;&t; */
r_for
c_loop
(paren
id|tgt2
op_assign
l_int|0
suffix:semicolon
id|tgt2
OL
id|MAX_TARGETS
suffix:semicolon
id|tgt2
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tq
op_assign
id|TGT_Q
c_func
(paren
id|ha
comma
id|tgt2
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;binding_type
op_eq
id|BIND_BY_PORT_ID
)paren
(brace
r_if
c_cond
(paren
id|tq-&gt;d_id.b24
op_ne
id|d_id-&gt;b24
)paren
(brace
r_continue
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|tq-&gt;port_name
comma
id|port_name
comma
id|WWN_SIZE
)paren
op_ne
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Duplicate persistent bindings found for &quot;
l_string|&quot;WWPN: %02x%02x%02x%02x%02x%02x%02x%02x.&bslash;n&quot;
comma
id|port_name
(braket
l_int|0
)braket
comma
id|port_name
(braket
l_int|1
)braket
comma
id|port_name
(braket
l_int|2
)braket
comma
id|port_name
(braket
l_int|3
)braket
comma
id|port_name
(braket
l_int|4
)braket
comma
id|port_name
(braket
l_int|5
)braket
comma
id|port_name
(braket
l_int|6
)braket
comma
id|port_name
(braket
l_int|7
)braket
)paren
suffix:semicolon
r_return
(paren
id|tq
)paren
suffix:semicolon
)brace
id|tq
op_assign
id|qla2x00_tgt_alloc
c_func
(paren
id|ha
comma
id|tgt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tq
op_eq
l_int|NULL
)paren
(brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node_name
op_ne
l_int|NULL
)paren
(brace
id|memcpy
c_func
(paren
id|tq-&gt;node_name
comma
id|node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port_name
op_ne
l_int|NULL
)paren
(brace
id|memcpy
c_func
(paren
id|tq-&gt;port_name
comma
id|port_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d_id
op_ne
l_int|NULL
)paren
(brace
id|tq-&gt;d_id.b24
op_assign
id|d_id-&gt;b24
suffix:semicolon
)brace
r_return
(paren
id|tq
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;*  qla2x00_abort_isp&n;*      Resets ISP and aborts all outstanding commands.&n;*&n;* Input:&n;*      ha           = adapter block pointer.&n;*&n;* Returns:&n;*      0 = success&n;*/
r_int
DECL|function|qla2x00_abort_isp
id|qla2x00_abort_isp
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_uint16
id|cnt
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.online
)paren
(brace
id|ha-&gt;flags.online
op_assign
id|FALSE
suffix:semicolon
id|clear_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|qla2x00_stats.ispAbort
op_increment
suffix:semicolon
id|ha-&gt;total_isp_aborts
op_increment
suffix:semicolon
multiline_comment|/* used by ioctl */
id|ha-&gt;sns_retry_cnt
op_assign
l_int|0
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Performing ISP error recovery - ha= %p.&bslash;n&quot;
comma
id|ha
)paren
suffix:semicolon
id|qla2x00_reset_chip
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_ne
id|LOOP_DOWN
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_DOWN
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
comma
id|LOOP_DOWN_TIME
)paren
suffix:semicolon
id|qla2x00_mark_all_devices_lost
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Requeue all commands in outstanding command list. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;actthreads
)paren
id|ha-&gt;actthreads
op_decrement
suffix:semicolon
id|sp-&gt;lun_queue-&gt;out_cnt
op_decrement
suffix:semicolon
id|sp-&gt;flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Set the cmd host_byte status depending on&n;&t;&t;&t;&t; * whether the scsi_error_handler is&n;&t;&t;&t;&t; * active or not.&n; &t;&t;&t;&t; */
r_if
c_cond
(paren
id|ha-&gt;host-&gt;eh_active
op_ne
id|EH_ACTIVE
)paren
(brace
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
)brace
id|sp-&gt;cmd-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
l_int|NULL
suffix:semicolon
id|add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|qla2x00_nvram_config
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qla2x00_restart_isp
c_func
(paren
id|ha
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|RESET_MARKER_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Issue marker command only when we are going&n;&t;&t;&t;&t; * to start the I/O .&n;&t;&t;&t;&t; */
id|ha-&gt;marker_needed
op_assign
l_int|1
suffix:semicolon
)brace
id|ha-&gt;flags.online
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Enable ISP interrupts. */
id|qla2x00_enable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* v2.19.5b6 Return all commands */
id|qla2x00_abort_queues
c_func
(paren
id|ha
comma
id|TRUE
)paren
suffix:semicolon
multiline_comment|/* Restart queues that may have been stopped. */
id|qla2x00_restart_queues
c_func
(paren
id|ha
comma
id|TRUE
)paren
suffix:semicolon
id|ha-&gt;isp_abort_cnt
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
id|ISP_ABORT_RETRY
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* failed the ISP abort */
id|ha-&gt;flags.online
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|ISP_ABORT_RETRY
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;isp_abort_cnt
op_eq
l_int|0
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;ISP error recovery failed - &quot;
l_string|&quot;board disabled&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t;&t;&t; * The next call disables the board&n;&t;&t;&t;&t;&t; * completely.&n;&t;&t;&t;&t;&t; */
id|qla2x00_reset_adapter
c_func
(paren
id|ha
)paren
suffix:semicolon
id|qla2x00_abort_queues
c_func
(paren
id|ha
comma
id|FALSE
)paren
suffix:semicolon
id|ha-&gt;flags.online
op_assign
id|FALSE
suffix:semicolon
id|clear_bit
c_func
(paren
id|ISP_ABORT_RETRY
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* schedule another ISP abort */
id|ha-&gt;isp_abort_cnt
op_decrement
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla%ld: ISP abort - &quot;
l_string|&quot;retry remainning %d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|ha-&gt;isp_abort_cnt
)paren
suffix:semicolon
)paren
id|status
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|ha-&gt;isp_abort_cnt
op_assign
id|MAX_RETRIES_OF_ISP_ABORT
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00(%ld): ISP error recovery &quot;
l_string|&quot;- retrying (%d) more times&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|ha-&gt;isp_abort_cnt
)paren
suffix:semicolon
)paren
id|set_bit
c_func
(paren
id|ISP_ABORT_RETRY
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;qla2x00_abort_isp: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla2x00_abort_isp(%ld): exiting.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n;*  qla2x00_restart_isp&n;*      restarts the ISP after a reset&n;*&n;* Input:&n;*      ha = adapter block pointer.&n;*&n;* Returns:&n;*      0 = success&n;*/
r_static
r_int
DECL|function|qla2x00_restart_isp
id|qla2x00_restart_isp
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_uint8
id|status
op_assign
l_int|0
suffix:semicolon
id|device_reg_t
op_star
id|reg
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_uint32
id|wait_time
suffix:semicolon
multiline_comment|/* If firmware needs to be loaded */
r_if
c_cond
(paren
id|qla2x00_isp_firmware
c_func
(paren
id|ha
)paren
)paren
(brace
id|ha-&gt;flags.online
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla2x00_chip_diag
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
id|status
op_assign
id|qla2x00_setup_chip
c_func
(paren
id|ha
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Disable SRAM, Instruction RAM and GP RAM parity. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
(paren
id|HCCR_ENABLE_PARITY
op_plus
l_int|0x0
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|qla2x00_setup_chip
c_func
(paren
id|ha
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Enable proper parity */
r_if
c_cond
(paren
id|IS_QLA2300
c_func
(paren
id|ha
)paren
)paren
multiline_comment|/* SRAM parity */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
(paren
id|HCCR_ENABLE_PARITY
op_plus
l_int|0x1
)paren
)paren
suffix:semicolon
r_else
multiline_comment|/* SRAM, Instruction RAM and GP RAM parity */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
(paren
id|HCCR_ENABLE_PARITY
op_plus
l_int|0x7
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
id|done
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|status
op_logical_and
op_logical_neg
(paren
id|status
op_assign
id|qla2x00_init_rings
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|RESET_MARKER_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla2x00_fw_ready
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Start configure loop, &quot;
l_string|&quot;status = %d&bslash;n&quot;
comma
id|__func__
comma
id|status
)paren
suffix:semicolon
)paren
id|ha-&gt;flags.online
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Wait at most MAX_TARGET RSCNs for a stable link. */
id|wait_time
op_assign
l_int|256
suffix:semicolon
r_do
(brace
id|clear_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|qla2x00_configure_loop
c_func
(paren
id|ha
)paren
suffix:semicolon
id|wait_time
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_and
op_logical_neg
(paren
id|test_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
op_logical_and
id|wait_time
op_logical_and
(paren
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* if no cable then assume it&squot;s good */
r_if
c_cond
(paren
(paren
id|ha-&gt;device_flags
op_amp
id|DFLG_NO_CABLE
)paren
)paren
id|status
op_assign
l_int|0
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Configure loop done, status = 0x%x&bslash;n&quot;
comma
id|__func__
comma
id|status
)paren
suffix:semicolon
)paren
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;* qla2x00_reset_adapter&n;*      Reset adapter.&n;*&n;* Input:&n;*      ha = adapter block pointer.&n;*/
r_static
r_void
DECL|function|qla2x00_reset_adapter
id|qla2x00_reset_adapter
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|ha-&gt;flags.online
op_assign
id|FALSE
suffix:semicolon
id|qla2x00_disable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Reset RISC processor. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_RESET_RISC
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_RELEASE_RISC
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
)brace
eof
