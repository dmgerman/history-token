multiline_comment|/*&n; *                  QLOGIC LINUX SOFTWARE&n; *&n; * QLogic ISP2x00 device driver for Linux 2.6.x&n; * Copyright (C) 2003 QLogic Corporation&n; * (www.qlogic.com)&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; */
macro_line|#include &quot;qla_os.h&quot;
macro_line|#include &quot;qla_def.h&quot;
multiline_comment|/* XXX(hch): this is ugly, but we don&squot;t want to pull in exioctl.h */
macro_line|#ifndef EXT_DEF_FC4_TYPE_SCSI
DECL|macro|EXT_DEF_FC4_TYPE_SCSI
mdefine_line|#define EXT_DEF_FC4_TYPE_SCSI&t;&t;0x1
macro_line|#endif
r_static
r_inline
id|ms_iocb_entry_t
op_star
id|qla2x00_prep_ms_iocb
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint32
comma
r_uint32
)paren
suffix:semicolon
r_static
r_inline
r_struct
id|ct_sns_req
op_star
id|qla2x00_prep_ct_req
c_func
(paren
r_struct
id|ct_sns_req
op_star
comma
r_uint16
comma
r_uint16
)paren
suffix:semicolon
multiline_comment|/**&n; * qla2x00_prep_ms_iocb() - Prepare common MS IOCB fields for SNS CT query.&n; * @ha: HA context&n; * @req_size: request size in bytes&n; * @rsp_size: response size in bytes&n; *&n; * Returns a pointer to the @ha&squot;s ms_iocb.&n; */
r_static
r_inline
id|ms_iocb_entry_t
op_star
DECL|function|qla2x00_prep_ms_iocb
id|qla2x00_prep_ms_iocb
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint32
id|req_size
comma
r_uint32
id|rsp_size
)paren
(brace
id|ms_iocb_entry_t
op_star
id|ms_pkt
suffix:semicolon
id|ms_pkt
op_assign
id|ha-&gt;ms_iocb
suffix:semicolon
id|memset
c_func
(paren
id|ms_pkt
comma
l_int|0
comma
r_sizeof
(paren
id|ms_iocb_entry_t
)paren
)paren
suffix:semicolon
id|ms_pkt-&gt;entry_type
op_assign
id|MS_IOCB_TYPE
suffix:semicolon
id|ms_pkt-&gt;entry_count
op_assign
l_int|1
suffix:semicolon
id|SET_TARGET_ID
c_func
(paren
id|ha
comma
id|ms_pkt-&gt;loop_id
comma
id|SIMPLE_NAME_SERVER
)paren
suffix:semicolon
id|ms_pkt-&gt;control_flags
op_assign
id|__constant_cpu_to_le16
c_func
(paren
id|CF_READ
op_or
id|CF_HEAD_TAG
)paren
suffix:semicolon
id|ms_pkt-&gt;timeout
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|25
)paren
suffix:semicolon
id|ms_pkt-&gt;cmd_dsd_count
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|ms_pkt-&gt;total_dsd_count
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|ms_pkt-&gt;rsp_bytecount
op_assign
id|cpu_to_le32
c_func
(paren
id|rsp_size
)paren
suffix:semicolon
id|ms_pkt-&gt;req_bytecount
op_assign
id|cpu_to_le32
c_func
(paren
id|req_size
)paren
suffix:semicolon
id|ms_pkt-&gt;dseg_req_address
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|LSD
c_func
(paren
id|ha-&gt;ct_sns_dma
)paren
)paren
suffix:semicolon
id|ms_pkt-&gt;dseg_req_address
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MSD
c_func
(paren
id|ha-&gt;ct_sns_dma
)paren
)paren
suffix:semicolon
id|ms_pkt-&gt;dseg_req_length
op_assign
id|ms_pkt-&gt;req_bytecount
suffix:semicolon
id|ms_pkt-&gt;dseg_rsp_address
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|LSD
c_func
(paren
id|ha-&gt;ct_sns_dma
)paren
)paren
suffix:semicolon
id|ms_pkt-&gt;dseg_rsp_address
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MSD
c_func
(paren
id|ha-&gt;ct_sns_dma
)paren
)paren
suffix:semicolon
id|ms_pkt-&gt;dseg_rsp_length
op_assign
id|ms_pkt-&gt;rsp_bytecount
suffix:semicolon
r_return
(paren
id|ms_pkt
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_prep_ct_req() - Prepare common CT request fields for SNS query.&n; * @ct_req: CT request buffer&n; * @cmd: GS command&n; * @rsp_size: response size in bytes&n; *&n; * Returns a pointer to the intitialized @ct_req.&n; */
r_static
r_inline
r_struct
id|ct_sns_req
op_star
DECL|function|qla2x00_prep_ct_req
id|qla2x00_prep_ct_req
c_func
(paren
r_struct
id|ct_sns_req
op_star
id|ct_req
comma
r_uint16
id|cmd
comma
r_uint16
id|rsp_size
)paren
(brace
id|memset
c_func
(paren
id|ct_req
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ct_sns_pkt
)paren
)paren
suffix:semicolon
id|ct_req-&gt;header.revision
op_assign
l_int|0x01
suffix:semicolon
id|ct_req-&gt;header.gs_type
op_assign
l_int|0xFC
suffix:semicolon
id|ct_req-&gt;header.gs_subtype
op_assign
l_int|0x02
suffix:semicolon
id|ct_req-&gt;command
op_assign
id|cpu_to_be16
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|ct_req-&gt;max_rsp_size
op_assign
id|cpu_to_be16
c_func
(paren
(paren
id|rsp_size
op_minus
l_int|16
)paren
op_div
l_int|4
)paren
suffix:semicolon
r_return
(paren
id|ct_req
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_ga_nxt() - SNS scan for fabric devices via GA_NXT command.&n; * @ha: HA context&n; * @fcport: fcport entry to updated&n; *&n; * Returns 0 on success.&n; */
r_int
DECL|function|qla2x00_ga_nxt
id|qla2x00_ga_nxt
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
)paren
(brace
r_int
id|rval
suffix:semicolon
id|ms_iocb_entry_t
op_star
id|ms_pkt
suffix:semicolon
r_struct
id|ct_sns_req
op_star
id|ct_req
suffix:semicolon
r_struct
id|ct_sns_rsp
op_star
id|ct_rsp
suffix:semicolon
multiline_comment|/* Issue GA_NXT */
multiline_comment|/* Prepare common MS IOCB */
id|ms_pkt
op_assign
id|qla2x00_prep_ms_iocb
c_func
(paren
id|ha
comma
id|GA_NXT_REQ_SIZE
comma
id|GA_NXT_RSP_SIZE
)paren
suffix:semicolon
multiline_comment|/* Prepare CT request */
id|ct_req
op_assign
id|qla2x00_prep_ct_req
c_func
(paren
op_amp
id|ha-&gt;ct_sns-&gt;p.req
comma
id|GA_NXT_CMD
comma
id|GA_NXT_RSP_SIZE
)paren
suffix:semicolon
id|ct_rsp
op_assign
op_amp
id|ha-&gt;ct_sns-&gt;p.rsp
suffix:semicolon
multiline_comment|/* Prepare CT arguments -- port_id */
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|0
)braket
op_assign
id|fcport-&gt;d_id.b.domain
suffix:semicolon
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|1
)braket
op_assign
id|fcport-&gt;d_id.b.area
suffix:semicolon
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|2
)braket
op_assign
id|fcport-&gt;d_id.b.al_pa
suffix:semicolon
multiline_comment|/* Execute MS IOCB */
id|rval
op_assign
id|qla2x00_issue_iocb
c_func
(paren
id|ha
comma
id|ha-&gt;ms_iocb
comma
id|ha-&gt;ms_iocb_dma
comma
r_sizeof
(paren
id|ms_iocb_entry_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GA_NXT issue IOCB failed (%d).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ct_rsp-&gt;header.response
op_ne
id|__constant_cpu_to_be16
c_func
(paren
id|CT_ACCEPT_RESPONSE
)paren
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GA_NXT failed, rejected request, &quot;
l_string|&quot;ga_nxt_rsp:&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG2_3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|ct_rsp-&gt;header
comma
r_sizeof
(paren
r_struct
id|ct_rsp_hdr
)paren
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Populate fc_port_t entry. */
id|fcport-&gt;d_id.b.domain
op_assign
id|ct_rsp-&gt;rsp.ga_nxt.port_id
(braket
l_int|0
)braket
suffix:semicolon
id|fcport-&gt;d_id.b.area
op_assign
id|ct_rsp-&gt;rsp.ga_nxt.port_id
(braket
l_int|1
)braket
suffix:semicolon
id|fcport-&gt;d_id.b.al_pa
op_assign
id|ct_rsp-&gt;rsp.ga_nxt.port_id
(braket
l_int|2
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|fcport-&gt;node_name
comma
id|ct_rsp-&gt;rsp.ga_nxt.node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|fcport-&gt;port_name
comma
id|ct_rsp-&gt;rsp.ga_nxt.port_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ct_rsp-&gt;rsp.ga_nxt.port_type
op_ne
id|NS_N_PORT_TYPE
op_logical_and
id|ct_rsp-&gt;rsp.ga_nxt.port_type
op_ne
id|NS_NL_PORT_TYPE
)paren
id|fcport-&gt;d_id.b.domain
op_assign
l_int|0xf0
suffix:semicolon
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GA_NXT entry - &quot;
l_string|&quot;nn %02x%02x%02x%02x%02x%02x%02x%02x &quot;
l_string|&quot;pn %02x%02x%02x%02x%02x%02x%02x%02x &quot;
l_string|&quot;portid=%02x%02x%02x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|fcport-&gt;node_name
(braket
l_int|0
)braket
comma
id|fcport-&gt;node_name
(braket
l_int|1
)braket
comma
id|fcport-&gt;node_name
(braket
l_int|2
)braket
comma
id|fcport-&gt;node_name
(braket
l_int|3
)braket
comma
id|fcport-&gt;node_name
(braket
l_int|4
)braket
comma
id|fcport-&gt;node_name
(braket
l_int|5
)braket
comma
id|fcport-&gt;node_name
(braket
l_int|6
)braket
comma
id|fcport-&gt;node_name
(braket
l_int|7
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|0
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|1
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|2
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|3
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|4
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|5
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|6
)braket
comma
id|fcport-&gt;port_name
(braket
l_int|7
)braket
comma
id|fcport-&gt;d_id.b.domain
comma
id|fcport-&gt;d_id.b.area
comma
id|fcport-&gt;d_id.b.al_pa
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_gid_pt() - SNS scan for fabric devices via GID_PT command.&n; * @ha: HA context&n; * @list: switch info entries to populate&n; *&n; * NOTE: Non-Nx_Ports are not requested.&n; *&n; * Returns 0 on success.&n; */
r_int
DECL|function|qla2x00_gid_pt
id|qla2x00_gid_pt
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|sw_info_t
op_star
id|list
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint16
id|i
suffix:semicolon
id|ms_iocb_entry_t
op_star
id|ms_pkt
suffix:semicolon
r_struct
id|ct_sns_req
op_star
id|ct_req
suffix:semicolon
r_struct
id|ct_sns_rsp
op_star
id|ct_rsp
suffix:semicolon
r_struct
id|ct_sns_gid_pt_data
op_star
id|gid_data
suffix:semicolon
id|gid_data
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Issue GID_PT */
multiline_comment|/* Prepare common MS IOCB */
id|ms_pkt
op_assign
id|qla2x00_prep_ms_iocb
c_func
(paren
id|ha
comma
id|GID_PT_REQ_SIZE
comma
id|GID_PT_RSP_SIZE
)paren
suffix:semicolon
multiline_comment|/* Prepare CT request */
id|ct_req
op_assign
id|qla2x00_prep_ct_req
c_func
(paren
op_amp
id|ha-&gt;ct_sns-&gt;p.req
comma
id|GID_PT_CMD
comma
id|GID_PT_RSP_SIZE
)paren
suffix:semicolon
id|ct_rsp
op_assign
op_amp
id|ha-&gt;ct_sns-&gt;p.rsp
suffix:semicolon
multiline_comment|/* Prepare CT arguments -- port_type */
id|ct_req-&gt;req.gid_pt.port_type
op_assign
id|NS_NX_PORT_TYPE
suffix:semicolon
multiline_comment|/* Execute MS IOCB */
id|rval
op_assign
id|qla2x00_issue_iocb
c_func
(paren
id|ha
comma
id|ha-&gt;ms_iocb
comma
id|ha-&gt;ms_iocb_dma
comma
r_sizeof
(paren
id|ms_iocb_entry_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GID_PT issue IOCB failed (%d).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ct_rsp-&gt;header.response
op_ne
id|__constant_cpu_to_be16
c_func
(paren
id|CT_ACCEPT_RESPONSE
)paren
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GID_PT failed, rejected request, &quot;
l_string|&quot;gid_pt_rsp:&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG2_3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|ct_rsp-&gt;header
comma
r_sizeof
(paren
r_struct
id|ct_rsp_hdr
)paren
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set port IDs in switch info list. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_FIBRE_DEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|gid_data
op_assign
op_amp
id|ct_rsp-&gt;rsp.gid_pt.entries
(braket
id|i
)braket
suffix:semicolon
id|list
(braket
id|i
)braket
dot
id|d_id.b.domain
op_assign
id|gid_data-&gt;port_id
(braket
l_int|0
)braket
suffix:semicolon
id|list
(braket
id|i
)braket
dot
id|d_id.b.area
op_assign
id|gid_data-&gt;port_id
(braket
l_int|1
)braket
suffix:semicolon
id|list
(braket
id|i
)braket
dot
id|d_id.b.al_pa
op_assign
id|gid_data-&gt;port_id
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Last one exit. */
r_if
c_cond
(paren
id|gid_data-&gt;control_byte
op_amp
id|BIT_7
)paren
(brace
id|list
(braket
id|i
)braket
dot
id|d_id.b.rsvd_1
op_assign
id|gid_data-&gt;control_byte
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * If we&squot;ve used all available slots, then the switch is&n;&t;&t; * reporting back more devices that we can handle with this&n;&t;&t; * single call.  Return a failed status, and let GA_NXT handle&n;&t;&t; * the overload.&n;&t;&t; */
r_if
c_cond
(paren
id|i
op_eq
id|MAX_FIBRE_DEVICES
)paren
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_gpn_id() - SNS Get Port Name (GPN_ID) query.&n; * @ha: HA context&n; * @list: switch info entries to populate&n; *&n; * Returns 0 on success.&n; */
r_int
DECL|function|qla2x00_gpn_id
id|qla2x00_gpn_id
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|sw_info_t
op_star
id|list
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint16
id|i
suffix:semicolon
id|ms_iocb_entry_t
op_star
id|ms_pkt
suffix:semicolon
r_struct
id|ct_sns_req
op_star
id|ct_req
suffix:semicolon
r_struct
id|ct_sns_rsp
op_star
id|ct_rsp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_FIBRE_DEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Issue GPN_ID */
multiline_comment|/* Prepare common MS IOCB */
id|ms_pkt
op_assign
id|qla2x00_prep_ms_iocb
c_func
(paren
id|ha
comma
id|GPN_ID_REQ_SIZE
comma
id|GPN_ID_RSP_SIZE
)paren
suffix:semicolon
multiline_comment|/* Prepare CT request */
id|ct_req
op_assign
id|qla2x00_prep_ct_req
c_func
(paren
op_amp
id|ha-&gt;ct_sns-&gt;p.req
comma
id|GPN_ID_CMD
comma
id|GPN_ID_RSP_SIZE
)paren
suffix:semicolon
id|ct_rsp
op_assign
op_amp
id|ha-&gt;ct_sns-&gt;p.rsp
suffix:semicolon
multiline_comment|/* Prepare CT arguments -- port_id */
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|0
)braket
op_assign
id|list
(braket
id|i
)braket
dot
id|d_id.b.domain
suffix:semicolon
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|1
)braket
op_assign
id|list
(braket
id|i
)braket
dot
id|d_id.b.area
suffix:semicolon
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|2
)braket
op_assign
id|list
(braket
id|i
)braket
dot
id|d_id.b.al_pa
suffix:semicolon
multiline_comment|/* Execute MS IOCB */
id|rval
op_assign
id|qla2x00_issue_iocb
c_func
(paren
id|ha
comma
id|ha-&gt;ms_iocb
comma
id|ha-&gt;ms_iocb_dma
comma
r_sizeof
(paren
id|ms_iocb_entry_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GPN_ID issue IOCB failed &quot;
l_string|&quot;(%d).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ct_rsp-&gt;header.response
op_ne
id|__constant_cpu_to_be16
c_func
(paren
id|CT_ACCEPT_RESPONSE
)paren
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GPN_ID failed, rejected &quot;
l_string|&quot;request, gpn_id_rsp:&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG2_3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|ct_rsp-&gt;header
comma
r_sizeof
(paren
r_struct
id|ct_rsp_hdr
)paren
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Save portname */
id|memcpy
c_func
(paren
id|list
(braket
id|i
)braket
dot
id|port_name
comma
id|ct_rsp-&gt;rsp.gpn_id.port_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* Last device exit. */
r_if
c_cond
(paren
id|list
(braket
id|i
)braket
dot
id|d_id.b.rsvd_1
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_gnn_id() - SNS Get Node Name (GPN_ID) query.&n; * @ha: HA context&n; * @list: switch info entries to populate&n; *&n; * Returns 0 on success.&n; */
r_int
DECL|function|qla2x00_gnn_id
id|qla2x00_gnn_id
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|sw_info_t
op_star
id|list
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint16
id|i
suffix:semicolon
id|ms_iocb_entry_t
op_star
id|ms_pkt
suffix:semicolon
r_struct
id|ct_sns_req
op_star
id|ct_req
suffix:semicolon
r_struct
id|ct_sns_rsp
op_star
id|ct_rsp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_FIBRE_DEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Issue GNN_ID */
multiline_comment|/* Prepare common MS IOCB */
id|ms_pkt
op_assign
id|qla2x00_prep_ms_iocb
c_func
(paren
id|ha
comma
id|GNN_ID_REQ_SIZE
comma
id|GNN_ID_RSP_SIZE
)paren
suffix:semicolon
multiline_comment|/* Prepare CT request */
id|ct_req
op_assign
id|qla2x00_prep_ct_req
c_func
(paren
op_amp
id|ha-&gt;ct_sns-&gt;p.req
comma
id|GNN_ID_CMD
comma
id|GNN_ID_RSP_SIZE
)paren
suffix:semicolon
id|ct_rsp
op_assign
op_amp
id|ha-&gt;ct_sns-&gt;p.rsp
suffix:semicolon
multiline_comment|/* Prepare CT arguments -- port_id */
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|0
)braket
op_assign
id|list
(braket
id|i
)braket
dot
id|d_id.b.domain
suffix:semicolon
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|1
)braket
op_assign
id|list
(braket
id|i
)braket
dot
id|d_id.b.area
suffix:semicolon
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|2
)braket
op_assign
id|list
(braket
id|i
)braket
dot
id|d_id.b.al_pa
suffix:semicolon
multiline_comment|/* Execute MS IOCB */
id|rval
op_assign
id|qla2x00_issue_iocb
c_func
(paren
id|ha
comma
id|ha-&gt;ms_iocb
comma
id|ha-&gt;ms_iocb_dma
comma
r_sizeof
(paren
id|ms_iocb_entry_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GNN_ID issue IOCB failed &quot;
l_string|&quot;(%d).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ct_rsp-&gt;header.response
op_ne
id|__constant_cpu_to_be16
c_func
(paren
id|CT_ACCEPT_RESPONSE
)paren
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GNN_ID failed, rejected &quot;
l_string|&quot;request, gnn_id_rsp:&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG2_3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|ct_rsp-&gt;header
comma
r_sizeof
(paren
r_struct
id|ct_rsp_hdr
)paren
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Save nodename */
id|memcpy
c_func
(paren
id|list
(braket
id|i
)braket
dot
id|node_name
comma
id|ct_rsp-&gt;rsp.gnn_id.node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GID_PT entry - &quot;
l_string|&quot;nn %02x%02x%02x%02x%02x%02x%02x%02x &quot;
l_string|&quot;pn %02x%02x%02x%02x%02x%02x%02x%02x &quot;
l_string|&quot;portid=%02x%02x%02x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|list
(braket
id|i
)braket
dot
id|node_name
(braket
l_int|0
)braket
comma
id|list
(braket
id|i
)braket
dot
id|node_name
(braket
l_int|1
)braket
comma
id|list
(braket
id|i
)braket
dot
id|node_name
(braket
l_int|2
)braket
comma
id|list
(braket
id|i
)braket
dot
id|node_name
(braket
l_int|3
)braket
comma
id|list
(braket
id|i
)braket
dot
id|node_name
(braket
l_int|4
)braket
comma
id|list
(braket
id|i
)braket
dot
id|node_name
(braket
l_int|5
)braket
comma
id|list
(braket
id|i
)braket
dot
id|node_name
(braket
l_int|6
)braket
comma
id|list
(braket
id|i
)braket
dot
id|node_name
(braket
l_int|7
)braket
comma
id|list
(braket
id|i
)braket
dot
id|port_name
(braket
l_int|0
)braket
comma
id|list
(braket
id|i
)braket
dot
id|port_name
(braket
l_int|1
)braket
comma
id|list
(braket
id|i
)braket
dot
id|port_name
(braket
l_int|2
)braket
comma
id|list
(braket
id|i
)braket
dot
id|port_name
(braket
l_int|3
)braket
comma
id|list
(braket
id|i
)braket
dot
id|port_name
(braket
l_int|4
)braket
comma
id|list
(braket
id|i
)braket
dot
id|port_name
(braket
l_int|5
)braket
comma
id|list
(braket
id|i
)braket
dot
id|port_name
(braket
l_int|6
)braket
comma
id|list
(braket
id|i
)braket
dot
id|port_name
(braket
l_int|7
)braket
comma
id|list
(braket
id|i
)braket
dot
id|d_id.b.domain
comma
id|list
(braket
id|i
)braket
dot
id|d_id.b.area
comma
id|list
(braket
id|i
)braket
dot
id|d_id.b.al_pa
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Last device exit. */
r_if
c_cond
(paren
id|list
(braket
id|i
)braket
dot
id|d_id.b.rsvd_1
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_gft_id() - SNS Get FC-4 TYPEs (GFT_ID) query.&n; * @ha: HA context&n; * @list: switch info entries to populate&n; *&n; * Returns 0 on success.&n; */
r_int
DECL|function|qla2x00_gft_id
id|qla2x00_gft_id
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|sw_info_t
op_star
id|list
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint16
id|i
suffix:semicolon
id|ms_iocb_entry_t
op_star
id|ms_pkt
suffix:semicolon
r_struct
id|ct_sns_req
op_star
id|ct_req
suffix:semicolon
r_struct
id|ct_sns_rsp
op_star
id|ct_rsp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_FIBRE_DEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Issue GFT_ID */
multiline_comment|/* Prepare common MS IOCB */
id|ms_pkt
op_assign
id|qla2x00_prep_ms_iocb
c_func
(paren
id|ha
comma
id|GFT_ID_REQ_SIZE
comma
id|GFT_ID_RSP_SIZE
)paren
suffix:semicolon
multiline_comment|/* Prepare CT request */
id|ct_req
op_assign
id|qla2x00_prep_ct_req
c_func
(paren
op_amp
id|ha-&gt;ct_sns-&gt;p.req
comma
id|GFT_ID_CMD
comma
id|GFT_ID_RSP_SIZE
)paren
suffix:semicolon
id|ct_rsp
op_assign
op_amp
id|ha-&gt;ct_sns-&gt;p.rsp
suffix:semicolon
multiline_comment|/* Prepare CT arguments -- port_id */
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|0
)braket
op_assign
id|list
(braket
id|i
)braket
dot
id|d_id.b.domain
suffix:semicolon
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|1
)braket
op_assign
id|list
(braket
id|i
)braket
dot
id|d_id.b.area
suffix:semicolon
id|ct_req-&gt;req.port_id.port_id
(braket
l_int|2
)braket
op_assign
id|list
(braket
id|i
)braket
dot
id|d_id.b.al_pa
suffix:semicolon
multiline_comment|/* Execute MS IOCB */
id|rval
op_assign
id|qla2x00_issue_iocb
c_func
(paren
id|ha
comma
id|ha-&gt;ms_iocb
comma
id|ha-&gt;ms_iocb_dma
comma
r_sizeof
(paren
id|ms_iocb_entry_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GFT_ID issue IOCB failed &quot;
l_string|&quot;(%d).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ct_rsp-&gt;header.response
op_ne
id|__constant_cpu_to_be16
c_func
(paren
id|CT_ACCEPT_RESPONSE
)paren
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): GFT_ID failed, rejected &quot;
l_string|&quot;request, gft_id_rsp:&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG2_3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|ct_rsp-&gt;header
comma
r_sizeof
(paren
r_struct
id|ct_rsp_hdr
)paren
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FCP-3 check necessary?  No, assume FCP-3 */
multiline_comment|/*if (ct_rsp-&gt;rsp.gft_id.fc4_types[2] &amp; 0x01)*/
id|list
(braket
id|i
)braket
dot
id|type
op_assign
id|SW_TYPE_SCSI
suffix:semicolon
r_if
c_cond
(paren
id|ct_rsp-&gt;rsp.gft_id.fc4_types
(braket
l_int|3
)braket
op_amp
l_int|0x20
)paren
id|list
(braket
id|i
)braket
dot
id|type
op_or_assign
id|SW_TYPE_IP
suffix:semicolon
)brace
multiline_comment|/* Last device exit. */
r_if
c_cond
(paren
id|list
(braket
id|i
)braket
dot
id|d_id.b.rsvd_1
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_rft_id() - SNS Register FC-4 TYPEs (RFT_ID) supported by the HBA.&n; * @ha: HA context&n; *&n; * Returns 0 on success.&n; */
r_int
DECL|function|qla2x00_rft_id
id|qla2x00_rft_id
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
id|ms_iocb_entry_t
op_star
id|ms_pkt
suffix:semicolon
r_struct
id|ct_sns_req
op_star
id|ct_req
suffix:semicolon
r_struct
id|ct_sns_rsp
op_star
id|ct_rsp
suffix:semicolon
multiline_comment|/* Issue RFT_ID */
multiline_comment|/* Prepare common MS IOCB */
id|ms_pkt
op_assign
id|qla2x00_prep_ms_iocb
c_func
(paren
id|ha
comma
id|RFT_ID_REQ_SIZE
comma
id|RFT_ID_RSP_SIZE
)paren
suffix:semicolon
multiline_comment|/* Prepare CT request */
id|ct_req
op_assign
id|qla2x00_prep_ct_req
c_func
(paren
op_amp
id|ha-&gt;ct_sns-&gt;p.req
comma
id|RFT_ID_CMD
comma
id|RFT_ID_RSP_SIZE
)paren
suffix:semicolon
id|ct_rsp
op_assign
op_amp
id|ha-&gt;ct_sns-&gt;p.rsp
suffix:semicolon
multiline_comment|/* Prepare CT arguments -- port_id, FC-4 types */
id|ct_req-&gt;req.rft_id.port_id
(braket
l_int|0
)braket
op_assign
id|ha-&gt;d_id.b.domain
suffix:semicolon
id|ct_req-&gt;req.rft_id.port_id
(braket
l_int|1
)braket
op_assign
id|ha-&gt;d_id.b.area
suffix:semicolon
id|ct_req-&gt;req.rft_id.port_id
(braket
l_int|2
)braket
op_assign
id|ha-&gt;d_id.b.al_pa
suffix:semicolon
id|ct_req-&gt;req.rft_id.fc4_types
(braket
l_int|2
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* FCP-3 */
id|ha-&gt;active_fc4_types
op_assign
id|EXT_DEF_FC4_TYPE_SCSI
suffix:semicolon
multiline_comment|/* Execute MS IOCB */
id|rval
op_assign
id|qla2x00_issue_iocb
c_func
(paren
id|ha
comma
id|ha-&gt;ms_iocb
comma
id|ha-&gt;ms_iocb_dma
comma
r_sizeof
(paren
id|ms_iocb_entry_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RFT_ID issue IOCB failed (%d).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ct_rsp-&gt;header.response
op_ne
id|__constant_cpu_to_be16
c_func
(paren
id|CT_ACCEPT_RESPONSE
)paren
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RFT_ID failed, rejected &quot;
l_string|&quot;request, rft_id_rsp:&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG2_3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|ct_rsp-&gt;header
comma
r_sizeof
(paren
r_struct
id|ct_rsp_hdr
)paren
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RFT_ID exiting normally.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_rff_id() - SNS Register FC-4 Features (RFF_ID) supported by the HBA.&n; * @ha: HA context&n; *&n; * Returns 0 on success.&n; */
r_int
DECL|function|qla2x00_rff_id
id|qla2x00_rff_id
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
id|ms_iocb_entry_t
op_star
id|ms_pkt
suffix:semicolon
r_struct
id|ct_sns_req
op_star
id|ct_req
suffix:semicolon
r_struct
id|ct_sns_rsp
op_star
id|ct_rsp
suffix:semicolon
multiline_comment|/* Issue RFF_ID */
multiline_comment|/* Prepare common MS IOCB */
id|ms_pkt
op_assign
id|qla2x00_prep_ms_iocb
c_func
(paren
id|ha
comma
id|RFF_ID_REQ_SIZE
comma
id|RFF_ID_RSP_SIZE
)paren
suffix:semicolon
multiline_comment|/* Prepare CT request */
id|ct_req
op_assign
id|qla2x00_prep_ct_req
c_func
(paren
op_amp
id|ha-&gt;ct_sns-&gt;p.req
comma
id|RFF_ID_CMD
comma
id|RFF_ID_RSP_SIZE
)paren
suffix:semicolon
id|ct_rsp
op_assign
op_amp
id|ha-&gt;ct_sns-&gt;p.rsp
suffix:semicolon
multiline_comment|/* Prepare CT arguments -- port_id, FC-4 feature, FC-4 type */
id|ct_req-&gt;req.rff_id.port_id
(braket
l_int|0
)braket
op_assign
id|ha-&gt;d_id.b.domain
suffix:semicolon
id|ct_req-&gt;req.rff_id.port_id
(braket
l_int|1
)braket
op_assign
id|ha-&gt;d_id.b.area
suffix:semicolon
id|ct_req-&gt;req.rff_id.port_id
(braket
l_int|2
)braket
op_assign
id|ha-&gt;d_id.b.al_pa
suffix:semicolon
id|ct_req-&gt;req.rff_id.fc4_type
op_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* SCSI - FCP */
multiline_comment|/* Execute MS IOCB */
id|rval
op_assign
id|qla2x00_issue_iocb
c_func
(paren
id|ha
comma
id|ha-&gt;ms_iocb
comma
id|ha-&gt;ms_iocb_dma
comma
r_sizeof
(paren
id|ms_iocb_entry_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RFF_ID issue IOCB failed (%d).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ct_rsp-&gt;header.response
op_ne
id|__constant_cpu_to_be16
c_func
(paren
id|CT_ACCEPT_RESPONSE
)paren
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RFF_ID failed, rejected &quot;
l_string|&quot;request, rff_id_rsp:&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG2_3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|ct_rsp-&gt;header
comma
r_sizeof
(paren
r_struct
id|ct_rsp_hdr
)paren
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RFF_ID exiting normally.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_rnn_id() - SNS Register Node Name (RNN_ID) of the HBA.&n; * @ha: HA context&n; *&n; * Returns 0 on success.&n; */
r_int
DECL|function|qla2x00_rnn_id
id|qla2x00_rnn_id
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
id|ms_iocb_entry_t
op_star
id|ms_pkt
suffix:semicolon
r_struct
id|ct_sns_req
op_star
id|ct_req
suffix:semicolon
r_struct
id|ct_sns_rsp
op_star
id|ct_rsp
suffix:semicolon
multiline_comment|/* Issue RNN_ID */
multiline_comment|/* Prepare common MS IOCB */
id|ms_pkt
op_assign
id|qla2x00_prep_ms_iocb
c_func
(paren
id|ha
comma
id|RNN_ID_REQ_SIZE
comma
id|RNN_ID_RSP_SIZE
)paren
suffix:semicolon
multiline_comment|/* Prepare CT request */
id|ct_req
op_assign
id|qla2x00_prep_ct_req
c_func
(paren
op_amp
id|ha-&gt;ct_sns-&gt;p.req
comma
id|RNN_ID_CMD
comma
id|RNN_ID_RSP_SIZE
)paren
suffix:semicolon
id|ct_rsp
op_assign
op_amp
id|ha-&gt;ct_sns-&gt;p.rsp
suffix:semicolon
multiline_comment|/* Prepare CT arguments -- port_id, node_name */
id|ct_req-&gt;req.rnn_id.port_id
(braket
l_int|0
)braket
op_assign
id|ha-&gt;d_id.b.domain
suffix:semicolon
id|ct_req-&gt;req.rnn_id.port_id
(braket
l_int|1
)braket
op_assign
id|ha-&gt;d_id.b.area
suffix:semicolon
id|ct_req-&gt;req.rnn_id.port_id
(braket
l_int|2
)braket
op_assign
id|ha-&gt;d_id.b.al_pa
suffix:semicolon
id|memcpy
c_func
(paren
id|ct_req-&gt;req.rnn_id.node_name
comma
id|ha-&gt;init_cb-&gt;node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
multiline_comment|/* Execute MS IOCB */
id|rval
op_assign
id|qla2x00_issue_iocb
c_func
(paren
id|ha
comma
id|ha-&gt;ms_iocb
comma
id|ha-&gt;ms_iocb_dma
comma
r_sizeof
(paren
id|ms_iocb_entry_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RNN_ID issue IOCB failed (%d).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ct_rsp-&gt;header.response
op_ne
id|__constant_cpu_to_be16
c_func
(paren
id|CT_ACCEPT_RESPONSE
)paren
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RNN_ID failed, rejected &quot;
l_string|&quot;request, rnn_id_rsp:&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG2_3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|ct_rsp-&gt;header
comma
r_sizeof
(paren
r_struct
id|ct_rsp_hdr
)paren
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RNN_ID exiting normally.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_rsnn_nn() - SNS Register Symbolic Node Name (RSNN_NN) of the HBA.&n; * @ha: HA context&n; *&n; * Returns 0 on success.&n; */
r_int
DECL|function|qla2x00_rsnn_nn
id|qla2x00_rsnn_nn
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint8
op_star
id|snn
suffix:semicolon
r_uint8
id|version
(braket
l_int|20
)braket
suffix:semicolon
id|ms_iocb_entry_t
op_star
id|ms_pkt
suffix:semicolon
r_struct
id|ct_sns_req
op_star
id|ct_req
suffix:semicolon
r_struct
id|ct_sns_rsp
op_star
id|ct_rsp
suffix:semicolon
multiline_comment|/* Issue RSNN_NN */
multiline_comment|/* Prepare common MS IOCB */
multiline_comment|/*   Request size adjusted after CT preparation */
id|ms_pkt
op_assign
id|qla2x00_prep_ms_iocb
c_func
(paren
id|ha
comma
l_int|0
comma
id|RSNN_NN_RSP_SIZE
)paren
suffix:semicolon
multiline_comment|/* Prepare CT request */
id|ct_req
op_assign
id|qla2x00_prep_ct_req
c_func
(paren
op_amp
id|ha-&gt;ct_sns-&gt;p.req
comma
id|RSNN_NN_CMD
comma
id|RSNN_NN_RSP_SIZE
)paren
suffix:semicolon
id|ct_rsp
op_assign
op_amp
id|ha-&gt;ct_sns-&gt;p.rsp
suffix:semicolon
multiline_comment|/* Prepare CT arguments -- node_name, symbolic node_name, size */
id|memcpy
c_func
(paren
id|ct_req-&gt;req.rsnn_nn.node_name
comma
id|ha-&gt;init_cb-&gt;node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
multiline_comment|/* Prepare the Symbolic Node Name */
multiline_comment|/* Board type */
id|snn
op_assign
id|ct_req-&gt;req.rsnn_nn.sym_node_name
suffix:semicolon
id|strcpy
c_func
(paren
id|snn
comma
id|ha-&gt;model_number
)paren
suffix:semicolon
multiline_comment|/* Firmware version */
id|strcat
c_func
(paren
id|snn
comma
l_string|&quot; FW:v&quot;
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|version
comma
l_string|&quot;%d.%02d.%02d&quot;
comma
id|ha-&gt;fw_major_version
comma
id|ha-&gt;fw_minor_version
comma
id|ha-&gt;fw_subminor_version
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|snn
comma
id|version
)paren
suffix:semicolon
multiline_comment|/* Driver version */
id|strcat
c_func
(paren
id|snn
comma
l_string|&quot; DVR:v&quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|snn
comma
id|qla2x00_version_str
)paren
suffix:semicolon
multiline_comment|/* Calculate SNN length */
id|ct_req-&gt;req.rsnn_nn.name_len
op_assign
(paren
r_uint8
)paren
id|strlen
c_func
(paren
id|snn
)paren
suffix:semicolon
multiline_comment|/* Update MS IOCB request */
id|ms_pkt-&gt;req_bytecount
op_assign
id|cpu_to_le32
c_func
(paren
l_int|24
op_plus
l_int|1
op_plus
id|ct_req-&gt;req.rsnn_nn.name_len
)paren
suffix:semicolon
id|ms_pkt-&gt;dseg_req_length
op_assign
id|ms_pkt-&gt;req_bytecount
suffix:semicolon
multiline_comment|/* Execute MS IOCB */
id|rval
op_assign
id|qla2x00_issue_iocb
c_func
(paren
id|ha
comma
id|ha-&gt;ms_iocb
comma
id|ha-&gt;ms_iocb_dma
comma
r_sizeof
(paren
id|ms_iocb_entry_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RSNN_NN issue IOCB failed (%d).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ct_rsp-&gt;header.response
op_ne
id|__constant_cpu_to_be16
c_func
(paren
id|CT_ACCEPT_RESPONSE
)paren
)paren
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RSNN_NN failed, rejected &quot;
l_string|&quot;request, rsnn_id_rsp:&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG2_3
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|ct_rsp-&gt;header
comma
r_sizeof
(paren
r_struct
id|ct_rsp_hdr
)paren
)paren
)paren
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_else
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): RSNN_NN exiting normally.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
eof
