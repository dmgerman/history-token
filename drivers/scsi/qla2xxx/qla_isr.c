multiline_comment|/*&n; *                  QLOGIC LINUX SOFTWARE&n; *&n; * QLogic ISP2x00 device driver for Linux 2.6.x&n; * Copyright (C) 2003-2004 QLogic Corporation&n; * (www.qlogic.com)&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; */
macro_line|#include &quot;qla_os.h&quot;
macro_line|#include &quot;qla_def.h&quot;
r_static
r_void
id|qla2x00_mbx_completion
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint16
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_async_event
c_func
(paren
id|scsi_qla_host_t
op_star
comma
r_uint32
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_process_completed_request
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_uint32
)paren
suffix:semicolon
r_void
id|qla2x00_process_response_queue
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_status_entry
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|sts_entry_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_status_cont_entry
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|sts_cont_entry_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_error_entry
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|sts_entry_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla2x00_ms_entry
c_func
(paren
id|scsi_qla_host_t
op_star
comma
id|ms_iocb_entry_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla2x00_check_sense
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cp
comma
id|os_lun_t
op_star
)paren
suffix:semicolon
multiline_comment|/**&n; * qla2x00_intr_handler() - Process interrupts for the ISP.&n; * @irq:&n; * @dev_id: SCSI driver HA context&n; * @regs:&n; *&n; * Called by system whenever the host adapter generates an interrupt.&n; *&n; * Returns handled flag.&n; */
id|irqreturn_t
DECL|function|qla2x00_intr_handler
id|qla2x00_intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|device_reg_t
op_star
id|reg
suffix:semicolon
r_uint32
id|mbx
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|mbx_flags
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|intr_iter
suffix:semicolon
r_uint32
id|stat
suffix:semicolon
r_uint16
id|hccr
suffix:semicolon
multiline_comment|/* Don&squot;t loop forever, interrupt are OFF */
id|intr_iter
op_assign
l_int|50
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|dev_id
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s(): NULL host pointer&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_return
(paren
id|IRQ_NONE
)paren
suffix:semicolon
)brace
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* Relax CPU! */
r_if
c_cond
(paren
op_logical_neg
(paren
id|intr_iter
op_decrement
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
op_amp
id|ISR_RISC_INT
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
)paren
op_amp
id|BIT_0
)paren
(brace
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_CLR_RISC_INT
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
)paren
suffix:semicolon
multiline_comment|/* Get mailbox data. */
id|mbx
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbx
OG
l_int|0x3fff
op_logical_and
id|mbx
OL
l_int|0x8000
)paren
(brace
id|qla2x00_mbx_completion
c_func
(paren
id|ha
comma
(paren
r_uint16
)paren
id|mbx
)paren
suffix:semicolon
id|status
op_or_assign
id|MBX_INTERRUPT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mbx
OG
l_int|0x7fff
op_logical_and
id|mbx
OL
l_int|0xc000
)paren
(brace
id|qla2x00_async_event
c_func
(paren
id|ha
comma
id|mbx
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Unrecognized &quot;
l_string|&quot;interrupt type (%d)&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|mbx
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Release mailbox registers. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Workaround for ISP2100 chip. */
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
)paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
)paren
suffix:semicolon
)brace
r_else
(brace
id|qla2x00_process_response_queue
c_func
(paren
id|ha
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_CLR_RISC_INT
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* IS_QLA23XX(ha) */
(brace
id|stat
op_assign
id|RD_REG_DWORD
c_func
(paren
op_amp
id|reg-&gt;u.isp2300.host_status
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|HSR_RISC_INT
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|mbx
op_assign
id|MSW
c_func
(paren
id|stat
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|stat
op_amp
l_int|0xff
)paren
(brace
r_case
l_int|0x13
suffix:colon
id|qla2x00_process_response_queue
c_func
(paren
id|ha
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1
suffix:colon
r_case
l_int|0x2
suffix:colon
r_case
l_int|0x10
suffix:colon
r_case
l_int|0x11
suffix:colon
id|qla2x00_mbx_completion
c_func
(paren
id|ha
comma
(paren
r_uint16
)paren
id|mbx
)paren
suffix:semicolon
id|status
op_or_assign
id|MBX_INTERRUPT
suffix:semicolon
multiline_comment|/* Release mailbox registers. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x12
suffix:colon
id|qla2x00_async_event
c_func
(paren
id|ha
comma
id|mbx
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x15
suffix:colon
id|mbx
op_assign
id|mbx
op_lshift
l_int|16
op_or
id|MBA_CMPLT_1_16BIT
suffix:semicolon
id|qla2x00_async_event
c_func
(paren
id|ha
comma
id|mbx
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x16
suffix:colon
id|mbx
op_assign
id|mbx
op_lshift
l_int|16
op_or
id|MBA_SCSI_COMPLETION
suffix:semicolon
id|qla2x00_async_event
c_func
(paren
id|ha
comma
id|mbx
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|hccr
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hccr
op_amp
id|HCCR_RISC_PAUSE
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;RISC paused, dumping HCCR=%x&bslash;n&quot;
comma
id|hccr
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Issue a &quot;HARD&quot; reset in order for&n;&t;&t;&t;&t;&t; * the RISC interrupt bit to be&n;&t;&t;&t;&t;&t; * cleared.  Schedule a big hammmer to&n;&t;&t;&t;&t;&t; * get out of the RISC PAUSED state.&n;&t;&t;&t;&t;&t; */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_RESET_RISC
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Unrecognized &quot;
l_string|&quot;interrupt type (%d)&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|stat
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_CLR_RISC_INT
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
id|qla2x00_next
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ha-&gt;last_irq_cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|ha-&gt;total_isr_cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|MBX_INTR_WAIT
comma
op_amp
id|ha-&gt;mbx_cmd_flags
)paren
op_logical_and
(paren
id|status
op_amp
id|MBX_INTERRUPT
)paren
op_logical_and
id|ha-&gt;flags.mbox_int
)paren
(brace
multiline_comment|/* There was a mailbox completion */
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): Going to get mbx reg lock.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;mbx_reg_lock
comma
id|mbx_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;mcp
op_eq
l_int|NULL
)paren
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): Error mbx pointer.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): Going to set mbx intr flags. &quot;
l_string|&quot;cmd=%x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|ha-&gt;mcp-&gt;mb
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|MBX_INTERRUPT
comma
op_amp
id|ha-&gt;mbx_cmd_flags
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): Going to wake up mbx function for &quot;
l_string|&quot;completion.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ha-&gt;mbx_intr_sem
)paren
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): Going to release mbx reg lock.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;mbx_reg_lock
comma
id|mbx_flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ha-&gt;done_queue
)paren
)paren
id|qla2x00_done
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Wakeup the DPC routine */
r_if
c_cond
(paren
(paren
op_logical_neg
id|ha-&gt;flags.mbox_busy
op_logical_and
(paren
id|test_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
op_logical_or
id|test_bit
c_func
(paren
id|RESET_MARKER_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
op_logical_or
id|test_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
op_logical_and
id|ha-&gt;dpc_wait
op_logical_and
op_logical_neg
id|ha-&gt;dpc_active
)paren
(brace
id|up
c_func
(paren
id|ha-&gt;dpc_wait
)paren
suffix:semicolon
)brace
r_return
(paren
id|IRQ_HANDLED
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_mbx_completion() - Process mailbox command completions.&n; * @ha: SCSI driver HA context&n; * @mb0: Mailbox0 register&n; */
r_static
r_void
DECL|function|qla2x00_mbx_completion
id|qla2x00_mbx_completion
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|mb0
)paren
(brace
r_uint16
id|cnt
suffix:semicolon
r_uint16
op_star
id|wptr
suffix:semicolon
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* Load return mailbox registers. */
id|ha-&gt;flags.mbox_int
op_assign
id|TRUE
suffix:semicolon
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
op_assign
id|mb0
suffix:semicolon
id|wptr
op_assign
(paren
r_uint16
op_star
)paren
id|MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1
suffix:semicolon
id|cnt
OL
id|ha-&gt;mbx_count
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|IS_QLA2200
c_func
(paren
id|ha
)paren
op_logical_and
id|cnt
op_eq
l_int|8
)paren
id|wptr
op_assign
(paren
r_uint16
op_star
)paren
id|MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_eq
l_int|4
op_logical_or
id|cnt
op_eq
l_int|5
)paren
id|ha-&gt;mailbox_out
(braket
id|cnt
)braket
op_assign
id|qla2x00_debounce_register
c_func
(paren
id|wptr
)paren
suffix:semicolon
r_else
id|ha-&gt;mailbox_out
(braket
id|cnt
)braket
op_assign
id|RD_REG_WORD
c_func
(paren
id|wptr
)paren
suffix:semicolon
id|wptr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;mcp
)paren
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): Got mailbox completion. cmd=%x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|ha-&gt;mcp-&gt;mb
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): MBX pointer ERROR!&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * qla2x00_async_event() - Process aynchronous events.&n; * @ha: SCSI driver HA context&n; * @mb0: Mailbox0 register&n; */
r_static
r_void
DECL|function|qla2x00_async_event
id|qla2x00_async_event
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint32
id|mbx
)paren
(brace
r_static
r_char
op_star
id|link_speeds
(braket
l_int|5
)braket
op_assign
(brace
l_string|&quot;1&quot;
comma
l_string|&quot;2&quot;
comma
l_string|&quot;4&quot;
comma
l_string|&quot;?&quot;
comma
l_string|&quot;10&quot;
)brace
suffix:semicolon
r_char
op_star
id|link_speed
suffix:semicolon
r_uint16
id|mb
(braket
l_int|4
)braket
suffix:semicolon
r_uint16
id|handle_cnt
suffix:semicolon
r_uint16
id|cnt
suffix:semicolon
r_uint32
id|handles
(braket
l_int|5
)braket
suffix:semicolon
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint32
id|rscn_entry
comma
id|host_pid
suffix:semicolon
r_uint8
id|rscn_queue_index
suffix:semicolon
multiline_comment|/* Setup to process RIO completion. */
id|handle_cnt
op_assign
l_int|0
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|LSW
c_func
(paren
id|mbx
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mb
(braket
l_int|0
)braket
)paren
(brace
r_case
id|MBA_SCSI_COMPLETION
suffix:colon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
id|handles
(braket
l_int|0
)braket
op_assign
id|le32_to_cpu
c_func
(paren
(paren
(paren
r_uint32
)paren
(paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|2
)paren
op_lshift
l_int|16
)paren
)paren
op_or
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
)paren
suffix:semicolon
r_else
id|handles
(braket
l_int|0
)braket
op_assign
id|le32_to_cpu
c_func
(paren
(paren
(paren
r_uint32
)paren
(paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|2
)paren
op_lshift
l_int|16
)paren
)paren
op_or
id|MSW
c_func
(paren
id|mbx
)paren
)paren
suffix:semicolon
id|handle_cnt
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_CMPLT_1_16BIT
suffix:colon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
id|handles
(braket
l_int|0
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
r_else
id|handles
(braket
l_int|0
)braket
op_assign
id|MSW
c_func
(paren
id|mbx
)paren
suffix:semicolon
id|handle_cnt
op_assign
l_int|1
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBA_SCSI_COMPLETION
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_CMPLT_2_16BIT
suffix:colon
id|handles
(braket
l_int|0
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|handles
(braket
l_int|1
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|2
)paren
suffix:semicolon
id|handle_cnt
op_assign
l_int|2
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBA_SCSI_COMPLETION
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_CMPLT_3_16BIT
suffix:colon
id|handles
(braket
l_int|0
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|handles
(braket
l_int|1
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|2
)paren
suffix:semicolon
id|handles
(braket
l_int|2
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|3
)paren
suffix:semicolon
id|handle_cnt
op_assign
l_int|3
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBA_SCSI_COMPLETION
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_CMPLT_4_16BIT
suffix:colon
id|handles
(braket
l_int|0
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|handles
(braket
l_int|1
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|2
)paren
suffix:semicolon
id|handles
(braket
l_int|2
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|3
)paren
suffix:semicolon
id|handles
(braket
l_int|3
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|6
)paren
suffix:semicolon
id|handle_cnt
op_assign
l_int|4
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBA_SCSI_COMPLETION
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_CMPLT_5_16BIT
suffix:colon
id|handles
(braket
l_int|0
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|handles
(braket
l_int|1
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|2
)paren
suffix:semicolon
id|handles
(braket
l_int|2
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|3
)paren
suffix:semicolon
id|handles
(braket
l_int|3
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|6
)paren
suffix:semicolon
id|handles
(braket
l_int|4
)braket
op_assign
(paren
r_uint32
)paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|7
)paren
suffix:semicolon
id|handle_cnt
op_assign
l_int|5
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBA_SCSI_COMPLETION
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_CMPLT_2_32BIT
suffix:colon
id|handles
(braket
l_int|0
)braket
op_assign
id|le32_to_cpu
c_func
(paren
(paren
(paren
r_uint32
)paren
(paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|2
)paren
op_lshift
l_int|16
)paren
)paren
op_or
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
)paren
suffix:semicolon
id|handles
(braket
l_int|1
)braket
op_assign
id|le32_to_cpu
c_func
(paren
(paren
(paren
r_uint32
)paren
(paren
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|7
)paren
op_lshift
l_int|16
)paren
)paren
op_or
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|6
)paren
)paren
suffix:semicolon
id|handle_cnt
op_assign
l_int|2
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBA_SCSI_COMPLETION
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|mb
(braket
l_int|0
)braket
op_assign
id|LSW
c_func
(paren
id|mbx
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mb
(braket
l_int|0
)braket
)paren
(brace
r_case
id|MBA_SCSI_COMPLETION
suffix:colon
multiline_comment|/* Fast Post */
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.online
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|handle_cnt
suffix:semicolon
id|cnt
op_increment
)paren
id|qla2x00_process_completed_request
c_func
(paren
id|ha
comma
id|handles
(braket
id|cnt
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_RESET
suffix:colon
multiline_comment|/* Reset */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Asynchronous RESET.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|RESET_MARKER_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_SYSTEM_ERR
suffix:colon
multiline_comment|/* System Error */
id|mb
(braket
l_int|1
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|2
)paren
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|3
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;ISP System Error - mbx1=%xh mbx2=%xh mbx3=%xh.&bslash;n&quot;
comma
id|mb
(braket
l_int|1
)braket
comma
id|mb
(braket
l_int|2
)braket
comma
id|mb
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
id|qla2100_fw_dump
c_func
(paren
id|ha
comma
l_int|1
)paren
suffix:semicolon
r_else
id|qla2300_fw_dump
c_func
(paren
id|ha
comma
l_int|1
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_REQ_TRANSFER_ERR
suffix:colon
multiline_comment|/* Request Transfer Error */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): ISP Request Transfer Error.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;ISP Request Transfer Error.&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_RSP_TRANSFER_ERR
suffix:colon
multiline_comment|/* Response Transfer Error */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): ISP Response Transfer Error.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;ISP Response Transfer Error.&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_WAKEUP_THRES
suffix:colon
multiline_comment|/* Request Queue Wake-up */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Asynchronous WAKEUP_THRES.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_LIP_OCCURRED
suffix:colon
multiline_comment|/* Loop Initialization Procedure */
id|mb
(braket
l_int|1
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): LIP occured (%x).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|mb
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;LIP occured (%x).&bslash;n&quot;
comma
id|mb
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_ne
id|LOOP_DOWN
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_DOWN
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
comma
id|LOOP_DOWN_TIME
)paren
suffix:semicolon
id|qla2x00_mark_all_devices_lost
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|REGISTER_FC4_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|ha-&gt;flags.management_server_logged_in
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Update AEN queue. */
id|qla2x00_enqueue_aen
c_func
(paren
id|ha
comma
id|MBA_LIP_OCCURRED
comma
l_int|NULL
)paren
suffix:semicolon
id|ha-&gt;total_lip_cnt
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_LOOP_UP
suffix:colon
multiline_comment|/* Loop Up Event */
id|mb
(braket
l_int|1
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|ha-&gt;link_data_rate
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
(brace
id|link_speed
op_assign
id|link_speeds
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
(brace
id|link_speed
op_assign
id|link_speeds
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
l_int|1
)braket
OL
l_int|5
)paren
id|link_speed
op_assign
id|link_speeds
(braket
id|mb
(braket
l_int|1
)braket
)braket
suffix:semicolon
id|ha-&gt;link_data_rate
op_assign
id|mb
(braket
l_int|1
)braket
suffix:semicolon
)brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Asynchronous LOOP UP (%s Gbps).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|link_speed
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;LOOP UP detected (%s Gbps).&bslash;n&quot;
comma
id|link_speed
)paren
suffix:semicolon
id|ha-&gt;flags.management_server_logged_in
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Update AEN queue. */
id|qla2x00_enqueue_aen
c_func
(paren
id|ha
comma
id|MBA_LOOP_UP
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_LOOP_DOWN
suffix:colon
multiline_comment|/* Loop Down Event */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Asynchronous LOOP DOWN.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;LOOP DOWN detected.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_ne
id|LOOP_DOWN
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_DOWN
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
comma
id|LOOP_DOWN_TIME
)paren
suffix:semicolon
id|qla2x00_mark_all_devices_lost
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
id|ha-&gt;flags.management_server_logged_in
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;link_data_rate
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Update AEN queue. */
id|qla2x00_enqueue_aen
c_func
(paren
id|ha
comma
id|MBA_LOOP_DOWN
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_LIP_RESET
suffix:colon
multiline_comment|/* LIP reset occurred */
id|mb
(braket
l_int|1
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Asynchronous LIP RESET (%x).&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|mb
(braket
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;LIP reset occured (%x).&bslash;n&quot;
comma
id|mb
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_ne
id|LOOP_DOWN
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_DOWN
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
comma
id|LOOP_DOWN_TIME
)paren
suffix:semicolon
id|qla2x00_mark_all_devices_lost
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|RESET_MARKER_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|ha-&gt;operating_mode
op_assign
id|LOOP
suffix:semicolon
id|ha-&gt;flags.management_server_logged_in
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Update AEN queue. */
id|qla2x00_enqueue_aen
c_func
(paren
id|ha
comma
id|MBA_LIP_RESET
comma
l_int|NULL
)paren
suffix:semicolon
id|ha-&gt;total_lip_cnt
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_POINT_TO_POINT
suffix:colon
multiline_comment|/* Point-to-Point */
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
)paren
r_break
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Asynchronous P2P MODE received.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Until there&squot;s a transition from loop down to loop up, treat&n;&t;&t; * this as loop down only.&n;&t;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_ne
id|LOOP_DOWN
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_DOWN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
)paren
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
comma
id|LOOP_DOWN_TIME
)paren
suffix:semicolon
id|qla2x00_mark_all_devices_lost
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|test_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
)paren
)paren
(brace
id|set_bit
c_func
(paren
id|RESET_MARKER_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|REGISTER_FC4_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_CHG_IN_CONNECTION
suffix:colon
multiline_comment|/* Change in connection mode */
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
)paren
r_break
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Asynchronous Change In Connection &quot;
l_string|&quot;received.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Configuration change detected: value=%x.&bslash;n&quot;
comma
id|mb
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_ne
id|LOOP_DOWN
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_DOWN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
)paren
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
comma
id|LOOP_DOWN_TIME
)paren
suffix:semicolon
id|qla2x00_mark_all_devices_lost
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|LOCAL_LOOP_UPDATE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_PORT_UPDATE
suffix:colon
multiline_comment|/* Port database update */
id|mb
(braket
l_int|1
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If a single remote port just logged into (or logged out of)&n;&t;&t; * us, create a new entry in our rscn fcports list and handle&n;&t;&t; * the event like an RSCN.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA2200
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA6312
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA6322
c_func
(paren
id|ha
)paren
op_logical_and
id|ha-&gt;flags.init_done
op_logical_and
id|mb
(braket
l_int|1
)braket
op_ne
l_int|0xffff
op_logical_and
(paren
(paren
id|ha-&gt;operating_mode
op_eq
id|P2P
op_logical_and
id|mb
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
op_logical_or
(paren
id|ha-&gt;operating_mode
op_ne
id|P2P
op_logical_and
id|mb
(braket
l_int|1
)braket
op_ne
id|SNS_FIRST_LOOP_ID
)paren
)paren
op_logical_and
(paren
id|mb
(braket
l_int|2
)braket
op_eq
l_int|6
op_logical_or
id|mb
(braket
l_int|2
)braket
op_eq
l_int|7
)paren
)paren
(brace
r_int
id|rval
suffix:semicolon
id|fc_port_t
op_star
id|rscn_fcport
suffix:semicolon
multiline_comment|/* Create new fcport for login. */
id|rscn_fcport
op_assign
id|qla2x00_alloc_rscn_fcport
c_func
(paren
id|ha
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rscn_fcport
)paren
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Port Update -- &quot;
l_string|&quot;creating RSCN fcport %p for login.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rscn_fcport
)paren
)paren
suffix:semicolon
id|rscn_fcport-&gt;loop_id
op_assign
id|mb
(braket
l_int|1
)braket
suffix:semicolon
id|rscn_fcport-&gt;d_id.b24
op_assign
id|INVALID_PORT_ID
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|rscn_fcport-&gt;state
comma
id|FCS_DEVICE_LOST
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|rscn_fcport-&gt;list
comma
op_amp
id|ha-&gt;rscn_fcports
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_handle_port_rscn
c_func
(paren
id|ha
comma
l_int|0
comma
id|rscn_fcport
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
id|DEBUG14
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Port Update -- &quot;
l_string|&quot;-- unable to allocate RSCN fcport &quot;
l_string|&quot;login.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * If PORT UPDATE is global (recieved LIP_OCCURED/LIP_RESET&n;&t;&t; * event etc. earlier indicating loop is down) then process&n;&t;&t; * it.  Otherwise ignore it and Wait for RSCN to come in.&n;&t;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_ne
id|LOOP_DOWN
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Asynchronous PORT UPDATE &quot;
l_string|&quot;ignored.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Asynchronous PORT UPDATE.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): Port database changed %04x %04x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|mb
(braket
l_int|1
)braket
comma
id|mb
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Mark all devices as missing so we will login again.&n;&t;&t; */
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_UP
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
comma
l_int|0
)paren
suffix:semicolon
id|qla2x00_mark_all_devices_lost
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ha-&gt;flags.rscn_queue_overflow
op_assign
l_int|1
suffix:semicolon
id|set_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|LOCAL_LOOP_UPDATE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
multiline_comment|/* Update AEN queue. */
id|qla2x00_enqueue_aen
c_func
(paren
id|ha
comma
id|MBA_PORT_UPDATE
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_RSCN_UPDATE
suffix:colon
multiline_comment|/* State Change Registration */
id|mb
(braket
l_int|1
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|1
)paren
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|RD_MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|2
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Asynchronous RSCR UPDATE.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): RSCN database changed -- %04x %04x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|mb
(braket
l_int|1
)braket
comma
id|mb
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
id|rscn_entry
op_assign
(paren
id|mb
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
id|mb
(braket
l_int|2
)braket
suffix:semicolon
id|host_pid
op_assign
(paren
id|ha-&gt;d_id.b.domain
op_lshift
l_int|16
)paren
op_or
(paren
id|ha-&gt;d_id.b.area
op_lshift
l_int|8
)paren
op_or
id|ha-&gt;d_id.b.al_pa
suffix:semicolon
r_if
c_cond
(paren
id|rscn_entry
op_eq
id|host_pid
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): Ignoring RSCN update to local host &quot;
l_string|&quot;port ID (%06x)&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|host_pid
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rscn_queue_index
op_assign
id|ha-&gt;rscn_in_ptr
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|rscn_queue_index
op_eq
id|MAX_RSCN_COUNT
)paren
id|rscn_queue_index
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rscn_queue_index
op_ne
id|ha-&gt;rscn_out_ptr
)paren
(brace
id|ha-&gt;rscn_queue
(braket
id|ha-&gt;rscn_in_ptr
)braket
op_assign
id|rscn_entry
suffix:semicolon
id|ha-&gt;rscn_in_ptr
op_assign
id|rscn_queue_index
suffix:semicolon
)brace
r_else
(brace
id|ha-&gt;flags.rscn_queue_overflow
op_assign
l_int|1
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_state
comma
id|LOOP_UPDATE
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
comma
l_int|0
)paren
suffix:semicolon
id|ha-&gt;flags.management_server_logged_in
op_assign
l_int|0
suffix:semicolon
id|set_bit
c_func
(paren
id|LOOP_RESYNC_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|RSCN_UPDATE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
multiline_comment|/* Update AEN queue. */
id|qla2x00_enqueue_aen
c_func
(paren
id|ha
comma
id|MBA_RSCN_UPDATE
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* case MBA_RIO_RESPONSE: */
r_case
id|MBA_ZIO_RESPONSE
suffix:colon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): [R|Z]IO update completion.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): [R|Z]IO update completion.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla2x00_process_response_queue
c_func
(paren
id|ha
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * qla2x00_process_completed_request() - Process a Fast Post response.&n; * @ha: SCSI driver HA context&n; * @index: SRB index&n; */
r_static
r_void
DECL|function|qla2x00_process_completed_request
id|qla2x00_process_completed_request
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_uint32
id|index
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|index
op_ge
id|MAX_OUTSTANDING_COMMANDS
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Invalid SCSI completion handle %d.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|index
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Invalid SCSI completion handle %d.&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|index
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;actthreads
)paren
id|ha-&gt;actthreads
op_decrement
suffix:semicolon
id|sp-&gt;lun_queue-&gt;out_cnt
op_decrement
suffix:semicolon
id|CMD_COMPL_STATUS
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
l_int|0L
suffix:semicolon
id|CMD_SCSI_STATUS
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
l_int|0L
suffix:semicolon
multiline_comment|/* Save ISP completion status */
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|sp-&gt;fo_retry_cnt
op_assign
l_int|0
suffix:semicolon
id|add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Invalid ISP SCSI completion handle&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Invalid ISP SCSI completion handle&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * qla2x00_process_response_queue() - Process response queue entries.&n; * @ha: SCSI driver HA context&n; */
r_void
DECL|function|qla2x00_process_response_queue
id|qla2x00_process_response_queue
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
id|device_reg_t
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|sts_entry_t
op_star
id|pkt
suffix:semicolon
r_uint16
id|handle_cnt
suffix:semicolon
r_uint16
id|cnt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.online
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|ha-&gt;response_ring_ptr-&gt;signature
op_ne
id|RESPONSE_PROCESSED
)paren
(brace
id|pkt
op_assign
(paren
id|sts_entry_t
op_star
)paren
id|ha-&gt;response_ring_ptr
suffix:semicolon
id|ha-&gt;rsp_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;rsp_ring_index
op_eq
id|ha-&gt;response_q_length
)paren
(brace
id|ha-&gt;rsp_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;response_ring_ptr
op_assign
id|ha-&gt;response_ring
suffix:semicolon
)brace
r_else
(brace
id|ha-&gt;response_ring_ptr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_ne
l_int|0
)paren
(brace
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): Process error entry.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla2x00_error_entry
c_func
(paren
id|ha
comma
id|pkt
)paren
suffix:semicolon
(paren
(paren
id|response_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|signature
op_assign
id|RESPONSE_PROCESSED
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pkt-&gt;entry_type
)paren
(brace
r_case
id|STATUS_TYPE
suffix:colon
id|qla2x00_status_entry
c_func
(paren
id|ha
comma
id|pkt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATUS_TYPE_21
suffix:colon
id|handle_cnt
op_assign
(paren
(paren
id|sts21_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|handle_count
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|handle_cnt
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|qla2x00_process_completed_request
c_func
(paren
id|ha
comma
(paren
(paren
id|sts21_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|handle
(braket
id|cnt
)braket
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|STATUS_TYPE_22
suffix:colon
id|handle_cnt
op_assign
(paren
(paren
id|sts22_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|handle_count
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|handle_cnt
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|qla2x00_process_completed_request
c_func
(paren
id|ha
comma
(paren
(paren
id|sts22_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|handle
(braket
id|cnt
)braket
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|STATUS_CONT_TYPE
suffix:colon
id|qla2x00_status_cont_entry
c_func
(paren
id|ha
comma
(paren
id|sts_cont_entry_t
op_star
)paren
id|pkt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MS_IOCB_TYPE
suffix:colon
id|qla2x00_ms_entry
c_func
(paren
id|ha
comma
(paren
id|ms_iocb_entry_t
op_star
)paren
id|pkt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBX_IOCB_TYPE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA2200
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA6312
c_func
(paren
id|ha
)paren
op_logical_and
op_logical_neg
id|IS_QLA6322
c_func
(paren
id|ha
)paren
)paren
(brace
r_if
c_cond
(paren
id|pkt-&gt;sys_define
op_eq
id|SOURCE_ASYNC_IOCB
)paren
(brace
id|qla2x00_process_iodesc
c_func
(paren
id|ha
comma
(paren
r_struct
id|mbx_entry
op_star
)paren
id|pkt
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* MBX IOCB Type Not Supported. */
id|DEBUG4
c_func
(paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(%ld): Received unknown MBX &quot;
l_string|&quot;IOCB response pkt type=%x &quot;
l_string|&quot;source=%x entry status=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|pkt-&gt;entry_type
comma
id|pkt-&gt;sys_define
comma
id|pkt-&gt;entry_status
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* Fallthrough. */
r_default
suffix:colon
multiline_comment|/* Type Not Supported. */
id|DEBUG4
c_func
(paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(%ld): Received unknown response pkt type %x &quot;
l_string|&quot;entry status=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|pkt-&gt;entry_type
comma
id|pkt-&gt;entry_status
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
(paren
(paren
id|response_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|signature
op_assign
id|RESPONSE_PROCESSED
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Adjust ring index */
id|WRT_REG_WORD
c_func
(paren
id|ISP_RSP_Q_OUT
c_func
(paren
id|ha
comma
id|reg
)paren
comma
id|ha-&gt;rsp_ring_index
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_status_entry() - Process a Status IOCB entry.&n; * @ha: SCSI driver HA context&n; * @pkt: Entry pointer&n; */
r_static
r_void
DECL|function|qla2x00_status_entry
id|qla2x00_status_entry
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|sts_entry_t
op_star
id|pkt
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|b
comma
id|t
comma
id|l
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
id|os_lun_t
op_star
id|lq
suffix:semicolon
id|os_tgt_t
op_star
id|tq
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cp
suffix:semicolon
r_uint16
id|comp_status
suffix:semicolon
r_uint16
id|scsi_status
suffix:semicolon
r_uint8
id|lscsi_status
suffix:semicolon
r_uint32
id|resid
suffix:semicolon
r_uint8
id|sense_sz
op_assign
l_int|0
suffix:semicolon
r_uint16
id|rsp_info_len
suffix:semicolon
multiline_comment|/* Fast path completion. */
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;comp_status
)paren
op_eq
id|CS_COMPLETE
op_logical_and
(paren
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;scsi_status
)paren
op_amp
id|SS_MASK
)paren
op_eq
l_int|0
)paren
(brace
id|qla2x00_process_completed_request
c_func
(paren
id|ha
comma
id|pkt-&gt;handle
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|pkt-&gt;handle
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
(brace
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
suffix:semicolon
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|sp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
l_int|NULL
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Status Entry invalid handle.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Status Entry invalid handle.&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;dpc_wait
op_logical_and
op_logical_neg
id|ha-&gt;dpc_active
)paren
id|up
c_func
(paren
id|ha-&gt;dpc_wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cp
op_assign
id|sp-&gt;cmd
suffix:semicolon
r_if
c_cond
(paren
id|cp
op_eq
l_int|NULL
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Command already returned back to OS &quot;
l_string|&quot;pkt-&gt;handle=%d sp=%p sp-&gt;state:%d&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|pkt-&gt;handle
comma
id|sp
comma
id|sp-&gt;state
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Command is NULL: already returned to OS (sp=%p)&bslash;n&quot;
comma
id|sp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;actthreads
)paren
id|ha-&gt;actthreads
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;lun_queue
op_eq
l_int|NULL
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Status Entry invalid lun pointer.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Status Entry invalid lun pointer.&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;dpc_wait
op_logical_and
op_logical_neg
id|ha-&gt;dpc_active
)paren
id|up
c_func
(paren
id|ha-&gt;dpc_wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sp-&gt;lun_queue-&gt;out_cnt
op_decrement
suffix:semicolon
id|comp_status
op_assign
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;comp_status
)paren
suffix:semicolon
multiline_comment|/* Mask of reserved bits 12-15, before we examine the scsi status */
id|scsi_status
op_assign
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;scsi_status
)paren
op_amp
id|SS_MASK
suffix:semicolon
id|lscsi_status
op_assign
id|scsi_status
op_amp
id|STATUS_MASK
suffix:semicolon
id|CMD_ENTRY_STATUS
c_func
(paren
id|cp
)paren
op_assign
id|pkt-&gt;entry_status
suffix:semicolon
id|CMD_COMPL_STATUS
c_func
(paren
id|cp
)paren
op_assign
id|comp_status
suffix:semicolon
id|CMD_SCSI_STATUS
c_func
(paren
id|cp
)paren
op_assign
id|scsi_status
suffix:semicolon
multiline_comment|/* Generate LU queue on cntrl, target, LUN */
id|b
op_assign
id|cp-&gt;device-&gt;channel
suffix:semicolon
id|t
op_assign
id|cp-&gt;device-&gt;id
suffix:semicolon
id|l
op_assign
id|cp-&gt;device-&gt;lun
comma
id|tq
op_assign
id|sp-&gt;tgt_queue
suffix:semicolon
id|lq
op_assign
id|sp-&gt;lun_queue
suffix:semicolon
multiline_comment|/*&n;&t; * If loop is in transient state Report DID_BUS_BUSY&n;&t; */
r_if
c_cond
(paren
(paren
id|comp_status
op_ne
id|CS_COMPLETE
op_logical_or
id|scsi_status
op_ne
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;flags
op_amp
id|SRB_IOCTL
)paren
op_logical_and
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_down_timer
)paren
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_ne
id|LOOP_READY
)paren
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld:%d:%d:%d): Loop Not Ready - &quot;
l_string|&quot;pid=%lx.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|b
comma
id|t
comma
id|l
comma
id|cp-&gt;serial_number
)paren
)paren
suffix:semicolon
id|qla2x00_extend_timeout
c_func
(paren
id|cp
comma
id|EXTEND_CMD_TIMEOUT
)paren
suffix:semicolon
id|add_to_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Check for any FCP transport errors. */
r_if
c_cond
(paren
id|scsi_status
op_amp
id|SS_RESPONSE_INFO_LEN_VALID
)paren
(brace
id|rsp_info_len
op_assign
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;rsp_info_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rsp_info_len
OG
l_int|3
op_logical_and
id|pkt-&gt;rsp_info
(braket
l_int|3
)braket
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld:%d:%d:%d) FCP I/O protocol &quot;
l_string|&quot;failure (%x/%02x%02x%02x%02x%02x%02x%02x%02x)...&quot;
l_string|&quot;retrying command&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|b
comma
id|t
comma
id|l
comma
id|rsp_info_len
comma
id|pkt-&gt;rsp_info
(braket
l_int|0
)braket
comma
id|pkt-&gt;rsp_info
(braket
l_int|1
)braket
comma
id|pkt-&gt;rsp_info
(braket
l_int|2
)braket
comma
id|pkt-&gt;rsp_info
(braket
l_int|3
)braket
comma
id|pkt-&gt;rsp_info
(braket
l_int|4
)braket
comma
id|pkt-&gt;rsp_info
(braket
l_int|5
)braket
comma
id|pkt-&gt;rsp_info
(braket
l_int|6
)braket
comma
id|pkt-&gt;rsp_info
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
id|cp-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Based on Host and scsi status generate status code for Linux&n;&t; */
r_switch
c_cond
(paren
id|comp_status
)paren
(brace
r_case
id|CS_COMPLETE
suffix:colon
r_if
c_cond
(paren
id|scsi_status
op_eq
l_int|0
)paren
(brace
id|cp-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lscsi_status
op_eq
id|SS_BUSY_CONDITION
)paren
(brace
id|cp-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
op_or
id|lscsi_status
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cp-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
op_or
id|lscsi_status
suffix:semicolon
r_if
c_cond
(paren
id|lscsi_status
op_ne
id|SS_CHECK_CONDITION
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Copy Sense Data into sense buffer&n;&t;&t; */
id|memset
c_func
(paren
id|cp-&gt;sense_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|cp-&gt;sense_buffer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|scsi_status
op_amp
id|SS_SENSE_LEN_VALID
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;req_sense_length
)paren
OL
r_sizeof
(paren
id|cp-&gt;sense_buffer
)paren
)paren
id|sense_sz
op_assign
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;req_sense_length
)paren
suffix:semicolon
r_else
id|sense_sz
op_assign
r_sizeof
(paren
id|cp-&gt;sense_buffer
)paren
op_minus
l_int|1
suffix:semicolon
id|CMD_ACTUAL_SNSLEN
c_func
(paren
id|cp
)paren
op_assign
id|sense_sz
suffix:semicolon
id|sp-&gt;request_sense_length
op_assign
id|sense_sz
suffix:semicolon
id|sp-&gt;request_sense_ptr
op_assign
id|cp-&gt;sense_buffer
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;request_sense_length
OG
l_int|32
)paren
id|sense_sz
op_assign
l_int|32
suffix:semicolon
id|memcpy
c_func
(paren
id|cp-&gt;sense_buffer
comma
id|pkt-&gt;req_sense_data
comma
id|sense_sz
)paren
suffix:semicolon
id|sp-&gt;request_sense_ptr
op_add_assign
id|sense_sz
suffix:semicolon
id|sp-&gt;request_sense_length
op_sub_assign
id|sense_sz
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;request_sense_length
op_ne
l_int|0
)paren
id|ha-&gt;status_srb
op_assign
id|sp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;flags
op_amp
id|SRB_IOCTL
)paren
op_logical_and
id|qla2x00_check_sense
c_func
(paren
id|cp
comma
id|lq
)paren
op_eq
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* Throw away status_cont if any */
id|ha-&gt;status_srb
op_assign
l_int|NULL
suffix:semicolon
id|add_to_scsi_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DEBUG5
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Check condition Sense data, &quot;
l_string|&quot;scsi(%ld:%d:%d:%d) cmd=%p pid=%ld&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|b
comma
id|t
comma
id|l
comma
id|cp
comma
id|cp-&gt;serial_number
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sense_sz
)paren
id|DEBUG5
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
id|cp-&gt;sense_buffer
comma
id|CMD_ACTUAL_SNSLEN
c_func
(paren
id|cp
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_UNDERRUN
suffix:colon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld:%d:%d) UNDERRUN status detected 0x%x-0x%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|t
comma
id|l
comma
id|comp_status
comma
id|scsi_status
)paren
)paren
suffix:semicolon
id|resid
op_assign
id|le32_to_cpu
c_func
(paren
id|pkt-&gt;residual_length
)paren
suffix:semicolon
id|CMD_RESID_LEN
c_func
(paren
id|cp
)paren
op_assign
id|resid
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Check to see if SCSI Status is non zero. If so report SCSI &n;&t;&t; * Status.&n;&t;&t; */
r_if
c_cond
(paren
id|lscsi_status
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|lscsi_status
op_eq
id|SS_BUSY_CONDITION
)paren
(brace
id|cp-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
op_or
id|lscsi_status
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cp-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
op_or
id|lscsi_status
suffix:semicolon
r_if
c_cond
(paren
id|lscsi_status
op_ne
id|SS_CHECK_CONDITION
)paren
r_break
suffix:semicolon
multiline_comment|/* Copy Sense Data into sense buffer */
id|memset
c_func
(paren
id|cp-&gt;sense_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|cp-&gt;sense_buffer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|scsi_status
op_amp
id|SS_SENSE_LEN_VALID
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;req_sense_length
)paren
OL
r_sizeof
(paren
id|cp-&gt;sense_buffer
)paren
)paren
id|sense_sz
op_assign
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;req_sense_length
)paren
suffix:semicolon
r_else
id|sense_sz
op_assign
r_sizeof
(paren
id|cp-&gt;sense_buffer
)paren
op_minus
l_int|1
suffix:semicolon
id|CMD_ACTUAL_SNSLEN
c_func
(paren
id|cp
)paren
op_assign
id|sense_sz
suffix:semicolon
id|sp-&gt;request_sense_length
op_assign
id|sense_sz
suffix:semicolon
id|sp-&gt;request_sense_ptr
op_assign
id|cp-&gt;sense_buffer
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;request_sense_length
OG
l_int|32
)paren
id|sense_sz
op_assign
l_int|32
suffix:semicolon
id|memcpy
c_func
(paren
id|cp-&gt;sense_buffer
comma
id|pkt-&gt;req_sense_data
comma
id|sense_sz
)paren
suffix:semicolon
id|sp-&gt;request_sense_ptr
op_add_assign
id|sense_sz
suffix:semicolon
id|sp-&gt;request_sense_length
op_sub_assign
id|sense_sz
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;request_sense_length
op_ne
l_int|0
)paren
id|ha-&gt;status_srb
op_assign
id|sp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;flags
op_amp
id|SRB_IOCTL
)paren
op_logical_and
(paren
id|qla2x00_check_sense
c_func
(paren
id|cp
comma
id|lq
)paren
op_eq
id|QLA_SUCCESS
)paren
)paren
(brace
id|ha-&gt;status_srb
op_assign
l_int|NULL
suffix:semicolon
id|add_to_scsi_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DEBUG5
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Check condition Sense data, &quot;
l_string|&quot;scsi(%ld:%d:%d:%d) cmd=%p pid=%ld&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|b
comma
id|t
comma
id|l
comma
id|cp
comma
id|cp-&gt;serial_number
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sense_sz
)paren
id|DEBUG5
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
id|cp-&gt;sense_buffer
comma
id|CMD_ACTUAL_SNSLEN
c_func
(paren
id|cp
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * If RISC reports underrun and target does not report&n;&t;&t;&t; * it then we must have a lost frame, so tell upper&n;&t;&t;&t; * layer to retry it by reporting a bus busy.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|scsi_status
op_amp
id|SS_RESIDUAL_UNDER
)paren
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld:%d:%d:%d) Dropped &quot;
l_string|&quot;frame(s) detected (%x of %x bytes)...&quot;
l_string|&quot;retrying command.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|b
comma
id|t
comma
id|l
comma
id|resid
comma
id|cp-&gt;request_bufflen
)paren
)paren
suffix:semicolon
id|cp-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|ha-&gt;dropped_frame_error_cnt
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Handle mid-layer underflow */
id|cp-&gt;resid
op_assign
id|resid
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|cp-&gt;request_bufflen
op_minus
id|resid
)paren
OL
id|cp-&gt;underflow
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi(%ld:%d:%d:%d): Mid-layer underflow &quot;
l_string|&quot;detected (%x of %x bytes)...returning &quot;
l_string|&quot;error status.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|b
comma
id|t
comma
id|l
comma
id|resid
comma
id|cp-&gt;request_bufflen
)paren
suffix:semicolon
id|cp-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Everybody online, looking good... */
id|cp-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_DATA_OVERRUN
suffix:colon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld:%d:%d): OVERRUN status detected 0x%x-0x%x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|t
comma
id|l
comma
id|comp_status
comma
id|scsi_status
)paren
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CDB: 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x&bslash;n&quot;
comma
id|cp-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cp-&gt;cmnd
(braket
l_int|1
)braket
comma
id|cp-&gt;cmnd
(braket
l_int|2
)braket
comma
id|cp-&gt;cmnd
(braket
l_int|3
)braket
comma
id|cp-&gt;cmnd
(braket
l_int|4
)braket
comma
id|cp-&gt;cmnd
(braket
l_int|5
)braket
)paren
)paren
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PID=0x%lx req=0x%x xtra=0x%x -- returning DID_ERROR &quot;
l_string|&quot;status!&bslash;n&quot;
comma
id|cp-&gt;serial_number
comma
id|cp-&gt;request_bufflen
comma
id|le32_to_cpu
c_func
(paren
id|pkt-&gt;residual_length
)paren
)paren
)paren
suffix:semicolon
id|cp-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_PORT_LOGGED_OUT
suffix:colon
r_case
id|CS_PORT_CONFIG_CHG
suffix:colon
r_case
id|CS_PORT_BUSY
suffix:colon
r_case
id|CS_INCOMPLETE
suffix:colon
r_case
id|CS_PORT_UNAVAILABLE
suffix:colon
multiline_comment|/*&n;&t;&t; * If the port is in Target Down state, return all IOs for this&n;&t;&t; * Target with DID_NO_CONNECT ELSE Queue the IOs in the&n;&t;&t; * retry_queue.&n;&t;&t; */
id|fcport
op_assign
id|sp-&gt;fclun-&gt;fcport
suffix:semicolon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld:%d:%d): status_entry: Port Down &quot;
l_string|&quot;pid=%ld, compl status=0x%x, port state=0x%x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|t
comma
id|l
comma
id|cp-&gt;serial_number
comma
id|comp_status
comma
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sp-&gt;flags
op_amp
id|SRB_IOCTL
)paren
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_DEVICE_DEAD
)paren
(brace
id|cp-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_eq
id|LOOP_DOWN
)paren
id|sp-&gt;err_id
op_assign
id|SRB_ERR_LOOP
suffix:semicolon
r_else
id|sp-&gt;err_id
op_assign
id|SRB_ERR_PORT
suffix:semicolon
id|add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
r_else
(brace
id|qla2x00_extend_timeout
c_func
(paren
id|cp
comma
id|EXTEND_CMD_TIMEOUT
)paren
suffix:semicolon
id|add_to_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_ONLINE
)paren
(brace
id|qla2x00_mark_device_lost
c_func
(paren
id|ha
comma
id|fcport
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_RESET
suffix:colon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): RESET status detected 0x%x-0x%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|comp_status
comma
id|scsi_status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_IOCTL
)paren
(brace
id|cp-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
id|qla2x00_extend_timeout
c_func
(paren
id|cp
comma
id|EXTEND_CMD_TIMEOUT
)paren
suffix:semicolon
id|add_to_retry_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_ABORTED
suffix:colon
multiline_comment|/* &n;&t;&t; * hv2.19.12 - DID_ABORT does not retry the request if we&n;&t;&t; * aborted this request then abort otherwise it must be a&n;&t;&t; * reset.&n;&t;&t; */
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): ABORT status detected 0x%x-0x%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|comp_status
comma
id|scsi_status
)paren
)paren
suffix:semicolon
id|cp-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_TIMEOUT
suffix:colon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld:%d:%d:%d): TIMEOUT status detected 0x%x-0x%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|b
comma
id|t
comma
id|l
comma
id|comp_status
comma
id|scsi_status
)paren
)paren
suffix:semicolon
id|cp-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|fcport
op_assign
id|lq-&gt;fclun-&gt;fcport
suffix:semicolon
multiline_comment|/* Check to see if logout occurred */
r_if
c_cond
(paren
(paren
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;status_flags
)paren
op_amp
id|SF_LOGOUT_SENT
)paren
)paren
(brace
id|qla2x00_mark_device_lost
c_func
(paren
id|ha
comma
id|fcport
comma
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_QUEUE_FULL
suffix:colon
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): QUEUE FULL status detected 0x%x-0x%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|comp_status
comma
id|scsi_status
)paren
)paren
suffix:semicolon
multiline_comment|/* SCSI Mid-Layer handles device queue full */
id|cp-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
op_or
id|lscsi_status
suffix:semicolon
multiline_comment|/* TODO: ??? */
multiline_comment|/* Adjust queue depth */
id|ret
op_assign
id|scsi_track_queue_full
c_func
(paren
id|cp-&gt;device
comma
id|sp-&gt;lun_queue-&gt;out_cnt
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;scsi(%ld:%d:%d:%d): Queue depth adjusted to %d.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|cp-&gt;device-&gt;channel
comma
id|cp-&gt;device-&gt;id
comma
id|cp-&gt;device-&gt;lun
comma
id|ret
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Error detected (unknown status) &quot;
l_string|&quot;0x%x-0x%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|comp_status
comma
id|scsi_status
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;Unknown status detected 0x%x-0x%x.&bslash;n&quot;
comma
id|comp_status
comma
id|scsi_status
)paren
suffix:semicolon
id|cp-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Place command on done queue. */
r_if
c_cond
(paren
id|ha-&gt;status_srb
op_eq
l_int|NULL
)paren
id|add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_status_cont_entry() - Process a Status Continuations entry.&n; * @ha: SCSI driver HA context&n; * @pkt: Entry pointer&n; *&n; * Extended sense data.&n; */
r_static
r_void
DECL|function|qla2x00_status_cont_entry
id|qla2x00_status_cont_entry
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|sts_cont_entry_t
op_star
id|pkt
)paren
(brace
r_uint8
id|sense_sz
op_assign
l_int|0
suffix:semicolon
id|srb_t
op_star
id|sp
op_assign
id|ha-&gt;status_srb
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cp
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_ne
l_int|NULL
op_logical_and
id|sp-&gt;request_sense_length
op_ne
l_int|0
)paren
(brace
id|cp
op_assign
id|sp-&gt;cmd
suffix:semicolon
r_if
c_cond
(paren
id|cp
op_eq
l_int|NULL
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(): Cmd already returned back to OS &quot;
l_string|&quot;sp=%p sp-&gt;state:%d&bslash;n&quot;
comma
id|__func__
comma
id|sp
comma
id|sp-&gt;state
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_INFO
comma
id|ha
comma
l_string|&quot;cmd is NULL: already returned to OS (sp=%p)&bslash;n&quot;
comma
id|sp
)paren
suffix:semicolon
id|ha-&gt;status_srb
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sp-&gt;request_sense_length
OG
r_sizeof
(paren
id|pkt-&gt;data
)paren
)paren
(brace
id|sense_sz
op_assign
r_sizeof
(paren
id|pkt-&gt;data
)paren
suffix:semicolon
)brace
r_else
(brace
id|sense_sz
op_assign
id|sp-&gt;request_sense_length
suffix:semicolon
)brace
multiline_comment|/* Move sense data. */
id|memcpy
c_func
(paren
id|sp-&gt;request_sense_ptr
comma
id|pkt-&gt;data
comma
id|sense_sz
)paren
suffix:semicolon
id|DEBUG5
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
id|sp-&gt;request_sense_ptr
comma
id|sense_sz
)paren
)paren
suffix:semicolon
id|sp-&gt;request_sense_ptr
op_add_assign
id|sense_sz
suffix:semicolon
id|sp-&gt;request_sense_length
op_sub_assign
id|sense_sz
suffix:semicolon
multiline_comment|/* Place command on done queue. */
r_if
c_cond
(paren
id|sp-&gt;request_sense_length
op_eq
l_int|0
)paren
(brace
id|add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|ha-&gt;status_srb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * qla2x00_error_entry() - Process an error entry.&n; * @ha: SCSI driver HA context&n; * @pkt: Entry pointer&n; */
r_static
r_void
DECL|function|qla2x00_error_entry
id|qla2x00_error_entry
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|sts_entry_t
op_star
id|pkt
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
macro_line|#if defined(QL_DEBUG_LEVEL_2)
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|RF_INV_E_ORDER
)paren
id|qla_printk
c_func
(paren
id|KERN_ERR
comma
id|ha
comma
l_string|&quot;%s: Invalid Entry Order&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|RF_INV_E_COUNT
)paren
id|qla_printk
c_func
(paren
id|KERN_ERR
comma
id|ha
comma
l_string|&quot;%s: Invalid Entry Count&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|RF_INV_E_PARAM
)paren
id|qla_printk
c_func
(paren
id|KERN_ERR
comma
id|ha
comma
l_string|&quot;%s: Invalid Entry Parameter&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|RF_INV_E_TYPE
)paren
id|qla_printk
c_func
(paren
id|KERN_ERR
comma
id|ha
comma
l_string|&quot;%s: Invalid Entry Type&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|RF_BUSY
)paren
id|qla_printk
c_func
(paren
id|KERN_ERR
comma
id|ha
comma
l_string|&quot;%s: Busy&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_else
id|qla_printk
c_func
(paren
id|KERN_ERR
comma
id|ha
comma
l_string|&quot;%s: UNKNOWN flag error&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|pkt-&gt;handle
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
suffix:semicolon
r_else
id|sp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;actthreads
)paren
id|ha-&gt;actthreads
op_decrement
suffix:semicolon
id|sp-&gt;lun_queue-&gt;out_cnt
op_decrement
suffix:semicolon
multiline_comment|/* Bad payload or header */
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
(paren
id|RF_INV_E_ORDER
op_or
id|RF_INV_E_COUNT
op_or
id|RF_INV_E_PARAM
op_or
id|RF_INV_E_TYPE
)paren
)paren
(brace
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|RF_BUSY
)paren
(brace
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
id|sp-&gt;cmd-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* Place command on done queue. */
id|add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|COMMAND_A64_TYPE
op_logical_or
id|pkt-&gt;entry_type
op_eq
id|COMMAND_TYPE
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): Error entry - invalid handle&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Error entry - invalid handle&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;dpc_wait
op_logical_and
op_logical_neg
id|ha-&gt;dpc_active
)paren
id|up
c_func
(paren
id|ha-&gt;dpc_wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * qla2x00_ms_entry() - Process a Management Server entry.&n; * @ha: SCSI driver HA context&n; * @index: Response queue out pointer&n; */
r_static
r_void
DECL|function|qla2x00_ms_entry
id|qla2x00_ms_entry
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|ms_iocb_entry_t
op_star
id|pkt
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): pkt=%p pkthandle=%d.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|pkt
comma
id|pkt-&gt;handle1
)paren
)paren
suffix:semicolon
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|pkt-&gt;handle1
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle1
)braket
suffix:semicolon
r_else
id|sp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
l_int|NULL
)paren
(brace
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi(%ld): MS entry - invalid handle&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;MS entry - invalid handle&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CMD_COMPL_STATUS
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;status
)paren
suffix:semicolon
id|CMD_ENTRY_STATUS
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|pkt-&gt;entry_status
suffix:semicolon
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle1
)braket
op_assign
l_int|0
suffix:semicolon
id|add_to_done_queue
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * qla2x00_check_sense() - Perform any sense data interrogation.&n; * @cp: SCSI Command&n; * @lq: Lun queue&n; *&n; * Returns QLA_SUCCESS if the lun queue is suspended, else&n; * QLA_FUNCTION_FAILED  (lun queue not suspended).&n; */
r_static
r_int
DECL|function|qla2x00_check_sense
id|qla2x00_check_sense
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cp
comma
id|os_lun_t
op_star
id|lq
)paren
(brace
id|scsi_qla_host_t
op_star
id|ha
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
id|ha
op_assign
(paren
id|scsi_qla_host_t
op_star
)paren
id|cp-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cp-&gt;sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x70
)paren
op_ne
l_int|0x70
)paren
(brace
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
)brace
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cp
)paren
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_GOT_SENSE
suffix:semicolon
r_switch
c_cond
(paren
id|cp-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0xf
)paren
(brace
r_case
id|RECOVERED_ERROR
suffix:colon
id|cp-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
id|cp-&gt;sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NOT_READY
suffix:colon
id|fcport
op_assign
id|lq-&gt;fclun-&gt;fcport
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Suspend the lun only for hard disk device type.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|fcport-&gt;flags
op_amp
id|FCF_TAPE_PRESENT
)paren
op_eq
l_int|0
op_logical_and
id|lq-&gt;q_state
op_ne
id|LUN_STATE_TIMEOUT
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * If target is in process of being ready then suspend&n;&t;&t;&t; * lun for 6 secs and retry all the commands.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|cp-&gt;sense_buffer
(braket
l_int|12
)braket
op_eq
l_int|0x4
op_logical_and
id|cp-&gt;sense_buffer
(braket
l_int|13
)braket
op_eq
l_int|0x1
)paren
(brace
multiline_comment|/* Suspend the lun for 6 secs */
id|qla2x00_suspend_lun
c_func
(paren
id|ha
comma
id|lq
comma
l_int|6
comma
id|ql2xsuspendcount
)paren
suffix:semicolon
r_return
(paren
id|QLA_SUCCESS
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_return
(paren
id|QLA_FUNCTION_FAILED
)paren
suffix:semicolon
)brace
eof
