multiline_comment|/*&n; *                  QLOGIC LINUX SOFTWARE&n; *&n; * QLogic ISP2x00 device driver for Linux 2.6.x&n; * Copyright (C) 2003-2004 QLogic Corporation&n; * (www.qlogic.com)&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; */
macro_line|#include &quot;qla_def.h&quot;
macro_line|#include &lt;linux/delay.h&gt;
r_static
r_void
DECL|function|qla2x00_mbx_sem_timeout
id|qla2x00_mbx_sem_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|semaphore
op_star
id|sem_ptr
op_assign
(paren
r_struct
id|semaphore
op_star
)paren
id|data
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_sem_timeout: entered.&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|sem_ptr
op_ne
l_int|NULL
)paren
(brace
id|up
c_func
(paren
id|sem_ptr
)paren
suffix:semicolon
)brace
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mbx_sem_timeout: exiting.&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
multiline_comment|/*&n; * qla2x00_mailbox_command&n; *&t;Issue mailbox command and waits for completion.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;mcp = driver internal mbx struct pointer.&n; *&n; * Output:&n; *&t;mb[MAX_MAILBOX_REGISTER_COUNT] = returned mailbox data.&n; *&n; * Returns:&n; *&t;0 : QLA_SUCCESS = cmd performed success&n; *&t;1 : QLA_FUNCTION_FAILED   (error encountered)&n; *&t;6 : QLA_FUNCTION_TIMEOUT (timeout condition encountered)&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_static
r_int
DECL|function|qla2x00_mailbox_command
id|qla2x00_mailbox_command
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|mbx_cmd_t
op_star
id|mcp
)paren
(brace
r_int
id|rval
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|device_reg_t
id|__iomem
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_struct
id|timer_list
id|tmp_intr_timer
suffix:semicolon
r_uint8
id|abort_active
op_assign
id|test_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_uint8
id|io_lock_on
op_assign
id|ha-&gt;flags.init_done
suffix:semicolon
r_uint16
id|command
suffix:semicolon
r_uint16
op_star
id|iptr
suffix:semicolon
r_uint16
id|__iomem
op_star
id|optr
suffix:semicolon
r_uint32
id|cnt
suffix:semicolon
r_uint32
id|mboxes
suffix:semicolon
r_int
r_int
id|mbx_flags
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|wait_time
suffix:semicolon
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
multiline_comment|/*&n;&t; * Wait for active mailbox commands to finish by waiting at most&n;&t; * tov seconds. This is to serialize actual issuing of mailbox cmds&n;&t; * during non ISP abort time.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|abort_active
)paren
(brace
r_if
c_cond
(paren
id|qla2x00_down_timeout
c_func
(paren
op_amp
id|ha-&gt;mbx_cmd_sem
comma
id|mcp-&gt;tov
op_star
id|HZ
)paren
)paren
(brace
multiline_comment|/* Timeout occurred. Return error. */
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): cmd &quot;
l_string|&quot;access timeout. Exiting.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
r_return
id|QLA_FUNCTION_TIMEOUT
suffix:semicolon
)brace
)brace
id|ha-&gt;flags.mbox_busy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Save mailbox command for debug */
id|ha-&gt;mcp
op_assign
id|mcp
suffix:semicolon
multiline_comment|/* Try to get mailbox register access */
r_if
c_cond
(paren
op_logical_neg
id|abort_active
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;mbx_reg_lock
comma
id|mbx_flags
)paren
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;scsi%d: prepare to issue mbox cmd=0x%x.&bslash;n&quot;
comma
(paren
r_int
)paren
id|ha-&gt;host_no
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Load mailbox registers. */
id|optr
op_assign
(paren
r_uint16
id|__iomem
op_star
)paren
id|MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|0
)paren
suffix:semicolon
id|iptr
op_assign
id|mcp-&gt;mb
suffix:semicolon
id|command
op_assign
id|mcp-&gt;mb
(braket
l_int|0
)braket
suffix:semicolon
id|mboxes
op_assign
id|mcp-&gt;out_mb
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|ha-&gt;mbx_count
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|IS_QLA2200
c_func
(paren
id|ha
)paren
op_logical_and
id|cnt
op_eq
l_int|8
)paren
id|optr
op_assign
(paren
r_uint16
id|__iomem
op_star
)paren
id|MAILBOX_REG
c_func
(paren
id|ha
comma
id|reg
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mboxes
op_amp
id|BIT_0
)paren
id|WRT_REG_WORD
c_func
(paren
id|optr
comma
op_star
id|iptr
)paren
suffix:semicolon
id|mboxes
op_rshift_assign
l_int|1
suffix:semicolon
id|optr
op_increment
suffix:semicolon
id|iptr
op_increment
suffix:semicolon
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_1)
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command: Loaded MBX registers &quot;
l_string|&quot;(displayed in bytes) = &bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_dump_buffer
c_func
(paren
(paren
r_uint8
op_star
)paren
id|mcp-&gt;mb
comma
l_int|16
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_dump_buffer
c_func
(paren
(paren
(paren
r_uint8
op_star
)paren
id|mcp-&gt;mb
op_plus
l_int|0x10
)paren
comma
l_int|16
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|qla2x00_dump_buffer
c_func
(paren
(paren
(paren
r_uint8
op_star
)paren
id|mcp-&gt;mb
op_plus
l_int|0x20
)paren
comma
l_int|8
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command: I/O address = %lx.&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|optr
)paren
suffix:semicolon
id|qla2x00_dump_regs
c_func
(paren
id|ha
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Issue set host interrupt command to send cmd out. */
id|ha-&gt;flags.mbox_int
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
id|MBX_INTERRUPT
comma
op_amp
id|ha-&gt;mbx_cmd_flags
)paren
suffix:semicolon
multiline_comment|/* Unlock mbx registers and wait for interrupt */
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command: going to unlock irq &amp; &quot;
l_string|&quot;waiting for interrupt. jiffies=%lx.&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
)paren
multiline_comment|/* Wait for mbx cmd completion until timeout */
r_if
c_cond
(paren
op_logical_neg
id|abort_active
op_logical_and
id|io_lock_on
)paren
(brace
multiline_comment|/* sleep on completion semaphore */
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): &quot;
l_string|&quot;INTERRUPT MODE. Initializing timer.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|init_timer
c_func
(paren
op_amp
id|tmp_intr_timer
)paren
suffix:semicolon
id|tmp_intr_timer.data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|ha-&gt;mbx_intr_sem
suffix:semicolon
id|tmp_intr_timer.expires
op_assign
id|jiffies
op_plus
id|mcp-&gt;tov
op_star
id|HZ
suffix:semicolon
id|tmp_intr_timer.function
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|qla2x00_mbx_sem_timeout
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): &quot;
l_string|&quot;Adding timer.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|add_timer
c_func
(paren
op_amp
id|tmp_intr_timer
)paren
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command: going to &quot;
l_string|&quot;unlock &amp; sleep. time=0x%lx.&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
)paren
id|set_bit
c_func
(paren
id|MBX_INTR_WAIT
comma
op_amp
id|ha-&gt;mbx_cmd_flags
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_SET_HOST_INT
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|abort_active
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;mbx_reg_lock
comma
id|mbx_flags
)paren
suffix:semicolon
multiline_comment|/* Wait for either the timer to expire&n;&t;&t; * or the mbox completion interrupt&n;&t;&t; */
id|down
c_func
(paren
op_amp
id|ha-&gt;mbx_intr_sem
)paren
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command:&quot;
l_string|&quot;waking up.&quot;
l_string|&quot;time=0x%lx&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
)paren
id|clear_bit
c_func
(paren
id|MBX_INTR_WAIT
comma
op_amp
id|ha-&gt;mbx_cmd_flags
)paren
suffix:semicolon
multiline_comment|/* delete the timer */
id|del_timer
c_func
(paren
op_amp
id|tmp_intr_timer
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): cmd=%x &quot;
l_string|&quot;POLLING MODE.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|command
)paren
suffix:semicolon
)paren
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;hccr
comma
id|HCCR_SET_HOST_INT
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|abort_active
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;mbx_reg_lock
comma
id|mbx_flags
)paren
suffix:semicolon
id|wait_time
op_assign
id|jiffies
op_plus
id|mcp-&gt;tov
op_star
id|HZ
suffix:semicolon
multiline_comment|/* wait at most tov secs */
r_while
c_loop
(paren
op_logical_neg
id|ha-&gt;flags.mbox_int
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|wait_time
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Check for pending interrupts. */
id|qla2x00_poll
c_func
(paren
id|ha
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* v4.27 */
)brace
multiline_comment|/* while */
)brace
r_if
c_cond
(paren
op_logical_neg
id|abort_active
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;mbx_reg_lock
comma
id|mbx_flags
)paren
suffix:semicolon
multiline_comment|/* Check whether we timed out */
r_if
c_cond
(paren
id|ha-&gt;flags.mbox_int
)paren
(brace
r_uint16
op_star
id|iptr2
suffix:semicolon
id|DEBUG3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_cmd: cmd %x completed.&bslash;n&quot;
comma
id|command
)paren
suffix:semicolon
)paren
multiline_comment|/* Got interrupt. Clear the flag. */
id|ha-&gt;flags.mbox_int
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
id|MBX_INTERRUPT
comma
op_amp
id|ha-&gt;mbx_cmd_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
op_ne
id|MBS_COMMAND_COMPLETE
)paren
(brace
id|qla2x00_stats.mboxerr
op_increment
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
multiline_comment|/* Load return mailbox registers. */
id|iptr2
op_assign
id|mcp-&gt;mb
suffix:semicolon
id|iptr
op_assign
(paren
r_uint16
op_star
)paren
op_amp
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
suffix:semicolon
id|mboxes
op_assign
id|mcp-&gt;in_mb
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|ha-&gt;mbx_count
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mboxes
op_amp
id|BIT_0
)paren
op_star
id|iptr2
op_assign
op_star
id|iptr
suffix:semicolon
id|mboxes
op_rshift_assign
l_int|1
suffix:semicolon
id|iptr2
op_increment
suffix:semicolon
id|iptr
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#if defined(QL_DEBUG_LEVEL_2) || defined(QL_DEBUG_LEVEL_3) || &bslash;&n;&t;&t;defined(QL_DEBUG_LEVEL_11)
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): **** MB Command Timeout &quot;
l_string|&quot;for cmd %x ****&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|command
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command: icontrol=%x jiffies=%lx&bslash;n&quot;
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
)paren
comma
id|jiffies
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command: *** mailbox[0] = 0x%x ***&bslash;n&quot;
comma
id|RD_REG_WORD
c_func
(paren
id|optr
)paren
)paren
suffix:semicolon
id|qla2x00_dump_regs
c_func
(paren
id|ha
)paren
suffix:semicolon
macro_line|#endif
id|qla2x00_stats.mboxtout
op_increment
suffix:semicolon
id|ha-&gt;total_mbx_timeout
op_increment
suffix:semicolon
id|rval
op_assign
id|QLA_FUNCTION_TIMEOUT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|abort_active
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;mbx_reg_lock
comma
id|mbx_flags
)paren
suffix:semicolon
id|ha-&gt;flags.mbox_busy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clean up */
id|ha-&gt;mcp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|abort_active
)paren
(brace
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_cmd: checking for additional &quot;
l_string|&quot;resp interrupt.&bslash;n&quot;
)paren
suffix:semicolon
)paren
multiline_comment|/* polling mode for non isp_abort commands. */
id|qla2x00_poll
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_FUNCTION_TIMEOUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|io_lock_on
op_logical_or
(paren
id|mcp-&gt;flags
op_amp
id|IOCTL_CMD
)paren
)paren
(brace
multiline_comment|/* not in dpc. schedule it for dpc to take over. */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): timeout &quot;
l_string|&quot;schedule isp_abort_needed.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): &quot;
l_string|&quot;timeout schedule isp_abort_needed.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Mailbox command timeout occured. Scheduling ISP &quot;
l_string|&quot;abort.&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;dpc_wait
op_logical_and
op_logical_neg
id|ha-&gt;dpc_active
)paren
id|up
c_func
(paren
id|ha-&gt;dpc_wait
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|abort_active
)paren
(brace
multiline_comment|/* call abort directly since we are in the DPC thread */
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): timeout &quot;
l_string|&quot;calling abort_isp&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): &quot;
l_string|&quot;timeout calling abort_isp&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|qla_printk
c_func
(paren
id|KERN_WARNING
comma
id|ha
comma
l_string|&quot;Mailbox command timeout occured. Issuing ISP &quot;
l_string|&quot;abort.&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla2x00_abort_isp
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* failed. retry later. */
id|set_bit
c_func
(paren
id|ISP_ABORT_NEEDED
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|ABORT_ISP_ACTIVE
comma
op_amp
id|ha-&gt;dpc_flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command: finished &quot;
l_string|&quot;abort_isp&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command: finished &quot;
l_string|&quot;abort_isp&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
)brace
multiline_comment|/* Allow next mbx cmd to come in. */
r_if
c_cond
(paren
op_logical_neg
id|abort_active
)paren
id|up
c_func
(paren
op_amp
id|ha-&gt;mbx_cmd_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
)paren
(brace
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): **** FAILED. &quot;
l_string|&quot;mbx0=%x, mbx1=%x, mbx2=%x, cmd=%x ****&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
comma
id|mcp-&gt;mb
(braket
l_int|1
)braket
comma
id|mcp-&gt;mb
(braket
l_int|2
)braket
comma
id|command
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mailbox_command(%ld): exiting.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_load_ram&n; *&t;Load adapter RAM using DMA.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_load_ram
id|qla2x00_load_ram
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|dma_addr_t
id|req_dma
comma
r_uint16
id|risc_addr
comma
r_uint16
id|risc_code_size
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
r_uint32
id|req_len
suffix:semicolon
id|dma_addr_t
id|nml_dma
suffix:semicolon
r_uint32
id|nml_len
suffix:semicolon
r_uint32
id|normalized
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_load_ram(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|req_len
op_assign
id|risc_code_size
suffix:semicolon
id|nml_dma
op_assign
l_int|0
suffix:semicolon
id|nml_len
op_assign
l_int|0
suffix:semicolon
id|normalized
op_assign
id|qla2x00_normalize_dma_addr
c_func
(paren
op_amp
id|req_dma
comma
op_amp
id|req_len
comma
op_amp
id|nml_dma
comma
op_amp
id|nml_len
)paren
suffix:semicolon
multiline_comment|/* Load first segment */
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_LOAD_RISC_RAM
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|risc_addr
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|MSW
c_func
(paren
id|req_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|LSW
c_func
(paren
id|req_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|4
)braket
op_assign
(paren
r_uint16
)paren
id|req_len
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
id|MSW
c_func
(paren
id|MSD
c_func
(paren
id|req_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|7
)braket
op_assign
id|LSW
c_func
(paren
id|MSD
c_func
(paren
id|req_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_4
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
multiline_comment|/* Load second segment - if necessary */
r_if
c_cond
(paren
id|normalized
op_logical_and
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
)paren
(brace
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_LOAD_RISC_RAM
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|risc_addr
op_plus
(paren
r_uint16
)paren
id|req_len
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|MSW
c_func
(paren
id|nml_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|LSW
c_func
(paren
id|nml_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|4
)braket
op_assign
(paren
r_uint16
)paren
id|nml_len
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
id|MSW
c_func
(paren
id|MSD
c_func
(paren
id|nml_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|7
)braket
op_assign
id|LSW
c_func
(paren
id|MSD
c_func
(paren
id|nml_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_4
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* Empty */
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_load_ram(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/* Empty */
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_load_ram(%ld): failed. rval=%x &quot;
l_string|&quot;mb[0]=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_load_ram_ext&n; *&t;Load adapter extended RAM using DMA.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_load_ram_ext
id|qla2x00_load_ram_ext
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|dma_addr_t
id|req_dma
comma
r_uint32
id|risc_addr
comma
r_uint16
id|risc_code_size
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
r_uint32
id|req_len
suffix:semicolon
id|dma_addr_t
id|nml_dma
suffix:semicolon
r_uint32
id|nml_len
suffix:semicolon
r_uint32
id|normalized
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): entered.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|req_len
op_assign
id|risc_code_size
suffix:semicolon
id|nml_dma
op_assign
l_int|0
suffix:semicolon
id|nml_len
op_assign
l_int|0
suffix:semicolon
id|normalized
op_assign
id|qla2x00_normalize_dma_addr
c_func
(paren
op_amp
id|req_dma
comma
op_amp
id|req_len
comma
op_amp
id|nml_dma
comma
op_amp
id|nml_len
)paren
suffix:semicolon
multiline_comment|/* Load first segment */
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_LOAD_RISC_RAM_EXTENDED
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|LSW
c_func
(paren
id|risc_addr
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|MSW
c_func
(paren
id|req_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|LSW
c_func
(paren
id|req_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|4
)braket
op_assign
(paren
r_uint16
)paren
id|req_len
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
id|MSW
c_func
(paren
id|MSD
c_func
(paren
id|req_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|7
)braket
op_assign
id|LSW
c_func
(paren
id|MSD
c_func
(paren
id|req_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|8
)braket
op_assign
id|MSW
c_func
(paren
id|risc_addr
)paren
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_8
op_or
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_4
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
multiline_comment|/* Load second segment - if necessary */
r_if
c_cond
(paren
id|normalized
op_logical_and
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
)paren
(brace
id|risc_addr
op_add_assign
id|req_len
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_LOAD_RISC_RAM_EXTENDED
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|LSW
c_func
(paren
id|risc_addr
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|MSW
c_func
(paren
id|nml_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|LSW
c_func
(paren
id|nml_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|4
)braket
op_assign
(paren
r_uint16
)paren
id|nml_len
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
id|MSW
c_func
(paren
id|MSD
c_func
(paren
id|nml_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|7
)braket
op_assign
id|LSW
c_func
(paren
id|MSD
c_func
(paren
id|nml_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|8
)braket
op_assign
id|MSW
c_func
(paren
id|risc_addr
)paren
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_8
op_or
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_4
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): failed=%x mb[0]=%x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|rval
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): done.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_execute_fw&n; *&t;Start adapter firmware.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_execute_fw
id|qla2x00_execute_fw
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_execute_fw(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_EXECUTE_FIRMWARE
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
op_star
id|ha-&gt;brd_info-&gt;fw_info
(braket
l_int|0
)braket
dot
id|fwstart
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2322
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA6322
c_func
(paren
id|ha
)paren
)paren
(brace
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;out_mb
op_or_assign
id|MBX_2
suffix:semicolon
)brace
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_execute_fw(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_get_fw_version&n; *&t;Get firmware version.&n; *&n; * Input:&n; *&t;ha:&t;&t;adapter state pointer.&n; *&t;major:&t;&t;pointer for major number.&n; *&t;minor:&t;&t;pointer for minor number.&n; *&t;subminor:&t;pointer for subminor number.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_void
DECL|function|qla2x00_get_fw_version
id|qla2x00_get_fw_version
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
op_star
id|major
comma
r_uint16
op_star
id|minor
comma
r_uint16
op_star
id|subminor
comma
r_uint16
op_star
id|attributes
comma
r_uint32
op_star
id|memory
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): entered.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_FIRMWARE_VERSION
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_6
op_or
id|MBX_5
op_or
id|MBX_4
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
multiline_comment|/* Return mailbox data. */
op_star
id|major
op_assign
id|mcp-&gt;mb
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|minor
op_assign
id|mcp-&gt;mb
(braket
l_int|2
)braket
suffix:semicolon
op_star
id|subminor
op_assign
id|mcp-&gt;mb
(braket
l_int|3
)braket
suffix:semicolon
op_star
id|attributes
op_assign
id|mcp-&gt;mb
(braket
l_int|6
)braket
suffix:semicolon
r_if
c_cond
(paren
id|IS_QLA2100
c_func
(paren
id|ha
)paren
op_logical_or
id|IS_QLA2200
c_func
(paren
id|ha
)paren
)paren
op_star
id|memory
op_assign
l_int|0x1FFFF
suffix:semicolon
multiline_comment|/* Defaults to 128KB. */
r_else
op_star
id|memory
op_assign
(paren
id|mcp-&gt;mb
(braket
l_int|5
)braket
op_lshift
l_int|16
)paren
op_or
id|mcp-&gt;mb
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): failed=%x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): done.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * qla2x00_get_fw_options&n; *&t;Set firmware options.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;fwopt = pointer for firmware options.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_get_fw_options
id|qla2x00_get_fw_options
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
op_star
id|fwopts
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): entered.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_FIRMWARE_OPTION
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): failed=%x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|fwopts
(braket
l_int|1
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|1
)braket
suffix:semicolon
id|fwopts
(braket
l_int|2
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|2
)braket
suffix:semicolon
id|fwopts
(braket
l_int|3
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|3
)braket
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): done.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_set_fw_options&n; *&t;Set firmware options.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;fwopt = pointer for firmware options.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_set_fw_options
id|qla2x00_set_fw_options
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
op_star
id|fwopts
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): entered.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_FIRMWARE_OPTION
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|fwopts
(braket
l_int|1
)braket
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|fwopts
(braket
l_int|2
)braket
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|fwopts
(braket
l_int|3
)braket
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|10
)braket
op_assign
id|fwopts
(braket
l_int|10
)braket
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|11
)braket
op_assign
id|fwopts
(braket
l_int|11
)braket
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|12
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Undocumented, but used */
id|mcp-&gt;out_mb
op_assign
id|MBX_12
op_or
id|MBX_11
op_or
id|MBX_10
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): failed=%x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): done.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_mbx_reg_test&n; *&t;Mailbox register wrap test.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_mbx_reg_test
id|qla2x00_mbx_reg_test
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mbx_reg_test(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_MAILBOX_REGISTER_TEST
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
l_int|0xAAAA
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
l_int|0x5555
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
l_int|0xAA55
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|4
)braket
op_assign
l_int|0x55AA
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|5
)braket
op_assign
l_int|0xA5A5
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
l_int|0x5A5A
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|7
)braket
op_assign
l_int|0x2525
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_5
op_or
id|MBX_4
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_5
op_or
id|MBX_4
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
(brace
r_if
c_cond
(paren
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_ne
l_int|0xAAAA
op_logical_or
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_ne
l_int|0x5555
op_logical_or
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_ne
l_int|0xAA55
op_logical_or
id|mcp-&gt;mb
(braket
l_int|4
)braket
op_ne
l_int|0x55AA
)paren
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
r_if
c_cond
(paren
id|mcp-&gt;mb
(braket
l_int|5
)braket
op_ne
l_int|0xA5A5
op_logical_or
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_ne
l_int|0x5A5A
op_logical_or
id|mcp-&gt;mb
(braket
l_int|7
)braket
op_ne
l_int|0x2525
)paren
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mbx_reg_test(%ld): failed=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_mbx_reg_test(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_verify_checksum&n; *&t;Verify firmware checksum.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_verify_checksum
id|qla2x00_verify_checksum
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_verify_checksum(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_VERIFY_CHECKSUM
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
op_star
id|ha-&gt;brd_info-&gt;fw_info
(braket
l_int|0
)braket
dot
id|fwstart
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_2
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_verify_checksum(%ld): failed=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_verify_checksum(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_issue_iocb&n; *&t;Issue IOCB using mailbox command&n; *&n; * Input:&n; *&t;ha = adapter state pointer.&n; *&t;buffer = buffer pointer.&n; *&t;phys_addr = physical address of buffer.&n; *&t;size = size of buffer.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_issue_iocb
id|qla2x00_issue_iocb
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_void
op_star
id|buffer
comma
id|dma_addr_t
id|phys_addr
comma
r_int
id|size
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_IOCB_COMMAND_A64
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|MSW
c_func
(paren
id|phys_addr
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|LSW
c_func
(paren
id|phys_addr
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
id|MSW
c_func
(paren
id|MSD
c_func
(paren
id|phys_addr
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|7
)braket
op_assign
id|LSW
c_func
(paren
id|MSD
c_func
(paren
id|phys_addr
)paren
)paren
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_2
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_issue_iocb(%ld): failed rval 0x%x&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
id|DEBUG2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_issue_iocb(%ld): failed rval 0x%x&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_abort_command&n; *&t;Abort command aborts a specified IOCB.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;sp = SB structure pointer.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_abort_command
id|qla2x00_abort_command
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
(brace
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|fc_port_t
op_star
id|fcport
suffix:semicolon
r_int
id|rval
suffix:semicolon
r_uint32
id|handle
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_abort_command(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|fcport
op_assign
id|sp-&gt;fclun-&gt;fcport
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ha-&gt;loop_state
)paren
op_eq
id|LOOP_DOWN
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|fcport-&gt;state
)paren
op_eq
id|FCS_DEVICE_LOST
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|handle
op_assign
l_int|1
suffix:semicolon
id|handle
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|handle
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;outstanding_cmds
(braket
id|handle
)braket
op_eq
id|sp
)paren
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ha-&gt;hardware_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|handle
op_eq
id|MAX_OUTSTANDING_COMMANDS
)paren
(brace
multiline_comment|/* command not found */
r_return
id|QLA_FUNCTION_FAILED
suffix:semicolon
)brace
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_ABORT_COMMAND
suffix:semicolon
r_if
c_cond
(paren
id|HAS_EXTENDED_IDS
c_func
(paren
id|ha
)paren
)paren
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|fcport-&gt;loop_id
suffix:semicolon
r_else
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|fcport-&gt;loop_id
op_lshift
l_int|8
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
(paren
r_uint16
)paren
id|handle
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|handle
op_rshift
l_int|16
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
(paren
r_uint16
)paren
id|sp-&gt;fclun-&gt;lun
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_6
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_abort_command(%ld): failed=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
id|sp-&gt;flags
op_or_assign
id|SRB_ABORT_PENDING
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_abort_command(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
macro_line|#if USE_ABORT_TGT
multiline_comment|/*&n; * qla2x00_abort_target&n; *&t;Issue abort target mailbox command.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_abort_target
id|qla2x00_abort_target
c_func
(paren
id|fc_port_t
op_star
id|fcport
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_abort_target(%ld): entered.&bslash;n&quot;
comma
id|fcport-&gt;ha-&gt;host_no
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|fcport
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* no target to abort */
r_return
l_int|0
suffix:semicolon
)brace
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_ABORT_TARGET
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
r_if
c_cond
(paren
id|HAS_EXTENDED_IDS
c_func
(paren
id|fcport-&gt;ha
)paren
)paren
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|fcport-&gt;loop_id
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|10
)braket
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;out_mb
op_or_assign
id|MBX_10
suffix:semicolon
)brace
r_else
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|fcport-&gt;loop_id
op_lshift
l_int|8
suffix:semicolon
)brace
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|fcport-&gt;ha-&gt;loop_reset_delay
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|fcport-&gt;ha
comma
id|mcp
)paren
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|fcport-&gt;ha-&gt;marker_needed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_abort_target(%ld): failed=%x.&bslash;n&quot;
comma
id|fcport-&gt;ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_abort_target(%ld): done.&bslash;n&quot;
comma
id|fcport-&gt;ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * qla2x00_target_reset&n; *&t;Issue target reset mailbox command.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_target_reset
id|qla2x00_target_reset
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|b
comma
r_uint16
id|t
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|os_tgt_t
op_star
id|tgt
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_target_reset(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|tgt
op_assign
id|TGT_Q
c_func
(paren
id|ha
comma
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tgt-&gt;fcport
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* no target to abort */
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|tgt-&gt;fcport-&gt;state
)paren
op_ne
id|FCS_ONLINE
)paren
(brace
multiline_comment|/* target not online */
r_return
l_int|0
suffix:semicolon
)brace
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_TARGET_RESET
suffix:semicolon
r_if
c_cond
(paren
id|HAS_EXTENDED_IDS
c_func
(paren
id|ha
)paren
)paren
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|tgt-&gt;fcport-&gt;loop_id
suffix:semicolon
r_else
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|tgt-&gt;fcport-&gt;loop_id
op_lshift
l_int|8
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|ha-&gt;loop_reset_delay
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_target_reset(%ld): failed=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_target_reset(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_get_adapter_id&n; *&t;Get adapter ID and topology.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;id = pointer for loop ID.&n; *&t;al_pa = pointer for AL_PA.&n; *&t;area = pointer for area.&n; *&t;domain = pointer for domain.&n; *&t;top = pointer for topology.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_get_adapter_id
id|qla2x00_get_adapter_id
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
op_star
id|id
comma
r_uint8
op_star
id|al_pa
comma
r_uint8
op_star
id|area
comma
r_uint8
op_star
id|domain
comma
r_uint16
op_star
id|top
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_adapter_id(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_ADAPTER_LOOP_ID
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
multiline_comment|/* Return data. */
op_star
id|id
op_assign
id|mcp-&gt;mb
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|al_pa
op_assign
id|LSB
c_func
(paren
id|mcp-&gt;mb
(braket
l_int|2
)braket
)paren
suffix:semicolon
op_star
id|area
op_assign
id|MSB
c_func
(paren
id|mcp-&gt;mb
(braket
l_int|2
)braket
)paren
suffix:semicolon
op_star
id|domain
op_assign
id|LSB
c_func
(paren
id|mcp-&gt;mb
(braket
l_int|3
)braket
)paren
suffix:semicolon
op_star
id|top
op_assign
id|mcp-&gt;mb
(braket
l_int|6
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_adapter_id(%ld): failed=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_adapter_id(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_get_retry_cnt&n; *&t;Get current firmware login retry count and delay.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;retry_cnt = pointer to login retry count.&n; *&t;tov = pointer to login timeout value.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_get_retry_cnt
id|qla2x00_get_retry_cnt
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint8
op_star
id|retry_cnt
comma
r_uint8
op_star
id|tov
comma
r_uint16
op_star
id|r_a_tov
)paren
(brace
r_int
id|rval
suffix:semicolon
r_uint16
id|ratov
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_retry_cnt(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_RETRY_COUNT
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_retry_cnt(%ld): failed = %x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/* Convert returned data and check our values. */
op_star
id|r_a_tov
op_assign
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_div
l_int|2
suffix:semicolon
id|ratov
op_assign
(paren
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_div
l_int|2
)paren
op_div
l_int|10
suffix:semicolon
multiline_comment|/* mb[3] value is in 100ms */
r_if
c_cond
(paren
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_star
id|ratov
OG
(paren
op_star
id|retry_cnt
)paren
op_star
(paren
op_star
id|tov
)paren
)paren
(brace
multiline_comment|/* Update to the larger values */
op_star
id|retry_cnt
op_assign
(paren
r_uint8
)paren
id|mcp-&gt;mb
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|tov
op_assign
id|ratov
suffix:semicolon
)brace
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_retry_cnt(%ld): done. mb3=%d &quot;
l_string|&quot;ratov=%d.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|mcp-&gt;mb
(braket
l_int|3
)braket
comma
id|ratov
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_init_firmware&n; *&t;Initialize adapter firmware.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;dptr = Initialization control block pointer.&n; *&t;size = size of initialization control block.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_init_firmware
id|qla2x00_init_firmware
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|size
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_init_firmware(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_INITIALIZE_FIRMWARE
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|MSW
c_func
(paren
id|ha-&gt;init_cb_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|LSW
c_func
(paren
id|ha-&gt;init_cb_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
id|MSW
c_func
(paren
id|MSD
c_func
(paren
id|ha-&gt;init_cb_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|7
)braket
op_assign
id|LSW
c_func
(paren
id|MSD
c_func
(paren
id|ha-&gt;init_cb_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_5
op_or
id|MBX_4
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;buf_size
op_assign
id|size
suffix:semicolon
id|mcp-&gt;flags
op_assign
id|MBX_DMA_OUT
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_init_firmware(%ld): failed=%x &quot;
l_string|&quot;mb0=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_init_firmware(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_get_port_database&n; *&t;Issue normal/enhanced get port database mailbox command&n; *&t;and copy device name as necessary.&n; *&n; * Input:&n; *&t;ha = adapter state pointer.&n; *&t;dev = structure pointer.&n; *&t;opt = enhanced cmd option byte.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_get_port_database
id|qla2x00_get_port_database
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|fc_port_t
op_star
id|fcport
comma
r_uint8
id|opt
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|port_database_t
op_star
id|pd
suffix:semicolon
id|dma_addr_t
id|pd_dma
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_port_database(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|pd
op_assign
id|dma_pool_alloc
c_func
(paren
id|ha-&gt;s_dma_pool
comma
id|GFP_ATOMIC
comma
op_amp
id|pd_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd
op_eq
l_int|NULL
)paren
(brace
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_port_database(%ld): **** &quot;
l_string|&quot;Mem Alloc Failed ****&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
r_return
id|QLA_MEMORY_ALLOC_FAILED
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pd
comma
l_int|0
comma
id|PORT_DATABASE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_ne
l_int|0
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_ENHANCED_GET_PORT_DATABASE
suffix:semicolon
r_else
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_PORT_DATABASE
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
r_if
c_cond
(paren
id|HAS_EXTENDED_IDS
c_func
(paren
id|ha
)paren
)paren
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|fcport-&gt;loop_id
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|10
)braket
op_assign
id|opt
suffix:semicolon
id|mcp-&gt;out_mb
op_or_assign
id|MBX_10
suffix:semicolon
)brace
r_else
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|fcport-&gt;loop_id
op_lshift
l_int|8
op_or
id|opt
suffix:semicolon
)brace
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|MSW
c_func
(paren
id|pd_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|LSW
c_func
(paren
id|pd_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
id|MSW
c_func
(paren
id|MSD
c_func
(paren
id|pd_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|7
)braket
op_assign
id|LSW
c_func
(paren
id|MSD
c_func
(paren
id|pd_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;buf_size
op_assign
id|PORT_DATABASE_SIZE
suffix:semicolon
id|mcp-&gt;flags
op_assign
id|MBX_DMA_IN
suffix:semicolon
id|mcp-&gt;tov
op_assign
(paren
id|ha-&gt;login_timeout
op_star
l_int|2
)paren
op_plus
(paren
id|ha-&gt;login_timeout
op_div
l_int|2
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
r_goto
id|gpd_error_out
suffix:semicolon
multiline_comment|/* Check for logged in state. */
r_if
c_cond
(paren
id|pd-&gt;master_state
op_ne
id|PD_STATE_PORT_LOGGED_IN
op_logical_and
id|pd-&gt;slave_state
op_ne
id|PD_STATE_PORT_LOGGED_IN
)paren
(brace
id|rval
op_assign
id|QLA_FUNCTION_FAILED
suffix:semicolon
r_goto
id|gpd_error_out
suffix:semicolon
)brace
multiline_comment|/* Names are little-endian. */
id|memcpy
c_func
(paren
id|fcport-&gt;node_name
comma
id|pd-&gt;node_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|fcport-&gt;port_name
comma
id|pd-&gt;port_name
comma
id|WWN_SIZE
)paren
suffix:semicolon
multiline_comment|/* Get port_id of device. */
id|fcport-&gt;d_id.b.al_pa
op_assign
id|pd-&gt;port_id
(braket
l_int|2
)braket
suffix:semicolon
id|fcport-&gt;d_id.b.area
op_assign
id|pd-&gt;port_id
(braket
l_int|3
)braket
suffix:semicolon
id|fcport-&gt;d_id.b.domain
op_assign
id|pd-&gt;port_id
(braket
l_int|0
)braket
suffix:semicolon
id|fcport-&gt;d_id.b.rsvd_1
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check for device require authentication. */
id|pd-&gt;common_features
op_amp
id|BIT_5
ques
c_cond
(paren
id|fcport-&gt;flags
op_or_assign
id|FCF_AUTH_REQ
)paren
suffix:colon
(paren
id|fcport-&gt;flags
op_and_assign
op_complement
id|FCF_AUTH_REQ
)paren
suffix:semicolon
multiline_comment|/* If not target must be initiator or unknown type. */
r_if
c_cond
(paren
(paren
id|pd-&gt;prli_svc_param_word_3
(braket
l_int|0
)braket
op_amp
id|BIT_4
)paren
op_eq
l_int|0
)paren
id|fcport-&gt;port_type
op_assign
id|FCT_INITIATOR
suffix:semicolon
r_else
id|fcport-&gt;port_type
op_assign
id|FCT_TARGET
suffix:semicolon
id|gpd_error_out
suffix:colon
id|dma_pool_free
c_func
(paren
id|ha-&gt;s_dma_pool
comma
id|pd
comma
id|pd_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_port_database(%ld): &quot;
l_string|&quot;failed=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_port_database(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_get_firmware_state&n; *&t;Get adapter firmware state.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;dptr = pointer for firmware state.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_get_firmware_state
id|qla2x00_get_firmware_state
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
op_star
id|dptr
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_firmware_state(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_FIRMWARE_STATE
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
multiline_comment|/* Return firmware state. */
op_star
id|dptr
op_assign
id|mcp-&gt;mb
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_firmware_state(%ld): &quot;
l_string|&quot;failed=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_firmware_state(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_get_port_name&n; *&t;Issue get port name mailbox command.&n; *&t;Returned name is in big endian format.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;loop_id = loop ID of device.&n; *&t;name = pointer for name.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_get_port_name
id|qla2x00_get_port_name
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|loop_id
comma
r_uint8
op_star
id|name
comma
r_uint8
id|opt
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_port_name(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_PORT_NAME
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
r_if
c_cond
(paren
id|HAS_EXTENDED_IDS
c_func
(paren
id|ha
)paren
)paren
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|loop_id
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|10
)braket
op_assign
id|opt
suffix:semicolon
id|mcp-&gt;out_mb
op_or_assign
id|MBX_10
suffix:semicolon
)brace
r_else
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|loop_id
op_lshift
l_int|8
op_or
id|opt
suffix:semicolon
)brace
id|mcp-&gt;in_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_port_name(%ld): failed=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
r_if
c_cond
(paren
id|name
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* This function returns name in big endian. */
id|name
(braket
l_int|0
)braket
op_assign
id|LSB
c_func
(paren
id|mcp-&gt;mb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|name
(braket
l_int|1
)braket
op_assign
id|MSB
c_func
(paren
id|mcp-&gt;mb
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|name
(braket
l_int|2
)braket
op_assign
id|LSB
c_func
(paren
id|mcp-&gt;mb
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|name
(braket
l_int|3
)braket
op_assign
id|MSB
c_func
(paren
id|mcp-&gt;mb
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|name
(braket
l_int|4
)braket
op_assign
id|LSB
c_func
(paren
id|mcp-&gt;mb
(braket
l_int|6
)braket
)paren
suffix:semicolon
id|name
(braket
l_int|5
)braket
op_assign
id|MSB
c_func
(paren
id|mcp-&gt;mb
(braket
l_int|6
)braket
)paren
suffix:semicolon
id|name
(braket
l_int|6
)braket
op_assign
id|LSB
c_func
(paren
id|mcp-&gt;mb
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|name
(braket
l_int|7
)braket
op_assign
id|MSB
c_func
(paren
id|mcp-&gt;mb
(braket
l_int|7
)braket
)paren
suffix:semicolon
)brace
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_port_name(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_lip_reset&n; *&t;Issue LIP reset mailbox command.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_lip_reset
id|qla2x00_lip_reset
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_lip_reset(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_LIP_RESET
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
r_if
c_cond
(paren
id|HAS_EXTENDED_IDS
c_func
(paren
id|ha
)paren
)paren
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
l_int|0x00ff
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|10
)braket
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;out_mb
op_or_assign
id|MBX_10
suffix:semicolon
)brace
r_else
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
l_int|0xff00
suffix:semicolon
)brace
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|ha-&gt;loop_reset_delay
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_lip_reset(%ld): failed=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_lip_reset(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_send_sns&n; *&t;Send SNS command.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;sns = pointer for command.&n; *&t;cmd_size = command size.&n; *&t;buf_size = response/command size.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_send_sns
id|qla2x00_send_sns
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
id|dma_addr_t
id|sns_phys_address
comma
r_uint16
id|cmd_size
comma
r_int
id|buf_size
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_send_sns(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_send_sns: retry cnt=%d ratov=%d total &quot;
l_string|&quot;tov=%d.&bslash;n&quot;
comma
id|ha-&gt;retry_count
comma
id|ha-&gt;login_timeout
comma
id|mcp-&gt;tov
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_SEND_SNS_COMMAND
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|cmd_size
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|MSW
c_func
(paren
id|sns_phys_address
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|LSW
c_func
(paren
id|sns_phys_address
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
id|MSW
c_func
(paren
id|MSD
c_func
(paren
id|sns_phys_address
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|7
)braket
op_assign
id|LSW
c_func
(paren
id|MSD
c_func
(paren
id|sns_phys_address
)paren
)paren
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
op_or
id|MBX_1
suffix:semicolon
id|mcp-&gt;buf_size
op_assign
id|buf_size
suffix:semicolon
id|mcp-&gt;flags
op_assign
id|MBX_DMA_OUT
op_or
id|MBX_DMA_IN
suffix:semicolon
id|mcp-&gt;tov
op_assign
(paren
id|ha-&gt;login_timeout
op_star
l_int|2
)paren
op_plus
(paren
id|ha-&gt;login_timeout
op_div
l_int|2
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_send_sns(%ld): failed=%x mb[0]=%x &quot;
l_string|&quot;mb[1]=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
comma
id|mcp-&gt;mb
(braket
l_int|1
)braket
)paren
suffix:semicolon
)paren
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_send_sns(%ld): failed=%x mb[0]=%x &quot;
l_string|&quot;mb[1]=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
comma
id|mcp-&gt;mb
(braket
l_int|1
)braket
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_send_sns(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_login_fabric&n; *&t;Issue login fabric port mailbox command.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;loop_id = device loop ID.&n; *&t;domain = device domain.&n; *&t;area = device area.&n; *&t;al_pa = device AL_PA.&n; *&t;status = pointer for return status.&n; *&t;opt = command options.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_login_fabric
id|qla2x00_login_fabric
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|loop_id
comma
r_uint8
id|domain
comma
r_uint8
id|area
comma
r_uint8
id|al_pa
comma
r_uint16
op_star
id|mb
comma
r_uint8
id|opt
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_login_fabric(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_LOGIN_FABRIC_PORT
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
r_if
c_cond
(paren
id|HAS_EXTENDED_IDS
c_func
(paren
id|ha
)paren
)paren
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|loop_id
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|10
)braket
op_assign
id|opt
suffix:semicolon
id|mcp-&gt;out_mb
op_or_assign
id|MBX_10
suffix:semicolon
)brace
r_else
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
(paren
id|loop_id
op_lshift
l_int|8
)paren
op_or
id|opt
suffix:semicolon
)brace
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|domain
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|area
op_lshift
l_int|8
op_or
id|al_pa
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
(paren
id|ha-&gt;login_timeout
op_star
l_int|2
)paren
op_plus
(paren
id|ha-&gt;login_timeout
op_div
l_int|2
)paren
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
multiline_comment|/* Return mailbox statuses. */
r_if
c_cond
(paren
id|mb
op_ne
l_int|NULL
)paren
(brace
id|mb
(braket
l_int|0
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|0
)braket
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|1
)braket
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|2
)braket
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|6
)braket
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|7
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* RLU tmp code: need to change main mailbox_command function to&n;&t;&t; * return ok even when the mailbox completion value is not&n;&t;&t; * SUCCESS. The caller needs to be responsible to interpret&n;&t;&t; * the return values of this mailbox command if we&squot;re not&n;&t;&t; * to change too much of the existing code.&n;&t;&t; */
r_if
c_cond
(paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_eq
l_int|0x4001
op_logical_or
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_eq
l_int|0x4002
op_logical_or
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_eq
l_int|0x4003
op_logical_or
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_eq
l_int|0x4005
op_logical_or
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_eq
l_int|0x4006
)paren
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_login_fabric(%ld): failed=%x &quot;
l_string|&quot;mb[0]=%x mb[1]=%x mb[2]=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
comma
id|mcp-&gt;mb
(braket
l_int|1
)braket
comma
id|mcp-&gt;mb
(braket
l_int|2
)braket
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_login_fabric(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_login_local_device&n; *           Issue login loop port mailbox command.&n; *    &n; * Input:&n; *           ha = adapter block pointer.&n; *           loop_id = device loop ID.&n; *           opt = command options.&n; *          &n; * Returns:&n; *            Return status code.&n; *             &n; * Context:&n; *            Kernel context.&n; *             &n; */
r_int
DECL|function|qla2x00_login_local_device
id|qla2x00_login_local_device
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|loop_id
comma
r_uint16
op_star
id|mb_ret
comma
r_uint8
id|opt
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): entered.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_LOGIN_LOOP_PORT
suffix:semicolon
r_if
c_cond
(paren
id|HAS_EXTENDED_IDS
c_func
(paren
id|ha
)paren
)paren
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|loop_id
suffix:semicolon
r_else
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|loop_id
op_lshift
l_int|8
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|opt
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
(paren
id|ha-&gt;login_timeout
op_star
l_int|2
)paren
op_plus
(paren
id|ha-&gt;login_timeout
op_div
l_int|2
)paren
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
multiline_comment|/* Return mailbox statuses. */
r_if
c_cond
(paren
id|mb_ret
op_ne
l_int|NULL
)paren
(brace
id|mb_ret
(braket
l_int|0
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|0
)braket
suffix:semicolon
id|mb_ret
(braket
l_int|1
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|1
)braket
suffix:semicolon
id|mb_ret
(braket
l_int|6
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|6
)braket
suffix:semicolon
id|mb_ret
(braket
l_int|7
)braket
op_assign
id|mcp-&gt;mb
(braket
l_int|7
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/* AV tmp code: need to change main mailbox_command function to&n; &t;&t; * return ok even when the mailbox completion value is not&n; &t;&t; * SUCCESS. The caller needs to be responsible to interpret&n; &t;&t; * the return values of this mailbox command if we&squot;re not&n; &t;&t; * to change too much of the existing code.&n; &t;&t; */
r_if
c_cond
(paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_eq
l_int|0x4005
op_logical_or
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_eq
l_int|0x4006
)paren
id|rval
op_assign
id|QLA_SUCCESS
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): failed=%x mb[0]=%x mb[1]=%x &quot;
l_string|&quot;mb[6]=%x mb[7]=%x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|rval
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
comma
id|mcp-&gt;mb
(braket
l_int|1
)braket
comma
id|mcp-&gt;mb
(braket
l_int|6
)braket
comma
id|mcp-&gt;mb
(braket
l_int|7
)braket
)paren
suffix:semicolon
)paren
id|DEBUG2_3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): failed=%x mb[0]=%x mb[1]=%x &quot;
l_string|&quot;mb[6]=%x mb[7]=%x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|rval
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
comma
id|mcp-&gt;mb
(braket
l_int|1
)braket
comma
id|mcp-&gt;mb
(braket
l_int|6
)braket
comma
id|mcp-&gt;mb
(braket
l_int|7
)braket
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): done.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_fabric_logout&n; *&t;Issue logout fabric port mailbox command.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;loop_id = device loop ID.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_fabric_logout
id|qla2x00_fabric_logout
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
id|loop_id
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_fabric_logout(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_LOGOUT_FABRIC_PORT
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
r_if
c_cond
(paren
id|HAS_EXTENDED_IDS
c_func
(paren
id|ha
)paren
)paren
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|loop_id
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|10
)braket
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;out_mb
op_or_assign
id|MBX_10
suffix:semicolon
)brace
r_else
(brace
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|loop_id
op_lshift
l_int|8
suffix:semicolon
)brace
id|mcp-&gt;in_mb
op_assign
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_fabric_logout(%ld): failed=%x &quot;
l_string|&quot;mbx1=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
comma
id|mcp-&gt;mb
(braket
l_int|1
)braket
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_fabric_logout(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_full_login_lip&n; *&t;Issue full login LIP mailbox command.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&t;TARGET_QUEUE_LOCK must be released.&n; *&t;ADAPTER_STATE_LOCK must be released.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_full_login_lip
id|qla2x00_full_login_lip
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_full_login_lip(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_LIP_FULL_LOGIN
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_full_login_lip(%ld): failed=%x.&bslash;n&quot;
comma
id|ha-&gt;instance
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
multiline_comment|/*EMPTY*/
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_full_login_lip(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_get_id_list&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_get_id_list
id|qla2x00_get_id_list
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_void
op_star
id|id_list
comma
id|dma_addr_t
id|id_list_dma
comma
r_uint16
op_star
id|entries
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_id_list(%ld): entered.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|id_list
op_eq
l_int|NULL
)paren
r_return
id|QLA_FUNCTION_FAILED
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_ID_LIST
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|1
)braket
op_assign
id|MSW
c_func
(paren
id|id_list_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|LSW
c_func
(paren
id|id_list_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|MSW
c_func
(paren
id|MSD
c_func
(paren
id|id_list_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
id|LSW
c_func
(paren
id|MSD
c_func
(paren
id|id_list_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_6
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_id_list(%ld): failed=%x.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|rval
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
op_star
id|entries
op_assign
id|mcp-&gt;mb
(braket
l_int|1
)braket
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;qla2x00_get_id_list(%ld): done.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)paren
)brace
r_return
id|rval
suffix:semicolon
)brace
multiline_comment|/*&n; * qla2x00_get_resource_cnts&n; *&t;Get current firmware resource counts.&n; *&n; * Input:&n; *&t;ha = adapter block pointer.&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_get_resource_cnts
id|qla2x00_get_resource_cnts
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_uint16
op_star
id|cur_xchg_cnt
comma
r_uint16
op_star
id|orig_xchg_cnt
comma
r_uint16
op_star
id|cur_iocb_cnt
comma
r_uint16
op_star
id|orig_iocb_cnt
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): entered.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_RESOURCE_COUNTS
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_10
op_or
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;tov
op_assign
l_int|30
suffix:semicolon
id|mcp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
multiline_comment|/*EMPTY*/
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): failed = %x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)paren
)brace
r_else
(brace
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): done. mb1=%x mb2=%x mb3=%x mb6=%x &quot;
l_string|&quot;mb7=%x mb10=%x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|mcp-&gt;mb
(braket
l_int|1
)braket
comma
id|mcp-&gt;mb
(braket
l_int|2
)braket
comma
id|mcp-&gt;mb
(braket
l_int|3
)braket
comma
id|mcp-&gt;mb
(braket
l_int|6
)braket
comma
id|mcp-&gt;mb
(braket
l_int|7
)braket
comma
id|mcp-&gt;mb
(braket
l_int|10
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cur_xchg_cnt
)paren
op_star
id|cur_xchg_cnt
op_assign
id|mcp-&gt;mb
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|orig_xchg_cnt
)paren
op_star
id|orig_xchg_cnt
op_assign
id|mcp-&gt;mb
(braket
l_int|6
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cur_iocb_cnt
)paren
op_star
id|cur_iocb_cnt
op_assign
id|mcp-&gt;mb
(braket
l_int|7
)braket
suffix:semicolon
r_if
c_cond
(paren
id|orig_iocb_cnt
)paren
op_star
id|orig_iocb_cnt
op_assign
id|mcp-&gt;mb
(braket
l_int|10
)braket
suffix:semicolon
)brace
r_return
(paren
id|rval
)paren
suffix:semicolon
)brace
macro_line|#if defined(QL_DEBUG_LEVEL_3)
multiline_comment|/*&n; * qla2x00_get_fcal_position_map&n; *&t;Get FCAL (LILP) position map using mailbox command&n; *&n; * Input:&n; *&t;ha = adapter state pointer.&n; *&t;pos_map = buffer pointer (can be NULL).&n; *&n; * Returns:&n; *&t;qla2x00 local function return status code.&n; *&n; * Context:&n; *&t;Kernel context.&n; */
r_int
DECL|function|qla2x00_get_fcal_position_map
id|qla2x00_get_fcal_position_map
c_func
(paren
id|scsi_qla_host_t
op_star
id|ha
comma
r_char
op_star
id|pos_map
)paren
(brace
r_int
id|rval
suffix:semicolon
id|mbx_cmd_t
id|mc
suffix:semicolon
id|mbx_cmd_t
op_star
id|mcp
op_assign
op_amp
id|mc
suffix:semicolon
r_char
op_star
id|pmap
suffix:semicolon
id|dma_addr_t
id|pmap_dma
suffix:semicolon
id|pmap
op_assign
id|dma_pool_alloc
c_func
(paren
id|ha-&gt;s_dma_pool
comma
id|GFP_ATOMIC
comma
op_amp
id|pmap_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmap
op_eq
l_int|NULL
)paren
(brace
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): **** Mem Alloc Failed ****&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
r_return
id|QLA_MEMORY_ALLOC_FAILED
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pmap
comma
l_int|0
comma
id|FCAL_MAP_SIZE
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_FC_AL_POSITION_MAP
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|2
)braket
op_assign
id|MSW
c_func
(paren
id|pmap_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|3
)braket
op_assign
id|LSW
c_func
(paren
id|pmap_dma
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|6
)braket
op_assign
id|MSW
c_func
(paren
id|MSD
c_func
(paren
id|pmap_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;mb
(braket
l_int|7
)braket
op_assign
id|LSW
c_func
(paren
id|MSD
c_func
(paren
id|pmap_dma
)paren
)paren
suffix:semicolon
id|mcp-&gt;out_mb
op_assign
id|MBX_7
op_or
id|MBX_6
op_or
id|MBX_3
op_or
id|MBX_2
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;in_mb
op_assign
id|MBX_1
op_or
id|MBX_0
suffix:semicolon
id|mcp-&gt;buf_size
op_assign
id|FCAL_MAP_SIZE
suffix:semicolon
id|mcp-&gt;flags
op_assign
id|MBX_DMA_IN
suffix:semicolon
id|mcp-&gt;tov
op_assign
(paren
id|ha-&gt;login_timeout
op_star
l_int|2
)paren
op_plus
(paren
id|ha-&gt;login_timeout
op_div
l_int|2
)paren
suffix:semicolon
id|rval
op_assign
id|qla2x00_mailbox_command
c_func
(paren
id|ha
comma
id|mcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_eq
id|QLA_SUCCESS
)paren
(brace
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): (mb0=%x/mb1=%x) FC/AL Position Map &quot;
l_string|&quot;size (%x)&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|mcp-&gt;mb
(braket
l_int|0
)braket
comma
id|mcp-&gt;mb
(braket
l_int|1
)braket
comma
(paren
r_int
)paren
id|pmap
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|DEBUG11
c_func
(paren
id|qla2x00_dump_buffer
c_func
(paren
id|pmap
comma
id|pmap
(braket
l_int|0
)braket
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos_map
)paren
id|memcpy
c_func
(paren
id|pos_map
comma
id|pmap
comma
id|FCAL_MAP_SIZE
)paren
suffix:semicolon
)brace
id|dma_pool_free
c_func
(paren
id|ha-&gt;s_dma_pool
comma
id|pmap
comma
id|pmap_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rval
op_ne
id|QLA_SUCCESS
)paren
(brace
id|DEBUG2_3_11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): failed=%x.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG11
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;%s(%ld): done.&bslash;n&quot;
comma
id|__func__
comma
id|ha-&gt;host_no
)paren
)paren
suffix:semicolon
)brace
r_return
id|rval
suffix:semicolon
)brace
macro_line|#endif
eof
