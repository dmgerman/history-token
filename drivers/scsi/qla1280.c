multiline_comment|/******************************************************************************&n;*                  QLOGIC LINUX SOFTWARE&n;*&n;* QLogic  QLA1280 (Ultra2)  and  QLA12160 (Ultra3) SCSI driver&n;* Copyright (C) 2000 Qlogic Corporation (www.qlogic.com)&n;* Copyright (C) 2001-2004 Jes Sorensen, Wild Open Source Inc.&n;* Copyright (C) 2003-2004 Christoph Hellwig&n;*&n;* This program is free software; you can redistribute it and/or modify it&n;* under the terms of the GNU General Public License as published by the&n;* Free Software Foundation; either version 2, or (at your option) any&n;* later version.&n;*&n;* This program is distributed in the hope that it will be useful, but&n;* WITHOUT ANY WARRANTY; without even the implied warranty of&n;* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n;* General Public License for more details.&n;*&n;******************************************************************************/
DECL|macro|QLA1280_VERSION
mdefine_line|#define QLA1280_VERSION      &quot;3.25&quot;
multiline_comment|/*****************************************************************************&n;    Revision History:&n;    Rev  3.25, September 28, 2004, Christoph Hellwig&n;&t;- add support for ISP1020/1040&n;&t;- don&squot;t include &quot;scsi.h&quot; anymore for 2.6.x&n;    Rev  3.24.4 June 7, 2004 Christoph Hellwig&n;&t;- restructure firmware loading, cleanup initialization code&n;&t;- prepare support for ISP1020/1040 chips&n;    Rev  3.24.3 January 19, 2004, Jes Sorensen&n;&t;- Handle PCI DMA mask settings correctly&n;&t;- Correct order of error handling in probe_one, free_irq should not&n;&t;  be called if request_irq failed&n;    Rev  3.24.2 January 19, 2004, James Bottomley &amp; Andrew Vasquez&n;&t;- Big endian fixes (James)&n;&t;- Remove bogus IOCB content on zero data transfer commands (Andrew)&n;    Rev  3.24.1 January 5, 2004, Jes Sorensen&n;&t;- Initialize completion queue to avoid OOPS on probe&n;&t;- Handle interrupts during mailbox testing&n;    Rev  3.24 November 17, 2003, Christoph Hellwig&n;    &t;- use struct list_head for completion queue&n;&t;- avoid old Scsi_FOO typedefs&n;&t;- cleanup 2.4 compat glue a bit&n;&t;- use &lt;scsi/scsi_*.h&gt; headers on 2.6 instead of &quot;scsi.h&quot;&n;&t;- make initialization for memory mapped vs port I/O more similar&n;&t;- remove broken pci config space manipulation&n;&t;- kill more cruft&n;&t;- this is an almost perfect 2.6 scsi driver now! ;)&n;    Rev  3.23.39 December 17, 2003, Jes Sorensen&n;&t;- Delete completion queue from srb if mailbox command failed to&n;&t;  to avoid qla1280_done completeting qla1280_error_action&squot;s&n;&t;  obsolete context&n;&t;- Reduce arguments for qla1280_done&n;    Rev  3.23.38 October 18, 2003, Christoph Hellwig&n;&t;- Convert to new-style hotplugable driver for 2.6&n;&t;- Fix missing scsi_unregister/scsi_host_put on HBA removal&n;&t;- Kill some more cruft&n;    Rev  3.23.37 October 1, 2003, Jes Sorensen&n;&t;- Make MMIO depend on CONFIG_X86_VISWS instead of yet another&n;&t;  random CONFIG option&n;&t;- Clean up locking in probe path&n;    Rev  3.23.36 October 1, 2003, Christoph Hellwig&n;&t;- queuecommand only ever receives new commands - clear flags&n;&t;- Reintegrate lost fixes from Linux 2.5&n;    Rev  3.23.35 August 14, 2003, Jes Sorensen&n;&t;- Build against 2.6&n;    Rev  3.23.34 July 23, 2003, Jes Sorensen&n;&t;- Remove pointless TRUE/FALSE macros&n;&t;- Clean up vchan handling&n;    Rev  3.23.33 July 3, 2003, Jes Sorensen&n;&t;- Don&squot;t define register access macros before define determining MMIO.&n;&t;  This just happend to work out on ia64 but not elsewhere.&n;&t;- Don&squot;t try and read from the card while it is in reset as&n;&t;  it won&squot;t respond and causes an MCA&n;    Rev  3.23.32 June 23, 2003, Jes Sorensen&n;&t;- Basic support for boot time arguments&n;    Rev  3.23.31 June 8, 2003, Jes Sorensen&n;&t;- Reduce boot time messages&n;    Rev  3.23.30 June 6, 2003, Jes Sorensen&n;&t;- Do not enable sync/wide/ppr before it has been determined&n;&t;  that the target device actually supports it&n;&t;- Enable DMA arbitration for multi channel controllers&n;    Rev  3.23.29 June 3, 2003, Jes Sorensen&n;&t;- Port to 2.5.69&n;    Rev  3.23.28 June 3, 2003, Jes Sorensen&n;&t;- Eliminate duplicate marker commands on bus resets&n;&t;- Handle outstanding commands appropriately on bus/device resets&n;    Rev  3.23.27 May 28, 2003, Jes Sorensen&n;&t;- Remove bogus input queue code, let the Linux SCSI layer do the work&n;&t;- Clean up NVRAM handling, only read it once from the card&n;&t;- Add a number of missing default nvram parameters&n;    Rev  3.23.26 Beta May 28, 2003, Jes Sorensen&n;&t;- Use completion queue for mailbox commands instead of busy wait&n;    Rev  3.23.25 Beta May 27, 2003, James Bottomley&n;&t;- Migrate to use new error handling code&n;    Rev  3.23.24 Beta May 21, 2003, James Bottomley&n;&t;- Big endian support&n;&t;- Cleanup data direction code&n;    Rev  3.23.23 Beta May 12, 2003, Jes Sorensen&n;&t;- Switch to using MMIO instead of PIO&n;    Rev  3.23.22 Beta April 15, 2003, Jes Sorensen&n;&t;- Fix PCI parity problem with 12160 during reset.&n;    Rev  3.23.21 Beta April 14, 2003, Jes Sorensen&n;&t;- Use pci_map_page()/pci_unmap_page() instead of map_single version.&n;    Rev  3.23.20 Beta April 9, 2003, Jes Sorensen&n;&t;- Remove &lt; 2.4.x support&n;&t;- Introduce HOST_LOCK to make the spin lock changes portable.&n;&t;- Remove a bunch of idiotic and unnecessary typedef&squot;s&n;&t;- Kill all leftovers of target-mode support which never worked anyway&n;    Rev  3.23.19 Beta April 11, 2002, Linus Torvalds&n;&t;- Do qla1280_pci_config() before calling request_irq() and&n;&t;  request_region()&n;&t;- Use pci_dma_hi32() to handle upper word of DMA addresses instead&n;&t;  of large shifts&n;&t;- Hand correct arguments to free_irq() in case of failure&n;    Rev  3.23.18 Beta April 11, 2002, Jes Sorensen&n;&t;- Run source through Lindent and clean up the output&n;    Rev  3.23.17 Beta April 11, 2002, Jes Sorensen&n;&t;- Update SCSI firmware to qla1280 v8.15.00 and qla12160 v10.04.32&n;    Rev  3.23.16 Beta March 19, 2002, Jes Sorensen&n;&t;- Rely on mailbox commands generating interrupts - do not&n;&t;  run qla1280_isr() from ql1280_mailbox_command()&n;&t;- Remove device_reg_t&n;&t;- Integrate ql12160_set_target_parameters() with 1280 version&n;&t;- Make qla1280_setup() non static&n;&t;- Do not call qla1280_check_for_dead_scsi_bus() on every I/O request&n;&t;  sent to the card - this command pauses the firmare!!!&n;    Rev  3.23.15 Beta March 19, 2002, Jes Sorensen&n;&t;- Clean up qla1280.h - remove obsolete QL_DEBUG_LEVEL_x definitions&n;&t;- Remove a pile of pointless and confusing (srb_t **) and&n;&t;  (scsi_lu_t *) typecasts&n;&t;- Explicit mark that we do not use the new error handling (for now)&n;&t;- Remove scsi_qla_host_t and use &squot;struct&squot; instead&n;&t;- Remove in_abort, watchdog_enabled, dpc, dpc_sched, bios_enabled,&n;&t;  pci_64bit_slot flags which weren&squot;t used for anything anyway&n;&t;- Grab host-&gt;host_lock while calling qla1280_isr() from abort()&n;&t;- Use spin_lock()/spin_unlock() in qla1280_intr_handler() - we&n;&t;  do not need to save/restore flags in the interrupt handler&n;&t;- Enable interrupts early (before any mailbox access) in preparation&n;&t;  for cleaning up the mailbox handling&n;    Rev  3.23.14 Beta March 14, 2002, Jes Sorensen&n;&t;- Further cleanups. Remove all trace of QL_DEBUG_LEVEL_x and replace&n;&t;  it with proper use of dprintk().&n;&t;- Make qla1280_print_scsi_cmd() and qla1280_dump_buffer() both take&n;&t;  a debug level argument to determine if data is to be printed&n;&t;- Add KERN_* info to printk()&n;    Rev  3.23.13 Beta March 14, 2002, Jes Sorensen&n;&t;- Significant cosmetic cleanups&n;&t;- Change debug code to use dprintk() and remove #if mess&n;    Rev  3.23.12 Beta March 13, 2002, Jes Sorensen&n;&t;- More cosmetic cleanups, fix places treating return as function&n;&t;- use cpu_relax() in qla1280_debounce_register()&n;    Rev  3.23.11 Beta March 13, 2002, Jes Sorensen&n;&t;- Make it compile under 2.5.5&n;    Rev  3.23.10 Beta October 1, 2001, Jes Sorensen&n;&t;- Do no typecast short * to long * in QL1280BoardTbl, this&n;&t;  broke miserably on big endian boxes&n;    Rev  3.23.9 Beta September 30, 2001, Jes Sorensen&n;&t;- Remove pre 2.2 hack for checking for reentrance in interrupt handler&n;&t;- Make data types used to receive from SCSI_{BUS,TCN,LUN}_32&n;&t;  unsigned int to match the types from struct scsi_cmnd&n;    Rev  3.23.8 Beta September 29, 2001, Jes Sorensen&n;&t;- Remove bogus timer_t typedef from qla1280.h&n;&t;- Remove obsolete pre 2.2 PCI setup code, use proper #define&squot;s&n;&t;  for PCI_ values, call pci_set_master()&n;&t;- Fix memleak of qla1280_buffer on module unload&n;&t;- Only compile module parsing code #ifdef MODULE - should be&n;&t;  changed to use individual MODULE_PARM&squot;s later&n;&t;- Remove dummy_buffer that was never modified nor printed&n;&t;- ENTER()/LEAVE() are noops unless QL_DEBUG_LEVEL_3, hence remove&n;&t;  #ifdef QL_DEBUG_LEVEL_3/#endif around ENTER()/LEAVE() calls&n;&t;- Remove &bslash;r from print statements, this is Linux, not DOS&n;&t;- Remove obsolete QLA1280_{SCSILU,INTR,RING}_{LOCK,UNLOCK}&n;&t;  dummy macros&n;&t;- Remove C++ compile hack in header file as Linux driver are not&n;&t;  supposed to be compiled as C++&n;&t;- Kill MS_64BITS macro as it makes the code more readable&n;&t;- Remove unnecessary flags.in_interrupts bit&n;    Rev  3.23.7 Beta August 20, 2001, Jes Sorensen&n;&t;- Dont&squot; check for set flags on q-&gt;q_flag one by one in qla1280_next()&n;        - Check whether the interrupt was generated by the QLA1280 before&n;          doing any processing&n;&t;- qla1280_status_entry(): Only zero out part of sense_buffer that&n;&t;  is not being copied into&n;&t;- Remove more superflouous typecasts&n;&t;- qla1280_32bit_start_scsi() replace home-brew memcpy() with memcpy()&n;    Rev  3.23.6 Beta August 20, 2001, Tony Luck, Intel&n;        - Don&squot;t walk the entire list in qla1280_putq_t() just to directly&n;&t;  grab the pointer to the last element afterwards&n;    Rev  3.23.5 Beta August 9, 2001, Jes Sorensen&n;&t;- Don&squot;t use SA_INTERRUPT, it&squot;s use is deprecated for this kinda driver&n;    Rev  3.23.4 Beta August 8, 2001, Jes Sorensen&n;&t;- Set dev-&gt;max_sectors to 1024&n;    Rev  3.23.3 Beta August 6, 2001, Jes Sorensen&n;&t;- Provide compat macros for pci_enable_device(), pci_find_subsys()&n;&t;  and scsi_set_pci_device()&n;&t;- Call scsi_set_pci_device() for all devices&n;&t;- Reduce size of kernel version dependent device probe code&n;&t;- Move duplicate probe/init code to separate function&n;&t;- Handle error if qla1280_mem_alloc() fails&n;&t;- Kill OFFSET() macro and use Linux&squot;s PCI definitions instead&n;        - Kill private structure defining PCI config space (struct config_reg)&n;&t;- Only allocate I/O port region if not in MMIO mode&n;&t;- Remove duplicate (unused) sanity check of sife of srb_t&n;    Rev  3.23.2 Beta August 6, 2001, Jes Sorensen&n;&t;- Change home-brew memset() implementations to use memset()&n;        - Remove all references to COMTRACE() - accessing a PC&squot;s COM2 serial&n;          port directly is not legal under Linux.&n;    Rev  3.23.1 Beta April 24, 2001, Jes Sorensen&n;        - Remove pre 2.2 kernel support&n;        - clean up 64 bit DMA setting to use 2.4 API (provide backwards compat)&n;        - Fix MMIO access to use readl/writel instead of directly&n;          dereferencing pointers&n;        - Nuke MSDOS debugging code&n;        - Change true/false data types to int from uint8_t&n;        - Use int for counters instead of uint8_t etc.&n;        - Clean up size &amp; byte order conversion macro usage&n;    Rev  3.23 Beta January 11, 2001 BN Qlogic&n;        - Added check of device_id when handling non&n;          QLA12160s during detect().&n;    Rev  3.22 Beta January 5, 2001 BN Qlogic&n;        - Changed queue_task() to schedule_task()&n;          for kernels 2.4.0 and higher.&n;          Note: 2.4.0-testxx kernels released prior to&n;                the actual 2.4.0 kernel release on January 2001&n;                will get compile/link errors with schedule_task().&n;                Please update your kernel to released 2.4.0 level,&n;                or comment lines in this file flagged with  3.22&n;                to resolve compile/link error of schedule_task().&n;        - Added -DCONFIG_SMP in addition to -D__SMP__&n;          in Makefile for 2.4.0 builds of driver as module.&n;    Rev  3.21 Beta January 4, 2001 BN Qlogic&n;        - Changed criteria of 64/32 Bit mode of HBA&n;          operation according to BITS_PER_LONG rather&n;          than HBA&squot;s NVRAM setting of &gt;4Gig memory bit;&n;          so that the HBA auto-configures without the need&n;          to setup each system individually.&n;    Rev  3.20 Beta December 5, 2000 BN Qlogic&n;        - Added priority handling to IA-64  onboard SCSI&n;          ISP12160 chip for kernels greater than 2.3.18.&n;        - Added irqrestore for qla1280_intr_handler.&n;        - Enabled /proc/scsi/qla1280 interface.&n;        - Clear /proc/scsi/qla1280 counters in detect().&n;    Rev  3.19 Beta October 13, 2000 BN Qlogic&n;        - Declare driver_template for new kernel&n;          (2.4.0 and greater) scsi initialization scheme.&n;        - Update /proc/scsi entry for 2.3.18 kernels and&n;          above as qla1280&n;    Rev  3.18 Beta October 10, 2000 BN Qlogic&n;        - Changed scan order of adapters to map&n;          the QLA12160 followed by the QLA1280.&n;    Rev  3.17 Beta September 18, 2000 BN Qlogic&n;        - Removed warnings for 32 bit 2.4.x compiles&n;        - Corrected declared size for request and response&n;          DMA addresses that are kept in each ha&n;    Rev. 3.16 Beta  August 25, 2000   BN  Qlogic&n;        - Corrected 64 bit addressing issue on IA-64&n;          where the upper 32 bits were not properly&n;          passed to the RISC engine.&n;    Rev. 3.15 Beta  August 22, 2000   BN  Qlogic&n;        - Modified qla1280_setup_chip to properly load&n;          ISP firmware for greater that 4 Gig memory on IA-64&n;    Rev. 3.14 Beta  August 16, 2000   BN  Qlogic&n;        - Added setting of dma_mask to full 64 bit&n;          if flags.enable_64bit_addressing is set in NVRAM&n;    Rev. 3.13 Beta  August 16, 2000   BN  Qlogic&n;        - Use new PCI DMA mapping APIs for 2.4.x kernel&n;    Rev. 3.12       July 18, 2000    Redhat &amp; BN Qlogic&n;        - Added check of pci_enable_device to detect() for 2.3.x&n;        - Use pci_resource_start() instead of&n;          pdev-&gt;resource[0].start in detect() for 2.3.x&n;        - Updated driver version&n;    Rev. 3.11       July 14, 2000    BN  Qlogic&n;&t;- Updated SCSI Firmware to following versions:&n;&t;  qla1x80:   8.13.08&n;&t;  qla1x160:  10.04.08&n;&t;- Updated driver version to 3.11&n;    Rev. 3.10    June 23, 2000   BN Qlogic&n;        - Added filtering of AMI SubSys Vendor ID devices&n;    Rev. 3.9&n;        - DEBUG_QLA1280 undefined and  new version  BN Qlogic&n;    Rev. 3.08b      May 9, 2000    MD Dell&n;        - Added logic to check against AMI subsystem vendor ID&n;&t;Rev. 3.08       May 4, 2000    DG  Qlogic&n;        - Added logic to check for PCI subsystem ID.&n;&t;Rev. 3.07       Apr 24, 2000    DG &amp; BN  Qlogic&n;&t;   - Updated SCSI Firmware to following versions:&n;&t;     qla12160:   10.01.19&n;&t;&t; qla1280:     8.09.00&n;&t;Rev. 3.06       Apr 12, 2000    DG &amp; BN  Qlogic&n;&t;   - Internal revision; not released&n;    Rev. 3.05       Mar 28, 2000    DG &amp; BN  Qlogic&n;       - Edit correction for virt_to_bus and PROC.&n;    Rev. 3.04       Mar 28, 2000    DG &amp; BN  Qlogic&n;       - Merge changes from ia64 port.&n;    Rev. 3.03       Mar 28, 2000    BN  Qlogic&n;       - Increase version to reflect new code drop with compile fix&n;         of issue with inclusion of linux/spinlock for 2.3 kernels&n;    Rev. 3.02       Mar 15, 2000    BN  Qlogic&n;       - Merge qla1280_proc_info from 2.10 code base&n;    Rev. 3.01       Feb 10, 2000    BN  Qlogic&n;       - Corrected code to compile on a 2.2.x kernel.&n;    Rev. 3.00       Jan 17, 2000    DG  Qlogic&n;&t;   - Added 64-bit support.&n;    Rev. 2.07       Nov 9, 1999     DG  Qlogic&n;&t;   - Added new routine to set target parameters for ISP12160.&n;    Rev. 2.06       Sept 10, 1999     DG  Qlogic&n;       - Added support for ISP12160 Ultra 3 chip.&n;    Rev. 2.03       August 3, 1999    Fred Lewis, Intel DuPont&n;&t;- Modified code to remove errors generated when compiling with&n;&t;  Cygnus IA64 Compiler.&n;        - Changed conversion of pointers to unsigned longs instead of integers.&n;        - Changed type of I/O port variables from uint32_t to unsigned long.&n;        - Modified OFFSET macro to work with 64-bit as well as 32-bit.&n;        - Changed sprintf and printk format specifiers for pointers to %p.&n;        - Changed some int to long type casts where needed in sprintf &amp; printk.&n;        - Added l modifiers to sprintf and printk format specifiers for longs.&n;        - Removed unused local variables.&n;    Rev. 1.20       June 8, 1999      DG,  Qlogic&n;         Changes to support RedHat release 6.0 (kernel 2.2.5).&n;       - Added SCSI exclusive access lock (io_request_lock) when accessing&n;         the adapter.&n;       - Added changes for the new LINUX interface template. Some new error&n;         handling routines have been added to the template, but for now we&n;         will use the old ones.&n;    -   Initial Beta Release.&n;*****************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci_ids.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= 0x020545
macro_line|#include &lt;scsi/scsi.h&gt;
macro_line|#include &lt;scsi/scsi_cmnd.h&gt;
macro_line|#include &lt;scsi/scsi_device.h&gt;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsi_tcq.h&gt;
macro_line|#else
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &quot;sd.h&quot;
macro_line|#endif
macro_line|#if defined(CONFIG_IA64_GENERIC) || defined(CONFIG_IA64_SGI_SN2)
macro_line|#include &lt;asm/sn/io.h&gt;
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; 0x020407
macro_line|#error &quot;Kernels older than 2.4.7 are no longer supported&quot;
macro_line|#endif
multiline_comment|/*&n; * Compile time Options:&n; *            0 - Disable and 1 - Enable&n; */
DECL|macro|DEBUG_QLA1280_INTR
mdefine_line|#define  DEBUG_QLA1280_INTR&t;0
DECL|macro|DEBUG_PRINT_NVRAM
mdefine_line|#define  DEBUG_PRINT_NVRAM&t;0
DECL|macro|DEBUG_QLA1280
mdefine_line|#define  DEBUG_QLA1280&t;&t;0
multiline_comment|/*&n; * The SGI VISWS is broken and doesn&squot;t support MMIO ;-(&n; */
macro_line|#ifdef CONFIG_X86_VISWS
DECL|macro|MEMORY_MAPPED_IO
mdefine_line|#define&t;MEMORY_MAPPED_IO&t;0
macro_line|#else
DECL|macro|MEMORY_MAPPED_IO
mdefine_line|#define&t;MEMORY_MAPPED_IO&t;1
macro_line|#endif
DECL|macro|UNIQUE_FW_NAME
mdefine_line|#define UNIQUE_FW_NAME
macro_line|#include &quot;qla1280.h&quot;
macro_line|#include &quot;ql12160_fw.h&quot;&t;&t;/* ISP RISC codes */
macro_line|#include &quot;ql1280_fw.h&quot;
macro_line|#include &quot;ql1040_fw.h&quot;
multiline_comment|/*&n; * Missing PCI ID&squot;s&n; */
macro_line|#ifndef PCI_DEVICE_ID_QLOGIC_ISP1080
DECL|macro|PCI_DEVICE_ID_QLOGIC_ISP1080
mdefine_line|#define PCI_DEVICE_ID_QLOGIC_ISP1080&t;0x1080
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_QLOGIC_ISP1240
DECL|macro|PCI_DEVICE_ID_QLOGIC_ISP1240
mdefine_line|#define PCI_DEVICE_ID_QLOGIC_ISP1240&t;0x1240
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_QLOGIC_ISP1280
DECL|macro|PCI_DEVICE_ID_QLOGIC_ISP1280
mdefine_line|#define PCI_DEVICE_ID_QLOGIC_ISP1280&t;0x1280
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_QLOGIC_ISP10160
DECL|macro|PCI_DEVICE_ID_QLOGIC_ISP10160
mdefine_line|#define PCI_DEVICE_ID_QLOGIC_ISP10160&t;0x1016
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_QLOGIC_ISP12160
DECL|macro|PCI_DEVICE_ID_QLOGIC_ISP12160
mdefine_line|#define PCI_DEVICE_ID_QLOGIC_ISP12160&t;0x1216
macro_line|#endif
macro_line|#ifndef PCI_VENDOR_ID_AMI
DECL|macro|PCI_VENDOR_ID_AMI
mdefine_line|#define PCI_VENDOR_ID_AMI               0x101e
macro_line|#endif
macro_line|#ifndef BITS_PER_LONG
macro_line|#error &quot;BITS_PER_LONG not defined!&quot;
macro_line|#endif
macro_line|#if (BITS_PER_LONG == 64) || defined CONFIG_HIGHMEM
DECL|macro|QLA_64BIT_PTR
mdefine_line|#define QLA_64BIT_PTR&t;1
macro_line|#endif
macro_line|#ifdef QLA_64BIT_PTR
DECL|macro|pci_dma_hi32
mdefine_line|#define pci_dma_hi32(a)&t;&t;&t;((a &gt;&gt; 16) &gt;&gt; 16)
macro_line|#else
DECL|macro|pci_dma_hi32
mdefine_line|#define pci_dma_hi32(a)&t;&t;&t;0
macro_line|#endif
DECL|macro|pci_dma_lo32
mdefine_line|#define pci_dma_lo32(a)&t;&t;&t;(a &amp; 0xffffffff)
DECL|macro|NVRAM_DELAY
mdefine_line|#define NVRAM_DELAY()&t;&t;&t;udelay(500)&t;/* 2 microseconds */
macro_line|#if LINUX_VERSION_CODE &lt; 0x020500
DECL|macro|HOST_LOCK
mdefine_line|#define HOST_LOCK&t;&t;&t;&amp;io_request_lock
DECL|macro|irqreturn_t
mdefine_line|#define irqreturn_t&t;&t;&t;void
DECL|macro|IRQ_RETVAL
mdefine_line|#define IRQ_RETVAL(foo)
DECL|macro|MSG_ORDERED_TAG
mdefine_line|#define MSG_ORDERED_TAG&t;&t;&t;1
DECL|macro|DMA_BIDIRECTIONAL
mdefine_line|#define DMA_BIDIRECTIONAL&t;SCSI_DATA_UNKNOWN
DECL|macro|DMA_TO_DEVICE
mdefine_line|#define DMA_TO_DEVICE&t;&t;SCSI_DATA_WRITE
DECL|macro|DMA_FROM_DEVICE
mdefine_line|#define DMA_FROM_DEVICE&t;&t;SCSI_DATA_READ
DECL|macro|DMA_NONE
mdefine_line|#define DMA_NONE&t;&t;SCSI_DATA_NONE
macro_line|#ifndef HAVE_SECTOR_T
DECL|typedef|sector_t
r_typedef
r_int
r_int
id|sector_t
suffix:semicolon
macro_line|#endif
r_static
r_inline
r_void
DECL|function|scsi_adjust_queue_depth
id|scsi_adjust_queue_depth
c_func
(paren
r_struct
id|scsi_device
op_star
id|device
comma
r_int
id|tag
comma
r_int
id|depth
)paren
(brace
r_if
c_cond
(paren
id|tag
)paren
(brace
id|device-&gt;tagged_queue
op_assign
id|tag
suffix:semicolon
id|device-&gt;current_tag
op_assign
l_int|0
suffix:semicolon
)brace
id|device-&gt;queue_depth
op_assign
id|depth
suffix:semicolon
)brace
DECL|function|scsi_host_alloc
r_static
r_inline
r_struct
id|Scsi_Host
op_star
id|scsi_host_alloc
c_func
(paren
id|Scsi_Host_Template
op_star
id|t
comma
r_int
id|s
)paren
(brace
r_return
id|scsi_register
c_func
(paren
id|t
comma
id|s
)paren
suffix:semicolon
)brace
DECL|function|scsi_host_put
r_static
r_inline
r_void
id|scsi_host_put
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|h
)paren
(brace
id|scsi_unregister
c_func
(paren
id|h
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|HOST_LOCK
mdefine_line|#define HOST_LOCK&t;&t;&t;ha-&gt;host-&gt;host_lock
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; 0x020600
DECL|macro|DEV_SIMPLE_TAGS
mdefine_line|#define DEV_SIMPLE_TAGS(device)&t;&t;device-&gt;tagged_queue
multiline_comment|/*&n; * Hack around that qla1280_remove_one is called from&n; * qla1280_release in 2.4&n; */
DECL|macro|__devexit
macro_line|#undef __devexit
DECL|macro|__devexit
mdefine_line|#define __devexit
macro_line|#else
DECL|macro|DEV_SIMPLE_TAGS
mdefine_line|#define DEV_SIMPLE_TAGS(device)&t;&t;device-&gt;simple_tags
macro_line|#endif
macro_line|#if defined(__ia64__) &amp;&amp; !defined(ia64_platform_is)
DECL|macro|ia64_platform_is
mdefine_line|#define ia64_platform_is(foo)&t;&t;(!strcmp(x, platform_name))
macro_line|#endif
DECL|macro|IS_ISP1040
mdefine_line|#define IS_ISP1040(ha) (ha-&gt;pdev-&gt;device == PCI_DEVICE_ID_QLOGIC_ISP1020)
DECL|macro|IS_ISP1x40
mdefine_line|#define IS_ISP1x40(ha) (ha-&gt;pdev-&gt;device == PCI_DEVICE_ID_QLOGIC_ISP1020 || &bslash;&n;&t;&t;&t;ha-&gt;pdev-&gt;device == PCI_DEVICE_ID_QLOGIC_ISP1240)
DECL|macro|IS_ISP1x160
mdefine_line|#define IS_ISP1x160(ha)        (ha-&gt;pdev-&gt;device == PCI_DEVICE_ID_QLOGIC_ISP10160 || &bslash;&n;&t;&t;&t;&t;ha-&gt;pdev-&gt;device == PCI_DEVICE_ID_QLOGIC_ISP12160)
r_static
r_int
id|qla1280_probe_one
c_func
(paren
r_struct
id|pci_dev
op_star
comma
r_const
r_struct
id|pci_device_id
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; *  QLogic Driver Support Function Prototypes.&n; */
r_static
r_void
id|qla1280_done
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; 0x020545
r_static
r_void
id|qla1280_get_target_options
c_func
(paren
r_struct
id|scsi_cmnd
op_star
comma
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|qla1280_get_token
c_func
(paren
r_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_setup
c_func
(paren
r_char
op_star
id|s
)paren
id|__init
suffix:semicolon
multiline_comment|/*&n; *  QLogic ISP1280 Hardware Support Function Prototypes.&n; */
r_static
r_int
id|qla1280_load_firmware
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_init_rings
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_nvram_config
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_mailbox_command
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_uint8
comma
r_uint16
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_bus_reset
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla1280_device_reset
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla1280_abort_device
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla1280_abort_command
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_struct
id|srb
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla1280_abort_isp
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
macro_line|#ifdef QLA_64BIT_PTR
r_static
r_int
id|qla1280_64bit_start_scsi
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_struct
id|srb
op_star
)paren
suffix:semicolon
macro_line|#else
r_static
r_int
id|qla1280_32bit_start_scsi
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_struct
id|srb
op_star
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|qla1280_nv_write
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_uint16
)paren
suffix:semicolon
r_static
r_void
id|qla1280_poll
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_reset_adapter
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_marker
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
comma
r_int
comma
r_int
comma
id|u8
)paren
suffix:semicolon
r_static
r_void
id|qla1280_isp_cmd
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_isr
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_struct
id|list_head
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_rst_aen
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_status_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_struct
id|response
op_star
comma
r_struct
id|list_head
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_error_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_struct
id|response
op_star
comma
r_struct
id|list_head
op_star
)paren
suffix:semicolon
r_static
r_uint16
id|qla1280_get_nvram_word
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_uint32
)paren
suffix:semicolon
r_static
r_uint16
id|qla1280_nvram_request
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_uint32
)paren
suffix:semicolon
r_static
r_uint16
id|qla1280_debounce_register
c_func
(paren
r_volatile
r_uint16
op_star
)paren
suffix:semicolon
r_static
id|request_t
op_star
id|qla1280_req_pkt
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_check_for_dead_scsi_bus
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|qla1280_get_target_parameters
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_struct
id|scsi_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_set_target_parameters
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|qla_driver_setup
id|driver_setup
id|__initdata
suffix:semicolon
multiline_comment|/*&n; * convert scsi data direction to request_t control flags&n; */
r_static
r_inline
r_uint16
DECL|function|qla1280_data_direction
id|qla1280_data_direction
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmnd
)paren
(brace
r_switch
c_cond
(paren
id|cmnd-&gt;sc_data_direction
)paren
(brace
r_case
id|DMA_FROM_DEVICE
suffix:colon
r_return
id|BIT_5
suffix:semicolon
r_case
id|DMA_TO_DEVICE
suffix:colon
r_return
id|BIT_6
suffix:semicolon
r_case
id|DMA_BIDIRECTIONAL
suffix:colon
r_return
id|BIT_5
op_or
id|BIT_6
suffix:semicolon
multiline_comment|/*&n;&t; * We could BUG() on default here if one of the four cases aren&squot;t&n;&t; * met, but then again if we receive something like that from the&n;&t; * SCSI layer we have more serious problems. This shuts up GCC.&n;&t; */
r_case
id|DMA_NONE
suffix:colon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#if DEBUG_QLA1280
r_static
r_void
id|__qla1280_print_scsi_cmd
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|__qla1280_dump_buffer
c_func
(paren
r_char
op_star
comma
r_int
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * insmod needs to find the variable and make it point to something&n; */
macro_line|#ifdef MODULE
DECL|variable|qla1280
r_static
r_char
op_star
id|qla1280
suffix:semicolon
multiline_comment|/* insmod qla1280 options=verbose&quot; */
id|MODULE_PARM
c_func
(paren
id|qla1280
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
macro_line|#else
id|__setup
c_func
(paren
l_string|&quot;qla1280=&quot;
comma
id|qla1280_setup
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * We use the scsi_pointer structure that&squot;s included with each scsi_command&n; * to overlay our struct srb over it. qla1280_init() checks that a srb is not&n; * bigger than a scsi_pointer.&n; */
DECL|macro|CMD_SP
mdefine_line|#define&t;CMD_SP(Cmnd)&t;&t;&amp;Cmnd-&gt;SCp
DECL|macro|CMD_CDBLEN
mdefine_line|#define&t;CMD_CDBLEN(Cmnd)&t;Cmnd-&gt;cmd_len
DECL|macro|CMD_CDBP
mdefine_line|#define&t;CMD_CDBP(Cmnd)&t;&t;Cmnd-&gt;cmnd
DECL|macro|CMD_SNSP
mdefine_line|#define&t;CMD_SNSP(Cmnd)&t;&t;Cmnd-&gt;sense_buffer
DECL|macro|CMD_SNSLEN
mdefine_line|#define&t;CMD_SNSLEN(Cmnd)&t;sizeof(Cmnd-&gt;sense_buffer)
DECL|macro|CMD_RESULT
mdefine_line|#define&t;CMD_RESULT(Cmnd)&t;Cmnd-&gt;result
DECL|macro|CMD_HANDLE
mdefine_line|#define&t;CMD_HANDLE(Cmnd)&t;Cmnd-&gt;host_scribble
macro_line|#if LINUX_VERSION_CODE &lt; 0x020545
DECL|macro|CMD_REQUEST
mdefine_line|#define CMD_REQUEST(Cmnd)&t;Cmnd-&gt;request.cmd
macro_line|#else
DECL|macro|CMD_REQUEST
mdefine_line|#define CMD_REQUEST(Cmnd)&t;Cmnd-&gt;request-&gt;cmd
macro_line|#endif
DECL|macro|CMD_HOST
mdefine_line|#define CMD_HOST(Cmnd)&t;&t;Cmnd-&gt;device-&gt;host
DECL|macro|SCSI_BUS_32
mdefine_line|#define SCSI_BUS_32(Cmnd)&t;Cmnd-&gt;device-&gt;channel
DECL|macro|SCSI_TCN_32
mdefine_line|#define SCSI_TCN_32(Cmnd)&t;Cmnd-&gt;device-&gt;id
DECL|macro|SCSI_LUN_32
mdefine_line|#define SCSI_LUN_32(Cmnd)&t;Cmnd-&gt;device-&gt;lun
multiline_comment|/*****************************************/
multiline_comment|/*   ISP Boards supported by this driver */
multiline_comment|/*****************************************/
DECL|struct|qla_boards
r_struct
id|qla_boards
(brace
DECL|member|name
r_int
r_char
id|name
(braket
l_int|9
)braket
suffix:semicolon
multiline_comment|/* Board ID String */
DECL|member|numPorts
r_int
id|numPorts
suffix:semicolon
multiline_comment|/* Number of SCSI ports */
DECL|member|fwcode
r_int
r_int
op_star
id|fwcode
suffix:semicolon
multiline_comment|/* pointer to FW array         */
DECL|member|fwlen
r_int
r_int
op_star
id|fwlen
suffix:semicolon
multiline_comment|/* number of words in array    */
DECL|member|fwstart
r_int
r_int
op_star
id|fwstart
suffix:semicolon
multiline_comment|/* start address for F/W       */
DECL|member|fwver
r_int
r_char
op_star
id|fwver
suffix:semicolon
multiline_comment|/* Ptr to F/W version array    */
)brace
suffix:semicolon
multiline_comment|/* NOTE: the last argument in each entry is used to index ql1280_board_tbl */
DECL|variable|qla1280_pci_tbl
r_static
r_struct
id|pci_device_id
id|qla1280_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_QLOGIC
comma
id|PCI_DEVICE_ID_QLOGIC_ISP12160
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
macro_line|#ifdef CONFIG_SCSI_QLOGIC_1280_1040
(brace
id|PCI_VENDOR_ID_QLOGIC
comma
id|PCI_DEVICE_ID_QLOGIC_ISP1020
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|1
)brace
comma
macro_line|#endif
(brace
id|PCI_VENDOR_ID_QLOGIC
comma
id|PCI_DEVICE_ID_QLOGIC_ISP1080
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|2
)brace
comma
(brace
id|PCI_VENDOR_ID_QLOGIC
comma
id|PCI_DEVICE_ID_QLOGIC_ISP1240
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|3
)brace
comma
(brace
id|PCI_VENDOR_ID_QLOGIC
comma
id|PCI_DEVICE_ID_QLOGIC_ISP1280
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|4
)brace
comma
(brace
id|PCI_VENDOR_ID_QLOGIC
comma
id|PCI_DEVICE_ID_QLOGIC_ISP10160
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|5
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|qla1280_pci_tbl
)paren
suffix:semicolon
DECL|variable|ql1280_board_tbl
r_static
r_struct
id|qla_boards
id|ql1280_board_tbl
(braket
)braket
op_assign
(brace
multiline_comment|/* Name ,  Number of ports, FW details */
(brace
l_string|&quot;QLA12160&quot;
comma
l_int|2
comma
op_amp
id|fw12160i_code01
(braket
l_int|0
)braket
comma
op_amp
id|fw12160i_length01
comma
op_amp
id|fw12160i_addr01
comma
op_amp
id|fw12160i_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA1040&quot;
comma
l_int|1
comma
op_amp
id|risc_code01
(braket
l_int|0
)braket
comma
op_amp
id|risc_code_length01
comma
op_amp
id|risc_code_addr01
comma
op_amp
id|firmware_version
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA1080&quot;
comma
l_int|1
comma
op_amp
id|fw1280ei_code01
(braket
l_int|0
)braket
comma
op_amp
id|fw1280ei_length01
comma
op_amp
id|fw1280ei_addr01
comma
op_amp
id|fw1280ei_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA1240&quot;
comma
l_int|2
comma
op_amp
id|fw1280ei_code01
(braket
l_int|0
)braket
comma
op_amp
id|fw1280ei_length01
comma
op_amp
id|fw1280ei_addr01
comma
op_amp
id|fw1280ei_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA1280&quot;
comma
l_int|2
comma
op_amp
id|fw1280ei_code01
(braket
l_int|0
)braket
comma
op_amp
id|fw1280ei_length01
comma
op_amp
id|fw1280ei_addr01
comma
op_amp
id|fw1280ei_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA10160&quot;
comma
l_int|1
comma
op_amp
id|fw12160i_code01
(braket
l_int|0
)braket
comma
op_amp
id|fw12160i_length01
comma
op_amp
id|fw12160i_addr01
comma
op_amp
id|fw12160i_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;        &quot;
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|qla1280_verbose
r_static
r_int
id|qla1280_verbose
op_assign
l_int|1
suffix:semicolon
DECL|variable|qla1280_buffer_size
r_static
r_int
id|qla1280_buffer_size
suffix:semicolon
DECL|variable|qla1280_buffer
r_static
r_char
op_star
id|qla1280_buffer
suffix:semicolon
macro_line|#if DEBUG_QLA1280
DECL|variable|ql_debug_level
r_static
r_int
id|ql_debug_level
op_assign
l_int|1
suffix:semicolon
DECL|macro|dprintk
mdefine_line|#define dprintk(level, format, a...)&t;&bslash;&n;&t;do { if (ql_debug_level &gt;= level) printk(KERN_ERR format, ##a); } while(0)
DECL|macro|qla1280_dump_buffer
mdefine_line|#define qla1280_dump_buffer(level, buf, size)&t;&bslash;&n;&t;if (ql_debug_level &gt;= level) __qla1280_dump_buffer(buf, size)
DECL|macro|qla1280_print_scsi_cmd
mdefine_line|#define qla1280_print_scsi_cmd(level, cmd)&t;&bslash;&n;&t;if (ql_debug_level &gt;= level) __qla1280_print_scsi_cmd(cmd)
macro_line|#else
DECL|macro|ql_debug_level
mdefine_line|#define ql_debug_level&t;&t;&t;0
DECL|macro|dprintk
mdefine_line|#define dprintk(level, format, a...)&t;do{}while(0)
DECL|macro|qla1280_dump_buffer
mdefine_line|#define qla1280_dump_buffer(a, b, c)&t;do{}while(0)
DECL|macro|qla1280_print_scsi_cmd
mdefine_line|#define qla1280_print_scsi_cmd(a, b)&t;do{}while(0)
macro_line|#endif
DECL|macro|ENTER
mdefine_line|#define ENTER(x)&t;&t;dprintk(3, &quot;qla1280 : Entering %s()&bslash;n&quot;, x);
DECL|macro|LEAVE
mdefine_line|#define LEAVE(x)&t;&t;dprintk(3, &quot;qla1280 : Leaving %s()&bslash;n&quot;, x);
DECL|macro|ENTER_INTR
mdefine_line|#define ENTER_INTR(x)&t;&t;dprintk(4, &quot;qla1280 : Entering %s()&bslash;n&quot;, x);
DECL|macro|LEAVE_INTR
mdefine_line|#define LEAVE_INTR(x)&t;&t;dprintk(4, &quot;qla1280 : Leaving %s()&bslash;n&quot;, x);
multiline_comment|/*************************************************************************&n; * qla1280_proc_info&n; *&n; * Description:&n; *   Return information to handle /proc support for the driver.&n; *&n; * buffer - ptrs to a page buffer&n; *&n; * Returns:&n; *************************************************************************/
DECL|macro|PROC_BUF
mdefine_line|#define&t;PROC_BUF&t;&amp;qla1280_buffer[len]
DECL|function|qla1280_proc_info
r_static
r_int
id|qla1280_proc_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|inout
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|qla_boards
op_star
id|bdp
op_assign
op_amp
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
suffix:semicolon
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|inout
)paren
r_return
op_minus
id|ENOSYS
suffix:semicolon
multiline_comment|/*&n;&t; * if our old buffer is the right size use it otherwise&n;&t; * allocate a new one.&n;&t; */
r_if
c_cond
(paren
id|qla1280_buffer_size
op_ne
id|PAGE_SIZE
)paren
(brace
multiline_comment|/* deallocate this buffer and get a new one */
r_if
c_cond
(paren
id|qla1280_buffer
op_ne
l_int|NULL
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|qla1280_buffer
)paren
suffix:semicolon
id|qla1280_buffer_size
op_assign
l_int|0
suffix:semicolon
)brace
id|qla1280_buffer
op_assign
(paren
r_char
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qla1280_buffer
op_eq
l_int|NULL
)paren
(brace
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;qla1280 - kmalloc error at line %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
multiline_comment|/* save the size of our buffer */
id|qla1280_buffer_size
op_assign
id|PAGE_SIZE
suffix:semicolon
multiline_comment|/* 3.20 clear the buffer we use for proc display */
id|memset
c_func
(paren
id|qla1280_buffer
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* start building the print buffer */
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;QLogic PCI to SCSI Adapter for ISP 1280/12160:&bslash;n&quot;
l_string|&quot;        Firmware version: %2d.%02d.%02d, Driver version %s&bslash;n&quot;
comma
id|bdp-&gt;fwver
(braket
l_int|0
)braket
comma
id|bdp-&gt;fwver
(braket
l_int|1
)braket
comma
id|bdp-&gt;fwver
(braket
l_int|2
)braket
comma
id|QLA1280_VERSION
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;SCSI Host Adapter Information: %s&bslash;n&quot;
comma
id|bdp-&gt;name
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Request Queue count= 0x%x, Response &quot;
l_string|&quot;Queue count= 0x%x&bslash;n&quot;
comma
id|REQUEST_ENTRY_CNT
comma
id|RESPONSE_ENTRY_CNT
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Number of pending commands = 0x%lx&bslash;n&quot;
comma
id|ha-&gt;actthreads
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Number of free request entries = %d&bslash;n&quot;
comma
id|ha-&gt;req_q_cnt
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* 1       */
id|len
op_add_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
id|qla1280_buffer_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Overflow buffer in qla1280_proc.c&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|offset
OG
id|len
op_minus
l_int|1
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|qla1280_buffer
)paren
suffix:semicolon
id|qla1280_buffer
op_assign
l_int|NULL
suffix:semicolon
id|qla1280_buffer_size
op_assign
id|length
op_assign
l_int|0
suffix:semicolon
op_star
id|start
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
op_star
id|start
op_assign
op_amp
id|qla1280_buffer
(braket
id|offset
)braket
suffix:semicolon
multiline_comment|/* Start of wanted data */
r_if
c_cond
(paren
id|len
op_minus
id|offset
OL
id|length
)paren
(brace
id|length
op_assign
id|len
op_minus
id|offset
suffix:semicolon
)brace
)brace
r_return
id|length
suffix:semicolon
)brace
DECL|function|qla1280_read_nvram
r_static
r_int
id|qla1280_read_nvram
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_uint16
op_star
id|wptr
suffix:semicolon
r_uint8
id|chksum
suffix:semicolon
r_int
id|cnt
comma
id|i
suffix:semicolon
r_struct
id|nvram
op_star
id|nv
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_read_nvram&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver_setup.no_nvram
)paren
r_return
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): Reading NVRAM&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|wptr
op_assign
(paren
r_uint16
op_star
)paren
op_amp
id|ha-&gt;nvram
suffix:semicolon
id|nv
op_assign
op_amp
id|ha-&gt;nvram
suffix:semicolon
id|chksum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|3
suffix:semicolon
id|cnt
op_increment
)paren
(brace
op_star
id|wptr
op_assign
id|qla1280_get_nvram_word
c_func
(paren
id|ha
comma
id|cnt
)paren
suffix:semicolon
id|chksum
op_add_assign
op_star
id|wptr
op_amp
l_int|0xff
suffix:semicolon
id|chksum
op_add_assign
(paren
op_star
id|wptr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|wptr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nv-&gt;id0
op_ne
l_char|&squot;I&squot;
op_logical_or
id|nv-&gt;id1
op_ne
l_char|&squot;S&squot;
op_logical_or
id|nv-&gt;id2
op_ne
l_char|&squot;P&squot;
op_logical_or
id|nv-&gt;id3
op_ne
l_char|&squot; &squot;
op_logical_or
id|nv-&gt;version
OL
l_int|1
)paren
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;Invalid nvram ID or version!&bslash;n&quot;
)paren
suffix:semicolon
id|chksum
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
suffix:semicolon
id|cnt
OL
r_sizeof
(paren
r_struct
id|nvram
)paren
suffix:semicolon
id|cnt
op_increment
)paren
(brace
op_star
id|wptr
op_assign
id|qla1280_get_nvram_word
c_func
(paren
id|ha
comma
id|cnt
)paren
suffix:semicolon
id|chksum
op_add_assign
op_star
id|wptr
op_amp
l_int|0xff
suffix:semicolon
id|chksum
op_add_assign
(paren
op_star
id|wptr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|wptr
op_increment
suffix:semicolon
)brace
)brace
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_read_nvram: NVRAM Magic ID= %c %c %c %02x&quot;
l_string|&quot; version %i&bslash;n&quot;
comma
id|nv-&gt;id0
comma
id|nv-&gt;id1
comma
id|nv-&gt;id2
comma
id|nv-&gt;id3
comma
id|nv-&gt;version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chksum
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|driver_setup.no_nvram
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(%ld): Unable to identify or &quot;
l_string|&quot;validate NVRAM checksum, using default &quot;
l_string|&quot;settings&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|ha-&gt;nvram_valid
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|ha-&gt;nvram_valid
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* The firmware interface is, um, interesting, in that the&n;&t; * actual firmware image on the chip is little endian, thus,&n;&t; * the process of taking that image to the CPU would end up&n;&t; * little endian.  However, the firmare interface requires it&n;&t; * to be read a word (two bytes) at a time.&n;&t; *&n;&t; * The net result of this would be that the word (and&n;&t; * doubleword) quantites in the firmware would be correct, but&n;&t; * the bytes would be pairwise reversed.  Since most of the&n;&t; * firmware quantites are, in fact, bytes, we do an extra&n;&t; * le16_to_cpu() in the firmware read routine.&n;&t; *&n;&t; * The upshot of all this is that the bytes in the firmware&n;&t; * are in the correct places, but the 16 and 32 bit quantites&n;&t; * are still in little endian format.  We fix that up below by&n;&t; * doing extra reverses on them */
id|nv-&gt;isp_parameter
op_assign
id|cpu_to_le16
c_func
(paren
id|nv-&gt;isp_parameter
)paren
suffix:semicolon
id|nv-&gt;firmware_feature.w
op_assign
id|cpu_to_le16
c_func
(paren
id|nv-&gt;firmware_feature.w
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_BUSES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|nv-&gt;bus
(braket
id|i
)braket
dot
id|selection_timeout
op_assign
id|cpu_to_le16
c_func
(paren
id|nv-&gt;bus
(braket
id|i
)braket
dot
id|selection_timeout
)paren
suffix:semicolon
id|nv-&gt;bus
(braket
id|i
)braket
dot
id|max_queue_depth
op_assign
id|cpu_to_le16
c_func
(paren
id|nv-&gt;bus
(braket
id|i
)braket
dot
id|max_queue_depth
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_read_nvram: Completed Reading NVRAM&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_read_nvram&quot;
)paren
suffix:semicolon
r_return
id|chksum
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_info&n; *     Return a string describing the driver.&n; **************************************************************************/
r_static
r_const
r_char
op_star
DECL|function|qla1280_info
id|qla1280_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_static
r_char
id|qla1280_scsi_name_buffer
(braket
l_int|125
)braket
suffix:semicolon
r_char
op_star
id|bp
suffix:semicolon
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_struct
id|qla_boards
op_star
id|bdp
suffix:semicolon
id|bp
op_assign
op_amp
id|qla1280_scsi_name_buffer
(braket
l_int|0
)braket
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|bdp
op_assign
op_amp
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
suffix:semicolon
id|memset
c_func
(paren
id|bp
comma
l_int|0
comma
r_sizeof
(paren
id|qla1280_scsi_name_buffer
)paren
)paren
suffix:semicolon
id|sprintf
(paren
id|bp
comma
l_string|&quot;QLogic %s PCI to SCSI Host Adapter&bslash;n&quot;
l_string|&quot;       Firmware version: %2d.%02d.%02d, Driver version %s&quot;
comma
op_amp
id|bdp-&gt;name
(braket
l_int|0
)braket
comma
id|bdp-&gt;fwver
(braket
l_int|0
)braket
comma
id|bdp-&gt;fwver
(braket
l_int|1
)braket
comma
id|bdp-&gt;fwver
(braket
l_int|2
)braket
comma
id|QLA1280_VERSION
)paren
suffix:semicolon
r_return
id|bp
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1200_queuecommand&n; *     Queue a command to the controller.&n; *&n; * Note:&n; * The mid-level driver tries to ensures that queuecommand never gets invoked&n; * concurrently with itself or the interrupt handler (although the&n; * interrupt handler may call this routine as part of request-completion&n; * handling).   Unfortunely, it sometimes calls the scheduler in interrupt&n; * context which is a big NO! NO!.&n; **************************************************************************/
r_static
r_int
DECL|function|qla1280_queuecommand
id|qla1280_queuecommand
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|fn
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|cmd-&gt;device-&gt;host
suffix:semicolon
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|srb
op_star
id|sp
op_assign
(paren
r_struct
id|srb
op_star
)paren
op_amp
id|cmd-&gt;SCp
suffix:semicolon
r_int
id|status
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|fn
suffix:semicolon
id|sp-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|sp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|qla1280_print_scsi_cmd
c_func
(paren
l_int|5
comma
id|cmd
)paren
suffix:semicolon
macro_line|#ifdef QLA_64BIT_PTR
multiline_comment|/*&n;&t; * Using 64 bit commands if the PCI bridge doesn&squot;t support it is a&n;&t; * bit wasteful, however this should really only happen if one&squot;s&n;&t; * PCI controller is completely broken, like the BCM1250. For&n;&t; * sane hardware this is not an issue.&n;&t; */
id|status
op_assign
id|qla1280_64bit_start_scsi
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
macro_line|#else
id|status
op_assign
id|qla1280_32bit_start_scsi
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
macro_line|#endif
r_return
id|status
suffix:semicolon
)brace
DECL|enum|action
r_enum
id|action
(brace
DECL|enumerator|ABORT_COMMAND
id|ABORT_COMMAND
comma
DECL|enumerator|ABORT_DEVICE
id|ABORT_DEVICE
comma
DECL|enumerator|DEVICE_RESET
id|DEVICE_RESET
comma
DECL|enumerator|BUS_RESET
id|BUS_RESET
comma
DECL|enumerator|ADAPTER_RESET
id|ADAPTER_RESET
comma
DECL|enumerator|FAIL
id|FAIL
)brace
suffix:semicolon
multiline_comment|/* timer action for error action processor */
DECL|function|qla1280_error_wait_timeout
r_static
r_void
id|qla1280_error_wait_timeout
c_func
(paren
r_int
r_int
id|__data
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|cmd
op_assign
(paren
r_struct
id|scsi_cmnd
op_star
)paren
id|__data
suffix:semicolon
r_struct
id|srb
op_star
id|sp
op_assign
(paren
r_struct
id|srb
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|complete
c_func
(paren
id|sp-&gt;wait
)paren
suffix:semicolon
)brace
DECL|function|qla1280_mailbox_timeout
r_static
r_void
id|qla1280_mailbox_timeout
c_func
(paren
r_int
r_int
id|__data
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|__data
suffix:semicolon
r_struct
id|device_reg
op_star
id|reg
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi(%ld): mailbox timed out, mailbox0 %04x, &quot;
l_string|&quot;ictrl %04x, istatus %04x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
)paren
suffix:semicolon
id|complete
c_func
(paren
id|ha-&gt;mailbox_wait
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * qla1200_error_action&n; *    The function will attempt to perform a specified error action and&n; *    wait for the results (or time out).&n; *&n; * Input:&n; *      cmd = Linux SCSI command packet of the command that cause the&n; *            bus reset.&n; *      action = error action to take (see action_t)&n; *&n; * Returns:&n; *      SUCCESS or FAILED&n; *&n; * Note:&n; *      Resetting the bus always succeeds - is has to, otherwise the&n; *      kernel will panic! Try a surgical technique - sending a BUS&n; *      DEVICE RESET message - on the offending target before pulling&n; *      the SCSI bus reset line.&n; **************************************************************************/
r_static
r_int
DECL|function|qla1280_error_action
id|qla1280_error_action
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_enum
id|action
id|action
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
r_struct
id|srb
op_star
id|sp
suffix:semicolon
r_uint16
id|data
suffix:semicolon
r_int
r_char
op_star
id|handle
suffix:semicolon
r_int
id|result
comma
id|i
suffix:semicolon
id|DECLARE_COMPLETION
c_func
(paren
id|wait
)paren
suffix:semicolon
r_struct
id|timer_list
id|timer
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
(paren
id|CMD_HOST
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|hostdata
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|4
comma
l_string|&quot;error_action %i, istatus 0x%04x&bslash;n&quot;
comma
id|action
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;istatus
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|4
comma
l_string|&quot;host_cmd 0x%04x, ictrl 0x%04x, jiffies %li&bslash;n&quot;
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;host_cmd
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;ictrl
)paren
comma
id|jiffies
)paren
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_error_action&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%li): Resetting Cmnd=0x%p, &quot;
l_string|&quot;Handle=0x%p, action=0x%x&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|cmd
comma
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
comma
id|action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(scsi?:?:?:?) Reset called with NULL &quot;
l_string|&quot;si_Cmnd pointer, failing.&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_error_action&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|sp
op_assign
(paren
r_struct
id|srb
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|handle
op_assign
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Check for pending interrupts. */
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;istatus
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The io_request_lock is held when the reset handler is called, hence&n;&t; * the interrupt handler cannot be running in parallel as it also&n;&t; * grabs the lock. /Jes&n;&t; */
r_if
c_cond
(paren
id|data
op_amp
id|RISC_INT
)paren
id|qla1280_isr
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;done_q
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Determine the suggested action that the mid-level driver wants&n;&t; * us to perform.&n;&t; */
r_if
c_cond
(paren
id|handle
op_eq
(paren
r_int
r_char
op_star
)paren
id|INVALID_HANDLE
op_logical_or
id|handle
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|action
op_eq
id|ABORT_COMMAND
)paren
(brace
multiline_comment|/* we never got this command */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Aborting a NULL handle&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
multiline_comment|/* no action - we don&squot;t have command */
)brace
)brace
r_else
(brace
id|sp-&gt;wait
op_assign
op_amp
id|wait
suffix:semicolon
)brace
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Overloading result.  Here it means the success or fail of the&n;&t; * *issue* of the action.  When we return from the routine, it must&n;&t; * mean the actual success or fail of the action */
id|result
op_assign
id|FAILED
suffix:semicolon
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|FAIL
suffix:colon
r_break
suffix:semicolon
r_case
id|ABORT_COMMAND
suffix:colon
r_if
c_cond
(paren
(paren
id|sp-&gt;flags
op_amp
id|SRB_ABORT_PENDING
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(): Command has a pending abort &quot;
l_string|&quot;message - ABORT_PENDING.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* This should technically be impossible since we&n;&t;&t;&t; * now wait for abort completion */
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sp
op_eq
id|ha-&gt;outstanding_cmds
(braket
id|i
)braket
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280: RISC aborting command&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_abort_command
c_func
(paren
id|ha
comma
id|sp
comma
id|i
)paren
op_eq
l_int|0
)paren
id|result
op_assign
id|SUCCESS
suffix:semicolon
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Since we don&squot;t know what might&n;&t;&t;&t;&t;&t; * have happend to the command, it&n;&t;&t;&t;&t;&t; * is unsafe to remove it from the&n;&t;&t;&t;&t;&t; * device&squot;s queue at this point.&n;&t;&t;&t;&t;&t; * Wait and let the escalation&n;&t;&t;&t;&t;&t; * process take care of it.&n;&t;&t;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(%li:%i:%i:%i): Unable&quot;
l_string|&quot; to abort command!&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
)brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|ABORT_DEVICE
suffix:colon
id|ha-&gt;flags.in_reset
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld:%d:%d:%d): Queueing abort device &quot;
l_string|&quot;command.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_abort_device
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
op_eq
l_int|0
)paren
id|result
op_assign
id|SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEVICE_RESET
suffix:colon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld:%d:%d:%d): Queueing device reset &quot;
l_string|&quot;command.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
id|ha-&gt;flags.in_reset
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_device_reset
c_func
(paren
id|ha
comma
id|bus
comma
id|target
)paren
op_eq
l_int|0
)paren
id|result
op_assign
id|SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_RESET
suffix:colon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280(%ld:%d): Issuing BUS &quot;
l_string|&quot;DEVICE RESET&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
)paren
suffix:semicolon
id|ha-&gt;flags.in_reset
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|bus
op_eq
l_int|0
)paren
)paren
id|result
op_assign
id|SUCCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ADAPTER_RESET
suffix:colon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|qla1280_verbose
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): Issued ADAPTER RESET&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): I/O processing will &quot;
l_string|&quot;continue automatically&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)brace
id|ha-&gt;flags.reset_active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We restarted all of the commands automatically, so the&n;&t;&t; * mid-level code can expect completions momentitarily.&n;&t;&t; */
r_if
c_cond
(paren
id|qla1280_abort_isp
c_func
(paren
id|ha
)paren
op_eq
l_int|0
)paren
id|result
op_assign
id|SUCCESS
suffix:semicolon
id|ha-&gt;flags.reset_active
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ha-&gt;done_q
)paren
)paren
id|qla1280_done
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ha-&gt;flags.in_reset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If we didn&squot;t manage to issue the action, or we have no&n;&t; * command to wait for, exit here */
r_if
c_cond
(paren
id|result
op_eq
id|FAILED
op_logical_or
id|handle
op_eq
l_int|NULL
op_logical_or
id|handle
op_eq
(paren
r_int
r_char
op_star
)paren
id|INVALID_HANDLE
)paren
(brace
multiline_comment|/*&n;&t;&t; * Clear completion queue to avoid qla1280_done() trying&n;&t;&t; * to complete the command at a later stage after we&n;&t;&t; * have exited the current context&n;&t;&t; */
id|sp-&gt;wait
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|leave
suffix:semicolon
)brace
multiline_comment|/* set up a timer just in case we&squot;re really jammed */
id|init_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|timer.expires
op_assign
id|jiffies
op_plus
l_int|4
op_star
id|HZ
suffix:semicolon
id|timer.data
op_assign
(paren
r_int
r_int
)paren
id|cmd
suffix:semicolon
id|timer.function
op_assign
id|qla1280_error_wait_timeout
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
multiline_comment|/* wait for the action to complete (or the timer to expire) */
id|spin_unlock_irq
c_func
(paren
id|HOST_LOCK
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|wait
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|HOST_LOCK
)paren
suffix:semicolon
id|sp-&gt;wait
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* the only action we might get a fail for is abort */
r_if
c_cond
(paren
id|action
op_eq
id|ABORT_COMMAND
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_ABORTED
)paren
(brace
id|result
op_assign
id|SUCCESS
suffix:semicolon
)brace
r_else
id|result
op_assign
id|FAILED
suffix:semicolon
)brace
id|leave
suffix:colon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;RESET returning %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_error_action&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_abort&n; *     Abort the specified SCSI command(s).&n; **************************************************************************/
r_static
r_int
DECL|function|qla1280_eh_abort
id|qla1280_eh_abort
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_return
id|qla1280_error_action
c_func
(paren
id|cmd
comma
id|ABORT_COMMAND
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_device_reset&n; *     Reset the specified SCSI device&n; **************************************************************************/
r_static
r_int
DECL|function|qla1280_eh_device_reset
id|qla1280_eh_device_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_return
id|qla1280_error_action
c_func
(paren
id|cmd
comma
id|DEVICE_RESET
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_bus_reset&n; *     Reset the specified bus.&n; **************************************************************************/
r_static
r_int
DECL|function|qla1280_eh_bus_reset
id|qla1280_eh_bus_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_return
id|qla1280_error_action
c_func
(paren
id|cmd
comma
id|BUS_RESET
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_adapter_reset&n; *     Reset the specified adapter (both channels)&n; **************************************************************************/
r_static
r_int
DECL|function|qla1280_eh_adapter_reset
id|qla1280_eh_adapter_reset
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_return
id|qla1280_error_action
c_func
(paren
id|cmd
comma
id|ADAPTER_RESET
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|qla1280_biosparam
id|qla1280_biosparam
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
comma
r_struct
id|block_device
op_star
id|bdev
comma
id|sector_t
id|capacity
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
(paren
r_int
r_int
)paren
id|capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cylinders
OG
l_int|1024
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
(paren
r_int
r_int
)paren
id|capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
multiline_comment|/* if (cylinders &gt; 1023)&n;&t;&t;   cylinders = 1023; */
)brace
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; 0x020600
r_static
r_int
DECL|function|qla1280_detect
id|qla1280_detect
c_func
(paren
id|Scsi_Host_Template
op_star
r_template
)paren
(brace
r_struct
id|pci_device_id
op_star
id|id
op_assign
op_amp
id|qla1280_pci_tbl
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|num_hosts
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|srb
)paren
OG
r_sizeof
(paren
id|Scsi_Pointer
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: struct srb too big, aborting&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|DMA_BIDIRECTIONAL
op_ne
id|PCI_DMA_BIDIRECTIONAL
)paren
op_logical_or
(paren
id|DMA_TO_DEVICE
op_ne
id|PCI_DMA_TODEVICE
)paren
op_logical_or
(paren
id|DMA_FROM_DEVICE
op_ne
id|PCI_DMA_FROMDEVICE
)paren
op_logical_or
(paren
id|DMA_NONE
op_ne
id|PCI_DMA_NONE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: dma direction bits don&squot;t match&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/*&n;&t; * If we are called as a module, the qla1280 pointer may not be null&n;&t; * and it would point to our bootup string, just like on the lilo&n;&t; * command line.  IF not NULL, then process this config string with&n;&t; * qla1280_setup&n;&t; *&n;&t; * Boot time Options&n;&t; * To add options at boot time add a line to your lilo.conf file like:&n;&t; * append=&quot;qla1280=verbose,max_tags:{{255,255,255,255},{255,255,255,255}}&quot;&n;&t; * which will result in the first four devices on the first two&n;&t; * controllers being set to a tagged queue depth of 32.&n;&t; */
r_if
c_cond
(paren
id|qla1280
)paren
id|qla1280_setup
c_func
(paren
id|qla1280
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* First Initialize QLA12160 on PCI Bus 1 Dev 2 */
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|id-&gt;vendor
comma
id|id-&gt;device
comma
id|pdev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;bus-&gt;number
op_eq
l_int|1
op_logical_and
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|qla1280_probe_one
c_func
(paren
id|pdev
comma
id|id
)paren
)paren
id|num_hosts
op_increment
suffix:semicolon
)brace
)brace
id|pdev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Try and find each different type of adapter we support */
r_for
c_loop
(paren
id|id
op_assign
op_amp
id|qla1280_pci_tbl
(braket
l_int|0
)braket
suffix:semicolon
id|id-&gt;device
suffix:semicolon
id|id
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|id-&gt;vendor
comma
id|id-&gt;device
comma
id|pdev
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * skip QLA12160 already initialized on&n;&t;&t;&t; * PCI Bus 1 Dev 2 since we already initialized&n;&t;&t;&t; * and presented it&n;&t;&t;&t; */
r_if
c_cond
(paren
id|id-&gt;device
op_eq
id|PCI_DEVICE_ID_QLOGIC_ISP12160
op_logical_and
id|pdev-&gt;bus-&gt;number
op_eq
l_int|1
op_logical_and
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
op_eq
l_int|2
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qla1280_probe_one
c_func
(paren
id|pdev
comma
id|id
)paren
)paren
id|num_hosts
op_increment
suffix:semicolon
)brace
)brace
r_return
id|num_hosts
suffix:semicolon
)brace
multiline_comment|/*&n; * This looks a bit ugly as we could just pass down host to&n; * qla1280_remove_one, but I want to keep qla1280_release purely a wrapper&n; * around pci_driver::remove as used from 2.6 onwards.&n; */
r_static
r_int
DECL|function|qla1280_release
id|qla1280_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|qla1280_remove_one
c_func
(paren
id|ha-&gt;pdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|qla1280_biosparam_old
id|qla1280_biosparam_old
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_return
id|qla1280_biosparam
c_func
(paren
id|disk-&gt;device
comma
l_int|NULL
comma
id|disk-&gt;capacity
comma
id|geom
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|qla1280_proc_info_old
id|qla1280_proc_info_old
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|inout
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_for
c_loop
(paren
id|host
op_assign
id|scsi_hostlist
suffix:semicolon
id|host
suffix:semicolon
id|host
op_assign
id|host-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;host_no
op_eq
id|hostno
)paren
(brace
r_return
id|qla1280_proc_info
c_func
(paren
id|host
comma
id|buffer
comma
id|start
comma
id|offset
comma
id|length
comma
id|inout
)paren
suffix:semicolon
)brace
)brace
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/**************************************************************************&n; * qla1280_intr_handler&n; *   Handles the H/W interrupt&n; **************************************************************************/
r_static
id|irqreturn_t
DECL|function|qla1280_intr_handler
id|qla1280_intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_struct
id|device_reg
op_star
id|reg
suffix:semicolon
id|u16
id|data
suffix:semicolon
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
id|ENTER_INTR
(paren
l_string|&quot;qla1280_intr_handler&quot;
)paren
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|dev_id
suffix:semicolon
id|spin_lock
c_func
(paren
id|HOST_LOCK
)paren
suffix:semicolon
id|ha-&gt;isr_count
op_increment
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable our interrupt. */
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
multiline_comment|/* Check for pending interrupts. */
r_if
c_cond
(paren
id|data
op_amp
id|RISC_INT
)paren
(brace
id|qla1280_isr
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;done_q
)paren
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ha-&gt;done_q
)paren
)paren
id|qla1280_done
c_func
(paren
id|ha
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
id|HOST_LOCK
)paren
suffix:semicolon
multiline_comment|/* enable our interrupt. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
(paren
id|ISP_EN_INT
op_or
id|ISP_EN_RISC
)paren
)paren
suffix:semicolon
id|LEAVE_INTR
c_func
(paren
l_string|&quot;qla1280_intr_handler&quot;
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|qla1280_set_target_parameters
id|qla1280_set_target_parameters
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
comma
r_int
id|target
)paren
(brace
r_uint8
id|mr
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_struct
id|nvram
op_star
id|nv
suffix:semicolon
r_int
id|status
suffix:semicolon
id|nv
op_assign
op_amp
id|ha-&gt;nvram
suffix:semicolon
id|mr
op_assign
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
suffix:semicolon
multiline_comment|/* Set Target Parameters. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_TARGET_PARAMETERS
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|bus
ques
c_cond
id|target
op_or
id|BIT_7
suffix:colon
id|target
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_lshift_assign
l_int|8
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.c
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ISP1x160
c_func
(paren
id|ha
)paren
)paren
(brace
id|mb
(braket
l_int|2
)braket
op_or_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160.flags.enable_ppr
op_lshift
l_int|5
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.flags1x160.sync_offset
op_lshift
l_int|8
)paren
op_or
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|sync_period
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160.flags.ppr_options
op_lshift
l_int|8
)paren
op_or
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160.flags.ppr_bus_width
suffix:semicolon
id|mr
op_or_assign
id|BIT_6
suffix:semicolon
)brace
r_else
(brace
id|mb
(braket
l_int|3
)braket
op_assign
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.flags1x80.sync_offset
op_lshift
l_int|8
)paren
op_or
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|sync_period
suffix:semicolon
)brace
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|mr
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(%ld:%i:%i): &quot;
l_string|&quot;qla1280_set_target_parameters() failed&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_slave_configure&n; *&n; * Description:&n; *   Determines the queue depth for a given device.  There are two ways&n; *   a queue depth can be obtained for a tagged queueing device.  One&n; *   way is the default queue depth which is determined by whether&n; *   If it is defined, then it is used&n; *   as the default queue depth.  Otherwise, we use either 4 or 8 as the&n; *   default queue depth (dependent on the number of hardware SCBs).&n; **************************************************************************/
r_static
r_int
DECL|function|qla1280_slave_configure
id|qla1280_slave_configure
c_func
(paren
r_struct
id|scsi_device
op_star
id|device
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_int
id|default_depth
op_assign
l_int|3
suffix:semicolon
r_int
id|bus
op_assign
id|device-&gt;channel
suffix:semicolon
r_int
id|target
op_assign
id|device-&gt;id
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_struct
id|nvram
op_star
id|nv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|device-&gt;host-&gt;hostdata
suffix:semicolon
id|nv
op_assign
op_amp
id|ha-&gt;nvram
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_check_for_dead_scsi_bus
c_func
(paren
id|ha
comma
id|bus
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tagged_supported
op_logical_and
(paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|qtag_enables
op_amp
(paren
id|BIT_0
op_lshift
id|target
)paren
)paren
)paren
(brace
id|scsi_adjust_queue_depth
c_func
(paren
id|device
comma
id|MSG_ORDERED_TAG
comma
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|hiwat
)paren
suffix:semicolon
)brace
r_else
(brace
id|scsi_adjust_queue_depth
c_func
(paren
id|device
comma
l_int|0
comma
id|default_depth
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt; 0x020500
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_sync
op_assign
id|device-&gt;sdtr
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_wide
op_assign
id|device-&gt;wdtr
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160.flags.enable_ppr
op_assign
id|device-&gt;ppr
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|driver_setup.no_sync
op_logical_or
(paren
id|driver_setup.sync_mask
op_logical_and
(paren
op_complement
id|driver_setup.sync_mask
op_amp
(paren
l_int|1
op_lshift
id|target
)paren
)paren
)paren
)paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_sync
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|driver_setup.no_wide
op_logical_or
(paren
id|driver_setup.wide_mask
op_logical_and
(paren
op_complement
id|driver_setup.wide_mask
op_amp
(paren
l_int|1
op_lshift
id|target
)paren
)paren
)paren
)paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_wide
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|IS_ISP1x160
c_func
(paren
id|ha
)paren
)paren
(brace
r_if
c_cond
(paren
id|driver_setup.no_ppr
op_logical_or
(paren
id|driver_setup.ppr_mask
op_logical_and
(paren
op_complement
id|driver_setup.ppr_mask
op_amp
(paren
l_int|1
op_lshift
id|target
)paren
)paren
)paren
)paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160.flags.enable_ppr
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
id|HOST_LOCK
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_sync
)paren
id|status
op_assign
id|qla1280_set_target_parameters
c_func
(paren
id|ha
comma
id|bus
comma
id|target
)paren
suffix:semicolon
id|qla1280_get_target_parameters
c_func
(paren
id|ha
comma
id|device
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|HOST_LOCK
comma
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; 0x020545
multiline_comment|/**************************************************************************&n; *   qla1280_select_queue_depth&n; *&n; *   Sets the queue depth for each SCSI device hanging off the input&n; *   host adapter.  We use a queue depth of 2 for devices that do not&n; *   support tagged queueing.&n; **************************************************************************/
r_static
r_void
DECL|function|qla1280_select_queue_depth
id|qla1280_select_queue_depth
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
r_struct
id|scsi_device
op_star
id|sdev_q
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|scsi_device
op_star
id|sdev
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_select_queue_depth&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sdev
op_assign
id|sdev_q
suffix:semicolon
id|sdev
suffix:semicolon
id|sdev
op_assign
id|sdev-&gt;next
)paren
r_if
c_cond
(paren
id|sdev-&gt;host
op_eq
id|host
)paren
id|qla1280_slave_configure
c_func
(paren
id|sdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdev_q
)paren
id|qla1280_check_for_dead_scsi_bus
c_func
(paren
id|ha
comma
id|sdev_q-&gt;channel
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_select_queue_depth&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * qla1280_done&n; *      Process completed commands.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      done_q       = done queue.&n; */
r_static
r_void
DECL|function|qla1280_done
id|qla1280_done
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|srb
op_star
id|sp
suffix:semicolon
r_struct
id|list_head
op_star
id|done_q
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmd
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_done&quot;
)paren
suffix:semicolon
id|done_q
op_assign
op_amp
id|ha-&gt;done_q
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
id|done_q
)paren
)paren
(brace
id|sp
op_assign
id|list_entry
c_func
(paren
id|done_q-&gt;next
comma
r_struct
id|srb
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|sp-&gt;list
)paren
suffix:semicolon
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_rshift
l_int|16
)paren
)paren
(brace
r_case
id|DID_RESET
suffix:colon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
l_int|0
comma
id|MK_SYNC_ID
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DID_ABORT
suffix:colon
id|sp-&gt;flags
op_and_assign
op_complement
id|SRB_ABORT_PENDING
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_ABORTED
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_TIMEOUT
)paren
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* Release memory used for this I/O */
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;S/G unmap_sg cmd=%p&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|pci_unmap_sg
c_func
(paren
id|ha-&gt;pdev
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;use_sg
comma
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
)paren
(brace
multiline_comment|/*dprintk(1, &quot;No S/G unmap_single cmd=%x saved_dma_handle=%lx&bslash;n&quot;,&n;&t;&t;&t;  cmd, sp-&gt;saved_dma_handle); */
id|pci_unmap_page
c_func
(paren
id|ha-&gt;pdev
comma
id|sp-&gt;saved_dma_handle
comma
id|cmd-&gt;request_bufflen
comma
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
multiline_comment|/* Call the mid-level driver interrupt handler */
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
id|INVALID_HANDLE
suffix:semicolon
id|ha-&gt;actthreads
op_decrement
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; 0x020500
r_if
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
id|qla1280_get_target_options
c_func
(paren
id|cmd
comma
id|ha
)paren
suffix:semicolon
macro_line|#endif
(paren
op_star
(paren
id|cmd
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;wait
op_ne
l_int|NULL
)paren
(brace
id|complete
c_func
(paren
id|sp-&gt;wait
)paren
suffix:semicolon
)brace
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_done&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Translates a ISP error to a Linux SCSI error&n; */
r_static
r_int
DECL|function|qla1280_return_status
id|qla1280_return_status
c_func
(paren
r_struct
id|response
op_star
id|sts
comma
r_struct
id|scsi_cmnd
op_star
id|cp
)paren
(brace
r_int
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_uint16
id|comp_status
op_assign
id|le16_to_cpu
c_func
(paren
id|sts-&gt;comp_status
)paren
suffix:semicolon
r_uint16
id|state_flags
op_assign
id|le16_to_cpu
c_func
(paren
id|sts-&gt;state_flags
)paren
suffix:semicolon
r_uint16
id|residual_length
op_assign
id|le16_to_cpu
c_func
(paren
id|sts-&gt;residual_length
)paren
suffix:semicolon
r_uint16
id|scsi_status
op_assign
id|le16_to_cpu
c_func
(paren
id|sts-&gt;scsi_status
)paren
suffix:semicolon
macro_line|#if DEBUG_QLA1280_INTR
r_static
r_char
op_star
id|reason
(braket
)braket
op_assign
(brace
l_string|&quot;DID_OK&quot;
comma
l_string|&quot;DID_NO_CONNECT&quot;
comma
l_string|&quot;DID_BUS_BUSY&quot;
comma
l_string|&quot;DID_TIME_OUT&quot;
comma
l_string|&quot;DID_BAD_TARGET&quot;
comma
l_string|&quot;DID_ABORT&quot;
comma
l_string|&quot;DID_PARITY&quot;
comma
l_string|&quot;DID_ERROR&quot;
comma
l_string|&quot;DID_RESET&quot;
comma
l_string|&quot;DID_BAD_INTR&quot;
)brace
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DEBUG_QLA1280_INTR */
id|ENTER
c_func
(paren
l_string|&quot;qla1280_return_status&quot;
)paren
suffix:semicolon
macro_line|#if DEBUG_QLA1280_INTR
multiline_comment|/*&n;&t;  dprintk(1, &quot;qla1280_return_status: compl status = 0x%04x&bslash;n&quot;,&n;&t;  comp_status);&n;&t;*/
macro_line|#endif
r_switch
c_cond
(paren
id|comp_status
)paren
(brace
r_case
id|CS_COMPLETE
suffix:colon
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_INCOMPLETE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state_flags
op_amp
id|SF_GOT_BUS
)paren
)paren
id|host_status
op_assign
id|DID_NO_CONNECT
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|state_flags
op_amp
id|SF_GOT_TARGET
)paren
)paren
id|host_status
op_assign
id|DID_BAD_TARGET
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|state_flags
op_amp
id|SF_SENT_CDB
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|state_flags
op_amp
id|SF_TRANSFERRED_DATA
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|state_flags
op_amp
id|SF_GOT_STATUS
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|state_flags
op_amp
id|SF_GOT_SENSE
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_RESET
suffix:colon
id|host_status
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_ABORTED
suffix:colon
id|host_status
op_assign
id|DID_ABORT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_TIMEOUT
suffix:colon
id|host_status
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_OVERRUN
suffix:colon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;Data overrun 0x%x&bslash;n&quot;
comma
id|residual_length
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: response packet data&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|2
comma
(paren
r_char
op_star
)paren
id|sts
comma
id|RESPONSE_ENTRY_SIZE
)paren
suffix:semicolon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_UNDERRUN
suffix:colon
r_if
c_cond
(paren
(paren
id|cp-&gt;request_bufflen
op_minus
id|residual_length
)paren
OL
id|cp-&gt;underflow
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi: Underflow detected - retrying &quot;
l_string|&quot;command.&bslash;n&quot;
)paren
suffix:semicolon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
)brace
r_else
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if DEBUG_QLA1280_INTR
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 ISP status: host status (%s) scsi status %x&bslash;n&quot;
comma
id|reason
(braket
id|host_status
)braket
comma
id|scsi_status
)paren
suffix:semicolon
macro_line|#endif
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_return_status&quot;
)paren
suffix:semicolon
r_return
(paren
id|scsi_status
op_amp
l_int|0xff
)paren
op_or
(paren
id|host_status
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                QLogic ISP1280 Hardware Support Functions.                */
multiline_comment|/****************************************************************************/
multiline_comment|/*&n;  * qla2100_enable_intrs&n;  * qla2100_disable_intrs&n;  *&n;  * Input:&n;  *      ha = adapter block pointer.&n;  *&n;  * Returns:&n;  *      None&n;  */
r_static
r_inline
r_void
DECL|function|qla1280_enable_intrs
id|qla1280_enable_intrs
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* enable risc and host interrupts */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
(paren
id|ISP_EN_INT
op_or
id|ISP_EN_RISC
)paren
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
)paren
suffix:semicolon
multiline_comment|/* PCI Posted Write flush */
id|ha-&gt;flags.ints_enabled
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|qla1280_disable_intrs
id|qla1280_disable_intrs
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* disable risc and host interrupts */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
)paren
suffix:semicolon
multiline_comment|/* PCI Posted Write flush */
id|ha-&gt;flags.ints_enabled
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_initialize_adapter&n; *      Initialize board.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
id|__devinit
DECL|function|qla1280_initialize_adapter
id|qla1280_initialize_adapter
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|bus
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; 0x020500
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif
id|ENTER
c_func
(paren
l_string|&quot;qla1280_initialize_adapter&quot;
)paren
suffix:semicolon
multiline_comment|/* Clear adapter flags. */
id|ha-&gt;flags.online
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;flags.disable_host_adapter
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;flags.reset_active
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;flags.abort_isp_active
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;flags.ints_enabled
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(CONFIG_IA64_GENERIC) || defined(CONFIG_IA64_SGI_SN2)
r_if
c_cond
(paren
id|ia64_platform_is
c_func
(paren
l_string|&quot;sn2&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%li): Enabling SN2 PCI DMA &quot;
l_string|&quot;dual channel lockup workaround&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|ha-&gt;flags.use_pci_vchannel
op_assign
l_int|1
suffix:semicolon
id|driver_setup.no_nvram
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* TODO: implement support for the 1040 nvram format */
r_if
c_cond
(paren
id|IS_ISP1040
c_func
(paren
id|ha
)paren
)paren
id|driver_setup.no_nvram
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;Configure PCI space for adapter...&bslash;n&quot;
)paren
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* Insure mailbox registers are free. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
comma
l_int|0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_RISC_INT
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_HOST_INT
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_read_nvram
c_func
(paren
id|ha
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_initialize_adapter: failed to read &quot;
l_string|&quot;NVRAM&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= 0x020500
multiline_comment|/*&n;&t; * It&squot;s necessary to grab the spin here as qla1280_mailbox_command&n;&t; * needs to be able to drop the lock unconditionally to wait&n;&t; * for completion.&n;&t; * In 2.4 -&gt;detect is called with the io_request_lock held.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
id|HOST_LOCK
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|status
op_assign
id|qla1280_load_firmware
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi(%li): initialize: pci probe failed!&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Setup adapter based on NVRAM parameters. */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;scsi(%ld): Configure NVRAM parameters&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|qla1280_nvram_config
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.disable_host_adapter
)paren
(brace
id|status
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|status
op_assign
id|qla1280_init_rings
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Issue SCSI reset, if we can&squot;t reset twice then bus is dead */
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|disable_scsi_reset
op_logical_and
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|bus
)paren
op_logical_and
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|bus
)paren
)paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
op_assign
l_int|1
suffix:semicolon
)brace
id|ha-&gt;flags.online
op_assign
l_int|1
suffix:semicolon
id|out
suffix:colon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x020500
id|spin_unlock_irqrestore
c_func
(paren
id|HOST_LOCK
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_initialize_adapter: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_initialize_adapter&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * ISP Firmware Test&n; *      Checks if present version of RISC firmware is older than&n; *      driver firmware.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = firmware does not need to be loaded.&n; */
r_static
r_int
DECL|function|qla1280_isp_firmware
id|qla1280_isp_firmware
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|nvram
op_star
id|nv
op_assign
(paren
r_struct
id|nvram
op_star
)paren
id|ha-&gt;response_ring
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* dg 2/27 always loads RISC */
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_isp_firmware&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;scsi(%li): Determining if RISC is loaded&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
multiline_comment|/* Bad NVRAM data, load RISC code. */
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;nvram_valid
)paren
(brace
id|ha-&gt;flags.disable_risc_code_load
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|ha-&gt;flags.disable_risc_code_load
op_assign
id|nv-&gt;cntr_flags_1.disable_loading_risc_code
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.disable_risc_code_load
)paren
(brace
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_isp_firmware: Telling RISC to verify &quot;
l_string|&quot;checksum of loaded BIOS code.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Verify checksum of loaded RISC code. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_VERIFY_CHECKSUM
suffix:semicolon
multiline_comment|/* mb[1] = ql12_risc_code_addr01; */
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
multiline_comment|/* Start firmware execution. */
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_isp_firmware: Startng F/W &quot;
l_string|&quot;execution.&bslash;n&quot;
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_EXECUTE_FIRMWARE
suffix:semicolon
multiline_comment|/* mb[1] = ql12_risc_code_addr01; */
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: RISC checksum failed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280: NVRAM configured to load RISC load.&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isp_firmware: **** Load RISC code ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_isp_firmware&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Chip diagnostics&n; *      Test chip for proper operation.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success.&n; */
r_static
r_int
DECL|function|qla1280_chip_diag
id|qla1280_chip_diag
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_uint16
id|data
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_chip_diag: testing device at 0x%p &bslash;n&quot;
comma
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;scsi(%ld): Verifying chip&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
multiline_comment|/* Soft reset chip and wait for it to finish. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
id|ISP_RESET
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We can&squot;t do a traditional PCI write flush here by reading&n;&t; * back the register. The card will not respond once the reset&n;&t; * is in action and we end up with a machine check exception&n;&t; * instead. Nothing to do but wait and hope for the best.&n;&t; * A portable pci_write_flush(pdev) call would be very useful here.&n;&t; */
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;ictrl
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Yet another QLogic gem ;-(&n;&t; */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1000000
suffix:semicolon
id|cnt
op_logical_and
id|data
op_amp
id|ISP_RESET
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cnt
)paren
r_goto
id|fail
suffix:semicolon
multiline_comment|/* Reset register cleared by chip reset. */
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_chip_diag: reset register cleared by chip reset&bslash;n&quot;
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset RISC and disable BIOS which&n;&t;   allows RISC to execute out of RAM. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RESET_RISC
op_or
id|HC_RELEASE_RISC
op_or
id|HC_DISABLE_BIOS
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
multiline_comment|/* Flush PCI write */
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;mailbox0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * I *LOVE* this code!&n;&t; */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1000000
suffix:semicolon
id|cnt
op_logical_and
id|data
op_eq
id|MBS_BUSY
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cnt
)paren
r_goto
id|fail
suffix:semicolon
multiline_comment|/* Check product ID of chip */
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_chip_diag: Checking product ID of chip&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox1
)paren
op_ne
id|PROD_ID_1
op_logical_or
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
op_ne
id|PROD_ID_2
op_logical_and
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
op_ne
id|PROD_ID_2a
)paren
op_logical_or
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox3
)paren
op_ne
id|PROD_ID_3
op_logical_or
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
op_ne
id|PROD_ID_4
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Wrong product ID = &quot;
l_string|&quot;0x%x,0x%x,0x%x,0x%x&bslash;n&quot;
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox1
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox3
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Enable ints early!!!&n;&t; */
id|qla1280_enable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_chip_diag: Checking mailboxes of chip&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Wrap Incoming Mailboxes Test. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_MAILBOX_REGISTER_TEST
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
l_int|0xAAAA
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
l_int|0x5555
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
l_int|0xAA55
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
l_int|0x55AA
suffix:semicolon
id|mb
(braket
l_int|5
)braket
op_assign
l_int|0xA5A5
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
l_int|0x5A5A
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
l_int|0x2525
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
l_int|0xff
comma
id|mb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
l_int|1
)braket
op_ne
l_int|0xAAAA
op_logical_or
id|mb
(braket
l_int|2
)braket
op_ne
l_int|0x5555
op_logical_or
id|mb
(braket
l_int|3
)braket
op_ne
l_int|0xAA55
op_logical_or
id|mb
(braket
l_int|4
)braket
op_ne
l_int|0x55AA
op_logical_or
id|mb
(braket
l_int|5
)braket
op_ne
l_int|0xA5A5
op_logical_or
id|mb
(braket
l_int|6
)braket
op_ne
l_int|0x5A5A
op_logical_or
id|mb
(braket
l_int|7
)braket
op_ne
l_int|0x2525
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Failed mbox check&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_chip_diag: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_chip_diag: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_static
r_int
DECL|function|qla1280_load_firmware_pio
id|qla1280_load_firmware_pio
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_uint16
id|risc_address
comma
op_star
id|risc_code_address
comma
id|risc_code_size
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
comma
id|i
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Load RISC code. */
id|risc_address
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
id|risc_code_address
op_assign
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwcode
suffix:semicolon
id|risc_code_size
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwlen
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|risc_code_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_WRITE_RAM_WORD
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|risc_address
op_plus
id|i
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|risc_code_address
(braket
id|i
)braket
suffix:semicolon
id|err
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_0
op_or
id|BIT_1
op_or
id|BIT_2
comma
id|mb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi(%li): Failed to load firmware&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|DUMP_IT_BACK
mdefine_line|#define DUMP_IT_BACK 0&t;&t;/* for debug of RISC loading */
r_static
r_int
DECL|function|qla1280_load_firmware_dma
id|qla1280_load_firmware_dma
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_uint16
id|risc_address
comma
op_star
id|risc_code_address
comma
id|risc_code_size
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
comma
id|cnt
suffix:semicolon
r_int
id|err
op_assign
l_int|0
comma
id|num
comma
id|i
suffix:semicolon
macro_line|#if DUMP_IT_BACK
r_uint8
op_star
id|sp
comma
op_star
id|tbuf
suffix:semicolon
id|dma_addr_t
id|p_tbuf
suffix:semicolon
id|tbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ha-&gt;pdev
comma
l_int|8000
comma
op_amp
id|p_tbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tbuf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
macro_line|#endif
multiline_comment|/* Load RISC code. */
id|risc_address
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
id|risc_code_address
op_assign
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwcode
suffix:semicolon
id|risc_code_size
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwlen
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;%s: DMA RISC code (%i) words&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|risc_code_size
)paren
suffix:semicolon
id|num
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|risc_code_size
OG
l_int|0
)paren
(brace
r_int
id|warn
id|__attribute__
c_func
(paren
(paren
id|unused
)paren
)paren
op_assign
l_int|0
suffix:semicolon
id|cnt
op_assign
l_int|2000
op_rshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|risc_code_size
)paren
id|cnt
op_assign
id|risc_code_size
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_setup_chip:  loading risc @ =(0x%p),&quot;
l_string|&quot;%d,%d(0x%x)&bslash;n&quot;
comma
id|risc_code_address
comma
id|cnt
comma
id|num
comma
id|risc_address
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
(paren
(paren
r_uint16
op_star
)paren
id|ha-&gt;request_ring
)paren
(braket
id|i
)braket
op_assign
id|cpu_to_le16
c_func
(paren
id|risc_code_address
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_LOAD_RAM
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|risc_address
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
id|cnt
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|ha-&gt;request_dma
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
id|ha-&gt;request_dma
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;request_dma
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;request_dma
)paren
op_rshift
l_int|16
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;%s: op=%d  0x%p = 0x%4x,0x%4x,0x%4x,0x%4x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|mb
(braket
l_int|0
)braket
comma
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|ha-&gt;request_dma
comma
id|mb
(braket
l_int|6
)braket
comma
id|mb
(braket
l_int|7
)braket
comma
id|mb
(braket
l_int|2
)braket
comma
id|mb
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|err
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_4
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
id|mb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi(%li): Failed to load partial &quot;
l_string|&quot;segment of f&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
macro_line|#if DUMP_IT_BACK
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_DUMP_RAM
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|risc_address
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
id|cnt
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|p_tbuf
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
id|p_tbuf
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|p_tbuf
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|p_tbuf
)paren
op_rshift
l_int|16
suffix:semicolon
id|err
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_4
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
id|mb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to dump partial segment of f/w&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sp
op_assign
(paren
r_uint8
op_star
)paren
id|ha-&gt;request_ring
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|cnt
op_lshift
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tbuf
(braket
id|i
)braket
op_ne
id|sp
(braket
id|i
)braket
op_logical_and
id|warn
op_increment
OL
l_int|10
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: FW compare error @ &quot;
l_string|&quot;byte(0x%x) loop#=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|i
comma
id|num
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: FWbyte=%x  &quot;
l_string|&quot;FWfromChip=%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|sp
(braket
id|i
)braket
comma
id|tbuf
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/*break; */
)brace
)brace
macro_line|#endif
id|risc_address
op_add_assign
id|cnt
suffix:semicolon
id|risc_code_size
op_assign
id|risc_code_size
op_minus
id|cnt
suffix:semicolon
id|risc_code_address
op_assign
id|risc_code_address
op_plus
id|cnt
suffix:semicolon
id|num
op_increment
suffix:semicolon
)brace
id|out
suffix:colon
macro_line|#if DUMP_IT_BACK
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
l_int|8000
comma
id|tbuf
comma
id|p_tbuf
)paren
suffix:semicolon
macro_line|#endif
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|qla1280_start_firmware
id|qla1280_start_firmware
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
id|err
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;%s: Verifying checksum of loaded RISC code.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* Verify checksum of loaded RISC code. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_VERIFY_CHECKSUM
suffix:semicolon
multiline_comment|/* mb[1] = ql12_risc_code_addr01; */
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
id|err
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
id|mb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi(%li): Failed checksum&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Start firmware execution. */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;%s: start firmware running.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_EXECUTE_FIRMWARE
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
id|err
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi(%li): Failed to start firmware&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|qla1280_load_firmware
id|qla1280_load_firmware
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_int
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* If firmware needs to be loaded */
r_if
c_cond
(paren
op_logical_neg
id|qla1280_isp_firmware
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi(%li): isp_firmware() failed!&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|qla1280_chip_diag
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|IS_ISP1040
c_func
(paren
id|ha
)paren
)paren
id|err
op_assign
id|qla1280_load_firmware_pio
c_func
(paren
id|ha
)paren
suffix:semicolon
r_else
id|err
op_assign
id|qla1280_load_firmware_dma
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
id|qla1280_start_firmware
c_func
(paren
id|ha
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize rings&n; *&n; * Input:&n; *      ha                = adapter block pointer.&n; *      ha-&gt;request_ring  = request ring virtual address&n; *      ha-&gt;response_ring = response ring virtual address&n; *      ha-&gt;request_dma   = request ring physical address&n; *      ha-&gt;response_dma  = response ring physical address&n; *&n; * Returns:&n; *      0 = success.&n; */
r_static
r_int
DECL|function|qla1280_init_rings
id|qla1280_init_rings
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_init_rings&quot;
)paren
suffix:semicolon
multiline_comment|/* Clear outstanding commands array. */
id|memset
c_func
(paren
id|ha-&gt;outstanding_cmds
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|srb
op_star
)paren
op_star
id|MAX_OUTSTANDING_COMMANDS
)paren
suffix:semicolon
multiline_comment|/* Initialize request queue. */
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
suffix:semicolon
multiline_comment|/* mb[0] = MBC_INIT_REQUEST_QUEUE; */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_INIT_REQUEST_QUEUE_A64
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|REQUEST_ENTRY_CNT
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|ha-&gt;request_dma
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
id|ha-&gt;request_dma
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;request_dma
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;request_dma
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_4
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
multiline_comment|/* Initialize response queue. */
id|ha-&gt;response_ring_ptr
op_assign
id|ha-&gt;response_ring
suffix:semicolon
id|ha-&gt;rsp_ring_index
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* mb[0] = MBC_INIT_RESPONSE_QUEUE; */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_INIT_RESPONSE_QUEUE_A64
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|RESPONSE_ENTRY_CNT
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|ha-&gt;response_dma
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
id|ha-&gt;response_dma
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;response_dma
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;response_dma
)paren
op_rshift
l_int|16
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_5
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_init_rings: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_init_rings&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_static
r_void
DECL|function|qla1280_print_settings
id|qla1280_print_settings
c_func
(paren
r_struct
id|nvram
op_star
id|nv
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : initiator scsi id bus[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_1.initiator_id
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : initiator scsi id bus[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_1.initiator_id
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : bus reset delay[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|bus_reset_delay
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : bus reset delay[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|bus_reset_delay
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : retry count[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_count
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : retry delay[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_delay
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : retry count[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_count
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : retry delay[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_delay
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : async data setup time[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.async_data_setup_time
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : async data setup time[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.async_data_setup_time
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : req/ack active negation[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.req_ack_active_negation
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : req/ack active negation[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.req_ack_active_negation
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : data line active negation[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.data_line_active_negation
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : data line active negation[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.data_line_active_negation
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : disable loading risc code=%d&bslash;n&quot;
comma
id|nv-&gt;cntr_flags_1.disable_loading_risc_code
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : enable 64bit addressing=%d&bslash;n&quot;
comma
id|nv-&gt;cntr_flags_1.enable_64bit_addressing
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : selection timeout limit[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|selection_timeout
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : selection timeout limit[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|selection_timeout
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : max queue depth[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|max_queue_depth
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : max queue depth[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|max_queue_depth
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|qla1280_set_target_defaults
id|qla1280_set_target_defaults
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
comma
r_int
id|target
)paren
(brace
r_struct
id|nvram
op_star
id|nv
op_assign
op_amp
id|ha-&gt;nvram
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.renegotiate_on_error
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.auto_request_sense
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.tag_queuing
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_sync
op_assign
l_int|1
suffix:semicolon
macro_line|#if 1&t;/* Some SCSI Processors do not seem to like this */
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_wide
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.parity_checking
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.disconnect_allowed
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|execution_throttle
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|max_queue_depth
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|IS_ISP1x160
c_func
(paren
id|ha
)paren
)paren
(brace
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.flags1x160.device_enable
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.flags1x160.sync_offset
op_assign
l_int|0x0e
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|sync_period
op_assign
l_int|9
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160.flags.enable_ppr
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160.flags.ppr_options
op_assign
l_int|2
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160.flags.ppr_bus_width
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.flags1x80.device_enable
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.flags1x80.sync_offset
op_assign
l_int|12
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|sync_period
op_assign
l_int|10
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|qla1280_set_defaults
id|qla1280_set_defaults
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|nvram
op_star
id|nv
op_assign
op_amp
id|ha-&gt;nvram
suffix:semicolon
r_int
id|bus
comma
id|target
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;Using defaults for NVRAM: &bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|nv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|nvram
)paren
)paren
suffix:semicolon
multiline_comment|/* nv-&gt;cntr_flags_1.disable_loading_risc_code = 1; */
id|nv-&gt;firmware_feature.f.enable_fast_posting
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;firmware_feature.f.disable_synchronous_backoff
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;termination.f.scsi_bus_0_control
op_assign
l_int|3
suffix:semicolon
id|nv-&gt;termination.f.scsi_bus_1_control
op_assign
l_int|3
suffix:semicolon
id|nv-&gt;termination.f.auto_term_support
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Set default FIFO magic - What appropriate values would be here&n;&t; * is unknown. This is what I have found testing with 12160s.&n;&t; *&n;&t; * Now, I would love the magic decoder ring for this one, the&n;&t; * header file provided by QLogic seems to be bogus or incomplete&n;&t; * at best.&n;&t; */
id|nv-&gt;isp_config.c
op_assign
id|ISP_CFG1_BENAB
op_or
id|ISP_CFG1_F128
suffix:semicolon
r_if
c_cond
(paren
id|IS_ISP1x160
c_func
(paren
id|ha
)paren
)paren
id|nv-&gt;isp_parameter
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* fast memory enable */
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|MAX_BUSES
suffix:semicolon
id|bus
op_increment
)paren
(brace
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_1.initiator_id
op_assign
l_int|7
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_2.req_ack_active_negation
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_2.data_line_active_negation
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|selection_timeout
op_assign
l_int|250
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|max_queue_depth
op_assign
l_int|256
suffix:semicolon
r_if
c_cond
(paren
id|IS_ISP1040
c_func
(paren
id|ha
)paren
)paren
(brace
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|bus_reset_delay
op_assign
l_int|3
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_2.async_data_setup_time
op_assign
l_int|6
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|retry_delay
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|bus_reset_delay
op_assign
l_int|5
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_2.async_data_setup_time
op_assign
l_int|8
suffix:semicolon
)brace
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
id|MAX_TARGETS
suffix:semicolon
id|target
op_increment
)paren
id|qla1280_set_target_defaults
c_func
(paren
id|ha
comma
id|bus
comma
id|target
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|qla1280_config_target
id|qla1280_config_target
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
comma
r_int
id|target
)paren
(brace
r_struct
id|nvram
op_star
id|nv
op_assign
op_amp
id|ha-&gt;nvram
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
id|status
comma
id|lun
suffix:semicolon
multiline_comment|/* Set Target Parameters. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_TARGET_PARAMETERS
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|bus
ques
c_cond
id|target
op_or
id|BIT_7
suffix:colon
id|target
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_lshift_assign
l_int|8
suffix:semicolon
multiline_comment|/*&n;&t; * Do not enable wide, sync, and ppr for the initial&n;&t; * INQUIRY run. We enable this later if we determine&n;&t; * the target actually supports it.&n;&t; */
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f
dot
id|auto_request_sense
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f
dot
id|stop_queue_on_check
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|IS_ISP1x160
c_func
(paren
id|ha
)paren
)paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160
dot
id|flags.enable_ppr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * No sync, wide, etc. while probing&n;&t; */
id|mb
(braket
l_int|2
)braket
op_assign
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.c
op_lshift
l_int|8
)paren
op_amp
op_complement
(paren
id|TP_SYNC
multiline_comment|/*| TP_WIDE | TP_PPR*/
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ISP1x160
c_func
(paren
id|ha
)paren
)paren
id|mb
(braket
l_int|3
)braket
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.flags1x160.sync_offset
op_lshift
l_int|8
suffix:semicolon
r_else
id|mb
(braket
l_int|3
)braket
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.flags1x80.sync_offset
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_or_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|sync_period
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Save Tag queuing enable flag. */
id|mb
(braket
l_int|0
)braket
op_assign
id|BIT_0
op_lshift
id|target
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.tag_queuing
)paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|qtag_enables
op_or_assign
id|mb
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Save Device enable flag. */
r_if
c_cond
(paren
id|IS_ISP1x160
c_func
(paren
id|ha
)paren
)paren
(brace
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.flags1x160.device_enable
)paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|device_enables
op_or_assign
id|mb
(braket
l_int|0
)braket
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|lun_disables
op_or_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.flags1x80.device_enable
)paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|device_enables
op_or_assign
id|mb
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Save LUN disable flag. */
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.flags1x80.lun_disable
)paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|lun_disables
op_or_assign
id|mb
(braket
l_int|0
)braket
suffix:semicolon
)brace
multiline_comment|/* Set Device Queue Parameters. */
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
id|MAX_LUNS
suffix:semicolon
id|lun
op_increment
)paren
(brace
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_DEVICE_QUEUE
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|bus
ques
c_cond
id|target
op_or
id|BIT_7
suffix:colon
id|target
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|mb
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|lun
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|max_queue_depth
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|execution_throttle
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
l_int|0x0f
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
r_static
r_int
DECL|function|qla1280_config_bus
id|qla1280_config_bus
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
)paren
(brace
r_struct
id|nvram
op_star
id|nv
op_assign
op_amp
id|ha-&gt;nvram
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
id|target
comma
id|status
suffix:semicolon
multiline_comment|/* SCSI Reset Disable. */
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|disable_scsi_reset
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_1.scsi_reset_disable
suffix:semicolon
multiline_comment|/* Initiator ID. */
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|id
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_1.initiator_id
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_INITIATOR_ID
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|bus
ques
c_cond
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|id
op_or
id|BIT_7
suffix:colon
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|id
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Reset Delay. */
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|bus_reset_delay
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|bus_reset_delay
suffix:semicolon
multiline_comment|/* Command queue depth per device. */
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|hiwat
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|max_queue_depth
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Set target parameters. */
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
id|MAX_TARGETS
suffix:semicolon
id|target
op_increment
)paren
id|status
op_or_assign
id|qla1280_config_target
c_func
(paren
id|ha
comma
id|bus
comma
id|target
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_static
r_int
DECL|function|qla1280_nvram_config
id|qla1280_nvram_config
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_struct
id|nvram
op_star
id|nv
op_assign
op_amp
id|ha-&gt;nvram
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|status
op_assign
l_int|0
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_uint16
id|mask
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_nvram_config&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;nvram_valid
)paren
(brace
multiline_comment|/* Always force AUTO sense for LINUX SCSI */
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|MAX_BUSES
suffix:semicolon
id|bus
op_increment
)paren
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
id|MAX_TARGETS
suffix:semicolon
id|target
op_increment
)paren
(brace
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f
dot
id|auto_request_sense
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|qla1280_set_defaults
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
id|qla1280_print_settings
c_func
(paren
id|nv
)paren
suffix:semicolon
multiline_comment|/* Disable RISC load of firmware. */
id|ha-&gt;flags.disable_risc_code_load
op_assign
id|nv-&gt;cntr_flags_1.disable_loading_risc_code
suffix:semicolon
r_if
c_cond
(paren
id|IS_ISP1040
c_func
(paren
id|ha
)paren
)paren
(brace
r_uint16
id|hwrev
comma
id|cfg1
comma
id|cdma_conf
comma
id|ddma_conf
suffix:semicolon
id|hwrev
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_0
)paren
op_amp
id|ISP_CFG0_HWMSK
suffix:semicolon
id|cfg1
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
)paren
suffix:semicolon
id|cdma_conf
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cdma_cfg
)paren
suffix:semicolon
id|ddma_conf
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ddma_cfg
)paren
suffix:semicolon
multiline_comment|/* Busted fifo, says mjacob. */
r_if
c_cond
(paren
id|hwrev
op_eq
id|ISP_CFG0_1040A
)paren
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
id|cfg1
op_or
id|ISP_CFG1_F64
)paren
suffix:semicolon
r_else
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
id|cfg1
op_or
id|ISP_CFG1_F64
op_or
id|ISP_CFG1_BENAB
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cdma_cfg
comma
id|cdma_conf
op_or
id|CDMA_CONF_BENAB
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ddma_cfg
comma
id|cdma_conf
op_or
id|DDMA_CONF_BENAB
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set ISP hardware DMA burst */
id|mb
(braket
l_int|0
)braket
op_assign
id|nv-&gt;isp_config.c
suffix:semicolon
multiline_comment|/* Enable DMA arbitration on dual channel controllers */
r_if
c_cond
(paren
id|ha-&gt;ports
OG
l_int|1
)paren
id|mb
(braket
l_int|0
)braket
op_or_assign
id|BIT_13
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Set SCSI termination. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;gpio_enable
comma
(paren
id|BIT_3
op_plus
id|BIT_2
op_plus
id|BIT_1
op_plus
id|BIT_0
)paren
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|nv-&gt;termination.c
op_amp
(paren
id|BIT_3
op_plus
id|BIT_2
op_plus
id|BIT_1
op_plus
id|BIT_0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;gpio_data
comma
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* ISP parameter word. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_SYSTEM_PARAMETER
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;isp_parameter
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ISP1x40
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* clock rate - for qla1240 and older, only */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_CLOCK_RATE
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
l_int|40
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
id|mb
)paren
suffix:semicolon
)brace
multiline_comment|/* Firmware feature word. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_FIRMWARE_FEATURES
suffix:semicolon
id|mask
op_assign
id|BIT_5
op_or
id|BIT_1
op_or
id|BIT_0
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|le16_to_cpu
c_func
(paren
id|nv-&gt;firmware_feature.w
)paren
op_amp
(paren
id|mask
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_IA64_GENERIC) || defined (CONFIG_IA64_SGI_SN2)
r_if
c_cond
(paren
id|ia64_platform_is
c_func
(paren
l_string|&quot;sn2&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%li): Enabling SN2 PCI DMA &quot;
l_string|&quot;workaround&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_or_assign
id|BIT_9
suffix:semicolon
)brace
macro_line|#endif
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|mask
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Retry count and delay. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_RETRY_COUNT
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_count
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_delay
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_count
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_delay
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* ASYNC data setup time. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_ASYNC_DATA_SETUP
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.async_data_setup_time
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.async_data_setup_time
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Active negation states. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_ACTIVE_NEGATION
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.req_ack_active_negation
)paren
id|mb
(braket
l_int|1
)braket
op_or_assign
id|BIT_5
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.data_line_active_negation
)paren
id|mb
(braket
l_int|1
)braket
op_or_assign
id|BIT_4
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.req_ack_active_negation
)paren
id|mb
(braket
l_int|2
)braket
op_or_assign
id|BIT_5
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.data_line_active_negation
)paren
id|mb
(braket
l_int|2
)braket
op_or_assign
id|BIT_4
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_DATA_OVERRUN_RECOVERY
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Reset SCSI bus and return all outstanding IO */
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* thingy */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_PCI_CONTROL
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Data DMA Channel Burst Enable */
id|mb
(braket
l_int|2
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Command DMA Channel Burst Enable */
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_TAG_AGE_LIMIT
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
l_int|8
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Selection timeout. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_SELECTION_TIMEOUT
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|selection_timeout
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|selection_timeout
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
id|status
op_or_assign
id|qla1280_config_bus
c_func
(paren
id|ha
comma
id|bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_nvram_config: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_nvram_config&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Get NVRAM data word&n; *      Calculates word position in NVRAM and calls request routine to&n; *      get the word from NVRAM.&n; *&n; * Input:&n; *      ha      = adapter block pointer.&n; *      address = NVRAM word address.&n; *&n; * Returns:&n; *      data word.&n; */
r_static
r_uint16
DECL|function|qla1280_get_nvram_word
id|qla1280_get_nvram_word
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_uint32
id|address
)paren
(brace
r_uint32
id|nv_cmd
suffix:semicolon
r_uint16
id|data
suffix:semicolon
id|nv_cmd
op_assign
id|address
op_lshift
l_int|16
suffix:semicolon
id|nv_cmd
op_or_assign
id|NV_READ_OP
suffix:semicolon
id|data
op_assign
id|le16_to_cpu
c_func
(paren
id|qla1280_nvram_request
c_func
(paren
id|ha
comma
id|nv_cmd
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|8
comma
l_string|&quot;qla1280_get_nvram_word: exiting normally NVRAM data = &quot;
l_string|&quot;0x%x&quot;
comma
id|data
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
multiline_comment|/*&n; * NVRAM request&n; *      Sends read command to NVRAM and gets data from NVRAM.&n; *&n; * Input:&n; *      ha     = adapter block pointer.&n; *      nv_cmd = Bit 26     = start bit&n; *               Bit 25, 24 = opcode&n; *               Bit 23-16  = address&n; *               Bit 15-0   = write data&n; *&n; * Returns:&n; *      data word.&n; */
r_static
r_uint16
DECL|function|qla1280_nvram_request
id|qla1280_nvram_request
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_uint32
id|nv_cmd
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_uint16
id|data
op_assign
l_int|0
suffix:semicolon
r_uint16
id|reg_data
suffix:semicolon
multiline_comment|/* Send command to NVRAM. */
id|nv_cmd
op_lshift_assign
l_int|5
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|11
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|nv_cmd
op_amp
id|BIT_31
)paren
id|qla1280_nv_write
c_func
(paren
id|ha
comma
id|NV_DATA_OUT
)paren
suffix:semicolon
r_else
id|qla1280_nv_write
c_func
(paren
id|ha
comma
l_int|0
)paren
suffix:semicolon
id|nv_cmd
op_lshift_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Read data from NVRAM. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|16
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
(paren
id|NV_SELECT
op_or
id|NV_CLOCK
)paren
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
multiline_comment|/* Flush PCI write */
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|data
op_lshift_assign
l_int|1
suffix:semicolon
id|reg_data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_data
op_amp
id|NV_DATA_IN
)paren
id|data
op_or_assign
id|BIT_0
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|NV_SELECT
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
multiline_comment|/* Flush PCI write */
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Deselect chip. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|NV_DESELECT
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
multiline_comment|/* Flush PCI write */
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
r_static
r_void
DECL|function|qla1280_nv_write
id|qla1280_nv_write
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_uint16
id|data
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|data
op_or
id|NV_SELECT
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
multiline_comment|/* Flush PCI write */
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|data
op_or
id|NV_SELECT
op_or
id|NV_CLOCK
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
multiline_comment|/* Flush PCI write */
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|data
op_or
id|NV_SELECT
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
multiline_comment|/* Flush PCI write */
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Mailbox Command&n; *      Issue mailbox command and waits for completion.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      mr = mailbox registers to load.&n; *      mb = data pointer for mailbox registers.&n; *&n; * Output:&n; *      mb[MAILBOX_REGISTER_COUNT] = returned mailbox data.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_mailbox_command
id|qla1280_mailbox_command
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_uint8
id|mr
comma
r_uint16
op_star
id|mb
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
macro_line|#if 0
id|LIST_HEAD
c_func
(paren
id|done_q
)paren
suffix:semicolon
macro_line|#endif
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_uint16
op_star
id|optr
comma
op_star
id|iptr
suffix:semicolon
r_uint16
id|data
suffix:semicolon
id|DECLARE_COMPLETION
c_func
(paren
id|wait
)paren
suffix:semicolon
r_struct
id|timer_list
id|timer
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_mailbox_command&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;mailbox_wait
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Warning mailbox wait already in use!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ha-&gt;mailbox_wait
op_assign
op_amp
id|wait
suffix:semicolon
multiline_comment|/*&n;&t; * We really should start out by verifying that the mailbox is&n;&t; * available before starting sending the command data&n;&t; */
multiline_comment|/* Load mailbox registers. */
id|optr
op_assign
(paren
r_uint16
op_star
)paren
op_amp
id|reg-&gt;mailbox0
suffix:semicolon
id|iptr
op_assign
id|mb
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAILBOX_REGISTER_COUNT
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mr
op_amp
id|BIT_0
)paren
(brace
id|WRT_REG_WORD
c_func
(paren
id|optr
comma
(paren
op_star
id|iptr
)paren
)paren
suffix:semicolon
)brace
id|mr
op_rshift_assign
l_int|1
suffix:semicolon
id|optr
op_increment
suffix:semicolon
id|iptr
op_increment
suffix:semicolon
)brace
multiline_comment|/* Issue set host interrupt command. */
multiline_comment|/* set up a timer just in case we&squot;re really jammed */
id|init_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|timer.expires
op_assign
id|jiffies
op_plus
l_int|20
op_star
id|HZ
suffix:semicolon
id|timer.data
op_assign
(paren
r_int
r_int
)paren
id|ha
suffix:semicolon
id|timer.function
op_assign
id|qla1280_mailbox_timeout
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|HOST_LOCK
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_SET_HOST_INT
)paren
suffix:semicolon
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|wait
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|HOST_LOCK
)paren
suffix:semicolon
id|ha-&gt;mailbox_wait
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Check for mailbox command timeout. */
r_if
c_cond
(paren
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
op_ne
id|MBS_CMD_CMP
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280_mailbox_command: Command failed, &quot;
l_string|&quot;mailbox0 = 0x%04x, mailbox_out0 = 0x%04x, istatus = &quot;
l_string|&quot;0x%04x&bslash;n&quot;
comma
id|mb
(braket
l_int|0
)braket
comma
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;m0 %04x, m1 %04x, m2 %04x, m3 %04x&bslash;n&quot;
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox0
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox1
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox3
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;m4 %04x, m5 %04x, m6 %04x, m7 %04x&bslash;n&quot;
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox5
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox6
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox7
)paren
)paren
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Load return mailbox registers. */
id|optr
op_assign
id|mb
suffix:semicolon
id|iptr
op_assign
(paren
r_uint16
op_star
)paren
op_amp
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
suffix:semicolon
id|mr
op_assign
id|MAILBOX_REGISTER_COUNT
suffix:semicolon
id|memcpy
c_func
(paren
id|optr
comma
id|iptr
comma
id|MAILBOX_REGISTER_COUNT
op_star
r_sizeof
(paren
r_uint16
)paren
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Go check for any response interrupts pending. */
id|qla1280_isr
c_func
(paren
id|ha
comma
op_amp
id|done_q
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ha-&gt;flags.reset_marker
)paren
id|qla1280_rst_aen
c_func
(paren
id|ha
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|done_q
)paren
)paren
id|qla1280_done
c_func
(paren
id|ha
comma
op_amp
id|done_q
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_mailbox_command: **** FAILED, mailbox0 = &quot;
l_string|&quot;0x%x ****&bslash;n&quot;
comma
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_mailbox_command&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_poll&n; *      Polls ISP for interrupts.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_poll
id|qla1280_poll
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint16
id|data
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|done_q
)paren
suffix:semicolon
multiline_comment|/* ENTER(&quot;qla1280_poll&quot;); */
multiline_comment|/* Check for pending interrupts. */
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|RISC_INT
)paren
id|qla1280_isr
c_func
(paren
id|ha
comma
op_amp
id|done_q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;mailbox_wait
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;flags.reset_marker
)paren
id|qla1280_rst_aen
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|done_q
)paren
)paren
id|qla1280_done
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* LEAVE(&quot;qla1280_poll&quot;); */
)brace
multiline_comment|/*&n; * qla1280_bus_reset&n; *      Issue SCSI bus reset.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; *      bus = SCSI bus number.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_bus_reset
id|qla1280_bus_reset
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_uint16
id|reset_delay
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_bus_reset: entered&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%li:%i): Resetting SCSI BUS&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
)paren
suffix:semicolon
id|reset_delay
op_assign
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|bus_reset_delay
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_BUS_RESET
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|reset_delay
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
r_uint16
)paren
id|bus
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|failed_reset_count
OG
l_int|2
)paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
op_assign
l_int|1
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|failed_reset_count
op_increment
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irq
c_func
(paren
id|HOST_LOCK
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|reset_delay
op_star
id|HZ
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|HOST_LOCK
)paren
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|failed_reset_count
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|reset_marker
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
l_int|0
comma
l_int|0
comma
id|MK_SYNC_ALL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We should probably call qla1280_set_target_parameters()&n;&t; * here as well for all devices on the bus.&n;&t; */
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_bus_reset: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_bus_reset: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_device_reset&n; *      Issue bus device reset message to the target.&n; *&n; * Input:&n; *      ha      = adapter block pointer.&n; *      bus     = SCSI BUS number.&n; *      target  = SCSI ID.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_device_reset
id|qla1280_device_reset
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
comma
r_int
id|target
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_device_reset&quot;
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_ABORT_TARGET
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
id|bus
ques
c_cond
(paren
id|target
op_or
id|BIT_7
)paren
suffix:colon
id|target
)paren
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
l_int|0
comma
id|MK_SYNC_ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_device_reset: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_device_reset&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_abort_device&n; *      Issue an abort message to the device&n; *&n; * Input:&n; *      ha     = adapter block pointer.&n; *      bus    = SCSI BUS.&n; *      target = SCSI ID.&n; *      lun    = SCSI LUN.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_abort_device
id|qla1280_abort_device
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
comma
r_int
id|target
comma
r_int
id|lun
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_device&quot;
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_ABORT_DEVICE
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
id|bus
ques
c_cond
id|target
op_or
id|BIT_7
suffix:colon
id|target
)paren
op_lshift
l_int|8
op_or
id|lun
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
comma
id|MK_SYNC_ID_LUN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_abort_device: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_device&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_abort_command&n; *      Abort command aborts a specified IOCB.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      sp = SB structure pointer.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_abort_command
id|qla1280_abort_command
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_struct
id|srb
op_star
id|sp
comma
r_int
id|handle
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
r_int
id|status
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_command&quot;
)paren
suffix:semicolon
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_ABORT_PENDING
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_ABORT_COMMAND
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
id|bus
ques
c_cond
id|target
op_or
id|BIT_7
suffix:colon
id|target
)paren
op_lshift
l_int|8
op_or
id|lun
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|handle
op_rshift
l_int|16
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|handle
op_amp
l_int|0xffff
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
l_int|0x0f
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_abort_command: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|sp-&gt;flags
op_and_assign
op_complement
id|SRB_ABORT_PENDING
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_command&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_reset_adapter&n; *      Reset adapter.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_reset_adapter
id|qla1280_reset_adapter
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_reset_adapter&quot;
)paren
suffix:semicolon
multiline_comment|/* Disable ISP chip */
id|ha-&gt;flags.online
op_assign
l_int|0
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
id|ISP_RESET
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RESET_RISC
op_or
id|HC_RELEASE_RISC
op_or
id|HC_DISABLE_BIOS
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
multiline_comment|/* Flush PCI write */
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_reset_adapter&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Issue marker command.&n; *      Function issues marker IOCB.&n; *&n; * Input:&n; *      ha   = adapter block pointer.&n; *      bus  = SCSI BUS number&n; *      id   = SCSI ID&n; *      lun  = SCSI LUN&n; *      type = marker modifier&n; */
r_static
r_void
DECL|function|qla1280_marker
id|qla1280_marker
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
comma
r_int
id|id
comma
r_int
id|lun
comma
id|u8
id|type
)paren
(brace
r_struct
id|mrk_entry
op_star
id|pkt
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_marker&quot;
)paren
suffix:semicolon
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
(paren
id|pkt
op_assign
(paren
r_struct
id|mrk_entry
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|MARKER_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
(paren
r_uint8
)paren
id|lun
suffix:semicolon
id|pkt-&gt;target
op_assign
(paren
r_uint8
)paren
(paren
id|bus
ques
c_cond
(paren
id|id
op_or
id|BIT_7
)paren
suffix:colon
id|id
)paren
suffix:semicolon
id|pkt-&gt;modifier
op_assign
id|type
suffix:semicolon
id|pkt-&gt;entry_status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_marker&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_64bit_start_scsi&n; *      The start SCSI is responsible for building request packets on&n; *      request ring and modifying ISP input pointer.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      sp = SB structure pointer.&n; *&n; * Returns:&n; *      0 = success, was able to issue command.&n; */
macro_line|#ifdef QLA_64BIT_PTR
r_static
r_int
DECL|function|qla1280_64bit_start_scsi
id|qla1280_64bit_start_scsi
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_struct
id|srb
op_star
id|sp
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|cmd_a64_entry_t
op_star
id|pkt
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
l_int|NULL
suffix:semicolon
id|u32
op_star
id|dword_ptr
suffix:semicolon
id|dma_addr_t
id|dma_handle
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
id|req_cnt
suffix:semicolon
id|u16
id|seg_cnt
suffix:semicolon
id|u8
id|dir
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_64bit_start_scsi:&quot;
)paren
suffix:semicolon
multiline_comment|/* Calculate number of entries and segments required. */
id|req_cnt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
id|seg_cnt
op_assign
id|pci_map_sg
c_func
(paren
id|ha-&gt;pdev
comma
id|sg
comma
id|cmd-&gt;use_sg
comma
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|seg_cnt
OG
l_int|2
)paren
(brace
id|req_cnt
op_add_assign
(paren
id|seg_cnt
op_minus
l_int|2
)paren
op_div
l_int|5
suffix:semicolon
r_if
c_cond
(paren
(paren
id|seg_cnt
op_minus
l_int|2
)paren
op_mod
l_int|5
)paren
id|req_cnt
op_increment
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
)paren
(brace
multiline_comment|/* If data transfer. */
id|seg_cnt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|seg_cnt
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
op_ge
id|ha-&gt;req_q_cnt
)paren
(brace
multiline_comment|/* Calculate number of free request entries. */
id|cnt
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
OL
id|cnt
)paren
id|ha-&gt;req_q_cnt
op_assign
id|cnt
op_minus
id|ha-&gt;req_ring_index
suffix:semicolon
r_else
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
op_minus
(paren
id|ha-&gt;req_ring_index
op_minus
id|cnt
)paren
suffix:semicolon
)brace
multiline_comment|/* If room for request in request ring. */
r_if
c_cond
(paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
op_ge
id|ha-&gt;req_q_cnt
)paren
(brace
id|status
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_64bit_start_scsi: in-ptr=0x%x  req_q_cnt=&quot;
l_string|&quot;0x%xreq_cnt=0x%x&quot;
comma
id|ha-&gt;req_ring_index
comma
id|ha-&gt;req_q_cnt
comma
id|req_cnt
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Check for room in outstanding command list. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
op_logical_and
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_ne
l_int|0
suffix:semicolon
id|cnt
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_ge
id|MAX_OUTSTANDING_COMMANDS
)paren
(brace
id|status
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_64bit_start_scsi: NO ROOM IN &quot;
l_string|&quot;OUTSTANDING ARRAY, req_q_cnt=0x%x&quot;
comma
id|ha-&gt;req_q_cnt
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
id|sp
suffix:semicolon
id|ha-&gt;req_q_cnt
op_sub_assign
id|req_cnt
suffix:semicolon
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
r_int
r_int
)paren
(paren
id|cnt
op_plus
l_int|1
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;64bit_start: cmd=%p sp=%p CDB=%xm, handle %lx&bslash;n&quot;
comma
id|cmd
comma
id|sp
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
(paren
r_int
)paren
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;             bus %i, target %i, lun %i&bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|2
comma
id|cmd-&gt;cmnd
comma
id|MAX_COMMAND_SIZE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Build command packet.&n;&t; */
id|pkt
op_assign
(paren
id|cmd_a64_entry_t
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
id|pkt-&gt;entry_type
op_assign
id|COMMAND_A64_TYPE
suffix:semicolon
id|pkt-&gt;entry_count
op_assign
(paren
r_uint8
)paren
id|req_cnt
suffix:semicolon
id|pkt-&gt;sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
id|pkt-&gt;entry_status
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;handle
op_assign
id|cpu_to_le32
c_func
(paren
id|cnt
)paren
suffix:semicolon
multiline_comment|/* Zero out remaining portion of packet. */
id|memset
c_func
(paren
(paren
(paren
r_char
op_star
)paren
id|pkt
op_plus
l_int|8
)paren
comma
l_int|0
comma
(paren
id|REQUEST_ENTRY_SIZE
op_minus
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* Set ISP command timeout. */
id|pkt-&gt;timeout
op_assign
id|cpu_to_le16
c_func
(paren
l_int|30
)paren
suffix:semicolon
multiline_comment|/* Set device target ID and LUN */
id|pkt-&gt;lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|pkt-&gt;target
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
ques
c_cond
(paren
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
op_or
id|BIT_7
)paren
suffix:colon
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Enable simple tag queuing if device supports it. */
r_if
c_cond
(paren
id|DEV_SIMPLE_TAGS
c_func
(paren
id|cmd-&gt;device
)paren
)paren
id|pkt-&gt;control_flags
op_or_assign
id|cpu_to_le16
c_func
(paren
id|BIT_3
)paren
suffix:semicolon
multiline_comment|/* Load SCSI command packet. */
id|pkt-&gt;cdb_len
op_assign
id|cpu_to_le16
c_func
(paren
id|CMD_CDBLEN
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|pkt-&gt;scsi_cdb
comma
op_amp
(paren
id|CMD_CDBP
c_func
(paren
id|cmd
)paren
)paren
comma
id|CMD_CDBLEN
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
multiline_comment|/* dprintk(1, &quot;Build packet for command[0]=0x%x&bslash;n&quot;,pkt-&gt;scsi_cdb[0]); */
multiline_comment|/* Set transfer direction. */
id|dir
op_assign
id|qla1280_data_direction
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|pkt-&gt;control_flags
op_or_assign
id|cpu_to_le16
c_func
(paren
id|dir
)paren
suffix:semicolon
multiline_comment|/* Set total data segment count. */
id|pkt-&gt;dseg_count
op_assign
id|cpu_to_le16
c_func
(paren
id|seg_cnt
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Load data segments.&n;&t; */
r_if
c_cond
(paren
id|seg_cnt
)paren
(brace
multiline_comment|/* If data transfer. */
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
(paren
id|u32
op_star
)paren
op_amp
id|pkt-&gt;dseg_0_address
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
multiline_comment|/* If scatter gather */
multiline_comment|/* Load command entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|2
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
id|dma_handle
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_IA64_GENERIC) || defined(CONFIG_IA64_SGI_SN2)
r_if
c_cond
(paren
id|ha-&gt;flags.use_pci_vchannel
)paren
id|sn_pci_set_vchan
c_func
(paren
id|ha-&gt;pdev
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dma_handle
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
macro_line|#endif
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|dma_handle
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_hi32
c_func
(paren
id|dma_handle
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;S/G Segment phys_addr=%x %x, len=0x%x&bslash;n&quot;
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_hi32
c_func
(paren
id|dma_handle
)paren
)paren
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|dma_handle
)paren
)paren
comma
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_64bit_start_scsi: Scatter/gather &quot;
l_string|&quot;command packet data - b %i, t %i, l %i &bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Build continuation packets.&n;&t;&t;&t; */
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;S/G Building Continuation...seg_cnt=0x%x &quot;
l_string|&quot;remains&bslash;n&quot;
comma
id|seg_cnt
)paren
suffix:semicolon
r_while
c_loop
(paren
id|seg_cnt
OG
l_int|0
)paren
(brace
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
id|pkt
op_assign
(paren
id|cmd_a64_entry_t
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
multiline_comment|/* Zero out packet. */
id|memset
c_func
(paren
id|pkt
comma
l_int|0
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/* Load packet defaults. */
(paren
(paren
r_struct
id|cont_a64_entry
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_type
op_assign
id|CONTINUE_A64_TYPE
suffix:semicolon
(paren
(paren
r_struct
id|cont_a64_entry
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_count
op_assign
l_int|1
suffix:semicolon
(paren
(paren
r_struct
id|cont_a64_entry
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
(paren
id|u32
op_star
)paren
op_amp
(paren
(paren
r_struct
id|cont_a64_entry
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|dseg_0_address
suffix:semicolon
multiline_comment|/* Load continuation entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|5
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
id|dma_handle
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_IA64_GENERIC) || defined(CONFIG_IA64_SGI_SN2)
r_if
c_cond
(paren
id|ha-&gt;flags.use_pci_vchannel
)paren
id|sn_pci_set_vchan
c_func
(paren
id|ha-&gt;pdev
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dma_handle
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
macro_line|#endif
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|dma_handle
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_hi32
c_func
(paren
id|dma_handle
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;S/G Segment Cont. phys_addr=%x %x, len=0x%x&bslash;n&quot;
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_hi32
c_func
(paren
id|dma_handle
)paren
)paren
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|dma_handle
)paren
)paren
comma
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_64bit_start_scsi: &quot;
l_string|&quot;continuation packet data - b %i, t &quot;
l_string|&quot;%i, l %i &bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* No scatter gather data transfer */
r_struct
id|page
op_star
id|page
op_assign
id|virt_to_page
c_func
(paren
id|cmd-&gt;request_buffer
)paren
suffix:semicolon
r_int
r_int
id|off
op_assign
(paren
r_int
r_int
)paren
id|cmd-&gt;request_buffer
op_amp
op_complement
id|PAGE_MASK
suffix:semicolon
id|dma_handle
op_assign
id|pci_map_page
c_func
(paren
id|ha-&gt;pdev
comma
id|page
comma
id|off
comma
id|cmd-&gt;request_bufflen
comma
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
multiline_comment|/* save dma_handle for pci_unmap_page */
id|sp-&gt;saved_dma_handle
op_assign
id|dma_handle
suffix:semicolon
macro_line|#if defined(CONFIG_IA64_GENERIC) || defined(CONFIG_IA64_SGI_SN2)
r_if
c_cond
(paren
id|ha-&gt;flags.use_pci_vchannel
)paren
id|sn_pci_set_vchan
c_func
(paren
id|ha-&gt;pdev
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|dma_handle
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
macro_line|#endif
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|dma_handle
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_hi32
c_func
(paren
id|dma_handle
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_assign
id|cpu_to_le32
c_func
(paren
id|cmd-&gt;request_bufflen
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_64bit_start_scsi: No scatter/&quot;
l_string|&quot;gather command packet data - b %i, t %i, &quot;
l_string|&quot;l %i &bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* No data transfer */
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_64bit_start_scsi: No data, command &quot;
l_string|&quot;packet data - b %i, t %i, l %i &bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
multiline_comment|/* Set chip new ring index. */
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_64bit_start_scsi: Wakeup RISC for pending command&bslash;n&quot;
)paren
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_SENT
suffix:semicolon
id|ha-&gt;actthreads
op_increment
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
comma
id|ha-&gt;req_ring_index
)paren
suffix:semicolon
(paren
r_void
)paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
multiline_comment|/* PCI posted write flush */
id|out
suffix:colon
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_64bit_start_scsi: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_64bit_start_scsi: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#else /* !QLA_64BIT_PTR */
multiline_comment|/*&n; * qla1280_32bit_start_scsi&n; *      The start SCSI is responsible for building request packets on&n; *      request ring and modifying ISP input pointer.&n; *&n; *      The Qlogic firmware interface allows every queue slot to have a SCSI&n; *      command and up to 4 scatter/gather (SG) entries.  If we need more&n; *      than 4 SG entries, then continuation entries are used that can&n; *      hold another 7 entries each.  The start routine determines if there&n; *      is eought empty slots then build the combination of requests to&n; *      fulfill the OS request.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      sp = SCSI Request Block structure pointer.&n; *&n; * Returns:&n; *      0 = success, was able to issue command.&n; */
r_static
r_int
DECL|function|qla1280_32bit_start_scsi
id|qla1280_32bit_start_scsi
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_struct
id|srb
op_star
id|sp
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
r_struct
id|cmd_entry
op_star
id|pkt
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
l_int|NULL
suffix:semicolon
r_uint32
op_star
id|dword_ptr
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
id|req_cnt
suffix:semicolon
r_uint16
id|seg_cnt
suffix:semicolon
id|dma_addr_t
id|dma_handle
suffix:semicolon
id|u8
id|dir
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_32bit_start_scsi&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;32bit_start: cmd=%p sp=%p CDB=%x&bslash;n&quot;
comma
id|cmd
comma
id|sp
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Calculate number of entries and segments required. */
id|req_cnt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
multiline_comment|/*&n;&t;&t; * We must build an SG list in adapter format, as the kernel&squot;s&n;&t;&t; * SG list cannot be used directly because of data field size&n;&t;&t; * (__alpha__) differences and the kernel SG list uses virtual&n;&t;&t; * addresses where we need physical addresses.&n;&t;&t; */
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
id|seg_cnt
op_assign
id|pci_map_sg
c_func
(paren
id|ha-&gt;pdev
comma
id|sg
comma
id|cmd-&gt;use_sg
comma
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * if greater than four sg entries then we need to allocate&n;&t;&t; * continuation entries&n;&t;&t; */
r_if
c_cond
(paren
id|seg_cnt
OG
l_int|4
)paren
(brace
id|req_cnt
op_add_assign
(paren
id|seg_cnt
op_minus
l_int|4
)paren
op_div
l_int|7
suffix:semicolon
r_if
c_cond
(paren
(paren
id|seg_cnt
op_minus
l_int|4
)paren
op_mod
l_int|7
)paren
id|req_cnt
op_increment
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;S/G Transfer cmd=%p seg_cnt=0x%x, req_cnt=%x&bslash;n&quot;
comma
id|cmd
comma
id|seg_cnt
comma
id|req_cnt
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
)paren
(brace
multiline_comment|/* If data transfer. */
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;No S/G transfer t=%x cmd=%p len=%x CDB=%x&bslash;n&quot;
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|cmd
comma
id|cmd-&gt;request_bufflen
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|seg_cnt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* dprintk(1, &quot;No data transfer &bslash;n&quot;); */
id|seg_cnt
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
op_ge
id|ha-&gt;req_q_cnt
)paren
(brace
multiline_comment|/* Calculate number of free request entries. */
id|cnt
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
OL
id|cnt
)paren
id|ha-&gt;req_q_cnt
op_assign
id|cnt
op_minus
id|ha-&gt;req_ring_index
suffix:semicolon
r_else
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
op_minus
(paren
id|ha-&gt;req_ring_index
op_minus
id|cnt
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;Number of free entries=(%d) seg_cnt=0x%x&bslash;n&quot;
comma
id|ha-&gt;req_q_cnt
comma
id|seg_cnt
)paren
suffix:semicolon
multiline_comment|/* If room for request in request ring. */
r_if
c_cond
(paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
op_ge
id|ha-&gt;req_q_cnt
)paren
(brace
id|status
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_32bit_start_scsi: in-ptr=0x%x, &quot;
l_string|&quot;req_q_cnt=0x%x, req_cnt=0x%x&quot;
comma
id|ha-&gt;req_ring_index
comma
id|ha-&gt;req_q_cnt
comma
id|req_cnt
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Check for empty slot in outstanding command list. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
op_logical_and
(paren
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_ne
l_int|0
)paren
suffix:semicolon
id|cnt
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_ge
id|MAX_OUTSTANDING_COMMANDS
)paren
(brace
id|status
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_32bit_start_scsi: NO ROOM IN OUTSTANDING &quot;
l_string|&quot;ARRAY, req_q_cnt=0x%x&bslash;n&quot;
comma
id|ha-&gt;req_q_cnt
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
r_int
r_int
)paren
(paren
id|cnt
op_plus
l_int|1
)paren
suffix:semicolon
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
id|sp
suffix:semicolon
id|ha-&gt;req_q_cnt
op_sub_assign
id|req_cnt
suffix:semicolon
multiline_comment|/*&n;&t; * Build command packet.&n;&t; */
id|pkt
op_assign
(paren
r_struct
id|cmd_entry
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
id|pkt-&gt;entry_type
op_assign
id|COMMAND_TYPE
suffix:semicolon
id|pkt-&gt;entry_count
op_assign
(paren
r_uint8
)paren
id|req_cnt
suffix:semicolon
id|pkt-&gt;sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
id|pkt-&gt;entry_status
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;handle
op_assign
id|cpu_to_le32
c_func
(paren
id|cnt
)paren
suffix:semicolon
multiline_comment|/* Zero out remaining portion of packet. */
id|memset
c_func
(paren
(paren
(paren
r_char
op_star
)paren
id|pkt
op_plus
l_int|8
)paren
comma
l_int|0
comma
(paren
id|REQUEST_ENTRY_SIZE
op_minus
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* Set ISP command timeout. */
id|pkt-&gt;timeout
op_assign
id|cpu_to_le16
c_func
(paren
l_int|30
)paren
suffix:semicolon
multiline_comment|/* Set device target ID and LUN */
id|pkt-&gt;lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|pkt-&gt;target
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
ques
c_cond
(paren
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
op_or
id|BIT_7
)paren
suffix:colon
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Enable simple tag queuing if device supports it. */
r_if
c_cond
(paren
id|DEV_SIMPLE_TAGS
c_func
(paren
id|cmd-&gt;device
)paren
)paren
id|pkt-&gt;control_flags
op_or_assign
id|cpu_to_le16
c_func
(paren
id|BIT_3
)paren
suffix:semicolon
multiline_comment|/* Load SCSI command packet. */
id|pkt-&gt;cdb_len
op_assign
id|cpu_to_le16
c_func
(paren
id|CMD_CDBLEN
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|pkt-&gt;scsi_cdb
comma
op_amp
(paren
id|CMD_CDBP
c_func
(paren
id|cmd
)paren
)paren
comma
id|CMD_CDBLEN
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
multiline_comment|/*dprintk(1, &quot;Build packet for command[0]=0x%x&bslash;n&quot;,pkt-&gt;scsi_cdb[0]); */
multiline_comment|/* Set transfer direction. */
id|dir
op_assign
id|qla1280_data_direction
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|pkt-&gt;control_flags
op_or_assign
id|cpu_to_le16
c_func
(paren
id|dir
)paren
suffix:semicolon
multiline_comment|/* Set total data segment count. */
id|pkt-&gt;dseg_count
op_assign
id|cpu_to_le16
c_func
(paren
id|seg_cnt
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Load data segments.&n;&t; */
r_if
c_cond
(paren
id|seg_cnt
)paren
(brace
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
op_amp
id|pkt-&gt;dseg_0_address
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
multiline_comment|/* If scatter gather */
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;Building S/G data segments..&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|1
comma
(paren
r_char
op_star
)paren
id|sg
comma
l_int|4
op_star
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Load command entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|4
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;S/G Segment phys_addr=0x%lx, len=0x%x&bslash;n&quot;
comma
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
comma
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Build continuation packets.&n;&t;&t;&t; */
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;S/G Building Continuation&quot;
l_string|&quot;...seg_cnt=0x%x remains&bslash;n&quot;
comma
id|seg_cnt
)paren
suffix:semicolon
r_while
c_loop
(paren
id|seg_cnt
OG
l_int|0
)paren
(brace
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
id|pkt
op_assign
(paren
r_struct
id|cmd_entry
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
multiline_comment|/* Zero out packet. */
id|memset
c_func
(paren
id|pkt
comma
l_int|0
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/* Load packet defaults. */
(paren
(paren
r_struct
id|cont_entry
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_type
op_assign
id|CONTINUE_TYPE
suffix:semicolon
(paren
(paren
r_struct
id|cont_entry
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_count
op_assign
l_int|1
suffix:semicolon
(paren
(paren
r_struct
id|cont_entry
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
op_amp
(paren
(paren
r_struct
id|cont_entry
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|dseg_0_address
suffix:semicolon
multiline_comment|/* Load continuation entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|7
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;S/G Segment Cont. phys_addr=0x%x, &quot;
l_string|&quot;len=0x%x&bslash;n&quot;
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
comma
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_32bit_start_scsi: &quot;
l_string|&quot;continuation packet data - &quot;
l_string|&quot;scsi(%i:%i:%i)&bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* No S/G data transfer */
r_struct
id|page
op_star
id|page
op_assign
id|virt_to_page
c_func
(paren
id|cmd-&gt;request_buffer
)paren
suffix:semicolon
r_int
r_int
id|off
op_assign
(paren
r_int
r_int
)paren
id|cmd-&gt;request_buffer
op_amp
op_complement
id|PAGE_MASK
suffix:semicolon
id|dma_handle
op_assign
id|pci_map_page
c_func
(paren
id|ha-&gt;pdev
comma
id|page
comma
id|off
comma
id|cmd-&gt;request_bufflen
comma
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|sp-&gt;saved_dma_handle
op_assign
id|dma_handle
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|dma_handle
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_assign
id|cpu_to_le32
c_func
(paren
id|cmd-&gt;request_bufflen
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* No data transfer at all */
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_32bit_start_scsi: No data, command &quot;
l_string|&quot;packet data - &bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_32bit_start_scsi: First IOCB block:&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|ha-&gt;request_ring_ptr
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
multiline_comment|/* Set chip new ring index. */
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_32bit_start_scsi: Wakeup RISC &quot;
l_string|&quot;for pending command&bslash;n&quot;
)paren
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_SENT
suffix:semicolon
id|ha-&gt;actthreads
op_increment
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
comma
id|ha-&gt;req_ring_index
)paren
suffix:semicolon
(paren
r_void
)paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
multiline_comment|/* PCI posted write flush */
id|out
suffix:colon
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_32bit_start_scsi: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_32bit_start_scsi&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * qla1280_req_pkt&n; *      Function is responsible for locking ring and&n; *      getting a zeroed out request packet.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; *&n; * Returns:&n; *      0 = failed to get slot.&n; */
r_static
id|request_t
op_star
DECL|function|qla1280_req_pkt
id|qla1280_req_pkt
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|request_t
op_star
id|pkt
op_assign
l_int|NULL
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_uint32
id|timer
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_req_pkt&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This can be called from interrupt context, damn it!!!&n;&t; */
multiline_comment|/* Wait for 30 seconds for slot. */
r_for
c_loop
(paren
id|timer
op_assign
l_int|15000000
suffix:semicolon
id|timer
suffix:semicolon
id|timer
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;req_q_cnt
OG
l_int|0
)paren
(brace
multiline_comment|/* Calculate number of free request entries. */
id|cnt
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
OL
id|cnt
)paren
id|ha-&gt;req_q_cnt
op_assign
id|cnt
op_minus
id|ha-&gt;req_ring_index
suffix:semicolon
r_else
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
op_minus
(paren
id|ha-&gt;req_ring_index
op_minus
id|cnt
)paren
suffix:semicolon
)brace
multiline_comment|/* Found empty request ring slot? */
r_if
c_cond
(paren
id|ha-&gt;req_q_cnt
OG
l_int|0
)paren
(brace
id|ha-&gt;req_q_cnt
op_decrement
suffix:semicolon
id|pkt
op_assign
id|ha-&gt;request_ring_ptr
suffix:semicolon
multiline_comment|/* Zero out packet. */
id|memset
c_func
(paren
id|pkt
comma
l_int|0
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * How can this be right when we have a ring&n;&t;&t;&t; * size of 512???&n;&t;&t;&t; */
multiline_comment|/* Set system defined field. */
id|pkt-&gt;sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
multiline_comment|/* Set entry count. */
id|pkt-&gt;entry_count
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 10 */
multiline_comment|/* Check for pending interrupts. */
id|qla1280_poll
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_req_pkt: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_req_pkt: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|pkt
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_isp_cmd&n; *      Function is responsible for modifying ISP input pointer.&n; *      Releases ring lock.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_isp_cmd
id|qla1280_isp_cmd
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_isp_cmd&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_isp_cmd: IOCB data:&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|ha-&gt;request_ring_ptr
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
multiline_comment|/* Set chip new ring index. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
comma
id|ha-&gt;req_ring_index
)paren
suffix:semicolon
(paren
r_void
)paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
multiline_comment|/* PCI posted write flush */
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_isp_cmd&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                        Interrupt Service Routine.                        */
multiline_comment|/****************************************************************************/
multiline_comment|/****************************************************************************&n; *  qla1280_isr&n; *      Calls I/O done on command completion.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      done_q       = done queue.&n; ****************************************************************************/
r_static
r_void
DECL|function|qla1280_isr
id|qla1280_isr
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_struct
id|list_head
op_star
id|done_q
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_struct
id|response
op_star
id|pkt
suffix:semicolon
r_struct
id|srb
op_star
id|sp
op_assign
l_int|NULL
suffix:semicolon
r_uint16
id|mailbox
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_uint16
op_star
id|wptr
suffix:semicolon
r_uint32
id|index
suffix:semicolon
id|u16
id|istatus
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_isr&quot;
)paren
suffix:semicolon
id|istatus
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|istatus
op_amp
(paren
id|RISC_INT
op_or
id|PCI_INT
)paren
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Save mailbox register 5 */
id|mailbox
(braket
l_int|5
)braket
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox5
)paren
suffix:semicolon
multiline_comment|/* Check for mailbox interrupt. */
id|mailbox
(braket
l_int|0
)braket
op_assign
id|RD_REG_WORD_dmasync
c_func
(paren
op_amp
id|reg-&gt;semaphore
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
op_amp
id|BIT_0
)paren
(brace
multiline_comment|/* Get mailbox data. */
multiline_comment|/* dprintk(1, &quot;qla1280_isr: In Get mailbox data &bslash;n&quot;); */
id|wptr
op_assign
op_amp
id|mailbox
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox0
)paren
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox1
)paren
suffix:semicolon
op_star
id|wptr
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
op_ne
id|MBA_SCSI_COMPLETION
)paren
(brace
id|wptr
op_increment
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox3
)paren
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
id|wptr
op_increment
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox6
)paren
suffix:semicolon
op_star
id|wptr
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox7
)paren
suffix:semicolon
)brace
multiline_comment|/* Release mailbox registers. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
comma
l_int|0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_RISC_INT
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_isr: mailbox interrupt mailbox[0] = 0x%x&quot;
comma
id|mailbox
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Handle asynchronous event */
r_switch
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
)paren
(brace
r_case
id|MBA_SCSI_COMPLETION
suffix:colon
multiline_comment|/* Response completion */
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_isr: mailbox SCSI response &quot;
l_string|&quot;completion&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.online
)paren
(brace
multiline_comment|/* Get outstanding command index. */
id|index
op_assign
id|mailbox
(braket
l_int|2
)braket
op_lshift
l_int|16
op_or
id|mailbox
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|index
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|index
)braket
suffix:semicolon
r_else
id|sp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|index
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Save ISP completion status */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Place block on done queue */
id|list_add_tail
c_func
(paren
op_amp
id|sp-&gt;list
comma
id|done_q
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * If we get here we have a real problem!&n;&t;&t;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP invalid handle&quot;
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|MBA_BUS_RESET
suffix:colon
multiline_comment|/* SCSI Bus Reset */
id|ha-&gt;flags.reset_marker
op_assign
l_int|1
suffix:semicolon
id|index
op_assign
id|mailbox
(braket
l_int|6
)braket
op_amp
id|BIT_0
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|index
)braket
dot
id|reset_marker
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;qla1280_isr(): index %i &quot;
l_string|&quot;asynchronous BUS_RESET&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_SYSTEM_ERR
suffix:colon
multiline_comment|/* System Error */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP System Error - mbx1=%xh, mbx2=&quot;
l_string|&quot;%xh, mbx3=%xh&bslash;n&quot;
comma
id|mailbox
(braket
l_int|1
)braket
comma
id|mailbox
(braket
l_int|2
)braket
comma
id|mailbox
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_REQ_TRANSFER_ERR
suffix:colon
multiline_comment|/* Request Transfer Error */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP Request Transfer Error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_RSP_TRANSFER_ERR
suffix:colon
multiline_comment|/* Response Transfer Error */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP Response Transfer Error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_WAKEUP_THRES
suffix:colon
multiline_comment|/* Request Queue Wake-up */
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: asynchronous WAKEUP_THRES&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_TIMEOUT_RESET
suffix:colon
multiline_comment|/* Execution Timeout Reset */
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: asynchronous TIMEOUT_RESET&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_DEVICE_RESET
suffix:colon
multiline_comment|/* Bus Device Reset */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280_isr(): asynchronous &quot;
l_string|&quot;BUS_DEVICE_RESET&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.reset_marker
op_assign
l_int|1
suffix:semicolon
id|index
op_assign
id|mailbox
(braket
l_int|6
)braket
op_amp
id|BIT_0
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|index
)braket
dot
id|reset_marker
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_BUS_MODE_CHANGE
suffix:colon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: asynchronous BUS_MODE_CHANGE&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* dprintk(1, &quot;qla1280_isr: default case of switch MB &bslash;n&quot;); */
r_if
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
OL
id|MBA_ASYNC_EVENT
)paren
(brace
id|wptr
op_assign
op_amp
id|mailbox
(braket
l_int|0
)braket
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_uint16
op_star
)paren
id|ha-&gt;mailbox_out
comma
id|wptr
comma
id|MAILBOX_REGISTER_COUNT
op_star
r_sizeof
(paren
r_uint16
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;mailbox_wait
op_ne
l_int|NULL
)paren
(brace
id|complete
c_func
(paren
id|ha-&gt;mailbox_wait
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_RISC_INT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We will receive interrupts during mailbox testing prior to&n;&t; * the card being marked online, hence the double check.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ha-&gt;flags.online
op_logical_and
op_logical_neg
id|ha-&gt;mailbox_wait
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: Response pointer Error&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mailbox
(braket
l_int|5
)braket
op_ge
id|RESPONSE_ENTRY_CNT
)paren
r_goto
id|out
suffix:semicolon
r_while
c_loop
(paren
id|ha-&gt;rsp_ring_index
op_ne
id|mailbox
(braket
l_int|5
)braket
)paren
(brace
id|pkt
op_assign
id|ha-&gt;response_ring_ptr
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_isr: ha-&gt;rsp_ring_index = 0x%x, mailbox[5]&quot;
l_string|&quot; = 0x%x&bslash;n&quot;
comma
id|ha-&gt;rsp_ring_index
comma
id|mailbox
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_isr: response packet data&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|RESPONSE_ENTRY_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|STATUS_TYPE
)paren
(brace
r_if
c_cond
(paren
(paren
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;scsi_status
)paren
op_amp
l_int|0xff
)paren
op_logical_or
id|pkt-&gt;comp_status
op_logical_or
id|pkt-&gt;entry_status
)paren
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: ha-&gt;rsp_ring_index = &quot;
l_string|&quot;0x%x mailbox[5] = 0x%x, comp_status &quot;
l_string|&quot;= 0x%x, scsi_status = 0x%x&bslash;n&quot;
comma
id|ha-&gt;rsp_ring_index
comma
id|mailbox
(braket
l_int|5
)braket
comma
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;comp_status
)paren
comma
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;scsi_status
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: ha-&gt;rsp_ring_index = &quot;
l_string|&quot;0x%x, mailbox[5] = 0x%x&bslash;n&quot;
comma
id|ha-&gt;rsp_ring_index
comma
id|mailbox
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: response packet data&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|2
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|RESPONSE_ENTRY_SIZE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|STATUS_TYPE
op_logical_or
id|pkt-&gt;entry_status
)paren
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;status: Cmd %p, handle %i&bslash;n&quot;
comma
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
op_member_access_from_pointer
id|cmd
comma
id|pkt-&gt;handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|STATUS_TYPE
)paren
id|qla1280_status_entry
c_func
(paren
id|ha
comma
id|pkt
comma
id|done_q
)paren
suffix:semicolon
r_else
id|qla1280_error_entry
c_func
(paren
id|ha
comma
id|pkt
comma
id|done_q
)paren
suffix:semicolon
multiline_comment|/* Adjust ring index. */
id|ha-&gt;rsp_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;rsp_ring_index
op_eq
id|RESPONSE_ENTRY_CNT
)paren
(brace
id|ha-&gt;rsp_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;response_ring_ptr
op_assign
id|ha-&gt;response_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;response_ring_ptr
op_increment
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox5
comma
id|ha-&gt;rsp_ring_index
)paren
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_isr&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_rst_aen&n; *      Processes asynchronous reset.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_rst_aen
id|qla1280_rst_aen
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_uint8
id|bus
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_rst_aen&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.online
op_logical_and
op_logical_neg
id|ha-&gt;flags.reset_active
op_logical_and
op_logical_neg
id|ha-&gt;flags.abort_isp_active
)paren
(brace
id|ha-&gt;flags.reset_active
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|ha-&gt;flags.reset_marker
)paren
(brace
multiline_comment|/* Issue marker command. */
id|ha-&gt;flags.reset_marker
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
op_logical_and
op_logical_neg
id|ha-&gt;flags.reset_marker
suffix:semicolon
id|bus
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|reset_marker
)paren
(brace
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|reset_marker
op_assign
l_int|0
suffix:semicolon
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
l_int|0
comma
l_int|0
comma
id|MK_SYNC_ALL
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_rst_aen&quot;
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; 0x020500
multiline_comment|/*&n; *&n; */
r_static
r_void
DECL|function|qla1280_get_target_options
id|qla1280_get_target_options
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
comma
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_int
r_char
op_star
id|result
suffix:semicolon
r_struct
id|nvram
op_star
id|n
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure to not touch anything if someone is using the&n;&t; * sg interface.&n;&t; */
r_if
c_cond
(paren
id|cmd-&gt;use_sg
op_logical_or
(paren
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_rshift
l_int|16
)paren
op_ne
id|DID_OK
op_logical_or
id|lun
)paren
r_return
suffix:semicolon
id|result
op_assign
id|cmd-&gt;request_buffer
suffix:semicolon
id|n
op_assign
op_amp
id|ha-&gt;nvram
suffix:semicolon
id|n-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_wide
op_assign
l_int|0
suffix:semicolon
id|n-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_sync
op_assign
l_int|0
suffix:semicolon
id|n-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160.flags.enable_ppr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|result
(braket
l_int|7
)braket
op_amp
l_int|0x60
)paren
id|n-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_wide
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|result
(braket
l_int|7
)braket
op_amp
l_int|0x10
)paren
id|n-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_sync
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
(braket
l_int|2
)braket
op_ge
l_int|3
)paren
op_logical_and
(paren
id|result
(braket
l_int|4
)braket
op_plus
l_int|5
OG
l_int|56
)paren
op_logical_and
(paren
id|result
(braket
l_int|56
)braket
op_amp
l_int|0x4
)paren
)paren
id|n-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160.flags.enable_ppr
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;get_target_options(): wide %i, sync %i, ppr %i&bslash;n&quot;
comma
id|n-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_wide
comma
id|n-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.enable_sync
comma
id|n-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|ppr_1x160.flags.enable_ppr
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *  qla1280_status_entry&n; *      Processes received ISP status entry.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      pkt          = entry pointer.&n; *      done_q       = done queue.&n; */
r_static
r_void
DECL|function|qla1280_status_entry
id|qla1280_status_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_struct
id|response
op_star
id|pkt
comma
r_struct
id|list_head
op_star
id|done_q
)paren
(brace
r_int
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
r_int
id|sense_sz
suffix:semicolon
r_struct
id|srb
op_star
id|sp
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|cmd
suffix:semicolon
r_uint32
id|handle
op_assign
id|le32_to_cpu
c_func
(paren
id|pkt-&gt;handle
)paren
suffix:semicolon
r_uint16
id|scsi_status
op_assign
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;scsi_status
)paren
suffix:semicolon
r_uint16
id|comp_status
op_assign
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;comp_status
)paren
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_status_entry&quot;
)paren
suffix:semicolon
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|handle
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|handle
)braket
suffix:semicolon
r_else
id|sp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sp
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Status Entry invalid handle&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|handle
)braket
op_assign
l_int|NULL
suffix:semicolon
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
multiline_comment|/* Generate LU queue on cntrl, target, LUN */
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|comp_status
op_logical_or
id|scsi_status
)paren
(brace
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;scsi: comp_status = 0x%x, scsi_status = &quot;
l_string|&quot;0x%x, handle = 0x%x&bslash;n&quot;
comma
id|comp_status
comma
id|scsi_status
comma
id|handle
)paren
suffix:semicolon
)brace
multiline_comment|/* Target busy */
r_if
c_cond
(paren
id|scsi_status
op_amp
id|SS_BUSY_CONDITION
op_logical_and
id|scsi_status
op_ne
id|SS_RESERVE_CONFLICT
)paren
(brace
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
op_or
(paren
id|scsi_status
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Save ISP completion status */
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
id|qla1280_return_status
c_func
(paren
id|pkt
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_status
op_amp
id|SS_CHECK_CONDITION
)paren
(brace
r_if
c_cond
(paren
id|comp_status
op_ne
id|CS_ARS_FAILED
)paren
(brace
r_uint16
id|req_sense_length
op_assign
id|le16_to_cpu
c_func
(paren
id|pkt-&gt;req_sense_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req_sense_length
OL
id|CMD_SNSLEN
c_func
(paren
id|cmd
)paren
)paren
id|sense_sz
op_assign
id|req_sense_length
suffix:semicolon
r_else
multiline_comment|/*&n;&t;&t;&t;&t;&t; * scsi_cmnd-&gt;sense_buffer is&n;&t;&t;&t;&t;&t; * 64 bytes, why only copy 63?&n;&t;&t;&t;&t;&t; * This looks wrong! /Jes&n;&t;&t;&t;&t;&t; */
id|sense_sz
op_assign
id|CMD_SNSLEN
c_func
(paren
id|cmd
)paren
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd-&gt;sense_buffer
comma
op_amp
id|pkt-&gt;req_sense_data
comma
id|sense_sz
)paren
suffix:semicolon
)brace
r_else
id|sense_sz
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|cmd-&gt;sense_buffer
op_plus
id|sense_sz
comma
l_int|0
comma
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
op_minus
id|sense_sz
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_status_entry: Check &quot;
l_string|&quot;condition Sense data, b %i, t %i, &quot;
l_string|&quot;l %i&bslash;n&quot;
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sense_sz
)paren
id|qla1280_dump_buffer
c_func
(paren
l_int|2
comma
(paren
r_char
op_star
)paren
id|cmd-&gt;sense_buffer
comma
id|sense_sz
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Place command on done queue. */
id|list_add_tail
c_func
(paren
op_amp
id|sp-&gt;list
comma
id|done_q
)paren
suffix:semicolon
id|out
suffix:colon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_status_entry&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_error_entry&n; *      Processes error entry.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      pkt          = entry pointer.&n; *      done_q       = done queue.&n; */
r_static
r_void
DECL|function|qla1280_error_entry
id|qla1280_error_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_struct
id|response
op_star
id|pkt
comma
r_struct
id|list_head
op_star
id|done_q
)paren
(brace
r_struct
id|srb
op_star
id|sp
suffix:semicolon
r_uint32
id|handle
op_assign
id|le32_to_cpu
c_func
(paren
id|pkt-&gt;handle
)paren
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_error_entry&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_3
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_error_entry: BAD PAYLOAD flag error&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_2
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_error_entry: BAD HEADER flag error&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_1
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_error_entry: FULL flag error&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_error_entry: UNKNOWN flag error&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|handle
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|handle
)braket
suffix:semicolon
r_else
id|sp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|handle
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Bad payload or header */
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
(paren
id|BIT_3
op_plus
id|BIT_2
)paren
)paren
(brace
multiline_comment|/* Bad payload or header, set error status. */
multiline_comment|/* CMD_RESULT(sp-&gt;cmd) = CS_BAD_PAYLOAD; */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_1
)paren
(brace
multiline_comment|/* FULL flag */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set error status. */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* Place command on done queue. */
id|list_add_tail
c_func
(paren
op_amp
id|sp-&gt;list
comma
id|done_q
)paren
suffix:semicolon
)brace
macro_line|#ifdef QLA_64BIT_PTR
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|COMMAND_A64_TYPE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;!qla1280: Error Entry invalid handle&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_error_entry&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_abort_isp&n; *      Resets ISP and aborts all outstanding commands.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_abort_isp
id|qla1280_abort_isp
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_struct
id|srb
op_star
id|sp
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
id|bus
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_isp&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.abort_isp_active
op_logical_or
op_logical_neg
id|ha-&gt;flags.online
)paren
r_goto
id|out
suffix:semicolon
id|ha-&gt;flags.abort_isp_active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Disable ISP interrupts. */
id|qla1280_disable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_PAUSE_RISC
)paren
suffix:semicolon
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%li): dequeuing outstanding commands&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
multiline_comment|/* Dequeue all commands in outstanding command list. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|cmd
suffix:semicolon
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
id|sp-&gt;cmd
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
l_int|NULL
suffix:semicolon
(paren
op_star
id|cmd-&gt;scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
id|sp-&gt;flags
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|status
op_assign
id|qla1280_load_firmware
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Setup adapter based on NVRAM parameters. */
id|qla1280_nvram_config
(paren
id|ha
)paren
suffix:semicolon
id|status
op_assign
id|qla1280_init_rings
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Issue SCSI reset. */
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|bus
)paren
suffix:semicolon
id|ha-&gt;flags.abort_isp_active
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|status
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP error recovery failed, board disabled&quot;
)paren
suffix:semicolon
id|qla1280_reset_adapter
c_func
(paren
id|ha
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_abort_isp: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_isp&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_debounce_register&n; *      Debounce register.&n; *&n; * Input:&n; *      port = register address.&n; *&n; * Returns:&n; *      register value.&n; */
r_static
id|u16
DECL|function|qla1280_debounce_register
id|qla1280_debounce_register
c_func
(paren
r_volatile
id|u16
op_star
id|addr
)paren
(brace
r_volatile
id|u16
id|ret
suffix:semicolon
r_volatile
id|u16
id|ret2
suffix:semicolon
id|ret
op_assign
id|RD_REG_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
id|ret2
op_assign
id|RD_REG_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|ret2
)paren
r_return
id|ret
suffix:semicolon
r_do
(brace
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|RD_REG_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
id|ret2
op_assign
id|RD_REG_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_ne
id|ret2
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/************************************************************************&n; * qla1280_check_for_dead_scsi_bus                                      *&n; *                                                                      *&n; *    This routine checks for a dead SCSI bus                           *&n; ************************************************************************/
DECL|macro|SET_SXP_BANK
mdefine_line|#define SET_SXP_BANK            0x0100
DECL|macro|SCSI_PHASE_INVALID
mdefine_line|#define SCSI_PHASE_INVALID      0x87FF
r_static
r_int
DECL|function|qla1280_check_for_dead_scsi_bus
id|qla1280_check_for_dead_scsi_bus
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
r_int
id|bus
)paren
(brace
r_uint16
id|config_reg
comma
id|scsi_control
suffix:semicolon
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
)paren
(brace
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_PAUSE_RISC
)paren
suffix:semicolon
id|config_reg
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
id|SET_SXP_BANK
)paren
suffix:semicolon
id|scsi_control
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;scsiControlPins
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
id|config_reg
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RELEASE_RISC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_control
op_eq
id|SCSI_PHASE_INVALID
)paren
(brace
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
id|CMD_RESULT
c_func
(paren
id|cp
)paren
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|CMD_HANDLE
c_func
(paren
id|cp
)paren
op_assign
id|INVALID_HANDLE
suffix:semicolon
multiline_comment|/* ha-&gt;actthreads--; */
(paren
op_star
(paren
id|cp
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|cp
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
multiline_comment|/* bus is dead */
)brace
r_else
(brace
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|failed_reset_count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* bus is not dead */
)brace
r_static
r_void
DECL|function|qla1280_get_target_parameters
id|qla1280_get_target_parameters
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_struct
id|scsi_device
op_star
id|device
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
id|bus
op_assign
id|device-&gt;channel
suffix:semicolon
id|target
op_assign
id|device-&gt;id
suffix:semicolon
id|lun
op_assign
id|device-&gt;lun
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_TARGET_PARAMETERS
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|bus
ques
c_cond
id|target
op_or
id|BIT_7
suffix:colon
id|target
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_lshift_assign
l_int|8
suffix:semicolon
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_6
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%li:%d:%d:%d):&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
l_int|3
)braket
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; Sync: period %d, offset %d&quot;
comma
(paren
id|mb
(braket
l_int|3
)braket
op_amp
l_int|0xff
)paren
comma
(paren
id|mb
(braket
l_int|3
)braket
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
l_int|2
)braket
op_amp
id|BIT_13
)paren
id|printk
c_func
(paren
l_string|&quot;, Wide&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mb
(braket
l_int|2
)braket
op_amp
id|BIT_5
)paren
op_logical_and
(paren
(paren
id|mb
(braket
l_int|6
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_ge
l_int|2
)paren
id|printk
c_func
(paren
l_string|&quot;, DT&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot; Async&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DEV_SIMPLE_TAGS
c_func
(paren
id|device
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;, Tagged queuing: depth %d&quot;
comma
id|device-&gt;queue_depth
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if DEBUG_QLA1280
r_static
r_void
DECL|function|__qla1280_dump_buffer
id|__qla1280_dump_buffer
c_func
(paren
r_char
op_star
id|b
comma
r_int
id|size
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|u8
id|c
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; 0   1   2   3   4   5   6   7   8   9   Ah  &quot;
l_string|&quot;Bh  Ch  Dh  Eh  Fh&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;---------------------------------------------&quot;
l_string|&quot;------------------&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|size
suffix:semicolon
)paren
(brace
id|c
op_assign
op_star
id|b
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;0x%02x&quot;
comma
id|c
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cnt
op_mod
l_int|16
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
op_mod
l_int|16
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   ql1280_print_scsi_cmd&n; *&n; **************************************************************************/
r_static
r_void
DECL|function|__qla1280_print_scsi_cmd
id|__qla1280_print_scsi_cmd
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|CMD_HOST
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_struct
id|srb
op_star
id|sp
suffix:semicolon
multiline_comment|/* struct scatterlist *sg; */
r_int
id|i
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|sp
op_assign
(paren
r_struct
id|srb
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCSI Command @= 0x%p, Handle=0x%p&bslash;n&quot;
comma
id|cmd
comma
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  chan=%d, target = 0x%02x, lun = 0x%02x, cmd_len = 0x%02x&bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
comma
id|CMD_CDBLEN
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; CDB = &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%02x &quot;
comma
id|cmd-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;  seg_cnt =%d&bslash;n&quot;
comma
id|cmd-&gt;use_sg
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  request buffer=0x%p, request buffer len=0x%x&bslash;n&quot;
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;request_bufflen
)paren
suffix:semicolon
multiline_comment|/* if (cmd-&gt;use_sg)&n;&t;   {&n;&t;   sg = (struct scatterlist *) cmd-&gt;request_buffer;&n;&t;   printk(&quot;  SG buffer: &bslash;n&quot;);&n;&t;   qla1280_dump_buffer(1, (char *)sg, (cmd-&gt;use_sg*sizeof(struct scatterlist)));&n;&t;   } */
id|printk
c_func
(paren
l_string|&quot;  tag=%d, transfersize=0x%x &bslash;n&quot;
comma
id|cmd-&gt;tag
comma
id|cmd-&gt;transfersize
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  Pid=%li, SP=0x%p&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|CMD_SP
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; underflow size = 0x%x, direction=0x%x&bslash;n&quot;
comma
id|cmd-&gt;underflow
comma
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   ql1280_dump_device&n; *&n; **************************************************************************/
r_static
r_void
DECL|function|ql1280_dump_device
id|ql1280_dump_device
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|scsi_cmnd
op_star
id|cp
suffix:semicolon
r_struct
id|srb
op_star
id|sp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Outstanding Commands on controller:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|i
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cp
op_assign
id|sp-&gt;cmd
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|qla1280_print_scsi_cmd
c_func
(paren
l_int|1
comma
id|cp
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|enum|tokens
r_enum
id|tokens
(brace
DECL|enumerator|TOKEN_NVRAM
id|TOKEN_NVRAM
comma
DECL|enumerator|TOKEN_SYNC
id|TOKEN_SYNC
comma
DECL|enumerator|TOKEN_WIDE
id|TOKEN_WIDE
comma
DECL|enumerator|TOKEN_PPR
id|TOKEN_PPR
comma
DECL|enumerator|TOKEN_VERBOSE
id|TOKEN_VERBOSE
comma
DECL|enumerator|TOKEN_DEBUG
id|TOKEN_DEBUG
comma
)brace
suffix:semicolon
DECL|struct|setup_tokens
r_struct
id|setup_tokens
(brace
DECL|member|token
r_char
op_star
id|token
suffix:semicolon
DECL|member|val
r_int
id|val
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|setup_tokens
id|setup_token
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_string|&quot;nvram&quot;
comma
id|TOKEN_NVRAM
)brace
comma
(brace
l_string|&quot;sync&quot;
comma
id|TOKEN_SYNC
)brace
comma
(brace
l_string|&quot;wide&quot;
comma
id|TOKEN_WIDE
)brace
comma
(brace
l_string|&quot;ppr&quot;
comma
id|TOKEN_PPR
)brace
comma
(brace
l_string|&quot;verbose&quot;
comma
id|TOKEN_VERBOSE
)brace
comma
(brace
l_string|&quot;debug&quot;
comma
id|TOKEN_DEBUG
)brace
comma
)brace
suffix:semicolon
multiline_comment|/**************************************************************************&n; *   qla1280_setup&n; *&n; *   Handle boot parameters. This really needs to be changed so one&n; *   can specify per adapter parameters.&n; **************************************************************************/
r_static
r_int
id|__init
DECL|function|qla1280_setup
id|qla1280_setup
c_func
(paren
r_char
op_star
id|s
)paren
(brace
r_char
op_star
id|cp
comma
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
r_int
id|toke
suffix:semicolon
id|cp
op_assign
id|s
suffix:semicolon
r_while
c_loop
(paren
id|cp
op_logical_and
(paren
id|ptr
op_assign
id|strchr
c_func
(paren
id|cp
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
id|ptr
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|ptr
comma
l_string|&quot;yes&quot;
)paren
)paren
(brace
id|val
op_assign
l_int|0x10000
suffix:semicolon
id|ptr
op_add_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|ptr
comma
l_string|&quot;no&quot;
)paren
)paren
(brace
id|val
op_assign
l_int|0
suffix:semicolon
id|ptr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
id|val
op_assign
id|simple_strtoul
c_func
(paren
id|ptr
comma
op_amp
id|ptr
comma
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|toke
op_assign
id|qla1280_get_token
c_func
(paren
id|cp
)paren
)paren
)paren
(brace
r_case
id|TOKEN_NVRAM
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|val
)paren
id|driver_setup.no_nvram
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TOKEN_SYNC
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|val
)paren
id|driver_setup.no_sync
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
op_ne
l_int|0x10000
)paren
id|driver_setup.sync_mask
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TOKEN_WIDE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|val
)paren
id|driver_setup.no_wide
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
op_ne
l_int|0x10000
)paren
id|driver_setup.wide_mask
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TOKEN_PPR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|val
)paren
id|driver_setup.no_ppr
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
op_ne
l_int|0x10000
)paren
id|driver_setup.ppr_mask
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TOKEN_VERBOSE
suffix:colon
id|qla1280_verbose
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: unknown boot option %s&bslash;n&quot;
comma
id|cp
)paren
suffix:semicolon
)brace
id|cp
op_assign
id|strchr
c_func
(paren
id|ptr
comma
l_char|&squot;;&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cp
)paren
id|cp
op_increment
suffix:semicolon
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|qla1280_get_token
id|qla1280_get_token
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|sep
suffix:semicolon
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|i
comma
id|len
suffix:semicolon
id|len
op_assign
r_sizeof
(paren
id|setup_token
)paren
op_div
r_sizeof
(paren
r_struct
id|setup_tokens
)paren
suffix:semicolon
id|sep
op_assign
id|strchr
c_func
(paren
id|str
comma
l_char|&squot;:&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sep
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|setup_token
(braket
id|i
)braket
dot
id|token
comma
id|str
comma
(paren
id|sep
op_minus
id|str
)paren
)paren
)paren
(brace
id|ret
op_assign
id|setup_token
(braket
id|i
)braket
dot
id|val
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= 0x020600
DECL|variable|qla1280_driver_template
r_static
r_struct
id|scsi_host_template
id|qla1280_driver_template
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|proc_name
op_assign
l_string|&quot;qla1280&quot;
comma
dot
id|name
op_assign
l_string|&quot;Qlogic ISP 1280/12160&quot;
comma
dot
id|info
op_assign
id|qla1280_info
comma
dot
id|slave_configure
op_assign
id|qla1280_slave_configure
comma
dot
id|queuecommand
op_assign
id|qla1280_queuecommand
comma
dot
id|eh_abort_handler
op_assign
id|qla1280_eh_abort
comma
dot
id|eh_device_reset_handler
op_assign
id|qla1280_eh_device_reset
comma
dot
id|eh_bus_reset_handler
op_assign
id|qla1280_eh_bus_reset
comma
dot
id|eh_host_reset_handler
op_assign
id|qla1280_eh_adapter_reset
comma
dot
id|bios_param
op_assign
id|qla1280_biosparam
comma
dot
id|proc_info
op_assign
id|qla1280_proc_info
comma
dot
id|can_queue
op_assign
l_int|0xfffff
comma
dot
id|this_id
op_assign
op_minus
l_int|1
comma
dot
id|sg_tablesize
op_assign
id|SG_ALL
comma
dot
id|cmd_per_lun
op_assign
l_int|1
comma
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
)brace
suffix:semicolon
macro_line|#else
DECL|variable|qla1280_driver_template
r_static
id|Scsi_Host_Template
id|qla1280_driver_template
op_assign
(brace
dot
id|proc_name
op_assign
l_string|&quot;qla1280&quot;
comma
dot
id|name
op_assign
l_string|&quot;Qlogic ISP 1280/12160&quot;
comma
dot
id|detect
op_assign
id|qla1280_detect
comma
dot
id|release
op_assign
id|qla1280_release
comma
dot
id|info
op_assign
id|qla1280_info
comma
dot
id|queuecommand
op_assign
id|qla1280_queuecommand
comma
dot
id|eh_abort_handler
op_assign
id|qla1280_eh_abort
comma
dot
id|eh_device_reset_handler
op_assign
id|qla1280_eh_device_reset
comma
dot
id|eh_bus_reset_handler
op_assign
id|qla1280_eh_bus_reset
comma
dot
id|eh_host_reset_handler
op_assign
id|qla1280_eh_adapter_reset
comma
dot
id|bios_param
op_assign
id|qla1280_biosparam_old
comma
dot
id|proc_info
op_assign
id|qla1280_proc_info_old
comma
dot
id|can_queue
op_assign
l_int|0xfffff
comma
dot
id|this_id
op_assign
op_minus
l_int|1
comma
dot
id|sg_tablesize
op_assign
id|SG_ALL
comma
dot
id|cmd_per_lun
op_assign
l_int|1
comma
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
dot
id|use_new_eh_code
op_assign
l_int|1
comma
)brace
suffix:semicolon
macro_line|#endif
r_static
r_int
id|__devinit
DECL|function|qla1280_probe_one
id|qla1280_probe_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
id|devnum
op_assign
id|id-&gt;driver_data
suffix:semicolon
r_struct
id|qla_boards
op_star
id|bdp
op_assign
op_amp
id|ql1280_board_tbl
(braket
id|devnum
)braket
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Bypass all AMI SUBSYS VENDOR IDs */
r_if
c_cond
(paren
id|pdev-&gt;subsystem_vendor
op_eq
id|PCI_VENDOR_ID_AMI
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Skipping AMI SubSys Vendor ID Chip&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: %s found on PCI bus %i, dev %i&bslash;n&quot;
comma
id|bdp-&gt;name
comma
id|pdev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Failed to enabled pci device, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|host
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|qla1280_driver_template
comma
r_sizeof
(paren
op_star
id|ha
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Failed to register host, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_disable_device
suffix:semicolon
)brace
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|memset
c_func
(paren
id|ha
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scsi_qla_host
)paren
)paren
suffix:semicolon
id|ha-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|ha-&gt;devnum
op_assign
id|devnum
suffix:semicolon
multiline_comment|/* specifies microcode load address */
macro_line|#ifdef QLA_64BIT_PTR
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|ha-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
op_complement
l_int|0ULL
)paren
)paren
(brace
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|ha-&gt;pdev
comma
l_int|0xffffffff
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(%li): Unable to set a &quot;
l_string|&quot; suitable DMA mask - aboring&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|error_free_irq
suffix:semicolon
)brace
)brace
r_else
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;scsi(%li): 64 Bit PCI Addressing Enabled&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|ha-&gt;pdev
comma
l_int|0xffffffff
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(%li): Unable to set a &quot;
l_string|&quot; suitable DMA mask - aboring&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|error_free_irq
suffix:semicolon
)brace
macro_line|#endif
id|ha-&gt;request_ring
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ha-&gt;pdev
comma
(paren
(paren
id|REQUEST_ENTRY_CNT
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
id|request_t
)paren
)paren
)paren
comma
op_amp
id|ha-&gt;request_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;request_ring
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Failed to get request memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_put_host
suffix:semicolon
)brace
id|ha-&gt;response_ring
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ha-&gt;pdev
comma
(paren
(paren
id|RESPONSE_ENTRY_CNT
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
r_struct
id|response
)paren
)paren
)paren
comma
op_amp
id|ha-&gt;response_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;response_ring
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Failed to get response memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_free_request_ring
suffix:semicolon
)brace
id|ha-&gt;ports
op_assign
id|bdp-&gt;numPorts
suffix:semicolon
id|ha-&gt;host
op_assign
id|host
suffix:semicolon
id|ha-&gt;host_no
op_assign
id|host-&gt;host_no
suffix:semicolon
id|host-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|host-&gt;max_channel
op_assign
id|bdp-&gt;numPorts
op_minus
l_int|1
suffix:semicolon
id|host-&gt;max_lun
op_assign
id|MAX_LUNS
op_minus
l_int|1
suffix:semicolon
id|host-&gt;max_id
op_assign
id|MAX_TARGETS
suffix:semicolon
id|host-&gt;max_sectors
op_assign
l_int|1024
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|host-&gt;host_no
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; 0x020545
id|host-&gt;select_queue_depths
op_assign
id|qla1280_select_queue_depth
suffix:semicolon
macro_line|#endif
id|error
op_assign
op_minus
id|ENODEV
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
id|ha-&gt;mmpbase
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|ha-&gt;pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|ha-&gt;pdev
comma
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;mmpbase
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Unable to map I/O memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_free_response_ring
suffix:semicolon
)brace
id|host-&gt;base
op_assign
(paren
r_int
r_int
)paren
id|ha-&gt;mmpbase
suffix:semicolon
id|ha-&gt;iobase
op_assign
(paren
r_struct
id|device_reg
op_star
)paren
id|ha-&gt;mmpbase
suffix:semicolon
macro_line|#else
id|host-&gt;io_port
op_assign
id|pci_resource_start
c_func
(paren
id|ha-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
comma
l_string|&quot;qla1280&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Failed to reserve i/o region &quot;
l_string|&quot;0x%04lx-0x%04lx - already in use&bslash;n&quot;
comma
id|host-&gt;io_port
comma
id|host-&gt;io_port
op_plus
l_int|0xff
)paren
suffix:semicolon
r_goto
id|error_free_response_ring
suffix:semicolon
)brace
id|ha-&gt;iobase
op_assign
(paren
r_struct
id|device_reg
op_star
)paren
id|host-&gt;io_port
suffix:semicolon
macro_line|#endif
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ha-&gt;done_q
)paren
suffix:semicolon
multiline_comment|/* Disable ISP interrupts. */
id|qla1280_disable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|qla1280_intr_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;qla1280&quot;
comma
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qla1280 : Failed to reserve interrupt %d already &quot;
l_string|&quot;in use&bslash;n&quot;
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
r_goto
id|error_release_region
suffix:semicolon
)brace
multiline_comment|/* load the F/W, read paramaters, and init the H/W */
r_if
c_cond
(paren
id|qla1280_initialize_adapter
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1x160: Failed to initialize adapter&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_free_irq
suffix:semicolon
)brace
multiline_comment|/* set our host ID  (need to do something about our two IDs) */
id|host-&gt;this_id
op_assign
id|ha-&gt;bus_settings
(braket
l_int|0
)braket
dot
id|id
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|host
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x020600
id|error
op_assign
id|scsi_add_host
c_func
(paren
id|host
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|error_disable_adapter
suffix:semicolon
id|scsi_scan_host
c_func
(paren
id|host
)paren
suffix:semicolon
macro_line|#else
id|scsi_set_pci_device
c_func
(paren
id|host
comma
id|pdev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x020600
id|error_disable_adapter
suffix:colon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|error_free_irq
suffix:colon
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|ha
)paren
suffix:semicolon
id|error_release_region
suffix:colon
macro_line|#if MEMORY_MAPPED_IO
id|iounmap
c_func
(paren
id|ha-&gt;mmpbase
)paren
suffix:semicolon
macro_line|#else
id|release_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
)paren
suffix:semicolon
macro_line|#endif
id|error_free_response_ring
suffix:colon
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
(paren
(paren
id|RESPONSE_ENTRY_CNT
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
r_struct
id|response
)paren
)paren
)paren
comma
id|ha-&gt;response_ring
comma
id|ha-&gt;response_dma
)paren
suffix:semicolon
id|error_free_request_ring
suffix:colon
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
(paren
(paren
id|REQUEST_ENTRY_CNT
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
id|request_t
)paren
)paren
)paren
comma
id|ha-&gt;request_ring
comma
id|ha-&gt;request_dma
)paren
suffix:semicolon
id|error_put_host
suffix:colon
id|scsi_host_put
c_func
(paren
id|host
)paren
suffix:semicolon
id|error_disable_device
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|error
suffix:colon
r_return
id|error
suffix:semicolon
)brace
r_static
r_void
id|__devexit
DECL|function|qla1280_remove_one
id|qla1280_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x020600
id|scsi_remove_host
c_func
(paren
id|host
)paren
suffix:semicolon
macro_line|#endif
id|WRT_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|ha
)paren
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
id|iounmap
c_func
(paren
id|ha-&gt;mmpbase
)paren
suffix:semicolon
macro_line|#else
id|release_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
)paren
suffix:semicolon
macro_line|#endif
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
(paren
(paren
id|REQUEST_ENTRY_CNT
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
id|request_t
)paren
)paren
)paren
comma
id|ha-&gt;request_ring
comma
id|ha-&gt;request_dma
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
(paren
(paren
id|RESPONSE_ENTRY_CNT
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
r_struct
id|response
)paren
)paren
)paren
comma
id|ha-&gt;response_ring
comma
id|ha-&gt;response_dma
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= 0x020600
DECL|variable|qla1280_pci_driver
r_static
r_struct
id|pci_driver
id|qla1280_pci_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;qla1280&quot;
comma
dot
id|id_table
op_assign
id|qla1280_pci_tbl
comma
dot
id|probe
op_assign
id|qla1280_probe_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|qla1280_remove_one
)paren
comma
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|qla1280_init
id|qla1280_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|srb
)paren
OG
r_sizeof
(paren
r_struct
id|scsi_pointer
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: struct srb too big, aborting&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/*&n;&t; * If we are called as a module, the qla1280 pointer may not be null&n;&t; * and it would point to our bootup string, just like on the lilo&n;&t; * command line.  IF not NULL, then process this config string with&n;&t; * qla1280_setup&n;&t; *&n;&t; * Boot time Options&n;&t; * To add options at boot time add a line to your lilo.conf file like:&n;&t; * append=&quot;qla1280=verbose,max_tags:{{255,255,255,255},{255,255,255,255}}&quot;&n;&t; * which will result in the first four devices on the first two&n;&t; * controllers being set to a tagged queue depth of 32.&n;&t; */
r_if
c_cond
(paren
id|qla1280
)paren
id|qla1280_setup
c_func
(paren
id|qla1280
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pci_module_init
c_func
(paren
op_amp
id|qla1280_pci_driver
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|qla1280_exit
id|qla1280_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|qla1280_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|qla1280_init
id|module_init
c_func
(paren
id|qla1280_init
)paren
suffix:semicolon
DECL|variable|qla1280_exit
id|module_exit
c_func
(paren
id|qla1280_exit
)paren
suffix:semicolon
macro_line|#else
DECL|macro|driver_template
macro_line|# define driver_template qla1280_driver_template
macro_line|# include &quot;scsi_module.c&quot;
macro_line|#endif
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Qlogic &amp; Jes Sorensen&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Qlogic ISP SCSI (qla1x80/qla1x160) driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|QLA1280_VERSION
id|MODULE_VERSION
c_func
(paren
id|QLA1280_VERSION
)paren
suffix:semicolon
multiline_comment|/*&n; * Overrides for Emacs so that we almost follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-basic-offset: 8&n; * tab-width: 8&n; * End:&n; */
eof
