multiline_comment|/******************************************************************************&n;*                  QLOGIC LINUX SOFTWARE&n;*&n;* QLogic  QLA1280 (Ultra2)  and  QLA12160 (Ultra3) SCSI driver&n;* Copyright (C) 2000 Qlogic Corporation (www.qlogic.com)&n;* Copyright (C) 2001-2002 Jes Sorensen, Wild Open Source Inc.&n;*&n;* This program is free software; you can redistribute it and/or modify it&n;* under the terms of the GNU General Public License as published by the&n;* Free Software Foundation; either version 2, or (at your option) any&n;* later version.&n;*&n;* This program is distributed in the hope that it will be useful, but&n;* WITHOUT ANY WARRANTY; without even the implied warranty of&n;* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n;* General Public License for more details.&n;*&n;******************************************************************************/
DECL|macro|QLA1280_VERSION
mdefine_line|#define QLA1280_VERSION      &quot;3.23.19 Beta&quot;
multiline_comment|/******************************************************************************&n;    Revision History:&n;    Rev  3.23.19 Beta April 11, 2002, Linus Torvalds&n;&t;- Do qla1280_pci_config() before calling request_irq() and&n;&t;  request_region()&n;&t;- Use pci_dma_hi32() to handle upper word of DMA addresses instead&n;&t;  of large shifts&n;&t;- Hand correct arguments to free_irq() in case of failure&n;    Rev  3.23.18 Beta April 11, 2002, Jes Sorensen&n;&t;- Run source through Lindent and clean up the output&n;    Rev  3.23.17 Beta April 11, 2002, Jes Sorensen&n;&t;- Update SCSI firmware to qla1280 v8.15.00 and qla12160 v10.04.32&n;    Rev  3.23.16 Beta March 19, 2002, Jes Sorensen&n;&t;- Rely on mailbox commands generating interrupts - do not&n;&t;  run qla1280_isr() from ql1280_mailbox_command()&n;&t;- Remove device_reg_t&n;&t;- Integrate ql12160_set_target_parameters() with 1280 version&n;&t;- Make qla1280_setup() non static&n;&t;- Do not call qla1280_check_for_dead_scsi_bus() on every I/O request&n;&t;  sent to the card - this command pauses the firmare!!!&n;    Rev  3.23.15 Beta March 19, 2002, Jes Sorensen&n;&t;- Clean up qla1280.h - remove obsolete QL_DEBUG_LEVEL_x definitions&n;&t;- Remove a pile of pointless and confusing (srb_t **) and&n;&t;  (scsi_lu_t *) typecasts&n;&t;- Explicit mark that we do not use the new error handling (for now)&n;&t;- Remove scsi_qla_host_t and use &squot;struct&squot; instead&n;&t;- Remove in_abort, watchdog_enabled, dpc, dpc_sched, bios_enabled,&n;&t;  pci_64bit_slot flags which weren&squot;t used for anything anyway&n;&t;- Grab host-&gt;host_lock while calling qla1280_isr() from abort()&n;&t;- Use spin_lock()/spin_unlock() in qla1280_intr_handler() - we&n;&t;  do not need to save/restore flags in the interrupt handler&n;&t;- Enable interrupts early (before any mailbox access) in preparation&n;&t;  for cleaning up the mailbox handling&n;    Rev  3.23.14 Beta March 14, 2002, Jes Sorensen&n;&t;- Further cleanups. Remove all trace of QL_DEBUG_LEVEL_x and replace&n;&t;  it with proper use of dprintk().&n;&t;- Make qla1280_print_scsi_cmd() and qla1280_dump_buffer() both take&n;&t;  a debug level argument to determine if data is to be printed&n;&t;- Add KERN_* info to printk()&n;    Rev  3.23.13 Beta March 14, 2002, Jes Sorensen&n;&t;- Significant cosmetic cleanups&n;&t;- Change debug code to use dprintk() and remove #if mess&n;    Rev  3.23.12 Beta March 13, 2002, Jes Sorensen&n;&t;- More cosmetic cleanups, fix places treating return as function&n;&t;- use cpu_relax() in qla1280_debounce_register()&n;    Rev  3.23.11 Beta March 13, 2002, Jes Sorensen&n;&t;- Make it compile under 2.5.5&n;    Rev  3.23.10 Beta October 1, 2001, Jes Sorensen&n;&t;- Do no typecast short * to long * in QL1280BoardTbl, this&n;&t;  broke miserably on big endian boxes&n;    Rev  3.23.9 Beta September 30, 2001, Jes Sorensen&n;&t;- Remove pre 2.2 hack for checking for reentrance in interrupt handler&n;&t;- Make data types used to receive from SCSI_{BUS,TCN,LUN}_32&n;&t;  unsigned int to match the types from struct scsi_cmnd&n;    Rev  3.23.8 Beta September 29, 2001, Jes Sorensen&n;&t;- Remove bogus timer_t typedef from qla1280.h&n;&t;- Remove obsolete pre 2.2 PCI setup code, use proper #define&squot;s&n;&t;  for PCI_ values, call pci_set_master()&n;&t;- Fix memleak of qla1280_buffer on module unload&n;&t;- Only compile module parsing code #ifdef MODULE - should be&n;&t;  changed to use individual MODULE_PARM&squot;s later&n;&t;- Remove dummy_buffer that was never modified nor printed&n;&t;- ENTER()/LEAVE() are noops unless QL_DEBUG_LEVEL_3, hence remove&n;&t;  #ifdef QL_DEBUG_LEVEL_3/#endif around ENTER()/LEAVE() calls&n;&t;- Remove &bslash;r from print statements, this is Linux, not DOS&n;&t;- Remove obsolete QLA1280_{SCSILU,INTR,RING}_{LOCK,UNLOCK}&n;&t;  dummy macros&n;&t;- Remove C++ compile hack in header file as Linux driver are not&n;&t;  supposed to be compiled as C++&n;&t;- Kill MS_64BITS macro as it makes the code more readable&n;&t;- Remove unnecessary flags.in_interrupts bit&n;    Rev  3.23.7 Beta August 20, 2001, Jes Sorensen&n;&t;- Dont&squot; check for set flags on q-&gt;q_flag one by one in qla1280_next()&n;        - Check whether the interrupt was generated by the QLA1280 before&n;          doing any processing&n;&t;- qla1280_status_entry(): Only zero out part of sense_buffer that&n;&t;  is not being copied into&n;&t;- Remove more superflouous typecasts&n;&t;- qla1280_32bit_start_scsi() replace home-brew memcpy() with memcpy()&n;    Rev  3.23.6 Beta August 20, 2001, Tony Luck, Intel&n;        - Don&squot;t walk the entire list in qla1280_putq_t() just to directly&n;&t;  grab the pointer to the last element afterwards&n;    Rev  3.23.5 Beta August 9, 2001, Jes Sorensen&n;&t;- Don&squot;t use SA_INTERRUPT, it&squot;s use is deprecated for this kinda driver&n;    Rev  3.23.4 Beta August 8, 2001, Jes Sorensen&n;&t;- Set dev-&gt;max_sectors to 1024&n;    Rev  3.23.3 Beta August 6, 2001, Jes Sorensen&n;&t;- Provide compat macros for pci_enable_device(), pci_find_subsys()&n;&t;  and scsi_set_pci_device()&n;&t;- Call scsi_set_pci_device() for all devices&n;&t;- Reduce size of kernel version dependant device probe code&n;&t;- Move duplicate probe/init code to seperate function&n;&t;- Handle error if qla1280_mem_alloc() fails&n;&t;- Kill OFFSET() macro and use Linux&squot;s PCI definitions instead&n;        - Kill private structure defining PCI config space (struct config_reg)&n;&t;- Only allocate I/O port region if not in MMIO mode&n;&t;- Remove duplicate (unused) sanity check of sife of srb_t&n;    Rev  3.23.2 Beta August 6, 2001, Jes Sorensen&n;&t;- Change home-brew memset() implementations to use memset()&n;        - Remove all references to COMTRACE() - accessing a PC&squot;s COM2 serial&n;          port directly is not legal under Linux.&n;    Rev  3.23.1 Beta April 24, 2001, Jes Sorensen&n;        - Remove pre 2.2 kernel support&n;        - clean up 64 bit DMA setting to use 2.4 API (provide backwards compat)&n;        - Fix MMIO access to use readl/writel instead of directly&n;          dereferencing pointers&n;        - Nuke MSDOS debugging code&n;        - Change true/false data types to int from uint8_t&n;        - Use int for counters instead of uint8_t etc.&n;        - Clean up size &amp; byte order conversion macro usage&n;    Rev  3.23 Beta January 11, 2001 BN Qlogic&n;        - Added check of device_id when handling non&n;          QLA12160s during detect().&n;    Rev  3.22 Beta January 5, 2001 BN Qlogic&n;        - Changed queue_task() to schedule_task()&n;          for kernels 2.4.0 and higher.&n;          Note: 2.4.0-testxx kernels released prior to&n;                the actual 2.4.0 kernel release on January 2001&n;                will get compile/link errors with schedule_task().&n;                Please update your kernel to released 2.4.0 level,&n;                or comment lines in this file flagged with  3.22&n;                to resolve compile/link error of schedule_task().&n;        - Added -DCONFIG_SMP in addition to -D__SMP__&n;          in Makefile for 2.4.0 builds of driver as module.&n;    Rev  3.21 Beta January 4, 2001 BN Qlogic&n;        - Changed criteria of 64/32 Bit mode of HBA&n;          operation according to BITS_PER_LONG rather&n;          than HBA&squot;s NVRAM setting of &gt;4Gig memory bit;&n;          so that the HBA auto-configures without the need&n;          to setup each system individually.&n;    Rev  3.20 Beta December 5, 2000 BN Qlogic&n;        - Added priority handling to IA-64  onboard SCSI&n;          ISP12160 chip for kernels greater than 2.3.18.&n;        - Added irqrestore for qla1280_intr_handler.&n;        - Enabled /proc/scsi/qla1280 interface.&n;        - Clear /proc/scsi/qla1280 counters in detect().&n;    Rev  3.19 Beta October 13, 2000 BN Qlogic&n;        - Declare driver_template for new kernel&n;          (2.4.0 and greater) scsi initialization scheme.&n;        - Update /proc/scsi entry for 2.3.18 kernels and&n;          above as qla1280&n;    Rev  3.18 Beta October 10, 2000 BN Qlogic&n;        - Changed scan order of adapters to map&n;          the QLA12160 followed by the QLA1280.&n;    Rev  3.17 Beta September 18, 2000 BN Qlogic&n;        - Removed warnings for 32 bit 2.4.x compiles&n;        - Corrected declared size for request and response&n;          DMA addresses that are kept in each ha&n;    Rev. 3.16 Beta  August 25, 2000   BN  Qlogic&n;        - Corrected 64 bit addressing issue on IA-64&n;          where the upper 32 bits were not properly&n;          passed to the RISC engine.&n;    Rev. 3.15 Beta  August 22, 2000   BN  Qlogic&n;        - Modified qla1280_setup_chip to properly load&n;          ISP firmware for greater that 4 Gig memory on IA-64&n;    Rev. 3.14 Beta  August 16, 2000   BN  Qlogic&n;        - Added setting of dma_mask to full 64 bit&n;          if flags.enable_64bit_addressing is set in NVRAM&n;    Rev. 3.13 Beta  August 16, 2000   BN  Qlogic&n;        - Use new PCI DMA mapping APIs for 2.4.x kernel&n;    Rev. 3.12       July 18, 2000    Redhat &amp; BN Qlogic&n;        - Added check of pci_enable_device to detect() for 2.3.x&n;        - Use pci_resource_start() instead of&n;          pdev-&gt;resource[0].start in detect() for 2.3.x&n;        - Updated driver version&n;    Rev. 3.11       July 14, 2000    BN  Qlogic&n;&t;- Updated SCSI Firmware to following versions:&n;&t;  qla1x80:   8.13.08&n;&t;  qla1x160:  10.04.08&n;&t;- Updated driver version to 3.11&n;    Rev. 3.10    June 23, 2000   BN Qlogic&n;        - Added filtering of AMI SubSys Vendor ID devices&n;    Rev. 3.9&n;        - DEBUG_QLA1280 undefined and  new version  BN Qlogic&n;    Rev. 3.08b      May 9, 2000    MD Dell&n;        - Added logic to check against AMI subsystem vendor ID&n;&t;Rev. 3.08       May 4, 2000    DG  Qlogic&n;        - Added logic to check for PCI subsystem ID.&n;&t;Rev. 3.07       Apr 24, 2000    DG &amp; BN  Qlogic&n;&t;   - Updated SCSI Firmware to following versions:&n;&t;     qla12160:   10.01.19&n;&t;&t; qla1280:     8.09.00&n;&t;Rev. 3.06       Apr 12, 2000    DG &amp; BN  Qlogic&n;&t;   - Internal revision; not released&n;    Rev. 3.05       Mar 28, 2000    DG &amp; BN  Qlogic&n;       - Edit correction for virt_to_bus and PROC.&n;    Rev. 3.04       Mar 28, 2000    DG &amp; BN  Qlogic&n;       - Merge changes from ia64 port.&n;    Rev. 3.03       Mar 28, 2000    BN  Qlogic&n;       - Increase version to reflect new code drop with compile fix&n;         of issue with inclusion of linux/spinlock for 2.3 kernels&n;    Rev. 3.02       Mar 15, 2000    BN  Qlogic&n;       - Merge qla1280_proc_info from 2.10 code base&n;    Rev. 3.01       Feb 10, 2000    BN  Qlogic&n;       - Corrected code to compile on a 2.2.x kernel.&n;    Rev. 3.00       Jan 17, 2000    DG  Qlogic&n;&t;   - Added 64-bit support.&n;    Rev. 2.07       Nov 9, 1999     DG  Qlogic&n;&t;   - Added new routine to set target parameters for ISP12160.&n;    Rev. 2.06       Sept 10, 1999     DG  Qlogic&n;       - Added support for ISP12160 Ultra 3 chip.&n;    Rev. 2.03       August 3, 1999    Fred Lewis, Intel DuPont&n;&t;- Modified code to remove errors generated when compiling with&n;&t;  Cygnus IA64 Compiler.&n;        - Changed conversion of pointers to unsigned longs instead of integers.&n;        - Changed type of I/O port variables from uint32_t to unsigned long.&n;        - Modified OFFSET macro to work with 64-bit as well as 32-bit.&n;        - Changed sprintf and printk format specifiers for pointers to %p.&n;        - Changed some int to long type casts where needed in sprintf &amp; printk.&n;        - Added l modifiers to sprintf and printk format specifiers for longs.&n;        - Removed unused local variables.&n;    Rev. 1.20       June 8, 1999      DG,  Qlogic&n;         Changes to support RedHat release 6.0 (kernel 2.2.5).&n;       - Added SCSI exclusive access lock (io_request_lock) when accessing&n;         the adapter.&n;       - Added changes for the new LINUX interface template. Some new error&n;         handling routines have been added to the template, but for now we&n;         will use the old ones.&n;    -   Initial Beta Release.&n;*****************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#ifndef KERNEL_VERSION
DECL|macro|KERNEL_VERSION
mdefine_line|#define KERNEL_VERSION(x,y,z) (((x)&lt;&lt;16)+((y)&lt;&lt;8)+(z))
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,18)
macro_line|#include &lt;linux/pci_ids.h&gt;
macro_line|#endif
macro_line|#include &quot;sd.h&quot;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
DECL|macro|UNIQUE_FW_NAME
mdefine_line|#define UNIQUE_FW_NAME
macro_line|#include &quot;qla1280.h&quot;
macro_line|#include &quot;ql12160_fw.h&quot;&t;&t;/* ISP RISC codes */
macro_line|#include &quot;ql1280_fw.h&quot;
multiline_comment|/*&n; * Compile time Options:&n; *            0 - Disable and 1 - Enable&n; */
DECL|macro|QL1280_TARGET_MODE_SUPPORT
mdefine_line|#define  QL1280_TARGET_MODE_SUPPORT    0&t;/* Target mode support */
DECL|macro|QL1280_LUN_SUPPORT
mdefine_line|#define  QL1280_LUN_SUPPORT            0
DECL|macro|WATCHDOGTIMER
mdefine_line|#define  WATCHDOGTIMER                 0
DECL|macro|MEMORY_MAPPED_IO
mdefine_line|#define  MEMORY_MAPPED_IO              0
DECL|macro|DEBUG_QLA1280_INTR
mdefine_line|#define  DEBUG_QLA1280_INTR            0
DECL|macro|USE_NVRAM_DEFAULTS
mdefine_line|#define  USE_NVRAM_DEFAULTS&t;       0
DECL|macro|DEBUG_PRINT_NVRAM
mdefine_line|#define  DEBUG_PRINT_NVRAM             0
DECL|macro|LOADING_RISC_ACTIVITY
mdefine_line|#define  LOADING_RISC_ACTIVITY         0
DECL|macro|AUTO_ESCALATE_RESET
mdefine_line|#define  AUTO_ESCALATE_RESET           0&t;/* Automatically escalate resets */
DECL|macro|AUTO_ESCALATE_ABORT
mdefine_line|#define  AUTO_ESCALATE_ABORT           0&t;/* Automatically escalate aborts */
DECL|macro|STOP_ON_ERROR
mdefine_line|#define  STOP_ON_ERROR                 0&t;/* Stop on aborts and resets  */
DECL|macro|STOP_ON_RESET
mdefine_line|#define  STOP_ON_RESET                 0
DECL|macro|STOP_ON_ABORT
mdefine_line|#define  STOP_ON_ABORT                 0
DECL|macro|QLA1280_PROFILE
mdefine_line|#define  QLA1280_PROFILE               1&t;/* 3.20 */
DECL|macro|DEBUG_QLA1280
mdefine_line|#define  DEBUG_QLA1280                 0
multiline_comment|/*&n; * Missing PCI ID&squot;s&n; */
macro_line|#ifndef PCI_DEVICE_ID_QLOGIC_ISP1080
DECL|macro|PCI_DEVICE_ID_QLOGIC_ISP1080
mdefine_line|#define PCI_DEVICE_ID_QLOGIC_ISP1080&t;0x1080
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_QLOGIC_ISP1240
DECL|macro|PCI_DEVICE_ID_QLOGIC_ISP1240
mdefine_line|#define PCI_DEVICE_ID_QLOGIC_ISP1240&t;0x1240
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_QLOGIC_ISP1280
DECL|macro|PCI_DEVICE_ID_QLOGIC_ISP1280
mdefine_line|#define PCI_DEVICE_ID_QLOGIC_ISP1280&t;0x1280
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_QLOGIC_ISP10160
DECL|macro|PCI_DEVICE_ID_QLOGIC_ISP10160
mdefine_line|#define PCI_DEVICE_ID_QLOGIC_ISP10160&t;0x1016
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_QLOGIC_ISP12160
DECL|macro|PCI_DEVICE_ID_QLOGIC_ISP12160
mdefine_line|#define PCI_DEVICE_ID_QLOGIC_ISP12160&t;0x1216
macro_line|#endif
macro_line|#ifndef PCI_VENDOR_ID_AMI
DECL|macro|PCI_VENDOR_ID_AMI
mdefine_line|#define PCI_VENDOR_ID_AMI               0x101e
macro_line|#endif
macro_line|#if (BITS_PER_LONG == 64) || defined CONFIG_HIGHMEM
DECL|macro|QLA_64BIT_PTR
mdefine_line|#define QLA_64BIT_PTR&t;1
macro_line|#endif
multiline_comment|/* 3.16 */
macro_line|#ifdef QLA_64BIT_PTR
DECL|macro|pci_dma_lo32
mdefine_line|#define pci_dma_lo32(a)&t;&t;(a &amp; 0xffffffff)
DECL|macro|pci_dma_hi32
mdefine_line|#define pci_dma_hi32(a)&t;&t;(a &gt;&gt; 32)
macro_line|#else
DECL|macro|pci_dma_lo32
mdefine_line|#define pci_dma_lo32(a)&t;&t;(a &amp; 0xffffffff)
DECL|macro|pci_dma_hi32
mdefine_line|#define pci_dma_hi32(a)&t;&t;0
macro_line|#endif
DECL|macro|NVRAM_DELAY
mdefine_line|#define NVRAM_DELAY()&t;&t;udelay(500)&t;/* 2 microsecond delay */
DECL|macro|CACHE_FLUSH
mdefine_line|#define CACHE_FLUSH(a)&t;&t;RD_REG_WORD(a)
DECL|macro|INVALID_HANDLE
mdefine_line|#define INVALID_HANDLE&t;&t;(MAX_OUTSTANDING_COMMANDS + 1)
multiline_comment|/*&n; * Compat macros&n; */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2, 4, 0)
DECL|macro|pci_set_dma_mask
mdefine_line|#define pci_set_dma_mask(dev, mask)&t;&t;dev-&gt;dma_mask = mask;
DECL|macro|pci_present
mdefine_line|#define pci_present()&t;&t;&t;&t;pcibios_present()
DECL|macro|pci_enable_device
mdefine_line|#define pci_enable_device(pdev)&t;&t;&t;0
DECL|macro|pci_find_subsys
mdefine_line|#define pci_find_subsys(id, dev, sid, sdev, pdev) pci_find_device(id,dev,pdev)
DECL|macro|scsi_set_pci_device
mdefine_line|#define scsi_set_pci_device(host, pdev)
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,18)
DECL|typedef|dma_addr_t
r_typedef
r_int
r_int
id|dma_addr_t
suffix:semicolon
r_static
r_inline
r_void
op_star
DECL|function|pci_alloc_consistent
id|pci_alloc_consistent
c_func
(paren
r_struct
id|pci_dev
op_star
id|hwdev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
)paren
(brace
r_void
op_star
id|virt_ptr
suffix:semicolon
id|virt_ptr
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|virt_ptr
)paren
r_return
l_int|NULL
suffix:semicolon
op_star
id|dma_handle
op_assign
id|virt_to_bus
c_func
(paren
id|virt_ptr
)paren
suffix:semicolon
r_return
id|virt_ptr
suffix:semicolon
)brace
DECL|macro|pci_free_consistent
mdefine_line|#define pci_free_consistent(cookie, size, ptr, dma_ptr)&t;kfree(ptr)
DECL|macro|pci_map_single
mdefine_line|#define pci_map_single(cookie, address, size, dir)&t;virt_to_bus(address)
DECL|macro|pci_map_sg
mdefine_line|#define pci_map_sg(cookie, scatter, ents, dir)&t;&t;ents
DECL|macro|pci_unmap_single
mdefine_line|#define pci_unmap_single(cookie, address, size, dir)
DECL|macro|pci_unmap_sg
mdefine_line|#define pci_unmap_sg(cookie, scatter, ents, dir)
DECL|macro|pci_resource_start
mdefine_line|#define pci_resource_start(dev, i)&t;&t;&t;dev-&gt;base_address[i]
macro_line|#endif
multiline_comment|/*&n; *  QLogic Driver Support Function Prototypes.&n; */
r_static
r_void
id|qla1280_done
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|srb_t
op_star
op_star
comma
id|srb_t
op_star
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_next
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|scsi_lu_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|qla1280_putq_t
c_func
(paren
id|scsi_lu_t
op_star
comma
id|srb_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_done_q_put
c_func
(paren
id|srb_t
op_star
comma
id|srb_t
op_star
op_star
comma
id|srb_t
op_star
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_device_queue_depth
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|Scsi_Device
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_select_queue_depth
c_func
(paren
r_struct
id|Scsi_Host
op_star
comma
id|Scsi_Device
op_star
)paren
suffix:semicolon
macro_line|#if STOP_ON_ERROR
r_static
r_void
id|qla1280_panic
c_func
(paren
r_char
op_star
comma
r_struct
id|Scsi_Host
op_star
id|host
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|qla1280_abort_queue_single
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
comma
r_int
comma
r_int
comma
r_uint32
)paren
suffix:semicolon
r_static
r_int
id|qla1280_return_status
c_func
(paren
id|sts_entry_t
op_star
id|sts
comma
id|Scsi_Cmnd
op_star
id|cp
)paren
suffix:semicolon
r_static
r_void
id|qla1280_removeq
c_func
(paren
id|scsi_lu_t
op_star
id|q
comma
id|srb_t
op_star
id|sp
)paren
suffix:semicolon
r_static
r_void
id|qla1280_mem_free
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
suffix:semicolon
r_void
id|qla1280_do_dpc
c_func
(paren
r_void
op_star
id|p
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_static
r_char
op_star
id|qla1280_get_token
c_func
(paren
r_char
op_star
comma
r_char
op_star
)paren
suffix:semicolon
macro_line|#endif
r_static
r_inline
r_void
id|qla1280_enable_intrs
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|qla1280_disable_intrs
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; *  QLogic ISP1280 Hardware Support Function Prototypes.&n; */
r_static
r_int
id|qla1280_initialize_adapter
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
suffix:semicolon
r_static
r_int
id|qla1280_enable_tgt
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla1280_isp_firmware
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_pci_config
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_chip_diag
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_setup_chip
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_init_rings
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_nvram_config
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_mailbox_command
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_uint8
comma
r_uint16
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_bus_reset
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla1280_device_reset
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla1280_abort_device
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla1280_abort_command
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|srb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_abort_isp
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_64bit_start_scsi
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|srb_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_32bit_start_scsi
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|srb_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_nv_write
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_uint16
)paren
suffix:semicolon
r_static
r_void
id|qla1280_poll
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_reset_adapter
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_marker
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
comma
r_int
comma
r_int
comma
id|u8
)paren
suffix:semicolon
r_static
r_void
id|qla1280_isp_cmd
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_isr
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|srb_t
op_star
op_star
comma
id|srb_t
op_star
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_rst_aen
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_status_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|sts_entry_t
op_star
comma
id|srb_t
op_star
op_star
comma
id|srb_t
op_star
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_error_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|response_t
op_star
comma
id|srb_t
op_star
op_star
comma
id|srb_t
op_star
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_restart_queues
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_abort_queues
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_uint16
id|qla1280_get_nvram_word
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_uint32
)paren
suffix:semicolon
r_static
r_uint16
id|qla1280_nvram_request
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_uint32
)paren
suffix:semicolon
r_static
r_uint16
id|qla1280_debounce_register
c_func
(paren
r_volatile
r_uint16
op_star
)paren
suffix:semicolon
r_static
id|request_t
op_star
id|qla1280_req_pkt
c_func
(paren
r_struct
id|scsi_qla_host
op_star
)paren
suffix:semicolon
r_static
r_int
id|qla1280_check_for_dead_scsi_bus
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|qla1280_mem_alloc
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
suffix:semicolon
r_static
r_void
id|qla12160_get_target_parameters
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_uint32
comma
r_uint32
comma
r_uint32
)paren
suffix:semicolon
macro_line|#if QL1280_LUN_SUPPORT
r_static
r_void
id|qla1280_enable_lun
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if QL1280_TARGET_MODE_SUPPORT
r_static
r_void
id|qla1280_notify_ack
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|notify_entry_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_immed_notify
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|notify_entry_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_accept_io
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|ctio_ret_entry_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_64bit_continue_io
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|atio_entry_t
op_star
comma
r_uint32
comma
id|paddr32_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_32bit_continue_io
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|atio_entry_t
op_star
comma
r_uint32
comma
id|paddr32_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_atio_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|atio_entry_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_notify_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
comma
id|notify_entry_t
op_star
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* QLA1280_TARGET_MODE_SUPPORT */
macro_line|#ifdef QL_DEBUG_ROUTINES
multiline_comment|/*&n; *  Driver Debug Function Prototypes.&n; */
r_static
id|u8
id|qla1280_getbyte
c_func
(paren
id|u8
op_star
)paren
suffix:semicolon
r_static
id|u16
id|qla1280_getword
c_func
(paren
id|u16
op_star
)paren
suffix:semicolon
r_static
id|u32
id|qla1280_getdword
c_func
(paren
id|u32
op_star
)paren
suffix:semicolon
r_static
r_void
id|qla1280_putbyte
c_func
(paren
id|u8
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
r_void
id|qla1280_putword
c_func
(paren
id|u16
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
r_void
id|qla1280_putdword
c_func
(paren
id|u32
op_star
comma
id|u32
)paren
suffix:semicolon
r_static
r_void
id|__qla1280_print_scsi_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
suffix:semicolon
r_static
r_void
id|__qla1280_dump_buffer
c_func
(paren
r_char
op_star
comma
id|u32
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * insmod needs to find the variable and make it point to something&n; */
macro_line|#ifdef MODULE
DECL|variable|options
r_static
r_char
op_star
id|options
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* insmod qla1280 options=verbose&quot; */
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,18)
multiline_comment|/*&n; * Our directory Entry in /proc/scsi for the user to&n; * access the driver.&n; */
multiline_comment|/* Need to add in proc_fs.h     PROC_SCSI_QL1280 */
DECL|macro|PROC_SCSI_QL1280
mdefine_line|#define PROC_SCSI_QL1280  PROC_SCSI_QLOGICISP
DECL|variable|proc_scsi_qla1280
r_struct
id|proc_dir_entry
id|proc_scsi_qla1280
op_assign
(brace
id|PROC_SCSI_QL1280
comma
l_int|7
comma
l_string|&quot;qla1280&quot;
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* We use the Scsi_Pointer structure that&squot;s included with each command&n; * SCSI_Cmnd as a scratchpad for our SRB.&n; *&n; * SCp will always point to the SRB structure (defined in qla1280.h).&n; * It is define as follows:&n; *  - SCp.ptr  -- &gt; pointer back to the cmd&n; *  - SCp.this_residual --&gt; used as forward pointer to next srb&n; *  - SCp.buffer --&gt; used as backward pointer to next srb&n; *  - SCp.buffers_residual --&gt; used as flags field&n; *  - SCp.have_data_in --&gt; not used&n; *  - SCp.sent_command --&gt; not used&n; *  - SCp.phase --&gt; not used&n; */
DECL|macro|CMD_SP
mdefine_line|#define&t;CMD_SP(Cmnd)&t;&t;&amp;Cmnd-&gt;SCp
DECL|macro|CMD_CDBLEN
mdefine_line|#define&t;CMD_CDBLEN(Cmnd)&t;Cmnd-&gt;cmd_len
DECL|macro|CMD_CDBP
mdefine_line|#define&t;CMD_CDBP(Cmnd)&t;&t;Cmnd-&gt;cmnd
DECL|macro|CMD_SNSP
mdefine_line|#define&t;CMD_SNSP(Cmnd)&t;&t;Cmnd-&gt;sense_buffer
DECL|macro|CMD_SNSLEN
mdefine_line|#define&t;CMD_SNSLEN(Cmnd)&t;sizeof(Cmnd-&gt;sense_buffer)
DECL|macro|CMD_RESULT
mdefine_line|#define&t;CMD_RESULT(Cmnd)&t;Cmnd-&gt;result
DECL|macro|CMD_HANDLE
mdefine_line|#define&t;CMD_HANDLE(Cmnd)&t;Cmnd-&gt;host_scribble
multiline_comment|/*****************************************/
multiline_comment|/*   ISP Boards supported by this driver */
multiline_comment|/*****************************************/
DECL|macro|NUM_OF_ISP_DEVICES
mdefine_line|#define NUM_OF_ISP_DEVICES&t;6
DECL|struct|qla_boards
r_struct
id|qla_boards
(brace
DECL|member|bdName
r_int
r_char
id|bdName
(braket
l_int|9
)braket
suffix:semicolon
multiline_comment|/* Board ID String */
DECL|member|device_id
r_int
r_int
id|device_id
suffix:semicolon
multiline_comment|/* Device PCI ID   */
DECL|member|numPorts
r_int
id|numPorts
suffix:semicolon
multiline_comment|/* Number of SCSI ports */
DECL|member|fwcode
r_int
r_int
op_star
id|fwcode
suffix:semicolon
multiline_comment|/* pointer to FW array         */
DECL|member|fwlen
r_int
r_int
op_star
id|fwlen
suffix:semicolon
multiline_comment|/* number of words in array    */
DECL|member|fwstart
r_int
r_int
op_star
id|fwstart
suffix:semicolon
multiline_comment|/* start address for F/W       */
DECL|member|fwver
r_int
r_char
op_star
id|fwver
suffix:semicolon
multiline_comment|/* Ptr to F/W version array    */
)brace
suffix:semicolon
DECL|variable|ql1280_board_tbl
r_struct
id|qla_boards
id|ql1280_board_tbl
(braket
id|NUM_OF_ISP_DEVICES
)braket
op_assign
(brace
multiline_comment|/* Name ,  Board PCI Device ID,         Number of ports */
(brace
l_string|&quot;QLA12160 &quot;
comma
id|PCI_DEVICE_ID_QLOGIC_ISP12160
comma
l_int|2
comma
op_amp
id|fw12160i_code01
(braket
l_int|0
)braket
comma
op_amp
id|fw12160i_length01
comma
op_amp
id|fw12160i_addr01
comma
op_amp
id|fw12160i_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA1080 &quot;
comma
id|PCI_DEVICE_ID_QLOGIC_ISP1080
comma
l_int|1
comma
op_amp
id|fw1280ei_code01
(braket
l_int|0
)braket
comma
op_amp
id|fw1280ei_length01
comma
op_amp
id|fw1280ei_addr01
comma
op_amp
id|fw1280ei_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA1240 &quot;
comma
id|PCI_DEVICE_ID_QLOGIC_ISP1240
comma
l_int|2
comma
op_amp
id|fw1280ei_code01
(braket
l_int|0
)braket
comma
op_amp
id|fw1280ei_length01
comma
op_amp
id|fw1280ei_addr01
comma
op_amp
id|fw1280ei_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA1280 &quot;
comma
id|PCI_DEVICE_ID_QLOGIC_ISP1280
comma
l_int|2
comma
op_amp
id|fw1280ei_code01
(braket
l_int|0
)braket
comma
op_amp
id|fw1280ei_length01
comma
op_amp
id|fw1280ei_addr01
comma
op_amp
id|fw1280ei_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;QLA10160 &quot;
comma
id|PCI_DEVICE_ID_QLOGIC_ISP10160
comma
l_int|1
comma
op_amp
id|fw12160i_code01
(braket
l_int|0
)braket
comma
op_amp
id|fw12160i_length01
comma
op_amp
id|fw12160i_addr01
comma
op_amp
id|fw12160i_version_str
(braket
l_int|0
)braket
)brace
comma
(brace
l_string|&quot;        &quot;
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|qla1280_verbose
r_static
r_int
id|qla1280_verbose
op_assign
l_int|1
suffix:semicolon
DECL|variable|qla1280_hostlist
r_static
r_struct
id|scsi_qla_host
op_star
id|qla1280_hostlist
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if QLA1280_PROFILE
DECL|variable|qla1280_buffer_size
r_static
r_int
id|qla1280_buffer_size
op_assign
l_int|0
suffix:semicolon
DECL|variable|qla1280_buffer
r_static
r_char
op_star
id|qla1280_buffer
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
macro_line|#if DEBUG_QLA1280
DECL|variable|ql_debug_print
r_static
r_int
id|ql_debug_print
op_assign
l_int|1
suffix:semicolon
DECL|variable|debug_buff
r_char
id|debug_buff
(braket
l_int|80
)braket
suffix:semicolon
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)&t;x
DECL|variable|ql_debug_level
r_static
r_int
id|ql_debug_level
op_assign
l_int|0
suffix:semicolon
DECL|macro|dprintk
mdefine_line|#define dprintk(level, format, a...)&t;&bslash;&n;&t;if ((ql_debug_level &gt;= level) &amp;&amp; ql_debug_print) printk(KERN_DEBUG format, ##a)
DECL|macro|qla1280_dump_buffer
mdefine_line|#define qla1280_dump_buffer(level, buf, size)&t;&bslash;&n;&t;if (ql_debug_level &gt;= level) __qla1280_dump_buffer(buf, size)
DECL|macro|qla1280_dump_print_cmd
mdefine_line|#define qla1280_dump_print_cmd(level, cmd)&t;&bslash;&n;&t;if (ql_debug_level &gt;= level) __qla1280_print_scsi_cmd(cmd)
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)
DECL|macro|ql_debug_level
mdefine_line|#define ql_debug_level&t;&t;&t;0
DECL|macro|dprintk
mdefine_line|#define dprintk(level, format, a...)&t;do{}while(0)
DECL|macro|qla1280_dump_buffer
mdefine_line|#define qla1280_dump_buffer(a, b, c)&t;do{}while(0)
DECL|macro|qla1280_print_scsi_cmd
mdefine_line|#define qla1280_print_scsi_cmd(a, b)&t;do{}while(0)
macro_line|#endif
DECL|macro|ENTER
mdefine_line|#define ENTER(x)&t;&t;dprintk(3, &quot;qla1280 : Entering %s()&bslash;n&quot;, x);
DECL|macro|LEAVE
mdefine_line|#define LEAVE(x)&t;&t;dprintk(3, &quot;qla1280 : Leaving %s()&bslash;n&quot;, x);
DECL|macro|ENTER_INTR
mdefine_line|#define ENTER_INTR(x)&t;&t;dprintk(3, &quot;qla1280 : Entering %s()&bslash;n&quot;, x);
DECL|macro|LEAVE_INTR
mdefine_line|#define LEAVE_INTR(x)&t;&t;dprintk(3, &quot;qla1280 : Leaving %s()&bslash;n&quot;, x);
DECL|macro|SCSI_BUS_32
mdefine_line|#define SCSI_BUS_32(scp)&t;scp-&gt;channel
DECL|macro|SCSI_TCN_32
mdefine_line|#define SCSI_TCN_32(scp)&t;scp-&gt;target
DECL|macro|SCSI_LUN_32
mdefine_line|#define SCSI_LUN_32(scp)&t;scp-&gt;lun
multiline_comment|/****************************************************************************/
multiline_comment|/*  LINUX -  Loadable Module Functions.                                     */
multiline_comment|/****************************************************************************/
multiline_comment|/*************************************************************************&n; *   qla1280_set_info&n; *&n; * Description:&n; *   Set parameters for the driver from the /proc filesystem.&n; *&n; * Returns:&n; *************************************************************************/
r_int
DECL|function|qla1280_set_info
id|qla1280_set_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
id|length
comma
r_struct
id|Scsi_Host
op_star
id|HBAptr
)paren
(brace
r_return
op_minus
id|ENOSYS
suffix:semicolon
multiline_comment|/* Currently this is a no-op */
)brace
multiline_comment|/*************************************************************************&n; * qla1280_proc_info&n; *&n; * Description:&n; *   Return information to handle /proc support for the driver.&n; *&n; * buffer - ptrs to a page buffer&n; *&n; * Returns:&n; *************************************************************************/
DECL|macro|PROC_BUF
mdefine_line|#define&t;PROC_BUF&t;&amp;qla1280_buffer[len]
r_int
DECL|function|qla1280_proc_info
id|qla1280_proc_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|inout
)paren
(brace
macro_line|#if QLA1280_PROFILE
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_int
id|size
op_assign
l_int|0
suffix:semicolon
id|scsi_lu_t
op_star
id|up
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_struct
id|qla_boards
op_star
id|bdp
suffix:semicolon
r_uint32
id|b
comma
id|t
comma
id|l
suffix:semicolon
id|host
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Find the host that was specified */
r_for
c_loop
(paren
id|ha
op_assign
id|qla1280_hostlist
suffix:semicolon
(paren
id|ha
op_ne
l_int|NULL
)paren
op_logical_and
id|ha-&gt;host-&gt;host_no
op_ne
id|hostno
suffix:semicolon
id|ha
op_assign
id|ha-&gt;next
)paren
suffix:semicolon
multiline_comment|/* if host wasn&squot;t found then exit */
r_if
c_cond
(paren
op_logical_neg
id|ha
)paren
(brace
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Can&squot;t find adapter for host &quot;
l_string|&quot;number %d&bslash;n&quot;
comma
id|hostno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|length
)paren
(brace
r_return
id|size
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|host
op_assign
id|ha-&gt;host
suffix:semicolon
r_if
c_cond
(paren
id|inout
op_eq
id|TRUE
)paren
(brace
multiline_comment|/* Has data been written to the file? */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280_proc: has data been written to the file.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|qla1280_set_info
c_func
(paren
id|buffer
comma
id|length
comma
id|host
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * if our old buffer is the right size use it otherwise&n;&t; * allocate a new one.&n;&t; */
r_if
c_cond
(paren
id|qla1280_buffer_size
op_ne
id|PAGE_SIZE
)paren
(brace
multiline_comment|/* deallocate this buffer and get a new one */
r_if
c_cond
(paren
id|qla1280_buffer
op_ne
l_int|NULL
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|qla1280_buffer
)paren
suffix:semicolon
id|qla1280_buffer_size
op_assign
l_int|0
suffix:semicolon
)brace
id|qla1280_buffer
op_assign
(paren
r_char
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qla1280_buffer
op_eq
l_int|NULL
)paren
(brace
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;qla1280 - kmalloc error at line %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
multiline_comment|/* save the size of our buffer */
id|qla1280_buffer_size
op_assign
id|PAGE_SIZE
suffix:semicolon
multiline_comment|/* 3.20 clear the buffer we use for proc display */
id|memset
c_func
(paren
id|qla1280_buffer
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* start building the print buffer */
id|bdp
op_assign
op_amp
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;QLogic PCI to SCSI Adapter for ISP 1280/12160:&bslash;n&quot;
l_string|&quot;        Firmware version: %2d.%02d.%02d, Driver version %s&bslash;n&quot;
comma
id|bdp-&gt;fwver
(braket
l_int|0
)braket
comma
id|bdp-&gt;fwver
(braket
l_int|1
)braket
comma
id|bdp-&gt;fwver
(braket
l_int|2
)braket
comma
id|QLA1280_VERSION
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;SCSI Host Adapter Information: %s&bslash;n&quot;
comma
id|bdp-&gt;bdName
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Request Queue = 0x%p, Response Queue = 0x%p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|ha-&gt;request_dma
comma
(paren
r_void
op_star
)paren
id|ha-&gt;response_dma
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Request Queue count= 0x%x, Response &quot;
l_string|&quot;Queue count= 0x%x&bslash;n&quot;
comma
id|REQUEST_ENTRY_CNT
comma
id|RESPONSE_ENTRY_CNT
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Number of pending commands = 0x%lx&bslash;n&quot;
comma
id|ha-&gt;actthreads
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Number of queued commands = 0x%lx&bslash;n&quot;
comma
id|ha-&gt;qthreads
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;Number of free request entries = %d&bslash;n&quot;
comma
id|ha-&gt;req_q_cnt
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* 1       */
id|len
op_add_assign
id|size
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;SCSI device Information:&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
multiline_comment|/* scan for all equipment stats */
r_for
c_loop
(paren
id|b
op_assign
l_int|0
suffix:semicolon
id|b
OL
id|MAX_BUSES
suffix:semicolon
id|b
op_increment
)paren
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|MAX_TARGETS
suffix:semicolon
id|t
op_increment
)paren
(brace
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
id|MAX_LUNS
suffix:semicolon
id|l
op_increment
)paren
(brace
id|up
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|b
comma
id|t
comma
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
id|up
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
multiline_comment|/* unused device/lun */
r_if
c_cond
(paren
id|up-&gt;io_cnt
op_eq
l_int|0
op_logical_or
id|up-&gt;io_cnt
OL
l_int|2
)paren
r_continue
suffix:semicolon
multiline_comment|/* total reads since boot */
multiline_comment|/* total writes since boot */
multiline_comment|/* total requests since boot  */
id|size
op_assign
id|sprintf
(paren
id|PROC_BUF
comma
l_string|&quot;(%2d:%2d:%2d): Total reqs %ld,&quot;
comma
id|b
comma
id|t
comma
id|l
comma
id|up-&gt;io_cnt
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
multiline_comment|/* current number of pending requests */
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot; Pend reqs %d,&quot;
comma
id|up-&gt;q_outcnt
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
macro_line|#if 0
multiline_comment|/* avg response time */
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot; Avg resp time %ld%%,&quot;
comma
(paren
id|up-&gt;resp_time
op_div
id|up-&gt;io_cnt
)paren
op_star
l_int|100
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
multiline_comment|/* avg active time */
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot; Avg active time %ld%%&bslash;n&quot;
comma
(paren
id|up-&gt;act_time
op_div
id|up-&gt;io_cnt
)paren
op_star
l_int|100
)paren
suffix:semicolon
macro_line|#else
id|size
op_assign
id|sprintf
c_func
(paren
id|PROC_BUF
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|len
op_add_assign
id|size
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_ge
id|qla1280_buffer_size
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_ge
id|qla1280_buffer_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Overflow buffer in qla1280_proc.c&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|offset
OG
id|len
op_minus
l_int|1
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|qla1280_buffer
)paren
suffix:semicolon
id|qla1280_buffer
op_assign
l_int|NULL
suffix:semicolon
id|qla1280_buffer_size
op_assign
id|length
op_assign
l_int|0
suffix:semicolon
op_star
id|start
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
op_star
id|start
op_assign
op_amp
id|qla1280_buffer
(braket
id|offset
)braket
suffix:semicolon
multiline_comment|/* Start of wanted data */
r_if
c_cond
(paren
id|len
op_minus
id|offset
OL
id|length
)paren
(brace
id|length
op_assign
id|len
op_minus
id|offset
suffix:semicolon
)brace
)brace
r_return
id|length
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/**************************************************************************&n; * qla1280_do_device_init&n; *    This routine will register the device with the SCSI subsystem,&n; *    initialize the host adapter structure and call the device init&n; *    routines.&n; *&n; * Input:&n; *     pdev      - pointer to struct pci_dev for adapter&n; *     template  - pointer to SCSI template&n; *     devnum    - the device number&n; *     bdp       - pointer to struct _qlaboards&n; *     num_hosts - the host number&n; *&n; * Returns:&n; *  host - pointer to SCSI host structure&n; **************************************************************************/
r_struct
id|Scsi_Host
op_star
DECL|function|qla1280_do_device_init
id|qla1280_do_device_init
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|Scsi_Host_Template
op_star
r_template
comma
r_int
id|devnum
comma
r_struct
id|qla_boards
op_star
id|bdp
comma
r_int
id|num_hosts
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_struct
id|device_reg
op_star
id|reg
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;qla1x160: Initializing ISP12160 on PCI bus %i, dev %i&bslash;n&quot;
comma
id|pdev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
)paren
suffix:semicolon
id|host
op_assign
id|scsi_register
c_func
(paren
r_template
comma
r_sizeof
(paren
r_struct
id|scsi_qla_host
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Failed to register host, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|scsi_set_pci_device
c_func
(paren
id|host
comma
id|pdev
)paren
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
multiline_comment|/* Clear our data area */
id|memset
c_func
(paren
id|ha
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scsi_qla_host
)paren
)paren
suffix:semicolon
multiline_comment|/* Sanitize the information from PCI BIOS.  */
id|host-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|ha-&gt;pci_bus
op_assign
id|pdev-&gt;bus-&gt;number
suffix:semicolon
id|ha-&gt;pci_device_fn
op_assign
id|pdev-&gt;devfn
suffix:semicolon
id|ha-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|ha-&gt;device_id
op_assign
id|bdp-&gt;device_id
suffix:semicolon
id|ha-&gt;devnum
op_assign
id|devnum
suffix:semicolon
multiline_comment|/* specifies microcode load address */
r_if
c_cond
(paren
id|qla1280_mem_alloc
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1x160: Failed to get memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|ha-&gt;ports
op_assign
id|bdp-&gt;numPorts
suffix:semicolon
multiline_comment|/* following needed for all cases of OS versions */
id|ha-&gt;host
op_assign
id|host
suffix:semicolon
id|ha-&gt;host_no
op_assign
id|host-&gt;host_no
suffix:semicolon
id|host-&gt;can_queue
op_assign
l_int|0xfffff
suffix:semicolon
multiline_comment|/* unlimited  */
id|host-&gt;cmd_per_lun
op_assign
l_int|1
suffix:semicolon
id|host-&gt;select_queue_depths
op_assign
id|qla1280_select_queue_depth
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,18)
id|host-&gt;base
op_assign
(paren
r_int
r_char
op_star
)paren
id|ha-&gt;mmpbase
suffix:semicolon
macro_line|#else
id|host-&gt;base
op_assign
(paren
r_int
r_int
)paren
id|ha-&gt;mmpbase
suffix:semicolon
macro_line|#endif
id|host-&gt;max_channel
op_assign
id|bdp-&gt;numPorts
op_minus
l_int|1
suffix:semicolon
id|host-&gt;max_lun
op_assign
id|MAX_LUNS
op_minus
l_int|1
suffix:semicolon
id|host-&gt;max_id
op_assign
id|MAX_TARGETS
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,7)
id|host-&gt;max_sectors
op_assign
l_int|1024
suffix:semicolon
macro_line|#endif
id|ha-&gt;instance
op_assign
id|num_hosts
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|ha-&gt;instance
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_pci_config
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1x160: Unable to configure PCI&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_mem_alloced
suffix:semicolon
)brace
multiline_comment|/* Disable ISP interrupts. */
id|qla1280_disable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Register the IRQ with Linux (sharable) */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|host-&gt;irq
comma
id|qla1280_intr_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;qla1280&quot;
comma
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qla1280 : Failed to reserve interrupt %d already &quot;
l_string|&quot;in use&bslash;n&quot;
comma
id|host-&gt;irq
)paren
suffix:semicolon
r_goto
id|error_mem_alloced
suffix:semicolon
)brace
macro_line|#if !MEMORY_MAPPED_IO
multiline_comment|/* Register the I/O space with Linux */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;qla1280 : Failed to reserve i/o region 0x%04lx-0x%04lx&quot;
l_string|&quot; already in use&bslash;n&quot;
comma
id|host-&gt;io_port
comma
id|host-&gt;io_port
op_plus
l_int|0xff
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|host-&gt;irq
comma
id|ha
)paren
suffix:semicolon
r_goto
id|error_mem_alloced
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
comma
l_string|&quot;qla1280&quot;
)paren
suffix:semicolon
macro_line|#endif
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* load the F/W, read paramaters, and init the H/W */
r_if
c_cond
(paren
id|qla1280_initialize_adapter
c_func
(paren
id|ha
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1x160:Failed to initialize adapter&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_mem_alloced
suffix:semicolon
)brace
multiline_comment|/* set our host ID  (need to do something about our two IDs) */
id|host-&gt;this_id
op_assign
id|ha-&gt;bus_settings
(braket
l_int|0
)braket
dot
id|id
suffix:semicolon
r_return
id|host
suffix:semicolon
id|error_mem_alloced
suffix:colon
id|qla1280_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|host
)paren
(brace
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * qla1280_detect&n; *    This routine will probe for Qlogic 1280 SCSI host adapters.&n; *    It returns the number of host adapters of a particular&n; *    type that were found.&t; It also initialize all data necessary for&n; *    the driver.  It is passed-in the host number, so that it&n; *    knows where its first entry is in the scsi_hosts[] array.&n; *&n; * Input:&n; *     template - pointer to SCSI template&n; *&n; * Returns:&n; *  num - number of host adapters found.&n; **************************************************************************/
r_int
DECL|function|qla1280_detect
id|qla1280_detect
c_func
(paren
id|Scsi_Host_Template
op_star
r_template
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_struct
id|scsi_qla_host
op_star
id|ha
comma
op_star
id|cur_ha
suffix:semicolon
r_struct
id|qla_boards
op_star
id|bdp
suffix:semicolon
r_uint16
id|subsys_vendor
comma
id|subsys_device
suffix:semicolon
r_int
id|num_hosts
op_assign
l_int|0
suffix:semicolon
r_int
id|devnum
op_assign
l_int|0
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_detect&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
id|srb_t
)paren
OG
r_sizeof
(paren
id|Scsi_Pointer
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280_detect: [WARNING] srb_t too big&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;DEBUG: qla1280_detect starts at address = %p&bslash;n&quot;
comma
id|qla1280_detect
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we are called as a module, the qla1280 pointer may not be null&n;&t; * and it would point to our bootup string, just like on the lilo&n;&t; * command line.  IF not NULL, then process this config string with&n;&t; * qla1280_setup&n;&t; *&n;&t; * Boot time Options&n;&t; * To add options at boot time add a line to your lilo.conf file like:&n;&t; * append=&quot;qla1280=verbose,max_tags:{{255,255,255,255},{255,255,255,255}}&quot;&n;&t; * which will result in the first four devices on the first two&n;&t; * controllers being set to a tagged queue depth of 32.&n;&t; */
r_if
c_cond
(paren
id|options
)paren
id|qla1280_setup
c_func
(paren
id|options
comma
l_int|NULL
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Please read the file /usr/src/linux/drivers&quot;
l_string|&quot;/scsi/README.qla1280&bslash;n&quot;
l_string|&quot;qla1280: to see the proper way to specify options to the qla1280 &quot;
l_string|&quot;module&bslash;n&quot;
l_string|&quot;qla1280: Specifically, don&squot;t use any commas when passing &quot;
l_string|&quot;arguments to&bslash;n&quot;
l_string|&quot;qla1280: insmod or else it might trash certain memory areas.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi: PCI not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bdp
op_assign
op_amp
id|ql1280_board_tbl
(braket
l_int|0
)braket
suffix:semicolon
id|qla1280_hostlist
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,18)
r_template
op_member_access_from_pointer
id|proc_dir
op_assign
op_amp
id|proc_scsi_qla1280
suffix:semicolon
macro_line|#else
r_template
op_member_access_from_pointer
id|proc_name
op_assign
l_string|&quot;qla1280&quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/* 3.20 */
multiline_comment|/* First Initialize QLA12160 on PCI Bus 1 Dev 2 */
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_subsys
c_func
(paren
id|PCI_VENDOR_ID_QLOGIC
comma
id|bdp-&gt;device_id
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|pdev
)paren
)paren
)paren
(brace
multiline_comment|/* find QLA12160 device on PCI bus=1 slot=2 */
r_if
c_cond
(paren
(paren
id|pdev-&gt;bus-&gt;number
op_ne
l_int|1
)paren
op_logical_or
(paren
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
op_ne
l_int|2
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Bypass all AMI SUBSYS VENDOR IDs */
r_if
c_cond
(paren
id|pdev-&gt;subsystem_vendor
op_eq
id|PCI_VENDOR_ID_AMI
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1x160: Skip AMI SubSys Vendor ID Chip&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_goto
id|find_devices
suffix:semicolon
id|host
op_assign
id|qla1280_do_device_init
c_func
(paren
id|pdev
comma
r_template
comma
id|devnum
comma
id|bdp
comma
id|num_hosts
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_continue
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
multiline_comment|/* this preferred device will always be the first one found */
id|cur_ha
op_assign
id|qla1280_hostlist
op_assign
id|ha
suffix:semicolon
id|num_hosts
op_increment
suffix:semicolon
)brace
id|find_devices
suffix:colon
id|pdev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Try and find each different type of adapter we support */
r_for
c_loop
(paren
id|devnum
op_assign
l_int|0
suffix:semicolon
id|bdp-&gt;device_id
op_ne
l_int|0
op_logical_and
id|devnum
OL
id|NUM_OF_ISP_DEVICES
suffix:semicolon
id|devnum
op_increment
comma
id|bdp
op_increment
)paren
(brace
multiline_comment|/* PCI_SUBSYSTEM_IDS supported */
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_subsys
c_func
(paren
id|PCI_VENDOR_ID_QLOGIC
comma
id|bdp-&gt;device_id
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|pdev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* found an adapter */
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,18)
id|subsys_vendor
op_assign
id|pdev-&gt;subsystem_vendor
suffix:semicolon
id|subsys_device
op_assign
id|pdev-&gt;subsystem_device
suffix:semicolon
macro_line|#else
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_SUBSYSTEM_VENDOR_ID
comma
op_amp
id|subsys_vendor
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_SUBSYSTEM_ID
comma
op_amp
id|subsys_device
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t;&t; * skip QLA12160 already initialized on&n;&t;&t;&t; * PCI Bus 1 Dev 2 since we already initialized&n;&t;&t;&t; * and presented it&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|bdp-&gt;device_id
op_eq
id|PCI_DEVICE_ID_QLOGIC_ISP12160
)paren
op_logical_and
(paren
id|pdev-&gt;bus-&gt;number
op_eq
l_int|1
)paren
op_logical_and
(paren
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
op_eq
l_int|2
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Bypass all AMI SUBSYS VENDOR IDs */
r_if
c_cond
(paren
id|subsys_vendor
op_eq
id|PCI_VENDOR_ID_AMI
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1x160: Skip AMI SubSys Vendor ID Chip&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1x160: Supported Device Found VID=%x &quot;
l_string|&quot;DID=%x SSVID=%x SSDID=%x&bslash;n&quot;
comma
id|pdev-&gt;vendor
comma
id|pdev-&gt;device
comma
id|subsys_vendor
comma
id|subsys_device
)paren
suffix:semicolon
id|host
op_assign
id|qla1280_do_device_init
c_func
(paren
id|pdev
comma
r_template
comma
id|devnum
comma
id|bdp
comma
id|num_hosts
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_continue
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_hostlist
op_eq
l_int|NULL
)paren
(brace
id|cur_ha
op_assign
id|qla1280_hostlist
op_assign
id|ha
suffix:semicolon
)brace
r_else
(brace
id|cur_ha
op_assign
id|qla1280_hostlist
suffix:semicolon
r_while
c_loop
(paren
id|cur_ha-&gt;next
op_ne
l_int|NULL
)paren
id|cur_ha
op_assign
id|cur_ha-&gt;next
suffix:semicolon
id|cur_ha-&gt;next
op_assign
id|ha
suffix:semicolon
)brace
id|num_hosts
op_increment
suffix:semicolon
)brace
multiline_comment|/* end of WHILE */
)brace
multiline_comment|/* end of FOR */
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_detect&quot;
)paren
suffix:semicolon
r_return
id|num_hosts
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_release&n; *   Free the passed in Scsi_Host memory structures prior to unloading the&n; *   module.&n; **************************************************************************/
r_int
DECL|function|qla1280_release
id|qla1280_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_release&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.online
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* turn-off interrupts on the card */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Detach interrupts */
r_if
c_cond
(paren
id|host-&gt;irq
)paren
id|free_irq
c_func
(paren
id|host-&gt;irq
comma
id|ha
)paren
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
r_if
c_cond
(paren
id|ha-&gt;mmpbase
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|ha-&gt;mmpbase
)paren
op_amp
id|PAGE_MASK
)paren
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* release io space registers  */
r_if
c_cond
(paren
id|host-&gt;io_port
)paren
id|release_region
c_func
(paren
id|host-&gt;io_port
comma
l_int|0xff
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* MEMORY_MAPPED_IO */
id|qla1280_mem_free
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_release&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_info&n; *     Return a string describing the driver.&n; **************************************************************************/
r_const
r_char
op_star
DECL|function|qla1280_info
id|qla1280_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_static
r_char
id|qla1280_scsi_name_buffer
(braket
l_int|125
)braket
suffix:semicolon
r_char
op_star
id|bp
suffix:semicolon
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_struct
id|qla_boards
op_star
id|bdp
suffix:semicolon
id|bp
op_assign
op_amp
id|qla1280_scsi_name_buffer
(braket
l_int|0
)braket
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|bdp
op_assign
op_amp
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
suffix:semicolon
id|memset
c_func
(paren
id|bp
comma
l_int|0
comma
r_sizeof
(paren
id|qla1280_scsi_name_buffer
)paren
)paren
suffix:semicolon
id|sprintf
(paren
id|bp
comma
l_string|&quot;QLogic %s PCI to SCSI Host Adapter: bus %d device %d irq %d&bslash;n&quot;
l_string|&quot;       Firmware version: %2d.%02d.%02d, Driver version %s&quot;
comma
op_amp
id|bdp-&gt;bdName
(braket
l_int|0
)braket
comma
id|ha-&gt;pci_bus
comma
(paren
id|ha-&gt;pci_device_fn
op_amp
l_int|0xf8
)paren
op_rshift
l_int|3
comma
id|host-&gt;irq
comma
id|bdp-&gt;fwver
(braket
l_int|0
)braket
comma
id|bdp-&gt;fwver
(braket
l_int|1
)braket
comma
id|bdp-&gt;fwver
(braket
l_int|2
)braket
comma
id|QLA1280_VERSION
)paren
suffix:semicolon
r_return
id|bp
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1200_queuecommand&n; *     Queue a command to the controller.&n; *&n; * Note:&n; * The mid-level driver tries to ensures that queuecommand never gets invoked&n; * concurrently with itself or the interrupt handler (although the&n; * interrupt handler may call this routine as part of request-completion&n; * handling).   Unfortunely, it sometimes calls the scheduler in interrupt&n; * context which is a big NO! NO!.&n; **************************************************************************/
r_int
DECL|function|qla1280_queuecommand
id|qla1280_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|fn
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
multiline_comment|/*ENTER(&quot;qla1280_queuecommand&quot;);&n;&t; */
id|host
op_assign
id|cmd-&gt;host
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
multiline_comment|/* send command to adapter */
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|sp-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|fn
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;flags
op_eq
l_int|0
)paren
(brace
multiline_comment|/* new command */
id|sp-&gt;flags
op_assign
l_int|0
suffix:semicolon
)brace
id|qla1280_print_scsi_cmd
c_func
(paren
l_int|5
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Generate LU queue on bus, target, LUN */
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|q
op_assign
(paren
id|scsi_lu_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scsi_lu
)paren
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
op_assign
id|q
suffix:semicolon
id|memset
c_func
(paren
id|q
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scsi_lu
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;Allocate new device queue 0x%p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|q
)paren
suffix:semicolon
)brace
r_else
(brace
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|qla1280_done_q_put
c_func
(paren
id|sp
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
multiline_comment|/* 3.22 */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,4,0)&t;/* 3.22 */
id|queue_task
c_func
(paren
op_amp
id|ha-&gt;run_qla_bh
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
macro_line|#else&t;&t;&t;&t;/* 3.22 */
id|schedule_task
c_func
(paren
op_amp
id|ha-&gt;run_qla_bh
)paren
suffix:semicolon
multiline_comment|/* 3.22 */
macro_line|#endif&t;&t;&t;&t;/* 3.22 */
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Set an invalid handle until we issue the command to ISP */
multiline_comment|/* then we will set the real handle value.                 */
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
id|INVALID_HANDLE
suffix:semicolon
multiline_comment|/* add the command to our queue */
id|ha-&gt;qthreads
op_increment
suffix:semicolon
id|qla1280_putq_t
c_func
(paren
id|q
comma
id|sp
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_QC: t=%x CDB=%x I/OSize=0x%x haQueueCount=0x%lx&bslash;n&quot;
comma
id|target
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;request_bufflen
comma
id|ha-&gt;qthreads
)paren
suffix:semicolon
multiline_comment|/* send command to adapter */
r_if
c_cond
(paren
id|q-&gt;q_outcnt
op_eq
l_int|0
)paren
id|qla1280_restart_queues
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/*LEAVE(&quot;qla1280_queuecommand&quot;); */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1200_abort&n; *     Abort the speciifed SCSI command(s).&n; **************************************************************************/
r_int
DECL|function|qla1280_abort
id|qla1280_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_int
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_int
id|return_status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|handle
suffix:semicolon
id|u16
id|data
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort&quot;
)paren
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|host
op_assign
id|cmd-&gt;host
suffix:semicolon
multiline_comment|/* Get the SCSI request ptr */
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|handle
op_assign
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi(%li): ABORT Command=0x%p, handle=0x%p&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
(paren
r_void
op_star
)paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|handle
)paren
suffix:semicolon
multiline_comment|/* Check for pending interrupts. */
r_if
c_cond
(paren
id|handle
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* we never got this command */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Aborting a NULL handle&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
multiline_comment|/* no action - we don&squot;t have command */
)brace
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;istatus
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The io_request_lock is held when the reset handler is called, hence&n;&t; * the interrupt handler cannot be running in parallel as it also&n;&t; * grabs the lock. No reason to play funny games with set_bit() in&n;&t; * order to test for interrupt handler entry as the driver used to&n;&t; * do here.&n;&t; * /Jes&n;&t; */
r_if
c_cond
(paren
id|data
op_amp
id|RISC_INT
)paren
(brace
multiline_comment|/* put any pending command in done queue */
id|qla1280_isr
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * This seems unnecessary, it&squot;s not used below! / Jes&n;&t; */
macro_line|#ifdef UNUSED
id|handle
op_assign
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Generate LU queue on bus, target, LUN */
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* No lun queue -- command must not be active */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280 (%d:%d:%d): No LUN queue for the &quot;
l_string|&quot;specified device&bslash;n&quot;
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
multiline_comment|/* no action - we don&squot;t have command */
)brace
macro_line|#if AUTO_ESCALATE_ABORT
r_if
c_cond
(paren
(paren
id|sp-&gt;flags
op_amp
id|SRB_ABORTED
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_abort: Abort escalayted - returning &quot;
l_string|&quot;SCSI_ABORT_SNOOZE.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|sp-&gt;flags
op_amp
id|SRB_ABORT_PENDING
)paren
)paren
(brace
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(): Command has a pending abort &quot;
l_string|&quot;message - ABORT_PENDING.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SCSI_ABORT_PENDING
suffix:semicolon
)brace
macro_line|#if STOP_ON_ABORT
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Scsi layer issued a ABORT command= 0x%p&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|qla1280_print_scsi_cmd
c_func
(paren
l_int|2
comma
id|cmd
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Normally, would would need to search our queue for the specified command&n;&t; * but; since our sp contains the cmd ptr, we can just remove it from our&n;&t; * LUN queue.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;flags
op_amp
id|SRB_SENT
)paren
)paren
(brace
id|found
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(): Command returned from queue &quot;
l_string|&quot;aborted.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Remove srb from SCSI LU queue. */
id|qla1280_removeq
c_func
(paren
id|q
comma
id|sp
)paren
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_ABORTED
suffix:semicolon
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|qla1280_done_q_put
c_func
(paren
id|sp
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* find the command in our active list */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sp
op_eq
id|ha-&gt;outstanding_cmds
(braket
id|i
)braket
)paren
(brace
id|found
op_increment
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280: RISC aborting command.&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_abort_command
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_ABORT_PENDING
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#if STOP_ON_ABORT
id|qla1280_panic
c_func
(paren
l_string|&quot;qla1280_abort&quot;
comma
id|ha-&gt;host
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|found
op_eq
l_int|0
)paren
id|return_status
op_assign
id|SCSI_ABORT_NOT_RUNNING
suffix:semicolon
multiline_comment|/* no action - we don&squot;t have command */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_abort: Aborted status returned = 0x%x.&bslash;n&quot;
comma
id|return_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;done_q_first
)paren
id|qla1280_done
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
r_if
c_cond
(paren
id|found
)paren
id|qla1280_restart_queues
c_func
(paren
id|ha
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort&quot;
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
)brace
r_int
DECL|function|qla1280_new_abort
id|qla1280_new_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
r_int
id|return_status
op_assign
id|SCSI_ABORT_SUCCESS
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|handle
suffix:semicolon
id|u16
id|data
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort&quot;
)paren
suffix:semicolon
id|host
op_assign
id|cmd-&gt;host
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
multiline_comment|/* Get the SCSI request ptr */
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|handle
op_assign
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi(%li): ABORT Command=0x%p, handle=0x%p&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|cmd
comma
id|handle
)paren
suffix:semicolon
multiline_comment|/* Check for pending interrupts. */
r_if
c_cond
(paren
id|handle
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* we never got this command */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Aborting a NULL handle&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
multiline_comment|/* no action - we don&squot;t have command */
)brace
id|spin_lock_irqsave
(paren
id|ha-&gt;host-&gt;host_lock
comma
id|cpu_flags
)paren
suffix:semicolon
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;istatus
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We grab the host lock in the interrupt handler to&n;&t; * prevent racing here.&n;&t; *&n;&t; * Then again, running the interrupt handler from here is somewhat&n;&t; * questionable.&n;&t; * /Jes&n;&t; */
r_if
c_cond
(paren
id|data
op_amp
id|RISC_INT
)paren
(brace
multiline_comment|/* put any pending command in done queue */
id|qla1280_isr
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
)brace
multiline_comment|/* Generate LU queue on bus, target, LUN */
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* No lun queue -- command must not be active */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280 (%d:%d:%d): No LUN queue for the &quot;
l_string|&quot;specified device&bslash;n&quot;
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
id|return_status
op_assign
id|SUCCESS
suffix:semicolon
multiline_comment|/* no action - we don&squot;t have command */
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sp-&gt;flags
op_amp
id|SRB_ABORT_PENDING
)paren
)paren
(brace
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(): Command has a pending abort &quot;
l_string|&quot;message - ABORT_PENDING.&bslash;n&quot;
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_ABORT_PENDING
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
macro_line|#if STOP_ON_ABORT
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Scsi layer issued a ABORT command= 0x%p&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|qla1280_print_scsi_cmd
c_func
(paren
l_int|2
comma
id|cmd
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Normally, would would need to search our queue for the specified command&n;&t; * but; since our sp contains the cmd ptr, we can just remove it from our&n;&t; * LUN queue.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp-&gt;flags
op_amp
id|SRB_SENT
)paren
)paren
(brace
id|found
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi(): Command returned from queue &quot;
l_string|&quot;aborted.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Remove srb from SCSI LU queue. */
id|qla1280_removeq
c_func
(paren
id|q
comma
id|sp
)paren
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_ABORTED
suffix:semicolon
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|qla1280_done_q_put
c_func
(paren
id|sp
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
id|return_status
op_assign
id|SUCCESS
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* find the command in our active list */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sp
op_eq
id|ha-&gt;outstanding_cmds
(braket
id|i
)braket
)paren
(brace
id|found
op_increment
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280: RISC aborting command.&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_abort_command
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
id|return_status
op_assign
id|SCSI_ABORT_PENDING
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#if STOP_ON_ABORT
id|qla1280_panic
c_func
(paren
l_string|&quot;qla1280_abort&quot;
comma
id|ha-&gt;host
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|found
op_eq
l_int|0
)paren
id|return_status
op_assign
id|SUCCESS
suffix:semicolon
multiline_comment|/* no action - we don&squot;t have the command */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_abort: Aborted status returned = 0x%x.&bslash;n&quot;
comma
id|return_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;done_q_first
)paren
id|qla1280_done
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
r_if
c_cond
(paren
id|found
)paren
id|qla1280_restart_queues
c_func
(paren
id|ha
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
id|ha-&gt;host-&gt;host_lock
comma
id|cpu_flags
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort&quot;
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * qla1200_reset&n; *    The reset function will reset the SCSI bus and abort any executing&n; *    commands.&n; *&n; * Input:&n; *      cmd = Linux SCSI command packet of the command that cause the&n; *            bus reset.&n; *      flags = SCSI bus reset option flags (see scsi.h)&n; *&n; * Returns:&n; *      DID_RESET in cmd.host_byte of aborted command(s)&n; *&n; * Note:&n; *      Resetting the bus always succeeds - is has to, otherwise the&n; *      kernel will panic! Try a surgical technique - sending a BUS&n; *      DEVICE RESET message - on the offending target before pulling&n; *      the SCSI bus reset line.&n; **************************************************************************/
r_int
DECL|function|qla1280_reset
id|qla1280_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_typedef
r_enum
(brace
id|ABORT_DEVICE
op_assign
l_int|1
comma
id|DEVICE_RESET
op_assign
l_int|2
comma
id|BUS_RESET
op_assign
l_int|3
comma
id|ADAPTER_RESET
op_assign
l_int|4
comma
id|RESET_DELAYED
op_assign
l_int|5
comma
id|FAIL
op_assign
l_int|6
)brace
id|action_t
suffix:semicolon
id|action_t
id|action
op_assign
id|ADAPTER_RESET
suffix:semicolon
id|u16
id|data
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_int
id|result
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_reset&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(): Resetting Cmnd=0x%p, Handle=0x%p, &quot;
l_string|&quot;flags=0x%x&bslash;n&quot;
comma
id|cmd
comma
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(scsi?:?:?:?) Reset called with NULL Scsi_Cmnd &quot;
l_string|&quot;pointer, failing.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SCSI_RESET_SNOOZE
suffix:semicolon
)brace
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|cmd-&gt;host-&gt;hostdata
suffix:semicolon
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
macro_line|#if STOP_ON_RESET
id|qla1280_panic
c_func
(paren
l_string|&quot;qla1280_reset&quot;
comma
id|ha-&gt;host
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Check for pending interrupts. */
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|ha-&gt;iobase-&gt;istatus
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The io_request_lock is held when the reset handler is called, hence&n;&t; * the interrupt handler cannot be running in parallel as it also&n;&t; * grabs the lock. /Jes&n;&t; */
r_if
c_cond
(paren
id|data
op_amp
id|RISC_INT
)paren
id|qla1280_isr
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Determine the suggested action that the mid-level driver wants&n;&t; * us to perform.&n;&t; */
r_if
c_cond
(paren
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t; * if mid-level driver called reset with a orphan SCSI_Cmnd&n;&t;&t; * (i.e. a command that&squot;s not pending), so perform the&n;&t;&t; * function specified.&n;&t;&t; */
r_if
c_cond
(paren
id|flags
op_amp
id|SCSI_RESET_SUGGEST_HOST_RESET
)paren
id|action
op_assign
id|ADAPTER_RESET
suffix:semicolon
r_else
id|action
op_assign
id|BUS_RESET
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Mid-level driver has called reset with this SCSI_Cmnd and&n;&t;&t; * its pending.&n;&t;&t; */
r_if
c_cond
(paren
id|flags
op_amp
id|SCSI_RESET_SUGGEST_HOST_RESET
)paren
id|action
op_assign
id|ADAPTER_RESET
suffix:semicolon
r_else
r_if
c_cond
(paren
id|flags
op_amp
id|SCSI_RESET_SUGGEST_BUS_RESET
)paren
id|action
op_assign
id|BUS_RESET
suffix:semicolon
r_else
id|action
op_assign
id|DEVICE_RESET
suffix:semicolon
)brace
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
macro_line|#if AUTO_ESCALATE_RESET
r_if
c_cond
(paren
(paren
id|action
op_amp
id|DEVICE_RESET
)paren
op_logical_and
(paren
id|q-&gt;q_flag
op_amp
id|QLA1280_QRESET
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280(%ld): Bus device reset already sent to &quot;
l_string|&quot;device, escalating.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|action
op_assign
id|BUS_RESET
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|action
op_amp
id|DEVICE_RESET
)paren
op_logical_and
(paren
id|sp-&gt;flags
op_amp
id|SRB_ABORT_PENDING
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280(%ld):Have already attempted to reach &quot;
l_string|&quot;device with abort device&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280(%ld):message, will escalate to BUS &quot;
l_string|&quot;RESET.&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|action
op_assign
id|BUS_RESET
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; *  By this point, we want to already know what we are going to do,&n;&t; *  so we only need to perform the course of action.&n;&t; */
id|result
op_assign
id|SCSI_RESET_ERROR
suffix:semicolon
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|FAIL
suffix:colon
r_break
suffix:semicolon
r_case
id|RESET_DELAYED
suffix:colon
id|result
op_assign
id|SCSI_RESET_PENDING
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ABORT_DEVICE
suffix:colon
id|ha-&gt;flags.in_reset
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld:%d:%d:%d): Queueing abort device &quot;
l_string|&quot;command.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
id|qla1280_abort_queue_single
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
comma
id|DID_ABORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_abort_device
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
op_eq
l_int|0
)paren
id|result
op_assign
id|SCSI_RESET_PENDING
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEVICE_RESET
suffix:colon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld:%d:%d:%d): Queueing device reset &quot;
l_string|&quot;command.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
id|ha-&gt;flags.in_reset
op_assign
id|TRUE
suffix:semicolon
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
id|MAX_LUNS
suffix:semicolon
id|lun
op_increment
)paren
id|qla1280_abort_queue_single
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
comma
id|DID_ABORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_device_reset
c_func
(paren
id|ha
comma
id|bus
comma
id|target
)paren
op_eq
l_int|0
)paren
id|result
op_assign
id|SCSI_RESET_PENDING
suffix:semicolon
id|q-&gt;q_flag
op_or_assign
id|QLA1280_QRESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUS_RESET
suffix:colon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280(%ld:%d:%d:%d): Issuing BUS &quot;
l_string|&quot;DEVICE RESET.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
id|ha-&gt;flags.in_reset
op_assign
id|TRUE
suffix:semicolon
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
id|MAX_TARGETS
suffix:semicolon
id|target
op_increment
)paren
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
id|MAX_LUNS
suffix:semicolon
id|lun
op_increment
)paren
id|qla1280_abort_queue_single
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
comma
id|DID_RESET
)paren
suffix:semicolon
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|bus
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * The bus reset routine returns all the outstanding commands&n;&t;&t; * back with &quot;DID_RESET&quot; in the status field after a short&n;&t;&t; * delay by the firmware. If the mid-level time out the SCSI&n;&t;&t; * reset before our delay we may need to ignore it.&n;&t;&t; */
multiline_comment|/* result = SCSI_RESET_PENDING | SCSI_RESET_BUS_RESET; */
id|result
op_assign
id|SCSI_RESET_SUCCESS
op_or
id|SCSI_RESET_BUS_RESET
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Wheeeee!!!&n;&t;&t; */
id|mdelay
c_func
(paren
l_int|4
op_star
l_int|1000
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|SCSI_RESET_SYNCHRONOUS
)paren
(brace
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
(paren
op_star
(paren
id|cmd
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* ha-&gt;reset_start = jiffies; */
r_break
suffix:semicolon
r_case
id|ADAPTER_RESET
suffix:colon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|qla1280_verbose
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld:%d:%d:%d): Issued an ADAPTER &quot;
l_string|&quot;RESET.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld:%d:%d:%d): I/O processing will &quot;
l_string|&quot;continue automatically.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
)brace
id|ha-&gt;flags.reset_active
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We restarted all of the commands automatically, so the&n;&t;&t; * mid-level code can expect completions momentitarily.&n;&t;&t; */
r_if
c_cond
(paren
id|qla1280_abort_isp
c_func
(paren
id|ha
)paren
op_eq
l_int|0
)paren
id|result
op_assign
id|SCSI_RESET_SUCCESS
op_or
id|SCSI_RESET_HOST_RESET
suffix:semicolon
id|ha-&gt;flags.reset_active
op_assign
id|FALSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;done_q_first
)paren
id|qla1280_done
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
id|qla1280_restart_queues
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ha-&gt;flags.in_reset
op_assign
id|FALSE
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;RESET returning %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_reset&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * qla1280_biosparam&n; *   Return the disk geometry for the given SCSI device.&n; **************************************************************************/
r_int
DECL|function|qla1280_biosparam
id|qla1280_biosparam
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
id|geom
(braket
)braket
)paren
(brace
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cylinders
OG
l_int|1024
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
multiline_comment|/* if (cylinders &gt; 1023)&n;&t;&t;   cylinders = 1023; */
)brace
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * qla1280_intr_handler&n; *   Handles the H/W interrupt&n; **************************************************************************/
r_void
DECL|function|qla1280_intr_handler
id|qla1280_intr_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_struct
id|device_reg
op_star
id|reg
suffix:semicolon
id|u16
id|data
suffix:semicolon
id|ENTER_INTR
(paren
l_string|&quot;qla1280_intr_handler&quot;
)paren
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|dev_id
suffix:semicolon
id|spin_lock
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
id|ha-&gt;isr_count
op_increment
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable our interrupt. */
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
multiline_comment|/* Check for pending interrupts. */
r_if
c_cond
(paren
id|data
op_amp
id|RISC_INT
)paren
(brace
id|qla1280_isr
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* spurious interrupts can happen legally */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;scsi(%ld): Spurious interrupt - ignoring&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ha-&gt;done_q_first
)paren
id|qla1280_done
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
id|ha-&gt;host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/* enable our interrupt. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
(paren
id|ISP_EN_INT
op_or
id|ISP_EN_RISC
)paren
)paren
suffix:semicolon
id|LEAVE_INTR
c_func
(paren
l_string|&quot;qla1280_intr_handler&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_do_dpc&n; *&n; * Description:&n; * This routine is a task that is schedule by the interrupt handler&n; * to perform the background processing for interrupts.  We put it&n; * on a task queue that is consumed whenever the scheduler runs; that&squot;s&n; * so you can do anything (i.e. put the process to sleep etc).  In fact, the&n; * mid-level tries to sleep when it reaches the driver threshold&n; * &quot;host-&gt;can_queue&quot;. This can cause a panic if we were in our interrupt&n; * code .&n; **************************************************************************/
r_void
DECL|function|qla1280_do_dpc
id|qla1280_do_dpc
c_func
(paren
r_void
op_star
id|p
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|p
suffix:semicolon
r_int
r_int
id|cpu_flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|ha-&gt;host-&gt;host_lock
comma
id|cpu_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.isp_abort_needed
)paren
id|qla1280_abort_isp
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.reset_marker
)paren
id|qla1280_rst_aen
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;done_q_first
)paren
id|qla1280_done
c_func
(paren
id|ha
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|ha-&gt;host-&gt;host_lock
comma
id|cpu_flags
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_device_queue_depth&n; *&n; * Description:&n; *   Determines the queue depth for a given device.  There are two ways&n; *   a queue depth can be obtained for a tagged queueing device.  One&n; *   way is the default queue depth which is determined by whether&n; *   If it is defined, then it is used&n; *   as the default queue depth.  Otherwise, we use either 4 or 8 as the&n; *   default queue depth (dependent on the number of hardware SCBs).&n; **************************************************************************/
r_static
r_void
DECL|function|qla1280_device_queue_depth
id|qla1280_device_queue_depth
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|p
comma
id|Scsi_Device
op_star
id|device
)paren
(brace
r_int
id|default_depth
op_assign
l_int|3
suffix:semicolon
r_int
id|bus
op_assign
id|device-&gt;channel
suffix:semicolon
r_int
id|target
op_assign
id|device-&gt;id
suffix:semicolon
id|device-&gt;queue_depth
op_assign
id|default_depth
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tagged_supported
op_logical_and
(paren
id|p-&gt;bus_settings
(braket
id|bus
)braket
dot
id|qtag_enables
op_amp
(paren
id|BIT_0
op_lshift
id|target
)paren
)paren
)paren
(brace
id|device-&gt;tagged_queue
op_assign
l_int|1
suffix:semicolon
id|device-&gt;current_tag
op_assign
l_int|0
suffix:semicolon
id|device-&gt;queue_depth
op_assign
id|p-&gt;bus_settings
(braket
id|bus
)braket
dot
id|hiwat
suffix:semicolon
multiline_comment|/* device-&gt;queue_depth = 20; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%li:%d:%d:%d): Enabled tagged queuing, &quot;
l_string|&quot;queue depth %d.&bslash;n&quot;
comma
id|p-&gt;host_no
comma
id|device-&gt;channel
comma
id|device-&gt;id
comma
id|device-&gt;lun
comma
id|device-&gt;queue_depth
)paren
suffix:semicolon
)brace
id|qla12160_get_target_parameters
c_func
(paren
id|p
comma
id|bus
comma
id|target
comma
id|device-&gt;lun
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   qla1280_select_queue_depth&n; *&n; *   Sets the queue depth for each SCSI device hanging off the input&n; *   host adapter.  We use a queue depth of 2 for devices that do not&n; *   support tagged queueing.&n; **************************************************************************/
r_static
r_void
DECL|function|qla1280_select_queue_depth
id|qla1280_select_queue_depth
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|Scsi_Device
op_star
id|scsi_devs
)paren
(brace
id|Scsi_Device
op_star
id|device
suffix:semicolon
r_struct
id|scsi_qla_host
op_star
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_select_queue_depth&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|device
op_assign
id|scsi_devs
suffix:semicolon
id|device
op_ne
l_int|NULL
suffix:semicolon
id|device
op_assign
id|device-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|device-&gt;host
op_eq
id|host
)paren
id|qla1280_device_queue_depth
(paren
id|ha
comma
id|device
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_devs
)paren
id|qla1280_check_for_dead_scsi_bus
c_func
(paren
id|ha
comma
id|scsi_devs-&gt;channel
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_select_queue_depth&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Driver Support Routines&n; */
multiline_comment|/*&n; * qla1280_done&n; *      Process completed commands.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      done_q_first = done queue first pointer.&n; *      done_q_last  = done queue last pointer.&n; */
r_static
r_void
DECL|function|qla1280_done
id|qla1280_done
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|srb_t
op_star
op_star
id|done_q_first
comma
id|srb_t
op_star
op_star
id|done_q_last
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_done&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|done_q_first
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* remove command from done list */
id|sp
op_assign
op_star
id|done_q_first
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|done_q_first
op_assign
id|sp-&gt;s_next
)paren
)paren
op_star
id|done_q_last
op_assign
l_int|NULL
suffix:semicolon
r_else
(paren
op_star
id|done_q_first
)paren
op_member_access_from_pointer
id|s_prev
op_assign
l_int|NULL
suffix:semicolon
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
multiline_comment|/* Decrement outstanding commands on device. */
r_if
c_cond
(paren
id|q-&gt;q_outcnt
)paren
id|q-&gt;q_outcnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;q_outcnt
OL
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|hiwat
)paren
(brace
id|q-&gt;q_flag
op_and_assign
op_complement
id|QLA1280_QBUSY
suffix:semicolon
)brace
id|q-&gt;io_cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;dir
op_amp
id|BIT_5
)paren
id|q-&gt;r_cnt
op_increment
suffix:semicolon
r_else
id|q-&gt;w_cnt
op_increment
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_rshift
l_int|16
)paren
)paren
(brace
r_case
id|DID_RESET
suffix:colon
id|q-&gt;q_flag
op_and_assign
op_complement
id|QLA1280_QRESET
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
l_int|0
comma
id|MK_SYNC_ID
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DID_ABORT
suffix:colon
id|sp-&gt;flags
op_and_assign
op_complement
id|SRB_ABORT_PENDING
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_ABORTED
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_TIMEOUT
)paren
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* 3.13   64 and 32 bit */
multiline_comment|/* Release memory used for this I/O */
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;S/G unmap_sg cmd=%p&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|pci_unmap_sg
c_func
(paren
id|ha-&gt;pdev
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;use_sg
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
)paren
(brace
multiline_comment|/*dprintk(1, &quot;No S/G unmap_single cmd=%x saved_dma_handle=%lx&bslash;n&quot;,&n;&t;&t;&t;  cmd, sp-&gt;saved_dma_handle); */
id|pci_unmap_single
c_func
(paren
id|ha-&gt;pdev
comma
id|sp-&gt;saved_dma_handle
comma
id|cmd-&gt;request_bufflen
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Call the mid-level driver interrupt handler */
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
l_int|NULL
suffix:semicolon
id|ha-&gt;actthreads
op_decrement
suffix:semicolon
(paren
op_star
(paren
id|cmd
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|cmd
)paren
suffix:semicolon
id|qla1280_next
c_func
(paren
id|ha
comma
id|q
comma
id|bus
)paren
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_done&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Translates a ISP error to a Linux SCSI error&n; */
r_static
r_int
DECL|function|qla1280_return_status
id|qla1280_return_status
c_func
(paren
id|sts_entry_t
op_star
id|sts
comma
id|Scsi_Cmnd
op_star
id|cp
)paren
(brace
r_int
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
macro_line|#if DEBUG_QLA1280_INTR
r_static
r_char
op_star
id|reason
(braket
)braket
op_assign
(brace
l_string|&quot;DID_OK&quot;
comma
l_string|&quot;DID_NO_CONNECT&quot;
comma
l_string|&quot;DID_BUS_BUSY&quot;
comma
l_string|&quot;DID_TIME_OUT&quot;
comma
l_string|&quot;DID_BAD_TARGET&quot;
comma
l_string|&quot;DID_ABORT&quot;
comma
l_string|&quot;DID_PARITY&quot;
comma
l_string|&quot;DID_ERROR&quot;
comma
l_string|&quot;DID_RESET&quot;
comma
l_string|&quot;DID_BAD_INTR&quot;
)brace
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DEBUG_QLA1280_INTR */
id|ENTER
c_func
(paren
l_string|&quot;qla1280_return_status&quot;
)paren
suffix:semicolon
macro_line|#if DEBUG_QLA1280_INTR
multiline_comment|/*&n;&t;  dprintk(1, &quot;qla1280_return_status: compl status = 0x%04x&bslash;n&quot;,&n;&t;  sts-&gt;comp_status);&n;&t;*/
macro_line|#endif
r_switch
c_cond
(paren
id|sts-&gt;comp_status
)paren
(brace
r_case
id|CS_COMPLETE
suffix:colon
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_INCOMPLETE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_BUS
)paren
)paren
id|host_status
op_assign
id|DID_NO_CONNECT
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_TARGET
)paren
)paren
id|host_status
op_assign
id|DID_BAD_TARGET
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_SENT_CDB
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_TRANSFERRED_DATA
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_STATUS
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|sts-&gt;state_flags
op_amp
id|SF_GOT_SENSE
)paren
)paren
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_RESET
suffix:colon
id|host_status
op_assign
id|DID_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_ABORTED
suffix:colon
id|host_status
op_assign
id|DID_ABORT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_TIMEOUT
suffix:colon
id|host_status
op_assign
id|DID_TIME_OUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_OVERRUN
suffix:colon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;Data overrun 0x%x&bslash;n&quot;
comma
id|sts-&gt;residual_length
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: response packet data&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|2
comma
(paren
r_char
op_star
)paren
id|sts
comma
id|RESPONSE_ENTRY_SIZE
)paren
suffix:semicolon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_DATA_UNDERRUN
suffix:colon
r_if
c_cond
(paren
(paren
id|cp-&gt;request_bufflen
op_minus
id|sts-&gt;residual_length
)paren
OL
id|cp-&gt;underflow
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi: Underflow detected - retrying &quot;
l_string|&quot;command.&bslash;n&quot;
)paren
suffix:semicolon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
)brace
r_else
id|host_status
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|host_status
op_assign
id|DID_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if DEBUG_QLA1280_INTR
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 ISP status: host status (%s) scsi status %x&bslash;n&quot;
comma
id|reason
(braket
id|host_status
)braket
comma
id|sts-&gt;scsi_status
)paren
suffix:semicolon
macro_line|#endif
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_return_status&quot;
)paren
suffix:semicolon
r_return
(paren
id|sts-&gt;scsi_status
op_amp
l_int|0xff
)paren
op_or
(paren
id|host_status
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_done_q_put&n; *      Place SRB command on done queue.&n; *&n; * Input:&n; *      sp           = srb pointer.&n; *      done_q_first = done queue first pointer.&n; *      done_q_last  = done queue last pointer.&n; */
r_static
r_void
DECL|function|qla1280_done_q_put
id|qla1280_done_q_put
c_func
(paren
id|srb_t
op_star
id|sp
comma
id|srb_t
op_star
op_star
id|done_q_first
comma
id|srb_t
op_star
op_star
id|done_q_last
)paren
(brace
id|ENTER
c_func
(paren
l_string|&quot;qla1280_put_done_q&quot;
)paren
suffix:semicolon
multiline_comment|/* Place block on done queue */
id|sp-&gt;s_next
op_assign
l_int|NULL
suffix:semicolon
id|sp-&gt;s_prev
op_assign
op_star
id|done_q_last
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|done_q_first
)paren
op_star
id|done_q_first
op_assign
id|sp
suffix:semicolon
r_else
(paren
op_star
id|done_q_last
)paren
op_member_access_from_pointer
id|s_next
op_assign
id|sp
suffix:semicolon
op_star
id|done_q_last
op_assign
id|sp
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_put_done_q&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_next&n; *      Retrieve and process next job in the queue.&n; *&n; * Input:&n; *      ha   = adapter block pointer.&n; *      q    = SCSI LU pointer.&n; *      bus  = SCSI bus number.&n; *      SCSI_LU_Qlock must be already obtained and no other locks.&n; *&n; * Output:&n; *      Releases SCSI_LU_Qupon exit.&n; */
r_static
r_void
DECL|function|qla1280_next
id|qla1280_next
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|scsi_lu_t
op_star
id|q
comma
r_int
id|bus
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
r_int
id|cnt
comma
id|status
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_next&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|sp
op_assign
id|q-&gt;q_first
)paren
op_ne
l_int|NULL
)paren
op_logical_and
multiline_comment|/* we have a queue pending */
multiline_comment|/* device not busy/suspended */
op_logical_neg
(paren
id|q-&gt;q_flag
op_amp
(paren
id|QLA1280_QBUSY
op_or
id|QLA1280_QSUSP
)paren
)paren
op_logical_and
op_logical_neg
id|ha-&gt;flags.abort_isp_active
)paren
(brace
multiline_comment|/* not resetting the adapter */
multiline_comment|/* Remove srb from SCSI LU queue. */
id|qla1280_removeq
c_func
(paren
id|q
comma
id|sp
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;starting request 0x%p&lt;-(0x%p)&bslash;n&quot;
comma
id|q
comma
id|sp
)paren
suffix:semicolon
(brace
multiline_comment|/* Set busy flag if reached high water mark. */
id|q-&gt;q_outcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;q_outcnt
op_ge
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|hiwat
)paren
id|q-&gt;q_flag
op_or_assign
id|QLA1280_QBUSY
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,18)
r_if
c_cond
(paren
id|ha-&gt;flags.enable_64bit_addressing
)paren
id|status
op_assign
id|qla1280_64bit_start_scsi
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_else
macro_line|#endif
id|status
op_assign
id|qla1280_32bit_start_scsi
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/* if couldn&squot;t start the request */
r_if
c_cond
(paren
id|q-&gt;q_outcnt
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Wait for 30 sec for command to be accepted. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|6000000
suffix:semicolon
id|cnt
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
macro_line|#if QLA_64BIT_PTR
r_if
c_cond
(paren
id|ha-&gt;flags.enable_64bit_addressing
)paren
id|status
op_assign
id|qla1280_64bit_start_scsi
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_else
macro_line|#endif
id|status
op_assign
id|qla1280_32bit_start_scsi
c_func
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
r_break
suffix:semicolon
multiline_comment|/* Go check for pending interrupts. */
id|qla1280_poll
c_func
(paren
id|ha
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* 10 */
)brace
r_if
c_cond
(paren
op_logical_neg
id|cnt
)paren
(brace
multiline_comment|/* Set timeout status */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|DID_TIME_OUT
op_lshift
l_int|16
suffix:semicolon
macro_line|#if WATCHDOGTIMER
multiline_comment|/* Remove command from watchdog queue. */
r_if
c_cond
(paren
id|sp-&gt;flags
op_amp
id|SRB_WATCHDOG
)paren
id|qla1280_timeout_remove
(paren
id|ha
comma
id|sp
)paren
suffix:semicolon
macro_line|#endif
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Call the mid-level driver interrupt handler */
(paren
op_star
(paren
id|sp-&gt;cmd
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;q_outcnt
)paren
id|q-&gt;q_outcnt
op_decrement
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Place request back on top of device queue. */
id|qla1280_putq_t
c_func
(paren
id|q
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;q_outcnt
)paren
id|q-&gt;q_outcnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;q_outcnt
OL
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|hiwat
)paren
id|q-&gt;q_flag
op_and_assign
op_complement
id|QLA1280_QBUSY
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_next&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_putq_t&n; *      Add the standard SCB job to the top of standard SCB commands.&n; *&n; * Input:&n; *      q  = SCSI LU pointer.&n; *      sp = srb pointer.&n; *      SCSI_LU_Qlock must be already obtained.&n; */
r_static
r_void
DECL|function|qla1280_putq_t
id|qla1280_putq_t
c_func
(paren
id|scsi_lu_t
op_star
id|q
comma
id|srb_t
op_star
id|sp
)paren
(brace
id|ENTER
c_func
(paren
l_string|&quot;qla1280_putq_t&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;Adding to device q=0x%p&lt;-(0x%p)sp&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|q
comma
(paren
r_void
op_star
)paren
id|sp
)paren
suffix:semicolon
id|sp-&gt;s_next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q-&gt;q_first
)paren
(brace
multiline_comment|/* If queue empty */
id|sp-&gt;s_prev
op_assign
l_int|NULL
suffix:semicolon
id|q-&gt;q_first
op_assign
id|sp
suffix:semicolon
id|q-&gt;q_last
op_assign
id|sp
suffix:semicolon
)brace
r_else
(brace
id|sp-&gt;s_prev
op_assign
id|q-&gt;q_last
suffix:semicolon
id|q-&gt;q_last-&gt;s_next
op_assign
id|sp
suffix:semicolon
id|q-&gt;q_last
op_assign
id|sp
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_putq_t&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_removeq&n; *      Function used to remove a command block from the&n; *      LU queue.&n; *&n; * Input:&n; *      q  = SCSI LU pointer.&n; *      sp = srb pointer.&n; *      SCSI_LU_Qlock must be already obtained.&n; */
r_static
r_void
DECL|function|qla1280_removeq
id|qla1280_removeq
c_func
(paren
id|scsi_lu_t
op_star
id|q
comma
id|srb_t
op_star
id|sp
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;Removing from device_q (0x%p)-&gt;(0x%p)&bslash;n&quot;
comma
id|q
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;s_prev
)paren
(brace
r_if
c_cond
(paren
(paren
id|sp-&gt;s_prev-&gt;s_next
op_assign
id|sp-&gt;s_next
)paren
op_ne
l_int|NULL
)paren
id|sp-&gt;s_next-&gt;s_prev
op_assign
id|sp-&gt;s_prev
suffix:semicolon
r_else
id|q-&gt;q_last
op_assign
id|sp-&gt;s_prev
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|q-&gt;q_first
op_assign
id|sp-&gt;s_next
)paren
)paren
id|q-&gt;q_last
op_assign
l_int|NULL
suffix:semicolon
r_else
id|q-&gt;q_first-&gt;s_prev
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;* qla1280_mem_alloc&n;*      Allocates adapter memory.&n;*&n;* Returns:&n;*      0  = success.&n;*      1  = failure.&n;*/
r_static
r_int
DECL|function|qla1280_mem_alloc
id|qla1280_mem_alloc
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_int
id|status
op_assign
l_int|1
suffix:semicolon
id|dma_addr_t
id|dma_handle
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_mem_alloc&quot;
)paren
suffix:semicolon
multiline_comment|/* 3.13 */
multiline_comment|/* get consistent memory allocated for request and response rings */
id|ha-&gt;request_ring
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ha-&gt;pdev
comma
(paren
(paren
id|REQUEST_ENTRY_CNT
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
id|request_t
)paren
)paren
)paren
comma
op_amp
id|dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;request_ring
)paren
r_goto
id|error
suffix:semicolon
id|ha-&gt;request_dma
op_assign
id|dma_handle
suffix:semicolon
id|ha-&gt;response_ring
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ha-&gt;pdev
comma
(paren
(paren
id|RESPONSE_ENTRY_CNT
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
id|response_t
)paren
)paren
)paren
comma
op_amp
id|dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;request_ring
)paren
r_goto
id|error
suffix:semicolon
id|ha-&gt;response_dma
op_assign
id|dma_handle
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_mem_alloc: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_mem_alloc&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_mem_free&n; *      Frees adapter allocated memory.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_mem_free
id|qla1280_mem_free
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qlc1280_mem_free&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha
)paren
(brace
multiline_comment|/* Free device queues. */
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|MAX_BUSES
suffix:semicolon
id|bus
op_increment
)paren
(brace
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|id
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
id|MAX_TARGETS
suffix:semicolon
id|target
op_increment
)paren
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
id|MAX_LUNS
suffix:semicolon
id|lun
op_increment
)paren
r_if
c_cond
(paren
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
op_ne
l_int|NULL
op_logical_and
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
op_ne
id|q
)paren
id|kfree
c_func
(paren
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|MAX_EQ
suffix:semicolon
id|bus
op_increment
)paren
id|ha-&gt;dev
(braket
id|bus
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* 3.13 */
multiline_comment|/* free consistent memory allocated for request and response rings */
r_if
c_cond
(paren
id|ha-&gt;request_ring
)paren
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
(paren
(paren
id|REQUEST_ENTRY_CNT
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
id|request_t
)paren
)paren
)paren
comma
id|ha-&gt;request_ring
comma
id|ha-&gt;request_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;response_ring
)paren
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
(paren
(paren
id|RESPONSE_ENTRY_CNT
op_plus
l_int|1
)paren
op_star
(paren
r_sizeof
(paren
id|response_t
)paren
)paren
)paren
comma
id|ha-&gt;response_ring
comma
id|ha-&gt;response_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_buffer
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|qla1280_buffer
)paren
suffix:semicolon
id|qla1280_buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qlc1280_mem_free&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*                QLogic ISP1280 Hardware Support Functions.                */
multiline_comment|/****************************************************************************/
multiline_comment|/*&n;    * qla2100_enable_intrs&n;    * qla2100_disable_intrs&n;    *&n;    * Input:&n;    *      ha = adapter block pointer.&n;    *&n;    * Returns:&n;    *      None&n;  */
r_static
r_inline
r_void
DECL|function|qla1280_enable_intrs
id|qla1280_enable_intrs
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* enable risc and host interrupts */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
(paren
id|ISP_EN_INT
op_or
id|ISP_EN_RISC
)paren
)paren
suffix:semicolon
id|ha-&gt;flags.ints_enabled
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;Enabling ints&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_inline
r_void
DECL|function|qla1280_disable_intrs
id|qla1280_disable_intrs
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* disable risc and host interrupts */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
l_int|0
)paren
suffix:semicolon
id|ha-&gt;flags.ints_enabled
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;Disabling ints&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * qla1280_initialize_adapter&n; *      Initialize board.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_initialize_adapter
id|qla1280_initialize_adapter
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|bus
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_initialize_adapter&quot;
)paren
suffix:semicolon
multiline_comment|/* Clear adapter flags. */
id|ha-&gt;flags.online
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.disable_host_adapter
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.reset_active
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.abort_isp_active
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.ints_enabled
op_assign
id|FALSE
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;Configure PCI space for adapter...&bslash;n&quot;
)paren
suffix:semicolon
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
multiline_comment|/* Insure mailbox registers are free. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
comma
l_int|0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_RISC_INT
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_HOST_INT
)paren
suffix:semicolon
multiline_comment|/* If firmware needs to be loaded */
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%li): Determining if RISC is &quot;
l_string|&quot;loaded...&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_isp_firmware
c_func
(paren
id|ha
)paren
)paren
(brace
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): Verifying chip...&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_chip_diag
(paren
id|ha
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): Setup chip...&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|status
op_assign
id|qla1280_setup_chip
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;initialize: isp_firmware() failed!&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
multiline_comment|/* Setup adapter based on NVRAM parameters. */
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld): Configure NVRAM parameters...&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|qla1280_nvram_config
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.disable_host_adapter
op_logical_and
op_logical_neg
id|qla1280_init_rings
c_func
(paren
id|ha
)paren
)paren
(brace
multiline_comment|/* Issue SCSI reset. */
multiline_comment|/* dg 03/13 if we can&squot;t reset twice then bus is dead */
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|disable_scsi_reset
)paren
(brace
r_if
c_cond
(paren
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|bus
)paren
)paren
(brace
r_if
c_cond
(paren
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|bus
)paren
)paren
(brace
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
)brace
)brace
r_do
(brace
multiline_comment|/* Issue marker command. */
id|ha-&gt;flags.reset_marker
op_assign
id|FALSE
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
(brace
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|reset_marker
op_assign
id|FALSE
suffix:semicolon
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
l_int|0
comma
l_int|0
comma
id|MK_SYNC_ALL
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|ha-&gt;flags.reset_marker
)paren
suffix:semicolon
id|ha-&gt;flags.online
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Enable host adapter target mode. */
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_enable_tgt
c_func
(paren
id|ha
comma
id|bus
)paren
)paren
)paren
(brace
macro_line|#if 0
r_int
id|cnt
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAX_LUNS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|qla1280_enable_lun
c_func
(paren
id|ha
comma
id|bus
comma
id|cnt
)paren
suffix:semicolon
id|qla1280_poll
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_else
r_break
suffix:semicolon
)brace
)brace
r_else
id|status
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi(%li): initialize: pci probe failed!&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_initialize_adapter: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_initialize_adapter&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_enable_tgt&n; *      Enable target mode.&n; *&n; * Input:&n; *      ha   = adapter block pointer.&n; *      bus  = SCSI bus number.&n; *&n; * Returns:&n; *      0 = success.&n; */
r_static
r_int
DECL|function|qla1280_enable_tgt
id|qla1280_enable_tgt
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  uint16_t    mb[MAILBOX_REGISTER_COUNT]; */
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_enable_tgt: entered&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Enable target mode. */
macro_line|#if 0
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_ENABLE_TARGET_MODE
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|BIT_15
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|bus
op_lshift
l_int|15
)paren
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_enable_tgt: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_enable_tgt: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * ISP Firmware Test&n; *      Checks if present version of RISC firmware is older than&n; *      driver firmware.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = firmware does not need to be loaded.&n; */
r_static
r_int
DECL|function|qla1280_isp_firmware
id|qla1280_isp_firmware
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
id|nvram_t
op_star
id|nv
op_assign
(paren
id|nvram_t
op_star
)paren
id|ha-&gt;response_ring
suffix:semicolon
r_uint16
op_star
id|wptr
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* dg 2/27 always loads RISC */
r_int
id|cnt
suffix:semicolon
r_uint8
id|chksum
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_isp_firmware&quot;
)paren
suffix:semicolon
multiline_comment|/* Verify valid NVRAM checksum. */
id|wptr
op_assign
(paren
r_uint16
op_star
)paren
id|ha-&gt;response_ring
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_isp_firmware: Reading NVRAM&bslash;n&quot;
)paren
suffix:semicolon
id|chksum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
r_sizeof
(paren
id|nvram_t
)paren
op_div
l_int|2
suffix:semicolon
id|cnt
op_increment
)paren
(brace
op_star
id|wptr
op_assign
id|qla1280_get_nvram_word
(paren
id|ha
comma
id|cnt
)paren
suffix:semicolon
id|chksum
op_add_assign
(paren
r_uint8
)paren
op_star
id|wptr
suffix:semicolon
id|chksum
op_add_assign
(paren
r_uint8
)paren
(paren
op_star
id|wptr
op_rshift
l_int|8
)paren
suffix:semicolon
id|wptr
op_increment
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_isp_firmware: Completed Reading NVRAM&bslash;n&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_isp_firmware: NVRAM Magic ID= %c %c %c&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
id|nv-&gt;id
(braket
l_int|0
)braket
comma
id|nv-&gt;id
(braket
l_int|1
)braket
comma
id|nv-&gt;id
(braket
l_int|2
)braket
)paren
suffix:semicolon
multiline_comment|/* Bad NVRAM data, load RISC code. */
r_if
c_cond
(paren
id|chksum
op_logical_or
id|nv-&gt;id
(braket
l_int|0
)braket
op_ne
l_char|&squot;I&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|1
)braket
op_ne
l_char|&squot;S&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|2
)braket
op_ne
l_char|&squot;P&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|3
)braket
op_ne
l_char|&squot; &squot;
op_logical_or
id|nv-&gt;version
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280_isp_firmware: Bad checksum or magic &quot;
l_string|&quot;number or version in NVRAM.&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.disable_risc_code_load
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
id|ha-&gt;flags.disable_risc_code_load
op_assign
id|nv-&gt;cntr_flags_1.disable_loading_risc_code
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.disable_risc_code_load
)paren
(brace
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_isp_firmware: Telling RISC to verify checksum &quot;
l_string|&quot;of loaded BIOS code.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Verify checksum of loaded RISC code. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_VERIFY_CHECKSUM
suffix:semicolon
multiline_comment|/* mb[1] = ql12_risc_code_addr01; */
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
multiline_comment|/* Start firmware execution. */
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_isp_firmware: Startng F/W &quot;
l_string|&quot;execution.&bslash;n&quot;
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_EXECUTE_FIRMWARE
suffix:semicolon
multiline_comment|/* mb[1] = ql12_risc_code_addr01; */
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: RISC checksum failed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280: NVRAM configured to load RISC load.&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isp_firmware: **** Load RISC code ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_isp_firmware&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * PCI configuration&n; *      Setup device PCI configuration registers.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success.&n; */
r_static
r_int
DECL|function|qla1280_pci_config
id|qla1280_pci_config
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
macro_line|#if MEMORY_MAPPED_IO
r_uint32
id|page_offset
comma
id|base
suffix:semicolon
r_uint32
id|mmapbase
suffix:semicolon
macro_line|#endif
r_uint16
id|buf_wd
suffix:semicolon
r_int
id|status
op_assign
l_int|1
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_pci_config&quot;
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|ha-&gt;pdev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set Bus Master Enable, Memory Address Space Enable and&n;&t; * reset any error bits, in the command register.&n;&t; */
id|pci_read_config_word
(paren
id|ha-&gt;pdev
comma
id|PCI_COMMAND
comma
op_amp
id|buf_wd
)paren
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280: MEMORY MAPPED IO is enabled.&bslash;n&quot;
)paren
suffix:semicolon
id|buf_wd
op_or_assign
id|PCI_COMMAND_MEMORY
op_plus
id|PCI_COMMAND_IO
suffix:semicolon
macro_line|#else
id|buf_wd
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
macro_line|#endif
id|pci_write_config_word
(paren
id|ha-&gt;pdev
comma
id|PCI_COMMAND
comma
id|buf_wd
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Reset expansion ROM address decode enable.&n;&t; */
id|pci_read_config_word
(paren
id|ha-&gt;pdev
comma
id|PCI_ROM_ADDRESS
comma
op_amp
id|buf_wd
)paren
suffix:semicolon
id|buf_wd
op_and_assign
op_complement
id|PCI_ROM_ADDRESS_ENABLE
suffix:semicolon
id|pci_write_config_word
(paren
id|ha-&gt;pdev
comma
id|PCI_ROM_ADDRESS
comma
id|buf_wd
)paren
suffix:semicolon
id|ha-&gt;host-&gt;io_port
op_assign
id|pci_resource_start
c_func
(paren
id|ha-&gt;pdev
comma
l_int|0
)paren
suffix:semicolon
id|ha-&gt;host-&gt;io_port
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|ha-&gt;iobase
op_assign
(paren
r_struct
id|device_reg
op_star
)paren
id|ha-&gt;host-&gt;io_port
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
multiline_comment|/*&n;&t; * Get memory mapped I/O address.&n;&t; */
id|pci_read_config_word
(paren
id|ha-&gt;pdev
comma
id|PCI_BASE_ADDRESS_1
comma
op_amp
id|mmapbase
)paren
suffix:semicolon
id|mmapbase
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
multiline_comment|/*&n;&t; * Find proper memory chunk for memory map I/O reg.&n;&t; */
id|base
op_assign
id|mmapbase
op_amp
id|PAGE_MASK
suffix:semicolon
id|page_offset
op_assign
id|mmapbase
op_minus
id|base
suffix:semicolon
multiline_comment|/*&n;&t; * Get virtual address for I/O registers.&n;&t; */
id|ha-&gt;mmpbase
op_assign
id|ioremap
c_func
(paren
id|base
comma
id|page_offset
op_plus
l_int|256
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;mmpbase
)paren
(brace
id|ha-&gt;mmpbase
op_add_assign
id|page_offset
suffix:semicolon
multiline_comment|/* ha-&gt;iobase = ha-&gt;mmpbase; */
id|status
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#else&t;&t;&t;&t;/* MEMORY_MAPPED_IO */
id|status
op_assign
l_int|0
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* MEMORY_MAPPED_IO */
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_pci_config&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Chip diagnostics&n; *      Test chip for proper operation.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success.&n; */
r_static
r_int
DECL|function|qla1280_chip_diag
id|qla1280_chip_diag
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_uint16
id|data
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_chip_diag: testing device at 0x%p &bslash;n&quot;
comma
op_amp
id|reg-&gt;id_l
)paren
suffix:semicolon
multiline_comment|/* Soft reset chip and wait for it to finish. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
id|ISP_RESET
)paren
suffix:semicolon
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;ictrl
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This is *AWESOME*&n;&t; */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|6000000
suffix:semicolon
id|cnt
op_logical_and
id|data
op_amp
id|ISP_RESET
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
)paren
(brace
multiline_comment|/* Reset register not cleared by chip reset. */
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_chip_diag: reset register cleared by chip reset&bslash;n&quot;
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset RISC and disable BIOS which&n;&t;&t;   allows RISC to execute out of RAM. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RESET_RISC
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RELEASE_RISC
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_DISABLE_BIOS
)paren
suffix:semicolon
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;mailbox0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * I *LOVE* this code!&n;&t;&t; */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|6000000
suffix:semicolon
id|cnt
op_logical_and
id|data
op_eq
id|MBS_BUSY
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
)paren
(brace
multiline_comment|/* Check product ID of chip */
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_chip_diag: Checking product ID of chip&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox1
)paren
op_ne
id|PROD_ID_1
op_logical_or
(paren
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
op_ne
id|PROD_ID_2
op_logical_and
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
op_ne
id|PROD_ID_2a
)paren
op_logical_or
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox3
)paren
op_ne
id|PROD_ID_3
op_logical_or
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
op_ne
id|PROD_ID_4
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Wrong product ID = 0x%x,0x%x,0x%x,&quot;
l_string|&quot;0x%x&bslash;n&quot;
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox1
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox3
)paren
comma
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
)paren
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Enable ints early!!!&n;&t;&t;&t;&t; */
id|qla1280_enable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_chip_diag: Checking mailboxes of chip&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Wrap Incoming Mailboxes Test. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_MAILBOX_REGISTER_TEST
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
l_int|0xAAAA
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
l_int|0x5555
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
l_int|0xAA55
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
l_int|0x55AA
suffix:semicolon
id|mb
(braket
l_int|5
)braket
op_assign
l_int|0xA5A5
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
l_int|0x5A5A
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
l_int|0x2525
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_5
op_or
id|BIT_4
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|mb
(braket
l_int|1
)braket
op_ne
l_int|0xAAAA
op_logical_or
id|mb
(braket
l_int|2
)braket
op_ne
l_int|0x5555
op_logical_or
id|mb
(braket
l_int|3
)braket
op_ne
l_int|0xAA55
op_logical_or
id|mb
(braket
l_int|4
)braket
op_ne
l_int|0x55AA
op_logical_or
id|mb
(braket
l_int|5
)braket
op_ne
l_int|0xA5A5
op_logical_or
id|mb
(braket
l_int|6
)braket
op_ne
l_int|0x5A5A
op_logical_or
id|mb
(braket
l_int|7
)braket
op_ne
l_int|0x2525
)paren
id|status
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280: Failed mailbox check&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
id|status
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|status
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_chip_diag: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_chip_diag: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Setup chip&n; *      Load and start RISC firmware.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success.&n; */
DECL|macro|DUMP_IT_BACK
mdefine_line|#define DUMP_IT_BACK 0&t;&t;/* for debug of RISC loading */
r_static
r_int
DECL|function|qla1280_setup_chip
id|qla1280_setup_chip
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_uint16
id|risc_address
suffix:semicolon
r_uint16
op_star
id|risc_code_address
suffix:semicolon
r_int
id|risc_code_size
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_uint16
id|cnt
suffix:semicolon
r_int
id|num
suffix:semicolon
macro_line|#if DUMP_IT_BACK
r_int
id|i
suffix:semicolon
r_uint8
op_star
id|sp
suffix:semicolon
r_uint8
op_star
id|tbuf
suffix:semicolon
macro_line|#ifdef QLA_64BIT_PTR
id|dma_addr_t
id|p_tbuf
suffix:semicolon
macro_line|#else
r_uint32
id|p_tbuf
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|ENTER
c_func
(paren
l_string|&quot;qla1280_setup_chip&quot;
)paren
suffix:semicolon
multiline_comment|/* 3.13 */
macro_line|#if DUMP_IT_BACK
multiline_comment|/* get consistent memory allocated for setup_chip */
id|tbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ha-&gt;pdev
comma
l_int|8000
comma
op_amp
id|p_tbuf
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Load RISC code. */
id|risc_address
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
id|risc_code_address
op_assign
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwcode
suffix:semicolon
id|risc_code_size
op_assign
(paren
r_int
)paren
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwlen
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_setup_chip: DMA RISC code (%i) words&bslash;n&quot;
comma
id|risc_code_size
)paren
suffix:semicolon
id|num
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|risc_code_size
OG
l_int|0
op_logical_and
op_logical_neg
id|status
)paren
(brace
id|cnt
op_assign
l_int|2000
op_rshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|risc_code_size
)paren
id|cnt
op_assign
id|risc_code_size
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_setup_chip:  loading risc @ =(0x%p),&quot;
l_string|&quot;%d,%d(0x%x)&bslash;n&quot;
comma
id|risc_code_address
comma
id|cnt
comma
id|num
comma
id|risc_address
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ha-&gt;request_ring
comma
id|risc_code_address
comma
(paren
id|cnt
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|flush_cache_all
c_func
(paren
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_LOAD_RAM
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|risc_address
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
id|cnt
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|ha-&gt;request_dma
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
id|ha-&gt;request_dma
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;request_dma
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;request_dma
)paren
op_rshift
l_int|16
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_setup_chip: op=%d  0x%p = 0x%4x,0x%4x,&quot;
l_string|&quot;0x%4x,0x%4x&bslash;n&quot;
comma
id|mb
(braket
l_int|0
)braket
comma
id|ha-&gt;request_dma
comma
id|mb
(braket
l_int|6
)braket
comma
id|mb
(braket
l_int|7
)braket
comma
id|mb
(braket
l_int|2
)braket
comma
id|mb
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_4
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to load partial segment of f/w&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if DUMP_IT_BACK
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_READ_RAM_WORD
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|risc_address
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
id|cnt
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|p_tbuf
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
id|p_tbuf
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|p_tbuf
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|p_tbuf
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_4
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to dump partial segment of f/w&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sp
op_assign
(paren
r_uint8
op_star
)paren
id|ha-&gt;request_ring
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|cnt
op_lshift
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tbuf
(braket
id|i
)braket
op_ne
id|sp
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;qla1280_setup_chip: FW &quot;
l_string|&quot;compare error @ byte(0x%x) loop#=%x&bslash;n&quot;
comma
id|i
comma
id|num
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;setup_chip: FWbyte=%x  &quot;
l_string|&quot;FWfromChip=%x&bslash;n&quot;
comma
id|sp
(braket
id|i
)braket
comma
id|tbuf
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/*break; */
)brace
)brace
macro_line|#endif
id|risc_address
op_add_assign
id|cnt
suffix:semicolon
id|risc_code_size
op_assign
id|risc_code_size
op_minus
id|cnt
suffix:semicolon
id|risc_code_address
op_assign
id|risc_code_address
op_plus
id|cnt
suffix:semicolon
id|num
op_increment
suffix:semicolon
)brace
multiline_comment|/* Verify checksum of loaded RISC code. */
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_setup_chip: Verifying checksum of &quot;
l_string|&quot;loaded RISC code.&bslash;n&quot;
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_VERIFY_CHECKSUM
suffix:semicolon
multiline_comment|/* mb[1] = ql12_risc_code_addr01; */
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
multiline_comment|/* Start firmware execution. */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_setup_chip: start firmware running.&bslash;n&quot;
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_EXECUTE_FIRMWARE
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
op_star
id|ql1280_board_tbl
(braket
id|ha-&gt;devnum
)braket
dot
id|fwstart
suffix:semicolon
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;qla1280_setup_chip: Failed checksum.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* 3.13 */
macro_line|#if DUMP_IT_BACK
multiline_comment|/* free consistent memory allocated for setup_chip */
id|pci_free_consistent
c_func
(paren
id|ha-&gt;pdev
comma
l_int|8000
comma
id|tbuf
comma
id|p_tbuf
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_setup_chip: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_setup_chip&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize rings&n; *&n; * Input:&n; *      ha                = adapter block pointer.&n; *      ha-&gt;request_ring  = request ring virtual address&n; *      ha-&gt;response_ring = response ring virtual address&n; *      ha-&gt;request_dma   = request ring physical address&n; *      ha-&gt;response_dma  = response ring physical address&n; *&n; * Returns:&n; *      0 = success.&n; */
r_static
r_int
DECL|function|qla1280_init_rings
id|qla1280_init_rings
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_init_rings&quot;
)paren
suffix:semicolon
multiline_comment|/* Clear outstanding commands array. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|cnt
op_increment
)paren
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize request queue. */
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
suffix:semicolon
multiline_comment|/* mb[0] = MBC_INIT_REQUEST_QUEUE; */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_INIT_REQUEST_QUEUE_A64
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|REQUEST_ENTRY_CNT
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|ha-&gt;request_dma
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
id|ha-&gt;request_dma
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;request_dma
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;request_dma
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_4
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
multiline_comment|/* Initialize response queue. */
id|ha-&gt;response_ring_ptr
op_assign
id|ha-&gt;response_ring
suffix:semicolon
id|ha-&gt;rsp_ring_index
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* mb[0] = MBC_INIT_RESPONSE_QUEUE; */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_INIT_RESPONSE_QUEUE_A64
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|RESPONSE_ENTRY_CNT
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|ha-&gt;response_dma
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
id|ha-&gt;response_dma
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;response_dma
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|pci_dma_hi32
c_func
(paren
id|ha-&gt;response_dma
)paren
op_rshift
l_int|16
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_5
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_init_rings: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_init_rings&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * NVRAM configuration.&n; *&n; * Input:&n; *      ha                = adapter block pointer.&n; *      ha-&gt;request_ring  = request ring virtual address&n; *&n; * Output:&n; *      host adapters parameters in host adapter block&n; *&n; * Returns:&n; *      0 = success.&n; */
r_static
r_int
DECL|function|qla1280_nvram_config
id|qla1280_nvram_config
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|nvram_t
op_star
id|nv
op_assign
(paren
id|nvram_t
op_star
)paren
id|ha-&gt;response_ring
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
r_uint16
op_star
id|wptr
suffix:semicolon
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_uint8
id|chksum
suffix:semicolon
r_int
id|nvsize
suffix:semicolon
macro_line|#if DEBUG_PRINT_NVRAM
r_int
id|saved_print_status
op_assign
id|ql_debug_print
suffix:semicolon
macro_line|#endif
id|ENTER
c_func
(paren
l_string|&quot;qla1280_nvram_config&quot;
)paren
suffix:semicolon
multiline_comment|/* Verify valid NVRAM checksum. */
macro_line|#if USE_NVRAM_DEFAULTS
id|chksum
op_assign
l_int|1
suffix:semicolon
macro_line|#else
id|wptr
op_assign
(paren
r_uint16
op_star
)paren
id|ha-&gt;response_ring
suffix:semicolon
id|chksum
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;device_id
op_eq
id|PCI_DEVICE_ID_QLOGIC_ISP12160
op_logical_or
id|ha-&gt;device_id
op_eq
id|PCI_DEVICE_ID_QLOGIC_ISP10160
)paren
id|nvsize
op_assign
r_sizeof
(paren
id|nvram160_t
)paren
op_div
l_int|2
suffix:semicolon
r_else
id|nvsize
op_assign
r_sizeof
(paren
id|nvram_t
)paren
op_div
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|nvsize
suffix:semicolon
id|cnt
op_increment
)paren
(brace
op_star
id|wptr
op_assign
id|qla1280_get_nvram_word
c_func
(paren
id|ha
comma
id|cnt
)paren
suffix:semicolon
id|chksum
op_add_assign
(paren
r_uint8
)paren
op_star
id|wptr
suffix:semicolon
id|chksum
op_add_assign
(paren
r_uint8
)paren
(paren
op_star
id|wptr
op_rshift
l_int|8
)paren
suffix:semicolon
id|wptr
op_increment
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Bad NVRAM data, set defaults parameters. */
r_if
c_cond
(paren
id|chksum
op_logical_or
id|nv-&gt;id
(braket
l_int|0
)braket
op_ne
l_char|&squot;I&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|1
)braket
op_ne
l_char|&squot;S&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|2
)braket
op_ne
l_char|&squot;P&squot;
op_logical_or
id|nv-&gt;id
(braket
l_int|3
)braket
op_ne
l_char|&squot; &squot;
op_logical_or
id|nv-&gt;version
OL
l_int|1
)paren
(brace
macro_line|#if USE_NVRAM_DEFAULTS
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;Using defaults for NVRAM&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;Using defaults for NVRAM: &bslash;n&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;checksum=0x%x, Id=%c, version=0x%x&bslash;n&quot;
comma
id|chksum
comma
id|nv-&gt;id
(braket
l_int|0
)braket
comma
id|nv-&gt;version
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ha-&gt;response_ring
comma
l_int|0
comma
r_sizeof
(paren
id|nvram_t
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* nv-&gt;cntr_flags_1.disable_loading_risc_code = 1; */
id|nv-&gt;firmware_feature.w
op_assign
id|BIT_0
suffix:semicolon
id|nv-&gt;termination.f.scsi_bus_0_control
op_assign
l_int|3
suffix:semicolon
id|nv-&gt;termination.f.scsi_bus_1_control
op_assign
l_int|3
suffix:semicolon
id|nv-&gt;termination.f.auto_term_support
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|MAX_BUSES
suffix:semicolon
id|bus
op_increment
)paren
(brace
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_1.initiator_id
op_assign
l_int|7
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|bus_reset_delay
op_assign
l_int|5
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_2.async_data_setup_time
op_assign
l_int|9
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_2.req_ack_active_negation
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_2.data_line_active_negation
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|selection_timeout
op_assign
l_int|250
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|max_queue_depth
op_assign
l_int|256
suffix:semicolon
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
id|MAX_TARGETS
suffix:semicolon
id|target
op_increment
)paren
(brace
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f
dot
id|auto_request_sense
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f
dot
id|disconnect_allowed
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f
dot
id|tag_queuing
op_assign
l_int|1
suffix:semicolon
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags
dot
id|device_enable
op_assign
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#if USE_NVRAM_DEFAULTS
id|status
op_assign
l_int|0
suffix:semicolon
macro_line|#else
id|status
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
multiline_comment|/* Always force AUTO sense for LINUX SCSI */
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|MAX_BUSES
suffix:semicolon
id|bus
op_increment
)paren
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
id|MAX_TARGETS
suffix:semicolon
id|target
op_increment
)paren
(brace
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f
dot
id|auto_request_sense
op_assign
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#if DEBUG_PRINT_NVRAM
id|ql_debug_print
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : initiator scsi id bus[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_1.initiator_id
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : initiator scsi id bus[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_1.initiator_id
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : bus reset delay[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|bus_reset_delay
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : bus reset delay[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|bus_reset_delay
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : retry count[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_count
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : retry delay[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_delay
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : retry count[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_count
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : retry delay[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_delay
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : async data setup time[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.async_data_setup_time
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : async data setup time[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.async_data_setup_time
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : req/ack active negation[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.req_ack_active_negation
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : req/ack active negation[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.req_ack_active_negation
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : data line active negation[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.data_line_active_negation
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : data line active negation[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.data_line_active_negation
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : disable loading risc code=%d&bslash;n&quot;
comma
id|nv-&gt;cntr_flags_1.disable_loading_risc_code
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : enable 64bit addressing=%d&bslash;n&quot;
comma
id|nv-&gt;cntr_flags_1.enable_64bit_addressing
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : selection timeout limit[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|selection_timeout
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : selection timeout limit[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|selection_timeout
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : max queue depth[0]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|max_queue_depth
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280 : max queue depth[1]=%d&bslash;n&quot;
comma
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|max_queue_depth
)paren
suffix:semicolon
multiline_comment|/* Disable RISC load of firmware. */
id|ha-&gt;flags.disable_risc_code_load
op_assign
id|nv-&gt;cntr_flags_1.disable_loading_risc_code
suffix:semicolon
macro_line|#ifdef QLA_64BIT_PTR
multiline_comment|/* Enable 64bit addressing for OS/System combination supporting it   */
multiline_comment|/* actual NVRAM bit is: nv-&gt;cntr_flags_1.enable_64bit_addressing     */
multiline_comment|/* but we will ignore it and use BITS_PER_LONG macro to setup for    */
multiline_comment|/* 64 or 32 bit access of host memory in all x86/ia-64/Alpha systems */
id|ha-&gt;flags.enable_64bit_addressing
op_assign
l_int|1
suffix:semicolon
macro_line|#else
id|ha-&gt;flags.enable_64bit_addressing
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,18)
r_if
c_cond
(paren
id|ha-&gt;flags.enable_64bit_addressing
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%li): 64 Bit PCI Addressing Enabled&bslash;n&quot;
comma
id|ha-&gt;host_no
)paren
suffix:semicolon
id|pci_set_dma_mask
c_func
(paren
id|ha-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
op_complement
l_int|0ULL
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Set ISP hardware DMA burst */
id|mb
(braket
l_int|0
)braket
op_assign
id|nv-&gt;isp_config.c
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Set SCSI termination. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;gpio_enable
comma
(paren
id|BIT_3
op_plus
id|BIT_2
op_plus
id|BIT_1
op_plus
id|BIT_0
)paren
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|nv-&gt;termination.c
op_amp
(paren
id|BIT_3
op_plus
id|BIT_2
op_plus
id|BIT_1
op_plus
id|BIT_0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;gpio_data
comma
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* ISP parameter word. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_SYSTEM_PARAMETER
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;isp_parameter
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Firmware feature word. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_FIRMWARE_FEATURES
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;firmware_feature.w
op_amp
(paren
id|BIT_1
op_or
id|BIT_0
)paren
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Retry count and delay. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_RETRY_COUNT
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_count
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|retry_delay
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_count
suffix:semicolon
id|mb
(braket
l_int|7
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|retry_delay
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_7
op_or
id|BIT_6
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* ASYNC data setup time. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_ASYNC_DATA_SETUP
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.async_data_setup_time
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.async_data_setup_time
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Active negation states. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_ACTIVE_NEGATION
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.req_ack_active_negation
)paren
id|mb
(braket
l_int|1
)braket
op_or_assign
id|BIT_5
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|config_2.data_line_active_negation
)paren
id|mb
(braket
l_int|1
)braket
op_or_assign
id|BIT_4
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.req_ack_active_negation
)paren
id|mb
(braket
l_int|2
)braket
op_or_assign
id|BIT_5
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|config_2.data_line_active_negation
)paren
id|mb
(braket
l_int|2
)braket
op_or_assign
id|BIT_4
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Selection timeout. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_SELECTION_TIMEOUT
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|0
)braket
dot
id|selection_timeout
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
l_int|1
)braket
dot
id|selection_timeout
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
(brace
multiline_comment|/* SCSI Reset Disable. */
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|disable_scsi_reset
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_1.scsi_reset_disable
suffix:semicolon
multiline_comment|/* Initiator ID. */
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|id
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|config_1.initiator_id
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_INITIATOR_ID
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|bus
ques
c_cond
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|id
op_or
id|BIT_7
suffix:colon
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|id
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Reset Delay. */
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|bus_reset_delay
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|bus_reset_delay
suffix:semicolon
multiline_comment|/* Command queue depth per device. */
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|hiwat
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|max_queue_depth
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Set target parameters. */
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
id|MAX_TARGETS
suffix:semicolon
id|target
op_increment
)paren
(brace
r_uint8
id|mr
op_assign
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
suffix:semicolon
multiline_comment|/* Set Target Parameters. */
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_TARGET_PARAMETERS
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|bus
ques
c_cond
id|target
op_or
id|BIT_7
suffix:colon
id|target
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_lshift_assign
l_int|8
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.c
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_or_assign
id|TP_AUTO_REQUEST_SENSE
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_and_assign
op_complement
id|TP_STOP_QUEUE
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.sync_offset
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_or_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|sync_period
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;device_id
op_eq
id|PCI_DEVICE_ID_QLOGIC_ISP12160
op_logical_or
id|ha-&gt;device_id
op_eq
id|PCI_DEVICE_ID_QLOGIC_ISP10160
)paren
(brace
id|nvram160_t
op_star
id|nv2
op_assign
(paren
id|nvram160_t
op_star
)paren
id|nv
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_or_assign
id|nv2-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags
dot
id|enable_ppr
op_lshift
l_int|5
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_assign
id|nv2-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags
dot
id|ppr_options
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|6
)braket
op_or_assign
id|nv2-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags
dot
id|ppr_bus_width
suffix:semicolon
id|mr
op_or_assign
id|BIT_6
suffix:semicolon
)brace
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|mr
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Save Tag queuing enable flag. */
id|mb
(braket
l_int|0
)braket
op_assign
id|BIT_0
op_lshift
id|target
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|parameter.f.tag_queuing
)paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|qtag_enables
op_or_assign
id|mb
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Save Device enable flag. */
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.device_enable
)paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|device_enables
op_or_assign
id|mb
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Save LUN disable flag. */
r_if
c_cond
(paren
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|flags.lun_disable
)paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|lun_disables
op_or_assign
id|mb
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Set Device Queue Parameters. */
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
id|MAX_LUNS
suffix:semicolon
id|lun
op_increment
)paren
(brace
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_SET_DEVICE_QUEUE
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|bus
ques
c_cond
id|target
op_or
id|BIT_7
suffix:colon
id|target
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|mb
(braket
l_int|1
)braket
op_lshift
l_int|8
op_or
id|lun
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|max_queue_depth
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|nv-&gt;bus
(braket
id|bus
)braket
dot
id|target
(braket
id|target
)braket
dot
id|execution_throttle
suffix:semicolon
id|status
op_or_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#if DEBUG_PRINT_NVRAM
id|ql_debug_print
op_assign
id|saved_print_status
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_nvram_config: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_nvram_config&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Get NVRAM data word&n; *      Calculates word position in NVRAM and calls request routine to&n; *      get the word from NVRAM.&n; *&n; * Input:&n; *      ha      = adapter block pointer.&n; *      address = NVRAM word address.&n; *&n; * Returns:&n; *      data word.&n; */
r_static
r_uint16
DECL|function|qla1280_get_nvram_word
id|qla1280_get_nvram_word
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_uint32
id|address
)paren
(brace
r_uint32
id|nv_cmd
suffix:semicolon
r_uint16
id|data
suffix:semicolon
macro_line|#ifdef QL_DEBUG_ROUTINES
r_int
id|saved_print_status
op_assign
id|ql_debug_print
suffix:semicolon
macro_line|#endif
id|nv_cmd
op_assign
id|address
op_lshift
l_int|16
suffix:semicolon
id|nv_cmd
op_or_assign
id|NV_READ_OP
suffix:semicolon
macro_line|#ifdef QL_DEBUG_ROUTINES
id|ql_debug_print
op_assign
id|FALSE
suffix:semicolon
macro_line|#endif
id|data
op_assign
id|qla1280_nvram_request
c_func
(paren
id|ha
comma
id|nv_cmd
)paren
suffix:semicolon
macro_line|#ifdef QL_DEBUG_ROUTINES
id|ql_debug_print
op_assign
id|saved_print_status
suffix:semicolon
macro_line|#endif
id|dprintk
c_func
(paren
l_int|4
comma
l_string|&quot;qla1280_get_nvram_word: exiting normally NVRAM data = 0x%x&quot;
comma
id|data
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
multiline_comment|/*&n; * NVRAM request&n; *      Sends read command to NVRAM and gets data from NVRAM.&n; *&n; * Input:&n; *      ha     = adapter block pointer.&n; *      nv_cmd = Bit 26     = start bit&n; *               Bit 25, 24 = opcode&n; *               Bit 23-16  = address&n; *               Bit 15-0   = write data&n; *&n; * Returns:&n; *      data word.&n; */
r_static
r_uint16
DECL|function|qla1280_nvram_request
id|qla1280_nvram_request
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_uint32
id|nv_cmd
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_uint16
id|data
op_assign
l_int|0
suffix:semicolon
r_uint16
id|reg_data
suffix:semicolon
multiline_comment|/* Send command to NVRAM. */
id|nv_cmd
op_lshift_assign
l_int|5
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|11
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|nv_cmd
op_amp
id|BIT_31
)paren
id|qla1280_nv_write
c_func
(paren
id|ha
comma
id|NV_DATA_OUT
)paren
suffix:semicolon
r_else
id|qla1280_nv_write
c_func
(paren
id|ha
comma
l_int|0
)paren
suffix:semicolon
id|nv_cmd
op_lshift_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Read data from NVRAM. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|16
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
(paren
id|NV_SELECT
op_or
id|NV_CLOCK
)paren
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|data
op_lshift_assign
l_int|1
suffix:semicolon
id|reg_data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_data
op_amp
id|NV_DATA_IN
)paren
id|data
op_or_assign
id|BIT_0
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|NV_SELECT
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Deselect chip. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|NV_DESELECT
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
r_static
r_void
DECL|function|qla1280_nv_write
id|qla1280_nv_write
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_uint16
id|data
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|data
op_or
id|NV_SELECT
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|data
op_or
id|NV_SELECT
op_or
id|NV_CLOCK
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;nvram
comma
id|data
op_or
id|NV_SELECT
)paren
suffix:semicolon
id|NVRAM_DELAY
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Mailbox Command&n; *      Issue mailbox command and waits for completion.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      mr = mailbox registers to load.&n; *      mb = data pointer for mailbox registers.&n; *&n; * Output:&n; *      mb[MAILBOX_REGISTER_COUNT] = returned mailbox data.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_mailbox_command
id|qla1280_mailbox_command
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_uint8
id|mr
comma
r_uint16
op_star
id|mb
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
macro_line|#if 0
id|srb_t
op_star
id|done_q_first
op_assign
l_int|0
suffix:semicolon
id|srb_t
op_star
id|done_q_last
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_uint16
op_star
id|optr
comma
op_star
id|iptr
suffix:semicolon
r_uint16
id|data
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_mailbox_command&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.mbox_busy
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.ints_enabled
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Running qla1280_mailbox_command() with interrupts &quot;
l_string|&quot;disabled!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We really should start out by verifying that the mailbox is available&n;&t; * before starting sending the command data&n;&t; */
multiline_comment|/* Load mailbox registers. */
id|optr
op_assign
(paren
r_uint16
op_star
)paren
op_amp
id|reg-&gt;mailbox0
suffix:semicolon
id|iptr
op_assign
id|mb
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAILBOX_REGISTER_COUNT
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mr
op_amp
id|BIT_0
)paren
(brace
id|WRT_REG_WORD
c_func
(paren
id|optr
comma
(paren
op_star
id|iptr
)paren
)paren
suffix:semicolon
)brace
id|mr
op_rshift_assign
l_int|1
suffix:semicolon
id|optr
op_increment
suffix:semicolon
id|iptr
op_increment
suffix:semicolon
)brace
multiline_comment|/* Issue set host interrupt command. */
id|ha-&gt;flags.mbox_int
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;flags.mbox_busy
op_assign
id|FALSE
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_SET_HOST_INT
)paren
suffix:semicolon
id|data
op_assign
id|qla1280_debounce_register
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This is insane - instead of looping to wait for the interrupt &n;&t; * to appear and run the handler (this is insane!!), use a waitqueue&n;&t; * and go to sleep.&n;&t; *&n;&t; * We are never called here from interrupt context anyway!    /Jes&n;&t; */
multiline_comment|/* Wait for 30 seconds for command to finish. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|30000000
suffix:semicolon
id|cnt
OG
l_int|0
op_logical_and
op_logical_neg
id|ha-&gt;flags.mbox_int
suffix:semicolon
id|cnt
op_decrement
)paren
(brace
multiline_comment|/* Check for pending interrupts. */
macro_line|#if 0
r_if
c_cond
(paren
id|data
op_amp
id|RISC_INT
)paren
(brace
id|qla1280_isr
c_func
(paren
id|ha
comma
op_amp
id|done_q_first
comma
op_amp
id|done_q_last
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
)brace
multiline_comment|/* Check for mailbox command timeout. */
r_if
c_cond
(paren
op_logical_neg
id|cnt
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280_mailbox_command: **** Command Timeout, &quot;
l_string|&quot;mailbox0 = 0x%x****&bslash;n&quot;
comma
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
id|status
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
op_ne
id|MBS_CMD_CMP
)paren
id|status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Load return mailbox registers. */
id|optr
op_assign
id|mb
suffix:semicolon
id|iptr
op_assign
(paren
r_uint16
op_star
)paren
op_amp
id|ha-&gt;mailbox_out
(braket
l_int|0
)braket
suffix:semicolon
id|mr
op_assign
id|MAILBOX_REGISTER_COUNT
suffix:semicolon
id|memcpy
c_func
(paren
id|optr
comma
id|iptr
comma
id|MAILBOX_REGISTER_COUNT
op_star
r_sizeof
(paren
r_uint16
)paren
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Go check for any response interrupts pending. */
id|qla1280_isr
c_func
(paren
id|ha
comma
op_amp
id|done_q_first
comma
op_amp
id|done_q_last
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ha-&gt;flags.isp_abort_needed
)paren
id|qla1280_abort_isp
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.reset_marker
)paren
id|qla1280_rst_aen
c_func
(paren
id|ha
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|done_q_first
)paren
id|qla1280_done
(paren
id|ha
comma
op_amp
id|done_q_first
comma
op_amp
id|done_q_last
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_mailbox_command: **** FAILED, mailbox0 = 0x%x &quot;
l_string|&quot;****n&quot;
comma
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_mailbox_command&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_poll&n; *      Polls ISP for interrupts.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_poll
id|qla1280_poll
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
r_uint16
id|data
suffix:semicolon
id|srb_t
op_star
id|done_q_first
op_assign
l_int|0
suffix:semicolon
id|srb_t
op_star
id|done_q_last
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ENTER(&quot;qla1280_poll&quot;); */
multiline_comment|/* Check for pending interrupts. */
id|data
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|RISC_INT
)paren
id|qla1280_isr
c_func
(paren
id|ha
comma
op_amp
id|done_q_first
comma
op_amp
id|done_q_last
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.mbox_busy
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;flags.isp_abort_needed
)paren
id|qla1280_abort_isp
c_func
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.reset_marker
)paren
id|qla1280_rst_aen
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|done_q_first
)paren
id|qla1280_done
c_func
(paren
id|ha
comma
op_amp
id|done_q_first
comma
op_amp
id|done_q_last
)paren
suffix:semicolon
multiline_comment|/* LEAVE(&quot;qla1280_poll&quot;); */
)brace
multiline_comment|/*&n; * qla1280_bus_reset&n; *      Issue SCSI bus reset.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; *      bus = SCSI bus number.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_bus_reset
id|qla1280_bus_reset
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_bus_reset: entered&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qla1280_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%li): Resetting SCSI BUS (%i)&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_BUS_RESET
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|bus_reset_delay
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
(paren
r_uint16
)paren
id|bus
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|failed_reset_count
OG
l_int|2
)paren
multiline_comment|/* dg - 03/13/99 */
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
op_assign
id|TRUE
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|failed_reset_count
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Eeeeep! This is evil! /Jes&n;&t;&t; */
macro_line|#if 0
id|mdelay
c_func
(paren
l_int|4000
)paren
suffix:semicolon
macro_line|#else
id|schedule_timeout
c_func
(paren
l_int|4
op_star
id|HZ
)paren
suffix:semicolon
macro_line|#endif
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* dg - 03/13/99 */
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|failed_reset_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
l_int|0
comma
l_int|0
comma
id|MK_SYNC_ALL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_bus_reset: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_bus_reset: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_device_reset&n; *      Issue bus device reset message to the target.&n; *&n; * Input:&n; *      ha      = adapter block pointer.&n; *      bus     = SCSI BUS number.&n; *      target  = SCSI ID.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_device_reset
id|qla1280_device_reset
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
comma
r_int
id|target
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_device_reset&quot;
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_ABORT_TARGET
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
id|bus
ques
c_cond
(paren
id|target
op_or
id|BIT_7
)paren
suffix:colon
id|target
)paren
op_lshift
l_int|8
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
l_int|0
comma
id|MK_SYNC_ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_device_reset: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_device_reset&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_abort_device&n; *      Issue an abort message to the device&n; *&n; * Input:&n; *      ha     = adapter block pointer.&n; *      bus    = SCSI BUS.&n; *      target = SCSI ID.&n; *      lun    = SCSI LUN.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_abort_device
id|qla1280_abort_device
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
comma
r_int
id|target
comma
r_int
id|lun
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_device&quot;
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_ABORT_DEVICE
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
id|bus
ques
c_cond
id|target
op_or
id|BIT_7
suffix:colon
id|target
)paren
op_lshift
l_int|8
op_or
id|lun
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Issue marker command. */
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
comma
id|MK_SYNC_ID_LUN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_abort_device: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_device&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_abort_command&n; *      Abort command aborts a specified IOCB.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      sp = SB structure pointer.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_abort_command
id|qla1280_abort_command
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_int
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
r_uint32
id|handle
suffix:semicolon
r_int
id|status
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_command&quot;
)paren
suffix:semicolon
multiline_comment|/* Locate handle number. */
r_for
c_loop
(paren
id|handle
op_assign
l_int|0
suffix:semicolon
id|handle
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|handle
op_increment
)paren
r_if
c_cond
(paren
id|ha-&gt;outstanding_cmds
(braket
id|handle
)braket
op_eq
id|sp
)paren
r_break
suffix:semicolon
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_ABORT_COMMAND
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
id|bus
ques
c_cond
id|target
op_or
id|BIT_7
suffix:colon
id|target
)paren
op_lshift
l_int|8
op_or
id|lun
suffix:semicolon
id|mb
(braket
l_int|2
)braket
op_assign
id|handle
op_rshift
l_int|16
suffix:semicolon
id|mb
(braket
l_int|3
)braket
op_assign
id|handle
op_amp
l_int|0xffff
suffix:semicolon
id|status
op_assign
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_abort_command: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_ABORT_PENDING
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_command&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_reset_adapter&n; *      Reset adapter.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_reset_adapter
id|qla1280_reset_adapter
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_reset_adapter&quot;
)paren
suffix:semicolon
multiline_comment|/* Disable ISP chip */
id|ha-&gt;flags.online
op_assign
id|FALSE
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;ictrl
comma
id|ISP_RESET
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RESET_RISC
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RELEASE_RISC
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_DISABLE_BIOS
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_reset_adapter&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Issue marker command.&n; *      Function issues marker IOCB.&n; *&n; * Input:&n; *      ha   = adapter block pointer.&n; *      bus  = SCSI BUS number&n; *      id   = SCSI ID&n; *      lun  = SCSI LUN&n; *      type = marker modifier&n; */
r_static
r_void
DECL|function|qla1280_marker
id|qla1280_marker
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
comma
r_int
id|id
comma
r_int
id|lun
comma
id|u8
id|type
)paren
(brace
id|mrk_entry_t
op_star
id|pkt
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_marker&quot;
)paren
suffix:semicolon
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
(paren
id|pkt
op_assign
(paren
id|mrk_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|MARKER_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
(paren
r_uint8
)paren
id|lun
suffix:semicolon
id|pkt-&gt;target
op_assign
(paren
r_uint8
)paren
(paren
id|bus
ques
c_cond
(paren
id|id
op_or
id|BIT_7
)paren
suffix:colon
id|id
)paren
suffix:semicolon
id|pkt-&gt;modifier
op_assign
id|type
suffix:semicolon
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_marker&quot;
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,18)
multiline_comment|/*&n; * qla1280_64bit_start_scsi&n; *      The start SCSI is responsible for building request packets on&n; *      request ring and modifying ISP input pointer.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      sp = SB structure pointer.&n; *&n; * Returns:&n; *      0 = success, was able to issue command.&n; */
r_static
r_int
DECL|function|qla1280_64bit_start_scsi
id|qla1280_64bit_start_scsi
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|cmd_a64_entry_t
op_star
id|pkt
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
l_int|NULL
suffix:semicolon
id|u32
op_star
id|dword_ptr
suffix:semicolon
id|dma_addr_t
id|dma_handle
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
id|req_cnt
suffix:semicolon
id|u16
id|seg_cnt
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_64bit_start_scsi:&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;64bit_start: cmd=%p sp=%p CDB=%x&bslash;n&quot;
comma
id|cmd
comma
id|sp
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Calculate number of entries and segments required. */
id|req_cnt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
multiline_comment|/* 3.13 64 bit */
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
id|seg_cnt
op_assign
id|pci_map_sg
(paren
id|ha-&gt;pdev
comma
id|sg
comma
id|cmd-&gt;use_sg
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|seg_cnt
OG
l_int|2
)paren
(brace
id|req_cnt
op_add_assign
(paren
id|seg_cnt
op_minus
l_int|2
)paren
op_div
l_int|5
suffix:semicolon
r_if
c_cond
(paren
(paren
id|seg_cnt
op_minus
l_int|2
)paren
op_mod
l_int|5
)paren
id|req_cnt
op_increment
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
)paren
(brace
multiline_comment|/* If data transfer. */
id|seg_cnt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|seg_cnt
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
op_ge
id|ha-&gt;req_q_cnt
)paren
(brace
multiline_comment|/* Calculate number of free request entries. */
id|cnt
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
OL
id|cnt
)paren
id|ha-&gt;req_q_cnt
op_assign
id|cnt
op_minus
id|ha-&gt;req_ring_index
suffix:semicolon
r_else
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
op_minus
(paren
id|ha-&gt;req_ring_index
op_minus
id|cnt
)paren
suffix:semicolon
)brace
multiline_comment|/* If room for request in request ring. */
r_if
c_cond
(paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
OL
id|ha-&gt;req_q_cnt
)paren
(brace
multiline_comment|/* Check for room in outstanding command list. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
op_logical_and
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_ne
l_int|0
suffix:semicolon
id|cnt
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
(brace
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
id|sp
suffix:semicolon
id|ha-&gt;req_q_cnt
op_sub_assign
id|req_cnt
suffix:semicolon
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
r_int
r_int
)paren
id|cnt
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Build command packet.&n;&t;&t;&t; */
id|pkt
op_assign
(paren
id|cmd_a64_entry_t
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
id|pkt-&gt;entry_type
op_assign
id|COMMAND_A64_TYPE
suffix:semicolon
id|pkt-&gt;entry_count
op_assign
(paren
r_uint8
)paren
id|req_cnt
suffix:semicolon
id|pkt-&gt;sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
id|pkt-&gt;handle
op_assign
(paren
r_uint32
)paren
id|cnt
suffix:semicolon
multiline_comment|/* Zero out remaining portion of packet. */
id|memset
c_func
(paren
(paren
(paren
r_char
op_star
)paren
id|pkt
op_plus
l_int|8
)paren
comma
l_int|0
comma
(paren
id|REQUEST_ENTRY_SIZE
op_minus
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* Set ISP command timeout. */
id|pkt-&gt;timeout
op_assign
l_int|30
suffix:semicolon
multiline_comment|/* Set device target ID and LUN */
id|pkt-&gt;lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|pkt-&gt;target
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
ques
c_cond
(paren
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
op_or
id|BIT_7
)paren
suffix:colon
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Enable simple tag queuing if device supports it. */
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;tagged_queue
)paren
id|pkt-&gt;control_flags
op_or_assign
id|BIT_3
suffix:semicolon
multiline_comment|/* Load SCSI command packet. */
id|pkt-&gt;cdb_len
op_assign
(paren
r_uint16
)paren
id|CMD_CDBLEN
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|pkt-&gt;scsi_cdb
comma
op_amp
(paren
id|CMD_CDBP
c_func
(paren
id|cmd
)paren
)paren
comma
id|pkt-&gt;cdb_len
)paren
suffix:semicolon
multiline_comment|/* dprintk(1, &quot;Build packet for command[0]=0x%x&bslash;n&quot;,pkt-&gt;scsi_cdb[0]); */
multiline_comment|/*&n;&t;&t;&t; * Load data segments.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|seg_cnt
)paren
(brace
multiline_comment|/* If data transfer. */
multiline_comment|/* Set transfer direction. */
r_if
c_cond
(paren
(paren
id|cmd-&gt;data_cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
)paren
id|pkt-&gt;control_flags
op_or_assign
id|BIT_6
suffix:semicolon
r_else
id|pkt-&gt;control_flags
op_or_assign
(paren
id|BIT_5
op_or
id|BIT_6
)paren
suffix:semicolon
id|sp-&gt;dir
op_assign
id|pkt-&gt;control_flags
op_amp
(paren
id|BIT_5
op_or
id|BIT_6
)paren
suffix:semicolon
multiline_comment|/* Set total data segment count. */
id|pkt-&gt;dseg_count
op_assign
id|seg_cnt
suffix:semicolon
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
(paren
id|u32
op_star
)paren
op_amp
id|pkt-&gt;dseg_0_address
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
multiline_comment|/* If scatter gather */
multiline_comment|/* Load command entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|2
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
multiline_comment|/* 3.13 64 bit */
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_hi32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;S/G Segment phys_addr=%x %x, len=0x%x&bslash;n&quot;
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_hi32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
comma
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_64bit_start_scsi: Scatter/gather &quot;
l_string|&quot;command packet data - b %i, t %i, l %i &bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Build continuation packets.&n;&t;&t;&t;&t;&t; */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;S/G Building Continuation...seg_cnt=0x%x &quot;
l_string|&quot;remains&bslash;n&quot;
comma
id|seg_cnt
)paren
suffix:semicolon
r_while
c_loop
(paren
id|seg_cnt
OG
l_int|0
)paren
(brace
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
id|pkt
op_assign
(paren
id|cmd_a64_entry_t
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
multiline_comment|/* Zero out packet. */
id|memset
c_func
(paren
id|pkt
comma
l_int|0
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/* Load packet defaults. */
(paren
(paren
id|cont_a64_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_type
op_assign
id|CONTINUE_A64_TYPE
suffix:semicolon
(paren
(paren
id|cont_a64_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_count
op_assign
l_int|1
suffix:semicolon
(paren
(paren
id|cont_a64_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
(paren
id|u32
op_star
)paren
op_amp
(paren
(paren
id|cont_a64_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|dseg_0_address
suffix:semicolon
multiline_comment|/* Load continuation entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|5
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
multiline_comment|/* 3.13 64 bit */
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_hi32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;S/G Segment Cont. phys_addr=%x %x, len=0x%x&bslash;n&quot;
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_hi32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
comma
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_64bit_start_scsi: continuation &quot;
l_string|&quot;packet data - b %i, t %i, l %i &bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* No scatter gather data transfer */
multiline_comment|/* 3.13 64 bit */
id|dma_handle
op_assign
id|pci_map_single
c_func
(paren
id|ha-&gt;pdev
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;request_bufflen
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
multiline_comment|/* save dma_handle for pci_unmap_single */
id|sp-&gt;saved_dma_handle
op_assign
id|dma_handle
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|dma_handle
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_hi32
c_func
(paren
id|dma_handle
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_assign
(paren
r_uint32
)paren
id|cmd-&gt;request_bufflen
suffix:semicolon
multiline_comment|/* dprintk(1,&n;&t;&t;&t;&t;&t;   &quot;No S/G map_single saved_dma_handle=%lx&bslash;n&quot;,dma_handle);&n;&t;&t;&t;&t;&t;*/
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_64bit_start_scsi: No scatter/gather &quot;
l_string|&quot;command packet data - b %i, t %i, l %i &bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* No data transfer */
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
(paren
id|pkt
op_plus
l_int|1
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|dword_ptr
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_64bit_start_scsi: No data, command &quot;
l_string|&quot;packet data - b %i, t %i, l %i &bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
multiline_comment|/* Set chip new ring index. */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_64bit_start_scsi: Wakeup RISC for pending command&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;qthreads
op_decrement
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_SENT
suffix:semicolon
id|ha-&gt;actthreads
op_increment
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
comma
id|ha-&gt;req_ring_index
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_64bit_start_scsi: NO ROOM IN &quot;
l_string|&quot;OUTSTANDING ARRAY, req_q_cnt=0x%x&quot;
comma
id|ha-&gt;req_q_cnt
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|status
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_64bit_start_scsi: in-ptr=0x%x  req_q_cnt=0x%x&quot;
l_string|&quot;req_cnt=0x%x&quot;
comma
id|ha-&gt;req_ring_index
comma
id|ha-&gt;req_q_cnt
comma
id|req_cnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_64bit_start_scsi: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_64bit_start_scsi: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * qla1280_32bit_start_scsi&n; *      The start SCSI is responsible for building request packets on&n; *      request ring and modifying ISP input pointer.&n; *&n; *      The Qlogic firmware interface allows every queue slot to have a SCSI&n; *      command and up to 4 scatter/gather (SG) entries.  If we need more&n; *      than 4 SG entries, then continuation entries are used that can&n; *      hold another 7 entries each.  The start routine determines if there&n; *      is eought empty slots then build the combination of requests to&n; *      fulfill the OS request.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      sp = SCSI Request Block structure pointer.&n; *&n; * Returns:&n; *      0 = success, was able to issue command.&n; */
r_static
r_int
DECL|function|qla1280_32bit_start_scsi
id|qla1280_32bit_start_scsi
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|srb_t
op_star
id|sp
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|cmd_entry_t
op_star
id|pkt
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
l_int|NULL
suffix:semicolon
r_uint32
op_star
id|dword_ptr
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
id|req_cnt
suffix:semicolon
r_uint16
id|seg_cnt
suffix:semicolon
id|dma_addr_t
id|dma_handle
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_32bit_start_scsi&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;32bit_start: cmd=%p sp=%p CDB=%x&bslash;n&quot;
comma
id|cmd
comma
id|sp
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Calculate number of entries and segments required. */
id|req_cnt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
multiline_comment|/*&n;&t;&t; * We must build an SG list in adapter format, as the kernel&squot;s SG list&n;&t;&t; * cannot be used directly because of data field size (__alpha__)&n;&t;&t; * differences and the kernel SG list uses virtual addresses where&n;&t;&t; * we need physical addresses.&n;&t;&t; */
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
multiline_comment|/* 3.13 32 bit */
id|seg_cnt
op_assign
id|pci_map_sg
(paren
id|ha-&gt;pdev
comma
id|sg
comma
id|cmd-&gt;use_sg
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * if greater than four sg entries then we need to allocate&n;&t;&t; * continuation entries&n;&t;&t; */
r_if
c_cond
(paren
id|seg_cnt
OG
l_int|4
)paren
(brace
id|req_cnt
op_add_assign
(paren
id|seg_cnt
op_minus
l_int|4
)paren
op_div
l_int|7
suffix:semicolon
r_if
c_cond
(paren
(paren
id|seg_cnt
op_minus
l_int|4
)paren
op_mod
l_int|7
)paren
id|req_cnt
op_increment
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;S/G Transfer cmd=%p seg_cnt=0x%x, req_cnt=%x&bslash;n&quot;
comma
id|cmd
comma
id|seg_cnt
comma
id|req_cnt
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;request_bufflen
)paren
(brace
multiline_comment|/* If data transfer. */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;No S/G transfer t=%x cmd=%p len=%x CDB=%x&bslash;n&quot;
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|cmd
comma
id|cmd-&gt;request_bufflen
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|seg_cnt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* dprintk(1, &quot;No data transfer &bslash;n&quot;); */
id|seg_cnt
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
op_ge
id|ha-&gt;req_q_cnt
)paren
(brace
multiline_comment|/* Calculate number of free request entries. */
id|cnt
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
OL
id|cnt
)paren
id|ha-&gt;req_q_cnt
op_assign
id|cnt
op_minus
id|ha-&gt;req_ring_index
suffix:semicolon
r_else
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
op_minus
(paren
id|ha-&gt;req_ring_index
op_minus
id|cnt
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;Number of free entries=(%d) seg_cnt=0x%x&bslash;n&quot;
comma
id|ha-&gt;req_q_cnt
comma
id|seg_cnt
)paren
suffix:semicolon
multiline_comment|/* If room for request in request ring. */
r_if
c_cond
(paren
(paren
id|req_cnt
op_plus
l_int|2
)paren
OL
id|ha-&gt;req_q_cnt
)paren
(brace
multiline_comment|/* Check for empty slot in outstanding command list. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
op_logical_and
(paren
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_ne
l_int|0
)paren
suffix:semicolon
id|cnt
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
(brace
id|CMD_HANDLE
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
r_int
r_int
)paren
id|cnt
suffix:semicolon
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
id|sp
suffix:semicolon
id|ha-&gt;req_q_cnt
op_sub_assign
id|req_cnt
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Build command packet.&n;&t;&t;&t; */
id|pkt
op_assign
(paren
id|cmd_entry_t
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
id|pkt-&gt;entry_type
op_assign
id|COMMAND_TYPE
suffix:semicolon
id|pkt-&gt;entry_count
op_assign
(paren
r_uint8
)paren
id|req_cnt
suffix:semicolon
id|pkt-&gt;sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
id|pkt-&gt;handle
op_assign
(paren
r_uint32
)paren
id|cnt
suffix:semicolon
multiline_comment|/* Zero out remaining portion of packet. */
id|memset
c_func
(paren
(paren
(paren
r_char
op_star
)paren
id|pkt
op_plus
l_int|8
)paren
comma
l_int|0
comma
(paren
id|REQUEST_ENTRY_SIZE
op_minus
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* Set ISP command timeout. */
id|pkt-&gt;timeout
op_assign
l_int|30
suffix:semicolon
multiline_comment|/* Set device target ID and LUN */
id|pkt-&gt;lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|pkt-&gt;target
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
ques
c_cond
(paren
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
op_or
id|BIT_7
)paren
suffix:colon
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Enable simple tag queuing if device supports it. */
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;tagged_queue
)paren
id|pkt-&gt;control_flags
op_or_assign
id|BIT_3
suffix:semicolon
multiline_comment|/* Load SCSI command packet. */
id|pkt-&gt;cdb_len
op_assign
(paren
r_uint16
)paren
id|CMD_CDBLEN
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|pkt-&gt;scsi_cdb
comma
op_amp
(paren
id|CMD_CDBP
c_func
(paren
id|cmd
)paren
)paren
comma
id|pkt-&gt;cdb_len
)paren
suffix:semicolon
multiline_comment|/*dprintk(1, &quot;Build packet for command[0]=0x%x&bslash;n&quot;,pkt-&gt;scsi_cdb[0]); */
multiline_comment|/*&n;&t;&t;&t; * Load data segments.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|seg_cnt
)paren
(brace
multiline_comment|/* Set transfer direction (READ and WRITE) */
multiline_comment|/* Linux doesn&squot;t tell us                   */
multiline_comment|/*&n;&t;&t;&t;&t; * For block devices, cmd-&gt;request.cmd has the operation&n;&t;&t;&t;&t; * For character devices, this isn&squot;t always set properly, so&n;&t;&t;&t;&t; * we need to check data_cmnd[0].  This catches the conditions&n;&t;&t;&t;&t; * for st.c, but not sg. Generic commands are pass down to us.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|cmd-&gt;data_cmnd
(braket
l_int|0
)braket
op_eq
id|WRITE_6
)paren
)paren
id|pkt-&gt;control_flags
op_or_assign
id|BIT_6
suffix:semicolon
r_else
id|pkt-&gt;control_flags
op_or_assign
(paren
id|BIT_5
op_or
id|BIT_6
)paren
suffix:semicolon
id|sp-&gt;dir
op_assign
id|pkt-&gt;control_flags
op_amp
(paren
id|BIT_5
op_or
id|BIT_6
)paren
suffix:semicolon
multiline_comment|/* Set total data segment count. */
id|pkt-&gt;dseg_count
op_assign
id|seg_cnt
suffix:semicolon
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
op_amp
id|pkt-&gt;dseg_0_address
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
multiline_comment|/* If scatter gather */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;Building S/G data &quot;
l_string|&quot;segments..&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|1
comma
(paren
r_char
op_star
)paren
id|sg
comma
l_int|4
op_star
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Load command entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|4
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
multiline_comment|/* 3.13 32 bit */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,18)
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
id|sg-&gt;address
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|sg-&gt;length
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;S/G Segment phys_addr=0x%x, len=0x%x&bslash;n&quot;
comma
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
id|sg-&gt;address
)paren
)paren
comma
id|sg-&gt;length
)paren
suffix:semicolon
macro_line|#else
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;S/G Segment phys_addr=0x%x, len=0x%x&bslash;n&quot;
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
comma
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|sg
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Build continuation packets.&n;&t;&t;&t;&t;&t; */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;S/G Building Continuation&quot;
l_string|&quot;...seg_cnt=0x%x remains&bslash;n&quot;
comma
id|seg_cnt
)paren
suffix:semicolon
r_while
c_loop
(paren
id|seg_cnt
OG
l_int|0
)paren
(brace
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
id|pkt
op_assign
(paren
id|cmd_entry_t
op_star
)paren
id|ha-&gt;request_ring_ptr
suffix:semicolon
multiline_comment|/* Zero out packet. */
id|memset
c_func
(paren
id|pkt
comma
l_int|0
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/* Load packet defaults. */
(paren
(paren
id|cont_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_type
op_assign
id|CONTINUE_TYPE
suffix:semicolon
(paren
(paren
id|cont_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|entry_count
op_assign
l_int|1
suffix:semicolon
(paren
(paren
id|cont_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|sys_define
op_assign
(paren
r_uint8
)paren
id|ha
op_member_access_from_pointer
id|req_ring_index
suffix:semicolon
multiline_comment|/* Setup packet address segment pointer. */
id|dword_ptr
op_assign
op_amp
(paren
(paren
id|cont_entry_t
op_star
)paren
id|pkt
)paren
op_member_access_from_pointer
id|dseg_0_address
suffix:semicolon
multiline_comment|/* Load continuation entry data segments. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
l_int|7
op_logical_and
id|seg_cnt
suffix:semicolon
id|cnt
op_increment
comma
id|seg_cnt
op_decrement
)paren
(brace
multiline_comment|/* 3.13 32 bit */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,18)
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
id|sg-&gt;address
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|sg-&gt;length
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;S/G Segment Cont. phys_addr=0x%x, len=0x%x&bslash;n&quot;
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|virt_to_bus
c_func
(paren
id|sg-&gt;address
)paren
)paren
)paren
comma
id|sg-&gt;length
)paren
suffix:semicolon
macro_line|#else
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;S/G Segment Cont. phys_addr=0x%x, &quot;
l_string|&quot;len=0x%x&bslash;n&quot;
comma
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
)paren
comma
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|sg
op_increment
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_32bit_start_scsi: continuation &quot;
l_string|&quot;packet data - scsi(%i:%i:%i)&bslash;n&quot;
comma
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
comma
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* No S/G data transfer */
multiline_comment|/* 3.13 32 bit */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,18)
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|cmd-&gt;request_buffer
)paren
)paren
suffix:semicolon
macro_line|#else
id|dma_handle
op_assign
id|pci_map_single
c_func
(paren
id|ha-&gt;pdev
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;request_bufflen
comma
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
)paren
suffix:semicolon
id|sp-&gt;saved_dma_handle
op_assign
id|dma_handle
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_dma_lo32
c_func
(paren
id|dma_handle
)paren
)paren
suffix:semicolon
macro_line|#endif
op_star
id|dword_ptr
op_assign
(paren
r_uint32
)paren
id|cmd-&gt;request_bufflen
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* No data transfer at all */
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
(paren
id|pkt
op_plus
l_int|1
)paren
suffix:semicolon
op_star
id|dword_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|dword_ptr
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_32bit_start_scsi: No data, command &quot;
l_string|&quot;packet data - &bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_32bit_start_scsi: First IOCB block:&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|ha-&gt;request_ring_ptr
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
multiline_comment|/* Set chip new ring index. */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;qla1280_32bit_start_scsi: Wakeup RISC &quot;
l_string|&quot;for pending command&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;qthreads
op_decrement
suffix:semicolon
id|sp-&gt;flags
op_or_assign
id|SRB_SENT
suffix:semicolon
id|ha-&gt;actthreads
op_increment
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
comma
id|ha-&gt;req_ring_index
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_32bit_start_scsi: NO ROOM IN OUTSTANDING &quot;
l_string|&quot;ARRAY, req_q_cnt=0x%x&bslash;n&quot;
comma
id|ha-&gt;req_q_cnt
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|status
op_assign
l_int|1
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_32bit_start_scsi: in-ptr=0x%x, req_q_cnt=0x%x, &quot;
l_string|&quot;req_cnt=0x%x&quot;
comma
id|ha-&gt;req_ring_index
comma
id|ha-&gt;req_q_cnt
comma
id|req_cnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_32bit_start_scsi: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_32bit_start_scsi&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_req_pkt&n; *      Function is responsible for locking ring and&n; *      getting a zeroed out request packet.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; *&n; * Returns:&n; *      0 = failed to get slot.&n; */
r_static
id|request_t
op_star
DECL|function|qla1280_req_pkt
id|qla1280_req_pkt
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|request_t
op_star
id|pkt
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_uint32
id|timer
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_req_pkt&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This can be called from interrupt context, damn it!!!&n;&t; */
multiline_comment|/* Wait for 30 seconds for slot. */
r_for
c_loop
(paren
id|timer
op_assign
l_int|15000000
suffix:semicolon
id|timer
suffix:semicolon
id|timer
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;req_q_cnt
OG
l_int|0
)paren
(brace
multiline_comment|/* Calculate number of free request entries. */
id|cnt
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
OL
id|cnt
)paren
id|ha-&gt;req_q_cnt
op_assign
id|cnt
op_minus
id|ha-&gt;req_ring_index
suffix:semicolon
r_else
id|ha-&gt;req_q_cnt
op_assign
id|REQUEST_ENTRY_CNT
op_minus
(paren
id|ha-&gt;req_ring_index
op_minus
id|cnt
)paren
suffix:semicolon
)brace
multiline_comment|/* Found empty request ring slot? */
r_if
c_cond
(paren
id|ha-&gt;req_q_cnt
OG
l_int|0
)paren
(brace
id|ha-&gt;req_q_cnt
op_decrement
suffix:semicolon
id|pkt
op_assign
id|ha-&gt;request_ring_ptr
suffix:semicolon
multiline_comment|/* Zero out packet. */
id|memset
c_func
(paren
id|pkt
comma
l_int|0
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/* Set system defined field. */
id|pkt-&gt;sys_define
op_assign
(paren
r_uint8
)paren
id|ha-&gt;req_ring_index
suffix:semicolon
multiline_comment|/* Set entry count. */
id|pkt-&gt;entry_count
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 10 */
multiline_comment|/* Check for pending interrupts. */
id|qla1280_poll
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_req_pkt: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_req_pkt: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|pkt
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_isp_cmd&n; *      Function is responsible for modifying ISP input pointer.&n; *      Releases ring lock.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_isp_cmd
id|qla1280_isp_cmd
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_isp_cmd&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_isp_cmd: IOCB data:&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|ha-&gt;request_ring_ptr
comma
id|REQUEST_ENTRY_SIZE
)paren
suffix:semicolon
multiline_comment|/* Adjust ring index. */
id|ha-&gt;req_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;req_ring_index
op_eq
id|REQUEST_ENTRY_CNT
)paren
(brace
id|ha-&gt;req_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;request_ring_ptr
op_assign
id|ha-&gt;request_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;request_ring_ptr
op_increment
suffix:semicolon
multiline_comment|/* Set chip new ring index. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
comma
id|ha-&gt;req_ring_index
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_isp_cmd&quot;
)paren
suffix:semicolon
)brace
macro_line|#if QL1280_LUN_SUPPORT
multiline_comment|/*&n; * qla1280_enable_lun&n; *      Issue enable LUN entry IOCB.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; *      bus = SCSI BUS number.&n; *      lun  = LUN number.&n; */
r_static
r_void
DECL|function|qla1280_enable_lun
id|qla1280_enable_lun
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
comma
r_int
id|lun
)paren
(brace
id|elun_entry_t
op_star
id|pkt
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_enable_lun&quot;
)paren
suffix:semicolon
multiline_comment|/* Get request packet. */
multiline_comment|/*&n;&t;  if (pkt = (elun_entry_t *)qla1280_req_pkt(ha))&n;&t;  {&n;&t;  pkt-&gt;entry_type = ENABLE_LUN_TYPE;&n;&t;  pkt-&gt;lun = (uint16_t)(bus ? lun | BIT_15 : lun);&n;&t;  pkt-&gt;command_count = 32;&n;&t;  pkt-&gt;immed_notify_count = 1;&n;&t;  pkt-&gt;group_6_length = MAX_CMDSZ;&n;&t;  pkt-&gt;group_7_length = MAX_CMDSZ;&n;&t;  pkt-&gt;timeout = 0x30;&n;&n;&t;  qla1280_isp_cmd(ha);&n;&t;  }&n;&t;*/
id|pkt
op_assign
(paren
id|elun_entry_t
op_star
)paren
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_enable_lun: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_enable_lun: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if QL1280_TARGET_MODE_SUPPORT
multiline_comment|/****************************************************************************/
multiline_comment|/*                      Target Mode Support Functions.                      */
multiline_comment|/****************************************************************************/
multiline_comment|/*&n; * qla1280_notify_ack&n; *      Issue notify acknowledge IOCB.&n; *      If sequence ID is zero, acknowledgement of&n; *      SCSI bus reset or bus device reset is assumed.&n; *&n; * Input:&n; *      ha      = adapter block pointer.&n; *      inotify = immediate notify entry pointer.&n; */
r_static
r_void
DECL|function|qla1280_notify_ack
id|qla1280_notify_ack
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|notify_entry_t
op_star
id|inotify
)paren
(brace
id|nack_entry_t
op_star
id|pkt
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_notify_ack: entered&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
id|pkt
op_assign
(paren
id|nack_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|NOTIFY_ACK_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
id|inotify-&gt;lun
suffix:semicolon
id|pkt-&gt;initiator_id
op_assign
id|inotify-&gt;initiator_id
suffix:semicolon
id|pkt-&gt;target_id
op_assign
id|inotify-&gt;target_id
suffix:semicolon
r_if
c_cond
(paren
id|inotify-&gt;seq_id
op_eq
l_int|0
)paren
id|pkt-&gt;event
op_assign
id|BIT_7
suffix:semicolon
r_else
id|pkt-&gt;seq_id
op_assign
id|inotify-&gt;seq_id
suffix:semicolon
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_notify_ack: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_notify_ack: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_immed_notify&n; *      Issue immediate notify IOCB for LUN 0.&n; *&n; * Input:&n; *      ha      = adapter block pointer.&n; *      inotify = immediate notify entry pointer.&n; */
r_static
r_void
DECL|function|qla1280_immed_notify
id|qla1280_immed_notify
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|notify_entry_t
op_star
id|inotify
)paren
(brace
id|notify_entry_t
op_star
id|pkt
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_immed_notify: entered&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
id|pkt
op_assign
(paren
id|notify_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|IMMED_NOTIFY_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
id|inotify-&gt;lun
suffix:semicolon
id|pkt-&gt;initiator_id
op_assign
id|inotify-&gt;initiator_id
suffix:semicolon
id|pkt-&gt;target_id
op_assign
id|inotify-&gt;target_id
suffix:semicolon
id|pkt-&gt;status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_immed_notify: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_immed_notify: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_accept_io&n; *      Issue accept target I/O IOCB for LUN 0.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; *      ctio = ctio returned entry pointer.&n; */
r_static
r_void
DECL|function|qla1280_accept_io
id|qla1280_accept_io
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|ctio_ret_entry_t
op_star
id|ctio
)paren
(brace
id|atio_entry_t
op_star
id|pkt
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_accept_io: entered&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
id|pkt
op_assign
(paren
id|atio_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|ACCEPT_TGT_IO_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
id|ctio-&gt;lun
suffix:semicolon
id|pkt-&gt;initiator_id
op_assign
id|ctio-&gt;initiator_id
suffix:semicolon
id|pkt-&gt;target_id
op_assign
id|ctio-&gt;target_id
suffix:semicolon
id|pkt-&gt;tag_value
op_assign
id|ctio-&gt;tag_value
suffix:semicolon
id|pkt-&gt;status
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_accept_io: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_accept_io: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_64bit_continue_io&n; *      Issue continue target I/O IOCB.&n; *&n; * Input:&n; *      ha   = adapter block pointer.&n; *      atio = atio pointer.&n; *      len  = total bytecount.&n; *      addr = physical address pointer.&n; */
r_static
r_void
DECL|function|qla1280_64bit_continue_io
id|qla1280_64bit_continue_io
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|atio_entry_t
op_star
id|atio
comma
r_uint32
id|len
comma
id|paddr32_t
op_star
id|addr
)paren
(brace
id|ctio_a64_entry_t
op_star
id|pkt
suffix:semicolon
r_uint32
op_star
id|dword_ptr
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_64bit_continue_io: entered&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
id|pkt
op_assign
(paren
id|ctio_a64_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|CTIO_A64_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
id|atio-&gt;lun
suffix:semicolon
id|pkt-&gt;initiator_id
op_assign
id|atio-&gt;initiator_id
suffix:semicolon
id|pkt-&gt;target_id
op_assign
id|atio-&gt;target_id
suffix:semicolon
id|pkt-&gt;option_flags
op_assign
id|atio-&gt;option_flags
suffix:semicolon
id|pkt-&gt;tag_value
op_assign
id|atio-&gt;tag_value
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|atio-&gt;scsi_status
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
id|pkt-&gt;dseg_count
op_assign
l_int|1
suffix:semicolon
id|pkt-&gt;transfer_length
op_assign
id|len
suffix:semicolon
id|pkt-&gt;dseg_0_length
op_assign
id|len
suffix:semicolon
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
id|addr
suffix:semicolon
id|pkt-&gt;dseg_0_address
(braket
l_int|0
)braket
op_assign
op_star
id|dword_ptr
op_increment
suffix:semicolon
id|pkt-&gt;dseg_0_address
(braket
l_int|1
)braket
op_assign
op_star
id|dword_ptr
suffix:semicolon
)brace
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_64bit_continue_io: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_64bit_continue_io: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_32bit_continue_io&n; *      Issue continue target I/O IOCB.&n; *&n; * Input:&n; *      ha   = adapter block pointer.&n; *      atio = atio pointer.&n; *      len  = total bytecount.&n; *      addr = physical address pointer.&n; */
r_static
r_void
DECL|function|qla1280_32bit_continue_io
id|qla1280_32bit_continue_io
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|atio_entry_t
op_star
id|atio
comma
r_uint32
id|len
comma
id|paddr32_t
op_star
id|addr
)paren
(brace
id|ctio_entry_t
op_star
id|pkt
suffix:semicolon
r_uint32
op_star
id|dword_ptr
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_32bit_continue_io: entered&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Get request packet. */
r_if
c_cond
(paren
id|pkt
op_assign
(paren
id|ctio_entry_t
op_star
)paren
id|qla1280_req_pkt
c_func
(paren
id|ha
)paren
)paren
(brace
id|pkt-&gt;entry_type
op_assign
id|CONTINUE_TGT_IO_TYPE
suffix:semicolon
id|pkt-&gt;lun
op_assign
id|atio-&gt;lun
suffix:semicolon
id|pkt-&gt;initiator_id
op_assign
id|atio-&gt;initiator_id
suffix:semicolon
id|pkt-&gt;target_id
op_assign
id|atio-&gt;target_id
suffix:semicolon
id|pkt-&gt;option_flags
op_assign
id|atio-&gt;option_flags
suffix:semicolon
id|pkt-&gt;tag_value
op_assign
id|atio-&gt;tag_value
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|atio-&gt;scsi_status
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
id|pkt-&gt;dseg_count
op_assign
l_int|1
suffix:semicolon
id|pkt-&gt;transfer_length
op_assign
id|len
suffix:semicolon
id|pkt-&gt;dseg_0_length
op_assign
id|len
suffix:semicolon
id|dword_ptr
op_assign
(paren
r_uint32
op_star
)paren
id|addr
suffix:semicolon
id|pkt-&gt;dseg_0_address
op_assign
op_star
id|dword_ptr
suffix:semicolon
)brace
multiline_comment|/* Issue command to ISP */
id|qla1280_isp_cmd
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_32bit_continue_io: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_32bit_continue_io: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* QL1280_TARGET_MODE_SUPPORT */
multiline_comment|/****************************************************************************/
multiline_comment|/*                        Interrupt Service Routine.                        */
multiline_comment|/****************************************************************************/
multiline_comment|/****************************************************************************&n; *  qla1280_isr&n; *      Calls I/O done on command completion.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      done_q_first = done queue first pointer.&n; *      done_q_last  = done queue last pointer.&n; ****************************************************************************/
r_static
r_void
DECL|function|qla1280_isr
id|qla1280_isr
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|srb_t
op_star
op_star
id|done_q_first
comma
id|srb_t
op_star
op_star
id|done_q_last
)paren
(brace
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
id|response_t
op_star
id|pkt
suffix:semicolon
id|srb_t
op_star
id|sp
op_assign
l_int|0
suffix:semicolon
r_uint16
id|mailbox
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
r_uint16
op_star
id|wptr
suffix:semicolon
r_uint32
id|index
suffix:semicolon
id|u16
id|istatus
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_isr&quot;
)paren
suffix:semicolon
id|istatus
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;istatus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|istatus
op_amp
(paren
id|RISC_INT
op_or
id|PCI_INT
)paren
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Save mailbox register 5 */
id|mailbox
(braket
l_int|5
)braket
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox5
)paren
suffix:semicolon
multiline_comment|/* Check for mailbox interrupt. */
id|mailbox
(braket
l_int|0
)braket
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
op_amp
id|BIT_0
)paren
(brace
multiline_comment|/* Get mailbox data. */
multiline_comment|/* dprintk(1, &quot;qla1280_isr: In Get mailbox data &bslash;n&quot;); */
id|wptr
op_assign
op_amp
id|mailbox
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox0
)paren
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox1
)paren
suffix:semicolon
op_star
id|wptr
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
op_ne
id|MBA_SCSI_COMPLETION
)paren
(brace
id|wptr
op_increment
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox3
)paren
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox4
)paren
suffix:semicolon
id|wptr
op_increment
suffix:semicolon
op_star
id|wptr
op_increment
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox6
)paren
suffix:semicolon
op_star
id|wptr
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox7
)paren
suffix:semicolon
)brace
multiline_comment|/* Release mailbox registers. */
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;semaphore
comma
l_int|0
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_RISC_INT
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_isr: mailbox interrupt mailbox[0] = 0x%x&quot;
comma
id|mailbox
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Handle asynchronous event */
r_switch
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
)paren
(brace
r_case
id|MBA_SCSI_COMPLETION
suffix:colon
multiline_comment|/* Response completion */
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_isr: mailbox SCSI response completion&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.online
)paren
(brace
multiline_comment|/* Get outstanding command index. */
id|index
op_assign
id|mailbox
(braket
l_int|2
)braket
op_lshift
l_int|16
op_or
id|mailbox
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|index
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|index
)braket
suffix:semicolon
r_else
id|sp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|index
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Save ISP completion status */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Place block on done queue */
id|sp-&gt;s_next
op_assign
l_int|NULL
suffix:semicolon
id|sp-&gt;s_prev
op_assign
op_star
id|done_q_last
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|done_q_first
)paren
op_star
id|done_q_first
op_assign
id|sp
suffix:semicolon
r_else
(paren
op_star
id|done_q_last
)paren
op_member_access_from_pointer
id|s_next
op_assign
id|sp
suffix:semicolon
op_star
id|done_q_last
op_assign
id|sp
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * If we get here we have a real problem!&n;&t;&t;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP invalid handle&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|MBA_BUS_RESET
suffix:colon
multiline_comment|/* SCSI Bus Reset */
id|ha-&gt;flags.reset_marker
op_assign
id|TRUE
suffix:semicolon
id|index
op_assign
id|mailbox
(braket
l_int|6
)braket
op_amp
id|BIT_0
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|index
)braket
dot
id|reset_marker
op_assign
id|TRUE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;qla1280_isr(): index %i asynchronous &quot;
l_string|&quot;BUS_RESET&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_SYSTEM_ERR
suffix:colon
multiline_comment|/* System Error */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP System Error - mbx1=%xh, mbx2=%xh, &quot;
l_string|&quot;mbx3=%xh&bslash;n&quot;
comma
id|mailbox
(braket
l_int|1
)braket
comma
id|mailbox
(braket
l_int|2
)braket
comma
id|mailbox
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_REQ_TRANSFER_ERR
suffix:colon
multiline_comment|/* Request Transfer Error */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP Request Transfer Error&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_RSP_TRANSFER_ERR
suffix:colon
multiline_comment|/* Response Transfer Error */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP Response Transfer Error&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_WAKEUP_THRES
suffix:colon
multiline_comment|/* Request Queue Wake-up */
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: asynchronous WAKEUP_THRES&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_TIMEOUT_RESET
suffix:colon
multiline_comment|/* Execution Timeout Reset */
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: asynchronous TIMEOUT_RESET&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_DEVICE_RESET
suffix:colon
multiline_comment|/* Bus Device Reset */
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: asynchronous BUS_DEVICE_RESET&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;qla1280_isr(): asynchronous &quot;
l_string|&quot;BUS_DEVICE_RESET&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.reset_marker
op_assign
id|TRUE
suffix:semicolon
id|index
op_assign
id|mailbox
(braket
l_int|6
)braket
op_amp
id|BIT_0
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|index
)braket
dot
id|reset_marker
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MBA_BUS_MODE_CHANGE
suffix:colon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: asynchronous BUS_MODE_CHANGE&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* dprintk(1, &quot;qla1280_isr: default case of switch MB &bslash;n&quot;); */
r_if
c_cond
(paren
id|mailbox
(braket
l_int|0
)braket
OL
id|MBA_ASYNC_EVENT
)paren
(brace
id|wptr
op_assign
op_amp
id|mailbox
(braket
l_int|0
)braket
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_uint16
op_star
)paren
id|ha-&gt;mailbox_out
comma
id|wptr
comma
id|MAILBOX_REGISTER_COUNT
op_star
r_sizeof
(paren
r_uint16
)paren
)paren
suffix:semicolon
id|ha-&gt;flags.mbox_int
op_assign
id|TRUE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_CLR_RISC_INT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Response ring - waiting for the mbox_busy flag here seems&n;&t; * unnecessary as the mailbox data has been copied to ha-&gt;mailbox_out&n;&t; * by the time we actually get here!&n;&t; */
r_if
c_cond
(paren
id|ha-&gt;flags.online
macro_line|#if 0
op_logical_and
op_logical_neg
id|ha-&gt;flags.mbox_busy
macro_line|#endif
)paren
(brace
r_if
c_cond
(paren
id|mailbox
(braket
l_int|5
)braket
OL
id|RESPONSE_ENTRY_CNT
)paren
(brace
r_while
c_loop
(paren
id|ha-&gt;rsp_ring_index
op_ne
id|mailbox
(braket
l_int|5
)braket
)paren
(brace
id|pkt
op_assign
id|ha-&gt;response_ring_ptr
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_isr: ha-&gt;rsp_ring_index = 0x%x, &quot;
l_string|&quot;mailbox[5] = 0x%x&bslash;n&quot;
comma
id|ha-&gt;rsp_ring_index
comma
id|mailbox
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
l_string|&quot;qla1280_isr: response packet data&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|5
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|RESPONSE_ENTRY_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|STATUS_TYPE
)paren
(brace
r_if
c_cond
(paren
(paren
id|pkt-&gt;scsi_status
op_amp
l_int|0xff
)paren
op_logical_or
id|pkt-&gt;comp_status
op_logical_or
id|pkt-&gt;entry_status
)paren
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: ha-&gt;rsp_ring_index = 0x%x&quot;
l_string|&quot;mailbox[5] = 0x%x, comp_status = 0x%x, &quot;
l_string|&quot;scsi_status = 0x%x&bslash;n&quot;
comma
id|ha-&gt;rsp_ring_index
comma
id|mailbox
(braket
l_int|5
)braket
comma
id|pkt-&gt;comp_status
comma
id|pkt-&gt;scsi_status
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: ha-&gt;rsp_ring_index = 0x%x, &quot;
l_string|&quot;mailbox[5] = 0x%x&bslash;n&quot;
comma
id|ha-&gt;rsp_ring_index
comma
id|mailbox
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: response packet data&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|2
comma
(paren
r_char
op_star
)paren
id|pkt
comma
id|RESPONSE_ENTRY_SIZE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|STATUS_TYPE
op_logical_or
id|pkt-&gt;entry_status
)paren
(brace
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|STATUS_TYPE
)paren
id|qla1280_status_entry
c_func
(paren
id|ha
comma
(paren
id|sts_entry_t
op_star
)paren
id|pkt
comma
id|done_q_first
comma
id|done_q_last
)paren
suffix:semicolon
r_else
id|qla1280_error_entry
c_func
(paren
id|ha
comma
id|pkt
comma
id|done_q_first
comma
id|done_q_last
)paren
suffix:semicolon
multiline_comment|/* Adjust ring index. */
id|ha-&gt;rsp_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;rsp_ring_index
op_eq
id|RESPONSE_ENTRY_CNT
)paren
(brace
id|ha-&gt;rsp_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;response_ring_ptr
op_assign
id|ha-&gt;response_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;response_ring_ptr
op_increment
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox5
comma
id|ha-&gt;rsp_ring_index
)paren
suffix:semicolon
)brace
macro_line|#if QLA1280_TARGET_MODE_SUPPORT
r_else
(brace
id|pkt
op_assign
op_amp
id|response_entry
suffix:semicolon
multiline_comment|/* Copy packet. */
id|dptr1
op_assign
(paren
r_uint32
op_star
)paren
id|ha-&gt;response_ring_ptr
suffix:semicolon
id|dptr2
op_assign
(paren
r_uint32
op_star
)paren
id|pkt
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|RESPONSE_ENTRY_SIZE
op_div
l_int|4
suffix:semicolon
id|index
op_increment
)paren
op_star
id|dptr2
op_increment
op_assign
op_star
id|dptr1
op_increment
suffix:semicolon
multiline_comment|/* Adjust ring index. */
id|ha-&gt;rsp_ring_index
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;rsp_ring_index
op_eq
id|RESPONSE_ENTRY_CNT
)paren
(brace
id|ha-&gt;rsp_ring_index
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;response_ring_ptr
op_assign
id|ha-&gt;response_ring
suffix:semicolon
)brace
r_else
id|ha-&gt;response_ring_ptr
op_increment
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;mailbox5
comma
id|ha-&gt;rsp_ring_index
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|pkt-&gt;entry_type
)paren
(brace
r_case
id|ACCEPT_TGT_IO_TYPE
suffix:colon
id|qla1280_atio_entry
c_func
(paren
id|ha
comma
(paren
id|atio_entry_t
op_star
)paren
id|pkt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMMED_NOTIFY_TYPE
suffix:colon
id|qla1280_notify_entry
c_func
(paren
id|ha
comma
(paren
id|notify_entry_t
op_star
)paren
id|pkt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTIO_RET_TYPE
suffix:colon
id|qla1280_accept_io
c_func
(paren
id|ha
comma
(paren
id|ctio_ret_entry_t
op_star
)paren
id|pkt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
)brace
r_else
(brace
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_isr: Response pointer Error&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_isr&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_rst_aen&n; *      Processes asynchronous reset.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_rst_aen
id|qla1280_rst_aen
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
macro_line|#if QL1280_TARGET_MODE_SUPPORT
id|notify_entry_t
id|nentry
suffix:semicolon
macro_line|#endif
r_uint8
id|bus
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_rst_aen&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ha-&gt;flags.online
op_logical_and
op_logical_neg
id|ha-&gt;flags.reset_active
op_logical_and
op_logical_neg
id|ha-&gt;flags.abort_isp_active
)paren
(brace
id|ha-&gt;flags.reset_active
op_assign
id|TRUE
suffix:semicolon
r_while
c_loop
(paren
id|ha-&gt;flags.reset_marker
)paren
(brace
multiline_comment|/* Issue marker command. */
id|ha-&gt;flags.reset_marker
op_assign
id|FALSE
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
op_logical_and
op_logical_neg
id|ha-&gt;flags.reset_marker
suffix:semicolon
id|bus
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|reset_marker
)paren
(brace
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|reset_marker
op_assign
id|FALSE
suffix:semicolon
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
l_int|0
comma
l_int|0
comma
id|MK_SYNC_ALL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.reset_marker
)paren
(brace
macro_line|#if QL1280_TARGET_MODE_SUPPORT
multiline_comment|/* Issue notify acknowledgement command. */
id|memset
c_func
(paren
op_amp
id|nentry
comma
l_int|0
comma
r_sizeof
(paren
id|notify_entry_t
)paren
)paren
suffix:semicolon
id|nentry.initiator_id
op_assign
id|nentry.target_id
op_assign
id|bus
ques
c_cond
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|id
op_or
id|BIT_7
suffix:colon
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|id
suffix:semicolon
id|qla1280_notify_entry
c_func
(paren
id|ha
comma
op_amp
id|nentry
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Asynchronous event notification */
)brace
)brace
)brace
)brace
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_rst_aen&quot;
)paren
suffix:semicolon
)brace
macro_line|#if QL1280_TARGET_MODE_SUPPORT
multiline_comment|/*&n; *  qla1280_atio_entry&n; *      Processes received ISP accept target I/O entry.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; *      pkt = entry pointer.&n; */
r_static
r_void
DECL|function|qla1280_atio_entry
id|qla1280_atio_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|atio_entry_t
op_star
id|pkt
)paren
(brace
r_uint64
op_star
id|a64
suffix:semicolon
r_uint64
op_star
id|end_a64
suffix:semicolon
id|paddr32_t
id|phy_addr
(braket
l_int|2
)braket
suffix:semicolon
id|paddr32_t
id|end_addr
(braket
l_int|2
)braket
suffix:semicolon
r_uint32
id|len
suffix:semicolon
r_uint32
id|offset
suffix:semicolon
r_uint8
id|t
suffix:semicolon
r_uint8
op_star
id|sense_ptr
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: entered&bslash;n&quot;
)paren
suffix:semicolon
id|t
op_assign
id|pkt-&gt;initiator_id
suffix:semicolon
id|sense_ptr
op_assign
id|ha-&gt;tsense
op_plus
id|t
op_star
id|TARGET_SENSE_SIZE
suffix:semicolon
id|a64
op_assign
(paren
r_uint64
op_star
)paren
op_amp
id|phy_addr
(braket
l_int|0
)braket
suffix:semicolon
id|end_a64
op_assign
(paren
r_uint64
op_star
)paren
op_amp
id|end_addr
(braket
l_int|0
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|pkt-&gt;status
op_amp
op_complement
id|BIT_7
)paren
(brace
r_case
l_int|7
suffix:colon
multiline_comment|/* Path invalid */
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: Path invalid&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x14
suffix:colon
multiline_comment|/* Target Bus Phase Sequence Failure */
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: Target Bus Phase &quot;
l_string|&quot;Sequence Failure&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;status
op_amp
id|BIT_7
)paren
(brace
id|memcpy
c_func
(paren
id|sense_ptr
comma
op_amp
id|pkt-&gt;sense_data
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|sense_ptr
comma
l_int|0
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_HARDERR
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_SELFAIL
suffix:semicolon
)brace
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
id|OF_SSTS
op_or
id|OF_NO_DATA
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,18)
r_if
c_cond
(paren
id|ha-&gt;flags.enable_64bit_addressing
)paren
id|qla1280_64bit_continue_io
c_func
(paren
id|ha
comma
id|pkt
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_else
macro_line|#endif
id|qla1280_32bit_continue_io
c_func
(paren
id|ha
comma
id|pkt
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x16
suffix:colon
multiline_comment|/* Requested Capability Not Available */
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: Target Bus Phase &quot;
l_string|&quot;Sequence Failure&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x17
suffix:colon
multiline_comment|/* Bus Device Reset Message Received */
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: Target Bus Phase &quot;
l_string|&quot;Sequence Failure&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x3D
suffix:colon
multiline_comment|/* CDB Received */
multiline_comment|/* Check for invalid LUN */
r_if
c_cond
(paren
id|pkt-&gt;lun
op_logical_and
id|pkt-&gt;cdb
(braket
l_int|0
)braket
op_ne
id|SS_INQUIR
op_logical_and
id|pkt-&gt;cdb
(braket
l_int|0
)braket
op_ne
id|SS_REQSEN
)paren
id|pkt-&gt;cdb
(braket
l_int|0
)braket
op_assign
id|SS_TEST
suffix:semicolon
r_switch
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|0
)braket
)paren
(brace
r_case
id|SS_TEST
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: SS_TEST&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sense_ptr
comma
l_int|0
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;lun
op_eq
l_int|0
)paren
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
r_else
(brace
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_INVLUN
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
)brace
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SS_REQSEN
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: SS_REQSEN&bslash;n&quot;
)paren
suffix:semicolon
id|phy_addr
(braket
l_int|0
)braket
op_assign
id|ha-&gt;tsense_dma
suffix:semicolon
id|phy_addr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|a64
op_add_assign
id|t
op_star
id|TARGET_SENSE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|4
)braket
OG
id|TARGET_SENSE_SIZE
)paren
id|len
op_assign
id|TARGET_SENSE_SIZE
suffix:semicolon
r_else
id|len
op_assign
id|pkt-&gt;cdb
(braket
l_int|4
)braket
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_DATA_IN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SS_INQUIR
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: SS_INQUIR&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sense_ptr
comma
l_int|0
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
id|phy_addr
(braket
l_int|0
)braket
op_assign
id|ha-&gt;tbuf_dma
suffix:semicolon
id|phy_addr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|a64
op_add_assign
id|TARGET_INQ_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;lun
op_eq
l_int|0
)paren
(brace
id|ha-&gt;tbuf-&gt;inq.id_type
op_assign
id|ID_PROCESOR
suffix:semicolon
id|ha-&gt;tbuf-&gt;inq.id_pqual
op_assign
id|ID_QOK
suffix:semicolon
)brace
r_else
(brace
id|ha-&gt;tbuf-&gt;inq.id_type
op_assign
id|ID_NODEV
suffix:semicolon
id|ha-&gt;tbuf-&gt;inq.id_pqual
op_assign
id|ID_QNOLU
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|4
)braket
OG
r_sizeof
(paren
r_struct
id|ident
)paren
)paren
id|len
op_assign
r_sizeof
(paren
r_struct
id|ident
)paren
suffix:semicolon
r_else
id|len
op_assign
id|pkt-&gt;cdb
(braket
l_int|4
)braket
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_DATA_IN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SM_WRDB
suffix:colon
id|memset
c_func
(paren
id|sense_ptr
comma
l_int|0
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
id|offset
op_assign
id|pkt-&gt;cdb
(braket
l_int|5
)braket
suffix:semicolon
id|offset
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|4
)braket
op_lshift
l_int|8
suffix:semicolon
id|offset
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|3
)braket
op_lshift
l_int|16
suffix:semicolon
id|len
op_assign
id|pkt-&gt;cdb
(braket
l_int|8
)braket
suffix:semicolon
id|len
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
suffix:semicolon
id|len
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|6
)braket
op_lshift
l_int|16
suffix:semicolon
id|end_addr
(braket
l_int|0
)braket
op_assign
id|phy_addr
(braket
l_int|0
)braket
op_assign
id|ha-&gt;tbuf_dma
suffix:semicolon
id|end_addr
(braket
l_int|1
)braket
op_assign
id|phy_addr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|end_a64
op_add_assign
id|TARGET_DATA_OFFSET
op_plus
id|TARGET_DATA_SIZE
suffix:semicolon
r_switch
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|1
)braket
op_amp
l_int|7
)paren
(brace
r_case
id|RW_BUF_HDATA
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: SM_WRDB, &quot;
l_string|&quot;RW_BUF_HDATA&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|TARGET_DATA_SIZE
op_plus
l_int|4
)paren
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: SM_WRDB, &quot;
l_string|&quot;length &gt; buffer size&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_ILLCDB
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|len
)paren
(brace
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_DATA_OUT
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: Issuing &quot;
l_string|&quot;SDI_TARMOD_WRCOMP&bslash;n&quot;
)paren
suffix:semicolon
id|sdi_xaen
c_func
(paren
id|SDI_TARMOD_WRCOMP
comma
id|ha-&gt;cntlr
comma
id|pkt-&gt;target_id
comma
id|pkt-&gt;lun
comma
l_int|0
comma
id|offset
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: SM_WRDB, &quot;
l_string|&quot;zero length&bslash;n&quot;
)paren
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RW_BUF_DATA
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: SM_WRDB, &quot;
l_string|&quot;RW_BUF_DATA&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|a64
op_add_assign
id|offset
op_plus
id|TARGET_DATA_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|2
)braket
op_ne
l_int|0
op_logical_or
op_star
id|a64
op_ge
op_star
id|end_a64
op_logical_or
op_star
id|a64
op_plus
id|len
OG
op_star
id|end_a64
)paren
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: SM_WRDB, &quot;
l_string|&quot;RW_BUF_DATA BAD&bslash;n&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;buf_id=0x%x, offset=0x%x, &quot;
l_string|&quot;length=0x%x&bslash;n&quot;
comma
id|pkt-&gt;cdb
(braket
l_int|2
)braket
comma
id|offset
comma
id|len
)paren
suffix:semicolon
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_ILLCDB
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|len
)paren
(brace
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_DATA_OUT
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: Issuing &quot;
l_string|&quot;SDI_TARMOD_WRCOMP&bslash;n&quot;
)paren
suffix:semicolon
id|sdi_xaen
c_func
(paren
id|SDI_TARMOD_WRCOMP
comma
id|ha-&gt;cntlr
comma
id|pkt-&gt;target_id
comma
id|pkt-&gt;lun
comma
l_int|0
comma
id|offset
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: SM_WRDB, &quot;
l_string|&quot;zero length&bslash;n&quot;
)paren
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: SM_WRDB &quot;
l_string|&quot;unknown mode&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_ILLCDB
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SM_RDDB
suffix:colon
id|memset
c_func
(paren
id|sense_ptr
comma
l_int|0
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
id|offset
op_assign
id|pkt-&gt;cdb
(braket
l_int|5
)braket
suffix:semicolon
id|offset
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|4
)braket
op_lshift
l_int|8
suffix:semicolon
id|offset
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|3
)braket
op_lshift
l_int|16
suffix:semicolon
id|len
op_assign
id|pkt-&gt;cdb
(braket
l_int|8
)braket
suffix:semicolon
id|len
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|7
)braket
op_lshift
l_int|8
suffix:semicolon
id|len
op_or_assign
id|pkt-&gt;cdb
(braket
l_int|6
)braket
op_lshift
l_int|16
suffix:semicolon
id|end_addr
(braket
l_int|0
)braket
op_assign
id|phy_addr
(braket
l_int|0
)braket
op_assign
id|ha-&gt;tbuf_dma
suffix:semicolon
id|end_addr
(braket
l_int|1
)braket
op_assign
id|phy_addr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|end_a64
op_add_assign
id|TARGET_DATA_OFFSET
op_plus
id|TARGET_DATA_SIZE
suffix:semicolon
r_switch
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|1
)braket
op_amp
l_int|7
)paren
(brace
r_case
id|RW_BUF_HDATA
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: SM_RDDB, &quot;
l_string|&quot;RW_BUF_HDATA&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|1
)braket
op_assign
(paren
id|TARGET_DATA_SIZE
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|2
)braket
op_assign
(paren
id|TARGET_DATA_SIZE
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|3
)braket
op_assign
id|TARGET_DATA_SIZE
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|TARGET_DATA_SIZE
op_plus
l_int|4
)paren
id|len
op_assign
id|TARGET_DATA_SIZE
op_plus
l_int|4
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_DATA_IN
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: SM_RDDB, &quot;
l_string|&quot;zero length&bslash;n&quot;
)paren
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RW_BUF_DATA
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: SM_RDDB, &quot;
l_string|&quot;RW_BUF_DATA&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|a64
op_add_assign
id|offset
op_plus
id|TARGET_DATA_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|2
)braket
op_ne
l_int|0
op_logical_or
op_star
id|a64
op_ge
op_star
id|end_a64
)paren
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: SM_RDDB, &quot;
l_string|&quot;RW_BUF_DATA BAD&bslash;n&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;buf_id=0x%x, offset=0x%x&bslash;n&quot;
id|pkt-&gt;cdb
(braket
l_int|2
)braket
comma
id|offset
)paren
suffix:semicolon
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_ILLCDB
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_star
id|a64
op_plus
id|len
OG
op_star
id|end_a64
)paren
id|len
op_assign
op_star
id|end_a64
op_minus
op_star
id|a64
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_DATA_IN
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: SM_RDDB, &quot;
l_string|&quot;zero length&bslash;n&quot;
)paren
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|RW_BUF_DESC
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: SM_RDDB, &quot;
l_string|&quot;RW_BUF_DESC&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
OG
l_int|4
)paren
id|len
op_assign
l_int|4
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;cdb
(braket
l_int|2
)braket
op_ne
l_int|0
)paren
(brace
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|1
)braket
op_assign
(paren
id|TARGET_DATA_SIZE
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|2
)braket
op_assign
(paren
id|TARGET_DATA_SIZE
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ha-&gt;tbuf-&gt;hdr
(braket
l_int|3
)braket
op_assign
id|TARGET_DATA_SIZE
op_amp
l_int|0xff
suffix:semicolon
)brace
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_DATA_IN
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: SM_RDDB,&quot;
l_string|&quot; zero length&bslash;n&quot;
)paren
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_GOOD
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: SM_RDDB &quot;
l_string|&quot;unknown mode&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_ILLCDB
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_atio_entry: Unknown SCSI command&bslash;n&quot;
)paren
suffix:semicolon
id|qla1280_dump_buffer
c_func
(paren
l_int|2
comma
op_amp
id|pkt-&gt;cdb
(braket
l_int|0
)braket
comma
id|pkt-&gt;cdb_len
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sense_ptr
comma
l_int|0
comma
id|TARGET_SENSE_SIZE
)paren
suffix:semicolon
op_star
id|sense_ptr
op_assign
l_int|0x70
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|2
)paren
op_assign
id|SD_ILLREQ
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|7
)paren
op_assign
id|TARGET_SENSE_SIZE
op_minus
l_int|8
suffix:semicolon
op_star
(paren
id|sense_ptr
op_plus
l_int|12
)paren
op_assign
id|SC_INVOPCODE
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|pkt-&gt;scsi_status
op_assign
id|S_CKCON
suffix:semicolon
id|pkt-&gt;option_flags
op_or_assign
(paren
id|OF_SSTS
op_or
id|OF_NO_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,18)
r_if
c_cond
(paren
id|ha-&gt;flags.enable_64bit_addressing
)paren
id|qla1280_64bit_continue_io
c_func
(paren
id|ha
comma
id|pkt
comma
id|len
comma
(paren
id|paddr32_t
op_star
)paren
op_amp
id|phy_addr
)paren
suffix:semicolon
r_else
macro_line|#endif
id|qla1280_32bit_continue_io
c_func
(paren
id|ha
comma
id|pkt
comma
id|len
comma
(paren
id|paddr32_t
op_star
)paren
op_amp
id|phy_addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_atio_entry: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_notify_entry&n; *      Processes received ISP immediate notify entry.&n; *&n; * Input:&n; *      ha  = adapter block pointer.&n; *      pkt = entry pointer.&n; */
r_static
r_void
DECL|function|qla1280_notify_entry
id|qla1280_notify_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|notify_entry_t
op_star
id|pkt
)paren
(brace
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_notify_entry: entered&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Acknowledge immediate notify */
id|qla1280_notify_ack
c_func
(paren
id|ha
comma
id|pkt
)paren
suffix:semicolon
multiline_comment|/* Issue notify entry to increment resource count */
id|qla1280_immed_notify
c_func
(paren
id|ha
comma
id|pkt
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_notify_entry: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* QLA1280_TARGET_MODE_SUPPORT */
multiline_comment|/*&n; *  qla1280_status_entry&n; *      Processes received ISP status entry.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      pkt          = entry pointer.&n; *      done_q_first = done queue first pointer.&n; *      done_q_last  = done queue last pointer.&n; */
r_static
r_void
DECL|function|qla1280_status_entry
id|qla1280_status_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|sts_entry_t
op_star
id|pkt
comma
id|srb_t
op_star
op_star
id|done_q_first
comma
id|srb_t
op_star
op_star
id|done_q_last
)paren
(brace
r_int
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
r_int
id|sense_sz
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_status_entry&quot;
)paren
suffix:semicolon
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|pkt-&gt;handle
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
suffix:semicolon
r_else
id|sp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd
op_assign
id|sp-&gt;cmd
suffix:semicolon
multiline_comment|/* Generate LU queue on cntrl, target, LUN */
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;comp_status
op_logical_or
id|pkt-&gt;scsi_status
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;scsi: comp_status = 0x%x, scsi_status = &quot;
l_string|&quot;0x%x, handle = 0x%x&bslash;n&quot;
comma
id|pkt-&gt;comp_status
comma
id|pkt-&gt;scsi_status
comma
id|pkt-&gt;handle
)paren
suffix:semicolon
)brace
multiline_comment|/* Target busy */
r_if
c_cond
(paren
id|pkt-&gt;scsi_status
op_amp
id|SS_BUSY_CONDITION
op_logical_and
id|pkt-&gt;scsi_status
op_ne
id|SS_RESERVE_CONFLICT
)paren
(brace
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
op_or
(paren
id|pkt-&gt;scsi_status
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Save ISP completion status */
id|CMD_RESULT
c_func
(paren
id|cmd
)paren
op_assign
id|qla1280_return_status
c_func
(paren
id|pkt
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;scsi_status
op_amp
id|SS_CHECK_CONDITION
)paren
(brace
r_if
c_cond
(paren
id|pkt-&gt;comp_status
op_ne
id|CS_ARS_FAILED
)paren
(brace
r_if
c_cond
(paren
id|pkt-&gt;req_sense_length
OL
id|CMD_SNSLEN
c_func
(paren
id|cmd
)paren
)paren
id|sense_sz
op_assign
id|pkt-&gt;req_sense_length
suffix:semicolon
r_else
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; * Scsi_Cmnd-&gt;sense_buffer is&n;&t;&t;&t;&t;&t;&t; * 64 bytes, why only copy 63?&n;&t;&t;&t;&t;&t;&t; * This looks wrong! /Jes&n;&t;&t;&t;&t;&t;&t; */
id|sense_sz
op_assign
id|CMD_SNSLEN
c_func
(paren
id|cmd
)paren
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd-&gt;sense_buffer
comma
op_amp
id|pkt-&gt;req_sense_data
comma
id|sense_sz
)paren
suffix:semicolon
)brace
r_else
id|sense_sz
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|cmd-&gt;sense_buffer
op_plus
id|sense_sz
comma
l_int|0
comma
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
op_minus
id|sense_sz
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_status_entry: Check &quot;
l_string|&quot;condition Sense data, b %i, t %i, &quot;
l_string|&quot;l %i&bslash;n&quot;
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sense_sz
)paren
id|qla1280_dump_buffer
c_func
(paren
l_int|2
comma
(paren
r_char
op_star
)paren
id|cmd-&gt;sense_buffer
comma
id|sense_sz
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Place command on done queue. */
id|qla1280_done_q_put
c_func
(paren
id|sp
comma
id|done_q_first
comma
id|done_q_last
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: Status Entry invalid handle&bslash;n&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_status_entry&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_error_entry&n; *      Processes error entry.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *      pkt          = entry pointer.&n; *      done_q_first = done queue first pointer.&n; *      done_q_last  = done queue last pointer.&n; */
r_static
r_void
DECL|function|qla1280_error_entry
id|qla1280_error_entry
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
id|response_t
op_star
id|pkt
comma
id|srb_t
op_star
op_star
id|done_q_first
comma
id|srb_t
op_star
op_star
id|done_q_last
)paren
(brace
id|srb_t
op_star
id|sp
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_error_entry&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_3
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_error_entry: BAD PAYLOAD flag error&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_2
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_error_entry: BAD HEADER flag error&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_1
)paren
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_error_entry: FULL flag error&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_error_entry: UNKNOWN flag error&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Validate handle. */
r_if
c_cond
(paren
id|pkt-&gt;handle
OL
id|MAX_OUTSTANDING_COMMANDS
)paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
suffix:semicolon
r_else
id|sp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
multiline_comment|/* Free outstanding command slot. */
id|ha-&gt;outstanding_cmds
(braket
id|pkt-&gt;handle
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Bad payload or header */
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
(paren
id|BIT_3
op_plus
id|BIT_2
)paren
)paren
(brace
multiline_comment|/* Bad payload or header, set error status. */
multiline_comment|/* CMD_RESULT(sp-&gt;cmd) = CS_BAD_PAYLOAD; */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_status
op_amp
id|BIT_1
)paren
(brace
multiline_comment|/* FULL flag */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set error status. */
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* Place command on done queue. */
id|qla1280_done_q_put
c_func
(paren
id|sp
comma
id|done_q_first
comma
id|done_q_last
)paren
suffix:semicolon
)brace
macro_line|#ifdef QLA_64BIT_PTR
r_else
r_if
c_cond
(paren
id|pkt-&gt;entry_type
op_eq
id|COMMAND_A64_TYPE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;!qla1280: Error Entry invalid handle&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|TRUE
suffix:semicolon
)brace
macro_line|#endif
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_error_entry&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_abort_isp&n; *      Resets ISP and aborts all outstanding commands.&n; *&n; * Input:&n; *      ha           = adapter block pointer.&n; *&n; * Returns:&n; *      0 = success&n; */
r_static
r_int
DECL|function|qla1280_abort_isp
id|qla1280_abort_isp
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
macro_line|#if 0
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
macro_line|#endif
id|srb_t
op_star
id|sp
suffix:semicolon
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_isp&quot;
)paren
suffix:semicolon
id|ha-&gt;flags.isp_abort_needed
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ha-&gt;flags.abort_isp_active
op_logical_and
id|ha-&gt;flags.online
)paren
(brace
id|ha-&gt;flags.abort_isp_active
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Disable ISP interrupts. */
id|qla1280_disable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
multiline_comment|/* Dequeue all commands in outstanding command list. */
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1
suffix:semicolon
id|cnt
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sp
)paren
(brace
id|ha-&gt;outstanding_cmds
(braket
id|cnt
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Generate LU queue on controller, target, LUN */
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|target
op_assign
id|SCSI_TCN_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|lun
op_assign
id|SCSI_LUN_32
c_func
(paren
id|sp-&gt;cmd
)paren
suffix:semicolon
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
multiline_comment|/* Reset outstanding command count. */
id|q-&gt;q_outcnt
op_assign
l_int|0
suffix:semicolon
id|q-&gt;q_flag
op_and_assign
op_complement
id|QLA1280_QBUSY
suffix:semicolon
id|q-&gt;q_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Adjust watchdog timer for command. */
multiline_comment|/* if (sp-&gt;flags &amp; SRB_WATCHDOG)&n;&t;&t;&t;&t;   sp-&gt;timeout += 2; */
multiline_comment|/* Place request back on top of device queue. */
id|sp-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|qla1280_putq_t
c_func
(paren
id|q
comma
id|sp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* If firmware needs to be loaded */
r_if
c_cond
(paren
id|qla1280_isp_firmware
(paren
id|ha
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_chip_diag
c_func
(paren
id|ha
)paren
)paren
)paren
id|status
op_assign
id|qla1280_setup_chip
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
multiline_comment|/* Setup adapter based on NVRAM parameters. */
id|qla1280_nvram_config
(paren
id|ha
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_init_rings
c_func
(paren
id|ha
)paren
)paren
)paren
(brace
multiline_comment|/* Issue SCSI reset. */
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
(brace
id|qla1280_bus_reset
c_func
(paren
id|ha
comma
id|bus
)paren
suffix:semicolon
)brace
r_do
(brace
multiline_comment|/* Issue marker command. */
id|ha-&gt;flags.reset_marker
op_assign
id|FALSE
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
(brace
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|reset_marker
op_assign
id|FALSE
suffix:semicolon
id|qla1280_marker
c_func
(paren
id|ha
comma
id|bus
comma
l_int|0
comma
l_int|0
comma
id|MK_SYNC_ALL
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|ha-&gt;flags.reset_marker
)paren
suffix:semicolon
multiline_comment|/* Enable host adapter target mode. */
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_assign
id|qla1280_enable_tgt
c_func
(paren
id|ha
comma
id|bus
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|MAX_LUNS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
multiline_comment|/* qla1280_enable_lun(ha, bus, cnt); */
id|qla1280_poll
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
)brace
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
multiline_comment|/* Enable ISP interrupts. */
id|qla1280_enable_intrs
c_func
(paren
id|ha
)paren
suffix:semicolon
id|ha-&gt;flags.abort_isp_active
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* Restart queues that may have been stopped. */
id|qla1280_restart_queues
c_func
(paren
id|ha
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;qla1280: ISP error recovery failed, board disabled&quot;
)paren
suffix:semicolon
id|qla1280_reset_adapter
c_func
(paren
id|ha
)paren
suffix:semicolon
id|qla1280_abort_queues
c_func
(paren
id|ha
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;qla1280_abort_isp: **** FAILED ****&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_isp&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_restart_queues&n; *      Restart all device queues.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_restart_queues
id|qla1280_restart_queues
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
id|scsi_lu_t
op_star
id|q
suffix:semicolon
r_int
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_restart_queues&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
id|MAX_TARGETS
suffix:semicolon
id|target
op_increment
)paren
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
id|MAX_LUNS
suffix:semicolon
id|lun
op_increment
)paren
(brace
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|q-&gt;q_first
)paren
id|qla1280_next
c_func
(paren
id|ha
comma
id|q
comma
id|bus
)paren
suffix:semicolon
)brace
)brace
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;qla1280_restart_queues: exiting normally&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_abort_queue_single&n; *      Abort all commands on a device queues.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_abort_queue_single
id|qla1280_abort_queue_single
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
id|bus
comma
r_int
id|target
comma
r_int
id|lun
comma
r_uint32
id|stat
)paren
(brace
id|scsi_lu_t
op_star
id|q
suffix:semicolon
id|srb_t
op_star
id|sp
comma
op_star
id|sp_next
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_queue_single&quot;
)paren
suffix:semicolon
id|q
op_assign
id|LU_Q
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_ne
l_int|NULL
)paren
(brace
id|sp
op_assign
id|q-&gt;q_first
suffix:semicolon
id|q-&gt;q_first
op_assign
id|q-&gt;q_last
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|sp
)paren
(brace
id|sp_next
op_assign
id|sp-&gt;s_next
suffix:semicolon
id|CMD_RESULT
c_func
(paren
id|sp-&gt;cmd
)paren
op_assign
id|stat
suffix:semicolon
id|qla1280_done_q_put
c_func
(paren
id|sp
comma
op_amp
id|ha-&gt;done_q_first
comma
op_amp
id|ha-&gt;done_q_last
)paren
suffix:semicolon
id|sp
op_assign
id|sp_next
suffix:semicolon
)brace
)brace
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_queue_single&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  qla1280_abort_queues&n; *      Abort all commands on device queues.&n; *&n; * Input:&n; *      ha = adapter block pointer.&n; */
r_static
r_void
DECL|function|qla1280_abort_queues
id|qla1280_abort_queues
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
r_uint32
id|bus
comma
id|target
comma
id|lun
suffix:semicolon
id|ENTER
c_func
(paren
l_string|&quot;qla1280_abort_queues&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
OL
id|ha-&gt;ports
suffix:semicolon
id|bus
op_increment
)paren
r_for
c_loop
(paren
id|target
op_assign
l_int|0
suffix:semicolon
id|target
OL
id|MAX_TARGETS
suffix:semicolon
id|target
op_increment
)paren
r_for
c_loop
(paren
id|lun
op_assign
l_int|0
suffix:semicolon
id|lun
OL
id|MAX_LUNS
suffix:semicolon
id|lun
op_increment
)paren
id|qla1280_abort_queue_single
c_func
(paren
id|ha
comma
id|bus
comma
id|target
comma
id|lun
comma
id|DID_RESET
)paren
suffix:semicolon
id|LEAVE
c_func
(paren
l_string|&quot;qla1280_abort_queues&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * qla1280_debounce_register&n; *      Debounce register.&n; *&n; * Input:&n; *      port = register address.&n; *&n; * Returns:&n; *      register value.&n; */
r_static
id|u16
DECL|function|qla1280_debounce_register
id|qla1280_debounce_register
c_func
(paren
r_volatile
id|u16
op_star
id|addr
)paren
(brace
r_volatile
id|u16
id|ret
suffix:semicolon
r_volatile
id|u16
id|ret2
suffix:semicolon
id|ret
op_assign
id|RD_REG_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
id|ret2
op_assign
id|RD_REG_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|ret2
)paren
r_return
id|ret
suffix:semicolon
r_do
(brace
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|RD_REG_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
id|ret2
op_assign
id|RD_REG_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_ne
id|ret2
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,4,0)
macro_line|#ifdef MODULE
DECL|variable|driver_template
id|Scsi_Host_Template
id|driver_template
op_assign
id|QLA1280_LINUX_TEMPLATE
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
macro_line|#else&t;&t;&t;&t;/* new kernel scsi initialization scheme */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|QLA1280_LINUX_TEMPLATE
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
macro_line|#endif
multiline_comment|/************************************************************************&n; * qla1280_check_for_dead_scsi_bus                                      *&n; *                                                                      *&n; *    This routine checks for a dead SCSI bus                           *&n; ************************************************************************/
DECL|macro|SET_SXP_BANK
mdefine_line|#define SET_SXP_BANK            0x0100
DECL|macro|SCSI_PHASE_INVALID
mdefine_line|#define SCSI_PHASE_INVALID      0x87FF
r_static
r_int
DECL|function|qla1280_check_for_dead_scsi_bus
id|qla1280_check_for_dead_scsi_bus
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_int
r_int
id|bus
)paren
(brace
r_uint16
id|config_reg
comma
id|scsi_control
suffix:semicolon
r_struct
id|device_reg
op_star
id|reg
op_assign
id|ha-&gt;iobase
suffix:semicolon
macro_line|#if 0
r_int
r_int
id|bus
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cp
suffix:semicolon
multiline_comment|/*&n;&t; * If SCSI Bus is Dead because of bad termination,&n;&t; * we will return a status of Selection timeout.&n;&t; */
id|cp
op_assign
id|sp-&gt;cmd
suffix:semicolon
id|bus
op_assign
id|SCSI_BUS_32
c_func
(paren
id|cp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
)paren
(brace
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_PAUSE_RISC
)paren
suffix:semicolon
id|config_reg
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
id|SET_SXP_BANK
)paren
suffix:semicolon
id|scsi_control
op_assign
id|RD_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;scsiControlPins
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;cfg_1
comma
id|config_reg
)paren
suffix:semicolon
id|WRT_REG_WORD
c_func
(paren
op_amp
id|reg-&gt;host_cmd
comma
id|HC_RELEASE_RISC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_control
op_eq
id|SCSI_PHASE_INVALID
)paren
(brace
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
op_assign
id|TRUE
suffix:semicolon
macro_line|#if 0
id|CMD_RESULT
c_func
(paren
id|cp
)paren
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|CMD_HANDLE
c_func
(paren
id|cp
)paren
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* ha-&gt;actthreads--; */
(paren
op_star
(paren
id|cp
)paren
op_member_access_from_pointer
id|scsi_done
)paren
(paren
id|cp
)paren
suffix:semicolon
macro_line|#endif
r_return
id|TRUE
suffix:semicolon
multiline_comment|/* bus is dead */
)brace
r_else
(brace
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|scsi_bus_dead
op_assign
id|FALSE
suffix:semicolon
id|ha-&gt;bus_settings
(braket
id|bus
)braket
dot
id|failed_reset_count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|FALSE
suffix:semicolon
multiline_comment|/* bus is not dead */
)brace
r_static
r_void
DECL|function|qla12160_get_target_parameters
id|qla12160_get_target_parameters
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
comma
r_uint32
id|bus
comma
r_uint32
id|target
comma
r_uint32
id|lun
)paren
(brace
r_uint16
id|mb
(braket
id|MAILBOX_REGISTER_COUNT
)braket
suffix:semicolon
id|mb
(braket
l_int|0
)braket
op_assign
id|MBC_GET_TARGET_PARAMETERS
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_assign
(paren
r_uint16
)paren
(paren
id|bus
ques
c_cond
id|target
op_or
id|BIT_7
suffix:colon
id|target
)paren
suffix:semicolon
id|mb
(braket
l_int|1
)braket
op_lshift_assign
l_int|8
suffix:semicolon
id|qla1280_mailbox_command
c_func
(paren
id|ha
comma
id|BIT_6
op_or
id|BIT_3
op_or
id|BIT_2
op_or
id|BIT_1
op_or
id|BIT_0
comma
op_amp
id|mb
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mb
(braket
l_int|3
)braket
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld:%d:%d:%d): Synchronous transfer at period &quot;
l_string|&quot;%d, offset %d. &bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
comma
id|lun
comma
(paren
id|mb
(braket
l_int|3
)braket
op_amp
l_int|0xff
)paren
comma
(paren
id|mb
(braket
l_int|3
)braket
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|mb
(braket
l_int|2
)braket
op_amp
id|BIT_5
)paren
op_logical_and
(paren
(paren
id|mb
(braket
l_int|6
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_ge
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi(%ld:%d:%d:%d): Dual Transition enabled.&bslash;n&quot;
comma
id|ha-&gt;host_no
comma
id|bus
comma
id|target
comma
id|lun
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef QL_DEBUG_ROUTINES
multiline_comment|/****************************************************************************/
multiline_comment|/*                         Driver Debug Functions.                          */
multiline_comment|/****************************************************************************/
multiline_comment|/*&n; *  Get byte from I/O port&n; */
r_static
id|u8
DECL|function|qla1280_getbyte
id|qla1280_getbyte
(paren
id|u8
op_star
id|port
)paren
(brace
id|u8
id|ret
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
id|ret
op_assign
id|readb
c_func
(paren
(paren
r_int
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#else
id|ret
op_assign
id|inb
c_func
(paren
(paren
r_int
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;qla1280_getbyte: address = 0x%p, data = 0x%x&quot;
comma
id|port
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *  Get word from I/O port&n; */
r_static
id|u16
DECL|function|qla1280_getword
id|qla1280_getword
(paren
id|u16
op_star
id|port
)paren
(brace
id|u16
id|ret
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
id|ret
op_assign
id|readw
c_func
(paren
r_int
r_int
)paren
id|port
suffix:semicolon
macro_line|#else
id|ret
op_assign
id|inw
c_func
(paren
(paren
r_int
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;qla1280_getbyte: address = 0x%p, data = 0x%x&quot;
comma
id|port
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *  Get double word from I/O port&n; */
r_static
id|u32
DECL|function|qla1280_getdword
id|qla1280_getdword
(paren
id|u32
op_star
id|port
)paren
(brace
id|u32
id|ret
suffix:semicolon
macro_line|#if MEMORY_MAPPED_IO
id|ret
op_assign
id|readl
c_func
(paren
(paren
r_int
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#else
id|ret
op_assign
id|inl
c_func
(paren
(paren
r_int
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;qla1280_getbyte: address = 0x%p, data = 0x%x&quot;
comma
id|port
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *  Send byte to I/O port&n; */
r_static
r_void
DECL|function|qla1280_putbyte
id|qla1280_putbyte
c_func
(paren
id|u8
op_star
id|port
comma
id|u8
id|data
)paren
(brace
macro_line|#if MEMORY_MAPPED_IO
id|writeb
c_func
(paren
id|data
comma
(paren
r_int
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#else
id|outb
c_func
(paren
id|data
comma
(paren
r_int
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;qla1280_getbyte: address = 0x%p, data = 0x%x&quot;
comma
id|port
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Send word to I/O port&n; */
r_static
r_void
DECL|function|qla1280_putword
id|qla1280_putword
c_func
(paren
id|u16
op_star
id|port
comma
id|u16
id|data
)paren
(brace
macro_line|#if MEMORY_MAPPED_IO
id|writew
c_func
(paren
id|data
comma
(paren
r_int
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#else
id|outw
c_func
(paren
id|data
comma
(paren
r_int
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;qla1280_getbyte: address = 0x%p, data = 0x%x&quot;
comma
id|port
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Send double word to I/O port&n; */
r_static
r_void
DECL|function|qla1280_putdword
id|qla1280_putdword
c_func
(paren
id|u32
op_star
id|port
comma
id|u32
id|data
)paren
(brace
macro_line|#if MEMORY_MAPPED_IO
id|writel
c_func
(paren
id|data
comma
(paren
r_int
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#else
id|outl
c_func
(paren
id|data
comma
(paren
r_int
r_int
)paren
id|port
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ql_debug_print
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;qla1280_getbyte: address = 0x%p, data = 0x%x&quot;
comma
id|port
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Dummy function to prevent warnings for&n; * declared and unused debug functions&n; */
r_static
r_void
DECL|function|qla1280_debug
id|qla1280_debug
c_func
(paren
r_void
)paren
(brace
id|qla1280_getbyte
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|qla1280_getword
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|qla1280_getdword
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|qla1280_putbyte
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|qla1280_putword
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|qla1280_putdword
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|__qla1280_dump_buffer
id|__qla1280_dump_buffer
c_func
(paren
r_char
op_star
id|b
comma
r_int
id|size
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|u8
id|c
suffix:semicolon
r_if
c_cond
(paren
id|ql_debug_print
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; 0   1   2   3   4   5   6   7   8   9   Ah  &quot;
l_string|&quot;Bh  Ch  Dh  Eh  Fh&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;---------------------------------------------&quot;
l_string|&quot;------------------&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|size
suffix:semicolon
)paren
(brace
id|c
op_assign
op_star
id|b
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|c
OL
l_int|16
)paren
id|printk
c_func
(paren
l_char|&squot; &squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;0x%x&quot;
comma
id|c
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cnt
op_mod
l_int|16
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|c
OL
l_int|10
)paren
id|printk
c_func
(paren
l_string|&quot;  &quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_char|&squot; &squot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
op_mod
l_int|16
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**************************************************************************&n; *   ql1280_print_scsi_cmd&n; *&n; **************************************************************************/
r_static
r_void
DECL|function|qla1280_print_scsi_cmd
id|qla1280_print_scsi_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|cmd-&gt;host
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
multiline_comment|/* struct scatterlist *sg; */
r_int
id|i
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|sp
op_assign
(paren
id|srb_t
op_star
)paren
id|CMD_SP
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SCSI Command @= 0x%p, Handle=0x%p&bslash;n&quot;
comma
id|cmd
comma
id|CMD_HANDLE
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  chan=%d, target = 0x%02x, lun = 0x%02x, cmd_len = 0x%02x&bslash;n&quot;
comma
id|cmd-&gt;channel
comma
id|cmd-&gt;target
comma
id|cmd-&gt;lun
comma
id|cmd-&gt;cmd_len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; CDB = &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%02x &quot;
comma
id|cmd-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;  seg_cnt =%d&bslash;n&quot;
comma
id|cmd-&gt;use_sg
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  request buffer=0x%p, request buffer len=0x%x&bslash;n&quot;
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;request_bufflen
)paren
suffix:semicolon
multiline_comment|/* if (cmd-&gt;use_sg)&n;&t;   {&n;&t;   sg = (struct scatterlist *) cmd-&gt;request_buffer;&n;&t;   printk(&quot;  SG buffer: &bslash;n&quot;);&n;&t;   qla1280_dump_buffer(1, (char *)sg, (cmd-&gt;use_sg*sizeof(struct scatterlist)));&n;&t;   } */
id|printk
c_func
(paren
l_string|&quot;  tag=%d, flags=0x%x, transfersize=0x%x &bslash;n&quot;
comma
id|cmd-&gt;tag
comma
id|cmd-&gt;flags
comma
id|cmd-&gt;transfersize
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  Pid=%li, SP=0x%p&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|CMD_SP
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; underflow size = 0x%x, direction=0x%x, req.cmd=0x%x &bslash;n&quot;
comma
id|cmd-&gt;underflow
comma
id|sp-&gt;dir
comma
id|cmd-&gt;request.cmd
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; *   ql1280_dump_device&n; *&n; **************************************************************************/
r_void
DECL|function|ql1280_dump_device
id|ql1280_dump_device
c_func
(paren
r_struct
id|scsi_qla_host
op_star
id|ha
)paren
(brace
id|Scsi_Cmnd
op_star
id|cp
suffix:semicolon
id|srb_t
op_star
id|sp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ql_debug_print
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Outstanding Commands on controller:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_OUTSTANDING_COMMANDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|sp
op_assign
id|ha-&gt;outstanding_cmds
(braket
id|i
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cp
op_assign
id|sp-&gt;cmd
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|qla1280_print_scsi_cmd
c_func
(paren
l_int|1
comma
id|cp
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
macro_line|#if STOP_ON_ERROR
multiline_comment|/**************************************************************************&n; *   ql1280_panic&n; *&n; **************************************************************************/
r_static
r_void
DECL|function|qla1280_panic
id|qla1280_panic
c_func
(paren
r_char
op_star
id|cp
comma
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|scsi_qla_host
op_star
id|ha
suffix:semicolon
r_int
op_star
id|fp
suffix:semicolon
id|ha
op_assign
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;qla1280 - PANIC:  %s&bslash;n&quot;
comma
id|cp
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Current time=0x%lx&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Number of pending commands =0x%lx&bslash;n&quot;
comma
id|ha-&gt;actthreads
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Number of SCSI queued commands =0x%lx&bslash;n&quot;
comma
id|ha-&gt;qthreads
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Number of free entries = (%d)&bslash;n&quot;
comma
id|ha-&gt;req_q_cnt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Request Queue @ 0x%lx, Response Queue @ 0x%lx&bslash;n&quot;
comma
id|ha-&gt;request_dma
comma
id|ha-&gt;response_dma
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Request In Ptr %d&bslash;n&quot;
comma
id|ha-&gt;req_ring_index
)paren
suffix:semicolon
id|fp
op_assign
(paren
r_int
op_star
)paren
op_amp
id|ha-&gt;flags
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HA flags =0x%lx&bslash;n&quot;
comma
op_star
id|fp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ql_debug_level
op_ge
l_int|2
)paren
(brace
id|ql_debug_print
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
id|ql1280_dump_device
c_func
(paren
(paren
r_struct
id|scsi_qla_host
op_star
)paren
id|host-&gt;hostdata
)paren
suffix:semicolon
macro_line|#endif
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Ooops&quot;
)paren
suffix:semicolon
multiline_comment|/* cli();&n;&t;   for(;;)&n;&t;   {&n;&t;   barrier();&n;&t;   sti();&n;&t;   }&n;&t;*/
)brace
macro_line|#endif
macro_line|#ifdef MODULE
multiline_comment|/**************************************************************************&n; *   qla1280_setup&n; *&n; *   Handle Linux boot parameters. This routine allows for assigning a value&n; *   to a parameter with a &squot;:&squot; between the parameter and the value.&n; *   ie. qla1280=max_reqs:0x0A,verbose&n; **************************************************************************/
r_void
DECL|function|qla1280_setup
id|qla1280_setup
c_func
(paren
r_char
op_star
id|s
comma
r_int
op_star
id|dummy
)paren
(brace
r_char
op_star
id|end
comma
op_star
id|str
comma
op_star
id|cp
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi: Processing Option str = %s&bslash;n&quot;
comma
id|s
)paren
suffix:semicolon
id|end
op_assign
id|strchr
(paren
id|s
comma
l_char|&squot;&bslash;0&squot;
)paren
suffix:semicolon
multiline_comment|/* locate command */
id|str
op_assign
id|s
suffix:semicolon
r_for
c_loop
(paren
id|cp
op_assign
id|s
suffix:semicolon
op_star
id|cp
op_logical_and
id|cp
op_ne
id|end
suffix:semicolon
id|cp
op_increment
)paren
(brace
id|cp
op_assign
id|qla1280_get_token
c_func
(paren
id|cp
comma
id|str
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi: token str = %s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
multiline_comment|/* if found execute routine */
)brace
)brace
r_static
r_char
op_star
DECL|function|qla1280_get_token
id|qla1280_get_token
c_func
(paren
r_char
op_star
id|cmdline
comma
r_char
op_star
id|str
)paren
(brace
r_register
r_char
op_star
id|cp
op_assign
id|cmdline
suffix:semicolon
multiline_comment|/* skip preceeding spaces */
r_while
c_loop
(paren
id|strchr
(paren
id|cp
comma
l_char|&squot; &squot;
)paren
)paren
op_increment
id|cp
suffix:semicolon
multiline_comment|/* symbol starts here */
id|str
op_assign
id|cp
suffix:semicolon
multiline_comment|/* skip char if not a space or : */
r_while
c_loop
(paren
op_star
id|cp
op_logical_and
op_logical_neg
(paren
id|strchr
(paren
id|cp
comma
l_char|&squot; &squot;
)paren
op_logical_or
id|strchr
(paren
id|cp
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
id|cp
op_increment
suffix:semicolon
op_star
id|cp
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|cp
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we almost follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-basic-offset: 8&n; * tab-width: 8&n; * End:&n; */
eof
