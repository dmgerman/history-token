multiline_comment|/*&n; * dc395x.c&n; *&n; * Device Driver for Tekram DC395(U/UW/F), DC315(U)&n; * PCI SCSI Bus Master Host Adapter&n; * (SCSI chip set used Tekram ASIC TRM-S1040)&n; *&n; * Authors:&n; *  C.L. Huang &lt;ching@tekram.com.tw&gt;&n; *  Erich Chen &lt;erich@tekram.com.tw&gt;&n; *  (C) Copyright 1995-1999 Tekram Technology Co., Ltd.&n; *&n; *  Kurt Garloff &lt;garloff@suse.de&gt;&n; *  (C) 1999-2000 Kurt Garloff&n; *&n; *  Oliver Neukum &lt;oliver@neukum.name&gt;&n; *  Ali Akcaagac &lt;aliakc@web.de&gt;&n; *  Jamie Lenehan &lt;lenehan@twibble.org&gt;&n; *  (C) 2003&n; *&n; * License: GNU GPL&n; *&n; *************************************************************************&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions and the following disclaimer.&n; * 2. Redistributions in binary form must reproduce the above copyright&n; *    notice, this list of conditions and the following disclaimer in the&n; *    documentation and/or other materials provided with the distribution.&n; * 3. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS&squot;&squot; AND ANY EXPRESS OR&n; * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES&n; * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.&n; * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,&n; * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,&n; * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY&n; * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT&n; * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; ************************************************************************&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;dc395x.h&quot;
macro_line|#include &lt;scsi/scsicam.h&gt;&t;/* needed for scsicam_bios_param */
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/list.h&gt;
multiline_comment|/*---------------------------------------------------------------------------&n;                                  Features&n; ---------------------------------------------------------------------------*/
multiline_comment|/*&n; * Set to disable parts of the driver&n; */
multiline_comment|/*#define DC395x_NO_DISCONNECT*/
multiline_comment|/*#define DC395x_NO_TAGQ*/
multiline_comment|/*#define DC395x_NO_SYNC*/
multiline_comment|/*#define DC395x_NO_WIDE*/
multiline_comment|/*---------------------------------------------------------------------------&n;                                  Debugging&n; ---------------------------------------------------------------------------*/
multiline_comment|/*&n; * Types of debugging that can be enabled and disabled&n; */
DECL|macro|DBG_KG
mdefine_line|#define DBG_KG&t;&t;0x0001
DECL|macro|DBG_0
mdefine_line|#define DBG_0&t;&t;0x0002
DECL|macro|DBG_1
mdefine_line|#define DBG_1&t;&t;0x0004
DECL|macro|DBG_DCB
mdefine_line|#define DBG_DCB&t;&t;0x0008
DECL|macro|DBG_PARSE
mdefine_line|#define DBG_PARSE&t;0x0010&t;&t;/* debug command line parsing */
DECL|macro|DBG_SGPARANOIA
mdefine_line|#define DBG_SGPARANOIA&t;0x0020
DECL|macro|DBG_FIFO
mdefine_line|#define DBG_FIFO&t;0x0040
DECL|macro|DBG_PIO
mdefine_line|#define DBG_PIO&t;&t;0x0080
multiline_comment|/*&n; * Set set of things to output debugging for.&n; * Undefine to remove all debugging&n; */
multiline_comment|/*#define DEBUG_MASK (DBG_0|DBG_1|DBG_DCB|DBG_PARSE|DBG_SGPARANOIA|DBG_FIFO|DBG_PIO)*/
multiline_comment|/*#define  DEBUG_MASK&t;DBG_0*/
multiline_comment|/*&n; * Output a kernel mesage at the specified level and append the&n; * driver name and a &quot;: &quot; to the start of the message&n; */
DECL|macro|dprintkl
mdefine_line|#define dprintkl(level, format, arg...)  &bslash;&n;    printk(level DC395X_NAME &quot;: &quot; format , ## arg)
macro_line|#ifdef DEBUG_MASK
multiline_comment|/*&n; * print a debug message - this is formated with KERN_DEBUG, then the&n; * driver name followed by a &quot;: &quot; and then the message is output. &n; * This also checks that the specified debug level is enabled before&n; * outputing the message&n; */
DECL|macro|dprintkdbg
mdefine_line|#define dprintkdbg(type, format, arg...) &bslash;&n;&t;do { &bslash;&n;&t;&t;if ((type) &amp; (DEBUG_MASK)) &bslash;&n;&t;&t;&t;dprintkl(KERN_DEBUG , format , ## arg); &bslash;&n;&t;} while (0)
multiline_comment|/*&n; * Check if the specified type of debugging is enabled&n; */
DECL|macro|debug_enabled
mdefine_line|#define debug_enabled(type)&t;((DEBUG_MASK) &amp; (type))
macro_line|#else
multiline_comment|/*&n; * No debugging. Do nothing&n; */
DECL|macro|dprintkdbg
mdefine_line|#define dprintkdbg(type, format, arg...) &bslash;&n;&t;do {} while (0)
DECL|macro|debug_enabled
mdefine_line|#define debug_enabled(type)&t;(0)
macro_line|#endif
macro_line|#ifndef PCI_VENDOR_ID_TEKRAM
DECL|macro|PCI_VENDOR_ID_TEKRAM
mdefine_line|#define PCI_VENDOR_ID_TEKRAM                    0x1DE1&t;/* Vendor ID    */
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_TEKRAM_TRMS1040
DECL|macro|PCI_DEVICE_ID_TEKRAM_TRMS1040
mdefine_line|#define PCI_DEVICE_ID_TEKRAM_TRMS1040           0x0391&t;/* Device ID    */
macro_line|#endif
DECL|macro|DC395x_LOCK_IO
mdefine_line|#define DC395x_LOCK_IO(dev,flags)&t;&t;spin_lock_irqsave(((struct Scsi_Host *)dev)-&gt;host_lock, flags)
DECL|macro|DC395x_UNLOCK_IO
mdefine_line|#define DC395x_UNLOCK_IO(dev,flags)&t;&t;spin_unlock_irqrestore(((struct Scsi_Host *)dev)-&gt;host_lock, flags)
DECL|macro|DC395x_read8
mdefine_line|#define DC395x_read8(acb,address)&t;&t;(u8)(inb(acb-&gt;io_port_base + (address)))
DECL|macro|DC395x_read16
mdefine_line|#define DC395x_read16(acb,address)&t;&t;(u16)(inw(acb-&gt;io_port_base + (address)))
DECL|macro|DC395x_read32
mdefine_line|#define DC395x_read32(acb,address)&t;&t;(u32)(inl(acb-&gt;io_port_base + (address)))
DECL|macro|DC395x_write8
mdefine_line|#define DC395x_write8(acb,address,value)&t;outb((value), acb-&gt;io_port_base + (address))
DECL|macro|DC395x_write16
mdefine_line|#define DC395x_write16(acb,address,value)&t;outw((value), acb-&gt;io_port_base + (address))
DECL|macro|DC395x_write32
mdefine_line|#define DC395x_write32(acb,address,value)&t;outl((value), acb-&gt;io_port_base + (address))
multiline_comment|/* cmd-&gt;result */
DECL|macro|RES_TARGET
mdefine_line|#define RES_TARGET&t;&t;0x000000FF&t;/* Target State */
DECL|macro|RES_TARGET_LNX
mdefine_line|#define RES_TARGET_LNX  STATUS_MASK&t;/* Only official ... */
DECL|macro|RES_ENDMSG
mdefine_line|#define RES_ENDMSG&t;&t;0x0000FF00&t;/* End Message */
DECL|macro|RES_DID
mdefine_line|#define RES_DID&t;&t;&t;0x00FF0000&t;/* DID_ codes */
DECL|macro|RES_DRV
mdefine_line|#define RES_DRV&t;&t;&t;0xFF000000&t;/* DRIVER_ codes */
DECL|macro|MK_RES
mdefine_line|#define MK_RES(drv,did,msg,tgt) ((int)(drv)&lt;&lt;24 | (int)(did)&lt;&lt;16 | (int)(msg)&lt;&lt;8 | (int)(tgt))
DECL|macro|MK_RES_LNX
mdefine_line|#define MK_RES_LNX(drv,did,msg,tgt) ((int)(drv)&lt;&lt;24 | (int)(did)&lt;&lt;16 | (int)(msg)&lt;&lt;8 | (int)(tgt)&lt;&lt;1)
DECL|macro|SET_RES_TARGET
mdefine_line|#define SET_RES_TARGET(who,tgt) { who &amp;= ~RES_TARGET; who |= (int)(tgt); }
DECL|macro|SET_RES_TARGET_LNX
mdefine_line|#define SET_RES_TARGET_LNX(who,tgt) { who &amp;= ~RES_TARGET_LNX; who |= (int)(tgt) &lt;&lt; 1; }
DECL|macro|SET_RES_MSG
mdefine_line|#define SET_RES_MSG(who,msg) { who &amp;= ~RES_ENDMSG; who |= (int)(msg) &lt;&lt; 8; }
DECL|macro|SET_RES_DID
mdefine_line|#define SET_RES_DID(who,did) { who &amp;= ~RES_DID; who |= (int)(did) &lt;&lt; 16; }
DECL|macro|SET_RES_DRV
mdefine_line|#define SET_RES_DRV(who,drv) { who &amp;= ~RES_DRV; who |= (int)(drv) &lt;&lt; 24; }
DECL|macro|TAG_NONE
mdefine_line|#define TAG_NONE 255
multiline_comment|/*&n; * srb-&gt;segement_x is the hw sg list. It is always allocated as a&n; * DC395x_MAX_SG_LISTENTRY entries in a linear block which does not&n; * cross a page boundy.&n; */
DECL|macro|SEGMENTX_LEN
mdefine_line|#define SEGMENTX_LEN&t;(sizeof(struct SGentry)*DC395x_MAX_SG_LISTENTRY)
DECL|struct|SGentry
r_struct
id|SGentry
(brace
DECL|member|address
id|u32
id|address
suffix:semicolon
multiline_comment|/* bus! address */
DECL|member|length
id|u32
id|length
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* The SEEPROM structure for TRM_S1040 */
DECL|struct|NVRamTarget
r_struct
id|NVRamTarget
(brace
DECL|member|cfg0
id|u8
id|cfg0
suffix:semicolon
multiline_comment|/* Target configuration byte 0  */
DECL|member|period
id|u8
id|period
suffix:semicolon
multiline_comment|/* Target period                */
DECL|member|cfg2
id|u8
id|cfg2
suffix:semicolon
multiline_comment|/* Target configuration byte 2  */
DECL|member|cfg3
id|u8
id|cfg3
suffix:semicolon
multiline_comment|/* Target configuration byte 3  */
)brace
suffix:semicolon
DECL|struct|NvRamType
r_struct
id|NvRamType
(brace
DECL|member|sub_vendor_id
id|u8
id|sub_vendor_id
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* 0,1  Sub Vendor ID   */
DECL|member|sub_sys_id
id|u8
id|sub_sys_id
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* 2,3  Sub System ID   */
DECL|member|sub_class
id|u8
id|sub_class
suffix:semicolon
multiline_comment|/* 4    Sub Class       */
DECL|member|vendor_id
id|u8
id|vendor_id
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* 5,6  Vendor ID       */
DECL|member|device_id
id|u8
id|device_id
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* 7,8  Device ID       */
DECL|member|reserved
id|u8
id|reserved
suffix:semicolon
multiline_comment|/* 9    Reserved        */
DECL|member|target
r_struct
id|NVRamTarget
id|target
(braket
id|DC395x_MAX_SCSI_ID
)braket
suffix:semicolon
multiline_comment|/** 10,11,12,13&n;&t;&t;&t;&t;&t;&t; ** 14,15,16,17&n;&t;&t;&t;&t;&t;&t; ** ....&n;&t;&t;&t;&t;&t;&t; ** ....&n;&t;&t;&t;&t;&t;&t; ** 70,71,72,73&n;&t;&t;&t;&t;&t;&t; */
DECL|member|scsi_id
id|u8
id|scsi_id
suffix:semicolon
multiline_comment|/* 74 Host Adapter SCSI ID      */
DECL|member|channel_cfg
id|u8
id|channel_cfg
suffix:semicolon
multiline_comment|/* 75 Channel configuration     */
DECL|member|delay_time
id|u8
id|delay_time
suffix:semicolon
multiline_comment|/* 76 Power on delay time       */
DECL|member|max_tag
id|u8
id|max_tag
suffix:semicolon
multiline_comment|/* 77 Maximum tags              */
DECL|member|reserved0
id|u8
id|reserved0
suffix:semicolon
multiline_comment|/* 78  */
DECL|member|boot_target
id|u8
id|boot_target
suffix:semicolon
multiline_comment|/* 79  */
DECL|member|boot_lun
id|u8
id|boot_lun
suffix:semicolon
multiline_comment|/* 80  */
DECL|member|reserved1
id|u8
id|reserved1
suffix:semicolon
multiline_comment|/* 81  */
DECL|member|reserved2
id|u16
id|reserved2
(braket
l_int|22
)braket
suffix:semicolon
multiline_comment|/* 82,..125 */
DECL|member|cksum
id|u16
id|cksum
suffix:semicolon
multiline_comment|/* 126,127 */
)brace
suffix:semicolon
DECL|struct|ScsiReqBlk
r_struct
id|ScsiReqBlk
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
multiline_comment|/* next/prev ptrs for srb lists */
DECL|member|dcb
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
DECL|member|cmd
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
DECL|member|segment_x
r_struct
id|SGentry
op_star
id|segment_x
suffix:semicolon
multiline_comment|/* Linear array of hw sg entries (up to 64 entries) */
DECL|member|sg_bus_addr
id|u32
id|sg_bus_addr
suffix:semicolon
multiline_comment|/* Bus address of sg list (ie, of segment_x) */
DECL|member|sg_count
id|u8
id|sg_count
suffix:semicolon
multiline_comment|/* No of HW sg entries for this request */
DECL|member|sg_index
id|u8
id|sg_index
suffix:semicolon
multiline_comment|/* Index of HW sg entry for this request */
DECL|member|total_xfer_length
id|u32
id|total_xfer_length
suffix:semicolon
multiline_comment|/* Total number of bytes remaining to be transfered */
DECL|member|virt_addr
r_int
r_char
op_star
id|virt_addr
suffix:semicolon
multiline_comment|/* Virtual address of current transfer position */
multiline_comment|/*&n;&t; * The sense buffer handling function, request_sense, uses&n;&t; * the first hw sg entry (segment_x[0]) and the transfer&n;&t; * length (total_xfer_length). While doing this it stores the&n;&t; * original values into the last sg hw list&n;&t; * (srb-&gt;segment_x[DC395x_MAX_SG_LISTENTRY - 1] and the&n;&t; * total_xfer_length in xferred. These values are restored in&n;&t; * pci_unmap_srb_sense. This is the only place xferred is used.&n;&t; */
DECL|member|xferred
id|u32
id|xferred
suffix:semicolon
multiline_comment|/* Saved copy of total_xfer_length */
DECL|member|state
id|u16
id|state
suffix:semicolon
DECL|member|msgin_buf
id|u8
id|msgin_buf
(braket
l_int|6
)braket
suffix:semicolon
DECL|member|msgout_buf
id|u8
id|msgout_buf
(braket
l_int|6
)braket
suffix:semicolon
DECL|member|adapter_status
id|u8
id|adapter_status
suffix:semicolon
DECL|member|target_status
id|u8
id|target_status
suffix:semicolon
DECL|member|msg_count
id|u8
id|msg_count
suffix:semicolon
DECL|member|end_message
id|u8
id|end_message
suffix:semicolon
DECL|member|tag_number
id|u8
id|tag_number
suffix:semicolon
DECL|member|status
id|u8
id|status
suffix:semicolon
DECL|member|retry_count
id|u8
id|retry_count
suffix:semicolon
DECL|member|flag
id|u8
id|flag
suffix:semicolon
DECL|member|scsi_phase
id|u8
id|scsi_phase
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|DeviceCtlBlk
r_struct
id|DeviceCtlBlk
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
multiline_comment|/* next/prev ptrs for the dcb list */
DECL|member|acb
r_struct
id|AdapterCtlBlk
op_star
id|acb
suffix:semicolon
DECL|member|srb_going_list
r_struct
id|list_head
id|srb_going_list
suffix:semicolon
multiline_comment|/* head of going srb list */
DECL|member|srb_waiting_list
r_struct
id|list_head
id|srb_waiting_list
suffix:semicolon
multiline_comment|/* head of waiting srb list */
DECL|member|active_srb
r_struct
id|ScsiReqBlk
op_star
id|active_srb
suffix:semicolon
DECL|member|tag_mask
id|u32
id|tag_mask
suffix:semicolon
DECL|member|max_command
id|u16
id|max_command
suffix:semicolon
DECL|member|target_id
id|u8
id|target_id
suffix:semicolon
multiline_comment|/* SCSI Target ID  (SCSI Only) */
DECL|member|target_lun
id|u8
id|target_lun
suffix:semicolon
multiline_comment|/* SCSI Log.  Unit (SCSI Only) */
DECL|member|identify_msg
id|u8
id|identify_msg
suffix:semicolon
DECL|member|dev_mode
id|u8
id|dev_mode
suffix:semicolon
DECL|member|inquiry7
id|u8
id|inquiry7
suffix:semicolon
multiline_comment|/* To store Inquiry flags */
DECL|member|sync_mode
id|u8
id|sync_mode
suffix:semicolon
multiline_comment|/* 0:async mode */
DECL|member|min_nego_period
id|u8
id|min_nego_period
suffix:semicolon
multiline_comment|/* for nego. */
DECL|member|sync_period
id|u8
id|sync_period
suffix:semicolon
multiline_comment|/* for reg.  */
DECL|member|sync_offset
id|u8
id|sync_offset
suffix:semicolon
multiline_comment|/* for reg. and nego.(low nibble) */
DECL|member|flag
id|u8
id|flag
suffix:semicolon
DECL|member|dev_type
id|u8
id|dev_type
suffix:semicolon
DECL|member|init_tcq_flag
id|u8
id|init_tcq_flag
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|AdapterCtlBlk
r_struct
id|AdapterCtlBlk
(brace
DECL|member|scsi_host
r_struct
id|Scsi_Host
op_star
id|scsi_host
suffix:semicolon
DECL|member|io_port_base
id|u16
id|io_port_base
suffix:semicolon
DECL|member|io_port_len
id|u16
id|io_port_len
suffix:semicolon
DECL|member|dcb_list
r_struct
id|list_head
id|dcb_list
suffix:semicolon
multiline_comment|/* head of going dcb list */
DECL|member|dcb_run_robin
r_struct
id|DeviceCtlBlk
op_star
id|dcb_run_robin
suffix:semicolon
DECL|member|active_dcb
r_struct
id|DeviceCtlBlk
op_star
id|active_dcb
suffix:semicolon
DECL|member|srb_free_list
r_struct
id|list_head
id|srb_free_list
suffix:semicolon
multiline_comment|/* head of free srb list */
DECL|member|tmp_srb
r_struct
id|ScsiReqBlk
op_star
id|tmp_srb
suffix:semicolon
DECL|member|waiting_timer
r_struct
id|timer_list
id|waiting_timer
suffix:semicolon
DECL|member|selto_timer
r_struct
id|timer_list
id|selto_timer
suffix:semicolon
DECL|member|srb_count
id|u16
id|srb_count
suffix:semicolon
DECL|member|sel_timeout
id|u8
id|sel_timeout
suffix:semicolon
DECL|member|irq_level
id|u8
id|irq_level
suffix:semicolon
DECL|member|tag_max_num
id|u8
id|tag_max_num
suffix:semicolon
DECL|member|acb_flag
id|u8
id|acb_flag
suffix:semicolon
DECL|member|gmode2
id|u8
id|gmode2
suffix:semicolon
DECL|member|config
id|u8
id|config
suffix:semicolon
DECL|member|lun_chk
id|u8
id|lun_chk
suffix:semicolon
DECL|member|scan_devices
id|u8
id|scan_devices
suffix:semicolon
DECL|member|hostid_bit
id|u8
id|hostid_bit
suffix:semicolon
DECL|member|dcb_map
id|u8
id|dcb_map
(braket
id|DC395x_MAX_SCSI_ID
)braket
suffix:semicolon
DECL|member|children
r_struct
id|DeviceCtlBlk
op_star
id|children
(braket
id|DC395x_MAX_SCSI_ID
)braket
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|dev
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
DECL|member|msg_len
id|u8
id|msg_len
suffix:semicolon
DECL|member|srb_array
r_struct
id|ScsiReqBlk
id|srb_array
(braket
id|DC395x_MAX_SRB_CNT
)braket
suffix:semicolon
DECL|member|srb
r_struct
id|ScsiReqBlk
id|srb
suffix:semicolon
DECL|member|eeprom
r_struct
id|NvRamType
id|eeprom
suffix:semicolon
multiline_comment|/* eeprom settings for this adapter */
)brace
suffix:semicolon
multiline_comment|/*---------------------------------------------------------------------------&n;                            Forward declarations&n; ---------------------------------------------------------------------------*/
r_static
r_void
id|data_out_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|data_in_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|command_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|status_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|msgout_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|msgin_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|data_out_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|data_in_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|command_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|status_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|msgout_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|msgin_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|nop0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|nop1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|set_basic_config
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
suffix:semicolon
r_static
r_void
id|cleanup_after_transfer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
suffix:semicolon
r_static
r_void
id|reset_scsi_bus
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
suffix:semicolon
r_static
r_void
id|data_io_transfer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
id|io_dir
)paren
suffix:semicolon
r_static
r_void
id|disconnect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
suffix:semicolon
r_static
r_void
id|reselect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
suffix:semicolon
r_static
id|u8
id|start_scsi
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
suffix:semicolon
r_static
r_void
id|build_srb
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
suffix:semicolon
r_static
r_void
id|doing_srb_done
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
id|u8
id|did_code
comma
id|Scsi_Cmnd
op_star
id|cmd
comma
id|u8
id|force
)paren
suffix:semicolon
r_static
r_void
id|scsi_reset_detect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
suffix:semicolon
r_static
r_void
id|pci_unmap_srb
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
suffix:semicolon
r_static
r_void
id|pci_unmap_srb_sense
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
suffix:semicolon
r_static
r_inline
r_void
id|enable_msgout_abort
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
suffix:semicolon
r_static
r_void
id|srb_done
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
suffix:semicolon
r_static
r_void
id|request_sense
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
suffix:semicolon
r_static
r_inline
r_void
id|set_xfer_rate
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
)paren
suffix:semicolon
r_static
r_void
id|waiting_timeout
c_func
(paren
r_int
r_int
id|ptr
)paren
suffix:semicolon
multiline_comment|/*---------------------------------------------------------------------------&n;                                 Static Data&n; ---------------------------------------------------------------------------*/
DECL|variable|current_sync_offset
r_static
id|u16
id|current_sync_offset
op_assign
l_int|0
suffix:semicolon
DECL|variable|monitor_next_irq
r_static
r_char
id|monitor_next_irq
op_assign
l_int|0
suffix:semicolon
DECL|variable|dc395x_scsi_phase0
r_static
r_void
op_star
id|dc395x_scsi_phase0
(braket
)braket
op_assign
(brace
id|data_out_phase0
comma
multiline_comment|/* phase:0 */
id|data_in_phase0
comma
multiline_comment|/* phase:1 */
id|command_phase0
comma
multiline_comment|/* phase:2 */
id|status_phase0
comma
multiline_comment|/* phase:3 */
id|nop0
comma
multiline_comment|/* phase:4 PH_BUS_FREE .. initial phase */
id|nop0
comma
multiline_comment|/* phase:5 PH_BUS_FREE .. initial phase */
id|msgout_phase0
comma
multiline_comment|/* phase:6 */
id|msgin_phase0
comma
multiline_comment|/* phase:7 */
)brace
suffix:semicolon
DECL|variable|dc395x_scsi_phase1
r_static
r_void
op_star
id|dc395x_scsi_phase1
(braket
)braket
op_assign
(brace
id|data_out_phase1
comma
multiline_comment|/* phase:0 */
id|data_in_phase1
comma
multiline_comment|/* phase:1 */
id|command_phase1
comma
multiline_comment|/* phase:2 */
id|status_phase1
comma
multiline_comment|/* phase:3 */
id|nop1
comma
multiline_comment|/* phase:4 PH_BUS_FREE .. initial phase */
id|nop1
comma
multiline_comment|/* phase:5 PH_BUS_FREE .. initial phase */
id|msgout_phase1
comma
multiline_comment|/* phase:6 */
id|msgin_phase1
comma
multiline_comment|/* phase:7 */
)brace
suffix:semicolon
multiline_comment|/*&n; *Fast20:&t;000&t; 50ns, 20.0 MHz&n; *&t;&t;001&t; 75ns, 13.3 MHz&n; *&t;&t;010&t;100ns, 10.0 MHz&n; *&t;&t;011&t;125ns,  8.0 MHz&n; *&t;&t;100&t;150ns,  6.6 MHz&n; *&t;&t;101&t;175ns,  5.7 MHz&n; *&t;&t;110&t;200ns,  5.0 MHz&n; *&t;&t;111&t;250ns,  4.0 MHz&n; *&n; *Fast40(LVDS):&t;000&t; 25ns, 40.0 MHz&n; *&t;&t;001&t; 50ns, 20.0 MHz&n; *&t;&t;010&t; 75ns, 13.3 MHz&n; *&t;&t;011&t;100ns, 10.0 MHz&n; *&t;&t;100&t;125ns,  8.0 MHz&n; *&t;&t;101&t;150ns,  6.6 MHz&n; *&t;&t;110&t;175ns,  5.7 MHz&n; *&t;&t;111&t;200ns,  5.0 MHz&n; */
multiline_comment|/*static u8&t;clock_period[] = {12,19,25,31,37,44,50,62};*/
multiline_comment|/* real period:48ns,76ns,100ns,124ns,148ns,176ns,200ns,248ns */
DECL|variable|clock_period
r_static
id|u8
id|clock_period
(braket
)braket
op_assign
(brace
l_int|12
comma
l_int|18
comma
l_int|25
comma
l_int|31
comma
l_int|37
comma
l_int|43
comma
l_int|50
comma
l_int|62
)brace
suffix:semicolon
DECL|variable|clock_speed
r_static
id|u16
id|clock_speed
(braket
)braket
op_assign
(brace
l_int|200
comma
l_int|133
comma
l_int|100
comma
l_int|80
comma
l_int|67
comma
l_int|58
comma
l_int|50
comma
l_int|40
)brace
suffix:semicolon
multiline_comment|/*---------------------------------------------------------------------------&n;                                Configuration&n;  ---------------------------------------------------------------------------*/
multiline_comment|/*&n; * Module/boot parameters currently effect *all* instances of the&n; * card in the system.&n; */
multiline_comment|/*&n; * Command line parameters are stored in a structure below.&n; * These are the index&squot;s into the structure for the various&n; * command line options.&n; */
DECL|macro|CFG_ADAPTER_ID
mdefine_line|#define CFG_ADAPTER_ID&t;&t;0
DECL|macro|CFG_MAX_SPEED
mdefine_line|#define CFG_MAX_SPEED&t;&t;1
DECL|macro|CFG_DEV_MODE
mdefine_line|#define CFG_DEV_MODE&t;&t;2
DECL|macro|CFG_ADAPTER_MODE
mdefine_line|#define CFG_ADAPTER_MODE&t;3
DECL|macro|CFG_TAGS
mdefine_line|#define CFG_TAGS&t;&t;4
DECL|macro|CFG_RESET_DELAY
mdefine_line|#define CFG_RESET_DELAY&t;&t;5
DECL|macro|CFG_NUM
mdefine_line|#define CFG_NUM&t;&t;&t;6&t;/* number of configuration items */
multiline_comment|/*&n; * Value used to indicate that a command line override&n; * hasn&squot;t been used to modify the value.&n; */
DECL|macro|CFG_PARAM_UNSET
mdefine_line|#define CFG_PARAM_UNSET -1
multiline_comment|/*&n; * Hold command line parameters.&n; */
DECL|struct|ParameterData
r_struct
id|ParameterData
(brace
DECL|member|value
r_int
id|value
suffix:semicolon
multiline_comment|/* value of this setting */
DECL|member|min
r_int
id|min
suffix:semicolon
multiline_comment|/* minimum value */
DECL|member|max
r_int
id|max
suffix:semicolon
multiline_comment|/* maximum value */
DECL|member|def
r_int
id|def
suffix:semicolon
multiline_comment|/* default value */
DECL|member|safe
r_int
id|safe
suffix:semicolon
multiline_comment|/* safe value */
)brace
suffix:semicolon
DECL|variable|cfg_data
r_static
r_struct
id|ParameterData
id|__initdata
id|cfg_data
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* adapter id */
id|CFG_PARAM_UNSET
comma
l_int|0
comma
l_int|15
comma
l_int|7
comma
l_int|7
)brace
comma
(brace
multiline_comment|/* max speed */
id|CFG_PARAM_UNSET
comma
l_int|0
comma
l_int|7
comma
l_int|1
comma
multiline_comment|/* 13.3Mhz */
l_int|4
comma
multiline_comment|/*  6.7Hmz */
)brace
comma
(brace
multiline_comment|/* dev mode */
id|CFG_PARAM_UNSET
comma
l_int|0
comma
l_int|0x3f
comma
id|NTC_DO_PARITY_CHK
op_or
id|NTC_DO_DISCONNECT
op_or
id|NTC_DO_SYNC_NEGO
op_or
id|NTC_DO_WIDE_NEGO
op_or
id|NTC_DO_TAG_QUEUEING
op_or
id|NTC_DO_SEND_START
comma
id|NTC_DO_PARITY_CHK
op_or
id|NTC_DO_SEND_START
)brace
comma
(brace
multiline_comment|/* adapter mode */
id|CFG_PARAM_UNSET
comma
l_int|0
comma
l_int|0x2f
comma
macro_line|#ifdef CONFIG_SCSI_MULTI_LUN
id|NAC_SCANLUN
op_or
macro_line|#endif
id|NAC_GT2DRIVES
op_or
id|NAC_GREATER_1G
op_or
id|NAC_POWERON_SCSI_RESET
multiline_comment|/*| NAC_ACTIVE_NEG*/
comma
id|NAC_GT2DRIVES
op_or
id|NAC_GREATER_1G
op_or
id|NAC_POWERON_SCSI_RESET
op_or
l_int|0x08
)brace
comma
(brace
multiline_comment|/* tags */
id|CFG_PARAM_UNSET
comma
l_int|0
comma
l_int|5
comma
l_int|3
comma
multiline_comment|/* 16 tags (??) */
l_int|2
comma
)brace
comma
(brace
multiline_comment|/* reset delay */
id|CFG_PARAM_UNSET
comma
l_int|0
comma
l_int|180
comma
l_int|1
comma
multiline_comment|/* 1 second */
l_int|10
comma
multiline_comment|/* 10 seconds */
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * Safe settings. If set to zero the the BIOS/default values with&n; * command line overrides will be used. If set to 1 then safe and&n; * slow settings will be used.&n; */
DECL|variable|use_safe_settings
r_static
r_int
id|use_safe_settings
op_assign
l_int|0
suffix:semicolon
id|module_param_named
c_func
(paren
id|safe
comma
id|use_safe_settings
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|safe
comma
l_string|&quot;Use safe and slow settings only. Default: false&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|adapter_id
comma
id|cfg_data
(braket
id|CFG_ADAPTER_ID
)braket
dot
id|value
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|adapter_id
comma
l_string|&quot;Adapter SCSI ID. Default 7 (0-15)&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|max_speed
comma
id|cfg_data
(braket
id|CFG_MAX_SPEED
)braket
dot
id|value
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_speed
comma
l_string|&quot;Maximum bus speed. Default 1 (0-7) Speeds: 0=20, 1=13.3, 2=10, 3=8, 4=6.7, 5=5.8, 6=5, 7=4 Mhz&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|dev_mode
comma
id|cfg_data
(braket
id|CFG_DEV_MODE
)braket
dot
id|value
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dev_mode
comma
l_string|&quot;Device mode.&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|adapter_mode
comma
id|cfg_data
(braket
id|CFG_ADAPTER_MODE
)braket
dot
id|value
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|adapter_mode
comma
l_string|&quot;Adapter mode.&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|tags
comma
id|cfg_data
(braket
id|CFG_TAGS
)braket
dot
id|value
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|tags
comma
l_string|&quot;Number of tags (1&lt;&lt;x). Default 3 (0-5)&quot;
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|reset_delay
comma
id|cfg_data
(braket
id|CFG_RESET_DELAY
)braket
dot
id|value
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|reset_delay
comma
l_string|&quot;Reset delay in seconds. Default 1 (0-180)&quot;
)paren
suffix:semicolon
multiline_comment|/**&n; * set_safe_settings - if the use_safe_settings option is set then&n; * set all values to the safe and slow values.&n; **/
DECL|function|set_safe_settings
r_static
r_void
id|__init
id|set_safe_settings
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|use_safe_settings
)paren
(brace
r_int
id|i
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Using safe settings.&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CFG_NUM
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cfg_data
(braket
id|i
)braket
dot
id|value
op_assign
id|cfg_data
(braket
id|i
)braket
dot
id|safe
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * fix_settings - reset any boot parameters which are out of range&n; * back to the default values.&n; **/
DECL|function|fix_settings
r_static
r_void
id|__init
id|fix_settings
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_PARSE
comma
l_string|&quot;setup %08x %08x %08x %08x %08x %08x&bslash;n&quot;
comma
id|cfg_data
(braket
id|CFG_ADAPTER_ID
)braket
dot
id|value
comma
id|cfg_data
(braket
id|CFG_MAX_SPEED
)braket
dot
id|value
comma
id|cfg_data
(braket
id|CFG_DEV_MODE
)braket
dot
id|value
comma
id|cfg_data
(braket
id|CFG_ADAPTER_MODE
)braket
dot
id|value
comma
id|cfg_data
(braket
id|CFG_TAGS
)braket
dot
id|value
comma
id|cfg_data
(braket
id|CFG_RESET_DELAY
)braket
dot
id|value
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CFG_NUM
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cfg_data
(braket
id|i
)braket
dot
id|value
template_param
id|cfg_data
(braket
id|i
)braket
dot
id|max
)paren
id|cfg_data
(braket
id|i
)braket
dot
id|value
op_assign
id|cfg_data
(braket
id|i
)braket
dot
id|def
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Mapping from the eeprom delay index value (index into this array)&n; * to the the number of actual seconds that the delay should be for.&n; */
DECL|variable|eeprom_index_to_delay_map
r_static
r_char
id|__initdata
id|eeprom_index_to_delay_map
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|3
comma
l_int|5
comma
l_int|10
comma
l_int|16
comma
l_int|30
comma
l_int|60
comma
l_int|120
)brace
suffix:semicolon
multiline_comment|/**&n; * eeprom_index_to_delay - Take the eeprom delay setting and convert it&n; * into a number of seconds.&n; *&n; * @eeprom: The eeprom structure in which we find the delay index to map.&n; **/
DECL|function|eeprom_index_to_delay
r_static
r_void
id|__init
id|eeprom_index_to_delay
c_func
(paren
r_struct
id|NvRamType
op_star
id|eeprom
)paren
(brace
id|eeprom-&gt;delay_time
op_assign
id|eeprom_index_to_delay_map
(braket
id|eeprom-&gt;delay_time
)braket
suffix:semicolon
)brace
multiline_comment|/**&n; * delay_to_eeprom_index - Take a delay in seconds and return the&n; * closest eeprom index which will delay for at least that amount of&n; * seconds.&n; *&n; * @delay: The delay, in seconds, to find the eeprom index for.&n; **/
DECL|function|delay_to_eeprom_index
r_static
r_int
id|__init
id|delay_to_eeprom_index
c_func
(paren
r_int
id|delay
)paren
(brace
id|u8
id|idx
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|idx
OL
l_int|7
op_logical_and
id|eeprom_index_to_delay_map
(braket
id|idx
)braket
OL
id|delay
)paren
id|idx
op_increment
suffix:semicolon
r_return
id|idx
suffix:semicolon
)brace
multiline_comment|/**&n; * eeprom_override - Override the eeprom settings, in the provided&n; * eeprom structure, with values that have been set on the command&n; * line.&n; *&n; * @eeprom: The eeprom data to override with command line options.&n; **/
DECL|function|eeprom_override
r_static
r_void
id|__init
id|eeprom_override
c_func
(paren
r_struct
id|NvRamType
op_star
id|eeprom
)paren
(brace
id|u8
id|id
suffix:semicolon
multiline_comment|/* Adapter Settings */
r_if
c_cond
(paren
id|cfg_data
(braket
id|CFG_ADAPTER_ID
)braket
dot
id|value
op_ne
id|CFG_PARAM_UNSET
)paren
id|eeprom-&gt;scsi_id
op_assign
(paren
id|u8
)paren
id|cfg_data
(braket
id|CFG_ADAPTER_ID
)braket
dot
id|value
suffix:semicolon
r_if
c_cond
(paren
id|cfg_data
(braket
id|CFG_ADAPTER_MODE
)braket
dot
id|value
op_ne
id|CFG_PARAM_UNSET
)paren
id|eeprom-&gt;channel_cfg
op_assign
(paren
id|u8
)paren
id|cfg_data
(braket
id|CFG_ADAPTER_MODE
)braket
dot
id|value
suffix:semicolon
r_if
c_cond
(paren
id|cfg_data
(braket
id|CFG_RESET_DELAY
)braket
dot
id|value
op_ne
id|CFG_PARAM_UNSET
)paren
id|eeprom-&gt;delay_time
op_assign
id|delay_to_eeprom_index
c_func
(paren
id|cfg_data
(braket
id|CFG_RESET_DELAY
)braket
dot
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cfg_data
(braket
id|CFG_TAGS
)braket
dot
id|value
op_ne
id|CFG_PARAM_UNSET
)paren
id|eeprom-&gt;max_tag
op_assign
(paren
id|u8
)paren
id|cfg_data
(braket
id|CFG_TAGS
)braket
dot
id|value
suffix:semicolon
multiline_comment|/* Device Settings */
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|DC395x_MAX_SCSI_ID
suffix:semicolon
id|id
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cfg_data
(braket
id|CFG_DEV_MODE
)braket
dot
id|value
op_ne
id|CFG_PARAM_UNSET
)paren
id|eeprom-&gt;target
(braket
id|id
)braket
dot
id|cfg0
op_assign
(paren
id|u8
)paren
id|cfg_data
(braket
id|CFG_DEV_MODE
)braket
dot
id|value
suffix:semicolon
r_if
c_cond
(paren
id|cfg_data
(braket
id|CFG_MAX_SPEED
)braket
dot
id|value
op_ne
id|CFG_PARAM_UNSET
)paren
id|eeprom-&gt;target
(braket
id|id
)braket
dot
id|period
op_assign
(paren
id|u8
)paren
id|cfg_data
(braket
id|CFG_MAX_SPEED
)braket
dot
id|value
suffix:semicolon
)brace
)brace
multiline_comment|/*---------------------------------------------------------------------------&n; ---------------------------------------------------------------------------*/
DECL|function|list_size
r_static
r_int
r_int
id|list_size
c_func
(paren
r_struct
id|list_head
op_star
id|head
)paren
(brace
r_int
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_struct
id|list_head
op_star
id|pos
suffix:semicolon
id|list_for_each
c_func
(paren
id|pos
comma
id|head
)paren
id|count
op_increment
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|dcb_get_next
r_static
r_struct
id|DeviceCtlBlk
op_star
id|dcb_get_next
c_func
(paren
r_struct
id|list_head
op_star
id|head
comma
r_struct
id|DeviceCtlBlk
op_star
id|pos
)paren
(brace
r_int
id|use_next
op_assign
l_int|0
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|next
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|i
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
id|head
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* find supplied dcb and then select the next one */
id|list_for_each_entry
c_func
(paren
id|i
comma
id|head
comma
id|list
)paren
r_if
c_cond
(paren
id|use_next
)paren
(brace
id|next
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i
op_eq
id|pos
)paren
(brace
id|use_next
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* if no next one take the head one (ie, wraparound) */
r_if
c_cond
(paren
op_logical_neg
id|next
)paren
id|list_for_each_entry
c_func
(paren
id|i
comma
id|head
comma
id|list
)paren
(brace
id|next
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|next
suffix:semicolon
)brace
DECL|function|free_tag
r_static
r_void
id|free_tag
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
r_if
c_cond
(paren
id|srb-&gt;tag_number
OL
l_int|255
)paren
(brace
id|dcb-&gt;tag_mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|srb-&gt;tag_number
)paren
suffix:semicolon
multiline_comment|/* free tag mask */
id|srb-&gt;tag_number
op_assign
l_int|255
suffix:semicolon
)brace
)brace
multiline_comment|/* Find cmd in SRB list */
DECL|function|find_cmd
r_inline
r_static
r_struct
id|ScsiReqBlk
op_star
id|find_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_struct
id|list_head
op_star
id|head
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|i
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|i
comma
id|head
comma
id|list
)paren
r_if
c_cond
(paren
id|i-&gt;cmd
op_eq
id|cmd
)paren
r_return
id|i
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|srb_get_free
r_static
r_struct
id|ScsiReqBlk
op_star
id|srb_get_free
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_struct
id|list_head
op_star
id|head
op_assign
op_amp
id|acb-&gt;srb_free_list
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|srb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
id|head
)paren
)paren
(brace
id|srb
op_assign
id|list_entry
c_func
(paren
id|head-&gt;next
comma
r_struct
id|ScsiReqBlk
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|head-&gt;next
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb_get_free: got srb %p&bslash;n&quot;
comma
id|srb
)paren
suffix:semicolon
)brace
r_else
(brace
id|srb
op_assign
l_int|NULL
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Out of Free SRBs :-(&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|srb
suffix:semicolon
)brace
DECL|function|srb_free_insert
r_static
r_void
id|srb_free_insert
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb_free_insert: put srb %p&bslash;n&quot;
comma
id|srb
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|srb-&gt;list
comma
op_amp
id|acb-&gt;srb_free_list
)paren
suffix:semicolon
)brace
DECL|function|srb_waiting_insert
r_static
r_void
id|srb_waiting_insert
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb_waiting_insert: srb %p cmd %li&bslash;n&quot;
comma
id|srb
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|srb-&gt;list
comma
op_amp
id|dcb-&gt;srb_waiting_list
)paren
suffix:semicolon
)brace
DECL|function|srb_waiting_append
r_static
r_void
id|srb_waiting_append
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb_waiting_append: srb %p cmd %li&bslash;n&quot;
comma
id|srb
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|srb-&gt;list
comma
op_amp
id|dcb-&gt;srb_waiting_list
)paren
suffix:semicolon
)brace
DECL|function|srb_going_append
r_static
r_void
id|srb_going_append
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb_going_append: srb %p&bslash;n&quot;
comma
id|srb
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|srb-&gt;list
comma
op_amp
id|dcb-&gt;srb_going_list
)paren
suffix:semicolon
)brace
DECL|function|srb_going_remove
r_static
r_void
id|srb_going_remove
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|i
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|tmp
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb_going_remove: srb %p&bslash;n&quot;
comma
id|srb
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|i
comma
id|tmp
comma
op_amp
id|dcb-&gt;srb_going_list
comma
id|list
)paren
r_if
c_cond
(paren
id|i
op_eq
id|srb
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|srb-&gt;list
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|srb_waiting_remove
r_static
r_void
id|srb_waiting_remove
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|i
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|tmp
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb_waiting_remove: srb %p&bslash;n&quot;
comma
id|srb
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|i
comma
id|tmp
comma
op_amp
id|dcb-&gt;srb_waiting_list
comma
id|list
)paren
r_if
c_cond
(paren
id|i
op_eq
id|srb
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|srb-&gt;list
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|srb_going_to_waiting_move
r_static
r_void
id|srb_going_to_waiting_move
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb_going_to_waiting_move: srb %p, pid = %li&bslash;n&quot;
comma
id|srb
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|list_move
c_func
(paren
op_amp
id|srb-&gt;list
comma
op_amp
id|dcb-&gt;srb_waiting_list
)paren
suffix:semicolon
)brace
DECL|function|srb_waiting_to_going_move
r_static
r_void
id|srb_waiting_to_going_move
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb_waiting_to_going_move: srb %p&bslash;n&quot;
comma
id|srb
)paren
suffix:semicolon
id|list_move
c_func
(paren
op_amp
id|srb-&gt;list
comma
op_amp
id|dcb-&gt;srb_going_list
)paren
suffix:semicolon
)brace
multiline_comment|/* Sets the timer to wake us up */
DECL|function|waiting_set_timer
r_static
r_void
id|waiting_set_timer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_int
r_int
id|to
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
)paren
r_return
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
suffix:semicolon
id|acb-&gt;waiting_timer.function
op_assign
id|waiting_timeout
suffix:semicolon
id|acb-&gt;waiting_timer.data
op_assign
(paren
r_int
r_int
)paren
id|acb
suffix:semicolon
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|jiffies
op_plus
id|to
comma
id|acb-&gt;scsi_host-&gt;last_reset
op_minus
id|HZ
op_div
l_int|2
)paren
)paren
id|acb-&gt;waiting_timer.expires
op_assign
id|acb-&gt;scsi_host-&gt;last_reset
op_minus
id|HZ
op_div
l_int|2
op_plus
l_int|1
suffix:semicolon
r_else
id|acb-&gt;waiting_timer.expires
op_assign
id|jiffies
op_plus
id|to
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Send the next command from the waiting list to the bus */
DECL|function|waiting_process_next
r_static
r_void
id|waiting_process_next
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|start
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pos
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|srb
suffix:semicolon
r_struct
id|list_head
op_star
id|dcb_list_head
op_assign
op_amp
id|acb-&gt;dcb_list
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;active_dcb
op_logical_or
(paren
id|acb-&gt;acb_flag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
id|dcb_list_head
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Find the starting dcb. Need to find it again in the list&n;&t; * since the list may have changed since we set the ptr to it&n;&t; */
id|list_for_each_entry
c_func
(paren
id|dcb
comma
id|dcb_list_head
comma
id|list
)paren
r_if
c_cond
(paren
id|dcb
op_eq
id|acb-&gt;dcb_run_robin
)paren
(brace
id|start
op_assign
id|dcb
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|start
)paren
(brace
multiline_comment|/* This can happen! */
id|start
op_assign
id|list_entry
c_func
(paren
id|dcb_list_head-&gt;next
comma
id|typeof
c_func
(paren
op_star
id|start
)paren
comma
id|list
)paren
suffix:semicolon
id|acb-&gt;dcb_run_robin
op_assign
id|start
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Loop over the dcb, but we start somewhere (potentially) in&n;&t; * the middle of the loop so we need to manully do this.&n;&t; */
id|pos
op_assign
id|start
suffix:semicolon
r_do
(brace
r_struct
id|list_head
op_star
id|waiting_list_head
op_assign
op_amp
id|pos-&gt;srb_waiting_list
suffix:semicolon
multiline_comment|/* Make sure, the next another device gets scheduled ... */
id|acb-&gt;dcb_run_robin
op_assign
id|dcb_get_next
c_func
(paren
id|dcb_list_head
comma
id|acb-&gt;dcb_run_robin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
id|waiting_list_head
)paren
op_logical_or
id|pos-&gt;max_command
op_le
id|list_size
c_func
(paren
op_amp
id|pos-&gt;srb_going_list
)paren
)paren
(brace
multiline_comment|/* move to next dcb */
id|pos
op_assign
id|dcb_get_next
c_func
(paren
id|dcb_list_head
comma
id|pos
)paren
suffix:semicolon
)brace
r_else
(brace
id|srb
op_assign
id|list_entry
c_func
(paren
id|waiting_list_head-&gt;next
comma
r_struct
id|ScsiReqBlk
comma
id|list
)paren
suffix:semicolon
multiline_comment|/* Try to send to the bus */
r_if
c_cond
(paren
op_logical_neg
id|start_scsi
c_func
(paren
id|acb
comma
id|pos
comma
id|srb
)paren
)paren
id|srb_waiting_to_going_move
c_func
(paren
id|pos
comma
id|srb
)paren
suffix:semicolon
r_else
id|waiting_set_timer
c_func
(paren
id|acb
comma
id|HZ
op_div
l_int|50
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|pos
op_ne
id|start
)paren
suffix:semicolon
)brace
multiline_comment|/* Wake up waiting queue */
DECL|function|waiting_timeout
r_static
r_void
id|waiting_timeout
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|ptr
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;Debug: Waiting queue woken up by timer.&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_LOCK_IO
c_func
(paren
id|acb-&gt;scsi_host
comma
id|flags
)paren
suffix:semicolon
id|waiting_process_next
c_func
(paren
id|acb
)paren
suffix:semicolon
id|DC395x_UNLOCK_IO
c_func
(paren
id|acb-&gt;scsi_host
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the DCB for a given ID/LUN combination */
DECL|function|find_dcb
r_static
r_struct
id|DeviceCtlBlk
op_star
id|find_dcb
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
id|u8
id|id
comma
id|u8
id|lun
)paren
(brace
r_return
id|acb-&gt;children
(braket
id|id
)braket
(braket
id|lun
)braket
suffix:semicolon
)brace
multiline_comment|/* Send SCSI Request Block (srb) to adapter (acb) */
DECL|function|send_srb
r_static
r_void
id|send_srb
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
op_assign
id|srb-&gt;dcb
suffix:semicolon
r_if
c_cond
(paren
id|dcb-&gt;max_command
op_le
id|list_size
c_func
(paren
op_amp
id|dcb-&gt;srb_going_list
)paren
op_logical_or
id|acb-&gt;active_dcb
op_logical_or
(paren
id|acb-&gt;acb_flag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
)paren
(brace
id|srb_waiting_append
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|waiting_process_next
c_func
(paren
id|acb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|start_scsi
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
)paren
id|srb_going_append
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
r_else
(brace
id|srb_waiting_insert
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|waiting_set_timer
c_func
(paren
id|acb
comma
id|HZ
op_div
l_int|50
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Prepare SRB for being sent to Device DCB w/ command *cmd */
DECL|function|build_srb
r_static
r_void
id|build_srb
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
r_int
id|dir
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;build_srb...&bslash;n&quot;
)paren
suffix:semicolon
id|srb-&gt;dcb
op_assign
id|dcb
suffix:semicolon
id|srb-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|srb-&gt;sg_count
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;total_xfer_length
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;sg_bus_addr
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;virt_addr
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;sg_index
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;adapter_status
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;target_status
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;msg_count
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;status
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;flag
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;state
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;retry_count
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;tag_number
op_assign
id|TAG_NONE
suffix:semicolon
id|srb-&gt;scsi_phase
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/* initial phase */
id|srb-&gt;end_message
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_eq
id|PCI_DMA_NONE
op_logical_or
op_logical_neg
id|cmd-&gt;request_buffer
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb[A] len=%d buf=%p use_sg=%d !MAP=%08x&bslash;n&quot;
comma
id|cmd-&gt;bufflen
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;use_sg
comma
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
r_int
id|i
suffix:semicolon
id|u32
id|reqlen
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sl
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
r_struct
id|SGentry
op_star
id|sgp
op_assign
id|srb-&gt;segment_x
suffix:semicolon
id|srb-&gt;sg_count
op_assign
id|pci_map_sg
c_func
(paren
id|dcb-&gt;acb-&gt;dev
comma
id|sl
comma
id|cmd-&gt;use_sg
comma
id|dir
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb[B] len=%d buf=%p use_sg=%d segs=%d&bslash;n&quot;
comma
id|reqlen
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;use_sg
comma
id|srb-&gt;sg_count
)paren
suffix:semicolon
id|srb-&gt;virt_addr
op_assign
id|page_address
c_func
(paren
id|sl-&gt;page
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|srb-&gt;sg_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|busaddr
op_assign
(paren
id|u32
)paren
id|sg_dma_address
c_func
(paren
op_amp
id|sl
(braket
id|i
)braket
)paren
suffix:semicolon
id|u32
id|seglen
op_assign
(paren
id|u32
)paren
id|sl
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|sgp
(braket
id|i
)braket
dot
id|address
op_assign
id|busaddr
suffix:semicolon
id|sgp
(braket
id|i
)braket
dot
id|length
op_assign
id|seglen
suffix:semicolon
id|srb-&gt;total_xfer_length
op_add_assign
id|seglen
suffix:semicolon
)brace
id|sgp
op_add_assign
id|srb-&gt;sg_count
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t; * adjust last page if too big as it is allocated&n;&t;&t; * on even page boundaries&n;&t;&t; */
r_if
c_cond
(paren
id|srb-&gt;total_xfer_length
OG
id|reqlen
)paren
(brace
id|sgp-&gt;length
op_sub_assign
(paren
id|srb-&gt;total_xfer_length
op_minus
id|reqlen
)paren
suffix:semicolon
id|srb-&gt;total_xfer_length
op_assign
id|reqlen
suffix:semicolon
)brace
multiline_comment|/* Fixup for WIDE padding - make sure length is even */
r_if
c_cond
(paren
id|dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
op_logical_and
id|srb-&gt;total_xfer_length
op_mod
l_int|2
)paren
(brace
id|srb-&gt;total_xfer_length
op_increment
suffix:semicolon
id|sgp-&gt;length
op_increment
suffix:semicolon
)brace
id|srb-&gt;sg_bus_addr
op_assign
id|pci_map_single
c_func
(paren
id|dcb-&gt;acb-&gt;dev
comma
id|srb-&gt;segment_x
comma
id|SEGMENTX_LEN
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_SGPARANOIA
comma
l_string|&quot;srb[B] map sg %p-&gt;%08x(%05x)&bslash;n&quot;
comma
id|srb-&gt;segment_x
comma
id|srb-&gt;sg_bus_addr
comma
id|SEGMENTX_LEN
)paren
suffix:semicolon
)brace
r_else
(brace
id|srb-&gt;total_xfer_length
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
id|srb-&gt;sg_count
op_assign
l_int|1
suffix:semicolon
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
op_assign
id|pci_map_single
c_func
(paren
id|dcb-&gt;acb-&gt;dev
comma
id|cmd-&gt;request_buffer
comma
id|srb-&gt;total_xfer_length
comma
id|dir
)paren
suffix:semicolon
multiline_comment|/* Fixup for WIDE padding - make sure length is even */
r_if
c_cond
(paren
id|dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
op_logical_and
id|srb-&gt;total_xfer_length
op_mod
l_int|2
)paren
id|srb-&gt;total_xfer_length
op_increment
suffix:semicolon
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|length
op_assign
id|srb-&gt;total_xfer_length
suffix:semicolon
id|srb-&gt;virt_addr
op_assign
id|cmd-&gt;request_buffer
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb[C] len=%d buf=%p use_sg=%d map=%08x&bslash;n&quot;
comma
id|srb-&gt;total_xfer_length
comma
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;use_sg
comma
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * dc395x_queue_command - queue scsi command passed from the mid&n; * layer, invoke &squot;done&squot; on completion&n; *&n; * @cmd: pointer to scsi command object&n; * @done: function pointer to be invoked on completion&n; *&n; * Returns 1 if the adapter (host) is busy, else returns 0. One&n; * reason for an adapter to be busy is that the number&n; * of outstanding queued commands is already equal to&n; * struct Scsi_Host::can_queue .&n; *&n; * Required: if struct Scsi_Host::can_queue is ever non-zero&n; *           then this function is required.&n; *&n; * Locks: struct Scsi_Host::host_lock held on entry (with &quot;irqsave&quot;)&n; *        and is expected to be held on return.&n; *&n; **/
DECL|function|dc395x_queue_command
r_static
r_int
id|dc395x_queue_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|srb
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;Queue Cmd=%02x,Tgt=%d,LUN=%d (pid=%li)&bslash;n&quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
multiline_comment|/* Assume BAD_TARGET; will be cleared later */
id|cmd-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* ignore invalid targets */
r_if
c_cond
(paren
id|cmd-&gt;device-&gt;id
op_ge
id|acb-&gt;scsi_host-&gt;max_id
op_logical_or
id|cmd-&gt;device-&gt;lun
op_ge
id|acb-&gt;scsi_host-&gt;max_lun
op_logical_or
id|cmd-&gt;device-&gt;lun
OG
l_int|31
)paren
(brace
r_goto
id|complete
suffix:semicolon
)brace
multiline_comment|/* does the specified lun on the specified device exist */
r_if
c_cond
(paren
op_logical_neg
(paren
id|acb-&gt;dcb_map
(braket
id|cmd-&gt;device-&gt;id
)braket
op_amp
(paren
l_int|1
op_lshift
id|cmd-&gt;device-&gt;lun
)paren
)paren
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Ignore target %02x lun %02x&bslash;n&quot;
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
r_goto
id|complete
suffix:semicolon
)brace
multiline_comment|/* do we have a DCB for the device */
id|dcb
op_assign
id|find_dcb
c_func
(paren
id|acb
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dcb
)paren
(brace
multiline_comment|/* should never happen */
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;no DCB failed, target %02x lun %02x&bslash;n&quot;
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;No DCB in queuecommand (2)!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|complete
suffix:semicolon
)brace
multiline_comment|/* set callback and clear result in the command */
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|cmd-&gt;result
op_assign
l_int|0
suffix:semicolon
id|srb
op_assign
id|srb_get_free
c_func
(paren
id|acb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|srb
)paren
(brace
multiline_comment|/*&n;&t;&t; * Return 1 since we are unable to queue this command at this&n;&t;&t; * point in time.&n;&t;&t; */
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;No free SRB&squot;s in queuecommand&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|build_srb
c_func
(paren
id|cmd
comma
id|dcb
comma
id|srb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dcb-&gt;srb_waiting_list
)paren
)paren
(brace
multiline_comment|/* append to waiting queue */
id|srb_waiting_append
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|waiting_process_next
c_func
(paren
id|acb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* process immediately */
id|send_srb
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
)brace
id|dprintkdbg
c_func
(paren
id|DBG_1
comma
l_string|&quot;... command (pid %li) queued successfully.&bslash;n&quot;
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|complete
suffix:colon
multiline_comment|/*&n;&t; * Complete the command immediatey, and then return 0 to&n;&t; * indicate that we have handled the command. This is usually&n;&t; * done when the commad is for things like non existent&n;&t; * devices.&n;&t; */
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Return the disk geometry for the given SCSI device.&n; */
DECL|function|dc395x_bios_param
r_static
r_int
id|dc395x_bios_param
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
comma
r_struct
id|block_device
op_star
id|bdev
comma
id|sector_t
id|capacity
comma
r_int
op_star
id|info
)paren
(brace
macro_line|#ifdef CONFIG_SCSI_DC395x_TRMS1040_TRADMAP
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|acb
suffix:semicolon
r_int
id|size
op_assign
id|capacity
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;dc395x_bios_param..............&bslash;n&quot;
)paren
suffix:semicolon
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|size
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|acb-&gt;gmode2
op_amp
id|NAC_GREATER_1G
)paren
op_logical_and
(paren
id|cylinders
OG
l_int|1024
)paren
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
id|size
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
id|scsicam_bios_param
c_func
(paren
id|bdev
comma
id|capacity
comma
id|info
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|dump_register_info
r_static
r_void
id|dump_register_info
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|u16
id|pstat
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|acb-&gt;dev
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_STATUS
comma
op_amp
id|pstat
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dcb
)paren
id|dcb
op_assign
id|acb-&gt;active_dcb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|srb
op_logical_and
id|dcb
)paren
id|srb
op_assign
id|dcb-&gt;active_srb
suffix:semicolon
r_if
c_cond
(paren
id|srb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|srb-&gt;cmd
)paren
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;dump: SRB %p: cmd %p OOOPS!&bslash;n&quot;
comma
id|srb
comma
id|srb-&gt;cmd
)paren
suffix:semicolon
r_else
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;dump: SRB %p: cmd %p pid %li: %02x (%02i-%i)&bslash;n&quot;
comma
id|srb
comma
id|srb-&gt;cmd
comma
id|srb-&gt;cmd-&gt;pid
comma
id|srb-&gt;cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|srb-&gt;cmd-&gt;device-&gt;id
comma
id|srb-&gt;cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              SGList %p Cnt %i Idx %i Len %i&bslash;n&quot;
comma
id|srb-&gt;segment_x
comma
id|srb-&gt;sg_count
comma
id|srb-&gt;sg_index
comma
id|srb-&gt;total_xfer_length
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;              State %04x Status %02x Phase %02x (%sconn.)&bslash;n&quot;
comma
id|srb-&gt;state
comma
id|srb-&gt;status
comma
id|srb-&gt;scsi_phase
comma
(paren
id|acb-&gt;active_dcb
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;not&quot;
)paren
suffix:semicolon
)brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;dump: SCSI block&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;              Status %04x FIFOCnt %02x Signals %02x IRQStat %02x&bslash;n&quot;
comma
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_STATUS
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_SIGNAL
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_INTSTATUS
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;              Sync %02x Target %02x RSelID %02x SCSICtr %08x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_SYNC
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_TARGETID
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_IDMSG
)paren
comma
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COUNTER
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;              IRQEn %02x Config %04x Cfg2 %02x Cmd %02x SelTO %02x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_INTEN
)paren
comma
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONFIG0
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONFIG2
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_TIMEOUT
)paren
)paren
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;dump: DMA block&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;              Cmd %04x FIFOCnt %02x FStat %02x IRQStat %02x IRQEn %02x Cfg %04x&bslash;n&quot;
comma
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_COMMAND
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOSTAT
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_STATUS
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_INTEN
)paren
comma
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONFIG
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              TCtr %08x CTCtr %08x Addr %08x%08x&bslash;n&quot;
comma
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_XCNT
)paren
comma
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CXCNT
)paren
comma
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_XHIGHADDR
)paren
comma
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_XLOWADDR
)paren
)paren
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;dump: Misc: GCtrl %02x GStat %02x GTmr %02x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_GEN_CONTROL
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_GEN_STATUS
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_GEN_TIMER
)paren
)paren
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;dump: PCI Status %04x&bslash;n&quot;
comma
id|pstat
)paren
suffix:semicolon
)brace
DECL|function|clear_fifo
r_static
r_inline
r_void
id|clear_fifo
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_char
op_star
id|txt
)paren
(brace
macro_line|#if debug_enabled(DBG_FIFO)
id|u8
id|lines
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_SIGNAL
)paren
suffix:semicolon
id|u8
id|fifocnt
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|fifocnt
op_amp
l_int|0x40
)paren
)paren
id|dprintkdbg
c_func
(paren
id|DBG_FIFO
comma
l_string|&quot;Clr FIFO (%i bytes) on phase %02x in %s&bslash;n&quot;
comma
id|fifocnt
op_amp
l_int|0x3f
comma
id|lines
comma
id|txt
)paren
suffix:semicolon
macro_line|#endif
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_CLRFIFO
)paren
suffix:semicolon
)brace
DECL|function|reset_dev_param
r_static
r_void
id|reset_dev_param
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
r_struct
id|NvRamType
op_star
id|eeprom
op_assign
op_amp
id|acb-&gt;eeprom
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;reset_dev_param..............&bslash;n&quot;
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dcb
comma
op_amp
id|acb-&gt;dcb_list
comma
id|list
)paren
(brace
id|u8
id|period_index
suffix:semicolon
id|dcb-&gt;sync_mode
op_and_assign
op_complement
(paren
id|SYNC_NEGO_DONE
op_plus
id|WIDE_NEGO_DONE
)paren
suffix:semicolon
id|dcb-&gt;sync_period
op_assign
l_int|0
suffix:semicolon
id|dcb-&gt;sync_offset
op_assign
l_int|0
suffix:semicolon
id|dcb-&gt;dev_mode
op_assign
id|eeprom-&gt;target
(braket
id|dcb-&gt;target_id
)braket
dot
id|cfg0
suffix:semicolon
id|period_index
op_assign
id|eeprom-&gt;target
(braket
id|dcb-&gt;target_id
)braket
dot
id|period
op_amp
l_int|0x07
suffix:semicolon
id|dcb-&gt;min_nego_period
op_assign
id|clock_period
(braket
id|period_index
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_WIDE_NEGO
)paren
op_logical_or
op_logical_neg
(paren
id|acb-&gt;config
op_amp
id|HCC_WIDE_CARD
)paren
)paren
id|dcb-&gt;sync_mode
op_and_assign
op_complement
id|WIDE_NEGO_ENABLE
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * perform a hard reset on the SCSI bus&n; * @cmd - some command for this host (for fetching hooks)&n; * Returns: SUCCESS (0x2002) on success, else FAILED (0x2003).&n; */
DECL|function|dc395x_eh_bus_reset
r_static
r_int
id|dc395x_eh_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|acb
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;reset requested!&bslash;n&quot;
)paren
suffix:semicolon
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupt    &n;&t; */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_INTEN
comma
l_int|0x00
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_INTEN
comma
l_int|0x00
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_RSTMODULE
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONTROL
comma
id|DMARESETMODULE
)paren
suffix:semicolon
id|reset_scsi_bus
c_func
(paren
id|acb
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
multiline_comment|/* We may be in serious trouble. Wait some seconds */
id|acb-&gt;scsi_host-&gt;last_reset
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|acb-&gt;eeprom.delay_time
suffix:semicolon
multiline_comment|/*&n;&t; * re-enable interrupt      &n;&t; */
multiline_comment|/* Clear SCSI FIFO          */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONTROL
comma
id|CLRXFIFO
)paren
suffix:semicolon
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;reset&quot;
)paren
suffix:semicolon
multiline_comment|/* Delete pending IRQ */
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_INTSTATUS
)paren
suffix:semicolon
id|set_basic_config
c_func
(paren
id|acb
)paren
suffix:semicolon
id|reset_dev_param
c_func
(paren
id|acb
)paren
suffix:semicolon
id|doing_srb_done
c_func
(paren
id|acb
comma
id|DID_RESET
comma
id|cmd
comma
l_int|0
)paren
suffix:semicolon
id|acb-&gt;active_dcb
op_assign
l_int|NULL
suffix:semicolon
id|acb-&gt;acb_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* RESET_DETECT, RESET_DONE ,RESET_DEV */
id|waiting_process_next
c_func
(paren
id|acb
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * abort an errant SCSI command&n; * @cmd - command to be aborted&n; * Returns: SUCCESS (0x2002) on success, else FAILED (0x2003).&n; */
DECL|function|dc395x_eh_abort
r_static
r_int
id|dc395x_eh_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
multiline_comment|/*&n;&t; * Look into our command queues: If it has not been sent already,&n;&t; * we remove it and return success. Otherwise fail.&n;&t; */
r_struct
id|AdapterCtlBlk
op_star
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|srb
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;eh abort: cmd %p (pid %li, %02i-%i) &quot;
comma
id|cmd
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|dcb
op_assign
id|find_dcb
c_func
(paren
id|acb
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dcb
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;abort - no DCB found&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|srb
op_assign
id|find_cmd
c_func
(paren
id|cmd
comma
op_amp
id|dcb-&gt;srb_waiting_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb
)paren
(brace
id|srb_waiting_remove
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|pci_unmap_srb_sense
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
id|pci_unmap_srb
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
id|free_tag
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|srb_free_insert
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;abort - command found in waiting commands queue&quot;
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
id|srb
op_assign
id|find_cmd
c_func
(paren
id|cmd
comma
op_amp
id|dcb-&gt;srb_going_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;abort - command currently in progress&quot;
)paren
suffix:semicolon
multiline_comment|/* XXX: Should abort the command here */
)brace
r_else
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;abort - command not found&quot;
)paren
suffix:semicolon
)brace
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* SDTR */
DECL|function|build_sdtr
r_static
r_void
id|build_sdtr
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|u8
op_star
id|ptr
op_assign
id|srb-&gt;msgout_buf
op_plus
id|srb-&gt;msg_count
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;msg_count
OG
l_int|1
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Build_SDTR: msgout_buf BUSY (%i: %02x %02x)&bslash;n&quot;
comma
id|srb-&gt;msg_count
comma
id|srb-&gt;msgout_buf
(braket
l_int|0
)braket
comma
id|srb-&gt;msgout_buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_SYNC_NEGO
)paren
)paren
(brace
id|dcb-&gt;sync_offset
op_assign
l_int|0
suffix:semicolon
id|dcb-&gt;min_nego_period
op_assign
l_int|200
op_rshift
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dcb-&gt;sync_offset
op_eq
l_int|0
)paren
id|dcb-&gt;sync_offset
op_assign
id|SYNC_NEGO_OFFSET
suffix:semicolon
op_star
id|ptr
op_increment
op_assign
id|MSG_EXTENDED
suffix:semicolon
multiline_comment|/* (01h) */
op_star
id|ptr
op_increment
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* length */
op_star
id|ptr
op_increment
op_assign
id|EXTENDED_SDTR
suffix:semicolon
multiline_comment|/* (01h) */
op_star
id|ptr
op_increment
op_assign
id|dcb-&gt;min_nego_period
suffix:semicolon
multiline_comment|/* Transfer period (in 4ns) */
op_star
id|ptr
op_increment
op_assign
id|dcb-&gt;sync_offset
suffix:semicolon
multiline_comment|/* Transfer period (max. REQ/ACK dist) */
id|srb-&gt;msg_count
op_add_assign
l_int|5
suffix:semicolon
id|srb-&gt;state
op_or_assign
id|SRB_DO_SYNC_NEGO
suffix:semicolon
)brace
multiline_comment|/* WDTR */
DECL|function|build_wdtr
r_static
r_void
id|build_wdtr
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|u8
id|wide
op_assign
(paren
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_WIDE_NEGO
)paren
op_amp
(paren
id|acb-&gt;config
op_amp
id|HCC_WIDE_CARD
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|u8
op_star
id|ptr
op_assign
id|srb-&gt;msgout_buf
op_plus
id|srb-&gt;msg_count
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;msg_count
OG
l_int|1
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Build_WDTR: msgout_buf BUSY (%i: %02x %02x)&bslash;n&quot;
comma
id|srb-&gt;msg_count
comma
id|srb-&gt;msgout_buf
(braket
l_int|0
)braket
comma
id|srb-&gt;msgout_buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
op_star
id|ptr
op_increment
op_assign
id|MSG_EXTENDED
suffix:semicolon
multiline_comment|/* (01h) */
op_star
id|ptr
op_increment
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* length */
op_star
id|ptr
op_increment
op_assign
id|EXTENDED_WDTR
suffix:semicolon
multiline_comment|/* (03h) */
op_star
id|ptr
op_increment
op_assign
id|wide
suffix:semicolon
id|srb-&gt;msg_count
op_add_assign
l_int|4
suffix:semicolon
id|srb-&gt;state
op_or_assign
id|SRB_DO_WIDE_NEGO
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* Timer to work around chip flaw: When selecting and the bus is &n; * busy, we sometimes miss a Selection timeout IRQ */
r_void
id|selection_timeout_missed
c_func
(paren
r_int
r_int
id|ptr
)paren
suffix:semicolon
multiline_comment|/* Sets the timer to wake us up */
r_static
r_void
id|selto_timer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|acb-&gt;selto_timer
)paren
)paren
r_return
suffix:semicolon
id|acb-&gt;selto_timer.function
op_assign
id|selection_timeout_missed
suffix:semicolon
id|acb-&gt;selto_timer.data
op_assign
(paren
r_int
r_int
)paren
id|acb
suffix:semicolon
r_if
c_cond
(paren
id|time_before
(paren
id|jiffies
op_plus
id|HZ
comma
id|acb-&gt;scsi_host-&gt;last_reset
op_plus
id|HZ
op_div
l_int|2
)paren
)paren
id|acb-&gt;selto_timer.expires
op_assign
id|acb-&gt;scsi_host-&gt;last_reset
op_plus
id|HZ
op_div
l_int|2
op_plus
l_int|1
suffix:semicolon
r_else
id|acb-&gt;selto_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|acb-&gt;selto_timer
)paren
suffix:semicolon
)brace
r_void
id|selection_timeout_missed
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|ptr
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|srb
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Chip forgot to produce SelTO IRQ!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acb-&gt;active_dcb
op_logical_or
op_logical_neg
id|acb-&gt;active_dcb-&gt;active_srb
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;... but no cmd pending? Oops!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DC395x_LOCK_IO
c_func
(paren
id|acb-&gt;scsi_host
comma
id|flags
)paren
suffix:semicolon
id|srb
op_assign
id|acb-&gt;active_dcb-&gt;active_srb
suffix:semicolon
id|disconnect
c_func
(paren
id|acb
)paren
suffix:semicolon
id|DC395x_UNLOCK_IO
c_func
(paren
id|acb-&gt;scsi_host
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|start_scsi
r_static
id|u8
id|start_scsi
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|u16
id|s_stat2
comma
id|return_code
suffix:semicolon
id|u8
id|s_stat
comma
id|scsicommand
comma
id|i
comma
id|identify_message
suffix:semicolon
id|u8
op_star
id|ptr
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;start_scsi (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|srb-&gt;tag_number
op_assign
id|TAG_NONE
suffix:semicolon
multiline_comment|/* acb-&gt;tag_max_num: had error read in eeprom */
id|s_stat
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_SIGNAL
)paren
suffix:semicolon
id|s_stat2
op_assign
l_int|0
suffix:semicolon
id|s_stat2
op_assign
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_STATUS
)paren
suffix:semicolon
macro_line|#if 1
r_if
c_cond
(paren
id|s_stat
op_amp
l_int|0x20
multiline_comment|/* s_stat2 &amp; 0x02000 */
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;StartSCSI: pid %li(%02i-%i): BUSY %02x %04x&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|s_stat
comma
id|s_stat2
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Try anyway?&n;&t;&t; *&n;&t;&t; * We could, BUT: Sometimes the TRM_S1040 misses to produce a Selection&n;&t;&t; * Timeout, a Disconnect or a Reselction IRQ, so we would be screwed!&n;&t;&t; * (This is likely to be a bug in the hardware. Obviously, most people&n;&t;&t; *  only have one initiator per SCSI bus.)&n;&t;&t; * Instead let this fail and have the timer make sure the command is &n;&t;&t; * tried again after a short time&n;&t;&t; */
multiline_comment|/*selto_timer (acb); */
multiline_comment|/*monitor_next_irq = 1; */
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|acb-&gt;active_dcb
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;We try to start a SCSI command (%li)!&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;While another one (%li) is active!!&bslash;n&quot;
comma
(paren
id|acb-&gt;active_dcb-&gt;active_srb
ques
c_cond
id|acb-&gt;active_dcb
op_member_access_from_pointer
id|active_srb-&gt;cmd-&gt;pid
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_STATUS
)paren
op_amp
id|SCSIINTERRUPT
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;StartSCSI failed (busy) for pid %li(%02i-%i)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Allow starting of SCSI commands half a second before we allow the mid-level&n;&t; * to queue them again after a reset */
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|acb-&gt;scsi_host-&gt;last_reset
op_minus
id|HZ
op_div
l_int|2
)paren
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;We were just reset and don&squot;t accept commands yet!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Flush FIFO */
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;Start&quot;
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_HOSTID
comma
id|acb-&gt;scsi_host-&gt;this_id
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_TARGETID
comma
id|dcb-&gt;target_id
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_SYNC
comma
id|dcb-&gt;sync_period
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_OFFSET
comma
id|dcb-&gt;sync_offset
)paren
suffix:semicolon
id|srb-&gt;scsi_phase
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/* initial phase */
id|identify_message
op_assign
id|dcb-&gt;identify_msg
suffix:semicolon
multiline_comment|/*DC395x_TRM_write8(TRM_S1040_SCSI_IDMSG, identify_message); */
multiline_comment|/* Don&squot;t allow disconnection for AUTO_REQSENSE: Cont.All.Cond.! */
r_if
c_cond
(paren
id|srb-&gt;flag
op_amp
id|AUTO_REQSENSE
)paren
id|identify_message
op_and_assign
l_int|0xBF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|srb-&gt;cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_or
(paren
id|srb-&gt;cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
op_logical_or
(paren
id|srb-&gt;flag
op_amp
id|AUTO_REQSENSE
)paren
)paren
op_logical_and
(paren
(paren
(paren
id|dcb-&gt;sync_mode
op_amp
id|WIDE_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|dcb-&gt;sync_mode
op_amp
id|WIDE_NEGO_DONE
)paren
)paren
op_logical_or
(paren
(paren
id|dcb-&gt;sync_mode
op_amp
id|SYNC_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|dcb-&gt;sync_mode
op_amp
id|SYNC_NEGO_DONE
)paren
)paren
)paren
op_logical_and
(paren
id|dcb-&gt;target_lun
op_eq
l_int|0
)paren
)paren
(brace
id|srb-&gt;msgout_buf
(braket
l_int|0
)braket
op_assign
id|identify_message
suffix:semicolon
id|srb-&gt;msg_count
op_assign
l_int|1
suffix:semicolon
id|scsicommand
op_assign
id|SCMD_SEL_ATNSTOP
suffix:semicolon
id|srb-&gt;state
op_assign
id|SRB_MSGOUT
suffix:semicolon
macro_line|#ifndef SYNC_FIRST
r_if
c_cond
(paren
id|dcb-&gt;sync_mode
op_amp
id|WIDE_NEGO_ENABLE
op_logical_and
id|dcb-&gt;inquiry7
op_amp
id|SCSI_INQ_WBUS16
)paren
(brace
id|build_wdtr
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
suffix:semicolon
r_goto
id|no_cmd
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|dcb-&gt;sync_mode
op_amp
id|SYNC_NEGO_ENABLE
op_logical_and
id|dcb-&gt;inquiry7
op_amp
id|SCSI_INQ_SYNC
)paren
(brace
id|build_sdtr
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
suffix:semicolon
r_goto
id|no_cmd
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dcb-&gt;sync_mode
op_amp
id|WIDE_NEGO_ENABLE
op_logical_and
id|dcb-&gt;inquiry7
op_amp
id|SCSI_INQ_WBUS16
)paren
(brace
id|build_wdtr
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
suffix:semicolon
r_goto
id|no_cmd
suffix:semicolon
)brace
id|srb-&gt;msg_count
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Send identify message */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
id|identify_message
)paren
suffix:semicolon
id|scsicommand
op_assign
id|SCMD_SEL_ATN
suffix:semicolon
id|srb-&gt;state
op_assign
id|SRB_START_
suffix:semicolon
macro_line|#ifndef DC395x_NO_TAGQ
r_if
c_cond
(paren
(paren
id|dcb-&gt;sync_mode
op_amp
id|EN_TAG_QUEUEING
)paren
op_logical_and
(paren
id|identify_message
op_amp
l_int|0xC0
)paren
)paren
(brace
multiline_comment|/* Send Tag message */
id|u32
id|tag_mask
op_assign
l_int|1
suffix:semicolon
id|u8
id|tag_number
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|tag_mask
op_amp
id|dcb-&gt;tag_mask
op_logical_and
id|tag_number
op_le
id|dcb-&gt;max_command
)paren
(brace
id|tag_mask
op_assign
id|tag_mask
op_lshift
l_int|1
suffix:semicolon
id|tag_number
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tag_number
op_ge
id|dcb-&gt;max_command
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;Start_SCSI: Out of tags for pid %li (%i-%i)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|srb-&gt;cmd-&gt;device-&gt;id
comma
id|srb-&gt;cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|srb-&gt;state
op_assign
id|SRB_READY
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_HWRESELECT
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Send Tag id */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
id|MSG_SIMPLE_QTAG
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
id|tag_number
)paren
suffix:semicolon
id|dcb-&gt;tag_mask
op_or_assign
id|tag_mask
suffix:semicolon
id|srb-&gt;tag_number
op_assign
id|tag_number
suffix:semicolon
id|scsicommand
op_assign
id|SCMD_SEL_ATN3
suffix:semicolon
id|srb-&gt;state
op_assign
id|SRB_START_
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*polling:*/
multiline_comment|/* Send CDB ..command block ......... */
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;StartSCSI (pid %li) %02x (%i-%i): Tag %i&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|srb-&gt;cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|srb-&gt;cmd-&gt;device-&gt;id
comma
id|srb-&gt;cmd-&gt;device-&gt;lun
comma
id|srb-&gt;tag_number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;flag
op_amp
id|AUTO_REQSENSE
)paren
(brace
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
id|REQUEST_SENSE
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
(paren
id|dcb-&gt;target_lun
op_lshift
l_int|5
)paren
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
r_sizeof
(paren
id|srb-&gt;cmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|srb-&gt;cmd-&gt;cmnd
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|srb-&gt;cmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
op_star
id|ptr
op_increment
)paren
suffix:semicolon
)brace
id|no_cmd
suffix:colon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_HWRESELECT
op_or
id|DO_DATALATCH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_STATUS
)paren
op_amp
id|SCSIINTERRUPT
)paren
(brace
multiline_comment|/* &n;&t;&t; * If start_scsi return 1:&n;&t;&t; * we caught an interrupt (must be reset or reselection ... )&n;&t;&t; * : Let&squot;s process it first!&n;&t;&t; */
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;Debug: StartSCSI failed (busy) for pid %li(%02i-%i)!&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
multiline_comment|/*clear_fifo(acb, &quot;Start2&quot;); */
multiline_comment|/*DC395x_write16(TRM_S1040_SCSI_CONTROL, DO_HWRESELECT | DO_DATALATCH); */
id|srb-&gt;state
op_assign
id|SRB_READY
suffix:semicolon
id|free_tag
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|srb-&gt;msg_count
op_assign
l_int|0
suffix:semicolon
id|return_code
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* This IRQ should NOT get lost, as we did not acknowledge it */
)brace
r_else
(brace
multiline_comment|/* &n;&t;&t; * If start_scsi returns 0:&n;&t;&t; * we know that the SCSI processor is free&n;&t;&t; */
id|srb-&gt;scsi_phase
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/* initial phase */
id|dcb-&gt;active_srb
op_assign
id|srb
suffix:semicolon
id|acb-&gt;active_dcb
op_assign
id|dcb
suffix:semicolon
id|return_code
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
op_or
id|DO_HWRESELECT
)paren
suffix:semicolon
multiline_comment|/* SCSI command */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|scsicommand
)paren
suffix:semicolon
)brace
r_return
id|return_code
suffix:semicolon
)brace
multiline_comment|/**&n; * dc395x_handle_interrupt - Handle an interrupt that has been confirmed to&n; *                           have been triggered for this card.&n; *&n; * @acb:&t; a pointer to the adpter control block&n; * @scsi_status: the status return when we checked the card&n; **/
DECL|function|dc395x_handle_interrupt
r_static
r_void
id|dc395x_handle_interrupt
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
id|u16
id|scsi_status
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|srb
suffix:semicolon
id|u16
id|phase
suffix:semicolon
id|u8
id|scsi_intstatus
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_void
(paren
op_star
id|dc395x_statev
)paren
(paren
r_struct
id|AdapterCtlBlk
op_star
comma
r_struct
id|ScsiReqBlk
op_star
comma
id|u16
op_star
)paren
suffix:semicolon
id|DC395x_LOCK_IO
c_func
(paren
id|acb-&gt;scsi_host
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* This acknowledges the IRQ */
id|scsi_intstatus
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_INTSTATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|scsi_status
op_amp
l_int|0x2007
)paren
op_eq
l_int|0x2002
)paren
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;COP after COP completed? %04x&bslash;n&quot;
comma
id|scsi_status
)paren
suffix:semicolon
macro_line|#if 1&t;&t;&t;&t;/*def DBG_0 */
r_if
c_cond
(paren
id|monitor_next_irq
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;status=%04x intstatus=%02x&bslash;n&quot;
comma
id|scsi_status
comma
id|scsi_intstatus
)paren
suffix:semicolon
id|monitor_next_irq
op_decrement
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_KG
)paren
)paren
(brace
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
id|INT_SELTIMEOUT
)paren
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;Sel Timeout IRQ&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*dprintkl(KERN_DEBUG, &quot;DC395x_IRQ: intstatus = %02x &quot;, scsi_intstatus); */
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|acb-&gt;selto_timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|acb-&gt;selto_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
(paren
id|INT_SELTIMEOUT
op_or
id|INT_DISCONNECT
)paren
)paren
(brace
id|disconnect
c_func
(paren
id|acb
)paren
suffix:semicolon
multiline_comment|/* bus free interrupt  */
r_goto
id|out_unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
id|INT_RESELECTED
)paren
(brace
id|reselect
c_func
(paren
id|acb
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
id|INT_SELECT
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Host does not support target mode!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
id|INT_SCSIRESET
)paren
(brace
id|scsi_reset_detect
c_func
(paren
id|acb
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
(paren
id|INT_BUSSERVICE
op_or
id|INT_CMDDONE
)paren
)paren
(brace
id|dcb
op_assign
id|acb-&gt;active_dcb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dcb
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Oops: BusService (%04x %02x) w/o ActiveDCB!&bslash;n&quot;
comma
id|scsi_status
comma
id|scsi_intstatus
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
id|srb
op_assign
id|dcb-&gt;active_srb
suffix:semicolon
r_if
c_cond
(paren
id|dcb-&gt;flag
op_amp
id|ABORT_DEV_
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;MsgOut Abort Device.....&bslash;n&quot;
)paren
suffix:semicolon
id|enable_msgout_abort
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
)brace
multiline_comment|/* software sequential machine */
id|phase
op_assign
(paren
id|u16
)paren
id|srb-&gt;scsi_phase
suffix:semicolon
multiline_comment|/* &n;&t;&t; * 62037 or 62137&n;&t;&t; * call  dc395x_scsi_phase0[]... &quot;phase entry&quot;&n;&t;&t; * handle every phase before start transfer&n;&t;&t; */
multiline_comment|/* data_out_phase0,&t;phase:0 */
multiline_comment|/* data_in_phase0,&t;phase:1 */
multiline_comment|/* command_phase0,&t;phase:2 */
multiline_comment|/* status_phase0,&t;phase:3 */
multiline_comment|/* nop0,&t;&t;phase:4 PH_BUS_FREE .. initial phase */
multiline_comment|/* nop0,&t;&t;phase:5 PH_BUS_FREE .. initial phase */
multiline_comment|/* msgout_phase0,&t;phase:6 */
multiline_comment|/* msgin_phase0,&t;phase:7 */
id|dc395x_statev
op_assign
id|dc395x_scsi_phase0
(braket
id|phase
)braket
suffix:semicolon
id|dc395x_statev
c_func
(paren
id|acb
comma
id|srb
comma
op_amp
id|scsi_status
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; * if there were any exception occured scsi_status&n;&t;&t; * will be modify to bus free phase new scsi_status&n;&t;&t; * transfer out from ... previous dc395x_statev&n;&t;&t; */
id|srb-&gt;scsi_phase
op_assign
id|scsi_status
op_amp
id|PHASEMASK
suffix:semicolon
id|phase
op_assign
(paren
id|u16
)paren
id|scsi_status
op_amp
id|PHASEMASK
suffix:semicolon
multiline_comment|/* &n;&t;&t; * call  dc395x_scsi_phase1[]... &quot;phase entry&quot; handle&n;&t;&t; * every phase to do transfer&n;&t;&t; */
multiline_comment|/* data_out_phase1,&t;phase:0 */
multiline_comment|/* data_in_phase1,&t;phase:1 */
multiline_comment|/* command_phase1,&t;phase:2 */
multiline_comment|/* status_phase1,&t;phase:3 */
multiline_comment|/* nop1,&t;&t;phase:4 PH_BUS_FREE .. initial phase */
multiline_comment|/* nop1,&t;&t;phase:5 PH_BUS_FREE .. initial phase */
multiline_comment|/* msgout_phase1,&t;phase:6 */
multiline_comment|/* msgin_phase1,&t;phase:7 */
id|dc395x_statev
op_assign
id|dc395x_scsi_phase1
(braket
id|phase
)braket
suffix:semicolon
id|dc395x_statev
c_func
(paren
id|acb
comma
id|srb
comma
op_amp
id|scsi_status
)paren
suffix:semicolon
)brace
id|out_unlock
suffix:colon
id|DC395x_UNLOCK_IO
c_func
(paren
id|acb-&gt;scsi_host
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|dc395x_interrupt
r_static
id|irqreturn_t
id|dc395x_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|dev_id
suffix:semicolon
id|u16
id|scsi_status
suffix:semicolon
id|u8
id|dma_status
suffix:semicolon
id|irqreturn_t
id|handled
op_assign
id|IRQ_NONE
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;dc395x_interrupt...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check for pending interupt&n;&t; */
id|scsi_status
op_assign
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_STATUS
)paren
suffix:semicolon
id|dma_status
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_status
op_amp
id|SCSIINTERRUPT
)paren
(brace
multiline_comment|/* interupt pending - let&squot;s process it! */
id|dc395x_handle_interrupt
c_func
(paren
id|acb
comma
id|scsi_status
)paren
suffix:semicolon
id|handled
op_assign
id|IRQ_HANDLED
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dma_status
op_amp
l_int|0x20
)paren
(brace
multiline_comment|/* Error from the DMA engine */
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Interrupt from DMA engine: %02x!&bslash;n&quot;
comma
id|dma_status
)paren
suffix:semicolon
macro_line|#if 0
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;This means DMA error! Try to handle ...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;active_dcb
)paren
(brace
id|acb-&gt;active_dcb
op_member_access_from_pointer
id|flag
op_or_assign
id|ABORT_DEV_
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;active_dcb-&gt;active_srb
)paren
id|enable_msgout_abort
c_func
(paren
id|acb
comma
id|acb-&gt;active_dcb-&gt;active_srb
)paren
suffix:semicolon
)brace
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONTROL
comma
id|ABORTXFER
op_or
id|CLRXFIFO
)paren
suffix:semicolon
macro_line|#else
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Ignoring DMA error (probably a bad thing) ...&bslash;n&quot;
)paren
suffix:semicolon
id|acb
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|handled
op_assign
id|IRQ_HANDLED
suffix:semicolon
)brace
r_return
id|handled
suffix:semicolon
)brace
DECL|function|msgout_phase0
r_static
r_void
id|msgout_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;msgout_phase0 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;state
op_amp
(paren
id|SRB_UNEXPECT_RESEL
op_plus
id|SRB_ABORT_SENT
)paren
)paren
op_star
id|pscsi_status
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/*.. initial phase */
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
id|srb-&gt;state
op_and_assign
op_complement
id|SRB_MSGOUT
suffix:semicolon
)brace
DECL|function|msgout_phase1
r_static
r_void
id|msgout_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|u16
id|i
suffix:semicolon
id|u8
op_star
id|ptr
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;msgout_phase1 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;MOP1&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|srb-&gt;state
op_amp
id|SRB_MSGOUT
)paren
)paren
(brace
id|srb-&gt;state
op_or_assign
id|SRB_MSGOUT
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Debug: pid %li: MsgOut Phase unexpected.&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
multiline_comment|/* So what ? */
)brace
r_if
c_cond
(paren
op_logical_neg
id|srb-&gt;msg_count
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;Debug: pid %li: NOP Msg (no output message there).&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
id|MSG_NOP
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_OUT
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|srb-&gt;msgout_buf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|srb-&gt;msg_count
suffix:semicolon
id|i
op_increment
)paren
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
op_star
id|ptr
op_increment
)paren
suffix:semicolon
id|srb-&gt;msg_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
multiline_comment|/*(dcb-&gt;flag &amp; ABORT_DEV_) &amp;&amp; */
(paren
id|srb-&gt;msgout_buf
(braket
l_int|0
)braket
op_eq
id|MSG_ABORT
)paren
)paren
id|srb-&gt;state
op_assign
id|SRB_ABORT_SENT
suffix:semicolon
multiline_comment|/*1.25 */
multiline_comment|/*DC395x_write16 (TRM_S1040_SCSI_CONTROL, DO_DATALATCH); */
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/* SCSI command */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_OUT
)paren
suffix:semicolon
)brace
DECL|function|command_phase0
r_static
r_void
id|command_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;command_phase0 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
multiline_comment|/*1.25 */
multiline_comment|/*clear_fifo(acb, COP0); */
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
)brace
DECL|function|command_phase1
r_static
r_void
id|command_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
id|u8
op_star
id|ptr
suffix:semicolon
id|u16
id|i
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;command_phase1 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;COP1&quot;
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_CLRATN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|srb-&gt;flag
op_amp
id|AUTO_REQSENSE
)paren
)paren
(brace
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|srb-&gt;cmd-&gt;cmnd
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|srb-&gt;cmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
op_star
id|ptr
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
id|REQUEST_SENSE
)paren
suffix:semicolon
id|dcb
op_assign
id|acb-&gt;active_dcb
suffix:semicolon
multiline_comment|/* target id */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
(paren
id|dcb-&gt;target_lun
op_lshift
l_int|5
)paren
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
r_sizeof
(paren
id|srb-&gt;cmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
)brace
id|srb-&gt;state
op_or_assign
id|SRB_COMMAND
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* SCSI command */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_OUT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Verify that the remaining space in the hw sg lists is the same as&n; * the count of remaining bytes in srb-&gt;total_xfer_length&n; */
DECL|function|sg_verify_length
r_static
r_void
id|sg_verify_length
c_func
(paren
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_SGPARANOIA
)paren
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|idx
op_assign
id|srb-&gt;sg_index
suffix:semicolon
r_struct
id|SGentry
op_star
id|psge
op_assign
id|srb-&gt;segment_x
op_plus
id|idx
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|idx
OL
id|srb-&gt;sg_count
suffix:semicolon
id|psge
op_increment
comma
id|idx
op_increment
)paren
id|len
op_add_assign
id|psge-&gt;length
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
id|srb-&gt;total_xfer_length
)paren
id|dprintkdbg
c_func
(paren
id|DBG_SGPARANOIA
comma
l_string|&quot;Inconsistent SRB S/G lengths (Tot=%i, Count=%i) !!&bslash;n&quot;
comma
id|srb-&gt;total_xfer_length
comma
id|len
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Compute the next Scatter Gather list index and adjust its length&n; * and address if necessary; also compute virt_addr&n; */
DECL|function|sg_update_list
r_static
r_void
id|sg_update_list
c_func
(paren
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u32
id|left
)paren
(brace
id|u8
id|idx
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|srb-&gt;cmd
suffix:semicolon
r_int
id|segment
op_assign
id|cmd-&gt;use_sg
suffix:semicolon
id|u32
id|xferred
op_assign
id|srb-&gt;total_xfer_length
op_minus
id|left
suffix:semicolon
multiline_comment|/* bytes transfered */
r_struct
id|SGentry
op_star
id|psge
op_assign
id|srb-&gt;segment_x
op_plus
id|srb-&gt;sg_index
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;sg_update_list: Transfered %i of %i bytes, &quot;
l_string|&quot;%i remain&bslash;n&quot;
comma
id|xferred
comma
id|srb-&gt;total_xfer_length
comma
id|left
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xferred
op_eq
l_int|0
)paren
(brace
multiline_comment|/* nothing to update since we did not transfer any data */
r_return
suffix:semicolon
)brace
id|sg_verify_length
c_func
(paren
id|srb
)paren
suffix:semicolon
id|srb-&gt;total_xfer_length
op_assign
id|left
suffix:semicolon
multiline_comment|/* update remaining count */
r_for
c_loop
(paren
id|idx
op_assign
id|srb-&gt;sg_index
suffix:semicolon
id|idx
OL
id|srb-&gt;sg_count
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|xferred
op_ge
id|psge-&gt;length
)paren
(brace
multiline_comment|/* Complete SG entries done */
id|xferred
op_sub_assign
id|psge-&gt;length
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Partial SG entry done */
id|psge-&gt;length
op_sub_assign
id|xferred
suffix:semicolon
id|psge-&gt;address
op_add_assign
id|xferred
suffix:semicolon
id|srb-&gt;sg_index
op_assign
id|idx
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|srb-&gt;dcb
op_member_access_from_pointer
id|acb-&gt;dev
comma
id|srb-&gt;sg_bus_addr
comma
id|SEGMENTX_LEN
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|psge
op_increment
suffix:semicolon
)brace
id|sg_verify_length
c_func
(paren
id|srb
)paren
suffix:semicolon
multiline_comment|/* we need the corresponding virtual address */
r_if
c_cond
(paren
op_logical_neg
id|segment
)paren
(brace
id|srb-&gt;virt_addr
op_add_assign
id|xferred
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* We have to walk the scatterlist to find it */
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
r_while
c_loop
(paren
id|segment
op_decrement
)paren
(brace
r_int
r_int
id|mask
op_assign
op_complement
(paren
(paren
r_int
r_int
)paren
id|sg-&gt;length
op_minus
l_int|1
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
op_amp
id|mask
)paren
op_eq
(paren
id|psge-&gt;address
op_amp
id|mask
)paren
)paren
(brace
id|srb-&gt;virt_addr
op_assign
(paren
id|page_address
c_func
(paren
id|sg-&gt;page
)paren
op_plus
id|psge-&gt;address
op_minus
(paren
id|psge-&gt;address
op_amp
id|PAGE_MASK
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
op_increment
id|sg
suffix:semicolon
)brace
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;sg_to_virt failed!&bslash;n&quot;
)paren
suffix:semicolon
id|srb-&gt;virt_addr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * We have transfered a single byte (PIO mode?) and need to update&n; * the count of bytes remaining (total_xfer_length) and update the sg&n; * entry to either point to next byte in the current sg entry, or of&n; * already at the end to point to the start of the next sg entry&n; */
DECL|function|sg_subtract_one
r_static
r_void
id|sg_subtract_one
c_func
(paren
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|srb-&gt;total_xfer_length
op_decrement
suffix:semicolon
id|srb-&gt;segment_x
(braket
id|srb-&gt;sg_index
)braket
dot
id|length
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;total_xfer_length
op_logical_and
op_logical_neg
id|srb-&gt;segment_x
(braket
id|srb-&gt;sg_index
)braket
dot
id|length
)paren
(brace
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_PIO
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; (next segment)&quot;
)paren
suffix:semicolon
id|srb-&gt;sg_index
op_increment
suffix:semicolon
id|sg_update_list
c_func
(paren
id|srb
comma
id|srb-&gt;total_xfer_length
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; * cleanup_after_transfer&n; * &n; * Makes sure, DMA and SCSI engine are empty, after the transfer has finished&n; * KG: Currently called from  StatusPhase1 ()&n; * Should probably also be called from other places&n; * Best might be to call it in DataXXPhase0, if new phase will differ &n; */
DECL|function|cleanup_after_transfer
r_static
r_void
id|cleanup_after_transfer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
multiline_comment|/*DC395x_write8 (TRM_S1040_DMA_STATUS, FORCEDMACOMP); */
r_if
c_cond
(paren
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_COMMAND
)paren
op_amp
l_int|0x0001
)paren
(brace
multiline_comment|/* read */
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x40
)paren
)paren
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;ClnIn&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOSTAT
)paren
op_amp
l_int|0x80
)paren
)paren
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONTROL
comma
id|CLRXFIFO
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* write */
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOSTAT
)paren
op_amp
l_int|0x80
)paren
)paren
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONTROL
comma
id|CLRXFIFO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x40
)paren
)paren
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;ClnOut&quot;
)paren
suffix:semicolon
)brace
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Those no of bytes will be transfered w/ PIO through the SCSI FIFO&n; * Seems to be needed for unknown reasons; could be a hardware bug :-(&n; */
DECL|macro|DC395x_LASTPIO
mdefine_line|#define DC395x_LASTPIO 4
DECL|function|data_out_phase0
r_static
r_void
id|data_out_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
op_assign
id|srb-&gt;dcb
suffix:semicolon
id|u16
id|scsi_status
op_assign
op_star
id|pscsi_status
suffix:semicolon
id|u32
id|d_left_counter
op_assign
l_int|0
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;data_out_phase0 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * KG: We need to drain the buffers before we draw any conclusions!&n;&t; * This means telling the DMA to push the rest into SCSI, telling&n;&t; * SCSI to push the rest to the bus.&n;&t; * However, the device might have been the one to stop us (phase&n;&t; * change), and the data in transit just needs to be accounted so&n;&t; * it can be retransmitted.)&n;&t; */
multiline_comment|/* &n;&t; * KG: Stop DMA engine pushing more data into the SCSI FIFO&n;&t; * If we need more data, the DMA SG list will be freshly set up, anyway&n;&t; */
id|dprintkdbg
c_func
(paren
id|DBG_PIO
comma
l_string|&quot;DOP0: DMA_FCNT: %02x, DMA_FSTAT: %02x, SCSI_FCNT: %02x, CTR %06x, stat %04x, Tot: %06x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOSTAT
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
comma
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COUNTER
)paren
comma
id|scsi_status
comma
id|srb-&gt;total_xfer_length
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONTROL
comma
id|STOPDMAXFER
op_or
id|CLRXFIFO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|srb-&gt;state
op_amp
id|SRB_XFERPAD
)paren
)paren
(brace
r_if
c_cond
(paren
id|scsi_status
op_amp
id|PARITYERROR
)paren
id|srb-&gt;status
op_or_assign
id|PARITY_ERROR
suffix:semicolon
multiline_comment|/*&n;&t;&t; * KG: Right, we can&squot;t just rely on the SCSI_COUNTER, because this&n;&t;&t; * is the no of bytes it got from the DMA engine not the no it &n;&t;&t; * transferred successfully to the device. (And the difference could&n;&t;&t; * be as much as the FIFO size, I guess ...)&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|scsi_status
op_amp
id|SCSIXFERDONE
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * when data transfer from DMA FIFO to SCSI FIFO&n;&t;&t;&t; * if there was some data left in SCSI FIFO&n;&t;&t;&t; */
id|d_left_counter
op_assign
(paren
id|u32
)paren
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
)paren
id|d_left_counter
op_lshift_assign
l_int|1
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;Debug: SCSI FIFO contains %i %s in DOP0&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
comma
(paren
id|dcb
op_member_access_from_pointer
id|sync_period
op_amp
id|WIDE_SYNC
)paren
ques
c_cond
l_string|&quot;words&quot;
suffix:colon
l_string|&quot;bytes&quot;
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;SCSI FIFOCNT %02x, SCSI CTR %08x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
comma
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COUNTER
)paren
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;DMA FIFOCNT %04x, FIFOSTAT %02x, DMA CTR %08x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOSTAT
)paren
comma
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CXCNT
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * if WIDE scsi SCSI FIFOCNT unit is word !!!&n;&t;&t;&t; * so need to *= 2&n;&t;&t;&t; */
)brace
multiline_comment|/*&n;&t;&t; * calculate all the residue data that not yet tranfered&n;&t;&t; * SCSI transfer counter + left in SCSI FIFO data&n;&t;&t; *&n;&t;&t; * .....TRM_S1040_SCSI_COUNTER (24bits)&n;&t;&t; * The counter always decrement by one for every SCSI byte transfer.&n;&t;&t; * .....TRM_S1040_SCSI_FIFOCNT ( 5bits)&n;&t;&t; * The counter is SCSI FIFO offset counter (in units of bytes or! words)&n;&t;&t; */
r_if
c_cond
(paren
id|srb-&gt;total_xfer_length
OG
id|DC395x_LASTPIO
)paren
id|d_left_counter
op_add_assign
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COUNTER
)paren
suffix:semicolon
multiline_comment|/* Is this a good idea? */
multiline_comment|/*clear_fifo(acb, &quot;DOP1&quot;); */
multiline_comment|/* KG: What is this supposed to be useful for? WIDE padding stuff? */
r_if
c_cond
(paren
id|d_left_counter
op_eq
l_int|1
op_logical_and
id|dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
op_logical_and
id|srb-&gt;cmd-&gt;request_bufflen
op_mod
l_int|2
)paren
(brace
id|d_left_counter
op_assign
l_int|0
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;DOP0: Discard 1 byte. (%02x)&bslash;n&quot;
comma
id|scsi_status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * KG: Oops again. Same thinko as above: The SCSI might have been&n;&t;&t; * faster than the DMA engine, so that it ran out of data.&n;&t;&t; * In that case, we have to do just nothing! &n;&t;&t; * But: Why the interrupt: No phase change. No XFERCNT_2_ZERO. Or?&n;&t;&t; */
multiline_comment|/*&n;&t;&t; * KG: This is nonsense: We have been WRITING data to the bus&n;&t;&t; * If the SCSI engine has no bytes left, how should the DMA engine?&n;&t;&t; */
r_if
c_cond
(paren
id|d_left_counter
op_eq
l_int|0
multiline_comment|/*|| (scsi_status &amp; SCSIXFERCNT_2_ZERO)*/
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * int ctr = 6000000; u8 TempDMAstatus;&n;&t;&t;&t; * do&n;&t;&t;&t; * {&n;&t;&t;&t; *  TempDMAstatus = DC395x_read8(acb, TRM_S1040_DMA_STATUS);&n;&t;&t;&t; * } while( !(TempDMAstatus &amp; DMAXFERCOMP) &amp;&amp; --ctr);&n;&t;&t;&t; * if (ctr &lt; 6000000-1) dprintkl(KERN_DEBUG, &quot;DMA should be complete ... in DOP1&bslash;n&quot;);&n;&t;&t;&t; * if (!ctr) dprintkl(KERN_ERR, &quot;Deadlock in DataOutPhase0 !!&bslash;n&quot;);&n;&t;&t;&t; */
id|srb-&gt;total_xfer_length
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Update SG list         */
multiline_comment|/*&n;&t;&t;&t; * if transfer not yet complete&n;&t;&t;&t; * there were some data residue in SCSI FIFO or&n;&t;&t;&t; * SCSI transfer counter not empty&n;&t;&t;&t; */
r_int
id|oldxferred
op_assign
id|srb-&gt;total_xfer_length
op_minus
id|d_left_counter
suffix:semicolon
r_const
r_int
id|diff
op_assign
(paren
id|dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
id|sg_update_list
c_func
(paren
id|srb
comma
id|d_left_counter
)paren
suffix:semicolon
multiline_comment|/* KG: Most ugly hack! Apparently, this works around a chip bug */
r_if
c_cond
(paren
(paren
id|srb-&gt;segment_x
(braket
id|srb-&gt;sg_index
)braket
dot
id|length
op_eq
id|diff
op_logical_and
id|srb-&gt;cmd-&gt;use_sg
)paren
op_logical_or
(paren
(paren
id|oldxferred
op_amp
op_complement
id|PAGE_MASK
)paren
op_eq
(paren
id|PAGE_SIZE
op_minus
id|diff
)paren
)paren
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Work around chip bug (%i)?&bslash;n&quot;
comma
id|diff
)paren
suffix:semicolon
id|d_left_counter
op_assign
id|srb-&gt;total_xfer_length
op_minus
id|diff
suffix:semicolon
id|sg_update_list
c_func
(paren
id|srb
comma
id|d_left_counter
)paren
suffix:semicolon
multiline_comment|/*srb-&gt;total_xfer_length -= diff; */
multiline_comment|/*srb-&gt;virt_addr += diff; */
multiline_comment|/*if (srb-&gt;cmd-&gt;use_sg) */
multiline_comment|/*      srb-&gt;sg_index++; */
)brace
)brace
)brace
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x40
)paren
)paren
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;DOP0(%li): %i bytes in SCSI FIFO! (Clear!)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1f
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*clear_fifo(acb, &quot;DOP0&quot;); */
multiline_comment|/*DC395x_write8(TRM_S1040_DMA_CONTROL, CLRXFIFO | ABORTXFER); */
macro_line|#if 1
r_if
c_cond
(paren
(paren
op_star
id|pscsi_status
op_amp
id|PHASEMASK
)paren
op_ne
id|PH_DATA_OUT
)paren
(brace
multiline_comment|/*dprintkl(KERN_DEBUG, &quot;Debug: Clean up after Data Out ...&bslash;n&quot;); */
id|cleanup_after_transfer
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|data_out_phase1
r_static
r_void
id|data_out_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;data_out_phase1 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
multiline_comment|/*1.25 */
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;DOP1&quot;
)paren
suffix:semicolon
multiline_comment|/* do prepare befor transfer when data out phase */
id|data_io_transfer
c_func
(paren
id|acb
comma
id|srb
comma
id|XFERDATAOUT
)paren
suffix:semicolon
)brace
DECL|function|data_in_phase0
r_static
r_void
id|data_in_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|u16
id|scsi_status
op_assign
op_star
id|pscsi_status
suffix:semicolon
id|u32
id|d_left_counter
op_assign
l_int|0
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;data_in_phase0 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * KG: DataIn is much more tricky than DataOut. When the device is finished&n;&t; * and switches to another phase, the SCSI engine should be finished too.&n;&t; * But: There might still be bytes left in its FIFO to be fetched by the DMA&n;&t; * engine and transferred to memory.&n;&t; * We should wait for the FIFOs to be emptied by that (is there any way to &n;&t; * enforce this?) and then stop the DMA engine, because it might think, that&n;&t; * there are more bytes to follow. Yes, the device might disconnect prior to&n;&t; * having all bytes transferred! &n;&t; * Also we should make sure that all data from the DMA engine buffer&squot;s really&n;&t; * made its way to the system memory! Some documentation on this would not&n;&t; * seem to be a bad idea, actually.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|srb-&gt;state
op_amp
id|SRB_XFERPAD
)paren
)paren
(brace
r_if
c_cond
(paren
id|scsi_status
op_amp
id|PARITYERROR
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Parity Error (pid %li, target %02i-%i)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|srb-&gt;cmd-&gt;device-&gt;id
comma
id|srb-&gt;cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|srb-&gt;status
op_or_assign
id|PARITY_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * KG: We should wait for the DMA FIFO to be empty ...&n;&t;&t; * but: it would be better to wait first for the SCSI FIFO and then the&n;&t;&t; * the DMA FIFO to become empty? How do we know, that the device not already&n;&t;&t; * sent data to the FIFO in a MsgIn phase, eg.?&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOSTAT
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
macro_line|#if 0
r_int
id|ctr
op_assign
l_int|6000000
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;DIP0: Wait for DMA FIFO to flush ...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*DC395x_write8  (TRM_S1040_DMA_CONTROL, STOPDMAXFER); */
multiline_comment|/*DC395x_write32 (TRM_S1040_SCSI_COUNTER, 7); */
multiline_comment|/*DC395x_write8  (TRM_S1040_SCSI_COMMAND, SCMD_DMA_IN); */
r_while
c_loop
(paren
op_logical_neg
(paren
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOSTAT
)paren
op_amp
l_int|0x80
)paren
op_logical_and
op_decrement
id|ctr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctr
OL
l_int|6000000
op_minus
l_int|1
)paren
id|dprintkl
c_func
(paren
id|KERN_DEBUG
l_string|&quot;DIP0: Had to wait for DMA ...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctr
)paren
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Deadlock in DIP0 waiting for DMA FIFO empty!!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*DC395x_write32 (TRM_S1040_SCSI_COUNTER, 0); */
macro_line|#endif
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;DIP0: DMA_FIFO: %02x %02x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOSTAT
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Now: Check remainig data: The SCSI counters should tell us ... */
id|d_left_counter
op_assign
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COUNTER
)paren
op_plus
(paren
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1f
)paren
op_lshift
(paren
(paren
id|srb-&gt;dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;SCSI FIFO contains %i %s in DIP0&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1f
comma
(paren
id|srb-&gt;dcb
op_member_access_from_pointer
id|sync_period
op_amp
id|WIDE_SYNC
)paren
ques
c_cond
l_string|&quot;words&quot;
suffix:colon
l_string|&quot;bytes&quot;
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;SCSI FIFOCNT %02x, SCSI CTR %08x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
comma
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COUNTER
)paren
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;DMA FIFOCNT %02x,%02x DMA CTR %08x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOSTAT
)paren
comma
id|DC395x_read32
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CXCNT
)paren
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;Remaining: TotXfer: %i, SCSI FIFO+Ctr: %i&bslash;n&quot;
comma
id|srb-&gt;total_xfer_length
comma
id|d_left_counter
)paren
suffix:semicolon
macro_line|#if DC395x_LASTPIO
multiline_comment|/* KG: Less than or equal to 4 bytes can not be transfered via DMA, it seems. */
r_if
c_cond
(paren
id|d_left_counter
op_logical_and
id|srb-&gt;total_xfer_length
op_le
id|DC395x_LASTPIO
)paren
(brace
multiline_comment|/*u32 addr = (srb-&gt;segment_x[srb-&gt;sg_index].address); */
multiline_comment|/*sg_update_list (srb, d_left_counter); */
id|dprintkdbg
c_func
(paren
id|DBG_PIO
comma
l_string|&quot;DIP0: PIO (%i %s) to %p for remaining %i bytes:&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1f
comma
(paren
id|srb-&gt;dcb
op_member_access_from_pointer
id|sync_period
op_amp
id|WIDE_SYNC
)paren
ques
c_cond
l_string|&quot;words&quot;
suffix:colon
l_string|&quot;bytes&quot;
comma
id|srb-&gt;virt_addr
comma
id|srb-&gt;total_xfer_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
)paren
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONFIG2
comma
id|CFG2_WIDEFIFO
)paren
suffix:semicolon
r_while
c_loop
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_ne
l_int|0x40
)paren
(brace
id|u8
id|byte
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
op_star
(paren
id|srb-&gt;virt_addr
)paren
op_increment
op_assign
id|byte
suffix:semicolon
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_PIO
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|byte
)paren
suffix:semicolon
id|d_left_counter
op_decrement
suffix:semicolon
id|sg_subtract_one
c_func
(paren
id|srb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srb-&gt;dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
)paren
(brace
macro_line|#if 1
multiline_comment|/* Read the last byte ... */
r_if
c_cond
(paren
id|srb-&gt;total_xfer_length
OG
l_int|0
)paren
(brace
id|u8
id|byte
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
op_star
(paren
id|srb-&gt;virt_addr
)paren
op_increment
op_assign
id|byte
suffix:semicolon
id|srb-&gt;total_xfer_length
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_PIO
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|byte
)paren
suffix:semicolon
)brace
macro_line|#endif
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONFIG2
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*printk(&quot; %08x&quot;, *(u32*)(bus_to_virt (addr))); */
multiline_comment|/*srb-&gt;total_xfer_length = 0; */
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_PIO
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* DC395x_LASTPIO */
macro_line|#if 0
multiline_comment|/*&n;&t;&t; * KG: This was in DATAOUT. Does it also belong here?&n;&t;&t; * Nobody seems to know what counter and fifo_cnt count exactly ...&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|scsi_status
op_amp
id|SCSIXFERDONE
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * when data transfer from DMA FIFO to SCSI FIFO&n;&t;&t;&t; * if there was some data left in SCSI FIFO&n;&t;&t;&t; */
id|d_left_counter
op_assign
(paren
id|u32
)paren
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
)paren
id|d_left_counter
op_lshift_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * if WIDE scsi SCSI FIFOCNT unit is word !!!&n;&t;&t;&t; * so need to *= 2&n;&t;&t;&t; * KG: Seems to be correct ...&n;&t;&t;&t; */
)brace
macro_line|#endif
multiline_comment|/*d_left_counter += DC395x_read32(acb, TRM_S1040_SCSI_COUNTER); */
macro_line|#if 0
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;DIP0: ctr=%08x, DMA_FIFO=%02x,%02x SCSI_FIFO=%02x&bslash;n&quot;
comma
id|d_left_counter
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_FIFOSTAT
)paren
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
)paren
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;DIP0: DMAStat %02x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_STATUS
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* KG: This should not be needed any more! */
r_if
c_cond
(paren
id|d_left_counter
op_eq
l_int|0
op_logical_or
(paren
id|scsi_status
op_amp
id|SCSIXFERCNT_2_ZERO
)paren
)paren
(brace
macro_line|#if 0
r_int
id|ctr
op_assign
l_int|6000000
suffix:semicolon
id|u8
id|TempDMAstatus
suffix:semicolon
r_do
(brace
id|TempDMAstatus
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_STATUS
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|TempDMAstatus
op_amp
id|DMAXFERCOMP
)paren
op_logical_and
op_decrement
id|ctr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctr
)paren
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Deadlock in DataInPhase0 waiting for DMA!!&bslash;n&quot;
)paren
suffix:semicolon
id|srb-&gt;total_xfer_length
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if 0&t;&t;&t;&t;/*def DBG_KG             */
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;DIP0: DMA not yet ready: %02x: %i -&gt; %i bytes&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_STATUS
)paren
comma
id|srb-&gt;total_xfer_length
comma
id|d_left_counter
)paren
suffix:semicolon
macro_line|#endif
id|srb-&gt;total_xfer_length
op_assign
id|d_left_counter
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* phase changed */
multiline_comment|/*&n;&t;&t;&t; * parsing the case:&n;&t;&t;&t; * when a transfer not yet complete &n;&t;&t;&t; * but be disconnected by target&n;&t;&t;&t; * if transfer not yet complete&n;&t;&t;&t; * there were some data residue in SCSI FIFO or&n;&t;&t;&t; * SCSI transfer counter not empty&n;&t;&t;&t; */
id|sg_update_list
c_func
(paren
id|srb
comma
id|d_left_counter
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* KG: The target may decide to disconnect: Empty FIFO before! */
r_if
c_cond
(paren
(paren
op_star
id|pscsi_status
op_amp
id|PHASEMASK
)paren
op_ne
id|PH_DATA_IN
)paren
(brace
multiline_comment|/*dprintkl(KERN_DEBUG, &quot;Debug: Clean up after Data In  ...&bslash;n&quot;); */
id|cleanup_after_transfer
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* KG: Make sure, no previous transfers are pending! */
id|bval
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFOCNT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
l_int|0x40
)paren
)paren
(brace
id|bval
op_and_assign
l_int|0x1f
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;DIP0(%li): %i bytes in SCSI FIFO (stat %04x) (left %08x)!!&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|bval
op_amp
l_int|0x1f
comma
id|scsi_status
comma
id|d_left_counter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d_left_counter
op_eq
l_int|0
op_logical_or
(paren
id|scsi_status
op_amp
id|SCSIXFERCNT_2_ZERO
)paren
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Clear FIFO!&bslash;n&quot;
)paren
suffix:semicolon
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;DIP0&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*DC395x_write8 (TRM_S1040_DMA_CONTROL, CLRXFIFO | ABORTXFER); */
multiline_comment|/*clear_fifo(acb, &quot;DIP0&quot;); */
multiline_comment|/*DC395x_write16(TRM_S1040_SCSI_CONTROL, DO_DATALATCH); */
)brace
DECL|function|data_in_phase1
r_static
r_void
id|data_in_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;data_in_phase1 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
multiline_comment|/* FIFO should be cleared, if previous phase was not DataPhase */
multiline_comment|/*clear_fifo(acb, &quot;DIP1&quot;); */
multiline_comment|/* Allow data in! */
multiline_comment|/*DC395x_write16(TRM_S1040_SCSI_CONTROL, DO_DATALATCH); */
multiline_comment|/* do prepare before transfer when data in phase */
id|data_io_transfer
c_func
(paren
id|acb
comma
id|srb
comma
id|XFERDATAIN
)paren
suffix:semicolon
)brace
DECL|function|data_io_transfer
r_static
r_void
id|data_io_transfer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
id|io_dir
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
op_assign
id|srb-&gt;dcb
suffix:semicolon
id|u8
id|bval
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;data_io_transfer %c (#%li): len=%i, sg=(%i/%i)&bslash;n&quot;
comma
(paren
(paren
id|io_dir
op_amp
id|DMACMD_DIR
)paren
ques
c_cond
l_char|&squot;r&squot;
suffix:colon
l_char|&squot;w&squot;
)paren
comma
id|srb-&gt;cmd-&gt;pid
comma
id|srb-&gt;total_xfer_length
comma
id|srb-&gt;sg_index
comma
id|srb-&gt;sg_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb
op_eq
id|acb-&gt;tmp_srb
)paren
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Using tmp_srb in DataPhase!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;sg_index
op_ge
id|srb-&gt;sg_count
)paren
(brace
multiline_comment|/* can&squot;t happen? out of bounds error */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srb-&gt;total_xfer_length
OG
id|DC395x_LASTPIO
)paren
(brace
id|u8
id|dma_status
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_STATUS
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * KG: What should we do: Use SCSI Cmd 0x90/0x92?&n;&t;&t; * Maybe, even ABORTXFER would be appropriate&n;&t;&t; */
r_if
c_cond
(paren
id|dma_status
op_amp
id|XFERPENDING
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Xfer pending! Expect trouble!!&bslash;n&quot;
)paren
suffix:semicolon
id|dump_register_info
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONTROL
comma
id|CLRXFIFO
)paren
suffix:semicolon
)brace
multiline_comment|/* clear_fifo(acb, &quot;IO&quot;); */
multiline_comment|/* &n;&t;&t; * load what physical address of Scatter/Gather list table&n;&t;&t; * want to be transfer&n;&t;&t; */
id|srb-&gt;state
op_or_assign
id|SRB_DATA_XFER
suffix:semicolon
id|DC395x_write32
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_XHIGHADDR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;cmd-&gt;use_sg
)paren
(brace
multiline_comment|/* with S/G */
id|io_dir
op_or_assign
id|DMACMD_SG
suffix:semicolon
id|DC395x_write32
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_XLOWADDR
comma
id|srb-&gt;sg_bus_addr
op_plus
r_sizeof
(paren
r_struct
id|SGentry
)paren
op_star
id|srb-&gt;sg_index
)paren
suffix:semicolon
multiline_comment|/* load how many bytes in the sg list table */
id|DC395x_write32
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_XCNT
comma
(paren
(paren
id|u32
)paren
(paren
id|srb-&gt;sg_count
op_minus
id|srb-&gt;sg_index
)paren
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* without S/G */
id|io_dir
op_and_assign
op_complement
id|DMACMD_SG
suffix:semicolon
id|DC395x_write32
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_XLOWADDR
comma
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
id|DC395x_write32
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_XCNT
comma
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/* load total transfer length (24bits) max value 16Mbyte */
id|DC395x_write32
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COUNTER
comma
id|srb-&gt;total_xfer_length
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
r_if
c_cond
(paren
id|io_dir
op_amp
id|DMACMD_DIR
)paren
(brace
multiline_comment|/* read */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_DMA_IN
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_COMMAND
comma
id|io_dir
)paren
suffix:semicolon
)brace
r_else
(brace
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_COMMAND
comma
id|io_dir
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_DMA_OUT
)paren
suffix:semicolon
)brace
)brace
macro_line|#if DC395x_LASTPIO
r_else
r_if
c_cond
(paren
id|srb-&gt;total_xfer_length
OG
l_int|0
)paren
(brace
multiline_comment|/* The last four bytes: Do PIO */
multiline_comment|/* &n;&t;&t; * load what physical address of Scatter/Gather list table&n;&t;&t; * want to be transfer&n;&t;&t; */
id|srb-&gt;state
op_or_assign
id|SRB_DATA_XFER
suffix:semicolon
multiline_comment|/* load total transfer length (24bits) max value 16Mbyte */
id|DC395x_write32
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COUNTER
comma
id|srb-&gt;total_xfer_length
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
r_if
c_cond
(paren
id|io_dir
op_amp
id|DMACMD_DIR
)paren
(brace
multiline_comment|/* read */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_IN
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* write */
r_int
id|ln
op_assign
id|srb-&gt;total_xfer_length
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
)paren
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONFIG2
comma
id|CFG2_WIDEFIFO
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_PIO
comma
l_string|&quot;DOP1: PIO %i bytes from %p:&quot;
comma
id|srb-&gt;total_xfer_length
comma
id|srb-&gt;virt_addr
)paren
suffix:semicolon
r_while
c_loop
(paren
id|srb-&gt;total_xfer_length
)paren
(brace
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_PIO
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
r_int
r_char
)paren
op_star
(paren
id|srb-&gt;virt_addr
)paren
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
op_star
(paren
id|srb-&gt;virt_addr
)paren
op_increment
)paren
suffix:semicolon
id|sg_subtract_one
c_func
(paren
id|srb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srb-&gt;dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
)paren
(brace
r_if
c_cond
(paren
id|ln
op_mod
l_int|2
)paren
(brace
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_PIO
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; |00&quot;
)paren
suffix:semicolon
)brace
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONFIG2
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*DC395x_write32(acb, TRM_S1040_SCSI_COUNTER, ln); */
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_PIO
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_OUT
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* DC395x_LASTPIO */
r_else
(brace
multiline_comment|/* xfer pad */
id|u8
id|data
op_assign
l_int|0
comma
id|data2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;sg_count
)paren
(brace
id|srb-&gt;adapter_status
op_assign
id|H_OVER_UNDER_RUN
suffix:semicolon
id|srb-&gt;status
op_or_assign
id|OVER_RUN
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * KG: despite the fact that we are using 16 bits I/O ops&n;&t;&t; * the SCSI FIFO is only 8 bits according to the docs&n;&t;&t; * (we can set bit 1 in 0x8f to serialize FIFO access ...)&n;&t;&t; */
r_if
c_cond
(paren
id|dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
)paren
(brace
id|DC395x_write32
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COUNTER
comma
l_int|2
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONFIG2
comma
id|CFG2_WIDEFIFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io_dir
op_amp
id|DMACMD_DIR
)paren
(brace
id|data
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
id|data2
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Danger, Robinson: If you find KGs&n;&t;&t;&t;&t; * scattered over the wide disk, the driver&n;&t;&t;&t;&t; * or chip is to blame :-( */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
l_char|&squot;K&squot;
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
l_char|&squot;G&squot;
)paren
suffix:semicolon
)brace
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONFIG2
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|DC395x_write32
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COUNTER
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Danger, Robinson: If you find a collection of Ks on your disk&n;&t;&t;&t; * something broke :-( */
r_if
c_cond
(paren
id|io_dir
op_amp
id|DMACMD_DIR
)paren
id|data
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
r_else
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
comma
l_char|&squot;K&squot;
)paren
suffix:semicolon
)brace
id|srb-&gt;state
op_or_assign
id|SRB_XFERPAD
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/* SCSI command */
id|bval
op_assign
(paren
id|io_dir
op_amp
id|DMACMD_DIR
)paren
ques
c_cond
id|SCMD_FIFO_IN
suffix:colon
id|SCMD_FIFO_OUT
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|bval
)paren
suffix:semicolon
)brace
)brace
DECL|function|status_phase0
r_static
r_void
id|status_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;status_phase0 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|srb-&gt;target_status
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
id|srb-&gt;end_message
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
multiline_comment|/* get message */
id|srb-&gt;state
op_assign
id|SRB_COMPLETED
suffix:semicolon
op_star
id|pscsi_status
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/*.. initial phase */
multiline_comment|/*1.25 */
multiline_comment|/*clear_fifo(acb, &quot;STP0&quot;); */
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/* SCSI command */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_MSGACCEPT
)paren
suffix:semicolon
)brace
DECL|function|status_phase1
r_static
r_void
id|status_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;status_phase1 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|srb-&gt;state
op_assign
id|SRB_STATUS
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/* SCSI command */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_COMP
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* Print received message */
r_static
r_void
id|print_msg
c_func
(paren
id|u8
op_star
id|msg_buf
comma
id|u32
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|msg_buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|msg_buf
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Check if the message is complete */
DECL|function|msgin_completed
r_static
r_inline
id|u8
id|msgin_completed
c_func
(paren
id|u8
op_star
id|msgbuf
comma
id|u32
id|len
)paren
(brace
r_if
c_cond
(paren
op_star
id|msgbuf
op_eq
id|EXTENDED_MESSAGE
)paren
(brace
r_if
c_cond
(paren
id|len
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|msgbuf
(braket
l_int|1
)braket
op_plus
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|msgbuf
op_ge
l_int|0x20
op_logical_and
op_star
id|msgbuf
op_le
l_int|0x2f
)paren
multiline_comment|/* two byte messages */
r_if
c_cond
(paren
id|len
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|macro|DC395x_ENABLE_MSGOUT
mdefine_line|#define DC395x_ENABLE_MSGOUT &bslash;&n; DC395x_write16 (acb, TRM_S1040_SCSI_CONTROL, DO_SETATN); &bslash;&n; srb-&gt;state |= SRB_MSGOUT
multiline_comment|/* reject_msg */
DECL|function|msgin_reject
r_static
r_inline
r_void
id|msgin_reject
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|srb-&gt;msgout_buf
(braket
l_int|0
)braket
op_assign
id|MESSAGE_REJECT
suffix:semicolon
id|srb-&gt;msg_count
op_assign
l_int|1
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|srb-&gt;state
op_and_assign
op_complement
id|SRB_MSGIN
suffix:semicolon
id|srb-&gt;state
op_or_assign
id|SRB_MSGOUT
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Reject message %02x from %02i-%i&bslash;n&quot;
comma
id|srb-&gt;msgin_buf
(braket
l_int|0
)braket
comma
id|srb-&gt;dcb-&gt;target_id
comma
id|srb-&gt;dcb-&gt;target_lun
)paren
suffix:semicolon
)brace
multiline_comment|/* abort command */
DECL|function|enable_msgout_abort
r_static
r_inline
r_void
id|enable_msgout_abort
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|srb-&gt;msgout_buf
(braket
l_int|0
)braket
op_assign
id|ABORT
suffix:semicolon
id|srb-&gt;msg_count
op_assign
l_int|1
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|srb-&gt;state
op_and_assign
op_complement
id|SRB_MSGIN
suffix:semicolon
id|srb-&gt;state
op_or_assign
id|SRB_MSGOUT
suffix:semicolon
multiline_comment|/*&n;&t;   if (srb-&gt;dcb)&n;&t;   srb-&gt;dcb-&gt;flag &amp;= ~ABORT_DEV_;&n;&t; */
)brace
DECL|function|msgin_qtag
r_static
r_struct
id|ScsiReqBlk
op_star
id|msgin_qtag
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
id|u8
id|tag
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|srb
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|i
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;msgin_qtag (#%li) tag=%i (srb=%p)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|tag
comma
id|srb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dcb-&gt;tag_mask
op_amp
(paren
l_int|1
op_lshift
id|tag
)paren
)paren
)paren
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;MsgIn_QTag: tag_mask (%08x) does not reserve tag %i!&bslash;n&quot;
comma
id|dcb-&gt;tag_mask
comma
id|tag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|dcb-&gt;srb_going_list
)paren
)paren
r_goto
id|mingx0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|i
comma
op_amp
id|dcb-&gt;srb_going_list
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|i-&gt;tag_number
op_eq
id|tag
)paren
(brace
id|srb
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|srb
)paren
r_goto
id|mingx0
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;pid %li (%i-%i)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|srb-&gt;dcb-&gt;target_id
comma
id|srb-&gt;dcb-&gt;target_lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dcb-&gt;flag
op_amp
id|ABORT_DEV_
)paren
(brace
multiline_comment|/*srb-&gt;state = SRB_ABORT_SENT; */
id|enable_msgout_abort
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|srb-&gt;state
op_amp
id|SRB_DISCONNECT
)paren
)paren
r_goto
id|mingx0
suffix:semicolon
id|memcpy
c_func
(paren
id|srb-&gt;msgin_buf
comma
id|dcb-&gt;active_srb-&gt;msgin_buf
comma
id|acb-&gt;msg_len
)paren
suffix:semicolon
id|srb-&gt;state
op_or_assign
id|dcb-&gt;active_srb-&gt;state
suffix:semicolon
id|srb-&gt;state
op_or_assign
id|SRB_DATA_XFER
suffix:semicolon
id|dcb-&gt;active_srb
op_assign
id|srb
suffix:semicolon
multiline_comment|/* How can we make the DORS happy? */
r_return
id|srb
suffix:semicolon
id|mingx0
suffix:colon
id|srb
op_assign
id|acb-&gt;tmp_srb
suffix:semicolon
id|srb-&gt;state
op_assign
id|SRB_UNEXPECT_RESEL
suffix:semicolon
id|dcb-&gt;active_srb
op_assign
id|srb
suffix:semicolon
id|srb-&gt;msgout_buf
(braket
l_int|0
)braket
op_assign
id|MSG_ABORT_TAG
suffix:semicolon
id|srb-&gt;msg_count
op_assign
l_int|1
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Unknown tag received: %i: abort !!&bslash;n&quot;
comma
id|tag
)paren
suffix:semicolon
r_return
id|srb
suffix:semicolon
)brace
DECL|function|reprogram_regs
r_static
r_inline
r_void
id|reprogram_regs
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
)paren
(brace
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_TARGETID
comma
id|dcb-&gt;target_id
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_SYNC
comma
id|dcb-&gt;sync_period
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_OFFSET
comma
id|dcb-&gt;sync_offset
)paren
suffix:semicolon
id|set_xfer_rate
c_func
(paren
id|acb
comma
id|dcb
)paren
suffix:semicolon
)brace
multiline_comment|/* set async transfer mode */
DECL|function|msgin_set_async
r_static
r_void
id|msgin_set_async
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
op_assign
id|srb-&gt;dcb
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Target %02i: No sync transfers&bslash;n&quot;
comma
id|dcb-&gt;target_id
)paren
suffix:semicolon
id|dcb-&gt;sync_mode
op_and_assign
op_complement
(paren
id|SYNC_NEGO_ENABLE
)paren
suffix:semicolon
id|dcb-&gt;sync_mode
op_or_assign
id|SYNC_NEGO_DONE
suffix:semicolon
multiline_comment|/*dcb-&gt;sync_period &amp;= 0; */
id|dcb-&gt;sync_offset
op_assign
l_int|0
suffix:semicolon
id|dcb-&gt;min_nego_period
op_assign
l_int|200
op_rshift
l_int|2
suffix:semicolon
multiline_comment|/* 200ns &lt;=&gt; 5 MHz */
id|srb-&gt;state
op_and_assign
op_complement
id|SRB_DO_SYNC_NEGO
suffix:semicolon
id|reprogram_regs
c_func
(paren
id|acb
comma
id|dcb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dcb-&gt;sync_mode
op_amp
id|WIDE_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|dcb-&gt;sync_mode
op_amp
id|WIDE_NEGO_DONE
)paren
)paren
(brace
id|build_wdtr
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;SDTR(rej): Try WDTR anyway ...&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* set sync transfer mode */
DECL|function|msgin_set_sync
r_static
r_void
id|msgin_set_sync
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
op_assign
id|srb-&gt;dcb
suffix:semicolon
id|u8
id|bval
suffix:semicolon
r_int
id|fact
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_1
comma
l_string|&quot;Target %02i: Sync: %ins (%02i.%01i MHz) Offset %i&bslash;n&quot;
comma
id|dcb-&gt;target_id
comma
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
op_lshift
l_int|2
comma
(paren
l_int|250
op_div
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
)paren
comma
(paren
(paren
l_int|250
op_mod
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
)paren
op_star
l_int|10
)paren
op_div
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
comma
id|srb-&gt;msgin_buf
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;msgin_buf
(braket
l_int|4
)braket
OG
l_int|15
)paren
id|srb-&gt;msgin_buf
(braket
l_int|4
)braket
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_SYNC_NEGO
)paren
)paren
id|dcb-&gt;sync_offset
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dcb-&gt;sync_offset
op_eq
l_int|0
)paren
id|dcb-&gt;sync_offset
op_assign
id|srb-&gt;msgin_buf
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;msgin_buf
(braket
l_int|4
)braket
OG
id|dcb-&gt;sync_offset
)paren
id|srb-&gt;msgin_buf
(braket
l_int|4
)braket
op_assign
id|dcb-&gt;sync_offset
suffix:semicolon
r_else
id|dcb-&gt;sync_offset
op_assign
id|srb-&gt;msgin_buf
(braket
l_int|4
)braket
suffix:semicolon
id|bval
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|bval
OL
l_int|7
op_logical_and
(paren
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
OG
id|clock_period
(braket
id|bval
)braket
op_logical_or
id|dcb-&gt;min_nego_period
OG
id|clock_period
(braket
id|bval
)braket
)paren
)paren
id|bval
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
OL
id|clock_period
(braket
id|bval
)braket
)paren
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Increase sync nego period to %ins&bslash;n&quot;
comma
id|clock_period
(braket
id|bval
)braket
op_lshift
l_int|2
)paren
suffix:semicolon
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
op_assign
id|clock_period
(braket
id|bval
)braket
suffix:semicolon
id|dcb-&gt;sync_period
op_and_assign
l_int|0xf0
suffix:semicolon
id|dcb-&gt;sync_period
op_or_assign
id|ALT_SYNC
op_or
id|bval
suffix:semicolon
id|dcb-&gt;min_nego_period
op_assign
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
)paren
id|fact
op_assign
l_int|500
suffix:semicolon
r_else
id|fact
op_assign
l_int|250
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Target %02i: %s Sync: %ins Offset %i (%02i.%01i MB/s)&bslash;n&quot;
comma
id|dcb-&gt;target_id
comma
(paren
id|fact
op_eq
l_int|500
)paren
ques
c_cond
l_string|&quot;Wide16&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|dcb-&gt;min_nego_period
op_lshift
l_int|2
comma
id|dcb-&gt;sync_offset
comma
(paren
id|fact
op_div
id|dcb-&gt;min_nego_period
)paren
comma
(paren
(paren
id|fact
op_mod
id|dcb-&gt;min_nego_period
)paren
op_star
l_int|10
op_plus
id|dcb-&gt;min_nego_period
op_div
l_int|2
)paren
op_div
id|dcb-&gt;min_nego_period
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|srb-&gt;state
op_amp
id|SRB_DO_SYNC_NEGO
)paren
)paren
(brace
multiline_comment|/* Reply with corrected SDTR Message */
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot; .. answer w/  %ins %i&bslash;n&quot;
comma
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
op_lshift
l_int|2
comma
id|srb-&gt;msgin_buf
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|srb-&gt;msgout_buf
comma
id|srb-&gt;msgin_buf
comma
l_int|5
)paren
suffix:semicolon
id|srb-&gt;msg_count
op_assign
l_int|5
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|dcb-&gt;sync_mode
op_or_assign
id|SYNC_NEGO_DONE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|dcb-&gt;sync_mode
op_amp
id|WIDE_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|dcb-&gt;sync_mode
op_amp
id|WIDE_NEGO_DONE
)paren
)paren
(brace
id|build_wdtr
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;SDTR: Also try WDTR ...&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|srb-&gt;state
op_and_assign
op_complement
id|SRB_DO_SYNC_NEGO
suffix:semicolon
id|dcb-&gt;sync_mode
op_or_assign
id|SYNC_NEGO_DONE
op_or
id|SYNC_NEGO_ENABLE
suffix:semicolon
id|reprogram_regs
c_func
(paren
id|acb
comma
id|dcb
)paren
suffix:semicolon
)brace
DECL|function|msgin_set_nowide
r_static
r_inline
r_void
id|msgin_set_nowide
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
op_assign
id|srb-&gt;dcb
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;WDTR got rejected from target %02i&bslash;n&quot;
comma
id|dcb-&gt;target_id
)paren
suffix:semicolon
id|dcb-&gt;sync_period
op_and_assign
op_complement
id|WIDE_SYNC
suffix:semicolon
id|dcb-&gt;sync_mode
op_and_assign
op_complement
(paren
id|WIDE_NEGO_ENABLE
)paren
suffix:semicolon
id|dcb-&gt;sync_mode
op_or_assign
id|WIDE_NEGO_DONE
suffix:semicolon
id|srb-&gt;state
op_and_assign
op_complement
id|SRB_DO_WIDE_NEGO
suffix:semicolon
id|reprogram_regs
c_func
(paren
id|acb
comma
id|dcb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dcb-&gt;sync_mode
op_amp
id|SYNC_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|dcb-&gt;sync_mode
op_amp
id|SYNC_NEGO_DONE
)paren
)paren
(brace
id|build_sdtr
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;WDTR(rej): Try SDTR anyway ...&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|msgin_set_wide
r_static
r_void
id|msgin_set_wide
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
op_assign
id|srb-&gt;dcb
suffix:semicolon
id|u8
id|wide
op_assign
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_WIDE_NEGO
op_logical_and
id|acb-&gt;config
op_amp
id|HCC_WIDE_CARD
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
OG
id|wide
)paren
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
op_assign
id|wide
suffix:semicolon
multiline_comment|/* Completed */
r_if
c_cond
(paren
op_logical_neg
(paren
id|srb-&gt;state
op_amp
id|SRB_DO_WIDE_NEGO
)paren
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Target %02i initiates Wide Nego ...&bslash;n&quot;
comma
id|dcb-&gt;target_id
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|srb-&gt;msgout_buf
comma
id|srb-&gt;msgin_buf
comma
l_int|4
)paren
suffix:semicolon
id|srb-&gt;msg_count
op_assign
l_int|4
suffix:semicolon
id|srb-&gt;state
op_or_assign
id|SRB_DO_WIDE_NEGO
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
)brace
id|dcb-&gt;sync_mode
op_or_assign
(paren
id|WIDE_NEGO_ENABLE
op_or
id|WIDE_NEGO_DONE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
OG
l_int|0
)paren
id|dcb-&gt;sync_period
op_or_assign
id|WIDE_SYNC
suffix:semicolon
r_else
id|dcb-&gt;sync_period
op_and_assign
op_complement
id|WIDE_SYNC
suffix:semicolon
id|srb-&gt;state
op_and_assign
op_complement
id|SRB_DO_WIDE_NEGO
suffix:semicolon
multiline_comment|/*dcb-&gt;sync_mode &amp;= ~(WIDE_NEGO_ENABLE+WIDE_NEGO_DONE); */
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;Wide transfers (%i bit) negotiated with target %02i&bslash;n&quot;
comma
(paren
l_int|8
op_lshift
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
)paren
comma
id|dcb-&gt;target_id
)paren
suffix:semicolon
id|reprogram_regs
c_func
(paren
id|acb
comma
id|dcb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dcb-&gt;sync_mode
op_amp
id|SYNC_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|dcb-&gt;sync_mode
op_amp
id|SYNC_NEGO_DONE
)paren
)paren
(brace
id|build_sdtr
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;WDTR: Also try SDTR ...&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * extended message codes:&n; *&n; *&t;code&t;description&n; *&n; *&t;02h&t;Reserved&n; *&t;00h&t;MODIFY DATA  POINTER&n; *&t;01h&t;SYNCHRONOUS DATA TRANSFER REQUEST&n; *&t;03h&t;WIDE DATA TRANSFER REQUEST&n; *   04h - 7Fh&t;Reserved&n; *   80h - FFh&t;Vendor specific&n; */
DECL|function|msgin_phase0
r_static
r_void
id|msgin_phase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
op_assign
id|acb-&gt;active_dcb
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;msgin_phase0 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|srb-&gt;msgin_buf
(braket
id|acb-&gt;msg_len
op_increment
)braket
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msgin_completed
c_func
(paren
id|srb-&gt;msgin_buf
comma
id|acb-&gt;msg_len
)paren
)paren
(brace
multiline_comment|/* Now eval the msg */
r_switch
c_cond
(paren
id|srb-&gt;msgin_buf
(braket
l_int|0
)braket
)paren
(brace
r_case
id|DISCONNECT
suffix:colon
id|srb-&gt;state
op_assign
id|SRB_DISCONNECT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIMPLE_QUEUE_TAG
suffix:colon
r_case
id|HEAD_OF_QUEUE_TAG
suffix:colon
r_case
id|ORDERED_QUEUE_TAG
suffix:colon
id|srb
op_assign
id|msgin_qtag
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb-&gt;msgin_buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MESSAGE_REJECT
suffix:colon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_CLRATN
op_or
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* A sync nego message was rejected ! */
r_if
c_cond
(paren
id|srb-&gt;state
op_amp
id|SRB_DO_SYNC_NEGO
)paren
(brace
id|msgin_set_async
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* A wide nego message was rejected ! */
r_if
c_cond
(paren
id|srb-&gt;state
op_amp
id|SRB_DO_WIDE_NEGO
)paren
(brace
id|msgin_set_nowide
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|enable_msgout_abort
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
multiline_comment|/*srb-&gt;state |= SRB_ABORT_SENT */
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
multiline_comment|/* SDTR */
r_if
c_cond
(paren
id|srb-&gt;msgin_buf
(braket
l_int|1
)braket
op_eq
l_int|3
op_logical_and
id|srb-&gt;msgin_buf
(braket
l_int|2
)braket
op_eq
id|EXTENDED_SDTR
)paren
(brace
id|msgin_set_sync
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* WDTR */
r_if
c_cond
(paren
id|srb-&gt;msgin_buf
(braket
l_int|1
)braket
op_eq
l_int|2
op_logical_and
id|srb-&gt;msgin_buf
(braket
l_int|2
)braket
op_eq
id|EXTENDED_WDTR
op_logical_and
id|srb-&gt;msgin_buf
(braket
l_int|3
)braket
op_le
l_int|2
)paren
(brace
multiline_comment|/* sanity check ... */
id|msgin_set_wide
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|msgin_reject
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Discard  wide residual */
r_case
id|MSG_IGNOREWIDE
suffix:colon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;Ignore Wide Residual!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*DC395x_write32 (TRM_S1040_SCSI_COUNTER, 1); */
multiline_comment|/*DC395x_read8 (TRM_S1040_SCSI_FIFO); */
r_break
suffix:semicolon
multiline_comment|/* nothing has to be done */
r_case
id|COMMAND_COMPLETE
suffix:colon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * SAVE POINTER may be ignored as we have the struct&n;&t;&t;&t; * ScsiReqBlk* associated with the scsi command.&n;&t;&t;&t; */
r_case
id|SAVE_POINTERS
suffix:colon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;SAVE POINTER message received (pid %li: rem.%i) ... ignore :-(&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|srb-&gt;total_xfer_length
)paren
suffix:semicolon
multiline_comment|/*srb-&gt;Saved_Ptr = srb-&gt;TotalxferredLen; */
r_break
suffix:semicolon
multiline_comment|/* The device might want to restart transfer with a RESTORE */
r_case
id|RESTORE_POINTERS
suffix:colon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;RESTORE POINTER message received ... ignore :-(&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*dc395x_restore_ptr (acb, srb); */
r_break
suffix:semicolon
r_case
id|ABORT
suffix:colon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;ABORT msg received (pid %li %02i-%i)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
id|dcb-&gt;flag
op_or_assign
id|ABORT_DEV_
suffix:semicolon
id|enable_msgout_abort
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* reject unknown messages */
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|srb-&gt;msgin_buf
(braket
l_int|0
)braket
op_amp
id|IDENTIFY_BASE
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Identify Message received?&bslash;n&quot;
)paren
suffix:semicolon
id|srb-&gt;msg_count
op_assign
l_int|1
suffix:semicolon
id|srb-&gt;msgout_buf
(braket
l_int|0
)braket
op_assign
id|dcb-&gt;identify_msg
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|srb-&gt;state
op_or_assign
id|SRB_MSGOUT
suffix:semicolon
multiline_comment|/*break; */
)brace
id|msgin_reject
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear counter and MsgIn state */
id|srb-&gt;state
op_and_assign
op_complement
id|SRB_MSGIN
suffix:semicolon
id|acb-&gt;msg_len
op_assign
l_int|0
suffix:semicolon
)brace
op_star
id|pscsi_status
op_assign
id|PH_BUS_FREE
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important ... you know! */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_MSGACCEPT
)paren
suffix:semicolon
)brace
DECL|function|msgin_phase1
r_static
r_void
id|msgin_phase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;msgin_phase1 (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;MIP1&quot;
)paren
suffix:semicolon
id|DC395x_write32
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COUNTER
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|srb-&gt;state
op_amp
id|SRB_MSGIN
)paren
)paren
(brace
id|srb-&gt;state
op_and_assign
op_complement
id|SRB_DISCONNECT
suffix:semicolon
id|srb-&gt;state
op_or_assign
id|SRB_MSGIN
suffix:semicolon
)brace
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/* SCSI command */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_IN
)paren
suffix:semicolon
)brace
DECL|function|nop0
r_static
r_void
id|nop0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
)brace
DECL|function|nop1
r_static
r_void
id|nop1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
)brace
DECL|function|set_xfer_rate
r_static
r_void
id|set_xfer_rate
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|i
suffix:semicolon
multiline_comment|/* set all lun device&squot;s  period, offset */
r_if
c_cond
(paren
id|dcb-&gt;identify_msg
op_amp
l_int|0x07
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;scan_devices
)paren
(brace
id|current_sync_offset
op_assign
id|dcb-&gt;sync_offset
suffix:semicolon
r_return
suffix:semicolon
)brace
id|list_for_each_entry
c_func
(paren
id|i
comma
op_amp
id|acb-&gt;dcb_list
comma
id|list
)paren
r_if
c_cond
(paren
id|i-&gt;target_id
op_eq
id|dcb-&gt;target_id
)paren
(brace
id|i-&gt;sync_period
op_assign
id|dcb-&gt;sync_period
suffix:semicolon
id|i-&gt;sync_offset
op_assign
id|dcb-&gt;sync_offset
suffix:semicolon
id|i-&gt;sync_mode
op_assign
id|dcb-&gt;sync_mode
suffix:semicolon
id|i-&gt;min_nego_period
op_assign
id|dcb-&gt;min_nego_period
suffix:semicolon
)brace
)brace
DECL|function|disconnect
r_static
r_void
id|disconnect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
op_assign
id|acb-&gt;active_dcb
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|srb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dcb
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Disc: Exception Disconnect dcb=NULL !!&bslash;n &quot;
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
multiline_comment|/* Suspend queue for a while */
id|acb-&gt;scsi_host-&gt;last_reset
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|acb-&gt;eeprom.delay_time
suffix:semicolon
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;DiscEx&quot;
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_HWRESELECT
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|srb
op_assign
id|dcb-&gt;active_srb
suffix:semicolon
id|acb-&gt;active_dcb
op_assign
l_int|NULL
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;disconnect (#%li)&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|srb-&gt;scsi_phase
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/* initial phase */
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;Disc&quot;
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_HWRESELECT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;state
op_amp
id|SRB_UNEXPECT_RESEL
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Disc: Unexpected Reselection (%i-%i)&bslash;n&quot;
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
id|srb-&gt;state
op_assign
l_int|0
suffix:semicolon
id|waiting_process_next
c_func
(paren
id|acb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|srb-&gt;state
op_amp
id|SRB_ABORT_SENT
)paren
(brace
id|dcb-&gt;flag
op_and_assign
op_complement
id|ABORT_DEV_
suffix:semicolon
id|acb-&gt;scsi_host-&gt;last_reset
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
op_plus
l_int|1
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Disc: SRB_ABORT_SENT!&bslash;n&quot;
)paren
suffix:semicolon
id|doing_srb_done
c_func
(paren
id|acb
comma
id|DID_ABORT
comma
id|srb-&gt;cmd
comma
l_int|1
)paren
suffix:semicolon
id|waiting_process_next
c_func
(paren
id|acb
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|srb-&gt;state
op_amp
(paren
id|SRB_START_
op_plus
id|SRB_MSGOUT
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|srb
op_member_access_from_pointer
id|state
op_amp
(paren
id|SRB_DISCONNECT
op_plus
id|SRB_COMPLETED
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Selection time out &n;&t;&t;&t; * SRB_START_ || SRB_MSGOUT || (!SRB_DISCONNECT &amp;&amp; !SRB_COMPLETED)&n;&t;&t;&t; */
multiline_comment|/* Unexp. Disc / Sel Timeout */
r_if
c_cond
(paren
id|srb-&gt;state
op_ne
id|SRB_START_
op_logical_and
id|srb-&gt;state
op_ne
id|SRB_MSGOUT
)paren
(brace
id|srb-&gt;state
op_assign
id|SRB_READY
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Unexpected Disconnection (pid %li)!&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|srb-&gt;target_status
op_assign
id|SCSI_STAT_SEL_TIMEOUT
suffix:semicolon
r_goto
id|disc1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Normal selection timeout */
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;Disc: SelTO (#%li) for dev %02i-%i&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;retry_count
op_increment
OG
id|DC395x_MAX_RETRIES
op_logical_or
id|acb-&gt;scan_devices
)paren
(brace
id|srb-&gt;target_status
op_assign
id|SCSI_STAT_SEL_TIMEOUT
suffix:semicolon
r_goto
id|disc1
suffix:semicolon
)brace
id|free_tag
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|srb_going_to_waiting_move
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;Retry pid %li ...&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
id|waiting_set_timer
c_func
(paren
id|acb
comma
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|srb-&gt;state
op_amp
id|SRB_DISCONNECT
)paren
(brace
id|u8
id|bval
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_SIGNAL
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * SRB_DISCONNECT (This is what we expect!)&n;&t;&t;&t; */
multiline_comment|/* dprintkl(KERN_DEBUG, &quot;DoWaitingSRB (#%li)&bslash;n&quot;, srb-&gt;cmd-&gt;pid); */
r_if
c_cond
(paren
id|bval
op_amp
l_int|0x40
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;Debug: DISC: SCSI bus stat %02x: ACK set! Other controllers?&bslash;n&quot;
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* It could come from another initiator, therefore don&squot;t do much ! */
)brace
r_else
id|waiting_process_next
c_func
(paren
id|acb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|srb-&gt;state
op_amp
id|SRB_COMPLETED
)paren
(brace
id|disc1
suffix:colon
multiline_comment|/*&n;&t;&t;&t; ** SRB_COMPLETED&n;&t;&t;&t; */
id|free_tag
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|dcb-&gt;active_srb
op_assign
l_int|NULL
suffix:semicolon
id|srb-&gt;state
op_assign
id|SRB_FREE
suffix:semicolon
multiline_comment|/*dprintkl(KERN_DEBUG, &quot;done (#%li)&bslash;n&quot;, srb-&gt;cmd-&gt;pid); */
id|srb_done
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|reselect
r_static
r_void
id|reselect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
op_assign
id|acb-&gt;active_dcb
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|srb
op_assign
l_int|NULL
suffix:semicolon
id|u16
id|rsel_tar_lun_id
suffix:semicolon
id|u8
id|id
comma
id|lun
suffix:semicolon
id|u8
id|arblostflag
op_assign
l_int|0
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;reselect...&bslash;n&quot;
)paren
suffix:semicolon
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;Resel&quot;
)paren
suffix:semicolon
multiline_comment|/*DC395x_write16(acb, TRM_S1040_SCSI_CONTROL, DO_HWRESELECT | DO_DATALATCH); */
multiline_comment|/* Read Reselected Target ID and LUN */
id|rsel_tar_lun_id
op_assign
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_TARGETID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dcb
)paren
(brace
multiline_comment|/* Arbitration lost but Reselection win */
id|srb
op_assign
id|dcb-&gt;active_srb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|srb
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Arb lost Resel won, but active_srb == NULL!&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
r_return
suffix:semicolon
)brace
multiline_comment|/* Why the if ? */
r_if
c_cond
(paren
op_logical_neg
id|acb-&gt;scan_devices
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;Arb lost but Resel win pid %li (%02i-%i) Rsel %04x Stat %04x&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|rsel_tar_lun_id
comma
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_STATUS
)paren
)paren
suffix:semicolon
id|arblostflag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*srb-&gt;state |= SRB_DISCONNECT; */
id|srb-&gt;state
op_assign
id|SRB_READY
suffix:semicolon
id|free_tag
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|srb_going_to_waiting_move
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|waiting_set_timer
c_func
(paren
id|acb
comma
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
multiline_comment|/* return; */
)brace
)brace
multiline_comment|/* Read Reselected Target Id and LUN */
r_if
c_cond
(paren
op_logical_neg
(paren
id|rsel_tar_lun_id
op_amp
(paren
id|IDENTIFY_BASE
op_lshift
l_int|8
)paren
)paren
)paren
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Resel expects identify msg! Got %04x!&bslash;n&quot;
comma
id|rsel_tar_lun_id
)paren
suffix:semicolon
id|id
op_assign
id|rsel_tar_lun_id
op_amp
l_int|0xff
suffix:semicolon
id|lun
op_assign
(paren
id|rsel_tar_lun_id
op_rshift
l_int|8
)paren
op_amp
l_int|7
suffix:semicolon
id|dcb
op_assign
id|find_dcb
c_func
(paren
id|acb
comma
id|id
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dcb
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Reselect from non existing device (%02i-%i)&bslash;n&quot;
comma
id|id
comma
id|lun
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
r_return
suffix:semicolon
)brace
id|acb-&gt;active_dcb
op_assign
id|dcb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_DISCONNECT
)paren
)paren
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Reselection in spite of forbidden disconnection? (%02i-%i)&bslash;n&quot;
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dcb-&gt;sync_mode
op_amp
id|EN_TAG_QUEUEING
multiline_comment|/*&amp;&amp; !arblostflag */
)paren
(brace
id|srb
op_assign
id|acb-&gt;tmp_srb
suffix:semicolon
id|dcb-&gt;active_srb
op_assign
id|srb
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* There can be only one! */
id|srb
op_assign
id|dcb-&gt;active_srb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|srb
op_logical_or
op_logical_neg
(paren
id|srb-&gt;state
op_amp
id|SRB_DISCONNECT
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * abort command&n;&t;&t;&t; */
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Reselected w/o disconnected cmds from %02i-%i?&bslash;n&quot;
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
id|srb
op_assign
id|acb-&gt;tmp_srb
suffix:semicolon
id|srb-&gt;state
op_assign
id|SRB_UNEXPECT_RESEL
suffix:semicolon
id|dcb-&gt;active_srb
op_assign
id|srb
suffix:semicolon
id|enable_msgout_abort
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|dcb-&gt;flag
op_amp
id|ABORT_DEV_
)paren
(brace
multiline_comment|/*srb-&gt;state = SRB_ABORT_SENT; */
id|enable_msgout_abort
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
)brace
r_else
id|srb-&gt;state
op_assign
id|SRB_DATA_XFER
suffix:semicolon
)brace
)brace
id|srb-&gt;scsi_phase
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/* initial phase */
multiline_comment|/* Program HA ID, target ID, period and offset */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_HOSTID
comma
id|acb-&gt;scsi_host-&gt;this_id
)paren
suffix:semicolon
multiline_comment|/* host   ID */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_TARGETID
comma
id|dcb-&gt;target_id
)paren
suffix:semicolon
multiline_comment|/* target ID */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_OFFSET
comma
id|dcb-&gt;sync_offset
)paren
suffix:semicolon
multiline_comment|/* offset    */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_SYNC
comma
id|dcb-&gt;sync_period
)paren
suffix:semicolon
multiline_comment|/* sync period, wide */
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/* SCSI command */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_MSGACCEPT
)paren
suffix:semicolon
)brace
DECL|function|tagq_blacklist
r_static
r_inline
id|u8
id|tagq_blacklist
c_func
(paren
r_char
op_star
id|name
)paren
(brace
macro_line|#ifndef DC395x_NO_TAGQ
macro_line|#if 0
id|u8
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BADDEVCNT
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|name
comma
id|DC395x_baddevname1
(braket
id|i
)braket
comma
l_int|28
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
l_int|1
suffix:semicolon
macro_line|#endif
)brace
DECL|function|disc_tagq_set
r_static
r_void
id|disc_tagq_set
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiInqData
op_star
id|ptr
)paren
(brace
multiline_comment|/* Check for SCSI format (ANSI and Response data format) */
r_if
c_cond
(paren
(paren
id|ptr-&gt;Vers
op_amp
l_int|0x07
)paren
op_ge
l_int|2
op_logical_or
(paren
id|ptr-&gt;RDF
op_amp
l_int|0x0F
)paren
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|ptr-&gt;Flags
op_amp
id|SCSI_INQ_CMDQUEUE
)paren
op_logical_and
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_TAG_QUEUEING
)paren
op_logical_and
multiline_comment|/*(dcb-&gt;dev_mode &amp; NTC_DO_DISCONNECT) */
multiline_comment|/* ((dcb-&gt;dev_type == TYPE_DISK) &n;&t;&t;       || (dcb-&gt;dev_type == TYPE_MOD)) &amp;&amp; */
op_logical_neg
id|tagq_blacklist
c_func
(paren
(paren
(paren
r_char
op_star
)paren
id|ptr
)paren
op_plus
l_int|8
)paren
)paren
(brace
r_if
c_cond
(paren
id|dcb-&gt;max_command
op_eq
l_int|1
)paren
id|dcb-&gt;max_command
op_assign
id|dcb-&gt;acb-&gt;tag_max_num
suffix:semicolon
id|dcb-&gt;sync_mode
op_or_assign
id|EN_TAG_QUEUEING
suffix:semicolon
multiline_comment|/*dcb-&gt;tag_mask = 0; */
)brace
r_else
id|dcb-&gt;max_command
op_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|add_dev
r_static
r_void
id|add_dev
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiInqData
op_star
id|ptr
)paren
(brace
id|u8
id|bval1
op_assign
id|ptr-&gt;DevType
op_amp
id|SCSI_DEVTYPE
suffix:semicolon
id|dcb-&gt;dev_type
op_assign
id|bval1
suffix:semicolon
multiline_comment|/* if (bval1 == TYPE_DISK || bval1 == TYPE_MOD) */
id|disc_tagq_set
c_func
(paren
id|dcb
comma
id|ptr
)paren
suffix:semicolon
)brace
multiline_comment|/* unmap mapped pci regions from SRB */
DECL|function|pci_unmap_srb
r_static
r_void
id|pci_unmap_srb
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|srb-&gt;cmd
suffix:semicolon
r_int
id|dir
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
op_logical_and
id|dir
op_ne
id|PCI_DMA_NONE
)paren
(brace
multiline_comment|/* unmap DC395x SG list */
id|dprintkdbg
c_func
(paren
id|DBG_SGPARANOIA
comma
l_string|&quot;unmap SG list %08x(%05x)&bslash;n&quot;
comma
id|srb-&gt;sg_bus_addr
comma
id|SEGMENTX_LEN
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|acb-&gt;dev
comma
id|srb-&gt;sg_bus_addr
comma
id|SEGMENTX_LEN
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_SGPARANOIA
comma
l_string|&quot;Unmap %i SG segments from %p&bslash;n&quot;
comma
id|cmd-&gt;use_sg
comma
id|cmd-&gt;request_buffer
)paren
suffix:semicolon
multiline_comment|/* unmap the sg segments */
id|pci_unmap_sg
c_func
(paren
id|acb-&gt;dev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
comma
id|cmd-&gt;use_sg
comma
id|dir
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd-&gt;request_buffer
op_logical_and
id|dir
op_ne
id|PCI_DMA_NONE
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_SGPARANOIA
comma
l_string|&quot;Unmap buffer %08x(%05x)&bslash;n&quot;
comma
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
comma
id|cmd-&gt;request_bufflen
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|acb-&gt;dev
comma
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
comma
id|cmd-&gt;request_bufflen
comma
id|dir
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* unmap mapped pci sense buffer from SRB */
DECL|function|pci_unmap_srb_sense
r_static
r_void
id|pci_unmap_srb_sense
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|srb-&gt;flag
op_amp
id|AUTO_REQSENSE
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Unmap sense buffer */
id|dprintkdbg
c_func
(paren
id|DBG_SGPARANOIA
comma
l_string|&quot;Unmap sense buffer from %08x&bslash;n&quot;
comma
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|acb-&gt;dev
comma
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
comma
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|length
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
multiline_comment|/* Restore SG stuff */
multiline_comment|/*printk (&quot;Auto_ReqSense finished: Restore Counters ...&bslash;n&quot;); */
id|srb-&gt;total_xfer_length
op_assign
id|srb-&gt;xferred
suffix:semicolon
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
op_assign
id|srb-&gt;segment_x
(braket
id|DC395x_MAX_SG_LISTENTRY
op_minus
l_int|1
)braket
dot
id|address
suffix:semicolon
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|length
op_assign
id|srb-&gt;segment_x
(braket
id|DC395x_MAX_SG_LISTENTRY
op_minus
l_int|1
)braket
dot
id|length
suffix:semicolon
)brace
multiline_comment|/*&n; * Complete execution of a SCSI command&n; * Signal completion to the generic SCSI driver  &n; */
DECL|function|srb_done
r_static
r_void
id|srb_done
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|u8
id|tempcnt
comma
id|status
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|srb-&gt;cmd
suffix:semicolon
r_struct
id|ScsiInqData
op_star
id|ptr
suffix:semicolon
r_int
id|dir
suffix:semicolon
id|dir
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd-&gt;request_buffer
suffix:semicolon
id|ptr
op_assign
(paren
r_struct
id|ScsiInqData
op_star
)paren
(paren
id|page_address
c_func
(paren
id|sg-&gt;page
)paren
op_plus
id|sg-&gt;offset
)paren
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
(paren
r_struct
id|ScsiInqData
op_star
)paren
(paren
id|cmd-&gt;request_buffer
)paren
suffix:semicolon
)brace
id|dprintkdbg
c_func
(paren
id|DBG_SGPARANOIA
comma
l_string|&quot;srb_done sg=%i(%i/%i), buf=%p, addr=%p&bslash;n&quot;
comma
id|cmd-&gt;use_sg
comma
id|srb-&gt;sg_index
comma
id|srb-&gt;sg_count
comma
id|cmd-&gt;request_buffer
comma
id|ptr
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;srb_done (#%li) (target %02i-%i): &quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|srb-&gt;cmd-&gt;device-&gt;id
comma
id|srb-&gt;cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|status
op_assign
id|srb-&gt;target_status
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;flag
op_amp
id|AUTO_REQSENSE
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;AUTO_REQSENSE1..............&bslash;n&quot;
)paren
suffix:semicolon
id|pci_unmap_srb_sense
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; ** target status..........................&n;&t;&t; */
id|srb-&gt;flag
op_and_assign
op_complement
id|AUTO_REQSENSE
suffix:semicolon
id|srb-&gt;adapter_status
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;target_status
op_assign
id|CHECK_CONDITION
op_lshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_KG
)paren
)paren
(brace
r_switch
c_cond
(paren
id|cmd-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
(brace
r_case
id|NOT_READY
suffix:colon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;ReqSense: NOT_READY (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i) &quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|status
comma
id|acb-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UNIT_ATTENTION
suffix:colon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;ReqSense: UNIT_ATTENTION (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i) &quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|status
comma
id|acb-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ILLEGAL_REQUEST
suffix:colon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;ReqSense: ILLEGAL_REQUEST (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i) &quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|status
comma
id|acb-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEDIUM_ERROR
suffix:colon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;ReqSense: MEDIUM_ERROR (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i) &quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|status
comma
id|acb-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARDWARE_ERROR
suffix:colon
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;ReqSense: HARDWARE_ERROR (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i) &quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|status
comma
id|acb-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd-&gt;sense_buffer
(braket
l_int|7
)braket
op_ge
l_int|6
)paren
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Sense=%02x, ASC=%02x, ASCQ=%02x (%08x %08x) &quot;
comma
id|cmd-&gt;sense_buffer
(braket
l_int|2
)braket
comma
id|cmd-&gt;sense_buffer
(braket
l_int|12
)braket
comma
id|cmd-&gt;sense_buffer
(braket
l_int|13
)braket
comma
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|cmd-&gt;sense_buffer
op_plus
l_int|3
)paren
)paren
comma
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|cmd-&gt;sense_buffer
op_plus
l_int|8
)paren
)paren
)paren
suffix:semicolon
r_else
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Sense=%02x, No ASC/ASCQ (%08x) &quot;
comma
id|cmd-&gt;sense_buffer
(braket
l_int|2
)braket
comma
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|cmd-&gt;sense_buffer
op_plus
l_int|3
)paren
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_eq
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
)paren
(brace
id|cmd-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
r_goto
id|ckc_e
suffix:semicolon
)brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;AUTO_REQSENSE2..............&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;total_xfer_length
op_logical_and
id|srb-&gt;total_xfer_length
op_ge
id|cmd-&gt;underflow
)paren
id|cmd-&gt;result
op_assign
id|MK_RES_LNX
c_func
(paren
id|DRIVER_SENSE
comma
id|DID_OK
comma
id|srb-&gt;end_message
comma
id|CHECK_CONDITION
)paren
suffix:semicolon
multiline_comment|/*SET_RES_DID(cmd-&gt;result,DID_OK) */
r_else
id|cmd-&gt;result
op_assign
id|MK_RES_LNX
c_func
(paren
id|DRIVER_SENSE
comma
id|DID_OK
comma
id|srb-&gt;end_message
comma
id|CHECK_CONDITION
)paren
suffix:semicolon
r_goto
id|ckc_e
suffix:semicolon
)brace
multiline_comment|/*************************************************************/
r_if
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/*&n;&t;&t; * target status..........................&n;&t;&t; */
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|status
)paren
op_eq
id|CHECK_CONDITION
)paren
(brace
id|request_sense
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|status
)paren
op_eq
id|QUEUE_FULL
)paren
(brace
id|tempcnt
op_assign
(paren
id|u8
)paren
id|list_size
c_func
(paren
op_amp
id|dcb-&gt;srb_going_list
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;nDC395x:  QUEUE_FULL for dev %02i-%i with %i cmnds&bslash;n&quot;
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|tempcnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tempcnt
OG
l_int|1
)paren
id|tempcnt
op_decrement
suffix:semicolon
id|dcb-&gt;max_command
op_assign
id|tempcnt
suffix:semicolon
id|free_tag
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|srb_going_to_waiting_move
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|waiting_set_timer
c_func
(paren
id|acb
comma
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|srb-&gt;adapter_status
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;target_status
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_eq
id|SCSI_STAT_SEL_TIMEOUT
)paren
(brace
id|srb-&gt;adapter_status
op_assign
id|H_SEL_TIMEOUT
suffix:semicolon
id|srb-&gt;target_status
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
id|srb-&gt;adapter_status
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|cmd-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
id|SET_RES_MSG
c_func
(paren
id|cmd-&gt;result
comma
id|srb-&gt;end_message
)paren
suffix:semicolon
id|SET_RES_TARGET
c_func
(paren
id|cmd-&gt;result
comma
id|status
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; ** process initiator status..........................&n;&t;&t; */
id|status
op_assign
id|srb-&gt;adapter_status
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|H_OVER_UNDER_RUN
)paren
(brace
id|srb-&gt;target_status
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|cmd-&gt;result
comma
id|DID_OK
)paren
suffix:semicolon
id|SET_RES_MSG
c_func
(paren
id|cmd-&gt;result
comma
id|srb-&gt;end_message
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|srb-&gt;status
op_amp
id|PARITY_ERROR
)paren
(brace
id|SET_RES_DID
c_func
(paren
id|cmd-&gt;result
comma
id|DID_PARITY
)paren
suffix:semicolon
id|SET_RES_MSG
c_func
(paren
id|cmd-&gt;result
comma
id|srb-&gt;end_message
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No error */
id|srb-&gt;adapter_status
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;target_status
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|cmd-&gt;result
comma
id|DID_OK
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dir
op_ne
id|PCI_DMA_NONE
)paren
(brace
r_if
c_cond
(paren
id|cmd-&gt;use_sg
)paren
id|pci_dma_sync_sg
c_func
(paren
id|acb-&gt;dev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|cmd
op_member_access_from_pointer
id|request_buffer
comma
id|cmd-&gt;use_sg
comma
id|dir
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cmd-&gt;request_buffer
)paren
id|pci_dma_sync_single
c_func
(paren
id|acb-&gt;dev
comma
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
comma
id|cmd-&gt;request_bufflen
comma
id|dir
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cmd-&gt;result
op_amp
id|RES_DID
)paren
op_eq
l_int|0
op_logical_and
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
id|cmd-&gt;cmnd
(braket
l_int|2
)braket
op_eq
l_int|0
op_logical_and
id|cmd-&gt;request_bufflen
op_ge
l_int|8
op_logical_and
id|dir
op_ne
id|PCI_DMA_NONE
op_logical_and
id|ptr
op_logical_and
(paren
id|ptr-&gt;Vers
op_amp
l_int|0x07
)paren
op_ge
l_int|2
)paren
id|dcb-&gt;inquiry7
op_assign
id|ptr-&gt;Flags
suffix:semicolon
multiline_comment|/* Check Error Conditions */
id|ckc_e
suffix:colon
multiline_comment|/*if( srb-&gt;cmd-&gt;cmnd[0] == INQUIRY &amp;&amp; */
multiline_comment|/*  (host_byte(cmd-&gt;result) == DID_OK || status_byte(cmd-&gt;result) &amp; CHECK_CONDITION) ) */
r_if
c_cond
(paren
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
(paren
id|cmd-&gt;result
op_eq
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_logical_or
id|status_byte
c_func
(paren
id|cmd
op_member_access_from_pointer
id|result
)paren
op_amp
id|CHECK_CONDITION
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dcb-&gt;init_tcq_flag
)paren
(brace
id|add_dev
c_func
(paren
id|acb
comma
id|dcb
comma
id|ptr
)paren
suffix:semicolon
id|dcb-&gt;init_tcq_flag
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Here is the info for Doug Gilbert&squot;s sg3 ... */
id|cmd-&gt;resid
op_assign
id|srb-&gt;total_xfer_length
suffix:semicolon
multiline_comment|/* This may be interpreted by sb. or not ... */
id|cmd-&gt;SCp.this_residual
op_assign
id|srb-&gt;total_xfer_length
suffix:semicolon
id|cmd-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_KG
)paren
)paren
(brace
r_if
c_cond
(paren
id|srb-&gt;total_xfer_length
)paren
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;pid %li: %02x (%02i-%i): Missed %i bytes&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
comma
id|srb-&gt;total_xfer_length
)paren
suffix:semicolon
)brace
id|srb_going_remove
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
multiline_comment|/* Add to free list */
r_if
c_cond
(paren
id|srb
op_eq
id|acb-&gt;tmp_srb
)paren
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;ERROR! Completed Cmnd with tmp_srb!&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|srb_free_insert
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;srb_done: done (#%li)&bslash;n&quot;
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_KG
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; 0x%08x&bslash;n&quot;
comma
id|cmd-&gt;result
)paren
suffix:semicolon
)brace
id|pci_unmap_srb
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
multiline_comment|/*DC395x_UNLOCK_ACB_NI; */
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/*DC395x_LOCK_ACB_NI; */
id|waiting_process_next
c_func
(paren
id|acb
)paren
suffix:semicolon
)brace
multiline_comment|/* abort all cmds in our queues */
DECL|function|doing_srb_done
r_static
r_void
id|doing_srb_done
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
id|u8
id|did_flag
comma
id|Scsi_Cmnd
op_star
id|cmd
comma
id|u8
id|force
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;doing_srb_done: pids &quot;
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dcb
comma
op_amp
id|acb-&gt;dcb_list
comma
id|list
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|srb
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|tmp
suffix:semicolon
id|Scsi_Cmnd
op_star
id|p
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|srb
comma
id|tmp
comma
op_amp
id|dcb-&gt;srb_going_list
comma
id|list
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|dir
suffix:semicolon
id|p
op_assign
id|srb-&gt;cmd
suffix:semicolon
id|dir
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|p-&gt;sc_data_direction
)paren
suffix:semicolon
id|result
op_assign
id|MK_RES
c_func
(paren
l_int|0
comma
id|did_flag
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;G:%li(%02i-%i) &quot;
comma
id|p-&gt;pid
comma
id|p-&gt;device-&gt;id
comma
id|p-&gt;device-&gt;lun
)paren
suffix:semicolon
id|srb_going_remove
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|free_tag
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|srb_free_insert
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
id|p-&gt;result
op_assign
id|result
suffix:semicolon
id|pci_unmap_srb_sense
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
id|pci_unmap_srb
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|force
)paren
(brace
multiline_comment|/* For new EH, we normally don&squot;t need to give commands back,&n;&t;&t;&t;&t; * as they all complete or all time out */
id|p
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dcb-&gt;srb_going_list
)paren
)paren
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;How could the ML send cmnds to the Going queue? (%02i-%i)!!&bslash;n&quot;
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dcb-&gt;tag_mask
)paren
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;tag_mask for %02i-%i should be empty, is %08x!&bslash;n&quot;
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|dcb-&gt;tag_mask
)paren
suffix:semicolon
multiline_comment|/* Waiting queue */
id|list_for_each_entry_safe
c_func
(paren
id|srb
comma
id|tmp
comma
op_amp
id|dcb-&gt;srb_waiting_list
comma
id|list
)paren
(brace
r_int
id|result
suffix:semicolon
id|p
op_assign
id|srb-&gt;cmd
suffix:semicolon
id|result
op_assign
id|MK_RES
c_func
(paren
l_int|0
comma
id|did_flag
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;W:%li(%i-%i)&quot;
comma
id|p-&gt;pid
comma
id|p-&gt;device-&gt;id
comma
id|p-&gt;device-&gt;lun
)paren
suffix:semicolon
id|srb_waiting_remove
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|srb_free_insert
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
id|p-&gt;result
op_assign
id|result
suffix:semicolon
id|pci_unmap_srb_sense
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
id|pci_unmap_srb
c_func
(paren
id|acb
comma
id|srb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|force
)paren
(brace
multiline_comment|/* For new EH, we normally don&squot;t need to give commands back,&n;&t;&t;&t;&t; * as they all complete or all time out */
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dcb-&gt;srb_waiting_list
)paren
)paren
id|printk
(paren
l_string|&quot;&bslash;nDC395x: Debug: ML queued %i cmnds again to %02i-%i&bslash;n&quot;
comma
id|list_size
c_func
(paren
op_amp
id|dcb-&gt;srb_waiting_list
)paren
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
id|dcb-&gt;flag
op_and_assign
op_complement
id|ABORT_DEV_
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|reset_scsi_bus
r_static
r_void
id|reset_scsi_bus
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;reset_scsi_bus...&bslash;n&quot;
)paren
suffix:semicolon
id|acb-&gt;acb_flag
op_or_assign
id|RESET_DEV
suffix:semicolon
multiline_comment|/* RESET_DETECT, RESET_DONE, RESET_DEV */
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_RSTSCSI
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_INTSTATUS
)paren
op_amp
id|INT_SCSIRESET
)paren
)paren
multiline_comment|/* nothing */
suffix:semicolon
)brace
DECL|function|set_basic_config
r_static
r_void
id|set_basic_config
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
id|u8
id|bval
suffix:semicolon
id|u16
id|wval
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_TIMEOUT
comma
id|acb-&gt;sel_timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;config
op_amp
id|HCC_PARITY
)paren
id|bval
op_assign
id|PHASELATCH
op_or
id|INITIATOR
op_or
id|BLOCKRST
op_or
id|PARITYCHECK
suffix:semicolon
r_else
id|bval
op_assign
id|PHASELATCH
op_or
id|INITIATOR
op_or
id|BLOCKRST
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONFIG0
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* program configuration 1: Act_Neg (+ Act_Neg_Enh? + Fast_Filter? + DataDis?) */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONFIG1
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* was 0x13: default */
multiline_comment|/* program Host ID                  */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_HOSTID
comma
id|acb-&gt;scsi_host-&gt;this_id
)paren
suffix:semicolon
multiline_comment|/* set ansynchronous transfer       */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_OFFSET
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Turn LED control off */
id|wval
op_assign
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_GEN_CONTROL
)paren
op_amp
l_int|0x7F
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_GEN_CONTROL
comma
id|wval
)paren
suffix:semicolon
multiline_comment|/* DMA config          */
id|wval
op_assign
id|DC395x_read16
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONFIG
)paren
op_amp
op_complement
id|DMA_FIFO_CTRL
suffix:semicolon
id|wval
op_or_assign
id|DMA_FIFO_HALF_HALF
op_or
id|DMA_ENHANCE
multiline_comment|/*| DMA_MEM_MULTI_READ */
suffix:semicolon
multiline_comment|/*dprintkl(KERN_INFO, &quot;DMA_Config: %04x&bslash;n&quot;, wval); */
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONFIG
comma
id|wval
)paren
suffix:semicolon
multiline_comment|/* Clear pending interrupt status */
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_INTSTATUS
)paren
suffix:semicolon
multiline_comment|/* Enable SCSI interrupt    */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_INTEN
comma
l_int|0x7F
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_INTEN
comma
id|EN_SCSIINTR
op_or
id|EN_DMAXFERERROR
multiline_comment|/*| EN_DMAXFERABORT | EN_DMAXFERCOMP | EN_FORCEDMACOMP */
)paren
suffix:semicolon
)brace
DECL|function|scsi_reset_detect
r_static
r_void
id|scsi_reset_detect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;scsi_reset_detect&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* delay half a second */
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_RSTMODULE
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONTROL
comma
id|DMARESETMODULE
)paren
suffix:semicolon
multiline_comment|/*DC395x_write8(acb, TRM_S1040_DMA_CONTROL,STOPDMAXFER); */
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
multiline_comment|/* Maybe we locked up the bus? Then lets wait even longer ... */
id|acb-&gt;scsi_host-&gt;last_reset
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|acb-&gt;eeprom.delay_time
suffix:semicolon
id|clear_fifo
c_func
(paren
id|acb
comma
l_string|&quot;RstDet&quot;
)paren
suffix:semicolon
id|set_basic_config
c_func
(paren
id|acb
)paren
suffix:semicolon
multiline_comment|/*1.25 */
multiline_comment|/*DC395x_write16(acb, TRM_S1040_SCSI_CONTROL, DO_HWRESELECT); */
r_if
c_cond
(paren
id|acb-&gt;acb_flag
op_amp
id|RESET_DEV
)paren
(brace
multiline_comment|/* RESET_DETECT, RESET_DONE, RESET_DEV */
id|acb-&gt;acb_flag
op_or_assign
id|RESET_DONE
suffix:semicolon
)brace
r_else
(brace
id|acb-&gt;acb_flag
op_or_assign
id|RESET_DETECT
suffix:semicolon
id|reset_dev_param
c_func
(paren
id|acb
)paren
suffix:semicolon
id|doing_srb_done
c_func
(paren
id|acb
comma
id|DID_RESET
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*DC395x_RecoverSRB( acb ); */
id|acb-&gt;active_dcb
op_assign
l_int|NULL
suffix:semicolon
id|acb-&gt;acb_flag
op_assign
l_int|0
suffix:semicolon
id|waiting_process_next
c_func
(paren
id|acb
)paren
suffix:semicolon
)brace
)brace
DECL|function|request_sense
r_static
r_void
id|request_sense
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
comma
r_struct
id|ScsiReqBlk
op_star
id|srb
)paren
(brace
id|Scsi_Cmnd
op_star
id|cmd
op_assign
id|srb-&gt;cmd
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;request_sense for pid %li, target %02i-%i&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|srb-&gt;flag
op_or_assign
id|AUTO_REQSENSE
suffix:semicolon
id|srb-&gt;adapter_status
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;target_status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* KG: Can this prevent crap sense data ? */
id|memset
c_func
(paren
id|cmd-&gt;sense_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
multiline_comment|/* Save some data */
id|srb-&gt;segment_x
(braket
id|DC395x_MAX_SG_LISTENTRY
op_minus
l_int|1
)braket
dot
id|address
op_assign
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
id|srb-&gt;segment_x
(braket
id|DC395x_MAX_SG_LISTENTRY
op_minus
l_int|1
)braket
dot
id|length
op_assign
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
id|srb-&gt;xferred
op_assign
id|srb-&gt;total_xfer_length
suffix:semicolon
multiline_comment|/* srb-&gt;segment_x : a one entry of S/G list table */
id|srb-&gt;total_xfer_length
op_assign
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
suffix:semicolon
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
suffix:semicolon
multiline_comment|/* Map sense buffer */
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
op_assign
id|pci_map_single
c_func
(paren
id|acb-&gt;dev
comma
id|cmd-&gt;sense_buffer
comma
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_SGPARANOIA
comma
l_string|&quot;Map sense buffer %p-&gt;%08x(%05x)&bslash;n&quot;
comma
id|cmd-&gt;sense_buffer
comma
id|srb-&gt;segment_x
(braket
l_int|0
)braket
dot
id|address
comma
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|srb-&gt;sg_count
op_assign
l_int|1
suffix:semicolon
id|srb-&gt;sg_index
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|start_scsi
c_func
(paren
id|acb
comma
id|dcb
comma
id|srb
)paren
)paren
(brace
multiline_comment|/* Should only happen, if sb. else grabs the bus */
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Request Sense failed for pid %li (%02i-%i)!&bslash;n&quot;
comma
id|srb-&gt;cmd-&gt;pid
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
id|srb_going_to_waiting_move
c_func
(paren
id|dcb
comma
id|srb
)paren
suffix:semicolon
id|waiting_set_timer
c_func
(paren
id|acb
comma
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * device_alloc - Allocate a new device instance. This create the&n; * devices instance and sets up all the data items. The adapter&n; * instance is required to obtain confiuration information for this&n; * device. This does *not* add this device to the adapters device&n; * list.&n; *&n; * @acb: The adapter to obtain configuration information from.&n; * @target: The target for the new device.&n; * @lun: The lun for the new device.&n; *&n; * Return the new device if succesfull or NULL on failure.&n; **/
DECL|function|device_alloc
r_static
r_struct
id|DeviceCtlBlk
op_star
id|device_alloc
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
id|u8
id|target
comma
id|u8
id|lun
)paren
(brace
r_struct
id|NvRamType
op_star
id|eeprom
op_assign
op_amp
id|acb-&gt;eeprom
suffix:semicolon
id|u8
id|period_index
op_assign
id|eeprom-&gt;target
(braket
id|target
)braket
dot
id|period
op_amp
l_int|0x07
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
id|dcb
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|DeviceCtlBlk
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;device_alloc: device %p&bslash;n&quot;
comma
id|dcb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dcb
)paren
r_return
l_int|NULL
suffix:semicolon
id|dcb-&gt;acb
op_assign
l_int|NULL
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dcb-&gt;srb_going_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dcb-&gt;srb_waiting_list
)paren
suffix:semicolon
id|dcb-&gt;active_srb
op_assign
l_int|NULL
suffix:semicolon
id|dcb-&gt;tag_mask
op_assign
l_int|0
suffix:semicolon
id|dcb-&gt;max_command
op_assign
l_int|1
suffix:semicolon
id|dcb-&gt;target_id
op_assign
id|target
suffix:semicolon
id|dcb-&gt;target_lun
op_assign
id|lun
suffix:semicolon
macro_line|#ifndef DC395x_NO_DISCONNECT
id|dcb-&gt;identify_msg
op_assign
id|IDENTIFY
c_func
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_DISCONNECT
comma
id|lun
)paren
suffix:semicolon
macro_line|#else
id|dcb-&gt;identify_msg
op_assign
id|IDENTIFY
c_func
(paren
l_int|0
comma
id|lun
)paren
suffix:semicolon
macro_line|#endif
id|dcb-&gt;dev_mode
op_assign
id|eeprom-&gt;target
(braket
id|target
)braket
dot
id|cfg0
suffix:semicolon
id|dcb-&gt;inquiry7
op_assign
l_int|0
suffix:semicolon
id|dcb-&gt;sync_mode
op_assign
l_int|0
suffix:semicolon
id|dcb-&gt;min_nego_period
op_assign
id|clock_period
(braket
id|period_index
)braket
suffix:semicolon
id|dcb-&gt;sync_period
op_assign
l_int|0
suffix:semicolon
id|dcb-&gt;sync_offset
op_assign
l_int|0
suffix:semicolon
id|dcb-&gt;flag
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef DC395x_NO_WIDE
r_if
c_cond
(paren
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_WIDE_NEGO
)paren
op_logical_and
(paren
id|acb-&gt;config
op_amp
id|HCC_WIDE_CARD
)paren
)paren
id|dcb-&gt;sync_mode
op_or_assign
id|WIDE_NEGO_ENABLE
suffix:semicolon
macro_line|#endif
macro_line|#ifndef DC395x_NO_SYNC
r_if
c_cond
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_SYNC_NEGO
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|lun
)paren
op_logical_or
id|current_sync_offset
)paren
id|dcb-&gt;sync_mode
op_or_assign
id|SYNC_NEGO_ENABLE
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dcb-&gt;target_lun
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Copy settings */
r_struct
id|DeviceCtlBlk
op_star
id|p
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|p
comma
op_amp
id|acb-&gt;dcb_list
comma
id|list
)paren
r_if
c_cond
(paren
id|p-&gt;target_id
op_eq
id|dcb-&gt;target_id
)paren
r_break
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_KG
comma
l_string|&quot;Copy settings from %02i-%02i to %02i-%02i&bslash;n&quot;
comma
id|p-&gt;target_id
comma
id|p-&gt;target_lun
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
id|dcb-&gt;sync_mode
op_assign
id|p-&gt;sync_mode
suffix:semicolon
id|dcb-&gt;sync_period
op_assign
id|p-&gt;sync_period
suffix:semicolon
id|dcb-&gt;min_nego_period
op_assign
id|p-&gt;min_nego_period
suffix:semicolon
id|dcb-&gt;sync_offset
op_assign
id|p-&gt;sync_offset
suffix:semicolon
id|dcb-&gt;inquiry7
op_assign
id|p-&gt;inquiry7
suffix:semicolon
)brace
r_return
id|dcb
suffix:semicolon
)brace
multiline_comment|/**&n; * adapter_add_device - Adds the device instance to the adaptor instance.&n; *&n; * @acb: The adapter device to be updated&n; * @dcb: A newly created and intialised device instance to add.&n; **/
DECL|function|adapter_add_device
r_static
r_void
id|adapter_add_device
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
)paren
(brace
multiline_comment|/* backpointer to adapter */
id|dcb-&gt;acb
op_assign
id|acb
suffix:semicolon
multiline_comment|/* set run_robin to this device if it is currently empty */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|acb-&gt;dcb_list
)paren
)paren
id|acb-&gt;dcb_run_robin
op_assign
id|dcb
suffix:semicolon
multiline_comment|/* add device to list */
id|list_add_tail
c_func
(paren
op_amp
id|dcb-&gt;list
comma
op_amp
id|acb-&gt;dcb_list
)paren
suffix:semicolon
multiline_comment|/* update device maps */
id|acb-&gt;dcb_map
(braket
id|dcb-&gt;target_id
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|dcb-&gt;target_lun
)paren
suffix:semicolon
id|acb-&gt;children
(braket
id|dcb-&gt;target_id
)braket
(braket
id|dcb-&gt;target_lun
)braket
op_assign
id|dcb
suffix:semicolon
)brace
multiline_comment|/**&n; * adapter_remove_device - Removes the device instance from the adaptor&n; * instance. The device instance is not check in any way or freed by this. &n; * The caller is expected to take care of that. This will simply remove the&n; * device from the adapters data strcutures.&n; *&n; * @acb: The adapter device to be updated&n; * @dcb: A device that has previously been added to the adapter.&n; **/
DECL|function|adapter_remove_device
r_static
r_void
id|adapter_remove_device
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|i
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|tmp
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;adapter_remove_device: Remove device (ID %i, LUN %i): %p&bslash;n&quot;
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|dcb
)paren
suffix:semicolon
multiline_comment|/* fix up any pointers to this device that we have in the adapter */
r_if
c_cond
(paren
id|acb-&gt;active_dcb
op_eq
id|dcb
)paren
id|acb-&gt;active_dcb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;dcb_run_robin
op_eq
id|dcb
)paren
id|acb-&gt;dcb_run_robin
op_assign
id|dcb_get_next
c_func
(paren
op_amp
id|acb-&gt;dcb_list
comma
id|dcb
)paren
suffix:semicolon
multiline_comment|/* unlink from list */
id|list_for_each_entry_safe
c_func
(paren
id|i
comma
id|tmp
comma
op_amp
id|acb-&gt;dcb_list
comma
id|list
)paren
r_if
c_cond
(paren
id|dcb
op_eq
id|i
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|i-&gt;list
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* clear map and children */
id|acb-&gt;dcb_map
(braket
id|dcb-&gt;target_id
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|dcb-&gt;target_lun
)paren
suffix:semicolon
id|acb-&gt;children
(braket
id|dcb-&gt;target_id
)braket
(braket
id|dcb-&gt;target_lun
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dcb-&gt;acb
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * adapter_remove_and_free_device - Removes a single device from the adapter&n; * and then frees the device information.&n; *&n; * @acb: The adapter device to be updated&n; * @dcb: A device that has previously been added to the adapter.&n; */
DECL|function|adapter_remove_and_free_device
r_static
r_void
id|adapter_remove_and_free_device
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
r_struct
id|DeviceCtlBlk
op_star
id|dcb
)paren
(brace
r_if
c_cond
(paren
id|list_size
c_func
(paren
op_amp
id|dcb-&gt;srb_going_list
)paren
OG
l_int|1
)paren
(brace
id|dprintkdbg
c_func
(paren
id|DBG_DCB
comma
l_string|&quot;adapter_remove_and_free_device: &quot;
l_string|&quot;Won&squot;t remove because of %i active requests&bslash;n&quot;
comma
id|list_size
c_func
(paren
op_amp
id|dcb-&gt;srb_going_list
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|adapter_remove_device
c_func
(paren
id|acb
comma
id|dcb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dcb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * adapter_remove_and_free_all_devices - Removes and frees all of the&n; * devices associated with the specified adapter.&n; *&n; * @acb: The adapter from which all devices should be removed.&n; **/
DECL|function|adapter_remove_and_free_all_devices
r_static
r_void
id|adapter_remove_and_free_all_devices
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|tmp
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_DCB
comma
l_string|&quot;adapter_remove_and_free_all_devices: Free all devices (%i devices)&bslash;n&quot;
comma
id|list_size
c_func
(paren
op_amp
id|acb-&gt;dcb_list
)paren
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|dcb
comma
id|tmp
comma
op_amp
id|acb-&gt;dcb_list
comma
id|list
)paren
id|adapter_remove_and_free_device
c_func
(paren
id|acb
comma
id|dcb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * dc395x_slave_alloc - Called by the scsi mid layer to tell us about a new&n; * scsi device that we need to deal with. We allocate a new device and then&n; * insert that device into the adapters device list.&n; *&n; * @scsi_device: The new scsi device that we need to handle.&n; **/
DECL|function|dc395x_slave_alloc
r_static
r_int
id|dc395x_slave_alloc
c_func
(paren
r_struct
id|scsi_device
op_star
id|scsi_device
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|scsi_device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
id|dcb
op_assign
id|device_alloc
c_func
(paren
id|acb
comma
id|scsi_device-&gt;id
comma
id|scsi_device-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dcb
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|adapter_add_device
c_func
(paren
id|acb
comma
id|dcb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * dc395x_slave_destroy - Called by the scsi mid layer to tell us about a&n; * device that is going away.&n; *&n; * @scsi_device: The new scsi device that we need to handle.&n; **/
DECL|function|dc395x_slave_destroy
r_static
r_void
id|dc395x_slave_destroy
c_func
(paren
r_struct
id|scsi_device
op_star
id|scsi_device
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|scsi_device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|dcb
op_assign
id|find_dcb
c_func
(paren
id|acb
comma
id|scsi_device-&gt;id
comma
id|scsi_device-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dcb
)paren
id|adapter_remove_and_free_device
c_func
(paren
id|acb
comma
id|dcb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * trms1040_wait_30us: wait for 30 us&n; *&n; * Waits for 30us (using the chip by the looks of it..)&n; *&n; * @io_port: base I/O address&n; **/
DECL|function|trms1040_wait_30us
r_static
r_void
id|__init
id|trms1040_wait_30us
c_func
(paren
id|u16
id|io_port
)paren
(brace
multiline_comment|/* ScsiPortStallExecution(30); wait 30 us */
id|outb
c_func
(paren
l_int|5
comma
id|io_port
op_plus
id|TRM_S1040_GEN_TIMER
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_STATUS
)paren
op_amp
id|GTIMEOUT
)paren
)paren
multiline_comment|/* nothing */
suffix:semicolon
)brace
multiline_comment|/**&n; * trms1040_write_cmd - write the secified command and address to&n; * chip&n; *&n; * @io_port:&t;base I/O address&n; * @cmd:&t;SB + op code (command) to send&n; * @addr:&t;address to send&n; **/
DECL|function|trms1040_write_cmd
r_static
r_void
id|__init
id|trms1040_write_cmd
c_func
(paren
id|u16
id|io_port
comma
id|u8
id|cmd
comma
id|u8
id|addr
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
id|send_data
suffix:semicolon
multiline_comment|/* program SB + OP code */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
comma
id|cmd
op_lshift_assign
l_int|1
)paren
(brace
id|send_data
op_assign
id|NVR_SELECT
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_amp
l_int|0x04
)paren
multiline_comment|/* Start from bit 2 */
id|send_data
op_or_assign
id|NVR_BITOUT
suffix:semicolon
id|outb
c_func
(paren
id|send_data
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|send_data
op_or
id|NVR_CLOCK
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
)brace
multiline_comment|/* send address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
comma
id|addr
op_lshift_assign
l_int|1
)paren
(brace
id|send_data
op_assign
id|NVR_SELECT
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
l_int|0x40
)paren
multiline_comment|/* Start from bit 6 */
id|send_data
op_or_assign
id|NVR_BITOUT
suffix:semicolon
id|outb
c_func
(paren
id|send_data
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|send_data
op_or
id|NVR_CLOCK
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|NVR_SELECT
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * trms1040_set_data - store a single byte in the eeprom&n; *&n; * Called from write all to write a single byte into the SSEEPROM&n; * Which is done one bit at a time.&n; *&n; * @io_port:&t;base I/O address&n; * @addr:&t;offset into EEPROM&n; * @byte:&t;bytes to write&n; **/
DECL|function|trms1040_set_data
r_static
r_void
id|__init
id|trms1040_set_data
c_func
(paren
id|u16
id|io_port
comma
id|u8
id|addr
comma
id|u8
id|byte
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
id|send_data
suffix:semicolon
multiline_comment|/* Send write command &amp; address */
id|trms1040_write_cmd
c_func
(paren
id|io_port
comma
l_int|0x05
comma
id|addr
)paren
suffix:semicolon
multiline_comment|/* Write data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|byte
op_lshift_assign
l_int|1
)paren
(brace
id|send_data
op_assign
id|NVR_SELECT
suffix:semicolon
r_if
c_cond
(paren
id|byte
op_amp
l_int|0x80
)paren
multiline_comment|/* Start from bit 7 */
id|send_data
op_or_assign
id|NVR_BITOUT
suffix:semicolon
id|outb
c_func
(paren
id|send_data
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|send_data
op_or
id|NVR_CLOCK
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|NVR_SELECT
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
multiline_comment|/* Disable chip select */
id|outb
c_func
(paren
l_int|0
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NVR_SELECT
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
multiline_comment|/* Wait for write ready */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|outb
c_func
(paren
(paren
id|NVR_SELECT
op_or
id|NVR_CLOCK
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NVR_SELECT
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
op_amp
id|NVR_BITIN
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/*  Disable chip select */
id|outb
c_func
(paren
l_int|0
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * trms1040_write_all - write 128 bytes to the eeprom&n; *&n; * Write the supplied 128 bytes to the chips SEEPROM&n; *&n; * @eeprom:&t;the data to write&n; * @io_port:&t;the base io port&n; **/
DECL|function|trms1040_write_all
r_static
r_void
id|__init
id|trms1040_write_all
c_func
(paren
r_struct
id|NvRamType
op_star
id|eeprom
comma
id|u16
id|io_port
)paren
(brace
id|u8
op_star
id|b_eeprom
op_assign
(paren
id|u8
op_star
)paren
id|eeprom
suffix:semicolon
id|u8
id|addr
suffix:semicolon
multiline_comment|/* Enable SEEPROM */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
op_or
id|EN_EEPROM
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
suffix:semicolon
multiline_comment|/* write enable */
id|trms1040_write_cmd
c_func
(paren
id|io_port
comma
l_int|0x04
comma
l_int|0xFF
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
multiline_comment|/* write */
r_for
c_loop
(paren
id|addr
op_assign
l_int|0
suffix:semicolon
id|addr
OL
l_int|128
suffix:semicolon
id|addr
op_increment
comma
id|b_eeprom
op_increment
)paren
id|trms1040_set_data
c_func
(paren
id|io_port
comma
id|addr
comma
op_star
id|b_eeprom
)paren
suffix:semicolon
multiline_comment|/* write disable */
id|trms1040_write_cmd
c_func
(paren
id|io_port
comma
l_int|0x04
comma
l_int|0x00
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
multiline_comment|/* Disable SEEPROM */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
op_amp
op_complement
id|EN_EEPROM
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * trms1040_get_data - get a single byte from the eeprom&n; *&n; * Called from read all to read a single byte into the SSEEPROM&n; * Which is done one bit at a time.&n; *&n; * @io_port:&t;base I/O address&n; * @addr:&t;offset into SEEPROM&n; *&n; * Returns the the byte read.&n; **/
DECL|function|trms1040_get_data
r_static
id|u8
id|__init
id|trms1040_get_data
c_func
(paren
id|u16
id|io_port
comma
id|u8
id|addr
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
id|read_byte
suffix:semicolon
id|u8
id|result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Send read command &amp; address */
id|trms1040_write_cmd
c_func
(paren
id|io_port
comma
l_int|0x06
comma
id|addr
)paren
suffix:semicolon
multiline_comment|/* read data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
(paren
id|NVR_SELECT
op_or
id|NVR_CLOCK
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NVR_SELECT
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
multiline_comment|/* Get data bit while falling edge */
id|read_byte
op_assign
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|result
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|read_byte
op_amp
id|NVR_BITIN
)paren
id|result
op_or_assign
l_int|1
suffix:semicolon
id|trms1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable chip select */
id|outb
c_func
(paren
l_int|0
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/**&n; * trms1040_read_all - read all bytes from the eeprom&n; *&n; * Read the 128 bytes from the SEEPROM.&n; *&n; * @eeprom:&t;where to store the data&n; * @io_port:&t;the base io port&n; **/
DECL|function|trms1040_read_all
r_static
r_void
id|__init
id|trms1040_read_all
c_func
(paren
r_struct
id|NvRamType
op_star
id|eeprom
comma
id|u16
id|io_port
)paren
(brace
id|u8
op_star
id|b_eeprom
op_assign
(paren
id|u8
op_star
)paren
id|eeprom
suffix:semicolon
id|u8
id|addr
suffix:semicolon
multiline_comment|/* Enable SEEPROM */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
op_or
id|EN_EEPROM
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
suffix:semicolon
multiline_comment|/* read details */
r_for
c_loop
(paren
id|addr
op_assign
l_int|0
suffix:semicolon
id|addr
OL
l_int|128
suffix:semicolon
id|addr
op_increment
comma
id|b_eeprom
op_increment
)paren
op_star
id|b_eeprom
op_assign
id|trms1040_get_data
c_func
(paren
id|io_port
comma
id|addr
)paren
suffix:semicolon
multiline_comment|/* Disable SEEPROM */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
op_amp
op_complement
id|EN_EEPROM
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * check_eeprom - get and check contents of the eeprom&n; *&n; * Read seeprom 128 bytes into the memory provider in eeprom.&n; * Checks the checksum and if it&squot;s not correct it uses a set of default&n; * values.&n; *&n; * @eeprom:&t;caller allocated strcuture to read the eeprom data into&n; * @io_port:&t;io port to read from&n; **/
DECL|function|check_eeprom
r_static
r_void
id|__init
id|check_eeprom
c_func
(paren
r_struct
id|NvRamType
op_star
id|eeprom
comma
id|u16
id|io_port
)paren
(brace
id|u16
op_star
id|w_eeprom
op_assign
(paren
id|u16
op_star
)paren
id|eeprom
suffix:semicolon
id|u16
id|w_addr
suffix:semicolon
id|u16
id|cksum
suffix:semicolon
id|u32
id|d_addr
suffix:semicolon
id|u32
op_star
id|d_eeprom
suffix:semicolon
id|trms1040_read_all
c_func
(paren
id|eeprom
comma
id|io_port
)paren
suffix:semicolon
multiline_comment|/* read eeprom */
id|cksum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|w_addr
op_assign
l_int|0
comma
id|w_eeprom
op_assign
(paren
id|u16
op_star
)paren
id|eeprom
suffix:semicolon
id|w_addr
OL
l_int|64
suffix:semicolon
id|w_addr
op_increment
comma
id|w_eeprom
op_increment
)paren
id|cksum
op_add_assign
op_star
id|w_eeprom
suffix:semicolon
r_if
c_cond
(paren
id|cksum
op_ne
l_int|0x1234
)paren
(brace
multiline_comment|/*&n;&t;&t; * Checksum is wrong.&n;&t;&t; * Load a set of defaults into the eeprom buffer&n;&t;&t; */
id|dprintkl
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;EEProm checksum error: using default values and options.&bslash;n&quot;
)paren
suffix:semicolon
id|eeprom-&gt;sub_vendor_id
(braket
l_int|0
)braket
op_assign
(paren
id|u8
)paren
id|PCI_VENDOR_ID_TEKRAM
suffix:semicolon
id|eeprom-&gt;sub_vendor_id
(braket
l_int|1
)braket
op_assign
(paren
id|u8
)paren
(paren
id|PCI_VENDOR_ID_TEKRAM
op_rshift
l_int|8
)paren
suffix:semicolon
id|eeprom-&gt;sub_sys_id
(braket
l_int|0
)braket
op_assign
(paren
id|u8
)paren
id|PCI_DEVICE_ID_TEKRAM_TRMS1040
suffix:semicolon
id|eeprom-&gt;sub_sys_id
(braket
l_int|1
)braket
op_assign
(paren
id|u8
)paren
(paren
id|PCI_DEVICE_ID_TEKRAM_TRMS1040
op_rshift
l_int|8
)paren
suffix:semicolon
id|eeprom-&gt;sub_class
op_assign
l_int|0x00
suffix:semicolon
id|eeprom-&gt;vendor_id
(braket
l_int|0
)braket
op_assign
(paren
id|u8
)paren
id|PCI_VENDOR_ID_TEKRAM
suffix:semicolon
id|eeprom-&gt;vendor_id
(braket
l_int|1
)braket
op_assign
(paren
id|u8
)paren
(paren
id|PCI_VENDOR_ID_TEKRAM
op_rshift
l_int|8
)paren
suffix:semicolon
id|eeprom-&gt;device_id
(braket
l_int|0
)braket
op_assign
(paren
id|u8
)paren
id|PCI_DEVICE_ID_TEKRAM_TRMS1040
suffix:semicolon
id|eeprom-&gt;device_id
(braket
l_int|1
)braket
op_assign
(paren
id|u8
)paren
(paren
id|PCI_DEVICE_ID_TEKRAM_TRMS1040
op_rshift
l_int|8
)paren
suffix:semicolon
id|eeprom-&gt;reserved
op_assign
l_int|0x00
suffix:semicolon
r_for
c_loop
(paren
id|d_addr
op_assign
l_int|0
comma
id|d_eeprom
op_assign
(paren
id|u32
op_star
)paren
id|eeprom-&gt;target
suffix:semicolon
id|d_addr
OL
l_int|16
suffix:semicolon
id|d_addr
op_increment
comma
id|d_eeprom
op_increment
)paren
op_star
id|d_eeprom
op_assign
l_int|0x00000077
suffix:semicolon
multiline_comment|/* cfg3,cfg2,period,cfg0 */
op_star
id|d_eeprom
op_increment
op_assign
l_int|0x04000F07
suffix:semicolon
multiline_comment|/* max_tag,delay_time,channel_cfg,scsi_id */
op_star
id|d_eeprom
op_increment
op_assign
l_int|0x00000015
suffix:semicolon
multiline_comment|/* reserved1,boot_lun,boot_target,reserved0 */
r_for
c_loop
(paren
id|d_addr
op_assign
l_int|0
suffix:semicolon
id|d_addr
OL
l_int|12
suffix:semicolon
id|d_addr
op_increment
comma
id|d_eeprom
op_increment
)paren
op_star
id|d_eeprom
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Now load defaults (maybe set by boot/module params) */
id|set_safe_settings
c_func
(paren
)paren
suffix:semicolon
id|fix_settings
c_func
(paren
)paren
suffix:semicolon
id|eeprom_override
c_func
(paren
id|eeprom
)paren
suffix:semicolon
id|eeprom-&gt;cksum
op_assign
l_int|0x00
suffix:semicolon
r_for
c_loop
(paren
id|w_addr
op_assign
l_int|0
comma
id|cksum
op_assign
l_int|0
comma
id|w_eeprom
op_assign
(paren
id|u16
op_star
)paren
id|eeprom
suffix:semicolon
id|w_addr
OL
l_int|63
suffix:semicolon
id|w_addr
op_increment
comma
id|w_eeprom
op_increment
)paren
id|cksum
op_add_assign
op_star
id|w_eeprom
suffix:semicolon
op_star
id|w_eeprom
op_assign
l_int|0x1234
op_minus
id|cksum
suffix:semicolon
id|trms1040_write_all
c_func
(paren
id|eeprom
comma
id|io_port
)paren
suffix:semicolon
id|eeprom-&gt;delay_time
op_assign
id|cfg_data
(braket
id|CFG_RESET_DELAY
)braket
dot
id|value
suffix:semicolon
)brace
r_else
(brace
id|set_safe_settings
c_func
(paren
)paren
suffix:semicolon
id|eeprom_index_to_delay
c_func
(paren
id|eeprom
)paren
suffix:semicolon
id|eeprom_override
c_func
(paren
id|eeprom
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * print_eeprom_settings - output the eeprom settings&n; * to the kernel log so people can see what they were.&n; *&n; * @eeprom: The eeprom data strucutre to show details for.&n; **/
DECL|function|print_eeprom_settings
r_static
r_void
id|__init
id|print_eeprom_settings
c_func
(paren
r_struct
id|NvRamType
op_star
id|eeprom
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Used settings: AdapterID=%02i, Speed=%i(%02i.%01iMHz), dev_mode=0x%02x&bslash;n&quot;
comma
id|eeprom-&gt;scsi_id
comma
id|eeprom-&gt;target
(braket
l_int|0
)braket
dot
id|period
comma
id|clock_speed
(braket
id|eeprom-&gt;target
(braket
l_int|0
)braket
dot
id|period
)braket
op_div
l_int|10
comma
id|clock_speed
(braket
id|eeprom-&gt;target
(braket
l_int|0
)braket
dot
id|period
)braket
op_mod
l_int|10
comma
id|eeprom-&gt;target
(braket
l_int|0
)braket
dot
id|cfg0
)paren
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;               AdaptMode=0x%02x, Tags=%i(%02i), DelayReset=%is&bslash;n&quot;
comma
id|eeprom-&gt;channel_cfg
comma
id|eeprom-&gt;max_tag
comma
l_int|1
op_lshift
id|eeprom-&gt;max_tag
comma
id|eeprom-&gt;delay_time
)paren
suffix:semicolon
)brace
multiline_comment|/* Free SG tables */
DECL|function|adapter_sg_tables_free
r_static
r_void
id|adapter_sg_tables_free
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_int
id|i
suffix:semicolon
r_const
r_int
id|srbs_per_page
op_assign
id|PAGE_SIZE
op_div
id|SEGMENTX_LEN
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DC395x_MAX_SRB_CNT
suffix:semicolon
id|i
op_add_assign
id|srbs_per_page
)paren
r_if
c_cond
(paren
id|acb-&gt;srb_array
(braket
id|i
)braket
dot
id|segment_x
)paren
id|kfree
c_func
(paren
id|acb-&gt;srb_array
(braket
id|i
)braket
dot
id|segment_x
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate SG tables; as we have to pci_map them, an SG list (struct SGentry*)&n; * should never cross a page boundary */
DECL|function|adapter_sg_tables_alloc
r_static
r_int
id|__init
id|adapter_sg_tables_alloc
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_const
r_int
id|mem_needed
op_assign
(paren
id|DC395x_MAX_SRB_CNT
op_plus
l_int|1
)paren
op_star
id|SEGMENTX_LEN
suffix:semicolon
r_int
id|pages
op_assign
(paren
id|mem_needed
op_plus
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_div
id|PAGE_SIZE
suffix:semicolon
r_const
r_int
id|srbs_per_page
op_assign
id|PAGE_SIZE
op_div
id|SEGMENTX_LEN
suffix:semicolon
r_int
id|srb_idx
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_struct
id|SGentry
op_star
id|ptr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DC395x_MAX_SRB_CNT
suffix:semicolon
id|i
op_increment
)paren
id|acb-&gt;srb_array
(braket
id|i
)braket
dot
id|segment_x
op_assign
l_int|NULL
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_1
comma
l_string|&quot;Allocate %i pages for SG tables&bslash;n&quot;
comma
id|pages
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pages
op_decrement
)paren
(brace
id|ptr
op_assign
(paren
r_struct
id|SGentry
op_star
)paren
id|kmalloc
c_func
(paren
id|PAGE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
(brace
id|adapter_sg_tables_free
c_func
(paren
id|acb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dprintkdbg
c_func
(paren
id|DBG_1
comma
l_string|&quot;Allocate %li bytes at %p for SG segments %i&bslash;n&quot;
comma
id|PAGE_SIZE
comma
id|ptr
comma
id|srb_idx
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|srbs_per_page
op_logical_and
id|srb_idx
OL
id|DC395x_MAX_SRB_CNT
)paren
id|acb-&gt;srb_array
(braket
id|srb_idx
op_increment
)braket
dot
id|segment_x
op_assign
id|ptr
op_plus
(paren
id|i
op_increment
op_star
id|DC395x_MAX_SG_LISTENTRY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|srbs_per_page
)paren
id|acb-&gt;srb.segment_x
op_assign
id|ptr
op_plus
(paren
id|i
op_star
id|DC395x_MAX_SG_LISTENTRY
)paren
suffix:semicolon
r_else
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;No space for tmsrb SG table reserved?!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * adapter_print_config - print adapter connection and termination&n; * config&n; *&n; * The io port in the adapter needs to have been set before calling&n; * this function.&n; *&n; * @acb: The adapter to print the information for.&n; **/
DECL|function|adapter_print_config
r_static
r_void
id|__init
id|adapter_print_config
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
id|u8
id|bval
suffix:semicolon
id|bval
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_GEN_STATUS
)paren
suffix:semicolon
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;%s Connectors: &quot;
comma
(paren
(paren
id|bval
op_amp
id|WIDESCSI
)paren
ques
c_cond
l_string|&quot;(Wide)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
id|CON5068
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;ext%s &quot;
comma
op_logical_neg
(paren
id|bval
op_amp
id|EXT68HIGH
)paren
ques
c_cond
l_string|&quot;68&quot;
suffix:colon
l_string|&quot;50&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
id|CON68
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;int68%s &quot;
comma
op_logical_neg
(paren
id|bval
op_amp
id|INT68HIGH
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;(50)&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
id|CON50
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;int50 &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bval
op_amp
(paren
id|CON5068
op_or
id|CON50
op_or
id|CON68
)paren
)paren
op_eq
l_int|0
multiline_comment|/*(CON5068 | CON50 | CON68) */
)paren
id|printk
c_func
(paren
l_string|&quot; Oops! (All 3?) &quot;
)paren
suffix:semicolon
id|bval
op_assign
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_GEN_CONTROL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; Termination: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_amp
id|DIS_TERM
)paren
id|printk
c_func
(paren
l_string|&quot;Disabled&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|bval
op_amp
id|AUTOTERM
)paren
id|printk
c_func
(paren
l_string|&quot;Auto &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_amp
id|LOW8TERM
)paren
id|printk
c_func
(paren
l_string|&quot;Low &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_amp
id|UP8TERM
)paren
id|printk
c_func
(paren
l_string|&quot;High &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * adapter_init_params - Initialize the various parameters in the&n; * adapter structure. Note that the pointer to the scsi_host is set&n; * early (when this instance is created) and the io_port and irq&n; * values are set later after they have been reserved. This just gets&n; * everything set to a good starting position.&n; *&n; * The eeprom structure in the adapter needs to have been set before&n; * calling this function.&n; *&n; * @acb: The adapter to initialize.&n; **/
DECL|function|adapter_init_params
r_static
r_void
id|__init
id|adapter_init_params
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_struct
id|NvRamType
op_star
id|eeprom
op_assign
op_amp
id|acb-&gt;eeprom
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* NOTE: acb-&gt;scsi_host is set at scsi_host/acb creation time */
multiline_comment|/* NOTE: acb-&gt;io_port_base is set at port registration time */
multiline_comment|/* NOTE: acb-&gt;io_port_len is set at port registration time */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|acb-&gt;dcb_list
)paren
suffix:semicolon
id|acb-&gt;dcb_run_robin
op_assign
l_int|NULL
suffix:semicolon
id|acb-&gt;active_dcb
op_assign
l_int|NULL
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|acb-&gt;srb_free_list
)paren
suffix:semicolon
multiline_comment|/*  temp SRB for Q tag used or abort command used  */
id|acb-&gt;tmp_srb
op_assign
op_amp
id|acb-&gt;srb
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|acb-&gt;selto_timer
)paren
suffix:semicolon
id|acb-&gt;srb_count
op_assign
id|DC395x_MAX_SRB_CNT
suffix:semicolon
id|acb-&gt;sel_timeout
op_assign
id|DC395x_SEL_TIMEOUT
suffix:semicolon
multiline_comment|/* timeout=250ms */
multiline_comment|/* NOTE: acb-&gt;irq_level is set at IRQ registration time */
id|acb-&gt;tag_max_num
op_assign
l_int|1
op_lshift
id|eeprom-&gt;max_tag
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;tag_max_num
OG
l_int|30
)paren
id|acb-&gt;tag_max_num
op_assign
l_int|30
suffix:semicolon
id|acb-&gt;acb_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* RESET_DETECT, RESET_DONE, RESET_DEV */
id|acb-&gt;gmode2
op_assign
id|eeprom-&gt;channel_cfg
suffix:semicolon
id|acb-&gt;config
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* NOTE: actually set in adapter_init_chip */
r_if
c_cond
(paren
id|eeprom-&gt;channel_cfg
op_amp
id|NAC_SCANLUN
)paren
id|acb-&gt;lun_chk
op_assign
l_int|1
suffix:semicolon
id|acb-&gt;scan_devices
op_assign
l_int|1
suffix:semicolon
id|acb-&gt;scsi_host-&gt;this_id
op_assign
id|eeprom-&gt;scsi_id
suffix:semicolon
id|acb-&gt;hostid_bit
op_assign
(paren
l_int|1
op_lshift
id|acb-&gt;scsi_host-&gt;this_id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DC395x_MAX_SCSI_ID
suffix:semicolon
id|i
op_increment
)paren
id|acb-&gt;dcb_map
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|acb-&gt;msg_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* link static array of srbs into the srb free list */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|acb-&gt;srb_count
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|srb_free_insert
c_func
(paren
id|acb
comma
op_amp
id|acb-&gt;srb_array
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * adapter_init_host - Initialize the scsi host instance based on&n; * values that we have already stored in the adapter instance. There&squot;s&n; * some mention that a lot of these are deprecated, so we won&squot;t use&n; * them (we&squot;ll use the ones in the adapter instance) but we&squot;ll fill&n; * them in in case something else needs them.&n; *&n; * The eeprom structure, irq and io ports in the adapter need to have&n; * been set before calling this function.&n; *&n; * @host: The scsi host instance to fill in the values for.&n; **/
DECL|function|adapter_init_scsi_host
r_static
r_void
id|__init
id|adapter_init_scsi_host
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|NvRamType
op_star
id|eeprom
op_assign
op_amp
id|acb-&gt;eeprom
suffix:semicolon
id|host-&gt;max_cmd_len
op_assign
l_int|24
suffix:semicolon
id|host-&gt;can_queue
op_assign
id|DC395x_MAX_CMD_QUEUE
suffix:semicolon
id|host-&gt;cmd_per_lun
op_assign
id|DC395x_MAX_CMD_PER_LUN
suffix:semicolon
id|host-&gt;this_id
op_assign
(paren
r_int
)paren
id|eeprom-&gt;scsi_id
suffix:semicolon
id|host-&gt;io_port
op_assign
id|acb-&gt;io_port_base
suffix:semicolon
id|host-&gt;n_io_port
op_assign
id|acb-&gt;io_port_len
suffix:semicolon
id|host-&gt;dma_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|acb-&gt;io_port_base
suffix:semicolon
id|host-&gt;irq
op_assign
id|acb-&gt;irq_level
suffix:semicolon
id|host-&gt;last_reset
op_assign
id|jiffies
suffix:semicolon
id|host-&gt;max_id
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;max_id
op_minus
l_int|1
op_eq
id|eeprom-&gt;scsi_id
)paren
id|host-&gt;max_id
op_decrement
suffix:semicolon
macro_line|#ifdef CONFIG_SCSI_MULTI_LUN
r_if
c_cond
(paren
id|eeprom-&gt;channel_cfg
op_amp
id|NAC_SCANLUN
)paren
id|host-&gt;max_lun
op_assign
l_int|8
suffix:semicolon
r_else
id|host-&gt;max_lun
op_assign
l_int|1
suffix:semicolon
macro_line|#else
id|host-&gt;max_lun
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/**&n; * adapter_init_chip - Get the chip into a know state and figure out&n; * some of the settings that apply to this adapter.&n; *&n; * The io port in the adapter needs to have been set before calling&n; * this function. The config will be configured correctly on return.&n; *&n; * @acb: The adapter which we are to init.&n; **/
DECL|function|adapter_init_chip
r_void
id|__init
id|adapter_init_chip
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_struct
id|NvRamType
op_star
id|eeprom
op_assign
op_amp
id|acb-&gt;eeprom
suffix:semicolon
multiline_comment|/* Mask all the interrupt */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_INTEN
comma
l_int|0x00
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_INTEN
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Reset SCSI module */
id|DC395x_write16
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_RSTMODULE
)paren
suffix:semicolon
multiline_comment|/* Reset PCI/DMA module */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_CONTROL
comma
id|DMARESETMODULE
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* program configuration 0 */
id|acb-&gt;config
op_assign
id|HCC_AUTOTERM
op_or
id|HCC_PARITY
suffix:semicolon
r_if
c_cond
(paren
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_GEN_STATUS
)paren
op_amp
id|WIDESCSI
)paren
id|acb-&gt;config
op_or_assign
id|HCC_WIDE_CARD
suffix:semicolon
r_if
c_cond
(paren
id|eeprom-&gt;channel_cfg
op_amp
id|NAC_POWERON_SCSI_RESET
)paren
id|acb-&gt;config
op_or_assign
id|HCC_SCSI_RESET
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;config
op_amp
id|HCC_SCSI_RESET
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Performing initial SCSI bus reset&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_RSTSCSI
)paren
suffix:semicolon
multiline_comment|/*while (!( DC395x_read8(acb, TRM_S1040_SCSI_INTSTATUS) &amp; INT_SCSIRESET )); */
multiline_comment|/*spin_unlock_irq (&amp;io_request_lock); */
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|acb-&gt;scsi_host-&gt;last_reset
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|acb-&gt;eeprom.delay_time
suffix:semicolon
multiline_comment|/*spin_lock_irq (&amp;io_request_lock); */
)brace
)brace
multiline_comment|/**&n; * init_adapter - Grab the resource for the card, setup the adapter&n; * information, set the card into a known state, create the various&n; * tables etc etc. This basically gets all adapter information all up&n; * to date, intialised and gets the chip in sync with it.&n; *&n; * @host:&t;This hosts adapter structure&n; * @io_port:&t;The base I/O port&n; * @irq:&t;IRQ&n; *&n; * Returns 0 if the initialization succeeds, any other value on&n; * failure.&n; **/
DECL|function|adapter_init
r_static
r_int
id|__init
id|adapter_init
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
comma
id|u32
id|io_port
comma
id|u32
id|io_port_len
comma
id|u8
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|io_port
comma
id|io_port_len
comma
id|DC395X_NAME
)paren
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Failed to reserve IO region 0x%x&bslash;n&quot;
comma
id|io_port
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
multiline_comment|/* store port base to indicate we have registered it */
id|acb-&gt;io_port_base
op_assign
id|io_port
suffix:semicolon
id|acb-&gt;io_port_len
op_assign
id|io_port_len
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|dc395x_interrupt
comma
id|SA_SHIRQ
comma
id|DC395X_NAME
comma
id|acb
)paren
)paren
(brace
multiline_comment|/* release the region we just claimed */
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Failed to register IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
multiline_comment|/* store irq to indicate we have registered it */
id|acb-&gt;irq_level
op_assign
id|irq
suffix:semicolon
multiline_comment|/* get eeprom configuration information and command line settings etc */
id|check_eeprom
c_func
(paren
op_amp
id|acb-&gt;eeprom
comma
(paren
id|u16
)paren
id|io_port
)paren
suffix:semicolon
id|print_eeprom_settings
c_func
(paren
op_amp
id|acb-&gt;eeprom
)paren
suffix:semicolon
multiline_comment|/* setup adapter control block */
id|adapter_init_params
c_func
(paren
id|acb
)paren
suffix:semicolon
multiline_comment|/* display card connectors/termination settings */
id|adapter_print_config
c_func
(paren
id|acb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter_sg_tables_alloc
c_func
(paren
id|acb
)paren
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Memory allocation for SG tables failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|adapter_init_scsi_host
c_func
(paren
id|acb-&gt;scsi_host
)paren
suffix:semicolon
id|adapter_init_chip
c_func
(paren
id|acb
)paren
suffix:semicolon
id|set_basic_config
c_func
(paren
id|acb
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;adapter_init: acb=%p, pdcb_map=%p &quot;
l_string|&quot;psrb_array=%p ACB size=%04x, DCB size=%04x &quot;
l_string|&quot;SRB size=%04x&bslash;n&quot;
comma
id|acb
comma
id|acb-&gt;dcb_map
comma
id|acb-&gt;srb_array
comma
r_sizeof
(paren
r_struct
id|AdapterCtlBlk
)paren
comma
r_sizeof
(paren
r_struct
id|DeviceCtlBlk
)paren
comma
r_sizeof
(paren
r_struct
id|ScsiReqBlk
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed
suffix:colon
r_if
c_cond
(paren
id|acb-&gt;irq_level
)paren
id|free_irq
c_func
(paren
id|acb-&gt;irq_level
comma
id|acb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;io_port_base
)paren
id|release_region
c_func
(paren
id|acb-&gt;io_port_base
comma
id|acb-&gt;io_port_len
)paren
suffix:semicolon
id|adapter_sg_tables_free
c_func
(paren
id|acb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * adapter_uninit_chip - cleanly shut down the scsi controller chip,&n; * stopping all operations and disabling interrupt generation on the&n; * card.&n; *&n; * @acb: The adapter which we are to shutdown.&n; **/
DECL|function|adapter_uninit_chip
r_static
r_void
id|adapter_uninit_chip
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
multiline_comment|/* disable interrupts */
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_DMA_INTEN
comma
l_int|0
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_INTEN
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reset the scsi bus */
r_if
c_cond
(paren
id|acb-&gt;config
op_amp
id|HCC_SCSI_RESET
)paren
id|reset_scsi_bus
c_func
(paren
id|acb
)paren
suffix:semicolon
multiline_comment|/* clear any pending interupt state */
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_INTSTATUS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * adapter_uninit - Shut down the chip and release any resources that&n; * we had allocated. Once this returns the adapter should not be used&n; * anymore.&n; *&n; * @acb: The adapter which we are to un-initialize.&n; **/
DECL|function|adapter_uninit
r_static
r_void
id|adapter_uninit
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|acb
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DC395x_LOCK_IO
c_func
(paren
id|acb-&gt;scsi_host
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* remove timers */
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|acb-&gt;selto_timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|acb-&gt;selto_timer
)paren
suffix:semicolon
id|adapter_uninit_chip
c_func
(paren
id|acb
)paren
suffix:semicolon
id|adapter_remove_and_free_all_devices
c_func
(paren
id|acb
)paren
suffix:semicolon
id|DC395x_UNLOCK_IO
c_func
(paren
id|acb-&gt;scsi_host
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;irq_level
)paren
id|free_irq
c_func
(paren
id|acb-&gt;irq_level
comma
id|acb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acb-&gt;io_port_base
)paren
id|release_region
c_func
(paren
id|acb-&gt;io_port_base
comma
id|acb-&gt;io_port_len
)paren
suffix:semicolon
id|adapter_sg_tables_free
c_func
(paren
id|acb
)paren
suffix:semicolon
)brace
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
DECL|macro|SPRINTF
mdefine_line|#define SPRINTF(args...) pos += sprintf(pos, args)
DECL|macro|YESNO
macro_line|#undef YESNO
DECL|macro|YESNO
mdefine_line|#define YESNO(YN) &bslash;&n; if (YN) SPRINTF(&quot; Yes &quot;);&bslash;&n; else SPRINTF(&quot; No  &quot;)
DECL|function|dc395x_proc_info
r_static
r_int
id|dc395x_proc_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|inout
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
r_int
id|spd
comma
id|spd1
suffix:semicolon
r_char
op_star
id|pos
op_assign
id|buffer
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|dcb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|inout
)paren
multiline_comment|/* Has data been written to the file ? */
r_return
op_minus
id|EPERM
suffix:semicolon
id|SPRINTF
c_func
(paren
id|DC395X_BANNER
l_string|&quot; PCI SCSI Host Adapter&bslash;n&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot; Driver Version &quot;
id|DC395X_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_LOCK_IO
c_func
(paren
id|acb-&gt;scsi_host
comma
id|flags
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SCSI Host Nr %i, &quot;
comma
id|host-&gt;host_no
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;DC395U/UW/F DC315/U %s&bslash;n&quot;
comma
(paren
id|acb-&gt;config
op_amp
id|HCC_WIDE_CARD
)paren
ques
c_cond
l_string|&quot;Wide&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;io_port_base 0x%04x, &quot;
comma
id|acb-&gt;io_port_base
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;irq_level 0x%02x, &quot;
comma
id|acb-&gt;irq_level
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot; SelTimeout %ims&bslash;n&quot;
comma
(paren
l_int|1638
op_star
id|acb-&gt;sel_timeout
)paren
op_div
l_int|1000
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;MaxID %i, MaxLUN %i, &quot;
comma
id|host-&gt;max_id
comma
id|host-&gt;max_lun
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;AdapterID %i&bslash;n&quot;
comma
id|host-&gt;this_id
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;tag_max_num %i&quot;
comma
id|acb-&gt;tag_max_num
)paren
suffix:semicolon
multiline_comment|/*SPRINTF(&quot;, DMA_Status %i&bslash;n&quot;, DC395x_read8(acb, TRM_S1040_DMA_STATUS)); */
id|SPRINTF
c_func
(paren
l_string|&quot;, FilterCfg 0x%02x&quot;
comma
id|DC395x_read8
c_func
(paren
id|acb
comma
id|TRM_S1040_SCSI_CONFIG1
)paren
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;, DelayReset %is&bslash;n&quot;
comma
id|acb-&gt;eeprom.delay_time
)paren
suffix:semicolon
multiline_comment|/*SPRINTF(&quot;&bslash;n&quot;); */
id|SPRINTF
c_func
(paren
l_string|&quot;Nr of DCBs: %i&bslash;n&quot;
comma
id|list_size
c_func
(paren
op_amp
id|acb-&gt;dcb_list
)paren
)paren
suffix:semicolon
id|SPRINTF
(paren
l_string|&quot;Map of attached LUNs: %02x %02x %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|acb-&gt;dcb_map
(braket
l_int|0
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|1
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|2
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|3
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|4
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|5
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|6
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|SPRINTF
(paren
l_string|&quot;                      %02x %02x %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|acb-&gt;dcb_map
(braket
l_int|8
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|9
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|10
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|11
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|12
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|13
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|14
)braket
comma
id|acb-&gt;dcb_map
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|SPRINTF
(paren
l_string|&quot;Un ID LUN Prty Sync Wide DsCn SndS TagQ nego_period SyncFreq SyncOffs MaxCmd&bslash;n&quot;
)paren
suffix:semicolon
id|dev
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dcb
comma
op_amp
id|acb-&gt;dcb_list
comma
id|list
)paren
(brace
r_int
id|nego_period
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%02i %02i  %02i &quot;
comma
id|dev
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_PARITY_CHK
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|dcb-&gt;sync_offset
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|dcb-&gt;sync_period
op_amp
id|WIDE_SYNC
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_DISCONNECT
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|dcb-&gt;dev_mode
op_amp
id|NTC_DO_SEND_START
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|dcb-&gt;sync_mode
op_amp
id|EN_TAG_QUEUEING
)paren
suffix:semicolon
id|nego_period
op_assign
id|clock_period
(braket
id|dcb-&gt;sync_period
op_amp
l_int|0x07
)braket
op_lshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|dcb-&gt;sync_offset
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;  %03i ns &quot;
comma
id|nego_period
)paren
suffix:semicolon
r_else
id|SPRINTF
c_func
(paren
l_string|&quot; (%03i ns)&quot;
comma
(paren
id|dcb-&gt;min_nego_period
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dcb-&gt;sync_offset
op_amp
l_int|0x0f
)paren
(brace
id|spd
op_assign
l_int|1000
op_div
(paren
id|nego_period
)paren
suffix:semicolon
id|spd1
op_assign
l_int|1000
op_mod
(paren
id|nego_period
)paren
suffix:semicolon
id|spd1
op_assign
(paren
id|spd1
op_star
l_int|10
op_plus
id|nego_period
op_div
l_int|2
)paren
op_div
(paren
id|nego_period
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;   %2i.%1i M     %02i &quot;
comma
id|spd
comma
id|spd1
comma
(paren
id|dcb-&gt;sync_offset
op_amp
l_int|0x0f
)paren
)paren
suffix:semicolon
)brace
r_else
id|SPRINTF
c_func
(paren
l_string|&quot;                 &quot;
)paren
suffix:semicolon
multiline_comment|/* Add more info ... */
id|SPRINTF
c_func
(paren
l_string|&quot;     %02i&bslash;n&quot;
comma
id|dcb-&gt;max_command
)paren
suffix:semicolon
id|dev
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|acb-&gt;waiting_timer
)paren
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;Waiting queue timer running&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dcb
comma
op_amp
id|acb-&gt;dcb_list
comma
id|list
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|srb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dcb-&gt;srb_waiting_list
)paren
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;DCB (%02i-%i): Waiting: %i:&quot;
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|list_size
c_func
(paren
op_amp
id|dcb-&gt;srb_waiting_list
)paren
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|srb
comma
op_amp
id|dcb-&gt;srb_waiting_list
comma
id|list
)paren
id|SPRINTF
c_func
(paren
l_string|&quot; %li&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dcb-&gt;srb_going_list
)paren
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;nDCB (%02i-%i): Going  : %i:&quot;
comma
id|dcb-&gt;target_id
comma
id|dcb-&gt;target_lun
comma
id|list_size
c_func
(paren
op_amp
id|dcb-&gt;srb_going_list
)paren
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|srb
comma
op_amp
id|dcb-&gt;srb_going_list
comma
id|list
)paren
id|SPRINTF
c_func
(paren
l_string|&quot; %li&quot;
comma
id|srb-&gt;cmd-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dcb-&gt;srb_waiting_list
)paren
op_logical_or
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dcb-&gt;srb_going_list
)paren
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug_enabled
c_func
(paren
id|DBG_DCB
)paren
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;DCB list for ACB %p:&bslash;n&quot;
comma
id|acb
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dcb
comma
op_amp
id|acb-&gt;dcb_list
comma
id|list
)paren
(brace
id|SPRINTF
c_func
(paren
l_string|&quot;%p -&gt; &quot;
comma
id|dcb
)paren
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;END&bslash;n&quot;
)paren
suffix:semicolon
)brace
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
id|DC395x_UNLOCK_IO
c_func
(paren
id|acb-&gt;scsi_host
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_minus
id|buffer
OL
id|offset
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pos
op_minus
id|buffer
op_minus
id|offset
OL
id|length
)paren
r_return
id|pos
op_minus
id|buffer
op_minus
id|offset
suffix:semicolon
r_else
r_return
id|length
suffix:semicolon
)brace
DECL|variable|dc395x_driver_template
r_static
id|Scsi_Host_Template
id|dc395x_driver_template
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|proc_name
op_assign
id|DC395X_NAME
comma
dot
id|proc_info
op_assign
id|dc395x_proc_info
comma
dot
id|name
op_assign
id|DC395X_BANNER
l_string|&quot; &quot;
id|DC395X_VERSION
comma
dot
id|queuecommand
op_assign
id|dc395x_queue_command
comma
dot
id|bios_param
op_assign
id|dc395x_bios_param
comma
dot
id|slave_alloc
op_assign
id|dc395x_slave_alloc
comma
dot
id|slave_destroy
op_assign
id|dc395x_slave_destroy
comma
dot
id|can_queue
op_assign
id|DC395x_MAX_CAN_QUEUE
comma
dot
id|this_id
op_assign
l_int|7
comma
dot
id|sg_tablesize
op_assign
id|DC395x_MAX_SG_TABLESIZE
comma
dot
id|cmd_per_lun
op_assign
id|DC395x_MAX_CMD_PER_LUN
comma
dot
id|eh_abort_handler
op_assign
id|dc395x_eh_abort
comma
dot
id|eh_bus_reset_handler
op_assign
id|dc395x_eh_bus_reset
comma
dot
id|unchecked_isa_dma
op_assign
l_int|0
comma
dot
id|use_clustering
op_assign
id|DISABLE_CLUSTERING
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * banner_display - Display banner on first instance of driver&n; * initialized.&n; **/
DECL|function|banner_display
r_static
r_void
id|banner_display
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|banner_done
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|banner_done
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;%s %s&bslash;n&quot;
comma
id|DC395X_BANNER
comma
id|DC395X_VERSION
)paren
suffix:semicolon
id|banner_done
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * dc395x_init_one - Initialise a single instance of the adapter.&n; *&n; * The PCI layer will call this once for each instance of the adapter&n; * that it finds in the system. The pci_dev strcuture indicates which&n; * instance we are being called from.&n; * &n; * @dev: The PCI device to intialize.&n; * @id: Looks like a pointer to the entry in our pci device table&n; * that was actually matched by the PCI subsystem.&n; *&n; * Returns 0 on success, or an error code (-ve) on failure.&n; **/
DECL|function|dc395x_init_one
r_static
r_int
id|__devinit
id|dc395x_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|scsi_host
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|acb
suffix:semicolon
r_int
r_int
id|io_port_base
suffix:semicolon
r_int
r_int
id|io_port_len
suffix:semicolon
id|u8
id|irq
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;Init one instance (%s)&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|banner_display
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;PCI Enable device failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|io_port_base
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|io_port_len
op_assign
id|pci_resource_len
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;IO_PORT=%04x, IRQ=%x&bslash;n&quot;
comma
id|io_port_base
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* allocate scsi host information (includes out adapter) */
id|scsi_host
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|dc395x_driver_template
comma
r_sizeof
(paren
r_struct
id|AdapterCtlBlk
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_host
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;scsi_host_alloc failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|scsi_host-&gt;hostdata
suffix:semicolon
id|acb-&gt;scsi_host
op_assign
id|scsi_host
suffix:semicolon
multiline_comment|/* initialise the adapter and everything we need */
r_if
c_cond
(paren
id|adapter_init
c_func
(paren
id|acb
comma
id|io_port_base
comma
id|io_port_len
comma
id|irq
)paren
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;DC395x_initAdapter initial ERROR&bslash;n&quot;
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|scsi_host
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* get the scsi mid level to scan for new devices on the bus */
r_if
c_cond
(paren
id|scsi_add_host
c_func
(paren
id|scsi_host
comma
op_amp
id|dev-&gt;dev
)paren
)paren
(brace
id|dprintkl
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;scsi_add_host failed&bslash;n&quot;
)paren
suffix:semicolon
id|adapter_uninit
c_func
(paren
id|acb
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|scsi_host
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|dev
comma
id|scsi_host
)paren
suffix:semicolon
id|scsi_scan_host
c_func
(paren
id|scsi_host
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * dc395x_remove_one - Called to remove a single instance of the&n; * adapter.&n; *&n; * @dev: The PCI device to intialize.&n; **/
DECL|function|dc395x_remove_one
r_static
r_void
id|__devexit
id|dc395x_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|scsi_host
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|acb
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
(paren
id|scsi_host-&gt;hostdata
)paren
suffix:semicolon
id|dprintkdbg
c_func
(paren
id|DBG_0
comma
l_string|&quot;Removing instance&bslash;n&quot;
)paren
suffix:semicolon
id|scsi_remove_host
c_func
(paren
id|scsi_host
)paren
suffix:semicolon
id|adapter_uninit
c_func
(paren
id|acb
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|scsi_host
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|dc395x_pci_table
r_static
r_struct
id|pci_device_id
id|dc395x_pci_table
(braket
)braket
op_assign
(brace
(brace
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_TEKRAM
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_TEKRAM_TRMS1040
comma
dot
id|subvendor
op_assign
id|PCI_ANY_ID
comma
dot
id|subdevice
op_assign
id|PCI_ANY_ID
comma
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|dc395x_pci_table
)paren
suffix:semicolon
DECL|variable|dc395x_driver
r_static
r_struct
id|pci_driver
id|dc395x_driver
op_assign
(brace
dot
id|name
op_assign
id|DC395X_NAME
comma
dot
id|id_table
op_assign
id|dc395x_pci_table
comma
dot
id|probe
op_assign
id|dc395x_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|dc395x_remove_one
)paren
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * dc395x_module_init - Module initialization function&n; *&n; * Used by both module and built-in driver to initialise this driver.&n; **/
DECL|function|dc395x_module_init
r_static
r_int
id|__init
id|dc395x_module_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|dc395x_driver
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * dc395x_module_exit - Module cleanup function.&n; **/
DECL|function|dc395x_module_exit
r_static
r_void
id|__exit
id|dc395x_module_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|dc395x_driver
)paren
suffix:semicolon
)brace
DECL|variable|dc395x_module_init
id|module_init
c_func
(paren
id|dc395x_module_init
)paren
suffix:semicolon
DECL|variable|dc395x_module_exit
id|module_exit
c_func
(paren
id|dc395x_module_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;C.L. Huang / Erich Chen / Kurt Garloff&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SCSI host adapter driver for Tekram TRM-S1040 based adapters: Tekram DC395 and DC315 series&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
