multiline_comment|/*&n; * dc395x.c&n; *&n; * Device Driver for Tekram DC395(U/UW/F), DC315(U)&n; * PCI SCSI Bus Master Host Adapter&n; * (SCSI chip set used Tekram ASIC TRM-S1040)&n; *&n; * Authors:&n; *  C.L. Huang &lt;ching@tekram.com.tw&gt;&n; *  Erich Chen &lt;erich@tekram.com.tw&gt;&n; *  (C) Copyright 1995-1999 Tekram Technology Co., Ltd.&n; *&n; *  Kurt Garloff &lt;garloff@suse.de&gt;&n; *  (C) 1999-2000 Kurt Garloff&n; *&n; *  Oliver Neukum &lt;oliver@neukum.name&gt;&n; *  Ali Akcaagac &lt;aliakc@web.de&gt;&n; *  Jamie Lenehan &lt;lenehan@twibble.org&gt;&n; *  (C) 2003&n; *&n; * License: GNU GPL&n; *&n; *************************************************************************&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions and the following disclaimer.&n; * 2. Redistributions in binary form must reproduce the above copyright&n; *    notice, this list of conditions and the following disclaimer in the&n; *    documentation and/or other materials provided with the distribution.&n; * 3. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS&squot;&squot; AND ANY EXPRESS OR&n; * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES&n; * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.&n; * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,&n; * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,&n; * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY&n; * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT&n; * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; ************************************************************************&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;dc395x.h&quot;
macro_line|#include &lt;scsi/scsicam.h&gt;&t;/* needed for scsicam_bios_param */
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
multiline_comment|/* Debugging */
multiline_comment|/*#define DC395x_DEBUG_KG */
multiline_comment|/*#define DC395x_DEBUG0*/
multiline_comment|/*#define DC395x_DEBUG1*/
multiline_comment|/*#define DC395x_DEBUGDCB*/
DECL|macro|DC395x_DEBUGTRACE
mdefine_line|#define DC395x_DEBUGTRACE
multiline_comment|/*#define DC395x_DEBUGTRACEALL*/
multiline_comment|/*#define DC395x_DEBUGPARSE*/
multiline_comment|/*#define DC395x_SGPARANOIA*/
multiline_comment|/*#define DC395x_DEBUGFIFO*/
multiline_comment|/*#define DC395x_DEBUGRECURSION*/
multiline_comment|/*#define DC395x_DEBUGPIO*/
multiline_comment|/*#define DC395x_DEBUGMALLOC*/
multiline_comment|/* DISable features */
multiline_comment|/*#define DC395x_NO_DISCONNECT*/
multiline_comment|/*#define DC395x_NO_TAGQ*/
multiline_comment|/*#define DC395x_NO_SYNC*/
multiline_comment|/*#define DC395x_NO_WIDE*/
macro_line|#ifdef DC395x_DEBUG0
DECL|macro|DEBUG0
macro_line|# define DEBUG0(x) x
macro_line|#else
DECL|macro|DEBUG0
macro_line|# define DEBUG0(x)
macro_line|#endif
macro_line|#ifdef DC395x_DEBUG1
DECL|macro|DEBUG1
macro_line|# define DEBUG1(x) x
macro_line|#else
DECL|macro|DEBUG1
macro_line|# define DEBUG1(x)
macro_line|#endif
macro_line|#ifdef DC395x_DEBUGDCB
DECL|macro|DCBDEBUG
macro_line|# define DCBDEBUG(x) x
macro_line|#else
DECL|macro|DCBDEBUG
macro_line|# define DCBDEBUG(x)
macro_line|#endif
macro_line|#ifdef DC395x_DEBUGPARSE
DECL|macro|PARSEDEBUG
macro_line|# define PARSEDEBUG(x) x
macro_line|#else
DECL|macro|PARSEDEBUG
macro_line|# define PARSEDEBUG(x)
macro_line|#endif
macro_line|#ifdef DC395x_DEBUGRECURSION
DECL|macro|DEBUGRECURSION
macro_line|# define DEBUGRECURSION(x) x
macro_line|#else
DECL|macro|DEBUGRECURSION
macro_line|# define DEBUGRECURSION(x)
macro_line|#endif
macro_line|#ifdef DC395x_DEBUGPIO
DECL|macro|DEBUGPIO
macro_line|# define DEBUGPIO(x) x
macro_line|#else
DECL|macro|DEBUGPIO
macro_line|# define DEBUGPIO(x)
macro_line|#endif
multiline_comment|/* Here comes the joker of all debugging facilities! */
macro_line|#ifdef DC395x_DEBUGTRACEALL
macro_line|# ifndef DC395x_DEBUGTRACE
DECL|macro|DC395x_DEBUGTRACE
macro_line|#  define DC395x_DEBUGTRACE
macro_line|# endif
DECL|macro|TRACEOUTALL
macro_line|# define TRACEOUTALL(x...) printk ( x)
macro_line|#else
DECL|macro|TRACEOUTALL
macro_line|# define TRACEOUTALL(x...) do {} while (0)
macro_line|#endif
macro_line|#ifdef DC395x_DEBUGTRACE
DECL|macro|DEBUGTRACEBUFSZ
macro_line|# define DEBUGTRACEBUFSZ 512
DECL|variable|DC395x_tracebuf
r_char
id|DC395x_tracebuf
(braket
l_int|64
)braket
suffix:semicolon
DECL|variable|DC395x_traceoverflow
r_char
id|DC395x_traceoverflow
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|macro|TRACEPRINTF
macro_line|# define TRACEPRINTF(x...) &bslash;&n;do { int ln = sprintf (DC395x_tracebuf, x); &bslash;&n;     if (pSRB-&gt;debugpos + ln &gt;= DEBUGTRACEBUFSZ) &bslash;&n;     { pSRB-&gt;debugtrace[pSRB-&gt;debugpos] = 0; pSRB-&gt;debugpos = DEBUGTRACEBUFSZ/5; pSRB-&gt;debugtrace[pSRB-&gt;debugpos++] = &squot;&gt;&squot;; }; &bslash;&n;     sprintf (pSRB-&gt;debugtrace + pSRB-&gt;debugpos, &quot;%s&quot;, DC395x_tracebuf); &bslash;&n;     pSRB-&gt;debugpos += ln - 1; &bslash;&n;   } while (0)
DECL|macro|TRACEOUT
macro_line|# define TRACEOUT(x...) printk ( x)
macro_line|#else
DECL|macro|TRACEPRINTF
macro_line|# define TRACEPRINTF(x...) do {} while (0)
DECL|macro|TRACEOUT
macro_line|# define TRACEOUT(x...) do {} while (0)
macro_line|#endif
macro_line|#ifdef DC395x_DEBUGMALLOC
DECL|function|dc395x_kmalloc
r_inline
r_void
op_star
id|dc395x_kmalloc
c_func
(paren
r_int
id|sz
comma
r_int
id|fl
)paren
(brace
r_void
op_star
id|ptr
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|fl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
id|DC395X_NAME
l_string|&quot;: Alloc %i bytes @ %p w/ fl %08x&bslash;n&quot;
comma
id|sz
comma
id|ptr
comma
id|fl
)paren
suffix:semicolon
r_return
id|ptr
suffix:semicolon
)brace
DECL|function|dc395x_kfree
r_inline
r_void
id|dc395x_kfree
c_func
(paren
r_const
r_void
op_star
id|adr
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
id|DC395X_NAME
l_string|&quot;: Free mem @ %p&bslash;n&quot;
comma
id|adr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|adr
)paren
suffix:semicolon
)brace
DECL|macro|KMALLOC
macro_line|# define KMALLOC(sz,fl) dc395x_kmalloc(sz,fl)
DECL|macro|KFREE
macro_line|# define KFREE(adr) dc395x_kfree(adr)
macro_line|#else
DECL|macro|KMALLOC
macro_line|# define KMALLOC(sz,fl) kmalloc(sz,fl)
DECL|macro|KFREE
macro_line|# define KFREE(adr) kfree(adr)
macro_line|#endif
macro_line|#ifndef PCI_VENDOR_ID_TEKRAM
DECL|macro|PCI_VENDOR_ID_TEKRAM
mdefine_line|#define PCI_VENDOR_ID_TEKRAM                    0x1DE1&t;/* Vendor ID    */
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_TEKRAM_TRMS1040
DECL|macro|PCI_DEVICE_ID_TEKRAM_TRMS1040
mdefine_line|#define PCI_DEVICE_ID_TEKRAM_TRMS1040           0x0391&t;/* Device ID    */
macro_line|#endif
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|dc395x_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_TEKRAM
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_TEKRAM_TRMS1040
comma
dot
id|subvendor
op_assign
id|PCI_ANY_ID
comma
dot
id|subdevice
op_assign
id|PCI_ANY_ID
comma
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|dc395x_pci_tbl
)paren
suffix:semicolon
DECL|macro|DC395x_LOCK_IO
mdefine_line|#define DC395x_LOCK_IO(dev)   spin_lock_irqsave(((struct Scsi_Host *)dev)-&gt;host_lock, flags)
DECL|macro|DC395x_UNLOCK_IO
mdefine_line|#define DC395x_UNLOCK_IO(dev) spin_unlock_irqrestore(((struct Scsi_Host *)dev)-&gt;host_lock, flags)
DECL|macro|DC395x_ACB_INITLOCK
mdefine_line|#define DC395x_ACB_INITLOCK(pACB)               spin_lock_init(&amp;pACB-&gt;smp_lock)
DECL|macro|DC395x_ACB_LOCK
mdefine_line|#define DC395x_ACB_LOCK(pACB,acb_flags)&t;        if (!pACB-&gt;lock_level_count[cpuid]) { spin_lock_irqsave(&amp;pACB-&gt;smp_lock,acb_flags); pACB-&gt;lock_level_count[cpuid]++; } else { pACB-&gt;lock_level_count[cpuid]++; }
DECL|macro|DC395x_ACB_UNLOCK
mdefine_line|#define DC395x_ACB_UNLOCK(pACB,acb_flags)       if (--pACB-&gt;lock_level_count[cpuid] == 0) { spin_unlock_irqrestore(&amp;pACB-&gt;smp_lock,acb_flags); }
DECL|macro|DC395x_SMP_IO_LOCK
mdefine_line|#define DC395x_SMP_IO_LOCK(dev,irq_flags)       spin_lock_irqsave(((struct Scsi_Host*)dev)-&gt;host_lock,irq_flags)
DECL|macro|DC395x_SMP_IO_UNLOCK
mdefine_line|#define DC395x_SMP_IO_UNLOCK(dev,irq_flags)     spin_unlock_irqrestore(((struct Scsi_Host*)dev)-&gt;host_lock,irq_flags)
DECL|macro|DC395x_SCSI_DONE_ACB_LOCK
mdefine_line|#define DC395x_SCSI_DONE_ACB_LOCK&t;        spin_lock(&amp;(pACB-&gt;smp_lock))
DECL|macro|DC395x_SCSI_DONE_ACB_UNLOCK
mdefine_line|#define DC395x_SCSI_DONE_ACB_UNLOCK&t;        spin_unlock(&amp;(pACB-&gt;smp_lock))
DECL|macro|DC395x_read8
mdefine_line|#define DC395x_read8(address)                   (u8)(inb(pACB-&gt;IOPortBase + (address)))
DECL|macro|DC395x_read8_
mdefine_line|#define DC395x_read8_(address, base)            (u8)(inb((USHORT)(base) + (address)))
DECL|macro|DC395x_read16
mdefine_line|#define DC395x_read16(address)                  (u16)(inw(pACB-&gt;IOPortBase + (address)))
DECL|macro|DC395x_read32
mdefine_line|#define DC395x_read32(address)                  (u32)(inl(pACB-&gt;IOPortBase + (address)))
DECL|macro|DC395x_write8
mdefine_line|#define DC395x_write8(address,value)            outb((value), pACB-&gt;IOPortBase + (address))
DECL|macro|DC395x_write8_
mdefine_line|#define DC395x_write8_(address,value,base)      outb((value), (USHORT)(base) + (address))
DECL|macro|DC395x_write16
mdefine_line|#define DC395x_write16(address,value)           outw((value), pACB-&gt;IOPortBase + (address))
DECL|macro|DC395x_write32
mdefine_line|#define DC395x_write32(address,value)           outl((value), pACB-&gt;IOPortBase + (address))
DECL|macro|BUS_ADDR
mdefine_line|#define BUS_ADDR(sg)&t;&t;sg_dma_address(&amp;(sg))
DECL|macro|CPU_ADDR
mdefine_line|#define CPU_ADDR(sg)&t;&t;(page_address((sg).page)+(sg).offset)
DECL|macro|PAGE_ADDRESS
mdefine_line|#define PAGE_ADDRESS(sg)&t;page_address((sg)-&gt;page)
DECL|macro|SET_DIR
mdefine_line|#define SET_DIR(dir,pcmd)&t;dir = scsi_to_pci_dma_dir((pcmd)-&gt;sc_data_direction)
multiline_comment|/* cmd-&gt;result */
DECL|macro|RES_TARGET
mdefine_line|#define RES_TARGET&t;&t;0x000000FF&t;/* Target State */
DECL|macro|RES_TARGET_LNX
mdefine_line|#define RES_TARGET_LNX  STATUS_MASK&t;/* Only official ... */
DECL|macro|RES_ENDMSG
mdefine_line|#define RES_ENDMSG&t;&t;0x0000FF00&t;/* End Message */
DECL|macro|RES_DID
mdefine_line|#define RES_DID&t;&t;&t;0x00FF0000&t;/* DID_ codes */
DECL|macro|RES_DRV
mdefine_line|#define RES_DRV&t;&t;&t;0xFF000000&t;/* DRIVER_ codes */
DECL|macro|MK_RES
mdefine_line|#define MK_RES(drv,did,msg,tgt) ((int)(drv)&lt;&lt;24 | (int)(did)&lt;&lt;16 | (int)(msg)&lt;&lt;8 | (int)(tgt))
DECL|macro|MK_RES_LNX
mdefine_line|#define MK_RES_LNX(drv,did,msg,tgt) ((int)(drv)&lt;&lt;24 | (int)(did)&lt;&lt;16 | (int)(msg)&lt;&lt;8 | (int)(tgt)&lt;&lt;1)
DECL|macro|SET_RES_TARGET
mdefine_line|#define SET_RES_TARGET(who,tgt) { who &amp;= ~RES_TARGET; who |= (int)(tgt); }
DECL|macro|SET_RES_TARGET_LNX
mdefine_line|#define SET_RES_TARGET_LNX(who,tgt) { who &amp;= ~RES_TARGET_LNX; who |= (int)(tgt) &lt;&lt; 1; }
DECL|macro|SET_RES_MSG
mdefine_line|#define SET_RES_MSG(who,msg) { who &amp;= ~RES_ENDMSG; who |= (int)(msg) &lt;&lt; 8; }
DECL|macro|SET_RES_DID
mdefine_line|#define SET_RES_DID(who,did) { who &amp;= ~RES_DID; who |= (int)(did) &lt;&lt; 16; }
DECL|macro|SET_RES_DRV
mdefine_line|#define SET_RES_DRV(who,drv) { who &amp;= ~RES_DRV; who |= (int)(drv) &lt;&lt; 24; }
multiline_comment|/*&n;**************************************************************************&n;*/
DECL|macro|NO_IRQ
mdefine_line|#define NO_IRQ 255
DECL|macro|TAG_NONE
mdefine_line|#define TAG_NONE 255
DECL|struct|SGentry
r_struct
id|SGentry
(brace
DECL|member|address
id|u32
id|address
suffix:semicolon
multiline_comment|/* bus! address */
DECL|member|length
id|u32
id|length
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*-----------------------------------------------------------------------&n;  SCSI Request Block&n;  -----------------------------------------------------------------------*/
DECL|struct|ScsiReqBlk
r_struct
id|ScsiReqBlk
(brace
DECL|member|pNextSRB
r_struct
id|ScsiReqBlk
op_star
id|pNextSRB
suffix:semicolon
DECL|member|pSRBDCB
r_struct
id|DeviceCtlBlk
op_star
id|pSRBDCB
suffix:semicolon
multiline_comment|/* HW scatter list (up to 64 entries) */
DECL|member|SegmentX
r_struct
id|SGentry
op_star
id|SegmentX
suffix:semicolon
DECL|member|pcmd
id|Scsi_Cmnd
op_star
id|pcmd
suffix:semicolon
multiline_comment|/* Offset 0x20/0x10 */
DECL|member|virt_addr
r_int
r_char
op_star
id|virt_addr
suffix:semicolon
multiline_comment|/* set by DC395x_update_SGlist */
DECL|member|SRBTotalXferLength
id|u32
id|SRBTotalXferLength
suffix:semicolon
DECL|member|Xferred
id|u32
id|Xferred
suffix:semicolon
multiline_comment|/* Backup for the already xferred len */
DECL|member|SRBSGBusAddr
id|u32
id|SRBSGBusAddr
suffix:semicolon
multiline_comment|/* bus address of DC395x scatterlist */
DECL|member|SRBState
id|u16
id|SRBState
suffix:semicolon
DECL|member|SRBSGCount
id|u8
id|SRBSGCount
suffix:semicolon
DECL|member|SRBSGIndex
id|u8
id|SRBSGIndex
suffix:semicolon
multiline_comment|/* Offset 0x38/0x24 */
DECL|member|MsgInBuf
id|u8
id|MsgInBuf
(braket
l_int|6
)braket
suffix:semicolon
DECL|member|MsgOutBuf
id|u8
id|MsgOutBuf
(braket
l_int|6
)braket
suffix:semicolon
DECL|member|AdaptStatus
id|u8
id|AdaptStatus
suffix:semicolon
DECL|member|TargetStatus
id|u8
id|TargetStatus
suffix:semicolon
DECL|member|MsgCnt
id|u8
id|MsgCnt
suffix:semicolon
DECL|member|EndMessage
id|u8
id|EndMessage
suffix:semicolon
multiline_comment|/* Offset 0x48/0x34 */
DECL|member|pMsgPtr
id|u8
op_star
id|pMsgPtr
suffix:semicolon
DECL|member|TagNumber
id|u8
id|TagNumber
suffix:semicolon
DECL|member|SRBStatus
id|u8
id|SRBStatus
suffix:semicolon
DECL|member|RetryCnt
id|u8
id|RetryCnt
suffix:semicolon
DECL|member|SRBFlag
id|u8
id|SRBFlag
suffix:semicolon
DECL|member|ScsiPhase
id|u8
id|ScsiPhase
suffix:semicolon
DECL|member|padding
id|u8
id|padding
suffix:semicolon
DECL|member|debugpos
id|u16
id|debugpos
suffix:semicolon
multiline_comment|/* Offset 0x58/0x40 */
macro_line|#ifdef DC395x_DEBUGTRACE
DECL|member|debugtrace
r_char
op_star
id|debugtrace
suffix:semicolon
multiline_comment|/* Offset 0x60/0x44 */
macro_line|#endif
)brace
suffix:semicolon
multiline_comment|/*-----------------------------------------------------------------------&n;  Device Control Block&n;  -----------------------------------------------------------------------*/
DECL|struct|DeviceCtlBlk
r_struct
id|DeviceCtlBlk
(brace
DECL|member|pNextDCB
r_struct
id|DeviceCtlBlk
op_star
id|pNextDCB
suffix:semicolon
DECL|member|pDCBACB
r_struct
id|AdapterCtlBlk
op_star
id|pDCBACB
suffix:semicolon
DECL|member|pGoingSRB
r_struct
id|ScsiReqBlk
op_star
id|pGoingSRB
suffix:semicolon
DECL|member|pGoingLast
r_struct
id|ScsiReqBlk
op_star
id|pGoingLast
suffix:semicolon
multiline_comment|/* 0x10: */
DECL|member|pWaitingSRB
r_struct
id|ScsiReqBlk
op_star
id|pWaitingSRB
suffix:semicolon
DECL|member|pWaitLast
r_struct
id|ScsiReqBlk
op_star
id|pWaitLast
suffix:semicolon
DECL|member|pActiveSRB
r_struct
id|ScsiReqBlk
op_star
id|pActiveSRB
suffix:semicolon
DECL|member|TagMask
id|u32
id|TagMask
suffix:semicolon
multiline_comment|/* 0x20: */
DECL|member|MaxCommand
id|u16
id|MaxCommand
suffix:semicolon
DECL|member|AdaptIndex
id|u8
id|AdaptIndex
suffix:semicolon
multiline_comment|/* UnitInfo struc start        */
DECL|member|UnitIndex
id|u8
id|UnitIndex
suffix:semicolon
multiline_comment|/* nth Unit on this card       */
DECL|member|GoingSRBCnt
id|u16
id|GoingSRBCnt
suffix:semicolon
DECL|member|WaitSRBCnt
id|u16
id|WaitSRBCnt
suffix:semicolon
DECL|member|TargetID
id|u8
id|TargetID
suffix:semicolon
multiline_comment|/* SCSI Target ID  (SCSI Only) */
DECL|member|TargetLUN
id|u8
id|TargetLUN
suffix:semicolon
multiline_comment|/* SCSI Log.  Unit (SCSI Only) */
DECL|member|IdentifyMsg
id|u8
id|IdentifyMsg
suffix:semicolon
DECL|member|DevMode
id|u8
id|DevMode
suffix:semicolon
multiline_comment|/* 0x2c: */
multiline_comment|/*    u8&t;AdpMode;*/
DECL|member|Inquiry7
id|u8
id|Inquiry7
suffix:semicolon
multiline_comment|/* To store Inquiry flags */
DECL|member|SyncMode
id|u8
id|SyncMode
suffix:semicolon
multiline_comment|/* 0:async mode */
DECL|member|MinNegoPeriod
id|u8
id|MinNegoPeriod
suffix:semicolon
multiline_comment|/* for nego. */
DECL|member|SyncPeriod
id|u8
id|SyncPeriod
suffix:semicolon
multiline_comment|/* for reg.  */
DECL|member|SyncOffset
id|u8
id|SyncOffset
suffix:semicolon
multiline_comment|/* for reg. and nego.(low nibble) */
DECL|member|UnitCtrlFlag
id|u8
id|UnitCtrlFlag
suffix:semicolon
DECL|member|DCBFlag
id|u8
id|DCBFlag
suffix:semicolon
DECL|member|DevType
id|u8
id|DevType
suffix:semicolon
DECL|member|init_TCQ_flag
id|u8
id|init_TCQ_flag
suffix:semicolon
DECL|member|last_derated
r_int
r_int
id|last_derated
suffix:semicolon
multiline_comment|/* last time, when features were turned off in abort */
multiline_comment|/* 0x38: */
multiline_comment|/* u8       Reserved2[3];    for dword alignment */
)brace
suffix:semicolon
multiline_comment|/*-----------------------------------------------------------------------&n;  Adapter Control Block&n;  -----------------------------------------------------------------------*/
DECL|struct|AdapterCtlBlk
r_struct
id|AdapterCtlBlk
(brace
DECL|member|pScsiHost
r_struct
id|Scsi_Host
op_star
id|pScsiHost
suffix:semicolon
DECL|member|pNextACB
r_struct
id|AdapterCtlBlk
op_star
id|pNextACB
suffix:semicolon
DECL|member|IOPortBase
id|u16
id|IOPortBase
suffix:semicolon
DECL|member|Revxx1
id|u16
id|Revxx1
suffix:semicolon
DECL|member|pLinkDCB
r_struct
id|DeviceCtlBlk
op_star
id|pLinkDCB
suffix:semicolon
DECL|member|pLastDCB
r_struct
id|DeviceCtlBlk
op_star
id|pLastDCB
suffix:semicolon
DECL|member|pDCBRunRobin
r_struct
id|DeviceCtlBlk
op_star
id|pDCBRunRobin
suffix:semicolon
DECL|member|pActiveDCB
r_struct
id|DeviceCtlBlk
op_star
id|pActiveDCB
suffix:semicolon
DECL|member|pFreeSRB
r_struct
id|ScsiReqBlk
op_star
id|pFreeSRB
suffix:semicolon
DECL|member|pTmpSRB
r_struct
id|ScsiReqBlk
op_star
id|pTmpSRB
suffix:semicolon
DECL|member|Waiting_Timer
r_struct
id|timer_list
id|Waiting_Timer
suffix:semicolon
DECL|member|SelTO_Timer
r_struct
id|timer_list
id|SelTO_Timer
suffix:semicolon
DECL|member|SRBCount
id|u16
id|SRBCount
suffix:semicolon
DECL|member|AdapterIndex
id|u16
id|AdapterIndex
suffix:semicolon
multiline_comment|/* nth Adapter this driver */
DECL|member|QueryCnt
id|u32
id|QueryCnt
suffix:semicolon
DECL|member|pQueryHead
id|Scsi_Cmnd
op_star
id|pQueryHead
suffix:semicolon
DECL|member|pQueryTail
id|Scsi_Cmnd
op_star
id|pQueryTail
suffix:semicolon
DECL|member|msgin123
id|u8
id|msgin123
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|status
id|u8
id|status
suffix:semicolon
DECL|member|DCBCnt
id|u8
id|DCBCnt
suffix:semicolon
DECL|member|sel_timeout
id|u8
id|sel_timeout
suffix:semicolon
DECL|member|dummy
id|u8
id|dummy
suffix:semicolon
DECL|member|IRQLevel
id|u8
id|IRQLevel
suffix:semicolon
DECL|member|TagMaxNum
id|u8
id|TagMaxNum
suffix:semicolon
DECL|member|ACBFlag
id|u8
id|ACBFlag
suffix:semicolon
DECL|member|Gmode2
id|u8
id|Gmode2
suffix:semicolon
DECL|member|Config
id|u8
id|Config
suffix:semicolon
DECL|member|LUNchk
id|u8
id|LUNchk
suffix:semicolon
DECL|member|scan_devices
id|u8
id|scan_devices
suffix:semicolon
DECL|member|HostID_Bit
id|u8
id|HostID_Bit
suffix:semicolon
DECL|member|DCBmap
id|u8
id|DCBmap
(braket
id|DC395x_MAX_SCSI_ID
)braket
suffix:semicolon
DECL|member|children
r_struct
id|DeviceCtlBlk
op_star
id|children
(braket
id|DC395x_MAX_SCSI_ID
)braket
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|Cmds
id|u32
id|Cmds
suffix:semicolon
DECL|member|SelLost
id|u32
id|SelLost
suffix:semicolon
DECL|member|SelConn
id|u32
id|SelConn
suffix:semicolon
DECL|member|CmdInQ
id|u32
id|CmdInQ
suffix:semicolon
DECL|member|CmdOutOfSRB
id|u32
id|CmdOutOfSRB
suffix:semicolon
multiline_comment|/*struct DeviceCtlBlk       DCB_array[DC395x_MAX_DCB]; */
multiline_comment|/*  +74h, Len=3E8  */
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
DECL|member|MsgLen
id|u8
id|MsgLen
suffix:semicolon
DECL|member|DeviceCnt
id|u8
id|DeviceCnt
suffix:semicolon
DECL|member|SRB_array
r_struct
id|ScsiReqBlk
id|SRB_array
(braket
id|DC395x_MAX_SRB_CNT
)braket
suffix:semicolon
DECL|member|TmpSRB
r_struct
id|ScsiReqBlk
id|TmpSRB
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * The SEEPROM structure for TRM_S1040 &n; */
DECL|struct|NVRamTarget
r_struct
id|NVRamTarget
(brace
DECL|member|NvmTarCfg0
id|u8
id|NvmTarCfg0
suffix:semicolon
multiline_comment|/* Target configuration byte 0  */
DECL|member|NvmTarPeriod
id|u8
id|NvmTarPeriod
suffix:semicolon
multiline_comment|/* Target period                */
DECL|member|NvmTarCfg2
id|u8
id|NvmTarCfg2
suffix:semicolon
multiline_comment|/* Target configuration byte 2  */
DECL|member|NvmTarCfg3
id|u8
id|NvmTarCfg3
suffix:semicolon
multiline_comment|/* Target configuration byte 3  */
)brace
suffix:semicolon
DECL|struct|NvRamType
r_struct
id|NvRamType
(brace
DECL|member|NvramSubVendorID
id|u8
id|NvramSubVendorID
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* 0,1  Sub Vendor ID   */
DECL|member|NvramSubSysID
id|u8
id|NvramSubSysID
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* 2,3  Sub System ID   */
DECL|member|NvramSubClass
id|u8
id|NvramSubClass
suffix:semicolon
multiline_comment|/* 4    Sub Class       */
DECL|member|NvramVendorID
id|u8
id|NvramVendorID
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* 5,6  Vendor ID       */
DECL|member|NvramDeviceID
id|u8
id|NvramDeviceID
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* 7,8  Device ID       */
DECL|member|NvramReserved
id|u8
id|NvramReserved
suffix:semicolon
multiline_comment|/* 9    Reserved        */
DECL|member|NvramTarget
r_struct
id|NVRamTarget
id|NvramTarget
(braket
id|DC395x_MAX_SCSI_ID
)braket
suffix:semicolon
multiline_comment|/** 10,11,12,13&n;&t;&t;&t;&t;&t;&t; ** 14,15,16,17&n;&t;&t;&t;&t;&t;&t; ** ....&n;&t;&t;&t;&t;&t;&t; ** ....&n;&t;&t;&t;&t;&t;&t; ** 70,71,72,73&n;&t;&t;&t;&t;&t;&t; */
DECL|member|NvramScsiId
id|u8
id|NvramScsiId
suffix:semicolon
multiline_comment|/* 74 Host Adapter SCSI ID      */
DECL|member|NvramChannelCfg
id|u8
id|NvramChannelCfg
suffix:semicolon
multiline_comment|/* 75 Channel configuration     */
DECL|member|NvramDelayTime
id|u8
id|NvramDelayTime
suffix:semicolon
multiline_comment|/* 76 Power on delay time       */
DECL|member|NvramMaxTag
id|u8
id|NvramMaxTag
suffix:semicolon
multiline_comment|/* 77 Maximum tags              */
DECL|member|NvramReserved0
id|u8
id|NvramReserved0
suffix:semicolon
multiline_comment|/* 78  */
DECL|member|NvramBootTarget
id|u8
id|NvramBootTarget
suffix:semicolon
multiline_comment|/* 79  */
DECL|member|NvramBootLun
id|u8
id|NvramBootLun
suffix:semicolon
multiline_comment|/* 80  */
DECL|member|NvramReserved1
id|u8
id|NvramReserved1
suffix:semicolon
multiline_comment|/* 81  */
DECL|member|Reserved
id|u16
id|Reserved
(braket
l_int|22
)braket
suffix:semicolon
multiline_comment|/* 82,..125 */
DECL|member|NvramCheckSum
id|u16
id|NvramCheckSum
suffix:semicolon
multiline_comment|/* 126,127 */
)brace
suffix:semicolon
multiline_comment|/*------------------------------------------------------------------------------*/
r_void
id|DC395x_DataOutPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_void
id|DC395x_DataInPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_CommandPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_StatusPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_MsgOutPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_void
id|DC395x_MsgInPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_DataOutPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_DataInPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_CommandPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_StatusPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_MsgOutPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_MsgInPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_Nop0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_Nop1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
suffix:semicolon
r_static
r_void
id|DC395x_basic_config
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|DC395x_cleanup_after_transfer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|DC395x_ResetSCSIBus
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
suffix:semicolon
r_void
id|DC395x_DataIO_transfer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
id|ioDir
)paren
suffix:semicolon
r_void
id|DC395x_Disconnect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
suffix:semicolon
r_void
id|DC395x_Reselect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
suffix:semicolon
id|u8
id|DC395x_StartSCSI
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|DC395x_BuildSRB
c_func
(paren
id|Scsi_Cmnd
op_star
id|pcmd
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
suffix:semicolon
r_void
id|DC395x_DoingSRB_Done
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
id|u8
id|did_code
comma
id|Scsi_Cmnd
op_star
id|pcmd
comma
id|u8
id|force
)paren
suffix:semicolon
r_static
r_void
id|DC395x_ScsiRstDetect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
suffix:semicolon
r_static
r_void
id|DC395x_pci_unmap
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|DC395x_pci_unmap_sense
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
suffix:semicolon
r_static
r_inline
r_void
id|DC395x_EnableMsgOut_Abort
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
suffix:semicolon
r_void
id|DC395x_SRBdone
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
suffix:semicolon
r_static
r_void
id|DC395x_RequestSense
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
suffix:semicolon
r_static
r_inline
r_void
id|DC395x_SetXferRate
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
)paren
suffix:semicolon
r_void
id|DC395x_initDCB
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
op_star
id|ppDCB
comma
id|u8
id|target
comma
id|u8
id|lun
)paren
suffix:semicolon
r_int
id|DC395x_shutdown
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
suffix:semicolon
r_static
r_void
id|DC395x_remove_dev
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
)paren
suffix:semicolon
DECL|variable|DC395x_pACB_start
r_static
r_struct
id|AdapterCtlBlk
op_star
id|DC395x_pACB_start
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|DC395x_pACB_current
r_static
r_struct
id|AdapterCtlBlk
op_star
id|DC395x_pACB_current
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|DC395x_adapterCnt
r_static
id|u16
id|DC395x_adapterCnt
op_assign
l_int|0
suffix:semicolon
DECL|variable|DC395x_CurrSyncOffset
r_static
id|u16
id|DC395x_CurrSyncOffset
op_assign
l_int|0
suffix:semicolon
id|DEBUGRECURSION
c_func
(paren
r_static
r_char
id|in_driver
op_assign
l_int|0
suffix:semicolon
)paren
DECL|variable|DC395x_monitor_next_IRQ
r_static
r_char
id|DC395x_monitor_next_IRQ
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &n; * DC395x_stateV = (void *)DC395x_SCSI_phase0[phase]&n; */
DECL|variable|DC395x_SCSI_phase0
r_static
r_void
op_star
id|DC395x_SCSI_phase0
(braket
)braket
op_assign
(brace
id|DC395x_DataOutPhase0
comma
multiline_comment|/* phase:0 */
id|DC395x_DataInPhase0
comma
multiline_comment|/* phase:1 */
id|DC395x_CommandPhase0
comma
multiline_comment|/* phase:2 */
id|DC395x_StatusPhase0
comma
multiline_comment|/* phase:3 */
id|DC395x_Nop0
comma
multiline_comment|/* phase:4 PH_BUS_FREE .. initial phase */
id|DC395x_Nop0
comma
multiline_comment|/* phase:5 PH_BUS_FREE .. initial phase */
id|DC395x_MsgOutPhase0
comma
multiline_comment|/* phase:6 */
id|DC395x_MsgInPhase0
comma
multiline_comment|/* phase:7 */
)brace
suffix:semicolon
multiline_comment|/*&n; * DC395x_stateV = (void *)DC395x_SCSI_phase1[phase]&n; */
DECL|variable|DC395x_SCSI_phase1
r_static
r_void
op_star
id|DC395x_SCSI_phase1
(braket
)braket
op_assign
(brace
id|DC395x_DataOutPhase1
comma
multiline_comment|/* phase:0 */
id|DC395x_DataInPhase1
comma
multiline_comment|/* phase:1 */
id|DC395x_CommandPhase1
comma
multiline_comment|/* phase:2 */
id|DC395x_StatusPhase1
comma
multiline_comment|/* phase:3 */
id|DC395x_Nop1
comma
multiline_comment|/* phase:4 PH_BUS_FREE .. initial phase */
id|DC395x_Nop1
comma
multiline_comment|/* phase:5 PH_BUS_FREE .. initial phase */
id|DC395x_MsgOutPhase1
comma
multiline_comment|/* phase:6 */
id|DC395x_MsgInPhase1
comma
multiline_comment|/* phase:7 */
)brace
suffix:semicolon
DECL|variable|dc395x_trm_eepromBuf
r_struct
id|NvRamType
id|dc395x_trm_eepromBuf
(braket
id|DC395x_MAX_ADAPTER_NUM
)braket
suffix:semicolon
multiline_comment|/*&n; *Fast20:&t;000&t; 50ns, 20.0 MHz&n; *&t;&t;001&t; 75ns, 13.3 MHz&n; *&t;&t;010&t;100ns, 10.0 MHz&n; *&t;&t;011&t;125ns,  8.0 MHz&n; *&t;&t;100&t;150ns,  6.6 MHz&n; *&t;&t;101&t;175ns,  5.7 MHz&n; *&t;&t;110&t;200ns,  5.0 MHz&n; *&t;&t;111&t;250ns,  4.0 MHz&n; *&n; *Fast40(LVDS):&t;000&t; 25ns, 40.0 MHz&n; *&t;&t;001&t; 50ns, 20.0 MHz&n; *&t;&t;010&t; 75ns, 13.3 MHz&n; *&t;&t;011&t;100ns, 10.0 MHz&n; *&t;&t;100&t;125ns,  8.0 MHz&n; *&t;&t;101&t;150ns,  6.6 MHz&n; *&t;&t;110&t;175ns,  5.7 MHz&n; *&t;&t;111&t;200ns,  5.0 MHz&n; */
multiline_comment|/*static u8&t;dc395x_clock_period[] = {12,19,25,31,37,44,50,62};*/
multiline_comment|/* real period:48ns,76ns,100ns,124ns,148ns,176ns,200ns,248ns */
DECL|variable|dc395x_clock_period
r_static
id|u8
id|dc395x_clock_period
(braket
)braket
op_assign
(brace
l_int|12
comma
l_int|18
comma
l_int|25
comma
l_int|31
comma
l_int|37
comma
l_int|43
comma
l_int|50
comma
l_int|62
)brace
suffix:semicolon
DECL|variable|dc395x_clock_speed
r_static
id|u16
id|dc395x_clock_speed
(braket
)braket
op_assign
(brace
l_int|200
comma
l_int|133
comma
l_int|100
comma
l_int|80
comma
l_int|67
comma
l_int|58
comma
l_int|50
comma
l_int|40
)brace
suffix:semicolon
multiline_comment|/* real period:48ns,72ns,100ns,124ns,148ns,172ns,200ns,248ns */
multiline_comment|/*&n; * Override defaults on cmdline:&n; * dc395x_trm = AdaptID, MaxSpeed (Index), DevMode (Bitmapped), AdaptMode (Bitmapped), Tags (log2-1), DelayReset&n; */
DECL|variable|dc395x_trm
r_int
id|dc395x_trm
(braket
)braket
op_assign
(brace
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
)brace
suffix:semicolon
macro_line|#if defined(MODULE)
id|MODULE_PARM
c_func
(paren
id|dc395x_trm
comma
l_string|&quot;1-6i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dc395x_trm
comma
l_string|&quot;Host SCSI ID, Speed (0=20MHz), Device Flags, Adapter Flags, Max Tags (log2(tags)-1), DelayReset (s)&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;C.L. Huang / Erich Chen / Kurt Garloff&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;SCSI host adapter driver for Tekram TRM-S1040 based adapters: Tekram DC395 and DC315 series&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;sd,sr,sg,st&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* Delaying after a reset */
DECL|variable|DC395x_interpd
r_static
r_char
id|__initdata
id|DC395x_interpd
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|3
comma
l_int|5
comma
l_int|10
comma
l_int|16
comma
l_int|30
comma
l_int|60
comma
l_int|120
)brace
suffix:semicolon
multiline_comment|/* Convert EEprom value to seconds */
DECL|function|DC395x_interpret_delay
r_static
r_void
id|__init
id|DC395x_interpret_delay
c_func
(paren
r_struct
id|NvRamType
op_star
id|eeprom
)paren
(brace
multiline_comment|/*printk (DC395X_NAME &quot;: Debug: Delay: %i&bslash;n&quot;, eeprom-&gt;NvramDelayTime); */
id|eeprom-&gt;NvramDelayTime
op_assign
id|DC395x_interpd
(braket
id|eeprom-&gt;NvramDelayTime
)braket
suffix:semicolon
)brace
multiline_comment|/* seconds to EEProm value */
DECL|function|DC395x_uninterpret_delay
r_static
r_int
id|__init
id|DC395x_uninterpret_delay
c_func
(paren
r_int
id|delay
)paren
(brace
id|u8
id|idx
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|idx
OL
l_int|7
op_logical_and
id|DC395x_interpd
(braket
id|idx
)braket
OL
id|delay
)paren
id|idx
op_increment
suffix:semicolon
r_return
id|idx
suffix:semicolon
)brace
multiline_comment|/* Handle &quot;-1&quot; case */
DECL|function|DC395x_check_for_safe_settings
r_static
r_void
id|__init
id|DC395x_check_for_safe_settings
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|dc395x_trm
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
op_logical_or
id|dc395x_trm
(braket
l_int|0
)braket
OG
l_int|15
)paren
(brace
multiline_comment|/* modules-2.0.0 passes -1 as string */
id|dc395x_trm
(braket
l_int|0
)braket
op_assign
l_int|7
suffix:semicolon
id|dc395x_trm
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
id|dc395x_trm
(braket
l_int|2
)braket
op_assign
l_int|0x09
suffix:semicolon
id|dc395x_trm
(braket
l_int|3
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|dc395x_trm
(braket
l_int|4
)braket
op_assign
l_int|2
suffix:semicolon
id|dc395x_trm
(braket
l_int|5
)braket
op_assign
l_int|10
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Using safe settings.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Defaults, to be overriden by (a) BIOS and (b) Cmnd line (kernel/module) args */
DECL|variable|dc395x_def
r_int
id|__initdata
id|dc395x_def
(braket
)braket
op_assign
(brace
l_int|7
comma
l_int|1
multiline_comment|/* 13.3MHz */
comma
id|NTC_DO_PARITY_CHK
op_or
id|NTC_DO_DISCONNECT
op_or
id|NTC_DO_SYNC_NEGO
op_or
id|NTC_DO_WIDE_NEGO
op_or
id|NTC_DO_TAG_QUEUEING
op_or
id|NTC_DO_SEND_START
comma
id|NAC_GT2DRIVES
op_or
id|NAC_GREATER_1G
op_or
id|NAC_POWERON_SCSI_RESET
multiline_comment|/* | NAC_ACTIVE_NEG */
macro_line|#ifdef CONFIG_SCSI_MULTI_LUN
op_or
id|NAC_SCANLUN
macro_line|#endif
comma
l_int|3
multiline_comment|/* 16 Tags per LUN */
comma
l_int|1
multiline_comment|/* s delay after Reset */
)brace
suffix:semicolon
multiline_comment|/* Copy defaults over set values where missing */
DECL|function|DC395x_fill_with_defaults
r_static
r_void
id|__init
id|DC395x_fill_with_defaults
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|PARSEDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: setup %08x %08x %08x %08x %08x %08x&bslash;n&quot;
comma
id|dc395x_trm
(braket
l_int|0
)braket
comma
id|dc395x_trm
(braket
l_int|1
)braket
comma
id|dc395x_trm
(braket
l_int|2
)braket
comma
id|dc395x_trm
(braket
l_int|3
)braket
comma
id|dc395x_trm
(braket
l_int|4
)braket
comma
id|dc395x_trm
(braket
l_int|5
)braket
)paren
suffix:semicolon
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dc395x_trm
(braket
id|i
)braket
template_param
l_int|255
)paren
id|dc395x_trm
(braket
id|i
)braket
op_assign
id|dc395x_def
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* Sanity checks */
r_if
c_cond
(paren
id|dc395x_trm
(braket
l_int|0
)braket
OG
l_int|15
)paren
id|dc395x_trm
(braket
l_int|0
)braket
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|dc395x_trm
(braket
l_int|1
)braket
OG
l_int|7
)paren
id|dc395x_trm
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|dc395x_trm
(braket
l_int|4
)braket
OG
l_int|5
)paren
id|dc395x_trm
(braket
l_int|4
)braket
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|dc395x_trm
(braket
l_int|5
)braket
OG
l_int|180
)paren
id|dc395x_trm
(braket
l_int|5
)braket
op_assign
l_int|180
suffix:semicolon
)brace
multiline_comment|/* Read the parameters from the command line */
macro_line|#if !defined(MODULE)
DECL|function|DC395x_trm_setup
r_static
r_int
id|DC395x_trm_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|im
suffix:semicolon
r_int
id|ints
(braket
l_int|8
)braket
suffix:semicolon
(paren
r_void
)paren
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|im
op_assign
id|ints
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|im
OG
l_int|6
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
id|DC395X_NAME
l_string|&quot;: ignore extra params!&bslash;n&quot;
)paren
suffix:semicolon
id|im
op_assign
l_int|6
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|im
suffix:semicolon
id|i
op_increment
)paren
id|dc395x_trm
(braket
id|i
)braket
op_assign
id|ints
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
id|DC395X_NAME
l_string|&quot;=&quot;
comma
id|DC395x_trm_setup
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* !MODULE */
multiline_comment|/* Overrride BIOS values with the set ones */
DECL|function|DC395x_EEprom_Override
r_static
r_void
id|__init
id|DC395x_EEprom_Override
c_func
(paren
r_struct
id|NvRamType
op_star
id|eeprom
)paren
(brace
id|u8
id|id
suffix:semicolon
multiline_comment|/* Adapter Settings */
r_if
c_cond
(paren
id|dc395x_trm
(braket
l_int|0
)braket
op_ne
op_minus
l_int|2
)paren
id|eeprom-&gt;NvramScsiId
op_assign
(paren
id|u8
)paren
id|dc395x_trm
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Adapter ID */
r_if
c_cond
(paren
id|dc395x_trm
(braket
l_int|3
)braket
op_ne
op_minus
l_int|2
)paren
id|eeprom-&gt;NvramChannelCfg
op_assign
(paren
id|u8
)paren
id|dc395x_trm
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dc395x_trm
(braket
l_int|5
)braket
op_ne
op_minus
l_int|2
)paren
id|eeprom-&gt;NvramDelayTime
op_assign
id|DC395x_uninterpret_delay
c_func
(paren
id|dc395x_trm
(braket
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/* Reset delay */
r_if
c_cond
(paren
id|dc395x_trm
(braket
l_int|4
)braket
op_ne
op_minus
l_int|2
)paren
id|eeprom-&gt;NvramMaxTag
op_assign
(paren
id|u8
)paren
id|dc395x_trm
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Tagged Cmds */
multiline_comment|/* Device Settings */
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|DC395x_MAX_SCSI_ID
suffix:semicolon
id|id
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dc395x_trm
(braket
l_int|2
)braket
op_ne
op_minus
l_int|2
)paren
id|eeprom-&gt;NvramTarget
(braket
id|id
)braket
dot
id|NvmTarCfg0
op_assign
(paren
id|u8
)paren
id|dc395x_trm
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Cfg0 */
r_if
c_cond
(paren
id|dc395x_trm
(braket
l_int|1
)braket
op_ne
op_minus
l_int|2
)paren
id|eeprom-&gt;NvramTarget
(braket
id|id
)braket
dot
id|NvmTarPeriod
op_assign
(paren
id|u8
)paren
id|dc395x_trm
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Speed */
)brace
)brace
multiline_comment|/*&n; * Queueing philosphy:&n; * There are a couple of lists:&n; * - Query: Contains the Scsi Commands not yet turned into SRBs (per ACB)&n; *   (Note: For new EH, it is unecessary!)&n; * - Waiting: Contains a list of SRBs not yet sent (per DCB)&n; * - Free: List of free SRB slots&n; * &n; * If there are no waiting commands for the DCB, the new one is sent to the bus&n; * otherwise the oldest one is taken from the Waiting list and the new one is &n; * queued to the Waiting List&n; * &n; * Lists are managed using two pointers and eventually a counter&n; */
multiline_comment|/* Nomen est omen ... */
r_static
r_inline
r_void
DECL|function|DC395x_freetag
id|DC395x_freetag
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;TagNumber
OL
l_int|255
)paren
(brace
id|pDCB-&gt;TagMask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|pSRB-&gt;TagNumber
)paren
suffix:semicolon
multiline_comment|/* free tag mask */
id|pSRB-&gt;TagNumber
op_assign
l_int|255
suffix:semicolon
)brace
)brace
multiline_comment|/* Find cmd in SRB list */
DECL|function|DC395x_find_cmd
r_inline
r_static
r_struct
id|ScsiReqBlk
op_star
id|DC395x_find_cmd
c_func
(paren
id|Scsi_Cmnd
op_star
id|pcmd
comma
r_struct
id|ScsiReqBlk
op_star
id|start
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|psrb
op_assign
id|start
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|start
)paren
r_return
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|psrb-&gt;pcmd
op_eq
id|pcmd
)paren
r_return
id|psrb
suffix:semicolon
id|psrb
op_assign
id|psrb-&gt;pNextSRB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|psrb
op_logical_and
id|psrb
op_ne
id|start
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Append to Query List */
r_static
r_void
DECL|function|DC395x_Query_append
id|DC395x_Query_append
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Append cmd %li to Query&bslash;n&quot;
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
)paren
id|cmd-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;QueryCnt
)paren
id|pACB-&gt;pQueryHead
op_assign
id|cmd
suffix:semicolon
r_else
id|pACB-&gt;pQueryTail-&gt;host_scribble
op_assign
(paren
r_void
op_star
)paren
id|cmd
suffix:semicolon
id|pACB-&gt;pQueryTail
op_assign
id|cmd
suffix:semicolon
id|pACB-&gt;QueryCnt
op_increment
suffix:semicolon
id|pACB-&gt;CmdOutOfSRB
op_increment
suffix:semicolon
)brace
multiline_comment|/* Return next cmd from Query list */
DECL|function|DC395x_Query_get
r_static
id|Scsi_Cmnd
op_star
id|DC395x_Query_get
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
id|Scsi_Cmnd
op_star
id|pcmd
suffix:semicolon
id|pcmd
op_assign
id|pACB-&gt;pQueryHead
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcmd
)paren
r_return
id|pcmd
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Get cmd %li from Query&bslash;n&quot;
comma
id|pcmd-&gt;pid
)paren
suffix:semicolon
)paren
id|pACB-&gt;pQueryHead
op_assign
(paren
r_void
op_star
)paren
id|pcmd-&gt;host_scribble
suffix:semicolon
id|pcmd-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;pQueryHead
)paren
id|pACB-&gt;pQueryTail
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;QueryCnt
op_decrement
suffix:semicolon
r_return
id|pcmd
suffix:semicolon
)brace
multiline_comment|/* Return next free SRB */
DECL|function|DC395x_Free_get
r_static
id|__inline__
r_struct
id|ScsiReqBlk
op_star
id|DC395x_Free_get
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|pSRB
suffix:semicolon
multiline_comment|/*DC395x_Free_integrity (pACB); */
id|pSRB
op_assign
id|pACB-&gt;pFreeSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Out of Free SRBs :-(&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
(brace
id|pACB-&gt;pFreeSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|pSRB
suffix:semicolon
)brace
multiline_comment|/* Insert SRB oin top of free list */
r_static
id|__inline__
r_void
DECL|function|DC395x_Free_insert
id|DC395x_Free_insert
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Free SRB %p&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
)paren
id|pSRB-&gt;pNextSRB
op_assign
id|pACB-&gt;pFreeSRB
suffix:semicolon
id|pACB-&gt;pFreeSRB
op_assign
id|pSRB
suffix:semicolon
)brace
multiline_comment|/* Inserts a SRB to the top of the Waiting list */
r_static
id|__inline__
r_void
DECL|function|DC395x_Waiting_insert
id|DC395x_Waiting_insert
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: Insert pSRB %p cmd %li to Waiting&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
)paren
id|pSRB-&gt;pNextSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB-&gt;pWaitingSRB
)paren
id|pDCB-&gt;pWaitLast
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_increment
suffix:semicolon
)brace
multiline_comment|/* Queue SRB to waiting list */
r_static
id|__inline__
r_void
DECL|function|DC395x_Waiting_append
id|DC395x_Waiting_append
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: Append pSRB %p cmd %li to Waiting&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
)paren
id|pDCB-&gt;pWaitLast-&gt;pNextSRB
op_assign
id|pSRB
suffix:semicolon
r_else
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pWaitLast
op_assign
id|pSRB
suffix:semicolon
multiline_comment|/* No next one in waiting list */
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_increment
suffix:semicolon
multiline_comment|/*pDCB-&gt;pDCBACB-&gt;CmdInQ++; */
)brace
r_static
id|__inline__
r_void
DECL|function|DC395x_Going_append
id|DC395x_Going_append
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Append SRB %p to Going&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
)paren
multiline_comment|/* Append to the list of Going commands */
r_if
c_cond
(paren
id|pDCB-&gt;pGoingSRB
)paren
id|pDCB-&gt;pGoingLast-&gt;pNextSRB
op_assign
id|pSRB
suffix:semicolon
r_else
id|pDCB-&gt;pGoingSRB
op_assign
id|pSRB
suffix:semicolon
id|pDCB-&gt;pGoingLast
op_assign
id|pSRB
suffix:semicolon
multiline_comment|/* No next one in sent list */
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;GoingSRBCnt
op_increment
suffix:semicolon
)brace
multiline_comment|/* Find predecessor SRB */
DECL|function|DC395x_find_SRBpre
r_inline
r_static
r_struct
id|ScsiReqBlk
op_star
id|DC395x_find_SRBpre
c_func
(paren
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
r_struct
id|ScsiReqBlk
op_star
id|start
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|srb
op_assign
id|start
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|start
)paren
r_return
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|srb-&gt;pNextSRB
op_eq
id|pSRB
)paren
r_return
id|srb
suffix:semicolon
id|srb
op_assign
id|srb-&gt;pNextSRB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|srb
op_logical_and
id|srb
op_ne
id|start
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Remove SRB from SRB queue */
DECL|function|DC395x_rmv_SRB
r_inline
r_static
r_struct
id|ScsiReqBlk
op_star
id|DC395x_rmv_SRB
c_func
(paren
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
r_struct
id|ScsiReqBlk
op_star
id|pre
)paren
(brace
r_if
c_cond
(paren
id|pre-&gt;pNextSRB
op_ne
id|pSRB
)paren
id|pre
op_assign
id|DC395x_find_SRBpre
c_func
(paren
id|pSRB
comma
id|pre
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pre
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Internal ERROR: SRB to rmv not found in Q!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pre-&gt;pNextSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
multiline_comment|/*pSRB-&gt;pNextSRB = 0; */
r_return
id|pre
suffix:semicolon
)brace
multiline_comment|/* Remove SRB from Going queue */
r_static
r_void
DECL|function|DC395x_Going_remove
id|DC395x_Going_remove
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
r_struct
id|ScsiReqBlk
op_star
id|hint
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|pre
op_assign
l_int|0
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Remove SRB %p from Going&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Going_remove %p!&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pGoingSRB
)paren
id|pDCB-&gt;pGoingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hint
op_logical_and
id|hint-&gt;pNextSRB
op_eq
id|pSRB
)paren
id|pre
op_assign
id|DC395x_rmv_SRB
c_func
(paren
id|pSRB
comma
id|hint
)paren
suffix:semicolon
r_else
id|pre
op_assign
id|DC395x_rmv_SRB
c_func
(paren
id|pSRB
comma
id|pDCB-&gt;pGoingSRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pGoingLast
)paren
id|pDCB-&gt;pGoingLast
op_assign
id|pre
suffix:semicolon
id|pDCB-&gt;GoingSRBCnt
op_decrement
suffix:semicolon
)brace
multiline_comment|/* Remove SRB from Waiting queue */
r_static
r_void
DECL|function|DC395x_Waiting_remove
id|DC395x_Waiting_remove
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
r_struct
id|ScsiReqBlk
op_star
id|hint
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|pre
op_assign
l_int|0
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Remove SRB %p from Waiting&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Waiting_remove %p!&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pWaitingSRB
)paren
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hint
op_logical_and
id|hint-&gt;pNextSRB
op_eq
id|pSRB
)paren
id|pre
op_assign
id|DC395x_rmv_SRB
c_func
(paren
id|pSRB
comma
id|hint
)paren
suffix:semicolon
r_else
id|pre
op_assign
id|DC395x_rmv_SRB
c_func
(paren
id|pSRB
comma
id|pDCB-&gt;pWaitingSRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pDCB-&gt;pWaitLast
)paren
id|pDCB-&gt;pWaitLast
op_assign
id|pre
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_decrement
suffix:semicolon
)brace
multiline_comment|/* Moves SRB from Going list to the top of Waiting list */
r_static
r_void
DECL|function|DC395x_Going_to_Waiting
id|DC395x_Going_to_Waiting
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Going_to_Waiting (SRB %p) pid = %li&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
)paren
multiline_comment|/* Remove SRB from Going */
id|DC395x_Going_remove
c_func
(paren
id|pDCB
comma
id|pSRB
comma
l_int|0
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;GtW *&quot;
)paren
suffix:semicolon
multiline_comment|/* Insert on top of Waiting */
id|DC395x_Waiting_insert
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/* Tag Mask must be freed elsewhere ! (KG, 99/06/18) */
)brace
multiline_comment|/* Moves first SRB from Waiting list to Going list */
r_static
id|__inline__
r_void
DECL|function|DC395x_Waiting_to_Going
id|DC395x_Waiting_to_Going
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
multiline_comment|/* Remove from waiting list */
id|DEBUG0
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: Remove SRB %p from head of Waiting&bslash;n&quot;
comma
id|pSRB
)paren
suffix:semicolon
)paren
id|DC395x_Waiting_remove
c_func
(paren
id|pDCB
comma
id|pSRB
comma
l_int|0
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;WtG *&quot;
)paren
suffix:semicolon
id|DC395x_Going_append
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_void
id|DC395x_waiting_timed_out
c_func
(paren
r_int
r_int
id|ptr
)paren
suffix:semicolon
multiline_comment|/* Sets the timer to wake us up */
r_static
r_void
DECL|function|DC395x_waiting_timer
id|DC395x_waiting_timer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_int
r_int
id|to
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
r_return
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
id|pACB-&gt;Waiting_Timer.function
op_assign
id|DC395x_waiting_timed_out
suffix:semicolon
id|pACB-&gt;Waiting_Timer.data
op_assign
(paren
r_int
r_int
)paren
id|pACB
suffix:semicolon
r_if
c_cond
(paren
id|time_before
(paren
id|jiffies
op_plus
id|to
comma
id|pACB-&gt;pScsiHost-&gt;last_reset
op_minus
id|HZ
op_div
l_int|2
)paren
)paren
id|pACB-&gt;Waiting_Timer.expires
op_assign
id|pACB-&gt;pScsiHost-&gt;last_reset
op_minus
id|HZ
op_div
l_int|2
op_plus
l_int|1
suffix:semicolon
r_else
id|pACB-&gt;Waiting_Timer.expires
op_assign
id|jiffies
op_plus
id|to
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Send the next command from the waiting list to the bus */
DECL|function|DC395x_Waiting_process
r_void
id|DC395x_Waiting_process
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|ptr
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|ptr1
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|pSRB
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pACB-&gt;pActiveDCB
)paren
op_logical_or
(paren
id|pACB-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
id|ptr
op_assign
id|pACB-&gt;pDCBRunRobin
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
(brace
multiline_comment|/* This can happen! */
id|ptr
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
id|ptr
suffix:semicolon
)brace
id|ptr1
op_assign
id|ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr1
)paren
r_return
suffix:semicolon
r_do
(brace
multiline_comment|/* Make sure, the next another device gets scheduled ... */
id|pACB-&gt;pDCBRunRobin
op_assign
id|ptr1-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB
op_assign
id|ptr1-&gt;pWaitingSRB
)paren
op_logical_or
(paren
id|ptr1-&gt;MaxCommand
op_le
id|ptr1-&gt;GoingSRBCnt
)paren
)paren
id|ptr1
op_assign
id|ptr1-&gt;pNextDCB
suffix:semicolon
r_else
(brace
multiline_comment|/* Try to send to the bus */
r_if
c_cond
(paren
op_logical_neg
id|DC395x_StartSCSI
c_func
(paren
id|pACB
comma
id|ptr1
comma
id|pSRB
)paren
)paren
id|DC395x_Waiting_to_Going
c_func
(paren
id|ptr1
comma
id|pSRB
)paren
suffix:semicolon
r_else
id|DC395x_waiting_timer
c_func
(paren
id|pACB
comma
id|HZ
op_div
l_int|50
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|ptr1
op_ne
id|ptr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Wake up waiting queue */
DECL|function|DC395x_waiting_timed_out
r_void
id|DC395x_waiting_timed_out
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|ptr
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Debug: Waiting queue woken up by timer.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|DC395x_LOCK_IO
c_func
(paren
id|pACB-&gt;pScsiHost
)paren
suffix:semicolon
id|DC395x_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|DC395x_UNLOCK_IO
c_func
(paren
id|pACB-&gt;pScsiHost
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the DCB for a given ID/LUN combination */
DECL|function|DC395x_findDCB
r_static
r_inline
r_struct
id|DeviceCtlBlk
op_star
id|DC395x_findDCB
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
id|u8
id|id
comma
id|u8
id|lun
)paren
(brace
r_return
id|pACB-&gt;children
(braket
id|id
)braket
(braket
id|lun
)braket
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function: static void DC395x_SendSRB (struct AdapterCtlBlk* pACB, struct ScsiReqBlk* pSRB)&n; *&n; * Purpose: Send SCSI Request Block (pSRB) to adapter (pACB)&n; *&n; *            DC395x_queue_command&n; *            DC395x_Waiting_process&n; *&n; ***********************************************************************/
r_static
r_void
DECL|function|DC395x_SendSRB
id|DC395x_SendSRB
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pDCB-&gt;MaxCommand
op_le
id|pDCB-&gt;GoingSRBCnt
)paren
op_logical_or
(paren
id|pACB-&gt;pActiveDCB
)paren
op_logical_or
(paren
id|pACB-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
)paren
(brace
id|DC395x_Waiting_append
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|DC395x_Waiting_append
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/*      pSRB = GetWaitingSRB(pDCB); */
multiline_comment|/* non-existent */
id|pSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
multiline_comment|/* Remove from waiting list */
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|pSRB-&gt;pNextSRB
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB-&gt;pWaitingSRB
)paren
id|pDCB-&gt;pWaitLast
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|DC395x_StartSCSI
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
)paren
id|DC395x_Going_append
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
r_else
(brace
id|DC395x_Waiting_insert
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_waiting_timer
c_func
(paren
id|pACB
comma
id|HZ
op_div
l_int|50
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *********************************************************************&n; *&n; * Function: static void DC395x_BuildSRB (Scsi_Cmd *pcmd, struct DeviceCtlBlk* pDCB, struct ScsiReqBlk* pSRB)&n; *&n; *  Purpose: Prepare SRB for being sent to Device DCB w/ command *pcmd&n; *&n; *********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_BuildSRB
id|DC395x_BuildSRB
c_func
(paren
id|Scsi_Cmnd
op_star
id|pcmd
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
r_int
id|i
comma
id|max
suffix:semicolon
r_struct
id|SGentry
op_star
id|sgp
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sl
suffix:semicolon
id|u32
id|request_size
suffix:semicolon
r_int
id|dir
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_BuildSRB..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*memset (pSRB, 0, sizeof (struct ScsiReqBlk)); */
id|pSRB-&gt;pSRBDCB
op_assign
id|pDCB
suffix:semicolon
id|pSRB-&gt;pcmd
op_assign
id|pcmd
suffix:semicolon
multiline_comment|/* Find out about direction */
id|dir
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
op_logical_and
id|dir
op_ne
id|PCI_DMA_NONE
)paren
(brace
r_int
r_int
id|len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* TODO: In case usg_sg and the no of segments differ, things&n;&t;&t; * will probably go wrong. */
id|max
op_assign
id|pSRB-&gt;SRBSGCount
op_assign
id|pci_map_sg
c_func
(paren
id|pDCB-&gt;pDCBACB-&gt;pdev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|pcmd-&gt;request_buffer
comma
id|pcmd-&gt;use_sg
comma
id|dir
)paren
suffix:semicolon
id|sgp
op_assign
id|pSRB-&gt;SegmentX
suffix:semicolon
id|request_size
op_assign
id|pcmd-&gt;request_bufflen
suffix:semicolon
macro_line|#ifdef DC395x_SGPARANOIA
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: BuildSRB: Bufflen = %d, buffer = %p, use_sg = %d&bslash;n&quot;
comma
id|pcmd-&gt;request_bufflen
comma
id|pcmd-&gt;request_buffer
comma
id|pcmd-&gt;use_sg
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Mapped %i Segments to %i&bslash;n&quot;
comma
id|pcmd-&gt;use_sg
comma
id|pSRB-&gt;SRBSGCount
)paren
suffix:semicolon
macro_line|#endif
id|sl
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
id|pSRB-&gt;virt_addr
op_assign
id|page_address
c_func
(paren
id|sl-&gt;page
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|busaddr
op_assign
(paren
id|u32
)paren
id|sg_dma_address
c_func
(paren
op_amp
id|sl
(braket
id|i
)braket
)paren
suffix:semicolon
id|u32
id|seglen
op_assign
(paren
id|u32
)paren
id|sl
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|sgp
(braket
id|i
)braket
dot
id|address
op_assign
id|busaddr
suffix:semicolon
id|sgp
(braket
id|i
)braket
dot
id|length
op_assign
id|seglen
suffix:semicolon
id|len
op_add_assign
id|seglen
suffix:semicolon
macro_line|#ifdef DC395x_SGPARANOIA
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Setting up sgp %d, address = 0x%08x, length = %d, tot len = %d&bslash;n&quot;
comma
id|i
comma
id|busaddr
comma
id|seglen
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
)brace
id|sgp
op_add_assign
id|max
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Fixup for last buffer too big as it is allocated on even page boundaries */
r_if
c_cond
(paren
id|len
OG
id|request_size
)paren
(brace
macro_line|#if defined(DC395x_DEBUG_KG) || defined (DC395x_SGPARANOIA)
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Fixup SG total length: %d-&gt;%d, last seg %d-&gt;%d&bslash;n&quot;
comma
id|len
comma
id|request_size
comma
id|sgp-&gt;length
comma
id|sgp-&gt;length
op_minus
(paren
id|len
op_minus
id|request_size
)paren
)paren
suffix:semicolon
macro_line|#endif
id|sgp-&gt;length
op_sub_assign
(paren
id|len
op_minus
id|request_size
)paren
suffix:semicolon
id|len
op_assign
id|request_size
suffix:semicolon
)brace
multiline_comment|/* WIDE padding */
r_if
c_cond
(paren
id|pDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
op_logical_and
id|len
op_mod
l_int|2
)paren
(brace
id|len
op_increment
suffix:semicolon
id|sgp-&gt;length
op_increment
suffix:semicolon
)brace
id|pSRB-&gt;SRBTotalXferLength
op_assign
id|len
suffix:semicolon
multiline_comment|/*? */
multiline_comment|/* Hopefully this does not cross a page boundary ... */
id|pSRB-&gt;SRBSGBusAddr
op_assign
id|pci_map_single
c_func
(paren
id|pDCB-&gt;pDCBACB-&gt;pdev
comma
id|pSRB-&gt;SegmentX
comma
r_sizeof
(paren
r_struct
id|SGentry
)paren
op_star
id|DC395x_MAX_SG_LISTENTRY
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
macro_line|#ifdef DC395x_SGPARANOIA
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Map SG descriptor list %p (%05x) to %08x&bslash;n&quot;
comma
id|pSRB-&gt;SegmentX
comma
r_sizeof
(paren
r_struct
id|SGentry
)paren
op_star
id|DC395x_MAX_SG_LISTENTRY
comma
id|pSRB-&gt;SRBSGBusAddr
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
op_logical_and
id|dir
op_ne
id|PCI_DMA_NONE
)paren
(brace
id|u32
id|len
op_assign
id|pcmd-&gt;request_bufflen
suffix:semicolon
multiline_comment|/* Actual request size */
id|pSRB-&gt;SRBSGCount
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
op_assign
id|pci_map_single
c_func
(paren
id|pDCB-&gt;pDCBACB-&gt;pdev
comma
id|pcmd-&gt;request_buffer
comma
id|len
comma
id|dir
)paren
suffix:semicolon
multiline_comment|/* WIDE padding */
r_if
c_cond
(paren
id|pDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
op_logical_and
id|len
op_mod
l_int|2
)paren
id|len
op_increment
suffix:semicolon
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|length
op_assign
id|len
suffix:semicolon
id|pSRB-&gt;SRBTotalXferLength
op_assign
id|len
suffix:semicolon
id|pSRB-&gt;virt_addr
op_assign
id|pcmd-&gt;request_buffer
suffix:semicolon
id|pSRB-&gt;SRBSGBusAddr
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DC395x_SGPARANOIA
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: BuildSRB: len = %d, buffer = %p, use_sg = %d, map %08x&bslash;n&quot;
comma
id|len
comma
id|pcmd-&gt;request_buffer
comma
id|pcmd-&gt;use_sg
comma
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|pSRB-&gt;SRBSGCount
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBTotalXferLength
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBSGBusAddr
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;virt_addr
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DC395x_SGPARANOIA
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: BuildSRB: buflen = %d, buffer = %p, use_sg = %d, NOMAP %08x&bslash;n&quot;
comma
id|pcmd-&gt;bufflen
comma
id|pcmd-&gt;request_buffer
comma
id|pcmd-&gt;use_sg
comma
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
id|pSRB-&gt;SRBSGIndex
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBFlag
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;RetryCnt
op_assign
l_int|0
suffix:semicolon
macro_line|#if DC395x_SGPARANOIA
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|pSRB-&gt;debugtrace
op_amp
(paren
id|DEBUGTRACEBUFSZ
op_minus
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: SRB %i (%p): debugtrace %p corrupt!&bslash;n&quot;
comma
(paren
id|pSRB
op_minus
id|pDCB-&gt;pDCBACB-&gt;SRB_array
)paren
op_div
r_sizeof
(paren
r_struct
id|ScsiReqBlk
)paren
comma
id|pSRB
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef DC395x_TRACEDEBUG
id|pSRB-&gt;debugpos
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;debugtrace
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;pid %li(%li):%02x %02x..(%i-%i) *&quot;
comma
id|pcmd-&gt;pid
comma
id|jiffies
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pcmd-&gt;cmnd
(braket
l_int|1
)braket
comma
id|pcmd-&gt;device-&gt;id
comma
id|pcmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|pSRB-&gt;TagNumber
op_assign
id|TAG_NONE
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/* initial phase */
id|pSRB-&gt;EndMessage
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Put cmnd from Query to Waiting list and send next Waiting cmnd */
DECL|function|DC395x_Query_to_Waiting
r_static
r_void
id|DC395x_Query_to_Waiting
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
id|Scsi_Cmnd
op_star
id|pcmd
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|pSRB
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;ACBFlag
op_amp
(paren
id|RESET_DETECT
op_plus
id|RESET_DONE
op_plus
id|RESET_DEV
)paren
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|pACB-&gt;QueryCnt
)paren
(brace
id|pSRB
op_assign
id|DC395x_Free_get
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
r_return
suffix:semicolon
id|pcmd
op_assign
id|DC395x_Query_get
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcmd
)paren
(brace
id|DC395x_Free_insert
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* should not happen */
id|pDCB
op_assign
id|DC395x_findDCB
c_func
(paren
id|pACB
comma
id|pcmd-&gt;device-&gt;id
comma
id|pcmd-&gt;device-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|DC395x_Free_insert
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|DC395X_NAME
l_string|&quot;: Command in queue to non-existing device!&bslash;n&quot;
)paren
suffix:semicolon
id|pcmd-&gt;result
op_assign
id|MK_RES
c_func
(paren
id|DRIVER_ERROR
comma
id|DID_ERROR
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*DC395x_UNLOCK_ACB_NI; */
id|pcmd
op_member_access_from_pointer
id|done
c_func
(paren
id|pcmd
)paren
suffix:semicolon
multiline_comment|/*DC395x_LOCK_ACB_NI; */
)brace
id|DC395x_BuildSRB
c_func
(paren
id|pcmd
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_Waiting_append
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/***********************************************************************&n; * Function : static int DC395x_queue_command (Scsi_Cmnd *cmd,&n; *&t;&t;&t;&t;&t;       void (*done)(Scsi_Cmnd *))&n; *&n; * Purpose : enqueues a SCSI command&n; *&n; * Inputs : cmd - SCSI command, done - callback function called on &n; *&t;    completion, with a pointer to the command descriptor.&n; *&n; * Returns : (depending on kernel version)&n; * 2.0.x: always return 0&n; * 2.1.x: old model: (use_new_eh_code == 0): like 2.0.x&n; *&t;  new model: return 0 if successful&n; *&t;  &t;     return 1 if command cannot be queued (queue full)&n; *&t;&t;     command will be inserted in midlevel queue then ...&n; *&n; ***********************************************************************/
r_static
r_int
DECL|function|DC395x_queue_command
id|DC395x_queue_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|pSRB
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|DEBUG0
c_func
(paren
multiline_comment|/*  if(pACB-&gt;scan_devices) */
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Queue Cmd=%02x,Tgt=%d,LUN=%d (pid=%li)&bslash;n&quot;
comma
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
)paren
id|DEBUGRECURSION
c_func
(paren
r_if
(paren
id|in_driver
op_increment
OG
id|NORM_REC_LVL
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: %i queue_command () recursion? (pid=%li)&bslash;n&quot;
comma
id|in_driver
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
)paren
multiline_comment|/* Assume BAD_TARGET; will be cleared later */
id|cmd-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd-&gt;device-&gt;id
op_ge
id|pACB-&gt;pScsiHost-&gt;max_id
)paren
op_logical_or
(paren
id|cmd-&gt;device-&gt;lun
op_ge
id|pACB-&gt;pScsiHost-&gt;max_lun
)paren
op_logical_or
(paren
id|cmd-&gt;device-&gt;lun
OG
l_int|31
)paren
)paren
(brace
multiline_comment|/*      printk (KERN_INFO DC395X_NAME &quot;Ignore target %d lun %d&bslash;n&quot;,&n;&t;&t;   cmd-&gt;device-&gt;id, cmd-&gt;device-&gt;lun); */
id|DEBUGRECURSION
c_func
(paren
id|in_driver
op_decrement
suffix:semicolon
)paren
multiline_comment|/*return 1; */
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pACB-&gt;DCBmap
(braket
id|cmd-&gt;device-&gt;id
)braket
op_amp
(paren
l_int|1
op_lshift
id|cmd-&gt;device-&gt;lun
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Ignore target %02x lun %02x&bslash;n&quot;
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
multiline_comment|/*return 1; */
id|DEBUGRECURSION
c_func
(paren
id|in_driver
op_decrement
suffix:semicolon
)paren
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|pDCB
op_assign
id|DC395x_findDCB
c_func
(paren
id|pACB
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
multiline_comment|/* should never happen */
id|printk
c_func
(paren
id|KERN_ERR
id|DC395X_NAME
l_string|&quot;: no DCB failed, target %02x lun %02x&bslash;n&quot;
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: No DCB in queuecommand (2)!&bslash;n&quot;
)paren
suffix:semicolon
id|DEBUGRECURSION
c_func
(paren
id|in_driver
op_decrement
suffix:semicolon
)paren
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|pACB-&gt;Cmds
op_increment
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|cmd-&gt;result
op_assign
l_int|0
suffix:semicolon
id|DC395x_Query_to_Waiting
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;QueryCnt
)paren
(brace
multiline_comment|/* Unsent commands ? */
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: QueryCnt != 0&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|DC395x_Query_append
c_func
(paren
id|cmd
comma
id|pACB
)paren
suffix:semicolon
id|DC395x_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pDCB-&gt;pWaitingSRB
)paren
(brace
id|pSRB
op_assign
id|DC395x_Free_get
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
r_if
(paren
op_logical_neg
id|pSRB
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: No free SRB but Waiting&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Free SRB w/ Waiting&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
(brace
id|DC395x_Query_append
c_func
(paren
id|cmd
comma
id|pACB
)paren
suffix:semicolon
)brace
r_else
(brace
id|DC395x_BuildSRB
c_func
(paren
id|cmd
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_Waiting_append
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
)brace
id|DC395x_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
(brace
id|pSRB
op_assign
id|DC395x_Free_get
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
r_if
(paren
op_logical_neg
id|pSRB
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: No free SRB w/o Waiting&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Free SRB w/o Waiting&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
(brace
id|DC395x_Query_append
c_func
(paren
id|cmd
comma
id|pACB
)paren
suffix:semicolon
id|DC395x_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
(brace
id|DC395x_BuildSRB
c_func
(paren
id|cmd
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_SendSRB
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*DC395x_ACB_LOCK(pACB,acb_flags); */
id|DEBUG1
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; ... command (pid %li) queued successfully.&bslash;n&quot;
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
)paren
id|DEBUGRECURSION
c_func
(paren
id|in_driver
op_decrement
suffix:semicolon
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function static int DC395x_slave_alloc()&n; *&n; * Purpose: Allocate DCB&n; ***********************************************************************/
DECL|function|DC395x_slave_alloc
r_static
r_int
id|DC395x_slave_alloc
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|pACB
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|dummy
suffix:semicolon
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|sdp-&gt;host-&gt;hostdata
suffix:semicolon
id|DC395x_initDCB
c_func
(paren
id|pACB
comma
op_amp
id|dummy
comma
id|sdp-&gt;id
comma
id|sdp-&gt;lun
)paren
suffix:semicolon
r_return
id|dummy
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|DC395x_slave_destroy
r_static
r_void
id|DC395x_slave_destroy
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|ACB
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|DCB
suffix:semicolon
id|ACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|sdp-&gt;host-&gt;hostdata
suffix:semicolon
id|DCB
op_assign
id|DC395x_findDCB
c_func
(paren
id|ACB
comma
id|sdp-&gt;id
comma
id|sdp-&gt;lun
)paren
suffix:semicolon
id|DC395x_remove_dev
c_func
(paren
id|ACB
comma
id|DCB
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************************************************&n; * Function : static void DC395_updateDCB()&n; *&n; * Purpose :  Set the configuration dependent DCB parameters&n; ***********************************************************************/
r_void
DECL|function|DC395x_updateDCB
id|DC395x_updateDCB
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
)paren
(brace
multiline_comment|/* Prevent disconnection of narrow devices if this_id &gt; 7 */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_WIDE_NEGO
)paren
op_logical_and
id|pACB-&gt;pScsiHost-&gt;this_id
OG
l_int|7
)paren
id|pDCB-&gt;DevMode
op_and_assign
op_complement
id|NTC_DO_DISCONNECT
suffix:semicolon
multiline_comment|/* TagQ w/o DisCn is impossible */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_DISCONNECT
)paren
)paren
id|pDCB-&gt;DevMode
op_and_assign
op_complement
id|NTC_DO_TAG_QUEUEING
suffix:semicolon
id|pDCB-&gt;IdentifyMsg
op_assign
id|IDENTIFY
c_func
(paren
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_DISCONNECT
)paren
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|pDCB-&gt;SyncMode
op_and_assign
id|EN_TAG_QUEUEING
op_or
id|SYNC_NEGO_DONE
op_or
id|WIDE_NEGO_DONE
multiline_comment|/*| EN_ATN_STOP */
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_TAG_QUEUEING
)paren
(brace
r_if
c_cond
(paren
id|pDCB-&gt;SyncMode
op_amp
id|EN_TAG_QUEUEING
)paren
id|pDCB-&gt;MaxCommand
op_assign
id|pACB-&gt;TagMaxNum
suffix:semicolon
)brace
r_else
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|EN_TAG_QUEUEING
suffix:semicolon
id|pDCB-&gt;MaxCommand
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_SYNC_NEGO
)paren
id|pDCB-&gt;SyncMode
op_or_assign
id|SYNC_NEGO_ENABLE
suffix:semicolon
r_else
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
(paren
id|SYNC_NEGO_DONE
op_or
id|SYNC_NEGO_ENABLE
)paren
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_and_assign
op_complement
l_int|0x0f
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_WIDE_NEGO
op_logical_and
id|pACB-&gt;Config
op_amp
id|HCC_WIDE_CARD
)paren
id|pDCB-&gt;SyncMode
op_or_assign
id|WIDE_NEGO_ENABLE
suffix:semicolon
r_else
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
(paren
id|WIDE_NEGO_DONE
op_or
id|WIDE_NEGO_ENABLE
)paren
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_and_assign
op_complement
id|WIDE_SYNC
suffix:semicolon
)brace
multiline_comment|/*if (! (pDCB-&gt;DevMode &amp; EN_DISCONNECT_)) pDCB-&gt;SyncMode &amp;= ~EN_ATN_STOP; */
)brace
multiline_comment|/*&n; *********************************************************************&n; *&n; * Function   : DC395x_bios_param&n; * Description: Return the disk geometry for the given SCSI device.&n; *********************************************************************&n; */
r_static
r_int
DECL|function|DC395x_bios_param
id|DC395x_bios_param
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdev
comma
r_struct
id|block_device
op_star
id|bdev
comma
id|sector_t
id|capacity
comma
r_int
op_star
id|info
)paren
(brace
macro_line|#ifdef CONFIG_SCSI_DC395x_TRMS1040_TRADMAP
r_int
id|heads
comma
id|sectors
comma
id|cylinders
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|pACB
suffix:semicolon
r_int
id|size
op_assign
id|capacity
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;:DC395x_bios_param..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|sdev-&gt;host-&gt;hostdata
suffix:semicolon
id|heads
op_assign
l_int|64
suffix:semicolon
id|sectors
op_assign
l_int|32
suffix:semicolon
id|cylinders
op_assign
id|size
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pACB-&gt;Gmode2
op_amp
id|NAC_GREATER_1G
)paren
op_logical_and
(paren
id|cylinders
OG
l_int|1024
)paren
)paren
(brace
id|heads
op_assign
l_int|255
suffix:semicolon
id|sectors
op_assign
l_int|63
suffix:semicolon
id|cylinders
op_assign
id|size
op_div
(paren
id|heads
op_star
id|sectors
)paren
suffix:semicolon
)brace
id|geom
(braket
l_int|0
)braket
op_assign
id|heads
suffix:semicolon
id|geom
(braket
l_int|1
)braket
op_assign
id|sectors
suffix:semicolon
id|geom
(braket
l_int|2
)braket
op_assign
id|cylinders
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
id|scsicam_bios_param
c_func
(paren
id|bdev
comma
id|capacity
comma
id|info
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * DC395x register dump&n; */
r_void
DECL|function|DC395x_dumpinfo
id|DC395x_dumpinfo
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|u16
id|pstat
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pACB-&gt;pdev
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_STATUS
comma
op_amp
id|pstat
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
op_logical_and
id|pDCB
)paren
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;pcmd
)paren
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: dump: SRB %p: cmd %p OOOPS!&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;pcmd
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: dump: SRB %p: cmd %p pid %li: %02x (%02i-%i)&bslash;n&quot;
comma
id|pSRB
comma
id|pSRB-&gt;pcmd
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;id
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              SGList %p Cnt %i Idx %i Len %i&bslash;n&quot;
comma
id|pSRB-&gt;SegmentX
comma
id|pSRB-&gt;SRBSGCount
comma
id|pSRB-&gt;SRBSGIndex
comma
id|pSRB-&gt;SRBTotalXferLength
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;              State %04x Status %02x Phase %02x (%sconn.)&bslash;n&quot;
comma
id|pSRB-&gt;SRBState
comma
id|pSRB-&gt;SRBStatus
comma
id|pSRB-&gt;ScsiPhase
comma
(paren
id|pACB-&gt;pActiveDCB
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;not&quot;
)paren
suffix:semicolon
id|TRACEOUT
c_func
(paren
l_string|&quot;        %s&bslash;n&quot;
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: dump: SCSI block&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;              Status %04x FIFOCnt %02x Signals %02x IRQStat %02x&bslash;n&quot;
comma
id|DC395x_read16
c_func
(paren
id|TRM_S1040_SCSI_STATUS
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_SIGNAL
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_INTSTATUS
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;              Sync %02x Target %02x RSelID %02x SCSICtr %08x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_SYNC
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_TARGETID
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_IDMSG
)paren
comma
id|DC395x_read32
c_func
(paren
id|TRM_S1040_SCSI_COUNTER
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;              IRQEn %02x Config %04x Cfg2 %02x Cmd %02x SelTO %02x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_INTEN
)paren
comma
id|DC395x_read16
c_func
(paren
id|TRM_S1040_SCSI_CONFIG0
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_CONFIG2
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_TIMEOUT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: dump: DMA block&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;              Cmd %04x FIFOCnt %02x FStat %02x IRQStat %02x IRQEn %02x Cfg %04x&bslash;n&quot;
comma
id|DC395x_read16
c_func
(paren
id|TRM_S1040_DMA_COMMAND
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOSTAT
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_STATUS
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_INTEN
)paren
comma
id|DC395x_read16
c_func
(paren
id|TRM_S1040_DMA_CONFIG
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;              TCtr %08x CTCtr %08x Addr %08x%08x&bslash;n&quot;
comma
id|DC395x_read32
c_func
(paren
id|TRM_S1040_DMA_XCNT
)paren
comma
id|DC395x_read32
c_func
(paren
id|TRM_S1040_DMA_CXCNT
)paren
comma
id|DC395x_read32
c_func
(paren
id|TRM_S1040_DMA_XHIGHADDR
)paren
comma
id|DC395x_read32
c_func
(paren
id|TRM_S1040_DMA_XLOWADDR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: dump: Misc: GCtrl %02x GStat %02x GTmr %02x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_GEN_CONTROL
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_GEN_STATUS
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_GEN_TIMER
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: dump: PCI Status %04x&bslash;n&quot;
comma
id|pstat
)paren
suffix:semicolon
)brace
DECL|function|DC395x_clrfifo
r_static
r_inline
r_void
id|DC395x_clrfifo
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_char
op_star
id|txt
)paren
(brace
macro_line|#ifdef DC395x_DEBUGFIFO
id|u8
id|lines
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_SIGNAL
)paren
suffix:semicolon
id|u8
id|fifocnt
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|fifocnt
op_amp
l_int|0x40
)paren
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Clr FIFO (%i bytes) on phase %02x in %s&bslash;n&quot;
comma
id|fifocnt
op_amp
l_int|0x3f
comma
id|lines
comma
id|txt
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pACB-&gt;pActiveDCB
op_logical_and
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|pSRB
op_assign
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;#*&quot;
)paren
suffix:semicolon
)brace
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_CLRFIFO
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; *&n; *&t;&t;DC395x_reset      DC395x_ScsiRstDetect&n; *&n; ********************************************************************&n; */
DECL|function|DC395x_ResetDevParam
r_static
r_void
id|DC395x_ResetDevParam
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCBTemp
suffix:semicolon
r_struct
id|NvRamType
op_star
id|eeprom
suffix:semicolon
id|u8
id|PeriodIndex
suffix:semicolon
id|u16
id|index
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_ResetDevParam..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|pDCBTemp
op_assign
id|pDCB
suffix:semicolon
r_do
(brace
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
(paren
id|SYNC_NEGO_DONE
op_plus
id|WIDE_NEGO_DONE
)paren
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
id|index
op_assign
id|pACB-&gt;AdapterIndex
suffix:semicolon
id|eeprom
op_assign
op_amp
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
suffix:semicolon
id|pDCB-&gt;DevMode
op_assign
id|eeprom-&gt;NvramTarget
(braket
id|pDCB-&gt;TargetID
)braket
dot
id|NvmTarCfg0
suffix:semicolon
multiline_comment|/*pDCB-&gt;AdpMode = eeprom-&gt;NvramChannelCfg; */
id|PeriodIndex
op_assign
id|eeprom-&gt;NvramTarget
(braket
id|pDCB-&gt;TargetID
)braket
dot
id|NvmTarPeriod
op_amp
l_int|0x07
suffix:semicolon
id|pDCB-&gt;MinNegoPeriod
op_assign
id|dc395x_clock_period
(braket
id|PeriodIndex
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_WIDE_NEGO
)paren
op_logical_or
op_logical_neg
(paren
id|pACB-&gt;Config
op_amp
id|HCC_WIDE_CARD
)paren
)paren
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|WIDE_NEGO_ENABLE
suffix:semicolon
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pDCBTemp
op_ne
id|pDCB
op_logical_and
id|pDCB
op_ne
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *********************************************************************&n; * Function : int DC395x_eh_bus_reset(Scsi_Cmnd *cmd)&n; * Purpose  : perform a hard reset on the SCSI bus&n; * Inputs   : cmd - some command for this host (for fetching hooks)&n; * Returns  : SUCCESS (0x2002) on success, else FAILED (0x2003).&n; *********************************************************************&n; */
DECL|function|DC395x_eh_bus_reset
r_static
r_int
id|DC395x_eh_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|pACB
suffix:semicolon
multiline_comment|/*u32         acb_flags=0; */
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: reset requested!&bslash;n&quot;
)paren
suffix:semicolon
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
multiline_comment|/* mid level guarantees no recursion */
multiline_comment|/*DC395x_ACB_LOCK(pACB,acb_flags); */
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * disable interrupt    &n;&t; */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_INTEN
comma
l_int|0x00
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_INTEN
comma
l_int|0x00
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_RSTMODULE
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_CONTROL
comma
id|DMARESETMODULE
)paren
suffix:semicolon
id|DC395x_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
multiline_comment|/* We may be in serious trouble. Wait some seconds */
id|pACB-&gt;pScsiHost-&gt;last_reset
op_assign
id|jiffies
op_plus
l_int|3
op_star
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc395x_trm_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
dot
id|NvramDelayTime
suffix:semicolon
multiline_comment|/*&n;&t; * re-enable interrupt      &n;&t; */
multiline_comment|/* Clear SCSI FIFO          */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_CONTROL
comma
id|CLRXFIFO
)paren
suffix:semicolon
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;reset&quot;
)paren
suffix:semicolon
multiline_comment|/* Delete pending IRQ */
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_INTSTATUS
)paren
suffix:semicolon
id|DC395x_basic_config
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|DC395x_ResetDevParam
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|DC395x_DoingSRB_Done
c_func
(paren
id|pACB
comma
id|DID_RESET
comma
id|cmd
comma
l_int|0
)paren
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* RESET_DETECT, RESET_DONE ,RESET_DEV */
id|DC395x_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
multiline_comment|/*DC395x_ACB_LOCK(pACB,acb_flags); */
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; *********************************************************************&n; * Function : int DC395x_eh_abort(Scsi_Cmnd *cmd)&n; * Purpose  : abort an errant SCSI command&n; * Inputs   : cmd - command to be aborted&n; * Returns  : SUCCESS (0x2002) on success, else FAILED (0x2003).&n; *********************************************************************&n; */
DECL|function|DC395x_eh_abort
r_static
r_int
id|DC395x_eh_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
multiline_comment|/*&n;&t; * Look into our command queues: If it has not been sent already,&n;&t; * we remove it and return success. Otherwise fail.&n;&t; * First check the Query Queues, then the Waiting ones&n;&t; */
r_struct
id|AdapterCtlBlk
op_star
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|pSRB
suffix:semicolon
r_int
id|cnt
op_assign
id|pACB-&gt;QueryCnt
suffix:semicolon
id|Scsi_Cmnd
op_star
id|pcmd
suffix:semicolon
id|Scsi_Cmnd
op_star
id|last
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DC395x_eh_abort: cmd %p (pid %li, %02i-%i) &quot;
comma
id|cmd
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pcmd
op_assign
id|pACB-&gt;pQueryHead
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
id|last
op_assign
id|pcmd
comma
id|pcmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|pcmd-&gt;host_scribble
)paren
(brace
r_if
c_cond
(paren
id|pcmd
op_eq
id|cmd
)paren
(brace
multiline_comment|/* unqueue */
r_if
c_cond
(paren
id|last
)paren
(brace
id|last-&gt;host_scribble
op_assign
id|pcmd-&gt;host_scribble
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcmd-&gt;host_scribble
)paren
id|pACB-&gt;pQueryTail
op_assign
id|last
suffix:semicolon
)brace
r_else
(brace
id|pACB-&gt;pQueryHead
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|pcmd-&gt;host_scribble
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcmd-&gt;host_scribble
)paren
id|pACB-&gt;pQueryTail
op_assign
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;found in Query queue :-)&bslash;n&quot;
)paren
suffix:semicolon
id|pACB-&gt;QueryCnt
op_decrement
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
)brace
id|pDCB
op_assign
id|DC395x_findDCB
c_func
(paren
id|pACB
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;no DCB !&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|pSRB
op_assign
id|DC395x_find_cmd
c_func
(paren
id|cmd
comma
id|pDCB-&gt;pWaitingSRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
(brace
id|DC395x_Waiting_remove
c_func
(paren
id|pDCB
comma
id|pSRB
comma
l_int|0
)paren
suffix:semicolon
id|DC395x_pci_unmap_sense
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_pci_unmap
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_freetag
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_Free_insert
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;found in waiting queue :-)&bslash;n&quot;
)paren
suffix:semicolon
id|cmd-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
id|pSRB
op_assign
id|DC395x_find_cmd
c_func
(paren
id|cmd
comma
id|pDCB-&gt;pGoingSRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
id|printk
c_func
(paren
l_string|&quot;found in going queue :-(&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;not found!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/*&n; * TODO (new EH):&n; * int (*eh_device_reset_handler)(Scsi_Cmnd *);&n; * int (*eh_host_reset_handler)(Scsi_Cmnd *);&n; * &n; * remove Query Queue&n; * investigate whether/which commands need to be ffed back to mid-layer&n; * in _eh_reset()&n; */
multiline_comment|/* SDTR */
r_static
r_void
DECL|function|DC395x_Build_SDTR
id|DC395x_Build_SDTR
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|u8
op_star
id|ptr
op_assign
id|pSRB-&gt;MsgOutBuf
op_plus
id|pSRB-&gt;MsgCnt
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;MsgCnt
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Build_SDTR: MsgOutBuf BUSY (%i: %02x %02x)&bslash;n&quot;
comma
id|pSRB-&gt;MsgCnt
comma
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
comma
id|pSRB-&gt;MsgOutBuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_SYNC_NEGO
)paren
)paren
(brace
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;MinNegoPeriod
op_assign
l_int|200
op_rshift
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pDCB-&gt;SyncOffset
op_eq
l_int|0
)paren
id|pDCB-&gt;SyncOffset
op_assign
id|SYNC_NEGO_OFFSET
suffix:semicolon
op_star
id|ptr
op_increment
op_assign
id|MSG_EXTENDED
suffix:semicolon
multiline_comment|/* (01h) */
op_star
id|ptr
op_increment
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* length */
op_star
id|ptr
op_increment
op_assign
id|EXTENDED_SDTR
suffix:semicolon
multiline_comment|/* (01h) */
op_star
id|ptr
op_increment
op_assign
id|pDCB-&gt;MinNegoPeriod
suffix:semicolon
multiline_comment|/* Transfer period (in 4ns) */
op_star
id|ptr
op_increment
op_assign
id|pDCB-&gt;SyncOffset
suffix:semicolon
multiline_comment|/* Transfer period (max. REQ/ACK dist) */
id|pSRB-&gt;MsgCnt
op_add_assign
l_int|5
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_DO_SYNC_NEGO
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;S *&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* SDTR */
r_static
r_void
DECL|function|DC395x_Build_WDTR
id|DC395x_Build_WDTR
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|u8
id|wide
op_assign
(paren
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_WIDE_NEGO
)paren
op_amp
(paren
id|pACB
op_member_access_from_pointer
id|Config
op_amp
id|HCC_WIDE_CARD
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|u8
op_star
id|ptr
op_assign
id|pSRB-&gt;MsgOutBuf
op_plus
id|pSRB-&gt;MsgCnt
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;MsgCnt
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Build_WDTR: MsgOutBuf BUSY (%i: %02x %02x)&bslash;n&quot;
comma
id|pSRB-&gt;MsgCnt
comma
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
comma
id|pSRB-&gt;MsgOutBuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
op_star
id|ptr
op_increment
op_assign
id|MSG_EXTENDED
suffix:semicolon
multiline_comment|/* (01h) */
op_star
id|ptr
op_increment
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* length */
op_star
id|ptr
op_increment
op_assign
id|EXTENDED_WDTR
suffix:semicolon
multiline_comment|/* (03h) */
op_star
id|ptr
op_increment
op_assign
id|wide
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_add_assign
l_int|4
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_DO_WIDE_NEGO
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;W *&quot;
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* Timer to work around chip flaw: When selecting and the bus is &n; * busy, we sometimes miss a Selection timeout IRQ */
r_void
id|DC395x_selection_timeout_missed
c_func
(paren
r_int
r_int
id|ptr
)paren
suffix:semicolon
multiline_comment|/* Sets the timer to wake us up */
r_static
r_void
id|DC395x_selto_timer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|pACB-&gt;SelTO_Timer
)paren
)paren
r_return
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|pACB-&gt;SelTO_Timer
)paren
suffix:semicolon
id|pACB-&gt;SelTO_Timer.function
op_assign
id|DC395x_selection_timeout_missed
suffix:semicolon
id|pACB-&gt;SelTO_Timer.data
op_assign
(paren
r_int
r_int
)paren
id|pACB
suffix:semicolon
r_if
c_cond
(paren
id|time_before
(paren
id|jiffies
op_plus
id|HZ
comma
id|pACB-&gt;pScsiHost-&gt;last_reset
op_plus
id|HZ
op_div
l_int|2
)paren
)paren
id|pACB-&gt;SelTO_Timer.expires
op_assign
id|pACB-&gt;pScsiHost-&gt;last_reset
op_plus
id|HZ
op_div
l_int|2
op_plus
l_int|1
suffix:semicolon
r_else
id|pACB-&gt;SelTO_Timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|pACB-&gt;SelTO_Timer
)paren
suffix:semicolon
)brace
r_void
id|DC395x_selection_timeout_missed
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|ptr
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|pSRB
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Debug: Chip forgot to produce SelTO IRQ!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pACB-&gt;pActiveDCB
op_logical_or
op_logical_neg
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: ... but no cmd pending? Oops!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DC395x_LOCK_IO
c_func
(paren
id|pACB-&gt;pScsiHost
)paren
suffix:semicolon
id|pSRB
op_assign
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;N/TO *&quot;
)paren
suffix:semicolon
id|DC395x_Disconnect
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|DC395x_UNLOCK_IO
c_func
(paren
id|pACB-&gt;pScsiHost
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * scsiio&n; *&t;&t;DC395x_DoWaitingSRB    DC395x_SRBdone &n; *&t;&t;DC395x_SendSRB         DC395x_RequestSense&n; */
id|u8
DECL|function|DC395x_StartSCSI
id|DC395x_StartSCSI
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|u16
id|s_stat2
comma
id|return_code
suffix:semicolon
id|u8
id|s_stat
comma
id|scsicommand
comma
id|i
comma
id|identify_message
suffix:semicolon
id|u8
op_star
id|ptr
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_StartSCSI..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|pSRB-&gt;TagNumber
op_assign
id|TAG_NONE
suffix:semicolon
multiline_comment|/* pACB-&gt;TagMaxNum: had error read in eeprom */
id|s_stat
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_SIGNAL
)paren
suffix:semicolon
id|s_stat2
op_assign
l_int|0
suffix:semicolon
id|s_stat2
op_assign
id|DC395x_read16
c_func
(paren
id|TRM_S1040_SCSI_STATUS
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;Start %02x *&quot;
comma
id|s_stat
)paren
suffix:semicolon
macro_line|#if 1
r_if
c_cond
(paren
id|s_stat
op_amp
l_int|0x20
multiline_comment|/* s_stat2 &amp; 0x02000 */
)paren
(brace
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Debug: StartSCSI: pid %li(%02i-%i): BUSY %02x %04x&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|s_stat
comma
id|s_stat2
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t; * Try anyway?&n;&t;&t; *&n;&t;&t; * We could, BUT: Sometimes the TRM_S1040 misses to produce a Selection&n;&t;&t; * Timeout, a Disconnect or a Reselction IRQ, so we would be screwed!&n;&t;&t; * (This is likely to be a bug in the hardware. Obviously, most people&n;&t;&t; *  only have one initiator per SCSI bus.)&n;&t;&t; * Instead let this fail and have the timer make sure the command is &n;&t;&t; * tried again after a short time&n;&t;&t; */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;^*&quot;
)paren
suffix:semicolon
multiline_comment|/*DC395x_selto_timer (pACB); */
multiline_comment|/*DC395x_monitor_next_IRQ = 1; */
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pACB-&gt;pActiveDCB
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: We try to start a SCSI command (%li)!&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: While another one (%li) is active!!&bslash;n&quot;
comma
(paren
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
ques
c_cond
id|pACB-&gt;pActiveDCB
op_member_access_from_pointer
id|pActiveSRB-&gt;pcmd-&gt;pid
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|TRACEOUT
c_func
(paren
l_string|&quot; %s&bslash;n&quot;
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
)paren
id|TRACEOUT
c_func
(paren
l_string|&quot; %s&bslash;n&quot;
comma
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB-&gt;debugtrace
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DC395x_read16
c_func
(paren
id|TRM_S1040_SCSI_STATUS
)paren
op_amp
id|SCSIINTERRUPT
)paren
(brace
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Debug: StartSCSI failed (busy) for pid %li(%02i-%i)&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;&#xfffd;*&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Allow starting of SCSI commands half a second before we allow the mid-level&n;&t; * to queue them again after a reset */
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|pACB-&gt;pScsiHost-&gt;last_reset
op_minus
id|HZ
op_div
l_int|2
)paren
)paren
(brace
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: We were just reset and don&squot;t accept commands yet!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Flush FIFO */
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;Start&quot;
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_HOSTID
comma
id|pACB-&gt;pScsiHost-&gt;this_id
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_TARGETID
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_SYNC
comma
id|pDCB-&gt;SyncPeriod
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_OFFSET
comma
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/* initial phase */
id|identify_message
op_assign
id|pDCB-&gt;IdentifyMsg
suffix:semicolon
multiline_comment|/*DC395x_TRM_write8(TRM_S1040_SCSI_IDMSG, identify_message); */
multiline_comment|/* Don&squot;t allow disconnection for AUTO_REQSENSE: Cont.All.Cond.! */
r_if
c_cond
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
id|identify_message
op_and_assign
l_int|0xBF
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
op_logical_or
(paren
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
op_logical_or
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
)paren
op_logical_and
(paren
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|WIDE_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|pDCB-&gt;SyncMode
op_amp
id|WIDE_NEGO_DONE
)paren
)paren
op_logical_or
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_NEGO_DONE
)paren
)paren
)paren
op_logical_and
(paren
id|pDCB-&gt;TargetLUN
op_eq
l_int|0
)paren
)paren
(brace
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|identify_message
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|1
suffix:semicolon
id|scsicommand
op_assign
id|SCMD_SEL_ATNSTOP
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_MSGOUT
suffix:semicolon
macro_line|#ifndef SYNC_FIRST
r_if
c_cond
(paren
id|pDCB-&gt;SyncMode
op_amp
id|WIDE_NEGO_ENABLE
op_logical_and
id|pDCB-&gt;Inquiry7
op_amp
id|SCSI_INQ_WBUS16
)paren
(brace
id|DC395x_Build_WDTR
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
r_goto
id|no_cmd
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_NEGO_ENABLE
op_logical_and
id|pDCB-&gt;Inquiry7
op_amp
id|SCSI_INQ_SYNC
)paren
(brace
id|DC395x_Build_SDTR
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
r_goto
id|no_cmd
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pDCB-&gt;SyncMode
op_amp
id|WIDE_NEGO_ENABLE
op_logical_and
id|pDCB-&gt;Inquiry7
op_amp
id|SCSI_INQ_WBUS16
)paren
(brace
id|DC395x_Build_WDTR
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
r_goto
id|no_cmd
suffix:semicolon
)brace
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n;&t; ** Send identify message   &n;&t; */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
id|identify_message
)paren
suffix:semicolon
id|scsicommand
op_assign
id|SCMD_SEL_ATN
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_START_
suffix:semicolon
macro_line|#ifndef DC395x_NO_TAGQ
r_if
c_cond
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|EN_TAG_QUEUEING
)paren
op_logical_and
(paren
id|identify_message
op_amp
l_int|0xC0
)paren
)paren
(brace
multiline_comment|/* Send Tag message */
id|u32
id|tag_mask
op_assign
l_int|1
suffix:semicolon
id|u8
id|tag_number
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|tag_mask
op_amp
id|pDCB-&gt;TagMask
op_logical_and
id|tag_number
op_le
id|pDCB-&gt;MaxCommand
)paren
(brace
id|tag_mask
op_assign
id|tag_mask
op_lshift
l_int|1
suffix:semicolon
id|tag_number
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tag_number
op_ge
id|pDCB-&gt;MaxCommand
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DC395X_NAME
l_string|&quot;: Start_SCSI: Out of tags for pid %li (%i-%i)&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;id
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_READY
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_HWRESELECT
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t; ** Send Tag id&n;&t;&t; */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
id|MSG_SIMPLE_QTAG
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
id|tag_number
)paren
suffix:semicolon
id|pDCB-&gt;TagMask
op_or_assign
id|tag_mask
suffix:semicolon
id|pSRB-&gt;TagNumber
op_assign
id|tag_number
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;Tag %i *&quot;
comma
id|tag_number
)paren
suffix:semicolon
id|scsicommand
op_assign
id|SCMD_SEL_ATN3
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_START_
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*polling:*/
multiline_comment|/*&n;&t; *          Send CDB ..command block .........                     &n;&t; */
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: StartSCSI (pid %li) %02x (%i-%i): Tag %i&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB-&gt;pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;id
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;lun
comma
id|pSRB-&gt;TagNumber
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
(brace
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
id|REQUEST_SENSE
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
(paren
id|pDCB-&gt;TargetLUN
op_lshift
l_int|5
)paren
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
r_sizeof
(paren
id|pSRB-&gt;pcmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|pSRB-&gt;pcmd-&gt;cmnd
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pSRB-&gt;pcmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
op_star
id|ptr
op_increment
)paren
suffix:semicolon
)brace
id|no_cmd
suffix:colon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_HWRESELECT
op_or
id|DO_DATALATCH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DC395x_read16
c_func
(paren
id|TRM_S1040_SCSI_STATUS
)paren
op_amp
id|SCSIINTERRUPT
)paren
(brace
multiline_comment|/* &n;&t;&t; * If DC395x_StartSCSI return 1:&n;&t;&t; * we caught an interrupt (must be reset or reselection ... )&n;&t;&t; * : Let&squot;s process it first!&n;&t;&t; */
id|DEBUG0
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: Debug: StartSCSI failed (busy) for pid %li(%02i-%i)!&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
)paren
multiline_comment|/*DC395x_clrfifo (pACB, &quot;Start2&quot;); */
multiline_comment|/*DC395x_write16 (TRM_S1040_SCSI_CONTROL, DO_HWRESELECT | DO_DATALATCH); */
id|pSRB-&gt;SRBState
op_assign
id|SRB_READY
suffix:semicolon
id|DC395x_freetag
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
id|return_code
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* This IRQ should NOT get lost, as we did not acknowledge it */
)brace
r_else
(brace
multiline_comment|/* &n;&t;&t; * If DC395x_StartSCSI returns 0:&n;&t;&t; * we know that the SCSI processor is free&n;&t;&t; */
id|pSRB-&gt;ScsiPhase
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/* initial phase */
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
id|pDCB
suffix:semicolon
id|return_code
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
op_or
id|DO_HWRESELECT
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; ** SCSI command&n;&t;&t; */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;%02x *&quot;
comma
id|scsicommand
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|scsicommand
)paren
suffix:semicolon
)brace
r_return
id|return_code
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;&t;DC395x_initAdapter&n; ********************************************************************&n; */
multiline_comment|/**&n; * dc395x_handle_interrupt - Handle an interrupt that has been confirmed to&n; *                           have been triggered for this card.&n; *&n; * @pACB:&t; a pointer to the adpter control block&n; * @scsi_status: the status return when we checked the card&n; **/
DECL|function|dc395x_handle_interrupt
r_static
r_void
id|dc395x_handle_interrupt
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
id|u16
id|scsi_status
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|pSRB
suffix:semicolon
id|u16
id|phase
suffix:semicolon
id|u8
id|scsi_intstatus
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_void
(paren
op_star
id|DC395x_stateV
)paren
(paren
r_struct
id|AdapterCtlBlk
op_star
comma
r_struct
id|ScsiReqBlk
op_star
comma
id|u16
op_star
)paren
suffix:semicolon
id|DC395x_LOCK_IO
c_func
(paren
id|pACB-&gt;pScsiHost
)paren
suffix:semicolon
multiline_comment|/* This acknowledges the IRQ */
id|scsi_intstatus
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_INTSTATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|scsi_status
op_amp
l_int|0x2007
)paren
op_eq
l_int|0x2002
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: COP after COP completed? %04x&bslash;n&quot;
comma
id|scsi_status
)paren
suffix:semicolon
macro_line|#if 1&t;&t;&t;&t;/*def DC395x_DEBUG0 */
r_if
c_cond
(paren
id|DC395x_monitor_next_IRQ
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: status=%04x intstatus=%02x&bslash;n&quot;
comma
id|scsi_status
comma
id|scsi_intstatus
)paren
suffix:semicolon
id|DC395x_monitor_next_IRQ
op_decrement
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*DC395x_ACB_LOCK(pACB,acb_flags); */
macro_line|#ifdef DC395x_DEBUG_KG
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
id|INT_SELTIMEOUT
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Sel Timeout IRQ&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*printk (DC395X_NAME &quot;: DC395x_IRQ: intstatus = %02x &quot;, scsi_intstatus); */
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|pACB-&gt;SelTO_Timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|pACB-&gt;SelTO_Timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
(paren
id|INT_SELTIMEOUT
op_or
id|INT_DISCONNECT
)paren
)paren
(brace
id|DC395x_Disconnect
c_func
(paren
id|pACB
)paren
suffix:semicolon
multiline_comment|/* bus free interrupt  */
r_goto
id|out_unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
id|INT_RESELECTED
)paren
(brace
id|DC395x_Reselect
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
id|INT_SELECT
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Host does not support target mode!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
id|INT_SCSIRESET
)paren
(brace
id|DC395x_ScsiRstDetect
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_intstatus
op_amp
(paren
id|INT_BUSSERVICE
op_or
id|INT_CMDDONE
)paren
)paren
(brace
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Oops: BusService (%04x %02x) w/o ActiveDCB!&bslash;n&quot;
comma
id|scsi_status
comma
id|scsi_intstatus
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;DCBFlag
op_amp
id|ABORT_DEV_
)paren
(brace
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MsgOut Abort Device..... &quot;
)paren
suffix:semicolon
macro_line|#endif
id|DC395x_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; ************************************************************&n;&t;&t; * software sequential machine&n;&t;&t; ************************************************************&n;&t;&t; */
id|phase
op_assign
(paren
id|u16
)paren
id|pSRB-&gt;ScsiPhase
suffix:semicolon
multiline_comment|/* &n;&t;&t; * 62037 or 62137&n;&t;&t; * call  DC395x_SCSI_phase0[]... &quot;phase entry&quot;&n;&t;&t; * handle every phase before start transfer&n;&t;&t; */
multiline_comment|/* DC395x_DataOutPhase0,     phase:0 */
multiline_comment|/* DC395x_DataInPhase0,      phase:1 */
multiline_comment|/* DC395x_CommandPhase0,     phase:2 */
multiline_comment|/* DC395x_StatusPhase0,      phase:3 */
multiline_comment|/* DC395x_Nop0,              phase:4 PH_BUS_FREE .. initial phase */
multiline_comment|/* DC395x_Nop0,              phase:5 PH_BUS_FREE .. initial phase */
multiline_comment|/* DC395x_MsgOutPhase0,      phase:6 */
multiline_comment|/* DC395x_MsgInPhase0,       phase:7 */
id|DC395x_stateV
op_assign
(paren
r_void
op_star
)paren
id|DC395x_SCSI_phase0
(braket
id|phase
)braket
suffix:semicolon
id|DC395x_stateV
c_func
(paren
id|pACB
comma
id|pSRB
comma
op_amp
id|scsi_status
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; *$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ &n;&t;&t; *&n;&t;&t; *        if there were any exception occured&n;&t;&t; *        scsi_status will be modify to bus free phase&n;&t;&t; * new scsi_status transfer out from ... previous DC395x_stateV&n;&t;&t; *&n;&t;&t; *$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$ &n;&t;&t; */
id|pSRB-&gt;ScsiPhase
op_assign
id|scsi_status
op_amp
id|PHASEMASK
suffix:semicolon
id|phase
op_assign
(paren
id|u16
)paren
id|scsi_status
op_amp
id|PHASEMASK
suffix:semicolon
multiline_comment|/* &n;&t;&t; * call  DC395x_SCSI_phase1[]... &quot;phase entry&quot;&n;&t;&t; * handle every phase do transfer&n;&t;&t; */
multiline_comment|/* DC395x_DataOutPhase1,     phase:0 */
multiline_comment|/* DC395x_DataInPhase1,      phase:1 */
multiline_comment|/* DC395x_CommandPhase1,     phase:2 */
multiline_comment|/* DC395x_StatusPhase1,      phase:3 */
multiline_comment|/* DC395x_Nop1,              phase:4 PH_BUS_FREE .. initial phase */
multiline_comment|/* DC395x_Nop1,              phase:5 PH_BUS_FREE .. initial phase */
multiline_comment|/* DC395x_MsgOutPhase1,      phase:6 */
multiline_comment|/* DC395x_MsgInPhase1,       phase:7 */
id|DC395x_stateV
op_assign
(paren
r_void
op_star
)paren
id|DC395x_SCSI_phase1
(braket
id|phase
)braket
suffix:semicolon
id|DC395x_stateV
c_func
(paren
id|pACB
comma
id|pSRB
comma
op_amp
id|scsi_status
)paren
suffix:semicolon
)brace
id|out_unlock
suffix:colon
id|DC395x_UNLOCK_IO
c_func
(paren
id|pACB-&gt;pScsiHost
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*inline */
DECL|function|DC395x_Interrupt
id|irqreturn_t
id|DC395x_Interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|pACB
op_assign
id|DC395x_pACB_start
suffix:semicolon
id|u16
id|scsi_status
suffix:semicolon
id|u8
id|dma_status
suffix:semicolon
id|irqreturn_t
id|handled
op_assign
id|IRQ_NONE
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_Interrupt..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|DEBUGRECURSION
c_func
(paren
r_if
(paren
id|in_driver
op_increment
OG
id|NORM_REC_LVL
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: %i interrupt recursion?&bslash;n&quot;
comma
id|in_driver
)paren
suffix:semicolon
)paren
multiline_comment|/*&n;&t; * Find which card generated the interrupt. Note that it may have&n;&t; * been something else that we share the interupt with which&n;&t; * actually generated it.&n;&t; *&n;&t; * We&squot;ll check the interupt status register of each card that&n;&t; * is on the IRQ that was responsible for this interupt.&n;&t; */
r_for
c_loop
(paren
suffix:semicolon
id|pACB
op_ne
l_int|NULL
suffix:semicolon
id|pACB
op_assign
id|pACB-&gt;pNextACB
)paren
(brace
r_if
c_cond
(paren
id|pACB-&gt;IRQLevel
op_ne
(paren
id|u8
)paren
id|irq
)paren
(brace
multiline_comment|/* card is not on the irq that triggered */
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Ok, we&squot;ve found a card on the correct irq,&n;&t;&t; * let&squot;s check if an interupt is pending&n;&t;&t; */
id|scsi_status
op_assign
id|DC395x_read16
c_func
(paren
id|TRM_S1040_SCSI_STATUS
)paren
suffix:semicolon
id|dma_status
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_status
op_amp
id|SCSIINTERRUPT
)paren
(brace
multiline_comment|/* interupt pending - let&squot;s process it! */
id|dc395x_handle_interrupt
c_func
(paren
id|pACB
comma
id|scsi_status
)paren
suffix:semicolon
id|handled
op_assign
id|IRQ_HANDLED
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dma_status
op_amp
l_int|0x20
)paren
(brace
multiline_comment|/* Error from the DMA engine */
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Interrupt from DMA engine: %02x!&bslash;n&quot;
comma
id|dma_status
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: This means DMA error! Try to handle ...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;pActiveDCB
)paren
(brace
id|pACB-&gt;pActiveDCB
op_member_access_from_pointer
id|DCBFlag
op_or_assign
id|ABORT_DEV_
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
)paren
id|DC395x_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB
)paren
suffix:semicolon
)brace
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_CONTROL
comma
id|ABORTXFER
op_or
id|CLRXFIFO
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Ignoring DMA error (probably a bad thing) ...&bslash;n&quot;
)paren
suffix:semicolon
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
l_int|NULL
suffix:semicolon
macro_line|#endif
id|handled
op_assign
id|IRQ_HANDLED
suffix:semicolon
)brace
)brace
id|DEBUGRECURSION
c_func
(paren
id|in_driver
op_decrement
suffix:semicolon
)paren
r_return
id|handled
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_MsgOutPhase0: one of DC395x_SCSI_phase0[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase0[phase]&n; *&t;&t;&t;           if phase =6&n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_MsgOutPhase0
id|DC395x_MsgOutPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_MsgOutPhase0..... &quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
(paren
id|SRB_UNEXPECT_RESEL
op_plus
id|SRB_ABORT_SENT
)paren
)paren
(brace
op_star
id|pscsi_status
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/*.. initial phase */
)brace
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_MSGOUT
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;MOP0 *&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_MsgOutPhase1: one of DC395x_SCSI_phase0[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase0[phase]&n; *&t;&t;&t;&t;&t;if phase =6&t;    &n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_MsgOutPhase1
id|DC395x_MsgOutPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|u16
id|i
suffix:semicolon
id|u8
op_star
id|ptr
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_MsgOutPhase1..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;MOP1*&quot;
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;MOP1&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_MSGOUT
)paren
)paren
(brace
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_MSGOUT
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Debug: pid %li: MsgOut Phase unexpected.&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
multiline_comment|/* So what ? */
)brace
r_if
c_cond
(paren
op_logical_neg
id|pSRB-&gt;MsgCnt
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: Debug: pid %li: NOP Msg (no output message there).&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
)paren
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
id|MSG_NOP
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_OUT
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;&bslash;&bslash;*&quot;
)paren
suffix:semicolon
id|TRACEOUT
c_func
(paren
l_string|&quot; %s&bslash;n&quot;
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|pSRB-&gt;MsgOutBuf
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;(*&quot;
)paren
suffix:semicolon
multiline_comment|/*printk (DC395X_NAME &quot;: Send msg: &quot;); DC395x_printMsg (ptr, pSRB-&gt;MsgCnt); */
multiline_comment|/*printk (DC395X_NAME &quot;: MsgOut: &quot;); */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pSRB-&gt;MsgCnt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TRACEPRINTF
c_func
(paren
l_string|&quot;%02x *&quot;
comma
op_star
id|ptr
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
op_star
id|ptr
op_increment
)paren
suffix:semicolon
)brace
id|TRACEPRINTF
c_func
(paren
l_string|&quot;)*&quot;
)paren
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*printk (&quot;&bslash;n&quot;); */
r_if
c_cond
(paren
multiline_comment|/*(pDCB-&gt;DCBFlag &amp; ABORT_DEV_) &amp;&amp; */
(paren
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_eq
id|MSG_ABORT
)paren
)paren
id|pSRB-&gt;SRBState
op_assign
id|SRB_ABORT_SENT
suffix:semicolon
multiline_comment|/*1.25 */
multiline_comment|/*DC395x_write16 (TRM_S1040_SCSI_CONTROL, DO_DATALATCH); */
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/*&n;&t; ** SCSI command &n;&t; */
multiline_comment|/*TRACEPRINTF (&quot;.*&quot;); */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_OUT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_CommandPhase0: one of DC395x_SCSI_phase0[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase0[phase]&n; *&t;&t;&t;&t;if phase =2 &n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_CommandPhase0
id|DC395x_CommandPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|TRACEPRINTF
c_func
(paren
l_string|&quot;COP0 *&quot;
)paren
suffix:semicolon
multiline_comment|/*1.25 */
multiline_comment|/*DC395x_clrfifo (pACB, COP0); */
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_CommandPhase1: one of DC395x_SCSI_phase1[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase1[phase]&n; *&t;&t;&t;&t;if phase =2    &t; &n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_CommandPhase1
id|DC395x_CommandPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
id|u8
op_star
id|ptr
suffix:semicolon
id|u16
id|i
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_CommandPhase1..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;COP1*&quot;
)paren
suffix:semicolon
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;COP1&quot;
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_CLRATN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
)paren
(brace
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|pSRB-&gt;pcmd-&gt;cmnd
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pSRB-&gt;pcmd-&gt;cmd_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
op_star
id|ptr
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
id|REQUEST_SENSE
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
multiline_comment|/* target id */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
(paren
id|pDCB-&gt;TargetLUN
op_lshift
l_int|5
)paren
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
r_sizeof
(paren
id|pSRB-&gt;pcmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
)brace
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_COMMAND
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* SCSI command */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;.*&quot;
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_OUT
)paren
suffix:semicolon
)brace
multiline_comment|/* Do sanity checks for S/G list */
macro_line|#ifdef DC395x_SGPARANOIA
DECL|function|DC395x_check_SG
r_static
r_inline
r_void
id|DC395x_check_SG
c_func
(paren
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
r_int
id|Length
op_assign
l_int|0
suffix:semicolon
r_int
id|Idx
op_assign
id|pSRB-&gt;SRBSGIndex
suffix:semicolon
r_struct
id|SGentry
op_star
id|psge
op_assign
id|pSRB-&gt;SegmentX
op_plus
id|Idx
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|Idx
OL
id|pSRB-&gt;SRBSGCount
suffix:semicolon
id|psge
op_increment
comma
id|Idx
op_increment
)paren
id|Length
op_add_assign
id|psge-&gt;length
suffix:semicolon
r_if
c_cond
(paren
id|Length
op_ne
id|pSRB-&gt;SRBTotalXferLength
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Inconsistent SRB S/G lengths (Tot=%i, Count=%i) !!&bslash;n&quot;
comma
id|pSRB-&gt;SRBTotalXferLength
comma
id|Length
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|DC395x_check_SG
r_static
r_inline
r_void
id|DC395x_check_SG
c_func
(paren
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/*&n; * Compute the next Scatter Gather list index and adjust its length&n; * and address if necessary; also compute virt_addr&n; */
DECL|function|DC395x_update_SGlist
r_void
id|DC395x_update_SGlist
c_func
(paren
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u32
id|Left
)paren
(brace
r_struct
id|SGentry
op_star
id|psge
suffix:semicolon
id|u32
id|Xferred
op_assign
l_int|0
suffix:semicolon
id|u8
id|Idx
suffix:semicolon
id|Scsi_Cmnd
op_star
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|segment
op_assign
id|pcmd-&gt;use_sg
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Update SG: Total %i, Left %i&bslash;n&quot;
comma
id|pSRB-&gt;SRBTotalXferLength
comma
id|Left
)paren
suffix:semicolon
macro_line|#endif
id|DC395x_check_SG
c_func
(paren
id|pSRB
)paren
suffix:semicolon
id|psge
op_assign
id|pSRB-&gt;SegmentX
op_plus
id|pSRB-&gt;SRBSGIndex
suffix:semicolon
multiline_comment|/* data that has already been transferred */
id|Xferred
op_assign
id|pSRB-&gt;SRBTotalXferLength
op_minus
id|Left
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SRBTotalXferLength
op_ne
id|Left
)paren
(brace
multiline_comment|/*DC395x_check_SG_TX (pSRB, Xferred); */
multiline_comment|/* Remaining */
id|pSRB-&gt;SRBTotalXferLength
op_assign
id|Left
suffix:semicolon
multiline_comment|/* parsing from last time disconnect SGIndex */
r_for
c_loop
(paren
id|Idx
op_assign
id|pSRB-&gt;SRBSGIndex
suffix:semicolon
id|Idx
OL
id|pSRB-&gt;SRBSGCount
suffix:semicolon
id|Idx
op_increment
)paren
(brace
multiline_comment|/* Complete SG entries done */
r_if
c_cond
(paren
id|Xferred
op_ge
id|psge-&gt;length
)paren
id|Xferred
op_sub_assign
id|psge-&gt;length
suffix:semicolon
multiline_comment|/* Partial SG entries done */
r_else
(brace
id|psge-&gt;length
op_sub_assign
id|Xferred
suffix:semicolon
multiline_comment|/* residue data length  */
id|psge-&gt;address
op_add_assign
id|Xferred
suffix:semicolon
multiline_comment|/* residue data pointer */
id|pSRB-&gt;SRBSGIndex
op_assign
id|Idx
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|pSRB-&gt;pSRBDCB
op_member_access_from_pointer
id|pDCBACB-&gt;pdev
comma
id|pSRB-&gt;SRBSGBusAddr
comma
r_sizeof
(paren
r_struct
id|SGentry
)paren
op_star
id|DC395x_MAX_SG_LISTENTRY
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|psge
op_increment
suffix:semicolon
)brace
id|DC395x_check_SG
c_func
(paren
id|pSRB
)paren
suffix:semicolon
)brace
multiline_comment|/* We need the corresponding virtual address sg_to_virt */
multiline_comment|/*printk (DC395X_NAME &quot;: sg_to_virt: bus %08x -&gt; virt &quot;, psge-&gt;address); */
r_if
c_cond
(paren
op_logical_neg
id|segment
)paren
(brace
id|pSRB-&gt;virt_addr
op_add_assign
id|Xferred
suffix:semicolon
multiline_comment|/*printk (&quot;%p&bslash;n&quot;, pSRB-&gt;virt_addr); */
r_return
suffix:semicolon
)brace
multiline_comment|/* We have to walk the scatterlist to find it */
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|pcmd-&gt;request_buffer
suffix:semicolon
r_while
c_loop
(paren
id|segment
op_decrement
)paren
(brace
multiline_comment|/*printk (&quot;(%08x)%p &quot;, BUS_ADDR(*sg), PAGE_ADDRESS(sg)); */
r_int
r_int
id|mask
op_assign
op_complement
(paren
(paren
r_int
r_int
)paren
id|sg-&gt;length
op_minus
l_int|1
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|BUS_ADDR
c_func
(paren
op_star
id|sg
)paren
op_amp
id|mask
)paren
op_eq
(paren
id|psge-&gt;address
op_amp
id|mask
)paren
)paren
(brace
id|pSRB-&gt;virt_addr
op_assign
(paren
id|PAGE_ADDRESS
c_func
(paren
id|sg
)paren
op_plus
id|psge-&gt;address
op_minus
(paren
id|psge-&gt;address
op_amp
id|PAGE_MASK
)paren
)paren
suffix:semicolon
multiline_comment|/*printk (&quot;%p&bslash;n&quot;, pSRB-&gt;virt_addr); */
r_return
suffix:semicolon
)brace
op_increment
id|sg
suffix:semicolon
)brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: sg_to_virt failed!&bslash;n&quot;
)paren
suffix:semicolon
id|pSRB-&gt;virt_addr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * DC395x_cleanup_after_transfer&n; * &n; * Makes sure, DMA and SCSI engine are empty, after the transfer has finished&n; * KG: Currently called from  StatusPhase1 ()&n; * Should probably also be called from other places&n; * Best might be to call it in DataXXPhase0, if new phase will differ &n; */
r_static
r_void
DECL|function|DC395x_cleanup_after_transfer
id|DC395x_cleanup_after_transfer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|TRACEPRINTF
c_func
(paren
l_string|&quot; Cln*&quot;
)paren
suffix:semicolon
multiline_comment|/*DC395x_write8 (TRM_S1040_DMA_STATUS, FORCEDMACOMP); */
r_if
c_cond
(paren
id|DC395x_read16
c_func
(paren
id|TRM_S1040_DMA_COMMAND
)paren
op_amp
l_int|0x0001
)paren
(brace
multiline_comment|/* read */
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x40
)paren
)paren
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;ClnIn&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOSTAT
)paren
op_amp
l_int|0x80
)paren
)paren
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_CONTROL
comma
id|CLRXFIFO
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* write */
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOSTAT
)paren
op_amp
l_int|0x80
)paren
)paren
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_CONTROL
comma
id|CLRXFIFO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x40
)paren
)paren
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;ClnOut&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*1.25 */
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Those no of bytes will be transfered w/ PIO through the SCSI FIFO&n; * Seems to be needed for unknown reasons; could be a hardware bug :-(&n; */
DECL|macro|DC395x_LASTPIO
mdefine_line|#define DC395x_LASTPIO 4
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_DataOutPhase0: one of DC395x_SCSI_phase0[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase0[phase]&n; *&t;&t;&t;&t;if phase =0 &n; ********************************************************************&n; */
r_void
DECL|function|DC395x_DataOutPhase0
id|DC395x_DataOutPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|u16
id|scsi_status
suffix:semicolon
id|u32
id|dLeftCounter
op_assign
l_int|0
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_DataOutPhase0.....&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;DOP0*&quot;
)paren
suffix:semicolon
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
id|scsi_status
op_assign
op_star
id|pscsi_status
suffix:semicolon
multiline_comment|/*&n;&t; * KG: We need to drain the buffers before we draw any conclusions!&n;&t; * This means telling the DMA to push the rest into SCSI, telling&n;&t; * SCSI to push the rest to the bus.&n;&t; * However, the device might have been the one to stop us (phase&n;&t; * change), and the data in transit just needs to be accounted so&n;&t; * it can be retransmitted.)&n;&t; */
multiline_comment|/* &n;&t; * KG: Stop DMA engine pushing more data into the SCSI FIFO&n;&t; * If we need more data, the DMA SG list will be freshly set up, anyway&n;&t; */
macro_line|#ifdef DC395x_DEBUGPIO
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DOP0: DMA_FCNT: %02x, DMA_FSTAT: %02x, SCSI_FCNT: %02x, CTR %06x, stat %04x, Tot: %06x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOSTAT
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
comma
id|DC395x_read32
c_func
(paren
id|TRM_S1040_SCSI_COUNTER
)paren
comma
id|scsi_status
comma
id|pSRB-&gt;SRBTotalXferLength
)paren
suffix:semicolon
multiline_comment|/*DC395x_dumpinfo(pACB, pDCB, pSRB); */
macro_line|#endif
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_CONTROL
comma
id|STOPDMAXFER
op_or
id|CLRXFIFO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_XFERPAD
)paren
)paren
(brace
r_if
c_cond
(paren
id|scsi_status
op_amp
id|PARITYERROR
)paren
id|pSRB-&gt;SRBStatus
op_or_assign
id|PARITY_ERROR
suffix:semicolon
multiline_comment|/*&n;&t;&t; * KG: Right, we can&squot;t just rely on the SCSI_COUNTER, because this&n;&t;&t; * is the no of bytes it got from the DMA engine not the no it &n;&t;&t; * transferred successfully to the device. (And the difference could&n;&t;&t; * be as much as the FIFO size, I guess ...)&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|scsi_status
op_amp
id|SCSIXFERDONE
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * when data transfer from DMA FIFO to SCSI FIFO&n;&t;&t;&t; * if there was some data left in SCSI FIFO&n;&t;&t;&t; */
id|dLeftCounter
op_assign
(paren
id|u32
)paren
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
)paren
id|dLeftCounter
op_lshift_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Debug: SCSI FIFO contains %i %s in DOP0&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
comma
(paren
id|pDCB
op_member_access_from_pointer
id|SyncPeriod
op_amp
id|WIDE_SYNC
)paren
ques
c_cond
l_string|&quot;words&quot;
suffix:colon
l_string|&quot;bytes&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: SCSI FIFOCNT %02x, SCSI CTR %08x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
comma
id|DC395x_read32
c_func
(paren
id|TRM_S1040_SCSI_COUNTER
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DMA FIFOCNT %04x, FIFOSTAT %02x, DMA CTR %08x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOSTAT
)paren
comma
id|DC395x_read32
c_func
(paren
id|TRM_S1040_DMA_CXCNT
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t;&t; * if WIDE scsi SCSI FIFOCNT unit is word !!!&n;&t;&t;&t; * so need to *= 2&n;&t;&t;&t; */
)brace
multiline_comment|/*&n;&t;&t; * calculate all the residue data that not yet tranfered&n;&t;&t; * SCSI transfer counter + left in SCSI FIFO data&n;&t;&t; *&n;&t;&t; * .....TRM_S1040_SCSI_COUNTER (24bits)&n;&t;&t; * The counter always decrement by one for every SCSI byte transfer.&n;&t;&t; * .....TRM_S1040_SCSI_FIFOCNT ( 5bits)&n;&t;&t; * The counter is SCSI FIFO offset counter (in units of bytes or! words)&n;&t;&t; */
r_if
c_cond
(paren
id|pSRB-&gt;SRBTotalXferLength
OG
id|DC395x_LASTPIO
)paren
id|dLeftCounter
op_add_assign
id|DC395x_read32
c_func
(paren
id|TRM_S1040_SCSI_COUNTER
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;%06x *&quot;
comma
id|dLeftCounter
)paren
suffix:semicolon
multiline_comment|/* Is this a good idea? */
multiline_comment|/*DC395x_clrfifo (pACB, &quot;DOP1&quot;); */
multiline_comment|/* KG: What is this supposed to be useful for? WIDE padding stuff? */
r_if
c_cond
(paren
id|dLeftCounter
op_eq
l_int|1
op_logical_and
id|pDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
op_logical_and
id|pSRB-&gt;pcmd-&gt;request_bufflen
op_mod
l_int|2
)paren
(brace
id|dLeftCounter
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DOP0: Discard 1 byte. (%02x)&bslash;n&quot;
comma
id|scsi_status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * KG: Oops again. Same thinko as above: The SCSI might have been&n;&t;&t; * faster than the DMA engine, so that it ran out of data.&n;&t;&t; * In that case, we have to do just nothing! &n;&t;&t; * But: Why the interrupt: No phase change. No XFERCNT_2_ZERO. Or?&n;&t;&t; */
multiline_comment|/*&n;&t;&t; * KG: This is nonsense: We have been WRITING data to the bus&n;&t;&t; * If the SCSI engine has no bytes left, how should the DMA engine?&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|dLeftCounter
op_eq
l_int|0
)paren
multiline_comment|/*|| (scsi_status &amp; SCSIXFERCNT_2_ZERO) ) */
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * int ctr = 6000000; u8 TempDMAstatus;&n;&t;&t;&t; * do&n;&t;&t;&t; * {&n;&t;&t;&t; *  TempDMAstatus = DC395x_read8(TRM_S1040_DMA_STATUS);&n;&t;&t;&t; * } while( !(TempDMAstatus &amp; DMAXFERCOMP) &amp;&amp; --ctr);&n;&t;&t;&t; * if (ctr &lt; 6000000-1) printk (DC395X_NAME &quot;: DMA should be complete ... in DOP1&bslash;n&quot;);&n;&t;&t;&t; * if (!ctr) printk (KERN_ERR DC395X_NAME &quot;: Deadlock in DataOutPhase0 !!&bslash;n&quot;);&n;&t;&t;&t; */
id|pSRB-&gt;SRBTotalXferLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Update SG list         */
multiline_comment|/*&n;&t;&t;&t; * if transfer not yet complete&n;&t;&t;&t; * there were some data residue in SCSI FIFO or&n;&t;&t;&t; * SCSI transfer counter not empty&n;&t;&t;&t; */
r_int
id|oldXferred
op_assign
id|pSRB-&gt;SRBTotalXferLength
op_minus
id|dLeftCounter
suffix:semicolon
r_const
r_int
id|diff
op_assign
(paren
id|pDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
id|DC395x_update_SGlist
c_func
(paren
id|pSRB
comma
id|dLeftCounter
)paren
suffix:semicolon
multiline_comment|/* KG: Most ugly hack! Apparently, this works around a chip bug */
r_if
c_cond
(paren
(paren
id|pSRB-&gt;SegmentX
(braket
id|pSRB-&gt;SRBSGIndex
)braket
dot
id|length
op_eq
id|diff
op_logical_and
id|pSRB-&gt;pcmd-&gt;use_sg
)paren
op_logical_or
(paren
(paren
id|oldXferred
op_amp
op_complement
id|PAGE_MASK
)paren
op_eq
(paren
id|PAGE_SIZE
op_minus
id|diff
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Work around chip bug (%i)?&bslash;n&quot;
comma
id|diff
)paren
suffix:semicolon
id|dLeftCounter
op_assign
id|pSRB-&gt;SRBTotalXferLength
op_minus
id|diff
suffix:semicolon
id|DC395x_update_SGlist
c_func
(paren
id|pSRB
comma
id|dLeftCounter
)paren
suffix:semicolon
multiline_comment|/*pSRB-&gt;SRBTotalXferLength -= diff; */
multiline_comment|/*pSRB-&gt;virt_addr += diff; */
multiline_comment|/*if (pSRB-&gt;pcmd-&gt;use_sg) */
multiline_comment|/*      pSRB-&gt;SRBSGIndex++; */
)brace
)brace
)brace
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x40
)paren
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DOP0(%li): %i bytes in SCSI FIFO! (Clear!)&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1f
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*DC395x_clrfifo (pACB, &quot;DOP0&quot;); */
multiline_comment|/*DC395x_write8 (TRM_S1040_DMA_CONTROL, CLRXFIFO | ABORTXFER); */
macro_line|#if 1
r_if
c_cond
(paren
(paren
op_star
id|pscsi_status
op_amp
id|PHASEMASK
)paren
op_ne
id|PH_DATA_OUT
)paren
(brace
multiline_comment|/*printk (DC395X_NAME &quot;: Debug: Clean up after Data Out ...&bslash;n&quot;); */
id|DC395x_cleanup_after_transfer
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;.*&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_DataOutPhase1: one of DC395x_SCSI_phase0[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase0[phase]&n; *&t;&t;&t;&t;if phase =0    &n; *&t;&t;62037&n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_DataOutPhase1
id|DC395x_DataOutPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_DataOutPhase1.....&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*1.25 */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;DOP1*&quot;
)paren
suffix:semicolon
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;DOP1&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; ** do prepare befor transfer when data out phase&n;&t; */
id|DC395x_DataIO_transfer
c_func
(paren
id|pACB
comma
id|pSRB
comma
id|XFERDATAOUT
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;.*&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_DataInPhase0: one of DC395x_SCSI_phase1[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase1[phase]&n; *&t;&t;&t;&t;if phase =1  &n; ********************************************************************&n; */
r_void
DECL|function|DC395x_DataInPhase0
id|DC395x_DataInPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
id|u16
id|scsi_status
suffix:semicolon
id|u32
id|dLeftCounter
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*struct DeviceCtlBlk*   pDCB = pSRB-&gt;pSRBDCB; */
multiline_comment|/*u8 bval; */
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_DataInPhase0..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;DIP0*&quot;
)paren
suffix:semicolon
id|scsi_status
op_assign
op_star
id|pscsi_status
suffix:semicolon
multiline_comment|/*&n;&t; * KG: DataIn is much more tricky than DataOut. When the device is finished&n;&t; * and switches to another phase, the SCSI engine should be finished too.&n;&t; * But: There might still be bytes left in its FIFO to be fetched by the DMA&n;&t; * engine and transferred to memory.&n;&t; * We should wait for the FIFOs to be emptied by that (is there any way to &n;&t; * enforce this?) and then stop the DMA engine, because it might think, that&n;&t; * there are more bytes to follow. Yes, the device might disconnect prior to&n;&t; * having all bytes transferred! &n;&t; * Also we should make sure that all data from the DMA engine buffer&squot;s really&n;&t; * made its way to the system memory! Some documentation on this would not&n;&t; * seem to be a bad idea, actually.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_XFERPAD
)paren
)paren
(brace
r_if
c_cond
(paren
id|scsi_status
op_amp
id|PARITYERROR
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Parity Error (pid %li, target %02i-%i)&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;id
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;lun
)paren
suffix:semicolon
id|pSRB-&gt;SRBStatus
op_or_assign
id|PARITY_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * KG: We should wait for the DMA FIFO to be empty ...&n;&t;&t; * but: it would be better to wait first for the SCSI FIFO and then the&n;&t;&t; * the DMA FIFO to become empty? How do we know, that the device not already&n;&t;&t; * sent data to the FIFO in a MsgIn phase, eg.?&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOSTAT
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
macro_line|#if 0
r_int
id|ctr
op_assign
l_int|6000000
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DIP0: Wait for DMA FIFO to flush ...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*DC395x_write8  (TRM_S1040_DMA_CONTROL, STOPDMAXFER); */
multiline_comment|/*DC395x_write32 (TRM_S1040_SCSI_COUNTER, 7); */
multiline_comment|/*DC395x_write8  (TRM_S1040_SCSI_COMMAND, SCMD_DMA_IN); */
r_while
c_loop
(paren
op_logical_neg
(paren
id|DC395x_read16
c_func
(paren
id|TRM_S1040_DMA_FIFOSTAT
)paren
op_amp
l_int|0x80
)paren
op_logical_and
op_decrement
id|ctr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctr
OL
l_int|6000000
op_minus
l_int|1
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Debug: DIP0: Had to wait for DMA ...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctr
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|DC395X_NAME
l_string|&quot;: Deadlock in DIP0 waiting for DMA FIFO empty!!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*DC395x_write32 (TRM_S1040_SCSI_COUNTER, 0); */
macro_line|#endif
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DIP0: DMA_FIFO: %02x %02x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOSTAT
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Now: Check remainig data: The SCSI counters should tell us ... */
id|dLeftCounter
op_assign
id|DC395x_read32
c_func
(paren
id|TRM_S1040_SCSI_COUNTER
)paren
op_plus
(paren
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1f
)paren
op_lshift
(paren
(paren
id|pSRB-&gt;pSRBDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Debug: SCSI FIFO contains %i %s in DIP0&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1f
comma
(paren
id|pSRB-&gt;pSRBDCB
op_member_access_from_pointer
id|SyncPeriod
op_amp
id|WIDE_SYNC
)paren
ques
c_cond
l_string|&quot;words&quot;
suffix:colon
l_string|&quot;bytes&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: SCSI FIFOCNT %02x, SCSI CTR %08x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
comma
id|DC395x_read32
c_func
(paren
id|TRM_S1040_SCSI_COUNTER
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DMA FIFOCNT %02x,%02x DMA CTR %08x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOSTAT
)paren
comma
id|DC395x_read32
c_func
(paren
id|TRM_S1040_DMA_CXCNT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Remaining: TotXfer: %i, SCSI FIFO+Ctr: %i&bslash;n&quot;
comma
id|pSRB-&gt;SRBTotalXferLength
comma
id|dLeftCounter
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if DC395x_LASTPIO
multiline_comment|/* KG: Less than or equal to 4 bytes can not be transfered via DMA, it seems. */
r_if
c_cond
(paren
id|dLeftCounter
op_logical_and
id|pSRB-&gt;SRBTotalXferLength
op_le
id|DC395x_LASTPIO
)paren
(brace
multiline_comment|/*u32 addr = (pSRB-&gt;SegmentX[pSRB-&gt;SRBSGIndex].address); */
multiline_comment|/*DC395x_update_SGlist (pSRB, dLeftCounter); */
id|DEBUGPIO
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: DIP0: PIO (%i %s) to %p for remaining %i bytes:&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1f
comma
(paren
id|pSRB-&gt;pSRBDCB
op_member_access_from_pointer
id|SyncPeriod
op_amp
id|WIDE_SYNC
)paren
ques
c_cond
l_string|&quot;words&quot;
suffix:colon
l_string|&quot;bytes&quot;
comma
id|pSRB-&gt;virt_addr
comma
id|pSRB-&gt;SRBTotalXferLength
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|pSRB-&gt;pSRBDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
)paren
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_CONFIG2
comma
id|CFG2_WIDEFIFO
)paren
suffix:semicolon
r_while
c_loop
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_ne
l_int|0x40
)paren
(brace
id|u8
id|byte
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
op_star
(paren
id|pSRB-&gt;virt_addr
)paren
op_increment
op_assign
id|byte
suffix:semicolon
id|DEBUGPIO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|byte
)paren
suffix:semicolon
)paren
id|pSRB-&gt;SRBTotalXferLength
op_decrement
suffix:semicolon
id|dLeftCounter
op_decrement
suffix:semicolon
id|pSRB-&gt;SegmentX
(braket
id|pSRB-&gt;SRBSGIndex
)braket
dot
id|length
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SRBTotalXferLength
op_logical_and
op_logical_neg
id|pSRB-&gt;SegmentX
(braket
id|pSRB-&gt;SRBSGIndex
)braket
dot
id|length
)paren
(brace
id|DEBUGPIO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; (next segment)&quot;
)paren
suffix:semicolon
)paren
id|pSRB-&gt;SRBSGIndex
op_increment
suffix:semicolon
id|DC395x_update_SGlist
c_func
(paren
id|pSRB
comma
id|dLeftCounter
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSRB-&gt;pSRBDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
)paren
(brace
macro_line|#if 1&t;&t;&t;&t;/* Read the last byte ... */
r_if
c_cond
(paren
id|pSRB-&gt;SRBTotalXferLength
OG
l_int|0
)paren
(brace
id|u8
id|byte
op_assign
id|DC395x_read8
(paren
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
op_star
(paren
id|pSRB-&gt;virt_addr
)paren
op_increment
op_assign
id|byte
suffix:semicolon
id|pSRB-&gt;SRBTotalXferLength
op_decrement
suffix:semicolon
id|DEBUGPIO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|byte
)paren
suffix:semicolon
)paren
)brace
macro_line|#endif
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_CONFIG2
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*printk (&quot; %08x&quot;, *(u32*)(bus_to_virt (addr))); */
multiline_comment|/*pSRB-&gt;SRBTotalXferLength = 0; */
id|DEBUGPIO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
macro_line|#endif&t;&t;&t;&t;/* DC395x_LASTPIO */
macro_line|#if 0
multiline_comment|/*&n;&t;&t; * KG: This was in DATAOUT. Does it also belong here?&n;&t;&t; * Nobody seems to know what counter and fifo_cnt count exactly ...&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|scsi_status
op_amp
id|SCSIXFERDONE
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * when data transfer from DMA FIFO to SCSI FIFO&n;&t;&t;&t; * if there was some data left in SCSI FIFO&n;&t;&t;&t; */
id|dLeftCounter
op_assign
(paren
id|u32
)paren
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
op_amp
l_int|0x1F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;pSRBDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
)paren
id|dLeftCounter
op_lshift_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * if WIDE scsi SCSI FIFOCNT unit is word !!!&n;&t;&t;&t; * so need to *= 2&n;&t;&t;&t; * KG: Seems to be correct ...&n;&t;&t;&t; */
)brace
macro_line|#endif
multiline_comment|/*dLeftCounter += DC395x_read32(TRM_S1040_SCSI_COUNTER); */
macro_line|#if 0
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DIP0: ctr=%08x, DMA_FIFO=%02x,%02x SCSI_FIFO=%02x&bslash;n&quot;
comma
id|dLeftCounter
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOCNT
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_FIFOSTAT
)paren
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DIP0: DMAStat %02x&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_STATUS
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* KG: This should not be needed any more! */
r_if
c_cond
(paren
(paren
id|dLeftCounter
op_eq
l_int|0
)paren
op_logical_or
(paren
id|scsi_status
op_amp
id|SCSIXFERCNT_2_ZERO
)paren
)paren
(brace
macro_line|#if 0
r_int
id|ctr
op_assign
l_int|6000000
suffix:semicolon
id|u8
id|TempDMAstatus
suffix:semicolon
r_do
(brace
id|TempDMAstatus
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_STATUS
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|TempDMAstatus
op_amp
id|DMAXFERCOMP
)paren
op_logical_and
op_decrement
id|ctr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctr
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|DC395X_NAME
l_string|&quot;: Deadlock in DataInPhase0 waiting for DMA!!&bslash;n&quot;
)paren
suffix:semicolon
id|pSRB-&gt;SRBTotalXferLength
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if 0&t;&t;&t;&t;/*def DC395x_DEBUG_KG             */
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DIP0: DMA not yet ready: %02x: %i -&gt; %i bytes&bslash;n&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_STATUS
)paren
comma
id|pSRB-&gt;SRBTotalXferLength
comma
id|dLeftCounter
)paren
suffix:semicolon
macro_line|#endif
id|pSRB-&gt;SRBTotalXferLength
op_assign
id|dLeftCounter
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* phase changed */
multiline_comment|/*&n;&t;&t;&t; * parsing the case:&n;&t;&t;&t; * when a transfer not yet complete &n;&t;&t;&t; * but be disconnected by target&n;&t;&t;&t; * if transfer not yet complete&n;&t;&t;&t; * there were some data residue in SCSI FIFO or&n;&t;&t;&t; * SCSI transfer counter not empty&n;&t;&t;&t; */
id|DC395x_update_SGlist
c_func
(paren
id|pSRB
comma
id|dLeftCounter
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* KG: The target may decide to disconnect: Empty FIFO before! */
r_if
c_cond
(paren
(paren
op_star
id|pscsi_status
op_amp
id|PHASEMASK
)paren
op_ne
id|PH_DATA_IN
)paren
(brace
multiline_comment|/*printk (DC395X_NAME &quot;: Debug: Clean up after Data In  ...&bslash;n&quot;); */
id|DC395x_cleanup_after_transfer
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* KG: Make sure, no previous transfers are pending! */
id|bval
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFOCNT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
l_int|0x40
)paren
)paren
(brace
id|bval
op_and_assign
l_int|0x1f
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: DIP0(%li): %i bytes in SCSI FIFO (stat %04x) (left %08x)!!&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|bval
op_amp
l_int|0x1f
comma
id|scsi_status
comma
id|dLeftCounter
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dLeftCounter
op_eq
l_int|0
)paren
op_logical_or
(paren
id|scsi_status
op_amp
id|SCSIXFERCNT_2_ZERO
)paren
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Clear FIFO!&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;DIP0&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*DC395x_write8 (TRM_S1040_DMA_CONTROL, CLRXFIFO | ABORTXFER); */
multiline_comment|/*DC395x_clrfifo (pACB, &quot;DIP0&quot;); */
multiline_comment|/*DC395x_write16 (TRM_S1040_SCSI_CONTROL, DO_DATALATCH); */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;.*&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_DataInPhase1: one of DC395x_SCSI_phase0[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase0[phase]&n; *&t;&t;&t;&t;if phase =1 &n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_DataInPhase1
id|DC395x_DataInPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_DataInPhase1..... &quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* FIFO should be cleared, if previous phase was not DataPhase */
multiline_comment|/*DC395x_clrfifo (pACB, &quot;DIP1&quot;); */
multiline_comment|/* Allow data in! */
multiline_comment|/*DC395x_write16 (TRM_S1040_SCSI_CONTROL, DO_DATALATCH); */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;DIP1:*&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; ** do prepare before transfer when data in phase&n;&t; */
id|DC395x_DataIO_transfer
c_func
(paren
id|pACB
comma
id|pSRB
comma
id|XFERDATAIN
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;.*&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;&t;DC395x_DataOutPhase1&n; *&t;&t;DC395x_DataInPhase1&n; ********************************************************************&n; */
r_void
DECL|function|DC395x_DataIO_transfer
id|DC395x_DataIO_transfer
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
id|ioDir
)paren
(brace
id|u8
id|bval
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DataIO_transfer %c (pid %li): len = %i, SG: %i/%i&bslash;n&quot;
comma
(paren
(paren
id|ioDir
op_amp
id|DMACMD_DIR
)paren
ques
c_cond
l_char|&squot;r&squot;
suffix:colon
l_char|&squot;w&squot;
)paren
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB-&gt;SRBTotalXferLength
comma
id|pSRB-&gt;SRBSGIndex
comma
id|pSRB-&gt;SRBSGCount
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;%05x(%i/%i)*&quot;
comma
id|pSRB-&gt;SRBTotalXferLength
comma
id|pSRB-&gt;SRBSGIndex
comma
id|pSRB-&gt;SRBSGCount
)paren
suffix:semicolon
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|pACB-&gt;pTmpSRB
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: ERROR! Using TmpSRB in DataPhase!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSRB-&gt;SRBSGIndex
OL
id|pSRB-&gt;SRBSGCount
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;SRBTotalXferLength
OG
id|DC395x_LASTPIO
)paren
(brace
id|u8
id|dma_status
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_DMA_STATUS
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * KG: What should we do: Use SCSI Cmd 0x90/0x92?&n;&t;&t;&t; * Maybe, even ABORTXFER would be appropriate&n;&t;&t;&t; */
r_if
c_cond
(paren
id|dma_status
op_amp
id|XFERPENDING
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Xfer pending! Expect trouble!!&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_dumpinfo
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_CONTROL
comma
id|CLRXFIFO
)paren
suffix:semicolon
)brace
multiline_comment|/*DC395x_clrfifo (pACB, &quot;IO&quot;); */
multiline_comment|/* &n;&t;&t;&t; * load what physical address of Scatter/Gather list table want to be&n;&t;&t;&t; * transfer &n;&t;&t;&t; */
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_DATA_XFER
suffix:semicolon
id|DC395x_write32
c_func
(paren
id|TRM_S1040_DMA_XHIGHADDR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;pcmd-&gt;use_sg
)paren
(brace
multiline_comment|/* with S/G */
id|ioDir
op_or_assign
id|DMACMD_SG
suffix:semicolon
id|DC395x_write32
c_func
(paren
id|TRM_S1040_DMA_XLOWADDR
comma
id|pSRB-&gt;SRBSGBusAddr
op_plus
r_sizeof
(paren
r_struct
id|SGentry
)paren
op_star
id|pSRB-&gt;SRBSGIndex
)paren
suffix:semicolon
multiline_comment|/* load how many bytes in the Scatter/Gather list table */
id|DC395x_write32
c_func
(paren
id|TRM_S1040_DMA_XCNT
comma
(paren
(paren
id|u32
)paren
(paren
id|pSRB-&gt;SRBSGCount
op_minus
id|pSRB-&gt;SRBSGIndex
)paren
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* without S/G */
id|ioDir
op_and_assign
op_complement
id|DMACMD_SG
suffix:semicolon
id|DC395x_write32
c_func
(paren
id|TRM_S1040_DMA_XLOWADDR
comma
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
id|DC395x_write32
c_func
(paren
id|TRM_S1040_DMA_XCNT
comma
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/* load total transfer length (24bits) max value 16Mbyte */
id|DC395x_write32
c_func
(paren
id|TRM_S1040_SCSI_COUNTER
comma
id|pSRB-&gt;SRBTotalXferLength
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
r_if
c_cond
(paren
id|ioDir
op_amp
id|DMACMD_DIR
)paren
(brace
multiline_comment|/* read */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_DMA_IN
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_DMA_COMMAND
comma
id|ioDir
)paren
suffix:semicolon
)brace
r_else
(brace
id|DC395x_write16
c_func
(paren
id|TRM_S1040_DMA_COMMAND
comma
id|ioDir
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_DMA_OUT
)paren
suffix:semicolon
)brace
)brace
macro_line|#if DC395x_LASTPIO
r_else
r_if
c_cond
(paren
id|pSRB-&gt;SRBTotalXferLength
OG
l_int|0
)paren
(brace
multiline_comment|/* The last four bytes: Do PIO */
multiline_comment|/*DC395x_clrfifo (pACB, &quot;IO&quot;); */
multiline_comment|/* &n;&t;&t;&t; * load what physical address of Scatter/Gather list table want to be&n;&t;&t;&t; * transfer &n;&t;&t;&t; */
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_DATA_XFER
suffix:semicolon
multiline_comment|/* load total transfer length (24bits) max value 16Mbyte */
id|DC395x_write32
c_func
(paren
id|TRM_S1040_SCSI_COUNTER
comma
id|pSRB-&gt;SRBTotalXferLength
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
r_if
c_cond
(paren
id|ioDir
op_amp
id|DMACMD_DIR
)paren
(brace
multiline_comment|/* read */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_IN
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* write */
r_int
id|ln
op_assign
id|pSRB-&gt;SRBTotalXferLength
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;pSRBDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
)paren
id|DC395x_write8
(paren
id|TRM_S1040_SCSI_CONFIG2
comma
id|CFG2_WIDEFIFO
)paren
suffix:semicolon
id|DEBUGPIO
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: DOP1: PIO %i bytes from %p:&quot;
comma
id|pSRB-&gt;SRBTotalXferLength
comma
id|pSRB-&gt;virt_addr
)paren
suffix:semicolon
)paren
r_while
c_loop
(paren
id|pSRB-&gt;SRBTotalXferLength
)paren
(brace
id|DEBUGPIO
c_func
(paren
id|printk
(paren
l_string|&quot; %02x&quot;
comma
(paren
r_int
r_char
)paren
op_star
(paren
id|pSRB
op_member_access_from_pointer
id|virt_addr
)paren
)paren
suffix:semicolon
)paren
id|DC395x_write8
(paren
id|TRM_S1040_SCSI_FIFO
comma
op_star
(paren
id|pSRB-&gt;virt_addr
)paren
op_increment
)paren
suffix:semicolon
id|pSRB-&gt;SRBTotalXferLength
op_decrement
suffix:semicolon
id|pSRB-&gt;SegmentX
(braket
id|pSRB-&gt;SRBSGIndex
)braket
dot
id|length
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SRBTotalXferLength
op_logical_and
op_logical_neg
id|pSRB-&gt;SegmentX
(braket
id|pSRB
op_member_access_from_pointer
id|SRBSGIndex
)braket
dot
id|length
)paren
(brace
id|DEBUGPIO
c_func
(paren
id|printk
(paren
l_string|&quot; (next segment)&quot;
)paren
suffix:semicolon
)paren
id|pSRB-&gt;SRBSGIndex
op_increment
suffix:semicolon
id|DC395x_update_SGlist
c_func
(paren
id|pSRB
comma
id|pSRB
op_member_access_from_pointer
id|SRBTotalXferLength
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSRB-&gt;pSRBDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
)paren
(brace
r_if
c_cond
(paren
id|ln
op_mod
l_int|2
)paren
(brace
id|DC395x_write8
(paren
id|TRM_S1040_SCSI_FIFO
comma
l_int|0
)paren
suffix:semicolon
id|DEBUGPIO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; |00&quot;
)paren
suffix:semicolon
)paren
)brace
id|DC395x_write8
(paren
id|TRM_S1040_SCSI_CONFIG2
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*DC395x_write32(TRM_S1040_SCSI_COUNTER, ln); */
id|DEBUGPIO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_OUT
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* DC395x_LASTPIO */
r_else
(brace
multiline_comment|/* xfer pad */
id|u8
id|data
op_assign
l_int|0
comma
id|data2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SRBSGCount
)paren
(brace
id|pSRB-&gt;AdaptStatus
op_assign
id|H_OVER_UNDER_RUN
suffix:semicolon
id|pSRB-&gt;SRBStatus
op_or_assign
id|OVER_RUN
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * KG: despite the fact that we are using 16 bits I/O ops&n;&t;&t;&t; * the SCSI FIFO is only 8 bits according to the docs&n;&t;&t;&t; * (we can set bit 1 in 0x8f to serialize FIFO access ...)&n;&t;&t;&t; */
r_if
c_cond
(paren
id|pDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
)paren
(brace
id|DC395x_write32
c_func
(paren
id|TRM_S1040_SCSI_COUNTER
comma
l_int|2
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_CONFIG2
comma
id|CFG2_WIDEFIFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioDir
op_amp
id|DMACMD_DIR
)paren
(brace
multiline_comment|/* read */
id|data
op_assign
id|DC395x_read8
(paren
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
id|data2
op_assign
id|DC395x_read8
(paren
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
multiline_comment|/*printk (DC395X_NAME &quot;: DataIO: Xfer pad: %02x %02x&bslash;n&quot;, data, data2); */
)brace
r_else
(brace
multiline_comment|/* Danger, Robinson: If you find KGs scattered over the wide&n;&t;&t;&t;&t;&t; * disk, the driver or chip is to blame :-( */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
l_char|&squot;K&squot;
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
l_char|&squot;G&squot;
)paren
suffix:semicolon
)brace
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_CONFIG2
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|DC395x_write32
c_func
(paren
id|TRM_S1040_SCSI_COUNTER
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Danger, Robinson: If you find a collection of Ks on your disk&n;&t;&t;&t;&t; * something broke :-( */
r_if
c_cond
(paren
id|ioDir
op_amp
id|DMACMD_DIR
)paren
(brace
multiline_comment|/* read */
id|data
op_assign
id|DC395x_read8
(paren
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
multiline_comment|/*printk (DC395X_NAME &quot;: DataIO: Xfer pad: %02x&bslash;n&quot;, data); */
)brace
r_else
(brace
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
comma
l_char|&squot;K&squot;
)paren
suffix:semicolon
)brace
)brace
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_XFERPAD
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/*&n;&t;&t;&t; * SCSI command &n;&t;&t;&t; */
id|bval
op_assign
(paren
id|ioDir
op_amp
id|DMACMD_DIR
)paren
ques
c_cond
id|SCMD_FIFO_IN
suffix:colon
id|SCMD_FIFO_OUT
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|bval
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*DC395x_monitor_next_IRQ = 2; */
multiline_comment|/*printk (&quot; done&bslash;n&quot;); */
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_StatusPhase0: one of DC395x_SCSI_phase0[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase0[phase]&n; *&t;&t;&t;&t;if phase =3  &n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_StatusPhase0
id|DC395x_StatusPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: StatusPhase0 (pid %li)&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;STP0 *&quot;
)paren
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
id|pSRB-&gt;EndMessage
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
multiline_comment|/* get message */
id|pSRB-&gt;SRBState
op_assign
id|SRB_COMPLETED
suffix:semicolon
op_star
id|pscsi_status
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/*.. initial phase */
multiline_comment|/*1.25 */
multiline_comment|/*DC395x_clrfifo (pACB, &quot;STP0&quot;); */
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/*&n;&t; ** SCSI command &n;&t; */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_MSGACCEPT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_StatusPhase1: one of DC395x_SCSI_phase1[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase1[phase]&n; *&t;&t;&t;&t;if phase =3 &n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_StatusPhase1
id|DC395x_StatusPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: StatusPhase1 (pid=%li)&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;STP1 *&quot;
)paren
suffix:semicolon
multiline_comment|/* Cleanup is now done at the end of DataXXPhase0 */
multiline_comment|/*DC395x_cleanup_after_transfer (pACB, pSRB); */
id|pSRB-&gt;SRBState
op_assign
id|SRB_STATUS
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/*&n;&t; * SCSI command &n;&t; */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_COMP
)paren
suffix:semicolon
)brace
multiline_comment|/* Message handling */
macro_line|#if 0
multiline_comment|/* Print received message */
r_static
r_void
id|DC395x_printMsg
c_func
(paren
id|u8
op_star
id|MsgBuf
comma
id|u32
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|MsgBuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|MsgBuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Check if the message is complete */
DECL|function|DC395x_MsgIn_complete
r_static
r_inline
id|u8
id|DC395x_MsgIn_complete
c_func
(paren
id|u8
op_star
id|msgbuf
comma
id|u32
id|len
)paren
(brace
r_if
c_cond
(paren
op_star
id|msgbuf
op_eq
id|EXTENDED_MESSAGE
)paren
(brace
r_if
c_cond
(paren
id|len
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|msgbuf
(braket
l_int|1
)braket
op_plus
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|msgbuf
op_ge
l_int|0x20
op_logical_and
op_star
id|msgbuf
op_le
l_int|0x2f
)paren
multiline_comment|/* two byte messages */
r_if
c_cond
(paren
id|len
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|macro|DC395x_ENABLE_MSGOUT
mdefine_line|#define DC395x_ENABLE_MSGOUT &bslash;&n; DC395x_write16 (TRM_S1040_SCSI_CONTROL, DO_SETATN); &bslash;&n; pSRB-&gt;SRBState |= SRB_MSGOUT
multiline_comment|/* reject_msg */
r_static
r_inline
r_void
DECL|function|DC395x_MsgIn_reject
id|DC395x_MsgIn_reject
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|MESSAGE_REJECT
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|1
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_MSGIN
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_MSGOUT
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Reject message %02x from %02i-%i&bslash;n&quot;
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|0
)braket
comma
id|pSRB-&gt;pSRBDCB-&gt;TargetID
comma
id|pSRB-&gt;pSRBDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;&bslash;&bslash;*&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* abort command */
r_static
r_inline
r_void
DECL|function|DC395x_EnableMsgOut_Abort
id|DC395x_EnableMsgOut_Abort
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|ABORT
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|1
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_MSGIN
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_MSGOUT
suffix:semicolon
multiline_comment|/*&n;&t;   if (pSRB-&gt;pSRBDCB)&n;&t;   pSRB-&gt;pSRBDCB-&gt;DCBFlag &amp;= ~ABORT_DEV_;&n;&t; */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;#*&quot;
)paren
suffix:semicolon
)brace
DECL|function|DC395x_MsgIn_QTag
r_static
r_struct
id|ScsiReqBlk
op_star
id|DC395x_MsgIn_QTag
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
id|u8
id|tag
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|lastSRB
op_assign
id|pDCB-&gt;pGoingLast
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|pSRB
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: QTag Msg (SRB %p): %i &quot;
comma
id|pSRB
comma
id|tag
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;TagMask
op_amp
(paren
l_int|1
op_lshift
id|tag
)paren
)paren
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: MsgIn_QTag: TagMask (%08x) does not reserve tag %i!&bslash;n&quot;
comma
id|pDCB-&gt;TagMask
comma
id|tag
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
r_goto
id|mingx0
suffix:semicolon
r_while
c_loop
(paren
id|pSRB
)paren
(brace
r_if
c_cond
(paren
id|pSRB-&gt;TagNumber
op_eq
id|tag
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
op_eq
id|lastSRB
)paren
r_goto
id|mingx0
suffix:semicolon
id|pSRB
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
)brace
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
l_string|&quot;pid %li (%i-%i)&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB-&gt;pSRBDCB-&gt;TargetID
comma
id|pSRB-&gt;pSRBDCB-&gt;TargetLUN
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pDCB-&gt;DCBFlag
op_amp
id|ABORT_DEV_
)paren
(brace
multiline_comment|/*pSRB-&gt;SRBState = SRB_ABORT_SENT; */
id|DC395x_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DISCONNECT
)paren
)paren
r_goto
id|mingx0
suffix:semicolon
multiline_comment|/* Tag found */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;[%s]*&quot;
comma
id|pDCB-&gt;pActiveSRB-&gt;debugtrace
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;RTag*&quot;
)paren
suffix:semicolon
multiline_comment|/* Just for debugging ... */
id|lastSRB
op_assign
id|pSRB
suffix:semicolon
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;Found.*&quot;
)paren
suffix:semicolon
id|pSRB
op_assign
id|lastSRB
suffix:semicolon
id|memcpy
c_func
(paren
id|pSRB-&gt;MsgInBuf
comma
id|pDCB-&gt;pActiveSRB-&gt;MsgInBuf
comma
id|pACB-&gt;MsgLen
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|pDCB-&gt;pActiveSRB-&gt;SRBState
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_DATA_XFER
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
multiline_comment|/* How can we make the DORS happy? */
r_return
id|pSRB
suffix:semicolon
id|mingx0
suffix:colon
id|pSRB
op_assign
id|pACB-&gt;pTmpSRB
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_UNEXPECT_RESEL
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|MSG_ABORT_TAG
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|1
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;?*&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Unknown tag received: %i: abort !!&bslash;n&quot;
comma
id|tag
)paren
suffix:semicolon
r_return
id|pSRB
suffix:semicolon
)brace
multiline_comment|/* Reprogram registers */
r_static
r_inline
r_void
DECL|function|DC395x_reprog
id|DC395x_reprog
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
)paren
(brace
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_TARGETID
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_SYNC
comma
id|pDCB-&gt;SyncPeriod
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_OFFSET
comma
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
id|DC395x_SetXferRate
c_func
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
multiline_comment|/* set async transfer mode */
r_static
r_void
DECL|function|DC395x_MsgIn_set_async
id|DC395x_MsgIn_set_async
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Target %02i: No sync transfers&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;!S *&quot;
)paren
suffix:semicolon
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
(paren
id|SYNC_NEGO_ENABLE
)paren
suffix:semicolon
id|pDCB-&gt;SyncMode
op_or_assign
id|SYNC_NEGO_DONE
suffix:semicolon
multiline_comment|/*pDCB-&gt;SyncPeriod &amp;= 0; */
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;MinNegoPeriod
op_assign
l_int|200
op_rshift
l_int|2
suffix:semicolon
multiline_comment|/* 200ns &lt;=&gt; 5 MHz */
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_DO_SYNC_NEGO
suffix:semicolon
id|DC395x_reprog
c_func
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|WIDE_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|pDCB-&gt;SyncMode
op_amp
id|WIDE_NEGO_DONE
)paren
)paren
(brace
id|DC395x_Build_WDTR
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: SDTR(rej): Try WDTR anyway ...&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
)brace
multiline_comment|/* set sync transfer mode */
r_static
r_void
DECL|function|DC395x_MsgIn_set_sync
id|DC395x_MsgIn_set_sync
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|u8
id|bval
suffix:semicolon
r_int
id|fact
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
multiline_comment|/*u8 oldsyncperiod = pDCB-&gt;SyncPeriod; */
multiline_comment|/*u8 oldsyncoffset = pDCB-&gt;SyncOffset; */
macro_line|#ifdef DC395x_DEBUG1
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Target %02i: Sync: %ins (%02i.%01i MHz) Offset %i&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
op_lshift
l_int|2
comma
(paren
l_int|250
op_div
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
)paren
comma
(paren
(paren
l_int|250
op_mod
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
)paren
op_star
l_int|10
)paren
op_div
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
OG
l_int|15
)paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_SYNC_NEGO
)paren
)paren
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pDCB-&gt;SyncOffset
op_eq
l_int|0
)paren
id|pDCB-&gt;SyncOffset
op_assign
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
OG
id|pDCB-&gt;SyncOffset
)paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
op_assign
id|pDCB-&gt;SyncOffset
suffix:semicolon
r_else
id|pDCB-&gt;SyncOffset
op_assign
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
suffix:semicolon
id|bval
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|bval
OL
l_int|7
op_logical_and
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
OG
id|dc395x_clock_period
(braket
id|bval
)braket
op_logical_or
id|pDCB-&gt;MinNegoPeriod
OG
id|dc395x_clock_period
(braket
id|bval
)braket
)paren
)paren
id|bval
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
OL
id|dc395x_clock_period
(braket
id|bval
)braket
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Increase sync nego period to %ins&bslash;n&quot;
comma
id|dc395x_clock_period
(braket
id|bval
)braket
op_lshift
l_int|2
)paren
suffix:semicolon
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
op_assign
id|dc395x_clock_period
(braket
id|bval
)braket
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_and_assign
l_int|0xf0
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_or_assign
id|ALT_SYNC
op_or
id|bval
suffix:semicolon
id|pDCB-&gt;MinNegoPeriod
op_assign
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
)paren
id|fact
op_assign
l_int|500
suffix:semicolon
r_else
id|fact
op_assign
l_int|250
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Target %02i: %s Sync: %ins Offset %i (%02i.%01i MB/s)&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
(paren
id|fact
op_eq
l_int|500
)paren
ques
c_cond
l_string|&quot;Wide16&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|pDCB-&gt;MinNegoPeriod
op_lshift
l_int|2
comma
id|pDCB-&gt;SyncOffset
comma
(paren
id|fact
op_div
id|pDCB-&gt;MinNegoPeriod
)paren
comma
(paren
(paren
id|fact
op_mod
id|pDCB-&gt;MinNegoPeriod
)paren
op_star
l_int|10
op_plus
id|pDCB-&gt;MinNegoPeriod
op_div
l_int|2
)paren
op_div
id|pDCB-&gt;MinNegoPeriod
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;S%i *&quot;
comma
id|pDCB-&gt;MinNegoPeriod
op_lshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DO_SYNC_NEGO
)paren
)paren
(brace
multiline_comment|/* Reply with corrected SDTR Message */
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: .. answer w/  %ins %i&bslash;n&quot;
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
op_lshift
l_int|2
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|pSRB-&gt;MsgOutBuf
comma
id|pSRB-&gt;MsgInBuf
comma
l_int|5
)paren
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|5
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|pDCB-&gt;SyncMode
op_or_assign
id|SYNC_NEGO_DONE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|WIDE_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|pDCB-&gt;SyncMode
op_amp
id|WIDE_NEGO_DONE
)paren
)paren
(brace
id|DC395x_Build_WDTR
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: SDTR: Also try WDTR ...&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
)brace
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_DO_SYNC_NEGO
suffix:semicolon
id|pDCB-&gt;SyncMode
op_or_assign
id|SYNC_NEGO_DONE
op_or
id|SYNC_NEGO_ENABLE
suffix:semicolon
id|DC395x_reprog
c_func
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|DC395x_MsgIn_set_nowide
id|DC395x_MsgIn_set_nowide
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: WDTR got rejected from target %02i&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;!W *&quot;
)paren
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_and_assign
op_complement
id|WIDE_SYNC
suffix:semicolon
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
(paren
id|WIDE_NEGO_ENABLE
)paren
suffix:semicolon
id|pDCB-&gt;SyncMode
op_or_assign
id|WIDE_NEGO_DONE
suffix:semicolon
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_DO_WIDE_NEGO
suffix:semicolon
id|DC395x_reprog
c_func
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_NEGO_DONE
)paren
)paren
(brace
id|DC395x_Build_SDTR
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: WDTR(rej): Try SDTR anyway ...&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
)brace
r_static
r_void
DECL|function|DC395x_MsgIn_set_wide
id|DC395x_MsgIn_set_wide
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
op_assign
id|pSRB-&gt;pSRBDCB
suffix:semicolon
id|u8
id|wide
op_assign
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_WIDE_NEGO
op_logical_and
id|pACB-&gt;Config
op_amp
id|HCC_WIDE_CARD
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
OG
id|wide
)paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
op_assign
id|wide
suffix:semicolon
multiline_comment|/* Completed */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DO_WIDE_NEGO
)paren
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Target %02i initiates Wide Nego ...&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|pSRB-&gt;MsgOutBuf
comma
id|pSRB-&gt;MsgInBuf
comma
l_int|4
)paren
suffix:semicolon
id|pSRB-&gt;MsgCnt
op_assign
l_int|4
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_DO_WIDE_NEGO
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
)brace
id|pDCB-&gt;SyncMode
op_or_assign
(paren
id|WIDE_NEGO_ENABLE
op_or
id|WIDE_NEGO_DONE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
OG
l_int|0
)paren
id|pDCB-&gt;SyncPeriod
op_or_assign
id|WIDE_SYNC
suffix:semicolon
r_else
id|pDCB-&gt;SyncPeriod
op_and_assign
op_complement
id|WIDE_SYNC
suffix:semicolon
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_DO_WIDE_NEGO
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;W%i *&quot;
comma
(paren
id|pDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/*pDCB-&gt;SyncMode &amp;= ~(WIDE_NEGO_ENABLE+WIDE_NEGO_DONE); */
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Wide transfers (%i bit) negotiated with target %02i&bslash;n&quot;
comma
(paren
l_int|8
op_lshift
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
)paren
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
macro_line|#endif
id|DC395x_reprog
c_func
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_NEGO_ENABLE
)paren
op_logical_and
op_logical_neg
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_NEGO_DONE
)paren
)paren
(brace
id|DC395x_Build_SDTR
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: WDTR: Also try SDTR ...&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_MsgInPhase0: one of DC395x_SCSI_phase0[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase0[phase]&n; *&t;&t;&t;&t;if phase =7   &n; *&n; * extended message codes:&n; *&n; *&t;code&t;description&n; *&n; *&t;02h&t;Reserved&n; *&t;00h&t;MODIFY DATA  POINTER&n; *&t;01h&t;SYNCHRONOUS DATA TRANSFER REQUEST&n; *&t;03h&t;WIDE DATA TRANSFER REQUEST&n; *   04h - 7Fh&t;Reserved&n; *   80h - FFh&t;Vendor specific&n; *  &n; ********************************************************************&n; */
r_void
DECL|function|DC395x_MsgInPhase0
id|DC395x_MsgInPhase0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_MsgInPhase0..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;MIP0*&quot;
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
id|pSRB-&gt;MsgInBuf
(braket
id|pACB-&gt;MsgLen
op_increment
)braket
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_FIFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DC395x_MsgIn_complete
c_func
(paren
id|pSRB-&gt;MsgInBuf
comma
id|pACB-&gt;MsgLen
)paren
)paren
(brace
id|TRACEPRINTF
c_func
(paren
l_string|&quot;(%02x)*&quot;
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/*printk (KERN_INFO DC395X_NAME &quot;: MsgIn:&quot;); */
multiline_comment|/*DC395x_printMsg (pSRB-&gt;MsgInBuf, pACB-&gt;MsgLen); */
multiline_comment|/* Now eval the msg */
r_switch
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|0
)braket
)paren
(brace
r_case
id|DISCONNECT
suffix:colon
id|pSRB-&gt;SRBState
op_assign
id|SRB_DISCONNECT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIMPLE_QUEUE_TAG
suffix:colon
r_case
id|HEAD_OF_QUEUE_TAG
suffix:colon
r_case
id|ORDERED_QUEUE_TAG
suffix:colon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;(%02x)*&quot;
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|pSRB
op_assign
id|DC395x_MsgIn_QTag
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MESSAGE_REJECT
suffix:colon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_CLRATN
op_or
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* A sync nego message was rejected ! */
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DO_SYNC_NEGO
)paren
(brace
id|DC395x_MsgIn_set_async
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* A wide nego message was rejected ! */
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DO_WIDE_NEGO
)paren
(brace
id|DC395x_MsgIn_set_nowide
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DC395x_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/*pSRB-&gt;SRBState |= SRB_ABORT_SENT */
r_break
suffix:semicolon
r_case
id|EXTENDED_MESSAGE
suffix:colon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;(%02x)*&quot;
comma
id|pSRB-&gt;MsgInBuf
(braket
l_int|2
)braket
)paren
suffix:semicolon
multiline_comment|/* SDTR */
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|1
)braket
op_eq
l_int|3
op_logical_and
id|pSRB-&gt;MsgInBuf
(braket
l_int|2
)braket
op_eq
id|EXTENDED_SDTR
)paren
(brace
id|DC395x_MsgIn_set_sync
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* WDTR */
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|1
)braket
op_eq
l_int|2
op_logical_and
id|pSRB-&gt;MsgInBuf
(braket
l_int|2
)braket
op_eq
id|EXTENDED_WDTR
op_logical_and
id|pSRB-&gt;MsgInBuf
(braket
l_int|3
)braket
op_le
l_int|2
)paren
(brace
multiline_comment|/* sanity check ... */
id|DC395x_MsgIn_set_wide
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DC395x_MsgIn_reject
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Discard  wide residual */
r_case
id|MSG_IGNOREWIDE
suffix:colon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: Ignore Wide Residual!&bslash;n&quot;
)paren
suffix:semicolon
)paren
multiline_comment|/*DC395x_write32 (TRM_S1040_SCSI_COUNTER, 1); */
multiline_comment|/*DC395x_read8 (TRM_S1040_SCSI_FIFO); */
r_break
suffix:semicolon
multiline_comment|/* nothing has to be done */
r_case
id|COMMAND_COMPLETE
suffix:colon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * SAVE POINTER may be ignored as we have the struct ScsiReqBlk* associated with the&n;&t;&t;&t; * scsi command. Thanks, G&#xfffd;rard, for pointing it out.&n;&t;&t;&t; */
r_case
id|SAVE_POINTERS
suffix:colon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: SAVE POINTER message received (pid %li: rem.%i) ... ignore :-(&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB-&gt;SRBTotalXferLength
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*pSRB-&gt;Saved_Ptr = pSRB-&gt;TotalXferredLen; */
r_break
suffix:semicolon
multiline_comment|/* The device might want to restart transfer with a RESTORE */
r_case
id|RESTORE_POINTERS
suffix:colon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: RESTORE POINTER message received ... ignore :-(&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*dc395x_restore_ptr (pACB, pSRB); */
r_break
suffix:semicolon
r_case
id|ABORT
suffix:colon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: ABORT msg received (pid %li %02i-%i)&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|pDCB-&gt;DCBFlag
op_or_assign
id|ABORT_DEV_
suffix:semicolon
id|DC395x_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* reject unknown messages */
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|pSRB-&gt;MsgInBuf
(braket
l_int|0
)braket
op_amp
id|IDENTIFY_BASE
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Identify Message received?&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*TRACEOUT (&quot; %s&bslash;n&quot;, pSRB-&gt;debugtrace); */
id|pSRB-&gt;MsgCnt
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;MsgOutBuf
(braket
l_int|0
)braket
op_assign
id|pDCB-&gt;IdentifyMsg
suffix:semicolon
id|DC395x_ENABLE_MSGOUT
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_MSGOUT
suffix:semicolon
multiline_comment|/*break; */
)brace
id|DC395x_MsgIn_reject
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|TRACEOUT
c_func
(paren
l_string|&quot; %s&bslash;n&quot;
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
)brace
id|TRACEPRINTF
c_func
(paren
l_string|&quot;.*&quot;
)paren
suffix:semicolon
multiline_comment|/* Clear counter and MsgIn state */
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_MSGIN
suffix:semicolon
id|pACB-&gt;MsgLen
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*1.25 */
r_if
c_cond
(paren
(paren
op_star
id|pscsi_status
op_amp
id|PHASEMASK
)paren
op_ne
id|PH_MSG_IN
)paren
macro_line|#if 0
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;MIP0_&quot;
)paren
suffix:semicolon
macro_line|#else
id|TRACEPRINTF
c_func
(paren
l_string|&quot;N/Cln *&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
id|pscsi_status
op_assign
id|PH_BUS_FREE
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important ... you know! */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_MSGACCEPT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_MsgInPhase1: one of DC395x_SCSI_phase1[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase1[phase]&n; *&t;&t;&t;&t;if phase =7&t;   &n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_MsgInPhase1
id|DC395x_MsgInPhase1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_MsgInPhase1..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;MIP1 *&quot;
)paren
suffix:semicolon
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;MIP1&quot;
)paren
suffix:semicolon
id|DC395x_write32
c_func
(paren
id|TRM_S1040_SCSI_COUNTER
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_MSGIN
)paren
)paren
(brace
id|pSRB-&gt;SRBState
op_and_assign
op_complement
id|SRB_DISCONNECT
suffix:semicolon
id|pSRB-&gt;SRBState
op_or_assign
id|SRB_MSGIN
suffix:semicolon
)brace
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/*&n;&t; * SCSI command &n;&t; */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_FIFO_IN
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_Nop0: one of DC395x_SCSI_phase1[] ,DC395x_SCSI_phase0[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase0[phase]&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase1[phase]&n; *&t;&t;&t;&t;if phase =4 ..PH_BUS_FREE&n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_Nop0
id|DC395x_Nop0
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
multiline_comment|/*TRACEPRINTF(&quot;NOP0 *&quot;); */
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;DC395x_Nop1: one of DC395x_SCSI_phase0[] ,DC395x_SCSI_phase1[] vectors&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase0[phase]&n; *&t; DC395x_stateV = (void *)DC395x_SCSI_phase1[phase]&n; *&t;&t;&t;&t;if phase =5&n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_Nop1
id|DC395x_Nop1
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
comma
id|u16
op_star
id|pscsi_status
)paren
(brace
multiline_comment|/*TRACEPRINTF(&quot;NOP1 *&quot;); */
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;&t;DC395x_MsgInPhase0&n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_SetXferRate
id|DC395x_SetXferRate
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
)paren
(brace
id|u8
id|bval
suffix:semicolon
id|u16
id|cnt
comma
id|i
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCBTemp
suffix:semicolon
multiline_comment|/*&n;&t; ** set all lun device&squot;s  period , offset&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;IdentifyMsg
op_amp
l_int|0x07
)paren
)paren
(brace
r_if
c_cond
(paren
id|pACB-&gt;scan_devices
)paren
id|DC395x_CurrSyncOffset
op_assign
id|pDCB-&gt;SyncOffset
suffix:semicolon
r_else
(brace
id|pDCBTemp
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|cnt
op_assign
id|pACB-&gt;DCBCnt
suffix:semicolon
id|bval
op_assign
id|pDCB-&gt;TargetID
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pDCBTemp-&gt;TargetID
op_eq
id|bval
)paren
(brace
id|pDCBTemp-&gt;SyncPeriod
op_assign
id|pDCB-&gt;SyncPeriod
suffix:semicolon
id|pDCBTemp-&gt;SyncOffset
op_assign
id|pDCB-&gt;SyncOffset
suffix:semicolon
id|pDCBTemp-&gt;SyncMode
op_assign
id|pDCB-&gt;SyncMode
suffix:semicolon
id|pDCBTemp-&gt;MinNegoPeriod
op_assign
id|pDCB-&gt;MinNegoPeriod
suffix:semicolon
)brace
id|pDCBTemp
op_assign
id|pDCBTemp-&gt;pNextDCB
suffix:semicolon
)brace
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;&t;DC395x_Interrupt&n; ********************************************************************&n; */
DECL|function|DC395x_Disconnect
r_void
id|DC395x_Disconnect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|pSRB
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Disconnect (pid=%li)&bslash;n&quot;
comma
id|pACB-&gt;pActiveDCB-&gt;pActiveSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
macro_line|#endif
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DC395X_NAME
l_string|&quot;: Disc: Exception Disconnect pDCB=NULL !!&bslash;n &quot;
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
multiline_comment|/* Suspend queue for a while */
id|pACB-&gt;pScsiHost-&gt;last_reset
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc395x_trm_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
dot
id|NvramDelayTime
suffix:semicolon
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;DiscEx&quot;
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_HWRESELECT
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
l_int|0
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;DISC *&quot;
)paren
suffix:semicolon
id|pSRB-&gt;ScsiPhase
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/* initial phase */
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;Disc&quot;
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_HWRESELECT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_UNEXPECT_RESEL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DC395X_NAME
l_string|&quot;: Disc: Unexpected Reselection (%i-%i)&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
l_int|0
suffix:semicolon
id|DC395x_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_ABORT_SENT
)paren
(brace
multiline_comment|/*Scsi_Cmnd* pcmd = pSRB-&gt;pcmd; */
id|pDCB-&gt;DCBFlag
op_and_assign
op_complement
id|ABORT_DEV_
suffix:semicolon
id|pACB-&gt;pScsiHost-&gt;last_reset
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
op_plus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|DC395X_NAME
l_string|&quot;: Disc: SRB_ABORT_SENT!&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_DoingSRB_Done
c_func
(paren
id|pACB
comma
id|DID_ABORT
comma
id|pSRB-&gt;pcmd
comma
l_int|1
)paren
suffix:semicolon
id|DC395x_Query_to_Waiting
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|DC395x_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|pSRB-&gt;SRBState
op_amp
(paren
id|SRB_START_
op_plus
id|SRB_MSGOUT
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|pSRB
op_member_access_from_pointer
id|SRBState
op_amp
(paren
id|SRB_DISCONNECT
op_plus
id|SRB_COMPLETED
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Selection time out &n;&t;&t;&t; * SRB_START_ || SRB_MSGOUT || (!SRB_DISCONNECT &amp;&amp; !SRB_COMPLETED)&n;&t;&t;&t; */
multiline_comment|/* Unexp. Disc / Sel Timeout */
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_ne
id|SRB_START_
op_logical_and
id|pSRB-&gt;SRBState
op_ne
id|SRB_MSGOUT
)paren
(brace
id|pSRB-&gt;SRBState
op_assign
id|SRB_READY
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Unexpected Disconnection (pid %li)!&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
id|SCSI_STAT_SEL_TIMEOUT
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;UnExpD *&quot;
)paren
suffix:semicolon
id|TRACEOUT
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
r_goto
id|disc1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Normal selection timeout */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;SlTO *&quot;
)paren
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Disc: SelTO (pid=%li) for dev %02i-%i&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pSRB-&gt;RetryCnt
op_increment
OG
id|DC395x_MAX_RETRIES
op_logical_or
id|pACB-&gt;scan_devices
)paren
(brace
id|pSRB-&gt;TargetStatus
op_assign
id|SCSI_STAT_SEL_TIMEOUT
suffix:semicolon
r_goto
id|disc1
suffix:semicolon
)brace
id|DC395x_freetag
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_Going_to_Waiting
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Retry pid %li ...&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
macro_line|#endif
id|DC395x_waiting_timer
c_func
(paren
id|pACB
comma
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DISCONNECT
)paren
(brace
id|u8
id|bval
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_SIGNAL
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * SRB_DISCONNECT (This is what we expect!)&n;&t;&t;&t; */
multiline_comment|/* printk (DC395X_NAME &quot;: DoWaitingSRB (pid=%li)&bslash;n&quot;, pSRB-&gt;pcmd-&gt;pid); */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;+*&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_amp
l_int|0x40
)paren
(brace
id|DEBUG0
c_func
(paren
id|printk
(paren
id|DC395X_NAME
l_string|&quot;: Debug: DISC: SCSI bus stat %02x: ACK set! Other controllers?&bslash;n&quot;
comma
id|bval
)paren
suffix:semicolon
)paren
multiline_comment|/* It could come from another initiator, therefore don&squot;t do much ! */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;ACK(%02x) *&quot;
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/*DC395x_dumpinfo (pACB, pDCB, pSRB); */
multiline_comment|/*TRACEOUT (&quot; %s&bslash;n&quot;, pSRB-&gt;debugtrace); */
multiline_comment|/*pDCB-&gt;DCBFlag |= ABORT_DEV_; */
multiline_comment|/*DC395x_EnableMsgOut_Abort (pACB, pSRB); */
multiline_comment|/*DC395x_write16 (TRM_S1040_SCSI_CONTROL, DO_CLRFIFO | DO_CLRATN | DO_HWRESELECT); */
)brace
r_else
id|DC395x_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_COMPLETED
)paren
(brace
id|disc1
suffix:colon
multiline_comment|/*&n;&t;&t;&t; ** SRB_COMPLETED&n;&t;&t;&t; */
id|DC395x_freetag
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_FREE
suffix:semicolon
multiline_comment|/*printk (DC395X_NAME &quot;: done (pid=%li)&bslash;n&quot;, pSRB-&gt;pcmd-&gt;pid); */
id|DC395x_SRBdone
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;&t;DC395x_Reselect&n; ********************************************************************&n; */
DECL|function|DC395x_Reselect
r_void
id|DC395x_Reselect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|pSRB
op_assign
l_int|0
suffix:semicolon
id|u16
id|RselTarLunId
suffix:semicolon
id|u8
id|id
comma
id|lun
suffix:semicolon
id|u8
id|arblostflag
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_Reselect..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;Resel&quot;
)paren
suffix:semicolon
multiline_comment|/*DC395x_write16(TRM_S1040_SCSI_CONTROL, DO_HWRESELECT | DO_DATALATCH); */
multiline_comment|/* Read Reselected Target ID and LUN */
id|RselTarLunId
op_assign
id|DC395x_read16
c_func
(paren
id|TRM_S1040_SCSI_TARGETID
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pActiveDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
)paren
(brace
multiline_comment|/* Arbitration lost but Reselection win */
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Arb lost Resel won, but pActiveSRB == 0!&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
r_return
suffix:semicolon
)brace
multiline_comment|/* Why the if ? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pACB-&gt;scan_devices
)paren
)paren
(brace
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Arb lost but Resel win pid %li (%02i-%i) Rsel %04x Stat %04x&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|RselTarLunId
comma
id|DC395x_read16
c_func
(paren
id|TRM_S1040_SCSI_STATUS
)paren
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;ArbLResel!*&quot;
)paren
suffix:semicolon
multiline_comment|/*TRACEOUT (&quot; %s&bslash;n&quot;, pSRB-&gt;debugtrace); */
id|arblostflag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*pSRB-&gt;SRBState |= SRB_DISCONNECT; */
id|pSRB-&gt;SRBState
op_assign
id|SRB_READY
suffix:semicolon
id|DC395x_freetag
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_Going_to_Waiting
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_waiting_timer
c_func
(paren
id|pACB
comma
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
multiline_comment|/* return; */
)brace
)brace
multiline_comment|/* Read Reselected Target Id and LUN */
r_if
c_cond
(paren
op_logical_neg
(paren
id|RselTarLunId
op_amp
(paren
id|IDENTIFY_BASE
op_lshift
l_int|8
)paren
)paren
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Resel expects identify msg! Got %04x!&bslash;n&quot;
comma
id|RselTarLunId
)paren
suffix:semicolon
id|id
op_assign
id|RselTarLunId
op_amp
l_int|0xff
suffix:semicolon
id|lun
op_assign
(paren
id|RselTarLunId
op_rshift
l_int|8
)paren
op_amp
l_int|7
suffix:semicolon
id|pDCB
op_assign
id|DC395x_findDCB
c_func
(paren
id|pACB
comma
id|id
comma
id|lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DC395X_NAME
l_string|&quot;: Reselect from non existing device (%02i-%i)&bslash;n&quot;
comma
id|id
comma
id|lun
)paren
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
r_return
suffix:semicolon
)brace
id|pACB-&gt;pActiveDCB
op_assign
id|pDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_DISCONNECT
)paren
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Reselection in spite of forbidden disconnection? (%02i-%i)&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pDCB-&gt;SyncMode
op_amp
id|EN_TAG_QUEUEING
)paren
multiline_comment|/*&amp;&amp; !arblostflag */
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|oldSRB
op_assign
id|pSRB
suffix:semicolon
id|pSRB
op_assign
id|pACB-&gt;pTmpSRB
suffix:semicolon
macro_line|#ifdef DC395x_DEBUGTRACE
id|pSRB-&gt;debugpos
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;debugtrace
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
r_if
c_cond
(paren
id|oldSRB
)paren
id|TRACEPRINTF
c_func
(paren
l_string|&quot;ArbLResel(%li):*&quot;
comma
id|oldSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
multiline_comment|/*if (arblostflag) printk (DC395X_NAME &quot;: Reselect: Wait for Tag ... &bslash;n&quot;); */
)brace
r_else
(brace
multiline_comment|/* There can be only one! */
id|pSRB
op_assign
id|pDCB-&gt;pActiveSRB
suffix:semicolon
r_if
c_cond
(paren
id|pSRB
)paren
id|TRACEPRINTF
c_func
(paren
l_string|&quot;RSel *&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRB
op_logical_or
op_logical_neg
(paren
id|pSRB-&gt;SRBState
op_amp
id|SRB_DISCONNECT
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * abort command&n;&t;&t;&t; */
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Reselected w/o disconnected cmds from %02i-%i?&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|pSRB
op_assign
id|pACB-&gt;pTmpSRB
suffix:semicolon
id|pSRB-&gt;SRBState
op_assign
id|SRB_UNEXPECT_RESEL
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
id|pSRB
suffix:semicolon
id|DC395x_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pDCB-&gt;DCBFlag
op_amp
id|ABORT_DEV_
)paren
(brace
multiline_comment|/*pSRB-&gt;SRBState = SRB_ABORT_SENT; */
id|DC395x_EnableMsgOut_Abort
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
)brace
r_else
id|pSRB-&gt;SRBState
op_assign
id|SRB_DATA_XFER
suffix:semicolon
)brace
multiline_comment|/*if (arblostflag) TRACEOUT (&quot; %s&bslash;n&quot;, pSRB-&gt;debugtrace); */
)brace
id|pSRB-&gt;ScsiPhase
op_assign
id|PH_BUS_FREE
suffix:semicolon
multiline_comment|/* initial phase */
multiline_comment|/* &n;&t; ***********************************************&n;&t; ** Program HA ID, target ID, period and offset&n;&t; ***********************************************&n;&t; */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_HOSTID
comma
id|pACB-&gt;pScsiHost-&gt;this_id
)paren
suffix:semicolon
multiline_comment|/* host   ID */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_TARGETID
comma
id|pDCB-&gt;TargetID
)paren
suffix:semicolon
multiline_comment|/* target ID */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_OFFSET
comma
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
multiline_comment|/* offset    */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_SYNC
comma
id|pDCB-&gt;SyncPeriod
)paren
suffix:semicolon
multiline_comment|/* sync period, wide */
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_DATALATCH
)paren
suffix:semicolon
multiline_comment|/* it&squot;s important for atn stop */
multiline_comment|/* SCSI command */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_COMMAND
comma
id|SCMD_MSGACCEPT
)paren
suffix:semicolon
)brace
multiline_comment|/* Dynamic device handling */
multiline_comment|/* Remove dev (and DCB) */
r_static
r_void
DECL|function|DC395x_remove_dev
id|DC395x_remove_dev
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pPrevDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;GoingSRBCnt
OG
l_int|1
)paren
(brace
id|DCBDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Driver won&squot;t free DCB (ID %i, LUN %i): 0x%08x because of SRBCnt %i&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
(paren
r_int
)paren
id|pDCB
comma
id|pDCB-&gt;GoingSRBCnt
)paren
suffix:semicolon
)paren
r_return
suffix:semicolon
)brace
id|pACB-&gt;DCBmap
(braket
id|pDCB-&gt;TargetID
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|pACB-&gt;children
(braket
id|pDCB-&gt;TargetID
)braket
(braket
id|pDCB-&gt;TargetLUN
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* The first one */
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLinkDCB
)paren
(brace
multiline_comment|/* The last one */
r_if
c_cond
(paren
id|pACB-&gt;pLastDCB
op_eq
id|pDCB
)paren
(brace
id|pDCB-&gt;pNextDCB
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;pLastDCB
op_assign
l_int|0
suffix:semicolon
)brace
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|pPrevDCB-&gt;pNextDCB
op_ne
id|pDCB
)paren
id|pPrevDCB
op_assign
id|pPrevDCB-&gt;pNextDCB
suffix:semicolon
id|pPrevDCB-&gt;pNextDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLastDCB
)paren
id|pACB-&gt;pLastDCB
op_assign
id|pPrevDCB
suffix:semicolon
)brace
id|DCBDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Driver about to free DCB (ID %i, LUN %i): %p&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|pDCB
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pActiveDCB
)paren
id|pACB-&gt;pActiveDCB
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pLinkDCB
)paren
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
op_eq
id|pACB-&gt;pDCBRunRobin
)paren
id|pACB-&gt;pDCBRunRobin
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
id|pACB-&gt;DCBCnt
op_decrement
suffix:semicolon
id|KFREE
c_func
(paren
id|pDCB
)paren
suffix:semicolon
multiline_comment|/* pACB-&gt;DeviceCnt--; */
)brace
DECL|function|DC395x_tagq_blacklist
r_static
r_inline
id|u8
id|DC395x_tagq_blacklist
c_func
(paren
r_char
op_star
id|name
)paren
(brace
macro_line|#ifndef DC395x_NO_TAGQ
macro_line|#if 0
id|u8
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BADDEVCNT
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|name
comma
id|DC395x_baddevname1
(braket
id|i
)braket
comma
l_int|28
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_static
r_void
DECL|function|DC395x_disc_tagq_set
id|DC395x_disc_tagq_set
c_func
(paren
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiInqData
op_star
id|ptr
)paren
(brace
multiline_comment|/* Check for SCSI format (ANSI and Response data format) */
r_if
c_cond
(paren
(paren
id|ptr-&gt;Vers
op_amp
l_int|0x07
)paren
op_ge
l_int|2
op_logical_or
(paren
id|ptr-&gt;RDF
op_amp
l_int|0x0F
)paren
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|ptr-&gt;Flags
op_amp
id|SCSI_INQ_CMDQUEUE
)paren
op_logical_and
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_TAG_QUEUEING
)paren
op_logical_and
multiline_comment|/*(pDCB-&gt;DevMode &amp; NTC_DO_DISCONNECT) */
multiline_comment|/* ((pDCB-&gt;DevType == TYPE_DISK) &n;&t;&t;       || (pDCB-&gt;DevType == TYPE_MOD)) &amp;&amp; */
op_logical_neg
id|DC395x_tagq_blacklist
c_func
(paren
(paren
(paren
r_char
op_star
)paren
id|ptr
)paren
op_plus
l_int|8
)paren
)paren
(brace
r_if
c_cond
(paren
id|pDCB-&gt;MaxCommand
op_eq
l_int|1
)paren
id|pDCB-&gt;MaxCommand
op_assign
id|pDCB-&gt;pDCBACB-&gt;TagMaxNum
suffix:semicolon
id|pDCB-&gt;SyncMode
op_or_assign
id|EN_TAG_QUEUEING
suffix:semicolon
multiline_comment|/*pDCB-&gt;TagMask = 0; */
)brace
r_else
id|pDCB-&gt;MaxCommand
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|DC395x_add_dev
id|DC395x_add_dev
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiInqData
op_star
id|ptr
)paren
(brace
id|u8
id|bval1
op_assign
id|ptr-&gt;DevType
op_amp
id|SCSI_DEVTYPE
suffix:semicolon
id|pDCB-&gt;DevType
op_assign
id|bval1
suffix:semicolon
multiline_comment|/* if (bval1 == TYPE_DISK || bval1 == TYPE_MOD) */
id|DC395x_disc_tagq_set
c_func
(paren
id|pDCB
comma
id|ptr
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; ********************************************************************&n; * unmap mapped pci regions from SRB&n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_pci_unmap
id|DC395x_pci_unmap
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
r_int
id|dir
suffix:semicolon
id|Scsi_Cmnd
op_star
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
id|dir
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
op_logical_and
id|dir
op_ne
id|PCI_DMA_NONE
)paren
(brace
multiline_comment|/* unmap DC395x SG list */
macro_line|#ifdef DC395x_SGPARANOIA
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Unmap SG descriptor list %08x (%05x)&bslash;n&quot;
comma
id|pSRB-&gt;SRBSGBusAddr
comma
r_sizeof
(paren
r_struct
id|SGentry
)paren
op_star
id|DC395x_MAX_SG_LISTENTRY
)paren
suffix:semicolon
macro_line|#endif
id|pci_unmap_single
c_func
(paren
id|pACB-&gt;pdev
comma
id|pSRB-&gt;SRBSGBusAddr
comma
r_sizeof
(paren
r_struct
id|SGentry
)paren
op_star
id|DC395x_MAX_SG_LISTENTRY
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
macro_line|#ifdef DC395x_SGPARANOIA
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Unmap %i SG segments from %p&bslash;n&quot;
comma
id|pcmd-&gt;use_sg
comma
id|pcmd-&gt;request_buffer
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* unmap the sg segments */
id|pci_unmap_sg
c_func
(paren
id|pACB-&gt;pdev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|pcmd-&gt;request_buffer
comma
id|pcmd-&gt;use_sg
comma
id|dir
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
op_logical_and
id|dir
op_ne
id|PCI_DMA_NONE
)paren
(brace
macro_line|#ifdef DC395x_SGPARANOIA
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Unmap buffer at %08x (%05x)&bslash;n&quot;
comma
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
comma
id|pcmd-&gt;request_bufflen
)paren
suffix:semicolon
macro_line|#endif
id|pci_unmap_single
c_func
(paren
id|pACB-&gt;pdev
comma
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
comma
id|pcmd-&gt;request_bufflen
comma
id|dir
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; ********************************************************************&n; * unmap mapped pci sense buffer from SRB&n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_pci_unmap_sense
id|DC395x_pci_unmap_sense
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Unmap sense buffer */
macro_line|#ifdef DC395x_SGPARANOIA
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Unmap sense buffer from %08x (%05x)&bslash;n&quot;
comma
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
comma
r_sizeof
(paren
id|pcmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
macro_line|#endif
id|pci_unmap_single
c_func
(paren
id|pACB-&gt;pdev
comma
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
comma
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|length
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
multiline_comment|/* Restore SG stuff */
multiline_comment|/*printk (&quot;Auto_ReqSense finished: Restore Counters ...&bslash;n&quot;); */
id|pSRB-&gt;SRBTotalXferLength
op_assign
id|pSRB-&gt;Xferred
suffix:semicolon
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
op_assign
id|pSRB-&gt;SegmentX
(braket
id|DC395x_MAX_SG_LISTENTRY
op_minus
l_int|1
)braket
dot
id|address
suffix:semicolon
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|length
op_assign
id|pSRB-&gt;SegmentX
(braket
id|DC395x_MAX_SG_LISTENTRY
op_minus
l_int|1
)braket
dot
id|length
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;&t;DC395x_Disconnected&n; *&t;Complete execution of a SCSI command&n; *&t;Signal completion to the generic SCSI driver  &n; ********************************************************************&n; */
r_void
DECL|function|DC395x_SRBdone
id|DC395x_SRBdone
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|u8
id|tempcnt
comma
id|status
suffix:semicolon
id|Scsi_Cmnd
op_star
id|pcmd
suffix:semicolon
r_struct
id|ScsiInqData
op_star
id|ptr
suffix:semicolon
multiline_comment|/*u32              drv_flags=0; */
r_int
id|dir
suffix:semicolon
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;DONE *&quot;
)paren
suffix:semicolon
id|dir
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|ptr
op_assign
(paren
r_struct
id|ScsiInqData
op_star
)paren
(paren
id|pcmd-&gt;request_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
id|ptr
op_assign
(paren
r_struct
id|ScsiInqData
op_star
)paren
id|CPU_ADDR
c_func
(paren
op_star
(paren
r_struct
id|scatterlist
op_star
)paren
id|ptr
)paren
suffix:semicolon
macro_line|#ifdef DC395x_SGPARANOIA
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: SRBdone SG=%i (%i/%i), req_buf = %p, adr = %p&bslash;n&quot;
comma
id|pcmd-&gt;use_sg
comma
id|pSRB-&gt;SRBSGIndex
comma
id|pSRB-&gt;SRBSGCount
comma
id|pcmd-&gt;request_buffer
comma
id|ptr
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: SRBdone (pid %li, target %02i-%i): &quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;id
comma
id|pSRB-&gt;pcmd-&gt;device-&gt;lun
)paren
suffix:semicolon
macro_line|#endif
id|status
op_assign
id|pSRB-&gt;TargetStatus
suffix:semicolon
r_if
c_cond
(paren
id|pSRB-&gt;SRBFlag
op_amp
id|AUTO_REQSENSE
)paren
(brace
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;AUTO_REQSENSE1..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|DC395x_pci_unmap_sense
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; ** target status..........................&n;&t;&t; */
id|pSRB-&gt;SRBFlag
op_and_assign
op_complement
id|AUTO_REQSENSE
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
id|CHECK_CONDITION
op_lshift
l_int|1
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG_KG
r_switch
c_cond
(paren
id|pcmd-&gt;sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
(brace
r_case
id|NOT_READY
suffix:colon
id|printk
(paren
l_string|&quot;&bslash;nDC395x:  ReqSense: NOT_READY (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i) &quot;
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|status
comma
id|pACB-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UNIT_ATTENTION
suffix:colon
id|printk
(paren
l_string|&quot;&bslash;nDC395x:  ReqSense: UNIT_ATTENTION (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i) &quot;
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|status
comma
id|pACB-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ILLEGAL_REQUEST
suffix:colon
id|printk
(paren
l_string|&quot;&bslash;nDC395x:  ReqSense: ILLEGAL_REQUEST (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i) &quot;
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|status
comma
id|pACB-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEDIUM_ERROR
suffix:colon
id|printk
(paren
l_string|&quot;&bslash;nDC395x:  ReqSense: MEDIUM_ERROR (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i) &quot;
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|status
comma
id|pACB-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARDWARE_ERROR
suffix:colon
id|printk
(paren
l_string|&quot;&bslash;nDC395x:  ReqSense: HARDWARE_ERROR (Cmnd = 0x%02x, Dev = %i-%i, Stat = %i, Scan = %i) &quot;
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|status
comma
id|pACB-&gt;scan_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcmd-&gt;sense_buffer
(braket
l_int|7
)braket
op_ge
l_int|6
)paren
id|printk
(paren
l_string|&quot;&bslash;nDC395x:  Sense=%02x, ASC=%02x, ASCQ=%02x (%08x %08x) &quot;
comma
id|pcmd-&gt;sense_buffer
(braket
l_int|2
)braket
comma
id|pcmd-&gt;sense_buffer
(braket
l_int|12
)braket
comma
id|pcmd-&gt;sense_buffer
(braket
l_int|13
)braket
comma
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|pcmd-&gt;sense_buffer
op_plus
l_int|3
)paren
)paren
comma
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|pcmd-&gt;sense_buffer
op_plus
l_int|8
)paren
)paren
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;&bslash;nDC395x:  Sense=%02x, No ASC/ASCQ (%08x) &quot;
comma
id|pcmd-&gt;sense_buffer
(braket
l_int|2
)braket
comma
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|pcmd-&gt;sense_buffer
op_plus
l_int|3
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
op_eq
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
)paren
(brace
id|pcmd-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
r_goto
id|ckc_e
suffix:semicolon
)brace
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;AUTO_REQSENSE2..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|pSRB-&gt;SRBTotalXferLength
)paren
op_logical_and
(paren
id|pSRB-&gt;SRBTotalXferLength
op_ge
id|pcmd-&gt;underflow
)paren
)paren
id|pcmd-&gt;result
op_assign
id|MK_RES_LNX
c_func
(paren
id|DRIVER_SENSE
comma
id|DID_OK
comma
id|pSRB-&gt;EndMessage
comma
id|CHECK_CONDITION
)paren
suffix:semicolon
multiline_comment|/*SET_RES_DID(pcmd-&gt;result,DID_OK) */
r_else
id|pcmd-&gt;result
op_assign
id|MK_RES_LNX
c_func
(paren
id|DRIVER_SENSE
comma
id|DID_OK
comma
id|pSRB-&gt;EndMessage
comma
id|CHECK_CONDITION
)paren
suffix:semicolon
r_goto
id|ckc_e
suffix:semicolon
)brace
multiline_comment|/*************************************************************/
r_if
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/*&n;&t;&t; * target status..........................&n;&t;&t; */
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|status
)paren
op_eq
id|CHECK_CONDITION
)paren
(brace
id|DC395x_RequestSense
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|status
)paren
op_eq
id|QUEUE_FULL
)paren
(brace
id|tempcnt
op_assign
(paren
id|u8
)paren
id|pDCB-&gt;GoingSRBCnt
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;nDC395x:  QUEUE_FULL for dev %02i-%i with %i cmnds&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|tempcnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tempcnt
OG
l_int|1
)paren
id|tempcnt
op_decrement
suffix:semicolon
id|pDCB-&gt;MaxCommand
op_assign
id|tempcnt
suffix:semicolon
id|DC395x_freetag
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_Going_to_Waiting
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_waiting_timer
c_func
(paren
id|pACB
comma
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_eq
id|SCSI_STAT_SEL_TIMEOUT
)paren
(brace
id|pSRB-&gt;AdaptStatus
op_assign
id|H_SEL_TIMEOUT
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|pcmd-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
id|SET_RES_MSG
c_func
(paren
id|pcmd-&gt;result
comma
id|pSRB-&gt;EndMessage
)paren
suffix:semicolon
id|SET_RES_TARGET
c_func
(paren
id|pcmd-&gt;result
comma
id|status
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; ** process initiator status..........................&n;&t;&t; */
id|status
op_assign
id|pSRB-&gt;AdaptStatus
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|H_OVER_UNDER_RUN
)paren
(brace
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_OK
)paren
suffix:semicolon
id|SET_RES_MSG
c_func
(paren
id|pcmd-&gt;result
comma
id|pSRB-&gt;EndMessage
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pSRB-&gt;SRBStatus
op_amp
id|PARITY_ERROR
)paren
(brace
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_PARITY
)paren
suffix:semicolon
id|SET_RES_MSG
c_func
(paren
id|pcmd-&gt;result
comma
id|pSRB-&gt;EndMessage
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No error */
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
id|SET_RES_DID
c_func
(paren
id|pcmd-&gt;result
comma
id|DID_OK
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dir
op_ne
id|PCI_DMA_NONE
)paren
(brace
r_if
c_cond
(paren
id|pcmd-&gt;use_sg
)paren
id|pci_dma_sync_sg
c_func
(paren
id|pACB-&gt;pdev
comma
(paren
r_struct
id|scatterlist
op_star
)paren
id|pcmd
op_member_access_from_pointer
id|request_buffer
comma
id|pcmd-&gt;use_sg
comma
id|dir
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pcmd-&gt;request_buffer
)paren
id|pci_dma_sync_single
c_func
(paren
id|pACB-&gt;pdev
comma
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
comma
id|pcmd-&gt;request_bufflen
comma
id|dir
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pcmd-&gt;result
op_amp
id|RES_DID
)paren
op_eq
l_int|0
op_logical_and
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
id|pcmd-&gt;cmnd
(braket
l_int|2
)braket
op_eq
l_int|0
op_logical_and
id|pcmd-&gt;request_bufflen
op_ge
l_int|8
op_logical_and
id|dir
op_ne
id|PCI_DMA_NONE
op_logical_and
id|ptr
op_logical_and
(paren
id|ptr-&gt;Vers
op_amp
l_int|0x07
)paren
op_ge
l_int|2
)paren
id|pDCB-&gt;Inquiry7
op_assign
id|ptr-&gt;Flags
suffix:semicolon
multiline_comment|/* Check Error Conditions */
id|ckc_e
suffix:colon
multiline_comment|/*if( pSRB-&gt;pcmd-&gt;cmnd[0] == INQUIRY &amp;&amp; */
multiline_comment|/*  (host_byte(pcmd-&gt;result) == DID_OK || status_byte(pcmd-&gt;result) &amp; CHECK_CONDITION) ) */
r_if
c_cond
(paren
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
op_logical_and
(paren
id|pcmd-&gt;result
op_eq
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_logical_or
id|status_byte
c_func
(paren
id|pcmd
op_member_access_from_pointer
id|result
)paren
op_amp
id|CHECK_CONDITION
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pDCB-&gt;init_TCQ_flag
)paren
(brace
id|DC395x_add_dev
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|ptr
)paren
suffix:semicolon
id|pDCB-&gt;init_TCQ_flag
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Here is the info for Doug Gilbert&squot;s sg3 ... */
id|pcmd-&gt;resid
op_assign
id|pSRB-&gt;SRBTotalXferLength
suffix:semicolon
multiline_comment|/* This may be interpreted by sb. or not ... */
id|pcmd-&gt;SCp.this_residual
op_assign
id|pSRB-&gt;SRBTotalXferLength
suffix:semicolon
id|pcmd-&gt;SCp.buffers_residual
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG_KG
r_if
c_cond
(paren
id|pSRB-&gt;SRBTotalXferLength
)paren
id|printk
(paren
l_string|&quot;&bslash;nDC395x:  pid %li: %02x (%02i-%i): Missed %i bytes&bslash;n&quot;
comma
id|pcmd-&gt;pid
comma
id|pcmd-&gt;cmnd
(braket
l_int|0
)braket
comma
id|pcmd-&gt;device-&gt;id
comma
id|pcmd-&gt;device-&gt;lun
comma
id|pSRB-&gt;SRBTotalXferLength
)paren
suffix:semicolon
macro_line|#endif
id|DC395x_Going_remove
c_func
(paren
id|pDCB
comma
id|pSRB
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Add to free list */
r_if
c_cond
(paren
id|pSRB
op_eq
id|pACB-&gt;pTmpSRB
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;nDC395x:  ERROR! Completed Cmnd with TmpSRB!&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|DC395x_Free_insert
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|DEBUG0
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
id|DC395X_NAME
l_string|&quot;:  SRBdone: done pid %li&bslash;n&quot;
comma
id|pcmd-&gt;pid
)paren
suffix:semicolon
)paren
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
l_string|&quot; 0x%08x&bslash;n&quot;
comma
id|pcmd-&gt;result
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;%08x(%li)*&quot;
comma
id|pcmd-&gt;result
comma
id|jiffies
)paren
suffix:semicolon
id|DC395x_pci_unmap
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
multiline_comment|/*DC395x_UNLOCK_ACB_NI; */
id|pcmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|pcmd
)paren
suffix:semicolon
multiline_comment|/*DC395x_LOCK_ACB_NI; */
id|TRACEOUTALL
c_func
(paren
id|KERN_INFO
l_string|&quot; %s&bslash;n&quot;
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
id|DC395x_Query_to_Waiting
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|DC395x_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;&t;DC395x_reset&n; * abort all cmds in our queues&n; ********************************************************************&n; */
r_void
DECL|function|DC395x_DoingSRB_Done
id|DC395x_DoingSRB_Done
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
id|u8
id|did_flag
comma
id|Scsi_Cmnd
op_star
id|cmd
comma
id|u8
id|force
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|pSRB
suffix:semicolon
r_struct
id|ScsiReqBlk
op_star
id|pSRBTemp
suffix:semicolon
id|u16
id|cnt
suffix:semicolon
id|Scsi_Cmnd
op_star
id|pcmd
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_DoingSRB_Done: pids &quot;
)paren
suffix:semicolon
r_do
(brace
multiline_comment|/* As the ML may queue cmnds again, cache old values */
r_struct
id|ScsiReqBlk
op_star
id|pWaitingSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
multiline_comment|/*struct ScsiReqBlk* pWaitLast = pDCB-&gt;pWaitLast; */
id|u16
id|WaitSRBCnt
op_assign
id|pDCB-&gt;WaitSRBCnt
suffix:semicolon
multiline_comment|/* Going queue */
id|cnt
op_assign
id|pDCB-&gt;GoingSRBCnt
suffix:semicolon
id|pSRB
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_decrement
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|dir
suffix:semicolon
id|pSRBTemp
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
id|dir
op_assign
id|scsi_to_pci_dma_dir
c_func
(paren
id|pcmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|result
op_assign
id|MK_RES
c_func
(paren
l_int|0
comma
id|did_flag
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*result = MK_RES(0,DID_RESET,0,0); */
id|TRACEPRINTF
c_func
(paren
l_string|&quot;Reset(%li):%08x*&quot;
comma
id|jiffies
comma
id|result
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; (G)&quot;
)paren
suffix:semicolon
macro_line|#if 1&t;&t;&t;&t;/*ndef DC395x_DEBUGTRACE */
id|printk
c_func
(paren
l_string|&quot;%li(%02i-%i) &quot;
comma
id|pcmd-&gt;pid
comma
id|pcmd-&gt;device-&gt;id
comma
id|pcmd-&gt;device-&gt;lun
)paren
suffix:semicolon
macro_line|#endif
id|TRACEOUT
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
id|pDCB-&gt;pGoingSRB
op_assign
id|pSRBTemp
suffix:semicolon
id|pDCB-&gt;GoingSRBCnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRBTemp
)paren
id|pDCB-&gt;pGoingLast
op_assign
l_int|NULL
suffix:semicolon
id|DC395x_freetag
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_Free_insert
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|pcmd-&gt;result
op_assign
id|result
suffix:semicolon
id|DC395x_pci_unmap_sense
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_pci_unmap
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|force
)paren
(brace
multiline_comment|/* For new EH, we normally don&squot;t need to give commands back,&n;&t;&t;&t;&t; * as they all complete or all time out */
multiline_comment|/* do we need the aic7xxx hack and conditionally decrease retry ? */
multiline_comment|/*DC395x_SCSI_DONE_ACB_UNLOCK; */
id|pcmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|pcmd
)paren
suffix:semicolon
multiline_comment|/*DC395x_SCSI_DONE_ACB_LOCK; */
)brace
id|pSRB
op_assign
id|pSRBTemp
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pDCB-&gt;pGoingSRB
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: How could the ML send cmnds to the Going queue? (%02i-%i)!!&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;TagMask
)paren
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: TagMask for %02i-%i should be empty, is %08x!&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|pDCB-&gt;TagMask
)paren
suffix:semicolon
multiline_comment|/*pDCB-&gt;GoingSRBCnt = 0;; */
multiline_comment|/*pDCB-&gt;pGoingSRB = NULL; pDCB-&gt;pGoingLast = NULL; */
multiline_comment|/* Waiting queue */
id|cnt
op_assign
id|WaitSRBCnt
suffix:semicolon
id|pSRB
op_assign
id|pWaitingSRB
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_decrement
)paren
(brace
r_int
id|result
suffix:semicolon
id|pSRBTemp
op_assign
id|pSRB-&gt;pNextSRB
suffix:semicolon
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
id|result
op_assign
id|MK_RES
c_func
(paren
l_int|0
comma
id|did_flag
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;Reset(%li):%08x*&quot;
comma
id|jiffies
comma
id|result
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; (W)&quot;
)paren
suffix:semicolon
macro_line|#if 1&t;&t;&t;&t;/*ndef DC395x_DEBUGTRACE */
id|printk
c_func
(paren
l_string|&quot;%li(%i-%i)&quot;
comma
id|pcmd-&gt;pid
comma
id|pcmd-&gt;device-&gt;id
comma
id|pcmd-&gt;device-&gt;lun
)paren
suffix:semicolon
macro_line|#endif
id|TRACEOUT
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
id|pDCB-&gt;pWaitingSRB
op_assign
id|pSRBTemp
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSRBTemp
)paren
id|pDCB-&gt;pWaitLast
op_assign
l_int|NULL
suffix:semicolon
id|DC395x_Free_insert
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|pcmd-&gt;result
op_assign
id|result
suffix:semicolon
id|DC395x_pci_unmap_sense
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_pci_unmap
c_func
(paren
id|pACB
comma
id|pSRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|force
)paren
(brace
multiline_comment|/* For new EH, we normally don&squot;t need to give commands back,&n;&t;&t;&t;&t; * as they all complete or all time out */
multiline_comment|/* do we need the aic7xxx hack and conditionally decrease retry ? */
multiline_comment|/*DC395x_SCSI_DONE_ACB_UNLOCK; */
id|pcmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|pcmd
)paren
suffix:semicolon
multiline_comment|/*DC395x_SCSI_DONE_ACB_LOCK; */
id|pSRB
op_assign
id|pSRBTemp
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pDCB-&gt;WaitSRBCnt
)paren
id|printk
(paren
l_string|&quot;&bslash;nDC395x: Debug: ML queued %i cmnds again to %02i-%i&bslash;n&quot;
comma
id|pDCB-&gt;WaitSRBCnt
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
multiline_comment|/* The ML could have queued the cmnds again! */
multiline_comment|/*pDCB-&gt;WaitSRBCnt = 0;; */
multiline_comment|/*pDCB-&gt;pWaitingSRB = NULL; pDCB-&gt;pWaitLast = NULL; */
id|pDCB-&gt;DCBFlag
op_and_assign
op_complement
id|ABORT_DEV_
suffix:semicolon
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pDCB
op_ne
id|pACB-&gt;pLinkDCB
op_logical_and
id|pDCB
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;&t;DC395x_shutdown   DC395x_reset&n; ********************************************************************&n; */
DECL|function|DC395x_ResetSCSIBus
r_static
r_void
id|DC395x_ResetSCSIBus
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
multiline_comment|/*u32  drv_flags=0; */
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_ResetSCSIBus..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*DC395x_DRV_LOCK(drv_flags); */
id|pACB-&gt;ACBFlag
op_or_assign
id|RESET_DEV
suffix:semicolon
multiline_comment|/* RESET_DETECT, RESET_DONE, RESET_DEV */
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_RSTSCSI
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_INTSTATUS
)paren
op_amp
id|INT_SCSIRESET
)paren
)paren
suffix:semicolon
multiline_comment|/*DC395x_DRV_UNLOCK(drv_flags); */
r_return
suffix:semicolon
)brace
multiline_comment|/* Set basic config */
DECL|function|DC395x_basic_config
r_static
r_void
id|DC395x_basic_config
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
id|u8
id|bval
suffix:semicolon
id|u16
id|wval
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_TIMEOUT
comma
id|pACB-&gt;sel_timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;Config
op_amp
id|HCC_PARITY
)paren
id|bval
op_assign
id|PHASELATCH
op_or
id|INITIATOR
op_or
id|BLOCKRST
op_or
id|PARITYCHECK
suffix:semicolon
r_else
id|bval
op_assign
id|PHASELATCH
op_or
id|INITIATOR
op_or
id|BLOCKRST
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_CONFIG0
comma
id|bval
)paren
suffix:semicolon
multiline_comment|/* program configuration 1: Act_Neg (+ Act_Neg_Enh? + Fast_Filter? + DataDis?) */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_CONFIG1
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* was 0x13: default */
multiline_comment|/* program Host ID                  */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_HOSTID
comma
id|pACB-&gt;pScsiHost-&gt;this_id
)paren
suffix:semicolon
multiline_comment|/* set ansynchronous transfer       */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_OFFSET
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Turn LED control off */
id|wval
op_assign
id|DC395x_read16
c_func
(paren
id|TRM_S1040_GEN_CONTROL
)paren
op_amp
l_int|0x7F
suffix:semicolon
id|DC395x_write16
c_func
(paren
id|TRM_S1040_GEN_CONTROL
comma
id|wval
)paren
suffix:semicolon
multiline_comment|/* DMA config          */
id|wval
op_assign
id|DC395x_read16
c_func
(paren
id|TRM_S1040_DMA_CONFIG
)paren
op_amp
op_complement
id|DMA_FIFO_CTRL
suffix:semicolon
id|wval
op_or_assign
id|DMA_FIFO_HALF_HALF
op_or
id|DMA_ENHANCE
multiline_comment|/*| DMA_MEM_MULTI_READ */
suffix:semicolon
multiline_comment|/*printk (KERN_INFO DC395X_NAME &quot;DMA_Config: %04x&bslash;n&quot;, wval); */
id|DC395x_write16
c_func
(paren
id|TRM_S1040_DMA_CONFIG
comma
id|wval
)paren
suffix:semicolon
multiline_comment|/* Clear pending interrupt status */
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_INTSTATUS
)paren
suffix:semicolon
multiline_comment|/* Enable SCSI interrupt    */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_INTEN
comma
l_int|0x7F
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_INTEN
comma
id|EN_SCSIINTR
op_or
id|EN_DMAXFERERROR
multiline_comment|/*| EN_DMAXFERABORT | EN_DMAXFERCOMP | EN_FORCEDMACOMP */
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;&t;DC395x_Interrupt&n; ********************************************************************&n; */
DECL|function|DC395x_ScsiRstDetect
r_static
r_void
id|DC395x_ScsiRstDetect
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_ScsiRstDetect&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* delay half a second */
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_RSTMODULE
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_CONTROL
comma
id|DMARESETMODULE
)paren
suffix:semicolon
multiline_comment|/*DC395x_write8(TRM_S1040_DMA_CONTROL,STOPDMAXFER); */
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
multiline_comment|/* Maybe we locked up the bus? Then lets wait even longer ... */
id|pACB-&gt;pScsiHost-&gt;last_reset
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc395x_trm_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
dot
id|NvramDelayTime
suffix:semicolon
id|DC395x_clrfifo
c_func
(paren
id|pACB
comma
l_string|&quot;RstDet&quot;
)paren
suffix:semicolon
id|DC395x_basic_config
c_func
(paren
id|pACB
)paren
suffix:semicolon
multiline_comment|/*1.25 */
multiline_comment|/*DC395x_write16(TRM_S1040_SCSI_CONTROL, DO_HWRESELECT); */
r_if
c_cond
(paren
id|pACB-&gt;ACBFlag
op_amp
id|RESET_DEV
)paren
(brace
multiline_comment|/* RESET_DETECT, RESET_DONE, RESET_DEV */
id|pACB-&gt;ACBFlag
op_or_assign
id|RESET_DONE
suffix:semicolon
)brace
r_else
(brace
id|pACB-&gt;ACBFlag
op_or_assign
id|RESET_DETECT
suffix:semicolon
id|DC395x_ResetDevParam
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|DC395x_DoingSRB_Done
c_func
(paren
id|pACB
comma
id|DID_RESET
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*DC395x_RecoverSRB( pACB ); */
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
id|DC395x_Waiting_process
c_func
(paren
id|pACB
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;&t;DC395x_SRBdone&n; ********************************************************************&n; */
r_static
r_void
DECL|function|DC395x_RequestSense
id|DC395x_RequestSense
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
comma
r_struct
id|ScsiReqBlk
op_star
id|pSRB
)paren
(brace
id|Scsi_Cmnd
op_star
id|pcmd
suffix:semicolon
id|pcmd
op_assign
id|pSRB-&gt;pcmd
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_RequestSense for pid %li, target %02i-%i&bslash;n&quot;
comma
id|pcmd-&gt;pid
comma
id|pcmd-&gt;device-&gt;id
comma
id|pcmd-&gt;device-&gt;lun
)paren
suffix:semicolon
macro_line|#endif
id|TRACEPRINTF
c_func
(paren
l_string|&quot;RqSn*&quot;
)paren
suffix:semicolon
id|pSRB-&gt;SRBFlag
op_or_assign
id|AUTO_REQSENSE
suffix:semicolon
id|pSRB-&gt;AdaptStatus
op_assign
l_int|0
suffix:semicolon
id|pSRB-&gt;TargetStatus
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* KG: Can this prevent crap sense data ? */
id|memset
c_func
(paren
id|pcmd-&gt;sense_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|pcmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
multiline_comment|/* Save some data */
id|pSRB-&gt;SegmentX
(braket
id|DC395x_MAX_SG_LISTENTRY
op_minus
l_int|1
)braket
dot
id|address
op_assign
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
id|pSRB-&gt;SegmentX
(braket
id|DC395x_MAX_SG_LISTENTRY
op_minus
l_int|1
)braket
dot
id|length
op_assign
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
id|pSRB-&gt;Xferred
op_assign
id|pSRB-&gt;SRBTotalXferLength
suffix:semicolon
multiline_comment|/* pSRB-&gt;SegmentX : a one entry of S/G list table */
id|pSRB-&gt;SRBTotalXferLength
op_assign
r_sizeof
(paren
id|pcmd-&gt;sense_buffer
)paren
suffix:semicolon
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|length
op_assign
r_sizeof
(paren
id|pcmd-&gt;sense_buffer
)paren
suffix:semicolon
multiline_comment|/* Map sense buffer */
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
op_assign
id|pci_map_single
c_func
(paren
id|pACB-&gt;pdev
comma
id|pcmd-&gt;sense_buffer
comma
r_sizeof
(paren
id|pcmd-&gt;sense_buffer
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
macro_line|#ifdef DC395x_SGPARANOIA
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Map sense buffer at %p (%05x) to %08x&bslash;n&quot;
comma
id|pcmd-&gt;sense_buffer
comma
r_sizeof
(paren
id|pcmd-&gt;sense_buffer
)paren
comma
id|pSRB-&gt;SegmentX
(braket
l_int|0
)braket
dot
id|address
)paren
suffix:semicolon
macro_line|#endif
id|pSRB-&gt;SRBSGCount
op_assign
l_int|1
suffix:semicolon
id|pSRB-&gt;SRBSGIndex
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|DC395x_StartSCSI
c_func
(paren
id|pACB
comma
id|pDCB
comma
id|pSRB
)paren
)paren
(brace
multiline_comment|/* Should only happen, if sb. else grabs the bus */
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Request Sense failed for pid %li (%02i-%i)!&bslash;n&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|TRACEPRINTF
c_func
(paren
l_string|&quot;?*&quot;
)paren
suffix:semicolon
id|DC395x_Going_to_Waiting
c_func
(paren
id|pDCB
comma
id|pSRB
)paren
suffix:semicolon
id|DC395x_waiting_timer
c_func
(paren
id|pACB
comma
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
)brace
id|TRACEPRINTF
c_func
(paren
l_string|&quot;.*&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *********************************************************************&n; *&t;&t;DC395x_queue_command&n; *&n; * Function : void DC395x_initDCB&n; *  Purpose : initialize the internal structures for a given DCB&n; *   Inputs : cmd - pointer to this scsi cmd request block structure&n; *********************************************************************&n; */
r_void
DECL|function|DC395x_initDCB
id|DC395x_initDCB
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
op_star
id|ppDCB
comma
id|u8
id|target
comma
id|u8
id|lun
)paren
(brace
r_struct
id|NvRamType
op_star
id|eeprom
suffix:semicolon
id|u8
id|PeriodIndex
suffix:semicolon
id|u16
id|index
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCB2
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_initDCB..............&bslash;n &quot;
)paren
suffix:semicolon
macro_line|#endif
id|pDCB
op_assign
id|KMALLOC
c_func
(paren
r_sizeof
(paren
r_struct
id|DeviceCtlBlk
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
multiline_comment|/*pDCB = DC395x_findDCB (pACB, target, lun); */
op_star
id|ppDCB
op_assign
id|pDCB
suffix:semicolon
id|pDCB2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDCB
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;DCBCnt
op_eq
l_int|0
)paren
(brace
id|pACB-&gt;pLinkDCB
op_assign
id|pDCB
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
id|pDCB
suffix:semicolon
)brace
r_else
(brace
id|pACB-&gt;pLastDCB-&gt;pNextDCB
op_assign
id|pDCB
suffix:semicolon
)brace
id|pACB-&gt;DCBCnt
op_increment
suffix:semicolon
id|pDCB-&gt;pNextDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|pACB-&gt;pLastDCB
op_assign
id|pDCB
suffix:semicolon
multiline_comment|/* $$$$$$$ */
id|pDCB-&gt;pDCBACB
op_assign
id|pACB
suffix:semicolon
id|pDCB-&gt;TargetID
op_assign
id|target
suffix:semicolon
id|pDCB-&gt;TargetLUN
op_assign
id|lun
suffix:semicolon
multiline_comment|/* $$$$$$$ */
id|pDCB-&gt;pWaitingSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;pGoingSRB
op_assign
l_int|NULL
suffix:semicolon
id|pDCB-&gt;GoingSRBCnt
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;WaitSRBCnt
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;pActiveSRB
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* $$$$$$$ */
id|pDCB-&gt;TagMask
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;DCBFlag
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;MaxCommand
op_assign
l_int|1
suffix:semicolon
id|pDCB-&gt;AdaptIndex
op_assign
id|pACB-&gt;AdapterIndex
suffix:semicolon
multiline_comment|/* $$$$$$$ */
id|index
op_assign
id|pACB-&gt;AdapterIndex
suffix:semicolon
id|eeprom
op_assign
op_amp
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
suffix:semicolon
id|pDCB-&gt;DevMode
op_assign
id|eeprom-&gt;NvramTarget
(braket
id|target
)braket
dot
id|NvmTarCfg0
suffix:semicolon
multiline_comment|/*pDCB-&gt;AdpMode = eeprom-&gt;NvramChannelCfg; */
id|pDCB-&gt;Inquiry7
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncMode
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;last_derated
op_assign
id|pACB-&gt;pScsiHost-&gt;last_reset
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* $$$$$$$ */
id|pDCB-&gt;SyncPeriod
op_assign
l_int|0
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
id|PeriodIndex
op_assign
id|eeprom-&gt;NvramTarget
(braket
id|target
)braket
dot
id|NvmTarPeriod
op_amp
l_int|0x07
suffix:semicolon
id|pDCB-&gt;MinNegoPeriod
op_assign
id|dc395x_clock_period
(braket
id|PeriodIndex
)braket
suffix:semicolon
macro_line|#ifndef DC395x_NO_WIDE
r_if
c_cond
(paren
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_WIDE_NEGO
)paren
op_logical_and
(paren
id|pACB-&gt;Config
op_amp
id|HCC_WIDE_CARD
)paren
)paren
id|pDCB-&gt;SyncMode
op_or_assign
id|WIDE_NEGO_ENABLE
suffix:semicolon
macro_line|#endif
macro_line|#ifndef DC395x_NO_SYNC
r_if
c_cond
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_SYNC_NEGO
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|lun
)paren
op_logical_or
id|DC395x_CurrSyncOffset
)paren
id|pDCB-&gt;SyncMode
op_or_assign
id|SYNC_NEGO_ENABLE
suffix:semicolon
macro_line|#endif
multiline_comment|/* $$$$$$$ */
macro_line|#ifndef DC395x_NO_DISCONNECT
id|pDCB-&gt;IdentifyMsg
op_assign
id|IDENTIFY
c_func
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_DISCONNECT
comma
id|lun
)paren
suffix:semicolon
macro_line|#else
id|pDCB-&gt;IdentifyMsg
op_assign
id|IDENTIFY
c_func
(paren
l_int|0
comma
id|lun
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* $$$$$$$ */
r_if
c_cond
(paren
id|pDCB-&gt;TargetLUN
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Copy settings */
r_struct
id|DeviceCtlBlk
op_star
id|prevDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_while
c_loop
(paren
id|prevDCB-&gt;TargetID
op_ne
id|pDCB-&gt;TargetID
)paren
id|prevDCB
op_assign
id|prevDCB-&gt;pNextDCB
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG_KG
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Copy settings from %02i-%02i to %02i-%02i&bslash;n&quot;
comma
id|prevDCB-&gt;TargetID
comma
id|prevDCB-&gt;TargetLUN
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
macro_line|#endif
id|pDCB-&gt;SyncMode
op_assign
id|prevDCB-&gt;SyncMode
suffix:semicolon
id|pDCB-&gt;SyncPeriod
op_assign
id|prevDCB-&gt;SyncPeriod
suffix:semicolon
id|pDCB-&gt;MinNegoPeriod
op_assign
id|prevDCB-&gt;MinNegoPeriod
suffix:semicolon
id|pDCB-&gt;SyncOffset
op_assign
id|prevDCB-&gt;SyncOffset
suffix:semicolon
id|pDCB-&gt;Inquiry7
op_assign
id|prevDCB-&gt;Inquiry7
suffix:semicolon
)brace
suffix:semicolon
id|pACB-&gt;DCBmap
(braket
id|target
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|lun
)paren
suffix:semicolon
id|pACB-&gt;children
(braket
id|target
)braket
(braket
id|lun
)braket
op_assign
id|pDCB
suffix:semicolon
)brace
multiline_comment|/* Dynamically allocated memory handling */
macro_line|#ifdef DC395x_DEBUGTRACE
multiline_comment|/* Memory for trace buffers */
DECL|function|DC395x_free_tracebufs
r_void
id|DC395x_free_tracebufs
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_int
id|SRBIdx
)paren
(brace
r_int
id|srbidx
suffix:semicolon
r_const
r_int
id|bufs_per_page
op_assign
id|PAGE_SIZE
op_div
id|DEBUGTRACEBUFSZ
suffix:semicolon
r_for
c_loop
(paren
id|srbidx
op_assign
l_int|0
suffix:semicolon
id|srbidx
OL
id|SRBIdx
suffix:semicolon
id|srbidx
op_add_assign
id|bufs_per_page
)paren
(brace
multiline_comment|/*printk (DC395X_NAME &quot;: Free tracebuf %p (for %i)&bslash;n&quot;, */
multiline_comment|/*      pACB-&gt;SRB_array[srbidx].debugtrace, srbidx); */
id|KFREE
c_func
(paren
id|pACB-&gt;SRB_array
(braket
id|srbidx
)braket
dot
id|debugtrace
)paren
suffix:semicolon
)brace
)brace
DECL|function|DC395x_alloc_tracebufs
r_int
id|DC395x_alloc_tracebufs
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
r_const
r_int
id|mem_needed
op_assign
(paren
id|DC395x_MAX_SRB_CNT
op_plus
l_int|1
)paren
op_star
id|DEBUGTRACEBUFSZ
suffix:semicolon
r_int
id|pages
op_assign
(paren
id|mem_needed
op_plus
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_div
id|PAGE_SIZE
suffix:semicolon
r_const
r_int
id|bufs_per_page
op_assign
id|PAGE_SIZE
op_div
id|DEBUGTRACEBUFSZ
suffix:semicolon
r_int
id|SRBIdx
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|ptr
suffix:semicolon
multiline_comment|/*printk (DC395X_NAME &quot;: Alloc %i pages for tracebufs&bslash;n&quot;, pages); */
r_while
c_loop
(paren
id|pages
op_decrement
)paren
(brace
id|ptr
op_assign
id|KMALLOC
c_func
(paren
id|PAGE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
(brace
id|DC395x_free_tracebufs
c_func
(paren
id|pACB
comma
id|SRBIdx
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*printk (DC395X_NAME &quot;: Alloc %li bytes at %p for tracebuf %i&bslash;n&quot;, */
multiline_comment|/*      PAGE_SIZE, ptr, SRBIdx); */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|bufs_per_page
op_logical_and
id|SRBIdx
OL
id|DC395x_MAX_SRB_CNT
)paren
id|pACB-&gt;SRB_array
(braket
id|SRBIdx
op_increment
)braket
dot
id|debugtrace
op_assign
id|ptr
op_plus
(paren
id|i
op_increment
op_star
id|DEBUGTRACEBUFSZ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|bufs_per_page
)paren
(brace
id|pACB-&gt;TmpSRB.debugtrace
op_assign
id|ptr
op_plus
(paren
id|i
op_star
id|DEBUGTRACEBUFSZ
)paren
suffix:semicolon
id|pACB-&gt;TmpSRB.debugtrace
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: No space for tmpSRB tracebuf reserved?!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Free SG tables */
DECL|function|DC395x_free_SG_tables
r_void
id|DC395x_free_SG_tables
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_int
id|SRBIdx
)paren
(brace
r_int
id|srbidx
suffix:semicolon
r_const
r_int
id|SRBs_per_page
op_assign
id|PAGE_SIZE
op_div
(paren
id|DC395x_MAX_SG_LISTENTRY
op_star
r_sizeof
(paren
r_struct
id|SGentry
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|srbidx
op_assign
l_int|0
suffix:semicolon
id|srbidx
OL
id|SRBIdx
suffix:semicolon
id|srbidx
op_add_assign
id|SRBs_per_page
)paren
(brace
multiline_comment|/*printk (DC395X_NAME &quot;: Free SG segs %p (for %i)&bslash;n&quot;, */
multiline_comment|/*      pACB-&gt;SRB_array[srbidx].SegmentX, srbidx); */
id|KFREE
c_func
(paren
id|pACB-&gt;SRB_array
(braket
id|srbidx
)braket
dot
id|SegmentX
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Allocate SG tables; as we have to pci_map them, an SG list (struct SGentry*)&n; * should never cross a page boundary */
DECL|function|DC395x_alloc_SG_tables
r_int
id|DC395x_alloc_SG_tables
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
r_const
r_int
id|mem_needed
op_assign
(paren
id|DC395x_MAX_SRB_CNT
op_plus
l_int|1
)paren
op_star
id|DC395x_MAX_SG_LISTENTRY
op_star
r_sizeof
(paren
r_struct
id|SGentry
)paren
suffix:semicolon
r_int
id|pages
op_assign
(paren
id|mem_needed
op_plus
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_div
id|PAGE_SIZE
suffix:semicolon
r_const
r_int
id|SRBs_per_page
op_assign
id|PAGE_SIZE
op_div
(paren
id|DC395x_MAX_SG_LISTENTRY
op_star
r_sizeof
(paren
r_struct
id|SGentry
)paren
)paren
suffix:semicolon
r_int
id|SRBIdx
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_struct
id|SGentry
op_star
id|ptr
suffix:semicolon
multiline_comment|/*printk (DC395X_NAME &quot;: Alloc %i pages for SG tables&bslash;n&quot;, pages); */
r_while
c_loop
(paren
id|pages
op_decrement
)paren
(brace
id|ptr
op_assign
(paren
r_struct
id|SGentry
op_star
)paren
id|KMALLOC
c_func
(paren
id|PAGE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
(brace
id|DC395x_free_SG_tables
c_func
(paren
id|pACB
comma
id|SRBIdx
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*printk (DC395X_NAME &quot;: Alloc %li bytes at %p for SG segments %i&bslash;n&quot;, */
multiline_comment|/*      PAGE_SIZE, ptr, SRBIdx); */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|SRBs_per_page
op_logical_and
id|SRBIdx
OL
id|DC395x_MAX_SRB_CNT
)paren
id|pACB-&gt;SRB_array
(braket
id|SRBIdx
op_increment
)braket
dot
id|SegmentX
op_assign
id|ptr
op_plus
(paren
id|i
op_increment
op_star
id|DC395x_MAX_SG_LISTENTRY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|SRBs_per_page
)paren
id|pACB-&gt;TmpSRB.SegmentX
op_assign
id|ptr
op_plus
(paren
id|i
op_star
id|DC395x_MAX_SG_LISTENTRY
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: No space for tmpSRB SG table reserved?!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; ********************************************************************&n; * scsiio&n; *&t;&t;DC395x_initACB&n; ********************************************************************&n; */
DECL|function|DC395x_linkSRB
r_void
id|__init
id|DC395x_linkSRB
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pACB-&gt;SRBCount
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|pACB-&gt;SRB_array
(braket
id|i
)braket
dot
id|pNextSRB
op_assign
op_amp
id|pACB-&gt;SRB_array
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|pACB-&gt;SRB_array
(braket
id|i
)braket
dot
id|pNextSRB
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*DC395x_Free_integrity (pACB);     */
)brace
multiline_comment|/*&n; ***********************************************************************&n; *&t;&t;DC395x_init&n; *&n; * Function : static void DC395x_initACB&n; *  Purpose :  initialize the internal structures for a given SCSI host&n; *   Inputs : host - pointer to this host adapter&squot;s structure&n; ***********************************************************************&n; */
r_int
id|__init
DECL|function|DC395x_initACB
id|DC395x_initACB
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|u32
id|io_port
comma
id|u8
id|irq
comma
id|u16
id|index
)paren
(brace
r_struct
id|NvRamType
op_star
id|eeprom
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|pACB
suffix:semicolon
id|u16
id|i
suffix:semicolon
id|eeprom
op_assign
op_amp
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
suffix:semicolon
id|host-&gt;max_cmd_len
op_assign
l_int|24
suffix:semicolon
id|host-&gt;can_queue
op_assign
id|DC395x_MAX_CMD_QUEUE
suffix:semicolon
id|host-&gt;cmd_per_lun
op_assign
id|DC395x_MAX_CMD_PER_LUN
suffix:semicolon
id|host-&gt;this_id
op_assign
(paren
r_int
)paren
id|eeprom-&gt;NvramScsiId
suffix:semicolon
id|host-&gt;io_port
op_assign
id|io_port
suffix:semicolon
id|host-&gt;n_io_port
op_assign
l_int|0x80
suffix:semicolon
id|host-&gt;dma_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|host-&gt;unique_id
op_assign
id|io_port
suffix:semicolon
id|host-&gt;irq
op_assign
id|irq
suffix:semicolon
id|host-&gt;last_reset
op_assign
id|jiffies
suffix:semicolon
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|host-&gt;max_id
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;max_id
op_minus
l_int|1
op_eq
id|eeprom-&gt;NvramScsiId
)paren
id|host-&gt;max_id
op_decrement
suffix:semicolon
macro_line|#ifdef&t;CONFIG_SCSI_MULTI_LUN
r_if
c_cond
(paren
id|eeprom-&gt;NvramChannelCfg
op_amp
id|NAC_SCANLUN
)paren
id|host-&gt;max_lun
op_assign
l_int|8
suffix:semicolon
r_else
id|host-&gt;max_lun
op_assign
l_int|1
suffix:semicolon
macro_line|#else
id|host-&gt;max_lun
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; ********************************&n;&t; */
id|pACB-&gt;pScsiHost
op_assign
id|host
suffix:semicolon
id|pACB-&gt;IOPortBase
op_assign
(paren
id|u16
)paren
id|io_port
suffix:semicolon
id|pACB-&gt;pLinkDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pDCBRunRobin
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;pActiveDCB
op_assign
l_int|NULL
suffix:semicolon
id|pACB-&gt;SRBCount
op_assign
id|DC395x_MAX_SRB_CNT
suffix:semicolon
id|pACB-&gt;AdapterIndex
op_assign
id|index
suffix:semicolon
id|pACB-&gt;status
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;pScsiHost-&gt;this_id
op_assign
id|eeprom-&gt;NvramScsiId
suffix:semicolon
id|pACB-&gt;HostID_Bit
op_assign
(paren
l_int|1
op_lshift
id|pACB-&gt;pScsiHost-&gt;this_id
)paren
suffix:semicolon
multiline_comment|/*pACB-&gt;pScsiHost-&gt;this_lun = 0; */
id|pACB-&gt;DCBCnt
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;DeviceCnt
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;IRQLevel
op_assign
id|irq
suffix:semicolon
id|pACB-&gt;TagMaxNum
op_assign
l_int|1
op_lshift
id|eeprom-&gt;NvramMaxTag
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;TagMaxNum
OG
l_int|30
)paren
id|pACB-&gt;TagMaxNum
op_assign
l_int|30
suffix:semicolon
id|pACB-&gt;ACBFlag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* RESET_DETECT, RESET_DONE, RESET_DEV */
id|pACB-&gt;scan_devices
op_assign
l_int|1
suffix:semicolon
id|pACB-&gt;MsgLen
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;Gmode2
op_assign
id|eeprom-&gt;NvramChannelCfg
suffix:semicolon
r_if
c_cond
(paren
id|eeprom-&gt;NvramChannelCfg
op_amp
id|NAC_SCANLUN
)paren
id|pACB-&gt;LUNchk
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* &n;&t; * link all device&squot;s SRB Q of this adapter &n;&t; */
r_if
c_cond
(paren
id|DC395x_alloc_SG_tables
c_func
(paren
id|pACB
)paren
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: SG table allocation failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef DC395x_DEBUGTRACE
r_if
c_cond
(paren
id|DC395x_alloc_tracebufs
c_func
(paren
id|pACB
)paren
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: SG trace buffer allocation failed!&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_free_SG_tables
c_func
(paren
id|pACB
comma
id|DC395x_MAX_SRB_CNT
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
id|DC395x_linkSRB
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|pACB-&gt;pFreeSRB
op_assign
id|pACB-&gt;SRB_array
suffix:semicolon
multiline_comment|/* &n;&t; * temp SRB for Q tag used or abort command used &n;&t; */
id|pACB-&gt;pTmpSRB
op_assign
op_amp
id|pACB-&gt;TmpSRB
suffix:semicolon
id|pACB-&gt;TmpSRB.pSRBDCB
op_assign
l_int|0
suffix:semicolon
id|pACB-&gt;TmpSRB.pNextSRB
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DC395x_MAX_SCSI_ID
suffix:semicolon
id|i
op_increment
)paren
id|pACB-&gt;DCBmap
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: pACB = %p, pDCBmap = %p, pSRB_array = %p&bslash;n&quot;
comma
id|pACB
comma
id|pACB-&gt;DCBmap
comma
id|pACB-&gt;SRB_array
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: ACB size= %04lx, DCB size= %04lx, SRB size= %04lx&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|AdapterCtlBlk
)paren
comma
r_sizeof
(paren
r_struct
id|DeviceCtlBlk
)paren
comma
r_sizeof
(paren
r_struct
id|ScsiReqBlk
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*===========================================================================&n;                                Init&n;  ===========================================================================*/
multiline_comment|/*&n; * Intialise the SCSI chip control registers&n; *&n; * @param host     This hosts adapter strcuture&n; * @param io_port  The base I/O port&n; * @param irq      IRQ&n; * @param index    Card number?? (for multiple cards?)&n; */
r_static
r_int
id|__init
DECL|function|DC395x_initAdapter
id|DC395x_initAdapter
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
comma
id|u32
id|io_port
comma
id|u8
id|irq
comma
id|u16
id|index
)paren
(brace
r_struct
id|NvRamType
op_star
id|eeprom
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|pACB
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|pTempACB
suffix:semicolon
id|u16
id|used_irq
op_assign
l_int|0
suffix:semicolon
id|eeprom
op_assign
op_amp
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
suffix:semicolon
id|pTempACB
op_assign
id|DC395x_pACB_start
suffix:semicolon
r_if
c_cond
(paren
id|pTempACB
op_ne
l_int|NULL
)paren
(brace
r_while
c_loop
(paren
id|pTempACB
)paren
(brace
r_if
c_cond
(paren
id|pTempACB-&gt;IRQLevel
op_eq
id|irq
)paren
(brace
id|used_irq
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|pTempACB
op_assign
id|pTempACB-&gt;pNextACB
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|io_port
comma
id|host-&gt;n_io_port
comma
id|DC395X_NAME
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DC395X_NAME
l_string|&quot;: Failed to reserve IO region 0x%x&bslash;n&quot;
comma
id|io_port
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|used_irq
)paren
(brace
r_if
c_cond
(paren
id|request_irq
(paren
id|irq
comma
id|DC395x_Interrupt
comma
id|SA_SHIRQ
comma
id|DC395X_NAME
comma
(paren
r_void
op_star
)paren
id|host-&gt;hostdata
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Failed to register IRQ!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|pACB-&gt;IOPortBase
op_assign
id|io_port
suffix:semicolon
multiline_comment|/* selection timeout = 250 ms */
id|pACB-&gt;sel_timeout
op_assign
id|DC395x_SEL_TIMEOUT
suffix:semicolon
multiline_comment|/* Mask all the interrupt */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_INTEN
comma
l_int|0x00
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_INTEN
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Reset SCSI module */
id|DC395x_write16
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_RSTMODULE
)paren
suffix:semicolon
multiline_comment|/* Reset PCI/DMA module */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_CONTROL
comma
id|DMARESETMODULE
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* program configuration 0 */
id|pACB-&gt;Config
op_assign
id|HCC_AUTOTERM
op_or
id|HCC_PARITY
suffix:semicolon
r_if
c_cond
(paren
id|DC395x_read8
c_func
(paren
id|TRM_S1040_GEN_STATUS
)paren
op_amp
id|WIDESCSI
)paren
id|pACB-&gt;Config
op_or_assign
id|HCC_WIDE_CARD
suffix:semicolon
r_if
c_cond
(paren
id|eeprom-&gt;NvramChannelCfg
op_amp
id|NAC_POWERON_SCSI_RESET
)paren
id|pACB-&gt;Config
op_or_assign
id|HCC_SCSI_RESET
suffix:semicolon
r_if
c_cond
(paren
id|pACB-&gt;Config
op_amp
id|HCC_SCSI_RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Performing initial SCSI bus reset&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_CONTROL
comma
id|DO_RSTSCSI
)paren
suffix:semicolon
multiline_comment|/*while (!( DC395x_read8(TRM_S1040_SCSI_INTSTATUS) &amp; INT_SCSIRESET )); */
multiline_comment|/*spin_unlock_irq (&amp;io_request_lock); */
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|pACB-&gt;pScsiHost-&gt;last_reset
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
op_plus
id|HZ
op_star
id|dc395x_trm_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
dot
id|NvramDelayTime
suffix:semicolon
multiline_comment|/*spin_lock_irq (&amp;io_request_lock); */
)brace
id|DC395x_basic_config
c_func
(paren
id|pACB
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * eeprom - wait 30 us&n; *&n; * Waits for 30us (using the chip by the looks of it..)&n; *&n; * @param io_port  - base I/O address&n; */
DECL|function|TRM_S1040_wait_30us
r_static
r_void
id|__init
id|TRM_S1040_wait_30us
c_func
(paren
id|u16
id|io_port
)paren
(brace
multiline_comment|/* ScsiPortStallExecution(30); wait 30 us */
id|outb
c_func
(paren
l_int|5
comma
id|io_port
op_plus
id|TRM_S1040_GEN_TIMER
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_STATUS
)paren
op_amp
id|GTIMEOUT
)paren
)paren
multiline_comment|/* nothing */
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * eeprom - write command and address to chip&n; *&n; * Write the specified command and address &n; *&n; * @param io_port - base I/O address&n; * @param cmd     - SB + op code (command) to send&n; * @param addr    - address to send&n; */
DECL|function|TRM_S1040_write_cmd
r_static
r_void
id|__init
id|TRM_S1040_write_cmd
c_func
(paren
id|u16
id|io_port
comma
id|u8
id|cmd
comma
id|u8
id|addr
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
id|send_data
suffix:semicolon
multiline_comment|/* program SB + OP code */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
comma
id|cmd
op_lshift_assign
l_int|1
)paren
(brace
id|send_data
op_assign
id|NVR_SELECT
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_amp
l_int|0x04
)paren
multiline_comment|/* Start from bit 2 */
id|send_data
op_or_assign
id|NVR_BITOUT
suffix:semicolon
id|outb
c_func
(paren
id|send_data
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|send_data
op_or
id|NVR_CLOCK
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
)brace
multiline_comment|/* send address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
comma
id|addr
op_lshift_assign
l_int|1
)paren
(brace
id|send_data
op_assign
id|NVR_SELECT
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
l_int|0x40
)paren
multiline_comment|/* Start from bit 6 */
id|send_data
op_or_assign
id|NVR_BITOUT
suffix:semicolon
id|outb
c_func
(paren
id|send_data
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|send_data
op_or
id|NVR_CLOCK
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|NVR_SELECT
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * eeprom - store a single byte in the SEEPROM&n; *&n; * Called from write all to write a single byte into the SSEEPROM&n; * Which is done one bit at a time.&n; *&n; * @param io_port - base I/O address&n; * @param addr    - offset into EEPROM&n; * @param byte    - bytes to write&n; */
DECL|function|TRM_S1040_set_data
r_static
r_void
id|__init
id|TRM_S1040_set_data
c_func
(paren
id|u16
id|io_port
comma
id|u8
id|addr
comma
id|u8
id|byte
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
id|send_data
suffix:semicolon
multiline_comment|/* Send write command &amp; address */
id|TRM_S1040_write_cmd
c_func
(paren
id|io_port
comma
l_int|0x05
comma
id|addr
)paren
suffix:semicolon
multiline_comment|/* Write data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|byte
op_lshift_assign
l_int|1
)paren
(brace
id|send_data
op_assign
id|NVR_SELECT
suffix:semicolon
r_if
c_cond
(paren
id|byte
op_amp
l_int|0x80
)paren
multiline_comment|/* Start from bit 7 */
id|send_data
op_or_assign
id|NVR_BITOUT
suffix:semicolon
id|outb
c_func
(paren
id|send_data
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|send_data
op_or
id|NVR_CLOCK
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|NVR_SELECT
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
multiline_comment|/* Disable chip select */
id|outb
c_func
(paren
l_int|0
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NVR_SELECT
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
multiline_comment|/* Wait for write ready */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|outb
c_func
(paren
(paren
id|NVR_SELECT
op_or
id|NVR_CLOCK
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NVR_SELECT
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
op_amp
id|NVR_BITIN
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/*  Disable chip select */
id|outb
c_func
(paren
l_int|0
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * eeprom - write 128 bytes to the SEEPROM&n; *&n; * Write the supplied 128 bytes to the chips SEEPROM&n; *&n; * @param eeprom  - the data to write&n; * @param io_port - the base io port&n; */
r_static
r_void
id|__init
DECL|function|TRM_S1040_write_all
id|TRM_S1040_write_all
c_func
(paren
r_struct
id|NvRamType
op_star
id|eeprom
comma
id|u16
id|io_port
)paren
(brace
id|u8
op_star
id|b_eeprom
op_assign
(paren
id|u8
op_star
)paren
id|eeprom
suffix:semicolon
id|u8
id|addr
suffix:semicolon
multiline_comment|/* Enable SEEPROM */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
op_or
id|EN_EEPROM
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
suffix:semicolon
multiline_comment|/* write enable */
id|TRM_S1040_write_cmd
c_func
(paren
id|io_port
comma
l_int|0x04
comma
l_int|0xFF
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
multiline_comment|/* write */
r_for
c_loop
(paren
id|addr
op_assign
l_int|0
suffix:semicolon
id|addr
OL
l_int|128
suffix:semicolon
id|addr
op_increment
comma
id|b_eeprom
op_increment
)paren
(brace
id|TRM_S1040_set_data
c_func
(paren
id|io_port
comma
id|addr
comma
op_star
id|b_eeprom
)paren
suffix:semicolon
)brace
multiline_comment|/* write disable */
id|TRM_S1040_write_cmd
c_func
(paren
id|io_port
comma
l_int|0x04
comma
l_int|0x00
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
multiline_comment|/* Disable SEEPROM */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
op_amp
op_complement
id|EN_EEPROM
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * eeprom - get a single byte from the SEEPROM&n; *&n; * Called from read all to read a single byte into the SSEEPROM&n; * Which is done one bit at a time.&n; *&n; * @param io_port  - base I/O address&n; * @param addr     - offset into SEEPROM&n; * @return         - the byte read&n; */
DECL|function|TRM_S1040_get_data
r_static
id|u8
id|__init
id|TRM_S1040_get_data
c_func
(paren
id|u16
id|io_port
comma
id|u8
id|addr
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
id|read_byte
suffix:semicolon
id|u8
id|result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Send read command &amp; address */
id|TRM_S1040_write_cmd
c_func
(paren
id|io_port
comma
l_int|0x06
comma
id|addr
)paren
suffix:semicolon
multiline_comment|/* read data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
(paren
id|NVR_SELECT
op_or
id|NVR_CLOCK
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NVR_SELECT
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
multiline_comment|/* Get data bit while falling edge */
id|read_byte
op_assign
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
id|result
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|read_byte
op_amp
id|NVR_BITIN
)paren
id|result
op_or_assign
l_int|1
suffix:semicolon
id|TRM_S1040_wait_30us
c_func
(paren
id|io_port
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable chip select */
id|outb
c_func
(paren
l_int|0
comma
id|io_port
op_plus
id|TRM_S1040_GEN_NVRAM
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * eeprom - read_all&n; *&n; * Read the 128 bytes from the SEEPROM.&n; *&n; * @param eeprom - where to store the data&n; * @param io_port - the base io port&n; */
r_static
r_void
id|__init
DECL|function|TRM_S1040_read_all
id|TRM_S1040_read_all
c_func
(paren
r_struct
id|NvRamType
op_star
id|eeprom
comma
id|u16
id|io_port
)paren
(brace
id|u8
op_star
id|b_eeprom
op_assign
(paren
id|u8
op_star
)paren
id|eeprom
suffix:semicolon
id|u8
id|addr
suffix:semicolon
multiline_comment|/* Enable SEEPROM */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
op_or
id|EN_EEPROM
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
suffix:semicolon
multiline_comment|/* read details */
r_for
c_loop
(paren
id|addr
op_assign
l_int|0
suffix:semicolon
id|addr
OL
l_int|128
suffix:semicolon
id|addr
op_increment
comma
id|b_eeprom
op_increment
)paren
(brace
op_star
id|b_eeprom
op_assign
id|TRM_S1040_get_data
c_func
(paren
id|io_port
comma
id|addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable SEEPROM */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
op_amp
op_complement
id|EN_EEPROM
)paren
comma
id|io_port
op_plus
id|TRM_S1040_GEN_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * eeprom - get and check contents&n; *&n; * Read seeprom 128 bytes into the memory provider in eeprom.&n; * Checks the checksum and if it&squot;s not correct it uses a set of default&n; * values.&n; *&n; * @param eeprom  - caller allocated strcuture to read the eeprom data into&n; * @param io_port - io port to read from&n; */
r_static
r_void
id|__init
DECL|function|DC395x_check_eeprom
id|DC395x_check_eeprom
c_func
(paren
r_struct
id|NvRamType
op_star
id|eeprom
comma
id|u16
id|io_port
)paren
(brace
id|u16
op_star
id|w_eeprom
op_assign
(paren
id|u16
op_star
)paren
id|eeprom
suffix:semicolon
id|u16
id|w_addr
suffix:semicolon
id|u16
id|cksum
suffix:semicolon
id|u32
id|d_addr
suffix:semicolon
id|u32
op_star
id|d_eeprom
suffix:semicolon
id|TRM_S1040_read_all
c_func
(paren
id|eeprom
comma
id|io_port
)paren
suffix:semicolon
multiline_comment|/* read eeprom */
id|cksum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|w_addr
op_assign
l_int|0
comma
id|w_eeprom
op_assign
(paren
id|u16
op_star
)paren
id|eeprom
suffix:semicolon
id|w_addr
OL
l_int|64
suffix:semicolon
id|w_addr
op_increment
comma
id|w_eeprom
op_increment
)paren
id|cksum
op_add_assign
op_star
id|w_eeprom
suffix:semicolon
r_if
c_cond
(paren
id|cksum
op_ne
l_int|0x1234
)paren
(brace
multiline_comment|/*&n;&t;&t; * Checksum is wrong. &n;&t;&t; * Load a set of defaults into the eeprom buffer&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
id|DC395X_NAME
l_string|&quot;: EEProm checksum error: using default values and options.&bslash;n&quot;
)paren
suffix:semicolon
id|eeprom-&gt;NvramSubVendorID
(braket
l_int|0
)braket
op_assign
(paren
id|u8
)paren
id|PCI_VENDOR_ID_TEKRAM
suffix:semicolon
id|eeprom-&gt;NvramSubVendorID
(braket
l_int|1
)braket
op_assign
(paren
id|u8
)paren
(paren
id|PCI_VENDOR_ID_TEKRAM
op_rshift
l_int|8
)paren
suffix:semicolon
id|eeprom-&gt;NvramSubSysID
(braket
l_int|0
)braket
op_assign
(paren
id|u8
)paren
id|PCI_DEVICE_ID_TEKRAM_TRMS1040
suffix:semicolon
id|eeprom-&gt;NvramSubSysID
(braket
l_int|1
)braket
op_assign
(paren
id|u8
)paren
(paren
id|PCI_DEVICE_ID_TEKRAM_TRMS1040
op_rshift
l_int|8
)paren
suffix:semicolon
id|eeprom-&gt;NvramSubClass
op_assign
l_int|0x00
suffix:semicolon
id|eeprom-&gt;NvramVendorID
(braket
l_int|0
)braket
op_assign
(paren
id|u8
)paren
id|PCI_VENDOR_ID_TEKRAM
suffix:semicolon
id|eeprom-&gt;NvramVendorID
(braket
l_int|1
)braket
op_assign
(paren
id|u8
)paren
(paren
id|PCI_VENDOR_ID_TEKRAM
op_rshift
l_int|8
)paren
suffix:semicolon
id|eeprom-&gt;NvramDeviceID
(braket
l_int|0
)braket
op_assign
(paren
id|u8
)paren
id|PCI_DEVICE_ID_TEKRAM_TRMS1040
suffix:semicolon
id|eeprom-&gt;NvramDeviceID
(braket
l_int|1
)braket
op_assign
(paren
id|u8
)paren
(paren
id|PCI_DEVICE_ID_TEKRAM_TRMS1040
op_rshift
l_int|8
)paren
suffix:semicolon
id|eeprom-&gt;NvramReserved
op_assign
l_int|0x00
suffix:semicolon
r_for
c_loop
(paren
id|d_addr
op_assign
l_int|0
comma
id|d_eeprom
op_assign
(paren
id|u32
op_star
)paren
id|eeprom-&gt;NvramTarget
suffix:semicolon
id|d_addr
OL
l_int|16
suffix:semicolon
id|d_addr
op_increment
comma
id|d_eeprom
op_increment
)paren
op_star
id|d_eeprom
op_assign
l_int|0x00000077
suffix:semicolon
multiline_comment|/* NvmTarCfg3,NvmTarCfg2,NvmTarPeriod,NvmTarCfg0 */
op_star
id|d_eeprom
op_increment
op_assign
l_int|0x04000F07
suffix:semicolon
multiline_comment|/* NvramMaxTag,NvramDelayTime,NvramChannelCfg,NvramScsiId */
op_star
id|d_eeprom
op_increment
op_assign
l_int|0x00000015
suffix:semicolon
multiline_comment|/* NvramReserved1,NvramBootLun,NvramBootTarget,NvramReserved0 */
r_for
c_loop
(paren
id|d_addr
op_assign
l_int|0
suffix:semicolon
id|d_addr
OL
l_int|12
suffix:semicolon
id|d_addr
op_increment
comma
id|d_eeprom
op_increment
)paren
op_star
id|d_eeprom
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Now load defaults (maybe set by boot/module params) */
id|DC395x_check_for_safe_settings
c_func
(paren
)paren
suffix:semicolon
id|DC395x_fill_with_defaults
c_func
(paren
)paren
suffix:semicolon
id|DC395x_EEprom_Override
c_func
(paren
id|eeprom
)paren
suffix:semicolon
id|eeprom-&gt;NvramCheckSum
op_assign
l_int|0x00
suffix:semicolon
r_for
c_loop
(paren
id|w_addr
op_assign
l_int|0
comma
id|cksum
op_assign
l_int|0
comma
id|w_eeprom
op_assign
(paren
id|u16
op_star
)paren
id|eeprom
suffix:semicolon
id|w_addr
OL
l_int|63
suffix:semicolon
id|w_addr
op_increment
comma
id|w_eeprom
op_increment
)paren
id|cksum
op_add_assign
op_star
id|w_eeprom
suffix:semicolon
op_star
id|w_eeprom
op_assign
l_int|0x1234
op_minus
id|cksum
suffix:semicolon
id|TRM_S1040_write_all
c_func
(paren
id|eeprom
comma
id|io_port
)paren
suffix:semicolon
id|eeprom-&gt;NvramDelayTime
op_assign
id|dc395x_trm
(braket
l_int|5
)braket
suffix:semicolon
)brace
r_else
(brace
id|DC395x_check_for_safe_settings
c_func
(paren
)paren
suffix:semicolon
id|DC395x_interpret_delay
c_func
(paren
id|eeprom
)paren
suffix:semicolon
id|DC395x_EEprom_Override
c_func
(paren
id|eeprom
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; * adapter - print connection and terminiation config&n; *&n; * @param pACB - adapter control block&n; */
DECL|function|DC395x_print_config
r_static
r_void
id|__init
id|DC395x_print_config
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
)paren
(brace
id|u8
id|bval
suffix:semicolon
id|bval
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_GEN_STATUS
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;%c: Connectors: &quot;
comma
(paren
(paren
id|bval
op_amp
id|WIDESCSI
)paren
ques
c_cond
l_char|&squot;W&squot;
suffix:colon
l_char|&squot; &squot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
id|CON5068
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;ext%s &quot;
comma
op_logical_neg
(paren
id|bval
op_amp
id|EXT68HIGH
)paren
ques
c_cond
l_string|&quot;68&quot;
suffix:colon
l_string|&quot;50&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
id|CON68
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;int68%s &quot;
comma
op_logical_neg
(paren
id|bval
op_amp
id|INT68HIGH
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;(50)&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bval
op_amp
id|CON50
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;int50 &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bval
op_amp
(paren
id|CON5068
op_or
id|CON50
op_or
id|CON68
)paren
)paren
op_eq
l_int|0
multiline_comment|/*(CON5068 | CON50 | CON68) */
)paren
id|printk
c_func
(paren
l_string|&quot; Oops! (All 3?) &quot;
)paren
suffix:semicolon
id|bval
op_assign
id|DC395x_read8
c_func
(paren
id|TRM_S1040_GEN_CONTROL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; Termination: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_amp
id|DIS_TERM
)paren
id|printk
c_func
(paren
l_string|&quot;Disabled&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|bval
op_amp
id|AUTOTERM
)paren
id|printk
c_func
(paren
l_string|&quot;Auto &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_amp
id|LOW8TERM
)paren
id|printk
c_func
(paren
l_string|&quot;Low &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_amp
id|UP8TERM
)paren
id|printk
c_func
(paren
l_string|&quot;High &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *********************************************************************&n; *&t;&t;&t;DC395x_detect&n; *&n; *      Function : static int DC395x_init (struct Scsi_Host *host)&n; *       Purpose : initialize the internal structures for a given SCSI host&n; *        Inputs : host - pointer to this host adapter&squot;s structure/&n; * Preconditions : when this function is called, the chip_type&n; *&t;&t;   field of the pACB structure MUST have been set.&n; *********************************************************************&n; */
r_static
r_struct
id|Scsi_Host
op_star
id|__init
DECL|function|DC395x_init
id|DC395x_init
c_func
(paren
id|Scsi_Host_Template
op_star
id|host_template
comma
id|u32
id|io_port
comma
id|u8
id|irq
comma
id|u16
id|index
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|pACB
suffix:semicolon
multiline_comment|/*&n;&t; * Read the eeprom contents info the buffer we supply. Use&n;&t; * defaults is eeprom checksum is wrong.&n;&t; */
id|DC395x_check_eeprom
c_func
(paren
op_amp
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
comma
(paren
id|u16
)paren
id|io_port
)paren
suffix:semicolon
multiline_comment|/*$$$$$$$$$$$  MEMORY ALLOCATE FOR ADAPTER CONTROL BLOCK $$$$$$$$$$$$ */
id|host
op_assign
id|scsi_register
c_func
(paren
id|host_template
comma
r_sizeof
(paren
r_struct
id|AdapterCtlBlk
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot; : pSH scsi_register ERROR&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Used settings: AdapterID=%02i, Speed=%i(%02i.%01iMHz), DevMode=0x%02x&bslash;n&quot;
comma
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
dot
id|NvramScsiId
comma
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
dot
id|NvramTarget
(braket
l_int|0
)braket
dot
id|NvmTarPeriod
comma
id|dc395x_clock_speed
(braket
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
dot
id|NvramTarget
(braket
l_int|0
)braket
dot
id|NvmTarPeriod
)braket
op_div
l_int|10
comma
id|dc395x_clock_speed
(braket
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
dot
id|NvramTarget
(braket
l_int|0
)braket
dot
id|NvmTarPeriod
)braket
op_mod
l_int|10
comma
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
dot
id|NvramTarget
(braket
l_int|0
)braket
dot
id|NvmTarCfg0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;:      AdaptMode=0x%02x, Tags=%i(%02i), DelayReset=%is&bslash;n&quot;
comma
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
dot
id|NvramChannelCfg
comma
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
dot
id|NvramMaxTag
comma
l_int|1
op_lshift
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
dot
id|NvramMaxTag
comma
id|dc395x_trm_eepromBuf
(braket
id|index
)braket
dot
id|NvramDelayTime
)paren
suffix:semicolon
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
multiline_comment|/*DC395x_ACB_INITLOCK(pACB); */
multiline_comment|/*DC395x_ACB_LOCK(pACB,acb_flags); */
multiline_comment|/*$$$$$$$$ INITIAL ADAPTER CONTROL BLOCK $$$$$$$$$$$$ */
r_if
c_cond
(paren
id|DC395x_initACB
c_func
(paren
id|host
comma
id|io_port
comma
id|irq
comma
id|index
)paren
)paren
(brace
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/*DC395x_ACB_UNLOCK(pACB,acb_flags); */
r_return
l_int|0
suffix:semicolon
)brace
id|DC395x_print_config
c_func
(paren
id|pACB
)paren
suffix:semicolon
multiline_comment|/*$$$$$$$$$$$$$$$$$ INITIAL ADAPTER $$$$$$$$$$$$$$$$$ */
r_if
c_cond
(paren
op_logical_neg
id|DC395x_initAdapter
c_func
(paren
id|host
comma
id|io_port
comma
id|irq
comma
id|index
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|DC395x_pACB_start
)paren
(brace
id|DC395x_pACB_start
op_assign
id|pACB
suffix:semicolon
id|DC395x_pACB_current
op_assign
id|pACB
suffix:semicolon
id|pACB-&gt;pNextACB
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|DC395x_pACB_current-&gt;pNextACB
op_assign
id|pACB
suffix:semicolon
id|DC395x_pACB_current
op_assign
id|pACB
suffix:semicolon
id|pACB-&gt;pNextACB
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*DC395x_ACB_UNLOCK(pACB,acb_flags); */
r_return
id|host
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: DC395x_initAdapter initial ERROR&bslash;n&quot;
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/*DC395x_ACB_UNLOCK(pACB,acb_flags); */
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * DC395x_detect&n; *&n; * Detect TRM-S1040 cards, acquire resources and initialise the card.&n; * Argument is a pointer to the host driver&squot;s scsi_hosts entry.&n; *&n; * Returns the number of adapters found.&n; *&n; * This function is called during system initialization and must not&n; * call SCSI mid-level functions including scsi_malloc() and&n; * scsi_free().&n; */
DECL|function|DC395x_detect
r_static
r_int
id|__init
id|DC395x_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|host_template
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|io_port
suffix:semicolon
id|u8
id|irq
suffix:semicolon
id|DC395x_pACB_start
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* without PCI we cannot do anything */
r_if
c_cond
(paren
id|pci_present
c_func
(paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: PCI not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: %s %s&bslash;n&quot;
comma
id|DC395X_BANNER
comma
id|DC395X_VERSION
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_TEKRAM
comma
id|PCI_DEVICE_ID_TEKRAM_TRMS1040
comma
id|pdev
)paren
)paren
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|scsi_host
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_continue
suffix:semicolon
id|io_port
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
macro_line|#ifdef DC395x_DEBUG0
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: IO_PORT=%04x,IRQ=%x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|io_port
comma
id|irq
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|scsi_host
op_assign
id|DC395x_init
c_func
(paren
id|host_template
comma
id|io_port
comma
id|irq
comma
id|DC395x_adapterCnt
)paren
)paren
)paren
(brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
(paren
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
(paren
id|scsi_host-&gt;hostdata
)paren
)paren
op_member_access_from_pointer
id|pdev
op_assign
id|pdev
suffix:semicolon
multiline_comment|/*DC395x_set_pci_cfg(pdev); */
id|DC395x_adapterCnt
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|DC395x_adapterCnt
)paren
(brace
id|host_template-&gt;proc_name
op_assign
id|DC395X_NAME
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: %s: %i adapters found&bslash;n&quot;
comma
id|DC395X_BANNER
comma
id|DC395x_adapterCnt
)paren
suffix:semicolon
r_return
id|DC395x_adapterCnt
suffix:semicolon
)brace
multiline_comment|/*&n; * Functions: DC395x_inquiry(), DC395x_inquiry_done()&n; *&n; * Purpose: When changing speed etc., we have to issue an INQUIRY&n; *&t;    command to make sure, we agree upon the nego parameters&n; *&t;    with the device&n; */
DECL|function|DC395x_inquiry_done
r_static
r_void
id|DC395x_inquiry_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
op_assign
id|DC395x_findDCB
c_func
(paren
id|pACB
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
macro_line|#ifdef DC395x_DEBUGTRACE
r_struct
id|ScsiReqBlk
op_star
id|pSRB
op_assign
id|pACB-&gt;pFreeSRB
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: INQUIRY (%02i-%i) returned %08x: %02x %02x %02x %02x ...&bslash;n&quot;
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
comma
id|cmd-&gt;result
comma
(paren
(paren
id|u8
op_star
)paren
id|cmd-&gt;request_buffer
)paren
(braket
l_int|0
)braket
comma
(paren
(paren
id|u8
op_star
)paren
id|cmd-&gt;request_buffer
)paren
(braket
l_int|1
)braket
comma
(paren
(paren
id|u8
op_star
)paren
id|cmd-&gt;request_buffer
)paren
(braket
l_int|2
)braket
comma
(paren
(paren
id|u8
op_star
)paren
id|cmd-&gt;request_buffer
)paren
(braket
l_int|3
)braket
)paren
suffix:semicolon
multiline_comment|/*TRACEOUT (&quot;%s&bslash;n&quot;, pSRB-&gt;debugtrace); */
r_if
c_cond
(paren
id|cmd-&gt;result
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: Unsetting Wide, Sync and TagQ!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
)paren
(brace
id|TRACEOUT
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
id|pDCB-&gt;DevMode
op_and_assign
op_complement
(paren
id|NTC_DO_SYNC_NEGO
op_or
id|NTC_DO_WIDE_NEGO
op_or
id|NTC_DO_TAG_QUEUEING
)paren
suffix:semicolon
id|DC395x_updateDCB
c_func
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pDCB
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;SyncMode
op_amp
id|SYNC_NEGO_DONE
)paren
)paren
(brace
id|pDCB-&gt;SyncOffset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*pDCB-&gt;SyncMode &amp;= ~SYNC_NEGO_ENABLE; */
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pDCB-&gt;SyncMode
op_amp
id|WIDE_NEGO_DONE
)paren
)paren
(brace
id|pDCB-&gt;SyncPeriod
op_and_assign
op_complement
id|WIDE_SYNC
suffix:semicolon
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|WIDE_NEGO_ENABLE
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: ERROR! No DCB existent for %02i-%i ?&bslash;n&quot;
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|cmd-&gt;buffer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform INQUIRY&n; */
DECL|function|DC395x_inquiry
r_void
id|DC395x_inquiry
c_func
(paren
r_struct
id|AdapterCtlBlk
op_star
id|pACB
comma
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
)paren
(brace
r_char
op_star
id|buffer
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
id|cmd
op_assign
id|KMALLOC
c_func
(paren
r_sizeof
(paren
id|Scsi_Cmnd
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmd
)paren
(brace
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: kmalloc failed in inquiry!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|buffer
op_assign
id|kmalloc
c_func
(paren
l_int|256
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|kfree
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: kmalloc failed in inquiry!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
r_sizeof
(paren
id|Scsi_Cmnd
)paren
)paren
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|0
)braket
op_assign
id|INQUIRY
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|1
)braket
op_assign
(paren
id|pDCB-&gt;TargetLUN
op_lshift
l_int|5
)paren
op_amp
l_int|0xe0
suffix:semicolon
id|cmd-&gt;cmnd
(braket
l_int|4
)braket
op_assign
l_int|0xff
suffix:semicolon
id|cmd-&gt;cmd_len
op_assign
l_int|6
suffix:semicolon
id|cmd-&gt;old_cmd_len
op_assign
l_int|6
suffix:semicolon
id|cmd-&gt;device-&gt;host
op_assign
id|pACB-&gt;pScsiHost
suffix:semicolon
id|cmd-&gt;device-&gt;id
op_assign
id|pDCB-&gt;TargetID
suffix:semicolon
id|cmd-&gt;device-&gt;lun
op_assign
id|pDCB-&gt;TargetLUN
suffix:semicolon
id|cmd-&gt;serial_number
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;pid
op_assign
l_int|395
suffix:semicolon
id|cmd-&gt;bufflen
op_assign
l_int|128
suffix:semicolon
id|cmd-&gt;buffer
op_assign
id|buffer
suffix:semicolon
id|cmd-&gt;request_bufflen
op_assign
l_int|128
suffix:semicolon
id|cmd-&gt;request_buffer
op_assign
op_amp
id|buffer
(braket
l_int|128
)braket
suffix:semicolon
id|cmd-&gt;done
op_assign
id|DC395x_inquiry_done
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
id|DC395x_inquiry_done
suffix:semicolon
id|cmd-&gt;timeout_per_command
op_assign
id|HZ
suffix:semicolon
macro_line|#if 0
multiline_comment|/* XXX */
id|cmd-&gt;request.rq_status
op_assign
id|RQ_SCSI_BUSY
suffix:semicolon
macro_line|#endif
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|SYNC_NEGO_DONE
suffix:semicolon
id|pDCB-&gt;SyncMode
op_or_assign
id|SYNC_NEGO_ENABLE
suffix:semicolon
id|pDCB-&gt;SyncMode
op_and_assign
op_complement
id|WIDE_NEGO_DONE
suffix:semicolon
id|pDCB-&gt;SyncMode
op_or_assign
id|WIDE_NEGO_ENABLE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Queue INQUIRY command to dev %02i-%i&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|DC395x_queue_command
c_func
(paren
id|cmd
comma
id|DC395x_inquiry_done
)paren
suffix:semicolon
)brace
DECL|macro|SEARCH
macro_line|#undef SEARCH
DECL|macro|YESNO
macro_line|#undef YESNO
DECL|macro|SCANF
macro_line|#undef SCANF
multiline_comment|/*&n; ******************************************************************&n; * Function: DC395x_proc_info(char* buffer, char **start,&n; *&t;&t;&t; off_t offset, int length, int hostno, int inout)&n; *  Purpose: return SCSI Adapter/Device Info&n; *    Input:&n; *          buffer: Pointer to a buffer where to write info&n; *&t;&t; start :&n; *&t;&t; offset:&n; *&t;&t; hostno: Host adapter index&n; *&t;&t; inout : Read (=0) or set(!=0) info&n; *   Output:&n; *          buffer: contains info length &n; *&t;&t;         &n; *    return value: length of info in buffer&n; *&n; ******************************************************************&n; */
multiline_comment|/* KG: proc_info taken from driver aha152x.c */
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
DECL|macro|SPRINTF
mdefine_line|#define SPRINTF(args...) pos += sprintf(pos, args)
DECL|macro|YESNO
mdefine_line|#define YESNO(YN) &bslash;&n; if (YN) SPRINTF(&quot; Yes &quot;);&bslash;&n; else SPRINTF(&quot; No  &quot;)
r_static
r_int
DECL|function|DC395x_proc_info
id|DC395x_proc_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|inout
)paren
(brace
r_int
id|dev
comma
id|spd
comma
id|spd1
suffix:semicolon
r_char
op_star
id|pos
op_assign
id|buffer
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|shpnt
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|pACB
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|Scsi_Cmnd
op_star
id|pcmd
suffix:semicolon
multiline_comment|/*  Scsi_Cmnd *ptr; */
id|pACB
op_assign
id|DC395x_pACB_start
suffix:semicolon
r_while
c_loop
(paren
id|pACB
)paren
(brace
id|shpnt
op_assign
id|pACB-&gt;pScsiHost
suffix:semicolon
r_if
c_cond
(paren
id|shpnt-&gt;host_no
op_eq
id|hostno
)paren
r_break
suffix:semicolon
id|pACB
op_assign
id|pACB-&gt;pNextACB
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pACB
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shpnt
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
id|inout
)paren
multiline_comment|/* Has data been written to the file ? */
r_return
op_minus
id|EPERM
suffix:semicolon
id|SPRINTF
c_func
(paren
id|DC395X_BANNER
l_string|&quot; PCI SCSI Host Adapter&bslash;n&quot;
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot; Driver Version &quot;
id|DC395X_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|DC395x_LOCK_IO
c_func
(paren
id|pACB-&gt;pScsiHost
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;SCSI Host Nr %i, &quot;
comma
id|shpnt-&gt;host_no
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;DC395U/UW/F DC315/U %s Adapter Nr %i&bslash;n&quot;
comma
(paren
id|pACB-&gt;Config
op_amp
id|HCC_WIDE_CARD
)paren
ques
c_cond
l_string|&quot;Wide&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|pACB-&gt;AdapterIndex
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;IOPortBase 0x%04x, &quot;
comma
id|pACB-&gt;IOPortBase
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;IRQLevel 0x%02x, &quot;
comma
id|pACB-&gt;IRQLevel
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot; SelTimeout %ims&bslash;n&quot;
comma
(paren
l_int|1638
op_star
id|pACB-&gt;sel_timeout
)paren
op_div
l_int|1000
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;MaxID %i, MaxLUN %i, &quot;
comma
id|shpnt-&gt;max_id
comma
id|shpnt-&gt;max_lun
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;AdapterID %i&bslash;n&quot;
comma
id|shpnt-&gt;this_id
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;TagMaxNum %i, Status %i&quot;
comma
id|pACB-&gt;TagMaxNum
comma
id|pACB-&gt;status
)paren
suffix:semicolon
multiline_comment|/*SPRINTF(&quot;, DMA_Status %i&bslash;n&quot;, DC395x_read8(TRM_S1040_DMA_STATUS)); */
id|SPRINTF
c_func
(paren
l_string|&quot;, FilterCfg 0x%02x&quot;
comma
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_CONFIG1
)paren
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;, DelayReset %is&bslash;n&quot;
comma
id|dc395x_trm_eepromBuf
(braket
id|pACB-&gt;AdapterIndex
)braket
dot
id|NvramDelayTime
)paren
suffix:semicolon
multiline_comment|/*SPRINTF(&quot;&bslash;n&quot;); */
id|SPRINTF
c_func
(paren
l_string|&quot;Nr of attached devices: %i, Nr of DCBs: %i&bslash;n&quot;
comma
id|pACB-&gt;DeviceCnt
comma
id|pACB-&gt;DCBCnt
)paren
suffix:semicolon
id|SPRINTF
(paren
l_string|&quot;Map of attached LUNs: %02x %02x %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|pACB-&gt;DCBmap
(braket
l_int|0
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|1
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|2
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|3
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|4
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|5
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|6
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|SPRINTF
(paren
l_string|&quot;                      %02x %02x %02x %02x %02x %02x %02x %02x&bslash;n&quot;
comma
id|pACB-&gt;DCBmap
(braket
l_int|8
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|9
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|10
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|11
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|12
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|13
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|14
)braket
comma
id|pACB-&gt;DCBmap
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|SPRINTF
(paren
l_string|&quot;Un ID LUN Prty Sync Wide DsCn SndS TagQ NegoPeriod SyncFreq SyncOffs MaxCmd&bslash;n&quot;
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
l_int|0
suffix:semicolon
id|dev
OL
id|pACB-&gt;DCBCnt
suffix:semicolon
id|dev
op_increment
)paren
(brace
r_int
id|NegoPeriod
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%02i %02i  %02i &quot;
comma
id|dev
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_PARITY_CHK
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|pDCB-&gt;SyncOffset
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|pDCB-&gt;SyncPeriod
op_amp
id|WIDE_SYNC
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_DISCONNECT
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|pDCB-&gt;DevMode
op_amp
id|NTC_DO_SEND_START
)paren
suffix:semicolon
id|YESNO
c_func
(paren
id|pDCB-&gt;SyncMode
op_amp
id|EN_TAG_QUEUEING
)paren
suffix:semicolon
id|NegoPeriod
op_assign
id|dc395x_clock_period
(braket
id|pDCB-&gt;SyncPeriod
op_amp
l_int|0x07
)braket
op_lshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;SyncOffset
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;  %03i ns &quot;
comma
id|NegoPeriod
)paren
suffix:semicolon
r_else
id|SPRINTF
c_func
(paren
l_string|&quot; (%03i ns)&quot;
comma
(paren
id|pDCB-&gt;MinNegoPeriod
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;SyncOffset
op_amp
l_int|0x0f
)paren
(brace
id|spd
op_assign
l_int|1000
op_div
(paren
id|NegoPeriod
)paren
suffix:semicolon
id|spd1
op_assign
l_int|1000
op_mod
(paren
id|NegoPeriod
)paren
suffix:semicolon
id|spd1
op_assign
(paren
id|spd1
op_star
l_int|10
op_plus
id|NegoPeriod
op_div
l_int|2
)paren
op_div
(paren
id|NegoPeriod
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;   %2i.%1i M     %02i &quot;
comma
id|spd
comma
id|spd1
comma
(paren
id|pDCB-&gt;SyncOffset
op_amp
l_int|0x0f
)paren
)paren
suffix:semicolon
)brace
r_else
id|SPRINTF
c_func
(paren
l_string|&quot;                 &quot;
)paren
suffix:semicolon
multiline_comment|/* Add more info ... */
id|SPRINTF
c_func
(paren
l_string|&quot;     %02i&bslash;n&quot;
comma
id|pDCB-&gt;MaxCommand
)paren
suffix:semicolon
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
id|SPRINTF
c_func
(paren
l_string|&quot;Commands in Queues: Query: %i:&quot;
comma
id|pACB-&gt;QueryCnt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pcmd
op_assign
id|pACB-&gt;pQueryHead
suffix:semicolon
id|pcmd
suffix:semicolon
id|pcmd
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|pcmd-&gt;host_scribble
)paren
id|SPRINTF
c_func
(paren
l_string|&quot; %li&quot;
comma
id|pcmd-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;Waiting queue timer running&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
l_int|0
suffix:semicolon
id|dev
OL
id|pACB-&gt;DCBCnt
suffix:semicolon
id|dev
op_increment
)paren
(brace
r_struct
id|ScsiReqBlk
op_star
id|pSRB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;WaitSRBCnt
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;DCB (%02i-%i): Waiting: %i:&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|pDCB-&gt;WaitSRBCnt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pSRB
op_assign
id|pDCB-&gt;pWaitingSRB
suffix:semicolon
id|pSRB
suffix:semicolon
id|pSRB
op_assign
id|pSRB-&gt;pNextSRB
)paren
id|SPRINTF
c_func
(paren
l_string|&quot; %li&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDCB-&gt;GoingSRBCnt
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;nDCB (%02i-%i): Going  : %i:&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|pDCB-&gt;GoingSRBCnt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pSRB
op_assign
id|pDCB-&gt;pGoingSRB
suffix:semicolon
id|pSRB
suffix:semicolon
id|pSRB
op_assign
id|pSRB-&gt;pNextSRB
)paren
macro_line|#ifdef DC395x_DEBUGTRACE
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n  %s&quot;
comma
id|pSRB-&gt;debugtrace
)paren
suffix:semicolon
macro_line|#else
id|SPRINTF
c_func
(paren
l_string|&quot; %li&quot;
comma
id|pSRB-&gt;pcmd-&gt;pid
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pDCB-&gt;WaitSRBCnt
op_logical_or
id|pDCB-&gt;GoingSRBCnt
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
)brace
macro_line|#ifdef DC395x_DEBUGDCB
id|SPRINTF
c_func
(paren
l_string|&quot;DCB list for ACB %p:&bslash;n&quot;
comma
id|pACB
)paren
suffix:semicolon
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;%p&quot;
comma
id|pDCB
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
l_int|0
suffix:semicolon
id|dev
OL
id|pACB-&gt;DCBCnt
suffix:semicolon
id|dev
op_increment
comma
id|pDCB
op_assign
id|pDCB-&gt;pNextDCB
)paren
id|SPRINTF
c_func
(paren
l_string|&quot;-&gt;%p&quot;
comma
id|pDCB-&gt;pNextDCB
)paren
suffix:semicolon
id|SPRINTF
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
id|DC395x_UNLOCK_IO
c_func
(paren
id|pACB-&gt;pScsiHost
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_minus
id|buffer
OL
id|offset
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pos
op_minus
id|buffer
op_minus
id|offset
OL
id|length
)paren
r_return
id|pos
op_minus
id|buffer
op_minus
id|offset
suffix:semicolon
r_else
r_return
id|length
suffix:semicolon
)brace
multiline_comment|/*&n; * Function : int DC395x_shutdown (struct Scsi_Host *host)&n; *  Purpose : does a clean (we hope) shutdown of the SCSI chip.&n; *&t;&t;Use prior to dumping core, unloading the driver, etc.&n; *  Returns : 0 on success&n; */
DECL|function|DC395x_shutdown
r_int
id|DC395x_shutdown
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|pACB
suffix:semicolon
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
(paren
id|host-&gt;hostdata
)paren
suffix:semicolon
multiline_comment|/* pACB-&gt;soft_reset(host); */
multiline_comment|/* disable interrupt */
id|DC395x_write8
c_func
(paren
id|TRM_S1040_DMA_INTEN
comma
l_int|0
)paren
suffix:semicolon
id|DC395x_write8
c_func
(paren
id|TRM_S1040_SCSI_INTEN
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|pACB-&gt;Waiting_Timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|pACB-&gt;SelTO_Timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|pACB-&gt;SelTO_Timer
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_logical_or
id|pACB-&gt;Config
op_amp
id|HCC_SCSI_RESET
)paren
id|DC395x_ResetSCSIBus
c_func
(paren
id|pACB
)paren
suffix:semicolon
id|DC395x_read8
c_func
(paren
id|TRM_S1040_SCSI_INTSTATUS
)paren
suffix:semicolon
macro_line|#ifdef DC395x_DEBUGTRACE
id|DC395x_free_tracebufs
c_func
(paren
id|pACB
comma
id|DC395x_MAX_SRB_CNT
)paren
suffix:semicolon
macro_line|#endif
id|DC395x_free_SG_tables
c_func
(paren
id|pACB
comma
id|DC395x_MAX_SRB_CNT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Free all DCBs&n; */
DECL|function|DC395x_freeDCBs
r_void
id|DC395x_freeDCBs
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|DeviceCtlBlk
op_star
id|pDCB
suffix:semicolon
r_struct
id|DeviceCtlBlk
op_star
id|nDCB
suffix:semicolon
r_struct
id|AdapterCtlBlk
op_star
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
(paren
id|host-&gt;hostdata
)paren
suffix:semicolon
id|DCBDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Free %i DCBs&bslash;n&quot;
comma
id|pACB-&gt;DCBCnt
)paren
suffix:semicolon
)paren
id|pDCB
op_assign
id|pACB-&gt;pLinkDCB
suffix:semicolon
r_if
c_cond
(paren
id|pDCB
)paren
(brace
r_do
(brace
id|nDCB
op_assign
id|pDCB-&gt;pNextDCB
suffix:semicolon
id|DCBDEBUG
c_func
(paren
id|printk
(paren
id|KERN_INFO
id|DC395X_NAME
l_string|&quot;: Free DCB (ID %i, LUN %i): %p&bslash;n&quot;
comma
id|pDCB-&gt;TargetID
comma
id|pDCB-&gt;TargetLUN
comma
id|pDCB
)paren
suffix:semicolon
)paren
id|DC395x_remove_dev
c_func
(paren
id|pACB
comma
id|pDCB
)paren
suffix:semicolon
multiline_comment|/* includes a KFREE(pDCB); */
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
id|pDCB
op_assign
id|nDCB
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pDCB
op_logical_and
id|pACB-&gt;pLinkDCB
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Release method&n; *&n; * Called when we are to shutdown the controller and release all of&n; * it&squot;s resources.&n; */
DECL|function|DC395x_release
r_static
r_int
id|DC395x_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_struct
id|AdapterCtlBlk
op_star
id|pACB
op_assign
(paren
r_struct
id|AdapterCtlBlk
op_star
)paren
(paren
id|host-&gt;hostdata
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|printk
c_func
(paren
id|DC395X_NAME
l_string|&quot;: release&quot;
)paren
suffix:semicolon
id|DC395x_LOCK_IO
c_func
(paren
id|pACB-&gt;pScsiHost
)paren
suffix:semicolon
id|DC395x_shutdown
c_func
(paren
id|host
)paren
suffix:semicolon
id|DC395x_freeDCBs
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;irq
op_ne
id|NO_IRQ
)paren
(brace
multiline_comment|/*&n;&t;&t; * Find the IRQ to release. XXX Why didn&squot;t we just store the&n;&t;&t; * appropriate IRQ details when we request_irq it?&n;&t;&t; */
r_int
id|irq_count
suffix:semicolon
r_for
c_loop
(paren
id|irq_count
op_assign
l_int|0
comma
id|pACB
op_assign
id|DC395x_pACB_start
suffix:semicolon
id|pACB
suffix:semicolon
id|pACB
op_assign
id|pACB-&gt;pNextACB
)paren
(brace
r_if
c_cond
(paren
id|pACB-&gt;IRQLevel
op_eq
id|host-&gt;irq
)paren
op_increment
id|irq_count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq_count
op_eq
l_int|1
)paren
id|free_irq
c_func
(paren
id|host-&gt;irq
comma
id|DC395x_pACB_start
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|host-&gt;io_port
comma
id|host-&gt;n_io_port
)paren
suffix:semicolon
id|DC395x_UNLOCK_IO
c_func
(paren
id|pACB-&gt;pScsiHost
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * SCSI host template&n; */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
(brace
dot
id|proc_name
op_assign
id|DC395X_NAME
comma
dot
id|proc_info
op_assign
id|DC395x_proc_info
comma
dot
id|name
op_assign
id|DC395X_BANNER
l_string|&quot; &quot;
id|DC395X_VERSION
comma
dot
id|detect
op_assign
id|DC395x_detect
comma
dot
id|release
op_assign
id|DC395x_release
comma
dot
id|queuecommand
op_assign
id|DC395x_queue_command
comma
dot
id|bios_param
op_assign
id|DC395x_bios_param
comma
dot
id|slave_alloc
op_assign
id|DC395x_slave_alloc
comma
dot
id|slave_destroy
op_assign
id|DC395x_slave_destroy
comma
dot
id|can_queue
op_assign
id|DC395x_MAX_CAN_QUEUE
comma
dot
id|this_id
op_assign
l_int|7
comma
dot
id|sg_tablesize
op_assign
id|DC395x_MAX_SG_TABLESIZE
comma
dot
id|cmd_per_lun
op_assign
id|DC395x_MAX_CMD_PER_LUN
comma
dot
id|eh_abort_handler
op_assign
id|DC395x_eh_abort
comma
dot
id|eh_bus_reset_handler
op_assign
id|DC395x_eh_bus_reset
comma
dot
id|unchecked_isa_dma
op_assign
l_int|0
comma
dot
id|use_clustering
op_assign
id|DISABLE_CLUSTERING
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * The following code deals with registering the above scsi host&n; * template with the higher level scsi code and results in the detect&n; * method from the template being called during initialisation.&n; */
macro_line|#include &quot;scsi_module.c&quot;
eof
