multiline_comment|/*&n; *&n; *  drivers/scsi/pc980155.c&n; *&n; *  PC-9801-55 SCSI host adapter driver&n; *&n; *  Copyright (C) 1997-2003  Kyoto University Microcomputer Club&n; *&t;&t;&t;     (Linux/98 project)&n; *&t;&t;&t;     Tomoharu Ugawa &lt;ohirune@kmc.gr.jp&gt;&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;wd33c93.h&quot;
macro_line|#include &quot;pc980155.h&quot;
r_extern
r_int
id|pc98_bios_param
c_func
(paren
r_struct
id|scsi_device
op_star
comma
r_struct
id|block_device
op_star
comma
id|sector_t
comma
r_int
op_star
)paren
suffix:semicolon
r_static
r_int
id|scsi_pc980155_detect
c_func
(paren
id|Scsi_Host_Template
op_star
)paren
suffix:semicolon
r_static
r_int
id|scsi_pc980155_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
)paren
suffix:semicolon
macro_line|#ifndef CMD_PER_LUN
DECL|macro|CMD_PER_LUN
mdefine_line|#define CMD_PER_LUN 2
macro_line|#endif
macro_line|#ifndef CAN_QUEUE
DECL|macro|CAN_QUEUE
mdefine_line|#define CAN_QUEUE 16
macro_line|#endif
DECL|macro|PC_9801_55_DEBUG
macro_line|#undef PC_9801_55_DEBUG
DECL|macro|PC_9801_55_DEBUG_VERBOSE
macro_line|#undef PC_9801_55_DEBUG_VERBOSE
DECL|macro|NR_BASE_IOS
mdefine_line|#define NR_BASE_IOS 4
DECL|variable|nr_base_ios
r_static
r_int
id|nr_base_ios
op_assign
id|NR_BASE_IOS
suffix:semicolon
DECL|variable|base_ios
r_static
r_int
r_int
id|base_ios
(braket
id|NR_BASE_IOS
)braket
op_assign
(brace
l_int|0xcc0
comma
l_int|0xcd0
comma
l_int|0xce0
comma
l_int|0xcf0
)brace
suffix:semicolon
DECL|variable|init_regs
r_static
id|wd33c93_regs
id|init_regs
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
suffix:semicolon
DECL|variable|pc980155_host
r_static
r_struct
id|Scsi_Host
op_star
id|pc980155_host
op_assign
l_int|NULL
suffix:semicolon
r_static
r_void
id|pc980155_intr_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regp
)paren
suffix:semicolon
DECL|function|pc980155_dma_enable
r_static
r_inline
r_void
id|pc980155_dma_enable
c_func
(paren
r_int
r_int
id|base_io
)paren
(brace
id|outb
c_func
(paren
l_int|0x01
comma
id|REG_CWRITE
)paren
suffix:semicolon
)brace
DECL|function|pc980155_dma_disable
r_static
r_inline
r_void
id|pc980155_dma_disable
c_func
(paren
r_int
r_int
id|base_io
)paren
(brace
id|outb
c_func
(paren
l_int|0x02
comma
id|REG_CWRITE
)paren
suffix:semicolon
)brace
DECL|function|pc980155_intr_handle
r_static
r_void
id|pc980155_intr_handle
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regp
)paren
(brace
id|wd33c93_intr
c_func
(paren
id|pc980155_host
)paren
suffix:semicolon
)brace
DECL|function|dma_setup
r_static
r_int
id|dma_setup
c_func
(paren
id|Scsi_Cmnd
op_star
id|sc
comma
r_int
id|dir_in
)paren
(brace
multiline_comment|/*&n;   * sc-&gt;SCp.this_residual : transfer count&n;   * sc-&gt;SCp.ptr : distination address (virtual address)&n;   * dir_in : data direction (DATA_OUT_DIR:0 or DATA_IN_DIR:1)&n;   *&n;   * if success return 0&n;   */
multiline_comment|/*&n;    * DMA WRITE MODE&n;    * bit 7,6 01b single mode (this mode only)&n;    * bit 5   inc/dec (default:0 = inc)&n;    * bit 4   auto initialize (normaly:0 = off)&n;    * bit 3,2 01b memory -&gt; io&n;    *         10b io -&gt; memory&n;    *         00b verify&n;    * bit 1,0 channel&n;    */
id|disable_dma
c_func
(paren
id|sc-&gt;device-&gt;host-&gt;dma_channel
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|sc-&gt;device-&gt;host-&gt;dma_channel
comma
l_int|0x40
op_or
(paren
id|dir_in
ques
c_cond
l_int|0x04
suffix:colon
l_int|0x08
)paren
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|sc-&gt;device-&gt;host-&gt;dma_channel
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|sc-&gt;device-&gt;host-&gt;dma_channel
comma
id|virt_to_phys
c_func
(paren
id|sc-&gt;SCp.ptr
)paren
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|sc-&gt;device-&gt;host-&gt;dma_channel
comma
id|sc-&gt;SCp.this_residual
)paren
suffix:semicolon
macro_line|#ifdef PC_9801_55_DEBUG
id|printk
c_func
(paren
l_string|&quot;D%d(%x)D&quot;
comma
id|sc-&gt;device-&gt;host-&gt;dma_channel
comma
id|sc-&gt;SCp.this_residual
)paren
suffix:semicolon
macro_line|#endif
id|enable_dma
c_func
(paren
id|sc-&gt;device-&gt;host-&gt;dma_channel
)paren
suffix:semicolon
id|pc980155_dma_enable
c_func
(paren
id|sc-&gt;device-&gt;host-&gt;io_port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dma_stop
r_static
r_void
id|dma_stop
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
id|Scsi_Cmnd
op_star
id|sc
comma
r_int
id|status
)paren
(brace
multiline_comment|/*&n;   * instance: Hostadapter&squot;s instance&n;   * sc: scsi command&n;   * status: True if success&n;   */
id|pc980155_dma_disable
c_func
(paren
id|sc-&gt;device-&gt;host-&gt;io_port
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|sc-&gt;device-&gt;host-&gt;dma_channel
)paren
suffix:semicolon
)brace
multiline_comment|/* return non-zero on detection */
DECL|function|pc980155_test_port
r_static
r_inline
r_int
id|pc980155_test_port
c_func
(paren
id|wd33c93_regs
id|regs
)paren
(brace
multiline_comment|/* Quick and dirty test for presence of the card. */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|regs.SASR
)paren
op_eq
l_int|0xff
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pc980155_getconfig
r_static
r_inline
r_int
id|pc980155_getconfig
c_func
(paren
r_int
r_int
id|base_io
comma
id|wd33c93_regs
id|regs
comma
r_int
r_char
op_star
id|irq
comma
r_int
r_char
op_star
id|dma
comma
r_int
r_char
op_star
id|scsi_id
)paren
(brace
r_static
r_int
r_char
id|irqs
(braket
)braket
op_assign
(brace
l_int|3
comma
l_int|5
comma
l_int|6
comma
l_int|9
comma
l_int|12
comma
l_int|13
)brace
suffix:semicolon
r_int
r_char
id|result
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PC-9801-55: base_io=%x SASR=%x SCMD=%x&bslash;n&quot;
comma
id|base_io
comma
id|regs.SASR
comma
id|regs.SCMD
)paren
suffix:semicolon
id|result
op_assign
id|read_pc980155_resetint
c_func
(paren
id|regs
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PC-9801-55: getting config (%x)&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
op_star
id|scsi_id
op_assign
id|result
op_amp
l_int|0x07
suffix:semicolon
op_star
id|irq
op_assign
(paren
id|result
op_rshift
l_int|3
)paren
op_amp
l_int|0x07
suffix:semicolon
r_if
c_cond
(paren
op_star
id|irq
OG
l_int|5
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PC-9801-55 (base %#x): impossible IRQ (%d)&quot;
l_string|&quot; - other device here?&bslash;n&quot;
comma
id|base_io
comma
op_star
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|irq
op_assign
id|irqs
(braket
op_star
id|irq
)braket
suffix:semicolon
id|result
op_assign
id|inb
c_func
(paren
id|REG_STATRD
)paren
suffix:semicolon
op_star
id|dma
op_assign
id|result
op_amp
l_int|0x03
suffix:semicolon
r_if
c_cond
(paren
op_star
id|dma
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PC-9801-55 (base %#x): impossible DMA channl (%d)&quot;
l_string|&quot; - other device here?&bslash;n&quot;
comma
id|base_io
comma
op_star
id|dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef PC_9801_55_DEBUG
id|printk
c_func
(paren
l_string|&quot;PC-9801-55: end of getconfig&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* return non-zero on detection */
DECL|function|scsi_pc980155_detect
r_static
r_int
id|scsi_pc980155_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
r_int
id|base_io
suffix:semicolon
r_int
r_char
id|irq
comma
id|dma
comma
id|scsi_id
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef PC_9801_55_DEBUG
r_int
r_char
id|debug
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|io
)paren
(brace
id|base_ios
(braket
l_int|0
)braket
op_assign
id|io
suffix:semicolon
id|nr_base_ios
op_assign
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_base_ios
suffix:semicolon
id|i
op_increment
)paren
(brace
id|base_io
op_assign
id|base_ios
(braket
id|i
)braket
suffix:semicolon
id|init_regs.SASR
op_assign
id|REG_ADDRST
suffix:semicolon
id|init_regs.SCMD
op_assign
id|REG_CONTRL
suffix:semicolon
macro_line|#ifdef PC_9801_55_DEBUG
id|printk
c_func
(paren
l_string|&quot;PC-9801-55: SASR(%x = %x)&bslash;n&quot;
comma
id|SASR
comma
id|REG_ADDRST
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|base_io
comma
l_int|6
comma
l_string|&quot;PC-9801-55&quot;
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pc980155_test_port
c_func
(paren
id|init_regs
)paren
op_logical_and
id|pc980155_getconfig
c_func
(paren
id|base_io
comma
id|init_regs
comma
op_amp
id|irq
comma
op_amp
id|dma
comma
op_amp
id|scsi_id
)paren
)paren
r_goto
id|found
suffix:semicolon
id|release_region
c_func
(paren
id|base_io
comma
l_int|6
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;PC-9801-55: not found&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|found
suffix:colon
macro_line|#ifdef PC_9801_55_DEBUG
id|printk
c_func
(paren
l_string|&quot;PC-9801-55: config: base io = %x, irq = %d, dma channel = %d, scsi id = %d&bslash;n&quot;
comma
id|base_io
comma
id|irq
comma
id|dma
comma
id|scsi_id
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|pc980155_intr_handle
comma
l_int|0
comma
l_string|&quot;PC-9801-55&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PC-9801-55: unable to allocate IRQ %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_goto
id|err1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dma
comma
l_string|&quot;PC-9801-55&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PC-9801-55: unable to allocate DMA channel %d&bslash;n&quot;
comma
id|dma
)paren
suffix:semicolon
r_goto
id|err2
suffix:semicolon
)brace
id|pc980155_host
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
r_sizeof
(paren
r_struct
id|WD33C93_hostdata
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pc980155_host
)paren
(brace
id|pc980155_host-&gt;this_id
op_assign
id|scsi_id
suffix:semicolon
id|pc980155_host-&gt;io_port
op_assign
id|base_io
suffix:semicolon
id|pc980155_host-&gt;n_io_port
op_assign
l_int|6
suffix:semicolon
id|pc980155_host-&gt;irq
op_assign
id|irq
suffix:semicolon
id|pc980155_host-&gt;dma_channel
op_assign
id|dma
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PC-9801-55: scsi host found at %x irq = %d, use dma channel %d.&bslash;n&quot;
comma
id|base_io
comma
id|irq
comma
id|dma
)paren
suffix:semicolon
id|pc980155_int_enable
c_func
(paren
id|init_regs
)paren
suffix:semicolon
id|wd33c93_init
c_func
(paren
id|pc980155_host
comma
id|init_regs
comma
id|dma_setup
comma
id|dma_stop
comma
id|WD33C93_FS_12_15
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PC-9801-55: failed to register device&bslash;n&quot;
)paren
suffix:semicolon
id|err2
suffix:colon
id|free_irq
c_func
(paren
id|irq
comma
l_int|NULL
)paren
suffix:semicolon
id|err1
suffix:colon
id|release_region
c_func
(paren
id|base_io
comma
l_int|6
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scsi_pc980155_release
r_static
r_int
id|scsi_pc980155_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shost
)paren
(brace
r_struct
id|WD33C93_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|WD33C93_hostdata
op_star
)paren
id|shost-&gt;hostdata
suffix:semicolon
id|pc980155_int_disable
c_func
(paren
id|hostdata-&gt;regs
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|shost-&gt;io_port
comma
id|shost-&gt;n_io_port
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|shost-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|shost-&gt;dma_channel
)paren
suffix:semicolon
id|wd33c93_release
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pc980155_bus_reset
r_static
r_int
id|pc980155_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
r_struct
id|WD33C93_hostdata
op_star
id|hostdata
op_assign
(paren
r_struct
id|WD33C93_hostdata
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;hostdata
suffix:semicolon
id|pc980155_int_disable
c_func
(paren
id|hostdata-&gt;regs
)paren
suffix:semicolon
id|pc980155_assert_bus_reset
c_func
(paren
id|hostdata-&gt;regs
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|pc980155_negate_bus_reset
c_func
(paren
id|hostdata-&gt;regs
)paren
suffix:semicolon
(paren
r_void
)paren
id|inb
c_func
(paren
id|hostdata-&gt;regs.SASR
)paren
suffix:semicolon
(paren
r_void
)paren
id|read_pc980155
c_func
(paren
id|hostdata-&gt;regs
comma
id|WD_SCSI_STATUS
)paren
suffix:semicolon
id|pc980155_int_enable
c_func
(paren
id|hostdata-&gt;regs
)paren
suffix:semicolon
id|wd33c93_host_reset
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
macro_line|#ifndef MODULE
DECL|function|pc980155_setup
r_static
r_int
id|__init
id|pc980155_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|ints
(braket
l_int|4
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|0
)paren
id|io
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;pc980155_io=&quot;
comma
id|pc980155_setup
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Tomoharu Ugawa &lt;ohirune@kmc.gr.jp&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;PC-9801-55 SCSI host adapter driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
(brace
dot
id|proc_info
op_assign
id|wd33c93_proc_info
comma
dot
id|name
op_assign
l_string|&quot;SCSI PC-9801-55&quot;
comma
dot
id|detect
op_assign
id|scsi_pc980155_detect
comma
dot
id|release
op_assign
id|scsi_pc980155_release
comma
dot
id|queuecommand
op_assign
id|wd33c93_queuecommand
comma
dot
id|eh_abort_handler
op_assign
id|wd33c93_abort
comma
dot
id|eh_bus_reset_handler
op_assign
id|pc980155_bus_reset
comma
dot
id|eh_host_reset_handler
op_assign
id|wd33c93_host_reset
comma
dot
id|bios_param
op_assign
id|pc98_bios_param
comma
dot
id|can_queue
op_assign
id|CAN_QUEUE
comma
dot
id|this_id
op_assign
l_int|7
comma
dot
id|sg_tablesize
op_assign
id|SG_ALL
comma
dot
id|cmd_per_lun
op_assign
id|CMD_PER_LUN
comma
multiline_comment|/* dont use link command */
dot
id|unchecked_isa_dma
op_assign
l_int|1
comma
multiline_comment|/* use dma **XXXX***/
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
dot
id|proc_name
op_assign
l_string|&quot;PC_9801_55&quot;
comma
)brace
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
