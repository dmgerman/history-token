multiline_comment|/************************************************************&n; *                                                          *&n; *               Linux EATA SCSI PIO driver                 *&n; *                                                          *&n; *  based on the CAM document CAM/89-004 rev. 2.0c,         *&n; *  DPT&squot;s driver kit, some internal documents and source,   *&n; *  and several other Linux scsi drivers and kernel docs.   *&n; *                                                          *&n; *  The driver currently:                                   *&n; *      -supports all EATA-PIO boards                       *&n; *      -only supports DASD devices                         *&n; *                                                          *&n; *  (c)1993-96 Michael Neuffer, Alfred Arnold               *&n; *             neuffer@goofy.zdv.uni-mainz.de               *&n; *             a.arnold@kfa-juelich.de                      * &n; *                                                          *&n; *  Updated 2002 by Alan Cox &lt;alan@redhat.com&gt; for Linux    *&n; *  2.5.x and the newer locking and error handling          *&n; *                                                          *&n; *  This program is free software; you can redistribute it  *&n; *  and/or modify it under the terms of the GNU General     *&n; *  Public License as published by the Free Software        *&n; *  Foundation; either version 2 of the License, or         *&n; *  (at your option) any later version.                     *&n; *                                                          *&n; *  This program is distributed in the hope that it will be *&n; *  useful, but WITHOUT ANY WARRANTY; without even the      *&n; *  implied warranty of MERCHANTABILITY or FITNESS FOR A    *&n; *  PARTICULAR PURPOSE.  See the GNU General Public License *&n; *  for more details.                                       *&n; *                                                          *&n; *  You should have received a copy of the GNU General      *&n; *  Public License along with this kernel; if not, write to *&n; *  the Free Software Foundation, Inc., 675 Mass Ave,       *&n; *  Cambridge, MA 02139, USA.                               *&n; *&t;&t;&t;&t;&t;&t;&t;    *&n; *  For the avoidance of doubt the &quot;preferred form&quot; of this *&n; *  code is one which is in an open non patent encumbered   *&n; *  format. Where cryptographic key signing forms part of   *&n; *  the process of creating an executable the information   *&n; *  including keys needed to generate an equivalently       *&n; *  functional executable are deemed to be part of the &t;    *&n; *  source code are deemed to be part of the source code.   *&n; *                                                          *&n; ************************************************************&n; *  last change: 2002/11/02               OS: Linux 2.5.45  *&n; ************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &lt;scsi/scsicam.h&gt;
macro_line|#include &quot;eata_generic.h&quot;
macro_line|#include &quot;eata_pio.h&quot;
DECL|variable|ISAbases
r_static
id|uint
id|ISAbases
(braket
id|MAXISA
)braket
op_assign
(brace
l_int|0x1F0
comma
l_int|0x170
comma
l_int|0x330
comma
l_int|0x230
)brace
suffix:semicolon
DECL|variable|ISAirqs
r_static
id|uint
id|ISAirqs
(braket
id|MAXISA
)braket
op_assign
(brace
l_int|14
comma
l_int|12
comma
l_int|15
comma
l_int|11
)brace
suffix:semicolon
DECL|variable|EISAbases
r_static
r_int
r_char
id|EISAbases
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
)brace
suffix:semicolon
DECL|variable|registered_HBAs
r_static
id|uint
id|registered_HBAs
suffix:semicolon
DECL|variable|last_HBA
r_static
r_struct
id|Scsi_Host
op_star
id|last_HBA
suffix:semicolon
DECL|variable|first_HBA
r_static
r_struct
id|Scsi_Host
op_star
id|first_HBA
suffix:semicolon
DECL|variable|reg_IRQ
r_static
r_int
r_char
id|reg_IRQ
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|reg_IRQL
r_static
r_int
r_char
id|reg_IRQL
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|int_counter
r_static
r_int
r_int
id|int_counter
suffix:semicolon
DECL|variable|queue_counter
r_static
r_int
r_int
id|queue_counter
suffix:semicolon
multiline_comment|/*&n; * eata_proc_info&n; * inout : decides on the direction of the dataflow and the meaning of the &n; *         variables&n; * buffer: If inout==FALSE data is being written to it else read from it&n; * *start: If inout==FALSE start of the valid data in the buffer&n; * offset: If inout==FALSE offset from the beginning of the imaginary file &n; *         from which we start writing into the buffer&n; * length: If inout==FALSE max number of bytes to be written into the buffer &n; *         else number of bytes in the buffer&n; */
DECL|function|eata_pio_proc_info
r_static
r_int
id|eata_pio_proc_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shost
comma
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|rw
)paren
(brace
r_static
id|u8
id|buff
(braket
l_int|512
)braket
suffix:semicolon
r_int
id|size
comma
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
comma
id|pos
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rw
)paren
r_return
op_minus
id|ENOSYS
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
l_int|0
)paren
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
r_sizeof
(paren
id|buff
)paren
)paren
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;EATA (Extended Attachment) PIO driver version: &quot;
l_string|&quot;%d.%d%s&bslash;n&quot;
comma
id|VER_MAJOR
comma
id|VER_MINOR
comma
id|VER_SUB
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;queued commands:     %10ld&bslash;n&quot;
l_string|&quot;processed interrupts:%10ld&bslash;n&quot;
comma
id|queue_counter
comma
id|int_counter
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;&bslash;nscsi%-2d: HBA %.10s&bslash;n&quot;
comma
id|shost-&gt;host_no
comma
id|SD
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;Firmware revision: v%s&bslash;n&quot;
comma
id|SD
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|revision
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;IO: PIO&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;Base IO : %#.4x&bslash;n&quot;
comma
(paren
id|u32
)paren
id|shost-&gt;base
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;Host Bus: %s&bslash;n&quot;
comma
(paren
id|SD
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|bustype
op_eq
l_char|&squot;P&squot;
)paren
ques
c_cond
l_string|&quot;PCI &quot;
suffix:colon
(paren
id|SD
c_func
(paren
id|shost
)paren
op_member_access_from_pointer
id|bustype
op_eq
l_char|&squot;E&squot;
)paren
ques
c_cond
l_string|&quot;EISA&quot;
suffix:colon
l_string|&quot;ISA &quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
r_goto
id|stop_output
suffix:semicolon
id|stop_output
suffix:colon
id|DBG
c_func
(paren
id|DBG_PROC
comma
id|printk
c_func
(paren
l_string|&quot;2pos: %ld offset: %ld len: %d&bslash;n&quot;
comma
id|pos
comma
id|offset
comma
id|len
)paren
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
multiline_comment|/* Start of wanted data */
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
multiline_comment|/* Start slop */
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
multiline_comment|/* Ending slop */
id|DBG
c_func
(paren
id|DBG_PROC
comma
id|printk
c_func
(paren
l_string|&quot;3pos: %ld offset: %ld len: %d&bslash;n&quot;
comma
id|pos
comma
id|offset
comma
id|len
)paren
)paren
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
DECL|function|eata_pio_release
r_static
r_int
id|eata_pio_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|sh
)paren
(brace
r_if
c_cond
(paren
id|sh-&gt;irq
op_logical_and
id|reg_IRQ
(braket
id|sh-&gt;irq
)braket
op_eq
l_int|1
)paren
id|free_irq
c_func
(paren
id|sh-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_else
id|reg_IRQ
(braket
id|sh-&gt;irq
)braket
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|channel
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sh-&gt;io_port
op_logical_and
id|sh-&gt;n_io_port
)paren
id|release_region
c_func
(paren
id|sh-&gt;io_port
comma
id|sh-&gt;n_io_port
)paren
suffix:semicolon
)brace
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
DECL|function|IncStat
r_static
r_void
id|IncStat
c_func
(paren
id|Scsi_Pointer
op_star
id|SCp
comma
id|uint
id|Increment
)paren
(brace
id|SCp-&gt;ptr
op_add_assign
id|Increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SCp-&gt;this_residual
op_sub_assign
id|Increment
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
op_decrement
id|SCp-&gt;buffers_residual
)paren
op_eq
l_int|0
)paren
id|SCp-&gt;Status
op_assign
id|FALSE
suffix:semicolon
r_else
(brace
id|SCp-&gt;buffer
op_increment
suffix:semicolon
id|SCp-&gt;ptr
op_assign
id|page_address
c_func
(paren
id|SCp-&gt;buffer-&gt;page
)paren
op_plus
id|SCp-&gt;buffer-&gt;offset
suffix:semicolon
id|SCp-&gt;this_residual
op_assign
id|SCp-&gt;buffer-&gt;length
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
id|eata_pio_int_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|function|do_eata_pio_int_handler
r_static
id|irqreturn_t
id|do_eata_pio_int_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|dev-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|eata_pio_int_handler
c_func
(paren
id|irq
comma
id|dev_id
comma
id|regs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|dev-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|eata_pio_int_handler
r_static
r_void
id|eata_pio_int_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|uint
id|eata_stat
op_assign
l_int|0xfffff
suffix:semicolon
id|Scsi_Cmnd
op_star
id|cmd
suffix:semicolon
id|hostdata
op_star
id|hd
suffix:semicolon
r_struct
id|eata_ccb
op_star
id|cp
suffix:semicolon
id|uint
id|base
suffix:semicolon
id|uint
id|x
comma
id|z
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
r_int
r_int
id|zwickel
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|stat
comma
id|odd
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|1
comma
id|sh
op_assign
id|first_HBA
suffix:semicolon
id|x
op_le
id|registered_HBAs
suffix:semicolon
id|x
op_increment
comma
id|sh
op_assign
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|prev
)paren
(brace
r_if
c_cond
(paren
id|sh-&gt;irq
op_ne
id|irq
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
(paren
id|uint
)paren
id|sh-&gt;base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SBUSY
)paren
r_continue
suffix:semicolon
id|int_counter
op_increment
suffix:semicolon
id|hd
op_assign
id|SD
c_func
(paren
id|sh
)paren
suffix:semicolon
id|cp
op_assign
op_amp
id|hd-&gt;ccb
(braket
l_int|0
)braket
suffix:semicolon
id|cmd
op_assign
id|cp-&gt;cmd
suffix:semicolon
id|base
op_assign
(paren
id|uint
)paren
id|cmd-&gt;device-&gt;host-&gt;base
suffix:semicolon
r_do
(brace
id|stat
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|HA_SDRQ
)paren
(brace
r_if
c_cond
(paren
id|cp-&gt;DataIn
)paren
(brace
id|z
op_assign
l_int|256
suffix:semicolon
id|odd
op_assign
id|FALSE
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cmd-&gt;SCp.Status
)paren
op_logical_and
(paren
(paren
id|z
OG
l_int|0
)paren
op_logical_or
(paren
id|odd
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|odd
)paren
(brace
op_star
(paren
id|cmd-&gt;SCp.ptr
)paren
op_assign
id|zwickel
op_rshift
l_int|8
suffix:semicolon
id|IncStat
c_func
(paren
op_amp
id|cmd-&gt;SCp
comma
l_int|1
)paren
suffix:semicolon
id|odd
op_assign
id|FALSE
suffix:semicolon
)brace
id|x
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|z
comma
id|cmd-&gt;SCp.this_residual
op_div
l_int|2
)paren
suffix:semicolon
id|insw
c_func
(paren
id|base
op_plus
id|HA_RDATA
comma
id|cmd-&gt;SCp.ptr
comma
id|x
)paren
suffix:semicolon
id|z
op_sub_assign
id|x
suffix:semicolon
id|IncStat
c_func
(paren
op_amp
id|cmd-&gt;SCp
comma
l_int|2
op_star
id|x
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|z
OG
l_int|0
)paren
op_logical_and
(paren
id|cmd-&gt;SCp.this_residual
op_eq
l_int|1
)paren
)paren
(brace
id|zwickel
op_assign
id|inw
c_func
(paren
id|base
op_plus
id|HA_RDATA
)paren
suffix:semicolon
op_star
(paren
id|cmd-&gt;SCp.ptr
)paren
op_assign
id|zwickel
op_amp
l_int|0xff
suffix:semicolon
id|IncStat
c_func
(paren
op_amp
id|cmd-&gt;SCp
comma
l_int|1
)paren
suffix:semicolon
id|z
op_decrement
suffix:semicolon
id|odd
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|z
OG
l_int|0
)paren
(brace
id|zwickel
op_assign
id|inw
c_func
(paren
id|base
op_plus
id|HA_RDATA
)paren
suffix:semicolon
id|z
op_decrement
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* cp-&gt;DataOut */
id|odd
op_assign
id|FALSE
suffix:semicolon
id|z
op_assign
l_int|256
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cmd-&gt;SCp.Status
)paren
op_logical_and
(paren
(paren
id|z
OG
l_int|0
)paren
op_logical_or
(paren
id|odd
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|odd
)paren
(brace
id|zwickel
op_add_assign
op_star
(paren
id|cmd-&gt;SCp.ptr
)paren
op_lshift
l_int|8
suffix:semicolon
id|IncStat
c_func
(paren
op_amp
id|cmd-&gt;SCp
comma
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
id|zwickel
comma
id|base
op_plus
id|HA_RDATA
)paren
suffix:semicolon
id|z
op_decrement
suffix:semicolon
id|odd
op_assign
id|FALSE
suffix:semicolon
)brace
id|x
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|z
comma
id|cmd-&gt;SCp.this_residual
op_div
l_int|2
)paren
suffix:semicolon
id|outsw
c_func
(paren
id|base
op_plus
id|HA_RDATA
comma
id|cmd-&gt;SCp.ptr
comma
id|x
)paren
suffix:semicolon
id|z
op_sub_assign
id|x
suffix:semicolon
id|IncStat
c_func
(paren
op_amp
id|cmd-&gt;SCp
comma
l_int|2
op_star
id|x
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|z
OG
l_int|0
)paren
op_logical_and
(paren
id|cmd-&gt;SCp.this_residual
op_eq
l_int|1
)paren
)paren
(brace
id|zwickel
op_assign
op_star
(paren
id|cmd-&gt;SCp.ptr
)paren
suffix:semicolon
id|zwickel
op_and_assign
l_int|0xff
suffix:semicolon
id|IncStat
c_func
(paren
op_amp
id|cmd-&gt;SCp
comma
l_int|1
)paren
suffix:semicolon
id|odd
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|z
OG
l_int|0
op_logical_or
id|odd
)paren
(brace
id|outw
c_func
(paren
id|zwickel
comma
id|base
op_plus
id|HA_RDATA
)paren
suffix:semicolon
id|z
op_decrement
suffix:semicolon
id|odd
op_assign
id|FALSE
suffix:semicolon
)brace
)brace
)brace
)brace
r_while
c_loop
(paren
(paren
id|stat
op_amp
id|HA_SDRQ
)paren
op_logical_or
(paren
(paren
id|stat
op_amp
id|HA_SMORE
)paren
op_logical_and
id|hd-&gt;moresupport
)paren
)paren
suffix:semicolon
multiline_comment|/* terminate handler if HBA goes busy again, i.e. transfers&n;&t;&t; * more data */
r_if
c_cond
(paren
id|stat
op_amp
id|HA_SBUSY
)paren
r_break
suffix:semicolon
multiline_comment|/* OK, this is quite stupid, but I haven&squot;t found any correct&n;&t;&t; * way to get HBA&amp;SCSI status so far */
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SERROR
)paren
)paren
(brace
id|cmd-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
suffix:semicolon
id|hd-&gt;devflags
op_or_assign
(paren
l_int|1
op_lshift
id|cp-&gt;cp_id
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hd-&gt;devflags
op_amp
l_int|1
op_lshift
id|cp-&gt;cp_id
)paren
id|cmd-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_plus
l_int|0x02
suffix:semicolon
r_else
id|cmd-&gt;result
op_assign
(paren
id|DID_NO_CONNECT
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;status
op_eq
id|LOCKED
)paren
(brace
id|cp-&gt;status
op_assign
id|FREE
suffix:semicolon
id|eata_stat
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;eata_pio: int_handler, freeing locked &quot;
l_string|&quot;queueslot&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if DBG_INTR2
r_if
c_cond
(paren
id|stat
op_ne
l_int|0x50
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;stat: %#.2x, result: %#.8x&bslash;n&quot;
comma
id|stat
comma
id|cmd-&gt;result
)paren
suffix:semicolon
macro_line|#endif
id|cp-&gt;status
op_assign
id|FREE
suffix:semicolon
multiline_comment|/* now we can release the slot  */
id|cmd
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|eata_pio_send_command
r_static
r_inline
id|uint
id|eata_pio_send_command
c_func
(paren
id|uint
id|base
comma
r_int
r_char
id|command
)paren
(brace
id|uint
id|loop
op_assign
id|HZ
op_div
l_int|2
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SBUSY
)paren
r_if
c_cond
(paren
op_decrement
id|loop
op_eq
l_int|0
)paren
r_return
(paren
id|TRUE
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts for HBA.  It is not the best way to do it at this&n;&t; * place, but I hope that it doesn&squot;t interfere with the IDE driver &n;&t; * initialization this way */
id|outb
c_func
(paren
id|HA_CTRL_8HEADS
comma
id|base
op_plus
id|HA_CTRLREG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|command
comma
id|base
op_plus
id|HA_WCOMMAND
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|eata_pio_queue
r_static
r_int
id|eata_pio_queue
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|uint
id|x
comma
id|y
suffix:semicolon
id|uint
id|base
suffix:semicolon
id|hostdata
op_star
id|hd
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
r_struct
id|eata_ccb
op_star
id|cp
suffix:semicolon
id|queue_counter
op_increment
suffix:semicolon
id|hd
op_assign
id|HD
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|sh
op_assign
id|cmd-&gt;device-&gt;host
suffix:semicolon
id|base
op_assign
(paren
id|uint
)paren
id|sh-&gt;base
suffix:semicolon
multiline_comment|/* use only slot 0, as 2001 can handle only one cmd at a time */
id|y
op_assign
id|x
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;ccb
(braket
id|y
)braket
dot
id|status
op_ne
id|FREE
)paren
(brace
id|DBG
c_func
(paren
id|DBG_QUEUE
comma
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;can_queue %d, x %d, y %d&bslash;n&quot;
comma
id|sh-&gt;can_queue
comma
id|x
comma
id|y
)paren
)paren
suffix:semicolon
macro_line|#if DEBUG_EATA
id|panic
c_func
(paren
id|KERN_EMERG
l_string|&quot;eata_pio: run out of queue slots cmdno:%ld &quot;
l_string|&quot;intrno: %ld&bslash;n&quot;
comma
id|queue_counter
comma
id|int_counter
)paren
suffix:semicolon
macro_line|#else
id|panic
c_func
(paren
id|KERN_EMERG
l_string|&quot;eata_pio: run out of queue slots....&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|cp
op_assign
op_amp
id|hd-&gt;ccb
(braket
id|y
)braket
suffix:semicolon
id|memset
c_func
(paren
id|cp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|eata_ccb
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cmd-&gt;sense_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|cmd-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|cp-&gt;status
op_assign
id|USED
suffix:semicolon
multiline_comment|/* claim free slot */
id|DBG
c_func
(paren
id|DBG_QUEUE
comma
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;eata_pio_queue pid %ld, target: %x, lun:&quot;
l_string|&quot; %x, y %d&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
comma
id|y
)paren
)paren
suffix:semicolon
id|cmd-&gt;scsi_done
op_assign
(paren
r_void
op_star
)paren
id|done
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;sc_data_direction
op_eq
id|SCSI_DATA_WRITE
)paren
(brace
id|cp-&gt;DataOut
op_assign
id|TRUE
suffix:semicolon
)brace
multiline_comment|/* Output mode */
r_else
id|cp-&gt;DataIn
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Input mode  */
id|cp-&gt;Interpret
op_assign
(paren
id|cmd-&gt;device-&gt;id
op_eq
id|hd-&gt;hostid
)paren
suffix:semicolon
id|cp-&gt;cp_datalen
op_assign
id|htonl
c_func
(paren
(paren
r_int
r_int
)paren
id|cmd-&gt;request_bufflen
)paren
suffix:semicolon
id|cp-&gt;Auto_Req_Sen
op_assign
id|FALSE
suffix:semicolon
id|cp-&gt;cp_reqDMA
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|cp-&gt;reqlen
op_assign
l_int|0
suffix:semicolon
id|cp-&gt;cp_id
op_assign
id|cmd-&gt;device-&gt;id
suffix:semicolon
id|cp-&gt;cp_lun
op_assign
id|cmd-&gt;device-&gt;lun
suffix:semicolon
id|cp-&gt;cp_dispri
op_assign
id|FALSE
suffix:semicolon
id|cp-&gt;cp_identify
op_assign
id|TRUE
suffix:semicolon
id|memcpy
c_func
(paren
id|cp-&gt;cp_cdb
comma
id|cmd-&gt;cmnd
comma
id|COMMAND_SIZE
c_func
(paren
op_star
id|cmd-&gt;cmnd
)paren
)paren
suffix:semicolon
id|cp-&gt;cp_statDMA
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|cp-&gt;cp_viraddr
op_assign
id|cp
suffix:semicolon
id|cp-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|cmd-&gt;host_scribble
op_assign
(paren
r_char
op_star
)paren
op_amp
id|hd-&gt;ccb
(braket
id|y
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;use_sg
op_eq
l_int|0
)paren
(brace
id|cmd-&gt;SCp.buffers_residual
op_assign
l_int|1
suffix:semicolon
id|cmd-&gt;SCp.ptr
op_assign
id|cmd-&gt;request_buffer
suffix:semicolon
id|cmd-&gt;SCp.this_residual
op_assign
id|cmd-&gt;request_bufflen
suffix:semicolon
id|cmd-&gt;SCp.buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|cmd-&gt;SCp.buffer
op_assign
id|cmd-&gt;request_buffer
suffix:semicolon
id|cmd-&gt;SCp.buffers_residual
op_assign
id|cmd-&gt;use_sg
suffix:semicolon
id|cmd-&gt;SCp.ptr
op_assign
id|page_address
c_func
(paren
id|cmd-&gt;SCp.buffer-&gt;page
)paren
op_plus
id|cmd-&gt;SCp.buffer-&gt;offset
suffix:semicolon
id|cmd-&gt;SCp.this_residual
op_assign
id|cmd-&gt;SCp.buffer-&gt;length
suffix:semicolon
)brace
id|cmd-&gt;SCp.Status
op_assign
(paren
id|cmd-&gt;SCp.this_residual
op_ne
l_int|0
)paren
suffix:semicolon
multiline_comment|/* TRUE as long as bytes &n;&t;&t;&t;&t;&t;&t;&t;&t; * are to transfer */
r_if
c_cond
(paren
id|eata_pio_send_command
c_func
(paren
id|base
comma
id|EATA_CMD_PIO_SEND_CP
)paren
)paren
(brace
id|cmd-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;eata_pio_queue target %d, pid %ld, HBA busy, &quot;
l_string|&quot;returning DID_BUS_BUSY, done.&bslash;n&quot;
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;pid
)paren
suffix:semicolon
id|done
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|cp-&gt;status
op_assign
id|FREE
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME: timeout */
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SDRQ
)paren
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
id|outsw
c_func
(paren
id|base
op_plus
id|HA_RDATA
comma
id|cp
comma
id|hd-&gt;cplen
)paren
suffix:semicolon
id|outb
c_func
(paren
id|EATA_CMD_PIO_TRUNC
comma
id|base
op_plus
id|HA_WCOMMAND
)paren
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|hd-&gt;cppadlen
suffix:semicolon
id|x
op_increment
)paren
id|outw
c_func
(paren
l_int|0
comma
id|base
op_plus
id|HA_RDATA
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_QUEUE
comma
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Queued base %#.4lx pid: %ld target: %x &quot;
l_string|&quot;lun: %x slot %d irq %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|sh-&gt;base
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
comma
id|y
comma
id|sh-&gt;irq
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|eata_pio_abort
r_static
r_int
id|eata_pio_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|uint
id|loop
op_assign
id|HZ
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio_abort called pid: %ld &quot;
l_string|&quot;target: %x lun: %x reason %x&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
comma
id|cmd-&gt;abort_reason
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|cmd-&gt;device-&gt;host-&gt;base
op_plus
id|HA_RAUXSTAT
)paren
op_amp
id|HA_ABUSY
)paren
r_if
c_cond
(paren
op_decrement
id|loop
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio: abort, timeout error.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|status
op_eq
id|FREE
)paren
(brace
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Returning: SCSI_ABORT_NOT_RUNNING&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|status
op_eq
id|USED
)paren
(brace
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Returning: SCSI_ABORT_BUSY&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* We want to sleep a bit more here */
r_return
id|FAILED
suffix:semicolon
multiline_comment|/* SNOOZE */
)brace
r_if
c_cond
(paren
id|CD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|status
op_eq
id|RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio: abort, command reset error.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|status
op_eq
id|LOCKED
)paren
(brace
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio: abort, queue slot &quot;
l_string|&quot;locked.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
id|panic
c_func
(paren
l_string|&quot;eata_pio: abort: invalid slot status&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|eata_pio_host_reset
r_static
r_int
id|eata_pio_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
id|uint
id|x
comma
id|limit
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|success
op_assign
id|FALSE
suffix:semicolon
id|Scsi_Cmnd
op_star
id|sp
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
op_assign
id|cmd-&gt;device-&gt;host
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio_reset called pid:%ld target:&quot;
l_string|&quot; %x lun: %x reason %x&bslash;n&quot;
comma
id|cmd-&gt;pid
comma
id|cmd-&gt;device-&gt;id
comma
id|cmd-&gt;device-&gt;lun
comma
id|cmd-&gt;abort_reason
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|state
op_eq
id|RESET
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio_reset: exit, already in reset.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
multiline_comment|/* force all slots to be free */
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|cmd-&gt;device-&gt;host-&gt;can_queue
suffix:semicolon
id|x
op_increment
)paren
(brace
r_if
c_cond
(paren
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|status
op_eq
id|FREE
)paren
r_continue
suffix:semicolon
id|sp
op_assign
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|cmd
suffix:semicolon
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|status
op_assign
id|RESET
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio_reset: slot %d in reset, pid %ld.&bslash;n&quot;
comma
id|x
comma
id|sp-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
l_int|NULL
)paren
id|panic
c_func
(paren
l_string|&quot;eata_pio_reset: slot %d, sp==NULL.&bslash;n&quot;
comma
id|x
)paren
suffix:semicolon
)brace
multiline_comment|/* hard reset the HBA  */
id|outb
c_func
(paren
id|EATA_CMD_RESET
comma
(paren
id|uint
)paren
id|cmd-&gt;device-&gt;host-&gt;base
op_plus
id|HA_WCOMMAND
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio_reset: board reset done.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|state
op_assign
id|RESET
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|host-&gt;host_lock
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|host-&gt;host_lock
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio_reset: interrupts disabled, &quot;
l_string|&quot;loops %d.&bslash;n&quot;
comma
id|limit
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|cmd-&gt;device-&gt;host-&gt;can_queue
suffix:semicolon
id|x
op_increment
)paren
(brace
multiline_comment|/* Skip slots already set free by interrupt */
r_if
c_cond
(paren
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|status
op_ne
id|RESET
)paren
r_continue
suffix:semicolon
id|sp
op_assign
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|cmd
suffix:semicolon
id|sp-&gt;result
op_assign
id|DID_RESET
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* This mailbox is terminated */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio_reset: reset ccb %d.&bslash;n&quot;
comma
id|x
)paren
suffix:semicolon
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|ccb
(braket
id|x
)braket
dot
id|status
op_assign
id|FREE
suffix:semicolon
id|sp
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
id|HD
c_func
(paren
id|cmd
)paren
op_member_access_from_pointer
id|state
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|success
)paren
(brace
multiline_comment|/* hmmm... */
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio_reset: exit, success.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
r_else
(brace
id|DBG
c_func
(paren
id|DBG_ABNORM
comma
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eata_pio_reset: exit, wakeup.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|FAILED
suffix:semicolon
)brace
)brace
DECL|function|get_pio_board_data
r_static
r_char
op_star
id|get_pio_board_data
c_func
(paren
r_int
r_int
id|base
comma
id|uint
id|irq
comma
id|uint
id|id
comma
r_int
r_int
id|cplen
comma
r_int
r_int
id|cppadlen
)paren
(brace
r_struct
id|eata_ccb
id|cp
suffix:semicolon
r_static
r_char
id|buff
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|z
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|eata_ccb
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
r_sizeof
(paren
id|buff
)paren
)paren
suffix:semicolon
id|cp.DataIn
op_assign
id|TRUE
suffix:semicolon
id|cp.Interpret
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* Interpret command */
id|cp.cp_datalen
op_assign
id|htonl
c_func
(paren
l_int|254
)paren
suffix:semicolon
id|cp.cp_dataDMA
op_assign
id|htonl
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|cp.cp_id
op_assign
id|id
suffix:semicolon
id|cp.cp_lun
op_assign
l_int|0
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|0
)braket
op_assign
id|INQUIRY
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|4
)braket
op_assign
l_int|254
suffix:semicolon
id|cp.cp_cdb
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|eata_pio_send_command
c_func
(paren
(paren
id|uint
)paren
id|base
comma
id|EATA_CMD_PIO_SEND_CP
)paren
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SDRQ
)paren
)paren
suffix:semicolon
id|outsw
c_func
(paren
id|base
op_plus
id|HA_RDATA
comma
op_amp
id|cp
comma
id|cplen
)paren
suffix:semicolon
id|outb
c_func
(paren
id|EATA_CMD_PIO_TRUNC
comma
id|base
op_plus
id|HA_WCOMMAND
)paren
suffix:semicolon
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|cppadlen
suffix:semicolon
id|z
op_increment
)paren
id|outw
c_func
(paren
l_int|0
comma
id|base
op_plus
id|HA_RDATA
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SERROR
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SDRQ
)paren
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
r_else
(brace
id|insw
c_func
(paren
id|base
op_plus
id|HA_RDATA
comma
op_amp
id|buff
comma
l_int|127
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SDRQ
)paren
id|inw
c_func
(paren
id|base
op_plus
id|HA_RDATA
)paren
suffix:semicolon
r_return
(paren
id|buff
)paren
suffix:semicolon
)brace
)brace
DECL|function|get_pio_conf_PIO
r_static
r_int
id|get_pio_conf_PIO
c_func
(paren
id|u32
id|base
comma
r_struct
id|get_conf
op_star
id|buf
)paren
(brace
r_int
r_int
id|loop
op_assign
id|HZ
op_div
l_int|2
suffix:semicolon
r_int
id|z
suffix:semicolon
r_int
r_int
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|base
comma
l_int|9
)paren
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|get_conf
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SBUSY
)paren
r_if
c_cond
(paren
op_decrement
id|loop
op_eq
l_int|0
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_PIO
op_logical_and
id|DBG_PROBE
comma
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Issuing PIO READ CONFIG to HBA at %#x&bslash;n&quot;
comma
id|base
)paren
)paren
suffix:semicolon
id|eata_pio_send_command
c_func
(paren
id|base
comma
id|EATA_CMD_PIO_READ_CONFIG
)paren
suffix:semicolon
id|loop
op_assign
id|HZ
op_div
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
id|buf
suffix:semicolon
(paren
r_int
)paren
id|p
op_le
(paren
(paren
r_int
)paren
id|buf
op_plus
(paren
r_sizeof
(paren
r_struct
id|get_conf
)paren
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|p
op_increment
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SDRQ
)paren
)paren
r_if
c_cond
(paren
op_decrement
id|loop
op_eq
l_int|0
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
id|loop
op_assign
id|HZ
op_div
l_int|2
suffix:semicolon
op_star
id|p
op_assign
id|inw
c_func
(paren
id|base
op_plus
id|HA_RDATA
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SERROR
)paren
)paren
(brace
multiline_comment|/* Error ? */
r_if
c_cond
(paren
id|htonl
c_func
(paren
id|EATA_SIGNATURE
)paren
op_eq
id|buf-&gt;signature
)paren
(brace
id|DBG
c_func
(paren
id|DBG_PIO
op_logical_and
id|DBG_PROBE
comma
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;EATA Controller found &quot;
l_string|&quot;at %#4x EATA Level: %x&bslash;n&quot;
comma
id|base
comma
(paren
id|uint
)paren
(paren
id|buf-&gt;version
)paren
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SDRQ
)paren
id|inw
c_func
(paren
id|base
op_plus
id|HA_RDATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ALLOW_DMA_BOARDS
op_eq
id|FALSE
)paren
(brace
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
id|MAXISA
suffix:semicolon
id|z
op_increment
)paren
r_if
c_cond
(paren
id|base
op_eq
id|ISAbases
(braket
id|z
)braket
)paren
(brace
id|buf-&gt;IRQ
op_assign
id|ISAirqs
(braket
id|z
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|DBG
c_func
(paren
id|DBG_PROBE
comma
id|printk
c_func
(paren
l_string|&quot;eata_dma: get_conf_PIO, error during transfer &quot;
l_string|&quot;for HBA at %x&bslash;n&quot;
comma
id|base
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
DECL|function|print_pio_config
r_static
r_void
id|print_pio_config
c_func
(paren
r_struct
id|get_conf
op_star
id|gc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Please check values: (read config data)&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;LEN: %d ver:%d OCS:%d TAR:%d TRNXFR:%d MORES:%d&bslash;n&quot;
comma
(paren
id|uint
)paren
id|ntohl
c_func
(paren
id|gc-&gt;len
)paren
comma
id|gc-&gt;version
comma
id|gc-&gt;OCS_enabled
comma
id|gc-&gt;TAR_support
comma
id|gc-&gt;TRNXFR
comma
id|gc-&gt;MORE_support
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HAAV:%d SCSIID0:%d ID1:%d ID2:%d QUEUE:%d SG:%d SEC:%d&bslash;n&quot;
comma
id|gc-&gt;HAA_valid
comma
id|gc-&gt;scsi_id
(braket
l_int|3
)braket
comma
id|gc-&gt;scsi_id
(braket
l_int|2
)braket
comma
id|gc-&gt;scsi_id
(braket
l_int|1
)braket
comma
id|ntohs
c_func
(paren
id|gc-&gt;queuesiz
)paren
comma
id|ntohs
c_func
(paren
id|gc-&gt;SGsiz
)paren
comma
id|gc-&gt;SECOND
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;IRQ:%d IRQT:%d FORCADR:%d MCH:%d RIDQ:%d&bslash;n&quot;
comma
id|gc-&gt;IRQ
comma
id|gc-&gt;IRQ_TR
comma
id|gc-&gt;FORCADR
comma
id|gc-&gt;MAX_CHAN
comma
id|gc-&gt;ID_qest
)paren
suffix:semicolon
)brace
DECL|function|print_selftest
r_static
id|uint
id|print_selftest
c_func
(paren
id|uint
id|base
)paren
(brace
r_int
r_char
id|buffer
(braket
l_int|512
)braket
suffix:semicolon
macro_line|#ifdef VERBOSE_SETUP
r_int
id|z
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;eata_pio: executing controller self test &amp; setup...&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SBUSY
)paren
suffix:semicolon
id|outb
c_func
(paren
id|EATA_CMD_PIO_SETUPTEST
comma
id|base
op_plus
id|HA_WCOMMAND
)paren
suffix:semicolon
r_do
(brace
r_while
c_loop
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SBUSY
)paren
multiline_comment|/* nothing */
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SDRQ
)paren
(brace
id|insw
c_func
(paren
id|base
op_plus
id|HA_RDATA
comma
op_amp
id|buffer
comma
l_int|256
)paren
suffix:semicolon
macro_line|#ifdef VERBOSE_SETUP
multiline_comment|/* no beeps please... */
r_for
c_loop
(paren
id|z
op_assign
l_int|0
suffix:semicolon
id|z
OL
l_int|511
op_logical_and
id|buffer
(braket
id|z
)braket
suffix:semicolon
id|z
op_increment
)paren
r_if
c_cond
(paren
id|buffer
(braket
id|z
)braket
op_ne
l_int|7
)paren
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
id|buffer
(braket
id|z
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_while
c_loop
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
(paren
id|HA_SBUSY
op_or
id|HA_SDRQ
)paren
)paren
suffix:semicolon
r_return
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|base
op_plus
id|HA_RSTATUS
)paren
op_amp
id|HA_SERROR
)paren
)paren
suffix:semicolon
)brace
DECL|function|register_pio_HBA
r_static
r_int
id|register_pio_HBA
c_func
(paren
r_int
id|base
comma
r_struct
id|get_conf
op_star
id|gc
comma
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|buff
suffix:semicolon
r_int
r_int
id|cplen
suffix:semicolon
r_int
r_int
id|cppadlen
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|sh
suffix:semicolon
id|hostdata
op_star
id|hd
suffix:semicolon
id|DBG
c_func
(paren
id|DBG_REGISTER
comma
id|print_pio_config
c_func
(paren
id|gc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gc-&gt;DMA_support
op_eq
id|TRUE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HBA at %#.4lx supports DMA. Please use EATA-DMA driver.&bslash;n&quot;
comma
id|base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ALLOW_DMA_BOARDS
op_eq
id|FALSE
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|buff
op_assign
id|get_pio_board_data
c_func
(paren
(paren
id|uint
)paren
id|base
comma
id|gc-&gt;IRQ
comma
id|gc-&gt;scsi_id
(braket
l_int|3
)braket
comma
id|cplen
op_assign
(paren
id|htonl
c_func
(paren
id|gc-&gt;cplen
)paren
op_plus
l_int|1
)paren
op_div
l_int|2
comma
id|cppadlen
op_assign
(paren
id|htons
c_func
(paren
id|gc-&gt;cppadlen
)paren
op_plus
l_int|1
)paren
op_div
l_int|2
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HBA at %#lx didn&squot;t react on INQUIRY. Sorry.&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|base
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|print_selftest
c_func
(paren
id|base
)paren
op_eq
id|FALSE
op_logical_and
id|ALLOW_DMA_BOARDS
op_eq
id|FALSE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HBA at %#lx failed while performing self test &amp; setup.&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|base
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|base
comma
l_int|8
comma
l_string|&quot;eata_pio&quot;
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|hostdata
)paren
op_plus
(paren
r_sizeof
(paren
r_struct
id|eata_ccb
)paren
op_star
id|ntohs
c_func
(paren
id|gc-&gt;queuesiz
)paren
)paren
suffix:semicolon
id|sh
op_assign
id|scsi_register
c_func
(paren
id|tpnt
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh
op_eq
l_int|NULL
)paren
(brace
id|release_region
c_func
(paren
id|base
comma
l_int|8
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
)paren
(brace
multiline_comment|/* Interrupt already registered ? */
r_if
c_cond
(paren
op_logical_neg
id|request_irq
c_func
(paren
id|gc-&gt;IRQ
comma
id|do_eata_pio_int_handler
comma
id|SA_INTERRUPT
comma
l_string|&quot;EATA-PIO&quot;
comma
id|sh
)paren
)paren
(brace
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gc-&gt;IRQ_TR
)paren
id|reg_IRQL
(braket
id|gc-&gt;IRQ
)braket
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/* IRQ is edge triggered */
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Couldn&squot;t allocate IRQ %d, Sorry.&bslash;n&quot;
comma
id|gc-&gt;IRQ
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|base
comma
l_int|8
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* More than one HBA on this IRQ */
r_if
c_cond
(paren
id|reg_IRQL
(braket
id|gc-&gt;IRQ
)braket
op_eq
id|TRUE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Can&squot;t support more than one HBA on this IRQ,&bslash;n&quot;
l_string|&quot;  if the IRQ is edge triggered. Sorry.&bslash;n&quot;
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|base
comma
l_int|8
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_else
id|reg_IRQ
(braket
id|gc-&gt;IRQ
)braket
op_increment
suffix:semicolon
)brace
id|hd
op_assign
id|SD
c_func
(paren
id|sh
)paren
suffix:semicolon
id|memset
c_func
(paren
id|hd-&gt;ccb
comma
l_int|0
comma
(paren
r_sizeof
(paren
r_struct
id|eata_ccb
)paren
op_star
id|ntohs
c_func
(paren
id|gc-&gt;queuesiz
)paren
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|hd-&gt;reads
comma
l_int|0
comma
r_sizeof
(paren
r_int
r_int
)paren
op_star
l_int|26
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|vendor
comma
op_amp
id|buff
(braket
l_int|8
)braket
comma
r_sizeof
(paren
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|vendor
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|name
comma
op_amp
id|buff
(braket
l_int|16
)braket
comma
r_sizeof
(paren
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|name
)paren
)paren
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|0
)braket
op_assign
id|buff
(braket
l_int|32
)braket
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|1
)braket
op_assign
id|buff
(braket
l_int|33
)braket
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|2
)braket
op_assign
id|buff
(braket
l_int|34
)braket
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|3
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|4
)braket
op_assign
id|buff
(braket
l_int|35
)braket
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|revision
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|ntohl
c_func
(paren
id|gc-&gt;len
)paren
)paren
(brace
r_case
l_int|0x1c
suffix:colon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|EATA_revision
op_assign
l_char|&squot;a&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1e
suffix:colon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|EATA_revision
op_assign
l_char|&squot;b&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x22
suffix:colon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|EATA_revision
op_assign
l_char|&squot;c&squot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x24
suffix:colon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|EATA_revision
op_assign
l_char|&squot;z&squot;
suffix:semicolon
r_default
suffix:colon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|EATA_revision
op_assign
l_char|&squot;?&squot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohl
c_func
(paren
id|gc-&gt;len
)paren
op_ge
l_int|0x22
)paren
(brace
r_if
c_cond
(paren
id|gc-&gt;is_PCI
op_eq
id|TRUE
)paren
id|hd-&gt;bustype
op_assign
id|IS_PCI
suffix:semicolon
r_else
r_if
c_cond
(paren
id|gc-&gt;is_EISA
op_eq
id|TRUE
)paren
id|hd-&gt;bustype
op_assign
id|IS_EISA
suffix:semicolon
r_else
id|hd-&gt;bustype
op_assign
id|IS_ISA
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|buff
(braket
l_int|21
)braket
op_eq
l_char|&squot;4&squot;
)paren
id|hd-&gt;bustype
op_assign
id|IS_PCI
suffix:semicolon
r_else
r_if
c_cond
(paren
id|buff
(braket
l_int|21
)braket
op_eq
l_char|&squot;2&squot;
)paren
id|hd-&gt;bustype
op_assign
id|IS_EISA
suffix:semicolon
r_else
id|hd-&gt;bustype
op_assign
id|IS_ISA
suffix:semicolon
)brace
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|cplen
op_assign
id|cplen
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|cppadlen
op_assign
id|cppadlen
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|hostid
op_assign
id|gc-&gt;scsi_id
(braket
l_int|3
)braket
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|devflags
op_assign
l_int|1
op_lshift
id|gc-&gt;scsi_id
(braket
l_int|3
)braket
suffix:semicolon
id|SD
c_func
(paren
id|sh
)paren
op_member_access_from_pointer
id|moresupport
op_assign
id|gc-&gt;MORE_support
suffix:semicolon
id|sh-&gt;unique_id
op_assign
id|base
suffix:semicolon
id|sh-&gt;base
op_assign
id|base
suffix:semicolon
id|sh-&gt;io_port
op_assign
id|base
suffix:semicolon
id|sh-&gt;n_io_port
op_assign
l_int|8
suffix:semicolon
id|sh-&gt;irq
op_assign
id|gc-&gt;IRQ
suffix:semicolon
id|sh-&gt;dma_channel
op_assign
id|PIO
suffix:semicolon
id|sh-&gt;this_id
op_assign
id|gc-&gt;scsi_id
(braket
l_int|3
)braket
suffix:semicolon
id|sh-&gt;can_queue
op_assign
l_int|1
suffix:semicolon
id|sh-&gt;cmd_per_lun
op_assign
l_int|1
suffix:semicolon
id|sh-&gt;sg_tablesize
op_assign
id|SG_ALL
suffix:semicolon
id|hd-&gt;channel
op_assign
l_int|0
suffix:semicolon
id|sh-&gt;max_id
op_assign
l_int|8
suffix:semicolon
id|sh-&gt;max_lun
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|gc-&gt;SECOND
)paren
id|hd-&gt;primary
op_assign
id|FALSE
suffix:semicolon
r_else
id|hd-&gt;primary
op_assign
id|TRUE
suffix:semicolon
id|sh-&gt;unchecked_isa_dma
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* We can only do PIO */
id|hd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* build a linked list of all HBAs */
id|hd-&gt;prev
op_assign
id|last_HBA
suffix:semicolon
r_if
c_cond
(paren
id|hd-&gt;prev
op_ne
l_int|NULL
)paren
id|SD
c_func
(paren
id|hd-&gt;prev
)paren
op_member_access_from_pointer
id|next
op_assign
id|sh
suffix:semicolon
id|last_HBA
op_assign
id|sh
suffix:semicolon
r_if
c_cond
(paren
id|first_HBA
op_eq
l_int|NULL
)paren
id|first_HBA
op_assign
id|sh
suffix:semicolon
id|registered_HBAs
op_increment
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|find_pio_ISA
r_static
r_void
id|find_pio_ISA
c_func
(paren
r_struct
id|get_conf
op_star
id|buf
comma
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXISA
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ISAbases
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|get_pio_conf_PIO
c_func
(paren
id|ISAbases
(braket
id|i
)braket
comma
id|buf
)paren
op_eq
id|TRUE
)paren
(brace
id|register_pio_HBA
c_func
(paren
id|ISAbases
(braket
id|i
)braket
comma
id|buf
comma
id|tpnt
)paren
suffix:semicolon
)brace
id|ISAbases
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
DECL|function|find_pio_EISA
r_static
r_void
id|find_pio_EISA
c_func
(paren
r_struct
id|get_conf
op_star
id|buf
comma
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
id|u32
id|base
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if CHECKPAL
id|u8
id|pal1
comma
id|pal2
comma
id|pal3
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXEISA
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|EISAbases
(braket
id|i
)braket
op_eq
id|TRUE
)paren
(brace
multiline_comment|/* Still a possibility ?          */
id|base
op_assign
l_int|0x1c88
op_plus
(paren
id|i
op_star
l_int|0x1000
)paren
suffix:semicolon
macro_line|#if CHECKPAL
id|pal1
op_assign
id|inb
c_func
(paren
(paren
id|u16
)paren
id|base
op_minus
l_int|8
)paren
suffix:semicolon
id|pal2
op_assign
id|inb
c_func
(paren
(paren
id|u16
)paren
id|base
op_minus
l_int|7
)paren
suffix:semicolon
id|pal3
op_assign
id|inb
c_func
(paren
(paren
id|u16
)paren
id|base
op_minus
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|pal1
op_eq
l_int|0x12
)paren
op_logical_and
(paren
id|pal2
op_eq
l_int|0x14
)paren
)paren
op_logical_or
(paren
(paren
id|pal1
op_eq
l_int|0x38
)paren
op_logical_and
(paren
id|pal2
op_eq
l_int|0xa3
)paren
op_logical_and
(paren
id|pal3
op_eq
l_int|0x82
)paren
)paren
op_logical_or
(paren
(paren
id|pal1
op_eq
l_int|0x06
)paren
op_logical_and
(paren
id|pal2
op_eq
l_int|0x94
)paren
op_logical_and
(paren
id|pal3
op_eq
l_int|0x24
)paren
)paren
)paren
(brace
id|DBG
c_func
(paren
id|DBG_PROBE
comma
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;EISA EATA id tags found: &quot;
l_string|&quot;%x %x %x &bslash;n&quot;
comma
(paren
r_int
)paren
id|pal1
comma
(paren
r_int
)paren
id|pal2
comma
(paren
r_int
)paren
id|pal3
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|get_pio_conf_PIO
c_func
(paren
id|base
comma
id|buf
)paren
op_eq
id|TRUE
)paren
(brace
id|DBG
c_func
(paren
id|DBG_PROBE
op_logical_and
id|DBG_EISA
comma
id|print_pio_config
c_func
(paren
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;IRQ
)paren
(brace
id|register_pio_HBA
c_func
(paren
id|base
comma
id|buf
comma
id|tpnt
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;eata_dma: No valid IRQ. HBA &quot;
l_string|&quot;removed from list&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Nothing found here so we take it from the list */
id|EISAbases
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#if CHECKPAL
)brace
macro_line|#endif
)brace
)brace
r_return
suffix:semicolon
)brace
DECL|function|find_pio_PCI
r_static
r_void
id|find_pio_PCI
c_func
(paren
r_struct
id|get_conf
op_star
id|buf
comma
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
macro_line|#ifndef CONFIG_PCI
id|printk
c_func
(paren
l_string|&quot;eata_dma: kernel PCI support not enabled. Skipping scan for PCI HBAs.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|base
comma
id|x
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_DPT
comma
id|PCI_DEVICE_ID_DPT
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
id|DBG_PROBE
op_logical_and
id|DBG_PCI
comma
id|printk
c_func
(paren
l_string|&quot;eata_pio: find_PCI, HBA at %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
r_continue
suffix:semicolon
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
id|base
op_assign
id|pci_resource_flags
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
op_amp
id|IORESOURCE_MEM
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;eata_pio: invalid base address of device %s&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|base
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* EISA tag there ? */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|base
)paren
op_eq
l_int|0x12
)paren
op_logical_and
(paren
id|inb
c_func
(paren
id|base
op_plus
l_int|1
)paren
op_eq
l_int|0x14
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Jep, it&squot;s forced, so move on  */
id|base
op_add_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Now, THIS is the real address */
r_if
c_cond
(paren
id|base
op_ne
l_int|0x1f8
)paren
(brace
multiline_comment|/* We didn&squot;t find it in the primary search */
r_if
c_cond
(paren
id|get_pio_conf_PIO
c_func
(paren
id|base
comma
id|buf
)paren
op_eq
id|TRUE
)paren
(brace
r_if
c_cond
(paren
id|buf-&gt;FORCADR
)paren
multiline_comment|/* If the address is forced */
r_continue
suffix:semicolon
multiline_comment|/* we&squot;ll find it later      */
multiline_comment|/* OK. We made it till here, so we can go now  &n;&t;&t;&t;&t; * and register it. We  only have to check and &n;&t;&t;&t;&t; * eventually remove it from the EISA and ISA list &n;&t;&t;&t;&t; */
id|register_pio_HBA
c_func
(paren
id|base
comma
id|buf
comma
id|tpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
OL
l_int|0x1000
)paren
(brace
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|MAXISA
suffix:semicolon
op_increment
id|x
)paren
(brace
r_if
c_cond
(paren
id|ISAbases
(braket
id|x
)braket
op_eq
id|base
)paren
(brace
id|ISAbases
(braket
id|x
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|base
op_amp
l_int|0x0fff
)paren
op_eq
l_int|0x0c88
)paren
(brace
id|x
op_assign
(paren
id|base
op_rshift
l_int|12
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|EISAbases
(braket
id|x
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#if CHECK_BLINK
r_else
r_if
c_cond
(paren
id|check_blink_state
c_func
(paren
id|base
)paren
op_eq
id|TRUE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;eata_pio: HBA is in BLINK state.&bslash;n&quot;
l_string|&quot;Consult your HBAs manual to correct this.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* #ifndef CONFIG_PCI */
)brace
DECL|function|eata_pio_detect
r_static
r_int
id|eata_pio_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|HBA_ptr
suffix:semicolon
r_struct
id|get_conf
id|gc
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tpnt-&gt;proc_name
op_assign
l_string|&quot;eata_pio&quot;
suffix:semicolon
id|find_pio_PCI
c_func
(paren
op_amp
id|gc
comma
id|tpnt
)paren
suffix:semicolon
id|find_pio_EISA
c_func
(paren
op_amp
id|gc
comma
id|tpnt
)paren
suffix:semicolon
id|find_pio_ISA
c_func
(paren
op_amp
id|gc
comma
id|tpnt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|MAXIRQ
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|reg_IRQ
(braket
id|i
)braket
)paren
id|request_irq
c_func
(paren
id|i
comma
id|do_eata_pio_int_handler
comma
id|SA_INTERRUPT
comma
l_string|&quot;EATA-PIO&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|HBA_ptr
op_assign
id|first_HBA
suffix:semicolon
r_if
c_cond
(paren
id|registered_HBAs
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;EATA (Extended Attachment) PIO driver version: %d.%d%s&bslash;n&quot;
l_string|&quot;(c) 1993-95 Michael Neuffer, neuffer@goofy.zdv.uni-mainz.de&bslash;n&quot;
l_string|&quot;            Alfred Arnold,   a.arnold@kfa-juelich.de&bslash;n&quot;
l_string|&quot;This release only supports DASD devices (harddisks)&bslash;n&quot;
comma
id|VER_MAJOR
comma
id|VER_MINOR
comma
id|VER_SUB
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Registered HBAs:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HBA no. Boardtype: Revis: EATA: Bus: BaseIO: IRQ: Ch: ID: Pr:&quot;
l_string|&quot; QS: SG: CPL:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|registered_HBAs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scsi%-2d: %.10s v%s 2.0%c  %s %#.4x   %2d   %d   %d   %c&quot;
l_string|&quot;  %2d  %2d  %2d&bslash;n&quot;
comma
id|HBA_ptr-&gt;host_no
comma
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|name
comma
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|revision
comma
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|EATA_revision
comma
(paren
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|bustype
op_eq
l_char|&squot;P&squot;
)paren
ques
c_cond
l_string|&quot;PCI &quot;
suffix:colon
(paren
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|bustype
op_eq
l_char|&squot;E&squot;
)paren
ques
c_cond
l_string|&quot;EISA&quot;
suffix:colon
l_string|&quot;ISA &quot;
comma
(paren
id|uint
)paren
id|HBA_ptr-&gt;base
comma
id|HBA_ptr-&gt;irq
comma
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|channel
comma
id|HBA_ptr-&gt;this_id
comma
(paren
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|primary
op_eq
id|TRUE
)paren
ques
c_cond
l_char|&squot;Y&squot;
suffix:colon
l_char|&squot;N&squot;
comma
id|HBA_ptr-&gt;can_queue
comma
id|HBA_ptr-&gt;sg_tablesize
comma
id|HBA_ptr-&gt;cmd_per_lun
)paren
suffix:semicolon
id|HBA_ptr
op_assign
id|SD
c_func
(paren
id|HBA_ptr
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)brace
r_return
(paren
id|registered_HBAs
)paren
suffix:semicolon
)brace
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
(brace
dot
id|proc_info
op_assign
id|eata_pio_proc_info
comma
dot
id|name
op_assign
l_string|&quot;EATA (Extended Attachment) PIO driver&quot;
comma
dot
id|detect
op_assign
id|eata_pio_detect
comma
dot
id|release
op_assign
id|eata_pio_release
comma
dot
id|queuecommand
op_assign
id|eata_pio_queue
comma
dot
id|eh_abort_handler
op_assign
id|eata_pio_abort
comma
dot
id|eh_host_reset_handler
op_assign
id|eata_pio_host_reset
comma
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Michael Neuffer, Alfred Arnold&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;EATA SCSI PIO driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
