multiline_comment|/*&n; *  History:&n; *  Started: Aug 9 by Lawrence Foard (entropy@world.std.com),&n; *           to allow user process control of SCSI devices.&n; *  Development Sponsored by Killy Corp. NY NY&n; *&n; * Original driver (sg.c):&n; *        Copyright (C) 1992 Lawrence Foard&n; * Version 2 and 3 extensions to driver:&n; *        Copyright (C) 1998 - 2004 Douglas Gilbert&n; *&n; *  Modified  19-JAN-1998  Richard Gooch &lt;rgooch@atnf.csiro.au&gt;  Devfs support&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; */
DECL|variable|sg_version_num
r_static
r_int
id|sg_version_num
op_assign
l_int|30531
suffix:semicolon
multiline_comment|/* 2 digits for each component */
DECL|macro|SG_VERSION_STR
mdefine_line|#define SG_VERSION_STR &quot;3.5.31&quot;
multiline_comment|/*&n; *  D. P. Gilbert (dgilbert@interlog.com, dougg@triode.net.au), notes:&n; *      - scsi logging is available via SCSI_LOG_TIMEOUT macros. First&n; *        the kernel/module needs to be built with CONFIG_SCSI_LOGGING&n; *        (otherwise the macros compile to empty statements).&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mtio.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/cdev.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &lt;scsi/scsi_driver.h&gt;
macro_line|#include &lt;scsi/scsi_ioctl.h&gt;
macro_line|#include &lt;scsi/sg.h&gt;
macro_line|#include &quot;scsi_logging.h&quot;
macro_line|#ifdef CONFIG_SCSI_PROC_FS
macro_line|#include &lt;linux/proc_fs.h&gt;
DECL|variable|sg_version_date
r_static
r_char
op_star
id|sg_version_date
op_assign
l_string|&quot;20040516&quot;
suffix:semicolon
r_static
r_int
id|sg_proc_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|sg_proc_cleanup
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifndef LINUX_VERSION_CODE
macro_line|#include &lt;linux/version.h&gt;
macro_line|#endif&t;&t;&t;&t;/* LINUX_VERSION_CODE */
DECL|macro|SG_ALLOW_DIO_DEF
mdefine_line|#define SG_ALLOW_DIO_DEF 0
DECL|macro|SG_ALLOW_DIO_CODE
mdefine_line|#define SG_ALLOW_DIO_CODE /* compile out by commenting this define */
DECL|macro|SG_MAX_DEVS
mdefine_line|#define SG_MAX_DEVS 32768
multiline_comment|/*&n; * Suppose you want to calculate the formula muldiv(x,m,d)=int(x * m / d)&n; * Then when using 32 bit integers x * m may overflow during the calculation.&n; * Replacing muldiv(x) by muldiv(x)=((x % d) * m) / d + int(x / d) * m&n; * calculates the same, but prevents the overflow when both m and d&n; * are &quot;small&quot; numbers (like HZ and USER_HZ).&n; * Of course an overflow is inavoidable if the result of muldiv doesn&squot;t fit&n; * in 32 bits.&n; */
DECL|macro|MULDIV
mdefine_line|#define MULDIV(X,MUL,DIV) ((((X % DIV) * MUL) / DIV) + ((X / DIV) * MUL))
DECL|macro|SG_DEFAULT_TIMEOUT
mdefine_line|#define SG_DEFAULT_TIMEOUT MULDIV(SG_DEFAULT_TIMEOUT_USER, HZ, USER_HZ)
DECL|variable|sg_big_buff
r_int
id|sg_big_buff
op_assign
id|SG_DEF_RESERVED_SIZE
suffix:semicolon
multiline_comment|/* N.B. This variable is readable and writeable via&n;   /proc/scsi/sg/def_reserved_size . Each time sg_open() is called a buffer&n;   of this size (or less if there is not enough memory) will be reserved&n;   for use by this file descriptor. [Deprecated usage: this variable is also&n;   readable via /proc/sys/kernel/sg-big-buff if the sg driver is built into&n;   the kernel (i.e. it is not a module).] */
DECL|variable|def_reserved_size
r_static
r_int
id|def_reserved_size
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* picks up init parameter */
DECL|variable|sg_allow_dio
r_static
r_int
id|sg_allow_dio
op_assign
id|SG_ALLOW_DIO_DEF
suffix:semicolon
DECL|macro|SG_SECTOR_SZ
mdefine_line|#define SG_SECTOR_SZ 512
DECL|macro|SG_SECTOR_MSK
mdefine_line|#define SG_SECTOR_MSK (SG_SECTOR_SZ - 1)
DECL|macro|SG_DEV_ARR_LUMP
mdefine_line|#define SG_DEV_ARR_LUMP 32&t;/* amount to over allocate sg_dev_arr by */
r_static
r_int
id|sg_add
c_func
(paren
r_struct
id|class_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|sg_remove
c_func
(paren
r_struct
id|class_device
op_star
)paren
suffix:semicolon
DECL|variable|dummy_cmdp
r_static
id|Scsi_Request
op_star
id|dummy_cmdp
suffix:semicolon
multiline_comment|/* only used for sizeof */
DECL|variable|sg_dev_arr_lock
r_static
id|rwlock_t
id|sg_dev_arr_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* Also used to lock&n;&t;&t;&t;&t;&t;&t;&t;   file descriptor list for device */
DECL|variable|sg_interface
r_static
r_struct
id|class_interface
id|sg_interface
op_assign
(brace
dot
id|add
op_assign
id|sg_add
comma
dot
id|remove
op_assign
id|sg_remove
comma
)brace
suffix:semicolon
DECL|struct|sg_scatter_hold
r_typedef
r_struct
id|sg_scatter_hold
(brace
multiline_comment|/* holding area for scsi scatter gather info */
DECL|member|k_use_sg
r_int
r_int
id|k_use_sg
suffix:semicolon
multiline_comment|/* Count of kernel scatter-gather pieces */
DECL|member|sglist_len
r_int
r_int
id|sglist_len
suffix:semicolon
multiline_comment|/* size of malloc&squot;d scatter-gather list ++ */
DECL|member|bufflen
r_int
id|bufflen
suffix:semicolon
multiline_comment|/* Size of (aggregate) data buffer */
DECL|member|b_malloc_len
r_int
id|b_malloc_len
suffix:semicolon
multiline_comment|/* actual len malloc&squot;ed in buffer */
DECL|member|buffer
r_void
op_star
id|buffer
suffix:semicolon
multiline_comment|/* Data buffer or scatter list (k_use_sg&gt;0) */
DECL|member|dio_in_use
r_char
id|dio_in_use
suffix:semicolon
multiline_comment|/* 0-&gt;indirect IO (or mmap), 1-&gt;dio */
DECL|member|cmd_opcode
r_int
r_char
id|cmd_opcode
suffix:semicolon
multiline_comment|/* first byte of command */
DECL|typedef|Sg_scatter_hold
)brace
id|Sg_scatter_hold
suffix:semicolon
r_struct
id|sg_device
suffix:semicolon
multiline_comment|/* forward declarations */
r_struct
id|sg_fd
suffix:semicolon
DECL|struct|sg_request
r_typedef
r_struct
id|sg_request
(brace
multiline_comment|/* SG_MAX_QUEUE requests outstanding per file */
DECL|member|my_cmdp
id|Scsi_Request
op_star
id|my_cmdp
suffix:semicolon
multiline_comment|/* != 0  when request with lower levels */
DECL|member|nextrp
r_struct
id|sg_request
op_star
id|nextrp
suffix:semicolon
multiline_comment|/* NULL -&gt; tail request (slist) */
DECL|member|parentfp
r_struct
id|sg_fd
op_star
id|parentfp
suffix:semicolon
multiline_comment|/* NULL -&gt; not in use */
DECL|member|data
id|Sg_scatter_hold
id|data
suffix:semicolon
multiline_comment|/* hold buffer, perhaps scatter list */
DECL|member|header
id|sg_io_hdr_t
id|header
suffix:semicolon
multiline_comment|/* scsi command+info, see &lt;scsi/sg.h&gt; */
DECL|member|sense_b
r_int
r_char
id|sense_b
(braket
r_sizeof
(paren
id|dummy_cmdp-&gt;sr_sense_buffer
)paren
)braket
suffix:semicolon
DECL|member|res_used
r_char
id|res_used
suffix:semicolon
multiline_comment|/* 1 -&gt; using reserve buffer, 0 -&gt; not ... */
DECL|member|orphan
r_char
id|orphan
suffix:semicolon
multiline_comment|/* 1 -&gt; drop on sight, 0 -&gt; normal */
DECL|member|sg_io_owned
r_char
id|sg_io_owned
suffix:semicolon
multiline_comment|/* 1 -&gt; packet belongs to SG_IO */
DECL|member|done
r_volatile
r_char
id|done
suffix:semicolon
multiline_comment|/* 0-&gt;before bh, 1-&gt;before read, 2-&gt;read */
DECL|typedef|Sg_request
)brace
id|Sg_request
suffix:semicolon
DECL|struct|sg_fd
r_typedef
r_struct
id|sg_fd
(brace
multiline_comment|/* holds the state of a file descriptor */
DECL|member|nextfp
r_struct
id|sg_fd
op_star
id|nextfp
suffix:semicolon
multiline_comment|/* NULL when last opened fd on this device */
DECL|member|parentdp
r_struct
id|sg_device
op_star
id|parentdp
suffix:semicolon
multiline_comment|/* owning device */
DECL|member|read_wait
id|wait_queue_head_t
id|read_wait
suffix:semicolon
multiline_comment|/* queue read until command done */
DECL|member|rq_list_lock
id|rwlock_t
id|rq_list_lock
suffix:semicolon
multiline_comment|/* protect access to list in req_arr */
DECL|member|timeout
r_int
id|timeout
suffix:semicolon
multiline_comment|/* defaults to SG_DEFAULT_TIMEOUT      */
DECL|member|timeout_user
r_int
id|timeout_user
suffix:semicolon
multiline_comment|/* defaults to SG_DEFAULT_TIMEOUT_USER */
DECL|member|reserve
id|Sg_scatter_hold
id|reserve
suffix:semicolon
multiline_comment|/* buffer held for this file descriptor */
DECL|member|save_scat_len
r_int
id|save_scat_len
suffix:semicolon
multiline_comment|/* original length of trunc. scat. element */
DECL|member|headrp
id|Sg_request
op_star
id|headrp
suffix:semicolon
multiline_comment|/* head of request slist, NULL-&gt;empty */
DECL|member|async_qp
r_struct
id|fasync_struct
op_star
id|async_qp
suffix:semicolon
multiline_comment|/* used by asynchronous notification */
DECL|member|req_arr
id|Sg_request
id|req_arr
(braket
id|SG_MAX_QUEUE
)braket
suffix:semicolon
multiline_comment|/* used as singly-linked list */
DECL|member|low_dma
r_char
id|low_dma
suffix:semicolon
multiline_comment|/* as in parent but possibly overridden to 1 */
DECL|member|force_packid
r_char
id|force_packid
suffix:semicolon
multiline_comment|/* 1 -&gt; pack_id input to read(), 0 -&gt; ignored */
DECL|member|closed
r_volatile
r_char
id|closed
suffix:semicolon
multiline_comment|/* 1 -&gt; fd closed but request(s) outstanding */
DECL|member|cmd_q
r_char
id|cmd_q
suffix:semicolon
multiline_comment|/* 1 -&gt; allow command queuing, 0 -&gt; don&squot;t */
DECL|member|next_cmd_len
r_char
id|next_cmd_len
suffix:semicolon
multiline_comment|/* 0 -&gt; automatic (def), &gt;0 -&gt; use on next write() */
DECL|member|keep_orphan
r_char
id|keep_orphan
suffix:semicolon
multiline_comment|/* 0 -&gt; drop orphan (def), 1 -&gt; keep for read() */
DECL|member|mmap_called
r_char
id|mmap_called
suffix:semicolon
multiline_comment|/* 0 -&gt; mmap() never called on this fd */
DECL|typedef|Sg_fd
)brace
id|Sg_fd
suffix:semicolon
DECL|struct|sg_device
r_typedef
r_struct
id|sg_device
(brace
multiline_comment|/* holds the state of each scsi generic device */
DECL|member|device
r_struct
id|scsi_device
op_star
id|device
suffix:semicolon
DECL|member|o_excl_wait
id|wait_queue_head_t
id|o_excl_wait
suffix:semicolon
multiline_comment|/* queue open() when O_EXCL in use */
DECL|member|sg_tablesize
r_int
id|sg_tablesize
suffix:semicolon
multiline_comment|/* adapter&squot;s max scatter-gather table size */
DECL|member|headfp
id|Sg_fd
op_star
id|headfp
suffix:semicolon
multiline_comment|/* first open fd belonging to this device */
DECL|member|detached
r_volatile
r_char
id|detached
suffix:semicolon
multiline_comment|/* 0-&gt;attached, 1-&gt;detached pending removal */
DECL|member|exclude
r_volatile
r_char
id|exclude
suffix:semicolon
multiline_comment|/* opened for exclusive access */
DECL|member|sgdebug
r_char
id|sgdebug
suffix:semicolon
multiline_comment|/* 0-&gt;off, 1-&gt;sense, 9-&gt;dump dev, 10-&gt; all devs */
DECL|member|disk
r_struct
id|gendisk
op_star
id|disk
suffix:semicolon
DECL|member|cdev
r_struct
id|cdev
op_star
id|cdev
suffix:semicolon
multiline_comment|/* char_dev [sysfs: /sys/cdev/major/sg&lt;n&gt;] */
DECL|typedef|Sg_device
)brace
id|Sg_device
suffix:semicolon
r_static
r_int
id|sg_fasync
c_func
(paren
r_int
id|fd
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_void
id|sg_cmd_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
suffix:semicolon
multiline_comment|/* tasklet or soft irq callback */
r_static
r_int
id|sg_start_req
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_void
id|sg_finish_rem_req
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_int
id|sg_build_indirect
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
comma
id|Sg_fd
op_star
id|sfp
comma
r_int
id|buff_size
)paren
suffix:semicolon
r_static
r_int
id|sg_build_sgat
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
comma
r_const
id|Sg_fd
op_star
id|sfp
comma
r_int
id|tablesize
)paren
suffix:semicolon
r_static
id|ssize_t
id|sg_new_read
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
id|ssize_t
id|sg_new_write
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|blocking
comma
r_int
id|read_only
comma
id|Sg_request
op_star
op_star
id|o_srp
)paren
suffix:semicolon
r_static
r_int
id|sg_common_write
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
comma
r_int
r_char
op_star
id|cmnd
comma
r_int
id|timeout
comma
r_int
id|blocking
)paren
suffix:semicolon
r_static
r_int
id|sg_u_iovec
c_func
(paren
id|sg_io_hdr_t
op_star
id|hp
comma
r_int
id|sg_num
comma
r_int
id|ind
comma
r_int
id|wr_xf
comma
r_int
op_star
id|countp
comma
r_int
r_char
id|__user
op_star
op_star
id|up
)paren
suffix:semicolon
r_static
r_int
id|sg_write_xfer
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_int
id|sg_read_xfer
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_int
id|sg_read_oxfer
c_func
(paren
id|Sg_request
op_star
id|srp
comma
r_char
id|__user
op_star
id|outp
comma
r_int
id|num_read_xfer
)paren
suffix:semicolon
r_static
r_void
id|sg_remove_scat
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
)paren
suffix:semicolon
r_static
r_void
id|sg_build_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_int
id|req_size
)paren
suffix:semicolon
r_static
r_void
id|sg_link_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_void
id|sg_unlink_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_char
op_star
id|sg_page_malloc
c_func
(paren
r_int
id|rqSz
comma
r_int
id|lowDma
comma
r_int
op_star
id|retSzp
)paren
suffix:semicolon
r_static
r_void
id|sg_page_free
c_func
(paren
r_char
op_star
id|buff
comma
r_int
id|size
)paren
suffix:semicolon
r_static
id|Sg_fd
op_star
id|sg_add_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
r_int
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sg_remove_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
id|Sg_fd
op_star
id|sfp
)paren
suffix:semicolon
r_static
r_void
id|__sg_remove_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
id|Sg_fd
op_star
id|sfp
)paren
suffix:semicolon
r_static
id|Sg_request
op_star
id|sg_get_rq_mark
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_int
id|pack_id
)paren
suffix:semicolon
r_static
id|Sg_request
op_star
id|sg_add_request
c_func
(paren
id|Sg_fd
op_star
id|sfp
)paren
suffix:semicolon
r_static
r_int
id|sg_remove_request
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_int
id|sg_res_in_use
c_func
(paren
id|Sg_fd
op_star
id|sfp
)paren
suffix:semicolon
r_static
r_int
id|sg_allow_access
c_func
(paren
r_int
r_char
id|opcode
comma
r_char
id|dev_type
)paren
suffix:semicolon
r_static
r_int
id|sg_build_direct
c_func
(paren
id|Sg_request
op_star
id|srp
comma
id|Sg_fd
op_star
id|sfp
comma
r_int
id|dxfer_len
)paren
suffix:semicolon
r_static
id|Sg_device
op_star
id|sg_get_dev
c_func
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_inline
r_int
r_char
op_star
id|sg_scatg2virt
c_func
(paren
r_const
r_struct
id|scatterlist
op_star
id|sclp
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SCSI_PROC_FS
r_static
r_int
id|sg_last_dev
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|sg_dev_arr
r_static
id|Sg_device
op_star
op_star
id|sg_dev_arr
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|sg_dev_max
r_static
r_int
id|sg_dev_max
suffix:semicolon
DECL|variable|sg_nr_dev
r_static
r_int
id|sg_nr_dev
suffix:semicolon
DECL|macro|SZ_SG_HEADER
mdefine_line|#define SZ_SG_HEADER sizeof(struct sg_header)
DECL|macro|SZ_SG_IO_HDR
mdefine_line|#define SZ_SG_IO_HDR sizeof(sg_io_hdr_t)
DECL|macro|SZ_SG_IOVEC
mdefine_line|#define SZ_SG_IOVEC sizeof(sg_iovec_t)
DECL|macro|SZ_SG_REQ_INFO
mdefine_line|#define SZ_SG_REQ_INFO sizeof(sg_req_info_t)
r_static
r_int
DECL|function|sg_open
id|sg_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|dev
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_int
id|flags
op_assign
id|filp-&gt;f_flags
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
r_int
id|res
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|nonseekable_open
c_func
(paren
id|inode
comma
id|filp
)paren
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_open: dev=%d, flags=0x%x&bslash;n&quot;
comma
id|dev
comma
id|flags
)paren
)paren
suffix:semicolon
id|sdp
op_assign
id|sg_get_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|sdp
)paren
op_logical_or
(paren
op_logical_neg
id|sdp-&gt;device
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* This driver&squot;s module count bumped by fops_get in &lt;linux/fs.h&gt; */
multiline_comment|/* Prevent the device driver from vanishing while we sleep */
id|retval
op_assign
id|scsi_device_get
c_func
(paren
id|sdp-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
op_logical_or
id|scsi_block_when_processing_errors
c_func
(paren
id|sdp-&gt;device
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* we are in error recovery for this device */
r_goto
id|error_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|O_EXCL
)paren
(brace
r_if
c_cond
(paren
id|O_RDONLY
op_eq
(paren
id|flags
op_amp
id|O_ACCMODE
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* Can&squot;t lock it with read only access */
r_goto
id|error_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sdp-&gt;headfp
op_logical_and
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
id|res
op_assign
l_int|0
suffix:semicolon
id|__wait_event_interruptible
c_func
(paren
id|sdp-&gt;o_excl_wait
comma
(paren
(paren
id|sdp-&gt;headfp
op_logical_or
id|sdp-&gt;exclude
)paren
ques
c_cond
l_int|0
suffix:colon
(paren
id|sdp-&gt;exclude
op_assign
l_int|1
)paren
)paren
comma
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|retval
op_assign
id|res
suffix:semicolon
multiline_comment|/* -ERESTARTSYS because signal hit process */
r_goto
id|error_out
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|sdp-&gt;exclude
)paren
(brace
multiline_comment|/* some other fd has an exclusive lock on dev */
r_if
c_cond
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
id|res
op_assign
l_int|0
suffix:semicolon
id|__wait_event_interruptible
c_func
(paren
id|sdp-&gt;o_excl_wait
comma
(paren
op_logical_neg
id|sdp-&gt;exclude
)paren
comma
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|retval
op_assign
id|res
suffix:semicolon
multiline_comment|/* -ERESTARTSYS because signal hit process */
r_goto
id|error_out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
(brace
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sdp-&gt;headfp
)paren
(brace
multiline_comment|/* no existing opens on this device */
id|sdp-&gt;sgdebug
op_assign
l_int|0
suffix:semicolon
id|sdp-&gt;sg_tablesize
op_assign
id|sdp-&gt;device-&gt;host-&gt;sg_tablesize
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sfp
op_assign
id|sg_add_sfp
c_func
(paren
id|sdp
comma
id|dev
)paren
)paren
)paren
id|filp-&gt;private_data
op_assign
id|sfp
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|flags
op_amp
id|O_EXCL
)paren
id|sdp-&gt;exclude
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* undo if error */
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error_out
suffix:colon
id|scsi_device_put
c_func
(paren
id|sdp-&gt;device
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Following function was formerly called &squot;sg_close&squot; */
r_static
r_int
DECL|function|sg_release
id|sg_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_release: %s&bslash;n&quot;
comma
id|sdp-&gt;disk-&gt;disk_name
)paren
)paren
suffix:semicolon
id|sg_fasync
c_func
(paren
op_minus
l_int|1
comma
id|filp
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* remove filp from async notification list */
r_if
c_cond
(paren
l_int|0
op_eq
id|sg_remove_sfp
c_func
(paren
id|sdp
comma
id|sfp
)paren
)paren
(brace
multiline_comment|/* Returns 1 when sdp gone */
r_if
c_cond
(paren
op_logical_neg
id|sdp-&gt;detached
)paren
(brace
id|scsi_device_put
c_func
(paren
id|sdp-&gt;device
)paren
suffix:semicolon
)brace
id|sdp-&gt;exclude
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|sdp-&gt;o_excl_wait
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|sg_read
id|sg_read
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|k
comma
id|res
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
r_int
id|req_pack_id
op_assign
op_minus
l_int|1
suffix:semicolon
r_struct
id|sg_header
id|old_hdr
suffix:semicolon
id|sg_io_hdr_t
id|new_hdr
suffix:semicolon
id|sg_io_hdr_t
op_star
id|hp
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_read: %s, count=%d&bslash;n&quot;
comma
id|sdp-&gt;disk-&gt;disk_name
comma
(paren
r_int
)paren
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|buf
comma
id|count
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;force_packid
op_logical_and
(paren
id|count
op_ge
id|SZ_SG_HEADER
)paren
)paren
(brace
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
op_amp
id|old_hdr
comma
id|buf
comma
id|SZ_SG_HEADER
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|old_hdr.reply_len
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|count
op_ge
id|SZ_SG_IO_HDR
)paren
(brace
r_if
c_cond
(paren
id|__copy_from_user
(paren
op_amp
id|new_hdr
comma
id|buf
comma
id|SZ_SG_IO_HDR
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|req_pack_id
op_assign
id|new_hdr.pack_id
suffix:semicolon
)brace
)brace
r_else
id|req_pack_id
op_assign
id|old_hdr.pack_id
suffix:semicolon
)brace
id|srp
op_assign
id|sg_get_rq_mark
c_func
(paren
id|sfp
comma
id|req_pack_id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|srp
)paren
(brace
multiline_comment|/* now wait on packet to arrive */
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|res
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* following is a macro that beats race condition */
id|__wait_event_interruptible
c_func
(paren
id|sfp-&gt;read_wait
comma
(paren
id|sdp-&gt;detached
op_logical_or
(paren
id|srp
op_assign
id|sg_get_rq_mark
c_func
(paren
id|sfp
comma
id|req_pack_id
)paren
)paren
)paren
comma
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|res
)paren
r_break
suffix:semicolon
r_return
id|res
suffix:semicolon
multiline_comment|/* -ERESTARTSYS because signal hit process */
)brace
)brace
r_if
c_cond
(paren
id|srp-&gt;header.interface_id
op_ne
l_char|&squot;&bslash;0&squot;
)paren
r_return
id|sg_new_read
c_func
(paren
id|sfp
comma
id|buf
comma
id|count
comma
id|srp
)paren
suffix:semicolon
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|old_hdr
comma
l_int|0
comma
id|SZ_SG_HEADER
)paren
suffix:semicolon
id|old_hdr.reply_len
op_assign
(paren
r_int
)paren
id|hp-&gt;timeout
suffix:semicolon
id|old_hdr.pack_len
op_assign
id|old_hdr.reply_len
suffix:semicolon
multiline_comment|/* very old, strange behaviour */
id|old_hdr.pack_id
op_assign
id|hp-&gt;pack_id
suffix:semicolon
id|old_hdr.twelve_byte
op_assign
(paren
(paren
id|srp-&gt;data.cmd_opcode
op_ge
l_int|0xc0
)paren
op_logical_and
(paren
l_int|12
op_eq
id|hp-&gt;cmd_len
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|old_hdr.target_status
op_assign
id|hp-&gt;masked_status
suffix:semicolon
id|old_hdr.host_status
op_assign
id|hp-&gt;host_status
suffix:semicolon
id|old_hdr.driver_status
op_assign
id|hp-&gt;driver_status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|CHECK_CONDITION
op_amp
id|hp-&gt;masked_status
)paren
op_logical_or
(paren
id|DRIVER_SENSE
op_amp
id|hp-&gt;driver_status
)paren
)paren
id|memcpy
c_func
(paren
id|old_hdr.sense_buffer
comma
id|srp-&gt;sense_b
comma
r_sizeof
(paren
id|old_hdr.sense_buffer
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;host_status
)paren
(brace
multiline_comment|/* This setup of &squot;result&squot; is for backward compatibility and is best&n;&t;   ignored by the user who should use target, host + driver status */
r_case
id|DID_OK
suffix:colon
r_case
id|DID_PASSTHROUGH
suffix:colon
r_case
id|DID_SOFT_ERROR
suffix:colon
id|old_hdr.result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DID_NO_CONNECT
suffix:colon
r_case
id|DID_BUS_BUSY
suffix:colon
r_case
id|DID_TIME_OUT
suffix:colon
id|old_hdr.result
op_assign
id|EBUSY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DID_BAD_TARGET
suffix:colon
r_case
id|DID_ABORT
suffix:colon
r_case
id|DID_PARITY
suffix:colon
r_case
id|DID_RESET
suffix:colon
r_case
id|DID_BAD_INTR
suffix:colon
id|old_hdr.result
op_assign
id|EIO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DID_ERROR
suffix:colon
id|old_hdr.result
op_assign
(paren
id|srp-&gt;sense_b
(braket
l_int|0
)braket
op_eq
l_int|0
op_logical_and
id|hp-&gt;masked_status
op_eq
id|GOOD
)paren
ques
c_cond
l_int|0
suffix:colon
id|EIO
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|old_hdr.result
op_assign
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Now copy the result back to the user buffer.  */
r_if
c_cond
(paren
id|count
op_ge
id|SZ_SG_HEADER
)paren
(brace
r_if
c_cond
(paren
id|__copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|old_hdr
comma
id|SZ_SG_HEADER
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|buf
op_add_assign
id|SZ_SG_HEADER
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|old_hdr.reply_len
)paren
id|count
op_assign
id|old_hdr.reply_len
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|SZ_SG_HEADER
)paren
(brace
r_if
c_cond
(paren
(paren
id|res
op_assign
id|sg_read_oxfer
c_func
(paren
id|srp
comma
id|buf
comma
id|count
op_minus
id|SZ_SG_HEADER
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_else
id|count
op_assign
(paren
id|old_hdr.result
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|sg_new_read
id|sg_new_read
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|Sg_request
op_star
id|srp
)paren
(brace
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|SZ_SG_IO_HDR
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|hp-&gt;sb_len_wr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hp-&gt;mx_sb_len
OG
l_int|0
)paren
op_logical_and
id|hp-&gt;sbp
)paren
(brace
r_if
c_cond
(paren
(paren
id|CHECK_CONDITION
op_amp
id|hp-&gt;masked_status
)paren
op_logical_or
(paren
id|DRIVER_SENSE
op_amp
id|hp-&gt;driver_status
)paren
)paren
(brace
r_int
id|sb_len
op_assign
r_sizeof
(paren
id|dummy_cmdp-&gt;sr_sense_buffer
)paren
suffix:semicolon
id|sb_len
op_assign
(paren
id|hp-&gt;mx_sb_len
OG
id|sb_len
)paren
ques
c_cond
id|sb_len
suffix:colon
id|hp-&gt;mx_sb_len
suffix:semicolon
id|len
op_assign
l_int|8
op_plus
(paren
r_int
)paren
id|srp-&gt;sense_b
(braket
l_int|7
)braket
suffix:semicolon
multiline_comment|/* Additional sense length field */
id|len
op_assign
(paren
id|len
OG
id|sb_len
)paren
ques
c_cond
id|sb_len
suffix:colon
id|len
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|hp-&gt;sbp
comma
id|srp-&gt;sense_b
comma
id|len
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|hp-&gt;sb_len_wr
op_assign
id|len
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hp-&gt;masked_status
op_logical_or
id|hp-&gt;host_status
op_logical_or
id|hp-&gt;driver_status
)paren
id|hp-&gt;info
op_or_assign
id|SG_INFO_CHECK
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|hp
comma
id|SZ_SG_IO_HDR
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|err
op_assign
id|sg_read_xfer
c_func
(paren
id|srp
)paren
suffix:semicolon
id|err_out
suffix:colon
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_return
(paren
l_int|0
op_eq
id|err
)paren
ques
c_cond
id|count
suffix:colon
id|err
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|sg_write
id|sg_write
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|mxsize
comma
id|cmd_size
comma
id|k
suffix:semicolon
r_int
id|input_size
comma
id|blocking
suffix:semicolon
r_int
r_char
id|opcode
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
r_struct
id|sg_header
id|old_hdr
suffix:semicolon
id|sg_io_hdr_t
op_star
id|hp
suffix:semicolon
r_int
r_char
id|cmnd
(braket
r_sizeof
(paren
id|dummy_cmdp-&gt;sr_cmnd
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: %s, count=%d&bslash;n&quot;
comma
id|sdp-&gt;disk-&gt;disk_name
comma
(paren
r_int
)paren
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
op_logical_or
id|scsi_block_when_processing_errors
c_func
(paren
id|sdp-&gt;device
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|buf
comma
id|count
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
multiline_comment|/* protects following copy_from_user()s + get_user()s */
r_if
c_cond
(paren
id|count
OL
id|SZ_SG_HEADER
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
op_amp
id|old_hdr
comma
id|buf
comma
id|SZ_SG_HEADER
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|blocking
op_assign
op_logical_neg
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_hdr.reply_len
OL
l_int|0
)paren
r_return
id|sg_new_write
c_func
(paren
id|sfp
comma
id|buf
comma
id|count
comma
id|blocking
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
(paren
id|SZ_SG_HEADER
op_plus
l_int|6
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* The minimum scsi command length is 6 bytes. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|srp
op_assign
id|sg_add_request
c_func
(paren
id|sfp
)paren
)paren
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: queue full&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EDOM
suffix:semicolon
)brace
id|buf
op_add_assign
id|SZ_SG_HEADER
suffix:semicolon
id|__get_user
c_func
(paren
id|opcode
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;next_cmd_len
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sfp-&gt;next_cmd_len
OG
id|MAX_COMMAND_SIZE
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: command length too long&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|sfp-&gt;next_cmd_len
op_assign
l_int|0
suffix:semicolon
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|cmd_size
op_assign
id|sfp-&gt;next_cmd_len
suffix:semicolon
id|sfp-&gt;next_cmd_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset so only this write() effected */
)brace
r_else
(brace
id|cmd_size
op_assign
id|COMMAND_SIZE
c_func
(paren
id|opcode
)paren
suffix:semicolon
multiline_comment|/* based on SCSI command group */
r_if
c_cond
(paren
(paren
id|opcode
op_ge
l_int|0xc0
)paren
op_logical_and
id|old_hdr.twelve_byte
)paren
id|cmd_size
op_assign
l_int|12
suffix:semicolon
)brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_write:   scsi opcode=0x%02x, cmd_size=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|opcode
comma
id|cmd_size
)paren
)paren
suffix:semicolon
multiline_comment|/* Determine buffer size.  */
id|input_size
op_assign
id|count
op_minus
id|cmd_size
suffix:semicolon
id|mxsize
op_assign
(paren
id|input_size
OG
id|old_hdr.reply_len
)paren
ques
c_cond
id|input_size
suffix:colon
id|old_hdr.reply_len
suffix:semicolon
id|mxsize
op_sub_assign
id|SZ_SG_HEADER
suffix:semicolon
id|input_size
op_sub_assign
id|SZ_SG_HEADER
suffix:semicolon
r_if
c_cond
(paren
id|input_size
OL
l_int|0
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* User did not pass enough bytes for this command. */
)brace
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|hp-&gt;interface_id
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* indicator of old interface tunnelled */
id|hp-&gt;cmd_len
op_assign
(paren
r_int
r_char
)paren
id|cmd_size
suffix:semicolon
id|hp-&gt;iovec_count
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;mx_sb_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|input_size
OG
l_int|0
)paren
id|hp-&gt;dxfer_direction
op_assign
(paren
id|old_hdr.reply_len
OG
id|SZ_SG_HEADER
)paren
ques
c_cond
id|SG_DXFER_TO_FROM_DEV
suffix:colon
id|SG_DXFER_TO_DEV
suffix:semicolon
r_else
id|hp-&gt;dxfer_direction
op_assign
(paren
id|mxsize
OG
l_int|0
)paren
ques
c_cond
id|SG_DXFER_FROM_DEV
suffix:colon
id|SG_DXFER_NONE
suffix:semicolon
id|hp-&gt;dxfer_len
op_assign
id|mxsize
suffix:semicolon
id|hp-&gt;dxferp
op_assign
(paren
r_char
id|__user
op_star
)paren
id|buf
op_plus
id|cmd_size
suffix:semicolon
id|hp-&gt;sbp
op_assign
l_int|NULL
suffix:semicolon
id|hp-&gt;timeout
op_assign
id|old_hdr.reply_len
suffix:semicolon
multiline_comment|/* structure abuse ... */
id|hp-&gt;flags
op_assign
id|input_size
suffix:semicolon
multiline_comment|/* structure abuse ... */
id|hp-&gt;pack_id
op_assign
id|old_hdr.pack_id
suffix:semicolon
id|hp-&gt;usr_ptr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
id|cmnd
comma
id|buf
comma
id|cmd_size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/*&n;&t; * SG_DXFER_TO_FROM_DEV is functionally equivalent to SG_DXFER_FROM_DEV,&n;&t; * but is is possible that the app intended SG_DXFER_TO_DEV, because there&n;&t; * is a non-zero input_size, so emit a warning.&n;&t; */
r_if
c_cond
(paren
id|hp-&gt;dxfer_direction
op_eq
id|SG_DXFER_TO_FROM_DEV
)paren
r_if
c_cond
(paren
id|printk_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sg_write: data in/out %d/%d bytes for SCSI command 0x%x--&quot;
l_string|&quot;guessing data in;&bslash;n&quot;
id|KERN_WARNING
l_string|&quot;   &quot;
l_string|&quot;program %s not setting count and/or reply_len properly&bslash;n&quot;
comma
id|old_hdr.reply_len
op_minus
(paren
r_int
)paren
id|SZ_SG_HEADER
comma
id|input_size
comma
(paren
r_int
r_int
)paren
id|cmnd
(braket
l_int|0
)braket
comma
id|current-&gt;comm
)paren
suffix:semicolon
id|k
op_assign
id|sg_common_write
c_func
(paren
id|sfp
comma
id|srp
comma
id|cmnd
comma
id|sfp-&gt;timeout
comma
id|blocking
)paren
suffix:semicolon
r_return
(paren
id|k
OL
l_int|0
)paren
ques
c_cond
id|k
suffix:colon
id|count
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|sg_new_write
id|sg_new_write
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|blocking
comma
r_int
id|read_only
comma
id|Sg_request
op_star
op_star
id|o_srp
)paren
(brace
r_int
id|k
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
id|sg_io_hdr_t
op_star
id|hp
suffix:semicolon
r_int
r_char
id|cmnd
(braket
r_sizeof
(paren
id|dummy_cmdp-&gt;sr_cmnd
)paren
)braket
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_int
r_int
id|ul_timeout
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|SZ_SG_IO_HDR
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|buf
comma
id|count
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
multiline_comment|/* protects following copy_from_user()s + get_user()s */
id|sfp-&gt;cmd_q
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* when sg_io_hdr seen, set command queuing on */
r_if
c_cond
(paren
op_logical_neg
(paren
id|srp
op_assign
id|sg_add_request
c_func
(paren
id|sfp
)paren
)paren
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_new_write: queue full&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EDOM
suffix:semicolon
)brace
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
id|hp
comma
id|buf
comma
id|SZ_SG_IO_HDR
)paren
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;interface_id
op_ne
l_char|&squot;S&squot;
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;flags
op_amp
id|SG_FLAG_MMAP_IO
)paren
(brace
r_if
c_cond
(paren
id|hp-&gt;dxfer_len
OG
id|sfp-&gt;reserve.bufflen
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* MMAP_IO size must fit in reserve buffer */
)brace
r_if
c_cond
(paren
id|hp-&gt;flags
op_amp
id|SG_FLAG_DIRECT_IO
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* either MMAP_IO or DIRECT_IO (not both) */
)brace
r_if
c_cond
(paren
id|sg_res_in_use
c_func
(paren
id|sfp
)paren
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* reserve buffer already being used */
)brace
)brace
id|ul_timeout
op_assign
id|msecs_to_jiffies
c_func
(paren
id|srp-&gt;header.timeout
)paren
suffix:semicolon
id|timeout
op_assign
(paren
id|ul_timeout
OL
id|INT_MAX
)paren
ques
c_cond
id|ul_timeout
suffix:colon
id|INT_MAX
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|hp-&gt;cmdp
)paren
op_logical_or
(paren
id|hp-&gt;cmd_len
OL
l_int|6
)paren
op_logical_or
(paren
id|hp-&gt;cmd_len
OG
r_sizeof
(paren
id|cmnd
)paren
)paren
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|hp-&gt;cmdp
comma
id|hp-&gt;cmd_len
)paren
)paren
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
id|k
suffix:semicolon
multiline_comment|/* protects following copy_from_user()s + get_user()s */
)brace
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
id|cmnd
comma
id|hp-&gt;cmdp
comma
id|hp-&gt;cmd_len
)paren
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|read_only
op_logical_and
(paren
op_logical_neg
id|sg_allow_access
c_func
(paren
id|cmnd
(braket
l_int|0
)braket
comma
id|sfp-&gt;parentdp-&gt;device-&gt;type
)paren
)paren
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|k
op_assign
id|sg_common_write
c_func
(paren
id|sfp
comma
id|srp
comma
id|cmnd
comma
id|timeout
comma
id|blocking
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
OL
l_int|0
)paren
r_return
id|k
suffix:semicolon
r_if
c_cond
(paren
id|o_srp
)paren
op_star
id|o_srp
op_assign
id|srp
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_common_write
id|sg_common_write
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
comma
r_int
r_char
op_star
id|cmnd
comma
r_int
id|timeout
comma
r_int
id|blocking
)paren
(brace
r_int
id|k
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
suffix:semicolon
id|Sg_device
op_star
id|sdp
op_assign
id|sfp-&gt;parentdp
suffix:semicolon
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|request_queue_t
op_star
id|q
suffix:semicolon
id|srp-&gt;data.cmd_opcode
op_assign
id|cmnd
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* hold opcode of command */
id|hp-&gt;status
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;masked_status
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;msg_status
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;info
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;host_status
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;driver_status
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;resid
op_assign
l_int|0
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_common_write:  scsi opcode=0x%02x, cmd_size=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|cmnd
(braket
l_int|0
)braket
comma
(paren
r_int
)paren
id|hp-&gt;cmd_len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|sg_start_req
c_func
(paren
id|srp
)paren
)paren
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: start_req err=%d&bslash;n&quot;
comma
id|k
)paren
)paren
suffix:semicolon
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_return
id|k
suffix:semicolon
multiline_comment|/* probably out of space --&gt; ENOMEM */
)brace
r_if
c_cond
(paren
(paren
id|k
op_assign
id|sg_write_xfer
c_func
(paren
id|srp
)paren
)paren
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: write_xfer, bad address&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_return
id|k
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
(brace
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|SRpnt
op_assign
id|scsi_allocate_request
c_func
(paren
id|sdp-&gt;device
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt
op_eq
l_int|NULL
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: no mem&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|srp-&gt;my_cmdp
op_assign
id|SRpnt
suffix:semicolon
id|q
op_assign
id|SRpnt-&gt;sr_device-&gt;request_queue
suffix:semicolon
id|SRpnt-&gt;sr_request-&gt;rq_disk
op_assign
id|sdp-&gt;disk
suffix:semicolon
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_cmd_len
op_assign
id|hp-&gt;cmd_len
suffix:semicolon
id|SRpnt-&gt;sr_use_sg
op_assign
id|srp-&gt;data.k_use_sg
suffix:semicolon
id|SRpnt-&gt;sr_sglist_len
op_assign
id|srp-&gt;data.sglist_len
suffix:semicolon
id|SRpnt-&gt;sr_bufflen
op_assign
id|srp-&gt;data.bufflen
suffix:semicolon
id|SRpnt-&gt;sr_underflow
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_buffer
op_assign
id|srp-&gt;data.buffer
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;dxfer_direction
)paren
(brace
r_case
id|SG_DXFER_TO_FROM_DEV
suffix:colon
r_case
id|SG_DXFER_FROM_DEV
suffix:colon
id|SRpnt-&gt;sr_data_direction
op_assign
id|SCSI_DATA_READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SG_DXFER_TO_DEV
suffix:colon
id|SRpnt-&gt;sr_data_direction
op_assign
id|SCSI_DATA_WRITE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SG_DXFER_UNKNOWN
suffix:colon
id|SRpnt-&gt;sr_data_direction
op_assign
id|SCSI_DATA_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SRpnt-&gt;sr_data_direction
op_assign
id|SCSI_DATA_NONE
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SRpnt-&gt;upper_private_data
op_assign
id|srp
suffix:semicolon
id|srp-&gt;data.k_use_sg
op_assign
l_int|0
suffix:semicolon
id|srp-&gt;data.sglist_len
op_assign
l_int|0
suffix:semicolon
id|srp-&gt;data.bufflen
op_assign
l_int|0
suffix:semicolon
id|srp-&gt;data.buffer
op_assign
l_int|NULL
suffix:semicolon
id|hp-&gt;duration
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* unit jiffies now, millisecs after done */
multiline_comment|/* Now send everything of to mid-level. The next time we hear about this&n;   packet is when sg_cmd_done() is called (i.e. a callback). */
id|scsi_do_req
c_func
(paren
id|SRpnt
comma
(paren
r_void
op_star
)paren
id|cmnd
comma
(paren
r_void
op_star
)paren
id|SRpnt-&gt;sr_buffer
comma
id|hp-&gt;dxfer_len
comma
id|sg_cmd_done
comma
id|timeout
comma
id|SG_DEFAULT_RETRIES
)paren
suffix:semicolon
multiline_comment|/* dxfer_len overwrites SRpnt-&gt;sr_bufflen, hence need for b_malloc_len */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_srp_done
id|sg_srp_done
c_func
(paren
id|Sg_request
op_star
id|srp
comma
id|Sg_fd
op_star
id|sfp
)paren
(brace
r_int
r_int
id|iflags
suffix:semicolon
r_int
id|done
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|done
op_assign
id|srp-&gt;done
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|done
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_ioctl
id|sg_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
(brace
r_void
id|__user
op_star
id|p
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
id|__user
op_star
id|ip
op_assign
id|p
suffix:semicolon
r_int
id|result
comma
id|val
comma
id|read_only
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_ioctl: %s, cmd=0x%x&bslash;n&quot;
comma
id|sdp-&gt;disk-&gt;disk_name
comma
(paren
r_int
)paren
id|cmd_in
)paren
)paren
suffix:semicolon
id|read_only
op_assign
(paren
id|O_RDWR
op_ne
(paren
id|filp-&gt;f_flags
op_amp
id|O_ACCMODE
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd_in
)paren
(brace
r_case
id|SG_IO
suffix:colon
(brace
r_int
id|blocking
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ignore O_NONBLOCK flag */
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_block_when_processing_errors
c_func
(paren
id|sdp-&gt;device
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|result
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|p
comma
id|SZ_SG_IO_HDR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|result
op_assign
id|sg_new_write
c_func
(paren
id|sfp
comma
id|p
comma
id|SZ_SG_IO_HDR
comma
id|blocking
comma
id|read_only
comma
op_amp
id|srp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
id|srp-&gt;sg_io_owned
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* following macro to beat race condition */
id|__wait_event_interruptible
c_func
(paren
id|sfp-&gt;read_wait
comma
(paren
id|sdp-&gt;detached
op_logical_or
id|sfp-&gt;closed
op_logical_or
id|sg_srp_done
c_func
(paren
id|srp
comma
id|sfp
)paren
)paren
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;closed
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* request packet dropped already */
r_if
c_cond
(paren
l_int|0
op_eq
id|result
)paren
r_break
suffix:semicolon
id|srp-&gt;orphan
op_assign
l_int|1
suffix:semicolon
r_return
id|result
suffix:semicolon
multiline_comment|/* -ERESTARTSYS because signal hit process */
)brace
id|write_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|srp-&gt;done
op_assign
l_int|2
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|result
op_assign
id|sg_new_read
c_func
(paren
id|sfp
comma
id|p
comma
id|SZ_SG_IO_HDR
comma
id|srp
)paren
suffix:semicolon
r_return
(paren
id|result
OL
l_int|0
)paren
ques
c_cond
id|result
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|SG_SET_TIMEOUT
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
id|MULDIV
(paren
id|INT_MAX
comma
id|USER_HZ
comma
id|HZ
)paren
)paren
id|val
op_assign
id|MULDIV
(paren
id|INT_MAX
comma
id|USER_HZ
comma
id|HZ
)paren
suffix:semicolon
id|sfp-&gt;timeout_user
op_assign
id|val
suffix:semicolon
id|sfp-&gt;timeout
op_assign
id|MULDIV
(paren
id|val
comma
id|HZ
comma
id|USER_HZ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_TIMEOUT
suffix:colon
multiline_comment|/* N.B. User receives timeout as return value */
multiline_comment|/* strange ..., for backward compatibility */
r_return
id|sfp-&gt;timeout_user
suffix:semicolon
r_case
id|SG_SET_FORCE_LOW_DMA
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
id|sfp-&gt;low_dma
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
l_int|0
op_eq
id|sfp-&gt;low_dma
)paren
op_logical_and
(paren
l_int|0
op_eq
id|sg_res_in_use
c_func
(paren
id|sfp
)paren
)paren
)paren
(brace
id|val
op_assign
(paren
r_int
)paren
id|sfp-&gt;reserve.bufflen
suffix:semicolon
id|sg_remove_scat
c_func
(paren
op_amp
id|sfp-&gt;reserve
)paren
suffix:semicolon
id|sg_build_reserve
c_func
(paren
id|sfp
comma
id|val
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|sfp-&gt;low_dma
op_assign
id|sdp-&gt;device-&gt;host-&gt;unchecked_isa_dma
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_LOW_DMA
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
r_int
)paren
id|sfp-&gt;low_dma
comma
id|ip
)paren
suffix:semicolon
r_case
id|SG_GET_SCSI_ID
suffix:colon
id|result
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|p
comma
r_sizeof
(paren
id|sg_scsi_id_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_else
(brace
id|sg_scsi_id_t
id|__user
op_star
id|sg_idp
op_assign
id|p
suffix:semicolon
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;host-&gt;host_no
comma
op_amp
id|sg_idp-&gt;host_no
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;channel
comma
op_amp
id|sg_idp-&gt;channel
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;id
comma
op_amp
id|sg_idp-&gt;scsi_id
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;lun
comma
op_amp
id|sg_idp-&gt;lun
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;type
comma
op_amp
id|sg_idp-&gt;scsi_type
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;host-&gt;cmd_per_lun
comma
op_amp
id|sg_idp-&gt;h_cmd_per_lun
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;queue_depth
comma
op_amp
id|sg_idp-&gt;d_queue_depth
)paren
suffix:semicolon
id|__put_user
c_func
(paren
l_int|0
comma
op_amp
id|sg_idp-&gt;unused
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|__put_user
c_func
(paren
l_int|0
comma
op_amp
id|sg_idp-&gt;unused
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SG_SET_FORCE_PACK_ID
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|sfp-&gt;force_packid
op_assign
id|val
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_PACK_ID
suffix:colon
id|result
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|ip
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|srp-&gt;nextrp
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1
op_eq
id|srp-&gt;done
)paren
op_logical_and
(paren
op_logical_neg
id|srp-&gt;sg_io_owned
)paren
)paren
(brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|__put_user
c_func
(paren
id|srp-&gt;header.pack_id
comma
id|ip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|__put_user
c_func
(paren
op_minus
l_int|1
comma
id|ip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_NUM_WAITING
suffix:colon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|val
op_assign
l_int|0
comma
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|srp-&gt;nextrp
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1
op_eq
id|srp-&gt;done
)paren
op_logical_and
(paren
op_logical_neg
id|srp-&gt;sg_io_owned
)paren
)paren
op_increment
id|val
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_case
id|SG_GET_SG_TABLESIZE
suffix:colon
r_return
id|put_user
c_func
(paren
id|sdp-&gt;sg_tablesize
comma
id|ip
)paren
suffix:semicolon
r_case
id|SG_SET_RESERVED_SIZE
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|sfp-&gt;reserve.bufflen
)paren
(brace
r_if
c_cond
(paren
id|sg_res_in_use
c_func
(paren
id|sfp
)paren
op_logical_or
id|sfp-&gt;mmap_called
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|sg_remove_scat
c_func
(paren
op_amp
id|sfp-&gt;reserve
)paren
suffix:semicolon
id|sg_build_reserve
c_func
(paren
id|sfp
comma
id|val
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_RESERVED_SIZE
suffix:colon
id|val
op_assign
(paren
r_int
)paren
id|sfp-&gt;reserve.bufflen
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_case
id|SG_SET_COMMAND_Q
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|sfp-&gt;cmd_q
op_assign
id|val
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_COMMAND_Q
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
r_int
)paren
id|sfp-&gt;cmd_q
comma
id|ip
)paren
suffix:semicolon
r_case
id|SG_SET_KEEP_ORPHAN
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|sfp-&gt;keep_orphan
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_KEEP_ORPHAN
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
r_int
)paren
id|sfp-&gt;keep_orphan
comma
id|ip
)paren
suffix:semicolon
r_case
id|SG_NEXT_CMD_LEN
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|sfp-&gt;next_cmd_len
op_assign
(paren
id|val
OG
l_int|0
)paren
ques
c_cond
id|val
suffix:colon
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_VERSION_NUM
suffix:colon
r_return
id|put_user
c_func
(paren
id|sg_version_num
comma
id|ip
)paren
suffix:semicolon
r_case
id|SG_GET_ACCESS_COUNT
suffix:colon
multiline_comment|/* faked - we don&squot;t have a real access count anymore */
id|val
op_assign
(paren
id|sdp-&gt;device
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_case
id|SG_GET_REQUEST_TABLE
suffix:colon
id|result
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|p
comma
id|SZ_SG_REQ_INFO
op_star
id|SG_MAX_QUEUE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_else
(brace
id|sg_req_info_t
id|rinfo
(braket
id|SG_MAX_QUEUE
)braket
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
comma
id|val
op_assign
l_int|0
suffix:semicolon
id|val
OL
id|SG_MAX_QUEUE
suffix:semicolon
op_increment
id|val
comma
id|srp
op_assign
id|srp
ques
c_cond
id|srp-&gt;nextrp
suffix:colon
id|srp
)paren
(brace
id|memset
c_func
(paren
op_amp
id|rinfo
(braket
id|val
)braket
comma
l_int|0
comma
id|SZ_SG_REQ_INFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srp
)paren
(brace
id|rinfo
(braket
id|val
)braket
dot
id|req_state
op_assign
id|srp-&gt;done
op_plus
l_int|1
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|problem
op_assign
id|srp-&gt;header.masked_status
op_amp
id|srp-&gt;header.host_status
op_amp
id|srp-&gt;header.driver_status
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|duration
op_assign
id|srp-&gt;done
ques
c_cond
id|srp-&gt;header.duration
suffix:colon
id|jiffies_to_msecs
c_func
(paren
id|jiffies
op_minus
id|srp-&gt;header.duration
)paren
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|orphan
op_assign
id|srp-&gt;orphan
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|sg_io_owned
op_assign
id|srp-&gt;sg_io_owned
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|pack_id
op_assign
id|srp-&gt;header.pack_id
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|usr_ptr
op_assign
id|srp-&gt;header.usr_ptr
suffix:semicolon
)brace
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
(paren
id|__copy_to_user
c_func
(paren
id|p
comma
id|rinfo
comma
id|SZ_SG_REQ_INFO
op_star
id|SG_MAX_QUEUE
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_case
id|SG_EMULATED_HOST
suffix:colon
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|sdp-&gt;device-&gt;host-&gt;hostt-&gt;emulated
comma
id|ip
)paren
suffix:semicolon
r_case
id|SG_SCSI_RESET
suffix:colon
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|SHOST_RECOVERY
comma
op_amp
id|sdp-&gt;device-&gt;host-&gt;shost_state
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|scsi_block_when_processing_errors
c_func
(paren
id|sdp-&gt;device
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
id|SG_SCSI_RESET_NOTHING
op_eq
id|val
)paren
r_return
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
id|SG_SCSI_RESET_DEVICE
suffix:colon
id|val
op_assign
id|SCSI_TRY_RESET_DEVICE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SG_SCSI_RESET_BUS
suffix:colon
id|val
op_assign
id|SCSI_TRY_RESET_BUS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SG_SCSI_RESET_HOST
suffix:colon
id|val
op_assign
id|SCSI_TRY_RESET_HOST
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_or
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_return
(paren
id|scsi_reset_provider
c_func
(paren
id|sdp-&gt;device
comma
id|val
)paren
op_eq
id|SUCCESS
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
r_case
id|SCSI_IOCTL_SEND_COMMAND
suffix:colon
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|read_only
)paren
(brace
r_int
r_char
id|opcode
op_assign
id|WRITE_6
suffix:semicolon
id|Scsi_Ioctl_Command
id|__user
op_star
id|siocp
op_assign
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|opcode
comma
id|siocp-&gt;data
comma
l_int|1
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sg_allow_access
c_func
(paren
id|opcode
comma
id|sdp-&gt;device-&gt;type
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_return
id|scsi_ioctl_send_command
c_func
(paren
id|sdp-&gt;device
comma
id|p
)paren
suffix:semicolon
r_case
id|SG_SET_DEBUG
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|sdp-&gt;sgdebug
op_assign
(paren
r_char
)paren
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SCSI_IOCTL_GET_IDLUN
suffix:colon
r_case
id|SCSI_IOCTL_GET_BUS_NUMBER
suffix:colon
r_case
id|SCSI_IOCTL_PROBE_HOST
suffix:colon
r_case
id|SG_GET_TRANSFORM
suffix:colon
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|scsi_ioctl
c_func
(paren
id|sdp-&gt;device
comma
id|cmd_in
comma
id|p
)paren
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|read_only
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* don&squot;t know so take safe approach */
r_return
id|scsi_ioctl
c_func
(paren
id|sdp-&gt;device
comma
id|cmd_in
comma
id|p
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
r_int
DECL|function|sg_poll
id|sg_poll
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_int
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
op_logical_or
id|sfp-&gt;closed
)paren
r_return
id|POLLERR
suffix:semicolon
id|poll_wait
c_func
(paren
id|filp
comma
op_amp
id|sfp-&gt;read_wait
comma
id|wait
)paren
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|srp-&gt;nextrp
)paren
(brace
multiline_comment|/* if any read waiting, flag it */
r_if
c_cond
(paren
(paren
l_int|0
op_eq
id|res
)paren
op_logical_and
(paren
l_int|1
op_eq
id|srp-&gt;done
)paren
op_logical_and
(paren
op_logical_neg
id|srp-&gt;sg_io_owned
)paren
)paren
id|res
op_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
op_increment
id|count
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
id|res
op_or_assign
id|POLLHUP
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|sfp-&gt;cmd_q
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|count
)paren
id|res
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|count
OL
id|SG_MAX_QUEUE
)paren
id|res
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_poll: %s, res=0x%x&bslash;n&quot;
comma
id|sdp-&gt;disk-&gt;disk_name
comma
(paren
r_int
)paren
id|res
)paren
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_fasync
id|sg_fasync
c_func
(paren
r_int
id|fd
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|mode
)paren
(brace
r_int
id|retval
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_fasync: %s, mode=%d&bslash;n&quot;
comma
id|sdp-&gt;disk-&gt;disk_name
comma
id|mode
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|fasync_helper
c_func
(paren
id|fd
comma
id|filp
comma
id|mode
comma
op_amp
id|sfp-&gt;async_qp
)paren
suffix:semicolon
r_return
(paren
id|retval
OL
l_int|0
)paren
ques
c_cond
id|retval
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
r_char
op_star
DECL|function|sg_scatg2virt
id|sg_scatg2virt
c_func
(paren
r_const
r_struct
id|scatterlist
op_star
id|sclp
)paren
(brace
r_return
(paren
id|sclp
op_logical_and
id|sclp-&gt;page
)paren
ques
c_cond
(paren
r_int
r_char
op_star
)paren
id|page_address
c_func
(paren
id|sclp-&gt;page
)paren
op_plus
id|sclp-&gt;offset
suffix:colon
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* When startFinish==1 increments page counts for pages other than the &n;   first of scatter gather elements obtained from __get_free_pages().&n;   When startFinish==0 decrements ... */
r_static
r_void
DECL|function|sg_rb_correct4mmap
id|sg_rb_correct4mmap
c_func
(paren
id|Sg_scatter_hold
op_star
id|rsv_schp
comma
r_int
id|startFinish
)paren
(brace
r_void
op_star
id|page_ptr
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
r_int
id|k
comma
id|m
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_rb_correct4mmap: startFinish=%d, scatg=%d&bslash;n&quot;
comma
id|startFinish
comma
id|rsv_schp-&gt;k_use_sg
)paren
)paren
suffix:semicolon
multiline_comment|/* N.B. correction _not_ applied to base page of each allocation */
r_if
c_cond
(paren
id|rsv_schp-&gt;k_use_sg
)paren
(brace
multiline_comment|/* reserve buffer is a scatter gather list */
r_struct
id|scatterlist
op_star
id|sclp
op_assign
id|rsv_schp-&gt;buffer
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|rsv_schp-&gt;k_use_sg
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
id|PAGE_SIZE
suffix:semicolon
id|m
OL
id|sclp-&gt;length
suffix:semicolon
id|m
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|page_ptr
op_assign
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
op_plus
id|m
suffix:semicolon
id|page
op_assign
id|virt_to_page
c_func
(paren
id|page_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|startFinish
)paren
id|get_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|page_count
c_func
(paren
id|page
)paren
OG
l_int|0
)paren
id|__put_page
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* reserve buffer is just a single allocation */
r_for
c_loop
(paren
id|m
op_assign
id|PAGE_SIZE
suffix:semicolon
id|m
OL
id|rsv_schp-&gt;bufflen
suffix:semicolon
id|m
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|page_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|rsv_schp-&gt;buffer
op_plus
id|m
suffix:semicolon
id|page
op_assign
id|virt_to_page
c_func
(paren
id|page_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|startFinish
)paren
id|get_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|page_count
c_func
(paren
id|page
)paren
OG
l_int|0
)paren
id|__put_page
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_static
r_struct
id|page
op_star
DECL|function|sg_vma_nopage
id|sg_vma_nopage
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|addr
comma
r_int
op_star
id|type
)paren
(brace
id|Sg_fd
op_star
id|sfp
suffix:semicolon
r_struct
id|page
op_star
id|page
op_assign
id|NOPAGE_SIGBUS
suffix:semicolon
r_void
op_star
id|page_ptr
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
id|Sg_scatter_hold
op_star
id|rsv_schp
suffix:semicolon
r_if
c_cond
(paren
(paren
l_int|NULL
op_eq
id|vma
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|vma-&gt;vm_private_data
)paren
)paren
)paren
r_return
id|page
suffix:semicolon
id|rsv_schp
op_assign
op_amp
id|sfp-&gt;reserve
suffix:semicolon
id|offset
op_assign
id|addr
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_ge
id|rsv_schp-&gt;bufflen
)paren
r_return
id|page
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_vma_nopage: offset=%lu, scatg=%d&bslash;n&quot;
comma
id|offset
comma
id|rsv_schp-&gt;k_use_sg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rsv_schp-&gt;k_use_sg
)paren
(brace
multiline_comment|/* reserve buffer is a scatter gather list */
r_int
id|k
suffix:semicolon
r_int
r_int
id|sa
op_assign
id|vma-&gt;vm_start
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sclp
op_assign
id|rsv_schp-&gt;buffer
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
(paren
id|k
OL
id|rsv_schp-&gt;k_use_sg
)paren
op_logical_and
(paren
id|sa
OL
id|vma-&gt;vm_end
)paren
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
)paren
(brace
id|len
op_assign
id|vma-&gt;vm_end
op_minus
id|sa
suffix:semicolon
id|len
op_assign
(paren
id|len
OL
id|sclp-&gt;length
)paren
ques
c_cond
id|len
suffix:colon
id|sclp-&gt;length
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
id|len
)paren
(brace
id|page_ptr
op_assign
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
op_plus
id|offset
suffix:semicolon
id|page
op_assign
id|virt_to_page
c_func
(paren
id|page_ptr
)paren
suffix:semicolon
id|get_page
c_func
(paren
id|page
)paren
suffix:semicolon
multiline_comment|/* increment page count */
r_break
suffix:semicolon
)brace
id|sa
op_add_assign
id|len
suffix:semicolon
id|offset
op_sub_assign
id|len
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* reserve buffer is just a single allocation */
id|page_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|rsv_schp-&gt;buffer
op_plus
id|offset
suffix:semicolon
id|page
op_assign
id|virt_to_page
c_func
(paren
id|page_ptr
)paren
suffix:semicolon
id|get_page
c_func
(paren
id|page
)paren
suffix:semicolon
multiline_comment|/* increment page count */
)brace
r_if
c_cond
(paren
id|type
)paren
op_star
id|type
op_assign
id|VM_FAULT_MINOR
suffix:semicolon
r_return
id|page
suffix:semicolon
)brace
DECL|variable|sg_mmap_vm_ops
r_static
r_struct
id|vm_operations_struct
id|sg_mmap_vm_ops
op_assign
(brace
dot
id|nopage
op_assign
id|sg_vma_nopage
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|sg_mmap
id|sg_mmap
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
id|Sg_fd
op_star
id|sfp
suffix:semicolon
r_int
r_int
id|req_sz
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
id|Sg_scatter_hold
op_star
id|rsv_schp
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|filp
)paren
op_logical_or
(paren
op_logical_neg
id|vma
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_mmap starting, vm_start=%p, len=%d&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|vma-&gt;vm_start
comma
(paren
r_int
)paren
id|req_sz
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_pgoff
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* want no offset */
id|rsv_schp
op_assign
op_amp
id|sfp-&gt;reserve
suffix:semicolon
r_if
c_cond
(paren
id|req_sz
OG
id|rsv_schp-&gt;bufflen
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* cannot map more than reserved buffer */
r_if
c_cond
(paren
id|rsv_schp-&gt;k_use_sg
)paren
(brace
multiline_comment|/* reserve buffer is a scatter gather list */
r_int
id|k
suffix:semicolon
r_int
r_int
id|sa
op_assign
id|vma-&gt;vm_start
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sclp
op_assign
id|rsv_schp-&gt;buffer
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
(paren
id|k
OL
id|rsv_schp-&gt;k_use_sg
)paren
op_logical_and
(paren
id|sa
OL
id|vma-&gt;vm_end
)paren
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_ne
id|sclp-&gt;offset
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* non page aligned memory ?? */
id|len
op_assign
id|vma-&gt;vm_end
op_minus
id|sa
suffix:semicolon
id|len
op_assign
(paren
id|len
OL
id|sclp-&gt;length
)paren
ques
c_cond
id|len
suffix:colon
id|sclp-&gt;length
suffix:semicolon
id|sa
op_add_assign
id|len
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* reserve buffer is just a single allocation */
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|rsv_schp-&gt;buffer
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* non page aligned memory ?? */
)brace
r_if
c_cond
(paren
l_int|0
op_eq
id|sfp-&gt;mmap_called
)paren
(brace
id|sg_rb_correct4mmap
c_func
(paren
id|rsv_schp
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* do only once per fd lifetime */
id|sfp-&gt;mmap_called
op_assign
l_int|1
suffix:semicolon
)brace
id|vma-&gt;vm_flags
op_or_assign
(paren
id|VM_RESERVED
op_or
id|VM_IO
)paren
suffix:semicolon
id|vma-&gt;vm_private_data
op_assign
id|sfp
suffix:semicolon
id|vma-&gt;vm_ops
op_assign
op_amp
id|sg_mmap_vm_ops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This function is a &quot;bottom half&quot; handler that is called by the&n; * mid level when a command is completed (or has failed). */
r_static
r_void
DECL|function|sg_cmd_done
id|sg_cmd_done
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|Scsi_Request
op_star
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
id|Sg_device
op_star
id|sdp
op_assign
l_int|NULL
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_request
op_star
id|srp
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_logical_and
(paren
id|SRpnt
op_assign
id|SCpnt-&gt;sc_request
)paren
)paren
id|srp
op_assign
(paren
id|Sg_request
op_star
)paren
id|SRpnt-&gt;upper_private_data
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|srp
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sg_cmd_done: NULL request&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt
)paren
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sfp
op_assign
id|srp-&gt;parentfp
suffix:semicolon
r_if
c_cond
(paren
id|sfp
)paren
id|sdp
op_assign
id|sfp-&gt;parentdp
suffix:semicolon
r_if
c_cond
(paren
(paren
l_int|NULL
op_eq
id|sdp
)paren
op_logical_or
id|sdp-&gt;detached
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sg_cmd_done: device detached&bslash;n&quot;
)paren
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* First transfer ownership of data buffers to sg_device object. */
id|srp-&gt;data.k_use_sg
op_assign
id|SRpnt-&gt;sr_use_sg
suffix:semicolon
id|srp-&gt;data.sglist_len
op_assign
id|SRpnt-&gt;sr_sglist_len
suffix:semicolon
id|srp-&gt;data.bufflen
op_assign
id|SRpnt-&gt;sr_bufflen
suffix:semicolon
id|srp-&gt;data.buffer
op_assign
id|SRpnt-&gt;sr_buffer
suffix:semicolon
multiline_comment|/* now clear out request structure */
id|SRpnt-&gt;sr_use_sg
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_sglist_len
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_bufflen
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_buffer
op_assign
l_int|NULL
suffix:semicolon
id|SRpnt-&gt;sr_underflow
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_request-&gt;rq_disk
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* &quot;sg&quot; _disowns_ request blk */
id|srp-&gt;my_cmdp
op_assign
l_int|NULL
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_cmd_done: %s, pack_id=%d, res=0x%x&bslash;n&quot;
comma
id|sdp-&gt;disk-&gt;disk_name
comma
id|srp-&gt;header.pack_id
comma
(paren
r_int
)paren
id|SRpnt-&gt;sr_result
)paren
)paren
suffix:semicolon
id|srp-&gt;header.resid
op_assign
id|SCpnt-&gt;resid
suffix:semicolon
multiline_comment|/* N.B. unit of duration changes here from jiffies to millisecs */
id|srp-&gt;header.duration
op_assign
id|jiffies_to_msecs
c_func
(paren
id|jiffies
op_minus
id|srp-&gt;header.duration
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|SRpnt-&gt;sr_result
)paren
(brace
id|memcpy
c_func
(paren
id|srp-&gt;sense_b
comma
id|SRpnt-&gt;sr_sense_buffer
comma
r_sizeof
(paren
id|srp-&gt;sense_b
)paren
)paren
suffix:semicolon
id|srp-&gt;header.status
op_assign
l_int|0xff
op_amp
id|SRpnt-&gt;sr_result
suffix:semicolon
id|srp-&gt;header.masked_status
op_assign
id|status_byte
c_func
(paren
id|SRpnt-&gt;sr_result
)paren
suffix:semicolon
id|srp-&gt;header.msg_status
op_assign
id|msg_byte
c_func
(paren
id|SRpnt-&gt;sr_result
)paren
suffix:semicolon
id|srp-&gt;header.host_status
op_assign
id|host_byte
c_func
(paren
id|SRpnt-&gt;sr_result
)paren
suffix:semicolon
id|srp-&gt;header.driver_status
op_assign
id|driver_byte
c_func
(paren
id|SRpnt-&gt;sr_result
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sdp-&gt;sgdebug
OG
l_int|0
)paren
op_logical_and
(paren
(paren
id|CHECK_CONDITION
op_eq
id|srp-&gt;header.masked_status
)paren
op_logical_or
(paren
id|COMMAND_TERMINATED
op_eq
id|srp-&gt;header.masked_status
)paren
)paren
)paren
id|print_req_sense
c_func
(paren
l_string|&quot;sg_cmd_done&quot;
comma
id|SRpnt
)paren
suffix:semicolon
multiline_comment|/* Following if statement is a patch supplied by Eric Youngdale */
r_if
c_cond
(paren
id|driver_byte
c_func
(paren
id|SRpnt-&gt;sr_result
)paren
op_ne
l_int|0
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x7f
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0xf
)paren
op_eq
id|UNIT_ATTENTION
op_logical_and
id|sdp-&gt;device-&gt;removable
)paren
(brace
multiline_comment|/* Detected disc change. Set the bit - this may be used if */
multiline_comment|/* there are filesystems using this device. */
id|sdp-&gt;device-&gt;changed
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Rely on write phase to clean out srp status values, so no &quot;else&quot; */
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;closed
)paren
(brace
multiline_comment|/* whoops this fd already released, cleanup */
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_cmd_done: already closed, freeing ...&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
id|srp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sfp-&gt;headrp
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg...bh: already closed, final cleanup&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|sg_remove_sfp
c_func
(paren
id|sdp
comma
id|sfp
)paren
)paren
(brace
multiline_comment|/* device still present */
id|scsi_device_put
c_func
(paren
id|sdp-&gt;device
)paren
suffix:semicolon
)brace
id|sfp
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|srp
op_logical_and
id|srp-&gt;orphan
)paren
(brace
r_if
c_cond
(paren
id|sfp-&gt;keep_orphan
)paren
id|srp-&gt;sg_io_owned
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
id|srp
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sfp
op_logical_and
id|srp
)paren
(brace
multiline_comment|/* Now wake up any sg_read() that is waiting for this packet. */
id|kill_fasync
c_func
(paren
op_amp
id|sfp-&gt;async_qp
comma
id|SIGPOLL
comma
id|POLL_IN
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|srp-&gt;done
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|sfp-&gt;read_wait
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
)brace
)brace
DECL|variable|sg_fops
r_static
r_struct
id|file_operations
id|sg_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|read
op_assign
id|sg_read
comma
dot
id|write
op_assign
id|sg_write
comma
dot
id|poll
op_assign
id|sg_poll
comma
dot
id|ioctl
op_assign
id|sg_ioctl
comma
dot
id|open
op_assign
id|sg_open
comma
dot
id|mmap
op_assign
id|sg_mmap
comma
dot
id|release
op_assign
id|sg_release
comma
dot
id|fasync
op_assign
id|sg_fasync
comma
)brace
suffix:semicolon
DECL|variable|sg_sysfs_class
r_static
r_struct
id|class_simple
op_star
id|sg_sysfs_class
suffix:semicolon
DECL|variable|sg_sysfs_valid
r_static
r_int
id|sg_sysfs_valid
op_assign
l_int|0
suffix:semicolon
DECL|function|sg_alloc
r_static
r_int
id|sg_alloc
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
comma
r_struct
id|scsi_device
op_star
id|scsidp
)paren
(brace
id|Sg_device
op_star
id|sdp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_void
op_star
id|old_sg_dev_arr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|k
comma
id|error
suffix:semicolon
id|sdp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|Sg_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sdp
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;kmalloc Sg_device failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|sg_nr_dev
op_ge
id|sg_dev_max
)paren
)paren
(brace
multiline_comment|/* try to resize */
id|Sg_device
op_star
op_star
id|tmp_da
suffix:semicolon
r_int
id|tmp_dev_max
op_assign
id|sg_nr_dev
op_plus
id|SG_DEV_ARR_LUMP
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|tmp_da
op_assign
id|kmalloc
c_func
(paren
id|tmp_dev_max
op_star
r_sizeof
(paren
id|Sg_device
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|tmp_da
)paren
)paren
r_goto
id|expand_failed
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|memset
c_func
(paren
id|tmp_da
comma
l_int|0
comma
id|tmp_dev_max
op_star
r_sizeof
(paren
id|Sg_device
op_star
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tmp_da
comma
id|sg_dev_arr
comma
id|sg_dev_max
op_star
r_sizeof
(paren
id|Sg_device
op_star
)paren
)paren
suffix:semicolon
id|old_sg_dev_arr
op_assign
id|sg_dev_arr
suffix:semicolon
id|sg_dev_arr
op_assign
id|tmp_da
suffix:semicolon
id|sg_dev_max
op_assign
id|tmp_dev_max
suffix:semicolon
)brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|sg_dev_max
suffix:semicolon
id|k
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|sg_dev_arr
(braket
id|k
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|k
op_ge
id|SG_MAX_DEVS
)paren
)paren
r_goto
id|overflow
suffix:semicolon
id|memset
c_func
(paren
id|sdp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sdp
)paren
)paren
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_alloc: dev=%d &bslash;n&quot;
comma
id|k
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;disk_name
comma
l_string|&quot;sg%d&quot;
comma
id|k
)paren
suffix:semicolon
id|disk-&gt;first_minor
op_assign
id|k
suffix:semicolon
id|sdp-&gt;disk
op_assign
id|disk
suffix:semicolon
id|sdp-&gt;device
op_assign
id|scsidp
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sdp-&gt;o_excl_wait
)paren
suffix:semicolon
id|sdp-&gt;sg_tablesize
op_assign
id|scsidp-&gt;host
ques
c_cond
id|scsidp-&gt;host-&gt;sg_tablesize
suffix:colon
l_int|0
suffix:semicolon
id|sg_nr_dev
op_increment
suffix:semicolon
id|sg_dev_arr
(braket
id|k
)braket
op_assign
id|sdp
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|error
op_assign
id|k
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
id|kfree
c_func
(paren
id|sdp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|old_sg_dev_arr
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
id|expand_failed
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sg_alloc: device array cannot be resized&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|overflow
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Unable to attach sg device &lt;%d, %d, %d, %d&gt; type=%d, minor &quot;
l_string|&quot;number exceeds %d&bslash;n&quot;
comma
id|scsidp-&gt;host-&gt;host_no
comma
id|scsidp-&gt;channel
comma
id|scsidp-&gt;id
comma
id|scsidp-&gt;lun
comma
id|scsidp-&gt;type
comma
id|SG_MAX_DEVS
op_minus
l_int|1
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_add
id|sg_add
c_func
(paren
r_struct
id|class_device
op_star
id|cl_dev
)paren
(brace
r_struct
id|scsi_device
op_star
id|scsidp
op_assign
id|to_scsi_device
c_func
(paren
id|cl_dev-&gt;dev
)paren
suffix:semicolon
r_struct
id|gendisk
op_star
id|disk
suffix:semicolon
id|Sg_device
op_star
id|sdp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|cdev
op_star
id|cdev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|error
comma
id|k
suffix:semicolon
id|disk
op_assign
id|alloc_disk
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disk
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;alloc_disk failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|disk-&gt;major
op_assign
id|SCSI_GENERIC_MAJOR
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|cdev
op_assign
id|cdev_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cdev_alloc failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|cdev-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|cdev-&gt;ops
op_assign
op_amp
id|sg_fops
suffix:semicolon
id|error
op_assign
id|sg_alloc
c_func
(paren
id|disk
comma
id|scsidp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sg_alloc failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|k
op_assign
id|error
suffix:semicolon
id|sdp
op_assign
id|sg_dev_arr
(braket
id|k
)braket
suffix:semicolon
id|devfs_mk_cdev
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_GENERIC_MAJOR
comma
id|k
)paren
comma
id|S_IFCHR
op_or
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
comma
l_string|&quot;%s/generic&quot;
comma
id|scsidp-&gt;devfs_name
)paren
suffix:semicolon
id|error
op_assign
id|cdev_add
c_func
(paren
id|cdev
comma
id|MKDEV
c_func
(paren
id|SCSI_GENERIC_MAJOR
comma
id|k
)paren
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|devfs_remove
c_func
(paren
l_string|&quot;%s/generic&quot;
comma
id|scsidp-&gt;devfs_name
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sdp-&gt;cdev
op_assign
id|cdev
suffix:semicolon
r_if
c_cond
(paren
id|sg_sysfs_valid
)paren
(brace
r_struct
id|class_device
op_star
id|sg_class_member
suffix:semicolon
id|sg_class_member
op_assign
id|class_simple_device_add
c_func
(paren
id|sg_sysfs_class
comma
id|MKDEV
c_func
(paren
id|SCSI_GENERIC_MAJOR
comma
id|k
)paren
comma
id|cl_dev-&gt;dev
comma
l_string|&quot;%s&quot;
comma
id|disk-&gt;disk_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|sg_class_member
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sg_add: &quot;
l_string|&quot;class_simple_device_add failed&bslash;n&quot;
)paren
suffix:semicolon
id|class_set_devdata
c_func
(paren
id|sg_class_member
comma
id|sdp
)paren
suffix:semicolon
id|error
op_assign
id|sysfs_create_link
c_func
(paren
op_amp
id|scsidp-&gt;sdev_gendev.kobj
comma
op_amp
id|sg_class_member-&gt;kobj
comma
l_string|&quot;generic&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sg_add: unable to make symlink &quot;
l_string|&quot;&squot;generic&squot; back to sg%d&bslash;n&quot;
comma
id|k
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sg_add: sg_sys INvalid&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Attached scsi generic sg%d at scsi%d, channel&quot;
l_string|&quot; %d, id %d, lun %d,  type %d&bslash;n&quot;
comma
id|k
comma
id|scsidp-&gt;host-&gt;host_no
comma
id|scsidp-&gt;channel
comma
id|scsidp-&gt;id
comma
id|scsidp-&gt;lun
comma
id|scsidp-&gt;type
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|put_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
)paren
id|cdev_del
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_static
r_void
DECL|function|sg_remove
id|sg_remove
c_func
(paren
r_struct
id|class_device
op_star
id|cl_dev
)paren
(brace
r_struct
id|scsi_device
op_star
id|scsidp
op_assign
id|to_scsi_device
c_func
(paren
id|cl_dev-&gt;dev
)paren
suffix:semicolon
id|Sg_device
op_star
id|sdp
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_fd
op_star
id|tsfp
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
id|Sg_request
op_star
id|tsrp
suffix:semicolon
r_int
id|k
comma
id|delay
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sg_dev_arr
)paren
r_return
suffix:semicolon
id|delay
op_assign
l_int|0
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|sg_dev_max
suffix:semicolon
id|k
op_increment
)paren
(brace
id|sdp
op_assign
id|sg_dev_arr
(braket
id|k
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
l_int|NULL
op_eq
id|sdp
)paren
op_logical_or
(paren
id|sdp-&gt;device
op_ne
id|scsidp
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* dirty but lowers nesting */
r_if
c_cond
(paren
id|sdp-&gt;headfp
)paren
(brace
id|sdp-&gt;detached
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|sfp
op_assign
id|sdp-&gt;headfp
suffix:semicolon
id|sfp
suffix:semicolon
id|sfp
op_assign
id|tsfp
)paren
(brace
id|tsfp
op_assign
id|sfp-&gt;nextfp
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|tsrp
)paren
(brace
id|tsrp
op_assign
id|srp-&gt;nextrp
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;closed
op_logical_or
(paren
l_int|0
op_eq
id|sg_srp_done
c_func
(paren
id|srp
comma
id|sfp
)paren
)paren
)paren
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sfp-&gt;closed
)paren
(brace
id|scsi_device_put
c_func
(paren
id|sdp-&gt;device
)paren
suffix:semicolon
id|__sg_remove_sfp
c_func
(paren
id|sdp
comma
id|sfp
)paren
suffix:semicolon
)brace
r_else
(brace
id|delay
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|sfp-&gt;read_wait
)paren
suffix:semicolon
id|kill_fasync
c_func
(paren
op_amp
id|sfp-&gt;async_qp
comma
id|SIGPOLL
comma
id|POLL_HUP
)paren
suffix:semicolon
)brace
)brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_detach: dev=%d, dirty&bslash;n&quot;
comma
id|k
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sdp-&gt;headfp
)paren
(brace
id|sg_dev_arr
(braket
id|k
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* nothing active, simple case */
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_detach: dev=%d&bslash;n&quot;
comma
id|k
)paren
)paren
suffix:semicolon
id|sg_dev_arr
(braket
id|k
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|sg_nr_dev
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdp
)paren
(brace
id|sysfs_remove_link
c_func
(paren
op_amp
id|scsidp-&gt;sdev_gendev.kobj
comma
l_string|&quot;generic&quot;
)paren
suffix:semicolon
id|class_simple_device_remove
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_GENERIC_MAJOR
comma
id|k
)paren
)paren
suffix:semicolon
id|cdev_del
c_func
(paren
id|sdp-&gt;cdev
)paren
suffix:semicolon
id|sdp-&gt;cdev
op_assign
l_int|NULL
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;%s/generic&quot;
comma
id|scsidp-&gt;devfs_name
)paren
suffix:semicolon
id|put_disk
c_func
(paren
id|sdp-&gt;disk
)paren
suffix:semicolon
id|sdp-&gt;disk
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sdp-&gt;headfp
)paren
id|kfree
c_func
(paren
(paren
r_char
op_star
)paren
id|sdp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|delay
)paren
id|msleep
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* dirty detach so delay device destruction */
)brace
multiline_comment|/* Set &squot;perm&squot; (4th argument) to 0 to disable module_param&squot;s definition&n; * of sysfs parameters (which module_param doesn&squot;t yet support).&n; * Sysfs parameters defined explicitly below.&n; */
id|module_param_named
c_func
(paren
id|def_reserved_size
comma
id|def_reserved_size
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|allow_dio
comma
id|sg_allow_dio
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Douglas Gilbert&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SCSI generic (sg) driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|SG_VERSION_STR
id|MODULE_VERSION
c_func
(paren
id|SG_VERSION_STR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|def_reserved_size
comma
l_string|&quot;size of buffer reserved for each fd&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|allow_dio
comma
l_string|&quot;allow direct I/O (default: 0 (disallow))&quot;
)paren
suffix:semicolon
r_static
r_int
id|__init
DECL|function|init_sg
id|init_sg
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|def_reserved_size
op_ge
l_int|0
)paren
id|sg_big_buff
op_assign
id|def_reserved_size
suffix:semicolon
id|rc
op_assign
id|register_chrdev_region
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_GENERIC_MAJOR
comma
l_int|0
)paren
comma
id|SG_MAX_DEVS
comma
l_string|&quot;sg&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|sg_sysfs_class
op_assign
id|class_simple_create
c_func
(paren
id|THIS_MODULE
comma
l_string|&quot;scsi_generic&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|sg_sysfs_class
)paren
)paren
(brace
id|rc
op_assign
id|PTR_ERR
c_func
(paren
id|sg_sysfs_class
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|sg_sysfs_valid
op_assign
l_int|1
suffix:semicolon
id|rc
op_assign
id|scsi_register_interface
c_func
(paren
op_amp
id|sg_interface
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|rc
)paren
(brace
macro_line|#ifdef CONFIG_SCSI_PROC_FS
id|sg_proc_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_SCSI_PROC_FS */
r_return
l_int|0
suffix:semicolon
)brace
id|class_simple_destroy
c_func
(paren
id|sg_sysfs_class
)paren
suffix:semicolon
id|err_out
suffix:colon
id|unregister_chrdev_region
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_GENERIC_MAJOR
comma
l_int|0
)paren
comma
id|SG_MAX_DEVS
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|exit_sg
id|exit_sg
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_SCSI_PROC_FS
id|sg_proc_cleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_SCSI_PROC_FS */
id|scsi_unregister_interface
c_func
(paren
op_amp
id|sg_interface
)paren
suffix:semicolon
id|class_simple_destroy
c_func
(paren
id|sg_sysfs_class
)paren
suffix:semicolon
id|sg_sysfs_valid
op_assign
l_int|0
suffix:semicolon
id|unregister_chrdev_region
c_func
(paren
id|MKDEV
c_func
(paren
id|SCSI_GENERIC_MAJOR
comma
l_int|0
)paren
comma
id|SG_MAX_DEVS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_dev_arr
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
(paren
r_char
op_star
)paren
id|sg_dev_arr
)paren
suffix:semicolon
id|sg_dev_arr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|sg_dev_max
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_start_req
id|sg_start_req
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
(brace
r_int
id|res
suffix:semicolon
id|Sg_fd
op_star
id|sfp
op_assign
id|srp-&gt;parentfp
suffix:semicolon
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
r_int
id|dxfer_len
op_assign
(paren
r_int
)paren
id|hp-&gt;dxfer_len
suffix:semicolon
r_int
id|dxfer_dir
op_assign
id|hp-&gt;dxfer_direction
suffix:semicolon
id|Sg_scatter_hold
op_star
id|req_schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
id|Sg_scatter_hold
op_star
id|rsv_schp
op_assign
op_amp
id|sfp-&gt;reserve
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_start_req: dxfer_len=%d&bslash;n&quot;
comma
id|dxfer_len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dxfer_len
op_le
l_int|0
)paren
op_logical_or
(paren
id|dxfer_dir
op_eq
id|SG_DXFER_NONE
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sg_allow_dio
op_logical_and
(paren
id|hp-&gt;flags
op_amp
id|SG_FLAG_DIRECT_IO
)paren
op_logical_and
(paren
id|dxfer_dir
op_ne
id|SG_DXFER_UNKNOWN
)paren
op_logical_and
(paren
l_int|0
op_eq
id|hp-&gt;iovec_count
)paren
op_logical_and
(paren
op_logical_neg
id|sfp-&gt;parentdp-&gt;device-&gt;host-&gt;unchecked_isa_dma
)paren
)paren
(brace
id|res
op_assign
id|sg_build_direct
c_func
(paren
id|srp
comma
id|sfp
comma
id|dxfer_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_le
l_int|0
)paren
multiline_comment|/* -ve -&gt; error, 0 -&gt; done, 1 -&gt; try indirect */
r_return
id|res
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|sg_res_in_use
c_func
(paren
id|sfp
)paren
)paren
op_logical_and
(paren
id|dxfer_len
op_le
id|rsv_schp-&gt;bufflen
)paren
)paren
id|sg_link_reserve
c_func
(paren
id|sfp
comma
id|srp
comma
id|dxfer_len
)paren
suffix:semicolon
r_else
(brace
id|res
op_assign
id|sg_build_indirect
c_func
(paren
id|req_schp
comma
id|sfp
comma
id|dxfer_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|sg_remove_scat
c_func
(paren
id|req_schp
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sg_finish_rem_req
id|sg_finish_rem_req
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
(brace
id|Sg_fd
op_star
id|sfp
op_assign
id|srp-&gt;parentfp
suffix:semicolon
id|Sg_scatter_hold
op_star
id|req_schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_finish_rem_req: res_used=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|srp-&gt;res_used
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srp-&gt;res_used
)paren
id|sg_unlink_reserve
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_else
id|sg_remove_scat
c_func
(paren
id|req_schp
)paren
suffix:semicolon
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_build_sgat
id|sg_build_sgat
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
comma
r_const
id|Sg_fd
op_star
id|sfp
comma
r_int
id|tablesize
)paren
(brace
r_int
id|ret_sz
suffix:semicolon
r_int
id|elem_sz
op_assign
r_sizeof
(paren
r_struct
id|scatterlist
)paren
suffix:semicolon
r_int
id|sg_bufflen
op_assign
id|tablesize
op_star
id|elem_sz
suffix:semicolon
r_int
id|mx_sc_elems
op_assign
id|tablesize
suffix:semicolon
id|schp-&gt;buffer
op_assign
id|sg_page_malloc
c_func
(paren
id|sg_bufflen
comma
id|sfp-&gt;low_dma
comma
op_amp
id|ret_sz
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|schp-&gt;buffer
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ret_sz
op_ne
id|sg_bufflen
)paren
(brace
id|sg_bufflen
op_assign
id|ret_sz
suffix:semicolon
id|mx_sc_elems
op_assign
id|sg_bufflen
op_div
id|elem_sz
suffix:semicolon
)brace
id|schp-&gt;sglist_len
op_assign
id|sg_bufflen
suffix:semicolon
id|memset
c_func
(paren
id|schp-&gt;buffer
comma
l_int|0
comma
id|sg_bufflen
)paren
suffix:semicolon
r_return
id|mx_sc_elems
suffix:semicolon
multiline_comment|/* number of scat_gath elements allocated */
)brace
macro_line|#ifdef SG_ALLOW_DIO_CODE
multiline_comment|/* vvvvvvvv  following code borrowed from st driver&squot;s direct IO vvvvvvvvv */
multiline_comment|/* hopefully this generic code will moved to a library */
multiline_comment|/* Pin down user pages and put them into a scatter gather list. Returns &lt;= 0 if&n;   - mapping of all pages not successful&n;   - any page is above max_pfn&n;   (i.e., either completely successful or fails)&n;*/
r_static
r_int
DECL|function|st_map_user_pages
id|st_map_user_pages
c_func
(paren
r_struct
id|scatterlist
op_star
id|sgl
comma
r_const
r_int
r_int
id|max_pages
comma
r_int
r_int
id|uaddr
comma
r_int
id|count
comma
r_int
id|rw
comma
r_int
r_int
id|max_pfn
)paren
(brace
r_int
id|res
comma
id|i
comma
id|j
suffix:semicolon
r_int
r_int
id|nr_pages
suffix:semicolon
r_struct
id|page
op_star
op_star
id|pages
suffix:semicolon
id|nr_pages
op_assign
(paren
(paren
id|uaddr
op_amp
op_complement
id|PAGE_MASK
)paren
op_plus
id|count
op_plus
op_complement
id|PAGE_MASK
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
multiline_comment|/* User attempted Overflow! */
r_if
c_cond
(paren
(paren
id|uaddr
op_plus
id|count
)paren
OL
id|uaddr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Too big */
r_if
c_cond
(paren
id|nr_pages
OG
id|max_pages
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Hmm? */
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pages
op_assign
id|kmalloc
c_func
(paren
id|max_pages
op_star
r_sizeof
(paren
op_star
id|pages
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Try to fault in all of the necessary pages */
id|down_read
c_func
(paren
op_amp
id|current-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
multiline_comment|/* rw==READ means read from drive, write into memory area */
id|res
op_assign
id|get_user_pages
c_func
(paren
id|current
comma
id|current-&gt;mm
comma
id|uaddr
comma
id|nr_pages
comma
id|rw
op_eq
id|READ
comma
l_int|0
comma
multiline_comment|/* don&squot;t force */
id|pages
comma
l_int|NULL
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|current-&gt;mm-&gt;mmap_sem
)paren
suffix:semicolon
multiline_comment|/* Errors and no page mapped should return here */
r_if
c_cond
(paren
id|res
OL
id|nr_pages
)paren
r_goto
id|out_unmap
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_pages
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* FIXME: flush superflous for rw==READ,&n;                 * probably wrong function for rw==WRITE&n;                 */
id|flush_dcache_page
c_func
(paren
id|pages
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page_to_pfn
c_func
(paren
id|pages
(braket
id|i
)braket
)paren
OG
id|max_pfn
)paren
r_goto
id|out_unlock
suffix:semicolon
multiline_comment|/* ?? Is locking needed? I don&squot;t think so */
multiline_comment|/* if (TestSetPageLocked(pages[i]))&n;&t;&t;   goto out_unlock; */
)brace
multiline_comment|/* Populate the scatter/gather list */
id|sgl
(braket
l_int|0
)braket
dot
id|page
op_assign
id|pages
(braket
l_int|0
)braket
suffix:semicolon
id|sgl
(braket
l_int|0
)braket
dot
id|offset
op_assign
id|uaddr
op_amp
op_complement
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|nr_pages
OG
l_int|1
)paren
(brace
id|sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
id|PAGE_SIZE
op_minus
id|sgl
(braket
l_int|0
)braket
dot
id|offset
suffix:semicolon
id|count
op_sub_assign
id|sgl
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|nr_pages
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sgl
(braket
id|i
)braket
dot
id|offset
op_assign
l_int|0
suffix:semicolon
id|sgl
(braket
id|i
)braket
dot
id|page
op_assign
id|pages
(braket
id|i
)braket
suffix:semicolon
id|sgl
(braket
id|i
)braket
dot
id|length
op_assign
id|count
OL
id|PAGE_SIZE
ques
c_cond
id|count
suffix:colon
id|PAGE_SIZE
suffix:semicolon
id|count
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
r_else
(brace
id|sgl
(braket
l_int|0
)braket
dot
id|length
op_assign
id|count
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|pages
)paren
suffix:semicolon
r_return
id|nr_pages
suffix:semicolon
id|out_unlock
suffix:colon
multiline_comment|/* for (j=0; j &lt; i; j++)&n;&t;   unlock_page(pages[j]); */
id|res
op_assign
l_int|0
suffix:semicolon
id|out_unmap
suffix:colon
r_if
c_cond
(paren
id|res
OG
l_int|0
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|res
suffix:semicolon
id|j
op_increment
)paren
id|page_cache_release
c_func
(paren
id|pages
(braket
id|j
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pages
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* And unmap them... */
r_static
r_int
DECL|function|st_unmap_user_pages
id|st_unmap_user_pages
c_func
(paren
r_struct
id|scatterlist
op_star
id|sgl
comma
r_const
r_int
r_int
id|nr_pages
comma
r_int
id|dirtied
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_pages
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dirtied
op_logical_and
op_logical_neg
id|PageReserved
c_func
(paren
id|sgl
(braket
id|i
)braket
dot
id|page
)paren
)paren
id|SetPageDirty
c_func
(paren
id|sgl
(braket
id|i
)braket
dot
id|page
)paren
suffix:semicolon
multiline_comment|/* unlock_page(sgl[i].page); */
multiline_comment|/* FIXME: cache flush missing for rw==READ&n;&t;&t; * FIXME: call the correct reference counting function&n;&t;&t; */
id|page_cache_release
c_func
(paren
id|sgl
(braket
id|i
)braket
dot
id|page
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ^^^^^^^^  above code borrowed from st driver&squot;s direct IO ^^^^^^^^^ */
macro_line|#endif
multiline_comment|/* Returns: -ve -&gt; error, 0 -&gt; done, 1 -&gt; try indirect */
r_static
r_int
DECL|function|sg_build_direct
id|sg_build_direct
c_func
(paren
id|Sg_request
op_star
id|srp
comma
id|Sg_fd
op_star
id|sfp
comma
r_int
id|dxfer_len
)paren
(brace
macro_line|#ifdef SG_ALLOW_DIO_CODE
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|Sg_scatter_hold
op_star
id|schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
r_int
id|sg_tablesize
op_assign
id|sfp-&gt;parentdp-&gt;sg_tablesize
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sgl
suffix:semicolon
r_int
id|mx_sc_elems
comma
id|res
suffix:semicolon
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|sfp-&gt;parentdp-&gt;device
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
r_int
)paren
id|hp-&gt;dxferp
op_amp
id|queue_dma_alignment
c_func
(paren
id|sdev-&gt;request_queue
)paren
)paren
op_ne
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|mx_sc_elems
op_assign
id|sg_build_sgat
c_func
(paren
id|schp
comma
id|sfp
comma
id|sg_tablesize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mx_sc_elems
op_le
l_int|0
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|sgl
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|schp-&gt;buffer
suffix:semicolon
id|res
op_assign
id|st_map_user_pages
c_func
(paren
id|sgl
comma
id|mx_sc_elems
comma
(paren
r_int
r_int
)paren
id|hp-&gt;dxferp
comma
id|dxfer_len
comma
(paren
id|SG_DXFER_TO_DEV
op_eq
id|hp-&gt;dxfer_direction
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
id|ULONG_MAX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_le
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|schp-&gt;k_use_sg
op_assign
id|res
suffix:semicolon
id|schp-&gt;dio_in_use
op_assign
l_int|1
suffix:semicolon
id|hp-&gt;info
op_or_assign
id|SG_INFO_DIRECT_IO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_static
r_int
DECL|function|sg_build_indirect
id|sg_build_indirect
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
comma
id|Sg_fd
op_star
id|sfp
comma
r_int
id|buff_size
)paren
(brace
r_int
id|ret_sz
suffix:semicolon
r_int
id|blk_size
op_assign
id|buff_size
suffix:semicolon
r_int
r_char
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|blk_size
OL
l_int|0
)paren
op_logical_or
(paren
op_logical_neg
id|sfp
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|blk_size
)paren
op_increment
id|blk_size
suffix:semicolon
multiline_comment|/* don&squot;t know why */
multiline_comment|/* round request up to next highest SG_SECTOR_SZ byte boundary */
id|blk_size
op_assign
(paren
id|blk_size
op_plus
id|SG_SECTOR_MSK
)paren
op_amp
(paren
op_complement
id|SG_SECTOR_MSK
)paren
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_indirect: buff_size=%d, blk_size=%d&bslash;n&quot;
comma
id|buff_size
comma
id|blk_size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blk_size
op_le
id|SG_SCATTER_SZ
)paren
(brace
id|p
op_assign
id|sg_page_malloc
c_func
(paren
id|blk_size
comma
id|sfp-&gt;low_dma
comma
op_amp
id|ret_sz
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|blk_size
op_eq
id|ret_sz
)paren
(brace
multiline_comment|/* got it on the first attempt */
id|schp-&gt;k_use_sg
op_assign
l_int|0
suffix:semicolon
id|schp-&gt;buffer
op_assign
id|p
suffix:semicolon
id|schp-&gt;bufflen
op_assign
id|blk_size
suffix:semicolon
id|schp-&gt;b_malloc_len
op_assign
id|blk_size
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|p
op_assign
id|sg_page_malloc
c_func
(paren
id|SG_SCATTER_SZ
comma
id|sfp-&gt;low_dma
comma
op_amp
id|ret_sz
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Want some local declarations, so start new block ... */
(brace
multiline_comment|/* lets try and build a scatter gather list */
r_struct
id|scatterlist
op_star
id|sclp
suffix:semicolon
r_int
id|k
comma
id|rem_sz
comma
id|num
suffix:semicolon
r_int
id|mx_sc_elems
suffix:semicolon
r_int
id|sg_tablesize
op_assign
id|sfp-&gt;parentdp-&gt;sg_tablesize
suffix:semicolon
r_int
id|first
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* N.B. ret_sz carried into this block ... */
id|mx_sc_elems
op_assign
id|sg_build_sgat
c_func
(paren
id|schp
comma
id|sfp
comma
id|sg_tablesize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mx_sc_elems
OL
l_int|0
)paren
r_return
id|mx_sc_elems
suffix:semicolon
multiline_comment|/* most likely -ENOMEM */
r_for
c_loop
(paren
id|k
op_assign
l_int|0
comma
id|sclp
op_assign
id|schp-&gt;buffer
comma
id|rem_sz
op_assign
id|blk_size
suffix:semicolon
(paren
id|rem_sz
OG
l_int|0
)paren
op_logical_and
(paren
id|k
OL
id|mx_sc_elems
)paren
suffix:semicolon
op_increment
id|k
comma
id|rem_sz
op_sub_assign
id|ret_sz
comma
op_increment
id|sclp
)paren
(brace
r_if
c_cond
(paren
id|first
)paren
id|first
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|num
op_assign
(paren
id|rem_sz
OG
id|SG_SCATTER_SZ
)paren
ques
c_cond
id|SG_SCATTER_SZ
suffix:colon
id|rem_sz
suffix:semicolon
id|p
op_assign
id|sg_page_malloc
c_func
(paren
id|num
comma
id|sfp-&gt;low_dma
comma
op_amp
id|ret_sz
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_break
suffix:semicolon
)brace
id|sclp-&gt;page
op_assign
id|virt_to_page
c_func
(paren
id|p
)paren
suffix:semicolon
id|sclp-&gt;offset
op_assign
id|offset_in_page
c_func
(paren
id|p
)paren
suffix:semicolon
id|sclp-&gt;length
op_assign
id|ret_sz
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|5
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_build: k=%d, a=0x%p, len=%d&bslash;n&quot;
comma
id|k
comma
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
comma
id|ret_sz
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* end of for loop */
id|schp-&gt;k_use_sg
op_assign
id|k
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|5
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_indirect: k_use_sg=%d, rem_sz=%d&bslash;n&quot;
comma
id|k
comma
id|rem_sz
)paren
)paren
suffix:semicolon
id|schp-&gt;bufflen
op_assign
id|blk_size
suffix:semicolon
r_if
c_cond
(paren
id|rem_sz
OG
l_int|0
)paren
multiline_comment|/* must have failed */
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_write_xfer
id|sg_write_xfer
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
(brace
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|Sg_scatter_hold
op_star
id|schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
r_int
id|num_xfer
op_assign
l_int|0
suffix:semicolon
r_int
id|j
comma
id|k
comma
id|onum
comma
id|usglen
comma
id|ksglen
comma
id|res
suffix:semicolon
r_int
id|iovec_count
op_assign
(paren
r_int
)paren
id|hp-&gt;iovec_count
suffix:semicolon
r_int
id|dxfer_dir
op_assign
id|hp-&gt;dxfer_direction
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_int
r_char
id|__user
op_star
id|up
suffix:semicolon
r_int
id|new_interface
op_assign
(paren
l_char|&squot;&bslash;0&squot;
op_eq
id|hp-&gt;interface_id
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SG_DXFER_UNKNOWN
op_eq
id|dxfer_dir
)paren
op_logical_or
(paren
id|SG_DXFER_TO_DEV
op_eq
id|dxfer_dir
)paren
op_logical_or
(paren
id|SG_DXFER_TO_FROM_DEV
op_eq
id|dxfer_dir
)paren
)paren
(brace
id|num_xfer
op_assign
(paren
r_int
)paren
(paren
id|new_interface
ques
c_cond
id|hp-&gt;dxfer_len
suffix:colon
id|hp-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|schp-&gt;bufflen
OL
id|num_xfer
)paren
id|num_xfer
op_assign
id|schp-&gt;bufflen
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|num_xfer
op_le
l_int|0
)paren
op_logical_or
(paren
id|schp-&gt;dio_in_use
)paren
op_logical_or
(paren
id|new_interface
op_logical_and
(paren
(paren
id|SG_FLAG_NO_DXFER
op_or
id|SG_FLAG_MMAP_IO
)paren
op_amp
id|hp-&gt;flags
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_write_xfer: num_xfer=%d, iovec_count=%d, k_use_sg=%d&bslash;n&quot;
comma
id|num_xfer
comma
id|iovec_count
comma
id|schp-&gt;k_use_sg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iovec_count
)paren
(brace
id|onum
op_assign
id|iovec_count
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|hp-&gt;dxferp
comma
id|SZ_SG_IOVEC
op_star
id|onum
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
)brace
r_else
id|onum
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|schp-&gt;k_use_sg
)paren
(brace
multiline_comment|/* kernel has single buffer */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|p
op_assign
id|schp-&gt;buffer
suffix:semicolon
id|j
OL
id|onum
suffix:semicolon
op_increment
id|j
)paren
(brace
id|res
op_assign
id|sg_u_iovec
c_func
(paren
id|hp
comma
id|iovec_count
comma
id|j
comma
l_int|1
comma
op_amp
id|usglen
comma
op_amp
id|up
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
id|usglen
op_assign
(paren
id|num_xfer
OG
id|usglen
)paren
ques
c_cond
id|usglen
suffix:colon
id|num_xfer
suffix:semicolon
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
id|p
comma
id|up
comma
id|usglen
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|p
op_add_assign
id|usglen
suffix:semicolon
id|num_xfer
op_sub_assign
id|usglen
suffix:semicolon
r_if
c_cond
(paren
id|num_xfer
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* kernel using scatter gather list */
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|schp-&gt;buffer
suffix:semicolon
id|ksglen
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
suffix:semicolon
id|p
op_assign
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|k
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|onum
suffix:semicolon
op_increment
id|j
)paren
(brace
id|res
op_assign
id|sg_u_iovec
c_func
(paren
id|hp
comma
id|iovec_count
comma
id|j
comma
l_int|1
comma
op_amp
id|usglen
comma
op_amp
id|up
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|p
suffix:semicolon
op_increment
id|sclp
comma
id|ksglen
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
comma
id|p
op_assign
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
)paren
(brace
r_if
c_cond
(paren
id|usglen
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ksglen
OG
id|usglen
)paren
(brace
r_if
c_cond
(paren
id|usglen
op_ge
id|num_xfer
)paren
(brace
r_if
c_cond
(paren
id|__copy_from_user
(paren
id|p
comma
id|up
comma
id|num_xfer
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
id|p
comma
id|up
comma
id|usglen
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|p
op_add_assign
id|usglen
suffix:semicolon
id|ksglen
op_sub_assign
id|usglen
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ksglen
op_ge
id|num_xfer
)paren
(brace
r_if
c_cond
(paren
id|__copy_from_user
(paren
id|p
comma
id|up
comma
id|num_xfer
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
id|p
comma
id|up
comma
id|ksglen
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|up
op_add_assign
id|ksglen
suffix:semicolon
id|usglen
op_sub_assign
id|ksglen
suffix:semicolon
)brace
op_increment
id|k
suffix:semicolon
r_if
c_cond
(paren
id|k
op_ge
id|schp-&gt;k_use_sg
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_u_iovec
id|sg_u_iovec
c_func
(paren
id|sg_io_hdr_t
op_star
id|hp
comma
r_int
id|sg_num
comma
r_int
id|ind
comma
r_int
id|wr_xf
comma
r_int
op_star
id|countp
comma
r_int
r_char
id|__user
op_star
op_star
id|up
)paren
(brace
r_int
id|num_xfer
op_assign
(paren
r_int
)paren
id|hp-&gt;dxfer_len
suffix:semicolon
r_int
r_char
id|__user
op_star
id|p
op_assign
id|hp-&gt;dxferp
suffix:semicolon
r_int
id|count
comma
id|k
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|sg_num
)paren
(brace
r_if
c_cond
(paren
id|wr_xf
op_logical_and
(paren
l_char|&squot;&bslash;0&squot;
op_eq
id|hp-&gt;interface_id
)paren
)paren
id|count
op_assign
(paren
r_int
)paren
id|hp-&gt;flags
suffix:semicolon
multiline_comment|/* holds &quot;old&quot; input_size */
r_else
id|count
op_assign
id|num_xfer
suffix:semicolon
)brace
r_else
(brace
id|sg_iovec_t
id|iovec
suffix:semicolon
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
op_amp
id|iovec
comma
id|p
op_plus
id|ind
op_star
id|SZ_SG_IOVEC
comma
id|SZ_SG_IOVEC
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|p
op_assign
id|iovec.iov_base
suffix:semicolon
id|count
op_assign
(paren
r_int
)paren
id|iovec.iov_len
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|wr_xf
ques
c_cond
id|VERIFY_READ
suffix:colon
id|VERIFY_WRITE
comma
id|p
comma
id|count
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
r_if
c_cond
(paren
id|up
)paren
op_star
id|up
op_assign
id|p
suffix:semicolon
r_if
c_cond
(paren
id|countp
)paren
op_star
id|countp
op_assign
id|count
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sg_remove_scat
id|sg_remove_scat
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_remove_scat: k_use_sg=%d&bslash;n&quot;
comma
id|schp-&gt;k_use_sg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|schp-&gt;buffer
op_logical_and
(paren
id|schp-&gt;sglist_len
OG
l_int|0
)paren
)paren
(brace
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|schp-&gt;buffer
suffix:semicolon
r_if
c_cond
(paren
id|schp-&gt;dio_in_use
)paren
(brace
macro_line|#ifdef SG_ALLOW_DIO_CODE
id|st_unmap_user_pages
c_func
(paren
id|sclp
comma
id|schp-&gt;k_use_sg
comma
id|TRUE
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_int
id|k
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
(paren
id|k
OL
id|schp-&gt;k_use_sg
)paren
op_logical_and
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|5
comma
id|printk
c_func
(paren
l_string|&quot;sg_remove_scat: k=%d, a=0x%p, len=%d&bslash;n&quot;
comma
id|k
comma
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
comma
id|sclp-&gt;length
)paren
)paren
suffix:semicolon
id|sg_page_free
c_func
(paren
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
comma
id|sclp-&gt;length
)paren
suffix:semicolon
id|sclp-&gt;page
op_assign
l_int|NULL
suffix:semicolon
id|sclp-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|sclp-&gt;length
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|sg_page_free
c_func
(paren
id|schp-&gt;buffer
comma
id|schp-&gt;sglist_len
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|schp-&gt;buffer
)paren
id|sg_page_free
c_func
(paren
id|schp-&gt;buffer
comma
id|schp-&gt;b_malloc_len
)paren
suffix:semicolon
id|memset
c_func
(paren
id|schp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|schp
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_read_xfer
id|sg_read_xfer
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
(brace
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|Sg_scatter_hold
op_star
id|schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
r_int
id|num_xfer
op_assign
l_int|0
suffix:semicolon
r_int
id|j
comma
id|k
comma
id|onum
comma
id|usglen
comma
id|ksglen
comma
id|res
suffix:semicolon
r_int
id|iovec_count
op_assign
(paren
r_int
)paren
id|hp-&gt;iovec_count
suffix:semicolon
r_int
id|dxfer_dir
op_assign
id|hp-&gt;dxfer_direction
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_int
r_char
id|__user
op_star
id|up
suffix:semicolon
r_int
id|new_interface
op_assign
(paren
l_char|&squot;&bslash;0&squot;
op_eq
id|hp-&gt;interface_id
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SG_DXFER_UNKNOWN
op_eq
id|dxfer_dir
)paren
op_logical_or
(paren
id|SG_DXFER_FROM_DEV
op_eq
id|dxfer_dir
)paren
op_logical_or
(paren
id|SG_DXFER_TO_FROM_DEV
op_eq
id|dxfer_dir
)paren
)paren
(brace
id|num_xfer
op_assign
id|hp-&gt;dxfer_len
suffix:semicolon
r_if
c_cond
(paren
id|schp-&gt;bufflen
OL
id|num_xfer
)paren
id|num_xfer
op_assign
id|schp-&gt;bufflen
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|num_xfer
op_le
l_int|0
)paren
op_logical_or
(paren
id|schp-&gt;dio_in_use
)paren
op_logical_or
(paren
id|new_interface
op_logical_and
(paren
(paren
id|SG_FLAG_NO_DXFER
op_or
id|SG_FLAG_MMAP_IO
)paren
op_amp
id|hp-&gt;flags
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_read_xfer: num_xfer=%d, iovec_count=%d, k_use_sg=%d&bslash;n&quot;
comma
id|num_xfer
comma
id|iovec_count
comma
id|schp-&gt;k_use_sg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iovec_count
)paren
(brace
id|onum
op_assign
id|iovec_count
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|hp-&gt;dxferp
comma
id|SZ_SG_IOVEC
op_star
id|onum
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
)brace
r_else
id|onum
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|schp-&gt;k_use_sg
)paren
(brace
multiline_comment|/* kernel has single buffer */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|p
op_assign
id|schp-&gt;buffer
suffix:semicolon
id|j
OL
id|onum
suffix:semicolon
op_increment
id|j
)paren
(brace
id|res
op_assign
id|sg_u_iovec
c_func
(paren
id|hp
comma
id|iovec_count
comma
id|j
comma
l_int|0
comma
op_amp
id|usglen
comma
op_amp
id|up
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
id|usglen
op_assign
(paren
id|num_xfer
OG
id|usglen
)paren
ques
c_cond
id|usglen
suffix:colon
id|num_xfer
suffix:semicolon
r_if
c_cond
(paren
id|__copy_to_user
c_func
(paren
id|up
comma
id|p
comma
id|usglen
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|p
op_add_assign
id|usglen
suffix:semicolon
id|num_xfer
op_sub_assign
id|usglen
suffix:semicolon
r_if
c_cond
(paren
id|num_xfer
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* kernel using scatter gather list */
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|schp-&gt;buffer
suffix:semicolon
id|ksglen
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
suffix:semicolon
id|p
op_assign
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|k
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|onum
suffix:semicolon
op_increment
id|j
)paren
(brace
id|res
op_assign
id|sg_u_iovec
c_func
(paren
id|hp
comma
id|iovec_count
comma
id|j
comma
l_int|0
comma
op_amp
id|usglen
comma
op_amp
id|up
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|p
suffix:semicolon
op_increment
id|sclp
comma
id|ksglen
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
comma
id|p
op_assign
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
)paren
(brace
r_if
c_cond
(paren
id|usglen
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ksglen
OG
id|usglen
)paren
(brace
r_if
c_cond
(paren
id|usglen
op_ge
id|num_xfer
)paren
(brace
r_if
c_cond
(paren
id|__copy_to_user
(paren
id|up
comma
id|p
comma
id|num_xfer
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|__copy_to_user
c_func
(paren
id|up
comma
id|p
comma
id|usglen
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|p
op_add_assign
id|usglen
suffix:semicolon
id|ksglen
op_sub_assign
id|usglen
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ksglen
op_ge
id|num_xfer
)paren
(brace
r_if
c_cond
(paren
id|__copy_to_user
(paren
id|up
comma
id|p
comma
id|num_xfer
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|__copy_to_user
c_func
(paren
id|up
comma
id|p
comma
id|ksglen
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|up
op_add_assign
id|ksglen
suffix:semicolon
id|usglen
op_sub_assign
id|ksglen
suffix:semicolon
)brace
op_increment
id|k
suffix:semicolon
r_if
c_cond
(paren
id|k
op_ge
id|schp-&gt;k_use_sg
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_read_oxfer
id|sg_read_oxfer
c_func
(paren
id|Sg_request
op_star
id|srp
comma
r_char
id|__user
op_star
id|outp
comma
r_int
id|num_read_xfer
)paren
(brace
id|Sg_scatter_hold
op_star
id|schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_read_oxfer: num_read_xfer=%d&bslash;n&quot;
comma
id|num_read_xfer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|outp
)paren
op_logical_or
(paren
id|num_read_xfer
op_le
l_int|0
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|schp-&gt;k_use_sg
OG
l_int|0
)paren
(brace
r_int
id|k
comma
id|num
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|schp-&gt;buffer
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
(paren
id|k
OL
id|schp-&gt;k_use_sg
)paren
op_logical_and
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
)paren
(brace
id|num
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
suffix:semicolon
r_if
c_cond
(paren
id|num
OG
id|num_read_xfer
)paren
(brace
r_if
c_cond
(paren
id|__copy_to_user
(paren
id|outp
comma
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
comma
id|num_read_xfer
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|__copy_to_user
(paren
id|outp
comma
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
comma
id|num
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|num_read_xfer
op_sub_assign
id|num
suffix:semicolon
r_if
c_cond
(paren
id|num_read_xfer
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|outp
op_add_assign
id|num
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|__copy_to_user
c_func
(paren
id|outp
comma
id|schp-&gt;buffer
comma
id|num_read_xfer
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sg_build_reserve
id|sg_build_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_int
id|req_size
)paren
(brace
id|Sg_scatter_hold
op_star
id|schp
op_assign
op_amp
id|sfp-&gt;reserve
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_reserve: req_size=%d&bslash;n&quot;
comma
id|req_size
)paren
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|req_size
OL
id|PAGE_SIZE
)paren
id|req_size
op_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|sg_build_indirect
c_func
(paren
id|schp
comma
id|sfp
comma
id|req_size
)paren
)paren
r_return
suffix:semicolon
r_else
id|sg_remove_scat
c_func
(paren
id|schp
)paren
suffix:semicolon
id|req_size
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* divide by 2 */
)brace
r_while
c_loop
(paren
id|req_size
OG
(paren
id|PAGE_SIZE
op_div
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|sg_link_reserve
id|sg_link_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
comma
r_int
id|size
)paren
(brace
id|Sg_scatter_hold
op_star
id|req_schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
id|Sg_scatter_hold
op_star
id|rsv_schp
op_assign
op_amp
id|sfp-&gt;reserve
suffix:semicolon
id|srp-&gt;res_used
op_assign
l_int|1
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_link_reserve: size=%d&bslash;n&quot;
comma
id|size
)paren
)paren
suffix:semicolon
id|size
op_assign
(paren
id|size
op_plus
l_int|1
)paren
op_amp
(paren
op_complement
l_int|1
)paren
suffix:semicolon
multiline_comment|/* round to even for aha1542 */
r_if
c_cond
(paren
id|rsv_schp-&gt;k_use_sg
OG
l_int|0
)paren
(brace
r_int
id|k
comma
id|num
suffix:semicolon
r_int
id|rem
op_assign
id|size
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|rsv_schp-&gt;buffer
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|rsv_schp-&gt;k_use_sg
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
)paren
(brace
id|num
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
suffix:semicolon
r_if
c_cond
(paren
id|rem
op_le
id|num
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|k
)paren
(brace
id|req_schp-&gt;k_use_sg
op_assign
l_int|0
suffix:semicolon
id|req_schp-&gt;buffer
op_assign
id|sg_scatg2virt
c_func
(paren
id|sclp
)paren
suffix:semicolon
)brace
r_else
(brace
id|sfp-&gt;save_scat_len
op_assign
id|num
suffix:semicolon
id|sclp-&gt;length
op_assign
(paren
r_int
)paren
id|rem
suffix:semicolon
id|req_schp-&gt;k_use_sg
op_assign
id|k
op_plus
l_int|1
suffix:semicolon
id|req_schp-&gt;sglist_len
op_assign
id|rsv_schp-&gt;sglist_len
suffix:semicolon
id|req_schp-&gt;buffer
op_assign
id|rsv_schp-&gt;buffer
suffix:semicolon
)brace
id|req_schp-&gt;bufflen
op_assign
id|size
suffix:semicolon
id|req_schp-&gt;b_malloc_len
op_assign
id|rsv_schp-&gt;b_malloc_len
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|rem
op_sub_assign
id|num
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
op_ge
id|rsv_schp-&gt;k_use_sg
)paren
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_link_reserve: BAD size&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|req_schp-&gt;k_use_sg
op_assign
l_int|0
suffix:semicolon
id|req_schp-&gt;bufflen
op_assign
id|size
suffix:semicolon
id|req_schp-&gt;buffer
op_assign
id|rsv_schp-&gt;buffer
suffix:semicolon
id|req_schp-&gt;b_malloc_len
op_assign
id|rsv_schp-&gt;b_malloc_len
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|sg_unlink_reserve
id|sg_unlink_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
)paren
(brace
id|Sg_scatter_hold
op_star
id|req_schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
id|Sg_scatter_hold
op_star
id|rsv_schp
op_assign
op_amp
id|sfp-&gt;reserve
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_unlink_reserve: req-&gt;k_use_sg=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|req_schp-&gt;k_use_sg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rsv_schp-&gt;k_use_sg
OG
l_int|0
)paren
op_logical_and
(paren
id|req_schp-&gt;k_use_sg
OG
l_int|0
)paren
)paren
(brace
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|rsv_schp-&gt;buffer
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;save_scat_len
OG
l_int|0
)paren
(paren
id|sclp
op_plus
(paren
id|req_schp-&gt;k_use_sg
op_minus
l_int|1
)paren
)paren
op_member_access_from_pointer
id|length
op_assign
(paren
r_int
)paren
id|sfp-&gt;save_scat_len
suffix:semicolon
r_else
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
(paren
l_string|&quot;sg_unlink_reserve: BAD save_scat_len&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|req_schp-&gt;k_use_sg
op_assign
l_int|0
suffix:semicolon
id|req_schp-&gt;bufflen
op_assign
l_int|0
suffix:semicolon
id|req_schp-&gt;buffer
op_assign
l_int|NULL
suffix:semicolon
id|req_schp-&gt;sglist_len
op_assign
l_int|0
suffix:semicolon
id|sfp-&gt;save_scat_len
op_assign
l_int|0
suffix:semicolon
id|srp-&gt;res_used
op_assign
l_int|0
suffix:semicolon
)brace
r_static
id|Sg_request
op_star
DECL|function|sg_get_rq_mark
id|sg_get_rq_mark
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_int
id|pack_id
)paren
(brace
id|Sg_request
op_star
id|resp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|resp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|resp
suffix:semicolon
id|resp
op_assign
id|resp-&gt;nextrp
)paren
(brace
multiline_comment|/* look for requests that are ready + not SG_IO owned */
r_if
c_cond
(paren
(paren
l_int|1
op_eq
id|resp-&gt;done
)paren
op_logical_and
(paren
op_logical_neg
id|resp-&gt;sg_io_owned
)paren
op_logical_and
(paren
(paren
op_minus
l_int|1
op_eq
id|pack_id
)paren
op_logical_or
(paren
id|resp-&gt;header.pack_id
op_eq
id|pack_id
)paren
)paren
)paren
(brace
id|resp-&gt;done
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* guard against other readers */
r_break
suffix:semicolon
)brace
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SCSI_PROC_FS
r_static
id|Sg_request
op_star
DECL|function|sg_get_nth_request
id|sg_get_nth_request
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_int
id|nth
)paren
(brace
id|Sg_request
op_star
id|resp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_int
id|k
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
comma
id|resp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|resp
op_logical_and
(paren
id|k
OL
id|nth
)paren
suffix:semicolon
op_increment
id|k
comma
id|resp
op_assign
id|resp-&gt;nextrp
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* always adds to end of list */
r_static
id|Sg_request
op_star
DECL|function|sg_add_request
id|sg_add_request
c_func
(paren
id|Sg_fd
op_star
id|sfp
)paren
(brace
r_int
id|k
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|Sg_request
op_star
id|resp
suffix:semicolon
id|Sg_request
op_star
id|rp
op_assign
id|sfp-&gt;req_arr
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|resp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|resp
)paren
(brace
id|memset
c_func
(paren
id|rp
comma
l_int|0
comma
r_sizeof
(paren
id|Sg_request
)paren
)paren
suffix:semicolon
id|rp-&gt;parentfp
op_assign
id|sfp
suffix:semicolon
id|resp
op_assign
id|rp
suffix:semicolon
id|sfp-&gt;headrp
op_assign
id|resp
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|sfp-&gt;cmd_q
)paren
id|resp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* command queuing disallowed */
r_else
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|SG_MAX_QUEUE
suffix:semicolon
op_increment
id|k
comma
op_increment
id|rp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rp-&gt;parentfp
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
OL
id|SG_MAX_QUEUE
)paren
(brace
id|memset
c_func
(paren
id|rp
comma
l_int|0
comma
r_sizeof
(paren
id|Sg_request
)paren
)paren
suffix:semicolon
id|rp-&gt;parentfp
op_assign
id|sfp
suffix:semicolon
r_while
c_loop
(paren
id|resp-&gt;nextrp
)paren
id|resp
op_assign
id|resp-&gt;nextrp
suffix:semicolon
id|resp-&gt;nextrp
op_assign
id|rp
suffix:semicolon
id|resp
op_assign
id|rp
suffix:semicolon
)brace
r_else
id|resp
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|resp
)paren
(brace
id|resp-&gt;nextrp
op_assign
l_int|NULL
suffix:semicolon
id|resp-&gt;header.duration
op_assign
id|jiffies
suffix:semicolon
id|resp-&gt;my_cmdp
op_assign
l_int|NULL
suffix:semicolon
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
multiline_comment|/* Return of 1 for found; 0 for not found */
r_static
r_int
DECL|function|sg_remove_request
id|sg_remove_request
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
)paren
(brace
id|Sg_request
op_star
id|prev_rp
suffix:semicolon
id|Sg_request
op_star
id|rp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|sfp
)paren
op_logical_or
(paren
op_logical_neg
id|srp
)paren
op_logical_or
(paren
op_logical_neg
id|sfp-&gt;headrp
)paren
)paren
r_return
id|res
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|prev_rp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
r_if
c_cond
(paren
id|srp
op_eq
id|prev_rp
)paren
(brace
id|sfp-&gt;headrp
op_assign
id|prev_rp-&gt;nextrp
suffix:semicolon
id|prev_rp-&gt;parentfp
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
(paren
id|rp
op_assign
id|prev_rp-&gt;nextrp
)paren
)paren
(brace
r_if
c_cond
(paren
id|srp
op_eq
id|rp
)paren
(brace
id|prev_rp-&gt;nextrp
op_assign
id|rp-&gt;nextrp
suffix:semicolon
id|rp-&gt;parentfp
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|prev_rp
op_assign
id|rp
suffix:semicolon
)brace
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SCSI_PROC_FS
r_static
id|Sg_fd
op_star
DECL|function|sg_get_nth_sfp
id|sg_get_nth_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
r_int
id|nth
)paren
(brace
id|Sg_fd
op_star
id|resp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_int
id|k
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
comma
id|resp
op_assign
id|sdp-&gt;headfp
suffix:semicolon
id|resp
op_logical_and
(paren
id|k
OL
id|nth
)paren
suffix:semicolon
op_increment
id|k
comma
id|resp
op_assign
id|resp-&gt;nextfp
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
macro_line|#endif
r_static
id|Sg_fd
op_star
DECL|function|sg_add_sfp
id|sg_add_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
r_int
id|dev
)paren
(brace
id|Sg_fd
op_star
id|sfp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|sg_page_malloc
c_func
(paren
r_sizeof
(paren
id|Sg_fd
)paren
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sfp
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|sfp
comma
l_int|0
comma
r_sizeof
(paren
id|Sg_fd
)paren
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sfp-&gt;read_wait
)paren
suffix:semicolon
id|sfp-&gt;rq_list_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
id|sfp-&gt;timeout
op_assign
id|SG_DEFAULT_TIMEOUT
suffix:semicolon
id|sfp-&gt;timeout_user
op_assign
id|SG_DEFAULT_TIMEOUT_USER
suffix:semicolon
id|sfp-&gt;force_packid
op_assign
id|SG_DEF_FORCE_PACK_ID
suffix:semicolon
id|sfp-&gt;low_dma
op_assign
(paren
id|SG_DEF_FORCE_LOW_DMA
op_eq
l_int|0
)paren
ques
c_cond
id|sdp-&gt;device-&gt;host-&gt;unchecked_isa_dma
suffix:colon
l_int|1
suffix:semicolon
id|sfp-&gt;cmd_q
op_assign
id|SG_DEF_COMMAND_Q
suffix:semicolon
id|sfp-&gt;keep_orphan
op_assign
id|SG_DEF_KEEP_ORPHAN
suffix:semicolon
id|sfp-&gt;parentdp
op_assign
id|sdp
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sdp-&gt;headfp
)paren
id|sdp-&gt;headfp
op_assign
id|sfp
suffix:semicolon
r_else
(brace
multiline_comment|/* add to tail of existing list */
id|Sg_fd
op_star
id|pfp
op_assign
id|sdp-&gt;headfp
suffix:semicolon
r_while
c_loop
(paren
id|pfp-&gt;nextfp
)paren
id|pfp
op_assign
id|pfp-&gt;nextfp
suffix:semicolon
id|pfp-&gt;nextfp
op_assign
id|sfp
suffix:semicolon
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_add_sfp: sfp=0x%p&bslash;n&quot;
comma
id|sfp
)paren
)paren
suffix:semicolon
id|sg_build_reserve
c_func
(paren
id|sfp
comma
id|sg_big_buff
)paren
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_add_sfp:   bufflen=%d, k_use_sg=%d&bslash;n&quot;
comma
id|sfp-&gt;reserve.bufflen
comma
id|sfp-&gt;reserve.k_use_sg
)paren
)paren
suffix:semicolon
r_return
id|sfp
suffix:semicolon
)brace
r_static
r_void
DECL|function|__sg_remove_sfp
id|__sg_remove_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
id|Sg_fd
op_star
id|sfp
)paren
(brace
id|Sg_fd
op_star
id|fp
suffix:semicolon
id|Sg_fd
op_star
id|prev_fp
suffix:semicolon
id|prev_fp
op_assign
id|sdp-&gt;headfp
suffix:semicolon
r_if
c_cond
(paren
id|sfp
op_eq
id|prev_fp
)paren
id|sdp-&gt;headfp
op_assign
id|prev_fp-&gt;nextfp
suffix:semicolon
r_else
(brace
r_while
c_loop
(paren
(paren
id|fp
op_assign
id|prev_fp-&gt;nextfp
)paren
)paren
(brace
r_if
c_cond
(paren
id|sfp
op_eq
id|fp
)paren
(brace
id|prev_fp-&gt;nextfp
op_assign
id|fp-&gt;nextfp
suffix:semicolon
r_break
suffix:semicolon
)brace
id|prev_fp
op_assign
id|fp
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sfp-&gt;reserve.bufflen
OG
l_int|0
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|6
comma
id|printk
c_func
(paren
l_string|&quot;__sg_remove_sfp:    bufflen=%d, k_use_sg=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|sfp-&gt;reserve.bufflen
comma
(paren
r_int
)paren
id|sfp-&gt;reserve.k_use_sg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;mmap_called
)paren
id|sg_rb_correct4mmap
c_func
(paren
op_amp
id|sfp-&gt;reserve
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* undo correction */
id|sg_remove_scat
c_func
(paren
op_amp
id|sfp-&gt;reserve
)paren
suffix:semicolon
)brace
id|sfp-&gt;parentdp
op_assign
l_int|NULL
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|6
comma
id|printk
c_func
(paren
l_string|&quot;__sg_remove_sfp:    sfp=0x%p&bslash;n&quot;
comma
id|sfp
)paren
)paren
suffix:semicolon
id|sg_page_free
c_func
(paren
(paren
r_char
op_star
)paren
id|sfp
comma
r_sizeof
(paren
id|Sg_fd
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Returns 0 in normal case, 1 when detached and sdp object removed */
r_static
r_int
DECL|function|sg_remove_sfp
id|sg_remove_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
id|Sg_fd
op_star
id|sfp
)paren
(brace
id|Sg_request
op_star
id|srp
suffix:semicolon
id|Sg_request
op_star
id|tsrp
suffix:semicolon
r_int
id|dirty
op_assign
l_int|0
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|tsrp
)paren
(brace
id|tsrp
op_assign
id|srp-&gt;nextrp
suffix:semicolon
r_if
c_cond
(paren
id|sg_srp_done
c_func
(paren
id|srp
comma
id|sfp
)paren
)paren
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_else
op_increment
id|dirty
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_eq
id|dirty
)paren
(brace
r_int
r_int
id|iflags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|__sg_remove_sfp
c_func
(paren
id|sdp
comma
id|sfp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdp-&gt;detached
op_logical_and
(paren
l_int|NULL
op_eq
id|sdp-&gt;headfp
)paren
)paren
(brace
r_int
id|k
comma
id|maxd
suffix:semicolon
id|maxd
op_assign
id|sg_dev_max
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|maxd
suffix:semicolon
op_increment
id|k
)paren
(brace
r_if
c_cond
(paren
id|sdp
op_eq
id|sg_dev_arr
(braket
id|k
)braket
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
OL
id|maxd
)paren
id|sg_dev_arr
(braket
id|k
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_char
op_star
)paren
id|sdp
)paren
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* MOD_INC&squot;s to inhibit unloading sg and associated adapter driver */
multiline_comment|/* only bump the access_count if we actually succeeded in&n;&t;&t; * throwing another counter on the host module */
id|scsi_device_get
c_func
(paren
id|sdp-&gt;device
)paren
suffix:semicolon
multiline_comment|/* XXX: retval ignored? */
id|sfp-&gt;closed
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* flag dirty state on this fd */
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_remove_sfp: worrisome, %d writes pending&bslash;n&quot;
comma
id|dirty
)paren
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
r_static
r_int
DECL|function|sg_res_in_use
id|sg_res_in_use
c_func
(paren
id|Sg_fd
op_star
id|sfp
)paren
(brace
r_const
id|Sg_request
op_star
id|srp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|srp-&gt;nextrp
)paren
r_if
c_cond
(paren
id|srp-&gt;res_used
)paren
r_break
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|srp
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If retSzp==NULL want exact size or fail */
r_static
r_char
op_star
DECL|function|sg_page_malloc
id|sg_page_malloc
c_func
(paren
r_int
id|rqSz
comma
r_int
id|lowDma
comma
r_int
op_star
id|retSzp
)paren
(brace
r_char
op_star
id|resp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|page_mask
suffix:semicolon
r_int
id|order
comma
id|a_size
suffix:semicolon
r_int
id|resSz
op_assign
id|rqSz
suffix:semicolon
r_if
c_cond
(paren
id|rqSz
op_le
l_int|0
)paren
r_return
id|resp
suffix:semicolon
r_if
c_cond
(paren
id|lowDma
)paren
id|page_mask
op_assign
id|GFP_ATOMIC
op_or
id|GFP_DMA
op_or
id|__GFP_NOWARN
suffix:semicolon
r_else
id|page_mask
op_assign
id|GFP_ATOMIC
op_or
id|__GFP_NOWARN
suffix:semicolon
r_for
c_loop
(paren
id|order
op_assign
l_int|0
comma
id|a_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|a_size
OL
id|rqSz
suffix:semicolon
id|order
op_increment
comma
id|a_size
op_lshift_assign
l_int|1
)paren
suffix:semicolon
id|resp
op_assign
(paren
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|page_mask
comma
id|order
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
id|resp
)paren
op_logical_and
id|order
op_logical_and
id|retSzp
)paren
(brace
op_decrement
id|order
suffix:semicolon
id|a_size
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* divide by 2, until PAGE_SIZE */
id|resp
op_assign
(paren
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|page_mask
comma
id|order
)paren
suffix:semicolon
multiline_comment|/* try half */
id|resSz
op_assign
id|a_size
suffix:semicolon
)brace
r_if
c_cond
(paren
id|resp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_or
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
id|memset
c_func
(paren
id|resp
comma
l_int|0
comma
id|resSz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retSzp
)paren
op_star
id|retSzp
op_assign
id|resSz
suffix:semicolon
)brace
r_return
id|resp
suffix:semicolon
)brace
r_static
r_void
DECL|function|sg_page_free
id|sg_page_free
c_func
(paren
r_char
op_star
id|buff
comma
r_int
id|size
)paren
(brace
r_int
id|order
comma
id|a_size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buff
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|order
op_assign
l_int|0
comma
id|a_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|a_size
OL
id|size
suffix:semicolon
id|order
op_increment
comma
id|a_size
op_lshift_assign
l_int|1
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|buff
comma
id|order
)paren
suffix:semicolon
)brace
DECL|variable|allow_ops
r_static
r_int
r_char
id|allow_ops
(braket
)braket
op_assign
(brace
id|TEST_UNIT_READY
comma
id|REQUEST_SENSE
comma
id|INQUIRY
comma
id|READ_CAPACITY
comma
id|READ_BUFFER
comma
id|READ_6
comma
id|READ_10
comma
id|READ_12
comma
id|MODE_SENSE
comma
id|MODE_SENSE_10
comma
id|LOG_SENSE
)brace
suffix:semicolon
r_static
r_int
DECL|function|sg_allow_access
id|sg_allow_access
c_func
(paren
r_int
r_char
id|opcode
comma
r_char
id|dev_type
)paren
(brace
r_int
id|k
suffix:semicolon
r_if
c_cond
(paren
id|TYPE_SCANNER
op_eq
id|dev_type
)paren
multiline_comment|/* TYPE_ROM maybe burner */
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
r_sizeof
(paren
id|allow_ops
)paren
suffix:semicolon
op_increment
id|k
)paren
(brace
r_if
c_cond
(paren
id|opcode
op_eq
id|allow_ops
(braket
id|k
)braket
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SCSI_PROC_FS
r_static
r_int
DECL|function|sg_last_dev
id|sg_last_dev
c_func
(paren
r_void
)paren
(brace
r_int
id|k
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
id|sg_dev_max
op_minus
l_int|1
suffix:semicolon
id|k
op_ge
l_int|0
suffix:semicolon
op_decrement
id|k
)paren
r_if
c_cond
(paren
id|sg_dev_arr
(braket
id|k
)braket
op_logical_and
id|sg_dev_arr
(braket
id|k
)braket
op_member_access_from_pointer
id|device
)paren
r_break
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|k
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* origin 1 */
)brace
macro_line|#endif
r_static
id|Sg_device
op_star
DECL|function|sg_get_dev
id|sg_get_dev
c_func
(paren
r_int
id|dev
)paren
(brace
id|Sg_device
op_star
id|sdp
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_if
c_cond
(paren
id|sg_dev_arr
op_logical_and
(paren
id|dev
op_ge
l_int|0
)paren
)paren
(brace
id|read_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
id|sg_dev_max
)paren
id|sdp
op_assign
id|sg_dev_arr
(braket
id|dev
)braket
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
)brace
r_return
id|sdp
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SCSI_PROC_FS
DECL|variable|sg_proc_sgp
r_static
r_struct
id|proc_dir_entry
op_star
id|sg_proc_sgp
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|sg_proc_sg_dirname
r_static
r_char
id|sg_proc_sg_dirname
(braket
)braket
op_assign
l_string|&quot;scsi/sg&quot;
suffix:semicolon
r_static
r_int
id|sg_proc_seq_show_int
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_single_open_adio
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
id|ssize_t
id|sg_proc_write_adio
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
suffix:semicolon
DECL|variable|adio_fops
r_static
r_struct
id|file_operations
id|adio_fops
op_assign
(brace
multiline_comment|/* .owner, .read and .llseek added in sg_proc_init() */
dot
id|open
op_assign
id|sg_proc_single_open_adio
comma
dot
id|write
op_assign
id|sg_proc_write_adio
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
r_static
r_int
id|sg_proc_single_open_dressz
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
id|ssize_t
id|sg_proc_write_dressz
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
suffix:semicolon
DECL|variable|dressz_fops
r_static
r_struct
id|file_operations
id|dressz_fops
op_assign
(brace
dot
id|open
op_assign
id|sg_proc_single_open_dressz
comma
dot
id|write
op_assign
id|sg_proc_write_dressz
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
r_static
r_int
id|sg_proc_seq_show_version
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_single_open_version
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
DECL|variable|version_fops
r_static
r_struct
id|file_operations
id|version_fops
op_assign
(brace
dot
id|open
op_assign
id|sg_proc_single_open_version
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
r_static
r_int
id|sg_proc_seq_show_devhdr
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_single_open_devhdr
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
DECL|variable|devhdr_fops
r_static
r_struct
id|file_operations
id|devhdr_fops
op_assign
(brace
dot
id|open
op_assign
id|sg_proc_single_open_devhdr
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
r_static
r_int
id|sg_proc_seq_show_dev
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_open_dev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_void
op_star
id|dev_seq_start
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
id|loff_t
op_star
id|pos
)paren
suffix:semicolon
r_static
r_void
op_star
id|dev_seq_next
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|pos
)paren
suffix:semicolon
r_static
r_void
id|dev_seq_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
suffix:semicolon
DECL|variable|dev_fops
r_static
r_struct
id|file_operations
id|dev_fops
op_assign
(brace
dot
id|open
op_assign
id|sg_proc_open_dev
comma
dot
id|release
op_assign
id|seq_release
comma
)brace
suffix:semicolon
DECL|variable|dev_seq_ops
r_static
r_struct
id|seq_operations
id|dev_seq_ops
op_assign
(brace
dot
id|start
op_assign
id|dev_seq_start
comma
dot
id|next
op_assign
id|dev_seq_next
comma
dot
id|stop
op_assign
id|dev_seq_stop
comma
dot
id|show
op_assign
id|sg_proc_seq_show_dev
comma
)brace
suffix:semicolon
r_static
r_int
id|sg_proc_seq_show_devstrs
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_open_devstrs
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
DECL|variable|devstrs_fops
r_static
r_struct
id|file_operations
id|devstrs_fops
op_assign
(brace
dot
id|open
op_assign
id|sg_proc_open_devstrs
comma
dot
id|release
op_assign
id|seq_release
comma
)brace
suffix:semicolon
DECL|variable|devstrs_seq_ops
r_static
r_struct
id|seq_operations
id|devstrs_seq_ops
op_assign
(brace
dot
id|start
op_assign
id|dev_seq_start
comma
dot
id|next
op_assign
id|dev_seq_next
comma
dot
id|stop
op_assign
id|dev_seq_stop
comma
dot
id|show
op_assign
id|sg_proc_seq_show_devstrs
comma
)brace
suffix:semicolon
r_static
r_int
id|sg_proc_seq_show_debug
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_open_debug
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
DECL|variable|debug_fops
r_static
r_struct
id|file_operations
id|debug_fops
op_assign
(brace
dot
id|open
op_assign
id|sg_proc_open_debug
comma
dot
id|release
op_assign
id|seq_release
comma
)brace
suffix:semicolon
DECL|variable|debug_seq_ops
r_static
r_struct
id|seq_operations
id|debug_seq_ops
op_assign
(brace
dot
id|start
op_assign
id|dev_seq_start
comma
dot
id|next
op_assign
id|dev_seq_next
comma
dot
id|stop
op_assign
id|dev_seq_stop
comma
dot
id|show
op_assign
id|sg_proc_seq_show_debug
comma
)brace
suffix:semicolon
DECL|struct|sg_proc_leaf
r_struct
id|sg_proc_leaf
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|fops
r_struct
id|file_operations
op_star
id|fops
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|sg_proc_leaf_arr
r_static
r_struct
id|sg_proc_leaf
id|sg_proc_leaf_arr
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;allow_dio&quot;
comma
op_amp
id|adio_fops
)brace
comma
(brace
l_string|&quot;debug&quot;
comma
op_amp
id|debug_fops
)brace
comma
(brace
l_string|&quot;def_reserved_size&quot;
comma
op_amp
id|dressz_fops
)brace
comma
(brace
l_string|&quot;device_hdr&quot;
comma
op_amp
id|devhdr_fops
)brace
comma
(brace
l_string|&quot;devices&quot;
comma
op_amp
id|dev_fops
)brace
comma
(brace
l_string|&quot;device_strs&quot;
comma
op_amp
id|devstrs_fops
)brace
comma
(brace
l_string|&quot;version&quot;
comma
op_amp
id|version_fops
)brace
)brace
suffix:semicolon
r_static
r_int
DECL|function|sg_proc_init
id|sg_proc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|k
comma
id|mask
suffix:semicolon
r_int
id|num_leaves
op_assign
r_sizeof
(paren
id|sg_proc_leaf_arr
)paren
op_div
r_sizeof
(paren
id|sg_proc_leaf_arr
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|pdep
suffix:semicolon
r_struct
id|sg_proc_leaf
op_star
id|leaf
suffix:semicolon
id|sg_proc_sgp
op_assign
id|create_proc_entry
c_func
(paren
id|sg_proc_sg_dirname
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sg_proc_sgp
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|num_leaves
suffix:semicolon
op_increment
id|k
)paren
(brace
id|leaf
op_assign
op_amp
id|sg_proc_leaf_arr
(braket
id|k
)braket
suffix:semicolon
id|mask
op_assign
id|leaf-&gt;fops-&gt;write
ques
c_cond
id|S_IRUGO
op_or
id|S_IWUSR
suffix:colon
id|S_IRUGO
suffix:semicolon
id|pdep
op_assign
id|create_proc_entry
c_func
(paren
id|leaf-&gt;name
comma
id|mask
comma
id|sg_proc_sgp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdep
)paren
(brace
id|leaf-&gt;fops-&gt;owner
op_assign
id|THIS_MODULE
comma
id|leaf-&gt;fops-&gt;read
op_assign
id|seq_read
comma
id|leaf-&gt;fops-&gt;llseek
op_assign
id|seq_lseek
comma
id|pdep-&gt;proc_fops
op_assign
id|leaf-&gt;fops
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sg_proc_cleanup
id|sg_proc_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|k
suffix:semicolon
r_int
id|num_leaves
op_assign
r_sizeof
(paren
id|sg_proc_leaf_arr
)paren
op_div
r_sizeof
(paren
id|sg_proc_leaf_arr
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sg_proc_sgp
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|num_leaves
suffix:semicolon
op_increment
id|k
)paren
id|remove_proc_entry
c_func
(paren
id|sg_proc_leaf_arr
(braket
id|k
)braket
dot
id|name
comma
id|sg_proc_sgp
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|sg_proc_sg_dirname
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_seq_show_int
r_static
r_int
id|sg_proc_seq_show_int
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
(brace
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;%d&bslash;n&quot;
comma
op_star
(paren
(paren
r_int
op_star
)paren
id|s
op_member_access_from_pointer
r_private
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_proc_single_open_adio
r_static
r_int
id|sg_proc_single_open_adio
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|sg_proc_seq_show_int
comma
op_amp
id|sg_allow_dio
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|sg_proc_write_adio
id|sg_proc_write_adio
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
(brace
r_int
id|num
suffix:semicolon
r_char
id|buff
(braket
l_int|11
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_or
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|num
op_assign
(paren
id|count
OL
l_int|10
)paren
ques
c_cond
id|count
suffix:colon
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buff
comma
id|buffer
comma
id|num
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|buff
(braket
id|num
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|sg_allow_dio
op_assign
id|simple_strtoul
c_func
(paren
id|buff
comma
l_int|NULL
comma
l_int|10
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|sg_proc_single_open_dressz
r_static
r_int
id|sg_proc_single_open_dressz
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|sg_proc_seq_show_int
comma
op_amp
id|sg_big_buff
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|sg_proc_write_dressz
id|sg_proc_write_dressz
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
(brace
r_int
id|num
suffix:semicolon
r_int
r_int
id|k
op_assign
id|ULONG_MAX
suffix:semicolon
r_char
id|buff
(braket
l_int|11
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_or
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|num
op_assign
(paren
id|count
OL
l_int|10
)paren
ques
c_cond
id|count
suffix:colon
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buff
comma
id|buffer
comma
id|num
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|buff
(braket
id|num
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|k
op_assign
id|simple_strtoul
c_func
(paren
id|buff
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
op_le
l_int|1048576
)paren
(brace
multiline_comment|/* limit &quot;big buff&quot; to 1 MB */
id|sg_big_buff
op_assign
id|k
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_return
op_minus
id|ERANGE
suffix:semicolon
)brace
DECL|function|sg_proc_seq_show_version
r_static
r_int
id|sg_proc_seq_show_version
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
(brace
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;%d&bslash;t%s [%s]&bslash;n&quot;
comma
id|sg_version_num
comma
id|SG_VERSION_STR
comma
id|sg_version_date
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_proc_single_open_version
r_static
r_int
id|sg_proc_single_open_version
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|sg_proc_seq_show_version
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_seq_show_devhdr
r_static
r_int
id|sg_proc_seq_show_devhdr
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
(brace
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;host&bslash;tchan&bslash;tid&bslash;tlun&bslash;ttype&bslash;topens&bslash;tqdepth&bslash;tbusy&bslash;t&quot;
l_string|&quot;online&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_proc_single_open_devhdr
r_static
r_int
id|sg_proc_single_open_devhdr
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|sg_proc_seq_show_devhdr
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|struct|sg_proc_deviter
r_struct
id|sg_proc_deviter
(brace
DECL|member|index
id|loff_t
id|index
suffix:semicolon
DECL|member|max
r_int
id|max
suffix:semicolon
)brace
suffix:semicolon
DECL|function|dev_seq_start
r_static
r_void
op_star
id|dev_seq_start
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_struct
id|sg_proc_deviter
op_star
id|it
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|it
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|it
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sg_dev_arr
)paren
r_goto
id|err1
suffix:semicolon
id|it-&gt;index
op_assign
op_star
id|pos
suffix:semicolon
id|it-&gt;max
op_assign
id|sg_last_dev
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|it-&gt;index
op_ge
id|it-&gt;max
)paren
r_goto
id|err1
suffix:semicolon
r_return
id|it
suffix:semicolon
id|err1
suffix:colon
id|kfree
c_func
(paren
id|it
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|dev_seq_next
r_static
r_void
op_star
id|dev_seq_next
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_struct
id|sg_proc_deviter
op_star
id|it
op_assign
(paren
r_struct
id|sg_proc_deviter
op_star
)paren
id|v
suffix:semicolon
op_star
id|pos
op_assign
op_increment
id|it-&gt;index
suffix:semicolon
r_return
(paren
id|it-&gt;index
OL
id|it-&gt;max
)paren
ques
c_cond
id|it
suffix:colon
l_int|NULL
suffix:semicolon
)brace
DECL|function|dev_seq_stop
r_static
r_void
id|dev_seq_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
(brace
id|kfree
(paren
id|v
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_open_dev
r_static
r_int
id|sg_proc_open_dev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|dev_seq_ops
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_seq_show_dev
r_static
r_int
id|sg_proc_seq_show_dev
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
(brace
r_struct
id|sg_proc_deviter
op_star
id|it
op_assign
(paren
r_struct
id|sg_proc_deviter
op_star
)paren
id|v
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
r_struct
id|scsi_device
op_star
id|scsidp
suffix:semicolon
id|sdp
op_assign
id|it
ques
c_cond
id|sg_get_dev
c_func
(paren
id|it-&gt;index
)paren
suffix:colon
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sdp
op_logical_and
(paren
id|scsidp
op_assign
id|sdp-&gt;device
)paren
op_logical_and
(paren
op_logical_neg
id|sdp-&gt;detached
)paren
)paren
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;%d&bslash;t%d&bslash;t%d&bslash;t%d&bslash;t%d&bslash;t%d&bslash;t%d&bslash;t%d&bslash;t%d&bslash;n&quot;
comma
id|scsidp-&gt;host-&gt;host_no
comma
id|scsidp-&gt;channel
comma
id|scsidp-&gt;id
comma
id|scsidp-&gt;lun
comma
(paren
r_int
)paren
id|scsidp-&gt;type
comma
l_int|1
comma
(paren
r_int
)paren
id|scsidp-&gt;queue_depth
comma
(paren
r_int
)paren
id|scsidp-&gt;device_busy
comma
(paren
r_int
)paren
id|scsi_device_online
c_func
(paren
id|scsidp
)paren
)paren
suffix:semicolon
r_else
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_proc_open_devstrs
r_static
r_int
id|sg_proc_open_devstrs
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|devstrs_seq_ops
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_seq_show_devstrs
r_static
r_int
id|sg_proc_seq_show_devstrs
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
(brace
r_struct
id|sg_proc_deviter
op_star
id|it
op_assign
(paren
r_struct
id|sg_proc_deviter
op_star
)paren
id|v
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
r_struct
id|scsi_device
op_star
id|scsidp
suffix:semicolon
id|sdp
op_assign
id|it
ques
c_cond
id|sg_get_dev
c_func
(paren
id|it-&gt;index
)paren
suffix:colon
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sdp
op_logical_and
(paren
id|scsidp
op_assign
id|sdp-&gt;device
)paren
op_logical_and
(paren
op_logical_neg
id|sdp-&gt;detached
)paren
)paren
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;%8.8s&bslash;t%16.16s&bslash;t%4.4s&bslash;n&quot;
comma
id|scsidp-&gt;vendor
comma
id|scsidp-&gt;model
comma
id|scsidp-&gt;rev
)paren
suffix:semicolon
r_else
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;&lt;no active device&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_proc_debug_helper
r_static
r_void
id|sg_proc_debug_helper
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
id|Sg_device
op_star
id|sdp
)paren
(brace
r_int
id|k
comma
id|m
comma
id|new_interface
comma
id|blen
comma
id|usg
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
id|Sg_fd
op_star
id|fp
suffix:semicolon
r_const
id|sg_io_hdr_t
op_star
id|hp
suffix:semicolon
r_const
r_char
op_star
id|cp
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
(paren
id|fp
op_assign
id|sg_get_nth_sfp
c_func
(paren
id|sdp
comma
id|k
)paren
)paren
suffix:semicolon
op_increment
id|k
)paren
(brace
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;   FD(%d): timeout=%dms bufflen=%d &quot;
l_string|&quot;(res)sgat=%d low_dma=%d&bslash;n&quot;
comma
id|k
op_plus
l_int|1
comma
id|jiffies_to_msecs
c_func
(paren
id|fp-&gt;timeout
)paren
comma
id|fp-&gt;reserve.bufflen
comma
(paren
r_int
)paren
id|fp-&gt;reserve.k_use_sg
comma
(paren
r_int
)paren
id|fp-&gt;low_dma
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;   cmd_q=%d f_packid=%d k_orphan=%d closed=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|fp-&gt;cmd_q
comma
(paren
r_int
)paren
id|fp-&gt;force_packid
comma
(paren
r_int
)paren
id|fp-&gt;keep_orphan
comma
(paren
r_int
)paren
id|fp-&gt;closed
)paren
suffix:semicolon
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
(paren
id|srp
op_assign
id|sg_get_nth_request
c_func
(paren
id|fp
comma
id|m
)paren
)paren
suffix:semicolon
op_increment
id|m
)paren
(brace
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|new_interface
op_assign
(paren
id|hp-&gt;interface_id
op_eq
l_char|&squot;&bslash;0&squot;
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|srp-&gt;res_used
)paren
(brace
r_if
c_cond
(paren
id|new_interface
op_logical_and
(paren
id|SG_FLAG_MMAP_IO
op_amp
id|hp-&gt;flags
)paren
)paren
id|cp
op_assign
l_string|&quot;     mmap&gt;&gt; &quot;
suffix:semicolon
r_else
id|cp
op_assign
l_string|&quot;     rb&gt;&gt; &quot;
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|SG_INFO_DIRECT_IO_MASK
op_amp
id|hp-&gt;info
)paren
id|cp
op_assign
l_string|&quot;     dio&gt;&gt; &quot;
suffix:semicolon
r_else
id|cp
op_assign
l_string|&quot;     &quot;
suffix:semicolon
)brace
id|seq_printf
c_func
(paren
id|s
comma
id|cp
)paren
suffix:semicolon
id|blen
op_assign
id|srp-&gt;my_cmdp
ques
c_cond
id|srp-&gt;my_cmdp-&gt;sr_bufflen
suffix:colon
id|srp-&gt;data.bufflen
suffix:semicolon
id|usg
op_assign
id|srp-&gt;my_cmdp
ques
c_cond
id|srp-&gt;my_cmdp-&gt;sr_use_sg
suffix:colon
id|srp-&gt;data.k_use_sg
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
id|srp-&gt;done
ques
c_cond
(paren
(paren
l_int|1
op_eq
id|srp-&gt;done
)paren
ques
c_cond
l_string|&quot;rcv:&quot;
suffix:colon
l_string|&quot;fin:&quot;
)paren
suffix:colon
(paren
id|srp-&gt;my_cmdp
ques
c_cond
l_string|&quot;act:&quot;
suffix:colon
l_string|&quot;prior:&quot;
)paren
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot; id=%d blen=%d&quot;
comma
id|srp-&gt;header.pack_id
comma
id|blen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srp-&gt;done
)paren
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot; dur=%d&quot;
comma
id|hp-&gt;duration
)paren
suffix:semicolon
r_else
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot; t_o/elap=%d/%d&quot;
comma
id|new_interface
ques
c_cond
id|hp-&gt;timeout
suffix:colon
id|jiffies_to_msecs
c_func
(paren
id|fp-&gt;timeout
)paren
comma
id|jiffies_to_msecs
c_func
(paren
id|hp-&gt;duration
ques
c_cond
(paren
id|jiffies
op_minus
id|hp-&gt;duration
)paren
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;ms sgat=%d op=0x%02x&bslash;n&quot;
comma
id|usg
comma
(paren
r_int
)paren
id|srp-&gt;data.cmd_opcode
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_eq
id|m
)paren
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;     No requests active&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|sg_proc_open_debug
r_static
r_int
id|sg_proc_open_debug
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|debug_seq_ops
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_seq_show_debug
r_static
r_int
id|sg_proc_seq_show_debug
c_func
(paren
r_struct
id|seq_file
op_star
id|s
comma
r_void
op_star
id|v
)paren
(brace
r_struct
id|sg_proc_deviter
op_star
id|it
op_assign
(paren
r_struct
id|sg_proc_deviter
op_star
)paren
id|v
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
r_if
c_cond
(paren
id|it
op_logical_and
(paren
l_int|0
op_eq
id|it-&gt;index
)paren
)paren
(brace
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;dev_max(currently)=%d max_active_device=%d &quot;
l_string|&quot;(origin 1)&bslash;n&quot;
comma
id|sg_dev_max
comma
(paren
r_int
)paren
id|it-&gt;max
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot; def_reserved_size=%d&bslash;n&quot;
comma
id|sg_big_buff
)paren
suffix:semicolon
)brace
id|sdp
op_assign
id|it
ques
c_cond
id|sg_get_dev
c_func
(paren
id|it-&gt;index
)paren
suffix:colon
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sdp
)paren
(brace
r_struct
id|scsi_device
op_star
id|scsidp
op_assign
id|sdp-&gt;device
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|scsidp
)paren
(brace
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;device %d detached ??&bslash;n&quot;
comma
(paren
r_int
)paren
id|it-&gt;index
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sg_get_nth_sfp
c_func
(paren
id|sdp
comma
l_int|0
)paren
)paren
(brace
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot; &gt;&gt;&gt; device=%s &quot;
comma
id|sdp-&gt;disk-&gt;disk_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdp-&gt;detached
)paren
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot;detached pending close &quot;
)paren
suffix:semicolon
r_else
id|seq_printf
(paren
id|s
comma
l_string|&quot;scsi%d chan=%d id=%d lun=%d   em=%d&quot;
comma
id|scsidp-&gt;host-&gt;host_no
comma
id|scsidp-&gt;channel
comma
id|scsidp-&gt;id
comma
id|scsidp-&gt;lun
comma
id|scsidp-&gt;host-&gt;hostt-&gt;emulated
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|s
comma
l_string|&quot; sg_tablesize=%d excl=%d&bslash;n&quot;
comma
id|sdp-&gt;sg_tablesize
comma
id|sdp-&gt;exclude
)paren
suffix:semicolon
)brace
id|sg_proc_debug_helper
c_func
(paren
id|s
comma
id|sdp
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_SCSI_PROC_FS */
DECL|variable|init_sg
id|module_init
c_func
(paren
id|init_sg
)paren
suffix:semicolon
DECL|variable|exit_sg
id|module_exit
c_func
(paren
id|exit_sg
)paren
suffix:semicolon
DECL|variable|SCSI_GENERIC_MAJOR
id|MODULE_ALIAS_CHARDEV_MAJOR
c_func
(paren
id|SCSI_GENERIC_MAJOR
)paren
suffix:semicolon
eof
