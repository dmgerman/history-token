multiline_comment|/*&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 1996 David S. Miller (dm@engr.sgi.com)&n; * Copyright (C) 1999 Andrew R. Baker (andrewb@uab.edu)&n; * Copyright (C) 2001 Florian Lohoff (flo@rfc822.org)&n; * Copyright (C) 2003 Ralf Baechle (ralf@linux-mips.org)&n; * &n; * (In all truth, Jed Schimmel wrote all this code.)&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/sgialib.h&gt;
macro_line|#include &lt;asm/sgi/sgi.h&gt;
macro_line|#include &lt;asm/sgi/mc.h&gt;
macro_line|#include &lt;asm/sgi/hpc3.h&gt;
macro_line|#include &lt;asm/sgi/ip22.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &lt;scsi/scsi_host.h&gt;
macro_line|#include &quot;wd33c93.h&quot;
macro_line|#include &quot;sgiwd93.h&quot;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#if 0
mdefine_line|#define DPRINTK(args...)&t;printk(args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(args...)
macro_line|#endif
DECL|macro|HDATA
mdefine_line|#define HDATA(ptr) ((struct ip22_hostdata *)((ptr)-&gt;hostdata))
DECL|struct|ip22_hostdata
r_struct
id|ip22_hostdata
(brace
DECL|member|wh
r_struct
id|WD33C93_hostdata
id|wh
suffix:semicolon
DECL|struct|hpc_data
r_struct
id|hpc_data
(brace
DECL|member|dma
id|dma_addr_t
id|dma
suffix:semicolon
DECL|member|cpu
r_void
op_star
id|cpu
suffix:semicolon
DECL|member|hd
)brace
id|hd
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|hpc_chunk
r_struct
id|hpc_chunk
(brace
DECL|member|desc
r_struct
id|hpc_dma_desc
id|desc
suffix:semicolon
DECL|member|_padding
id|u32
id|_padding
suffix:semicolon
multiline_comment|/* align to quadword boundary */
)brace
suffix:semicolon
DECL|variable|sgiwd93_host
r_struct
id|Scsi_Host
op_star
id|sgiwd93_host
suffix:semicolon
DECL|variable|sgiwd93_host1
r_struct
id|Scsi_Host
op_star
id|sgiwd93_host1
suffix:semicolon
multiline_comment|/* Wuff wuff, wuff, wd33c93.c, wuff wuff, object oriented, bow wow. */
DECL|function|write_wd33c93_count
r_static
r_inline
r_void
id|write_wd33c93_count
c_func
(paren
r_const
id|wd33c93_regs
id|regs
comma
r_int
r_int
id|value
)paren
(brace
op_star
id|regs.SASR
op_assign
id|WD_TRANSFER_COUNT_MSB
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
op_star
id|regs.SCMD
op_assign
(paren
(paren
id|value
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
op_star
id|regs.SCMD
op_assign
(paren
(paren
id|value
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
op_star
id|regs.SCMD
op_assign
(paren
(paren
id|value
op_rshift
l_int|0
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|read_wd33c93_count
r_static
r_inline
r_int
r_int
id|read_wd33c93_count
c_func
(paren
r_const
id|wd33c93_regs
id|regs
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
op_star
id|regs.SASR
op_assign
id|WD_TRANSFER_COUNT_MSB
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|value
op_assign
(paren
(paren
op_star
id|regs.SCMD
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|value
op_or_assign
(paren
(paren
op_star
id|regs.SCMD
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|value
op_or_assign
(paren
(paren
op_star
id|regs.SCMD
op_amp
l_int|0xff
)paren
op_lshift
l_int|0
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
DECL|function|sgiwd93_intr
r_static
id|irqreturn_t
id|sgiwd93_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|host
op_assign
(paren
r_struct
id|Scsi_Host
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|wd33c93_intr
c_func
(paren
id|host
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_static
r_inline
DECL|function|fill_hpc_entries
r_void
id|fill_hpc_entries
c_func
(paren
r_struct
id|hpc_chunk
op_star
id|hcp
comma
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
id|datainp
)paren
(brace
r_int
r_int
id|len
op_assign
id|cmd-&gt;SCp.this_residual
suffix:semicolon
r_void
op_star
id|addr
op_assign
id|cmd-&gt;SCp.ptr
suffix:semicolon
id|dma_addr_t
id|physaddr
suffix:semicolon
r_int
r_int
id|count
suffix:semicolon
id|physaddr
op_assign
id|dma_map_single
c_func
(paren
l_int|NULL
comma
id|addr
comma
id|len
comma
id|cmd-&gt;sc_data_direction
)paren
suffix:semicolon
id|cmd-&gt;SCp.dma_handle
op_assign
id|physaddr
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
multiline_comment|/*&n;&t;&t; * even cntinfo could be up to 16383, without&n;&t;&t; * magic only 8192 works correctly&n;&t;&t; */
id|count
op_assign
id|len
OG
l_int|8192
ques
c_cond
l_int|8192
suffix:colon
id|len
suffix:semicolon
id|hcp-&gt;desc.pbuf
op_assign
id|physaddr
suffix:semicolon
id|hcp-&gt;desc.cntinfo
op_assign
id|count
suffix:semicolon
id|hcp
op_increment
suffix:semicolon
id|len
op_sub_assign
id|count
suffix:semicolon
id|physaddr
op_add_assign
id|count
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * To make sure, if we trip an HPC bug, that we transfer every single&n;&t; * byte, we tag on an extra zero length dma descriptor at the end of&n;&t; * the chain.&n;&t; */
id|hcp-&gt;desc.pbuf
op_assign
l_int|0
suffix:semicolon
id|hcp-&gt;desc.cntinfo
op_assign
id|HPCDMA_EOX
suffix:semicolon
)brace
DECL|function|dma_setup
r_static
r_int
id|dma_setup
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
comma
r_int
id|datainp
)paren
(brace
r_struct
id|ip22_hostdata
op_star
id|hdata
op_assign
id|HDATA
c_func
(paren
id|cmd-&gt;device-&gt;host
)paren
suffix:semicolon
r_struct
id|hpc3_scsiregs
op_star
id|hregs
op_assign
(paren
r_struct
id|hpc3_scsiregs
op_star
)paren
id|cmd-&gt;device-&gt;host-&gt;base
suffix:semicolon
r_struct
id|hpc_chunk
op_star
id|hcp
op_assign
(paren
r_struct
id|hpc_chunk
op_star
)paren
id|hdata-&gt;hd.cpu
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;dma_setup: datainp&lt;%d&gt; hcp&lt;%p&gt; &quot;
comma
id|datainp
comma
id|hcp
)paren
suffix:semicolon
id|hdata-&gt;wh.dma_dir
op_assign
id|datainp
suffix:semicolon
multiline_comment|/*&n;&t; * wd33c93 shouldn&squot;t pass us bogus dma_setups, but it does:-(  The&n;&t; * other wd33c93 drivers deal with it the same way (which isn&squot;t that&n;&t; * obvious).  IMHO a better fix would be, not to do these dma setups&n;&t; * in the first place.&n;&t; */
r_if
c_cond
(paren
id|cmd-&gt;SCp.ptr
op_eq
l_int|NULL
op_logical_or
id|cmd-&gt;SCp.this_residual
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|fill_hpc_entries
c_func
(paren
id|hcp
comma
id|cmd
comma
id|datainp
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot; HPCGO&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Start up the HPC. */
id|hregs-&gt;ndptr
op_assign
id|hdata-&gt;hd.dma
suffix:semicolon
r_if
c_cond
(paren
id|datainp
)paren
id|hregs-&gt;ctrl
op_assign
id|HPC3_SCTRL_ACTIVE
suffix:semicolon
r_else
id|hregs-&gt;ctrl
op_assign
id|HPC3_SCTRL_ACTIVE
op_or
id|HPC3_SCTRL_DIR
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dma_stop
r_static
r_void
id|dma_stop
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
comma
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
id|status
)paren
(brace
r_struct
id|ip22_hostdata
op_star
id|hdata
op_assign
id|HDATA
c_func
(paren
id|instance
)paren
suffix:semicolon
r_struct
id|hpc3_scsiregs
op_star
id|hregs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
r_return
suffix:semicolon
id|hregs
op_assign
(paren
r_struct
id|hpc3_scsiregs
op_star
)paren
id|SCpnt-&gt;device-&gt;host-&gt;base
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;dma_stop: status&lt;%d&gt; &quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* First stop the HPC and flush it&squot;s FIFO. */
r_if
c_cond
(paren
id|hdata-&gt;wh.dma_dir
)paren
(brace
id|hregs-&gt;ctrl
op_or_assign
id|HPC3_SCTRL_FLUSH
suffix:semicolon
r_while
c_loop
(paren
id|hregs-&gt;ctrl
op_amp
id|HPC3_SCTRL_ACTIVE
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|hregs-&gt;ctrl
op_assign
l_int|0
suffix:semicolon
id|dma_unmap_single
c_func
(paren
l_int|NULL
comma
id|SCpnt-&gt;SCp.dma_handle
comma
id|SCpnt-&gt;SCp.this_residual
comma
id|SCpnt-&gt;sc_data_direction
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|sgiwd93_reset
r_void
id|sgiwd93_reset
c_func
(paren
r_int
r_int
id|base
)paren
(brace
r_struct
id|hpc3_scsiregs
op_star
id|hregs
op_assign
(paren
r_struct
id|hpc3_scsiregs
op_star
)paren
id|base
suffix:semicolon
id|hregs-&gt;ctrl
op_assign
id|HPC3_SCTRL_CRESET
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|hregs-&gt;ctrl
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|init_hpc_chain
r_static
r_inline
r_void
id|init_hpc_chain
c_func
(paren
r_struct
id|hpc_data
op_star
id|hd
)paren
(brace
r_struct
id|hpc_chunk
op_star
id|hcp
op_assign
(paren
r_struct
id|hpc_chunk
op_star
)paren
id|hd-&gt;cpu
suffix:semicolon
r_struct
id|hpc_chunk
op_star
id|dma
op_assign
(paren
r_struct
id|hpc_chunk
op_star
)paren
id|hd-&gt;dma
suffix:semicolon
r_int
r_int
id|start
comma
id|end
suffix:semicolon
id|start
op_assign
(paren
r_int
r_int
)paren
id|hcp
suffix:semicolon
id|end
op_assign
id|start
op_plus
id|PAGE_SIZE
suffix:semicolon
r_while
c_loop
(paren
id|start
OL
id|end
)paren
(brace
id|hcp-&gt;desc.pnext
op_assign
(paren
id|u32
)paren
(paren
id|dma
op_plus
l_int|1
)paren
suffix:semicolon
id|hcp-&gt;desc.cntinfo
op_assign
id|HPCDMA_EOX
suffix:semicolon
id|hcp
op_increment
suffix:semicolon
id|dma
op_increment
suffix:semicolon
id|start
op_add_assign
r_sizeof
(paren
r_struct
id|hpc_chunk
)paren
suffix:semicolon
)brace
suffix:semicolon
id|hcp
op_decrement
suffix:semicolon
id|hcp-&gt;desc.pnext
op_assign
id|hd-&gt;dma
suffix:semicolon
)brace
DECL|function|sgiwd93_setup_scsi
r_static
r_struct
id|Scsi_Host
op_star
id|__init
id|sgiwd93_setup_scsi
c_func
(paren
id|Scsi_Host_Template
op_star
id|SGIblows
comma
r_int
id|unit
comma
r_int
id|irq
comma
r_struct
id|hpc3_scsiregs
op_star
id|hregs
comma
r_int
r_char
op_star
id|wdregs
)paren
(brace
r_struct
id|ip22_hostdata
op_star
id|hdata
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
id|wd33c93_regs
id|regs
suffix:semicolon
id|host
op_assign
id|scsi_register
c_func
(paren
id|SGIblows
comma
r_sizeof
(paren
r_struct
id|ip22_hostdata
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
r_return
l_int|NULL
suffix:semicolon
id|host-&gt;base
op_assign
(paren
r_int
r_int
)paren
id|hregs
suffix:semicolon
id|host-&gt;irq
op_assign
id|irq
suffix:semicolon
id|hdata
op_assign
id|HDATA
c_func
(paren
id|host
)paren
suffix:semicolon
id|hdata-&gt;hd.cpu
op_assign
id|dma_alloc_coherent
c_func
(paren
l_int|NULL
comma
id|PAGE_SIZE
comma
op_amp
id|hdata-&gt;hd.dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hdata-&gt;hd.cpu
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sgiwd93: Could not allocate memory for &quot;
l_string|&quot;host %d buffer.&bslash;n&quot;
comma
id|unit
)paren
suffix:semicolon
r_goto
id|out_unregister
suffix:semicolon
)brace
id|init_hpc_chain
c_func
(paren
op_amp
id|hdata-&gt;hd
)paren
suffix:semicolon
id|regs.SASR
op_assign
id|wdregs
op_plus
l_int|3
suffix:semicolon
id|regs.SCMD
op_assign
id|wdregs
op_plus
l_int|7
suffix:semicolon
id|wd33c93_init
c_func
(paren
id|host
comma
id|regs
comma
id|dma_setup
comma
id|dma_stop
comma
id|WD33C93_FS_16_20
)paren
suffix:semicolon
id|hdata-&gt;wh.no_sync
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|sgiwd93_intr
comma
l_int|0
comma
l_string|&quot;SGI WD93&quot;
comma
(paren
r_void
op_star
)paren
id|host
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sgiwd93: Could not register irq %d &quot;
l_string|&quot;for host %d.&bslash;n&quot;
comma
id|irq
comma
id|unit
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
r_return
id|host
suffix:semicolon
id|out_free
suffix:colon
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|PAGE_SIZE
comma
id|hdata-&gt;hd.cpu
comma
id|hdata-&gt;hd.dma
)paren
suffix:semicolon
id|wd33c93_release
c_func
(paren
)paren
suffix:semicolon
id|out_unregister
suffix:colon
id|scsi_unregister
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|sgiwd93_detect
r_int
id|__init
id|sgiwd93_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|SGIblows
)paren
(brace
r_int
id|found
op_assign
l_int|0
suffix:semicolon
id|SGIblows-&gt;proc_name
op_assign
l_string|&quot;SGIWD93&quot;
suffix:semicolon
id|sgiwd93_host
op_assign
id|sgiwd93_setup_scsi
c_func
(paren
id|SGIblows
comma
l_int|0
comma
id|SGI_WD93_0_IRQ
comma
op_amp
id|hpc3c0-&gt;scsi_chan0
comma
(paren
r_int
r_char
op_star
)paren
id|hpc3c0-&gt;scsi0_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sgiwd93_host
)paren
id|found
op_increment
suffix:semicolon
multiline_comment|/* Set up second controller on the Indigo2 */
r_if
c_cond
(paren
id|ip22_is_fullhouse
c_func
(paren
)paren
)paren
(brace
id|sgiwd93_host1
op_assign
id|sgiwd93_setup_scsi
c_func
(paren
id|SGIblows
comma
l_int|1
comma
id|SGI_WD93_1_IRQ
comma
op_amp
id|hpc3c0-&gt;scsi_chan1
comma
(paren
r_int
r_char
op_star
)paren
id|hpc3c0-&gt;scsi1_ext
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sgiwd93_host1
)paren
id|found
op_increment
suffix:semicolon
)brace
r_return
id|found
suffix:semicolon
)brace
DECL|function|sgiwd93_release
r_int
id|sgiwd93_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|instance
)paren
(brace
r_struct
id|ip22_hostdata
op_star
id|hdata
op_assign
id|HDATA
c_func
(paren
id|instance
)paren
suffix:semicolon
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sgiwd93_host
op_logical_and
id|sgiwd93_host
op_eq
id|instance
)paren
id|irq
op_assign
id|SGI_WD93_0_IRQ
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sgiwd93_host1
op_logical_and
id|sgiwd93_host1
op_eq
id|instance
)paren
id|irq
op_assign
id|SGI_WD93_1_IRQ
suffix:semicolon
id|free_irq
c_func
(paren
id|irq
comma
id|sgiwd93_intr
)paren
suffix:semicolon
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|PAGE_SIZE
comma
id|hdata-&gt;hd.cpu
comma
id|hdata-&gt;hd.dma
)paren
suffix:semicolon
id|wd33c93_release
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sgiwd93_bus_reset
r_static
r_int
id|sgiwd93_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|cmd
)paren
(brace
multiline_comment|/* FIXME perform bus-specific reset */
id|wd33c93_host_reset
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * Kludge alert - the SCSI code calls the abort and reset method with int&n; * arguments not with pointers.  So this is going to blow up beautyfully&n; * on 64-bit systems with memory outside the compat address spaces.&n; */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
(brace
dot
id|proc_name
op_assign
l_string|&quot;SGIWD93&quot;
comma
dot
id|name
op_assign
l_string|&quot;SGI WD93&quot;
comma
dot
id|detect
op_assign
id|sgiwd93_detect
comma
dot
id|release
op_assign
id|sgiwd93_release
comma
dot
id|queuecommand
op_assign
id|wd33c93_queuecommand
comma
dot
id|eh_abort_handler
op_assign
id|wd33c93_abort
comma
dot
id|eh_bus_reset_handler
op_assign
id|sgiwd93_bus_reset
comma
dot
id|eh_host_reset_handler
op_assign
id|wd33c93_host_reset
comma
dot
id|can_queue
op_assign
id|CAN_QUEUE
comma
dot
id|this_id
op_assign
l_int|7
comma
dot
id|sg_tablesize
op_assign
id|SG_ALL
comma
dot
id|cmd_per_lun
op_assign
id|CMD_PER_LUN
comma
dot
id|use_clustering
op_assign
id|DISABLE_CLUSTERING
comma
)brace
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
