multiline_comment|/* &n;   Common Flash Interface probe code.&n;   (C) 2000 Red Hat. GPL&squot;d.&n;   $Id: jedec_probe.c,v 1.3 2001/10/02 15:05:12 dwmw2 Exp $&n;*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
macro_line|#include &lt;linux/mtd/cfi.h&gt;
macro_line|#include &lt;linux/mtd/gen_probe.h&gt;
multiline_comment|/* Manufacturers */
DECL|macro|MANUFACTURER_AMD
mdefine_line|#define MANUFACTURER_AMD&t;0x0001
DECL|macro|MANUFACTURER_FUJITSU
mdefine_line|#define MANUFACTURER_FUJITSU&t;0x0004
DECL|macro|MANUFACTURER_ATMEL
mdefine_line|#define MANUFACTURER_ATMEL&t;0x001f
DECL|macro|MANUFACTURER_ST
mdefine_line|#define MANUFACTURER_ST&t;&t;0x0020
DECL|macro|MANUFACTURER_SST
mdefine_line|#define MANUFACTURER_SST&t;0x00BF
DECL|macro|MANUFACTURER_TOSHIBA
mdefine_line|#define MANUFACTURER_TOSHIBA&t;0x0098
multiline_comment|/* AMD */
DECL|macro|AM29F800BB
mdefine_line|#define AM29F800BB&t;0x2258
DECL|macro|AM29F800BT
mdefine_line|#define AM29F800BT&t;0x22D6
DECL|macro|AM29LV800BB
mdefine_line|#define AM29LV800BB&t;0x225B
DECL|macro|AM29LV800BT
mdefine_line|#define AM29LV800BT&t;0x22DA
DECL|macro|AM29LV160DT
mdefine_line|#define AM29LV160DT&t;0x22C4
DECL|macro|AM29LV160DB
mdefine_line|#define AM29LV160DB&t;0x2249
multiline_comment|/* Atmel */
DECL|macro|AT49BV16X4
mdefine_line|#define AT49BV16X4&t;0x00c0
DECL|macro|AT49BV16X4T
mdefine_line|#define AT49BV16X4T&t;0x00c2
multiline_comment|/* Fujitsu */
DECL|macro|MBM29LV160TE
mdefine_line|#define MBM29LV160TE&t;0x22C4
DECL|macro|MBM29LV160BE
mdefine_line|#define MBM29LV160BE&t;0x2249
multiline_comment|/* ST - www.st.com */
DECL|macro|M29W800T
mdefine_line|#define M29W800T&t;0x00D7
DECL|macro|M29W160DT
mdefine_line|#define M29W160DT&t;0x22C4
DECL|macro|M29W160DB
mdefine_line|#define M29W160DB&t;0x2249
multiline_comment|/* SST */
DECL|macro|SST39LF800
mdefine_line|#define SST39LF800&t;0x2781
DECL|macro|SST39LF160
mdefine_line|#define SST39LF160&t;0x2782
multiline_comment|/* Toshiba */
DECL|macro|TC58FVT160
mdefine_line|#define TC58FVT160&t;0x00C2
DECL|macro|TC58FVB160
mdefine_line|#define TC58FVB160&t;0x0043
DECL|struct|amd_flash_info
r_struct
id|amd_flash_info
(brace
DECL|member|mfr_id
r_const
id|__u16
id|mfr_id
suffix:semicolon
DECL|member|dev_id
r_const
id|__u16
id|dev_id
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|DevSize
r_const
r_int
id|DevSize
suffix:semicolon
DECL|member|InterfaceDesc
r_const
r_int
id|InterfaceDesc
suffix:semicolon
DECL|member|NumEraseRegions
r_const
r_int
id|NumEraseRegions
suffix:semicolon
DECL|member|regions
r_const
id|ulong
id|regions
(braket
l_int|4
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|ERASEINFO
mdefine_line|#define ERASEINFO(size,blocks) (size&lt;&lt;8)|(blocks-1)
DECL|macro|SIZE_1MiB
mdefine_line|#define SIZE_1MiB 20
DECL|macro|SIZE_2MiB
mdefine_line|#define SIZE_2MiB 21
DECL|macro|SIZE_4MiB
mdefine_line|#define SIZE_4MiB 22
DECL|variable|jedec_table
r_static
r_const
r_struct
id|amd_flash_info
id|jedec_table
(braket
)braket
op_assign
(brace
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_AMD
comma
dot
id|dev_id
op_assign
id|AM29LV160DT
comma
dot
id|name
op_assign
l_string|&quot;AMD AM29LV160DT&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_2MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_AMD
comma
dot
id|dev_id
op_assign
id|AM29LV160DB
comma
dot
id|name
op_assign
l_string|&quot;AMD AM29LV160DB&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_2MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_TOSHIBA
comma
dot
id|dev_id
op_assign
id|TC58FVT160
comma
dot
id|name
op_assign
l_string|&quot;Toshiba TC58FVT160&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_2MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_FUJITSU
comma
dot
id|dev_id
op_assign
id|MBM29LV160TE
comma
dot
id|name
op_assign
l_string|&quot;Fujitsu MBM29LV160TE&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_2MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_TOSHIBA
comma
dot
id|dev_id
op_assign
id|TC58FVB160
comma
dot
id|name
op_assign
l_string|&quot;Toshiba TC58FVB160&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_2MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_FUJITSU
comma
dot
id|dev_id
op_assign
id|MBM29LV160BE
comma
dot
id|name
op_assign
l_string|&quot;Fujitsu MBM29LV160BE&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_2MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_AMD
comma
dot
id|dev_id
op_assign
id|AM29LV800BB
comma
dot
id|name
op_assign
l_string|&quot;AMD AM29LV800BB&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_1MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_AMD
comma
dot
id|dev_id
op_assign
id|AM29F800BB
comma
dot
id|name
op_assign
l_string|&quot;AMD AM29F800BB&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_1MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_AMD
comma
dot
id|dev_id
op_assign
id|AM29LV800BT
comma
dot
id|name
op_assign
l_string|&quot;AMD AM29LV800BT&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_1MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_AMD
comma
dot
id|dev_id
op_assign
id|AM29F800BT
comma
dot
id|name
op_assign
l_string|&quot;AMD AM29F800BT&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_1MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_AMD
comma
dot
id|dev_id
op_assign
id|AM29LV800BB
comma
dot
id|name
op_assign
l_string|&quot;AMD AM29LV800BB&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_1MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_ST
comma
dot
id|dev_id
op_assign
id|M29W800T
comma
dot
id|name
op_assign
l_string|&quot;ST M29W800T&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_1MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_ST
comma
dot
id|dev_id
op_assign
id|M29W160DT
comma
dot
id|name
op_assign
l_string|&quot;ST M29W160DT&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_2MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_ST
comma
dot
id|dev_id
op_assign
id|M29W160DB
comma
dot
id|name
op_assign
l_string|&quot;ST M29W160DB&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_2MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|4
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_ATMEL
comma
dot
id|dev_id
op_assign
id|AT49BV16X4
comma
dot
id|name
op_assign
l_string|&quot;Atmel AT49BV16X4&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_2MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|3
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|8
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|30
)paren
)brace
)brace
comma
(brace
dot
id|mfr_id
op_assign
id|MANUFACTURER_ATMEL
comma
dot
id|dev_id
op_assign
id|AT49BV16X4T
comma
dot
id|name
op_assign
l_string|&quot;Atmel AT49BV16X4T&quot;
comma
dot
id|DevSize
op_assign
id|SIZE_2MiB
comma
dot
id|NumEraseRegions
op_assign
l_int|3
comma
dot
id|regions
op_assign
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|30
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|8
)paren
)brace
)brace
)brace
suffix:semicolon
r_static
r_int
id|cfi_jedec_setup
c_func
(paren
r_struct
id|cfi_private
op_star
id|p_cfi
comma
r_int
id|index
)paren
suffix:semicolon
r_static
r_int
id|jedec_probe_chip
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u32
id|base
comma
r_struct
id|flchip
op_star
id|chips
comma
r_struct
id|cfi_private
op_star
id|cfi
)paren
suffix:semicolon
r_struct
id|mtd_info
op_star
id|jedec_probe
c_func
(paren
r_struct
id|map_info
op_star
id|map
)paren
suffix:semicolon
DECL|macro|jedec_read_mfr
mdefine_line|#define jedec_read_mfr(map, base, osf) cfi_read(map, base)
DECL|macro|jedec_read_id
mdefine_line|#define jedec_read_id(map, base, osf) cfi_read(map, (base)+(osf))
DECL|function|cfi_jedec_setup
r_static
r_int
id|cfi_jedec_setup
c_func
(paren
r_struct
id|cfi_private
op_star
id|p_cfi
comma
r_int
id|index
)paren
(brace
r_int
id|i
comma
id|num_erase_regions
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Found: %s&bslash;n&quot;
comma
id|jedec_table
(braket
id|index
)braket
dot
id|name
)paren
suffix:semicolon
id|num_erase_regions
op_assign
id|jedec_table
(braket
id|index
)braket
dot
id|NumEraseRegions
suffix:semicolon
id|p_cfi-&gt;cfiq
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|cfi_ident
)paren
op_plus
id|num_erase_regions
op_star
l_int|4
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p_cfi-&gt;cfiq
)paren
(brace
singleline_comment|//xx printk(KERN_WARNING &quot;%s: kmalloc failed for CFI ident structure&bslash;n&quot;, map-&gt;name);
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
id|p_cfi-&gt;cfiq
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|cfi_ident
)paren
)paren
suffix:semicolon
id|p_cfi-&gt;cfiq-&gt;P_ID
op_assign
id|P_ID_AMD_STD
suffix:semicolon
id|p_cfi-&gt;cfiq-&gt;NumEraseRegions
op_assign
id|jedec_table
(braket
id|index
)braket
dot
id|NumEraseRegions
suffix:semicolon
id|p_cfi-&gt;cfiq-&gt;DevSize
op_assign
id|jedec_table
(braket
id|index
)braket
dot
id|DevSize
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_erase_regions
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p_cfi-&gt;cfiq-&gt;EraseRegionInfo
(braket
id|i
)braket
op_assign
id|jedec_table
(braket
id|index
)braket
dot
id|regions
(braket
id|i
)braket
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* ok */
)brace
DECL|function|jedec_probe_chip
r_static
r_int
id|jedec_probe_chip
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u32
id|base
comma
r_struct
id|flchip
op_star
id|chips
comma
r_struct
id|cfi_private
op_star
id|cfi
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|osf
op_assign
id|cfi-&gt;interleave
op_star
id|cfi-&gt;device_type
suffix:semicolon
r_int
id|retried
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cfi-&gt;numchips
)paren
(brace
r_switch
c_cond
(paren
id|cfi-&gt;device_type
)paren
(brace
r_case
id|CFI_DEVICETYPE_X8
suffix:colon
id|cfi-&gt;addr_unlock1
op_assign
l_int|0x555
suffix:semicolon
id|cfi-&gt;addr_unlock2
op_assign
l_int|0x2aa
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CFI_DEVICETYPE_X16
suffix:colon
id|cfi-&gt;addr_unlock1
op_assign
l_int|0xaaa
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
id|cfi-&gt;interleave
)paren
(brace
multiline_comment|/* X16 chip(s) in X8 mode */
id|cfi-&gt;addr_unlock2
op_assign
l_int|0x555
suffix:semicolon
)brace
r_else
(brace
id|cfi-&gt;addr_unlock2
op_assign
l_int|0x554
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CFI_DEVICETYPE_X32
suffix:colon
id|cfi-&gt;addr_unlock1
op_assign
l_int|0x1555
suffix:semicolon
id|cfi-&gt;addr_unlock2
op_assign
l_int|0xaaa
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Eep. Unknown jedec_probe device type %d&bslash;n&quot;
comma
id|cfi-&gt;device_type
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|retry
suffix:colon
multiline_comment|/* Reset */
id|cfi_send_gen_cmd
c_func
(paren
l_int|0xF0
comma
l_int|0
comma
id|base
comma
id|map
comma
id|cfi
comma
id|cfi-&gt;device_type
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Autoselect Mode */
id|cfi_send_gen_cmd
c_func
(paren
l_int|0xaa
comma
id|cfi-&gt;addr_unlock1
comma
id|base
comma
id|map
comma
id|cfi
comma
id|CFI_DEVICETYPE_X8
comma
l_int|NULL
)paren
suffix:semicolon
id|cfi_send_gen_cmd
c_func
(paren
l_int|0x55
comma
id|cfi-&gt;addr_unlock2
comma
id|base
comma
id|map
comma
id|cfi
comma
id|CFI_DEVICETYPE_X8
comma
l_int|NULL
)paren
suffix:semicolon
id|cfi_send_gen_cmd
c_func
(paren
l_int|0x90
comma
id|cfi-&gt;addr_unlock1
comma
id|base
comma
id|map
comma
id|cfi
comma
id|CFI_DEVICETYPE_X8
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cfi-&gt;numchips
)paren
(brace
multiline_comment|/* This is the first time we&squot;re called. Set up the CFI &n;&t;&t;   stuff accordingly and return */
id|cfi-&gt;mfr
op_assign
id|jedec_read_mfr
c_func
(paren
id|map
comma
id|base
comma
id|osf
)paren
suffix:semicolon
id|cfi-&gt;id
op_assign
id|jedec_read_id
c_func
(paren
id|map
comma
id|base
comma
id|osf
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|jedec_table
)paren
op_div
r_sizeof
(paren
id|jedec_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cfi-&gt;mfr
op_eq
id|jedec_table
(braket
id|i
)braket
dot
id|mfr_id
op_logical_and
id|cfi-&gt;id
op_eq
id|jedec_table
(braket
id|i
)braket
dot
id|dev_id
)paren
r_return
id|cfi_jedec_setup
c_func
(paren
id|cfi
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|retried
op_increment
)paren
(brace
multiline_comment|/* Deal with whichever strange chips these were */
id|cfi-&gt;addr_unlock1
op_or_assign
id|cfi-&gt;addr_unlock1
op_lshift
l_int|8
suffix:semicolon
id|cfi-&gt;addr_unlock2
op_or_assign
id|cfi-&gt;addr_unlock2
op_lshift
l_int|8
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Check each previous chip to see if it&squot;s an alias */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cfi-&gt;numchips
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* This chip should be in read mode if it&squot;s one&n;&t;&t;   we&squot;ve already touched. */
r_if
c_cond
(paren
id|jedec_read_mfr
c_func
(paren
id|map
comma
id|base
comma
id|osf
)paren
op_eq
id|cfi-&gt;mfr
op_logical_and
id|jedec_read_id
c_func
(paren
id|map
comma
id|base
comma
id|osf
)paren
op_eq
id|cfi-&gt;id
)paren
(brace
multiline_comment|/* Eep. This chip also looks like it&squot;s in autoselect mode.&n;&t;&t;&t;   Is it an alias for the new one? */
id|cfi_send_gen_cmd
c_func
(paren
l_int|0xF0
comma
l_int|0
comma
id|chips
(braket
id|i
)braket
dot
id|start
comma
id|map
comma
id|cfi
comma
id|cfi-&gt;device_type
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* If the device IDs go away, it&squot;s an alias */
r_if
c_cond
(paren
id|jedec_read_mfr
c_func
(paren
id|map
comma
id|base
comma
id|osf
)paren
op_ne
id|cfi-&gt;mfr
op_logical_or
id|jedec_read_id
c_func
(paren
id|map
comma
id|base
comma
id|osf
)paren
op_ne
id|cfi-&gt;id
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Found an alias at 0x%x for the chip at 0x%lx&bslash;n&quot;
comma
id|map-&gt;name
comma
id|base
comma
id|chips
(braket
id|i
)braket
dot
id|start
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Yes, it&squot;s actually got the device IDs as data. Most&n;&t;&t;&t; * unfortunate. Stick the new chip in read mode&n;&t;&t;&t; * too and if it&squot;s the same, assume it&squot;s an alias. */
multiline_comment|/* FIXME: Use other modes to do a proper check */
id|cfi_send_gen_cmd
c_func
(paren
l_int|0xF0
comma
l_int|0
comma
id|base
comma
id|map
comma
id|cfi
comma
id|cfi-&gt;device_type
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jedec_read_mfr
c_func
(paren
id|map
comma
id|base
comma
id|osf
)paren
op_eq
id|cfi-&gt;mfr
op_logical_and
id|jedec_read_id
c_func
(paren
id|map
comma
id|base
comma
id|osf
)paren
op_eq
id|cfi-&gt;id
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Found an alias at 0x%x for the chip at 0x%lx&bslash;n&quot;
comma
id|map-&gt;name
comma
id|base
comma
id|chips
(braket
id|i
)braket
dot
id|start
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* OK, if we got to here, then none of the previous chips appear to&n;&t;   be aliases for the current one. */
r_if
c_cond
(paren
id|cfi-&gt;numchips
op_eq
id|MAX_CFI_CHIPS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too many flash chips detected. Increase MAX_CFI_CHIPS from %d.&bslash;n&quot;
comma
id|map-&gt;name
comma
id|MAX_CFI_CHIPS
)paren
suffix:semicolon
multiline_comment|/* Doesn&squot;t matter about resetting it to Read Mode - we&squot;re not going to talk to it anyway */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|chips
(braket
id|cfi-&gt;numchips
)braket
dot
id|start
op_assign
id|base
suffix:semicolon
id|chips
(braket
id|cfi-&gt;numchips
)braket
dot
id|state
op_assign
id|FL_READY
suffix:semicolon
id|cfi-&gt;numchips
op_increment
suffix:semicolon
multiline_comment|/* Put it back into Read Mode */
id|cfi_send_gen_cmd
c_func
(paren
l_int|0xF0
comma
l_int|0
comma
id|base
comma
id|map
comma
id|cfi
comma
id|cfi-&gt;device_type
comma
l_int|NULL
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Found %d x%d devices at 0x%x in %d-bit mode&bslash;n&quot;
comma
id|map-&gt;name
comma
id|cfi-&gt;interleave
comma
id|cfi-&gt;device_type
op_star
l_int|8
comma
id|base
comma
id|map-&gt;buswidth
op_star
l_int|8
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|jedec_chip_probe
r_static
r_struct
id|chip_probe
id|jedec_chip_probe
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;JEDEC&quot;
comma
dot
id|probe_chip
op_assign
id|jedec_probe_chip
)brace
suffix:semicolon
DECL|function|jedec_probe
r_struct
id|mtd_info
op_star
id|jedec_probe
c_func
(paren
r_struct
id|map_info
op_star
id|map
)paren
(brace
multiline_comment|/*&n;&t; * Just use the generic probe stuff to call our CFI-specific&n;&t; * chip_probe routine in all the possible permutations, etc.&n;&t; */
r_return
id|mtd_do_chip_probe
c_func
(paren
id|map
comma
op_amp
id|jedec_chip_probe
)paren
suffix:semicolon
)brace
DECL|variable|jedec_chipdrv
r_static
r_struct
id|mtd_chip_driver
id|jedec_chipdrv
op_assign
(brace
dot
id|probe
op_assign
id|jedec_probe
comma
dot
id|name
op_assign
l_string|&quot;jedec_probe&quot;
comma
dot
id|module
op_assign
id|THIS_MODULE
)brace
suffix:semicolon
DECL|function|jedec_probe_init
r_int
id|__init
id|jedec_probe_init
c_func
(paren
r_void
)paren
(brace
id|register_mtd_chip_driver
c_func
(paren
op_amp
id|jedec_chipdrv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|jedec_probe_exit
r_static
r_void
id|__exit
id|jedec_probe_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_mtd_chip_driver
c_func
(paren
op_amp
id|jedec_chipdrv
)paren
suffix:semicolon
)brace
DECL|variable|jedec_probe_init
id|module_init
c_func
(paren
id|jedec_probe_init
)paren
suffix:semicolon
DECL|variable|jedec_probe_exit
id|module_exit
c_func
(paren
id|jedec_probe_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Erwin Authried &lt;eauth@softsys.co.at&gt; et al.&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Probe code for JEDEC-compliant flash chips&quot;
)paren
suffix:semicolon
eof
