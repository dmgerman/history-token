multiline_comment|/*&n; * MTD chip driver for pre-CFI Sharp flash chips&n; *&n; * Copyright 2000,2001 David A. Schleef &lt;ds@schleef.org&gt;&n; *           2000,2001 Lineo, Inc.&n; *&n; * $Id: sharp.c,v 1.6 2001/10/02 15:05:12 dwmw2 Exp $&n; *&n; * Devices supported:&n; *   LH28F016SCT Symmetrical block flash memory, 2Mx8&n; *   LH28F008SCT Symmetrical block flash memory, 1Mx8&n; *&n; * Documentation:&n; *   http://www.sharpmeg.com/datasheets/memic/flashcmp/&n; *   http://www.sharpmeg.com/datasheets/memic/flashcmp/01symf/16m/016sctl9.pdf&n; *   016sctl9.pdf&n; *&n; * Limitations:&n; *   This driver only supports 4x1 arrangement of chips.&n; *   Not tested on anything but PowerPC.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
macro_line|#include &lt;linux/mtd/cfi.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
DECL|macro|CMD_RESET
mdefine_line|#define CMD_RESET&t;&t;0xffffffff
DECL|macro|CMD_READ_ID
mdefine_line|#define CMD_READ_ID&t;&t;0x90909090
DECL|macro|CMD_READ_STATUS
mdefine_line|#define CMD_READ_STATUS&t;&t;0x70707070
DECL|macro|CMD_CLEAR_STATUS
mdefine_line|#define CMD_CLEAR_STATUS&t;0x50505050
DECL|macro|CMD_BLOCK_ERASE_1
mdefine_line|#define CMD_BLOCK_ERASE_1&t;0x20202020
DECL|macro|CMD_BLOCK_ERASE_2
mdefine_line|#define CMD_BLOCK_ERASE_2&t;0xd0d0d0d0
DECL|macro|CMD_BYTE_WRITE
mdefine_line|#define CMD_BYTE_WRITE&t;&t;0x40404040
DECL|macro|CMD_SUSPEND
mdefine_line|#define CMD_SUSPEND&t;&t;0xb0b0b0b0
DECL|macro|CMD_RESUME
mdefine_line|#define CMD_RESUME&t;&t;0xd0d0d0d0
DECL|macro|CMD_SET_BLOCK_LOCK_1
mdefine_line|#define CMD_SET_BLOCK_LOCK_1&t;0x60606060
DECL|macro|CMD_SET_BLOCK_LOCK_2
mdefine_line|#define CMD_SET_BLOCK_LOCK_2&t;0x01010101
DECL|macro|CMD_SET_MASTER_LOCK_1
mdefine_line|#define CMD_SET_MASTER_LOCK_1&t;0x60606060
DECL|macro|CMD_SET_MASTER_LOCK_2
mdefine_line|#define CMD_SET_MASTER_LOCK_2&t;0xf1f1f1f1
DECL|macro|CMD_CLEAR_BLOCK_LOCKS_1
mdefine_line|#define CMD_CLEAR_BLOCK_LOCKS_1&t;0x60606060
DECL|macro|CMD_CLEAR_BLOCK_LOCKS_2
mdefine_line|#define CMD_CLEAR_BLOCK_LOCKS_2&t;0xd0d0d0d0
DECL|macro|SR_READY
mdefine_line|#define SR_READY&t;&t;0x80808080 
singleline_comment|// 1 = ready
DECL|macro|SR_ERASE_SUSPEND
mdefine_line|#define SR_ERASE_SUSPEND&t;0x40404040 
singleline_comment|// 1 = block erase suspended
DECL|macro|SR_ERROR_ERASE
mdefine_line|#define SR_ERROR_ERASE&t;&t;0x20202020 
singleline_comment|// 1 = error in block erase or clear lock bits
DECL|macro|SR_ERROR_WRITE
mdefine_line|#define SR_ERROR_WRITE&t;&t;0x10101010 
singleline_comment|// 1 = error in byte write or set lock bit
DECL|macro|SR_VPP
mdefine_line|#define&t;SR_VPP&t;&t;&t;0x08080808 
singleline_comment|// 1 = Vpp is low
DECL|macro|SR_WRITE_SUSPEND
mdefine_line|#define SR_WRITE_SUSPEND&t;0x04040404 
singleline_comment|// 1 = byte write suspended
DECL|macro|SR_PROTECT
mdefine_line|#define SR_PROTECT&t;&t;0x02020202 
singleline_comment|// 1 = lock bit set
DECL|macro|SR_RESERVED
mdefine_line|#define SR_RESERVED&t;&t;0x01010101
DECL|macro|SR_ERRORS
mdefine_line|#define SR_ERRORS (SR_ERROR_ERASE|SR_ERROR_WRITE|SR_VPP|SR_PROTECT)
multiline_comment|/* Configuration options */
DECL|macro|AUTOUNLOCK
macro_line|#undef AUTOUNLOCK  /* automatically unlocks blocks before erasing */
r_struct
id|mtd_info
op_star
id|sharp_probe
c_func
(paren
r_struct
id|map_info
op_star
)paren
suffix:semicolon
r_static
r_int
id|sharp_probe_map
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|mtd_info
op_star
id|mtd
)paren
suffix:semicolon
r_static
r_int
id|sharp_read
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|sharp_write
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|sharp_erase
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_struct
id|erase_info
op_star
id|instr
)paren
suffix:semicolon
r_static
r_void
id|sharp_sync
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
suffix:semicolon
r_static
r_int
id|sharp_suspend
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
suffix:semicolon
r_static
r_void
id|sharp_resume
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
suffix:semicolon
r_static
r_void
id|sharp_destroy
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
suffix:semicolon
r_static
r_int
id|sharp_write_oneword
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|flchip
op_star
id|chip
comma
r_int
r_int
id|adr
comma
id|__u32
id|datum
)paren
suffix:semicolon
r_static
r_int
id|sharp_erase_oneblock
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|flchip
op_star
id|chip
comma
r_int
r_int
id|adr
)paren
suffix:semicolon
macro_line|#ifdef AUTOUNLOCK
r_static
r_void
id|sharp_unlock_oneblock
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|flchip
op_star
id|chip
comma
r_int
r_int
id|adr
)paren
suffix:semicolon
macro_line|#endif
DECL|struct|sharp_info
r_struct
id|sharp_info
(brace
DECL|member|chip
r_struct
id|flchip
op_star
id|chip
suffix:semicolon
DECL|member|bogus
r_int
id|bogus
suffix:semicolon
DECL|member|chipshift
r_int
id|chipshift
suffix:semicolon
DECL|member|numchips
r_int
id|numchips
suffix:semicolon
DECL|member|chips
r_struct
id|flchip
id|chips
(braket
l_int|1
)braket
suffix:semicolon
)brace
suffix:semicolon
r_struct
id|mtd_info
op_star
id|sharp_probe
c_func
(paren
r_struct
id|map_info
op_star
id|map
)paren
suffix:semicolon
r_static
r_void
id|sharp_destroy
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
suffix:semicolon
DECL|variable|sharp_chipdrv
r_static
r_struct
id|mtd_chip_driver
id|sharp_chipdrv
op_assign
(brace
id|probe
suffix:colon
id|sharp_probe
comma
id|destroy
suffix:colon
id|sharp_destroy
comma
id|name
suffix:colon
l_string|&quot;sharp&quot;
comma
id|module
suffix:colon
id|THIS_MODULE
)brace
suffix:semicolon
DECL|function|sharp_probe
r_struct
id|mtd_info
op_star
id|sharp_probe
c_func
(paren
r_struct
id|map_info
op_star
id|map
)paren
(brace
r_struct
id|mtd_info
op_star
id|mtd
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sharp_info
op_star
id|sharp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|width
suffix:semicolon
id|mtd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mtd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mtd
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|sharp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|sharp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sharp
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mtd
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mtd
)paren
)paren
suffix:semicolon
id|width
op_assign
id|sharp_probe_map
c_func
(paren
id|map
comma
id|mtd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|width
)paren
(brace
id|kfree
c_func
(paren
id|mtd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sharp
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|mtd-&gt;priv
op_assign
id|map
suffix:semicolon
id|mtd-&gt;type
op_assign
id|MTD_NORFLASH
suffix:semicolon
id|mtd-&gt;erase
op_assign
id|sharp_erase
suffix:semicolon
id|mtd-&gt;read
op_assign
id|sharp_read
suffix:semicolon
id|mtd-&gt;write
op_assign
id|sharp_write
suffix:semicolon
id|mtd-&gt;sync
op_assign
id|sharp_sync
suffix:semicolon
id|mtd-&gt;suspend
op_assign
id|sharp_suspend
suffix:semicolon
id|mtd-&gt;resume
op_assign
id|sharp_resume
suffix:semicolon
id|mtd-&gt;flags
op_assign
id|MTD_CAP_NORFLASH
suffix:semicolon
id|mtd-&gt;name
op_assign
id|map-&gt;name
suffix:semicolon
id|memset
c_func
(paren
id|sharp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sharp
)paren
)paren
suffix:semicolon
id|sharp-&gt;chipshift
op_assign
l_int|23
suffix:semicolon
id|sharp-&gt;numchips
op_assign
l_int|1
suffix:semicolon
id|sharp-&gt;chips
(braket
l_int|0
)braket
dot
id|start
op_assign
l_int|0
suffix:semicolon
id|sharp-&gt;chips
(braket
l_int|0
)braket
dot
id|state
op_assign
id|FL_READY
suffix:semicolon
id|sharp-&gt;chips
(braket
l_int|0
)braket
dot
id|mutex
op_assign
op_amp
id|sharp-&gt;chips
(braket
l_int|0
)braket
dot
id|_spinlock
suffix:semicolon
id|sharp-&gt;chips
(braket
l_int|0
)braket
dot
id|word_write_time
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sharp-&gt;chips
(braket
l_int|0
)braket
dot
id|wq
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|sharp-&gt;chips
(braket
l_int|0
)braket
dot
id|_spinlock
)paren
suffix:semicolon
id|map-&gt;fldrv
op_assign
op_amp
id|sharp_chipdrv
suffix:semicolon
id|map-&gt;fldrv_priv
op_assign
id|sharp
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
id|mtd
suffix:semicolon
)brace
DECL|function|sharp_probe_map
r_static
r_int
id|sharp_probe_map
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_int
r_int
id|base
op_assign
l_int|0
suffix:semicolon
id|u32
id|read0
comma
id|read4
suffix:semicolon
r_int
id|width
op_assign
l_int|4
suffix:semicolon
id|tmp
op_assign
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|base
op_plus
l_int|0
)paren
suffix:semicolon
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_READ_ID
comma
id|base
op_plus
l_int|0
)paren
suffix:semicolon
id|read0
op_assign
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|base
op_plus
l_int|0
)paren
suffix:semicolon
id|read4
op_assign
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|base
op_plus
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read0
op_eq
l_int|0x89898989
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Looks like sharp flash&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|read4
)paren
(brace
r_case
l_int|0xaaaaaaaa
suffix:colon
r_case
l_int|0xa0a0a0a0
suffix:colon
multiline_comment|/* aa - LH28F016SCT-L95 2Mx8, 32 64k blocks*/
multiline_comment|/* a0 - LH28F016SCT-Z4  2Mx8, 32 64k blocks*/
id|mtd-&gt;erasesize
op_assign
l_int|0x10000
op_star
id|width
suffix:semicolon
id|mtd-&gt;size
op_assign
l_int|0x200000
op_star
id|width
suffix:semicolon
r_return
id|width
suffix:semicolon
r_case
l_int|0xa6a6a6a6
suffix:colon
multiline_comment|/* a6 - LH28F008SCT-L12 1Mx8, 16 64k blocks*/
multiline_comment|/* a6 - LH28F008SCR-L85 1Mx8, 16 64k blocks*/
id|mtd-&gt;erasesize
op_assign
l_int|0x10000
op_star
id|width
suffix:semicolon
id|mtd-&gt;size
op_assign
l_int|0x100000
op_star
id|width
suffix:semicolon
r_return
id|width
suffix:semicolon
macro_line|#if 0
r_case
l_int|0x00000000
suffix:colon
multiline_comment|/* unknown */
multiline_comment|/* XX - LH28F004SCT 512kx8, 8 64k blocks*/
id|mtd-&gt;erasesize
op_assign
l_int|0x10000
op_star
id|width
suffix:semicolon
id|mtd-&gt;size
op_assign
l_int|0x80000
op_star
id|width
suffix:semicolon
r_return
id|width
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Sort-of looks like sharp flash, 0x%08x 0x%08x&bslash;n&quot;
comma
id|read0
comma
id|read4
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|base
op_plus
l_int|0
)paren
op_eq
id|CMD_READ_ID
)paren
)paren
(brace
multiline_comment|/* RAM, probably */
id|printk
c_func
(paren
l_string|&quot;Looks like RAM&bslash;n&quot;
)paren
suffix:semicolon
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|tmp
comma
id|base
op_plus
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Doesn&squot;t look like sharp flash, 0x%08x 0x%08x&bslash;n&quot;
comma
id|read0
comma
id|read4
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This function returns with the chip-&gt;mutex lock held. */
DECL|function|sharp_wait
r_static
r_int
id|sharp_wait
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|flchip
op_star
id|chip
)paren
(brace
id|__u16
id|status
suffix:semicolon
r_int
r_int
id|timeo
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
id|adr
op_assign
l_int|0
suffix:semicolon
id|retry
suffix:colon
id|spin_lock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|chip-&gt;state
)paren
(brace
r_case
id|FL_READY
suffix:colon
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_READ_STATUS
comma
id|adr
)paren
suffix:semicolon
id|chip-&gt;state
op_assign
id|FL_STATUS
suffix:semicolon
r_case
id|FL_STATUS
suffix:colon
id|status
op_assign
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
singleline_comment|//printk(&quot;status=%08x&bslash;n&quot;,status);
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|SR_READY
)paren
op_ne
id|SR_READY
)paren
(brace
singleline_comment|//printk(&quot;.status=%08x&bslash;n&quot;,status);
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Waiting for chip&bslash;n&quot;
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|timeo
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_RESET
comma
id|adr
)paren
suffix:semicolon
id|chip-&gt;state
op_assign
id|FL_READY
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sharp_release
r_static
r_void
id|sharp_release
c_func
(paren
r_struct
id|flchip
op_star
id|chip
)paren
(brace
id|wake_up
c_func
(paren
op_amp
id|chip-&gt;wq
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
)brace
DECL|function|sharp_read
r_static
r_int
id|sharp_read
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
(brace
r_struct
id|map_info
op_star
id|map
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|sharp_info
op_star
id|sharp
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
r_int
id|chipnum
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|ofs
op_assign
l_int|0
suffix:semicolon
id|chipnum
op_assign
(paren
id|from
op_rshift
id|sharp-&gt;chipshift
)paren
suffix:semicolon
id|ofs
op_assign
id|from
op_amp
(paren
(paren
l_int|1
op_lshift
id|sharp-&gt;chipshift
)paren
op_minus
l_int|1
)paren
suffix:semicolon
op_star
id|retlen
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
r_int
r_int
id|thislen
suffix:semicolon
r_if
c_cond
(paren
id|chipnum
op_ge
id|sharp-&gt;numchips
)paren
(brace
r_break
suffix:semicolon
)brace
id|thislen
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|ofs
op_plus
id|thislen
op_ge
(paren
l_int|1
op_lshift
id|sharp-&gt;chipshift
)paren
)paren
(brace
id|thislen
op_assign
(paren
l_int|1
op_lshift
id|sharp-&gt;chipshift
)paren
op_minus
id|ofs
suffix:semicolon
)brace
id|ret
op_assign
id|sharp_wait
c_func
(paren
id|map
comma
op_amp
id|sharp-&gt;chips
(braket
id|chipnum
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
id|map
op_member_access_from_pointer
id|copy_from
c_func
(paren
id|map
comma
id|buf
comma
id|ofs
comma
id|thislen
)paren
suffix:semicolon
id|sharp_release
c_func
(paren
op_amp
id|sharp-&gt;chips
(braket
id|chipnum
)braket
)paren
suffix:semicolon
op_star
id|retlen
op_add_assign
id|thislen
suffix:semicolon
id|len
op_sub_assign
id|thislen
suffix:semicolon
id|buf
op_add_assign
id|thislen
suffix:semicolon
id|ofs
op_assign
l_int|0
suffix:semicolon
id|chipnum
op_increment
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sharp_write
r_static
r_int
id|sharp_write
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
(brace
r_struct
id|map_info
op_star
id|map
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|sharp_info
op_star
id|sharp
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|chipnum
suffix:semicolon
r_int
r_int
id|ofs
suffix:semicolon
r_union
(brace
id|u32
id|l
suffix:semicolon
r_int
r_char
id|uc
(braket
l_int|4
)braket
suffix:semicolon
)brace
id|tbuf
suffix:semicolon
op_star
id|retlen
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
id|tbuf.l
op_assign
l_int|0xffffffff
suffix:semicolon
id|chipnum
op_assign
id|to
op_rshift
id|sharp-&gt;chipshift
suffix:semicolon
id|ofs
op_assign
id|to
op_amp
(paren
(paren
l_int|1
op_lshift
id|sharp-&gt;chipshift
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ofs
op_amp
l_int|3
suffix:semicolon
id|i
OL
l_int|4
op_logical_and
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tbuf.uc
(braket
id|i
)braket
op_assign
op_star
id|buf
suffix:semicolon
id|buf
op_increment
suffix:semicolon
id|to
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
id|sharp_write_oneword
c_func
(paren
id|map
comma
op_amp
id|sharp-&gt;chips
(braket
id|chipnum
)braket
comma
id|ofs
op_amp
op_complement
l_int|3
comma
id|tbuf.l
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
(paren
op_star
id|retlen
)paren
op_add_assign
id|j
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sharp_write_oneword
r_static
r_int
id|sharp_write_oneword
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|flchip
op_star
id|chip
comma
r_int
r_int
id|adr
comma
id|__u32
id|datum
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|timeo
suffix:semicolon
r_int
r_try
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|sharp_wait
c_func
(paren
id|map
comma
id|chip
)paren
suffix:semicolon
r_for
c_loop
(paren
r_try
op_assign
l_int|0
suffix:semicolon
r_try
OL
l_int|10
suffix:semicolon
r_try
op_increment
)paren
(brace
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_BYTE_WRITE
comma
id|adr
)paren
suffix:semicolon
multiline_comment|/* cpu_to_le32 -&gt; hack to fix the writel be-&gt;le conversion */
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|cpu_to_le32
c_func
(paren
id|datum
)paren
comma
id|adr
)paren
suffix:semicolon
id|chip-&gt;state
op_assign
id|FL_WRITING
suffix:semicolon
id|timeo
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_READ_STATUS
comma
id|adr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|status
op_assign
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|SR_READY
)paren
op_eq
id|SR_READY
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|100
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sharp: timed out writing&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|SR_ERRORS
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;sharp: error writing byte at addr=%08lx status=%08x&bslash;n&quot;
comma
id|adr
comma
id|status
)paren
suffix:semicolon
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_CLEAR_STATUS
comma
id|adr
)paren
suffix:semicolon
)brace
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_RESET
comma
id|adr
)paren
suffix:semicolon
id|chip-&gt;state
op_assign
id|FL_READY
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|chip-&gt;wq
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sharp_erase
r_static
r_int
id|sharp_erase
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_struct
id|erase_info
op_star
id|instr
)paren
(brace
r_struct
id|map_info
op_star
id|map
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|sharp_info
op_star
id|sharp
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
r_int
r_int
id|adr
comma
id|len
suffix:semicolon
r_int
id|chipnum
comma
id|ret
op_assign
l_int|0
suffix:semicolon
singleline_comment|//printk(&quot;sharp_erase()&bslash;n&quot;);
r_if
c_cond
(paren
id|instr-&gt;addr
op_amp
(paren
id|mtd-&gt;erasesize
op_minus
l_int|1
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|instr-&gt;len
op_amp
(paren
id|mtd-&gt;erasesize
op_minus
l_int|1
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|instr-&gt;len
op_plus
id|instr-&gt;addr
OG
id|mtd-&gt;size
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|chipnum
op_assign
id|instr-&gt;addr
op_rshift
id|sharp-&gt;chipshift
suffix:semicolon
id|adr
op_assign
id|instr-&gt;addr
op_amp
(paren
(paren
l_int|1
op_lshift
id|sharp-&gt;chipshift
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|len
op_assign
id|instr-&gt;len
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
id|ret
op_assign
id|sharp_erase_oneblock
c_func
(paren
id|map
comma
op_amp
id|sharp-&gt;chips
(braket
id|chipnum
)braket
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|adr
op_add_assign
id|mtd-&gt;erasesize
suffix:semicolon
id|len
op_sub_assign
id|mtd-&gt;erasesize
suffix:semicolon
r_if
c_cond
(paren
id|adr
op_rshift
id|sharp-&gt;chipshift
)paren
(brace
id|adr
op_assign
l_int|0
suffix:semicolon
id|chipnum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|chipnum
op_ge
id|sharp-&gt;numchips
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|instr-&gt;callback
)paren
(brace
id|instr
op_member_access_from_pointer
id|callback
c_func
(paren
id|instr
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sharp_do_wait_for_ready
r_static
r_int
id|sharp_do_wait_for_ready
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|flchip
op_star
id|chip
comma
r_int
r_int
id|adr
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|timeo
suffix:semicolon
r_int
id|status
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_READ_STATUS
comma
id|adr
)paren
suffix:semicolon
id|status
op_assign
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
id|timeo
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|timeo
)paren
(brace
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_READ_STATUS
comma
id|adr
)paren
suffix:semicolon
id|status
op_assign
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|SR_READY
)paren
op_eq
id|SR_READY
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
singleline_comment|//spin_unlock_bh(chip-&gt;mutex);
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
singleline_comment|//spin_lock_bh(chip-&gt;mutex);
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINTR
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|ret
op_assign
op_minus
id|ETIME
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sharp_erase_oneblock
r_static
r_int
id|sharp_erase_oneblock
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|flchip
op_star
id|chip
comma
r_int
r_int
id|adr
)paren
(brace
r_int
id|ret
suffix:semicolon
singleline_comment|//int timeo;
r_int
id|status
suffix:semicolon
singleline_comment|//int i;
singleline_comment|//printk(&quot;sharp_erase_oneblock()&bslash;n&quot;);
macro_line|#ifdef AUTOUNLOCK
multiline_comment|/* This seems like a good place to do an unlock */
id|sharp_unlock_oneblock
c_func
(paren
id|map
comma
id|chip
comma
id|adr
)paren
suffix:semicolon
macro_line|#endif
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_BLOCK_ERASE_1
comma
id|adr
)paren
suffix:semicolon
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_BLOCK_ERASE_2
comma
id|adr
)paren
suffix:semicolon
id|chip-&gt;state
op_assign
id|FL_ERASING
suffix:semicolon
id|ret
op_assign
id|sharp_do_wait_for_ready
c_func
(paren
id|map
comma
id|chip
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_READ_STATUS
comma
id|adr
)paren
suffix:semicolon
id|status
op_assign
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|SR_ERRORS
)paren
)paren
(brace
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_RESET
comma
id|adr
)paren
suffix:semicolon
id|chip-&gt;state
op_assign
id|FL_READY
suffix:semicolon
singleline_comment|//spin_unlock_bh(chip-&gt;mutex);
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;sharp: error erasing block at addr=%08lx status=%08x&bslash;n&quot;
comma
id|adr
comma
id|status
)paren
suffix:semicolon
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_CLEAR_STATUS
comma
id|adr
)paren
suffix:semicolon
singleline_comment|//spin_unlock_bh(chip-&gt;mutex);
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef AUTOUNLOCK
DECL|function|sharp_unlock_oneblock
r_static
r_void
id|sharp_unlock_oneblock
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|flchip
op_star
id|chip
comma
r_int
r_int
id|adr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|status
suffix:semicolon
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_CLEAR_BLOCK_LOCKS_1
comma
id|adr
)paren
suffix:semicolon
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_CLEAR_BLOCK_LOCKS_2
comma
id|adr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|status
op_assign
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;status=%08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
(brace
singleline_comment|//map-&gt;write32(map,CMD_READ_STATUS,adr);
id|status
op_assign
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|SR_READY
)paren
op_eq
id|SR_READY
)paren
(brace
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|1000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sharp: timed out unlocking block&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|SR_ERRORS
)paren
)paren
(brace
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_RESET
comma
id|adr
)paren
suffix:semicolon
id|chip-&gt;state
op_assign
id|FL_READY
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;sharp: error unlocking block at addr=%08lx status=%08x&bslash;n&quot;
comma
id|adr
comma
id|status
)paren
suffix:semicolon
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|CMD_CLEAR_STATUS
comma
id|adr
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|sharp_sync
r_static
r_void
id|sharp_sync
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
singleline_comment|//printk(&quot;sharp_sync()&bslash;n&quot;);
)brace
DECL|function|sharp_suspend
r_static
r_int
id|sharp_suspend
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sharp_suspend()&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|sharp_resume
r_static
r_void
id|sharp_resume
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sharp_resume()&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|sharp_destroy
r_static
r_void
id|sharp_destroy
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sharp_destroy()&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|sharp_probe_init
r_int
id|__init
id|sharp_probe_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MTD Sharp chip driver &lt;ds@lineo.com&gt;&bslash;n&quot;
)paren
suffix:semicolon
id|register_mtd_chip_driver
c_func
(paren
op_amp
id|sharp_chipdrv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sharp_probe_exit
r_static
r_void
id|__exit
id|sharp_probe_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_mtd_chip_driver
c_func
(paren
op_amp
id|sharp_chipdrv
)paren
suffix:semicolon
)brace
DECL|variable|sharp_probe_init
id|module_init
c_func
(paren
id|sharp_probe_init
)paren
suffix:semicolon
DECL|variable|sharp_probe_exit
id|module_exit
c_func
(paren
id|sharp_probe_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;David Schleef &lt;ds@schleef.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Old MTD chip driver for pre-CFI Sharp flash chips&quot;
)paren
suffix:semicolon
eof
