multiline_comment|/*&n; * MTD map driver for AMD compatible flash chips (non-CFI)&n; *&n; * Author: Jonas Holmberg &lt;jonas.holmberg@axis.com&gt;&n; *&n; * $Id: amd_flash.c,v 1.8 2001/06/02 14:47:16 dwmw2 Exp $&n; *&n; * Copyright (c) 2001 Axis Communications AB&n; *&n; * This file is under GPL.&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/mtd/flashchip.h&gt;
multiline_comment|/* There&squot;s no limit. It exists only to avoid realloc. */
DECL|macro|MAX_AMD_CHIPS
mdefine_line|#define MAX_AMD_CHIPS 8
DECL|macro|DEVICE_TYPE_X8
mdefine_line|#define DEVICE_TYPE_X8&t;(8 / 8)
DECL|macro|DEVICE_TYPE_X16
mdefine_line|#define DEVICE_TYPE_X16&t;(16 / 8)
DECL|macro|DEVICE_TYPE_X32
mdefine_line|#define DEVICE_TYPE_X32&t;(32 / 8)
multiline_comment|/* Addresses */
DECL|macro|ADDR_MANUFACTURER
mdefine_line|#define ADDR_MANUFACTURER&t;&t;0x0000
DECL|macro|ADDR_DEVICE_ID
mdefine_line|#define ADDR_DEVICE_ID&t;&t;&t;0x0001
DECL|macro|ADDR_UNLOCK_1
mdefine_line|#define ADDR_UNLOCK_1&t;&t;&t;0x0555
DECL|macro|ADDR_UNLOCK_2
mdefine_line|#define ADDR_UNLOCK_2&t;&t;&t;0x02AA
multiline_comment|/* Commands */
DECL|macro|CMD_UNLOCK_DATA_1
mdefine_line|#define CMD_UNLOCK_DATA_1&t;&t;0x00AA
DECL|macro|CMD_UNLOCK_DATA_2
mdefine_line|#define CMD_UNLOCK_DATA_2&t;&t;0x0055
DECL|macro|CMD_MANUFACTURER_UNLOCK_DATA
mdefine_line|#define CMD_MANUFACTURER_UNLOCK_DATA&t;0x0090
DECL|macro|CMD_UNLOCK_BYPASS_MODE
mdefine_line|#define CMD_UNLOCK_BYPASS_MODE&t;&t;0x0020
DECL|macro|CMD_PROGRAM_UNLOCK_DATA
mdefine_line|#define CMD_PROGRAM_UNLOCK_DATA&t;&t;0x00A0
DECL|macro|CMD_RESET_DATA
mdefine_line|#define CMD_RESET_DATA&t;&t;&t;0x00F0
DECL|macro|CMD_SECTOR_ERASE_UNLOCK_DATA
mdefine_line|#define CMD_SECTOR_ERASE_UNLOCK_DATA&t;0x0080
DECL|macro|CMD_SECTOR_ERASE_UNLOCK_DATA_2
mdefine_line|#define CMD_SECTOR_ERASE_UNLOCK_DATA_2&t;0x0030
multiline_comment|/* Manufacturers */
DECL|macro|MANUFACTURER_AMD
mdefine_line|#define MANUFACTURER_AMD&t;0x0001
DECL|macro|MANUFACTURER_FUJITSU
mdefine_line|#define MANUFACTURER_FUJITSU&t;0x0004
DECL|macro|MANUFACTURER_ST
mdefine_line|#define MANUFACTURER_ST&t;&t;0x0020
DECL|macro|MANUFACTURER_SST
mdefine_line|#define MANUFACTURER_SST&t;0x00BF
DECL|macro|MANUFACTURER_TOSHIBA
mdefine_line|#define MANUFACTURER_TOSHIBA&t;0x0098
multiline_comment|/* AMD */
DECL|macro|AM29F800BB
mdefine_line|#define AM29F800BB&t;0x2258
DECL|macro|AM29F800BT
mdefine_line|#define AM29F800BT&t;0x22D6
DECL|macro|AM29LV800BB
mdefine_line|#define AM29LV800BB&t;0x225B
DECL|macro|AM29LV800BT
mdefine_line|#define AM29LV800BT&t;0x22DA
DECL|macro|AM29LV160DT
mdefine_line|#define AM29LV160DT&t;0x22C4
DECL|macro|AM29LV160DB
mdefine_line|#define AM29LV160DB&t;0x2249
multiline_comment|/* Fujitsu */
DECL|macro|MBM29LV160TE
mdefine_line|#define MBM29LV160TE&t;0x22C4
DECL|macro|MBM29LV160BE
mdefine_line|#define MBM29LV160BE&t;0x2249
multiline_comment|/* ST - www.st.com */
DECL|macro|M29W800T
mdefine_line|#define M29W800T&t;0x00D7
DECL|macro|M29W160DT
mdefine_line|#define M29W160DT&t;0x22C4
DECL|macro|M29W160DB
mdefine_line|#define M29W160DB&t;0x2249
multiline_comment|/* SST */
DECL|macro|SST39LF800
mdefine_line|#define SST39LF800&t;0x2781
DECL|macro|SST39LF160
mdefine_line|#define SST39LF160&t;0x2782
multiline_comment|/* Toshiba */
DECL|macro|TC58FVT160
mdefine_line|#define TC58FVT160&t;0x00C2
DECL|macro|TC58FVB160
mdefine_line|#define TC58FVB160&t;0x0043
DECL|macro|D6_MASK
mdefine_line|#define D6_MASK&t;0x40
DECL|struct|amd_flash_private
r_struct
id|amd_flash_private
(brace
DECL|member|device_type
r_int
id|device_type
suffix:semicolon
DECL|member|interleave
r_int
id|interleave
suffix:semicolon
DECL|member|numchips
r_int
id|numchips
suffix:semicolon
DECL|member|chipshift
r_int
r_int
id|chipshift
suffix:semicolon
singleline_comment|//&t;const char *im_name;
DECL|member|chips
r_struct
id|flchip
id|chips
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|amd_flash_info
r_struct
id|amd_flash_info
(brace
DECL|member|mfr_id
r_const
id|__u16
id|mfr_id
suffix:semicolon
DECL|member|dev_id
r_const
id|__u16
id|dev_id
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|size
r_const
id|u_long
id|size
suffix:semicolon
DECL|member|numeraseregions
r_const
r_int
id|numeraseregions
suffix:semicolon
DECL|member|regions
r_const
r_struct
id|mtd_erase_region_info
id|regions
(braket
l_int|4
)braket
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|amd_flash_read
c_func
(paren
r_struct
id|mtd_info
op_star
comma
id|loff_t
comma
r_int
comma
r_int
op_star
comma
id|u_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|amd_flash_write
c_func
(paren
r_struct
id|mtd_info
op_star
comma
id|loff_t
comma
r_int
comma
r_int
op_star
comma
r_const
id|u_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|amd_flash_erase
c_func
(paren
r_struct
id|mtd_info
op_star
comma
r_struct
id|erase_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|amd_flash_sync
c_func
(paren
r_struct
id|mtd_info
op_star
)paren
suffix:semicolon
r_static
r_int
id|amd_flash_suspend
c_func
(paren
r_struct
id|mtd_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|amd_flash_resume
c_func
(paren
r_struct
id|mtd_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|amd_flash_destroy
c_func
(paren
r_struct
id|mtd_info
op_star
)paren
suffix:semicolon
r_static
r_struct
id|mtd_info
op_star
id|amd_flash_probe
c_func
(paren
r_struct
id|map_info
op_star
id|map
)paren
suffix:semicolon
DECL|variable|amd_flash_chipdrv
r_static
r_struct
id|mtd_chip_driver
id|amd_flash_chipdrv
op_assign
(brace
id|probe
suffix:colon
id|amd_flash_probe
comma
id|destroy
suffix:colon
id|amd_flash_destroy
comma
id|name
suffix:colon
l_string|&quot;amd_flash&quot;
comma
id|module
suffix:colon
id|THIS_MODULE
)brace
suffix:semicolon
DECL|variable|im_name
r_static
r_const
r_char
id|im_name
(braket
)braket
op_assign
l_string|&quot;amd_flash&quot;
suffix:semicolon
DECL|function|wide_read
r_static
r_inline
id|__u32
id|wide_read
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u32
id|addr
)paren
(brace
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|1
)paren
(brace
r_return
id|map
op_member_access_from_pointer
id|read8
c_func
(paren
id|map
comma
id|addr
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|2
)paren
(brace
r_return
id|map
op_member_access_from_pointer
id|read16
c_func
(paren
id|map
comma
id|addr
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|4
)paren
(brace
r_return
id|map
op_member_access_from_pointer
id|read32
c_func
(paren
id|map
comma
id|addr
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wide_write
r_static
r_inline
r_void
id|wide_write
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u32
id|val
comma
id|__u32
id|addr
)paren
(brace
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|1
)paren
(brace
id|map
op_member_access_from_pointer
id|write8
c_func
(paren
id|map
comma
id|val
comma
id|addr
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|2
)paren
(brace
id|map
op_member_access_from_pointer
id|write16
c_func
(paren
id|map
comma
id|val
comma
id|addr
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|4
)paren
(brace
id|map
op_member_access_from_pointer
id|write32
c_func
(paren
id|map
comma
id|val
comma
id|addr
)paren
suffix:semicolon
)brace
)brace
DECL|function|make_cmd
r_static
r_inline
id|__u32
id|make_cmd
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u32
id|cmd
)paren
(brace
r_const
r_struct
id|amd_flash_private
op_star
r_private
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
r_if
c_cond
(paren
(paren
r_private
op_member_access_from_pointer
id|interleave
op_eq
l_int|2
)paren
op_logical_and
(paren
r_private
op_member_access_from_pointer
id|device_type
op_eq
id|DEVICE_TYPE_X16
)paren
)paren
(brace
id|cmd
op_or_assign
(paren
id|cmd
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_return
id|cmd
suffix:semicolon
)brace
DECL|function|send_unlock
r_static
r_inline
r_void
id|send_unlock
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|base
)paren
(brace
id|wide_write
c_func
(paren
id|map
comma
(paren
id|CMD_UNLOCK_DATA_1
op_lshift
l_int|16
)paren
op_or
id|CMD_UNLOCK_DATA_1
comma
id|base
op_plus
(paren
id|map-&gt;buswidth
op_star
id|ADDR_UNLOCK_1
)paren
)paren
suffix:semicolon
id|wide_write
c_func
(paren
id|map
comma
(paren
id|CMD_UNLOCK_DATA_2
op_lshift
l_int|16
)paren
op_or
id|CMD_UNLOCK_DATA_2
comma
id|base
op_plus
(paren
id|map-&gt;buswidth
op_star
id|ADDR_UNLOCK_2
)paren
)paren
suffix:semicolon
)brace
DECL|function|send_cmd
r_static
r_inline
r_void
id|send_cmd
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|base
comma
id|__u32
id|cmd
)paren
(brace
id|send_unlock
c_func
(paren
id|map
comma
id|base
)paren
suffix:semicolon
id|wide_write
c_func
(paren
id|map
comma
id|make_cmd
c_func
(paren
id|map
comma
id|cmd
)paren
comma
id|base
op_plus
(paren
id|map-&gt;buswidth
op_star
id|ADDR_UNLOCK_1
)paren
)paren
suffix:semicolon
)brace
DECL|function|send_cmd_to_addr
r_static
r_inline
r_void
id|send_cmd_to_addr
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|base
comma
id|__u32
id|cmd
comma
r_int
r_int
id|addr
)paren
(brace
id|send_unlock
c_func
(paren
id|map
comma
id|base
)paren
suffix:semicolon
id|wide_write
c_func
(paren
id|map
comma
id|make_cmd
c_func
(paren
id|map
comma
id|cmd
)paren
comma
id|addr
)paren
suffix:semicolon
)brace
DECL|function|flash_is_busy
r_static
r_inline
r_int
id|flash_is_busy
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|addr
comma
r_int
id|interleave
)paren
(brace
r_if
c_cond
(paren
(paren
id|interleave
op_eq
l_int|2
)paren
op_logical_and
(paren
id|map-&gt;buswidth
op_eq
l_int|4
)paren
)paren
(brace
id|__u32
id|read1
comma
id|read2
suffix:semicolon
id|read1
op_assign
id|wide_read
c_func
(paren
id|map
comma
id|addr
)paren
suffix:semicolon
id|read2
op_assign
id|wide_read
c_func
(paren
id|map
comma
id|addr
)paren
suffix:semicolon
r_return
(paren
(paren
(paren
id|read1
op_rshift
l_int|16
)paren
op_amp
id|D6_MASK
)paren
op_ne
(paren
(paren
id|read2
op_rshift
l_int|16
)paren
op_amp
id|D6_MASK
)paren
)paren
op_logical_or
(paren
(paren
(paren
id|read1
op_amp
l_int|0xffff
)paren
op_amp
id|D6_MASK
)paren
op_ne
(paren
(paren
id|read2
op_amp
l_int|0xffff
)paren
op_amp
id|D6_MASK
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
(paren
id|wide_read
c_func
(paren
id|map
comma
id|addr
)paren
op_amp
id|D6_MASK
)paren
op_ne
(paren
id|wide_read
c_func
(paren
id|map
comma
id|addr
)paren
op_amp
id|D6_MASK
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Reads JEDEC manufacturer ID and device ID and returns the index of the first&n; * matching table entry (-1 if not found or alias for already found chip).&n; */
DECL|function|probe_new_chip
r_static
r_int
id|probe_new_chip
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|__u32
id|base
comma
r_struct
id|flchip
op_star
id|chips
comma
r_struct
id|amd_flash_private
op_star
r_private
comma
r_const
r_struct
id|amd_flash_info
op_star
id|table
comma
r_int
id|table_size
)paren
(brace
id|__u32
id|mfr_id
comma
id|dev_id
suffix:semicolon
r_struct
id|map_info
op_star
id|map
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|amd_flash_private
id|temp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|temp.device_type
op_assign
id|DEVICE_TYPE_X16
suffix:semicolon
singleline_comment|// Assume X16 (FIXME)
id|temp.interleave
op_assign
l_int|2
suffix:semicolon
id|map-&gt;fldrv_priv
op_assign
op_amp
id|temp
suffix:semicolon
multiline_comment|/* Enter autoselect mode. */
id|send_cmd
c_func
(paren
id|map
comma
id|base
comma
id|CMD_RESET_DATA
)paren
suffix:semicolon
id|send_cmd
c_func
(paren
id|map
comma
id|base
comma
id|CMD_MANUFACTURER_UNLOCK_DATA
)paren
suffix:semicolon
id|mfr_id
op_assign
id|wide_read
c_func
(paren
id|map
comma
id|base
op_plus
(paren
id|map-&gt;buswidth
op_star
id|ADDR_MANUFACTURER
)paren
)paren
suffix:semicolon
id|dev_id
op_assign
id|wide_read
c_func
(paren
id|map
comma
id|base
op_plus
(paren
id|map-&gt;buswidth
op_star
id|ADDR_DEVICE_ID
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|map-&gt;buswidth
op_eq
l_int|4
)paren
op_logical_and
(paren
(paren
id|mfr_id
op_rshift
l_int|16
)paren
op_eq
(paren
id|mfr_id
op_amp
l_int|0xffff
)paren
)paren
op_logical_and
(paren
(paren
id|dev_id
op_rshift
l_int|16
)paren
op_eq
(paren
id|dev_id
op_amp
l_int|0xffff
)paren
)paren
)paren
(brace
id|mfr_id
op_assign
id|mfr_id
op_amp
l_int|0xffff
suffix:semicolon
id|dev_id
op_assign
id|dev_id
op_amp
l_int|0xffff
suffix:semicolon
)brace
r_else
(brace
id|temp.interleave
op_assign
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|table_size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|mfr_id
op_eq
id|table
(braket
id|i
)braket
dot
id|mfr_id
)paren
op_logical_and
(paren
id|dev_id
op_eq
id|table
(braket
id|i
)braket
dot
id|dev_id
)paren
)paren
(brace
r_if
c_cond
(paren
id|chips
)paren
(brace
r_int
id|j
suffix:semicolon
multiline_comment|/* Is this an alias for an already found chip?&n;&t;&t;&t;&t; * In that case that chip should be in&n;&t;&t;&t;&t; * autoselect mode now.&n;&t;&t;&t;&t; */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
r_private
op_member_access_from_pointer
id|numchips
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|wide_read
c_func
(paren
id|map
comma
id|chips
(braket
id|j
)braket
dot
id|start
op_plus
(paren
id|map-&gt;buswidth
op_star
id|ADDR_MANUFACTURER
)paren
)paren
op_eq
id|mfr_id
)paren
op_logical_and
(paren
id|wide_read
c_func
(paren
id|map
comma
id|chips
(braket
id|j
)braket
dot
id|start
op_plus
(paren
id|map-&gt;buswidth
op_star
id|ADDR_DEVICE_ID
)paren
)paren
op_eq
id|dev_id
)paren
)paren
(brace
multiline_comment|/* Exit autoselect mode. */
id|send_cmd
c_func
(paren
id|map
comma
id|base
comma
id|CMD_RESET_DATA
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|numchips
op_eq
id|MAX_AMD_CHIPS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too many flash chips &quot;
l_string|&quot;detected. Increase &quot;
l_string|&quot;MAX_AMD_CHIPS from %d.&bslash;n&quot;
comma
id|map-&gt;name
comma
id|MAX_AMD_CHIPS
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|chips
(braket
r_private
op_member_access_from_pointer
id|numchips
)braket
dot
id|start
op_assign
id|base
suffix:semicolon
id|chips
(braket
r_private
op_member_access_from_pointer
id|numchips
)braket
dot
id|state
op_assign
id|FL_READY
suffix:semicolon
id|chips
(braket
r_private
op_member_access_from_pointer
id|numchips
)braket
dot
id|mutex
op_assign
op_amp
id|chips
(braket
r_private
op_member_access_from_pointer
id|numchips
)braket
dot
id|_spinlock
suffix:semicolon
r_private
op_member_access_from_pointer
id|numchips
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: Found %d x %ldMiB %s at 0x%x&bslash;n&quot;
comma
id|map-&gt;name
comma
id|temp.interleave
comma
(paren
id|table
(braket
id|i
)braket
dot
id|size
)paren
op_div
(paren
l_int|1024
op_star
l_int|1024
)paren
comma
id|table
(braket
id|i
)braket
dot
id|name
comma
id|base
)paren
suffix:semicolon
id|mtd-&gt;size
op_add_assign
id|table
(braket
id|i
)braket
dot
id|size
op_star
id|temp.interleave
suffix:semicolon
id|mtd-&gt;numeraseregions
op_add_assign
id|table
(braket
id|i
)braket
dot
id|numeraseregions
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Exit autoselect mode. */
id|send_cmd
c_func
(paren
id|map
comma
id|base
comma
id|CMD_RESET_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|table_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: unknown flash device at 0x%x, &quot;
l_string|&quot;mfr id 0x%x, dev id 0x%x&bslash;n&quot;
comma
id|map-&gt;name
comma
id|base
comma
id|mfr_id
comma
id|dev_id
)paren
suffix:semicolon
id|map-&gt;fldrv_priv
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_private
op_member_access_from_pointer
id|device_type
op_assign
id|temp.device_type
suffix:semicolon
r_private
op_member_access_from_pointer
id|interleave
op_assign
id|temp.interleave
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|amd_flash_probe
r_static
r_struct
id|mtd_info
op_star
id|amd_flash_probe
c_func
(paren
r_struct
id|map_info
op_star
id|map
)paren
(brace
multiline_comment|/* Keep this table on the stack so that it gets deallocated after the&n;&t; * probe is done.&n;&t; */
r_const
r_struct
id|amd_flash_info
id|table
(braket
)braket
op_assign
(brace
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29LV160DT
comma
id|name
suffix:colon
l_string|&quot;AMD AM29LV160DT&quot;
comma
id|size
suffix:colon
l_int|0x00200000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|31
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1F0000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1F8000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1FC000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29LV160DB
comma
id|name
suffix:colon
l_string|&quot;AMD AM29LV160DB&quot;
comma
id|size
suffix:colon
l_int|0x00200000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x004000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x008000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x010000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|31
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_TOSHIBA
comma
id|dev_id
suffix:colon
id|TC58FVT160
comma
id|name
suffix:colon
l_string|&quot;Toshiba TC58FVT160&quot;
comma
id|size
suffix:colon
l_int|0x00200000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|31
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1F0000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1F8000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1FC000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_FUJITSU
comma
id|dev_id
suffix:colon
id|MBM29LV160TE
comma
id|name
suffix:colon
l_string|&quot;Fujitsu MBM29LV160TE&quot;
comma
id|size
suffix:colon
l_int|0x00200000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|31
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1F0000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1F8000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1FC000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_TOSHIBA
comma
id|dev_id
suffix:colon
id|TC58FVB160
comma
id|name
suffix:colon
l_string|&quot;Toshiba TC58FVB160&quot;
comma
id|size
suffix:colon
l_int|0x00200000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x004000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x008000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x010000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|31
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_FUJITSU
comma
id|dev_id
suffix:colon
id|MBM29LV160BE
comma
id|name
suffix:colon
l_string|&quot;Fujitsu MBM29LV160BE&quot;
comma
id|size
suffix:colon
l_int|0x00200000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x004000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x008000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x010000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|31
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29LV800BB
comma
id|name
suffix:colon
l_string|&quot;AMD AM29LV800BB&quot;
comma
id|size
suffix:colon
l_int|0x00100000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x004000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x008000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x010000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|15
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29F800BB
comma
id|name
suffix:colon
l_string|&quot;AMD AM29F800BB&quot;
comma
id|size
suffix:colon
l_int|0x00100000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x004000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x008000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x010000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|15
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29LV800BT
comma
id|name
suffix:colon
l_string|&quot;AMD AM29LV800BT&quot;
comma
id|size
suffix:colon
l_int|0x00100000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|15
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0F0000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0F8000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0FC000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29F800BT
comma
id|name
suffix:colon
l_string|&quot;AMD AM29F800BT&quot;
comma
id|size
suffix:colon
l_int|0x00100000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|15
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0F0000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0F8000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0FC000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29LV800BB
comma
id|name
suffix:colon
l_string|&quot;AMD AM29LV800BB&quot;
comma
id|size
suffix:colon
l_int|0x00100000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|15
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0F0000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0F8000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0FC000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_ST
comma
id|dev_id
suffix:colon
id|M29W800T
comma
id|name
suffix:colon
l_string|&quot;ST M29W800T&quot;
comma
id|size
suffix:colon
l_int|0x00100000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|15
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0F0000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0F8000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x0FC000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_ST
comma
id|dev_id
suffix:colon
id|M29W160DT
comma
id|name
suffix:colon
l_string|&quot;ST M29W160DT&quot;
comma
id|size
suffix:colon
l_int|0x00200000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|31
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1F0000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1F8000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x1FC000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_ST
comma
id|dev_id
suffix:colon
id|M29W160DB
comma
id|name
suffix:colon
l_string|&quot;ST M29W160DB&quot;
comma
id|size
suffix:colon
l_int|0x00200000
comma
id|numeraseregions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
(brace
id|offset
suffix:colon
l_int|0x000000
comma
id|erasesize
suffix:colon
l_int|0x04000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x004000
comma
id|erasesize
suffix:colon
l_int|0x02000
comma
id|numblocks
suffix:colon
l_int|2
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x008000
comma
id|erasesize
suffix:colon
l_int|0x08000
comma
id|numblocks
suffix:colon
l_int|1
)brace
comma
(brace
id|offset
suffix:colon
l_int|0x010000
comma
id|erasesize
suffix:colon
l_int|0x10000
comma
id|numblocks
suffix:colon
l_int|31
)brace
)brace
)brace
)brace
suffix:semicolon
r_struct
id|mtd_info
op_star
id|mtd
suffix:semicolon
r_struct
id|flchip
id|chips
(braket
id|MAX_AMD_CHIPS
)braket
suffix:semicolon
r_int
id|table_pos
(braket
id|MAX_AMD_CHIPS
)braket
suffix:semicolon
r_struct
id|amd_flash_private
id|temp
suffix:semicolon
r_struct
id|amd_flash_private
op_star
r_private
suffix:semicolon
id|u_long
id|size
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|reg_idx
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|mtd
op_assign
(paren
r_struct
id|mtd_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mtd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mtd
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: kmalloc failed for info structure&bslash;n&quot;
comma
id|map-&gt;name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mtd
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mtd
)paren
)paren
suffix:semicolon
id|mtd-&gt;priv
op_assign
id|map
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|temp
comma
l_int|0
comma
r_sizeof
(paren
id|temp
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Probing for AMD compatible flash...&bslash;n&quot;
comma
id|map-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|table_pos
(braket
l_int|0
)braket
op_assign
id|probe_new_chip
c_func
(paren
id|mtd
comma
l_int|0
comma
l_int|NULL
comma
op_amp
id|temp
comma
id|table
comma
r_sizeof
(paren
id|table
)paren
op_div
r_sizeof
(paren
id|table
(braket
l_int|0
)braket
)paren
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Found no AMD compatible device at location zero&bslash;n&quot;
comma
id|map-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mtd
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|chips
(braket
l_int|0
)braket
dot
id|start
op_assign
l_int|0
suffix:semicolon
id|chips
(braket
l_int|0
)braket
dot
id|state
op_assign
id|FL_READY
suffix:semicolon
id|chips
(braket
l_int|0
)braket
dot
id|mutex
op_assign
op_amp
id|chips
(braket
l_int|0
)braket
dot
id|_spinlock
suffix:semicolon
id|temp.numchips
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|size
op_assign
id|mtd-&gt;size
suffix:semicolon
id|size
OG
l_int|1
suffix:semicolon
id|size
op_rshift_assign
l_int|1
)paren
(brace
id|temp.chipshift
op_increment
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|temp.interleave
)paren
(brace
r_case
l_int|2
suffix:colon
id|temp.chipshift
op_add_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|temp.chipshift
op_add_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Find out if there are any more chips in the map. */
r_for
c_loop
(paren
id|base
op_assign
(paren
l_int|1
op_lshift
id|temp.chipshift
)paren
suffix:semicolon
id|base
OL
id|map-&gt;size
suffix:semicolon
id|base
op_add_assign
(paren
l_int|1
op_lshift
id|temp.chipshift
)paren
)paren
(brace
r_int
id|numchips
op_assign
id|temp.numchips
suffix:semicolon
id|table_pos
(braket
id|numchips
)braket
op_assign
id|probe_new_chip
c_func
(paren
id|mtd
comma
id|base
comma
id|chips
comma
op_amp
id|temp
comma
id|table
comma
r_sizeof
(paren
id|table
)paren
op_div
r_sizeof
(paren
id|table
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
id|mtd-&gt;eraseregions
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mtd_erase_region_info
)paren
op_star
id|mtd-&gt;numeraseregions
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mtd-&gt;eraseregions
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Failed to allocate &quot;
l_string|&quot;memory for MTD erase region info&bslash;n&quot;
comma
id|map-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mtd
)paren
suffix:semicolon
id|map-&gt;fldrv_priv
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|reg_idx
op_assign
l_int|0
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|temp.numchips
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|dev_size
suffix:semicolon
r_int
id|j
suffix:semicolon
id|dev_size
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|table
(braket
id|table_pos
(braket
id|i
)braket
)braket
dot
id|numeraseregions
suffix:semicolon
id|j
op_increment
)paren
(brace
id|mtd-&gt;eraseregions
(braket
id|reg_idx
)braket
dot
id|offset
op_assign
id|offset
op_plus
(paren
id|table
(braket
id|table_pos
(braket
id|i
)braket
)braket
dot
id|regions
(braket
id|j
)braket
dot
id|offset
op_star
id|temp.interleave
)paren
suffix:semicolon
id|mtd-&gt;eraseregions
(braket
id|reg_idx
)braket
dot
id|erasesize
op_assign
id|table
(braket
id|table_pos
(braket
id|i
)braket
)braket
dot
id|regions
(braket
id|j
)braket
dot
id|erasesize
op_star
id|temp.interleave
suffix:semicolon
id|mtd-&gt;eraseregions
(braket
id|reg_idx
)braket
dot
id|numblocks
op_assign
id|table
(braket
id|table_pos
(braket
id|i
)braket
)braket
dot
id|regions
(braket
id|j
)braket
dot
id|numblocks
suffix:semicolon
r_if
c_cond
(paren
id|mtd-&gt;erasesize
OL
id|mtd-&gt;eraseregions
(braket
id|reg_idx
)braket
dot
id|erasesize
)paren
(brace
id|mtd-&gt;erasesize
op_assign
id|mtd-&gt;eraseregions
(braket
id|reg_idx
)braket
dot
id|erasesize
suffix:semicolon
)brace
id|dev_size
op_add_assign
id|mtd-&gt;eraseregions
(braket
id|reg_idx
)braket
dot
id|erasesize
op_star
id|mtd-&gt;eraseregions
(braket
id|reg_idx
)braket
dot
id|numblocks
suffix:semicolon
id|reg_idx
op_increment
suffix:semicolon
)brace
id|offset
op_add_assign
id|dev_size
suffix:semicolon
)brace
id|mtd-&gt;type
op_assign
id|MTD_NORFLASH
suffix:semicolon
id|mtd-&gt;flags
op_assign
id|MTD_CAP_NORFLASH
suffix:semicolon
id|mtd-&gt;name
op_assign
id|map-&gt;name
suffix:semicolon
id|mtd-&gt;erase
op_assign
id|amd_flash_erase
suffix:semicolon
id|mtd-&gt;read
op_assign
id|amd_flash_read
suffix:semicolon
id|mtd-&gt;write
op_assign
id|amd_flash_write
suffix:semicolon
id|mtd-&gt;sync
op_assign
id|amd_flash_sync
suffix:semicolon
id|mtd-&gt;suspend
op_assign
id|amd_flash_suspend
suffix:semicolon
id|mtd-&gt;resume
op_assign
id|amd_flash_resume
suffix:semicolon
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
r_private
)paren
op_plus
(paren
r_sizeof
(paren
r_struct
id|flchip
)paren
op_star
id|temp.numchips
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_private
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: kmalloc failed for private structure&bslash;n&quot;
comma
id|map-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mtd
)paren
suffix:semicolon
id|map-&gt;fldrv_priv
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memcpy
c_func
(paren
r_private
comma
op_amp
id|temp
comma
r_sizeof
(paren
id|temp
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
r_private
op_member_access_from_pointer
id|chips
comma
id|chips
comma
r_sizeof
(paren
r_struct
id|flchip
)paren
op_star
r_private
op_member_access_from_pointer
id|numchips
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_private
op_member_access_from_pointer
id|numchips
suffix:semicolon
id|i
op_increment
)paren
(brace
id|init_waitqueue_head
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|chips
(braket
id|i
)braket
dot
id|wq
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|chips
(braket
id|i
)braket
dot
id|_spinlock
)paren
suffix:semicolon
)brace
id|map-&gt;fldrv_priv
op_assign
r_private
suffix:semicolon
id|map-&gt;fldrv
op_assign
op_amp
id|amd_flash_chipdrv
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
id|mtd
suffix:semicolon
)brace
DECL|function|read_one_chip
r_static
r_inline
r_int
id|read_one_chip
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|flchip
op_star
id|chip
comma
id|loff_t
id|adr
comma
r_int
id|len
comma
id|u_char
op_star
id|buf
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|timeo
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|retry
suffix:colon
id|spin_lock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;state
op_ne
id|FL_READY
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: waiting for chip to read, state = %d&bslash;n&quot;
comma
id|map-&gt;name
comma
id|chip-&gt;state
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|timeo
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
id|adr
op_add_assign
id|chip-&gt;start
suffix:semicolon
id|chip-&gt;state
op_assign
id|FL_READY
suffix:semicolon
id|map
op_member_access_from_pointer
id|copy_from
c_func
(paren
id|map
comma
id|buf
comma
id|adr
comma
id|len
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|chip-&gt;wq
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd_flash_read
r_static
r_int
id|amd_flash_read
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
(brace
r_struct
id|map_info
op_star
id|map
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|amd_flash_private
op_star
r_private
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
r_int
r_int
id|ofs
suffix:semicolon
r_int
id|chipnum
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|from
op_plus
id|len
)paren
OG
id|mtd-&gt;size
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: read request past end of device &quot;
l_string|&quot;(0x%lx)&bslash;n&quot;
comma
id|map-&gt;name
comma
(paren
r_int
r_int
)paren
id|from
op_plus
id|len
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Offset within the first chip that the first read should start. */
id|chipnum
op_assign
(paren
id|from
op_rshift
r_private
op_member_access_from_pointer
id|chipshift
)paren
suffix:semicolon
id|ofs
op_assign
id|from
op_minus
(paren
id|chipnum
op_lshift
r_private
op_member_access_from_pointer
id|chipshift
)paren
suffix:semicolon
op_star
id|retlen
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
r_int
r_int
id|this_len
suffix:semicolon
r_if
c_cond
(paren
id|chipnum
op_ge
r_private
op_member_access_from_pointer
id|numchips
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|len
op_plus
id|ofs
op_minus
l_int|1
)paren
op_rshift
r_private
op_member_access_from_pointer
id|chipshift
)paren
(brace
id|this_len
op_assign
(paren
l_int|1
op_lshift
r_private
op_member_access_from_pointer
id|chipshift
)paren
op_minus
id|ofs
suffix:semicolon
)brace
r_else
(brace
id|this_len
op_assign
id|len
suffix:semicolon
)brace
id|ret
op_assign
id|read_one_chip
c_func
(paren
id|map
comma
op_amp
r_private
op_member_access_from_pointer
id|chips
(braket
id|chipnum
)braket
comma
id|ofs
comma
id|this_len
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_break
suffix:semicolon
)brace
op_star
id|retlen
op_add_assign
id|this_len
suffix:semicolon
id|len
op_sub_assign
id|this_len
suffix:semicolon
id|buf
op_add_assign
id|this_len
suffix:semicolon
id|ofs
op_assign
l_int|0
suffix:semicolon
id|chipnum
op_increment
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|write_one_word
r_static
r_int
id|write_one_word
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|flchip
op_star
id|chip
comma
r_int
r_int
id|adr
comma
id|__u32
id|datum
)paren
(brace
r_int
r_int
id|timeo
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_struct
id|amd_flash_private
op_star
r_private
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|times_left
suffix:semicolon
id|retry
suffix:colon
id|spin_lock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;state
op_ne
id|FL_READY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: waiting for chip to write, state = %d&bslash;n&quot;
comma
id|map-&gt;name
comma
id|chip-&gt;state
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: woke up to write&bslash;n&quot;
comma
id|map-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|timeo
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
id|chip-&gt;state
op_assign
id|FL_WRITING
suffix:semicolon
id|adr
op_add_assign
id|chip-&gt;start
suffix:semicolon
id|ENABLE_VPP
c_func
(paren
id|map
)paren
suffix:semicolon
id|send_cmd
c_func
(paren
id|map
comma
id|chip-&gt;start
comma
id|CMD_PROGRAM_UNLOCK_DATA
)paren
suffix:semicolon
id|wide_write
c_func
(paren
id|map
comma
id|datum
comma
id|adr
)paren
suffix:semicolon
id|times_left
op_assign
l_int|500000
suffix:semicolon
r_while
c_loop
(paren
id|times_left
op_decrement
op_logical_and
id|flash_is_busy
c_func
(paren
id|map
comma
id|chip-&gt;start
comma
r_private
op_member_access_from_pointer
id|interleave
)paren
)paren
(brace
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
(brace
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|times_left
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: write to 0x%lx timed out!&bslash;n&quot;
comma
id|map-&gt;name
comma
id|adr
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
(brace
id|__u32
id|verify
suffix:semicolon
r_if
c_cond
(paren
(paren
id|verify
op_assign
id|wide_read
c_func
(paren
id|map
comma
id|adr
)paren
)paren
op_ne
id|datum
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: write to 0x%lx failed. &quot;
l_string|&quot;datum = %x, verify = %x&bslash;n&quot;
comma
id|map-&gt;name
comma
id|adr
comma
id|datum
comma
id|verify
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|DISABLE_VPP
c_func
(paren
id|map
)paren
suffix:semicolon
id|chip-&gt;state
op_assign
id|FL_READY
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|chip-&gt;wq
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|amd_flash_write
r_static
r_int
id|amd_flash_write
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
(brace
r_struct
id|map_info
op_star
id|map
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|amd_flash_private
op_star
r_private
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|chipnum
suffix:semicolon
r_int
r_int
id|ofs
suffix:semicolon
r_int
r_int
id|chipstart
suffix:semicolon
op_star
id|retlen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|chipnum
op_assign
id|to
op_rshift
r_private
op_member_access_from_pointer
id|chipshift
suffix:semicolon
id|ofs
op_assign
id|to
op_minus
(paren
id|chipnum
op_lshift
r_private
op_member_access_from_pointer
id|chipshift
)paren
suffix:semicolon
id|chipstart
op_assign
r_private
op_member_access_from_pointer
id|chips
(braket
id|chipnum
)braket
dot
id|start
suffix:semicolon
multiline_comment|/* If it&squot;s not bus-aligned, do the first byte write. */
r_if
c_cond
(paren
id|ofs
op_amp
(paren
id|map-&gt;buswidth
op_minus
l_int|1
)paren
)paren
(brace
r_int
r_int
id|bus_ofs
op_assign
id|ofs
op_amp
op_complement
(paren
id|map-&gt;buswidth
op_minus
l_int|1
)paren
suffix:semicolon
r_int
id|i
op_assign
id|ofs
op_minus
id|bus_ofs
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
id|u_char
id|tmp_buf
(braket
l_int|4
)braket
suffix:semicolon
id|__u32
id|datum
suffix:semicolon
id|map
op_member_access_from_pointer
id|copy_from
c_func
(paren
id|map
comma
id|tmp_buf
comma
id|bus_ofs
op_plus
r_private
op_member_access_from_pointer
id|chips
(braket
id|chipnum
)braket
dot
id|start
comma
id|map-&gt;buswidth
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_logical_and
id|i
OL
id|map-&gt;buswidth
)paren
id|tmp_buf
(braket
id|i
op_increment
)braket
op_assign
id|buf
(braket
id|n
op_increment
)braket
comma
id|len
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|2
)paren
(brace
id|datum
op_assign
op_star
(paren
id|__u16
op_star
)paren
id|tmp_buf
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|4
)paren
(brace
id|datum
op_assign
op_star
(paren
id|__u32
op_star
)paren
id|tmp_buf
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* should never happen, but be safe */
)brace
id|ret
op_assign
id|write_one_word
c_func
(paren
id|map
comma
op_amp
r_private
op_member_access_from_pointer
id|chips
(braket
id|chipnum
)braket
comma
id|bus_ofs
comma
id|datum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|ofs
op_add_assign
id|n
suffix:semicolon
id|buf
op_add_assign
id|n
suffix:semicolon
(paren
op_star
id|retlen
)paren
op_add_assign
id|n
suffix:semicolon
r_if
c_cond
(paren
id|ofs
op_rshift
r_private
op_member_access_from_pointer
id|chipshift
)paren
(brace
id|chipnum
op_increment
suffix:semicolon
id|ofs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|chipnum
op_eq
r_private
op_member_access_from_pointer
id|numchips
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* We are now aligned, write as much as possible. */
r_while
c_loop
(paren
id|len
op_ge
id|map-&gt;buswidth
)paren
(brace
id|__u32
id|datum
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|1
)paren
(brace
id|datum
op_assign
op_star
(paren
id|__u8
op_star
)paren
id|buf
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|2
)paren
(brace
id|datum
op_assign
op_star
(paren
id|__u16
op_star
)paren
id|buf
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|4
)paren
(brace
id|datum
op_assign
op_star
(paren
id|__u32
op_star
)paren
id|buf
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ret
op_assign
id|write_one_word
c_func
(paren
id|map
comma
op_amp
r_private
op_member_access_from_pointer
id|chips
(braket
id|chipnum
)braket
comma
id|ofs
comma
id|datum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|ofs
op_add_assign
id|map-&gt;buswidth
suffix:semicolon
id|buf
op_add_assign
id|map-&gt;buswidth
suffix:semicolon
(paren
op_star
id|retlen
)paren
op_add_assign
id|map-&gt;buswidth
suffix:semicolon
id|len
op_sub_assign
id|map-&gt;buswidth
suffix:semicolon
r_if
c_cond
(paren
id|ofs
op_rshift
r_private
op_member_access_from_pointer
id|chipshift
)paren
(brace
id|chipnum
op_increment
suffix:semicolon
id|ofs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|chipnum
op_eq
r_private
op_member_access_from_pointer
id|numchips
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|chipstart
op_assign
r_private
op_member_access_from_pointer
id|chips
(braket
id|chipnum
)braket
dot
id|start
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|len
op_amp
(paren
id|map-&gt;buswidth
op_minus
l_int|1
)paren
)paren
(brace
r_int
id|i
op_assign
l_int|0
comma
id|n
op_assign
l_int|0
suffix:semicolon
id|u_char
id|tmp_buf
(braket
l_int|2
)braket
suffix:semicolon
id|__u32
id|datum
suffix:semicolon
id|map
op_member_access_from_pointer
id|copy_from
c_func
(paren
id|map
comma
id|tmp_buf
comma
id|ofs
op_plus
r_private
op_member_access_from_pointer
id|chips
(braket
id|chipnum
)braket
dot
id|start
comma
id|map-&gt;buswidth
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|tmp_buf
(braket
id|i
op_increment
)braket
op_assign
id|buf
(braket
id|n
op_increment
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|2
)paren
(brace
id|datum
op_assign
op_star
(paren
id|__u16
op_star
)paren
id|tmp_buf
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|map-&gt;buswidth
op_eq
l_int|4
)paren
(brace
id|datum
op_assign
op_star
(paren
id|__u32
op_star
)paren
id|tmp_buf
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* should never happen, but be safe */
)brace
id|ret
op_assign
id|write_one_word
c_func
(paren
id|map
comma
op_amp
r_private
op_member_access_from_pointer
id|chips
(braket
id|chipnum
)braket
comma
id|ofs
comma
id|datum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
(paren
op_star
id|retlen
)paren
op_add_assign
id|n
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|erase_one_block
r_static
r_inline
r_int
id|erase_one_block
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|flchip
op_star
id|chip
comma
r_int
r_int
id|adr
comma
id|u_long
id|size
)paren
(brace
r_int
r_int
id|timeo
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_struct
id|amd_flash_private
op_star
r_private
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|retry
suffix:colon
id|spin_lock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;state
op_ne
id|FL_READY
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|timeo
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
id|chip-&gt;state
op_assign
id|FL_ERASING
suffix:semicolon
id|adr
op_add_assign
id|chip-&gt;start
suffix:semicolon
id|ENABLE_VPP
c_func
(paren
id|map
)paren
suffix:semicolon
id|send_cmd
c_func
(paren
id|map
comma
id|chip-&gt;start
comma
id|CMD_SECTOR_ERASE_UNLOCK_DATA
)paren
suffix:semicolon
id|send_cmd_to_addr
c_func
(paren
id|map
comma
id|chip-&gt;start
comma
id|CMD_SECTOR_ERASE_UNLOCK_DATA_2
comma
id|adr
)paren
suffix:semicolon
id|timeo
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
l_int|20
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_while
c_loop
(paren
id|flash_is_busy
c_func
(paren
id|map
comma
id|chip-&gt;start
comma
r_private
op_member_access_from_pointer
id|interleave
)paren
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;state
op_ne
id|FL_ERASING
)paren
(brace
multiline_comment|/* Someone&squot;s suspended the erase. Sleep */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: erase suspended. Sleeping&bslash;n&quot;
comma
id|map-&gt;name
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|timeo
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
l_int|2
)paren
suffix:semicolon
multiline_comment|/* FIXME */
id|spin_lock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* OK Still waiting */
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeo
)paren
)paren
(brace
id|chip-&gt;state
op_assign
id|FL_READY
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: waiting for erase to complete &quot;
l_string|&quot;timed out.&bslash;n&quot;
comma
id|map-&gt;name
)paren
suffix:semicolon
id|DISABLE_VPP
c_func
(paren
id|map
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Latency issues. Drop the lock, wait a while and retry */
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_else
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
)brace
multiline_comment|/* Verify every single word */
(brace
r_int
id|address
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|__u8
id|verify
suffix:semicolon
r_for
c_loop
(paren
id|address
op_assign
id|adr
suffix:semicolon
id|address
OL
(paren
id|adr
op_plus
id|size
)paren
suffix:semicolon
id|address
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|verify
op_assign
id|map
op_member_access_from_pointer
id|read8
c_func
(paren
id|map
comma
id|address
)paren
)paren
op_ne
l_int|0xFF
)paren
(brace
id|error
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|error
)paren
(brace
id|chip-&gt;state
op_assign
id|FL_READY
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: verify error at 0x%x, size %ld.&bslash;n&quot;
comma
id|map-&gt;name
comma
id|address
comma
id|size
)paren
suffix:semicolon
id|DISABLE_VPP
c_func
(paren
id|map
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|DISABLE_VPP
c_func
(paren
id|map
)paren
suffix:semicolon
id|chip-&gt;state
op_assign
id|FL_READY
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|chip-&gt;wq
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd_flash_erase
r_static
r_int
id|amd_flash_erase
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_struct
id|erase_info
op_star
id|instr
)paren
(brace
r_struct
id|map_info
op_star
id|map
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|amd_flash_private
op_star
r_private
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
r_int
r_int
id|adr
comma
id|len
suffix:semicolon
r_int
id|chipnum
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|first
suffix:semicolon
r_struct
id|mtd_erase_region_info
op_star
id|regions
op_assign
id|mtd-&gt;eraseregions
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;addr
OG
id|mtd-&gt;size
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|instr-&gt;len
op_plus
id|instr-&gt;addr
)paren
OG
id|mtd-&gt;size
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Check that both start and end of the requested erase are&n;&t; * aligned with the erasesize at the appropriate addresses.&n;&t; */
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Skip all erase regions which are ended before the start of&n;           the requested erase. Actually, to save on the calculations,&n;           we skip to the first erase region which starts after the&n;           start of the requested erase, and then go back one.&n;        */
r_while
c_loop
(paren
(paren
id|i
OL
id|mtd-&gt;numeraseregions
)paren
op_logical_and
(paren
id|instr-&gt;addr
op_ge
id|regions
(braket
id|i
)braket
dot
id|offset
)paren
)paren
(brace
id|i
op_increment
suffix:semicolon
)brace
id|i
op_decrement
suffix:semicolon
multiline_comment|/* OK, now i is pointing at the erase region in which this&n;&t; * erase request starts. Check the start of the requested&n;&t; * erase range is aligned with the erase size which is in&n;&t; * effect here.&n;&t; */
r_if
c_cond
(paren
id|instr-&gt;addr
op_amp
(paren
id|regions
(braket
id|i
)braket
dot
id|erasesize
op_minus
l_int|1
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Remember the erase region we start on. */
id|first
op_assign
id|i
suffix:semicolon
multiline_comment|/* Next, check that the end of the requested erase is aligned&n;&t; * with the erase region at that address.&n;&t; */
r_while
c_loop
(paren
(paren
id|i
OL
id|mtd-&gt;numeraseregions
)paren
op_logical_and
(paren
(paren
id|instr-&gt;addr
op_plus
id|instr-&gt;len
)paren
op_ge
id|regions
(braket
id|i
)braket
dot
id|offset
)paren
)paren
(brace
id|i
op_increment
suffix:semicolon
)brace
multiline_comment|/* As before, drop back one to point at the region in which&n;&t; * the address actually falls.&n;&t; */
id|i
op_decrement
suffix:semicolon
r_if
c_cond
(paren
(paren
id|instr-&gt;addr
op_plus
id|instr-&gt;len
)paren
op_amp
(paren
id|regions
(braket
id|i
)braket
dot
id|erasesize
op_minus
l_int|1
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|chipnum
op_assign
id|instr-&gt;addr
op_rshift
r_private
op_member_access_from_pointer
id|chipshift
suffix:semicolon
id|adr
op_assign
id|instr-&gt;addr
op_minus
(paren
id|chipnum
op_lshift
r_private
op_member_access_from_pointer
id|chipshift
)paren
suffix:semicolon
id|len
op_assign
id|instr-&gt;len
suffix:semicolon
id|i
op_assign
id|first
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
id|ret
op_assign
id|erase_one_block
c_func
(paren
id|map
comma
op_amp
r_private
op_member_access_from_pointer
id|chips
(braket
id|chipnum
)braket
comma
id|adr
comma
id|regions
(braket
id|i
)braket
dot
id|erasesize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|adr
op_add_assign
id|regions
(braket
id|i
)braket
dot
id|erasesize
suffix:semicolon
id|len
op_sub_assign
id|regions
(braket
id|i
)braket
dot
id|erasesize
suffix:semicolon
r_if
c_cond
(paren
(paren
id|adr
op_mod
(paren
l_int|1
op_lshift
r_private
op_member_access_from_pointer
id|chipshift
)paren
)paren
op_eq
(paren
(paren
id|regions
(braket
id|i
)braket
dot
id|offset
op_plus
(paren
id|regions
(braket
id|i
)braket
dot
id|erasesize
op_star
id|regions
(braket
id|i
)braket
dot
id|numblocks
)paren
)paren
op_mod
(paren
l_int|1
op_lshift
r_private
op_member_access_from_pointer
id|chipshift
)paren
)paren
)paren
(brace
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adr
op_rshift
r_private
op_member_access_from_pointer
id|chipshift
)paren
(brace
id|adr
op_assign
l_int|0
suffix:semicolon
id|chipnum
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|chipnum
op_ge
r_private
op_member_access_from_pointer
id|numchips
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
id|instr-&gt;state
op_assign
id|MTD_ERASE_DONE
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;callback
)paren
(brace
id|instr
op_member_access_from_pointer
id|callback
c_func
(paren
id|instr
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd_flash_sync
r_static
r_void
id|amd_flash_sync
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
r_struct
id|map_info
op_star
id|map
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|amd_flash_private
op_star
r_private
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|flchip
op_star
id|chip
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|ret
op_logical_and
(paren
id|i
OL
r_private
op_member_access_from_pointer
id|numchips
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|chip
op_assign
op_amp
r_private
op_member_access_from_pointer
id|chips
(braket
id|i
)braket
suffix:semicolon
id|retry
suffix:colon
id|spin_lock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|chip-&gt;state
)paren
(brace
r_case
id|FL_READY
suffix:colon
r_case
id|FL_STATUS
suffix:colon
r_case
id|FL_CFI_QUERY
suffix:colon
r_case
id|FL_JEDEC_QUERY
suffix:colon
id|chip-&gt;oldstate
op_assign
id|chip-&gt;state
suffix:semicolon
id|chip-&gt;state
op_assign
id|FL_SYNCING
suffix:semicolon
multiline_comment|/* No need to wake_up() on this state change - &n;&t;&t;&t; * as the whole point is that nobody can do anything&n;&t;&t;&t; * with the chip now anyway.&n;&t;&t;&t; */
r_case
id|FL_SYNCING
suffix:colon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Not an idle state */
id|add_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|chip-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
)brace
multiline_comment|/* Unlock the chips again */
r_for
c_loop
(paren
id|i
op_decrement
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|chip
op_assign
op_amp
r_private
op_member_access_from_pointer
id|chips
(braket
id|i
)braket
suffix:semicolon
id|spin_lock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;state
op_eq
id|FL_SYNCING
)paren
(brace
id|chip-&gt;state
op_assign
id|chip-&gt;oldstate
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|chip-&gt;wq
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
id|chip-&gt;mutex
)paren
suffix:semicolon
)brace
)brace
DECL|function|amd_flash_suspend
r_static
r_int
id|amd_flash_suspend
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;amd_flash_suspend(): not implemented!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|amd_flash_resume
r_static
r_void
id|amd_flash_resume
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;amd_flash_resume(): not implemented!&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|amd_flash_destroy
r_static
r_void
id|amd_flash_destroy
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
r_struct
id|map_info
op_star
id|map
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|amd_flash_private
op_star
r_private
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
id|kfree
c_func
(paren
r_private
)paren
suffix:semicolon
)brace
DECL|function|amd_flash_init
r_int
id|__init
id|amd_flash_init
c_func
(paren
r_void
)paren
(brace
id|register_mtd_chip_driver
c_func
(paren
op_amp
id|amd_flash_chipdrv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd_flash_exit
r_void
id|__exit
id|amd_flash_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_mtd_chip_driver
c_func
(paren
op_amp
id|amd_flash_chipdrv
)paren
suffix:semicolon
)brace
DECL|variable|amd_flash_init
id|module_init
c_func
(paren
id|amd_flash_init
)paren
suffix:semicolon
DECL|variable|amd_flash_exit
id|module_exit
c_func
(paren
id|amd_flash_exit
)paren
suffix:semicolon
eof
