multiline_comment|/*&n; * Common Flash Interface support:&n; *   Generic utility functions not dependant on command set&n; *&n; * Copyright (C) 2002 Red Hat&n; * Copyright (C) 2003 STMicroelectronics Limited&n; *&n; * This code is covered by the GPL.&n; *&n; * $Id: cfi_util.c,v 1.4 2004/07/14 08:38:44 dwmw2 Exp $&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
macro_line|#include &lt;linux/mtd/cfi.h&gt;
macro_line|#include &lt;linux/mtd/compatmac.h&gt;
r_struct
id|cfi_extquery
op_star
DECL|function|cfi_read_pri
id|cfi_read_pri
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|__u16
id|adr
comma
id|__u16
id|size
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|cfi_private
op_star
id|cfi
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
id|__u32
id|base
op_assign
l_int|0
suffix:semicolon
singleline_comment|// cfi-&gt;chips[0].start;
r_int
id|ofs_factor
op_assign
id|cfi-&gt;interleave
op_star
id|cfi-&gt;device_type
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|cfi_extquery
op_star
id|extp
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %s Extended Query Table at 0x%4.4X&bslash;n&quot;
comma
id|name
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adr
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Switch it into Query Mode */
id|cfi_send_gen_cmd
c_func
(paren
l_int|0x98
comma
l_int|0x55
comma
id|base
comma
id|map
comma
id|cfi
comma
id|cfi-&gt;device_type
comma
l_int|NULL
)paren
suffix:semicolon
id|extp
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|extp
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to allocate memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Read in the Extended Query Table */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
(paren
(paren
r_int
r_char
op_star
)paren
id|extp
)paren
(braket
id|i
)braket
op_assign
id|cfi_read_query
c_func
(paren
id|map
comma
id|base
op_plus
(paren
(paren
id|adr
op_plus
id|i
)paren
op_star
id|ofs_factor
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|extp-&gt;MajorVersion
op_ne
l_char|&squot;1&squot;
op_logical_or
(paren
id|extp-&gt;MinorVersion
template_param
l_char|&squot;3&squot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;  Unknown %s Extended Query &quot;
l_string|&quot;version %c.%c.&bslash;n&quot;
comma
id|name
comma
id|extp-&gt;MajorVersion
comma
id|extp-&gt;MinorVersion
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|extp
)paren
suffix:semicolon
id|extp
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
multiline_comment|/* Make sure it&squot;s in read mode */
id|cfi_send_gen_cmd
c_func
(paren
l_int|0xf0
comma
l_int|0
comma
id|base
comma
id|map
comma
id|cfi
comma
id|cfi-&gt;device_type
comma
l_int|NULL
)paren
suffix:semicolon
id|cfi_send_gen_cmd
c_func
(paren
l_int|0xff
comma
l_int|0
comma
id|base
comma
id|map
comma
id|cfi
comma
id|cfi-&gt;device_type
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|extp
suffix:semicolon
)brace
DECL|variable|cfi_read_pri
id|EXPORT_SYMBOL
c_func
(paren
id|cfi_read_pri
)paren
suffix:semicolon
DECL|function|cfi_fixup
r_void
id|cfi_fixup
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_struct
id|cfi_fixup
op_star
id|fixups
)paren
(brace
r_struct
id|cfi_private
op_star
id|cfi
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
r_struct
id|cfi_fixup
op_star
id|f
suffix:semicolon
r_for
c_loop
(paren
id|f
op_assign
id|fixups
suffix:semicolon
id|f-&gt;fixup
suffix:semicolon
id|f
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|f-&gt;mfr
op_eq
id|CFI_MFR_ANY
)paren
op_logical_or
(paren
id|f-&gt;mfr
op_eq
id|cfi-&gt;mfr
)paren
)paren
op_logical_and
(paren
(paren
id|f-&gt;id
op_eq
id|CFI_ID_ANY
)paren
op_logical_or
(paren
id|f-&gt;id
op_eq
id|cfi-&gt;id
)paren
)paren
)paren
(brace
id|f
op_member_access_from_pointer
id|fixup
c_func
(paren
id|map
comma
id|f-&gt;param
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|cfi_fixup
id|EXPORT_SYMBOL
c_func
(paren
id|cfi_fixup
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
