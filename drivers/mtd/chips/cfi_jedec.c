multiline_comment|/* $Id: cfi_jedec.c,v 1.5 2001/06/02 14:52:23 dwmw2 Exp $ */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
macro_line|#include &lt;linux/mtd/cfi.h&gt;
multiline_comment|/* Manufacturers */
DECL|macro|MANUFACTURER_AMD
mdefine_line|#define MANUFACTURER_AMD&t;0x0001
DECL|macro|MANUFACTURER_FUJITSU
mdefine_line|#define MANUFACTURER_FUJITSU&t;0x0004
DECL|macro|MANUFACTURER_ATMEL
mdefine_line|#define MANUFACTURER_ATMEL&t;0x001f
DECL|macro|MANUFACTURER_ST
mdefine_line|#define MANUFACTURER_ST&t;&t;0x0020
DECL|macro|MANUFACTURER_SST
mdefine_line|#define MANUFACTURER_SST&t;0x00BF
DECL|macro|MANUFACTURER_TOSHIBA
mdefine_line|#define MANUFACTURER_TOSHIBA&t;0x0098
multiline_comment|/* AMD */
DECL|macro|AM29F800BB
mdefine_line|#define AM29F800BB&t;0x2258
DECL|macro|AM29F800BT
mdefine_line|#define AM29F800BT&t;0x22D6
DECL|macro|AM29LV800BB
mdefine_line|#define AM29LV800BB&t;0x225B
DECL|macro|AM29LV800BT
mdefine_line|#define AM29LV800BT&t;0x22DA
DECL|macro|AM29LV160DT
mdefine_line|#define AM29LV160DT&t;0x22C4
DECL|macro|AM29LV160DB
mdefine_line|#define AM29LV160DB&t;0x2249
multiline_comment|/* Atmel */
DECL|macro|AT49BV16X4
mdefine_line|#define AT49BV16X4&t;0x00c0
DECL|macro|AT49BV16X4T
mdefine_line|#define AT49BV16X4T&t;0x00c2
multiline_comment|/* Fujitsu */
DECL|macro|MBM29LV160TE
mdefine_line|#define MBM29LV160TE&t;0x22C4
DECL|macro|MBM29LV160BE
mdefine_line|#define MBM29LV160BE&t;0x2249
multiline_comment|/* ST - www.st.com */
DECL|macro|M29W800T
mdefine_line|#define M29W800T&t;0x00D7
DECL|macro|M29W160DT
mdefine_line|#define M29W160DT&t;0x22C4
DECL|macro|M29W160DB
mdefine_line|#define M29W160DB&t;0x2249
multiline_comment|/* SST */
DECL|macro|SST39LF800
mdefine_line|#define SST39LF800&t;0x2781
DECL|macro|SST39LF160
mdefine_line|#define SST39LF160&t;0x2782
multiline_comment|/* Toshiba */
DECL|macro|TC58FVT160
mdefine_line|#define TC58FVT160&t;0x00C2
DECL|macro|TC58FVB160
mdefine_line|#define TC58FVB160&t;0x0043
DECL|struct|amd_flash_info
r_struct
id|amd_flash_info
(brace
DECL|member|mfr_id
r_const
id|__u16
id|mfr_id
suffix:semicolon
DECL|member|dev_id
r_const
id|__u16
id|dev_id
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|DevSize
r_const
r_int
id|DevSize
suffix:semicolon
DECL|member|InterfaceDesc
r_const
r_int
id|InterfaceDesc
suffix:semicolon
DECL|member|NumEraseRegions
r_const
r_int
id|NumEraseRegions
suffix:semicolon
DECL|member|regions
r_const
id|ulong
id|regions
(braket
l_int|4
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|ERASEINFO
mdefine_line|#define ERASEINFO(size,blocks) (size&lt;&lt;8)|(blocks-1)
DECL|macro|SIZE_1MiB
mdefine_line|#define SIZE_1MiB 20
DECL|macro|SIZE_2MiB
mdefine_line|#define SIZE_2MiB 21
DECL|macro|SIZE_4MiB
mdefine_line|#define SIZE_4MiB 22
DECL|variable|jedec_table
r_static
r_const
r_struct
id|amd_flash_info
id|jedec_table
(braket
)braket
op_assign
(brace
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29LV160DT
comma
id|name
suffix:colon
l_string|&quot;AMD AM29LV160DT&quot;
comma
id|DevSize
suffix:colon
id|SIZE_2MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29LV160DB
comma
id|name
suffix:colon
l_string|&quot;AMD AM29LV160DB&quot;
comma
id|DevSize
suffix:colon
id|SIZE_2MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_TOSHIBA
comma
id|dev_id
suffix:colon
id|TC58FVT160
comma
id|name
suffix:colon
l_string|&quot;Toshiba TC58FVT160&quot;
comma
id|DevSize
suffix:colon
id|SIZE_2MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_FUJITSU
comma
id|dev_id
suffix:colon
id|MBM29LV160TE
comma
id|name
suffix:colon
l_string|&quot;Fujitsu MBM29LV160TE&quot;
comma
id|DevSize
suffix:colon
id|SIZE_2MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_TOSHIBA
comma
id|dev_id
suffix:colon
id|TC58FVB160
comma
id|name
suffix:colon
l_string|&quot;Toshiba TC58FVB160&quot;
comma
id|DevSize
suffix:colon
id|SIZE_2MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_FUJITSU
comma
id|dev_id
suffix:colon
id|MBM29LV160BE
comma
id|name
suffix:colon
l_string|&quot;Fujitsu MBM29LV160BE&quot;
comma
id|DevSize
suffix:colon
id|SIZE_2MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29LV800BB
comma
id|name
suffix:colon
l_string|&quot;AMD AM29LV800BB&quot;
comma
id|DevSize
suffix:colon
id|SIZE_1MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29F800BB
comma
id|name
suffix:colon
l_string|&quot;AMD AM29F800BB&quot;
comma
id|DevSize
suffix:colon
id|SIZE_1MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29LV800BT
comma
id|name
suffix:colon
l_string|&quot;AMD AM29LV800BT&quot;
comma
id|DevSize
suffix:colon
id|SIZE_1MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29F800BT
comma
id|name
suffix:colon
l_string|&quot;AMD AM29F800BT&quot;
comma
id|DevSize
suffix:colon
id|SIZE_1MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_AMD
comma
id|dev_id
suffix:colon
id|AM29LV800BB
comma
id|name
suffix:colon
l_string|&quot;AMD AM29LV800BB&quot;
comma
id|DevSize
suffix:colon
id|SIZE_1MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_ST
comma
id|dev_id
suffix:colon
id|M29W800T
comma
id|name
suffix:colon
l_string|&quot;ST M29W800T&quot;
comma
id|DevSize
suffix:colon
id|SIZE_1MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|15
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_ST
comma
id|dev_id
suffix:colon
id|M29W160DT
comma
id|name
suffix:colon
l_string|&quot;ST M29W160DT&quot;
comma
id|DevSize
suffix:colon
id|SIZE_2MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_ST
comma
id|dev_id
suffix:colon
id|M29W160DB
comma
id|name
suffix:colon
l_string|&quot;ST M29W160DB&quot;
comma
id|DevSize
suffix:colon
id|SIZE_2MiB
comma
id|NumEraseRegions
suffix:colon
l_int|4
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x04000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|1
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|31
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_ATMEL
comma
id|dev_id
suffix:colon
id|AT49BV16X4
comma
id|name
suffix:colon
l_string|&quot;Atmel AT49BV16X4&quot;
comma
id|DevSize
suffix:colon
id|SIZE_2MiB
comma
id|NumEraseRegions
suffix:colon
l_int|3
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|8
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|30
)paren
)brace
)brace
comma
(brace
id|mfr_id
suffix:colon
id|MANUFACTURER_ATMEL
comma
id|dev_id
suffix:colon
id|AT49BV16X4T
comma
id|name
suffix:colon
l_string|&quot;Atmel AT49BV16X4T&quot;
comma
id|DevSize
suffix:colon
id|SIZE_2MiB
comma
id|NumEraseRegions
suffix:colon
l_int|3
comma
id|regions
suffix:colon
(brace
id|ERASEINFO
c_func
(paren
l_int|0x10000
comma
l_int|30
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x08000
comma
l_int|2
)paren
comma
id|ERASEINFO
c_func
(paren
l_int|0x02000
comma
l_int|8
)paren
)brace
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|function|cfi_jedec_lookup
r_int
id|cfi_jedec_lookup
c_func
(paren
r_int
id|index
comma
r_int
id|mfr_id
comma
r_int
id|dev_id
)paren
(brace
r_if
c_cond
(paren
id|index
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|jedec_table
(braket
id|index
)braket
dot
id|mfr_id
op_eq
id|mfr_id
op_logical_and
id|jedec_table
(braket
id|index
)braket
dot
id|dev_id
op_eq
id|dev_id
)paren
r_return
id|index
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|jedec_table
(braket
id|index
)braket
dot
id|mfr_id
suffix:semicolon
id|index
op_increment
)paren
(brace
r_if
c_cond
(paren
id|jedec_table
(braket
id|index
)braket
dot
id|mfr_id
op_eq
id|mfr_id
op_logical_and
id|jedec_table
(braket
id|index
)braket
dot
id|dev_id
op_eq
id|dev_id
)paren
r_return
id|index
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|cfi_jedec_setup
r_int
id|cfi_jedec_setup
c_func
(paren
r_struct
id|cfi_private
op_star
id|p_cfi
comma
r_int
id|index
)paren
(brace
r_int
id|i
comma
id|num_erase_regions
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Found: %s&bslash;n&quot;
comma
id|jedec_table
(braket
id|index
)braket
dot
id|name
)paren
suffix:semicolon
id|num_erase_regions
op_assign
id|jedec_table
(braket
id|index
)braket
dot
id|NumEraseRegions
suffix:semicolon
id|p_cfi-&gt;cfiq
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|cfi_ident
)paren
op_plus
id|num_erase_regions
op_star
l_int|4
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p_cfi-&gt;cfiq
)paren
(brace
singleline_comment|//xx printk(KERN_WARNING &quot;%s: kmalloc failed for CFI ident structure&bslash;n&quot;, map-&gt;name);
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|p_cfi-&gt;cfiq
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|cfi_ident
)paren
)paren
suffix:semicolon
id|p_cfi-&gt;cfiq-&gt;P_ID
op_assign
id|P_ID_AMD_STD
suffix:semicolon
id|p_cfi-&gt;cfiq-&gt;NumEraseRegions
op_assign
id|jedec_table
(braket
id|index
)braket
dot
id|NumEraseRegions
suffix:semicolon
id|p_cfi-&gt;cfiq-&gt;DevSize
op_assign
id|jedec_table
(braket
id|index
)braket
dot
id|DevSize
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_erase_regions
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p_cfi-&gt;cfiq-&gt;EraseRegionInfo
(braket
id|i
)braket
op_assign
id|jedec_table
(braket
id|index
)braket
dot
id|regions
(braket
id|i
)braket
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ok */
)brace
eof
