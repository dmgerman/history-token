multiline_comment|/*&n; * Linux driver for Disk-On-Chip Millennium Plus&n; *&n; * (c) 2002-2003 Greg Ungerer &lt;gerg@snapgear.com&gt;&n; * (c) 2002-2003 SnapGear Inc&n; * (c) 1999 Machine Vision Holdings, Inc.&n; * (c) 1999, 2000 David Woodhouse &lt;dwmw2@infradead.org&gt;&n; *&n; * $Id: doc2001plus.c,v 1.11 2004/11/16 18:29:01 dwmw2 Exp $&n; *&n; * Released under GPL&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/mtd/nand.h&gt;
macro_line|#include &lt;linux/mtd/doc2000.h&gt;
multiline_comment|/* #define ECC_DEBUG */
multiline_comment|/* I have no idea why some DoC chips can not use memcop_form|to_io().&n; * This may be due to the different revisions of the ASIC controller built-in or&n; * simplily a QA/Bug issue. Who knows ?? If you have trouble, please uncomment&n; * this:*/
DECL|macro|USE_MEMCPY
macro_line|#undef USE_MEMCPY
r_static
r_int
id|doc_read
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|doc_write
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|doc_read_ecc
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
comma
id|u_char
op_star
id|eccbuf
comma
r_struct
id|nand_oobinfo
op_star
id|oobsel
)paren
suffix:semicolon
r_static
r_int
id|doc_write_ecc
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
comma
id|u_char
op_star
id|eccbuf
comma
r_struct
id|nand_oobinfo
op_star
id|oobsel
)paren
suffix:semicolon
r_static
r_int
id|doc_read_oob
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|ofs
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|doc_write_oob
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|ofs
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|doc_erase
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_struct
id|erase_info
op_star
id|instr
)paren
suffix:semicolon
DECL|variable|docmilpluslist
r_static
r_struct
id|mtd_info
op_star
id|docmilpluslist
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Perform the required delay cycles by writing to the NOP register */
DECL|function|DoC_Delay
r_static
r_void
id|DoC_Delay
c_func
(paren
r_void
id|__iomem
op_star
id|docptr
comma
r_int
id|cycles
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|cycles
)paren
suffix:semicolon
id|i
op_increment
)paren
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_NOP
)paren
suffix:semicolon
)brace
DECL|macro|CDSN_CTRL_FR_B_MASK
mdefine_line|#define&t;CDSN_CTRL_FR_B_MASK&t;(CDSN_CTRL_FR_B0 | CDSN_CTRL_FR_B1)
multiline_comment|/* DOC_WaitReady: Wait for RDY line to be asserted by the flash chip */
DECL|function|_DoC_WaitReady
r_static
r_int
id|_DoC_WaitReady
c_func
(paren
r_void
id|__iomem
op_star
id|docptr
)paren
(brace
r_int
r_int
id|c
op_assign
l_int|0xffff
suffix:semicolon
id|DEBUG
c_func
(paren
id|MTD_DEBUG_LEVEL3
comma
l_string|&quot;_DoC_WaitReady called for out-of-line wait&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Out-of-line routine to wait for chip response */
r_while
c_loop
(paren
(paren
(paren
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_FlashControl
)paren
op_amp
id|CDSN_CTRL_FR_B_MASK
)paren
op_ne
id|CDSN_CTRL_FR_B_MASK
)paren
op_logical_and
op_decrement
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_int|0
)paren
id|DEBUG
c_func
(paren
id|MTD_DEBUG_LEVEL2
comma
l_string|&quot;_DoC_WaitReady timed out.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|c
op_eq
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|DoC_WaitReady
r_static
r_inline
r_int
id|DoC_WaitReady
c_func
(paren
r_void
id|__iomem
op_star
id|docptr
)paren
(brace
multiline_comment|/* This is inline, to optimise the common case, where it&squot;s ready instantly */
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* read form NOP register should be issued prior to the read from CDSNControl&n;&t;   see Software Requirement 11.4 item 2. */
id|DoC_Delay
c_func
(paren
id|docptr
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_FlashControl
)paren
op_amp
id|CDSN_CTRL_FR_B_MASK
)paren
op_ne
id|CDSN_CTRL_FR_B_MASK
)paren
multiline_comment|/* Call the out-of-line routine to wait */
id|ret
op_assign
id|_DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* For some reason the Millennium Plus seems to occassionally put itself&n; * into reset mode. For me this happens randomly, with no pattern that I&n; * can detect. M-systems suggest always check this on any block level&n; * operation and setting to normal mode if in reset mode.&n; */
DECL|function|DoC_CheckASIC
r_static
r_inline
r_void
id|DoC_CheckASIC
c_func
(paren
r_void
id|__iomem
op_star
id|docptr
)paren
(brace
multiline_comment|/* Make sure the DoC is in normal mode */
r_if
c_cond
(paren
(paren
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_DOCControl
)paren
op_amp
id|DOC_MODE_NORMAL
)paren
op_eq
l_int|0
)paren
(brace
id|WriteDOC
c_func
(paren
(paren
id|DOC_MODE_NORMAL
op_or
id|DOC_MODE_MDWREN
)paren
comma
id|docptr
comma
id|Mplus_DOCControl
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
op_complement
(paren
id|DOC_MODE_NORMAL
op_or
id|DOC_MODE_MDWREN
)paren
comma
id|docptr
comma
id|Mplus_CtrlConfirm
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* DoC_Command: Send a flash command to the flash chip through the Flash&n; * command register. Need 2 Write Pipeline Terminates to complete send.&n; */
DECL|function|DoC_Command
r_static
r_inline
r_void
id|DoC_Command
c_func
(paren
r_void
id|__iomem
op_star
id|docptr
comma
r_int
r_char
id|command
comma
r_int
r_char
id|xtraflags
)paren
(brace
id|WriteDOC
c_func
(paren
id|command
comma
id|docptr
comma
id|Mplus_FlashCmd
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
id|command
comma
id|docptr
comma
id|Mplus_WritePipeTerm
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
id|command
comma
id|docptr
comma
id|Mplus_WritePipeTerm
)paren
suffix:semicolon
)brace
multiline_comment|/* DoC_Address: Set the current address for the flash chip through the Flash&n; * Address register. Need 2 Write Pipeline Terminates to complete send.&n; */
DECL|function|DoC_Address
r_static
r_inline
r_void
id|DoC_Address
c_func
(paren
r_struct
id|DiskOnChip
op_star
id|doc
comma
r_int
id|numbytes
comma
r_int
r_int
id|ofs
comma
r_int
r_char
id|xtraflags1
comma
r_int
r_char
id|xtraflags2
)paren
(brace
r_void
id|__iomem
op_star
id|docptr
op_assign
id|doc-&gt;virtadr
suffix:semicolon
multiline_comment|/* Allow for possible Mill Plus internal flash interleaving */
id|ofs
op_rshift_assign
id|doc-&gt;interleave
suffix:semicolon
r_switch
c_cond
(paren
id|numbytes
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* Send single byte, bits 0-7. */
id|WriteDOC
c_func
(paren
id|ofs
op_amp
l_int|0xff
comma
id|docptr
comma
id|Mplus_FlashAddress
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Send bits 9-16 followed by 17-23 */
id|WriteDOC
c_func
(paren
(paren
id|ofs
op_rshift
l_int|9
)paren
op_amp
l_int|0xff
comma
id|docptr
comma
id|Mplus_FlashAddress
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
(paren
id|ofs
op_rshift
l_int|17
)paren
op_amp
l_int|0xff
comma
id|docptr
comma
id|Mplus_FlashAddress
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* Send 0-7, 9-16, then 17-23 */
id|WriteDOC
c_func
(paren
id|ofs
op_amp
l_int|0xff
comma
id|docptr
comma
id|Mplus_FlashAddress
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
(paren
id|ofs
op_rshift
l_int|9
)paren
op_amp
l_int|0xff
comma
id|docptr
comma
id|Mplus_FlashAddress
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
(paren
id|ofs
op_rshift
l_int|17
)paren
op_amp
l_int|0xff
comma
id|docptr
comma
id|Mplus_FlashAddress
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
id|WriteDOC
c_func
(paren
l_int|0x00
comma
id|docptr
comma
id|Mplus_WritePipeTerm
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
l_int|0x00
comma
id|docptr
comma
id|Mplus_WritePipeTerm
)paren
suffix:semicolon
)brace
multiline_comment|/* DoC_SelectChip: Select a given flash chip within the current floor */
DECL|function|DoC_SelectChip
r_static
r_int
id|DoC_SelectChip
c_func
(paren
r_void
id|__iomem
op_star
id|docptr
comma
r_int
id|chip
)paren
(brace
multiline_comment|/* No choice for flash chip on Millennium Plus */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* DoC_SelectFloor: Select a given floor (bank of flash chips) */
DECL|function|DoC_SelectFloor
r_static
r_int
id|DoC_SelectFloor
c_func
(paren
r_void
id|__iomem
op_star
id|docptr
comma
r_int
id|floor
)paren
(brace
id|WriteDOC
c_func
(paren
(paren
id|floor
op_amp
l_int|0x3
)paren
comma
id|docptr
comma
id|Mplus_DeviceSelect
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Translate the given offset into the appropriate command and offset.&n; * This does the mapping using the 16bit interleave layout defined by&n; * M-Systems, and looks like this for a sector pair:&n; *  +-----------+-------+-------+-------+--------------+---------+-----------+&n; *  | 0 --- 511 |512-517|518-519|520-521| 522 --- 1033 |1034-1039|1040 - 1055|&n; *  +-----------+-------+-------+-------+--------------+---------+-----------+&n; *  | Data 0    | ECC 0 |Flags0 |Flags1 | Data 1       |ECC 1    | OOB 1 + 2 |&n; *  +-----------+-------+-------+-------+--------------+---------+-----------+&n; */
multiline_comment|/* FIXME: This lives in INFTL not here. Other users of flash devices&n;   may not want it */
DECL|function|DoC_GetDataOffset
r_static
r_int
r_int
id|DoC_GetDataOffset
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
op_star
id|from
)paren
(brace
r_struct
id|DiskOnChip
op_star
id|this
op_assign
(paren
r_struct
id|DiskOnChip
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|this-&gt;interleave
)paren
(brace
r_int
r_int
id|ofs
op_assign
op_star
id|from
op_amp
l_int|0x3ff
suffix:semicolon
r_int
r_int
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|ofs
OL
l_int|512
)paren
(brace
id|cmd
op_assign
id|NAND_CMD_READ0
suffix:semicolon
id|ofs
op_and_assign
l_int|0x1ff
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ofs
OL
l_int|1014
)paren
(brace
id|cmd
op_assign
id|NAND_CMD_READ1
suffix:semicolon
id|ofs
op_assign
(paren
id|ofs
op_amp
l_int|0x1ff
)paren
op_plus
l_int|10
suffix:semicolon
)brace
r_else
(brace
id|cmd
op_assign
id|NAND_CMD_READOOB
suffix:semicolon
id|ofs
op_assign
id|ofs
op_minus
l_int|1014
suffix:semicolon
)brace
op_star
id|from
op_assign
(paren
op_star
id|from
op_amp
op_complement
l_int|0x3ff
)paren
op_or
id|ofs
suffix:semicolon
r_return
id|cmd
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No interleave */
r_if
c_cond
(paren
(paren
op_star
id|from
)paren
op_amp
l_int|0x100
)paren
r_return
id|NAND_CMD_READ1
suffix:semicolon
r_return
id|NAND_CMD_READ0
suffix:semicolon
)brace
)brace
DECL|function|DoC_GetECCOffset
r_static
r_int
r_int
id|DoC_GetECCOffset
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
op_star
id|from
)paren
(brace
r_int
r_int
id|ofs
comma
id|cmd
suffix:semicolon
r_if
c_cond
(paren
op_star
id|from
op_amp
l_int|0x200
)paren
(brace
id|cmd
op_assign
id|NAND_CMD_READOOB
suffix:semicolon
id|ofs
op_assign
l_int|10
op_plus
(paren
op_star
id|from
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
r_else
(brace
id|cmd
op_assign
id|NAND_CMD_READ1
suffix:semicolon
id|ofs
op_assign
(paren
op_star
id|from
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
op_star
id|from
op_assign
(paren
op_star
id|from
op_amp
op_complement
l_int|0x3ff
)paren
op_or
id|ofs
suffix:semicolon
r_return
id|cmd
suffix:semicolon
)brace
DECL|function|DoC_GetFlagsOffset
r_static
r_int
r_int
id|DoC_GetFlagsOffset
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
op_star
id|from
)paren
(brace
r_int
r_int
id|ofs
comma
id|cmd
suffix:semicolon
id|cmd
op_assign
id|NAND_CMD_READ1
suffix:semicolon
id|ofs
op_assign
(paren
op_star
id|from
op_amp
l_int|0x200
)paren
ques
c_cond
l_int|8
suffix:colon
l_int|6
suffix:semicolon
op_star
id|from
op_assign
(paren
op_star
id|from
op_amp
op_complement
l_int|0x3ff
)paren
op_or
id|ofs
suffix:semicolon
r_return
id|cmd
suffix:semicolon
)brace
DECL|function|DoC_GetHdrOffset
r_static
r_int
r_int
id|DoC_GetHdrOffset
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
op_star
id|from
)paren
(brace
r_int
r_int
id|ofs
comma
id|cmd
suffix:semicolon
id|cmd
op_assign
id|NAND_CMD_READOOB
suffix:semicolon
id|ofs
op_assign
(paren
op_star
id|from
op_amp
l_int|0x200
)paren
ques
c_cond
l_int|24
suffix:colon
l_int|16
suffix:semicolon
op_star
id|from
op_assign
(paren
op_star
id|from
op_amp
op_complement
l_int|0x3ff
)paren
op_or
id|ofs
suffix:semicolon
r_return
id|cmd
suffix:semicolon
)brace
DECL|function|MemReadDOC
r_static
r_inline
r_void
id|MemReadDOC
c_func
(paren
r_void
id|__iomem
op_star
id|docptr
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
macro_line|#ifndef USE_MEMCPY
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|buf
(braket
id|i
)braket
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mil_CDSN_IO
op_plus
id|i
)paren
suffix:semicolon
macro_line|#else
id|memcpy_fromio
c_func
(paren
id|buf
comma
id|docptr
op_plus
id|DoC_Mil_CDSN_IO
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|MemWriteDOC
r_static
r_inline
r_void
id|MemWriteDOC
c_func
(paren
r_void
id|__iomem
op_star
id|docptr
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
macro_line|#ifndef USE_MEMCPY
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|WriteDOC
c_func
(paren
id|buf
(braket
id|i
)braket
comma
id|docptr
comma
id|Mil_CDSN_IO
op_plus
id|i
)paren
suffix:semicolon
macro_line|#else
id|memcpy_toio
c_func
(paren
id|docptr
op_plus
id|DoC_Mil_CDSN_IO
comma
id|buf
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* DoC_IdentChip: Identify a given NAND chip given {floor,chip} */
DECL|function|DoC_IdentChip
r_static
r_int
id|DoC_IdentChip
c_func
(paren
r_struct
id|DiskOnChip
op_star
id|doc
comma
r_int
id|floor
comma
r_int
id|chip
)paren
(brace
r_int
id|mfr
comma
id|id
comma
id|i
comma
id|j
suffix:semicolon
r_volatile
r_char
id|dummy
suffix:semicolon
r_void
id|__iomem
op_star
id|docptr
op_assign
id|doc-&gt;virtadr
suffix:semicolon
multiline_comment|/* Page in the required floor/chip */
id|DoC_SelectFloor
c_func
(paren
id|docptr
comma
id|floor
)paren
suffix:semicolon
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|chip
)paren
suffix:semicolon
multiline_comment|/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */
id|WriteDOC
c_func
(paren
(paren
id|DOC_FLASH_CE
op_or
id|DOC_FLASH_WP
)paren
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
multiline_comment|/* Reset the chip, see Software Requirement 11.4 item 1. */
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_RESET
comma
l_int|0
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Read the NAND chip ID: 1. Send ReadID command */
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_READID
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Read the NAND chip ID: 2. Send address byte zero */
id|DoC_Address
c_func
(paren
id|doc
comma
l_int|1
comma
l_int|0x00
comma
l_int|0
comma
l_int|0x00
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_FlashControl
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Read the manufacturer and device id codes of the flash device through&n;&t;   CDSN IO register see Software Requirement 11.4 item 5.*/
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
id|mfr
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mil_CDSN_IO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|doc-&gt;interleave
)paren
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mil_CDSN_IO
)paren
suffix:semicolon
multiline_comment|/* 2 way interleave */
id|id
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mil_CDSN_IO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|doc-&gt;interleave
)paren
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mil_CDSN_IO
)paren
suffix:semicolon
multiline_comment|/* 2 way interleave */
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
multiline_comment|/* Disable flash internally */
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
multiline_comment|/* No response - return failure */
r_if
c_cond
(paren
id|mfr
op_eq
l_int|0xff
op_logical_or
id|mfr
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|nand_flash_ids
(braket
id|i
)braket
dot
id|name
op_ne
l_int|NULL
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|id
op_eq
id|nand_flash_ids
(braket
id|i
)braket
dot
id|id
)paren
(brace
multiline_comment|/* Try to identify manufacturer */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|nand_manuf_ids
(braket
id|j
)braket
dot
id|id
op_ne
l_int|0x0
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|nand_manuf_ids
(braket
id|j
)braket
dot
id|id
op_eq
id|mfr
)paren
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Flash chip found: Manufacturer ID: %2.2X, &quot;
l_string|&quot;Chip ID: %2.2X (%s:%s)&bslash;n&quot;
comma
id|mfr
comma
id|id
comma
id|nand_manuf_ids
(braket
id|j
)braket
dot
id|name
comma
id|nand_flash_ids
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
id|doc-&gt;mfr
op_assign
id|mfr
suffix:semicolon
id|doc-&gt;id
op_assign
id|id
suffix:semicolon
id|doc-&gt;chipshift
op_assign
id|ffs
c_func
(paren
(paren
id|nand_flash_ids
(braket
id|i
)braket
dot
id|chipsize
op_lshift
l_int|20
)paren
)paren
op_minus
l_int|1
suffix:semicolon
id|doc-&gt;erasesize
op_assign
id|nand_flash_ids
(braket
id|i
)braket
dot
id|erasesize
op_lshift
id|doc-&gt;interleave
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|nand_flash_ids
(braket
id|i
)braket
dot
id|name
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* DoC_ScanChips: Find all NAND chips present in a DiskOnChip, and identify them */
DECL|function|DoC_ScanChips
r_static
r_void
id|DoC_ScanChips
c_func
(paren
r_struct
id|DiskOnChip
op_star
id|this
)paren
(brace
r_int
id|floor
comma
id|chip
suffix:semicolon
r_int
id|numchips
(braket
id|MAX_FLOORS_MPLUS
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|this-&gt;numchips
op_assign
l_int|0
suffix:semicolon
id|this-&gt;mfr
op_assign
l_int|0
suffix:semicolon
id|this-&gt;id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Work out the intended interleave setting */
id|this-&gt;interleave
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|this-&gt;ChipID
op_eq
id|DOC_ChipID_DocMilPlus32
)paren
id|this-&gt;interleave
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Check the ASIC agrees */
r_if
c_cond
(paren
(paren
id|this-&gt;interleave
op_lshift
l_int|2
)paren
op_ne
(paren
id|ReadDOC
c_func
(paren
id|this-&gt;virtadr
comma
id|Mplus_Configuration
)paren
op_amp
l_int|4
)paren
)paren
(brace
id|u_char
id|conf
op_assign
id|ReadDOC
c_func
(paren
id|this-&gt;virtadr
comma
id|Mplus_Configuration
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Setting DiskOnChip Millennium Plus interleave to %s&bslash;n&quot;
comma
id|this-&gt;interleave
ques
c_cond
l_string|&quot;on (16-bit)&quot;
suffix:colon
l_string|&quot;off (8-bit)&quot;
)paren
suffix:semicolon
id|conf
op_xor_assign
l_int|4
suffix:semicolon
id|WriteDOC
c_func
(paren
id|conf
comma
id|this-&gt;virtadr
comma
id|Mplus_Configuration
)paren
suffix:semicolon
)brace
multiline_comment|/* For each floor, find the number of valid chips it contains */
r_for
c_loop
(paren
id|floor
op_assign
l_int|0
comma
id|ret
op_assign
l_int|1
suffix:semicolon
id|floor
OL
id|MAX_FLOORS_MPLUS
suffix:semicolon
id|floor
op_increment
)paren
(brace
id|numchips
(braket
id|floor
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|chip
op_assign
l_int|0
suffix:semicolon
id|chip
OL
id|MAX_CHIPS_MPLUS
op_logical_and
id|ret
op_ne
l_int|0
suffix:semicolon
id|chip
op_increment
)paren
(brace
id|ret
op_assign
id|DoC_IdentChip
c_func
(paren
id|this
comma
id|floor
comma
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|numchips
(braket
id|floor
)braket
op_increment
suffix:semicolon
id|this-&gt;numchips
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* If there are none at all that we recognise, bail */
r_if
c_cond
(paren
op_logical_neg
id|this-&gt;numchips
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No flash chips recognised.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Allocate an array to hold the information for each chip */
id|this-&gt;chips
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|Nand
)paren
op_star
id|this-&gt;numchips
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|this-&gt;chips
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MTD: No memory for allocating chip info structures&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Fill out the chip array with {floor, chipno} for each &n;&t; * detected chip in the device. */
r_for
c_loop
(paren
id|floor
op_assign
l_int|0
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|floor
OL
id|MAX_FLOORS_MPLUS
suffix:semicolon
id|floor
op_increment
)paren
(brace
r_for
c_loop
(paren
id|chip
op_assign
l_int|0
suffix:semicolon
id|chip
OL
id|numchips
(braket
id|floor
)braket
suffix:semicolon
id|chip
op_increment
)paren
(brace
id|this-&gt;chips
(braket
id|ret
)braket
dot
id|floor
op_assign
id|floor
suffix:semicolon
id|this-&gt;chips
(braket
id|ret
)braket
dot
id|chip
op_assign
id|chip
suffix:semicolon
id|this-&gt;chips
(braket
id|ret
)braket
dot
id|curadr
op_assign
l_int|0
suffix:semicolon
id|this-&gt;chips
(braket
id|ret
)braket
dot
id|curmode
op_assign
l_int|0x50
suffix:semicolon
id|ret
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Calculate and print the total size of the device */
id|this-&gt;totlen
op_assign
id|this-&gt;numchips
op_star
(paren
l_int|1
op_lshift
id|this-&gt;chipshift
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%d flash chips found. Total DiskOnChip size: %ld MiB&bslash;n&quot;
comma
id|this-&gt;numchips
comma
id|this-&gt;totlen
op_rshift
l_int|20
)paren
suffix:semicolon
)brace
DECL|function|DoCMilPlus_is_alias
r_static
r_int
id|DoCMilPlus_is_alias
c_func
(paren
r_struct
id|DiskOnChip
op_star
id|doc1
comma
r_struct
id|DiskOnChip
op_star
id|doc2
)paren
(brace
r_int
id|tmp1
comma
id|tmp2
comma
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|doc1-&gt;physadr
op_eq
id|doc2-&gt;physadr
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Use the alias resolution register which was set aside for this&n;&t; * purpose. If it&squot;s value is the same on both chips, they might&n;&t; * be the same chip, and we write to one and check for a change in&n;&t; * the other. It&squot;s unclear if this register is usuable in the&n;&t; * DoC 2000 (it&squot;s in the Millennium docs), but it seems to work. */
id|tmp1
op_assign
id|ReadDOC
c_func
(paren
id|doc1-&gt;virtadr
comma
id|Mplus_AliasResolution
)paren
suffix:semicolon
id|tmp2
op_assign
id|ReadDOC
c_func
(paren
id|doc2-&gt;virtadr
comma
id|Mplus_AliasResolution
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp1
op_ne
id|tmp2
)paren
r_return
l_int|0
suffix:semicolon
id|WriteDOC
c_func
(paren
(paren
id|tmp1
op_plus
l_int|1
)paren
op_mod
l_int|0xff
comma
id|doc1-&gt;virtadr
comma
id|Mplus_AliasResolution
)paren
suffix:semicolon
id|tmp2
op_assign
id|ReadDOC
c_func
(paren
id|doc2-&gt;virtadr
comma
id|Mplus_AliasResolution
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp2
op_eq
(paren
id|tmp1
op_plus
l_int|1
)paren
op_mod
l_int|0xff
)paren
id|retval
op_assign
l_int|1
suffix:semicolon
r_else
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Restore register contents.  May not be necessary, but do it just to&n;&t; * be safe. */
id|WriteDOC
c_func
(paren
id|tmp1
comma
id|doc1-&gt;virtadr
comma
id|Mplus_AliasResolution
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|variable|im_name
r_static
r_const
r_char
id|im_name
(braket
)braket
op_assign
l_string|&quot;DoCMilPlus_init&quot;
suffix:semicolon
multiline_comment|/* This routine is made available to other mtd code via&n; * inter_module_register.  It must only be accessed through&n; * inter_module_get which will bump the use count of this module.  The&n; * addresses passed back in mtd are valid as long as the use count of&n; * this module is non-zero, i.e. between inter_module_get and&n; * inter_module_put.  Keith Owens &lt;kaos@ocs.com.au&gt; 29 Oct 2000.&n; */
DECL|function|DoCMilPlus_init
r_static
r_void
id|DoCMilPlus_init
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
r_struct
id|DiskOnChip
op_star
id|this
op_assign
(paren
r_struct
id|DiskOnChip
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|DiskOnChip
op_star
id|old
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* We must avoid being called twice for the same device. */
r_if
c_cond
(paren
id|docmilpluslist
)paren
id|old
op_assign
(paren
r_struct
id|DiskOnChip
op_star
)paren
id|docmilpluslist-&gt;priv
suffix:semicolon
r_while
c_loop
(paren
id|old
)paren
(brace
r_if
c_cond
(paren
id|DoCMilPlus_is_alias
c_func
(paren
id|this
comma
id|old
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Ignoring DiskOnChip Millennium &quot;
l_string|&quot;Plus at 0x%lX - already configured&bslash;n&quot;
comma
id|this-&gt;physadr
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|this-&gt;virtadr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mtd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|old-&gt;nextdoc
)paren
id|old
op_assign
(paren
r_struct
id|DiskOnChip
op_star
)paren
id|old-&gt;nextdoc-&gt;priv
suffix:semicolon
r_else
id|old
op_assign
l_int|NULL
suffix:semicolon
)brace
id|mtd-&gt;name
op_assign
l_string|&quot;DiskOnChip Millennium Plus&quot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;DiskOnChip Millennium Plus found at &quot;
l_string|&quot;address 0x%lX&bslash;n&quot;
comma
id|this-&gt;physadr
)paren
suffix:semicolon
id|mtd-&gt;type
op_assign
id|MTD_NANDFLASH
suffix:semicolon
id|mtd-&gt;flags
op_assign
id|MTD_CAP_NANDFLASH
suffix:semicolon
id|mtd-&gt;ecctype
op_assign
id|MTD_ECC_RS_DiskOnChip
suffix:semicolon
id|mtd-&gt;size
op_assign
l_int|0
suffix:semicolon
id|mtd-&gt;erasesize
op_assign
l_int|0
suffix:semicolon
id|mtd-&gt;oobblock
op_assign
l_int|512
suffix:semicolon
id|mtd-&gt;oobsize
op_assign
l_int|16
suffix:semicolon
id|mtd-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|mtd-&gt;erase
op_assign
id|doc_erase
suffix:semicolon
id|mtd-&gt;point
op_assign
l_int|NULL
suffix:semicolon
id|mtd-&gt;unpoint
op_assign
l_int|NULL
suffix:semicolon
id|mtd-&gt;read
op_assign
id|doc_read
suffix:semicolon
id|mtd-&gt;write
op_assign
id|doc_write
suffix:semicolon
id|mtd-&gt;read_ecc
op_assign
id|doc_read_ecc
suffix:semicolon
id|mtd-&gt;write_ecc
op_assign
id|doc_write_ecc
suffix:semicolon
id|mtd-&gt;read_oob
op_assign
id|doc_read_oob
suffix:semicolon
id|mtd-&gt;write_oob
op_assign
id|doc_write_oob
suffix:semicolon
id|mtd-&gt;sync
op_assign
l_int|NULL
suffix:semicolon
id|this-&gt;totlen
op_assign
l_int|0
suffix:semicolon
id|this-&gt;numchips
op_assign
l_int|0
suffix:semicolon
id|this-&gt;curfloor
op_assign
op_minus
l_int|1
suffix:semicolon
id|this-&gt;curchip
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Ident all the chips present. */
id|DoC_ScanChips
c_func
(paren
id|this
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|this-&gt;totlen
)paren
(brace
id|kfree
c_func
(paren
id|mtd
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|this-&gt;virtadr
)paren
suffix:semicolon
)brace
r_else
(brace
id|this-&gt;nextdoc
op_assign
id|docmilpluslist
suffix:semicolon
id|docmilpluslist
op_assign
id|mtd
suffix:semicolon
id|mtd-&gt;size
op_assign
id|this-&gt;totlen
suffix:semicolon
id|mtd-&gt;erasesize
op_assign
id|this-&gt;erasesize
suffix:semicolon
id|add_mtd_device
c_func
(paren
id|mtd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
macro_line|#if 0
r_static
r_int
id|doc_dumpblk
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
)paren
(brace
r_int
id|i
suffix:semicolon
id|loff_t
id|fofs
suffix:semicolon
r_struct
id|DiskOnChip
op_star
id|this
op_assign
(paren
r_struct
id|DiskOnChip
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
r_void
id|__iomem
op_star
id|docptr
op_assign
id|this-&gt;virtadr
suffix:semicolon
r_struct
id|Nand
op_star
id|mychip
op_assign
op_amp
id|this-&gt;chips
(braket
id|from
op_rshift
(paren
id|this-&gt;chipshift
)paren
)braket
suffix:semicolon
r_int
r_char
op_star
id|bp
comma
id|buf
(braket
l_int|1056
)braket
suffix:semicolon
r_char
id|c
(braket
l_int|32
)braket
suffix:semicolon
id|from
op_and_assign
op_complement
l_int|0x3ff
suffix:semicolon
multiline_comment|/* Don&squot;t allow read past end of device */
r_if
c_cond
(paren
id|from
op_ge
id|this-&gt;totlen
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|DoC_CheckASIC
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Find the chip which is to be used and select it */
r_if
c_cond
(paren
id|this-&gt;curfloor
op_ne
id|mychip-&gt;floor
)paren
(brace
id|DoC_SelectFloor
c_func
(paren
id|docptr
comma
id|mychip-&gt;floor
)paren
suffix:semicolon
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|this-&gt;curchip
op_ne
id|mychip-&gt;chip
)paren
(brace
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
id|this-&gt;curfloor
op_assign
id|mychip-&gt;floor
suffix:semicolon
id|this-&gt;curchip
op_assign
id|mychip-&gt;chip
suffix:semicolon
multiline_comment|/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */
id|WriteDOC
c_func
(paren
(paren
id|DOC_FLASH_CE
op_or
id|DOC_FLASH_WP
)paren
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
multiline_comment|/* Reset the chip, see Software Requirement 11.4 item 1. */
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_RESET
comma
l_int|0
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
id|fofs
op_assign
id|from
suffix:semicolon
id|DoC_Command
c_func
(paren
id|docptr
comma
id|DoC_GetDataOffset
c_func
(paren
id|mtd
comma
op_amp
id|fofs
)paren
comma
l_int|0
)paren
suffix:semicolon
id|DoC_Address
c_func
(paren
id|this
comma
l_int|3
comma
id|fofs
comma
l_int|0
comma
l_int|0x00
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_FlashControl
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* disable the ECC engine */
id|WriteDOC
c_func
(paren
id|DOC_ECC_RESET
comma
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
multiline_comment|/* Read the data via the internal pipeline through CDSN IO&n;&t;   register, see Pipelined Read Operations 11.3 */
id|MemReadDOC
c_func
(paren
id|docptr
comma
id|buf
comma
l_int|1054
)paren
suffix:semicolon
id|buf
(braket
l_int|1054
)braket
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
id|buf
(braket
l_int|1055
)braket
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|c
(braket
l_int|0
)braket
comma
l_int|0
comma
r_sizeof
(paren
id|c
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DUMP OFFSET=%x:&bslash;n&quot;
comma
(paren
r_int
)paren
id|from
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|bp
op_assign
op_amp
id|buf
(braket
l_int|0
)braket
suffix:semicolon
(paren
id|i
OL
l_int|1056
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|16
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;%08x: &quot;
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
op_star
id|bp
)paren
suffix:semicolon
id|c
(braket
(paren
id|i
op_amp
l_int|0xf
)paren
)braket
op_assign
(paren
(paren
op_star
id|bp
op_ge
l_int|0x20
)paren
op_logical_and
(paren
op_star
id|bp
op_le
l_int|0x7f
)paren
)paren
ques
c_cond
op_star
id|bp
suffix:colon
l_char|&squot;.&squot;
suffix:semicolon
id|bp
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|16
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;    %s&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Disable flash internally */
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|doc_read
r_static
r_int
id|doc_read
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
(brace
multiline_comment|/* Just a special case of doc_read_ecc */
r_return
id|doc_read_ecc
c_func
(paren
id|mtd
comma
id|from
comma
id|len
comma
id|retlen
comma
id|buf
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|doc_read_ecc
r_static
r_int
id|doc_read_ecc
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
comma
id|u_char
op_star
id|eccbuf
comma
r_struct
id|nand_oobinfo
op_star
id|oobsel
)paren
(brace
r_int
id|ret
comma
id|i
suffix:semicolon
r_volatile
r_char
id|dummy
suffix:semicolon
id|loff_t
id|fofs
suffix:semicolon
r_int
r_char
id|syndrome
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|DiskOnChip
op_star
id|this
op_assign
(paren
r_struct
id|DiskOnChip
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
r_void
id|__iomem
op_star
id|docptr
op_assign
id|this-&gt;virtadr
suffix:semicolon
r_struct
id|Nand
op_star
id|mychip
op_assign
op_amp
id|this-&gt;chips
(braket
id|from
op_rshift
(paren
id|this-&gt;chipshift
)paren
)braket
suffix:semicolon
multiline_comment|/* Don&squot;t allow read past end of device */
r_if
c_cond
(paren
id|from
op_ge
id|this-&gt;totlen
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Don&squot;t allow a single read to cross a 512-byte block boundary */
r_if
c_cond
(paren
id|from
op_plus
id|len
OG
(paren
(paren
id|from
op_or
l_int|0x1ff
)paren
op_plus
l_int|1
)paren
)paren
id|len
op_assign
(paren
(paren
id|from
op_or
l_int|0x1ff
)paren
op_plus
l_int|1
)paren
op_minus
id|from
suffix:semicolon
id|DoC_CheckASIC
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Find the chip which is to be used and select it */
r_if
c_cond
(paren
id|this-&gt;curfloor
op_ne
id|mychip-&gt;floor
)paren
(brace
id|DoC_SelectFloor
c_func
(paren
id|docptr
comma
id|mychip-&gt;floor
)paren
suffix:semicolon
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|this-&gt;curchip
op_ne
id|mychip-&gt;chip
)paren
(brace
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
id|this-&gt;curfloor
op_assign
id|mychip-&gt;floor
suffix:semicolon
id|this-&gt;curchip
op_assign
id|mychip-&gt;chip
suffix:semicolon
multiline_comment|/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */
id|WriteDOC
c_func
(paren
(paren
id|DOC_FLASH_CE
op_or
id|DOC_FLASH_WP
)paren
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
multiline_comment|/* Reset the chip, see Software Requirement 11.4 item 1. */
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_RESET
comma
l_int|0
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
id|fofs
op_assign
id|from
suffix:semicolon
id|DoC_Command
c_func
(paren
id|docptr
comma
id|DoC_GetDataOffset
c_func
(paren
id|mtd
comma
op_amp
id|fofs
)paren
comma
l_int|0
)paren
suffix:semicolon
id|DoC_Address
c_func
(paren
id|this
comma
l_int|3
comma
id|fofs
comma
l_int|0
comma
l_int|0x00
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_FlashControl
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eccbuf
)paren
(brace
multiline_comment|/* init the ECC engine, see Reed-Solomon EDC/ECC 11.1 .*/
id|WriteDOC
c_func
(paren
id|DOC_ECC_RESET
comma
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
id|DOC_ECC_EN
comma
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* disable the ECC engine */
id|WriteDOC
c_func
(paren
id|DOC_ECC_RESET
comma
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
)brace
multiline_comment|/* Let the caller know we completed it */
op_star
id|retlen
op_assign
id|len
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eccbuf
)paren
(brace
multiline_comment|/* Read the data via the internal pipeline through CDSN IO&n;&t;&t;   register, see Pipelined Read Operations 11.3 */
id|MemReadDOC
c_func
(paren
id|docptr
comma
id|buf
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Read the ECC data following raw data */
id|MemReadDOC
c_func
(paren
id|docptr
comma
id|eccbuf
comma
l_int|4
)paren
suffix:semicolon
id|eccbuf
(braket
l_int|4
)braket
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
id|eccbuf
(braket
l_int|5
)braket
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
multiline_comment|/* Flush the pipeline */
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
multiline_comment|/* Check the ECC Status */
r_if
c_cond
(paren
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ECCConf
)paren
op_amp
l_int|0x80
)paren
(brace
r_int
id|nb_errors
suffix:semicolon
multiline_comment|/* There was an ECC error */
macro_line|#ifdef ECC_DEBUG
id|printk
c_func
(paren
l_string|&quot;DiskOnChip ECC Error: Read at %lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|from
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Read the ECC syndrom through the DiskOnChip ECC logic.&n;&t;&t;&t;   These syndrome will be all ZERO when there is no error */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|syndrome
(braket
id|i
)braket
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ECCSyndrome0
op_plus
id|i
)paren
suffix:semicolon
id|nb_errors
op_assign
id|doc_decode_ecc
c_func
(paren
id|buf
comma
id|syndrome
)paren
suffix:semicolon
macro_line|#ifdef ECC_DEBUG
id|printk
c_func
(paren
l_string|&quot;ECC Errors corrected: %x&bslash;n&quot;
comma
id|nb_errors
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|nb_errors
OL
l_int|0
)paren
(brace
multiline_comment|/* We return error, but have actually done the read. Not that&n;&t;&t;&t;&t;   this can be told to user-space, via sys_read(), but at least&n;&t;&t;&t;&t;   MTD-aware stuff can know about it by checking *retlen */
macro_line|#ifdef ECC_DEBUG
id|printk
c_func
(paren
l_string|&quot;%s(%d): Millennium Plus ECC error (from=0x%x:&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
(paren
r_int
)paren
id|from
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;        syndrome= %02x:%02x:%02x:%02x:%02x:&quot;
l_string|&quot;%02x&bslash;n&quot;
comma
id|syndrome
(braket
l_int|0
)braket
comma
id|syndrome
(braket
l_int|1
)braket
comma
id|syndrome
(braket
l_int|2
)braket
comma
id|syndrome
(braket
l_int|3
)braket
comma
id|syndrome
(braket
l_int|4
)braket
comma
id|syndrome
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;          eccbuf= %02x:%02x:%02x:%02x:%02x:&quot;
l_string|&quot;%02x&bslash;n&quot;
comma
id|eccbuf
(braket
l_int|0
)braket
comma
id|eccbuf
(braket
l_int|1
)braket
comma
id|eccbuf
(braket
l_int|2
)braket
comma
id|eccbuf
(braket
l_int|3
)braket
comma
id|eccbuf
(braket
l_int|4
)braket
comma
id|eccbuf
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
)brace
macro_line|#ifdef PSYCHO_DEBUG
id|printk
c_func
(paren
l_string|&quot;ECC DATA at %lx: %2.2X %2.2X %2.2X %2.2X %2.2X %2.2X&bslash;n&quot;
comma
(paren
r_int
)paren
id|from
comma
id|eccbuf
(braket
l_int|0
)braket
comma
id|eccbuf
(braket
l_int|1
)braket
comma
id|eccbuf
(braket
l_int|2
)braket
comma
id|eccbuf
(braket
l_int|3
)braket
comma
id|eccbuf
(braket
l_int|4
)braket
comma
id|eccbuf
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* disable the ECC engine */
id|WriteDOC
c_func
(paren
id|DOC_ECC_DIS
comma
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Read the data via the internal pipeline through CDSN IO&n;&t;&t;   register, see Pipelined Read Operations 11.3 */
id|MemReadDOC
c_func
(paren
id|docptr
comma
id|buf
comma
id|len
op_minus
l_int|2
)paren
suffix:semicolon
id|buf
(braket
id|len
op_minus
l_int|2
)braket
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
id|buf
(braket
id|len
op_minus
l_int|1
)braket
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable flash internally */
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|doc_write
r_static
r_int
id|doc_write
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
(brace
r_char
id|eccbuf
(braket
l_int|6
)braket
suffix:semicolon
r_return
id|doc_write_ecc
c_func
(paren
id|mtd
comma
id|to
comma
id|len
comma
id|retlen
comma
id|buf
comma
id|eccbuf
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|doc_write_ecc
r_static
r_int
id|doc_write_ecc
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
comma
id|u_char
op_star
id|eccbuf
comma
r_struct
id|nand_oobinfo
op_star
id|oobsel
)paren
(brace
r_int
id|i
comma
id|before
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|loff_t
id|fto
suffix:semicolon
r_volatile
r_char
id|dummy
suffix:semicolon
r_struct
id|DiskOnChip
op_star
id|this
op_assign
(paren
r_struct
id|DiskOnChip
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
r_void
id|__iomem
op_star
id|docptr
op_assign
id|this-&gt;virtadr
suffix:semicolon
r_struct
id|Nand
op_star
id|mychip
op_assign
op_amp
id|this-&gt;chips
(braket
id|to
op_rshift
(paren
id|this-&gt;chipshift
)paren
)braket
suffix:semicolon
multiline_comment|/* Don&squot;t allow write past end of device */
r_if
c_cond
(paren
id|to
op_ge
id|this-&gt;totlen
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Don&squot;t allow writes which aren&squot;t exactly one block (512 bytes) */
r_if
c_cond
(paren
(paren
id|to
op_amp
l_int|0x1ff
)paren
op_logical_or
(paren
id|len
op_ne
l_int|0x200
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Determine position of OOB flags, before or after data */
id|before
op_assign
(paren
id|this-&gt;interleave
op_logical_and
(paren
id|to
op_amp
l_int|0x200
)paren
)paren
suffix:semicolon
id|DoC_CheckASIC
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Find the chip which is to be used and select it */
r_if
c_cond
(paren
id|this-&gt;curfloor
op_ne
id|mychip-&gt;floor
)paren
(brace
id|DoC_SelectFloor
c_func
(paren
id|docptr
comma
id|mychip-&gt;floor
)paren
suffix:semicolon
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|this-&gt;curchip
op_ne
id|mychip-&gt;chip
)paren
(brace
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
id|this-&gt;curfloor
op_assign
id|mychip-&gt;floor
suffix:semicolon
id|this-&gt;curchip
op_assign
id|mychip-&gt;chip
suffix:semicolon
multiline_comment|/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */
id|WriteDOC
c_func
(paren
id|DOC_FLASH_CE
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
multiline_comment|/* Reset the chip, see Software Requirement 11.4 item 1. */
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_RESET
comma
l_int|0
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Set device to appropriate plane of flash */
id|fto
op_assign
id|to
suffix:semicolon
id|WriteDOC
c_func
(paren
id|DoC_GetDataOffset
c_func
(paren
id|mtd
comma
op_amp
id|fto
)paren
comma
id|docptr
comma
id|Mplus_FlashCmd
)paren
suffix:semicolon
multiline_comment|/* On interleaved devices the flags for 2nd half 512 are before data */
r_if
c_cond
(paren
id|eccbuf
op_logical_and
id|before
)paren
id|fto
op_sub_assign
l_int|2
suffix:semicolon
multiline_comment|/* issue the Serial Data In command to initial the Page Program process */
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_SEQIN
comma
l_int|0x00
)paren
suffix:semicolon
id|DoC_Address
c_func
(paren
id|this
comma
l_int|3
comma
id|fto
comma
l_int|0x00
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Disable the ECC engine */
id|WriteDOC
c_func
(paren
id|DOC_ECC_RESET
comma
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eccbuf
)paren
(brace
r_if
c_cond
(paren
id|before
)paren
(brace
multiline_comment|/* Write the block status BLOCK_USED (0x5555) */
id|WriteDOC
c_func
(paren
l_int|0x55
comma
id|docptr
comma
id|Mil_CDSN_IO
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
l_int|0x55
comma
id|docptr
comma
id|Mil_CDSN_IO
)paren
suffix:semicolon
)brace
multiline_comment|/* init the ECC engine, see Reed-Solomon EDC/ECC 11.1 .*/
id|WriteDOC
c_func
(paren
id|DOC_ECC_EN
op_or
id|DOC_ECC_RW
comma
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
)brace
id|MemWriteDOC
c_func
(paren
id|docptr
comma
(paren
r_int
r_char
op_star
)paren
id|buf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eccbuf
)paren
(brace
multiline_comment|/* Write ECC data to flash, the ECC info is generated by&n;&t;&t;   the DiskOnChip ECC logic see Reed-Solomon EDC/ECC 11.1 */
id|DoC_Delay
c_func
(paren
id|docptr
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Read the ECC data through the DiskOnChip ECC logic */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|eccbuf
(braket
id|i
)braket
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ECCSyndrome0
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* disable the ECC engine */
id|WriteDOC
c_func
(paren
id|DOC_ECC_DIS
comma
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
multiline_comment|/* Write the ECC data to flash */
id|MemWriteDOC
c_func
(paren
id|docptr
comma
id|eccbuf
comma
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|before
)paren
(brace
multiline_comment|/* Write the block status BLOCK_USED (0x5555) */
id|WriteDOC
c_func
(paren
l_int|0x55
comma
id|docptr
comma
id|Mil_CDSN_IO
op_plus
l_int|6
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
l_int|0x55
comma
id|docptr
comma
id|Mil_CDSN_IO
op_plus
l_int|7
)paren
suffix:semicolon
)brace
macro_line|#ifdef PSYCHO_DEBUG
id|printk
c_func
(paren
l_string|&quot;OOB data at %lx is %2.2X %2.2X %2.2X %2.2X %2.2X %2.2X&bslash;n&quot;
comma
(paren
r_int
)paren
id|to
comma
id|eccbuf
(braket
l_int|0
)braket
comma
id|eccbuf
(braket
l_int|1
)braket
comma
id|eccbuf
(braket
l_int|2
)braket
comma
id|eccbuf
(braket
l_int|3
)braket
comma
id|eccbuf
(braket
l_int|4
)braket
comma
id|eccbuf
(braket
l_int|5
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
id|WriteDOC
c_func
(paren
l_int|0x00
comma
id|docptr
comma
id|Mplus_WritePipeTerm
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
l_int|0x00
comma
id|docptr
comma
id|Mplus_WritePipeTerm
)paren
suffix:semicolon
multiline_comment|/* Commit the Page Program command and wait for ready&n;&t;   see Software Requirement 11.4 item 1.*/
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_PAGEPROG
comma
l_int|0x00
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Read the status of the flash device through CDSN IO register&n;&t;   see Software Requirement 11.4 item 5.*/
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_STATUS
comma
l_int|0
)paren
suffix:semicolon
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
id|DoC_Delay
c_func
(paren
id|docptr
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
)paren
op_amp
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MTD: Error 0x%x programming at 0x%x&bslash;n&quot;
comma
id|dummy
comma
(paren
r_int
)paren
id|to
)paren
suffix:semicolon
multiline_comment|/* Error in programming&n;&t;&t;   FIXME: implement Bad Block Replacement (in nftl.c ??) */
op_star
id|retlen
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
multiline_comment|/* Disable flash internally */
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
multiline_comment|/* Let the caller know we completed it */
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|doc_read_oob
r_static
r_int
id|doc_read_oob
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|ofs
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
(brace
id|loff_t
id|fofs
comma
id|base
suffix:semicolon
r_struct
id|DiskOnChip
op_star
id|this
op_assign
(paren
r_struct
id|DiskOnChip
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
r_void
id|__iomem
op_star
id|docptr
op_assign
id|this-&gt;virtadr
suffix:semicolon
r_struct
id|Nand
op_star
id|mychip
op_assign
op_amp
id|this-&gt;chips
(braket
id|ofs
op_rshift
id|this-&gt;chipshift
)braket
suffix:semicolon
r_int
id|i
comma
id|size
comma
id|got
comma
id|want
suffix:semicolon
id|DoC_CheckASIC
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Find the chip which is to be used and select it */
r_if
c_cond
(paren
id|this-&gt;curfloor
op_ne
id|mychip-&gt;floor
)paren
(brace
id|DoC_SelectFloor
c_func
(paren
id|docptr
comma
id|mychip-&gt;floor
)paren
suffix:semicolon
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|this-&gt;curchip
op_ne
id|mychip-&gt;chip
)paren
(brace
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
id|this-&gt;curfloor
op_assign
id|mychip-&gt;floor
suffix:semicolon
id|this-&gt;curchip
op_assign
id|mychip-&gt;chip
suffix:semicolon
multiline_comment|/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */
id|WriteDOC
c_func
(paren
(paren
id|DOC_FLASH_CE
op_or
id|DOC_FLASH_WP
)paren
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
multiline_comment|/* disable the ECC engine */
id|WriteDOC
c_func
(paren
id|DOC_ECC_RESET
comma
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Maximum of 16 bytes in the OOB region, so limit read to that */
r_if
c_cond
(paren
id|len
OG
l_int|16
)paren
id|len
op_assign
l_int|16
suffix:semicolon
id|got
op_assign
l_int|0
suffix:semicolon
id|want
op_assign
id|len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|i
OL
l_int|3
)paren
op_logical_and
(paren
id|want
OG
l_int|0
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Figure out which region we are accessing... */
id|fofs
op_assign
id|ofs
suffix:semicolon
id|base
op_assign
id|ofs
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|this-&gt;interleave
)paren
(brace
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_READOOB
comma
l_int|0
)paren
suffix:semicolon
id|size
op_assign
l_int|16
op_minus
id|base
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|base
OL
l_int|6
)paren
(brace
id|DoC_Command
c_func
(paren
id|docptr
comma
id|DoC_GetECCOffset
c_func
(paren
id|mtd
comma
op_amp
id|fofs
)paren
comma
l_int|0
)paren
suffix:semicolon
id|size
op_assign
l_int|6
op_minus
id|base
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|base
OL
l_int|8
)paren
(brace
id|DoC_Command
c_func
(paren
id|docptr
comma
id|DoC_GetFlagsOffset
c_func
(paren
id|mtd
comma
op_amp
id|fofs
)paren
comma
l_int|0
)paren
suffix:semicolon
id|size
op_assign
l_int|8
op_minus
id|base
suffix:semicolon
)brace
r_else
(brace
id|DoC_Command
c_func
(paren
id|docptr
comma
id|DoC_GetHdrOffset
c_func
(paren
id|mtd
comma
op_amp
id|fofs
)paren
comma
l_int|0
)paren
suffix:semicolon
id|size
op_assign
l_int|16
op_minus
id|base
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
OG
id|want
)paren
id|size
op_assign
id|want
suffix:semicolon
multiline_comment|/* Issue read command */
id|DoC_Address
c_func
(paren
id|this
comma
l_int|3
comma
id|fofs
comma
l_int|0
comma
l_int|0x00
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_FlashControl
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
id|MemReadDOC
c_func
(paren
id|docptr
comma
op_amp
id|buf
(braket
id|got
)braket
comma
id|size
op_minus
l_int|2
)paren
suffix:semicolon
id|buf
(braket
id|got
op_plus
id|size
op_minus
l_int|2
)braket
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
id|buf
(braket
id|got
op_plus
id|size
op_minus
l_int|1
)braket
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
id|ofs
op_add_assign
id|size
suffix:semicolon
id|got
op_add_assign
id|size
suffix:semicolon
id|want
op_sub_assign
id|size
suffix:semicolon
)brace
multiline_comment|/* Disable flash internally */
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|doc_write_oob
r_static
r_int
id|doc_write_oob
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|ofs
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
(brace
r_volatile
r_char
id|dummy
suffix:semicolon
id|loff_t
id|fofs
comma
id|base
suffix:semicolon
r_struct
id|DiskOnChip
op_star
id|this
op_assign
(paren
r_struct
id|DiskOnChip
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
r_void
id|__iomem
op_star
id|docptr
op_assign
id|this-&gt;virtadr
suffix:semicolon
r_struct
id|Nand
op_star
id|mychip
op_assign
op_amp
id|this-&gt;chips
(braket
id|ofs
op_rshift
id|this-&gt;chipshift
)braket
suffix:semicolon
r_int
id|i
comma
id|size
comma
id|got
comma
id|want
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|DoC_CheckASIC
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Find the chip which is to be used and select it */
r_if
c_cond
(paren
id|this-&gt;curfloor
op_ne
id|mychip-&gt;floor
)paren
(brace
id|DoC_SelectFloor
c_func
(paren
id|docptr
comma
id|mychip-&gt;floor
)paren
suffix:semicolon
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|this-&gt;curchip
op_ne
id|mychip-&gt;chip
)paren
(brace
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
id|this-&gt;curfloor
op_assign
id|mychip-&gt;floor
suffix:semicolon
id|this-&gt;curchip
op_assign
id|mychip-&gt;chip
suffix:semicolon
multiline_comment|/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */
id|WriteDOC
c_func
(paren
id|DOC_FLASH_CE
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
multiline_comment|/* Maximum of 16 bytes in the OOB region, so limit write to that */
r_if
c_cond
(paren
id|len
OG
l_int|16
)paren
id|len
op_assign
l_int|16
suffix:semicolon
id|got
op_assign
l_int|0
suffix:semicolon
id|want
op_assign
id|len
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|i
OL
l_int|3
)paren
op_logical_and
(paren
id|want
OG
l_int|0
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Reset the chip, see Software Requirement 11.4 item 1. */
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_RESET
comma
l_int|0
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Figure out which region we are accessing... */
id|fofs
op_assign
id|ofs
suffix:semicolon
id|base
op_assign
id|ofs
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|this-&gt;interleave
)paren
(brace
id|WriteDOC
c_func
(paren
id|NAND_CMD_READOOB
comma
id|docptr
comma
id|Mplus_FlashCmd
)paren
suffix:semicolon
id|size
op_assign
l_int|16
op_minus
id|base
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|base
OL
l_int|6
)paren
(brace
id|WriteDOC
c_func
(paren
id|DoC_GetECCOffset
c_func
(paren
id|mtd
comma
op_amp
id|fofs
)paren
comma
id|docptr
comma
id|Mplus_FlashCmd
)paren
suffix:semicolon
id|size
op_assign
l_int|6
op_minus
id|base
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|base
OL
l_int|8
)paren
(brace
id|WriteDOC
c_func
(paren
id|DoC_GetFlagsOffset
c_func
(paren
id|mtd
comma
op_amp
id|fofs
)paren
comma
id|docptr
comma
id|Mplus_FlashCmd
)paren
suffix:semicolon
id|size
op_assign
l_int|8
op_minus
id|base
suffix:semicolon
)brace
r_else
(brace
id|WriteDOC
c_func
(paren
id|DoC_GetHdrOffset
c_func
(paren
id|mtd
comma
op_amp
id|fofs
)paren
comma
id|docptr
comma
id|Mplus_FlashCmd
)paren
suffix:semicolon
id|size
op_assign
l_int|16
op_minus
id|base
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
OG
id|want
)paren
id|size
op_assign
id|want
suffix:semicolon
multiline_comment|/* Issue the Serial Data In command to initial the Page Program process */
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_SEQIN
comma
l_int|0x00
)paren
suffix:semicolon
id|DoC_Address
c_func
(paren
id|this
comma
l_int|3
comma
id|fofs
comma
l_int|0
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Disable the ECC engine */
id|WriteDOC
c_func
(paren
id|DOC_ECC_RESET
comma
id|docptr
comma
id|Mplus_ECCConf
)paren
suffix:semicolon
multiline_comment|/* Write the data via the internal pipeline through CDSN IO&n;&t;&t;   register, see Pipelined Write Operations 11.2 */
id|MemWriteDOC
c_func
(paren
id|docptr
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|buf
(braket
id|got
)braket
comma
id|size
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
l_int|0x00
comma
id|docptr
comma
id|Mplus_WritePipeTerm
)paren
suffix:semicolon
id|WriteDOC
c_func
(paren
l_int|0x00
comma
id|docptr
comma
id|Mplus_WritePipeTerm
)paren
suffix:semicolon
multiline_comment|/* Commit the Page Program command and wait for ready&n;&t; &t;   see Software Requirement 11.4 item 1.*/
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_PAGEPROG
comma
l_int|0x00
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
multiline_comment|/* Read the status of the flash device through CDSN IO register&n;&t;&t;   see Software Requirement 11.4 item 5.*/
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_STATUS
comma
l_int|0x00
)paren
suffix:semicolon
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
id|DoC_Delay
c_func
(paren
id|docptr
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
)paren
op_amp
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MTD: Error 0x%x programming oob at 0x%x&bslash;n&quot;
comma
id|dummy
comma
(paren
r_int
)paren
id|ofs
)paren
suffix:semicolon
multiline_comment|/* FIXME: implement Bad Block Replacement */
op_star
id|retlen
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
id|ofs
op_add_assign
id|size
suffix:semicolon
id|got
op_add_assign
id|size
suffix:semicolon
id|want
op_sub_assign
id|size
suffix:semicolon
)brace
multiline_comment|/* Disable flash internally */
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|doc_erase
r_int
id|doc_erase
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_struct
id|erase_info
op_star
id|instr
)paren
(brace
r_volatile
r_char
id|dummy
suffix:semicolon
r_struct
id|DiskOnChip
op_star
id|this
op_assign
(paren
r_struct
id|DiskOnChip
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
id|__u32
id|ofs
op_assign
id|instr-&gt;addr
suffix:semicolon
id|__u32
id|len
op_assign
id|instr-&gt;len
suffix:semicolon
r_void
id|__iomem
op_star
id|docptr
op_assign
id|this-&gt;virtadr
suffix:semicolon
r_struct
id|Nand
op_star
id|mychip
op_assign
op_amp
id|this-&gt;chips
(braket
id|ofs
op_rshift
id|this-&gt;chipshift
)braket
suffix:semicolon
id|DoC_CheckASIC
c_func
(paren
id|docptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
id|mtd-&gt;erasesize
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;MTD: Erase not right size (%x != %x)n&quot;
comma
id|len
comma
id|mtd-&gt;erasesize
)paren
suffix:semicolon
multiline_comment|/* Find the chip which is to be used and select it */
r_if
c_cond
(paren
id|this-&gt;curfloor
op_ne
id|mychip-&gt;floor
)paren
(brace
id|DoC_SelectFloor
c_func
(paren
id|docptr
comma
id|mychip-&gt;floor
)paren
suffix:semicolon
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|this-&gt;curchip
op_ne
id|mychip-&gt;chip
)paren
(brace
id|DoC_SelectChip
c_func
(paren
id|docptr
comma
id|mychip-&gt;chip
)paren
suffix:semicolon
)brace
id|this-&gt;curfloor
op_assign
id|mychip-&gt;floor
suffix:semicolon
id|this-&gt;curchip
op_assign
id|mychip-&gt;chip
suffix:semicolon
id|instr-&gt;state
op_assign
id|MTD_ERASE_PENDING
suffix:semicolon
multiline_comment|/* Millennium Plus bus cycle sequence as per figure 2, section 2.4 */
id|WriteDOC
c_func
(paren
id|DOC_FLASH_CE
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_RESET
comma
l_int|0x00
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_ERASE1
comma
l_int|0
)paren
suffix:semicolon
id|DoC_Address
c_func
(paren
id|this
comma
l_int|2
comma
id|ofs
comma
l_int|0
comma
l_int|0x00
)paren
suffix:semicolon
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_ERASE2
comma
l_int|0
)paren
suffix:semicolon
id|DoC_WaitReady
c_func
(paren
id|docptr
)paren
suffix:semicolon
id|instr-&gt;state
op_assign
id|MTD_ERASING
suffix:semicolon
multiline_comment|/* Read the status of the flash device through CDSN IO register&n;&t;   see Software Requirement 11.4 item 5. */
id|DoC_Command
c_func
(paren
id|docptr
comma
id|NAND_CMD_STATUS
comma
l_int|0
)paren
suffix:semicolon
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_ReadPipeInit
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
)paren
op_amp
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MTD: Error 0x%x erasing at 0x%x&bslash;n&quot;
comma
id|dummy
comma
id|ofs
)paren
suffix:semicolon
multiline_comment|/* FIXME: implement Bad Block Replacement (in nftl.c ??) */
id|instr-&gt;state
op_assign
id|MTD_ERASE_FAILED
suffix:semicolon
)brace
r_else
(brace
id|instr-&gt;state
op_assign
id|MTD_ERASE_DONE
suffix:semicolon
)brace
id|dummy
op_assign
id|ReadDOC
c_func
(paren
id|docptr
comma
id|Mplus_LastDataRead
)paren
suffix:semicolon
multiline_comment|/* Disable flash internally */
id|WriteDOC
c_func
(paren
l_int|0
comma
id|docptr
comma
id|Mplus_FlashSelect
)paren
suffix:semicolon
id|mtd_erase_callback
c_func
(paren
id|instr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * Module stuff&n; *&n; ****************************************************************************/
DECL|function|init_doc2001plus
r_static
r_int
id|__init
id|init_doc2001plus
c_func
(paren
r_void
)paren
(brace
id|inter_module_register
c_func
(paren
id|im_name
comma
id|THIS_MODULE
comma
op_amp
id|DoCMilPlus_init
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_doc2001plus
r_static
r_void
id|__exit
id|cleanup_doc2001plus
c_func
(paren
r_void
)paren
(brace
r_struct
id|mtd_info
op_star
id|mtd
suffix:semicolon
r_struct
id|DiskOnChip
op_star
id|this
suffix:semicolon
r_while
c_loop
(paren
(paren
id|mtd
op_assign
id|docmilpluslist
)paren
)paren
(brace
id|this
op_assign
(paren
r_struct
id|DiskOnChip
op_star
)paren
id|mtd-&gt;priv
suffix:semicolon
id|docmilpluslist
op_assign
id|this-&gt;nextdoc
suffix:semicolon
id|del_mtd_device
c_func
(paren
id|mtd
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|this-&gt;virtadr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|this-&gt;chips
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mtd
)paren
suffix:semicolon
)brace
id|inter_module_unregister
c_func
(paren
id|im_name
)paren
suffix:semicolon
)brace
DECL|variable|cleanup_doc2001plus
id|module_exit
c_func
(paren
id|cleanup_doc2001plus
)paren
suffix:semicolon
DECL|variable|init_doc2001plus
id|module_init
c_func
(paren
id|init_doc2001plus
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Greg Ungerer &lt;gerg@snapgear.com&gt; et al.&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for DiskOnChip Millennium Plus&quot;
)paren
suffix:semicolon
eof
