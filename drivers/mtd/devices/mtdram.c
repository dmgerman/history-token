multiline_comment|/*&n; * mtdram - a test mtd device&n; * $Id: mtdram.c,v 1.32 2003/05/21 15:15:07 dwmw2 Exp $&n; * Author: Alexander Larsson &lt;alex@cendio.se&gt;&n; *&n; * Copyright (c) 1999 Alexander Larsson &lt;alex@cendio.se&gt;&n; *&n; * This code is GPL&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mtd/compatmac.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#ifndef CONFIG_MTDRAM_ABS_POS
DECL|macro|CONFIG_MTDRAM_ABS_POS
mdefine_line|#define CONFIG_MTDRAM_ABS_POS 0
macro_line|#endif
macro_line|#if CONFIG_MTDRAM_ABS_POS &gt; 0
macro_line|#include &lt;asm/io.h&gt;
macro_line|#endif
macro_line|#ifdef MODULE
DECL|variable|total_size
r_static
r_int
r_int
id|total_size
op_assign
id|CONFIG_MTDRAM_TOTAL_SIZE
suffix:semicolon
DECL|variable|erase_size
r_static
r_int
r_int
id|erase_size
op_assign
id|CONFIG_MTDRAM_ERASE_SIZE
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|total_size
comma
l_string|&quot;l&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|total_size
comma
l_string|&quot;Total device size in KiB&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|erase_size
comma
l_string|&quot;l&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|erase_size
comma
l_string|&quot;Device erase block size in KiB&quot;
)paren
suffix:semicolon
DECL|macro|MTDRAM_TOTAL_SIZE
mdefine_line|#define MTDRAM_TOTAL_SIZE (total_size * 1024)
DECL|macro|MTDRAM_ERASE_SIZE
mdefine_line|#define MTDRAM_ERASE_SIZE (erase_size * 1024)
macro_line|#else
DECL|macro|MTDRAM_TOTAL_SIZE
mdefine_line|#define MTDRAM_TOTAL_SIZE (CONFIG_MTDRAM_TOTAL_SIZE * 1024)
DECL|macro|MTDRAM_ERASE_SIZE
mdefine_line|#define MTDRAM_ERASE_SIZE (CONFIG_MTDRAM_ERASE_SIZE * 1024)
macro_line|#endif
singleline_comment|// We could store these in the mtd structure, but we only support 1 device..
DECL|variable|mtd_info
r_static
r_struct
id|mtd_info
op_star
id|mtd_info
suffix:semicolon
r_static
r_int
DECL|function|ram_erase
id|ram_erase
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_struct
id|erase_info
op_star
id|instr
)paren
(brace
id|DEBUG
c_func
(paren
id|MTD_DEBUG_LEVEL2
comma
l_string|&quot;ram_erase(pos:%ld, len:%ld)&bslash;n&quot;
comma
(paren
r_int
)paren
id|instr-&gt;addr
comma
(paren
r_int
)paren
id|instr-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;addr
op_plus
id|instr-&gt;len
OG
id|mtd-&gt;size
)paren
(brace
id|DEBUG
c_func
(paren
id|MTD_DEBUG_LEVEL1
comma
l_string|&quot;ram_erase() out of bounds (%ld &gt; %ld)&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|instr-&gt;addr
op_plus
id|instr-&gt;len
)paren
comma
(paren
r_int
)paren
id|mtd-&gt;size
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|mtd-&gt;priv
op_plus
id|instr-&gt;addr
comma
l_int|0xff
comma
id|instr-&gt;len
)paren
suffix:semicolon
id|instr-&gt;state
op_assign
id|MTD_ERASE_DONE
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;callback
)paren
(paren
op_star
(paren
id|instr-&gt;callback
)paren
)paren
(paren
id|instr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ram_point
r_static
r_int
id|ram_point
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
op_star
id|mtdbuf
)paren
(brace
r_if
c_cond
(paren
id|from
op_plus
id|len
OG
id|mtd-&gt;size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|mtdbuf
op_assign
id|mtd-&gt;priv
op_plus
id|from
suffix:semicolon
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ram_unpoint
r_static
r_void
id|ram_unpoint
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|u_char
op_star
id|addr
comma
id|loff_t
id|from
comma
r_int
id|len
)paren
(brace
id|DEBUG
c_func
(paren
id|MTD_DEBUG_LEVEL2
comma
l_string|&quot;ram_unpoint&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ram_read
r_static
r_int
id|ram_read
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|from
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
id|u_char
op_star
id|buf
)paren
(brace
id|DEBUG
c_func
(paren
id|MTD_DEBUG_LEVEL2
comma
l_string|&quot;ram_read(pos:%ld, len:%ld)&bslash;n&quot;
comma
(paren
r_int
)paren
id|from
comma
(paren
r_int
)paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from
op_plus
id|len
OG
id|mtd-&gt;size
)paren
(brace
id|DEBUG
c_func
(paren
id|MTD_DEBUG_LEVEL1
comma
l_string|&quot;ram_read() out of bounds (%ld &gt; %ld)&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|from
op_plus
id|len
)paren
comma
(paren
r_int
)paren
id|mtd-&gt;size
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|buf
comma
id|mtd-&gt;priv
op_plus
id|from
comma
id|len
)paren
suffix:semicolon
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ram_write
r_static
r_int
id|ram_write
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
id|loff_t
id|to
comma
r_int
id|len
comma
r_int
op_star
id|retlen
comma
r_const
id|u_char
op_star
id|buf
)paren
(brace
id|DEBUG
c_func
(paren
id|MTD_DEBUG_LEVEL2
comma
l_string|&quot;ram_write(pos:%ld, len:%ld)&bslash;n&quot;
comma
(paren
r_int
)paren
id|to
comma
(paren
r_int
)paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|to
op_plus
id|len
OG
id|mtd-&gt;size
)paren
(brace
id|DEBUG
c_func
(paren
id|MTD_DEBUG_LEVEL1
comma
l_string|&quot;ram_write() out of bounds (%ld &gt; %ld)&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|to
op_plus
id|len
)paren
comma
(paren
r_int
)paren
id|mtd-&gt;size
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memcpy
(paren
(paren
r_char
op_star
)paren
id|mtd-&gt;priv
op_plus
id|to
comma
id|buf
comma
id|len
)paren
suffix:semicolon
op_star
id|retlen
op_assign
id|len
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_mtdram
r_static
r_void
id|__exit
id|cleanup_mtdram
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|mtd_info
)paren
(brace
id|del_mtd_device
c_func
(paren
id|mtd_info
)paren
suffix:semicolon
macro_line|#if CONFIG_MTDRAM_TOTAL_SIZE &gt; 0
r_if
c_cond
(paren
id|mtd_info-&gt;priv
)paren
macro_line|#if CONFIG_MTDRAM_ABS_POS &gt; 0
id|iounmap
c_func
(paren
id|mtd_info-&gt;priv
)paren
suffix:semicolon
macro_line|#else
id|vfree
c_func
(paren
id|mtd_info-&gt;priv
)paren
suffix:semicolon
macro_line|#endif&t;
macro_line|#endif
id|kfree
c_func
(paren
id|mtd_info
)paren
suffix:semicolon
)brace
)brace
DECL|function|mtdram_init_device
r_int
id|mtdram_init_device
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
comma
r_void
op_star
id|mapped_address
comma
r_int
r_int
id|size
comma
r_char
op_star
id|name
)paren
(brace
id|memset
c_func
(paren
id|mtd
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mtd
)paren
)paren
suffix:semicolon
multiline_comment|/* Setup the MTD structure */
id|mtd-&gt;name
op_assign
id|name
suffix:semicolon
id|mtd-&gt;type
op_assign
id|MTD_RAM
suffix:semicolon
id|mtd-&gt;flags
op_assign
id|MTD_CAP_RAM
suffix:semicolon
id|mtd-&gt;size
op_assign
id|size
suffix:semicolon
id|mtd-&gt;erasesize
op_assign
id|MTDRAM_ERASE_SIZE
suffix:semicolon
id|mtd-&gt;priv
op_assign
id|mapped_address
suffix:semicolon
id|mtd-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|mtd-&gt;erase
op_assign
id|ram_erase
suffix:semicolon
id|mtd-&gt;point
op_assign
id|ram_point
suffix:semicolon
id|mtd-&gt;unpoint
op_assign
id|ram_unpoint
suffix:semicolon
id|mtd-&gt;read
op_assign
id|ram_read
suffix:semicolon
id|mtd-&gt;write
op_assign
id|ram_write
suffix:semicolon
r_if
c_cond
(paren
id|add_mtd_device
c_func
(paren
id|mtd
)paren
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if CONFIG_MTDRAM_TOTAL_SIZE &gt; 0
macro_line|#if CONFIG_MTDRAM_ABS_POS &gt; 0
DECL|function|init_mtdram
r_int
id|__init
id|init_mtdram
c_func
(paren
r_void
)paren
(brace
r_void
op_star
id|addr
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Allocate some memory */
id|mtd_info
op_assign
(paren
r_struct
id|mtd_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mtd_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mtd_info
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|addr
op_assign
id|ioremap
c_func
(paren
id|CONFIG_MTDRAM_ABS_POS
comma
id|MTDRAM_TOTAL_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
(brace
id|DEBUG
c_func
(paren
id|MTD_DEBUG_LEVEL1
comma
l_string|&quot;Failed to ioremap) memory region of size %ld at ABS_POS:%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|MTDRAM_TOTAL_SIZE
comma
(paren
r_int
)paren
id|CONFIG_MTDRAM_ABS_POS
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mtd_info
)paren
suffix:semicolon
id|mtd_info
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|err
op_assign
id|mtdram_init_device
c_func
(paren
id|mtd_info
comma
id|addr
comma
id|MTDRAM_TOTAL_SIZE
comma
l_string|&quot;mtdram test device&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|iounmap
c_func
(paren
id|addr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mtd_info
)paren
suffix:semicolon
id|mtd_info
op_assign
l_int|NULL
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mtd_info-&gt;priv
comma
l_int|0xff
comma
id|MTDRAM_TOTAL_SIZE
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
macro_line|#else /* CONFIG_MTDRAM_ABS_POS &gt; 0 */
DECL|function|init_mtdram
r_int
id|__init
id|init_mtdram
c_func
(paren
r_void
)paren
(brace
r_void
op_star
id|addr
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Allocate some memory */
id|mtd_info
op_assign
(paren
r_struct
id|mtd_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mtd_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mtd_info
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|addr
op_assign
id|vmalloc
c_func
(paren
id|MTDRAM_TOTAL_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
(brace
id|DEBUG
c_func
(paren
id|MTD_DEBUG_LEVEL1
comma
l_string|&quot;Failed to vmalloc memory region of size %ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|MTDRAM_TOTAL_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mtd_info
)paren
suffix:semicolon
id|mtd_info
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|err
op_assign
id|mtdram_init_device
c_func
(paren
id|mtd_info
comma
id|addr
comma
id|MTDRAM_TOTAL_SIZE
comma
l_string|&quot;mtdram test device&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|vfree
c_func
(paren
id|addr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mtd_info
)paren
suffix:semicolon
id|mtd_info
op_assign
l_int|NULL
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mtd_info-&gt;priv
comma
l_int|0xff
comma
id|MTDRAM_TOTAL_SIZE
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
macro_line|#endif /* !(CONFIG_MTDRAM_ABS_POS &gt; 0) */
macro_line|#else /* CONFIG_MTDRAM_TOTAL_SIZE &gt; 0 */
DECL|function|init_mtdram
r_int
id|__init
id|init_mtdram
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* !(CONFIG_MTDRAM_TOTAL_SIZE &gt; 0) */
DECL|variable|init_mtdram
id|module_init
c_func
(paren
id|init_mtdram
)paren
suffix:semicolon
DECL|variable|cleanup_mtdram
id|module_exit
c_func
(paren
id|cleanup_mtdram
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Alexander Larsson &lt;alexl@redhat.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Simulated MTD driver for testing&quot;
)paren
suffix:semicolon
eof
