multiline_comment|/*&n; * Read flash partition table from Compaq Bootloader&n; *&n; * Copyright 2001 Compaq Computer Corporation.&n; *&n; * $Id: bootldr.c,v 1.4 2001/06/02 18:24:27 nico Exp $&n; *&n; * Use consistent with the GNU GPL is permitted,&n; * provided that this copyright notice is&n; * preserved in its entirety in all copies and derived works.&n; *&n; * COMPAQ COMPUTER CORPORATION MAKES NO WARRANTIES, EXPRESSED OR IMPLIED,&n; * AS TO THE USEFULNESS OR CORRECTNESS OF THIS CODE OR ITS&n; * FITNESS FOR ANY PARTICULAR PURPOSE.&n; *&n; */
multiline_comment|/*&n; * Maintainer: Jamey Hicks (jamey.hicks@compaq.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/mtd/partitions.h&gt;
DECL|macro|FLASH_PARTITION_NAMELEN
mdefine_line|#define FLASH_PARTITION_NAMELEN 32
DECL|enum|LFR_FLAGS
r_enum
id|LFR_FLAGS
(brace
DECL|enumerator|LFR_SIZE_PREFIX
id|LFR_SIZE_PREFIX
op_assign
l_int|1
comma
multiline_comment|/* prefix data with 4-byte size */
DECL|enumerator|LFR_PATCH_BOOTLDR
id|LFR_PATCH_BOOTLDR
op_assign
l_int|2
comma
multiline_comment|/* patch bootloader&squot;s 0th instruction */
DECL|enumerator|LFR_KERNEL
id|LFR_KERNEL
op_assign
l_int|4
comma
multiline_comment|/* add BOOTIMG_MAGIC, imgsize and VKERNEL_BASE to head of programmed region (see bootldr.c) */
DECL|enumerator|LFR_EXPAND
id|LFR_EXPAND
op_assign
l_int|8
multiline_comment|/* expand partition size to fit rest of flash */
)brace
suffix:semicolon
DECL|struct|FlashRegion
r_typedef
r_struct
id|FlashRegion
(brace
DECL|member|name
r_char
id|name
(braket
id|FLASH_PARTITION_NAMELEN
)braket
suffix:semicolon
DECL|member|base
r_int
r_int
id|base
suffix:semicolon
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
DECL|member|flags
r_enum
id|LFR_FLAGS
id|flags
suffix:semicolon
DECL|typedef|FlashRegion
)brace
id|FlashRegion
suffix:semicolon
DECL|struct|BootldrFlashPartitionTable
r_typedef
r_struct
id|BootldrFlashPartitionTable
(brace
DECL|member|magic
r_int
id|magic
suffix:semicolon
multiline_comment|/* should be filled with 0x646c7470 (btlp) BOOTLDR_PARTITION_MAGIC */
DECL|member|npartitions
r_int
id|npartitions
suffix:semicolon
DECL|member|partition
r_struct
id|FlashRegion
id|partition
(braket
l_int|0
)braket
suffix:semicolon
DECL|typedef|BootldrFlashPartitionTable
)brace
id|BootldrFlashPartitionTable
suffix:semicolon
DECL|macro|BOOTLDR_MAGIC
mdefine_line|#define BOOTLDR_MAGIC      0x646c7462        /* btld: marks a valid bootldr image */
DECL|macro|BOOTLDR_PARTITION_MAGIC
mdefine_line|#define BOOTLDR_PARTITION_MAGIC  0x646c7470  /* btlp: marks a valid bootldr partition table in params sector */
DECL|macro|BOOTLDR_MAGIC_OFFSET
mdefine_line|#define BOOTLDR_MAGIC_OFFSET 0x20 /* offset 0x20 into the bootldr */
DECL|macro|BOOTCAP_OFFSET
mdefine_line|#define BOOTCAP_OFFSET 0X30 /* offset 0x30 into the bootldr */
DECL|macro|BOOTCAP_WAKEUP
mdefine_line|#define BOOTCAP_WAKEUP&t;(1&lt;&lt;0)
DECL|macro|BOOTCAP_PARTITIONS
mdefine_line|#define BOOTCAP_PARTITIONS (1&lt;&lt;1) /* partition table stored in params sector */
DECL|macro|BOOTCAP_PARAMS_AFTER_BOOTLDR
mdefine_line|#define BOOTCAP_PARAMS_AFTER_BOOTLDR (1&lt;&lt;2) /* params sector right after bootldr sector(s), else in last sector */
DECL|function|parse_bootldr_partitions
r_int
id|parse_bootldr_partitions
c_func
(paren
r_struct
id|mtd_info
op_star
id|master
comma
r_struct
id|mtd_partition
op_star
op_star
id|pparts
)paren
(brace
r_struct
id|mtd_partition
op_star
id|parts
suffix:semicolon
r_int
id|ret
comma
id|retlen
comma
id|i
suffix:semicolon
r_int
id|npartitions
op_assign
l_int|0
suffix:semicolon
r_int
id|partition_table_offset
suffix:semicolon
r_int
id|bootmagic
op_assign
l_int|0
suffix:semicolon
r_int
id|bootcap
op_assign
l_int|0
suffix:semicolon
r_int
id|namelen
op_assign
l_int|0
suffix:semicolon
r_struct
id|BootldrFlashPartitionTable
op_star
id|partition_table
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|names
suffix:semicolon
multiline_comment|/* verify bootldr magic */
id|ret
op_assign
id|master
op_member_access_from_pointer
id|read
c_func
(paren
id|master
comma
id|BOOTLDR_MAGIC_OFFSET
comma
r_sizeof
(paren
r_int
)paren
comma
op_amp
id|retlen
comma
(paren
r_void
op_star
)paren
op_amp
id|bootmagic
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|bootmagic
op_ne
id|BOOTLDR_MAGIC
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* see if bootldr supports partition tables and where to find the partition table */
id|ret
op_assign
id|master
op_member_access_from_pointer
id|read
c_func
(paren
id|master
comma
id|BOOTCAP_OFFSET
comma
r_sizeof
(paren
r_int
)paren
comma
op_amp
id|retlen
comma
(paren
r_void
op_star
)paren
op_amp
id|bootcap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bootcap
op_amp
id|BOOTCAP_PARTITIONS
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|bootcap
op_amp
id|BOOTCAP_PARAMS_AFTER_BOOTLDR
)paren
id|partition_table_offset
op_assign
id|master-&gt;erasesize
suffix:semicolon
r_else
id|partition_table_offset
op_assign
id|master-&gt;size
op_minus
id|master-&gt;erasesize
suffix:semicolon
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;: partition_table_offset=%#lx&bslash;n&quot;
comma
id|partition_table_offset
)paren
suffix:semicolon
multiline_comment|/* Read the partition table */
id|partition_table
op_assign
(paren
r_struct
id|BootldrFlashPartitionTable
op_star
)paren
id|kmalloc
c_func
(paren
id|PAGE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|partition_table
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ret
op_assign
id|master
op_member_access_from_pointer
id|read
c_func
(paren
id|master
comma
id|partition_table_offset
comma
id|PAGE_SIZE
comma
op_amp
id|retlen
comma
(paren
r_void
op_star
)paren
id|partition_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;: magic=%#x&bslash;n&quot;
comma
id|partition_table-&gt;magic
)paren
suffix:semicolon
multiline_comment|/* check for partition table magic number */
r_if
c_cond
(paren
id|partition_table-&gt;magic
op_ne
id|BOOTLDR_PARTITION_MAGIC
)paren
r_goto
id|out
suffix:semicolon
id|npartitions
op_assign
id|partition_table-&gt;npartitions
suffix:semicolon
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;: npartitions=%#x&bslash;n&quot;
comma
id|npartitions
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npartitions
suffix:semicolon
id|i
op_increment
)paren
(brace
id|namelen
op_add_assign
id|strlen
c_func
(paren
id|partition_table-&gt;partition
(braket
id|i
)braket
dot
id|name
)paren
op_plus
l_int|1
suffix:semicolon
)brace
id|parts
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|parts
)paren
op_star
id|npartitions
op_plus
id|namelen
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parts
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|names
op_assign
(paren
r_char
op_star
)paren
op_amp
id|parts
(braket
id|npartitions
)braket
suffix:semicolon
id|memset
c_func
(paren
id|parts
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|parts
)paren
op_star
id|npartitions
op_plus
id|namelen
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|npartitions
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|FlashRegion
op_star
id|partition
op_assign
op_amp
id|partition_table-&gt;partition
(braket
id|i
)braket
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|partition-&gt;name
suffix:semicolon
id|parts
(braket
id|i
)braket
dot
id|name
op_assign
id|names
suffix:semicolon
id|names
op_add_assign
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|parts
(braket
id|i
)braket
dot
id|name
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|partition-&gt;flags
op_amp
id|LFR_EXPAND
)paren
id|parts
(braket
id|i
)braket
dot
id|size
op_assign
id|MTDPART_SIZ_FULL
suffix:semicolon
r_else
id|parts
(braket
id|i
)braket
dot
id|size
op_assign
id|partition-&gt;size
suffix:semicolon
id|parts
(braket
id|i
)braket
dot
id|offset
op_assign
id|partition-&gt;base
suffix:semicolon
id|parts
(braket
id|i
)braket
dot
id|mask_flags
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;        partition %s o=%x s=%x&bslash;n&quot;
comma
id|parts
(braket
id|i
)braket
dot
id|name
comma
id|parts
(braket
id|i
)braket
dot
id|offset
comma
id|parts
(braket
id|i
)braket
dot
id|size
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|npartitions
suffix:semicolon
op_star
id|pparts
op_assign
id|parts
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|partition_table
)paren
id|kfree
c_func
(paren
id|partition_table
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|parse_bootldr_partitions
id|EXPORT_SYMBOL
c_func
(paren
id|parse_bootldr_partitions
)paren
suffix:semicolon
eof
