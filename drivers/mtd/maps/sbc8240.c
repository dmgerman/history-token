multiline_comment|/*&n; * Handle mapping of the flash memory access routines on the SBC8240 board.&n; *&n; * Carolyn Smith, Tektronix, Inc.&n; *&n; * This code is GPLed&n; *&n; * $Id: sbc8240.c,v 1.4 2004/07/12 22:38:29 dwmw2 Exp $&n; *&n; */
multiline_comment|/*&n; * The SBC8240 has 2 flash banks.&n; * Bank 0 is a 512 KiB AMD AM29F040B; 8 x 64 KiB sectors.&n; * It contains the U-Boot code (7 sectors) and the environment (1 sector).&n; * Bank 1 is 4 x 1 MiB AMD AM29LV800BT; 15 x 64 KiB sectors, 1 x 32 KiB sector,&n; * 2 x 8 KiB sectors, 1 x 16 KiB sectors.&n; * Both parts are JEDEC compatible.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
macro_line|#include &lt;linux/mtd/cfi.h&gt;
macro_line|#ifdef CONFIG_MTD_PARTITIONS
macro_line|#include &lt;linux/mtd/partitions.h&gt;
macro_line|#endif
DECL|macro|DEBUG
mdefine_line|#define&t;DEBUG
macro_line|#ifdef&t;DEBUG
DECL|macro|debugk
macro_line|# define debugk(fmt,args...)&t;printk(fmt ,##args)
macro_line|#else
DECL|macro|debugk
macro_line|# define debugk(fmt,args...)
macro_line|#endif
DECL|macro|WINDOW_ADDR0
mdefine_line|#define WINDOW_ADDR0&t;0xFFF00000&t;&t;/* 512 KiB */
DECL|macro|WINDOW_SIZE0
mdefine_line|#define WINDOW_SIZE0&t;0x00080000
DECL|macro|BUSWIDTH0
mdefine_line|#define BUSWIDTH0&t;1
DECL|macro|WINDOW_ADDR1
mdefine_line|#define WINDOW_ADDR1&t;0xFF000000&t;&t;/* 4 MiB */
DECL|macro|WINDOW_SIZE1
mdefine_line|#define WINDOW_SIZE1&t;0x00400000
DECL|macro|BUSWIDTH1
mdefine_line|#define BUSWIDTH1&t;8
DECL|macro|MSG_PREFIX
mdefine_line|#define MSG_PREFIX &quot;sbc8240:&quot;&t;/* prefix for our printk()&squot;s */
DECL|macro|MTDID
mdefine_line|#define MTDID&t;   &quot;sbc8240-%d&quot;&t;/* for mtdparts= partitioning */
DECL|variable|sbc8240_map
r_static
r_struct
id|map_info
id|sbc8240_map
(braket
l_int|2
)braket
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;sbc8240 Flash Bank #0&quot;
comma
dot
id|size
op_assign
id|WINDOW_SIZE0
comma
dot
id|bankwidth
op_assign
id|BUSWIDTH0
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;sbc8240 Flash Bank #1&quot;
comma
dot
id|size
op_assign
id|WINDOW_SIZE1
comma
dot
id|bankwidth
op_assign
id|BUSWIDTH1
comma
)brace
)brace
suffix:semicolon
DECL|macro|NUM_FLASH_BANKS
mdefine_line|#define NUM_FLASH_BANKS&t;(sizeof(sbc8240_map) / sizeof(struct map_info))
multiline_comment|/*&n; * The following defines the partition layout of SBC8240 boards.&n; *&n; * See include/linux/mtd/partitions.h for definition of the&n; * mtd_partition structure.&n; *&n; * The *_max_flash_size is the maximum possible mapped flash size&n; * which is not necessarily the actual flash size. It must correspond&n; * to the value specified in the mapping definition defined by the&n; * &quot;struct map_desc *_io_desc&quot; for the corresponding machine.&n; */
macro_line|#ifdef CONFIG_MTD_PARTITIONS
DECL|variable|sbc8240_uboot_partitions
r_static
r_struct
id|mtd_partition
id|sbc8240_uboot_partitions
(braket
)braket
op_assign
(brace
multiline_comment|/* Bank 0 */
(brace
dot
id|name
op_assign
l_string|&quot;U-boot&quot;
comma
multiline_comment|/* U-Boot Firmware&t;*/
dot
id|offset
op_assign
l_int|0
comma
dot
id|size
op_assign
l_int|0x00070000
comma
multiline_comment|/*  7 x 64 KiB sectors &t;*/
dot
id|mask_flags
op_assign
id|MTD_WRITEABLE
comma
multiline_comment|/*  force read-only&t;*/
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;environment&quot;
comma
multiline_comment|/* U-Boot environment&t;*/
dot
id|offset
op_assign
l_int|0x00070000
comma
dot
id|size
op_assign
l_int|0x00010000
comma
multiline_comment|/*  1 x 64 KiB sector&t;*/
)brace
comma
)brace
suffix:semicolon
DECL|variable|sbc8240_fs_partitions
r_static
r_struct
id|mtd_partition
id|sbc8240_fs_partitions
(braket
)braket
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;jffs&quot;
comma
multiline_comment|/* JFFS  filesystem&t;*/
dot
id|offset
op_assign
l_int|0
comma
dot
id|size
op_assign
l_int|0x003C0000
comma
multiline_comment|/*  4 * 15 * 64KiB&t;*/
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;tmp32&quot;
comma
dot
id|offset
op_assign
l_int|0x003C0000
comma
dot
id|size
op_assign
l_int|0x00020000
comma
multiline_comment|/*  4 * 32KiB&t;&t;*/
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;tmp8a&quot;
comma
dot
id|offset
op_assign
l_int|0x003E0000
comma
dot
id|size
op_assign
l_int|0x00008000
comma
multiline_comment|/*  4 * 8KiB&t;&t;*/
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;tmp8b&quot;
comma
dot
id|offset
op_assign
l_int|0x003E8000
comma
dot
id|size
op_assign
l_int|0x00008000
comma
multiline_comment|/*  4 * 8KiB&t;&t;*/
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;tmp16&quot;
comma
dot
id|offset
op_assign
l_int|0x003F0000
comma
dot
id|size
op_assign
l_int|0x00010000
comma
multiline_comment|/*  4 * 16KiB&t;&t;*/
)brace
)brace
suffix:semicolon
DECL|macro|NB_OF
mdefine_line|#define NB_OF(x) (sizeof (x) / sizeof (x[0]))
multiline_comment|/* trivial struct to describe partition information */
DECL|struct|mtd_part_def
r_struct
id|mtd_part_def
(brace
DECL|member|nums
r_int
id|nums
suffix:semicolon
DECL|member|type
r_int
r_char
op_star
id|type
suffix:semicolon
DECL|member|mtd_part
r_struct
id|mtd_partition
op_star
id|mtd_part
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|sbc8240_mtd
r_static
r_struct
id|mtd_info
op_star
id|sbc8240_mtd
(braket
id|NUM_FLASH_BANKS
)braket
suffix:semicolon
DECL|variable|sbc8240_part_banks
r_static
r_struct
id|mtd_part_def
id|sbc8240_part_banks
(braket
id|NUM_FLASH_BANKS
)braket
suffix:semicolon
macro_line|#endif&t;/* CONFIG_MTD_PARTITIONS */
DECL|function|init_sbc8240_mtd
r_int
id|__init
id|init_sbc8240_mtd
(paren
r_void
)paren
(brace
r_static
r_struct
id|_cjs
(brace
id|u_long
id|addr
suffix:semicolon
id|u_long
id|size
suffix:semicolon
)brace
id|pt
(braket
id|NUM_FLASH_BANKS
)braket
op_assign
(brace
(brace
dot
id|addr
op_assign
id|WINDOW_ADDR0
comma
dot
id|size
op_assign
id|WINDOW_SIZE0
)brace
comma
(brace
dot
id|addr
op_assign
id|WINDOW_ADDR1
comma
dot
id|size
op_assign
id|WINDOW_SIZE1
)brace
comma
)brace
suffix:semicolon
r_int
id|devicesfound
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_FLASH_BANKS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
(paren
id|KERN_NOTICE
id|MSG_PREFIX
l_string|&quot;Probing 0x%08lx at 0x%08lx&bslash;n&quot;
comma
id|pt
(braket
id|i
)braket
dot
id|size
comma
id|pt
(braket
id|i
)braket
dot
id|addr
)paren
suffix:semicolon
id|sbc8240_map
(braket
id|i
)braket
dot
id|map_priv_1
op_assign
(paren
r_int
r_int
)paren
id|ioremap
(paren
id|pt
(braket
id|i
)braket
dot
id|addr
comma
id|pt
(braket
id|i
)braket
dot
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbc8240_map
(braket
id|i
)braket
dot
id|map_priv_1
)paren
(brace
id|printk
(paren
id|MSG_PREFIX
l_string|&quot;failed to ioremap&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|simple_map_init
c_func
(paren
op_amp
id|sbc8240_mtd
(braket
id|i
)braket
)paren
suffix:semicolon
id|sbc8240_mtd
(braket
id|i
)braket
op_assign
id|do_map_probe
c_func
(paren
l_string|&quot;jedec_probe&quot;
comma
op_amp
id|sbc8240_map
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbc8240_mtd
(braket
id|i
)braket
)paren
(brace
id|sbc8240_mtd
(braket
id|i
)braket
op_member_access_from_pointer
id|module
op_assign
id|THIS_MODULE
suffix:semicolon
id|devicesfound
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|devicesfound
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
id|MSG_PREFIX
l_string|&quot;No suppported flash chips found!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_MTD_PARTITIONS
id|sbc8240_part_banks
(braket
l_int|0
)braket
dot
id|mtd_part
op_assign
id|sbc8240_uboot_partitions
suffix:semicolon
id|sbc8240_part_banks
(braket
l_int|0
)braket
dot
id|type
op_assign
l_string|&quot;static image&quot;
suffix:semicolon
id|sbc8240_part_banks
(braket
l_int|0
)braket
dot
id|nums
op_assign
id|NB_OF
c_func
(paren
id|sbc8240_uboot_partitions
)paren
suffix:semicolon
id|sbc8240_part_banks
(braket
l_int|1
)braket
dot
id|mtd_part
op_assign
id|sbc8240_fs_partitions
suffix:semicolon
id|sbc8240_part_banks
(braket
l_int|1
)braket
dot
id|type
op_assign
l_string|&quot;static file system&quot;
suffix:semicolon
id|sbc8240_part_banks
(braket
l_int|1
)braket
dot
id|nums
op_assign
id|NB_OF
c_func
(paren
id|sbc8240_fs_partitions
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_FLASH_BANKS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sbc8240_mtd
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sbc8240_part_banks
(braket
id|i
)braket
dot
id|nums
op_eq
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_NOTICE
id|MSG_PREFIX
l_string|&quot;No partition info available, registering whole device&bslash;n&quot;
)paren
suffix:semicolon
id|add_mtd_device
c_func
(paren
id|sbc8240_mtd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_NOTICE
id|MSG_PREFIX
l_string|&quot;Using %s partition definition&bslash;n&quot;
comma
id|sbc8240_part_banks
(braket
id|i
)braket
dot
id|mtd_part-&gt;name
)paren
suffix:semicolon
id|add_mtd_partitions
(paren
id|sbc8240_mtd
(braket
id|i
)braket
comma
id|sbc8240_part_banks
(braket
id|i
)braket
dot
id|mtd_part
comma
id|sbc8240_part_banks
(braket
id|i
)braket
dot
id|nums
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
id|printk
c_func
(paren
id|KERN_NOTICE
id|MSG_PREFIX
l_string|&quot;Registering %d flash banks at once&bslash;n&quot;
comma
id|devicesfound
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devicesfound
suffix:semicolon
id|i
op_increment
)paren
(brace
id|add_mtd_device
c_func
(paren
id|sbc8240_mtd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_MTD_PARTITIONS */
r_return
id|devicesfound
op_eq
l_int|0
ques
c_cond
op_minus
id|ENXIO
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_sbc8240_mtd
r_static
r_void
id|__exit
id|cleanup_sbc8240_mtd
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_FLASH_BANKS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sbc8240_mtd
(braket
id|i
)braket
)paren
(brace
id|del_mtd_device
(paren
id|sbc8240_mtd
(braket
id|i
)braket
)paren
suffix:semicolon
id|map_destroy
(paren
id|sbc8240_mtd
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sbc8240_map
(braket
id|i
)braket
dot
id|map_priv_1
)paren
(brace
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|sbc8240_map
(braket
id|i
)braket
dot
id|map_priv_1
)paren
suffix:semicolon
id|sbc8240_map
(braket
id|i
)braket
dot
id|map_priv_1
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
DECL|variable|init_sbc8240_mtd
id|module_init
(paren
id|init_sbc8240_mtd
)paren
suffix:semicolon
DECL|variable|cleanup_sbc8240_mtd
id|module_exit
(paren
id|cleanup_sbc8240_mtd
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
(paren
l_string|&quot;Carolyn Smith &lt;carolyn.smith@tektronix.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;MTD map driver for SBC8240 boards&quot;
)paren
suffix:semicolon
eof
