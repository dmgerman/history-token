multiline_comment|/*&n; * NOR Flash memory access on TI Toto board&n; *&n; * jzhang@ti.com (C) 2003 Texas Instruments.&n; *&n; *  (C) 2002 MontVista Software, Inc.&n; *&n; * $Id: omap-toto-flash.c,v 1.3 2004/09/16 23:27:13 gleixner Exp $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
macro_line|#include &lt;linux/mtd/partitions.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#ifndef CONFIG_ARCH_OMAP
macro_line|#error This is for OMAP architecture only
macro_line|#endif
singleline_comment|//these lines need be moved to a hardware header file
DECL|macro|OMAP_TOTO_FLASH_BASE
mdefine_line|#define OMAP_TOTO_FLASH_BASE 0xd8000000
DECL|macro|OMAP_TOTO_FLASH_SIZE
mdefine_line|#define OMAP_TOTO_FLASH_SIZE 0x80000
DECL|variable|omap_toto_map_flash
r_static
r_struct
id|map_info
id|omap_toto_map_flash
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;OMAP Toto flash&quot;
comma
dot
id|bankwidth
op_assign
l_int|2
comma
dot
id|virt
op_assign
(paren
r_void
id|__iomem
op_star
)paren
id|OMAP_TOTO_FLASH_BASE
comma
)brace
suffix:semicolon
DECL|variable|toto_flash_partitions
r_static
r_struct
id|mtd_partition
id|toto_flash_partitions
(braket
)braket
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;BootLoader&quot;
comma
dot
id|size
op_assign
l_int|0x00040000
comma
multiline_comment|/* hopefully u-boot will stay 128k + 128*/
dot
id|offset
op_assign
l_int|0
comma
dot
id|mask_flags
op_assign
id|MTD_WRITEABLE
comma
multiline_comment|/* force read-only */
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;ReservedSpace&quot;
comma
dot
id|size
op_assign
l_int|0x00030000
comma
dot
id|offset
op_assign
id|MTDPART_OFS_APPEND
comma
singleline_comment|//mask_flags:&t;MTD_WRITEABLE,  /* force read-only */
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;EnvArea&quot;
comma
multiline_comment|/* bottom 64KiB for env vars */
dot
id|size
op_assign
id|MTDPART_SIZ_FULL
comma
dot
id|offset
op_assign
id|MTDPART_OFS_APPEND
comma
)brace
)brace
suffix:semicolon
DECL|variable|parsed_parts
r_static
r_struct
id|mtd_partition
op_star
id|parsed_parts
suffix:semicolon
DECL|variable|flash_mtd
r_static
r_struct
id|mtd_info
op_star
id|flash_mtd
suffix:semicolon
DECL|function|init_flash
r_static
r_int
id|__init
id|init_flash
(paren
r_void
)paren
(brace
r_struct
id|mtd_partition
op_star
id|parts
suffix:semicolon
r_int
id|nb_parts
op_assign
l_int|0
suffix:semicolon
r_int
id|parsed_nr_parts
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|part_type
suffix:semicolon
multiline_comment|/*&n;&t; * Static partition definition selection&n;&t; */
id|part_type
op_assign
l_string|&quot;static&quot;
suffix:semicolon
id|parts
op_assign
id|toto_flash_partitions
suffix:semicolon
id|nb_parts
op_assign
id|ARRAY_SIZE
c_func
(paren
id|toto_flash_partitions
)paren
suffix:semicolon
id|omap_toto_map_flash.size
op_assign
id|OMAP_TOTO_FLASH_SIZE
suffix:semicolon
id|omap_toto_map_flash.phys
op_assign
id|virt_to_phys
c_func
(paren
id|OMAP_TOTO_FLASH_BASE
)paren
suffix:semicolon
id|simple_map_init
c_func
(paren
op_amp
id|omap_toto_map_flash
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now let&squot;s probe for the actual flash.  Do it here since&n;&t; * specific machine settings might have been set above.&n;&t; */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;OMAP toto flash: probing %d-bit flash bus&bslash;n&quot;
comma
id|omap_toto_map_flash.bankwidth
op_star
l_int|8
)paren
suffix:semicolon
id|flash_mtd
op_assign
id|do_map_probe
c_func
(paren
l_string|&quot;jedec_probe&quot;
comma
op_amp
id|omap_toto_map_flash
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|flash_mtd
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|parsed_nr_parts
OG
l_int|0
)paren
(brace
id|parts
op_assign
id|parsed_parts
suffix:semicolon
id|nb_parts
op_assign
id|parsed_nr_parts
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nb_parts
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;OMAP toto flash: no partition info available,&quot;
l_string|&quot;registering whole flash at once&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|add_mtd_device
c_func
(paren
id|flash_mtd
)paren
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Using %s partition definition&bslash;n&quot;
comma
id|part_type
)paren
suffix:semicolon
r_return
id|add_mtd_partitions
c_func
(paren
id|flash_mtd
comma
id|parts
comma
id|nb_parts
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|omap_toto_mtd_init
r_int
id|__init
id|omap_toto_mtd_init
c_func
(paren
r_void
)paren
(brace
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|status
op_assign
id|init_flash
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;OMAP Toto Flash: unable to init map for toto flash&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|omap_toto_mtd_cleanup
r_static
r_void
id|__exit
id|omap_toto_mtd_cleanup
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|flash_mtd
)paren
(brace
id|del_mtd_partitions
c_func
(paren
id|flash_mtd
)paren
suffix:semicolon
id|map_destroy
c_func
(paren
id|flash_mtd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parsed_parts
)paren
id|kfree
c_func
(paren
id|parsed_parts
)paren
suffix:semicolon
)brace
)brace
DECL|variable|omap_toto_mtd_init
id|module_init
c_func
(paren
id|omap_toto_mtd_init
)paren
suffix:semicolon
DECL|variable|omap_toto_mtd_cleanup
id|module_exit
c_func
(paren
id|omap_toto_mtd_cleanup
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jian Zhang&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;OMAP Toto board map driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
