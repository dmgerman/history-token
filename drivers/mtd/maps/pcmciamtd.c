multiline_comment|/*&n; * $Id: pcmciamtd.c,v 1.51 2004/07/12 22:38:29 dwmw2 Exp $&n; *&n; * pcmciamtd.c - MTD driver for PCMCIA flash memory cards&n; *&n; * Author: Simon Evans &lt;spse@secret.org.uk&gt;&n; *&n; * Copyright (C) 2002 Simon Evans&n; *&n; * Licence: GPL&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#ifdef CONFIG_MTD_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
id|CONFIG_MTD_DEBUG_VERBOSE
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Set Debug Level 0=quiet, 5=noisy&quot;
)paren
suffix:semicolon
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, format, arg...) &bslash;&n;&t;if (n &lt;= debug) {&t; &bslash;&n;&t;&t;printk(KERN_DEBUG __FILE__ &quot;:%s(): &quot; format &quot;&bslash;n&quot;, __FUNCTION__ , ## arg); &bslash;&n;&t;}
macro_line|#else
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG(n, arg...)
DECL|variable|debug
r_static
r_const
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|macro|err
mdefine_line|#define err(format, arg...) printk(KERN_ERR &quot;pcmciamtd: &quot; format &quot;&bslash;n&quot; , ## arg)
DECL|macro|info
mdefine_line|#define info(format, arg...) printk(KERN_INFO &quot;pcmciamtd: &quot; format &quot;&bslash;n&quot; , ## arg)
DECL|macro|warn
mdefine_line|#define warn(format, arg...) printk(KERN_WARNING &quot;pcmciamtd: &quot; format &quot;&bslash;n&quot; , ## arg)
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;PCMCIA Flash memory card driver&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&quot;$Revision: 1.51 $&quot;
multiline_comment|/* Size of the PCMCIA address space: 26 bits = 64 MB */
DECL|macro|MAX_PCMCIA_ADDR
mdefine_line|#define MAX_PCMCIA_ADDR&t;0x4000000
DECL|struct|pcmciamtd_dev
r_struct
id|pcmciamtd_dev
(brace
DECL|member|link
id|dev_link_t
id|link
suffix:semicolon
multiline_comment|/* PCMCIA link */
DECL|member|node
id|dev_node_t
id|node
suffix:semicolon
multiline_comment|/* device node */
DECL|member|win_base
id|caddr_t
id|win_base
suffix:semicolon
multiline_comment|/* ioremapped address of PCMCIA window */
DECL|member|win_size
r_int
r_int
id|win_size
suffix:semicolon
multiline_comment|/* size of window */
DECL|member|offset
r_int
r_int
id|offset
suffix:semicolon
multiline_comment|/* offset into card the window currently points at */
DECL|member|pcmcia_map
r_struct
id|map_info
id|pcmcia_map
suffix:semicolon
DECL|member|mtd_info
r_struct
id|mtd_info
op_star
id|mtd_info
suffix:semicolon
DECL|member|vpp
r_int
id|vpp
suffix:semicolon
DECL|member|mtd_name
r_char
id|mtd_name
(braket
r_sizeof
(paren
r_struct
id|cistpl_vers_1_t
)paren
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|dev_info
r_static
id|dev_info_t
id|dev_info
op_assign
l_string|&quot;pcmciamtd&quot;
suffix:semicolon
DECL|variable|dev_list
r_static
id|dev_link_t
op_star
id|dev_list
suffix:semicolon
multiline_comment|/* Module parameters */
multiline_comment|/* 2 = do 16-bit transfers, 1 = do 8-bit transfers */
DECL|variable|bankwidth
r_static
r_int
id|bankwidth
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Speed of memory accesses, in ns */
DECL|variable|mem_speed
r_static
r_int
id|mem_speed
suffix:semicolon
multiline_comment|/* Force the size of an SRAM card */
DECL|variable|force_size
r_static
r_int
id|force_size
suffix:semicolon
multiline_comment|/* Force Vpp */
DECL|variable|vpp
r_static
r_int
id|vpp
suffix:semicolon
multiline_comment|/* Set Vpp */
DECL|variable|setvpp
r_static
r_int
id|setvpp
suffix:semicolon
multiline_comment|/* Force card to be treated as FLASH, ROM or RAM */
DECL|variable|mem_type
r_static
r_int
id|mem_type
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Simon Evans &lt;spse@secret.org.uk&gt;&quot;
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|bankwidth
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|bankwidth
comma
l_string|&quot;Set bankwidth (1=8 bit, 2=16 bit, default=2)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mem_speed
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mem_speed
comma
l_string|&quot;Set memory access speed in ns&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|force_size
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|force_size
comma
l_string|&quot;Force size of card in MiB (1-64)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|setvpp
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|setvpp
comma
l_string|&quot;Set Vpp (0=Never, 1=On writes, 2=Always on, default=0)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|vpp
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|vpp
comma
l_string|&quot;Vpp value in 1/10ths eg 33=3.3V 120=12V (Dangerous)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mem_type
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mem_type
comma
l_string|&quot;Set Memory type (0=Flash, 1=RAM, 2=ROM, default=0)&quot;
)paren
suffix:semicolon
multiline_comment|/* read/write{8,16} copy_{from,to} routines with window remapping to access whole card */
DECL|function|remap_window
r_static
id|caddr_t
id|remap_window
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|to
)paren
(brace
r_struct
id|pcmciamtd_dev
op_star
id|dev
op_assign
(paren
r_struct
id|pcmciamtd_dev
op_star
)paren
id|map-&gt;map_priv_1
suffix:semicolon
id|window_handle_t
id|win
op_assign
(paren
id|window_handle_t
)paren
id|map-&gt;map_priv_2
suffix:semicolon
id|memreq_t
id|mrq
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;link.state
op_amp
id|DEV_PRESENT
)paren
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;device removed state = 0x%4.4X&quot;
comma
id|dev-&gt;link.state
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mrq.CardOffset
op_assign
id|to
op_amp
op_complement
(paren
id|dev-&gt;win_size
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mrq.CardOffset
op_ne
id|dev-&gt;offset
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Remapping window from 0x%8.8x to 0x%8.8x&quot;
comma
id|dev-&gt;offset
comma
id|mrq.CardOffset
)paren
suffix:semicolon
id|mrq.Page
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|pcmcia_map_mem_page
c_func
(paren
id|win
comma
op_amp
id|mrq
)paren
)paren
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|dev-&gt;link.handle
comma
id|MapMemPage
comma
id|ret
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dev-&gt;offset
op_assign
id|mrq.CardOffset
suffix:semicolon
)brace
r_return
id|dev-&gt;win_base
op_plus
(paren
id|to
op_amp
(paren
id|dev-&gt;win_size
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
DECL|function|pcmcia_read8_remap
r_static
id|map_word
id|pcmcia_read8_remap
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
id|caddr_t
id|addr
suffix:semicolon
id|map_word
id|d
op_assign
(brace
(brace
l_int|0
)brace
)brace
suffix:semicolon
id|addr
op_assign
id|remap_window
c_func
(paren
id|map
comma
id|ofs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
(brace
r_return
id|d
suffix:semicolon
)brace
id|d.x
(braket
l_int|0
)braket
op_assign
id|readb
c_func
(paren
id|addr
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ofs = 0x%08lx (%p) data = 0x%02x&quot;
comma
id|ofs
comma
id|addr
comma
id|d.x
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
DECL|function|pcmcia_read16_remap
r_static
id|map_word
id|pcmcia_read16_remap
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
id|caddr_t
id|addr
suffix:semicolon
id|map_word
id|d
op_assign
(brace
(brace
l_int|0
)brace
)brace
suffix:semicolon
id|addr
op_assign
id|remap_window
c_func
(paren
id|map
comma
id|ofs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
(brace
r_return
id|d
suffix:semicolon
)brace
id|d.x
(braket
l_int|0
)braket
op_assign
id|readw
c_func
(paren
id|addr
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ofs = 0x%08lx (%p) data = 0x%04x&quot;
comma
id|ofs
comma
id|addr
comma
id|d.x
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
DECL|function|pcmcia_copy_from_remap
r_static
r_void
id|pcmcia_copy_from_remap
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_void
op_star
id|to
comma
r_int
r_int
id|from
comma
id|ssize_t
id|len
)paren
(brace
r_struct
id|pcmciamtd_dev
op_star
id|dev
op_assign
(paren
r_struct
id|pcmciamtd_dev
op_star
)paren
id|map-&gt;map_priv_1
suffix:semicolon
r_int
r_int
id|win_size
op_assign
id|dev-&gt;win_size
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;to = %p from = %lu len = %u&quot;
comma
id|to
comma
id|from
comma
id|len
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
r_int
id|toread
op_assign
id|win_size
op_minus
(paren
id|from
op_amp
(paren
id|win_size
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|caddr_t
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|toread
OG
id|len
)paren
(brace
id|toread
op_assign
id|len
suffix:semicolon
)brace
id|addr
op_assign
id|remap_window
c_func
(paren
id|map
comma
id|from
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
(brace
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;memcpy from %p to %p len = %d&quot;
comma
id|addr
comma
id|to
comma
id|toread
)paren
suffix:semicolon
id|memcpy_fromio
c_func
(paren
id|to
comma
id|addr
comma
id|toread
)paren
suffix:semicolon
id|len
op_sub_assign
id|toread
suffix:semicolon
id|to
op_add_assign
id|toread
suffix:semicolon
id|from
op_add_assign
id|toread
suffix:semicolon
)brace
)brace
DECL|function|pcmcia_write8_remap
r_static
r_void
id|pcmcia_write8_remap
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|map_word
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|caddr_t
id|addr
op_assign
id|remap_window
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
(brace
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;adr = 0x%08lx (%p)  data = 0x%02x&quot;
comma
id|adr
comma
id|addr
comma
id|d.x
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|d.x
(braket
l_int|0
)braket
comma
id|addr
)paren
suffix:semicolon
)brace
DECL|function|pcmcia_write16_remap
r_static
r_void
id|pcmcia_write16_remap
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|map_word
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|caddr_t
id|addr
op_assign
id|remap_window
c_func
(paren
id|map
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
(brace
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;adr = 0x%08lx (%p)  data = 0x%04x&quot;
comma
id|adr
comma
id|addr
comma
id|d.x
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|writew
c_func
(paren
id|d.x
(braket
l_int|0
)braket
comma
id|addr
)paren
suffix:semicolon
)brace
DECL|function|pcmcia_copy_to_remap
r_static
r_void
id|pcmcia_copy_to_remap
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|to
comma
r_const
r_void
op_star
id|from
comma
id|ssize_t
id|len
)paren
(brace
r_struct
id|pcmciamtd_dev
op_star
id|dev
op_assign
(paren
r_struct
id|pcmciamtd_dev
op_star
)paren
id|map-&gt;map_priv_1
suffix:semicolon
r_int
r_int
id|win_size
op_assign
id|dev-&gt;win_size
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;to = %lu from = %p len = %u&quot;
comma
id|to
comma
id|from
comma
id|len
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
r_int
id|towrite
op_assign
id|win_size
op_minus
(paren
id|to
op_amp
(paren
id|win_size
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|caddr_t
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|towrite
OG
id|len
)paren
(brace
id|towrite
op_assign
id|len
suffix:semicolon
)brace
id|addr
op_assign
id|remap_window
c_func
(paren
id|map
comma
id|to
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
(brace
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;memcpy from %p to %p len = %d&quot;
comma
id|from
comma
id|addr
comma
id|towrite
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|addr
comma
id|from
comma
id|towrite
)paren
suffix:semicolon
id|len
op_sub_assign
id|towrite
suffix:semicolon
id|to
op_add_assign
id|towrite
suffix:semicolon
id|from
op_add_assign
id|towrite
suffix:semicolon
)brace
)brace
multiline_comment|/* read/write{8,16} copy_{from,to} routines with direct access */
DECL|macro|DEV_REMOVED
mdefine_line|#define DEV_REMOVED(x)  (!(*(u_int *)x-&gt;map_priv_1 &amp; DEV_PRESENT))
DECL|function|pcmcia_read8
r_static
id|map_word
id|pcmcia_read8
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
id|caddr_t
id|win_base
op_assign
(paren
id|caddr_t
)paren
id|map-&gt;map_priv_2
suffix:semicolon
id|map_word
id|d
op_assign
(brace
(brace
l_int|0
)brace
)brace
suffix:semicolon
r_if
c_cond
(paren
id|DEV_REMOVED
c_func
(paren
id|map
)paren
)paren
(brace
r_return
id|d
suffix:semicolon
)brace
id|d.x
(braket
l_int|0
)braket
op_assign
id|readb
c_func
(paren
id|win_base
op_plus
id|ofs
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ofs = 0x%08lx (%p) data = 0x%02x&quot;
comma
id|ofs
comma
id|win_base
op_plus
id|ofs
comma
id|d.x
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
DECL|function|pcmcia_read16
r_static
id|map_word
id|pcmcia_read16
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|ofs
)paren
(brace
id|caddr_t
id|win_base
op_assign
(paren
id|caddr_t
)paren
id|map-&gt;map_priv_2
suffix:semicolon
id|map_word
id|d
op_assign
(brace
(brace
l_int|0
)brace
)brace
suffix:semicolon
r_if
c_cond
(paren
id|DEV_REMOVED
c_func
(paren
id|map
)paren
)paren
(brace
r_return
id|d
suffix:semicolon
)brace
id|d.x
(braket
l_int|0
)braket
op_assign
id|readw
c_func
(paren
id|win_base
op_plus
id|ofs
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;ofs = 0x%08lx (%p) data = 0x%04x&quot;
comma
id|ofs
comma
id|win_base
op_plus
id|ofs
comma
id|d.x
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
DECL|function|pcmcia_copy_from
r_static
r_void
id|pcmcia_copy_from
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_void
op_star
id|to
comma
r_int
r_int
id|from
comma
id|ssize_t
id|len
)paren
(brace
id|caddr_t
id|win_base
op_assign
(paren
id|caddr_t
)paren
id|map-&gt;map_priv_2
suffix:semicolon
r_if
c_cond
(paren
id|DEV_REMOVED
c_func
(paren
id|map
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;to = %p from = %lu len = %u&quot;
comma
id|to
comma
id|from
comma
id|len
)paren
suffix:semicolon
id|memcpy_fromio
c_func
(paren
id|to
comma
id|win_base
op_plus
id|from
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|pcmcia_write8
r_static
r_void
id|pcmcia_write8
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|u8
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|caddr_t
id|win_base
op_assign
(paren
id|caddr_t
)paren
id|map-&gt;map_priv_2
suffix:semicolon
r_if
c_cond
(paren
id|DEV_REMOVED
c_func
(paren
id|map
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;adr = 0x%08lx (%p)  data = 0x%02x&quot;
comma
id|adr
comma
id|win_base
op_plus
id|adr
comma
id|d
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|d
comma
id|win_base
op_plus
id|adr
)paren
suffix:semicolon
)brace
DECL|function|pcmcia_write16
r_static
r_void
id|pcmcia_write16
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
id|u16
id|d
comma
r_int
r_int
id|adr
)paren
(brace
id|caddr_t
id|win_base
op_assign
(paren
id|caddr_t
)paren
id|map-&gt;map_priv_2
suffix:semicolon
r_if
c_cond
(paren
id|DEV_REMOVED
c_func
(paren
id|map
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;adr = 0x%08lx (%p)  data = 0x%04x&quot;
comma
id|adr
comma
id|win_base
op_plus
id|adr
comma
id|d
)paren
suffix:semicolon
id|writew
c_func
(paren
id|d
comma
id|win_base
op_plus
id|adr
)paren
suffix:semicolon
)brace
DECL|function|pcmcia_copy_to
r_static
r_void
id|pcmcia_copy_to
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
r_int
id|to
comma
r_const
r_void
op_star
id|from
comma
id|ssize_t
id|len
)paren
(brace
id|caddr_t
id|win_base
op_assign
(paren
id|caddr_t
)paren
id|map-&gt;map_priv_2
suffix:semicolon
r_if
c_cond
(paren
id|DEV_REMOVED
c_func
(paren
id|map
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;to = %lu from = %p len = %u&quot;
comma
id|to
comma
id|from
comma
id|len
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|win_base
op_plus
id|to
comma
id|from
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|pcmciamtd_set_vpp
r_static
r_void
id|pcmciamtd_set_vpp
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
id|on
)paren
(brace
r_struct
id|pcmciamtd_dev
op_star
id|dev
op_assign
(paren
r_struct
id|pcmciamtd_dev
op_star
)paren
id|map-&gt;map_priv_1
suffix:semicolon
id|dev_link_t
op_star
id|link
op_assign
op_amp
id|dev-&gt;link
suffix:semicolon
id|modconf_t
id|mod
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|mod.Attributes
op_assign
id|CONF_VPP1_CHANGE_VALID
op_or
id|CONF_VPP2_CHANGE_VALID
suffix:semicolon
id|mod.Vcc
op_assign
l_int|0
suffix:semicolon
id|mod.Vpp1
op_assign
id|mod.Vpp2
op_assign
id|on
ques
c_cond
id|dev-&gt;vpp
suffix:colon
l_int|0
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;dev = %p on = %d vpp = %d&bslash;n&quot;
comma
id|dev
comma
id|on
comma
id|dev-&gt;vpp
)paren
suffix:semicolon
id|ret
op_assign
id|pcmcia_modify_configuration
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|mod
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|ModifyConfiguration
comma
id|ret
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* After a card is removed, pcmciamtd_release() will unregister the&n; * device, and release the PCMCIA configuration.  If the device is&n; * still open, this will be postponed until it is closed.&n; */
DECL|function|pcmciamtd_release
r_static
r_void
id|pcmciamtd_release
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|pcmciamtd_dev
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;link = 0x%p&quot;
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;win
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;win_base
)paren
(brace
id|iounmap
c_func
(paren
id|dev-&gt;win_base
)paren
suffix:semicolon
id|dev-&gt;win_base
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pcmcia_release_window
c_func
(paren
id|link-&gt;win
)paren
suffix:semicolon
)brace
id|pcmcia_release_configuration
c_func
(paren
id|link-&gt;handle
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG
suffix:semicolon
)brace
DECL|function|card_settings
r_static
r_void
id|card_settings
c_func
(paren
r_struct
id|pcmciamtd_dev
op_star
id|dev
comma
id|dev_link_t
op_star
id|link
comma
r_int
op_star
id|new_name
)paren
(brace
r_int
id|rc
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
id|u_char
id|buf
(braket
l_int|64
)braket
suffix:semicolon
id|tuple.Attributes
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleData
op_assign
(paren
id|cisdata_t
op_star
)paren
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|tuple.DesiredTuple
op_assign
id|RETURN_FIRST_TUPLE
suffix:semicolon
id|rc
op_assign
id|pcmcia_get_first_tuple
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rc
op_eq
id|CS_SUCCESS
)paren
(brace
id|rc
op_assign
id|pcmcia_get_tuple_data
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|GetTupleData
comma
id|rc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rc
op_assign
id|pcmcia_parse_tuple
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|ParseTuple
comma
id|rc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|tuple.TupleCode
)paren
(brace
r_case
id|CISTPL_FORMAT
suffix:colon
(brace
id|cistpl_format_t
op_star
id|t
op_assign
op_amp
id|parse.format
suffix:semicolon
(paren
r_void
)paren
id|t
suffix:semicolon
multiline_comment|/* Shut up, gcc */
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Format type: %u, Error Detection: %u, offset = %u, length =%u&quot;
comma
id|t-&gt;type
comma
id|t-&gt;edc
comma
id|t-&gt;offset
comma
id|t-&gt;length
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|CISTPL_DEVICE
suffix:colon
(brace
id|cistpl_device_t
op_star
id|t
op_assign
op_amp
id|parse.device
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Common memory:&quot;
)paren
suffix:semicolon
id|dev-&gt;pcmcia_map.size
op_assign
id|t-&gt;dev
(braket
l_int|0
)braket
dot
id|size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|t-&gt;ndev
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Region %d, type = %u&quot;
comma
id|i
comma
id|t-&gt;dev
(braket
id|i
)braket
dot
id|type
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Region %d, wp = %u&quot;
comma
id|i
comma
id|t-&gt;dev
(braket
id|i
)braket
dot
id|wp
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Region %d, speed = %u ns&quot;
comma
id|i
comma
id|t-&gt;dev
(braket
id|i
)braket
dot
id|speed
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Region %d, size = %u bytes&quot;
comma
id|i
comma
id|t-&gt;dev
(braket
id|i
)braket
dot
id|size
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|CISTPL_VERS_1
suffix:colon
(brace
id|cistpl_vers_1_t
op_star
id|t
op_assign
op_amp
id|parse.version_1
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|t-&gt;ns
)paren
(brace
id|dev-&gt;mtd_name
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|t-&gt;ns
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
)paren
(brace
id|strcat
c_func
(paren
id|dev-&gt;mtd_name
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
id|strcat
c_func
(paren
id|dev-&gt;mtd_name
comma
id|t-&gt;str
op_plus
id|t-&gt;ofs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Found name: %s&quot;
comma
id|dev-&gt;mtd_name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|CISTPL_JEDEC_C
suffix:colon
(brace
id|cistpl_jedec_t
op_star
id|t
op_assign
op_amp
id|parse.jedec
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|t-&gt;nid
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;JEDEC: 0x%02x 0x%02x&quot;
comma
id|t-&gt;id
(braket
id|i
)braket
dot
id|mfr
comma
id|t-&gt;id
(braket
id|i
)braket
dot
id|info
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|CISTPL_DEVICE_GEO
suffix:colon
(brace
id|cistpl_device_geo_t
op_star
id|t
op_assign
op_amp
id|parse.device_geo
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev-&gt;pcmcia_map.bankwidth
op_assign
id|t-&gt;geo
(braket
l_int|0
)braket
dot
id|buswidth
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|t-&gt;ngeo
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;region: %d bankwidth = %u&quot;
comma
id|i
comma
id|t-&gt;geo
(braket
id|i
)braket
dot
id|buswidth
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;region: %d erase_block = %u&quot;
comma
id|i
comma
id|t-&gt;geo
(braket
id|i
)braket
dot
id|erase_block
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;region: %d read_block = %u&quot;
comma
id|i
comma
id|t-&gt;geo
(braket
id|i
)braket
dot
id|read_block
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;region: %d write_block = %u&quot;
comma
id|i
comma
id|t-&gt;geo
(braket
id|i
)braket
dot
id|write_block
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;region: %d partition = %u&quot;
comma
id|i
comma
id|t-&gt;geo
(braket
id|i
)braket
dot
id|partition
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;region: %d interleave = %u&quot;
comma
id|i
comma
id|t-&gt;geo
(braket
id|i
)braket
dot
id|interleave
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Unknown tuple code %d&quot;
comma
id|tuple.TupleCode
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|pcmcia_get_next_tuple
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|tuple
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;pcmcia_map.size
)paren
(brace
id|dev-&gt;pcmcia_map.size
op_assign
id|MAX_PCMCIA_ADDR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;pcmcia_map.bankwidth
)paren
(brace
id|dev-&gt;pcmcia_map.bankwidth
op_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|force_size
)paren
(brace
id|dev-&gt;pcmcia_map.size
op_assign
id|force_size
op_lshift
l_int|20
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;size forced to %dM&quot;
comma
id|force_size
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bankwidth
)paren
(brace
id|dev-&gt;pcmcia_map.bankwidth
op_assign
id|bankwidth
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;bankwidth forced to %d&quot;
comma
id|bankwidth
)paren
suffix:semicolon
)brace
id|dev-&gt;pcmcia_map.name
op_assign
id|dev-&gt;mtd_name
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;mtd_name
(braket
l_int|0
)braket
)paren
(brace
id|strcpy
c_func
(paren
id|dev-&gt;mtd_name
comma
l_string|&quot;PCMCIA Memory card&quot;
)paren
suffix:semicolon
op_star
id|new_name
op_assign
l_int|1
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Device: Size: %lu Width:%d Name: %s&quot;
comma
id|dev-&gt;pcmcia_map.size
comma
id|dev-&gt;pcmcia_map.bankwidth
op_lshift
l_int|3
comma
id|dev-&gt;mtd_name
)paren
suffix:semicolon
)brace
multiline_comment|/* pcmciamtd_config() is scheduled to run after a CARD_INSERTION event&n; * is received, to configure the PCMCIA socket, and to make the&n; * MTD device available to the system.&n; */
DECL|macro|CS_CHECK
mdefine_line|#define CS_CHECK(fn, ret) &bslash;&n;do { last_fn = (fn); if ((last_ret = (ret)) != 0) goto cs_failed; } while (0)
DECL|function|pcmciamtd_config
r_static
r_void
id|pcmciamtd_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
r_struct
id|pcmciamtd_dev
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
r_struct
id|mtd_info
op_star
id|mtd
op_assign
l_int|NULL
suffix:semicolon
id|cs_status_t
id|status
suffix:semicolon
id|win_req_t
id|req
suffix:semicolon
r_int
id|last_ret
op_assign
l_int|0
comma
id|last_fn
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|i
suffix:semicolon
id|config_info_t
id|t
suffix:semicolon
r_static
r_char
op_star
id|probes
(braket
)braket
op_assign
(brace
l_string|&quot;jedec_probe&quot;
comma
l_string|&quot;cfi_probe&quot;
)brace
suffix:semicolon
id|cisinfo_t
id|cisinfo
suffix:semicolon
r_int
id|new_name
op_assign
l_int|0
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;link=0x%p&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* Configure card */
id|link-&gt;state
op_or_assign
id|DEV_CONFIG
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Validating CIS&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|pcmcia_validate_cis
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|cisinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|GetTupleData
comma
id|ret
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ValidateCIS found %d chains&quot;
comma
id|cisinfo.Chains
)paren
suffix:semicolon
)brace
id|card_settings
c_func
(paren
id|dev
comma
id|link
comma
op_amp
id|new_name
)paren
suffix:semicolon
id|dev-&gt;pcmcia_map.phys
op_assign
id|NO_XIP
suffix:semicolon
id|dev-&gt;pcmcia_map.copy_from
op_assign
id|pcmcia_copy_from_remap
suffix:semicolon
id|dev-&gt;pcmcia_map.copy_to
op_assign
id|pcmcia_copy_to_remap
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;pcmcia_map.bankwidth
op_eq
l_int|1
)paren
(brace
id|dev-&gt;pcmcia_map.read
op_assign
id|pcmcia_read8_remap
suffix:semicolon
id|dev-&gt;pcmcia_map.write
op_assign
id|pcmcia_write8_remap
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;pcmcia_map.read
op_assign
id|pcmcia_read16_remap
suffix:semicolon
id|dev-&gt;pcmcia_map.write
op_assign
id|pcmcia_write16_remap
suffix:semicolon
)brace
r_if
c_cond
(paren
id|setvpp
op_eq
l_int|1
)paren
(brace
id|dev-&gt;pcmcia_map.set_vpp
op_assign
id|pcmciamtd_set_vpp
suffix:semicolon
)brace
multiline_comment|/* Request a memory window for PCMCIA. Some architeures can map windows upto the maximum&n;&t;   that PCMCIA can support (64MiB) - this is ideal and we aim for a window the size of the&n;&t;   whole card - otherwise we try smaller windows until we succeed */
id|req.Attributes
op_assign
id|WIN_MEMORY_TYPE_CM
op_or
id|WIN_ENABLE
suffix:semicolon
id|req.Attributes
op_or_assign
(paren
id|dev-&gt;pcmcia_map.bankwidth
op_eq
l_int|1
)paren
ques
c_cond
id|WIN_DATA_WIDTH_8
suffix:colon
id|WIN_DATA_WIDTH_16
suffix:semicolon
id|req.Base
op_assign
l_int|0
suffix:semicolon
id|req.AccessSpeed
op_assign
id|mem_speed
suffix:semicolon
id|link-&gt;win
op_assign
(paren
id|window_handle_t
)paren
id|link-&gt;handle
suffix:semicolon
id|req.Size
op_assign
(paren
id|force_size
)paren
ques
c_cond
id|force_size
op_lshift
l_int|20
suffix:colon
id|MAX_PCMCIA_ADDR
suffix:semicolon
id|dev-&gt;win_size
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_int
id|ret
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;requesting window with size = %dKiB memspeed = %d&quot;
comma
id|req.Size
op_rshift
l_int|10
comma
id|req.AccessSpeed
)paren
suffix:semicolon
id|ret
op_assign
id|pcmcia_request_window
c_func
(paren
op_amp
id|link-&gt;handle
comma
op_amp
id|req
comma
op_amp
id|link-&gt;win
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;ret = %d dev-&gt;win_size = %d&quot;
comma
id|ret
comma
id|dev-&gt;win_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|req.Size
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Got window of size %dKiB&quot;
comma
id|req.Size
op_rshift
l_int|10
)paren
suffix:semicolon
id|dev-&gt;win_size
op_assign
id|req.Size
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|req.Size
op_ge
l_int|0x1000
)paren
(brace
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;dev-&gt;win_size = %d&quot;
comma
id|dev-&gt;win_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;win_size
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Cant allocate memory window&quot;
)paren
suffix:semicolon
id|pcmciamtd_release
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Allocated a window of %dKiB&quot;
comma
id|dev-&gt;win_size
op_rshift
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Get write protect status */
id|CS_CHECK
c_func
(paren
id|GetStatus
comma
id|pcmcia_get_status
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|status
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;status value: 0x%x window handle = 0x%8.8lx&quot;
comma
id|status.CardState
comma
(paren
r_int
r_int
)paren
id|link-&gt;win
)paren
suffix:semicolon
id|dev-&gt;win_base
op_assign
id|ioremap
c_func
(paren
id|req.Base
comma
id|req.Size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;win_base
)paren
(brace
id|err
c_func
(paren
l_string|&quot;ioremap(%lu, %u) failed&quot;
comma
id|req.Base
comma
id|req.Size
)paren
suffix:semicolon
id|pcmciamtd_release
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;mapped window dev = %p req.base = 0x%lx base = %p size = 0x%x&quot;
comma
id|dev
comma
id|req.Base
comma
id|dev-&gt;win_base
comma
id|req.Size
)paren
suffix:semicolon
id|dev-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;pcmcia_map.map_priv_1
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|dev-&gt;pcmcia_map.map_priv_2
op_assign
(paren
r_int
r_int
)paren
id|link-&gt;win
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Getting configuration&quot;
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetConfigurationInfo
comma
id|pcmcia_get_configuration_info
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|t
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Vcc = %d Vpp1 = %d Vpp2 = %d&quot;
comma
id|t.Vcc
comma
id|t.Vpp1
comma
id|t.Vpp2
)paren
suffix:semicolon
id|dev-&gt;vpp
op_assign
(paren
id|vpp
)paren
ques
c_cond
id|vpp
suffix:colon
id|t.Vpp1
suffix:semicolon
id|link-&gt;conf.Attributes
op_assign
l_int|0
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
id|t.Vcc
suffix:semicolon
r_if
c_cond
(paren
id|setvpp
op_eq
l_int|2
)paren
(brace
id|link-&gt;conf.Vpp1
op_assign
id|dev-&gt;vpp
suffix:semicolon
id|link-&gt;conf.Vpp2
op_assign
id|dev-&gt;vpp
suffix:semicolon
)brace
r_else
(brace
id|link-&gt;conf.Vpp1
op_assign
l_int|0
suffix:semicolon
id|link-&gt;conf.Vpp2
op_assign
l_int|0
suffix:semicolon
)brace
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY
suffix:semicolon
id|link-&gt;conf.ConfigBase
op_assign
id|t.ConfigBase
suffix:semicolon
id|link-&gt;conf.Status
op_assign
id|t.Status
suffix:semicolon
id|link-&gt;conf.Pin
op_assign
id|t.Pin
suffix:semicolon
id|link-&gt;conf.Copy
op_assign
id|t.Copy
suffix:semicolon
id|link-&gt;conf.ExtStatus
op_assign
id|t.ExtStatus
suffix:semicolon
id|link-&gt;conf.ConfigIndex
op_assign
l_int|0
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|t.Present
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Setting Configuration&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|pcmcia_request_configuration
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RequestConfiguration
comma
id|ret
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mem_type
op_eq
l_int|1
)paren
(brace
id|mtd
op_assign
id|do_map_probe
c_func
(paren
l_string|&quot;map_ram&quot;
comma
op_amp
id|dev-&gt;pcmcia_map
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mem_type
op_eq
l_int|2
)paren
(brace
id|mtd
op_assign
id|do_map_probe
c_func
(paren
l_string|&quot;map_rom&quot;
comma
op_amp
id|dev-&gt;pcmcia_map
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|probes
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Trying %s&quot;
comma
id|probes
(braket
id|i
)braket
)paren
suffix:semicolon
id|mtd
op_assign
id|do_map_probe
c_func
(paren
id|probes
(braket
id|i
)braket
comma
op_amp
id|dev-&gt;pcmcia_map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtd
)paren
(brace
r_break
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;FAILED: %s&quot;
comma
id|probes
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|mtd
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Cant find an MTD&quot;
)paren
suffix:semicolon
id|pcmciamtd_release
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev-&gt;mtd_info
op_assign
id|mtd
suffix:semicolon
id|mtd-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
r_if
c_cond
(paren
id|new_name
)paren
(brace
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_char
id|unit
op_assign
l_char|&squot; &squot;
suffix:semicolon
multiline_comment|/* Since we are using a default name, make it better by adding in the&n;&t;&t;   size */
r_if
c_cond
(paren
id|mtd-&gt;size
OL
l_int|1048576
)paren
(brace
multiline_comment|/* &lt;1MiB in size, show size in KiB */
id|size
op_assign
id|mtd-&gt;size
op_rshift
l_int|10
suffix:semicolon
id|unit
op_assign
l_char|&squot;K&squot;
suffix:semicolon
)brace
r_else
(brace
id|size
op_assign
id|mtd-&gt;size
op_rshift
l_int|20
suffix:semicolon
id|unit
op_assign
l_char|&squot;M&squot;
suffix:semicolon
)brace
id|snprintf
c_func
(paren
id|dev-&gt;mtd_name
comma
r_sizeof
(paren
id|dev-&gt;mtd_name
)paren
comma
l_string|&quot;%d%ciB %s&quot;
comma
id|size
comma
id|unit
comma
l_string|&quot;PCMCIA Memory card&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* If the memory found is fits completely into the mapped PCMCIA window,&n;&t;   use the faster non-remapping read/write functions */
r_if
c_cond
(paren
id|mtd-&gt;size
op_le
id|dev-&gt;win_size
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Using non remapping memory functions&quot;
)paren
suffix:semicolon
id|dev-&gt;pcmcia_map.map_priv_1
op_assign
(paren
r_int
r_int
)paren
op_amp
(paren
id|dev-&gt;link.state
)paren
suffix:semicolon
id|dev-&gt;pcmcia_map.map_priv_2
op_assign
(paren
r_int
r_int
)paren
id|dev-&gt;win_base
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;pcmcia_map.bankwidth
op_eq
l_int|1
)paren
(brace
id|dev-&gt;pcmcia_map.read
op_assign
id|pcmcia_read8
suffix:semicolon
id|dev-&gt;pcmcia_map.write
op_assign
id|pcmcia_write8
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;pcmcia_map.read
op_assign
id|pcmcia_read16
suffix:semicolon
id|dev-&gt;pcmcia_map.write
op_assign
id|pcmcia_write16
suffix:semicolon
)brace
id|dev-&gt;pcmcia_map.copy_from
op_assign
id|pcmcia_copy_from
suffix:semicolon
id|dev-&gt;pcmcia_map.copy_to
op_assign
id|pcmcia_copy_to
suffix:semicolon
)brace
r_if
c_cond
(paren
id|add_mtd_device
c_func
(paren
id|mtd
)paren
)paren
(brace
id|map_destroy
c_func
(paren
id|mtd
)paren
suffix:semicolon
id|dev-&gt;mtd_info
op_assign
l_int|NULL
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;Couldnt register MTD device&quot;
)paren
suffix:semicolon
id|pcmciamtd_release
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|snprintf
c_func
(paren
id|dev-&gt;node.dev_name
comma
r_sizeof
(paren
id|dev-&gt;node.dev_name
)paren
comma
l_string|&quot;mtd%d&quot;
comma
id|mtd-&gt;index
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;mtd%d: %s&quot;
comma
id|mtd-&gt;index
comma
id|mtd-&gt;name
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
id|link-&gt;dev
op_assign
op_amp
id|dev-&gt;node
suffix:semicolon
r_return
suffix:semicolon
id|cs_failed
suffix:colon
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|last_fn
comma
id|last_ret
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;CS Error, exiting&quot;
)paren
suffix:semicolon
id|pcmciamtd_release
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* The card status event handler.  Mostly, this schedules other&n; * stuff to run after an event is received.  A CARD_REMOVAL event&n; * also sets some flags to discourage the driver from trying&n; * to talk to the card any more.&n; */
DECL|function|pcmciamtd_event
r_static
r_int
id|pcmciamtd_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|args-&gt;client_data
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;event=0x%06x&quot;
comma
id|event
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CS_EVENT_CARD_REMOVAL
suffix:colon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;EVENT_CARD_REMOVAL&quot;
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
r_struct
id|pcmciamtd_dev
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mtd_info
)paren
(brace
id|del_mtd_device
c_func
(paren
id|dev-&gt;mtd_info
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;mtd%d: Removed&quot;
comma
id|dev-&gt;mtd_info-&gt;index
)paren
suffix:semicolon
)brace
id|pcmciamtd_release
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_INSERTION
suffix:colon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;EVENT_CARD_INSERTION&quot;
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_PRESENT
op_or
id|DEV_CONFIG_PENDING
suffix:semicolon
id|pcmciamtd_config
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_SUSPEND
suffix:colon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;EVENT_PM_SUSPEND&quot;
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_RESET_PHYSICAL
suffix:colon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;EVENT_RESET_PHYSICAL&quot;
)paren
suffix:semicolon
multiline_comment|/* get_lock(link); */
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_RESUME
suffix:colon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;EVENT_PM_RESUME&quot;
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_CARD_RESET
suffix:colon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;EVENT_CARD_RESET&quot;
)paren
suffix:semicolon
multiline_comment|/* free_lock(link); */
r_break
suffix:semicolon
r_default
suffix:colon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Unknown event %d&quot;
comma
id|event
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This deletes a driver &quot;instance&quot;.  The device is de-registered&n; * with Card Services.  If it has been released, all local data&n; * structures are freed.  Otherwise, the structures will be freed&n; * when the device is released.&n; */
DECL|function|pcmciamtd_detach
r_static
r_void
id|pcmciamtd_detach
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|DEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;link=0x%p&quot;
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
id|pcmciamtd_release
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link-&gt;handle
)paren
(brace
r_int
id|ret
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Deregistering with card services&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|pcmcia_deregister_client
c_func
(paren
id|link-&gt;handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|DeregisterClient
comma
id|ret
)paren
suffix:semicolon
)brace
id|link-&gt;state
op_or_assign
id|DEV_STALE_LINK
suffix:semicolon
)brace
multiline_comment|/* pcmciamtd_attach() creates an &quot;instance&quot; of the driver, allocating&n; * local data structures for one device.  The device is registered&n; * with Card Services.&n; */
DECL|function|pcmciamtd_attach
r_static
id|dev_link_t
op_star
id|pcmciamtd_attach
c_func
(paren
r_void
)paren
(brace
r_struct
id|pcmciamtd_dev
op_star
id|dev
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
id|client_reg_t
id|client_reg
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* Create new memory card device */
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;dev=0x%p&quot;
comma
id|dev
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|link
op_assign
op_amp
id|dev-&gt;link
suffix:semicolon
id|link-&gt;priv
op_assign
id|dev
suffix:semicolon
id|link-&gt;conf.Attributes
op_assign
l_int|0
suffix:semicolon
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY
suffix:semicolon
id|link-&gt;next
op_assign
id|dev_list
suffix:semicolon
id|dev_list
op_assign
id|link
suffix:semicolon
multiline_comment|/* Register with Card Services */
id|client_reg.dev_info
op_assign
op_amp
id|dev_info
suffix:semicolon
id|client_reg.Attributes
op_assign
id|INFO_IO_CLIENT
op_or
id|INFO_CARD_SHARE
suffix:semicolon
id|client_reg.EventMask
op_assign
id|CS_EVENT_RESET_PHYSICAL
op_or
id|CS_EVENT_CARD_RESET
op_or
id|CS_EVENT_CARD_INSERTION
op_or
id|CS_EVENT_CARD_REMOVAL
op_or
id|CS_EVENT_PM_SUSPEND
op_or
id|CS_EVENT_PM_RESUME
suffix:semicolon
id|client_reg.event_handler
op_assign
op_amp
id|pcmciamtd_event
suffix:semicolon
id|client_reg.Version
op_assign
l_int|0x0210
suffix:semicolon
id|client_reg.event_callback_args.client_data
op_assign
id|link
suffix:semicolon
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Calling RegisterClient&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|pcmcia_register_client
c_func
(paren
op_amp
id|link-&gt;handle
comma
op_amp
id|client_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RegisterClient
comma
id|ret
)paren
suffix:semicolon
id|pcmciamtd_detach
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;link = %p&quot;
comma
id|link
)paren
suffix:semicolon
r_return
id|link
suffix:semicolon
)brace
DECL|variable|pcmciamtd_driver
r_static
r_struct
id|pcmcia_driver
id|pcmciamtd_driver
op_assign
(brace
dot
id|drv
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;pcmciamtd&quot;
)brace
comma
dot
id|attach
op_assign
id|pcmciamtd_attach
comma
dot
id|detach
op_assign
id|pcmciamtd_detach
comma
dot
id|owner
op_assign
id|THIS_MODULE
)brace
suffix:semicolon
DECL|function|init_pcmciamtd
r_static
r_int
id|__init
id|init_pcmciamtd
c_func
(paren
r_void
)paren
(brace
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bankwidth
op_logical_and
id|bankwidth
op_ne
l_int|1
op_logical_and
id|bankwidth
op_ne
l_int|2
)paren
(brace
id|info
c_func
(paren
l_string|&quot;bad bankwidth (%d), using default&quot;
comma
id|bankwidth
)paren
suffix:semicolon
id|bankwidth
op_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|force_size
op_logical_and
(paren
id|force_size
template_param
l_int|64
)paren
)paren
(brace
id|info
c_func
(paren
l_string|&quot;bad force_size (%d), using default&quot;
comma
id|force_size
)paren
suffix:semicolon
id|force_size
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mem_type
op_logical_and
id|mem_type
op_ne
l_int|1
op_logical_and
id|mem_type
op_ne
l_int|2
)paren
(brace
id|info
c_func
(paren
l_string|&quot;bad mem_type (%d), using default&quot;
comma
id|mem_type
)paren
suffix:semicolon
id|mem_type
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|pcmcia_register_driver
c_func
(paren
op_amp
id|pcmciamtd_driver
)paren
suffix:semicolon
)brace
DECL|function|exit_pcmciamtd
r_static
r_void
id|__exit
id|exit_pcmciamtd
c_func
(paren
r_void
)paren
(brace
id|DEBUG
c_func
(paren
l_int|1
comma
id|DRIVER_DESC
l_string|&quot; unloading&quot;
)paren
suffix:semicolon
id|pcmcia_unregister_driver
c_func
(paren
op_amp
id|pcmciamtd_driver
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dev_list
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|dev_list
suffix:semicolon
id|dev_list
op_assign
id|link-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|link
)paren
(brace
r_struct
id|pcmciamtd_dev
op_star
id|dev
op_assign
id|link-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_PRESENT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_LINK
)paren
)paren
(brace
id|pcmciamtd_detach
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
id|link-&gt;state
op_and_assign
op_complement
id|DEV_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;mtd_info
)paren
(brace
id|del_mtd_device
c_func
(paren
id|dev-&gt;mtd_info
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;mtd%d: Removed&quot;
comma
id|dev-&gt;mtd_info-&gt;index
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;mtd_info
)paren
(brace
id|DEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;Destroying map for mtd%d&quot;
comma
id|dev-&gt;mtd_info-&gt;index
)paren
suffix:semicolon
id|map_destroy
c_func
(paren
id|dev-&gt;mtd_info
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|variable|init_pcmciamtd
id|module_init
c_func
(paren
id|init_pcmciamtd
)paren
suffix:semicolon
DECL|variable|exit_pcmciamtd
id|module_exit
c_func
(paren
id|exit_pcmciamtd
)paren
suffix:semicolon
eof
