multiline_comment|/*&n; * MTD map driver for BIOS Flash on Intel SCB2 boards&n; * $Id: scb2_flash.c,v 1.6 2003/05/21 12:45:20 dwmw2 Exp $&n; * Copyright (C) 2002 Sun Microsystems, Inc.&n; * Tim Hockin &lt;thockin@sun.com&gt;&n; *&n; * A few notes on this MTD map:&n; *&n; * This was developed with a small number of SCB2 boards to test on.&n; * Hopefully, Intel has not introducted too many unaccounted variables in the&n; * making of this board.&n; *&n; * The BIOS marks its own memory region as &squot;reserved&squot; in the e820 map.  We&n; * try to request it here, but if it fails, we carry on anyway.&n; *&n; * This is how the chip is attached, so said the schematic:&n; * * a 4 MiB (32 Mib) 16 bit chip&n; * * a 1 MiB memory region&n; * * A20 and A21 pulled up&n; * * D8-D15 ignored&n; * What this means is that, while we are addressing bytes linearly, we are&n; * really addressing words, and discarding the other byte.  This means that&n; * the chip MUST BE at least 2 MiB.  This also means that every block is&n; * actually half as big as the chip reports.  It also means that accesses of&n; * logical address 0 hit higher-address sections of the chip, not physical 0.&n; * One can only hope that these 4MiB x16 chips were a lot cheaper than 1MiB x8&n; * chips.&n; *&n; * This driver assumes the chip is not write-protected by an external signal.&n; * As of the this writing, that is true, but may change, just to spite me.&n; *&n; * The actual BIOS layout has been mostly reverse engineered.  Intel BIOS&n; * updates for this board include 10 related (*.bio - &amp;.bi9) binary files and&n; * another seperate (*.bbo) binary file.  The 10 files are 64k of data + a&n; * small header.  If the headers are stripped off, the 10 64k files can be&n; * concatenated into a 640k image.  This is your BIOS image, proper.  The&n; * seperate .bbo file also has a small header.  It is the &squot;Boot Block&squot;&n; * recovery BIOS.  Once the header is stripped, no further prep is needed.&n; * As best I can tell, the BIOS is arranged as such:&n; * offset 0x00000 to 0x4ffff (320k):  unknown - SCSI BIOS, etc?&n; * offset 0x50000 to 0xeffff (640k):  BIOS proper&n; * offset 0xf0000 ty 0xfffff (64k):   Boot Block region&n; *&n; * Intel&squot;s BIOS update program flashes the BIOS and Boot Block in seperate&n; * steps.  Probably a wise thing to do.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
macro_line|#include &lt;linux/mtd/cfi.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/pci_ids.h&gt;
DECL|macro|MODNAME
mdefine_line|#define MODNAME&t;&t;&quot;scb2_flash&quot;
DECL|macro|SCB2_ADDR
mdefine_line|#define SCB2_ADDR&t;0xfff00000
DECL|macro|SCB2_WINDOW
mdefine_line|#define SCB2_WINDOW&t;0x00100000
DECL|variable|scb2_ioaddr
r_static
r_void
op_star
id|scb2_ioaddr
suffix:semicolon
DECL|variable|scb2_mtd
r_static
r_struct
id|mtd_info
op_star
id|scb2_mtd
suffix:semicolon
DECL|variable|scb2_map
r_struct
id|map_info
id|scb2_map
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;SCB2 BIOS Flash&quot;
comma
dot
id|size
op_assign
l_int|0
comma
dot
id|buswidth
op_assign
l_int|1
comma
)brace
suffix:semicolon
DECL|variable|region_fail
r_static
r_int
id|region_fail
suffix:semicolon
r_static
r_int
id|__devinit
DECL|function|scb2_fixup_mtd
id|scb2_fixup_mtd
c_func
(paren
r_struct
id|mtd_info
op_star
id|mtd
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|done
op_assign
l_int|0
suffix:semicolon
r_struct
id|map_info
op_star
id|map
op_assign
id|mtd-&gt;priv
suffix:semicolon
r_struct
id|cfi_private
op_star
id|cfi
op_assign
id|map-&gt;fldrv_priv
suffix:semicolon
multiline_comment|/* barf if this doesn&squot;t look right */
r_if
c_cond
(paren
id|cfi-&gt;cfiq-&gt;InterfaceDesc
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MODNAME
l_string|&quot;: unsupported InterfaceDesc: %#x&bslash;n&quot;
comma
id|cfi-&gt;cfiq-&gt;InterfaceDesc
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* I wasn&squot;t here. I didn&squot;t see. dwmw2. */
multiline_comment|/* the chip is sometimes bigger than the map - what a waste */
id|mtd-&gt;size
op_assign
id|map-&gt;size
suffix:semicolon
multiline_comment|/*&n;&t; * We only REALLY get half the chip, due to the way it is&n;&t; * wired up - D8-D15 are tossed away.  We read linear bytes,&n;&t; * but in reality we are getting 1/2 of each 16-bit read,&n;&t; * which LOOKS linear to us.  Because CFI code accounts for&n;&t; * things like lock/unlock/erase by eraseregions, we need to&n;&t; * fudge them to reflect this.  Erases go like this:&n;&t; *   * send an erase to an address&n;&t; *   * the chip samples the address and erases the block&n;&t; *   * add the block erasesize to the address and repeat&n;&t; *   -- the problem is that addresses are 16-bit addressable&n;&t; *   -- we end up erasing every-other block&n;&t; */
id|mtd-&gt;erasesize
op_div_assign
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mtd-&gt;numeraseregions
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|mtd_erase_region_info
op_star
id|region
op_assign
op_amp
id|mtd-&gt;eraseregions
(braket
id|i
)braket
suffix:semicolon
id|region-&gt;erasesize
op_div_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If the chip is bigger than the map, it is wired with the high&n;&t; * address lines pulled up.  This makes us access the top portion of&n;&t; * the chip, so all our erase-region info is wrong.  Start cutting from&n;&t; * the bottom.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|done
op_logical_and
id|i
OL
id|mtd-&gt;numeraseregions
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|mtd_erase_region_info
op_star
id|region
op_assign
op_amp
id|mtd-&gt;eraseregions
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|region-&gt;numblocks
op_star
id|region-&gt;erasesize
OG
id|mtd-&gt;size
)paren
(brace
id|region-&gt;numblocks
op_assign
(paren
id|mtd-&gt;size
op_div
id|region-&gt;erasesize
)paren
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|region-&gt;numblocks
op_assign
l_int|0
suffix:semicolon
)brace
id|region-&gt;offset
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* CSB5&squot;s &squot;Function Control Register&squot; has bits for decoding @ &gt;= 0xffc00000 */
DECL|macro|CSB5_FCR
mdefine_line|#define CSB5_FCR&t;0x41
DECL|macro|CSB5_FCR_DECODE_ALL
mdefine_line|#define CSB5_FCR_DECODE_ALL 0x0e
r_static
r_int
id|__devinit
DECL|function|scb2_flash_probe
id|scb2_flash_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
id|u8
id|reg
suffix:semicolon
multiline_comment|/* enable decoding of the flash region in the south bridge */
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|CSB5_FCR
comma
op_amp
id|reg
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|CSB5_FCR
comma
id|reg
op_or
id|CSB5_FCR_DECODE_ALL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|SCB2_ADDR
comma
id|SCB2_WINDOW
comma
id|scb2_map.name
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * The BIOS seems to mark the flash region as &squot;reserved&squot;&n;&t;&t; * in the e820 map.  Warn and go about our business.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
id|MODNAME
l_string|&quot;: warning - can&squot;t reserve rom window, continuing&bslash;n&quot;
)paren
suffix:semicolon
id|region_fail
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* remap the IO window (w/o caching) */
id|scb2_ioaddr
op_assign
id|ioremap_nocache
c_func
(paren
id|SCB2_ADDR
comma
id|SCB2_WINDOW
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb2_ioaddr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MODNAME
l_string|&quot;: Failed to ioremap window!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|region_fail
)paren
id|release_mem_region
c_func
(paren
id|SCB2_ADDR
comma
id|SCB2_WINDOW
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|scb2_map.phys
op_assign
id|SCB2_ADDR
suffix:semicolon
id|scb2_map.virt
op_assign
(paren
r_int
r_int
)paren
id|scb2_ioaddr
suffix:semicolon
id|scb2_map.size
op_assign
id|SCB2_WINDOW
suffix:semicolon
id|simple_map_init
c_func
(paren
op_amp
id|scb2_map
)paren
suffix:semicolon
multiline_comment|/* try to find a chip */
id|scb2_mtd
op_assign
id|do_map_probe
c_func
(paren
l_string|&quot;cfi_probe&quot;
comma
op_amp
id|scb2_map
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scb2_mtd
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MODNAME
l_string|&quot;: flash probe failed!&bslash;n&quot;
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|scb2_ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|region_fail
)paren
id|release_mem_region
c_func
(paren
id|SCB2_ADDR
comma
id|SCB2_WINDOW
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|scb2_mtd-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
r_if
c_cond
(paren
id|scb2_fixup_mtd
c_func
(paren
id|scb2_mtd
)paren
OL
l_int|0
)paren
(brace
id|del_mtd_device
c_func
(paren
id|scb2_mtd
)paren
suffix:semicolon
id|map_destroy
c_func
(paren
id|scb2_mtd
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|scb2_ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|region_fail
)paren
id|release_mem_region
c_func
(paren
id|SCB2_ADDR
comma
id|SCB2_WINDOW
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
id|MODNAME
l_string|&quot;: chip size 0x%x at offset 0x%x&bslash;n&quot;
comma
id|scb2_mtd-&gt;size
comma
id|SCB2_WINDOW
op_minus
id|scb2_mtd-&gt;size
)paren
suffix:semicolon
id|add_mtd_device
c_func
(paren
id|scb2_mtd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__devexit
DECL|function|scb2_flash_remove
id|scb2_flash_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|scb2_mtd
)paren
r_return
suffix:semicolon
multiline_comment|/* disable flash writes */
r_if
c_cond
(paren
id|scb2_mtd-&gt;lock
)paren
id|scb2_mtd
op_member_access_from_pointer
id|lock
c_func
(paren
id|scb2_mtd
comma
l_int|0
comma
id|scb2_mtd-&gt;size
)paren
suffix:semicolon
id|del_mtd_device
c_func
(paren
id|scb2_mtd
)paren
suffix:semicolon
id|map_destroy
c_func
(paren
id|scb2_mtd
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|scb2_ioaddr
)paren
suffix:semicolon
id|scb2_ioaddr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|region_fail
)paren
id|release_mem_region
c_func
(paren
id|SCB2_ADDR
comma
id|SCB2_WINDOW
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|scb2_flash_pci_ids
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_SERVERWORKS
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_SERVERWORKS_CSB5
comma
dot
id|subvendor
op_assign
id|PCI_ANY_ID
comma
dot
id|subdevice
op_assign
id|PCI_ANY_ID
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
DECL|variable|scb2_flash_driver
r_static
r_struct
id|pci_driver
id|scb2_flash_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Intel SCB2 BIOS Flash&quot;
comma
dot
id|id_table
op_assign
id|scb2_flash_pci_ids
comma
dot
id|probe
op_assign
id|scb2_flash_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|scb2_flash_remove
)paren
comma
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|scb2_flash_init
id|scb2_flash_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|scb2_flash_driver
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|scb2_flash_exit
id|scb2_flash_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|scb2_flash_driver
)paren
suffix:semicolon
)brace
DECL|variable|scb2_flash_init
id|module_init
c_func
(paren
id|scb2_flash_init
)paren
suffix:semicolon
DECL|variable|scb2_flash_exit
id|module_exit
c_func
(paren
id|scb2_flash_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Tim Hockin &lt;thockin@sun.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;MTD map driver for Intel SCB2 BIOS Flash&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|scb2_flash_pci_ids
)paren
suffix:semicolon
eof
