multiline_comment|/*&n; * Flash memory access on SA11x0 based devices&n; * &n; * (C) 2000 Nicolas Pitre &lt;nico@cam.org&gt;&n; * &n; * $Id: sa1100-flash.c,v 1.47 2004/11/01 13:44:36 rmk Exp $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/err.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/mtd/map.h&gt;
macro_line|#include &lt;linux/mtd/partitions.h&gt;
macro_line|#include &lt;linux/mtd/concat.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/sizes.h&gt;
macro_line|#include &lt;asm/mach/flash.h&gt;
macro_line|#if 0
multiline_comment|/*&n; * This is here for documentation purposes only - until these people&n; * submit their machine types.  It will be gone January 2005.&n; */
r_static
r_struct
id|mtd_partition
id|consus_partitions
(braket
)braket
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;Consus boot firmware&quot;
comma
dot
id|offset
op_assign
l_int|0
comma
dot
id|size
op_assign
l_int|0x00040000
comma
dot
id|mask_flags
op_assign
id|MTD_WRITABLE
comma
multiline_comment|/* force read-only */
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;Consus kernel&quot;
comma
dot
id|offset
op_assign
l_int|0x00040000
comma
dot
id|size
op_assign
l_int|0x00100000
comma
dot
id|mask_flags
op_assign
l_int|0
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;Consus disk&quot;
comma
dot
id|offset
op_assign
l_int|0x00140000
comma
multiline_comment|/* The rest (up to 16M) for jffs.  We could put 0 and&n;&t;&t;   make it find the size automatically, but right now&n;&t;&t;   i have 32 megs.  jffs will use all 32 megs if given&n;&t;&t;   the chance, and this leads to horrible problems&n;&t;&t;   when you try to re-flash the image because blob&n;&t;&t;   won&squot;t erase the whole partition. */
dot
id|size
op_assign
l_int|0x01000000
op_minus
l_int|0x00140000
comma
dot
id|mask_flags
op_assign
l_int|0
comma
)brace
comma
(brace
multiline_comment|/* this disk is a secondary disk, which can be used as&n;&t;&t;   needed, for simplicity, make it the size of the other&n;&t;&t;   consus partition, although realistically it could be&n;&t;&t;   the remainder of the disk (depending on the file&n;&t;&t;   system used) */
dot
id|name
op_assign
l_string|&quot;Consus disk2&quot;
comma
dot
id|offset
op_assign
l_int|0x01000000
comma
dot
id|size
op_assign
l_int|0x01000000
op_minus
l_int|0x00140000
comma
dot
id|mask_flags
op_assign
l_int|0
comma
)brace
)brace
suffix:semicolon
multiline_comment|/* Frodo has 2 x 16M 28F128J3A flash chips in bank 0: */
r_static
r_struct
id|mtd_partition
id|frodo_partitions
(braket
)braket
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;bootloader&quot;
comma
dot
id|size
op_assign
l_int|0x00040000
comma
dot
id|offset
op_assign
l_int|0x00000000
comma
dot
id|mask_flags
op_assign
id|MTD_WRITEABLE
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;bootloader params&quot;
comma
dot
id|size
op_assign
l_int|0x00040000
comma
dot
id|offset
op_assign
id|MTDPART_OFS_APPEND
comma
dot
id|mask_flags
op_assign
id|MTD_WRITEABLE
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;kernel&quot;
comma
dot
id|size
op_assign
l_int|0x00100000
comma
dot
id|offset
op_assign
id|MTDPART_OFS_APPEND
comma
dot
id|mask_flags
op_assign
id|MTD_WRITEABLE
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;ramdisk&quot;
comma
dot
id|size
op_assign
l_int|0x00400000
comma
dot
id|offset
op_assign
id|MTDPART_OFS_APPEND
comma
dot
id|mask_flags
op_assign
id|MTD_WRITEABLE
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;file system&quot;
comma
dot
id|size
op_assign
id|MTDPART_SIZ_FULL
comma
dot
id|offset
op_assign
id|MTDPART_OFS_APPEND
)brace
)brace
suffix:semicolon
r_static
r_struct
id|mtd_partition
id|jornada56x_partitions
(braket
)braket
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;bootldr&quot;
comma
dot
id|size
op_assign
l_int|0x00040000
comma
dot
id|offset
op_assign
l_int|0
comma
dot
id|mask_flags
op_assign
id|MTD_WRITEABLE
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;rootfs&quot;
comma
dot
id|size
op_assign
id|MTDPART_SIZ_FULL
comma
dot
id|offset
op_assign
id|MTDPART_OFS_APPEND
comma
)brace
)brace
suffix:semicolon
r_static
r_void
id|jornada56x_set_vpp
c_func
(paren
r_int
id|vpp
)paren
(brace
r_if
c_cond
(paren
id|vpp
)paren
id|GPSR
op_assign
id|GPIO_GPIO26
suffix:semicolon
r_else
id|GPCR
op_assign
id|GPIO_GPIO26
suffix:semicolon
id|GPDR
op_or_assign
id|GPIO_GPIO26
suffix:semicolon
)brace
multiline_comment|/*&n; * Machine        Phys          Size    set_vpp&n; * Consus    : SA1100_CS0_PHYS SZ_32M&n; * Frodo     : SA1100_CS0_PHYS SZ_32M&n; * Jornada56x: SA1100_CS0_PHYS SZ_32M jornada56x_set_vpp&n; */
macro_line|#endif
DECL|struct|sa_subdev_info
r_struct
id|sa_subdev_info
(brace
DECL|member|name
r_char
id|name
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|map
r_struct
id|map_info
id|map
suffix:semicolon
DECL|member|mtd
r_struct
id|mtd_info
op_star
id|mtd
suffix:semicolon
DECL|member|data
r_struct
id|flash_platform_data
op_star
id|data
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sa_info
r_struct
id|sa_info
(brace
DECL|member|parts
r_struct
id|mtd_partition
op_star
id|parts
suffix:semicolon
DECL|member|mtd
r_struct
id|mtd_info
op_star
id|mtd
suffix:semicolon
DECL|member|num_subdev
r_int
id|num_subdev
suffix:semicolon
DECL|member|subdev
r_struct
id|sa_subdev_info
id|subdev
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|sa1100_set_vpp
r_static
r_void
id|sa1100_set_vpp
c_func
(paren
r_struct
id|map_info
op_star
id|map
comma
r_int
id|on
)paren
(brace
r_struct
id|sa_subdev_info
op_star
id|subdev
op_assign
id|container_of
c_func
(paren
id|map
comma
r_struct
id|sa_subdev_info
comma
id|map
)paren
suffix:semicolon
id|subdev-&gt;data
op_member_access_from_pointer
id|set_vpp
c_func
(paren
id|on
)paren
suffix:semicolon
)brace
DECL|function|sa1100_destroy_subdev
r_static
r_void
id|sa1100_destroy_subdev
c_func
(paren
r_struct
id|sa_subdev_info
op_star
id|subdev
)paren
(brace
r_if
c_cond
(paren
id|subdev-&gt;mtd
)paren
id|map_destroy
c_func
(paren
id|subdev-&gt;mtd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|subdev-&gt;map.virt
)paren
id|iounmap
c_func
(paren
id|subdev-&gt;map.virt
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|subdev-&gt;map.phys
comma
id|subdev-&gt;map.size
)paren
suffix:semicolon
)brace
DECL|function|sa1100_probe_subdev
r_static
r_int
id|sa1100_probe_subdev
c_func
(paren
r_struct
id|sa_subdev_info
op_star
id|subdev
comma
r_struct
id|resource
op_star
id|res
)paren
(brace
r_int
r_int
id|phys
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|phys
op_assign
id|res-&gt;start
suffix:semicolon
id|size
op_assign
id|res-&gt;end
op_minus
id|phys
op_plus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Retrieve the bankwidth from the MSC registers.&n;&t; * We currently only implement CS0 and CS1 here.&n;&t; */
r_switch
c_cond
(paren
id|phys
)paren
(brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SA1100 flash: unknown base address &quot;
l_string|&quot;0x%08lx, assuming CS0&bslash;n&quot;
comma
id|phys
)paren
suffix:semicolon
r_case
id|SA1100_CS0_PHYS
suffix:colon
id|subdev-&gt;map.bankwidth
op_assign
(paren
id|MSC0
op_amp
id|MSC_RBW
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SA1100_CS1_PHYS
suffix:colon
id|subdev-&gt;map.bankwidth
op_assign
(paren
(paren
id|MSC0
op_rshift
l_int|16
)paren
op_amp
id|MSC_RBW
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|phys
comma
id|size
comma
id|subdev-&gt;name
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|subdev-&gt;data-&gt;set_vpp
)paren
id|subdev-&gt;map.set_vpp
op_assign
id|sa1100_set_vpp
suffix:semicolon
id|subdev-&gt;map.phys
op_assign
id|phys
suffix:semicolon
id|subdev-&gt;map.size
op_assign
id|size
suffix:semicolon
id|subdev-&gt;map.virt
op_assign
id|ioremap
c_func
(paren
id|phys
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|subdev-&gt;map.virt
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|simple_map_init
c_func
(paren
op_amp
id|subdev-&gt;map
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now let&squot;s probe for the actual flash.  Do it here since&n;&t; * specific machine settings might have been set above.&n;&t; */
id|subdev-&gt;mtd
op_assign
id|do_map_probe
c_func
(paren
id|subdev-&gt;data-&gt;map_name
comma
op_amp
id|subdev-&gt;map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|subdev-&gt;mtd
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|subdev-&gt;mtd-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SA1100 flash: CFI device at 0x%08lx, %dMiB, &quot;
l_string|&quot;%d-bit&bslash;n&quot;
comma
id|phys
comma
id|subdev-&gt;mtd-&gt;size
op_rshift
l_int|20
comma
id|subdev-&gt;map.bankwidth
op_star
l_int|8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
id|sa1100_destroy_subdev
c_func
(paren
id|subdev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sa1100_destroy
r_static
r_void
id|sa1100_destroy
c_func
(paren
r_struct
id|sa_info
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;mtd
)paren
(brace
id|del_mtd_partitions
c_func
(paren
id|info-&gt;mtd
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MTD_CONCAT
r_if
c_cond
(paren
id|info-&gt;mtd
op_ne
id|info-&gt;subdev
(braket
l_int|0
)braket
dot
id|mtd
)paren
id|mtd_concat_destroy
c_func
(paren
id|info-&gt;mtd
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|info-&gt;parts
)paren
id|kfree
c_func
(paren
id|info-&gt;parts
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|info-&gt;num_subdev
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|sa1100_destroy_subdev
c_func
(paren
op_amp
id|info-&gt;subdev
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_static
r_struct
id|sa_info
op_star
id|__init
DECL|function|sa1100_setup_mtd
id|sa1100_setup_mtd
c_func
(paren
r_struct
id|platform_device
op_star
id|pdev
comma
r_struct
id|flash_platform_data
op_star
id|flash
)paren
(brace
r_struct
id|sa_info
op_star
id|info
suffix:semicolon
r_int
id|nr
comma
id|size
comma
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Count number of devices.&n;&t; */
r_for
c_loop
(paren
id|nr
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
id|nr
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|platform_get_resource
c_func
(paren
id|pdev
comma
id|IORESOURCE_MEM
comma
id|nr
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|nr
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|size
op_assign
r_sizeof
(paren
r_struct
id|sa_info
)paren
op_plus
r_sizeof
(paren
r_struct
id|sa_subdev_info
)paren
op_star
id|nr
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate the map_info structs in one go.&n;&t; */
id|info
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Claim and then map the memory regions.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sa_subdev_info
op_star
id|subdev
op_assign
op_amp
id|info-&gt;subdev
(braket
id|i
)braket
suffix:semicolon
r_struct
id|resource
op_star
id|res
suffix:semicolon
id|res
op_assign
id|platform_get_resource
c_func
(paren
id|pdev
comma
id|IORESOURCE_MEM
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
r_break
suffix:semicolon
id|subdev-&gt;map.name
op_assign
id|subdev-&gt;name
suffix:semicolon
id|sprintf
c_func
(paren
id|subdev-&gt;name
comma
l_string|&quot;sa1100-%d&quot;
comma
id|i
)paren
suffix:semicolon
id|subdev-&gt;data
op_assign
id|flash
suffix:semicolon
id|ret
op_assign
id|sa1100_probe_subdev
c_func
(paren
id|subdev
comma
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_break
suffix:semicolon
)brace
id|info-&gt;num_subdev
op_assign
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * ENXIO is special.  It means we didn&squot;t find a chip when we probed.&n;&t; */
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
op_logical_and
op_logical_neg
(paren
id|ret
op_eq
op_minus
id|ENXIO
op_logical_and
id|info-&gt;num_subdev
OG
l_int|0
)paren
)paren
r_goto
id|err
suffix:semicolon
multiline_comment|/*&n;&t; * If we found one device, don&squot;t bother with concat support.  If&n;&t; * we found multiple devices, use concat if we have it available,&n;&t; * otherwise fail.  Either way, it&squot;ll be called &quot;sa1100&quot;.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;num_subdev
op_eq
l_int|1
)paren
(brace
id|strcpy
c_func
(paren
id|info-&gt;subdev
(braket
l_int|0
)braket
dot
id|name
comma
l_string|&quot;sa1100&quot;
)paren
suffix:semicolon
id|info-&gt;mtd
op_assign
id|info-&gt;subdev
(braket
l_int|0
)braket
dot
id|mtd
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;num_subdev
OG
l_int|1
)paren
(brace
macro_line|#ifdef CONFIG_MTD_CONCAT
r_struct
id|mtd_info
op_star
id|cdev
(braket
id|nr
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We detected multiple devices.  Concatenate them together.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|info-&gt;num_subdev
suffix:semicolon
id|i
op_increment
)paren
id|cdev
(braket
id|i
)braket
op_assign
id|info-&gt;subdev
(braket
id|i
)braket
dot
id|mtd
suffix:semicolon
id|info-&gt;mtd
op_assign
id|mtd_concat_create
c_func
(paren
id|cdev
comma
id|info-&gt;num_subdev
comma
l_string|&quot;sa1100&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;mtd
op_eq
l_int|NULL
)paren
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SA1100 flash: multiple devices &quot;
l_string|&quot;found but MTD concat support disabled.&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
r_return
id|info
suffix:semicolon
id|err
suffix:colon
id|sa1100_destroy
c_func
(paren
id|info
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ERR_PTR
c_func
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|variable|part_probes
r_static
r_const
r_char
op_star
id|part_probes
(braket
)braket
op_assign
(brace
l_string|&quot;cmdlinepart&quot;
comma
l_string|&quot;RedBoot&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|sa1100_mtd_probe
r_static
r_int
id|__init
id|sa1100_mtd_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|platform_device
op_star
id|pdev
op_assign
id|to_platform_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|flash_platform_data
op_star
id|flash
op_assign
id|pdev-&gt;dev.platform_data
suffix:semicolon
r_struct
id|mtd_partition
op_star
id|parts
suffix:semicolon
r_const
r_char
op_star
id|part_type
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sa_info
op_star
id|info
suffix:semicolon
r_int
id|err
comma
id|nr_parts
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|flash
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|info
op_assign
id|sa1100_setup_mtd
c_func
(paren
id|pdev
comma
id|flash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|info
)paren
)paren
(brace
id|err
op_assign
id|PTR_ERR
c_func
(paren
id|info
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Partition selection stuff.&n;&t; */
macro_line|#ifdef CONFIG_MTD_PARTITIONS
id|nr_parts
op_assign
id|parse_mtd_partitions
c_func
(paren
id|info-&gt;mtd
comma
id|part_probes
comma
op_amp
id|parts
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nr_parts
OG
l_int|0
)paren
(brace
id|info-&gt;parts
op_assign
id|parts
suffix:semicolon
id|part_type
op_assign
l_string|&quot;dynamic&quot;
suffix:semicolon
)brace
r_else
macro_line|#endif
(brace
id|parts
op_assign
id|flash-&gt;parts
suffix:semicolon
id|nr_parts
op_assign
id|flash-&gt;nr_parts
suffix:semicolon
id|part_type
op_assign
l_string|&quot;static&quot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nr_parts
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;SA1100 flash: no partition info &quot;
l_string|&quot;available, registering whole flash&bslash;n&quot;
)paren
suffix:semicolon
id|add_mtd_device
c_func
(paren
id|info-&gt;mtd
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;SA1100 flash: using %s partition &quot;
l_string|&quot;definition&bslash;n&quot;
comma
id|part_type
)paren
suffix:semicolon
id|add_mtd_partitions
c_func
(paren
id|info-&gt;mtd
comma
id|parts
comma
id|nr_parts
)paren
suffix:semicolon
)brace
id|dev_set_drvdata
c_func
(paren
id|dev
comma
id|info
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|sa1100_mtd_remove
r_static
r_int
id|__exit
id|sa1100_mtd_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|sa_info
op_star
id|info
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
id|sa1100_destroy
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
DECL|function|sa1100_mtd_suspend
r_static
r_int
id|sa1100_mtd_suspend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
comma
id|u32
id|level
)paren
(brace
r_struct
id|sa_info
op_star
id|info
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info
op_logical_and
id|level
op_eq
id|SUSPEND_SAVE_STATE
)paren
id|ret
op_assign
id|info-&gt;mtd
op_member_access_from_pointer
id|suspend
c_func
(paren
id|info-&gt;mtd
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sa1100_mtd_resume
r_static
r_int
id|sa1100_mtd_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|level
)paren
(brace
r_struct
id|sa_info
op_star
id|info
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
op_logical_and
id|level
op_eq
id|RESUME_RESTORE_STATE
)paren
id|info-&gt;mtd
op_member_access_from_pointer
id|resume
c_func
(paren
id|info-&gt;mtd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|macro|sa1100_mtd_suspend
mdefine_line|#define sa1100_mtd_suspend NULL
DECL|macro|sa1100_mtd_resume
mdefine_line|#define sa1100_mtd_resume  NULL
macro_line|#endif
DECL|variable|sa1100_mtd_driver
r_static
r_struct
id|device_driver
id|sa1100_mtd_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;flash&quot;
comma
dot
id|bus
op_assign
op_amp
id|platform_bus_type
comma
dot
id|probe
op_assign
id|sa1100_mtd_probe
comma
dot
id|remove
op_assign
id|__exit_p
c_func
(paren
id|sa1100_mtd_remove
)paren
comma
dot
id|suspend
op_assign
id|sa1100_mtd_suspend
comma
dot
id|resume
op_assign
id|sa1100_mtd_resume
comma
)brace
suffix:semicolon
DECL|function|sa1100_mtd_init
r_static
r_int
id|__init
id|sa1100_mtd_init
c_func
(paren
r_void
)paren
(brace
r_return
id|driver_register
c_func
(paren
op_amp
id|sa1100_mtd_driver
)paren
suffix:semicolon
)brace
DECL|function|sa1100_mtd_exit
r_static
r_void
id|__exit
id|sa1100_mtd_exit
c_func
(paren
r_void
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|sa1100_mtd_driver
)paren
suffix:semicolon
)brace
DECL|variable|sa1100_mtd_init
id|module_init
c_func
(paren
id|sa1100_mtd_init
)paren
suffix:semicolon
DECL|variable|sa1100_mtd_exit
id|module_exit
c_func
(paren
id|sa1100_mtd_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Nicolas Pitre&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SA1100 CFI map driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
