multiline_comment|/*&n; * Device driver for the i2c thermostat found on the iBook G4, Albook G4&n; *&n; * Copyright (C) 2003, 2004 Colin Leroy, Rasmus Rohde, Benjamin Herrenschmidt&n; *&n; * Documentation from&n; * http://www.analog.com/UploadedFiles/Data_Sheets/115254175ADT7467_pra.pdf&n; * http://www.analog.com/UploadedFiles/Data_Sheets/3686221171167ADT7460_b.pdf&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/suspend.h&gt;
macro_line|#include &lt;linux/kthread.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/sections.h&gt;
macro_line|#include &lt;asm/of_device.h&gt;
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|macro|CONFIG_REG
mdefine_line|#define CONFIG_REG   0x40
DECL|macro|MANUAL_MASK
mdefine_line|#define MANUAL_MASK  0xe0
DECL|macro|AUTO_MASK
mdefine_line|#define AUTO_MASK    0x20
DECL|variable|TEMP_REG
r_static
id|u8
id|TEMP_REG
(braket
l_int|3
)braket
op_assign
(brace
l_int|0x26
comma
l_int|0x25
comma
l_int|0x27
)brace
suffix:semicolon
multiline_comment|/* local, cpu, gpu */
DECL|variable|LIMIT_REG
r_static
id|u8
id|LIMIT_REG
(braket
l_int|3
)braket
op_assign
(brace
l_int|0x6b
comma
l_int|0x6a
comma
l_int|0x6c
)brace
suffix:semicolon
multiline_comment|/* local, cpu, gpu */
DECL|variable|MANUAL_MODE
r_static
id|u8
id|MANUAL_MODE
(braket
l_int|2
)braket
op_assign
(brace
l_int|0x5c
comma
l_int|0x5d
)brace
suffix:semicolon
DECL|variable|REM_CONTROL
r_static
id|u8
id|REM_CONTROL
(braket
l_int|2
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x40
)brace
suffix:semicolon
DECL|variable|FAN_SPEED
r_static
id|u8
id|FAN_SPEED
(braket
l_int|2
)braket
op_assign
(brace
l_int|0x28
comma
l_int|0x2a
)brace
suffix:semicolon
DECL|variable|FAN_SPD_SET
r_static
id|u8
id|FAN_SPD_SET
(braket
l_int|2
)braket
op_assign
(brace
l_int|0x30
comma
l_int|0x31
)brace
suffix:semicolon
DECL|variable|default_limits_local
r_static
id|u8
id|default_limits_local
(braket
l_int|3
)braket
op_assign
(brace
l_int|70
comma
l_int|50
comma
l_int|70
)brace
suffix:semicolon
multiline_comment|/* local, cpu, gpu */
DECL|variable|default_limits_chip
r_static
id|u8
id|default_limits_chip
(braket
l_int|3
)braket
op_assign
(brace
l_int|80
comma
l_int|65
comma
l_int|80
)brace
suffix:semicolon
multiline_comment|/* local, cpu, gpu */
DECL|variable|limit_adjust
r_static
r_int
id|limit_adjust
op_assign
l_int|0
suffix:semicolon
DECL|variable|fan_speed
r_static
r_int
id|fan_speed
op_assign
op_minus
l_int|1
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Colin Leroy &lt;colin@colino.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for ADT746x thermostat in iBook G4 and &quot;
l_string|&quot;Powerbook G4 Alu&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|limit_adjust
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|limit_adjust
comma
l_string|&quot;Adjust maximum temperatures (50 cpu, 70 gpu) &quot;
l_string|&quot;by N degrees.&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|fan_speed
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|fan_speed
comma
l_string|&quot;Specify starting fan speed (0-255) &quot;
l_string|&quot;(default 64)&quot;
)paren
suffix:semicolon
DECL|struct|thermostat
r_struct
id|thermostat
(brace
DECL|member|clt
r_struct
id|i2c_client
id|clt
suffix:semicolon
DECL|member|temps
id|u8
id|temps
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|cached_temp
id|u8
id|cached_temp
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|initial_limits
id|u8
id|initial_limits
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|limits
id|u8
id|limits
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|last_speed
r_int
id|last_speed
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|last_var
r_int
id|last_var
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|enumerator|ADT7460
DECL|enumerator|ADT7467
DECL|variable|therm_type
r_static
r_enum
(brace
id|ADT7460
comma
id|ADT7467
)brace
id|therm_type
suffix:semicolon
DECL|variable|therm_bus
DECL|variable|therm_address
r_static
r_int
id|therm_bus
comma
id|therm_address
suffix:semicolon
DECL|variable|of_dev
r_static
r_struct
id|of_device
op_star
id|of_dev
suffix:semicolon
DECL|variable|thermostat
r_static
r_struct
id|thermostat
op_star
id|thermostat
suffix:semicolon
DECL|variable|thread_therm
r_static
r_struct
id|task_struct
op_star
id|thread_therm
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
id|attach_one_thermostat
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|addr
comma
r_int
id|busno
)paren
suffix:semicolon
r_static
r_void
id|write_both_fan_speed
c_func
(paren
r_struct
id|thermostat
op_star
id|th
comma
r_int
id|speed
)paren
suffix:semicolon
r_static
r_void
id|write_fan_speed
c_func
(paren
r_struct
id|thermostat
op_star
id|th
comma
r_int
id|speed
comma
r_int
id|fan
)paren
suffix:semicolon
r_static
r_int
DECL|function|write_reg
id|write_reg
c_func
(paren
r_struct
id|thermostat
op_star
id|th
comma
r_int
id|reg
comma
id|u8
id|data
)paren
(brace
id|u8
id|tmp
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|tmp
(braket
l_int|0
)braket
op_assign
id|reg
suffix:semicolon
id|tmp
(braket
l_int|1
)braket
op_assign
id|data
suffix:semicolon
id|rc
op_assign
id|i2c_master_send
c_func
(paren
op_amp
id|th-&gt;clt
comma
(paren
r_const
r_char
op_star
)paren
id|tmp
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|2
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_reg
id|read_reg
c_func
(paren
r_struct
id|thermostat
op_star
id|th
comma
r_int
id|reg
)paren
(brace
id|u8
id|reg_addr
comma
id|data
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|reg_addr
op_assign
(paren
id|u8
)paren
id|reg
suffix:semicolon
id|rc
op_assign
id|i2c_master_send
c_func
(paren
op_amp
id|th-&gt;clt
comma
op_amp
id|reg_addr
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|1
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|rc
op_assign
id|i2c_master_recv
c_func
(paren
op_amp
id|th-&gt;clt
comma
(paren
r_char
op_star
)paren
op_amp
id|data
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
r_static
r_int
DECL|function|attach_thermostat
id|attach_thermostat
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
(brace
r_int
r_int
id|bus_no
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|adapter-&gt;name
comma
l_string|&quot;uni-n&quot;
comma
l_int|5
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|bus_no
op_assign
id|simple_strtoul
c_func
(paren
id|adapter-&gt;name
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus_no
op_ne
id|therm_bus
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|attach_one_thermostat
c_func
(paren
id|adapter
comma
id|therm_address
comma
id|bus_no
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|detach_thermostat
id|detach_thermostat
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
(brace
r_struct
id|thermostat
op_star
id|th
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|thermostat
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|th
op_assign
id|thermostat
suffix:semicolon
r_if
c_cond
(paren
id|thread_therm
op_ne
l_int|NULL
)paren
(brace
id|kthread_stop
c_func
(paren
id|thread_therm
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;adt746x: Putting max temperatures back from &quot;
l_string|&quot;%d, %d, %d to %d, %d, %d&bslash;n&quot;
comma
id|th-&gt;limits
(braket
l_int|0
)braket
comma
id|th-&gt;limits
(braket
l_int|1
)braket
comma
id|th-&gt;limits
(braket
l_int|2
)braket
comma
id|th-&gt;initial_limits
(braket
l_int|0
)braket
comma
id|th-&gt;initial_limits
(braket
l_int|1
)braket
comma
id|th-&gt;initial_limits
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|write_reg
c_func
(paren
id|th
comma
id|LIMIT_REG
(braket
id|i
)braket
comma
id|th-&gt;initial_limits
(braket
id|i
)braket
)paren
suffix:semicolon
id|write_both_fan_speed
c_func
(paren
id|th
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|i2c_detach_client
c_func
(paren
op_amp
id|th-&gt;clt
)paren
suffix:semicolon
id|thermostat
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|th
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|thermostat_driver
r_static
r_struct
id|i2c_driver
id|thermostat_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Apple Thermostat ADT746x&quot;
comma
dot
id|id
op_assign
l_int|0xDEAD7467
comma
dot
id|flags
op_assign
id|I2C_DF_NOTIFY
comma
dot
id|attach_adapter
op_assign
op_amp
id|attach_thermostat
comma
dot
id|detach_adapter
op_assign
op_amp
id|detach_thermostat
comma
)brace
suffix:semicolon
DECL|function|read_fan_speed
r_static
r_int
id|read_fan_speed
c_func
(paren
r_struct
id|thermostat
op_star
id|th
comma
id|u8
id|addr
)paren
(brace
id|u8
id|tmp
(braket
l_int|2
)braket
suffix:semicolon
id|u16
id|res
suffix:semicolon
multiline_comment|/* should start with low byte */
id|tmp
(braket
l_int|1
)braket
op_assign
id|read_reg
c_func
(paren
id|th
comma
id|addr
)paren
suffix:semicolon
id|tmp
(braket
l_int|0
)braket
op_assign
id|read_reg
c_func
(paren
id|th
comma
id|addr
op_plus
l_int|1
)paren
suffix:semicolon
id|res
op_assign
id|tmp
(braket
l_int|1
)braket
op_plus
(paren
id|tmp
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* &quot;a value of 0xffff means that the fan has stopped&quot; */
r_return
(paren
id|res
op_eq
l_int|0xffff
ques
c_cond
l_int|0
suffix:colon
(paren
l_int|90000
op_star
l_int|60
)paren
op_div
id|res
)paren
suffix:semicolon
)brace
DECL|function|write_both_fan_speed
r_static
r_void
id|write_both_fan_speed
c_func
(paren
r_struct
id|thermostat
op_star
id|th
comma
r_int
id|speed
)paren
(brace
id|write_fan_speed
c_func
(paren
id|th
comma
id|speed
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|therm_type
op_eq
id|ADT7460
)paren
id|write_fan_speed
c_func
(paren
id|th
comma
id|speed
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|write_fan_speed
r_static
r_void
id|write_fan_speed
c_func
(paren
r_struct
id|thermostat
op_star
id|th
comma
r_int
id|speed
comma
r_int
id|fan
)paren
(brace
id|u8
id|manual
suffix:semicolon
r_if
c_cond
(paren
id|speed
OG
l_int|0xff
)paren
id|speed
op_assign
l_int|0xff
suffix:semicolon
r_else
r_if
c_cond
(paren
id|speed
OL
op_minus
l_int|1
)paren
id|speed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|therm_type
op_eq
id|ADT7467
op_logical_and
id|fan
op_eq
l_int|1
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|th-&gt;last_speed
(braket
id|fan
)braket
op_ne
id|speed
)paren
(brace
r_if
c_cond
(paren
id|speed
op_eq
op_minus
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;adt746x: Setting speed to automatic &quot;
l_string|&quot;for %s fan.&bslash;n&quot;
comma
id|fan
ques
c_cond
l_string|&quot;GPU&quot;
suffix:colon
l_string|&quot;CPU&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;adt746x: Setting speed to %d &quot;
l_string|&quot;for %s fan.&bslash;n&quot;
comma
id|speed
comma
id|fan
ques
c_cond
l_string|&quot;GPU&quot;
suffix:colon
l_string|&quot;CPU&quot;
)paren
suffix:semicolon
)brace
r_else
r_return
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_ge
l_int|0
)paren
(brace
id|manual
op_assign
id|read_reg
c_func
(paren
id|th
comma
id|MANUAL_MODE
(braket
id|fan
)braket
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|th
comma
id|MANUAL_MODE
(braket
id|fan
)braket
comma
id|manual
op_or
id|MANUAL_MASK
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|th
comma
id|FAN_SPD_SET
(braket
id|fan
)braket
comma
id|speed
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* back to automatic */
r_if
c_cond
(paren
id|therm_type
op_eq
id|ADT7460
)paren
(brace
id|manual
op_assign
id|read_reg
c_func
(paren
id|th
comma
id|MANUAL_MODE
(braket
id|fan
)braket
)paren
op_amp
(paren
op_complement
id|MANUAL_MASK
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|th
comma
id|MANUAL_MODE
(braket
id|fan
)braket
comma
id|manual
op_or
id|REM_CONTROL
(braket
id|fan
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|manual
op_assign
id|read_reg
c_func
(paren
id|th
comma
id|MANUAL_MODE
(braket
id|fan
)braket
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|th
comma
id|MANUAL_MODE
(braket
id|fan
)braket
comma
id|manual
op_amp
(paren
op_complement
id|AUTO_MASK
)paren
)paren
suffix:semicolon
)brace
)brace
id|th-&gt;last_speed
(braket
id|fan
)braket
op_assign
id|speed
suffix:semicolon
)brace
DECL|function|read_sensors
r_static
r_void
id|read_sensors
c_func
(paren
r_struct
id|thermostat
op_star
id|th
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|th-&gt;temps
(braket
id|i
)braket
op_assign
id|read_reg
c_func
(paren
id|th
comma
id|TEMP_REG
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
DECL|function|display_stats
r_static
r_void
id|display_stats
c_func
(paren
r_struct
id|thermostat
op_star
id|th
)paren
(brace
r_if
c_cond
(paren
id|th-&gt;temps
(braket
l_int|0
)braket
op_ne
id|th-&gt;cached_temp
(braket
l_int|0
)braket
op_logical_or
id|th-&gt;temps
(braket
l_int|1
)braket
op_ne
id|th-&gt;cached_temp
(braket
l_int|1
)braket
op_logical_or
id|th-&gt;temps
(braket
l_int|2
)braket
op_ne
id|th-&gt;cached_temp
(braket
l_int|2
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;adt746x: Temperature infos:&quot;
l_string|&quot; thermostats: %d,%d,%d;&quot;
l_string|&quot; limits: %d,%d,%d;&quot;
l_string|&quot; fan speed: %d RPM&bslash;n&quot;
comma
id|th-&gt;temps
(braket
l_int|0
)braket
comma
id|th-&gt;temps
(braket
l_int|1
)braket
comma
id|th-&gt;temps
(braket
l_int|2
)braket
comma
id|th-&gt;limits
(braket
l_int|0
)braket
comma
id|th-&gt;limits
(braket
l_int|1
)braket
comma
id|th-&gt;limits
(braket
l_int|2
)braket
comma
id|read_fan_speed
c_func
(paren
id|th
comma
id|FAN_SPEED
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
id|th-&gt;cached_temp
(braket
l_int|0
)braket
op_assign
id|th-&gt;temps
(braket
l_int|0
)braket
suffix:semicolon
id|th-&gt;cached_temp
(braket
l_int|1
)braket
op_assign
id|th-&gt;temps
(braket
l_int|1
)braket
suffix:semicolon
id|th-&gt;cached_temp
(braket
l_int|2
)braket
op_assign
id|th-&gt;temps
(braket
l_int|2
)braket
suffix:semicolon
)brace
macro_line|#endif
DECL|function|update_fans_speed
r_static
r_void
id|update_fans_speed
(paren
r_struct
id|thermostat
op_star
id|th
)paren
(brace
r_int
id|lastvar
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* last variation, for iBook */
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we don&squot;t care about local sensor, so we start at sensor 1 */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|started
op_assign
l_int|0
suffix:semicolon
r_int
id|fan_number
op_assign
(paren
id|therm_type
op_eq
id|ADT7460
op_logical_and
id|i
op_eq
l_int|2
)paren
suffix:semicolon
r_int
id|var
op_assign
id|th-&gt;temps
(braket
id|i
)braket
op_minus
id|th-&gt;limits
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|var
OG
op_minus
l_int|1
)paren
(brace
r_int
id|step
op_assign
(paren
l_int|255
op_minus
id|fan_speed
)paren
op_div
l_int|7
suffix:semicolon
r_int
id|new_speed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* hysteresis : change fan speed only if variation is&n;&t;&t;&t; * more than two degrees */
r_if
c_cond
(paren
id|abs
c_func
(paren
id|var
op_minus
id|th-&gt;last_var
(braket
id|fan_number
)braket
)paren
OL
l_int|2
)paren
r_continue
suffix:semicolon
id|started
op_assign
l_int|1
suffix:semicolon
id|new_speed
op_assign
id|fan_speed
op_plus
(paren
(paren
id|var
op_minus
l_int|1
)paren
op_star
id|step
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_speed
OL
id|fan_speed
)paren
id|new_speed
op_assign
id|fan_speed
suffix:semicolon
r_if
c_cond
(paren
id|new_speed
OG
l_int|255
)paren
id|new_speed
op_assign
l_int|255
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;adt746x: setting fans speed to %d &quot;
l_string|&quot;(limit exceeded by %d on %s) &bslash;n&quot;
comma
id|new_speed
comma
id|var
comma
id|fan_number
ques
c_cond
l_string|&quot;GPU/pwr&quot;
suffix:colon
l_string|&quot;CPU&quot;
)paren
suffix:semicolon
id|write_both_fan_speed
c_func
(paren
id|th
comma
id|new_speed
)paren
suffix:semicolon
id|th-&gt;last_var
(braket
id|fan_number
)braket
op_assign
id|var
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|var
OL
op_minus
l_int|2
)paren
(brace
multiline_comment|/* don&squot;t stop fan if GPU/power is cold and CPU is not&n;&t;&t;&t; * so cold (lastvar &gt;= -1) */
r_if
c_cond
(paren
id|i
op_eq
l_int|2
op_logical_and
id|lastvar
OL
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|th-&gt;last_speed
(braket
id|fan_number
)braket
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;adt746x: Stopping &quot;
l_string|&quot;fans.&bslash;n&quot;
)paren
suffix:semicolon
id|write_both_fan_speed
c_func
(paren
id|th
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|lastvar
op_assign
id|var
suffix:semicolon
r_if
c_cond
(paren
id|started
)paren
r_return
suffix:semicolon
multiline_comment|/* we don&squot;t want to re-stop the fan&n;&t;&t;&t;&t;* if CPU is heating and GPU/power is not */
)brace
)brace
DECL|function|monitor_task
r_static
r_int
id|monitor_task
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
r_struct
id|thermostat
op_star
id|th
op_assign
id|arg
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|kthread_should_stop
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|current-&gt;flags
op_amp
id|PF_FREEZE
)paren
id|refrigerator
c_func
(paren
id|PF_FREEZE
)paren
suffix:semicolon
id|msleep_interruptible
c_func
(paren
l_int|2000
)paren
suffix:semicolon
macro_line|#ifndef DEBUG
r_if
c_cond
(paren
id|fan_speed
op_ne
op_minus
l_int|1
)paren
id|read_sensors
c_func
(paren
id|th
)paren
suffix:semicolon
macro_line|#else
id|read_sensors
c_func
(paren
id|th
)paren
suffix:semicolon
macro_line|#endif&t;&t;
r_if
c_cond
(paren
id|fan_speed
op_ne
op_minus
l_int|1
)paren
id|update_fans_speed
c_func
(paren
id|th
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|display_stats
c_func
(paren
id|th
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_limit
r_static
r_void
id|set_limit
c_func
(paren
r_struct
id|thermostat
op_star
id|th
comma
r_int
id|i
)paren
(brace
multiline_comment|/* Set CPU limit higher to avoid powerdowns */
id|th-&gt;limits
(braket
id|i
)braket
op_assign
id|default_limits_chip
(braket
id|i
)braket
op_plus
id|limit_adjust
suffix:semicolon
id|write_reg
c_func
(paren
id|th
comma
id|LIMIT_REG
(braket
id|i
)braket
comma
id|th-&gt;limits
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* set our limits to normal */
id|th-&gt;limits
(braket
id|i
)braket
op_assign
id|default_limits_local
(braket
id|i
)braket
op_plus
id|limit_adjust
suffix:semicolon
)brace
DECL|function|attach_one_thermostat
r_static
r_int
id|attach_one_thermostat
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|addr
comma
r_int
id|busno
)paren
(brace
r_struct
id|thermostat
op_star
id|th
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|thermostat
)paren
r_return
l_int|0
suffix:semicolon
id|th
op_assign
(paren
r_struct
id|thermostat
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|thermostat
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|th
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|th
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|th
)paren
)paren
suffix:semicolon
id|th-&gt;clt.addr
op_assign
id|addr
suffix:semicolon
id|th-&gt;clt.adapter
op_assign
id|adapter
suffix:semicolon
id|th-&gt;clt.driver
op_assign
op_amp
id|thermostat_driver
suffix:semicolon
id|th-&gt;clt.id
op_assign
l_int|0xDEAD7467
suffix:semicolon
id|strcpy
c_func
(paren
id|th-&gt;clt.name
comma
l_string|&quot;thermostat&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|read_reg
c_func
(paren
id|th
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;adt746x: Thermostat failed to read config &quot;
l_string|&quot;from bus %d !&bslash;n&quot;
comma
id|busno
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|th
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* force manual control to start the fan quieter */
r_if
c_cond
(paren
id|fan_speed
op_eq
op_minus
l_int|1
)paren
id|fan_speed
op_assign
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|therm_type
op_eq
id|ADT7460
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;adt746x: ADT7460 initializing&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* The 7460 needs to be started explicitly */
id|write_reg
c_func
(paren
id|th
comma
id|CONFIG_REG
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;adt746x: ADT7467 initializing&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|th-&gt;initial_limits
(braket
id|i
)braket
op_assign
id|read_reg
c_func
(paren
id|th
comma
id|LIMIT_REG
(braket
id|i
)braket
)paren
suffix:semicolon
id|set_limit
c_func
(paren
id|th
comma
id|i
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;adt746x: Lowering max temperatures from %d, %d, %d&quot;
l_string|&quot; to %d, %d, %d&bslash;n&quot;
comma
id|th-&gt;initial_limits
(braket
l_int|0
)braket
comma
id|th-&gt;initial_limits
(braket
l_int|1
)braket
comma
id|th-&gt;initial_limits
(braket
l_int|2
)braket
comma
id|th-&gt;limits
(braket
l_int|0
)braket
comma
id|th-&gt;limits
(braket
l_int|1
)braket
comma
id|th-&gt;limits
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|thermostat
op_assign
id|th
suffix:semicolon
r_if
c_cond
(paren
id|i2c_attach_client
c_func
(paren
op_amp
id|th-&gt;clt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;adt746x: Thermostat failed to attach &quot;
l_string|&quot;client !&bslash;n&quot;
)paren
suffix:semicolon
id|thermostat
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|th
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* be sure to really write fan speed the first time */
id|th-&gt;last_speed
(braket
l_int|0
)braket
op_assign
op_minus
l_int|2
suffix:semicolon
id|th-&gt;last_speed
(braket
l_int|1
)braket
op_assign
op_minus
l_int|2
suffix:semicolon
id|th-&gt;last_var
(braket
l_int|0
)braket
op_assign
op_minus
l_int|80
suffix:semicolon
id|th-&gt;last_var
(braket
l_int|1
)braket
op_assign
op_minus
l_int|80
suffix:semicolon
r_if
c_cond
(paren
id|fan_speed
op_ne
op_minus
l_int|1
)paren
(brace
multiline_comment|/* manual mode, stop fans */
id|write_both_fan_speed
c_func
(paren
id|th
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* automatic mode */
id|write_both_fan_speed
c_func
(paren
id|th
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|thread_therm
op_assign
id|kthread_run
c_func
(paren
id|monitor_task
comma
id|th
comma
l_string|&quot;kfand&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|thread_therm
op_eq
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;adt746x: Kthread creation failed&bslash;n&quot;
)paren
suffix:semicolon
id|thread_therm
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Now, unfortunately, sysfs doesn&squot;t give us a nice void * we could&n; * pass around to the attribute functions, so we don&squot;t really have&n; * choice but implement a bunch of them...&n; *&n; */
DECL|macro|BUILD_SHOW_FUNC_INT
mdefine_line|#define BUILD_SHOW_FUNC_INT(name, data)&t;&t;&t;&t;&bslash;&n;static ssize_t show_##name(struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return sprintf(buf, &quot;%d&bslash;n&quot;, data);&t;&t;&t;&bslash;&n;}
DECL|macro|BUILD_SHOW_FUNC_FAN
mdefine_line|#define BUILD_SHOW_FUNC_FAN(name, data)&t;&t;&t;&t;&bslash;&n;static ssize_t show_##name(struct device *dev, char *buf)       &bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return sprintf(buf, &quot;%d (%d rpm)&bslash;n&quot;, &t;&t;&t;&bslash;&n;&t;&t;thermostat-&gt;last_speed[data],&t;&t;&t;&bslash;&n;&t;&t;read_fan_speed(thermostat, FAN_SPEED[data])&t;&bslash;&n;&t;&t;);&t;&t;&t;&t;&t;&t;&bslash;&n;}
DECL|macro|BUILD_STORE_FUNC_DEG
mdefine_line|#define BUILD_STORE_FUNC_DEG(name, data)&t;&t;&t;&bslash;&n;static ssize_t store_##name(struct device *dev, const char *buf, size_t n) &bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;int val;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;int i;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;val = simple_strtol(buf, NULL, 10);&t;&t;&t;&bslash;&n;&t;printk(KERN_INFO &quot;Adjusting limits by %d&#xfffd;C&bslash;n&quot;, val);&t;&bslash;&n;&t;limit_adjust = val;&t;&t;&t;&t;&t;&bslash;&n;&t;for (i=0; i &lt; 3; i++)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;set_limit(thermostat, i);&t;&t;&t;&bslash;&n;&t;return n;&t;&t;&t;&t;&t;&t;&bslash;&n;}
DECL|macro|BUILD_STORE_FUNC_INT
mdefine_line|#define BUILD_STORE_FUNC_INT(name, data)&t;&t;&t;&bslash;&n;static ssize_t store_##name(struct device *dev, const char *buf, size_t n) &bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;u32 val;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;val = simple_strtoul(buf, NULL, 10);&t;&t;&t;&bslash;&n;&t;if (val &lt; 0 || val &gt; 255)&t;&t;&t;&t;&bslash;&n;&t;&t;return -EINVAL;&t;&t;&t;&t;&t;&bslash;&n;&t;printk(KERN_INFO &quot;Setting specified fan speed to %d&bslash;n&quot;, val);&t;&bslash;&n;&t;data = val;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return n;&t;&t;&t;&t;&t;&t;&bslash;&n;}
id|BUILD_SHOW_FUNC_INT
c_func
(paren
id|cpu_temperature
comma
(paren
id|read_reg
c_func
(paren
id|thermostat
comma
id|TEMP_REG
(braket
l_int|1
)braket
)paren
)paren
)paren
id|BUILD_SHOW_FUNC_INT
c_func
(paren
id|gpu_temperature
comma
(paren
id|read_reg
c_func
(paren
id|thermostat
comma
id|TEMP_REG
(braket
l_int|2
)braket
)paren
)paren
)paren
id|BUILD_SHOW_FUNC_INT
c_func
(paren
id|cpu_limit
comma
id|thermostat-&gt;limits
(braket
l_int|1
)braket
)paren
id|BUILD_SHOW_FUNC_INT
c_func
(paren
id|gpu_limit
comma
id|thermostat-&gt;limits
(braket
l_int|2
)braket
)paren
id|BUILD_SHOW_FUNC_INT
c_func
(paren
id|specified_fan_speed
comma
id|fan_speed
)paren
id|BUILD_SHOW_FUNC_FAN
c_func
(paren
id|cpu_fan_speed
comma
l_int|0
)paren
id|BUILD_SHOW_FUNC_FAN
c_func
(paren
id|gpu_fan_speed
comma
l_int|1
)paren
id|BUILD_STORE_FUNC_INT
c_func
(paren
id|specified_fan_speed
comma
id|fan_speed
)paren
id|BUILD_SHOW_FUNC_INT
c_func
(paren
id|limit_adjust
comma
id|limit_adjust
)paren
id|BUILD_STORE_FUNC_DEG
c_func
(paren
id|limit_adjust
comma
id|thermostat
)paren
r_static
id|DEVICE_ATTR
c_func
(paren
id|cpu_temperature
comma
id|S_IRUGO
comma
id|show_cpu_temperature
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|gpu_temperature
comma
id|S_IRUGO
comma
id|show_gpu_temperature
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|cpu_limit
comma
id|S_IRUGO
comma
id|show_cpu_limit
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|gpu_limit
comma
id|S_IRUGO
comma
id|show_gpu_limit
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|specified_fan_speed
comma
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
op_or
id|S_IROTH
comma
id|show_specified_fan_speed
comma
id|store_specified_fan_speed
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|cpu_fan_speed
comma
id|S_IRUGO
comma
id|show_cpu_fan_speed
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|gpu_fan_speed
comma
id|S_IRUGO
comma
id|show_gpu_fan_speed
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|limit_adjust
comma
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
op_or
id|S_IROTH
comma
id|show_limit_adjust
comma
id|store_limit_adjust
)paren
suffix:semicolon
r_static
r_int
id|__init
DECL|function|thermostat_init
id|thermostat_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
id|u32
op_star
id|prop
suffix:semicolon
id|np
op_assign
id|of_find_node_by_name
c_func
(paren
l_int|NULL
comma
l_string|&quot;fan&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|np
comma
l_string|&quot;adt7460&quot;
)paren
)paren
id|therm_type
op_assign
id|ADT7460
suffix:semicolon
r_else
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|np
comma
l_string|&quot;adt7467&quot;
)paren
)paren
id|therm_type
op_assign
id|ADT7467
suffix:semicolon
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
id|prop
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;reg&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prop
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|therm_bus
op_assign
(paren
(paren
op_star
id|prop
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|therm_address
op_assign
(paren
(paren
op_star
id|prop
)paren
op_amp
l_int|0xff
)paren
op_rshift
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;adt746x: Thermostat bus: %d, address: 0x%02x, &quot;
l_string|&quot;limit_adjust: %d, fan_speed: %d&bslash;n&quot;
comma
id|therm_bus
comma
id|therm_address
comma
id|limit_adjust
comma
id|fan_speed
)paren
suffix:semicolon
id|of_dev
op_assign
id|of_platform_device_create
c_func
(paren
id|np
comma
l_string|&quot;temperatures&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|of_dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t register temperatures device !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|device_create_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_cpu_temperature
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_gpu_temperature
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_cpu_limit
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_gpu_limit
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_limit_adjust
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_specified_fan_speed
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_cpu_fan_speed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|therm_type
op_eq
id|ADT7460
)paren
(brace
id|device_create_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_gpu_fan_speed
)paren
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_I2C_KEYWEST
id|request_module
c_func
(paren
l_string|&quot;i2c-keywest&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|i2c_add_driver
c_func
(paren
op_amp
id|thermostat_driver
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|thermostat_exit
id|thermostat_exit
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|of_dev
)paren
(brace
id|device_remove_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_cpu_temperature
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_gpu_temperature
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_cpu_limit
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_gpu_limit
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_limit_adjust
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_specified_fan_speed
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_cpu_fan_speed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|therm_type
op_eq
id|ADT7460
)paren
(brace
id|device_remove_file
c_func
(paren
op_amp
id|of_dev-&gt;dev
comma
op_amp
id|dev_attr_gpu_fan_speed
)paren
suffix:semicolon
)brace
id|of_device_unregister
c_func
(paren
id|of_dev
)paren
suffix:semicolon
)brace
id|i2c_del_driver
c_func
(paren
op_amp
id|thermostat_driver
)paren
suffix:semicolon
)brace
DECL|variable|thermostat_init
id|module_init
c_func
(paren
id|thermostat_init
)paren
suffix:semicolon
DECL|variable|thermostat_exit
id|module_exit
c_func
(paren
id|thermostat_exit
)paren
suffix:semicolon
eof
