multiline_comment|/*&n; * Bus &amp; driver management routines for devices within&n; * a MacIO ASIC. Interface to new driver model mostly&n; * stolen from the PCI version.&n; * &n; * TODO:&n; * &n; *  - Don&squot;t probe below media bay by default, but instead provide&n; *    some hooks for media bay to dynamically add/remove it&squot;s own&n; *    sub-devices.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/pci_ids.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/macio.h&gt;
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|macro|MAX_NODE_NAME_SIZE
mdefine_line|#define MAX_NODE_NAME_SIZE (BUS_ID_SIZE - 12)
DECL|variable|macio_on_hold
r_static
r_struct
id|macio_chip
op_star
id|macio_on_hold
suffix:semicolon
DECL|function|macio_bus_match
r_static
r_int
id|macio_bus_match
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|device_driver
op_star
id|drv
)paren
(brace
r_struct
id|macio_dev
op_star
id|macio_dev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|macio_driver
op_star
id|macio_drv
op_assign
id|to_macio_driver
c_func
(paren
id|drv
)paren
suffix:semicolon
r_const
r_struct
id|of_match
op_star
id|matches
op_assign
id|macio_drv-&gt;match_table
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|matches
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|of_match_device
c_func
(paren
id|matches
comma
op_amp
id|macio_dev-&gt;ofdev
)paren
op_ne
l_int|NULL
suffix:semicolon
)brace
DECL|function|macio_dev_get
r_struct
id|macio_dev
op_star
id|macio_dev_get
c_func
(paren
r_struct
id|macio_dev
op_star
id|dev
)paren
(brace
r_struct
id|device
op_star
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|tmp
op_assign
id|get_device
c_func
(paren
op_amp
id|dev-&gt;ofdev.dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
)paren
r_return
id|to_macio_device
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_else
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|macio_dev_put
r_void
id|macio_dev_put
c_func
(paren
r_struct
id|macio_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev
)paren
id|put_device
c_func
(paren
op_amp
id|dev-&gt;ofdev.dev
)paren
suffix:semicolon
)brace
DECL|function|macio_device_probe
r_static
r_int
id|macio_device_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|error
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|macio_driver
op_star
id|drv
suffix:semicolon
r_struct
id|macio_dev
op_star
id|macio_dev
suffix:semicolon
r_const
r_struct
id|of_match
op_star
id|match
suffix:semicolon
id|drv
op_assign
id|to_macio_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
id|macio_dev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drv-&gt;probe
)paren
r_return
id|error
suffix:semicolon
id|macio_dev_get
c_func
(paren
id|macio_dev
)paren
suffix:semicolon
id|match
op_assign
id|of_match_device
c_func
(paren
id|drv-&gt;match_table
comma
op_amp
id|macio_dev-&gt;ofdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|match
)paren
id|error
op_assign
id|drv
op_member_access_from_pointer
id|probe
c_func
(paren
id|macio_dev
comma
id|match
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|macio_dev_put
c_func
(paren
id|macio_dev
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|macio_device_remove
r_static
r_int
id|macio_device_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|macio_dev
op_star
id|macio_dev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|macio_driver
op_star
id|drv
op_assign
id|to_macio_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
op_logical_and
id|drv-&gt;remove
)paren
id|drv
op_member_access_from_pointer
id|remove
c_func
(paren
id|macio_dev
)paren
suffix:semicolon
id|macio_dev_put
c_func
(paren
id|macio_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macio_device_shutdown
r_static
r_void
id|macio_device_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|macio_dev
op_star
id|macio_dev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|macio_driver
op_star
id|drv
op_assign
id|to_macio_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
op_logical_and
id|drv-&gt;shutdown
)paren
id|drv
op_member_access_from_pointer
id|shutdown
c_func
(paren
id|macio_dev
)paren
suffix:semicolon
)brace
DECL|function|macio_device_suspend
r_static
r_int
id|macio_device_suspend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
r_struct
id|macio_dev
op_star
id|macio_dev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|macio_driver
op_star
id|drv
op_assign
id|to_macio_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
op_logical_and
id|drv-&gt;suspend
)paren
r_return
id|drv
op_member_access_from_pointer
id|suspend
c_func
(paren
id|macio_dev
comma
id|state
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macio_device_resume
r_static
r_int
id|macio_device_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|macio_dev
op_star
id|macio_dev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|macio_driver
op_star
id|drv
op_assign
id|to_macio_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
op_logical_and
id|drv-&gt;resume
)paren
r_return
id|drv
op_member_access_from_pointer
id|resume
c_func
(paren
id|macio_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|macio_bus_type
r_struct
id|bus_type
id|macio_bus_type
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;macio&quot;
comma
dot
id|match
op_assign
id|macio_bus_match
comma
dot
id|suspend
op_assign
id|macio_device_suspend
comma
dot
id|resume
op_assign
id|macio_device_resume
comma
)brace
suffix:semicolon
DECL|function|macio_bus_driver_init
r_static
r_int
id|__init
id|macio_bus_driver_init
c_func
(paren
r_void
)paren
(brace
r_return
id|bus_register
c_func
(paren
op_amp
id|macio_bus_type
)paren
suffix:semicolon
)brace
DECL|variable|macio_bus_driver_init
id|postcore_initcall
c_func
(paren
id|macio_bus_driver_init
)paren
suffix:semicolon
multiline_comment|/**&n; * macio_release_dev - free a macio device structure when all users of it are finished.&n; * @dev: device that&squot;s been disconnected&n; *&n; * Will be called only by the device core when all users of this macio device are&n; * done. This currently means never as we don&squot;t hot remove any macio device yet,&n; * though that will happen with mediabay based devices in a later implementation.&n; */
DECL|function|macio_release_dev
r_static
r_void
id|macio_release_dev
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|macio_dev
op_star
id|mdev
suffix:semicolon
id|mdev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mdev
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * macio_resource_quirks - tweak or skip some resources for a device&n; * @np: pointer to the device node&n; * @res: resulting resource&n; * @index: index of resource in node&n; *&n; * If this routine returns non-null, then the resource is completely&n; * skipped.&n; */
DECL|function|macio_resource_quirks
r_static
r_int
id|macio_resource_quirks
c_func
(paren
r_struct
id|device_node
op_star
id|np
comma
r_struct
id|resource
op_star
id|res
comma
r_int
id|index
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_MEM
)paren
(brace
multiline_comment|/* Grand Central has too large resource 0 on some machines */
r_if
c_cond
(paren
id|index
op_eq
l_int|0
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;gc&quot;
)paren
)paren
(brace
id|np-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
op_assign
l_int|0x20000
suffix:semicolon
id|res-&gt;end
op_assign
id|res-&gt;start
op_plus
l_int|0x1ffff
suffix:semicolon
)brace
multiline_comment|/* Airport has bogus resource 2 */
r_if
c_cond
(paren
id|index
op_ge
l_int|2
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;radio&quot;
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* DBDMAs may have bogus sizes */
r_if
c_cond
(paren
(paren
id|res-&gt;start
op_amp
l_int|0x0001f000
)paren
op_eq
l_int|0x00008000
)paren
(brace
id|np-&gt;addrs
(braket
id|index
)braket
dot
id|size
op_assign
l_int|0x100
suffix:semicolon
id|res-&gt;end
op_assign
id|res-&gt;start
op_plus
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/* ESCC parent eats child resources. We could have added a level of hierarchy,&n;&t;&t; * but I don&squot;t really feel the need for it */
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;escc&quot;
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* ESCC has bogus resources &gt;= 3 */
r_if
c_cond
(paren
id|index
op_ge
l_int|3
op_logical_and
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;ch-a&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;ch-b&quot;
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Media bay has too many resources, keep only first one */
r_if
c_cond
(paren
id|index
OG
l_int|0
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;media-bay&quot;
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Some older IDE resources have bogus sizes */
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;IDE&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;ATA&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|np-&gt;type
comma
l_string|&quot;ide&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|np-&gt;type
comma
l_string|&quot;ata&quot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|index
op_eq
l_int|0
op_logical_and
id|np-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
OG
l_int|0x1000
)paren
(brace
id|np-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
op_assign
l_int|0x1000
suffix:semicolon
id|res-&gt;end
op_assign
id|res-&gt;start
op_plus
l_int|0xfff
suffix:semicolon
)brace
r_if
c_cond
(paren
id|index
op_eq
l_int|1
op_logical_and
id|np-&gt;addrs
(braket
l_int|1
)braket
dot
id|size
OG
l_int|0x100
)paren
(brace
id|np-&gt;addrs
(braket
l_int|1
)braket
dot
id|size
op_assign
l_int|0x100
suffix:semicolon
id|res-&gt;end
op_assign
id|res-&gt;start
op_plus
l_int|0xff
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * macio_add_one_device - Add one device from OF node to the device tree&n; * @chip: pointer to the macio_chip holding the device&n; * @np: pointer to the device node in the OF tree&n; * @in_bay: set to 1 if device is part of a media-bay&n; *&n; * When media-bay is changed to hotswap drivers, this function will&n; * be exposed to the bay driver some way...&n; */
DECL|function|macio_add_one_device
r_static
r_struct
id|macio_dev
op_star
id|macio_add_one_device
c_func
(paren
r_struct
id|macio_chip
op_star
id|chip
comma
r_struct
id|device
op_star
id|parent
comma
r_struct
id|device_node
op_star
id|np
comma
r_struct
id|macio_dev
op_star
id|in_bay
comma
r_struct
id|resource
op_star
id|parent_res
)paren
(brace
r_struct
id|macio_dev
op_star
id|dev
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|u32
op_star
id|reg
suffix:semicolon
r_if
c_cond
(paren
id|np
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;bus
op_assign
op_amp
id|chip-&gt;lbus
suffix:semicolon
id|dev-&gt;media_bay
op_assign
id|in_bay
suffix:semicolon
id|dev-&gt;ofdev.node
op_assign
id|np
suffix:semicolon
id|dev-&gt;ofdev.dma_mask
op_assign
l_int|0xffffffffUL
suffix:semicolon
id|dev-&gt;ofdev.dev.dma_mask
op_assign
op_amp
id|dev-&gt;ofdev.dma_mask
suffix:semicolon
id|dev-&gt;ofdev.dev.parent
op_assign
id|parent
suffix:semicolon
id|dev-&gt;ofdev.dev.bus
op_assign
op_amp
id|macio_bus_type
suffix:semicolon
id|dev-&gt;ofdev.dev.release
op_assign
id|macio_release_dev
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;preparing mdev @%p, ofdev @%p, dev @%p, kobj @%p&bslash;n&quot;
comma
id|dev
comma
op_amp
id|dev-&gt;ofdev
comma
op_amp
id|dev-&gt;ofdev.dev
comma
op_amp
id|dev-&gt;ofdev.dev.kobj
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* MacIO itself has a different reg, we use it&squot;s PCI base */
r_if
c_cond
(paren
id|np
op_eq
id|chip-&gt;of_node
)paren
(brace
id|sprintf
c_func
(paren
id|dev-&gt;ofdev.dev.bus_id
comma
l_string|&quot;%1d.%08lx:%.*s&quot;
comma
id|chip-&gt;lbus.index
comma
macro_line|#ifdef CONFIG_PCI
id|pci_resource_start
c_func
(paren
id|chip-&gt;lbus.pdev
comma
l_int|0
)paren
comma
macro_line|#else
l_int|0
comma
multiline_comment|/* NuBus may want to do something better here */
macro_line|#endif
id|MAX_NODE_NAME_SIZE
comma
id|np-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|reg
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;reg&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|dev-&gt;ofdev.dev.bus_id
comma
l_string|&quot;%1d.%08x:%.*s&quot;
comma
id|chip-&gt;lbus.index
comma
id|reg
ques
c_cond
op_star
id|reg
suffix:colon
l_int|0
comma
id|MAX_NODE_NAME_SIZE
comma
id|np-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* For now, we use pre-parsed entries in the device-tree for&n;&t; * interrupt routing and addresses, but we should change that&n;&t; * to dynamically parsed entries and so get rid of most of the&n;&t; * clutter in struct device_node&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|np-&gt;n_intrs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|res
op_assign
op_amp
id|dev-&gt;interrupt
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|j
op_ge
id|MACIO_DEV_COUNT_IRQS
)paren
r_break
suffix:semicolon
id|res-&gt;start
op_assign
id|np-&gt;intrs
(braket
id|i
)braket
dot
id|line
suffix:semicolon
id|res-&gt;flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;intrs
(braket
id|j
)braket
dot
id|sense
)paren
id|res-&gt;flags
op_or_assign
id|IORESOURCE_IRQ_LOWLEVEL
suffix:semicolon
r_else
id|res-&gt;flags
op_or_assign
id|IORESOURCE_IRQ_HIGHEDGE
suffix:semicolon
id|res-&gt;name
op_assign
id|dev-&gt;ofdev.dev.bus_id
suffix:semicolon
r_if
c_cond
(paren
id|macio_resource_quirks
c_func
(paren
id|np
comma
id|res
comma
id|i
)paren
)paren
id|memset
c_func
(paren
id|res
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource
)paren
)paren
suffix:semicolon
r_else
id|j
op_increment
suffix:semicolon
)brace
id|dev-&gt;n_interrupts
op_assign
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|np-&gt;n_addrs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|res
op_assign
op_amp
id|dev-&gt;resource
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|j
op_ge
id|MACIO_DEV_COUNT_RESOURCES
)paren
r_break
suffix:semicolon
id|res-&gt;start
op_assign
id|np-&gt;addrs
(braket
id|i
)braket
dot
id|address
suffix:semicolon
id|res-&gt;end
op_assign
id|np-&gt;addrs
(braket
id|i
)braket
dot
id|address
op_plus
id|np-&gt;addrs
(braket
id|i
)braket
dot
id|size
op_minus
l_int|1
suffix:semicolon
id|res-&gt;flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
id|res-&gt;name
op_assign
id|dev-&gt;ofdev.dev.bus_id
suffix:semicolon
r_if
c_cond
(paren
id|macio_resource_quirks
c_func
(paren
id|np
comma
id|res
comma
id|i
)paren
)paren
id|memset
c_func
(paren
id|res
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|resource
)paren
)paren
suffix:semicolon
r_else
(brace
id|j
op_increment
suffix:semicolon
multiline_comment|/* Currently, we consider failure as harmless, this may&n;&t;&t;&t; * change in the future, once I&squot;ve found all the device&n;&t;&t;&t; * tree bugs in older machines &amp; worked around them&n;&t;&t;&t; */
r_if
c_cond
(paren
id|insert_resource
c_func
(paren
id|parent_res
comma
id|res
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Can&squot;t request resource %d for MacIO&quot;
l_string|&quot; device %s&bslash;n&quot;
comma
id|i
comma
id|dev-&gt;ofdev.dev.bus_id
)paren
suffix:semicolon
)brace
)brace
id|dev-&gt;n_resources
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
id|of_device_register
c_func
(paren
op_amp
id|dev-&gt;ofdev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;macio: device registration error for %s!&bslash;n&quot;
comma
id|dev-&gt;ofdev.dev.bus_id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|dev
suffix:semicolon
)brace
DECL|function|macio_skip_device
r_static
r_int
id|macio_skip_device
c_func
(paren
r_struct
id|device_node
op_star
id|np
)paren
(brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;battery&quot;
comma
l_int|7
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;escc-legacy&quot;
comma
l_int|11
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * macio_pci_add_devices - Adds sub-devices of mac-io to the device tree&n; * @chip: pointer to the macio_chip holding the devices&n; * &n; * This function will do the job of extracting devices from the&n; * Open Firmware device tree, build macio_dev structures and add&n; * them to the Linux device tree.&n; * &n; * For now, childs of media-bay are added now as well. This will&n; * change rsn though.&n; */
DECL|function|macio_pci_add_devices
r_static
r_void
id|macio_pci_add_devices
c_func
(paren
r_struct
id|macio_chip
op_star
id|chip
)paren
(brace
r_struct
id|device_node
op_star
id|np
comma
op_star
id|pnode
suffix:semicolon
r_struct
id|macio_dev
op_star
id|rdev
comma
op_star
id|mdev
comma
op_star
id|mbdev
op_assign
l_int|NULL
comma
op_star
id|sdev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|device
op_star
id|parent
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|resource
op_star
id|root_res
op_assign
op_amp
id|iomem_resource
suffix:semicolon
multiline_comment|/* Add a node for the macio bus itself */
macro_line|#ifdef CONFIG_PCI
r_if
c_cond
(paren
id|chip-&gt;lbus.pdev
)paren
(brace
id|parent
op_assign
op_amp
id|chip-&gt;lbus.pdev-&gt;dev
suffix:semicolon
id|root_res
op_assign
op_amp
id|chip-&gt;lbus.pdev-&gt;resource
(braket
l_int|0
)braket
suffix:semicolon
)brace
macro_line|#endif
id|pnode
op_assign
id|of_node_get
c_func
(paren
id|chip-&gt;of_node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pnode
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* Add macio itself to hierarchy */
id|rdev
op_assign
id|macio_add_one_device
c_func
(paren
id|chip
comma
id|parent
comma
id|pnode
comma
l_int|NULL
comma
id|root_res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rdev
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|root_res
op_assign
op_amp
id|rdev-&gt;resource
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* First scan 1st level */
r_for
c_loop
(paren
id|np
op_assign
l_int|NULL
suffix:semicolon
(paren
id|np
op_assign
id|of_get_next_child
c_func
(paren
id|pnode
comma
id|np
)paren
)paren
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|macio_skip_device
c_func
(paren
id|np
)paren
)paren
(brace
id|of_node_get
c_func
(paren
id|np
)paren
suffix:semicolon
id|mdev
op_assign
id|macio_add_one_device
c_func
(paren
id|chip
comma
op_amp
id|rdev-&gt;ofdev.dev
comma
id|np
comma
l_int|NULL
comma
id|root_res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdev
op_eq
l_int|NULL
)paren
id|of_node_put
c_func
(paren
id|np
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;media-bay&quot;
comma
l_int|9
)paren
op_eq
l_int|0
)paren
id|mbdev
op_assign
id|mdev
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;escc&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
id|sdev
op_assign
id|mdev
suffix:semicolon
)brace
)brace
multiline_comment|/* Add media bay devices if any */
r_if
c_cond
(paren
id|mbdev
)paren
r_for
c_loop
(paren
id|np
op_assign
l_int|NULL
suffix:semicolon
(paren
id|np
op_assign
id|of_get_next_child
c_func
(paren
id|mbdev-&gt;ofdev.node
comma
id|np
)paren
)paren
op_ne
l_int|NULL
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|macio_skip_device
c_func
(paren
id|np
)paren
)paren
(brace
id|of_node_get
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
id|macio_add_one_device
c_func
(paren
id|chip
comma
op_amp
id|mbdev-&gt;ofdev.dev
comma
id|np
comma
id|mbdev
comma
id|root_res
)paren
op_eq
l_int|NULL
)paren
id|of_node_put
c_func
(paren
id|np
)paren
suffix:semicolon
)brace
multiline_comment|/* Add serial ports if any */
r_if
c_cond
(paren
id|sdev
)paren
(brace
r_for
c_loop
(paren
id|np
op_assign
l_int|NULL
suffix:semicolon
(paren
id|np
op_assign
id|of_get_next_child
c_func
(paren
id|sdev-&gt;ofdev.node
comma
id|np
)paren
)paren
op_ne
l_int|NULL
suffix:semicolon
)paren
r_if
c_cond
(paren
op_logical_neg
id|macio_skip_device
c_func
(paren
id|np
)paren
)paren
(brace
id|of_node_get
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
id|macio_add_one_device
c_func
(paren
id|chip
comma
op_amp
id|sdev-&gt;ofdev.dev
comma
id|np
comma
l_int|NULL
comma
id|root_res
)paren
op_eq
l_int|NULL
)paren
id|of_node_put
c_func
(paren
id|np
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * macio_register_driver - Registers a new MacIO device driver&n; * @drv: pointer to the driver definition structure&n; */
DECL|function|macio_register_driver
r_int
id|macio_register_driver
c_func
(paren
r_struct
id|macio_driver
op_star
id|drv
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initialize common driver fields */
id|drv-&gt;driver.name
op_assign
id|drv-&gt;name
suffix:semicolon
id|drv-&gt;driver.bus
op_assign
op_amp
id|macio_bus_type
suffix:semicolon
id|drv-&gt;driver.probe
op_assign
id|macio_device_probe
suffix:semicolon
id|drv-&gt;driver.remove
op_assign
id|macio_device_remove
suffix:semicolon
id|drv-&gt;driver.shutdown
op_assign
id|macio_device_shutdown
suffix:semicolon
multiline_comment|/* register with core */
id|count
op_assign
id|driver_register
c_func
(paren
op_amp
id|drv-&gt;driver
)paren
suffix:semicolon
r_return
id|count
ques
c_cond
id|count
suffix:colon
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * macio_unregister_driver - Unregisters a new MacIO device driver&n; * @drv: pointer to the driver definition structure&n; */
DECL|function|macio_unregister_driver
r_void
id|macio_unregister_driver
c_func
(paren
r_struct
id|macio_driver
op_star
id|drv
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|drv-&gt;driver
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;macio_request_resource - Request an MMIO resource&n; * &t;@dev: pointer to the device holding the resource&n; *&t;@resource_no: resource number to request&n; *&t;@name: resource name&n; *&n; *&t;Mark  memory region number @resource_no associated with MacIO&n; *&t;device @dev as being reserved by owner @name.  Do not access&n; *&t;any address inside the memory regions unless this call returns&n; *&t;successfully.&n; *&n; *&t;Returns 0 on success, or %EBUSY on error.  A warning&n; *&t;message is also printed on failure.&n; */
DECL|function|macio_request_resource
r_int
id|macio_request_resource
c_func
(paren
r_struct
id|macio_dev
op_star
id|dev
comma
r_int
id|resource_no
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_if
c_cond
(paren
id|macio_resource_len
c_func
(paren
id|dev
comma
id|resource_no
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|macio_resource_start
c_func
(paren
id|dev
comma
id|resource_no
)paren
comma
id|macio_resource_len
c_func
(paren
id|dev
comma
id|resource_no
)paren
comma
id|name
)paren
)paren
r_goto
id|err_out
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out
suffix:colon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;MacIO: Unable to reserve resource #%d:%lx@%lx&quot;
l_string|&quot; for device %s&bslash;n&quot;
comma
id|resource_no
comma
id|macio_resource_len
c_func
(paren
id|dev
comma
id|resource_no
)paren
comma
id|macio_resource_start
c_func
(paren
id|dev
comma
id|resource_no
)paren
comma
id|dev-&gt;ofdev.dev.bus_id
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/**&n; * macio_release_resource - Release an MMIO resource&n; * @dev: pointer to the device holding the resource&n; * @resource_no: resource number to release&n; */
DECL|function|macio_release_resource
r_void
id|macio_release_resource
c_func
(paren
r_struct
id|macio_dev
op_star
id|dev
comma
r_int
id|resource_no
)paren
(brace
r_if
c_cond
(paren
id|macio_resource_len
c_func
(paren
id|dev
comma
id|resource_no
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|release_mem_region
c_func
(paren
id|macio_resource_start
c_func
(paren
id|dev
comma
id|resource_no
)paren
comma
id|macio_resource_len
c_func
(paren
id|dev
comma
id|resource_no
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;macio_request_resources - Reserve all memory resources&n; *&t;@dev: MacIO device whose resources are to be reserved&n; *&t;@name: Name to be associated with resource.&n; *&n; *&t;Mark all memory regions associated with MacIO device @dev as&n; *&t;being reserved by owner @name.  Do not access any address inside&n; *&t;the memory regions unless this call returns successfully.&n; *&n; *&t;Returns 0 on success, or %EBUSY on error.  A warning&n; *&t;message is also printed on failure.&n; */
DECL|function|macio_request_resources
r_int
id|macio_request_resources
c_func
(paren
r_struct
id|macio_dev
op_star
id|dev
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;n_resources
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|macio_request_resource
c_func
(paren
id|dev
comma
id|i
comma
id|name
)paren
)paren
r_goto
id|err_out
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out
suffix:colon
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
(brace
id|macio_release_resource
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;macio_release_resources - Release reserved memory resources&n; *&t;@dev: MacIO device whose resources were previously reserved&n; */
DECL|function|macio_release_resources
r_void
id|macio_release_resources
c_func
(paren
r_struct
id|macio_dev
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;n_resources
suffix:semicolon
id|i
op_increment
)paren
id|macio_release_resource
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PCI
DECL|function|macio_pci_probe
r_static
r_int
id|__devinit
id|macio_pci_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
r_struct
id|macio_chip
op_star
id|chip
suffix:semicolon
r_if
c_cond
(paren
id|ent-&gt;vendor
op_ne
id|PCI_VENDOR_ID_APPLE
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Note regarding refcounting: We assume pci_device_to_OF_node() is ported&n;&t; * to new OF APIs and returns a node with refcount incremented. This isn&squot;t&n;&t; * the case today, but on the other hand ppc32 doesn&squot;t do refcounting. This&n;&t; * will have to be fixed when going to ppc64. --BenH.&n;&t; */
id|np
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* This assumption is wrong, fix that here for now until I fix the arch */
id|of_node_get
c_func
(paren
id|np
)paren
suffix:semicolon
multiline_comment|/* We also assume that pmac_feature will have done a get() on nodes stored&n;&t; * in the macio chips array&n;&t; */
id|chip
op_assign
id|macio_find
c_func
(paren
id|np
comma
id|macio_unknown
)paren
suffix:semicolon
id|of_node_put
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* XXX Need locking ??? */
r_if
c_cond
(paren
id|chip-&gt;lbus.pdev
op_eq
l_int|NULL
)paren
(brace
id|chip-&gt;lbus.pdev
op_assign
id|pdev
suffix:semicolon
id|chip-&gt;lbus.chip
op_assign
id|chip
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
op_amp
id|chip-&gt;lbus
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MacIO PCI driver attached to %s chipset&bslash;n&quot;
comma
id|chip-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * HACK ALERT: The WallStreet PowerBook and some OHare based machines&n;&t; * have 2 macio ASICs. I must probe the &quot;main&quot; one first or IDE ordering&n;&t; * will be incorrect. So I put on &quot;hold&quot; the second one since it seem to&n;&t; * appear first on PCI&n;&t; */
r_if
c_cond
(paren
id|chip-&gt;type
op_eq
id|macio_gatwick
op_logical_or
id|chip-&gt;type
op_eq
id|macio_ohareII
)paren
r_if
c_cond
(paren
id|macio_chips
(braket
l_int|0
)braket
dot
id|lbus.pdev
op_eq
l_int|NULL
)paren
(brace
id|macio_on_hold
op_assign
id|chip
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|macio_pci_add_devices
c_func
(paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|macio_on_hold
op_logical_and
id|macio_chips
(braket
l_int|0
)braket
dot
id|lbus.pdev
op_ne
l_int|NULL
)paren
(brace
id|macio_pci_add_devices
c_func
(paren
id|macio_on_hold
)paren
suffix:semicolon
id|macio_on_hold
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macio_pci_remove
r_static
r_void
id|__devexit
id|macio_pci_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;removing of macio-asic not supported !&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MacIO is matched against any Apple ID, it&squot;s probe() function&n; * will then decide wether it applies or not&n; */
DECL|variable|pci_ids
r_static
r_const
r_struct
id|pci_device_id
id|__devinitdata
id|pci_ids
(braket
)braket
op_assign
(brace
(brace
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_APPLE
comma
dot
id|device
op_assign
id|PCI_ANY_ID
comma
dot
id|subvendor
op_assign
id|PCI_ANY_ID
comma
dot
id|subdevice
op_assign
id|PCI_ANY_ID
comma
)brace
comma
(brace
multiline_comment|/* end: all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|pci_ids
)paren
suffix:semicolon
multiline_comment|/* pci driver glue; this is a &quot;new style&quot; PCI driver module */
DECL|variable|macio_pci_driver
r_static
r_struct
id|pci_driver
id|macio_pci_driver
op_assign
(brace
dot
id|name
op_assign
(paren
r_char
op_star
)paren
l_string|&quot;macio&quot;
comma
dot
id|id_table
op_assign
id|pci_ids
comma
dot
id|probe
op_assign
id|macio_pci_probe
comma
dot
id|remove
op_assign
id|macio_pci_remove
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PCI */
DECL|function|macio_module_init
r_static
r_int
id|__init
id|macio_module_init
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PCI
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|macio_pci_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
macro_line|#endif /* CONFIG_PCI */
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|macio_module_init
id|module_init
c_func
(paren
id|macio_module_init
)paren
suffix:semicolon
DECL|variable|macio_register_driver
id|EXPORT_SYMBOL
c_func
(paren
id|macio_register_driver
)paren
suffix:semicolon
DECL|variable|macio_unregister_driver
id|EXPORT_SYMBOL
c_func
(paren
id|macio_unregister_driver
)paren
suffix:semicolon
DECL|variable|macio_dev_get
id|EXPORT_SYMBOL
c_func
(paren
id|macio_dev_get
)paren
suffix:semicolon
DECL|variable|macio_dev_put
id|EXPORT_SYMBOL
c_func
(paren
id|macio_dev_put
)paren
suffix:semicolon
DECL|variable|macio_request_resource
id|EXPORT_SYMBOL
c_func
(paren
id|macio_request_resource
)paren
suffix:semicolon
DECL|variable|macio_release_resource
id|EXPORT_SYMBOL
c_func
(paren
id|macio_release_resource
)paren
suffix:semicolon
DECL|variable|macio_request_resources
id|EXPORT_SYMBOL
c_func
(paren
id|macio_request_resources
)paren
suffix:semicolon
DECL|variable|macio_release_resources
id|EXPORT_SYMBOL
c_func
(paren
id|macio_release_resources
)paren
suffix:semicolon
eof
