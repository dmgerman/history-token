multiline_comment|/*&n; * Bus &amp; driver management routines for devices within&n; * a MacIO ASIC. Interface to new driver model mostly&n; * stolen from the PCI version.&n; * &n; * TODO:&n; * &n; *  - Don&squot;t probe below media bay by default, but instead provide&n; *    some hooks for media bay to dynamically add/remove it&squot;s own&n; *    sub-devices.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/pci_ids.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/macio.h&gt;
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
r_static
r_int
DECL|function|macio_bus_match
id|macio_bus_match
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|device_driver
op_star
id|drv
)paren
(brace
r_struct
id|macio_dev
op_star
id|macio_dev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|macio_driver
op_star
id|macio_drv
op_assign
id|to_macio_driver
c_func
(paren
id|drv
)paren
suffix:semicolon
r_const
r_struct
id|of_match
op_star
id|matches
op_assign
id|macio_drv-&gt;match_table
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|matches
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|of_match_device
c_func
(paren
id|matches
comma
op_amp
id|macio_dev-&gt;ofdev
)paren
op_ne
l_int|NULL
suffix:semicolon
)brace
DECL|variable|macio_bus_type
r_struct
id|bus_type
id|macio_bus_type
op_assign
(brace
id|name
suffix:colon
l_string|&quot;macio&quot;
comma
id|match
suffix:colon
id|macio_bus_match
comma
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|macio_bus_driver_init
id|macio_bus_driver_init
c_func
(paren
r_void
)paren
(brace
r_return
id|bus_register
c_func
(paren
op_amp
id|macio_bus_type
)paren
suffix:semicolon
)brace
DECL|variable|macio_bus_driver_init
id|postcore_initcall
c_func
(paren
id|macio_bus_driver_init
)paren
suffix:semicolon
r_static
r_int
DECL|function|macio_device_probe
id|macio_device_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|error
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|macio_driver
op_star
id|drv
suffix:semicolon
r_struct
id|macio_dev
op_star
id|macio_dev
suffix:semicolon
r_const
r_struct
id|of_match
op_star
id|match
suffix:semicolon
id|drv
op_assign
id|to_macio_driver
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
id|macio_dev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drv-&gt;probe
)paren
r_return
id|error
suffix:semicolon
multiline_comment|/*&t;if (!try_module_get(driver-&gt;owner)) {&n;&t;&t;printk(KERN_ERR &quot;Can&squot;t get a module reference for %s&bslash;n&quot;, driver-&gt;name);&n;&t;&t;return error;&n;&t;}&n;*/
id|match
op_assign
id|of_match_device
c_func
(paren
id|drv-&gt;match_table
comma
op_amp
id|macio_dev-&gt;ofdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|match
)paren
id|error
op_assign
id|drv
op_member_access_from_pointer
id|probe
c_func
(paren
id|macio_dev
comma
id|match
)paren
suffix:semicolon
multiline_comment|/*&n; &t;module_put(driver-&gt;owner);&n;*/
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|macio_device_remove
id|macio_device_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|macio_dev
op_star
id|macio_dev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|macio_driver
op_star
id|drv
op_assign
id|to_macio_driver
c_func
(paren
id|macio_dev-&gt;ofdev.dev.driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drv
op_logical_and
id|drv-&gt;remove
)paren
id|drv
op_member_access_from_pointer
id|remove
c_func
(paren
id|macio_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|macio_device_suspend
id|macio_device_suspend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
comma
id|u32
id|level
)paren
(brace
r_struct
id|macio_dev
op_star
id|macio_dev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|macio_driver
op_star
id|drv
op_assign
id|to_macio_driver
c_func
(paren
id|macio_dev-&gt;ofdev.dev.driver
)paren
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|drv
op_logical_and
id|drv-&gt;suspend
)paren
id|error
op_assign
id|drv
op_member_access_from_pointer
id|suspend
c_func
(paren
id|macio_dev
comma
id|state
comma
id|level
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|macio_device_resume
id|macio_device_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|level
)paren
(brace
r_struct
id|macio_dev
op_star
id|macio_dev
op_assign
id|to_macio_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|macio_driver
op_star
id|drv
op_assign
id|to_macio_driver
c_func
(paren
id|macio_dev-&gt;ofdev.dev.driver
)paren
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|drv
op_logical_and
id|drv-&gt;resume
)paren
id|error
op_assign
id|drv
op_member_access_from_pointer
id|resume
c_func
(paren
id|macio_dev
comma
id|level
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; * macio_add_one_device - Add one device from OF node to the device tree&n; * @chip: pointer to the macio_chip holding the device&n; * @np: pointer to the device node in the OF tree&n; * @in_bay: set to 1 if device is part of a media-bay&n; *&n; * When media-bay is changed to hotswap drivers, this function will&n; * be exposed to the bay driver some way...&n; */
r_static
r_struct
id|macio_dev
op_star
DECL|function|macio_add_one_device
id|macio_add_one_device
c_func
(paren
r_struct
id|macio_chip
op_star
id|chip
comma
r_struct
id|device
op_star
id|parent
comma
r_struct
id|device_node
op_star
id|np
comma
r_struct
id|macio_dev
op_star
id|in_bay
)paren
(brace
r_struct
id|macio_dev
op_star
id|dev
suffix:semicolon
id|u32
op_star
id|reg
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|dev-&gt;bus
op_assign
op_amp
id|chip-&gt;lbus
suffix:semicolon
id|dev-&gt;media_bay
op_assign
id|in_bay
suffix:semicolon
id|dev-&gt;ofdev.node
op_assign
id|np
suffix:semicolon
id|dev-&gt;ofdev.dma_mask
op_assign
l_int|0xffffffffUL
suffix:semicolon
id|dev-&gt;ofdev.dev.dma_mask
op_assign
op_amp
id|dev-&gt;ofdev.dma_mask
suffix:semicolon
id|dev-&gt;ofdev.dev.parent
op_assign
id|parent
suffix:semicolon
id|dev-&gt;ofdev.dev.bus
op_assign
op_amp
id|macio_bus_type
suffix:semicolon
multiline_comment|/* MacIO itself has a different reg, we use it&squot;s PCI base */
r_if
c_cond
(paren
id|np
op_eq
id|chip-&gt;of_node
)paren
(brace
id|sprintf
c_func
(paren
id|dev-&gt;ofdev.dev.bus_id
comma
l_string|&quot;%1d.%08lx:%.8s&quot;
comma
id|chip-&gt;lbus.index
comma
macro_line|#ifdef CONFIG_PCI
id|pci_resource_start
c_func
(paren
id|chip-&gt;lbus.pdev
comma
l_int|0
)paren
comma
macro_line|#else
l_int|0
comma
multiline_comment|/* NuBus may want to do something better here */
macro_line|#endif
id|np-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|reg
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;reg&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|dev-&gt;ofdev.dev.bus_id
comma
l_string|&quot;%1d.%08x:%.8s&quot;
comma
id|chip-&gt;lbus.index
comma
id|reg
ques
c_cond
op_star
id|reg
suffix:colon
l_int|0
comma
id|np-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|of_device_register
c_func
(paren
op_amp
id|dev-&gt;ofdev
)paren
op_ne
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|dev
suffix:semicolon
)brace
r_static
r_int
DECL|function|macio_skip_device
id|macio_skip_device
c_func
(paren
r_struct
id|device_node
op_star
id|np
)paren
(brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;battery&quot;
comma
l_int|7
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;escc-legacy&quot;
comma
l_int|11
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * macio_pci_add_devices - Adds sub-devices of mac-io to the device tree&n; * @chip: pointer to the macio_chip holding the devices&n; * &n; * This function will do the job of extracting devices from the&n; * Open Firmware device tree, build macio_dev structures and add&n; * them to the Linux device tree.&n; * &n; * For now, childs of media-bay are added now as well. This will&n; * change rsn though.&n; */
r_static
r_void
DECL|function|macio_pci_add_devices
id|macio_pci_add_devices
c_func
(paren
r_struct
id|macio_chip
op_star
id|chip
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
r_struct
id|macio_dev
op_star
id|rdev
comma
op_star
id|mdev
comma
op_star
id|mbdev
op_assign
l_int|NULL
comma
op_star
id|sdev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|device
op_star
id|parent
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Add a node for the macio bus itself */
macro_line|#ifdef CONFIG_PCI
r_if
c_cond
(paren
id|chip-&gt;lbus.pdev
)paren
id|parent
op_assign
op_amp
id|chip-&gt;lbus.pdev-&gt;dev
suffix:semicolon
macro_line|#endif&t;&t;
id|rdev
op_assign
id|macio_add_one_device
c_func
(paren
id|chip
comma
id|parent
comma
id|chip-&gt;of_node
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rdev
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* First scan 1st level */
r_for
c_loop
(paren
id|np
op_assign
id|chip-&gt;of_node-&gt;child
suffix:semicolon
id|np
op_ne
l_int|NULL
suffix:semicolon
id|np
op_assign
id|np-&gt;sibling
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|macio_skip_device
c_func
(paren
id|np
)paren
)paren
(brace
id|mdev
op_assign
id|macio_add_one_device
c_func
(paren
id|chip
comma
op_amp
id|rdev-&gt;ofdev.dev
comma
id|np
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;media-bay&quot;
comma
l_int|9
)paren
op_eq
l_int|0
)paren
id|mbdev
op_assign
id|mdev
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|np-&gt;name
comma
l_string|&quot;escc&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
id|sdev
op_assign
id|mdev
suffix:semicolon
)brace
)brace
multiline_comment|/* Add media bay devices if any */
r_if
c_cond
(paren
id|mbdev
)paren
(brace
r_for
c_loop
(paren
id|np
op_assign
id|mbdev-&gt;ofdev.node-&gt;child
suffix:semicolon
id|np
op_ne
l_int|NULL
suffix:semicolon
id|np
op_assign
id|np-&gt;sibling
)paren
r_if
c_cond
(paren
op_logical_neg
id|macio_skip_device
c_func
(paren
id|np
)paren
)paren
id|macio_add_one_device
c_func
(paren
id|chip
comma
op_amp
id|mbdev-&gt;ofdev.dev
comma
id|np
comma
id|mbdev
)paren
suffix:semicolon
)brace
multiline_comment|/* Add serial ports if any */
r_if
c_cond
(paren
id|sdev
)paren
(brace
r_for
c_loop
(paren
id|np
op_assign
id|sdev-&gt;ofdev.node-&gt;child
suffix:semicolon
id|np
op_ne
l_int|NULL
suffix:semicolon
id|np
op_assign
id|np-&gt;sibling
)paren
r_if
c_cond
(paren
op_logical_neg
id|macio_skip_device
c_func
(paren
id|np
)paren
)paren
id|macio_add_one_device
c_func
(paren
id|chip
comma
op_amp
id|sdev-&gt;ofdev.dev
comma
id|np
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * macio_register_driver - Registers a new MacIO device driver&n; * @drv: pointer to the driver definition structure&n; */
r_int
DECL|function|macio_register_driver
id|macio_register_driver
c_func
(paren
r_struct
id|macio_driver
op_star
id|drv
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initialize common driver fields */
id|drv-&gt;driver.name
op_assign
id|drv-&gt;name
suffix:semicolon
id|drv-&gt;driver.bus
op_assign
op_amp
id|macio_bus_type
suffix:semicolon
id|drv-&gt;driver.probe
op_assign
id|macio_device_probe
suffix:semicolon
id|drv-&gt;driver.resume
op_assign
id|macio_device_resume
suffix:semicolon
id|drv-&gt;driver.suspend
op_assign
id|macio_device_suspend
suffix:semicolon
id|drv-&gt;driver.remove
op_assign
id|macio_device_remove
suffix:semicolon
multiline_comment|/* register with core */
id|count
op_assign
id|driver_register
c_func
(paren
op_amp
id|drv-&gt;driver
)paren
suffix:semicolon
r_return
id|count
ques
c_cond
id|count
suffix:colon
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * macio_unregister_driver - Unregisters a new MacIO device driver&n; * @drv: pointer to the driver definition structure&n; */
r_void
DECL|function|macio_unregister_driver
id|macio_unregister_driver
c_func
(paren
r_struct
id|macio_driver
op_star
id|drv
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|drv-&gt;driver
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PCI
r_static
r_int
id|__devinit
DECL|function|macio_pci_probe
id|macio_pci_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
r_struct
id|macio_chip
op_star
id|chip
suffix:semicolon
r_if
c_cond
(paren
id|ent-&gt;vendor
op_ne
id|PCI_VENDOR_ID_APPLE
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|np
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|chip
op_assign
id|macio_find
c_func
(paren
id|np
comma
id|macio_unknown
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* XXX Need locking */
r_if
c_cond
(paren
id|chip-&gt;lbus.pdev
op_eq
l_int|NULL
)paren
(brace
id|chip-&gt;lbus.pdev
op_assign
id|pdev
suffix:semicolon
id|chip-&gt;lbus.chip
op_assign
id|chip
suffix:semicolon
singleline_comment|//&t;&t;INIT_LIST_HEAD(&amp;chip-&gt;lbus.devices);
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
op_amp
id|chip-&gt;lbus
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MacIO PCI driver attached to %s chipset&bslash;n&quot;
comma
id|chip-&gt;name
)paren
suffix:semicolon
id|macio_pci_add_devices
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__devexit
DECL|function|macio_pci_remove
id|macio_pci_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;removing of macio-asic not supported !&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MacIO is matched against any Apple ID, it&squot;s probe() function&n; * will then decide wether it applies or not&n; */
DECL|variable|pci_ids
r_static
r_const
r_struct
id|pci_device_id
id|__devinitdata
id|pci_ids
(braket
)braket
op_assign
(brace
(brace
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_APPLE
comma
dot
id|device
op_assign
id|PCI_ANY_ID
comma
dot
id|subvendor
op_assign
id|PCI_ANY_ID
comma
dot
id|subdevice
op_assign
id|PCI_ANY_ID
comma
)brace
comma
(brace
multiline_comment|/* end: all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|pci_ids
)paren
suffix:semicolon
multiline_comment|/* pci driver glue; this is a &quot;new style&quot; PCI driver module */
DECL|variable|macio_pci_driver
r_static
r_struct
id|pci_driver
id|macio_pci_driver
op_assign
(brace
dot
id|name
op_assign
(paren
r_char
op_star
)paren
l_string|&quot;macio&quot;
comma
dot
id|id_table
op_assign
id|pci_ids
comma
dot
id|probe
op_assign
id|macio_pci_probe
comma
dot
id|remove
op_assign
id|macio_pci_remove
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PCI */
r_static
r_int
id|__init
DECL|function|macio_module_init
id|macio_module_init
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PCI
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|macio_pci_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
macro_line|#endif /* CONFIG_PCI */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;static void __exit&n;macio_module_cleanup (void) &n;{&t;&n;#ifdef CONFIG_PCI&n;&t;pci_unregister_driver(&amp;macio_pci_driver);&n;#endif&n;}&n;module_exit(macio_module_cleanup);&n;*/
DECL|variable|macio_module_init
id|module_init
c_func
(paren
id|macio_module_init
)paren
suffix:semicolon
DECL|variable|macio_register_driver
id|EXPORT_SYMBOL
c_func
(paren
id|macio_register_driver
)paren
suffix:semicolon
DECL|variable|macio_unregister_driver
id|EXPORT_SYMBOL
c_func
(paren
id|macio_unregister_driver
)paren
suffix:semicolon
eof
