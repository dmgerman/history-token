multiline_comment|/*&n; * PowerMac G5 SMU driver&n; *&n; * Copyright 2004 J. Mayer &lt;l_indien@magic.fr&gt;&n; * Copyright 2005 Benjamin Herrenschmidt, IBM Corp.&n; *&n; * Released under the term of the GNU GPL v2.&n; */
multiline_comment|/*&n; * For now, this driver includes:&n; * - RTC get &amp; set&n; * - reboot &amp; shutdown commands&n; * all synchronous with IRQ disabled (ugh)&n; *&n; * TODO:&n; *   rework in a way the PMU driver works, that is asynchronous&n; *   with a queue of commands. I&squot;ll do that as soon as I have an&n; *   SMU based machine at hand. Some more cleanup is needed too,&n; *   like maybe fitting it into a platform device, etc...&n; *   Also check what&squot;s up with cache coherency, and if we really&n; *   can&squot;t do better than flushing the cache, maybe build a table&n; *   of command len/reply len like the PMU driver to only flush&n; *   what is actually necessary.&n; *   --BenH.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/dmapool.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/highmem.h&gt;
macro_line|#include &lt;linux/jiffies.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/rtc.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#include &lt;asm/smu.h&gt;
macro_line|#include &lt;asm/sections.h&gt;
macro_line|#include &lt;asm/abs_addr.h&gt;
DECL|macro|DEBUG_SMU
mdefine_line|#define DEBUG_SMU 1
macro_line|#ifdef DEBUG_SMU
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...) do { printk(KERN_DEBUG fmt , ##args); } while (0)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...) do { } while (0)
macro_line|#endif
multiline_comment|/*&n; * This is the command buffer passed to the SMU hardware&n; */
DECL|struct|smu_cmd_buf
r_struct
id|smu_cmd_buf
(brace
DECL|member|cmd
id|u8
id|cmd
suffix:semicolon
DECL|member|length
id|u8
id|length
suffix:semicolon
DECL|member|data
id|u8
id|data
(braket
l_int|0x0FFE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|smu_device
r_struct
id|smu_device
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|of_node
r_struct
id|device_node
op_star
id|of_node
suffix:semicolon
DECL|member|db_ack
r_int
id|db_ack
suffix:semicolon
multiline_comment|/* doorbell ack GPIO */
DECL|member|db_req
r_int
id|db_req
suffix:semicolon
multiline_comment|/* doorbell req GPIO */
DECL|member|db_buf
id|u32
id|__iomem
op_star
id|db_buf
suffix:semicolon
multiline_comment|/* doorbell buffer */
DECL|member|cmd_buf
r_struct
id|smu_cmd_buf
op_star
id|cmd_buf
suffix:semicolon
multiline_comment|/* command buffer virtual */
DECL|member|cmd_buf_abs
id|u32
id|cmd_buf_abs
suffix:semicolon
multiline_comment|/* command buffer absolute */
)brace
suffix:semicolon
multiline_comment|/*&n; * I don&squot;t think there will ever be more than one SMU, so&n; * for now, just hard code that&n; */
DECL|variable|smu
r_static
r_struct
id|smu_device
op_star
id|smu
suffix:semicolon
multiline_comment|/*&n; * SMU low level communication stuff&n; */
DECL|function|smu_cmd_stat
r_static
r_inline
r_int
id|smu_cmd_stat
c_func
(paren
r_struct
id|smu_cmd_buf
op_star
id|cmd_buf
comma
id|u8
id|cmd_ack
)paren
(brace
id|rmb
c_func
(paren
)paren
suffix:semicolon
r_return
id|cmd_buf-&gt;cmd
op_eq
id|cmd_ack
op_logical_and
id|cmd_buf-&gt;length
op_ne
l_int|0
suffix:semicolon
)brace
DECL|function|smu_save_ack_cmd
r_static
r_inline
id|u8
id|smu_save_ack_cmd
c_func
(paren
r_struct
id|smu_cmd_buf
op_star
id|cmd_buf
)paren
(brace
r_return
(paren
op_complement
id|cmd_buf-&gt;cmd
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
DECL|function|smu_send_cmd
r_static
r_void
id|smu_send_cmd
c_func
(paren
r_struct
id|smu_device
op_star
id|dev
)paren
(brace
multiline_comment|/* SMU command buf is currently cacheable, we need a physical&n;&t; * address. This isn&squot;t exactly a DMA mapping here, I suspect&n;&t; * the SMU is actually communicating with us via i2c to the&n;&t; * northbridge or the CPU to access RAM.&n;&t; */
id|writel
c_func
(paren
id|dev-&gt;cmd_buf_abs
comma
id|dev-&gt;db_buf
)paren
suffix:semicolon
multiline_comment|/* Ring the SMU doorbell */
id|pmac_do_feature_call
c_func
(paren
id|PMAC_FTR_WRITE_GPIO
comma
l_int|NULL
comma
id|dev-&gt;db_req
comma
l_int|4
)paren
suffix:semicolon
id|pmac_do_feature_call
c_func
(paren
id|PMAC_FTR_READ_GPIO
comma
l_int|NULL
comma
id|dev-&gt;db_req
comma
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|smu_cmd_done
r_static
r_int
id|smu_cmd_done
c_func
(paren
r_struct
id|smu_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|wait
op_assign
l_int|0
suffix:semicolon
r_int
id|gpio
suffix:semicolon
multiline_comment|/* Check the SMU doorbell */
r_do
(brace
id|gpio
op_assign
id|pmac_do_feature_call
c_func
(paren
id|PMAC_FTR_READ_GPIO
comma
l_int|NULL
comma
id|dev-&gt;db_ack
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|gpio
op_amp
l_int|7
)paren
op_eq
l_int|7
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_increment
id|wait
OL
l_int|10000
)paren
(brace
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SMU timeout !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
DECL|function|smu_do_cmd
r_static
r_int
id|smu_do_cmd
c_func
(paren
r_struct
id|smu_device
op_star
id|dev
)paren
(brace
r_int
id|rc
suffix:semicolon
id|u8
id|cmd_ack
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;SMU do_cmd %02x len=%d %02x&bslash;n&quot;
comma
id|dev-&gt;cmd_buf-&gt;cmd
comma
id|dev-&gt;cmd_buf-&gt;length
comma
id|dev-&gt;cmd_buf-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|cmd_ack
op_assign
id|smu_save_ack_cmd
c_func
(paren
id|dev-&gt;cmd_buf
)paren
suffix:semicolon
multiline_comment|/* Clear cmd_buf cache lines */
id|flush_inval_dcache_range
c_func
(paren
(paren
r_int
r_int
)paren
id|dev-&gt;cmd_buf
comma
(paren
(paren
r_int
r_int
)paren
id|dev-&gt;cmd_buf
)paren
op_plus
r_sizeof
(paren
r_struct
id|smu_cmd_buf
)paren
)paren
suffix:semicolon
id|smu_send_cmd
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rc
op_assign
id|smu_cmd_done
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|rc
op_assign
id|smu_cmd_stat
c_func
(paren
id|dev-&gt;cmd_buf
comma
id|cmd_ack
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;SMU do_cmd %02x len=%d %02x =&gt; %d (%02x)&bslash;n&quot;
comma
id|dev-&gt;cmd_buf-&gt;cmd
comma
id|dev-&gt;cmd_buf-&gt;length
comma
id|dev-&gt;cmd_buf-&gt;data
(braket
l_int|0
)braket
comma
id|rc
comma
id|cmd_ack
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* RTC low level commands */
DECL|function|bcd2hex
r_static
r_inline
r_int
id|bcd2hex
(paren
r_int
id|n
)paren
(brace
r_return
(paren
(paren
(paren
id|n
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
)paren
op_star
l_int|10
)paren
op_plus
(paren
id|n
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
DECL|function|hex2bcd
r_static
r_inline
r_int
id|hex2bcd
(paren
r_int
id|n
)paren
(brace
r_return
(paren
(paren
id|n
op_div
l_int|10
)paren
op_lshift
l_int|4
)paren
op_plus
(paren
id|n
op_mod
l_int|10
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_inline
r_void
id|smu_fill_set_pwrup_timer_cmd
c_func
(paren
r_struct
id|smu_cmd_buf
op_star
id|cmd_buf
)paren
(brace
id|cmd_buf-&gt;cmd
op_assign
l_int|0x8e
suffix:semicolon
id|cmd_buf-&gt;length
op_assign
l_int|8
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|memset
c_func
(paren
id|cmd_buf-&gt;data
op_plus
l_int|1
comma
l_int|0
comma
l_int|7
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
id|smu_fill_get_pwrup_timer_cmd
c_func
(paren
r_struct
id|smu_cmd_buf
op_star
id|cmd_buf
)paren
(brace
id|cmd_buf-&gt;cmd
op_assign
l_int|0x8e
suffix:semicolon
id|cmd_buf-&gt;length
op_assign
l_int|1
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
)brace
r_static
r_inline
r_void
id|smu_fill_dis_pwrup_timer_cmd
c_func
(paren
r_struct
id|smu_cmd_buf
op_star
id|cmd_buf
)paren
(brace
id|cmd_buf-&gt;cmd
op_assign
l_int|0x8e
suffix:semicolon
id|cmd_buf-&gt;length
op_assign
l_int|1
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x02
suffix:semicolon
)brace
macro_line|#endif
DECL|function|smu_fill_set_rtc_cmd
r_static
r_inline
r_void
id|smu_fill_set_rtc_cmd
c_func
(paren
r_struct
id|smu_cmd_buf
op_star
id|cmd_buf
comma
r_struct
id|rtc_time
op_star
id|time
)paren
(brace
id|cmd_buf-&gt;cmd
op_assign
l_int|0x8e
suffix:semicolon
id|cmd_buf-&gt;length
op_assign
l_int|8
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x80
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|1
)braket
op_assign
id|hex2bcd
c_func
(paren
id|time-&gt;tm_sec
)paren
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|2
)braket
op_assign
id|hex2bcd
c_func
(paren
id|time-&gt;tm_min
)paren
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|3
)braket
op_assign
id|hex2bcd
c_func
(paren
id|time-&gt;tm_hour
)paren
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|4
)braket
op_assign
id|time-&gt;tm_wday
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|5
)braket
op_assign
id|hex2bcd
c_func
(paren
id|time-&gt;tm_mday
)paren
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|6
)braket
op_assign
id|hex2bcd
c_func
(paren
id|time-&gt;tm_mon
)paren
op_plus
l_int|1
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|7
)braket
op_assign
id|hex2bcd
c_func
(paren
id|time-&gt;tm_year
op_minus
l_int|100
)paren
suffix:semicolon
)brace
DECL|function|smu_fill_get_rtc_cmd
r_static
r_inline
r_void
id|smu_fill_get_rtc_cmd
c_func
(paren
r_struct
id|smu_cmd_buf
op_star
id|cmd_buf
)paren
(brace
id|cmd_buf-&gt;cmd
op_assign
l_int|0x8e
suffix:semicolon
id|cmd_buf-&gt;length
op_assign
l_int|1
suffix:semicolon
id|cmd_buf-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0x81
suffix:semicolon
)brace
DECL|function|smu_parse_get_rtc_reply
r_static
r_void
id|smu_parse_get_rtc_reply
c_func
(paren
r_struct
id|smu_cmd_buf
op_star
id|cmd_buf
comma
r_struct
id|rtc_time
op_star
id|time
)paren
(brace
id|time-&gt;tm_sec
op_assign
id|bcd2hex
c_func
(paren
id|cmd_buf-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|time-&gt;tm_min
op_assign
id|bcd2hex
c_func
(paren
id|cmd_buf-&gt;data
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|time-&gt;tm_hour
op_assign
id|bcd2hex
c_func
(paren
id|cmd_buf-&gt;data
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|time-&gt;tm_wday
op_assign
id|bcd2hex
c_func
(paren
id|cmd_buf-&gt;data
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|time-&gt;tm_mday
op_assign
id|bcd2hex
c_func
(paren
id|cmd_buf-&gt;data
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|time-&gt;tm_mon
op_assign
id|bcd2hex
c_func
(paren
id|cmd_buf-&gt;data
(braket
l_int|5
)braket
)paren
op_minus
l_int|1
suffix:semicolon
id|time-&gt;tm_year
op_assign
id|bcd2hex
c_func
(paren
id|cmd_buf-&gt;data
(braket
l_int|6
)braket
)paren
op_plus
l_int|100
suffix:semicolon
)brace
DECL|function|smu_get_rtc_time
r_int
id|smu_get_rtc_time
c_func
(paren
r_struct
id|rtc_time
op_star
id|time
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|smu
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|memset
c_func
(paren
id|time
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|smu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|smu_fill_get_rtc_cmd
c_func
(paren
id|smu-&gt;cmd_buf
)paren
suffix:semicolon
id|rc
op_assign
id|smu_do_cmd
c_func
(paren
id|smu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|smu_parse_get_rtc_reply
c_func
(paren
id|smu-&gt;cmd_buf
comma
id|time
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|smu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|smu_set_rtc_time
r_int
id|smu_set_rtc_time
c_func
(paren
r_struct
id|rtc_time
op_star
id|time
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|smu
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|smu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|smu_fill_set_rtc_cmd
c_func
(paren
id|smu-&gt;cmd_buf
comma
id|time
)paren
suffix:semicolon
id|rc
op_assign
id|smu_do_cmd
c_func
(paren
id|smu
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|smu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|smu_shutdown
r_void
id|smu_shutdown
c_func
(paren
r_void
)paren
(brace
r_const
r_int
r_char
op_star
id|command
op_assign
l_string|&quot;SHUTDOWN&quot;
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|smu
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|smu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|smu-&gt;cmd_buf-&gt;cmd
op_assign
l_int|0xaa
suffix:semicolon
id|smu-&gt;cmd_buf-&gt;length
op_assign
id|strlen
c_func
(paren
id|command
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|smu-&gt;cmd_buf-&gt;data
comma
id|command
)paren
suffix:semicolon
id|smu_do_cmd
c_func
(paren
id|smu
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|smu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|smu_restart
r_void
id|smu_restart
c_func
(paren
r_void
)paren
(brace
r_const
r_int
r_char
op_star
id|command
op_assign
l_string|&quot;RESTART&quot;
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|smu
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|smu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|smu-&gt;cmd_buf-&gt;cmd
op_assign
l_int|0xaa
suffix:semicolon
id|smu-&gt;cmd_buf-&gt;length
op_assign
id|strlen
c_func
(paren
id|command
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|smu-&gt;cmd_buf-&gt;data
comma
id|command
)paren
suffix:semicolon
id|smu_do_cmd
c_func
(paren
id|smu
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|smu-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|smu_present
r_int
id|smu_present
c_func
(paren
r_void
)paren
(brace
r_return
id|smu
op_ne
l_int|NULL
suffix:semicolon
)brace
DECL|function|smu_init
r_int
id|smu_init
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
id|u32
op_star
id|data
suffix:semicolon
id|np
op_assign
id|of_find_node_by_type
c_func
(paren
l_int|NULL
comma
l_string|&quot;smu&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|smu_cmdbuf_abs
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SMU: Command buffer not allocated !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|smu
op_assign
id|alloc_bootmem
c_func
(paren
r_sizeof
(paren
r_struct
id|smu_device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smu
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|smu
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|smu
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|smu-&gt;lock
)paren
suffix:semicolon
id|smu-&gt;of_node
op_assign
id|np
suffix:semicolon
multiline_comment|/* smu_cmdbuf_abs is in the low 2G of RAM, can be converted to a&n;&t; * 32 bits value safely&n;&t; */
id|smu-&gt;cmd_buf_abs
op_assign
(paren
id|u32
)paren
id|smu_cmdbuf_abs
suffix:semicolon
id|smu-&gt;cmd_buf
op_assign
(paren
r_struct
id|smu_cmd_buf
op_star
)paren
id|abs_to_virt
c_func
(paren
id|smu_cmdbuf_abs
)paren
suffix:semicolon
id|np
op_assign
id|of_find_node_by_name
c_func
(paren
l_int|NULL
comma
l_string|&quot;smu-doorbell&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SMU: Can&squot;t find doorbell GPIO !&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|data
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;reg&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|of_node_put
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SMU: Can&squot;t find doorbell GPIO address !&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* Current setup has one doorbell GPIO that does both doorbell&n;&t; * and ack. GPIOs are at 0x50, best would be to find that out&n;&t; * in the device-tree though.&n;&t; */
id|smu-&gt;db_req
op_assign
l_int|0x50
op_plus
op_star
id|data
suffix:semicolon
id|smu-&gt;db_ack
op_assign
l_int|0x50
op_plus
op_star
id|data
suffix:semicolon
multiline_comment|/* Doorbell buffer is currently hard-coded, I didn&squot;t find a proper&n;&t; * device-tree entry giving the address. Best would probably to use&n;&t; * an offset for K2 base though, but let&squot;s do it that way for now.&n;&t; */
id|smu-&gt;db_buf
op_assign
id|ioremap
c_func
(paren
l_int|0x8000860c
comma
l_int|0x1000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smu-&gt;db_buf
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SMU: Can&squot;t map doorbell buffer pointer !&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|sys_ctrler
op_assign
id|SYS_CTRLER_SMU
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|smu
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
eof
