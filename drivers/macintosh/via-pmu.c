multiline_comment|/*&n; * Device driver for the via-pmu on Apple Powermacs.&n; *&n; * The VIA (versatile interface adapter) interfaces to the PMU,&n; * a 6805 microprocessor core whose primary function is to control&n; * battery charging and system power on the PowerBook 3400 and 2400.&n; * The PMU also controls the ADB (Apple Desktop Bus) which connects&n; * to the keyboard and mouse, as well as the non-volatile RAM&n; * and the RTC (real time clock) chip.&n; *&n; * Copyright (C) 1998 Paul Mackerras and Fabio Riccardi.&n; * Copyright (C) 2001-2002 Benjamin Herrenschmidt&n; *&n; * THIS DRIVER IS BECOMING A TOTAL MESS !&n; *  - Cleanup atomically disabling reply to PMU events after&n; *    a sleep or a freq. switch&n; *  - Move sleep code out of here to pmac_pm, merge into new&n; *    common PM infrastructure&n; *  - Move backlight code out as well&n; *  - Save/Restore PCI space properly&n; *&n; */
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#include &lt;linux/cuda.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/suspend.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/sections.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &lt;asm/cputable.h&gt;
macro_line|#include &lt;asm/time.h&gt;
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
macro_line|#include &lt;asm/backlight.h&gt;
macro_line|#endif
multiline_comment|/* Some compile options */
DECL|macro|SUSPEND_USES_PMU
macro_line|#undef SUSPEND_USES_PMU
DECL|macro|DEBUG_SLEEP
mdefine_line|#define DEBUG_SLEEP
DECL|macro|HACKED_PCI_SAVE
macro_line|#undef HACKED_PCI_SAVE
multiline_comment|/* Misc minor number allocated for /dev/pmu */
DECL|macro|PMU_MINOR
mdefine_line|#define PMU_MINOR&t;&t;154
multiline_comment|/* How many iterations between battery polls */
DECL|macro|BATTERY_POLLING_COUNT
mdefine_line|#define BATTERY_POLLING_COUNT&t;2
multiline_comment|/* Some debugging tools */
macro_line|#ifdef CONFIG_XMON
singleline_comment|//#define LIVE_DEBUG(req) ((req) &amp;&amp; (req)-&gt;data[0] == 0x7d)
DECL|macro|LIVE_DEBUG
mdefine_line|#define LIVE_DEBUG(req) (0)
DECL|variable|whacky_debug
r_static
r_int
id|whacky_debug
suffix:semicolon
macro_line|#endif /* CONFIG_XMON */
DECL|variable|via
r_static
r_volatile
r_int
r_char
op_star
id|via
suffix:semicolon
multiline_comment|/* VIA registers - spaced 0x200 bytes apart */
DECL|macro|RS
mdefine_line|#define RS&t;&t;0x200&t;&t;/* skip between registers */
DECL|macro|B
mdefine_line|#define B&t;&t;0&t;&t;/* B-side data */
DECL|macro|A
mdefine_line|#define A&t;&t;RS&t;&t;/* A-side data */
DECL|macro|DIRB
mdefine_line|#define DIRB&t;&t;(2*RS)&t;&t;/* B-side direction (1=output) */
DECL|macro|DIRA
mdefine_line|#define DIRA&t;&t;(3*RS)&t;&t;/* A-side direction (1=output) */
DECL|macro|T1CL
mdefine_line|#define T1CL&t;&t;(4*RS)&t;&t;/* Timer 1 ctr/latch (low 8 bits) */
DECL|macro|T1CH
mdefine_line|#define T1CH&t;&t;(5*RS)&t;&t;/* Timer 1 counter (high 8 bits) */
DECL|macro|T1LL
mdefine_line|#define T1LL&t;&t;(6*RS)&t;&t;/* Timer 1 latch (low 8 bits) */
DECL|macro|T1LH
mdefine_line|#define T1LH&t;&t;(7*RS)&t;&t;/* Timer 1 latch (high 8 bits) */
DECL|macro|T2CL
mdefine_line|#define T2CL&t;&t;(8*RS)&t;&t;/* Timer 2 ctr/latch (low 8 bits) */
DECL|macro|T2CH
mdefine_line|#define T2CH&t;&t;(9*RS)&t;&t;/* Timer 2 counter (high 8 bits) */
DECL|macro|SR
mdefine_line|#define SR&t;&t;(10*RS)&t;&t;/* Shift register */
DECL|macro|ACR
mdefine_line|#define ACR&t;&t;(11*RS)&t;&t;/* Auxiliary control register */
DECL|macro|PCR
mdefine_line|#define PCR&t;&t;(12*RS)&t;&t;/* Peripheral control register */
DECL|macro|IFR
mdefine_line|#define IFR&t;&t;(13*RS)&t;&t;/* Interrupt flag register */
DECL|macro|IER
mdefine_line|#define IER&t;&t;(14*RS)&t;&t;/* Interrupt enable register */
DECL|macro|ANH
mdefine_line|#define ANH&t;&t;(15*RS)&t;&t;/* A-side data, no handshake */
multiline_comment|/* Bits in B data register: both active low */
DECL|macro|TACK
mdefine_line|#define TACK&t;&t;0x08&t;&t;/* Transfer acknowledge (input) */
DECL|macro|TREQ
mdefine_line|#define TREQ&t;&t;0x10&t;&t;/* Transfer request (output) */
multiline_comment|/* Bits in ACR */
DECL|macro|SR_CTRL
mdefine_line|#define SR_CTRL&t;&t;0x1c&t;&t;/* Shift register control bits */
DECL|macro|SR_EXT
mdefine_line|#define SR_EXT&t;&t;0x0c&t;&t;/* Shift on external clock */
DECL|macro|SR_OUT
mdefine_line|#define SR_OUT&t;&t;0x10&t;&t;/* Shift out if 1 */
multiline_comment|/* Bits in IFR and IER */
DECL|macro|IER_SET
mdefine_line|#define IER_SET&t;&t;0x80&t;&t;/* set bits in IER */
DECL|macro|IER_CLR
mdefine_line|#define IER_CLR&t;&t;0&t;&t;/* clear bits in IER */
DECL|macro|SR_INT
mdefine_line|#define SR_INT&t;&t;0x04&t;&t;/* Shift register full/empty */
DECL|macro|CB2_INT
mdefine_line|#define CB2_INT&t;&t;0x08
DECL|macro|CB1_INT
mdefine_line|#define CB1_INT&t;&t;0x10&t;&t;/* transition on CB1 input */
DECL|enum|pmu_state
r_static
r_volatile
r_enum
id|pmu_state
(brace
DECL|enumerator|idle
id|idle
comma
DECL|enumerator|sending
id|sending
comma
DECL|enumerator|intack
id|intack
comma
DECL|enumerator|reading
id|reading
comma
DECL|enumerator|reading_intr
id|reading_intr
comma
DECL|enumerator|locked
id|locked
comma
DECL|variable|pmu_state
)brace
id|pmu_state
suffix:semicolon
DECL|enum|int_data_state
r_static
r_volatile
r_enum
id|int_data_state
(brace
DECL|enumerator|int_data_empty
id|int_data_empty
comma
DECL|enumerator|int_data_fill
id|int_data_fill
comma
DECL|enumerator|int_data_ready
id|int_data_ready
comma
DECL|enumerator|int_data_flush
id|int_data_flush
DECL|variable|int_data_state
)brace
id|int_data_state
(braket
l_int|2
)braket
op_assign
(brace
id|int_data_empty
comma
id|int_data_empty
)brace
suffix:semicolon
DECL|variable|current_req
r_static
r_struct
id|adb_request
op_star
id|current_req
suffix:semicolon
DECL|variable|last_req
r_static
r_struct
id|adb_request
op_star
id|last_req
suffix:semicolon
DECL|variable|req_awaiting_reply
r_static
r_struct
id|adb_request
op_star
id|req_awaiting_reply
suffix:semicolon
DECL|variable|interrupt_data
r_static
r_int
r_char
id|interrupt_data
(braket
l_int|2
)braket
(braket
l_int|32
)braket
suffix:semicolon
DECL|variable|interrupt_data_len
r_static
r_int
id|interrupt_data_len
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|int_data_last
r_static
r_int
id|int_data_last
suffix:semicolon
DECL|variable|reply_ptr
r_static
r_int
r_char
op_star
id|reply_ptr
suffix:semicolon
DECL|variable|data_index
r_static
r_int
id|data_index
suffix:semicolon
DECL|variable|data_len
r_static
r_int
id|data_len
suffix:semicolon
DECL|variable|adb_int_pending
r_static
r_volatile
r_int
id|adb_int_pending
suffix:semicolon
DECL|variable|disable_poll
r_static
r_volatile
r_int
id|disable_poll
suffix:semicolon
DECL|variable|bright_req_1
DECL|variable|bright_req_2
DECL|variable|bright_req_3
r_static
r_struct
id|adb_request
id|bright_req_1
comma
id|bright_req_2
comma
id|bright_req_3
suffix:semicolon
DECL|variable|vias
r_static
r_struct
id|device_node
op_star
id|vias
suffix:semicolon
DECL|variable|pmu_kind
r_static
r_int
id|pmu_kind
op_assign
id|PMU_UNKNOWN
suffix:semicolon
DECL|variable|pmu_fully_inited
r_static
r_int
id|pmu_fully_inited
op_assign
l_int|0
suffix:semicolon
DECL|variable|pmu_has_adb
r_static
r_int
id|pmu_has_adb
suffix:semicolon
DECL|variable|gpio_reg
r_static
r_int
r_char
op_star
id|gpio_reg
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|gpio_irq
r_static
r_int
id|gpio_irq
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|gpio_irq_enabled
r_static
r_int
id|gpio_irq_enabled
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|pmu_suspended
r_static
r_volatile
r_int
id|pmu_suspended
op_assign
l_int|0
suffix:semicolon
DECL|variable|pmu_lock
r_static
id|spinlock_t
id|pmu_lock
suffix:semicolon
DECL|variable|pmu_intr_mask
r_static
id|u8
id|pmu_intr_mask
suffix:semicolon
DECL|variable|pmu_version
r_static
r_int
id|pmu_version
suffix:semicolon
DECL|variable|drop_interrupts
r_static
r_int
id|drop_interrupts
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
DECL|variable|option_lid_wakeup
r_static
r_int
id|option_lid_wakeup
op_assign
l_int|1
suffix:semicolon
DECL|variable|sleep_in_progress
r_static
r_int
id|sleep_in_progress
suffix:semicolon
DECL|variable|can_sleep
r_static
r_int
id|can_sleep
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
DECL|variable|pmu_irq_stats
r_static
r_int
r_int
id|pmu_irq_stats
(braket
l_int|11
)braket
suffix:semicolon
DECL|variable|proc_pmu_root
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_pmu_root
suffix:semicolon
DECL|variable|proc_pmu_info
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_pmu_info
suffix:semicolon
DECL|variable|proc_pmu_irqstats
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_pmu_irqstats
suffix:semicolon
DECL|variable|proc_pmu_options
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_pmu_options
suffix:semicolon
DECL|variable|option_server_mode
r_static
r_int
id|option_server_mode
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
DECL|variable|pmu_battery_count
r_int
id|pmu_battery_count
suffix:semicolon
DECL|variable|pmu_cur_battery
r_int
id|pmu_cur_battery
suffix:semicolon
DECL|variable|pmu_power_flags
r_int
r_int
id|pmu_power_flags
suffix:semicolon
DECL|variable|pmu_batteries
r_struct
id|pmu_battery_info
id|pmu_batteries
(braket
id|PMU_MAX_BATTERIES
)braket
suffix:semicolon
DECL|variable|query_batt_timer
r_static
r_int
id|query_batt_timer
op_assign
id|BATTERY_POLLING_COUNT
suffix:semicolon
DECL|variable|batt_req
r_static
r_struct
id|adb_request
id|batt_req
suffix:semicolon
DECL|variable|proc_pmu_batt
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_pmu_batt
(braket
id|PMU_MAX_BATTERIES
)braket
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
macro_line|#if defined(CONFIG_INPUT_ADBHID) &amp;&amp; defined(CONFIG_PMAC_BACKLIGHT)
r_extern
r_int
id|disable_kernel_backlight
suffix:semicolon
macro_line|#endif /* defined(CONFIG_INPUT_ADBHID) &amp;&amp; defined(CONFIG_PMAC_BACKLIGHT) */
DECL|variable|__fake_sleep
r_int
id|__fake_sleep
suffix:semicolon
DECL|variable|asleep
r_int
id|asleep
suffix:semicolon
DECL|variable|sleep_notifier_list
r_struct
id|notifier_block
op_star
id|sleep_notifier_list
suffix:semicolon
macro_line|#ifdef CONFIG_ADB
DECL|variable|adb_dev_map
r_static
r_int
id|adb_dev_map
op_assign
l_int|0
suffix:semicolon
DECL|variable|pmu_adb_flags
r_static
r_int
id|pmu_adb_flags
suffix:semicolon
r_static
r_int
id|pmu_probe
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|pmu_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|pmu_send_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_int
id|sync
)paren
suffix:semicolon
r_static
r_int
id|pmu_adb_autopoll
c_func
(paren
r_int
id|devs
)paren
suffix:semicolon
r_static
r_int
id|pmu_adb_reset_bus
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ADB */
r_static
r_int
id|init_pmu
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|pmu_queue_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
suffix:semicolon
r_static
r_void
id|pmu_start
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|via_pmu_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|gpio1_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|proc_get_info
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|proc_get_irqstats
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
r_static
r_int
id|pmu_set_backlight_level
c_func
(paren
r_int
id|level
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|pmu_set_backlight_enable
c_func
(paren
r_int
id|on
comma
r_int
id|level
comma
r_void
op_star
id|data
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_BACKLIGHT */
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_static
r_void
id|pmu_pass_intr
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|proc_get_batt
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
r_static
r_int
id|proc_read_options
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|proc_write_options
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ADB
DECL|variable|via_pmu_driver
r_struct
id|adb_driver
id|via_pmu_driver
op_assign
(brace
l_string|&quot;PMU&quot;
comma
id|pmu_probe
comma
id|pmu_init
comma
id|pmu_send_request
comma
id|pmu_adb_autopoll
comma
id|pmu_poll_adb
comma
id|pmu_adb_reset_bus
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_ADB */
r_extern
r_void
id|low_sleep_handler
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|enable_kernel_altivec
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|enable_kernel_fp
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_SLEEP
r_int
id|pmu_polled_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
suffix:semicolon
r_int
id|pmu_wink
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * This table indicates for each PMU opcode:&n; * - the number of data bytes to be sent with the command, or -1&n; *   if a length byte should be sent,&n; * - the number of response bytes which the PMU will return, or&n; *   -1 if it will send a length byte.&n; */
DECL|variable|__openfirmwaredata
r_static
r_const
id|s8
id|pmu_data_len
(braket
l_int|256
)braket
(braket
l_int|2
)braket
id|__openfirmwaredata
op_assign
(brace
multiline_comment|/*&t;   0&t;   1&t;   2&t;   3&t;   4&t;   5&t;   6&t;   7  */
multiline_comment|/*00*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*08*/
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*10*/
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*18*/
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*20*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*28*/
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*30*/
(brace
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|20
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|3
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*38*/
(brace
l_int|0
comma
l_int|4
)brace
comma
(brace
l_int|0
comma
l_int|20
)brace
comma
(brace
l_int|2
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|2
comma
l_int|1
)brace
comma
(brace
l_int|3
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|4
comma
l_int|0
)brace
comma
multiline_comment|/*40*/
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*48*/
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*50*/
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|3
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*58*/
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|2
)brace
comma
(brace
l_int|0
comma
l_int|2
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*60*/
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*68*/
(brace
l_int|0
comma
l_int|3
)brace
comma
(brace
l_int|0
comma
l_int|3
)brace
comma
(brace
l_int|0
comma
l_int|2
)brace
comma
(brace
l_int|0
comma
l_int|8
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*70*/
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*78*/
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|5
comma
l_int|1
)brace
comma
(brace
l_int|4
comma
l_int|1
)brace
comma
(brace
l_int|4
comma
l_int|1
)brace
comma
multiline_comment|/*80*/
(brace
l_int|4
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*88*/
(brace
l_int|0
comma
l_int|5
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*90*/
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*98*/
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*a0*/
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
l_int|4
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*a8*/
(brace
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|3
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*b0*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*b8*/
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*c0*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*c8*/
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*d0*/
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*d8*/
(brace
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|1
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
multiline_comment|/*e0*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|4
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*e8*/
(brace
l_int|3
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/*f0*/
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/*f8*/
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
comma
)brace
suffix:semicolon
DECL|variable|pbook_type
r_static
r_char
op_star
id|pbook_type
(braket
)braket
op_assign
(brace
l_string|&quot;Unknown PowerBook&quot;
comma
l_string|&quot;PowerBook 2400/3400/3500(G3)&quot;
comma
l_string|&quot;PowerBook G3 Series&quot;
comma
l_string|&quot;1999 PowerBook G3&quot;
comma
l_string|&quot;Core99&quot;
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
DECL|variable|pmu_backlight_controller
r_static
r_struct
id|backlight_controller
id|pmu_backlight_controller
op_assign
(brace
id|pmu_set_backlight_enable
comma
id|pmu_set_backlight_level
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_BACKLIGHT */
r_int
id|__openfirmware
DECL|function|find_via_pmu
id|find_via_pmu
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|via
op_ne
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|vias
op_assign
id|find_devices
c_func
(paren
l_string|&quot;via-pmu&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vias
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vias-&gt;next
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Warning: only using 1st via-pmu&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vias-&gt;n_addrs
OL
l_int|1
op_logical_or
id|vias-&gt;n_intrs
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;via-pmu: %d addresses, %d interrupts!&bslash;n&quot;
comma
id|vias-&gt;n_addrs
comma
id|vias-&gt;n_intrs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vias-&gt;n_addrs
OL
l_int|1
op_logical_or
id|vias-&gt;n_intrs
OL
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|pmu_lock
)paren
suffix:semicolon
id|pmu_has_adb
op_assign
l_int|1
suffix:semicolon
id|pmu_intr_mask
op_assign
id|PMU_INT_PCEJECT
op_or
id|PMU_INT_SNDBRT
op_or
id|PMU_INT_ADB
op_or
id|PMU_INT_TICK
suffix:semicolon
r_if
c_cond
(paren
id|vias-&gt;parent-&gt;name
op_logical_and
(paren
(paren
id|strcmp
c_func
(paren
id|vias-&gt;parent-&gt;name
comma
l_string|&quot;ohare&quot;
)paren
op_eq
l_int|0
)paren
op_logical_or
id|device_is_compatible
c_func
(paren
id|vias-&gt;parent
comma
l_string|&quot;ohare&quot;
)paren
)paren
)paren
id|pmu_kind
op_assign
id|PMU_OHARE_BASED
suffix:semicolon
r_else
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|vias-&gt;parent
comma
l_string|&quot;paddington&quot;
)paren
)paren
id|pmu_kind
op_assign
id|PMU_PADDINGTON_BASED
suffix:semicolon
r_else
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|vias-&gt;parent
comma
l_string|&quot;heathrow&quot;
)paren
)paren
id|pmu_kind
op_assign
id|PMU_HEATHROW_BASED
suffix:semicolon
r_else
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|vias-&gt;parent
comma
l_string|&quot;Keylargo&quot;
)paren
op_logical_or
id|device_is_compatible
c_func
(paren
id|vias-&gt;parent
comma
l_string|&quot;K2-Keylargo&quot;
)paren
)paren
(brace
r_struct
id|device_node
op_star
id|gpio
comma
op_star
id|gpiop
suffix:semicolon
id|pmu_kind
op_assign
id|PMU_KEYLARGO_BASED
suffix:semicolon
id|pmu_has_adb
op_assign
(paren
id|find_type_devices
c_func
(paren
l_string|&quot;adb&quot;
)paren
op_ne
l_int|NULL
)paren
suffix:semicolon
id|pmu_intr_mask
op_assign
id|PMU_INT_PCEJECT
op_or
id|PMU_INT_SNDBRT
op_or
id|PMU_INT_ADB
op_or
id|PMU_INT_TICK
op_or
id|PMU_INT_ENVIRONMENT
suffix:semicolon
id|gpiop
op_assign
id|find_devices
c_func
(paren
l_string|&quot;gpio&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gpiop
op_logical_and
id|gpiop-&gt;n_addrs
)paren
(brace
id|gpio_reg
op_assign
id|ioremap
c_func
(paren
id|gpiop-&gt;addrs-&gt;address
comma
l_int|0x10
)paren
suffix:semicolon
id|gpio
op_assign
id|find_devices
c_func
(paren
l_string|&quot;extint-gpio1&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gpio
op_eq
l_int|NULL
)paren
id|gpio
op_assign
id|find_devices
c_func
(paren
l_string|&quot;pmu-interrupt&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gpio
op_logical_and
id|gpio-&gt;parent
op_eq
id|gpiop
op_logical_and
id|gpio-&gt;n_intrs
)paren
id|gpio_irq
op_assign
id|gpio-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
)brace
)brace
r_else
id|pmu_kind
op_assign
id|PMU_UNKNOWN
suffix:semicolon
id|via
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|ioremap
c_func
(paren
id|vias-&gt;addrs-&gt;address
comma
l_int|0x2000
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IER
)braket
comma
id|IER_CLR
op_or
l_int|0x7f
)paren
suffix:semicolon
multiline_comment|/* disable all intrs */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IFR
)braket
comma
l_int|0x7f
)paren
suffix:semicolon
multiline_comment|/* clear IFR */
id|pmu_state
op_assign
id|idle
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|init_pmu
c_func
(paren
)paren
)paren
(brace
id|via
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PMU driver %d initialized for %s, firmware: %02x&bslash;n&quot;
comma
id|PMU_DRIVER_VERSION
comma
id|pbook_type
(braket
id|pmu_kind
)braket
comma
id|pmu_version
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_PPC64
id|sys_ctrler
op_assign
id|SYS_CTRLER_PMU
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ADB
r_static
r_int
id|__openfirmware
DECL|function|pmu_probe
id|pmu_probe
c_func
(paren
r_void
)paren
(brace
r_return
id|vias
op_eq
l_int|NULL
ques
c_cond
op_minus
id|ENODEV
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|pmu_init
id|pmu_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|vias
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ADB */
multiline_comment|/*&n; * We can&squot;t wait until pmu_init gets called, that happens too late.&n; * It happens after IDE and SCSI initialization, which can take a few&n; * seconds, and by that time the PMU could have given up on us and&n; * turned us off.&n; * Thus this is called with arch_initcall rather than device_initcall.&n; */
DECL|function|via_pmu_start
r_static
r_int
id|__init
id|via_pmu_start
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|vias
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|bright_req_1.complete
op_assign
l_int|1
suffix:semicolon
id|bright_req_2.complete
op_assign
l_int|1
suffix:semicolon
id|bright_req_3.complete
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|batt_req.complete
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_SLEEP_STATE
comma
l_int|NULL
comma
l_int|0
comma
op_minus
l_int|1
)paren
op_ge
l_int|0
)paren
id|can_sleep
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|vias-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
comma
id|via_pmu_interrupt
comma
l_int|0
comma
l_string|&quot;VIA-PMU&quot;
comma
(paren
r_void
op_star
)paren
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VIA-PMU: can&squot;t get irq %d&bslash;n&quot;
comma
id|vias-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pmu_kind
op_eq
id|PMU_KEYLARGO_BASED
op_logical_and
id|gpio_irq
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|gpio_irq
comma
id|gpio1_interrupt
comma
l_int|0
comma
l_string|&quot;GPIO1/ADB&quot;
comma
(paren
r_void
op_star
)paren
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmu: can&squot;t get irq %d (GPIO1)&bslash;n&quot;
comma
id|gpio_irq
)paren
suffix:semicolon
id|gpio_irq_enabled
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Enable interrupts */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IER
)braket
comma
id|IER_SET
op_or
id|SR_INT
op_or
id|CB1_INT
)paren
suffix:semicolon
id|pmu_fully_inited
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Make sure PMU settle down before continuing. This is _very_ important&n;&t; * since the IDE probe may shut interrupts down for quite a bit of time. If&n;&t; * a PMU communication is pending while this happens, the PMU may timeout&n;&t; * Not that on Core99 machines, the PMU keeps sending us environement&n;&t; * messages, we should find a way to either fix IDE or make it call&n;&t; * pmu_suspend() before masking interrupts. This can also happens while&n;&t; * scolling with some fbdevs.&n;&t; */
r_do
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pmu_state
op_ne
id|idle
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|via_pmu_start
id|arch_initcall
c_func
(paren
id|via_pmu_start
)paren
suffix:semicolon
multiline_comment|/*&n; * This has to be done after pci_init, which is a subsys_initcall.&n; */
DECL|function|via_pmu_dev_init
r_static
r_int
id|__init
id|via_pmu_dev_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|vias
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#ifndef CONFIG_PPC64
id|request_OF_resource
c_func
(paren
id|vias
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
multiline_comment|/* Enable backlight */
id|register_backlight_controller
c_func
(paren
op_amp
id|pmu_backlight_controller
comma
l_int|NULL
comma
l_string|&quot;pmu&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_BACKLIGHT */
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
l_string|&quot;AAPL,3400/2400&quot;
)paren
op_logical_or
id|machine_is_compatible
c_func
(paren
l_string|&quot;AAPL,3500&quot;
)paren
)paren
(brace
r_int
id|mb
op_assign
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_GET_MB_INFO
comma
l_int|NULL
comma
id|PMAC_MB_INFO_MODEL
comma
l_int|0
)paren
suffix:semicolon
id|pmu_battery_count
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mb
op_eq
id|PMAC_TYPE_COMET
)paren
id|pmu_batteries
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|PMU_BATT_TYPE_COMET
suffix:semicolon
r_else
id|pmu_batteries
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|PMU_BATT_TYPE_HOOPER
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
l_string|&quot;AAPL,PowerBook1998&quot;
)paren
op_logical_or
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerBook1,1&quot;
)paren
)paren
(brace
id|pmu_battery_count
op_assign
l_int|2
suffix:semicolon
id|pmu_batteries
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|PMU_BATT_TYPE_SMART
suffix:semicolon
id|pmu_batteries
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|PMU_BATT_TYPE_SMART
suffix:semicolon
)brace
r_else
(brace
r_struct
id|device_node
op_star
id|prim
op_assign
id|find_devices
c_func
(paren
l_string|&quot;power-mgt&quot;
)paren
suffix:semicolon
id|u32
op_star
id|prim_info
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|prim
)paren
id|prim_info
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|prim
comma
l_string|&quot;prim-info&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prim_info
)paren
(brace
multiline_comment|/* Other stuffs here yet unknown */
id|pmu_battery_count
op_assign
(paren
id|prim_info
(braket
l_int|6
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|pmu_batteries
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|PMU_BATT_TYPE_SMART
suffix:semicolon
r_if
c_cond
(paren
id|pmu_battery_count
OG
l_int|1
)paren
id|pmu_batteries
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|PMU_BATT_TYPE_SMART
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_PMAC_PBOOK */
multiline_comment|/* Create /proc/pmu */
id|proc_pmu_root
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;pmu&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proc_pmu_root
)paren
(brace
r_int
id|i
suffix:semicolon
id|proc_pmu_info
op_assign
id|create_proc_read_entry
c_func
(paren
l_string|&quot;info&quot;
comma
l_int|0
comma
id|proc_pmu_root
comma
id|proc_get_info
comma
l_int|NULL
)paren
suffix:semicolon
id|proc_pmu_irqstats
op_assign
id|create_proc_read_entry
c_func
(paren
l_string|&quot;interrupts&quot;
comma
l_int|0
comma
id|proc_pmu_root
comma
id|proc_get_irqstats
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pmu_battery_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|title
(braket
l_int|16
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|title
comma
l_string|&quot;battery_%d&quot;
comma
id|i
)paren
suffix:semicolon
id|proc_pmu_batt
(braket
id|i
)braket
op_assign
id|create_proc_read_entry
c_func
(paren
id|title
comma
l_int|0
comma
id|proc_pmu_root
comma
id|proc_get_batt
comma
(paren
r_void
op_star
)paren
id|i
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PMAC_PBOOK */
id|proc_pmu_options
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;options&quot;
comma
l_int|0600
comma
id|proc_pmu_root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proc_pmu_options
)paren
(brace
id|proc_pmu_options-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|proc_pmu_options-&gt;read_proc
op_assign
id|proc_read_options
suffix:semicolon
id|proc_pmu_options-&gt;write_proc
op_assign
id|proc_write_options
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|via_pmu_dev_init
id|device_initcall
c_func
(paren
id|via_pmu_dev_init
)paren
suffix:semicolon
r_static
r_int
id|__openfirmware
DECL|function|init_pmu
id|init_pmu
c_func
(paren
r_void
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_struct
id|adb_request
id|req
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
comma
id|via
(braket
id|B
)braket
op_or
id|TREQ
)paren
suffix:semicolon
multiline_comment|/* negate TREQ */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|DIRB
)braket
comma
(paren
id|via
(braket
id|DIRB
)braket
op_or
id|TREQ
)paren
op_amp
op_complement
id|TACK
)paren
suffix:semicolon
multiline_comment|/* TACK in, TREQ out */
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_SET_INTR_MASK
comma
id|pmu_intr_mask
)paren
suffix:semicolon
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|timeout
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;init_pmu: no response from PMU&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* ack all pending interrupts */
id|timeout
op_assign
l_int|100000
suffix:semicolon
id|interrupt_data
(braket
l_int|0
)braket
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|interrupt_data
(braket
l_int|0
)braket
(braket
l_int|0
)braket
op_logical_or
id|pmu_state
op_ne
id|idle
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|timeout
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;init_pmu: timed out acking intrs&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pmu_state
op_eq
id|idle
)paren
id|adb_int_pending
op_assign
l_int|1
suffix:semicolon
id|via_pmu_interrupt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* Tell PMU we are ready.  */
r_if
c_cond
(paren
id|pmu_kind
op_eq
id|PMU_KEYLARGO_BASED
)paren
(brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_SYSTEM_READY
comma
l_int|2
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Read PMU version */
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|1
comma
id|PMU_GET_VERSION
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.reply_len
OG
l_int|0
)paren
id|pmu_version
op_assign
id|req.reply
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Read server mode setting */
r_if
c_cond
(paren
id|pmu_kind
op_eq
id|PMU_KEYLARGO_BASED
)paren
(brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_POWER_EVENTS
comma
id|PMU_PWR_GET_POWERUP_EVENTS
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.reply_len
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|1
)braket
op_amp
id|PMU_PWR_WAKEUP_AC_INSERT
)paren
id|option_server_mode
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;via-pmu: Server Mode is %s&bslash;n&quot;
comma
id|option_server_mode
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|pmu_get_model
id|pmu_get_model
c_func
(paren
r_void
)paren
(brace
r_return
id|pmu_kind
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_PPC64
DECL|function|wakeup_decrementer
r_static
r_inline
r_void
id|wakeup_decrementer
c_func
(paren
r_void
)paren
(brace
id|set_dec
c_func
(paren
id|tb_ticks_per_jiffy
)paren
suffix:semicolon
multiline_comment|/* No currently-supported powerbook has a 601,&n;&t; * so use get_tbl, not native&n;&t; */
id|last_jiffy_stamp
c_func
(paren
l_int|0
)paren
op_assign
id|tb_last_stamp
op_assign
id|get_tbl
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|pmu_set_server_mode
r_static
r_void
id|pmu_set_server_mode
c_func
(paren
r_int
id|server_mode
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
r_if
c_cond
(paren
id|pmu_kind
op_ne
id|PMU_KEYLARGO_BASED
)paren
r_return
suffix:semicolon
id|option_server_mode
op_assign
id|server_mode
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_POWER_EVENTS
comma
id|PMU_PWR_GET_POWERUP_EVENTS
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.reply_len
OL
l_int|2
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|server_mode
)paren
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|4
comma
id|PMU_POWER_EVENTS
comma
id|PMU_PWR_SET_POWERUP_EVENTS
comma
id|req.reply
(braket
l_int|0
)braket
comma
id|PMU_PWR_WAKEUP_AC_INSERT
)paren
suffix:semicolon
r_else
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|4
comma
id|PMU_POWER_EVENTS
comma
id|PMU_PWR_CLR_POWERUP_EVENTS
comma
id|req.reply
(braket
l_int|0
)braket
comma
id|PMU_PWR_WAKEUP_AC_INSERT
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
multiline_comment|/* This new version of the code for 2400/3400/3500 powerbooks&n; * is inspired from the implementation in gkrellm-pmu&n; */
r_static
r_void
id|__pmac
DECL|function|done_battery_state_ohare
id|done_battery_state_ohare
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
multiline_comment|/* format:&n;&t; *  [0]    :  flags&n;&t; *    0x01 :  AC indicator&n;&t; *    0x02 :  charging&n;&t; *    0x04 :  battery exist&n;&t; *    0x08 :  &n;&t; *    0x10 :  &n;&t; *    0x20 :  full charged&n;&t; *    0x40 :  pcharge reset&n;&t; *    0x80 :  battery exist&n;&t; *&n;&t; *  [1][2] :  battery voltage&n;&t; *  [3]    :  CPU temperature&n;&t; *  [4]    :  battery temperature&n;&t; *  [5]    :  current&n;&t; *  [6][7] :  pcharge&n;&t; *              --tkoba&n;&t; */
r_int
r_int
id|bat_flags
op_assign
id|PMU_BATT_TYPE_HOOPER
suffix:semicolon
r_int
id|pcharge
comma
id|charge
comma
id|vb
comma
id|vmax
comma
id|lmax
suffix:semicolon
r_int
id|vmax_charging
comma
id|vmax_charged
suffix:semicolon
r_int
id|current
comma
id|voltage
comma
id|time
comma
id|max
suffix:semicolon
r_int
id|mb
op_assign
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_GET_MB_INFO
comma
l_int|NULL
comma
id|PMAC_MB_INFO_MODEL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;reply
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
id|pmu_power_flags
op_or_assign
id|PMU_PWR_AC_PRESENT
suffix:semicolon
r_else
id|pmu_power_flags
op_and_assign
op_complement
id|PMU_PWR_AC_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|mb
op_eq
id|PMAC_TYPE_COMET
)paren
(brace
id|vmax_charged
op_assign
l_int|189
suffix:semicolon
id|vmax_charging
op_assign
l_int|213
suffix:semicolon
id|lmax
op_assign
l_int|6500
suffix:semicolon
)brace
r_else
(brace
id|vmax_charged
op_assign
l_int|330
suffix:semicolon
id|vmax_charging
op_assign
l_int|330
suffix:semicolon
id|lmax
op_assign
l_int|6500
suffix:semicolon
)brace
id|vmax
op_assign
id|vmax_charged
suffix:semicolon
multiline_comment|/* If battery installed */
r_if
c_cond
(paren
id|req-&gt;reply
(braket
l_int|0
)braket
op_amp
l_int|0x04
)paren
(brace
id|bat_flags
op_or_assign
id|PMU_BATT_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;reply
(braket
l_int|0
)braket
op_amp
l_int|0x02
)paren
id|bat_flags
op_or_assign
id|PMU_BATT_CHARGING
suffix:semicolon
id|vb
op_assign
(paren
id|req-&gt;reply
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|req-&gt;reply
(braket
l_int|2
)braket
suffix:semicolon
id|voltage
op_assign
(paren
id|vb
op_star
l_int|265
op_plus
l_int|72665
)paren
op_div
l_int|10
suffix:semicolon
id|current
op_assign
id|req-&gt;reply
(braket
l_int|5
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|req-&gt;reply
(braket
l_int|0
)braket
op_amp
l_int|0x01
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|current
OG
l_int|200
)paren
id|vb
op_add_assign
(paren
(paren
id|current
op_minus
l_int|200
)paren
op_star
l_int|15
)paren
op_div
l_int|100
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|req-&gt;reply
(braket
l_int|0
)braket
op_amp
l_int|0x02
)paren
(brace
id|vb
op_assign
(paren
id|vb
op_star
l_int|97
)paren
op_div
l_int|100
suffix:semicolon
id|vmax
op_assign
id|vmax_charging
suffix:semicolon
)brace
id|charge
op_assign
(paren
l_int|100
op_star
id|vb
)paren
op_div
id|vmax
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;reply
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
(brace
id|pcharge
op_assign
(paren
id|req-&gt;reply
(braket
l_int|6
)braket
op_lshift
l_int|8
)paren
op_plus
id|req-&gt;reply
(braket
l_int|7
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pcharge
OG
id|lmax
)paren
id|pcharge
op_assign
id|lmax
suffix:semicolon
id|pcharge
op_mul_assign
l_int|100
suffix:semicolon
id|pcharge
op_assign
l_int|100
op_minus
id|pcharge
op_div
id|lmax
suffix:semicolon
r_if
c_cond
(paren
id|pcharge
OL
id|charge
)paren
id|charge
op_assign
id|pcharge
suffix:semicolon
)brace
r_if
c_cond
(paren
id|current
OG
l_int|0
)paren
id|time
op_assign
(paren
id|charge
op_star
l_int|16440
)paren
op_div
id|current
suffix:semicolon
r_else
id|time
op_assign
l_int|0
suffix:semicolon
id|max
op_assign
l_int|100
suffix:semicolon
id|current
op_assign
op_minus
id|current
suffix:semicolon
)brace
r_else
id|charge
op_assign
id|max
op_assign
id|current
op_assign
id|voltage
op_assign
id|time
op_assign
l_int|0
suffix:semicolon
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|flags
op_assign
id|bat_flags
suffix:semicolon
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|charge
op_assign
id|charge
suffix:semicolon
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|max_charge
op_assign
id|max
suffix:semicolon
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|current
op_assign
id|current
suffix:semicolon
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|voltage
op_assign
id|voltage
suffix:semicolon
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|time_remaining
op_assign
id|time
suffix:semicolon
)brace
r_static
r_void
id|__pmac
DECL|function|done_battery_state_smart
id|done_battery_state_smart
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
multiline_comment|/* format:&n;&t; *  [0] : format of this structure (known: 3,4,5)&n;&t; *  [1] : flags&n;&t; *  &n;&t; *  format 3 &amp; 4:&n;&t; *  &n;&t; *  [2] : charge&n;&t; *  [3] : max charge&n;&t; *  [4] : current&n;&t; *  [5] : voltage&n;&t; *  &n;&t; *  format 5:&n;&t; *  &n;&t; *  [2][3] : charge&n;&t; *  [4][5] : max charge&n;&t; *  [6][7] : current&n;&t; *  [8][9] : voltage&n;&t; */
r_int
r_int
id|bat_flags
op_assign
id|PMU_BATT_TYPE_SMART
suffix:semicolon
r_int
id|current
suffix:semicolon
r_int
r_int
id|capa
comma
id|max
comma
id|voltage
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;reply
(braket
l_int|1
)braket
op_amp
l_int|0x01
)paren
id|pmu_power_flags
op_or_assign
id|PMU_PWR_AC_PRESENT
suffix:semicolon
r_else
id|pmu_power_flags
op_and_assign
op_complement
id|PMU_PWR_AC_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;reply
(braket
l_int|1
)braket
op_amp
l_int|0x04
)paren
(brace
id|bat_flags
op_or_assign
id|PMU_BATT_PRESENT
suffix:semicolon
r_switch
c_cond
(paren
id|req-&gt;reply
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|3
suffix:colon
r_case
l_int|4
suffix:colon
id|capa
op_assign
id|req-&gt;reply
(braket
l_int|2
)braket
suffix:semicolon
id|max
op_assign
id|req-&gt;reply
(braket
l_int|3
)braket
suffix:semicolon
id|current
op_assign
op_star
(paren
(paren
r_int
r_char
op_star
)paren
op_amp
id|req-&gt;reply
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|voltage
op_assign
id|req-&gt;reply
(braket
l_int|5
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|capa
op_assign
(paren
id|req-&gt;reply
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|req-&gt;reply
(braket
l_int|3
)braket
suffix:semicolon
id|max
op_assign
(paren
id|req-&gt;reply
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
id|req-&gt;reply
(braket
l_int|5
)braket
suffix:semicolon
id|current
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
op_amp
id|req-&gt;reply
(braket
l_int|6
)braket
)paren
suffix:semicolon
id|voltage
op_assign
(paren
id|req-&gt;reply
(braket
l_int|8
)braket
op_lshift
l_int|8
)paren
op_or
id|req-&gt;reply
(braket
l_int|9
)braket
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;pmu.c : unrecognized battery info, len: %d, %02x %02x %02x %02x&bslash;n&quot;
comma
id|req-&gt;reply_len
comma
id|req-&gt;reply
(braket
l_int|0
)braket
comma
id|req-&gt;reply
(braket
l_int|1
)braket
comma
id|req-&gt;reply
(braket
l_int|2
)braket
comma
id|req-&gt;reply
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
id|capa
op_assign
id|max
op_assign
id|current
op_assign
id|voltage
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|req-&gt;reply
(braket
l_int|1
)braket
op_amp
l_int|0x01
)paren
op_logical_and
(paren
id|current
OG
l_int|0
)paren
)paren
id|bat_flags
op_or_assign
id|PMU_BATT_CHARGING
suffix:semicolon
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|flags
op_assign
id|bat_flags
suffix:semicolon
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|charge
op_assign
id|capa
suffix:semicolon
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|max_charge
op_assign
id|max
suffix:semicolon
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|current
op_assign
id|current
suffix:semicolon
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|voltage
op_assign
id|voltage
suffix:semicolon
r_if
c_cond
(paren
id|current
)paren
(brace
r_if
c_cond
(paren
(paren
id|req-&gt;reply
(braket
l_int|1
)braket
op_amp
l_int|0x01
)paren
op_logical_and
(paren
id|current
OG
l_int|0
)paren
)paren
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|time_remaining
op_assign
(paren
(paren
id|max
op_minus
id|capa
)paren
op_star
l_int|3600
)paren
op_div
id|current
suffix:semicolon
r_else
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|time_remaining
op_assign
(paren
id|capa
op_star
l_int|3600
)paren
op_div
(paren
op_minus
id|current
)paren
suffix:semicolon
)brace
r_else
id|pmu_batteries
(braket
id|pmu_cur_battery
)braket
dot
id|time_remaining
op_assign
l_int|0
suffix:semicolon
id|pmu_cur_battery
op_assign
(paren
id|pmu_cur_battery
op_plus
l_int|1
)paren
op_mod
id|pmu_battery_count
suffix:semicolon
)brace
r_static
r_void
id|__pmac
DECL|function|query_battery_state
id|query_battery_state
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|batt_req.complete
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pmu_kind
op_eq
id|PMU_OHARE_BASED
)paren
id|pmu_request
c_func
(paren
op_amp
id|batt_req
comma
id|done_battery_state_ohare
comma
l_int|1
comma
id|PMU_BATTERY_STATE
)paren
suffix:semicolon
r_else
id|pmu_request
c_func
(paren
op_amp
id|batt_req
comma
id|done_battery_state_smart
comma
l_int|2
comma
id|PMU_SMART_BATTERY_STATE
comma
id|pmu_cur_battery
op_plus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PMAC_PBOOK */
r_static
r_int
id|__pmac
DECL|function|proc_get_info
id|proc_get_info
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_char
op_star
id|p
op_assign
id|page
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;PMU driver version     : %d&bslash;n&quot;
comma
id|PMU_DRIVER_VERSION
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;PMU firmware version   : %02x&bslash;n&quot;
comma
id|pmu_version
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AC Power               : %d&bslash;n&quot;
comma
(paren
(paren
id|pmu_power_flags
op_amp
id|PMU_PWR_AC_PRESENT
)paren
op_ne
l_int|0
)paren
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Battery count          : %d&bslash;n&quot;
comma
id|pmu_battery_count
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
r_return
id|p
op_minus
id|page
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|proc_get_irqstats
id|proc_get_irqstats
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|p
op_assign
id|page
suffix:semicolon
r_static
r_const
r_char
op_star
id|irq_names
(braket
)braket
op_assign
(brace
l_string|&quot;Total CB1 triggered events&quot;
comma
l_string|&quot;Total GPIO1 triggered events&quot;
comma
l_string|&quot;PC-Card eject button&quot;
comma
l_string|&quot;Sound/Brightness button&quot;
comma
l_string|&quot;ADB message&quot;
comma
l_string|&quot;Battery state change&quot;
comma
l_string|&quot;Environment interrupt&quot;
comma
l_string|&quot;Tick timer&quot;
comma
l_string|&quot;Ghost interrupt (zero len)&quot;
comma
l_string|&quot;Empty interrupt (empty mask)&quot;
comma
l_string|&quot;Max irqs in a row&quot;
)brace
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|11
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot; %2u: %10u (%s)&bslash;n&quot;
comma
id|i
comma
id|pmu_irq_stats
(braket
id|i
)braket
comma
id|irq_names
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
id|p
op_minus
id|page
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_static
r_int
id|__pmac
DECL|function|proc_get_batt
id|proc_get_batt
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|batnum
op_assign
(paren
r_int
)paren
id|data
suffix:semicolon
r_char
op_star
id|p
op_assign
id|page
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;flags      : %08x&bslash;n&quot;
comma
id|pmu_batteries
(braket
id|batnum
)braket
dot
id|flags
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;charge     : %d&bslash;n&quot;
comma
id|pmu_batteries
(braket
id|batnum
)braket
dot
id|charge
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;max_charge : %d&bslash;n&quot;
comma
id|pmu_batteries
(braket
id|batnum
)braket
dot
id|max_charge
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;current    : %d&bslash;n&quot;
comma
id|pmu_batteries
(braket
id|batnum
)braket
dot
id|current
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;voltage    : %d&bslash;n&quot;
comma
id|pmu_batteries
(braket
id|batnum
)braket
dot
id|voltage
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;time rem.  : %d&bslash;n&quot;
comma
id|pmu_batteries
(braket
id|batnum
)braket
dot
id|time_remaining
)paren
suffix:semicolon
r_return
id|p
op_minus
id|page
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PMAC_PBOOK */
r_static
r_int
id|__pmac
DECL|function|proc_read_options
id|proc_read_options
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_char
op_star
id|p
op_assign
id|page
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_if
c_cond
(paren
id|pmu_kind
op_eq
id|PMU_KEYLARGO_BASED
op_logical_and
id|can_sleep
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;lid_wakeup=%d&bslash;n&quot;
comma
id|option_lid_wakeup
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
r_if
c_cond
(paren
id|pmu_kind
op_eq
id|PMU_KEYLARGO_BASED
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;server_mode=%d&bslash;n&quot;
comma
id|option_server_mode
)paren
suffix:semicolon
r_return
id|p
op_minus
id|page
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|proc_write_options
id|proc_write_options
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_char
id|tmp
(braket
l_int|33
)braket
suffix:semicolon
r_char
op_star
id|label
comma
op_star
id|val
suffix:semicolon
r_int
r_int
id|fcount
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|32
)paren
id|count
op_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|tmp
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|tmp
(braket
id|count
)braket
op_assign
l_int|0
suffix:semicolon
id|label
op_assign
id|tmp
suffix:semicolon
r_while
c_loop
(paren
op_star
id|label
op_eq
l_char|&squot; &squot;
)paren
(brace
id|label
op_increment
suffix:semicolon
)brace
id|val
op_assign
id|label
suffix:semicolon
r_while
c_loop
(paren
op_star
id|val
op_logical_and
(paren
op_star
id|val
op_ne
l_char|&squot;=&squot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_star
id|val
op_eq
l_char|&squot; &squot;
)paren
op_star
id|val
op_assign
l_int|0
suffix:semicolon
id|val
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|val
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
(paren
id|val
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_star
id|val
op_eq
l_char|&squot; &squot;
)paren
(brace
id|val
op_increment
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_if
c_cond
(paren
id|pmu_kind
op_eq
id|PMU_KEYLARGO_BASED
op_logical_and
id|can_sleep
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|label
comma
l_string|&quot;lid_wakeup&quot;
)paren
)paren
id|option_lid_wakeup
op_assign
(paren
(paren
op_star
id|val
)paren
op_eq
l_char|&squot;1&squot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
r_if
c_cond
(paren
id|pmu_kind
op_eq
id|PMU_KEYLARGO_BASED
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|label
comma
l_string|&quot;server_mode&quot;
)paren
)paren
(brace
r_int
id|new_value
suffix:semicolon
id|new_value
op_assign
(paren
(paren
op_star
id|val
)paren
op_eq
l_char|&squot;1&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_value
op_ne
id|option_server_mode
)paren
id|pmu_set_server_mode
c_func
(paren
id|new_value
)paren
suffix:semicolon
)brace
r_return
id|fcount
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ADB
multiline_comment|/* Send an ADB command */
r_static
r_int
id|__pmac
DECL|function|pmu_send_request
id|pmu_send_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_int
id|sync
)paren
(brace
r_int
id|i
comma
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vias
op_eq
l_int|NULL
)paren
op_logical_or
(paren
op_logical_neg
id|pmu_fully_inited
)paren
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|req-&gt;data
(braket
l_int|0
)braket
)paren
(brace
r_case
id|PMU_PACKET
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|req-&gt;nbytes
op_minus
l_int|1
suffix:semicolon
op_increment
id|i
)paren
id|req-&gt;data
(braket
id|i
)braket
op_assign
id|req-&gt;data
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
op_decrement
id|req-&gt;nbytes
suffix:semicolon
r_if
c_cond
(paren
id|pmu_data_len
(braket
id|req-&gt;data
(braket
l_int|0
)braket
)braket
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
(brace
id|req-&gt;reply
(braket
l_int|0
)braket
op_assign
id|ADB_RET_OK
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|pmu_queue_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CUDA_PACKET
suffix:colon
r_switch
c_cond
(paren
id|req-&gt;data
(braket
l_int|1
)braket
)paren
(brace
r_case
id|CUDA_GET_TIME
suffix:colon
r_if
c_cond
(paren
id|req-&gt;nbytes
op_ne
l_int|2
)paren
r_break
suffix:semicolon
id|req-&gt;data
(braket
l_int|0
)braket
op_assign
id|PMU_READ_RTC
suffix:semicolon
id|req-&gt;nbytes
op_assign
l_int|1
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|3
suffix:semicolon
id|req-&gt;reply
(braket
l_int|0
)braket
op_assign
id|CUDA_PACKET
suffix:semicolon
id|req-&gt;reply
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|req-&gt;reply
(braket
l_int|2
)braket
op_assign
id|CUDA_GET_TIME
suffix:semicolon
id|ret
op_assign
id|pmu_queue_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CUDA_SET_TIME
suffix:colon
r_if
c_cond
(paren
id|req-&gt;nbytes
op_ne
l_int|6
)paren
r_break
suffix:semicolon
id|req-&gt;data
(braket
l_int|0
)braket
op_assign
id|PMU_SET_RTC
suffix:semicolon
id|req-&gt;nbytes
op_assign
l_int|5
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
l_int|4
suffix:semicolon
op_increment
id|i
)paren
id|req-&gt;data
(braket
id|i
)braket
op_assign
id|req-&gt;data
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|3
suffix:semicolon
id|req-&gt;reply
(braket
l_int|0
)braket
op_assign
id|CUDA_PACKET
suffix:semicolon
id|req-&gt;reply
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|req-&gt;reply
(braket
l_int|2
)braket
op_assign
id|CUDA_SET_TIME
suffix:semicolon
id|ret
op_assign
id|pmu_queue_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ADB_PACKET
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|pmu_has_adb
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|req-&gt;nbytes
op_minus
l_int|1
suffix:semicolon
id|i
OG
l_int|1
suffix:semicolon
op_decrement
id|i
)paren
id|req-&gt;data
(braket
id|i
op_plus
l_int|2
)braket
op_assign
id|req-&gt;data
(braket
id|i
)braket
suffix:semicolon
id|req-&gt;data
(braket
l_int|3
)braket
op_assign
id|req-&gt;nbytes
op_minus
l_int|2
suffix:semicolon
id|req-&gt;data
(braket
l_int|2
)braket
op_assign
id|pmu_adb_flags
suffix:semicolon
multiline_comment|/*req-&gt;data[1] = req-&gt;data[1];*/
id|req-&gt;data
(braket
l_int|0
)braket
op_assign
id|PMU_ADB_CMD
suffix:semicolon
id|req-&gt;nbytes
op_add_assign
l_int|2
suffix:semicolon
id|req-&gt;reply_expected
op_assign
l_int|1
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|pmu_queue_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sync
)paren
r_while
c_loop
(paren
op_logical_neg
id|req-&gt;complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Enable/disable autopolling */
r_static
r_int
id|__pmac
DECL|function|pmu_adb_autopoll
id|pmu_adb_autopoll
c_func
(paren
r_int
id|devs
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vias
op_eq
l_int|NULL
)paren
op_logical_or
(paren
op_logical_neg
id|pmu_fully_inited
)paren
op_logical_or
op_logical_neg
id|pmu_has_adb
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|devs
)paren
(brace
id|adb_dev_map
op_assign
id|devs
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|5
comma
id|PMU_ADB_CMD
comma
l_int|0
comma
l_int|0x86
comma
id|adb_dev_map
op_rshift
l_int|8
comma
id|adb_dev_map
)paren
suffix:semicolon
id|pmu_adb_flags
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|1
comma
id|PMU_ADB_POLL_OFF
)paren
suffix:semicolon
id|pmu_adb_flags
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Reset the ADB bus */
r_static
r_int
id|__pmac
DECL|function|pmu_adb_reset_bus
id|pmu_adb_reset_bus
c_func
(paren
r_void
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
r_int
id|save_autopoll
op_assign
id|adb_dev_map
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vias
op_eq
l_int|NULL
)paren
op_logical_or
(paren
op_logical_neg
id|pmu_fully_inited
)paren
op_logical_or
op_logical_neg
id|pmu_has_adb
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* anyone got a better idea?? */
id|pmu_adb_autopoll
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|req.nbytes
op_assign
l_int|5
suffix:semicolon
id|req.done
op_assign
l_int|NULL
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
id|PMU_ADB_CMD
suffix:semicolon
id|req.data
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|req.data
(braket
l_int|2
)braket
op_assign
id|ADB_BUSRESET
suffix:semicolon
id|req.data
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|req.data
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|req.reply_len
op_assign
l_int|0
suffix:semicolon
id|req.reply_expected
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pmu_queue_request
c_func
(paren
op_amp
id|req
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmu_adb_reset_bus: pmu_queue_request failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|save_autopoll
op_ne
l_int|0
)paren
id|pmu_adb_autopoll
c_func
(paren
id|save_autopoll
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ADB */
multiline_comment|/* Construct and send a pmu request */
r_int
id|__openfirmware
DECL|function|pmu_request
id|pmu_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|adb_request
op_star
)paren
comma
r_int
id|nbytes
comma
dot
dot
dot
)paren
(brace
id|va_list
id|list
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|vias
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|nbytes
template_param
l_int|32
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmu_request: bad nbytes (%d)&bslash;n&quot;
comma
id|nbytes
)paren
suffix:semicolon
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|req-&gt;nbytes
op_assign
id|nbytes
suffix:semicolon
id|req-&gt;done
op_assign
id|done
suffix:semicolon
id|va_start
c_func
(paren
id|list
comma
id|nbytes
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nbytes
suffix:semicolon
op_increment
id|i
)paren
id|req-&gt;data
(braket
id|i
)braket
op_assign
id|va_arg
c_func
(paren
id|list
comma
r_int
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|list
)paren
suffix:semicolon
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
id|req-&gt;reply_expected
op_assign
l_int|0
suffix:semicolon
r_return
id|pmu_queue_request
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_int
id|__pmac
DECL|function|pmu_queue_request
id|pmu_queue_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|nsend
suffix:semicolon
r_if
c_cond
(paren
id|via
op_eq
l_int|NULL
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;nbytes
op_le
l_int|0
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|nsend
op_assign
id|pmu_data_len
(braket
id|req-&gt;data
(braket
l_int|0
)braket
)braket
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|nsend
op_ge
l_int|0
op_logical_and
id|req-&gt;nbytes
op_ne
id|nsend
op_plus
l_int|1
)paren
(brace
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|req-&gt;next
op_assign
l_int|0
suffix:semicolon
id|req-&gt;sent
op_assign
l_int|0
suffix:semicolon
id|req-&gt;complete
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_req
op_ne
l_int|0
)paren
(brace
id|last_req-&gt;next
op_assign
id|req
suffix:semicolon
id|last_req
op_assign
id|req
suffix:semicolon
)brace
r_else
(brace
id|current_req
op_assign
id|req
suffix:semicolon
id|last_req
op_assign
id|req
suffix:semicolon
r_if
c_cond
(paren
id|pmu_state
op_eq
id|idle
)paren
id|pmu_start
c_func
(paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|wait_for_ack
id|wait_for_ack
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Sightly increased the delay, I had one occurrence of the message&n;&t; * reported&n;&t; */
r_int
id|timeout
op_assign
l_int|4000
suffix:semicolon
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
)paren
op_amp
id|TACK
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|timeout
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PMU not responding (!ack)&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* New PMU seems to be very sensitive to those timings, so we make sure&n; * PCI is flushed immediately */
r_static
r_inline
r_void
DECL|function|send_byte
id|send_byte
c_func
(paren
r_int
id|x
)paren
(brace
r_volatile
r_int
r_char
op_star
id|v
op_assign
id|via
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|v
(braket
id|ACR
)braket
comma
id|in_8
c_func
(paren
op_amp
id|v
(braket
id|ACR
)braket
)paren
op_or
id|SR_OUT
op_or
id|SR_EXT
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|v
(braket
id|SR
)braket
comma
id|x
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|v
(braket
id|B
)braket
comma
id|in_8
c_func
(paren
op_amp
id|v
(braket
id|B
)braket
)paren
op_amp
op_complement
id|TREQ
)paren
suffix:semicolon
multiline_comment|/* assert TREQ */
(paren
r_void
)paren
id|in_8
c_func
(paren
op_amp
id|v
(braket
id|B
)braket
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|recv_byte
id|recv_byte
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
r_char
op_star
id|v
op_assign
id|via
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|v
(braket
id|ACR
)braket
comma
(paren
id|in_8
c_func
(paren
op_amp
id|v
(braket
id|ACR
)braket
)paren
op_amp
op_complement
id|SR_OUT
)paren
op_or
id|SR_EXT
)paren
suffix:semicolon
id|in_8
c_func
(paren
op_amp
id|v
(braket
id|SR
)braket
)paren
suffix:semicolon
multiline_comment|/* resets SR */
id|out_8
c_func
(paren
op_amp
id|v
(braket
id|B
)braket
comma
id|in_8
c_func
(paren
op_amp
id|v
(braket
id|B
)braket
)paren
op_amp
op_complement
id|TREQ
)paren
suffix:semicolon
(paren
r_void
)paren
id|in_8
c_func
(paren
op_amp
id|v
(braket
id|B
)braket
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|pmu_done
id|pmu_done
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|adb_request
op_star
)paren
op_assign
id|req-&gt;done
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Here, we assume that if the request has a done member, the&n;    &t; * struct request will survive to setting req-&gt;complete to 1&n;    &t; */
r_if
c_cond
(paren
id|done
)paren
(paren
op_star
id|done
)paren
(paren
id|req
)paren
suffix:semicolon
)brace
r_static
r_void
id|__pmac
DECL|function|pmu_start
id|pmu_start
c_func
(paren
r_void
)paren
(brace
r_struct
id|adb_request
op_star
id|req
suffix:semicolon
multiline_comment|/* assert pmu_state == idle */
multiline_comment|/* get the packet to send */
id|req
op_assign
id|current_req
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|0
op_logical_or
id|pmu_state
op_ne
id|idle
op_logical_or
(paren
multiline_comment|/*req-&gt;reply_expected &amp;&amp; */
id|req_awaiting_reply
)paren
)paren
r_return
suffix:semicolon
id|pmu_state
op_assign
id|sending
suffix:semicolon
id|data_index
op_assign
l_int|1
suffix:semicolon
id|data_len
op_assign
id|pmu_data_len
(braket
id|req-&gt;data
(braket
l_int|0
)braket
)braket
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Sounds safer to make sure ACK is high before writing. This helped&n;&t; * kill a problem with ADB and some iBooks&n;&t; */
id|wait_for_ack
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* set the shift register to shift out and send a byte */
id|send_byte
c_func
(paren
id|req-&gt;data
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_XMON
r_if
c_cond
(paren
id|LIVE_DEBUG
c_func
(paren
id|req
)paren
)paren
id|xmon_printf
c_func
(paren
l_string|&quot;R&quot;
)paren
suffix:semicolon
r_else
id|whacky_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif /* CONFIG_XMON */
)brace
r_void
id|__openfirmware
DECL|function|pmu_poll
id|pmu_poll
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|via
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|disable_poll
)paren
r_return
suffix:semicolon
id|via_pmu_interrupt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_void
id|__openfirmware
DECL|function|pmu_poll_adb
id|pmu_poll_adb
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|via
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|disable_poll
)paren
r_return
suffix:semicolon
multiline_comment|/* Kicks ADB read when PMU is suspended */
id|adb_int_pending
op_assign
l_int|1
suffix:semicolon
r_do
(brace
id|via_pmu_interrupt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|pmu_suspended
op_logical_and
(paren
id|adb_int_pending
op_logical_or
id|pmu_state
op_ne
id|idle
op_logical_or
id|req_awaiting_reply
)paren
)paren
suffix:semicolon
)brace
r_void
id|__openfirmware
DECL|function|pmu_wait_complete
id|pmu_wait_complete
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|via
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pmu_state
op_ne
id|idle
op_logical_and
id|pmu_state
op_ne
id|locked
)paren
op_logical_or
op_logical_neg
id|req-&gt;complete
)paren
(brace
id|via_pmu_interrupt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* This function loops until the PMU is idle and prevents it from&n; * anwsering to ADB interrupts. pmu_request can still be called.&n; * This is done to avoid spurrious shutdowns when we know we&squot;ll have&n; * interrupts switched off for a long time&n; */
r_void
id|__openfirmware
DECL|function|pmu_suspend
id|pmu_suspend
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef SUSPEND_USES_PMU
r_struct
id|adb_request
op_star
id|req
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|via
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
id|pmu_suspended
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pmu_suspended
OG
l_int|1
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_do
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req_awaiting_reply
)paren
id|adb_int_pending
op_assign
l_int|1
suffix:semicolon
id|via_pmu_interrupt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adb_int_pending
op_logical_and
id|pmu_state
op_eq
id|idle
op_logical_and
op_logical_neg
id|req_awaiting_reply
)paren
(brace
macro_line|#ifdef SUSPEND_USES_PMU
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_SET_INTR_MASK
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#else /* SUSPEND_USES_PMU */
r_if
c_cond
(paren
id|gpio_irq
op_ge
l_int|0
)paren
id|disable_irq_nosync
c_func
(paren
id|gpio_irq
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IER
)braket
comma
id|CB1_INT
op_or
id|IER_CLR
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif /* SUSPEND_USES_PMU */
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_void
id|__openfirmware
DECL|function|pmu_resume
id|pmu_resume
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|via
op_logical_or
(paren
id|pmu_suspended
OL
l_int|1
)paren
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
id|pmu_suspended
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|pmu_suspended
OG
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|adb_int_pending
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef SUSPEND_USES_PMU
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_SET_INTR_MASK
comma
id|pmu_intr_mask
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#else /* SUSPEND_USES_PMU */
r_if
c_cond
(paren
id|gpio_irq
op_ge
l_int|0
)paren
id|enable_irq
c_func
(paren
id|gpio_irq
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IER
)braket
comma
id|CB1_INT
op_or
id|IER_SET
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif /* SUSPEND_USES_PMU */
)brace
multiline_comment|/* Interrupt data could be the result data from an ADB cmd */
r_static
r_void
id|__pmac
DECL|function|pmu_handle_data
id|pmu_handle_data
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
id|len
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|ints
comma
id|pirq
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|asleep
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|drop_interrupts
op_logical_or
id|len
OL
l_int|1
)paren
(brace
id|adb_int_pending
op_assign
l_int|0
suffix:semicolon
id|pmu_irq_stats
(braket
l_int|8
)braket
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Get PMU interrupt mask */
id|ints
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Record zero interrupts for stats */
r_if
c_cond
(paren
id|ints
op_eq
l_int|0
)paren
id|pmu_irq_stats
(braket
l_int|9
)braket
op_increment
suffix:semicolon
multiline_comment|/* Hack to deal with ADB autopoll flag */
r_if
c_cond
(paren
id|ints
op_amp
id|PMU_INT_ADB
)paren
id|ints
op_and_assign
op_complement
(paren
id|PMU_INT_ADB_AUTO
op_or
id|PMU_INT_AUTO_SRQ_POLL
)paren
suffix:semicolon
id|next
suffix:colon
r_if
c_cond
(paren
id|ints
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|i
OG
id|pmu_irq_stats
(braket
l_int|10
)braket
)paren
id|pmu_irq_stats
(braket
l_int|10
)braket
op_assign
id|i
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|pirq
op_assign
l_int|0
suffix:semicolon
id|pirq
OL
l_int|8
suffix:semicolon
id|pirq
op_increment
)paren
r_if
c_cond
(paren
id|ints
op_amp
(paren
l_int|1
op_lshift
id|pirq
)paren
)paren
r_break
suffix:semicolon
id|pmu_irq_stats
(braket
id|pirq
)braket
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|ints
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|pirq
)paren
suffix:semicolon
multiline_comment|/* Note: for some reason, we get an interrupt with len=1,&n;&t; * data[0]==0 after each normal ADB interrupt, at least&n;&t; * on the Pismo. Still investigating...  --BenH&n;&t; */
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|pirq
)paren
op_amp
id|PMU_INT_ADB
)paren
(brace
r_if
c_cond
(paren
(paren
id|data
(braket
l_int|0
)braket
op_amp
id|PMU_INT_ADB_AUTO
)paren
op_eq
l_int|0
)paren
(brace
r_struct
id|adb_request
op_star
id|req
op_assign
id|req_awaiting_reply
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PMU: extra ADB reply&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|req_awaiting_reply
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|2
)paren
id|req-&gt;reply_len
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|memcpy
c_func
(paren
id|req-&gt;reply
comma
id|data
op_plus
l_int|1
comma
id|len
op_minus
l_int|1
)paren
suffix:semicolon
id|req-&gt;reply_len
op_assign
id|len
op_minus
l_int|1
suffix:semicolon
)brace
id|pmu_done
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#if defined(CONFIG_XMON) &amp;&amp; !defined(CONFIG_PPC64)
r_if
c_cond
(paren
id|len
op_eq
l_int|4
op_logical_and
id|data
(braket
l_int|1
)braket
op_eq
l_int|0x2c
)paren
(brace
r_extern
r_int
id|xmon_wants_key
comma
id|xmon_adb_keycode
suffix:semicolon
r_if
c_cond
(paren
id|xmon_wants_key
)paren
(brace
id|xmon_adb_keycode
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
macro_line|#endif /* defined(CONFIG_XMON) &amp;&amp; !defined(CONFIG_PPC64) */
macro_line|#ifdef CONFIG_ADB
multiline_comment|/*&n;&t;&t;&t; * XXX On the [23]400 the PMU gives us an up&n;&t;&t;&t; * event for keycodes 0x74 or 0x75 when the PC&n;&t;&t;&t; * card eject buttons are released, so we&n;&t;&t;&t; * ignore those events.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pmu_kind
op_eq
id|PMU_OHARE_BASED
op_logical_and
id|len
op_eq
l_int|4
op_logical_and
id|data
(braket
l_int|1
)braket
op_eq
l_int|0x2c
op_logical_and
id|data
(braket
l_int|3
)braket
op_eq
l_int|0xff
op_logical_and
(paren
id|data
(braket
l_int|2
)braket
op_amp
op_complement
l_int|1
)paren
op_eq
l_int|0xf4
)paren
)paren
id|adb_input
c_func
(paren
id|data
op_plus
l_int|1
comma
id|len
op_minus
l_int|1
comma
id|regs
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ADB */&t;&t;
)brace
)brace
multiline_comment|/* Sound/brightness button pressed */
r_else
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|pirq
)paren
op_amp
id|PMU_INT_SNDBRT
)paren
(brace
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
r_if
c_cond
(paren
id|len
op_eq
l_int|3
)paren
macro_line|#ifdef CONFIG_INPUT_ADBHID
r_if
c_cond
(paren
op_logical_neg
id|disable_kernel_backlight
)paren
macro_line|#endif /* CONFIG_INPUT_ADBHID */
id|set_backlight_level
c_func
(paren
id|data
(braket
l_int|1
)braket
op_rshift
l_int|4
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_BACKLIGHT */
)brace
multiline_comment|/* Tick interrupt */
r_else
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|pirq
)paren
op_amp
id|PMU_INT_TICK
)paren
(brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
multiline_comment|/* Environement or tick interrupt, query batteries */
r_if
c_cond
(paren
id|pmu_battery_count
)paren
(brace
r_if
c_cond
(paren
(paren
op_decrement
id|query_batt_timer
)paren
op_eq
l_int|0
)paren
(brace
id|query_battery_state
c_func
(paren
)paren
suffix:semicolon
id|query_batt_timer
op_assign
id|BATTERY_POLLING_COUNT
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|pirq
)paren
op_amp
id|PMU_INT_ENVIRONMENT
)paren
(brace
r_if
c_cond
(paren
id|pmu_battery_count
)paren
id|query_battery_state
c_func
(paren
)paren
suffix:semicolon
id|pmu_pass_intr
c_func
(paren
id|data
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
id|pmu_pass_intr
c_func
(paren
id|data
comma
id|len
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
)brace
r_goto
id|next
suffix:semicolon
)brace
r_static
r_struct
id|adb_request
op_star
id|__pmac
DECL|function|pmu_sr_intr
id|pmu_sr_intr
c_func
(paren
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|adb_request
op_star
id|req
suffix:semicolon
r_int
id|bite
suffix:semicolon
r_if
c_cond
(paren
id|via
(braket
id|B
)braket
op_amp
id|TREQ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PMU: spurious SR intr (%x)&bslash;n&quot;
comma
id|via
(braket
id|B
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IFR
)braket
comma
id|SR_INT
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* The ack may not yet be low when we get the interrupt */
r_while
c_loop
(paren
(paren
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
)paren
op_amp
id|TACK
)paren
op_ne
l_int|0
)paren
suffix:semicolon
multiline_comment|/* if reading grab the byte, and reset the interrupt */
r_if
c_cond
(paren
id|pmu_state
op_eq
id|reading
op_logical_or
id|pmu_state
op_eq
id|reading_intr
)paren
id|bite
op_assign
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|SR
)braket
)paren
suffix:semicolon
multiline_comment|/* reset TREQ and wait for TACK to go high */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
comma
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
)paren
op_or
id|TREQ
)paren
suffix:semicolon
id|wait_for_ack
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|pmu_state
)paren
(brace
r_case
id|sending
suffix:colon
id|req
op_assign
id|current_req
suffix:semicolon
r_if
c_cond
(paren
id|data_len
OL
l_int|0
)paren
(brace
macro_line|#ifdef CONFIG_XMON
r_if
c_cond
(paren
id|LIVE_DEBUG
c_func
(paren
id|req
)paren
)paren
id|xmon_printf
c_func
(paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_XMON */
id|data_len
op_assign
id|req-&gt;nbytes
op_minus
l_int|1
suffix:semicolon
id|send_byte
c_func
(paren
id|data_len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_index
op_le
id|data_len
)paren
(brace
macro_line|#ifdef CONFIG_XMON
r_if
c_cond
(paren
id|LIVE_DEBUG
c_func
(paren
id|req
)paren
)paren
id|xmon_printf
c_func
(paren
l_string|&quot;S&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_XMON */
id|send_byte
c_func
(paren
id|req-&gt;data
(braket
id|data_index
op_increment
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|req-&gt;sent
op_assign
l_int|1
suffix:semicolon
id|data_len
op_assign
id|pmu_data_len
(braket
id|req-&gt;data
(braket
l_int|0
)braket
)braket
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|data_len
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef CONFIG_XMON
r_if
c_cond
(paren
id|LIVE_DEBUG
c_func
(paren
id|req
)paren
)paren
id|xmon_printf
c_func
(paren
l_string|&quot;D&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_XMON */
id|pmu_state
op_assign
id|idle
suffix:semicolon
id|current_req
op_assign
id|req-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;reply_expected
)paren
id|req_awaiting_reply
op_assign
id|req
suffix:semicolon
r_else
r_return
id|req
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef CONFIG_XMON
r_if
c_cond
(paren
id|LIVE_DEBUG
c_func
(paren
id|req
)paren
)paren
id|xmon_printf
c_func
(paren
l_string|&quot;-&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_XMON */
id|pmu_state
op_assign
id|reading
suffix:semicolon
id|data_index
op_assign
l_int|0
suffix:semicolon
id|reply_ptr
op_assign
id|req-&gt;reply
op_plus
id|req-&gt;reply_len
suffix:semicolon
id|recv_byte
c_func
(paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|intack
suffix:colon
id|data_index
op_assign
l_int|0
suffix:semicolon
id|data_len
op_assign
op_minus
l_int|1
suffix:semicolon
id|pmu_state
op_assign
id|reading_intr
suffix:semicolon
id|reply_ptr
op_assign
id|interrupt_data
(braket
id|int_data_last
)braket
suffix:semicolon
id|recv_byte
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gpio_irq
op_ge
l_int|0
op_logical_and
op_logical_neg
id|gpio_irq_enabled
)paren
(brace
id|enable_irq
c_func
(paren
id|gpio_irq
)paren
suffix:semicolon
id|gpio_irq_enabled
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|reading
suffix:colon
r_case
id|reading_intr
suffix:colon
r_if
c_cond
(paren
id|data_len
op_eq
op_minus
l_int|1
)paren
(brace
macro_line|#ifdef CONFIG_XMON
r_if
c_cond
(paren
id|LIVE_DEBUG
c_func
(paren
id|current_req
)paren
)paren
id|xmon_printf
c_func
(paren
l_string|&quot;r&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_XMON */
id|data_len
op_assign
id|bite
suffix:semicolon
r_if
c_cond
(paren
id|bite
OG
l_int|32
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PMU: bad reply len %d&bslash;n&quot;
comma
id|bite
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|data_index
OL
l_int|32
)paren
(brace
macro_line|#ifdef CONFIG_XMON
r_if
c_cond
(paren
id|LIVE_DEBUG
c_func
(paren
id|current_req
)paren
)paren
id|xmon_printf
c_func
(paren
l_string|&quot;R&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_XMON */
id|reply_ptr
(braket
id|data_index
op_increment
)braket
op_assign
id|bite
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_index
OL
id|data_len
)paren
(brace
id|recv_byte
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_XMON
r_if
c_cond
(paren
id|LIVE_DEBUG
c_func
(paren
id|current_req
)paren
)paren
(brace
id|whacky_debug
op_assign
l_int|1
suffix:semicolon
id|xmon_printf
c_func
(paren
l_string|&quot;D&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_XMON */
r_if
c_cond
(paren
id|pmu_state
op_eq
id|reading_intr
)paren
(brace
id|pmu_state
op_assign
id|idle
suffix:semicolon
id|int_data_state
(braket
id|int_data_last
)braket
op_assign
id|int_data_ready
suffix:semicolon
id|interrupt_data_len
(braket
id|int_data_last
)braket
op_assign
id|data_len
suffix:semicolon
)brace
r_else
(brace
id|req
op_assign
id|current_req
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * For PMU sleep and freq change requests, we lock the&n;&t;&t;&t; * PMU until it&squot;s explicitely unlocked. This avoids any&n;&t;&t;&t; * spurrious event polling getting in&n;&t;&t;&t; */
id|current_req
op_assign
id|req-&gt;next
suffix:semicolon
id|req-&gt;reply_len
op_add_assign
id|data_index
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;data
(braket
l_int|0
)braket
op_eq
id|PMU_SLEEP
op_logical_or
id|req-&gt;data
(braket
l_int|0
)braket
op_eq
id|PMU_CPU_SPEED
)paren
id|pmu_state
op_assign
id|locked
suffix:semicolon
r_else
id|pmu_state
op_assign
id|idle
suffix:semicolon
r_return
id|req
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;via_pmu_interrupt: unknown state %d?&bslash;n&quot;
comma
id|pmu_state
)paren
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
id|irqreturn_t
id|__pmac
DECL|function|via_pmu_interrupt
id|via_pmu_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|intr
suffix:semicolon
r_int
id|nloop
op_assign
l_int|0
suffix:semicolon
r_int
id|int_data
op_assign
op_minus
l_int|1
suffix:semicolon
r_struct
id|adb_request
op_star
id|req
op_assign
l_int|NULL
suffix:semicolon
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This is a bit brutal, we can probably do better */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
op_increment
id|disable_poll
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|intr
op_assign
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|IFR
)braket
)paren
op_amp
(paren
id|SR_INT
op_or
id|CB1_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|0
)paren
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_XMON
r_if
c_cond
(paren
id|whacky_debug
)paren
id|xmon_printf
c_func
(paren
l_string|&quot;|%02x|&quot;
comma
id|intr
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_XMON */
id|handled
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|nloop
OG
l_int|1000
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;PMU: stuck in intr loop, &quot;
l_string|&quot;intr=%x, ier=%x pmu_state=%d&bslash;n&quot;
comma
id|intr
comma
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|IER
)braket
)paren
comma
id|pmu_state
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IFR
)braket
comma
id|intr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_amp
id|CB1_INT
)paren
(brace
id|adb_int_pending
op_assign
l_int|1
suffix:semicolon
id|pmu_irq_stats
(braket
l_int|0
)braket
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr
op_amp
id|SR_INT
)paren
(brace
id|req
op_assign
id|pmu_sr_intr
c_func
(paren
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
)paren
r_break
suffix:semicolon
)brace
)brace
id|recheck
suffix:colon
r_if
c_cond
(paren
id|pmu_state
op_eq
id|idle
)paren
(brace
r_if
c_cond
(paren
id|adb_int_pending
)paren
(brace
macro_line|#ifdef CONFIG_XMON
r_if
c_cond
(paren
id|whacky_debug
)paren
id|xmon_printf
c_func
(paren
l_string|&quot;!A!&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_XMON */
r_if
c_cond
(paren
id|int_data_state
(braket
l_int|0
)braket
op_eq
id|int_data_empty
)paren
id|int_data_last
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|int_data_state
(braket
l_int|1
)braket
op_eq
id|int_data_empty
)paren
id|int_data_last
op_assign
l_int|1
suffix:semicolon
r_else
r_goto
id|no_free_slot
suffix:semicolon
id|pmu_state
op_assign
id|intack
suffix:semicolon
id|int_data_state
(braket
id|int_data_last
)braket
op_assign
id|int_data_fill
suffix:semicolon
multiline_comment|/* Sounds safer to make sure ACK is high before writing.&n;&t;&t;&t; * This helped kill a problem with ADB and some iBooks&n;&t;&t;&t; */
id|wait_for_ack
c_func
(paren
)paren
suffix:semicolon
id|send_byte
c_func
(paren
id|PMU_INT_ACK
)paren
suffix:semicolon
id|adb_int_pending
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|current_req
)paren
id|pmu_start
c_func
(paren
)paren
suffix:semicolon
)brace
id|no_free_slot
suffix:colon
multiline_comment|/* Mark the oldest buffer for flushing */
r_if
c_cond
(paren
id|int_data_state
(braket
op_logical_neg
id|int_data_last
)braket
op_eq
id|int_data_ready
)paren
(brace
id|int_data_state
(braket
op_logical_neg
id|int_data_last
)braket
op_assign
id|int_data_flush
suffix:semicolon
id|int_data
op_assign
op_logical_neg
id|int_data_last
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|int_data_state
(braket
id|int_data_last
)braket
op_eq
id|int_data_ready
)paren
(brace
id|int_data_state
(braket
id|int_data_last
)braket
op_assign
id|int_data_flush
suffix:semicolon
id|int_data
op_assign
id|int_data_last
suffix:semicolon
)brace
op_decrement
id|disable_poll
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Deal with completed PMU requests outside of the lock */
r_if
c_cond
(paren
id|req
)paren
(brace
id|pmu_done
c_func
(paren
id|req
)paren
suffix:semicolon
id|req
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Deal with interrupt datas outside of the lock */
r_if
c_cond
(paren
id|int_data
op_ge
l_int|0
)paren
(brace
id|pmu_handle_data
c_func
(paren
id|interrupt_data
(braket
id|int_data
)braket
comma
id|interrupt_data_len
(braket
id|int_data
)braket
comma
id|regs
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
op_increment
id|disable_poll
suffix:semicolon
id|int_data_state
(braket
id|int_data
)braket
op_assign
id|int_data_empty
suffix:semicolon
id|int_data
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|recheck
suffix:semicolon
)brace
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
r_void
id|__pmac
DECL|function|pmu_unlock
id|pmu_unlock
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmu_state
op_eq
id|locked
)paren
id|pmu_state
op_assign
id|idle
suffix:semicolon
id|adb_int_pending
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
id|irqreturn_t
id|__pmac
DECL|function|gpio1_interrupt
id|gpio1_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|in_8
c_func
(paren
id|gpio_reg
op_plus
l_int|0x9
)paren
op_amp
l_int|0x02
)paren
op_eq
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gpio_irq_enabled
OG
l_int|0
)paren
(brace
id|disable_irq_nosync
c_func
(paren
id|gpio_irq
)paren
suffix:semicolon
id|gpio_irq_enabled
op_assign
l_int|0
suffix:semicolon
)brace
id|pmu_irq_stats
(braket
l_int|1
)braket
op_increment
suffix:semicolon
id|adb_int_pending
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
id|via_pmu_interrupt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_return
id|IRQ_NONE
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
DECL|variable|__pmacdata
r_static
r_int
id|backlight_to_bright
(braket
)braket
id|__pmacdata
op_assign
(brace
l_int|0x7f
comma
l_int|0x46
comma
l_int|0x42
comma
l_int|0x3e
comma
l_int|0x3a
comma
l_int|0x36
comma
l_int|0x32
comma
l_int|0x2e
comma
l_int|0x2a
comma
l_int|0x26
comma
l_int|0x22
comma
l_int|0x1e
comma
l_int|0x1a
comma
l_int|0x16
comma
l_int|0x12
comma
l_int|0x0e
)brace
suffix:semicolon
r_static
r_int
id|__openfirmware
DECL|function|pmu_set_backlight_enable
id|pmu_set_backlight_enable
c_func
(paren
r_int
id|on
comma
r_int
id|level
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
r_if
c_cond
(paren
id|vias
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
(brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_BACKLIGHT_BRIGHT
comma
id|backlight_to_bright
(braket
id|level
)braket
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
)brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_POWER_CTRL
comma
id|PMU_POW_BACKLIGHT
op_or
(paren
id|on
ques
c_cond
id|PMU_POW_ON
suffix:colon
id|PMU_POW_OFF
)paren
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__openfirmware
DECL|function|pmu_set_backlight_level
id|pmu_set_backlight_level
c_func
(paren
r_int
id|level
comma
r_void
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
id|vias
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bright_req_1.complete
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|bright_req_1
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_BACKLIGHT_BRIGHT
comma
id|backlight_to_bright
(braket
id|level
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bright_req_2.complete
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|bright_req_2
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_POWER_CTRL
comma
id|PMU_POW_BACKLIGHT
op_or
(paren
id|level
OG
id|BACKLIGHT_OFF
ques
c_cond
id|PMU_POW_ON
suffix:colon
id|PMU_POW_OFF
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PMAC_BACKLIGHT */
r_void
id|__pmac
DECL|function|pmu_enable_irled
id|pmu_enable_irled
c_func
(paren
r_int
id|on
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
r_if
c_cond
(paren
id|vias
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pmu_kind
op_eq
id|PMU_KEYLARGO_BASED
)paren
r_return
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_POWER_CTRL
comma
id|PMU_POW_IRLED
op_or
(paren
id|on
ques
c_cond
id|PMU_POW_ON
suffix:colon
id|PMU_POW_OFF
)paren
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
)brace
r_void
id|__pmac
DECL|function|pmu_restart
id|pmu_restart
c_func
(paren
r_void
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|drop_interrupts
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pmu_kind
op_ne
id|PMU_KEYLARGO_BASED
)paren
(brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_SET_INTR_MASK
comma
id|PMU_INT_ADB
op_or
id|PMU_INT_TICK
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|1
comma
id|PMU_RESET
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
)brace
r_void
id|__pmac
DECL|function|pmu_shutdown
id|pmu_shutdown
c_func
(paren
r_void
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|drop_interrupts
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pmu_kind
op_ne
id|PMU_KEYLARGO_BASED
)paren
(brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_SET_INTR_MASK
comma
id|PMU_INT_ADB
op_or
id|PMU_INT_TICK
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Disable server mode on shutdown or we&squot;ll just&n;&t;&t; * wake up again&n;&t;&t; */
id|pmu_set_server_mode
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|5
comma
id|PMU_SHUTDOWN
comma
l_char|&squot;M&squot;
comma
l_char|&squot;A&squot;
comma
l_char|&squot;T&squot;
comma
l_char|&squot;T&squot;
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
suffix:semicolon
)brace
r_int
DECL|function|pmu_present
id|pmu_present
c_func
(paren
r_void
)paren
(brace
r_return
id|via
op_ne
l_int|0
suffix:semicolon
)brace
DECL|struct|pmu_i2c_hdr
r_struct
id|pmu_i2c_hdr
(brace
DECL|member|bus
id|u8
id|bus
suffix:semicolon
DECL|member|mode
id|u8
id|mode
suffix:semicolon
DECL|member|bus2
id|u8
id|bus2
suffix:semicolon
DECL|member|address
id|u8
id|address
suffix:semicolon
DECL|member|sub_addr
id|u8
id|sub_addr
suffix:semicolon
DECL|member|comb_addr
id|u8
id|comb_addr
suffix:semicolon
DECL|member|count
id|u8
id|count
suffix:semicolon
)brace
suffix:semicolon
r_int
DECL|function|pmu_i2c_combined_read
id|pmu_i2c_combined_read
c_func
(paren
r_int
id|bus
comma
r_int
id|addr
comma
r_int
id|subaddr
comma
id|u8
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
r_struct
id|pmu_i2c_hdr
op_star
id|hdr
op_assign
(paren
r_struct
id|pmu_i2c_hdr
op_star
)paren
op_amp
id|req.data
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|retry
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|16
suffix:semicolon
id|retry
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|req
comma
l_int|0
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
id|hdr-&gt;bus
op_assign
id|bus
suffix:semicolon
id|hdr-&gt;address
op_assign
id|addr
op_amp
l_int|0xfe
suffix:semicolon
id|hdr-&gt;mode
op_assign
id|PMU_I2C_MODE_COMBINED
suffix:semicolon
id|hdr-&gt;bus2
op_assign
l_int|0
suffix:semicolon
id|hdr-&gt;sub_addr
op_assign
id|subaddr
suffix:semicolon
id|hdr-&gt;comb_addr
op_assign
id|addr
op_or
l_int|1
suffix:semicolon
id|hdr-&gt;count
op_assign
id|len
suffix:semicolon
id|req.nbytes
op_assign
r_sizeof
(paren
r_struct
id|pmu_i2c_hdr
)paren
op_plus
l_int|1
suffix:semicolon
id|req.reply_expected
op_assign
l_int|0
suffix:semicolon
id|req.reply_len
op_assign
l_int|0
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
id|PMU_I2C_CMD
suffix:semicolon
id|req.reply
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|rc
op_assign
id|pmu_queue_request
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_eq
id|PMU_I2C_STATUS_OK
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_ne
id|PMU_I2C_STATUS_OK
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|16
suffix:semicolon
id|retry
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|req
comma
l_int|0
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
id|hdr-&gt;bus
op_assign
id|PMU_I2C_BUS_STATUS
suffix:semicolon
id|req.reply
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|req.nbytes
op_assign
l_int|2
suffix:semicolon
id|req.reply_expected
op_assign
l_int|0
suffix:semicolon
id|req.reply_len
op_assign
l_int|0
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
id|PMU_I2C_CMD
suffix:semicolon
id|rc
op_assign
id|pmu_queue_request
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_eq
id|PMU_I2C_STATUS_DATAREAD
)paren
(brace
id|memcpy
c_func
(paren
id|data
comma
op_amp
id|req.reply
(braket
l_int|1
)braket
comma
id|req.reply_len
op_minus
l_int|1
)paren
suffix:semicolon
r_return
id|req.reply_len
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|pmu_i2c_stdsub_write
id|pmu_i2c_stdsub_write
c_func
(paren
r_int
id|bus
comma
r_int
id|addr
comma
r_int
id|subaddr
comma
id|u8
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
r_struct
id|pmu_i2c_hdr
op_star
id|hdr
op_assign
(paren
r_struct
id|pmu_i2c_hdr
op_star
)paren
op_amp
id|req.data
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|retry
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|16
suffix:semicolon
id|retry
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|req
comma
l_int|0
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
id|hdr-&gt;bus
op_assign
id|bus
suffix:semicolon
id|hdr-&gt;address
op_assign
id|addr
op_amp
l_int|0xfe
suffix:semicolon
id|hdr-&gt;mode
op_assign
id|PMU_I2C_MODE_STDSUB
suffix:semicolon
id|hdr-&gt;bus2
op_assign
l_int|0
suffix:semicolon
id|hdr-&gt;sub_addr
op_assign
id|subaddr
suffix:semicolon
id|hdr-&gt;comb_addr
op_assign
id|addr
op_amp
l_int|0xfe
suffix:semicolon
id|hdr-&gt;count
op_assign
id|len
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
id|PMU_I2C_CMD
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|req.data
(braket
r_sizeof
(paren
r_struct
id|pmu_i2c_hdr
)paren
op_plus
l_int|1
)braket
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|req.nbytes
op_assign
r_sizeof
(paren
r_struct
id|pmu_i2c_hdr
)paren
op_plus
id|len
op_plus
l_int|1
suffix:semicolon
id|req.reply_expected
op_assign
l_int|0
suffix:semicolon
id|req.reply_len
op_assign
l_int|0
suffix:semicolon
id|req.reply
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|rc
op_assign
id|pmu_queue_request
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_eq
id|PMU_I2C_STATUS_OK
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_ne
id|PMU_I2C_STATUS_OK
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|16
suffix:semicolon
id|retry
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|req
comma
l_int|0
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
id|hdr-&gt;bus
op_assign
id|PMU_I2C_BUS_STATUS
suffix:semicolon
id|req.reply
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|req.nbytes
op_assign
l_int|2
suffix:semicolon
id|req.reply_expected
op_assign
l_int|0
suffix:semicolon
id|req.reply_len
op_assign
l_int|0
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
id|PMU_I2C_CMD
suffix:semicolon
id|rc
op_assign
id|pmu_queue_request
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_eq
id|PMU_I2C_STATUS_OK
)paren
r_return
id|len
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|pmu_i2c_simple_read
id|pmu_i2c_simple_read
c_func
(paren
r_int
id|bus
comma
r_int
id|addr
comma
id|u8
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
r_struct
id|pmu_i2c_hdr
op_star
id|hdr
op_assign
(paren
r_struct
id|pmu_i2c_hdr
op_star
)paren
op_amp
id|req.data
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|retry
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|16
suffix:semicolon
id|retry
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|req
comma
l_int|0
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
id|hdr-&gt;bus
op_assign
id|bus
suffix:semicolon
id|hdr-&gt;address
op_assign
id|addr
op_or
l_int|1
suffix:semicolon
id|hdr-&gt;mode
op_assign
id|PMU_I2C_MODE_SIMPLE
suffix:semicolon
id|hdr-&gt;bus2
op_assign
l_int|0
suffix:semicolon
id|hdr-&gt;sub_addr
op_assign
l_int|0
suffix:semicolon
id|hdr-&gt;comb_addr
op_assign
l_int|0
suffix:semicolon
id|hdr-&gt;count
op_assign
id|len
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
id|PMU_I2C_CMD
suffix:semicolon
id|req.nbytes
op_assign
r_sizeof
(paren
r_struct
id|pmu_i2c_hdr
)paren
op_plus
l_int|1
suffix:semicolon
id|req.reply_expected
op_assign
l_int|0
suffix:semicolon
id|req.reply_len
op_assign
l_int|0
suffix:semicolon
id|req.reply
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|rc
op_assign
id|pmu_queue_request
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_eq
id|PMU_I2C_STATUS_OK
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_ne
id|PMU_I2C_STATUS_OK
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|16
suffix:semicolon
id|retry
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|req
comma
l_int|0
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
id|hdr-&gt;bus
op_assign
id|PMU_I2C_BUS_STATUS
suffix:semicolon
id|req.reply
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|req.nbytes
op_assign
l_int|2
suffix:semicolon
id|req.reply_expected
op_assign
l_int|0
suffix:semicolon
id|req.reply_len
op_assign
l_int|0
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
id|PMU_I2C_CMD
suffix:semicolon
id|rc
op_assign
id|pmu_queue_request
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_eq
id|PMU_I2C_STATUS_DATAREAD
)paren
(brace
id|memcpy
c_func
(paren
id|data
comma
op_amp
id|req.reply
(braket
l_int|1
)braket
comma
id|req.reply_len
op_minus
l_int|1
)paren
suffix:semicolon
r_return
id|req.reply_len
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|pmu_i2c_simple_write
id|pmu_i2c_simple_write
c_func
(paren
r_int
id|bus
comma
r_int
id|addr
comma
id|u8
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
r_struct
id|pmu_i2c_hdr
op_star
id|hdr
op_assign
(paren
r_struct
id|pmu_i2c_hdr
op_star
)paren
op_amp
id|req.data
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|retry
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|16
suffix:semicolon
id|retry
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|req
comma
l_int|0
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
id|hdr-&gt;bus
op_assign
id|bus
suffix:semicolon
id|hdr-&gt;address
op_assign
id|addr
op_amp
l_int|0xfe
suffix:semicolon
id|hdr-&gt;mode
op_assign
id|PMU_I2C_MODE_SIMPLE
suffix:semicolon
id|hdr-&gt;bus2
op_assign
l_int|0
suffix:semicolon
id|hdr-&gt;sub_addr
op_assign
l_int|0
suffix:semicolon
id|hdr-&gt;comb_addr
op_assign
l_int|0
suffix:semicolon
id|hdr-&gt;count
op_assign
id|len
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
id|PMU_I2C_CMD
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|req.data
(braket
r_sizeof
(paren
r_struct
id|pmu_i2c_hdr
)paren
op_plus
l_int|1
)braket
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|req.nbytes
op_assign
r_sizeof
(paren
r_struct
id|pmu_i2c_hdr
)paren
op_plus
id|len
op_plus
l_int|1
suffix:semicolon
id|req.reply_expected
op_assign
l_int|0
suffix:semicolon
id|req.reply_len
op_assign
l_int|0
suffix:semicolon
id|req.reply
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|rc
op_assign
id|pmu_queue_request
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_eq
id|PMU_I2C_STATUS_OK
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_ne
id|PMU_I2C_STATUS_OK
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|16
suffix:semicolon
id|retry
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|req
comma
l_int|0
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
id|hdr-&gt;bus
op_assign
id|PMU_I2C_BUS_STATUS
suffix:semicolon
id|req.reply
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|req.nbytes
op_assign
l_int|2
suffix:semicolon
id|req.reply_expected
op_assign
l_int|0
suffix:semicolon
id|req.reply_len
op_assign
l_int|0
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
id|PMU_I2C_CMD
suffix:semicolon
id|rc
op_assign
id|pmu_queue_request
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|req.complete
)paren
(brace
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.reply
(braket
l_int|0
)braket
op_eq
id|PMU_I2C_STATUS_OK
)paren
r_return
id|len
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_static
id|LIST_HEAD
c_func
(paren
id|sleep_notifiers
)paren
suffix:semicolon
r_int
DECL|function|pmu_register_sleep_notifier
id|pmu_register_sleep_notifier
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|n
)paren
(brace
r_struct
id|list_head
op_star
id|list
suffix:semicolon
r_struct
id|pmu_sleep_notifier
op_star
id|notifier
suffix:semicolon
r_for
c_loop
(paren
id|list
op_assign
id|sleep_notifiers.next
suffix:semicolon
id|list
op_ne
op_amp
id|sleep_notifiers
suffix:semicolon
id|list
op_assign
id|list-&gt;next
)paren
(brace
id|notifier
op_assign
id|list_entry
c_func
(paren
id|list
comma
r_struct
id|pmu_sleep_notifier
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n-&gt;priority
OG
id|notifier-&gt;priority
)paren
r_break
suffix:semicolon
)brace
id|__list_add
c_func
(paren
op_amp
id|n-&gt;list
comma
id|list-&gt;prev
comma
id|list
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|pmu_unregister_sleep_notifier
id|pmu_unregister_sleep_notifier
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|n
)paren
(brace
r_if
c_cond
(paren
id|n-&gt;list.next
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|n-&gt;list
)paren
suffix:semicolon
id|n-&gt;list.next
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Sleep is broadcast last-to-first */
r_static
r_int
id|__pmac
DECL|function|broadcast_sleep
id|broadcast_sleep
c_func
(paren
r_int
id|when
comma
r_int
id|fallback
)paren
(brace
r_int
id|ret
op_assign
id|PBOOK_SLEEP_OK
suffix:semicolon
r_struct
id|list_head
op_star
id|list
suffix:semicolon
r_struct
id|pmu_sleep_notifier
op_star
id|notifier
suffix:semicolon
r_for
c_loop
(paren
id|list
op_assign
id|sleep_notifiers.prev
suffix:semicolon
id|list
op_ne
op_amp
id|sleep_notifiers
suffix:semicolon
id|list
op_assign
id|list-&gt;prev
)paren
(brace
id|notifier
op_assign
id|list_entry
c_func
(paren
id|list
comma
r_struct
id|pmu_sleep_notifier
comma
id|list
)paren
suffix:semicolon
id|ret
op_assign
id|notifier
op_member_access_from_pointer
id|notifier_call
c_func
(paren
id|notifier
comma
id|when
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|PBOOK_SLEEP_OK
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;sleep %d rejected by %p (%p)&bslash;n&quot;
comma
id|when
comma
id|notifier
comma
id|notifier-&gt;notifier_call
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|list
op_ne
op_amp
id|sleep_notifiers
suffix:semicolon
id|list
op_assign
id|list-&gt;next
)paren
(brace
id|notifier
op_assign
id|list_entry
c_func
(paren
id|list
comma
r_struct
id|pmu_sleep_notifier
comma
id|list
)paren
suffix:semicolon
id|notifier
op_member_access_from_pointer
id|notifier_call
c_func
(paren
id|notifier
comma
id|fallback
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Wake is broadcast first-to-last */
r_static
r_int
id|__pmac
DECL|function|broadcast_wake
id|broadcast_wake
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
id|PBOOK_SLEEP_OK
suffix:semicolon
r_struct
id|list_head
op_star
id|list
suffix:semicolon
r_struct
id|pmu_sleep_notifier
op_star
id|notifier
suffix:semicolon
r_for
c_loop
(paren
id|list
op_assign
id|sleep_notifiers.next
suffix:semicolon
id|list
op_ne
op_amp
id|sleep_notifiers
suffix:semicolon
id|list
op_assign
id|list-&gt;next
)paren
(brace
id|notifier
op_assign
id|list_entry
c_func
(paren
id|list
comma
r_struct
id|pmu_sleep_notifier
comma
id|list
)paren
suffix:semicolon
id|notifier
op_member_access_from_pointer
id|notifier_call
c_func
(paren
id|notifier
comma
id|PBOOK_WAKE
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * This struct is used to store config register values for&n; * PCI devices which may get powered off when we sleep.&n; */
DECL|struct|pci_save
r_static
r_struct
id|pci_save
(brace
macro_line|#ifndef HACKED_PCI_SAVE
DECL|member|command
id|u16
id|command
suffix:semicolon
DECL|member|cache_lat
id|u16
id|cache_lat
suffix:semicolon
DECL|member|intr
id|u16
id|intr
suffix:semicolon
DECL|member|rom_address
id|u32
id|rom_address
suffix:semicolon
macro_line|#else
id|u32
id|config
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif&t;
DECL|variable|pbook_pci_saves
)brace
op_star
id|pbook_pci_saves
suffix:semicolon
DECL|variable|pbook_npci_saves
r_static
r_int
id|pbook_npci_saves
suffix:semicolon
r_static
r_void
id|__pmac
DECL|function|pbook_alloc_pci_save
id|pbook_alloc_pci_save
c_func
(paren
r_void
)paren
(brace
r_int
id|npci
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pd
op_assign
l_int|NULL
suffix:semicolon
id|npci
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pd
op_assign
id|pci_find_device
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|pd
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
op_increment
id|npci
suffix:semicolon
)brace
r_if
c_cond
(paren
id|npci
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|pbook_pci_saves
op_assign
(paren
r_struct
id|pci_save
op_star
)paren
id|kmalloc
c_func
(paren
id|npci
op_star
r_sizeof
(paren
r_struct
id|pci_save
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|pbook_npci_saves
op_assign
id|npci
suffix:semicolon
)brace
r_static
r_void
id|__pmac
DECL|function|pbook_free_pci_save
id|pbook_free_pci_save
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|pbook_pci_saves
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|kfree
c_func
(paren
id|pbook_pci_saves
)paren
suffix:semicolon
id|pbook_pci_saves
op_assign
l_int|NULL
suffix:semicolon
id|pbook_npci_saves
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__pmac
DECL|function|pbook_pci_save
id|pbook_pci_save
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_save
op_star
id|ps
op_assign
id|pbook_pci_saves
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pd
op_assign
l_int|NULL
suffix:semicolon
r_int
id|npci
op_assign
id|pbook_npci_saves
suffix:semicolon
r_if
c_cond
(paren
id|ps
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pd
op_assign
id|pci_find_device
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|pd
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|npci
op_decrement
op_eq
l_int|0
)paren
r_return
suffix:semicolon
macro_line|#ifndef HACKED_PCI_SAVE
id|pci_read_config_word
c_func
(paren
id|pd
comma
id|PCI_COMMAND
comma
op_amp
id|ps-&gt;command
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pd
comma
id|PCI_CACHE_LINE_SIZE
comma
op_amp
id|ps-&gt;cache_lat
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pd
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|ps-&gt;intr
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pd
comma
id|PCI_ROM_ADDRESS
comma
op_amp
id|ps-&gt;rom_address
)paren
suffix:semicolon
macro_line|#else
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|pci_read_config_dword
c_func
(paren
id|pd
comma
id|i
op_lshift
l_int|4
comma
op_amp
id|ps-&gt;config
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
op_increment
id|ps
suffix:semicolon
)brace
)brace
multiline_comment|/* For this to work, we must take care of a few things: If gmac was enabled&n; * during boot, it will be in the pci dev list. If it&squot;s disabled at this point&n; * (and it will probably be), then you can&squot;t access it&squot;s config space.&n; */
r_static
r_void
id|__pmac
DECL|function|pbook_pci_restore
id|pbook_pci_restore
c_func
(paren
r_void
)paren
(brace
id|u16
id|cmd
suffix:semicolon
r_struct
id|pci_save
op_star
id|ps
op_assign
id|pbook_pci_saves
op_minus
l_int|1
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pd
op_assign
l_int|NULL
suffix:semicolon
r_int
id|npci
op_assign
id|pbook_npci_saves
suffix:semicolon
r_int
id|j
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pd
op_assign
id|pci_find_device
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|pd
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
macro_line|#ifdef HACKED_PCI_SAVE
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|npci
op_decrement
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|ps
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|pci_write_config_dword
c_func
(paren
id|pd
comma
id|i
op_lshift
l_int|4
comma
id|ps-&gt;config
(braket
id|i
)braket
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pd
comma
l_int|4
comma
id|ps-&gt;config
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|npci
op_decrement
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|ps
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ps-&gt;command
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pd
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ps-&gt;command
op_amp
op_complement
id|cmd
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|pd-&gt;hdr_type
)paren
(brace
r_case
id|PCI_HEADER_TYPE_NORMAL
suffix:colon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|6
suffix:semicolon
op_increment
id|j
)paren
id|pci_write_config_dword
c_func
(paren
id|pd
comma
id|PCI_BASE_ADDRESS_0
op_plus
id|j
op_star
l_int|4
comma
id|pd-&gt;resource
(braket
id|j
)braket
dot
id|start
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pd
comma
id|PCI_ROM_ADDRESS
comma
id|ps-&gt;rom_address
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pd
comma
id|PCI_CACHE_LINE_SIZE
comma
id|ps-&gt;cache_lat
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pd
comma
id|PCI_INTERRUPT_LINE
comma
id|ps-&gt;intr
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pd
comma
id|PCI_COMMAND
comma
id|ps-&gt;command
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif&t;
)brace
)brace
macro_line|#ifdef DEBUG_SLEEP
multiline_comment|/* N.B. This doesn&squot;t work on the 3400 */
r_void
id|__pmac
DECL|function|pmu_blink
id|pmu_blink
c_func
(paren
r_int
id|n
)paren
(brace
r_struct
id|adb_request
id|req
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|req
comma
l_int|0
comma
r_sizeof
(paren
id|req
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|n
OG
l_int|0
suffix:semicolon
op_decrement
id|n
)paren
(brace
id|req.nbytes
op_assign
l_int|4
suffix:semicolon
id|req.done
op_assign
l_int|NULL
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
l_int|0xee
suffix:semicolon
id|req.data
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
id|req.data
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|req.data
(braket
l_int|3
)braket
op_assign
l_int|1
suffix:semicolon
id|req.reply
(braket
l_int|0
)braket
op_assign
id|ADB_RET_OK
suffix:semicolon
id|req.reply_len
op_assign
l_int|1
suffix:semicolon
id|req.reply_expected
op_assign
l_int|0
suffix:semicolon
id|pmu_polled_request
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|req.nbytes
op_assign
l_int|4
suffix:semicolon
id|req.done
op_assign
l_int|NULL
suffix:semicolon
id|req.data
(braket
l_int|0
)braket
op_assign
l_int|0xee
suffix:semicolon
id|req.data
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
id|req.data
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|req.data
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|req.reply
(braket
l_int|0
)braket
op_assign
id|ADB_RET_OK
suffix:semicolon
id|req.reply_len
op_assign
l_int|1
suffix:semicolon
id|req.reply_expected
op_assign
l_int|0
suffix:semicolon
id|pmu_polled_request
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Put the powerbook to sleep.&n; */
DECL|variable|__pmacdata
r_static
id|u32
id|save_via
(braket
l_int|8
)braket
id|__pmacdata
suffix:semicolon
r_static
r_void
id|__pmac
DECL|function|save_via_state
id|save_via_state
c_func
(paren
r_void
)paren
(brace
id|save_via
(braket
l_int|0
)braket
op_assign
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|ANH
)braket
)paren
suffix:semicolon
id|save_via
(braket
l_int|1
)braket
op_assign
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|DIRA
)braket
)paren
suffix:semicolon
id|save_via
(braket
l_int|2
)braket
op_assign
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
)paren
suffix:semicolon
id|save_via
(braket
l_int|3
)braket
op_assign
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|DIRB
)braket
)paren
suffix:semicolon
id|save_via
(braket
l_int|4
)braket
op_assign
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|PCR
)braket
)paren
suffix:semicolon
id|save_via
(braket
l_int|5
)braket
op_assign
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|ACR
)braket
)paren
suffix:semicolon
id|save_via
(braket
l_int|6
)braket
op_assign
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|T1CL
)braket
)paren
suffix:semicolon
id|save_via
(braket
l_int|7
)braket
op_assign
id|in_8
c_func
(paren
op_amp
id|via
(braket
id|T1CH
)braket
)paren
suffix:semicolon
)brace
r_static
r_void
id|__pmac
DECL|function|restore_via_state
id|restore_via_state
c_func
(paren
r_void
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|ANH
)braket
comma
id|save_via
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|DIRA
)braket
comma
id|save_via
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|B
)braket
comma
id|save_via
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|DIRB
)braket
comma
id|save_via
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|PCR
)braket
comma
id|save_via
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|ACR
)braket
comma
id|save_via
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|T1CL
)braket
comma
id|save_via
(braket
l_int|6
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|T1CH
)braket
comma
id|save_via
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IER
)braket
comma
id|IER_CLR
op_or
l_int|0x7f
)paren
suffix:semicolon
multiline_comment|/* disable all intrs */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IFR
)braket
comma
l_int|0x7f
)paren
suffix:semicolon
multiline_comment|/* clear IFR */
id|out_8
c_func
(paren
op_amp
id|via
(braket
id|IER
)braket
comma
id|IER_SET
op_or
id|SR_INT
op_or
id|CB1_INT
)paren
suffix:semicolon
)brace
r_extern
r_int
id|sys_sync
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|__pmac
DECL|function|pmac_suspend_devices
id|pmac_suspend_devices
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|pm_prepare_console
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Notify old-style device drivers &amp; userland */
id|ret
op_assign
id|broadcast_sleep
c_func
(paren
id|PBOOK_SLEEP_REQUEST
comma
id|PBOOK_SLEEP_REJECT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|PBOOK_SLEEP_OK
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Sleep rejected by drivers&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Sync the disks. */
multiline_comment|/* XXX It would be nice to have some way to ensure that&n;&t; * nobody is dirtying any new buffers while we wait. That&n;&t; * could be acheived using the refrigerator for processes&n;&t; * that swsusp uses&n;&t; */
id|sys_sync
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Sleep can fail now. May not be very robust but useful for debugging */
id|ret
op_assign
id|broadcast_sleep
c_func
(paren
id|PBOOK_SLEEP_NOW
comma
id|PBOOK_WAKE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|PBOOK_SLEEP_OK
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Driver sleep failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Send suspend call to devices, hold the device core&squot;s dpm_sem */
id|ret
op_assign
id|device_suspend
c_func
(paren
id|PM_SUSPEND_MEM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Driver sleep failed&bslash;n&quot;
)paren
suffix:semicolon
id|broadcast_wake
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Make sure the decrementer won&squot;t interrupt us */
id|asm
r_volatile
(paren
l_string|&quot;mtdec %0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
l_int|0x7fffffff
)paren
)paren
suffix:semicolon
multiline_comment|/* Make sure any pending DEC interrupt occurring while we did&n;&t; * the above didn&squot;t re-enable the DEC */
id|mb
c_func
(paren
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;mtdec %0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
l_int|0x7fffffff
)paren
)paren
suffix:semicolon
multiline_comment|/* We can now disable MSR_EE. This code of course works properly only&n;&t; * on UP machines... For SMP, if we ever implement sleep, we&squot;ll have to&n;&t; * stop the &quot;other&quot; CPUs way before we do all that stuff.&n;&t; */
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Broadcast power down irq&n;&t; * This isn&squot;t that useful in most cases (only directly wired devices can&n;&t; * use this but still... This will take care of sysdev&squot;s as well, so&n;&t; * we exit from here with local irqs disabled and PIC off.&n;&t; */
id|ret
op_assign
id|device_power_down
c_func
(paren
id|PM_SUSPEND_MEM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|wakeup_decrementer
c_func
(paren
)paren
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
id|device_resume
c_func
(paren
)paren
suffix:semicolon
id|broadcast_wake
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Driver powerdown failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Wait for completion of async backlight requests */
r_while
c_loop
(paren
op_logical_neg
id|bright_req_1.complete
op_logical_or
op_logical_neg
id|bright_req_2.complete
op_logical_or
op_logical_neg
id|bright_req_3.complete
op_logical_or
op_logical_neg
id|batt_req.complete
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Giveup the lazy FPU &amp; vec so we don&squot;t have to back them&n;&t; * up from the low level code&n;&t; */
id|enable_kernel_fp
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ALTIVEC
r_if
c_cond
(paren
id|cur_cpu_spec
(braket
l_int|0
)braket
op_member_access_from_pointer
id|cpu_features
op_amp
id|CPU_FTR_ALTIVEC
)paren
id|enable_kernel_altivec
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ALTIVEC */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|pmac_wakeup_devices
id|pmac_wakeup_devices
c_func
(paren
r_void
)paren
(brace
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* Power back up system devices (including the PIC) */
id|device_power_up
c_func
(paren
)paren
suffix:semicolon
id|pmu_blink
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Force a poll of ADB interrupts */
id|adb_int_pending
op_assign
l_int|1
suffix:semicolon
id|via_pmu_interrupt
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Restart jiffies &amp; scheduling */
id|wakeup_decrementer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Re-enable local CPU interrupts */
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
id|pmu_blink
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Resume devices */
id|device_resume
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Notify old style drivers */
id|broadcast_wake
c_func
(paren
)paren
suffix:semicolon
id|pm_restore_console
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|GRACKLE_PM
mdefine_line|#define&t;GRACKLE_PM&t;(1&lt;&lt;7)
DECL|macro|GRACKLE_DOZE
mdefine_line|#define GRACKLE_DOZE&t;(1&lt;&lt;5)
DECL|macro|GRACKLE_NAP
mdefine_line|#define&t;GRACKLE_NAP&t;(1&lt;&lt;4)
DECL|macro|GRACKLE_SLEEP
mdefine_line|#define&t;GRACKLE_SLEEP&t;(1&lt;&lt;3)
r_int
id|__pmac
DECL|function|powerbook_sleep_grackle
id|powerbook_sleep_grackle
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|save_l2cr
suffix:semicolon
r_int
r_int
id|pmcr1
suffix:semicolon
r_struct
id|adb_request
id|req
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_struct
id|pci_dev
op_star
id|grackle
suffix:semicolon
id|grackle
op_assign
id|pci_find_slot
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|grackle
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ret
op_assign
id|pmac_suspend_devices
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Sleep rejected by devices&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Turn off various things. Darwin does some retry tests here... */
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_POWER_CTRL0
comma
id|PMU_POW0_OFF
op_or
id|PMU_POW0_HARD_DRIVE
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_POWER_CTRL
comma
id|PMU_POW_OFF
op_or
id|PMU_POW_BACKLIGHT
op_or
id|PMU_POW_IRLED
op_or
id|PMU_POW_MEDIABAY
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
multiline_comment|/* For 750, save backside cache setting and disable it */
id|save_l2cr
op_assign
id|_get_L2CR
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (returns -1 if not available) */
r_if
c_cond
(paren
id|save_l2cr
op_ne
l_int|0xffffffff
op_logical_and
(paren
id|save_l2cr
op_amp
id|L2CR_L2E
)paren
op_ne
l_int|0
)paren
id|_set_L2CR
c_func
(paren
id|save_l2cr
op_amp
l_int|0x7fffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|__fake_sleep
)paren
(brace
multiline_comment|/* Ask the PMU to put us to sleep */
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|5
comma
id|PMU_SLEEP
comma
l_char|&squot;M&squot;
comma
l_char|&squot;A&squot;
comma
l_char|&squot;T&squot;
comma
l_char|&squot;T&squot;
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/* The VIA is supposed not to be restored correctly*/
id|save_via_state
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* We shut down some HW */
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_SLEEP_STATE
comma
l_int|NULL
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|grackle
comma
l_int|0x70
comma
op_amp
id|pmcr1
)paren
suffix:semicolon
multiline_comment|/* Apparently, MacOS uses NAP mode for Grackle ??? */
id|pmcr1
op_and_assign
op_complement
(paren
id|GRACKLE_DOZE
op_or
id|GRACKLE_SLEEP
)paren
suffix:semicolon
id|pmcr1
op_or_assign
id|GRACKLE_PM
op_or
id|GRACKLE_NAP
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|grackle
comma
l_int|0x70
comma
id|pmcr1
)paren
suffix:semicolon
multiline_comment|/* Call low-level ASM sleep handler */
r_if
c_cond
(paren
id|__fake_sleep
)paren
id|mdelay
c_func
(paren
l_int|5000
)paren
suffix:semicolon
r_else
id|low_sleep_handler
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* We&squot;re awake again, stop grackle PM */
id|pci_read_config_word
c_func
(paren
id|grackle
comma
l_int|0x70
comma
op_amp
id|pmcr1
)paren
suffix:semicolon
id|pmcr1
op_and_assign
op_complement
(paren
id|GRACKLE_PM
op_or
id|GRACKLE_DOZE
op_or
id|GRACKLE_SLEEP
op_or
id|GRACKLE_NAP
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|grackle
comma
l_int|0x70
comma
id|pmcr1
)paren
suffix:semicolon
multiline_comment|/* Make sure the PMU is idle */
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_SLEEP_STATE
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|restore_via_state
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Restore L2 cache */
r_if
c_cond
(paren
id|save_l2cr
op_ne
l_int|0xffffffff
op_logical_and
(paren
id|save_l2cr
op_amp
id|L2CR_L2E
)paren
op_ne
l_int|0
)paren
id|_set_L2CR
c_func
(paren
id|save_l2cr
)paren
suffix:semicolon
multiline_comment|/* Restore userland MMU context */
id|set_context
c_func
(paren
id|current-&gt;active_mm-&gt;context
comma
id|current-&gt;active_mm-&gt;pgd
)paren
suffix:semicolon
multiline_comment|/* Power things up */
id|pmu_unlock
c_func
(paren
)paren
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_SET_INTR_MASK
comma
id|pmu_intr_mask
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_POWER_CTRL0
comma
id|PMU_POW0_ON
op_or
id|PMU_POW0_HARD_DRIVE
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_POWER_CTRL
comma
id|PMU_POW_ON
op_or
id|PMU_POW_BACKLIGHT
op_or
id|PMU_POW_CHARGER
op_or
id|PMU_POW_IRLED
op_or
id|PMU_POW_MEDIABAY
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|pmac_wakeup_devices
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|powerbook_sleep_Core99
id|powerbook_sleep_Core99
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|save_l2cr
suffix:semicolon
r_int
r_int
id|save_l3cr
suffix:semicolon
r_struct
id|adb_request
id|req
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|can_sleep
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Sleep mode not supported on this machine&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
id|ret
op_assign
id|pmac_suspend_devices
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Sleep rejected by devices&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Tell PMU what events will wake us up */
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|4
comma
id|PMU_POWER_EVENTS
comma
id|PMU_PWR_CLR_WAKEUP_EVENTS
comma
l_int|0xff
comma
l_int|0xff
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|4
comma
id|PMU_POWER_EVENTS
comma
id|PMU_PWR_SET_WAKEUP_EVENTS
comma
l_int|0
comma
id|PMU_PWR_WAKEUP_KEY
op_or
(paren
id|option_lid_wakeup
ques
c_cond
id|PMU_PWR_WAKEUP_LID_OPEN
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
multiline_comment|/* Save &amp; disable L2 and L3 caches*/
id|save_l3cr
op_assign
id|_get_L3CR
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (returns -1 if not available) */
id|save_l2cr
op_assign
id|_get_L2CR
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* (returns -1 if not available) */
r_if
c_cond
(paren
id|save_l3cr
op_ne
l_int|0xffffffff
op_logical_and
(paren
id|save_l3cr
op_amp
id|L3CR_L3E
)paren
op_ne
l_int|0
)paren
id|_set_L3CR
c_func
(paren
id|save_l3cr
op_amp
l_int|0x7fffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|save_l2cr
op_ne
l_int|0xffffffff
op_logical_and
(paren
id|save_l2cr
op_amp
id|L2CR_L2E
)paren
op_ne
l_int|0
)paren
id|_set_L2CR
c_func
(paren
id|save_l2cr
op_amp
l_int|0x7fffffff
)paren
suffix:semicolon
multiline_comment|/* Save the state of PCI config space for some slots */
singleline_comment|//pbook_pci_save();
r_if
c_cond
(paren
op_logical_neg
id|__fake_sleep
)paren
(brace
multiline_comment|/* Ask the PMU to put us to sleep */
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|5
comma
id|PMU_SLEEP
comma
l_char|&squot;M&squot;
comma
l_char|&squot;A&squot;
comma
l_char|&squot;T&squot;
comma
l_char|&squot;T&squot;
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/* The VIA is supposed not to be restored correctly*/
id|save_via_state
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Shut down various ASICs. There&squot;s a chance that we can no longer&n;&t; * talk to the PMU after this, so I moved it to _after_ sending the&n;&t; * sleep command to it. Still need to be checked.&n;&t; */
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_SLEEP_STATE
comma
l_int|NULL
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Call low-level ASM sleep handler */
r_if
c_cond
(paren
id|__fake_sleep
)paren
id|mdelay
c_func
(paren
l_int|5000
)paren
suffix:semicolon
r_else
id|low_sleep_handler
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Restore Apple core ASICs state */
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_SLEEP_STATE
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Restore VIA */
id|restore_via_state
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Restore PCI config space. This should be overridable by PCI device&n;&t; * drivers as some of them may need special restore code. That&squot;s yet&n;&t; * another issue that should be handled by the common code properly,&n;&t; * maybe one day ?&n;&t; */
multiline_comment|/* Don&squot;t restore PCI for now, it crashes. Maybe unnecessary on pbook */
singleline_comment|//pbook_pci_restore();
multiline_comment|/* Restore L2 cache */
r_if
c_cond
(paren
id|save_l2cr
op_ne
l_int|0xffffffff
op_logical_and
(paren
id|save_l2cr
op_amp
id|L2CR_L2E
)paren
op_ne
l_int|0
)paren
id|_set_L2CR
c_func
(paren
id|save_l2cr
)paren
suffix:semicolon
multiline_comment|/* Restore L3 cache */
r_if
c_cond
(paren
id|save_l3cr
op_ne
l_int|0xffffffff
op_logical_and
(paren
id|save_l3cr
op_amp
id|L3CR_L3E
)paren
op_ne
l_int|0
)paren
id|_set_L3CR
c_func
(paren
id|save_l3cr
)paren
suffix:semicolon
multiline_comment|/* Restore userland MMU context */
id|set_context
c_func
(paren
id|current-&gt;active_mm-&gt;context
comma
id|current-&gt;active_mm-&gt;pgd
)paren
suffix:semicolon
multiline_comment|/* Tell PMU we are ready */
id|pmu_unlock
c_func
(paren
)paren
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_SYSTEM_READY
comma
l_int|2
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|pmu_request
c_func
(paren
op_amp
id|req
comma
l_int|NULL
comma
l_int|2
comma
id|PMU_SET_INTR_MASK
comma
id|pmu_intr_mask
)paren
suffix:semicolon
id|pmu_wait_complete
c_func
(paren
op_amp
id|req
)paren
suffix:semicolon
id|pmu_blink
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|pmac_wakeup_devices
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|PB3400_MEM_CTRL
mdefine_line|#define PB3400_MEM_CTRL&t;&t;0xf8000000
DECL|macro|PB3400_MEM_CTRL_SLEEP
mdefine_line|#define PB3400_MEM_CTRL_SLEEP&t;0x70
r_static
r_int
id|__pmac
DECL|function|powerbook_sleep_3400
id|powerbook_sleep_3400
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
comma
id|i
comma
id|x
suffix:semicolon
r_int
r_int
id|hid0
suffix:semicolon
r_int
r_int
id|p
suffix:semicolon
r_struct
id|adb_request
id|sleep_req
suffix:semicolon
r_char
op_star
id|mem_ctrl
suffix:semicolon
r_int
r_int
op_star
id|mem_ctrl_sleep
suffix:semicolon
multiline_comment|/* first map in the memory controller registers */
id|mem_ctrl
op_assign
id|ioremap
c_func
(paren
id|PB3400_MEM_CTRL
comma
l_int|0x100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem_ctrl
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;powerbook_sleep_3400: ioremap failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|mem_ctrl_sleep
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|mem_ctrl
op_plus
id|PB3400_MEM_CTRL_SLEEP
)paren
suffix:semicolon
multiline_comment|/* Allocate room for PCI save */
id|pbook_alloc_pci_save
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|pmac_suspend_devices
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|pbook_free_pci_save
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Sleep rejected by devices&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Save the state of PCI config space for some slots */
id|pbook_pci_save
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Set the memory controller to keep the memory refreshed&n;&t;   while we&squot;re asleep */
r_for
c_loop
(paren
id|i
op_assign
l_int|0x403f
suffix:semicolon
id|i
op_ge
l_int|0x4000
suffix:semicolon
op_decrement
id|i
)paren
(brace
id|out_be32
c_func
(paren
id|mem_ctrl_sleep
comma
id|i
)paren
suffix:semicolon
r_do
(brace
id|x
op_assign
(paren
id|in_be32
c_func
(paren
id|mem_ctrl_sleep
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x3ff
suffix:semicolon
)brace
r_while
c_loop
(paren
id|x
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x
op_ge
l_int|0x100
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Ask the PMU to put us to sleep */
id|pmu_request
c_func
(paren
op_amp
id|sleep_req
comma
l_int|NULL
comma
l_int|5
comma
id|PMU_SLEEP
comma
l_char|&squot;M&squot;
comma
l_char|&squot;A&squot;
comma
l_char|&squot;T&squot;
comma
l_char|&squot;T&squot;
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|sleep_req.complete
)paren
id|mb
c_func
(paren
)paren
suffix:semicolon
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_SLEEP_STATE
comma
l_int|NULL
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* displacement-flush the L2 cache - necessary? */
r_for
c_loop
(paren
id|p
op_assign
id|KERNELBASE
suffix:semicolon
id|p
OL
id|KERNELBASE
op_plus
l_int|0x100000
suffix:semicolon
id|p
op_add_assign
l_int|0x1000
)paren
id|i
op_assign
op_star
(paren
r_volatile
r_int
op_star
)paren
id|p
suffix:semicolon
id|asleep
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Put the CPU into sleep mode */
id|asm
r_volatile
(paren
l_string|&quot;mfspr %0,1008&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|hid0
)paren
suffix:colon
)paren
suffix:semicolon
id|hid0
op_assign
(paren
id|hid0
op_amp
op_complement
(paren
id|HID0_NAP
op_or
id|HID0_DOZE
)paren
)paren
op_or
id|HID0_SLEEP
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;mtspr 1008,%0&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|hid0
)paren
)paren
suffix:semicolon
id|_nmask_and_or_msr
c_func
(paren
l_int|0
comma
id|MSR_POW
op_or
id|MSR_EE
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* OK, we&squot;re awake again, start restoring things */
id|out_be32
c_func
(paren
id|mem_ctrl_sleep
comma
l_int|0x3f
)paren
suffix:semicolon
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_SLEEP_STATE
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|pbook_pci_restore
c_func
(paren
)paren
suffix:semicolon
id|pmu_unlock
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wait for the PMU interrupt sequence to complete */
r_while
c_loop
(paren
id|asleep
)paren
id|mb
c_func
(paren
)paren
suffix:semicolon
id|pmac_wakeup_devices
c_func
(paren
)paren
suffix:semicolon
id|pbook_free_pci_save
c_func
(paren
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|mem_ctrl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Support for /dev/pmu device&n; */
DECL|macro|RB_SIZE
mdefine_line|#define RB_SIZE&t;&t;0x10
DECL|struct|pmu_private
r_struct
id|pmu_private
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|rb_get
r_int
id|rb_get
suffix:semicolon
DECL|member|rb_put
r_int
id|rb_put
suffix:semicolon
DECL|struct|rb_entry
r_struct
id|rb_entry
(brace
DECL|member|len
r_int
r_int
id|len
suffix:semicolon
DECL|member|data
r_int
r_char
id|data
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|rb_buf
)brace
id|rb_buf
(braket
id|RB_SIZE
)braket
suffix:semicolon
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
macro_line|#if defined(CONFIG_INPUT_ADBHID) &amp;&amp; defined(CONFIG_PMAC_BACKLIGHT)
DECL|member|backlight_locker
r_int
id|backlight_locker
suffix:semicolon
macro_line|#endif /* defined(CONFIG_INPUT_ADBHID) &amp;&amp; defined(CONFIG_PMAC_BACKLIGHT) */&t;
)brace
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|all_pmu_pvt
)paren
suffix:semicolon
DECL|variable|__pmacdata
r_static
id|spinlock_t
id|all_pvt_lock
id|__pmacdata
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_static
r_void
id|__pmac
DECL|function|pmu_pass_intr
id|pmu_pass_intr
c_func
(paren
r_int
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_struct
id|pmu_private
op_star
id|pp
suffix:semicolon
r_struct
id|list_head
op_star
id|list
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
r_sizeof
(paren
id|pp-&gt;rb_buf
(braket
l_int|0
)braket
dot
id|data
)paren
)paren
id|len
op_assign
r_sizeof
(paren
id|pp-&gt;rb_buf
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|all_pvt_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|list
op_assign
op_amp
id|all_pmu_pvt
suffix:semicolon
(paren
id|list
op_assign
id|list-&gt;next
)paren
op_ne
op_amp
id|all_pmu_pvt
suffix:semicolon
)paren
(brace
id|pp
op_assign
id|list_entry
c_func
(paren
id|list
comma
r_struct
id|pmu_private
comma
id|list
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pp-&gt;lock
)paren
suffix:semicolon
id|i
op_assign
id|pp-&gt;rb_put
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|RB_SIZE
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|pp-&gt;rb_get
)paren
(brace
r_struct
id|rb_entry
op_star
id|rp
op_assign
op_amp
id|pp-&gt;rb_buf
(braket
id|pp-&gt;rb_put
)braket
suffix:semicolon
id|rp-&gt;len
op_assign
id|len
suffix:semicolon
id|memcpy
c_func
(paren
id|rp-&gt;data
comma
id|data
comma
id|len
)paren
suffix:semicolon
id|pp-&gt;rb_put
op_assign
id|i
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|pp-&gt;wait
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|pp-&gt;lock
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|all_pvt_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|pmu_open
id|pmu_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|pmu_private
op_star
id|pp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|pp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pmu_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pp
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|pp-&gt;rb_get
op_assign
id|pp-&gt;rb_put
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|pp-&gt;lock
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|pp-&gt;wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|all_pvt_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_INPUT_ADBHID) &amp;&amp; defined(CONFIG_PMAC_BACKLIGHT)
id|pp-&gt;backlight_locker
op_assign
l_int|0
suffix:semicolon
macro_line|#endif /* defined(CONFIG_INPUT_ADBHID) &amp;&amp; defined(CONFIG_PMAC_BACKLIGHT) */&t;
id|list_add
c_func
(paren
op_amp
id|pp-&gt;list
comma
op_amp
id|all_pmu_pvt
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|all_pvt_lock
comma
id|flags
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|pp
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|ssize_t
id|__pmac
DECL|function|pmu_read
id|pmu_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|pmu_private
op_star
id|pp
op_assign
id|file-&gt;private_data
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|1
op_logical_or
id|pp
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ret
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|pp-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|pp-&gt;rb_get
op_ne
id|pp-&gt;rb_put
)paren
(brace
r_int
id|i
op_assign
id|pp-&gt;rb_get
suffix:semicolon
r_struct
id|rb_entry
op_star
id|rp
op_assign
op_amp
id|pp-&gt;rb_buf
(braket
id|i
)braket
suffix:semicolon
id|ret
op_assign
id|rp-&gt;len
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OG
id|count
)paren
id|ret
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|ret
OG
l_int|0
op_logical_and
id|copy_to_user
c_func
(paren
id|buf
comma
id|rp-&gt;data
comma
id|ret
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|RB_SIZE
)paren
id|i
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|pp-&gt;rb_get
op_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_ge
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_break
suffix:semicolon
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|pp-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
id|ssize_t
id|__pmac
DECL|function|pmu_write
id|pmu_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
r_int
id|__pmac
DECL|function|pmu_fpoll
id|pmu_fpoll
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|pmu_private
op_star
id|pp
op_assign
id|filp-&gt;private_data
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|pp
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|poll_wait
c_func
(paren
id|filp
comma
op_amp
id|pp-&gt;wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pp-&gt;rb_get
op_ne
id|pp-&gt;rb_put
)paren
id|mask
op_or_assign
id|POLLIN
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
r_static
r_int
id|__pmac
DECL|function|pmu_release
id|pmu_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|pmu_private
op_star
id|pp
op_assign
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pp
op_ne
l_int|0
)paren
(brace
id|file-&gt;private_data
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|all_pvt_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|pp-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|all_pvt_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_INPUT_ADBHID) &amp;&amp; defined(CONFIG_PMAC_BACKLIGHT)
r_if
c_cond
(paren
id|pp-&gt;backlight_locker
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
id|disable_kernel_backlight
op_decrement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif /* defined(CONFIG_INPUT_ADBHID) &amp;&amp; defined(CONFIG_PMAC_BACKLIGHT) */
id|kfree
c_func
(paren
id|pp
)paren
suffix:semicolon
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Note: removed __openfirmware here since it causes link errors */
r_static
r_int
id|__pmac
DECL|function|pmu_ioctl
id|pmu_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
)paren
(brace
r_struct
id|pmu_private
op_star
id|pp
op_assign
id|filp-&gt;private_data
suffix:semicolon
r_int
id|error
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|PMU_IOC_SLEEP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|sleep_in_progress
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|sleep_in_progress
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|pmu_kind
)paren
(brace
r_case
id|PMU_OHARE_BASED
suffix:colon
id|error
op_assign
id|powerbook_sleep_3400
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PMU_HEATHROW_BASED
suffix:colon
r_case
id|PMU_PADDINGTON_BASED
suffix:colon
id|error
op_assign
id|powerbook_sleep_grackle
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PMU_KEYLARGO_BASED
suffix:colon
id|error
op_assign
id|powerbook_sleep_Core99
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|error
op_assign
op_minus
id|ENOSYS
suffix:semicolon
)brace
id|sleep_in_progress
op_assign
l_int|0
suffix:semicolon
r_return
id|error
suffix:semicolon
r_case
id|PMU_IOC_CAN_SLEEP
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|u32
)paren
id|can_sleep
comma
(paren
id|__u32
op_star
)paren
id|arg
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
multiline_comment|/* Backlight should have its own device or go via&n;&t; * the fbdev&n;&t; */
r_case
id|PMU_IOC_GET_BACKLIGHT
suffix:colon
r_if
c_cond
(paren
id|sleep_in_progress
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|error
op_assign
id|get_backlight_level
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_return
id|error
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|error
comma
(paren
id|__u32
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|PMU_IOC_SET_BACKLIGHT
suffix:colon
(brace
id|__u32
id|value
suffix:semicolon
r_if
c_cond
(paren
id|sleep_in_progress
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|error
op_assign
id|get_user
c_func
(paren
id|value
comma
(paren
id|__u32
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|error
op_assign
id|set_backlight_level
c_func
(paren
id|value
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_INPUT_ADBHID
r_case
id|PMU_IOC_GRAB_BACKLIGHT
suffix:colon
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|pp-&gt;backlight_locker
)paren
r_return
l_int|0
suffix:semicolon
id|pp-&gt;backlight_locker
op_assign
l_int|1
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
id|disable_kernel_backlight
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pmu_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_INPUT_ADBHID */
macro_line|#endif /* CONFIG_PMAC_BACKLIGHT */
r_case
id|PMU_IOC_GET_MODEL
suffix:colon
r_return
id|put_user
c_func
(paren
id|pmu_kind
comma
(paren
id|__u32
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|PMU_IOC_HAS_ADB
suffix:colon
r_return
id|put_user
c_func
(paren
id|pmu_has_adb
comma
(paren
id|__u32
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|__pmacdata
r_static
r_struct
id|file_operations
id|pmu_device_fops
id|__pmacdata
op_assign
(brace
dot
id|read
op_assign
id|pmu_read
comma
dot
id|write
op_assign
id|pmu_write
comma
dot
id|poll
op_assign
id|pmu_fpoll
comma
dot
id|ioctl
op_assign
id|pmu_ioctl
comma
dot
id|open
op_assign
id|pmu_open
comma
dot
id|release
op_assign
id|pmu_release
comma
)brace
suffix:semicolon
DECL|variable|__pmacdata
r_static
r_struct
id|miscdevice
id|pmu_device
id|__pmacdata
op_assign
(brace
id|PMU_MINOR
comma
l_string|&quot;pmu&quot;
comma
op_amp
id|pmu_device_fops
)brace
suffix:semicolon
DECL|function|pmu_device_init
r_void
id|pmu_device_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|via
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|misc_register
c_func
(paren
op_amp
id|pmu_device
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;via-pmu: cannot register misc device.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PMAC_PBOOK */
macro_line|#ifdef DEBUG_SLEEP
r_static
r_inline
r_void
id|__pmac
DECL|function|polled_handshake
id|polled_handshake
c_func
(paren
r_volatile
r_int
r_char
op_star
id|via
)paren
(brace
id|via
(braket
id|B
)braket
op_and_assign
op_complement
id|TREQ
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|via
(braket
id|B
)braket
op_amp
id|TACK
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|via
(braket
id|B
)braket
op_or_assign
id|TREQ
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|via
(braket
id|B
)braket
op_amp
id|TACK
)paren
op_eq
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
id|__pmac
DECL|function|polled_send_byte
id|polled_send_byte
c_func
(paren
r_volatile
r_int
r_char
op_star
id|via
comma
r_int
id|x
)paren
(brace
id|via
(braket
id|ACR
)braket
op_or_assign
id|SR_OUT
op_or
id|SR_EXT
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|via
(braket
id|SR
)braket
op_assign
id|x
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|polled_handshake
c_func
(paren
id|via
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
id|__pmac
DECL|function|polled_recv_byte
id|polled_recv_byte
c_func
(paren
r_volatile
r_int
r_char
op_star
id|via
)paren
(brace
r_int
id|x
suffix:semicolon
id|via
(braket
id|ACR
)braket
op_assign
(paren
id|via
(braket
id|ACR
)braket
op_amp
op_complement
id|SR_OUT
)paren
op_or
id|SR_EXT
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|x
op_assign
id|via
(braket
id|SR
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
id|polled_handshake
c_func
(paren
id|via
)paren
suffix:semicolon
id|x
op_assign
id|via
(braket
id|SR
)braket
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_return
id|x
suffix:semicolon
)brace
r_int
id|__pmac
DECL|function|pmu_polled_request
id|pmu_polled_request
c_func
(paren
r_struct
id|adb_request
op_star
id|req
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|l
comma
id|c
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|v
op_assign
id|via
suffix:semicolon
id|req-&gt;complete
op_assign
l_int|1
suffix:semicolon
id|c
op_assign
id|req-&gt;data
(braket
l_int|0
)braket
suffix:semicolon
id|l
op_assign
id|pmu_data_len
(braket
id|c
)braket
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|l
op_ge
l_int|0
op_logical_and
id|req-&gt;nbytes
op_ne
id|l
op_plus
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pmu_state
op_ne
id|idle
)paren
id|pmu_poll
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|via
(braket
id|B
)braket
op_amp
id|TACK
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|polled_send_byte
c_func
(paren
id|v
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l
OL
l_int|0
)paren
(brace
id|l
op_assign
id|req-&gt;nbytes
op_minus
l_int|1
suffix:semicolon
id|polled_send_byte
c_func
(paren
id|v
comma
id|l
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|l
suffix:semicolon
op_increment
id|i
)paren
id|polled_send_byte
c_func
(paren
id|v
comma
id|req-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
id|l
op_assign
id|pmu_data_len
(braket
id|c
)braket
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|l
OL
l_int|0
)paren
id|l
op_assign
id|polled_recv_byte
c_func
(paren
id|v
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|l
suffix:semicolon
op_increment
id|i
)paren
id|req-&gt;reply
(braket
id|i
op_plus
id|req-&gt;reply_len
)braket
op_assign
id|polled_recv_byte
c_func
(paren
id|v
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;done
)paren
(paren
op_star
id|req-&gt;done
)paren
(paren
id|req
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* DEBUG_SLEEP */
DECL|variable|pmu_request
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_request
)paren
suffix:semicolon
DECL|variable|pmu_poll
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_poll
)paren
suffix:semicolon
DECL|variable|pmu_poll_adb
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_poll_adb
)paren
suffix:semicolon
DECL|variable|pmu_wait_complete
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_wait_complete
)paren
suffix:semicolon
DECL|variable|pmu_suspend
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_suspend
)paren
suffix:semicolon
DECL|variable|pmu_resume
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_resume
)paren
suffix:semicolon
DECL|variable|pmu_unlock
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_unlock
)paren
suffix:semicolon
DECL|variable|pmu_i2c_combined_read
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_i2c_combined_read
)paren
suffix:semicolon
DECL|variable|pmu_i2c_stdsub_write
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_i2c_stdsub_write
)paren
suffix:semicolon
DECL|variable|pmu_i2c_simple_read
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_i2c_simple_read
)paren
suffix:semicolon
DECL|variable|pmu_i2c_simple_write
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_i2c_simple_write
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
DECL|variable|pmu_register_sleep_notifier
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_register_sleep_notifier
)paren
suffix:semicolon
DECL|variable|pmu_unregister_sleep_notifier
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_unregister_sleep_notifier
)paren
suffix:semicolon
DECL|variable|pmu_enable_irled
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_enable_irled
)paren
suffix:semicolon
DECL|variable|pmu_battery_count
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_battery_count
)paren
suffix:semicolon
DECL|variable|pmu_batteries
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_batteries
)paren
suffix:semicolon
DECL|variable|pmu_power_flags
id|EXPORT_SYMBOL
c_func
(paren
id|pmu_power_flags
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
eof
