multiline_comment|/* &n; *   Creation Date: &lt;2003/03/14 20:54:13 samuel&gt;&n; *   Time-stamp: &lt;2004/03/20 14:20:59 samuel&gt;&n; *   &n; *&t;&lt;therm_windtunnel.c&gt;&n; *&t;&n; *&t;The G4 &quot;windtunnel&quot; has a single fan controlled by an&n; *&t;ADM1030 fan controller and a DS1775 thermostat.&n; *&n; *&t;The fan controller is equipped with a temperature sensor&n; *&t;which measures the case temperature. The DS1775 sensor&n; *&t;measures the CPU temperature. This driver tunes the&n; *&t;behavior of the fan. It is based upon empirical observations&n; *&t;of the &squot;AppleFan&squot; driver under Mac OS X.&n; *&n; *&t;WARNING: This driver has only been testen on Apple&squot;s&n; *&t;1.25 MHz Dual G4 (March 03). It is tuned for a CPU&n; *&t;temperatur around 57 C.&n; *&n; *   Copyright (C) 2003, 2004 Samuel Rydh (samuel@ibrium.se)&n; *&n; *   Loosely based upon &squot;thermostat.c&squot; written by Benjamin Herrenschmidt&n; *   &n; *   This program is free software; you can redistribute it and/or&n; *   modify it under the terms of the GNU General Public License&n; *   as published by the Free Software Foundation&n; *   &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/sections.h&gt;
macro_line|#include &lt;asm/of_device.h&gt;
DECL|macro|LOG_TEMP
mdefine_line|#define LOG_TEMP&t;&t;0&t;&t;&t;/* continously log temperature */
DECL|macro|I2C_DRIVERID_G4FAN
mdefine_line|#define I2C_DRIVERID_G4FAN&t;0x9001&t;&t;&t;/* fixme */
DECL|macro|THERMOSTAT_CLIENT_ID
mdefine_line|#define THERMOSTAT_CLIENT_ID&t;1
DECL|macro|FAN_CLIENT_ID
mdefine_line|#define FAN_CLIENT_ID&t;&t;2
r_static
r_int
id|do_probe
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|addr
comma
r_int
id|kind
)paren
suffix:semicolon
multiline_comment|/* scan 0x48-0x4f (DS1775) and 0x2c-2x2f (ADM1030) */
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
l_int|0x49
comma
l_int|0x2c
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_i2c_range
r_static
r_int
r_int
id|normal_i2c_range
(braket
)braket
op_assign
(brace
l_int|0x48
comma
l_int|0x4f
comma
l_int|0x2c
comma
l_int|0x2f
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
id|I2C_CLIENT_INSMOD
suffix:semicolon
r_static
r_struct
(brace
DECL|member|running
r_volatile
r_int
id|running
suffix:semicolon
DECL|member|completion
r_struct
id|completion
id|completion
suffix:semicolon
DECL|member|poll_task
id|pid_t
id|poll_task
suffix:semicolon
DECL|member|lock
r_struct
id|semaphore
id|lock
suffix:semicolon
DECL|member|of_dev
r_struct
id|of_device
op_star
id|of_dev
suffix:semicolon
DECL|member|thermostat
r_struct
id|i2c_client
op_star
id|thermostat
suffix:semicolon
DECL|member|fan
r_struct
id|i2c_client
op_star
id|fan
suffix:semicolon
DECL|member|overheat_temp
r_int
id|overheat_temp
suffix:semicolon
multiline_comment|/* 100% fan at this temp */
DECL|member|overheat_hyst
r_int
id|overheat_hyst
suffix:semicolon
DECL|member|temp
r_int
id|temp
suffix:semicolon
DECL|member|casetemp
r_int
id|casetemp
suffix:semicolon
DECL|member|fan_level
r_int
id|fan_level
suffix:semicolon
multiline_comment|/* active fan_table setting */
DECL|member|downind
r_int
id|downind
suffix:semicolon
DECL|member|upind
r_int
id|upind
suffix:semicolon
DECL|member|r0
DECL|member|r1
DECL|member|r20
DECL|member|r23
DECL|member|r25
r_int
id|r0
comma
id|r1
comma
id|r20
comma
id|r23
comma
id|r25
suffix:semicolon
multiline_comment|/* saved register */
DECL|variable|x
)brace
id|x
suffix:semicolon
DECL|macro|T
mdefine_line|#define T(x,y)&t;&t;&t;(((x)&lt;&lt;8) | (y)*0x100/10 )
r_static
r_struct
(brace
DECL|member|fan_down_setting
r_int
id|fan_down_setting
suffix:semicolon
DECL|member|temp
r_int
id|temp
suffix:semicolon
DECL|member|fan_up_setting
r_int
id|fan_up_setting
suffix:semicolon
DECL|variable|fan_table
)brace
id|fan_table
(braket
)braket
op_assign
(brace
(brace
l_int|11
comma
id|T
c_func
(paren
l_int|0
comma
l_int|0
)paren
comma
l_int|11
)brace
comma
multiline_comment|/* min fan */
(brace
l_int|11
comma
id|T
c_func
(paren
l_int|55
comma
l_int|0
)paren
comma
l_int|11
)brace
comma
(brace
l_int|6
comma
id|T
c_func
(paren
l_int|55
comma
l_int|3
)paren
comma
l_int|11
)brace
comma
(brace
l_int|7
comma
id|T
c_func
(paren
l_int|56
comma
l_int|0
)paren
comma
l_int|11
)brace
comma
(brace
l_int|8
comma
id|T
c_func
(paren
l_int|57
comma
l_int|0
)paren
comma
l_int|8
)brace
comma
(brace
l_int|7
comma
id|T
c_func
(paren
l_int|58
comma
l_int|3
)paren
comma
l_int|7
)brace
comma
(brace
l_int|6
comma
id|T
c_func
(paren
l_int|58
comma
l_int|8
)paren
comma
l_int|6
)brace
comma
(brace
l_int|5
comma
id|T
c_func
(paren
l_int|59
comma
l_int|2
)paren
comma
l_int|5
)brace
comma
(brace
l_int|4
comma
id|T
c_func
(paren
l_int|59
comma
l_int|6
)paren
comma
l_int|4
)brace
comma
(brace
l_int|3
comma
id|T
c_func
(paren
l_int|59
comma
l_int|9
)paren
comma
l_int|3
)brace
comma
(brace
l_int|2
comma
id|T
c_func
(paren
l_int|60
comma
l_int|1
)paren
comma
l_int|2
)brace
comma
(brace
l_int|1
comma
l_int|0xfffff
comma
l_int|1
)brace
multiline_comment|/* on fire */
)brace
suffix:semicolon
r_static
r_void
DECL|function|print_temp
id|print_temp
c_func
(paren
r_const
r_char
op_star
id|s
comma
r_int
id|temp
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s%d.%d C&quot;
comma
id|s
ques
c_cond
id|s
suffix:colon
l_string|&quot;&quot;
comma
id|temp
op_rshift
l_int|8
comma
(paren
id|temp
op_amp
l_int|255
)paren
op_star
l_int|10
op_div
l_int|256
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|show_cpu_temperature
id|show_cpu_temperature
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d.%d&bslash;n&quot;
comma
id|x.temp
op_rshift
l_int|8
comma
(paren
id|x.temp
op_amp
l_int|255
)paren
op_star
l_int|10
op_div
l_int|256
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|show_case_temperature
id|show_case_temperature
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d.%d&bslash;n&quot;
comma
id|x.casetemp
op_rshift
l_int|8
comma
(paren
id|x.casetemp
op_amp
l_int|255
)paren
op_star
l_int|10
op_div
l_int|256
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|cpu_temperature
comma
id|S_IRUGO
comma
id|show_cpu_temperature
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|case_temperature
comma
id|S_IRUGO
comma
id|show_case_temperature
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/************************************************************************/
multiline_comment|/*&t;controller thread&t;&t;&t;&t;&t;&t;*/
multiline_comment|/************************************************************************/
r_static
r_int
DECL|function|write_reg
id|write_reg
c_func
(paren
r_struct
id|i2c_client
op_star
id|cl
comma
r_int
id|reg
comma
r_int
id|data
comma
r_int
id|len
)paren
(brace
id|u8
id|tmp
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
template_param
l_int|2
op_logical_or
id|data
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|tmp
(braket
l_int|0
)braket
op_assign
id|reg
suffix:semicolon
id|tmp
(braket
l_int|1
)braket
op_assign
(paren
id|len
op_eq
l_int|1
)paren
ques
c_cond
id|data
suffix:colon
(paren
id|data
op_rshift
l_int|8
)paren
suffix:semicolon
id|tmp
(braket
l_int|2
)braket
op_assign
id|data
suffix:semicolon
id|len
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i2c_master_send
c_func
(paren
id|cl
comma
id|tmp
comma
id|len
)paren
op_ne
id|len
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_reg
id|read_reg
c_func
(paren
r_struct
id|i2c_client
op_star
id|cl
comma
r_int
id|reg
comma
r_int
id|len
)paren
(brace
id|u8
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|1
op_logical_and
id|len
op_ne
l_int|2
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf
(braket
l_int|0
)braket
op_assign
id|reg
suffix:semicolon
r_if
c_cond
(paren
id|i2c_master_send
c_func
(paren
id|cl
comma
id|buf
comma
l_int|1
)paren
op_ne
l_int|1
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2c_master_recv
c_func
(paren
id|cl
comma
id|buf
comma
id|len
)paren
op_ne
id|len
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
(paren
id|len
op_eq
l_int|2
)paren
ques
c_cond
(paren
(paren
r_int
r_int
)paren
id|buf
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|buf
(braket
l_int|1
)braket
suffix:colon
id|buf
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_static
r_void
DECL|function|tune_fan
id|tune_fan
c_func
(paren
r_int
id|fan_setting
)paren
(brace
r_int
id|val
op_assign
(paren
id|fan_setting
op_lshift
l_int|3
)paren
op_or
l_int|7
suffix:semicolon
multiline_comment|/* write_reg( x.fan, 0x24, val, 1 ); */
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x25
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x20
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;CPU-temp: &quot;
comma
id|x.temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x.casetemp
)paren
(brace
id|print_temp
c_func
(paren
l_string|&quot;, Case: &quot;
comma
id|x.casetemp
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;,  Fan: %d (tuned %+d)&bslash;n&quot;
comma
l_int|11
op_minus
id|fan_setting
comma
id|x.fan_level
op_minus
id|fan_setting
)paren
suffix:semicolon
id|x.fan_level
op_assign
id|fan_setting
suffix:semicolon
)brace
r_static
r_void
DECL|function|poll_temp
id|poll_temp
c_func
(paren
r_void
)paren
(brace
r_int
id|temp
comma
id|i
comma
id|level
comma
id|casetemp
suffix:semicolon
id|temp
op_assign
id|read_reg
c_func
(paren
id|x.thermostat
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* this actually occurs when the computer is loaded */
r_if
c_cond
(paren
id|temp
OL
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
id|casetemp
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x0b
comma
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|casetemp
op_or_assign
(paren
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x06
comma
l_int|1
)paren
op_amp
l_int|0x7
)paren
op_lshift
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|LOG_TEMP
op_logical_and
id|x.temp
op_ne
id|temp
)paren
(brace
id|print_temp
c_func
(paren
l_string|&quot;CPU-temp: &quot;
comma
id|temp
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;, Case: &quot;
comma
id|casetemp
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;,  Fan: %d&bslash;n&quot;
comma
l_int|11
op_minus
id|x.fan_level
)paren
suffix:semicolon
)brace
id|x.temp
op_assign
id|temp
suffix:semicolon
id|x.casetemp
op_assign
id|casetemp
suffix:semicolon
id|level
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|temp
op_amp
l_int|0xffff
)paren
OG
id|fan_table
(braket
id|i
)braket
dot
id|temp
suffix:semicolon
id|i
op_increment
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|x.downind
)paren
(brace
id|level
op_assign
id|fan_table
(braket
id|i
)braket
dot
id|fan_down_setting
suffix:semicolon
)brace
id|x.downind
op_assign
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|temp
op_amp
l_int|0xffff
)paren
op_ge
id|fan_table
(braket
id|i
op_plus
l_int|1
)braket
dot
id|temp
suffix:semicolon
id|i
op_increment
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x.upind
OL
id|i
)paren
(brace
id|level
op_assign
id|fan_table
(braket
id|i
)braket
dot
id|fan_up_setting
suffix:semicolon
)brace
id|x.upind
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|level
op_ge
l_int|0
)paren
(brace
id|tune_fan
c_func
(paren
id|level
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|setup_hardware
id|setup_hardware
c_func
(paren
r_void
)paren
(brace
r_int
id|val
suffix:semicolon
multiline_comment|/* save registers (if we unload the module) */
id|x.r0
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x00
comma
l_int|1
)paren
suffix:semicolon
id|x.r1
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x01
comma
l_int|1
)paren
suffix:semicolon
id|x.r20
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x20
comma
l_int|1
)paren
suffix:semicolon
id|x.r23
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x23
comma
l_int|1
)paren
suffix:semicolon
id|x.r25
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x25
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* improve measurement resolution (convergence time 1.5s) */
r_if
c_cond
(paren
(paren
id|val
op_assign
id|read_reg
c_func
(paren
id|x.thermostat
comma
l_int|1
comma
l_int|1
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|val
op_or_assign
l_int|0x60
suffix:semicolon
r_if
c_cond
(paren
id|write_reg
c_func
(paren
id|x.thermostat
comma
l_int|1
comma
id|val
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed writing config register&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* disable interrupts and TAC input */
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* enable filter */
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x23
comma
l_int|0x91
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* remote temp. controls fan */
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x00
comma
l_int|0x95
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* The thermostat (which besides measureing temperature controls&n;&t; * has a THERM output which puts the fan on 100%) is usually&n;&t; * set to kick in at 80 C (chip default). We reduce this a bit&n;&t; * to be on the safe side (OSX doesn&squot;t)...&n;&t; */
r_if
c_cond
(paren
id|x.overheat_temp
op_eq
(paren
l_int|80
op_lshift
l_int|8
)paren
)paren
(brace
id|x.overheat_temp
op_assign
l_int|65
op_lshift
l_int|8
suffix:semicolon
id|x.overheat_hyst
op_assign
l_int|60
op_lshift
l_int|8
suffix:semicolon
id|write_reg
c_func
(paren
id|x.thermostat
comma
l_int|2
comma
id|x.overheat_hyst
comma
l_int|2
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.thermostat
comma
l_int|3
comma
id|x.overheat_temp
comma
l_int|2
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;Reducing overheating limit to &quot;
comma
id|x.overheat_temp
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot; (Hyst: &quot;
comma
id|x.overheat_hyst
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* set an initial fan setting */
id|x.downind
op_assign
l_int|0xffff
suffix:semicolon
id|x.upind
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* tune_fan( fan_up_table[x.upind].fan_setting ); */
id|device_create_file
c_func
(paren
op_amp
id|x.of_dev-&gt;dev
comma
op_amp
id|dev_attr_cpu_temperature
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|x.of_dev-&gt;dev
comma
op_amp
id|dev_attr_case_temperature
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|restore_regs
id|restore_regs
c_func
(paren
r_void
)paren
(brace
id|device_remove_file
c_func
(paren
op_amp
id|x.of_dev-&gt;dev
comma
op_amp
id|dev_attr_cpu_temperature
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|x.of_dev-&gt;dev
comma
op_amp
id|dev_attr_case_temperature
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x01
comma
id|x.r1
comma
l_int|1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x20
comma
id|x.r20
comma
l_int|1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x23
comma
id|x.r23
comma
l_int|1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x25
comma
id|x.r25
comma
l_int|1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x00
comma
id|x.r0
comma
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|control_loop
id|control_loop
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
id|daemonize
c_func
(paren
l_string|&quot;g4fand&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|x.lock
)paren
suffix:semicolon
id|setup_hardware
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|x.running
)paren
(brace
id|up
c_func
(paren
op_amp
id|x.lock
)paren
suffix:semicolon
id|msleep_interruptible
c_func
(paren
l_int|8000
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|x.lock
)paren
suffix:semicolon
id|poll_temp
c_func
(paren
)paren
suffix:semicolon
)brace
id|restore_regs
c_func
(paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|x.lock
)paren
suffix:semicolon
id|complete_and_exit
c_func
(paren
op_amp
id|x.completion
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/*&t;i2c probing and setup&t;&t;&t;&t;&t;&t;*/
multiline_comment|/************************************************************************/
r_static
r_int
DECL|function|do_attach
id|do_attach
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|adapter-&gt;name
comma
l_string|&quot;uni-n&quot;
comma
l_int|5
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|x.running
)paren
(brace
id|ret
op_assign
id|i2c_probe
c_func
(paren
id|adapter
comma
op_amp
id|addr_data
comma
op_amp
id|do_probe
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x.thermostat
op_logical_and
id|x.fan
)paren
(brace
id|x.running
op_assign
l_int|1
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|x.completion
)paren
suffix:semicolon
id|x.poll_task
op_assign
id|kernel_thread
c_func
(paren
id|control_loop
comma
l_int|NULL
comma
id|SIGCHLD
op_or
id|CLONE_KERNEL
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|do_detach
id|do_detach
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|i2c_detach_client
c_func
(paren
id|client
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;failed to detach thermostat client&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|x.running
)paren
(brace
id|x.running
op_assign
l_int|0
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|x.completion
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|client
op_eq
id|x.thermostat
)paren
(brace
id|x.thermostat
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|client
op_eq
id|x.fan
)paren
(brace
id|x.fan
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;g4fan: bad client&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|variable|g4fan_driver
r_static
r_struct
id|i2c_driver
id|g4fan_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Apple G4 Thermostat/Fan&quot;
comma
dot
id|id
op_assign
id|I2C_DRIVERID_G4FAN
comma
dot
id|flags
op_assign
id|I2C_DF_NOTIFY
comma
dot
id|attach_adapter
op_assign
op_amp
id|do_attach
comma
dot
id|detach_client
op_assign
op_amp
id|do_detach
comma
dot
id|command
op_assign
l_int|NULL
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|attach_fan
id|attach_fan
c_func
(paren
r_struct
id|i2c_client
op_star
id|cl
)paren
(brace
r_if
c_cond
(paren
id|x.fan
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* check that this is an ADM1030 */
r_if
c_cond
(paren
id|read_reg
c_func
(paren
id|cl
comma
l_int|0x3d
comma
l_int|1
)paren
op_ne
l_int|0x30
op_logical_or
id|read_reg
c_func
(paren
id|cl
comma
l_int|0x3e
comma
l_int|1
)paren
op_ne
l_int|0x41
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;ADM1030 fan controller [@%02x]&bslash;n&quot;
comma
id|cl-&gt;addr
)paren
suffix:semicolon
id|cl-&gt;id
op_assign
id|FAN_CLIENT_ID
suffix:semicolon
id|strlcpy
c_func
(paren
id|cl-&gt;name
comma
l_string|&quot;ADM1030 fan controller&quot;
comma
r_sizeof
(paren
id|cl-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i2c_attach_client
c_func
(paren
id|cl
)paren
)paren
(brace
id|x.fan
op_assign
id|cl
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|cl
op_ne
id|x.fan
)paren
(brace
id|kfree
c_func
(paren
id|cl
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|attach_thermostat
id|attach_thermostat
c_func
(paren
r_struct
id|i2c_client
op_star
id|cl
)paren
(brace
r_int
id|hyst_temp
comma
id|os_temp
comma
id|temp
suffix:semicolon
r_if
c_cond
(paren
id|x.thermostat
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|temp
op_assign
id|read_reg
c_func
(paren
id|cl
comma
l_int|0
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* temperature sanity check */
r_if
c_cond
(paren
id|temp
template_param
l_int|0x3c00
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|hyst_temp
op_assign
id|read_reg
c_func
(paren
id|cl
comma
l_int|2
comma
l_int|2
)paren
suffix:semicolon
id|os_temp
op_assign
id|read_reg
c_func
(paren
id|cl
comma
l_int|3
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hyst_temp
OL
l_int|0
op_logical_or
id|os_temp
OL
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;DS1775 digital thermometer [@%02x]&bslash;n&quot;
comma
id|cl-&gt;addr
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;Temp: &quot;
comma
id|temp
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;  Hyst: &quot;
comma
id|hyst_temp
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;  OS: &quot;
comma
id|os_temp
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|x.temp
op_assign
id|temp
suffix:semicolon
id|x.overheat_temp
op_assign
id|os_temp
suffix:semicolon
id|x.overheat_hyst
op_assign
id|hyst_temp
suffix:semicolon
id|cl-&gt;id
op_assign
id|THERMOSTAT_CLIENT_ID
suffix:semicolon
id|strlcpy
c_func
(paren
id|cl-&gt;name
comma
l_string|&quot;DS1775 thermostat&quot;
comma
r_sizeof
(paren
id|cl-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i2c_attach_client
c_func
(paren
id|cl
)paren
)paren
(brace
id|x.thermostat
op_assign
id|cl
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|cl
op_ne
id|x.thermostat
)paren
(brace
id|kfree
c_func
(paren
id|cl
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|do_probe
id|do_probe
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|addr
comma
r_int
id|kind
)paren
(brace
r_struct
id|i2c_client
op_star
id|cl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i2c_check_functionality
c_func
(paren
id|adapter
comma
id|I2C_FUNC_SMBUS_WORD_DATA
op_or
id|I2C_FUNC_SMBUS_WRITE_BYTE
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|cl
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|cl
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cl
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|i2c_client
)paren
)paren
suffix:semicolon
id|cl-&gt;addr
op_assign
id|addr
suffix:semicolon
id|cl-&gt;adapter
op_assign
id|adapter
suffix:semicolon
id|cl-&gt;driver
op_assign
op_amp
id|g4fan_driver
suffix:semicolon
id|cl-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|addr
OL
l_int|0x48
)paren
(brace
r_return
id|attach_fan
c_func
(paren
id|cl
)paren
suffix:semicolon
)brace
r_return
id|attach_thermostat
c_func
(paren
id|cl
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/*&t;initialization / cleanup&t;&t;&t;&t;&t;*/
multiline_comment|/************************************************************************/
r_static
r_int
DECL|function|therm_of_probe
id|therm_of_probe
c_func
(paren
r_struct
id|of_device
op_star
id|dev
comma
r_const
r_struct
id|of_match
op_star
id|match
)paren
(brace
r_return
id|i2c_add_driver
c_func
(paren
op_amp
id|g4fan_driver
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|therm_of_remove
id|therm_of_remove
c_func
(paren
r_struct
id|of_device
op_star
id|dev
)paren
(brace
r_return
id|i2c_del_driver
c_func
(paren
op_amp
id|g4fan_driver
)paren
suffix:semicolon
)brace
DECL|variable|therm_of_match
r_static
r_struct
id|of_match
id|therm_of_match
(braket
)braket
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;fan&quot;
comma
dot
id|type
op_assign
id|OF_ANY_MATCH
comma
dot
id|compatible
op_assign
l_string|&quot;adm1030&quot;
)brace
comma
(brace
)brace
)brace
suffix:semicolon
DECL|variable|therm_of_driver
r_static
r_struct
id|of_platform_driver
id|therm_of_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;temperature&quot;
comma
dot
id|match_table
op_assign
id|therm_of_match
comma
dot
id|probe
op_assign
id|therm_of_probe
comma
dot
id|remove
op_assign
id|therm_of_remove
comma
)brace
suffix:semicolon
DECL|struct|apple_thermal_info
r_struct
id|apple_thermal_info
(brace
DECL|member|id
id|u8
id|id
suffix:semicolon
multiline_comment|/* implementation ID */
DECL|member|fan_count
id|u8
id|fan_count
suffix:semicolon
multiline_comment|/* number of fans */
DECL|member|thermostat_count
id|u8
id|thermostat_count
suffix:semicolon
multiline_comment|/* number of thermostats */
DECL|member|unused
id|u8
id|unused
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|g4fan_init
id|g4fan_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|apple_thermal_info
op_star
id|info
suffix:semicolon
r_struct
id|device_node
op_star
id|np
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|x.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|np
op_assign
id|of_find_node_by_name
c_func
(paren
l_int|NULL
comma
l_string|&quot;power-mgt&quot;
)paren
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|info
op_assign
(paren
r_struct
id|apple_thermal_info
op_star
)paren
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;thermal-info&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|of_node_put
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerMac3,6&quot;
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;id
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;therm_windtunnel: unsupported thermal design %d&bslash;n&quot;
comma
id|info-&gt;id
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|np
op_assign
id|of_find_node_by_name
c_func
(paren
l_int|NULL
comma
l_string|&quot;fan&quot;
)paren
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|x.of_dev
op_assign
id|of_platform_device_create
c_func
(paren
id|np
comma
l_string|&quot;temperature&quot;
)paren
suffix:semicolon
id|of_node_put
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|x.of_dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t register fan controller!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|of_register_driver
c_func
(paren
op_amp
id|therm_of_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|g4fan_exit
id|g4fan_exit
c_func
(paren
r_void
)paren
(brace
id|of_unregister_driver
c_func
(paren
op_amp
id|therm_of_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x.of_dev
)paren
(brace
id|of_device_unregister
c_func
(paren
id|x.of_dev
)paren
suffix:semicolon
)brace
)brace
DECL|variable|g4fan_init
id|module_init
c_func
(paren
id|g4fan_init
)paren
suffix:semicolon
DECL|variable|g4fan_exit
id|module_exit
c_func
(paren
id|g4fan_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Samuel Rydh &lt;samuel@ibrium.se&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Apple G4 (windtunnel) fan controller&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
