multiline_comment|/* &n; *   Creation Date: &lt;2003/03/14 20:54:13 samuel&gt;&n; *   Time-stamp: &lt;2003/03/15 18:55:53 samuel&gt;&n; *   &n; *&t;&lt;therm_windtunnel.c&gt;&n; *&t;&n; *&t;The G4 &quot;windtunnel&quot; has a single fan controlled by a&n; *&t;DS1775 fan controller and an ADM1030 thermostat.&n; *&n; *&t;The fan controller is equipped with a temperature sensor&n; *&t;which measures the case temperature. The ADM censor&n; *&t;measures the CPU temperature. This driver tunes the&n; *&t;behavior of the fan. It is based upon empirical observations&n; *&t;of the &squot;AppleFan&squot; driver under OSX.&n; *&n; *&t;WARNING: This driver has only been testen on Apple&squot;s&n; *&t;1.25 MHz Dual G4 (March 03). Other machines might have&n; *&t;a different thermal design. It is tuned for a CPU&n; *&t;temperatur around 57 C.&n; *&n; *   Copyright (C) 2003 Samuel Rydh (samuel@ibrium.se)&n; *&n; *   Loosely based upon &squot;thermostat.c&squot; written by Benjamin Herrenschmidt&n; *   &n; *   This program is free software; you can redistribute it and/or&n; *   modify it under the terms of the GNU General Public License&n; *   as published by the Free Software Foundation&n; *   &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/sections.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Samuel Rydh &lt;samuel@ibrium.se&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Apple G4 (windtunnel) fan driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|LOG_TEMP
mdefine_line|#define LOG_TEMP&t;&t;0&t;&t;&t;/* continously log temperature */
multiline_comment|/* scan 0x48-0x4f (DS1775) and 0x2c-2x2f (ADM1030) */
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
l_int|0x49
comma
l_int|0x2c
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_i2c_range
r_static
r_int
r_int
id|normal_i2c_range
(braket
)braket
op_assign
(brace
l_int|0x48
comma
l_int|0x4f
comma
l_int|0x2c
comma
l_int|0x2f
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|poll_work
r_static
r_struct
id|work_struct
id|poll_work
suffix:semicolon
id|I2C_CLIENT_INSMOD
suffix:semicolon
DECL|macro|I2C_DRIVERID_G4FAN
mdefine_line|#define I2C_DRIVERID_G4FAN&t;0x9001&t;&t;&t;/* fixme */
DECL|macro|THERMOSTAT_CLIENT_ID
mdefine_line|#define THERMOSTAT_CLIENT_ID&t;1
DECL|macro|FAN_CLIENT_ID
mdefine_line|#define FAN_CLIENT_ID&t;&t;2
DECL|struct|temp_range
r_struct
id|temp_range
(brace
DECL|member|high
id|u8
id|high
suffix:semicolon
multiline_comment|/* start the fan */
DECL|member|low
id|u8
id|low
suffix:semicolon
multiline_comment|/* stop the fan */
)brace
suffix:semicolon
DECL|struct|apple_thermal_info
r_struct
id|apple_thermal_info
(brace
DECL|member|id
id|u8
id|id
suffix:semicolon
multiline_comment|/* implementation ID */
DECL|member|fan_count
id|u8
id|fan_count
suffix:semicolon
multiline_comment|/* number of fans */
DECL|member|thermostat_count
id|u8
id|thermostat_count
suffix:semicolon
multiline_comment|/* number of thermostats */
DECL|member|unused
id|u8
id|unused
(braket
l_int|5
)braket
suffix:semicolon
DECL|member|ranges
r_struct
id|temp_range
id|ranges
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* temperature ranges (may be [])*/
)brace
suffix:semicolon
r_static
r_int
id|do_detect
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|addr
comma
r_int
id|kind
)paren
suffix:semicolon
r_static
r_struct
(brace
DECL|member|thermostat
r_struct
id|i2c_client
op_star
id|thermostat
suffix:semicolon
DECL|member|fan
r_struct
id|i2c_client
op_star
id|fan
suffix:semicolon
DECL|member|error
r_int
id|error
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|overheat_temp
r_int
id|overheat_temp
suffix:semicolon
multiline_comment|/* 100% fan at this temp */
DECL|member|overheat_hyst
r_int
id|overheat_hyst
suffix:semicolon
DECL|member|temp
r_int
id|temp
suffix:semicolon
DECL|member|casetemp
r_int
id|casetemp
suffix:semicolon
DECL|member|fan_level
r_int
id|fan_level
suffix:semicolon
multiline_comment|/* active fan_table setting */
DECL|member|downind
r_int
id|downind
suffix:semicolon
DECL|member|upind
r_int
id|upind
suffix:semicolon
DECL|member|r0
DECL|member|r1
DECL|member|r20
DECL|member|r23
DECL|member|r25
r_int
id|r0
comma
id|r1
comma
id|r20
comma
id|r23
comma
id|r25
suffix:semicolon
multiline_comment|/* saved register */
DECL|variable|x
)brace
id|x
suffix:semicolon
r_static
r_struct
(brace
DECL|member|temp
r_int
id|temp
suffix:semicolon
DECL|member|fan_setting
r_int
id|fan_setting
suffix:semicolon
DECL|variable|fan_up_table
)brace
id|fan_up_table
(braket
)braket
op_assign
(brace
(brace
l_int|0x0000
comma
l_int|11
)brace
comma
multiline_comment|/* min fan */
(brace
l_int|0x3900
comma
l_int|8
)brace
comma
multiline_comment|/* 57.0 C */
(brace
l_int|0x3a4a
comma
l_int|7
)brace
comma
multiline_comment|/* 58.3 C */
(brace
l_int|0x3ad3
comma
l_int|6
)brace
comma
multiline_comment|/* 58.8 C */
(brace
l_int|0x3b3c
comma
l_int|5
)brace
comma
multiline_comment|/* 59.2 C */
(brace
l_int|0x3b94
comma
l_int|4
)brace
comma
multiline_comment|/* 59.6 C */
(brace
l_int|0x3be3
comma
l_int|3
)brace
comma
multiline_comment|/* 58.9 C */
(brace
l_int|0x3c29
comma
l_int|2
)brace
comma
multiline_comment|/* 59.2 C */
(brace
l_int|0xffff
comma
l_int|1
)brace
multiline_comment|/* on fire */
)brace
suffix:semicolon
r_static
r_struct
(brace
DECL|member|temp
r_int
id|temp
suffix:semicolon
DECL|member|fan_setting
r_int
id|fan_setting
suffix:semicolon
DECL|variable|fan_down_table
)brace
id|fan_down_table
(braket
)braket
op_assign
(brace
(brace
l_int|0x3700
comma
l_int|11
)brace
comma
multiline_comment|/* 55.0 C */
(brace
l_int|0x374a
comma
l_int|6
)brace
comma
(brace
l_int|0x3800
comma
l_int|7
)brace
comma
multiline_comment|/* 56.0 C */
(brace
l_int|0x3900
comma
l_int|8
)brace
comma
multiline_comment|/* 57.0 C */
(brace
l_int|0x3a4a
comma
l_int|7
)brace
comma
multiline_comment|/* 58.3 C */
(brace
l_int|0x3ad3
comma
l_int|6
)brace
comma
multiline_comment|/* 58.8 C */
(brace
l_int|0x3b3c
comma
l_int|5
)brace
comma
multiline_comment|/* 59.2 C */
(brace
l_int|0x3b94
comma
l_int|4
)brace
comma
multiline_comment|/* 58.9 C */
(brace
l_int|0x3be3
comma
l_int|3
)brace
comma
multiline_comment|/* 58.9 C */
(brace
l_int|0x3c29
comma
l_int|2
)brace
comma
multiline_comment|/* 59.2 C */
(brace
l_int|0xffff
comma
l_int|1
)brace
)brace
suffix:semicolon
r_static
r_int
DECL|function|write_reg
id|write_reg
c_func
(paren
r_struct
id|i2c_client
op_star
id|cl
comma
r_int
id|reg
comma
r_int
id|data
comma
r_int
id|len
)paren
(brace
id|u8
id|tmp
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
template_param
l_int|2
op_logical_or
id|data
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|tmp
(braket
l_int|0
)braket
op_assign
id|reg
suffix:semicolon
id|tmp
(braket
l_int|1
)braket
op_assign
(paren
id|len
op_eq
l_int|1
)paren
ques
c_cond
id|data
suffix:colon
(paren
id|data
op_rshift
l_int|8
)paren
suffix:semicolon
id|tmp
(braket
l_int|2
)braket
op_assign
id|data
suffix:semicolon
id|len
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i2c_master_send
c_func
(paren
id|cl
comma
id|tmp
comma
id|len
)paren
op_ne
id|len
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_reg
id|read_reg
c_func
(paren
r_struct
id|i2c_client
op_star
id|cl
comma
r_int
id|reg
comma
r_int
id|len
)paren
(brace
id|u8
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|1
op_logical_and
id|len
op_ne
l_int|2
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf
(braket
l_int|0
)braket
op_assign
id|reg
suffix:semicolon
r_if
c_cond
(paren
id|i2c_master_send
c_func
(paren
id|cl
comma
id|buf
comma
l_int|1
)paren
op_ne
l_int|1
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2c_master_recv
c_func
(paren
id|cl
comma
id|buf
comma
id|len
)paren
op_ne
id|len
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
(paren
id|len
op_eq
l_int|2
)paren
ques
c_cond
(paren
(paren
r_int
r_int
)paren
id|buf
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|buf
(braket
l_int|1
)braket
suffix:colon
id|buf
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_static
r_void
DECL|function|print_temp
id|print_temp
c_func
(paren
r_const
r_char
op_star
id|s
comma
r_int
id|temp
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s%d.%d C&quot;
comma
id|s
ques
c_cond
id|s
suffix:colon
l_string|&quot;&quot;
comma
id|temp
op_rshift
l_int|8
comma
(paren
id|temp
op_amp
l_int|255
)paren
op_star
l_int|10
op_div
l_int|256
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|tune_fan
id|tune_fan
c_func
(paren
r_int
id|fan_setting
)paren
(brace
r_int
id|val
op_assign
(paren
id|fan_setting
op_lshift
l_int|3
)paren
op_or
l_int|7
suffix:semicolon
id|x.fan_level
op_assign
id|fan_setting
suffix:semicolon
singleline_comment|//write_reg( x.fan, 0x24, val, 1 );
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x25
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x20
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;CPU-temp: &quot;
comma
id|x.temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x.casetemp
)paren
(brace
id|print_temp
c_func
(paren
l_string|&quot;, Case: &quot;
comma
id|x.casetemp
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;  Tuning fan: %d (%02x)&bslash;n&quot;
comma
id|fan_setting
comma
id|val
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|poll_temp
id|poll_temp
c_func
(paren
r_void
op_star
id|param
)paren
(brace
r_int
id|temp
op_assign
id|read_reg
c_func
(paren
id|x.thermostat
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
r_int
id|i
comma
id|level
comma
id|casetemp
suffix:semicolon
multiline_comment|/* this actually occurs when the computer is loaded */
r_if
c_cond
(paren
id|temp
OL
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|casetemp
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x0b
comma
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|casetemp
op_or_assign
(paren
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x06
comma
l_int|1
)paren
op_amp
l_int|0x7
)paren
op_lshift
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|LOG_TEMP
op_logical_and
id|x.temp
op_ne
id|temp
)paren
(brace
id|print_temp
c_func
(paren
l_string|&quot;CPU-temp: &quot;
comma
id|temp
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;, Case: &quot;
comma
id|casetemp
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;,  Fan: %d&bslash;n&quot;
comma
id|x.fan_level
)paren
suffix:semicolon
)brace
id|x.temp
op_assign
id|temp
suffix:semicolon
id|x.casetemp
op_assign
id|casetemp
suffix:semicolon
id|level
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|temp
op_amp
l_int|0xffff
)paren
OG
id|fan_down_table
(braket
id|i
)braket
dot
id|temp
suffix:semicolon
id|i
op_increment
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OL
id|x.downind
)paren
(brace
id|level
op_assign
id|fan_down_table
(braket
id|i
)braket
dot
id|fan_setting
suffix:semicolon
)brace
id|x.downind
op_assign
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|temp
op_amp
l_int|0xfffe
)paren
op_ge
id|fan_up_table
(braket
id|i
op_plus
l_int|1
)braket
dot
id|temp
suffix:semicolon
id|i
op_increment
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x.upind
OL
id|i
)paren
(brace
id|level
op_assign
id|fan_up_table
(braket
id|i
)braket
dot
id|fan_setting
suffix:semicolon
)brace
id|x.upind
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|level
op_ge
l_int|0
)paren
(brace
id|tune_fan
c_func
(paren
id|level
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|x.timer.expires
op_assign
id|jiffies
op_plus
l_int|8
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|x.timer
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|schedule_poll
id|schedule_poll
c_func
(paren
r_int
r_int
id|t
)paren
(brace
id|schedule_work
c_func
(paren
op_amp
id|poll_work
)paren
suffix:semicolon
)brace
multiline_comment|/************************************************************************/
multiline_comment|/*&t;i2c probing and setup&t;&t;&t;&t;&t;&t;*/
multiline_comment|/************************************************************************/
r_static
r_int
DECL|function|do_attach
id|do_attach
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
(brace
r_return
id|i2c_probe
c_func
(paren
id|adapter
comma
op_amp
id|addr_data
comma
op_amp
id|do_detect
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|do_detach
id|do_detach
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_int
id|err
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;do_detach: id %d&bslash;n&quot;
comma
id|client-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|i2c_detach_client
c_func
(paren
id|client
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;failed to detach thermostat client&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|g4fan_driver
r_static
r_struct
id|i2c_driver
id|g4fan_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Apple G4 Thermostat/Fan&quot;
comma
dot
id|id
op_assign
id|I2C_DRIVERID_G4FAN
comma
dot
id|flags
op_assign
id|I2C_DF_NOTIFY
comma
dot
id|attach_adapter
op_assign
op_amp
id|do_attach
comma
dot
id|detach_client
op_assign
op_amp
id|do_detach
comma
dot
id|command
op_assign
l_int|NULL
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|detect_fan
id|detect_fan
c_func
(paren
r_struct
id|i2c_client
op_star
id|cl
)paren
(brace
multiline_comment|/* check that this is an ADM1030 */
r_if
c_cond
(paren
id|read_reg
c_func
(paren
id|cl
comma
l_int|0x3d
comma
l_int|1
)paren
op_ne
l_int|0x30
op_logical_or
id|read_reg
c_func
(paren
id|cl
comma
l_int|0x3e
comma
l_int|1
)paren
op_ne
l_int|0x41
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;ADM1030 fan controller detected at %02x&bslash;n&quot;
comma
id|cl-&gt;addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x.fan
)paren
(brace
id|x.error
op_or_assign
l_int|2
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|x.fan
op_assign
id|cl
suffix:semicolon
id|cl-&gt;id
op_assign
id|FAN_CLIENT_ID
suffix:semicolon
id|strncpy
c_func
(paren
id|cl-&gt;name
comma
l_string|&quot;ADM1030 fan controller&quot;
comma
r_sizeof
(paren
id|cl-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c_attach_client
c_func
(paren
id|cl
)paren
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|cl
op_ne
id|x.fan
)paren
(brace
id|kfree
c_func
(paren
id|cl
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|detect_thermostat
id|detect_thermostat
c_func
(paren
r_struct
id|i2c_client
op_star
id|cl
)paren
(brace
r_int
id|hyst_temp
comma
id|os_temp
comma
id|temp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_assign
id|read_reg
c_func
(paren
id|cl
comma
l_int|0
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* temperature sanity check */
r_if
c_cond
(paren
id|temp
template_param
l_int|0x3c00
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|hyst_temp
op_assign
id|read_reg
c_func
(paren
id|cl
comma
l_int|2
comma
l_int|2
)paren
suffix:semicolon
id|os_temp
op_assign
id|read_reg
c_func
(paren
id|cl
comma
l_int|3
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hyst_temp
OL
l_int|0
op_logical_or
id|os_temp
OL
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;DS1775 digital thermometer detected at %02x&bslash;n&quot;
comma
id|cl-&gt;addr
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;Temp: &quot;
comma
id|temp
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;  Hyst: &quot;
comma
id|hyst_temp
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;  OS: &quot;
comma
id|os_temp
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x.thermostat
)paren
(brace
id|x.error
op_or_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|x.temp
op_assign
id|temp
suffix:semicolon
id|x.thermostat
op_assign
id|cl
suffix:semicolon
id|x.overheat_temp
op_assign
id|os_temp
suffix:semicolon
id|x.overheat_hyst
op_assign
id|hyst_temp
suffix:semicolon
id|cl-&gt;id
op_assign
id|THERMOSTAT_CLIENT_ID
suffix:semicolon
id|strncpy
c_func
(paren
id|cl-&gt;name
comma
l_string|&quot;DS1775 thermostat&quot;
comma
r_sizeof
(paren
id|cl-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c_attach_client
c_func
(paren
id|cl
)paren
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|cl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|do_detect
id|do_detect
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|addr
comma
r_int
id|kind
)paren
(brace
r_struct
id|i2c_client
op_star
id|cl
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|adapter-&gt;name
comma
l_string|&quot;uni-n&quot;
comma
l_int|5
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|i2c_check_functionality
c_func
(paren
id|adapter
comma
id|I2C_FUNC_SMBUS_WORD_DATA
op_or
id|I2C_FUNC_SMBUS_WRITE_BYTE
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|cl
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|i2c_client
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cl
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|i2c_client
)paren
)paren
suffix:semicolon
id|cl-&gt;addr
op_assign
id|addr
suffix:semicolon
id|cl-&gt;adapter
op_assign
id|adapter
suffix:semicolon
id|cl-&gt;driver
op_assign
op_amp
id|g4fan_driver
suffix:semicolon
id|cl-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|addr
OL
l_int|0x48
)paren
(brace
r_return
id|detect_fan
c_func
(paren
id|cl
)paren
suffix:semicolon
)brace
r_return
id|detect_thermostat
c_func
(paren
id|cl
)paren
suffix:semicolon
)brace
DECL|macro|PRINT_REG
mdefine_line|#define PRINT_REG( r )&t;printk(&quot;reg %02x = %02x&bslash;n&quot;, r, read_reg(x.fan, r, 1) )
r_static
r_int
id|__init
DECL|function|g4fan_init
id|g4fan_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|apple_thermal_info
op_star
id|info
suffix:semicolon
r_struct
id|device_node
op_star
id|np
suffix:semicolon
r_int
id|ret
comma
id|val
suffix:semicolon
id|np
op_assign
id|of_find_node_by_name
c_func
(paren
l_int|NULL
comma
l_string|&quot;power-mgt&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|apple_thermal_info
op_star
)paren
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;thermal-info&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|of_node_put
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* check for G4 &quot;Windtunnel&quot; SMP */
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerMac3,6&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;id
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;g4fan: design id %d unknown&bslash;n&quot;
comma
id|info-&gt;id
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;g4fan: unsupported machine type&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|i2c_add_driver
c_func
(paren
op_amp
id|g4fan_driver
)paren
)paren
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|x.thermostat
op_logical_or
op_logical_neg
id|x.fan
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|g4fan_driver
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* save registers (if we unload the module) */
id|x.r0
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x00
comma
l_int|1
)paren
suffix:semicolon
id|x.r1
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x01
comma
l_int|1
)paren
suffix:semicolon
id|x.r20
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x20
comma
l_int|1
)paren
suffix:semicolon
id|x.r23
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x23
comma
l_int|1
)paren
suffix:semicolon
id|x.r25
op_assign
id|read_reg
c_func
(paren
id|x.fan
comma
l_int|0x25
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* improve measurement resolution (convergence time 1.5s) */
r_if
c_cond
(paren
(paren
id|val
op_assign
id|read_reg
c_func
(paren
id|x.thermostat
comma
l_int|1
comma
l_int|1
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|val
op_or_assign
l_int|0x60
suffix:semicolon
r_if
c_cond
(paren
id|write_reg
c_func
(paren
id|x.thermostat
comma
l_int|1
comma
id|val
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed writing config register&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* disable interrupts and TAC input */
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* enable filter */
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x23
comma
l_int|0x91
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* remote temp. controls fan */
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x00
comma
l_int|0x95
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* The thermostat (which besides measureing temperature controls&n;&t; * has a THERM output which puts the fan on 100%) is usually&n;&t; * set to kick in at 80 C (chip default). We reduce this a bit&n;&t; * to be on the safe side (OSX doesn&squot;t)...&n;&t; */
r_if
c_cond
(paren
id|x.overheat_temp
op_eq
(paren
l_int|80
op_lshift
l_int|8
)paren
)paren
(brace
id|x.overheat_temp
op_assign
l_int|65
op_lshift
l_int|8
suffix:semicolon
id|x.overheat_hyst
op_assign
l_int|60
op_lshift
l_int|8
suffix:semicolon
id|write_reg
c_func
(paren
id|x.thermostat
comma
l_int|2
comma
id|x.overheat_hyst
comma
l_int|2
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.thermostat
comma
l_int|3
comma
id|x.overheat_temp
comma
l_int|2
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot;Reducing overheating limit to &quot;
comma
id|x.overheat_temp
)paren
suffix:semicolon
id|print_temp
c_func
(paren
l_string|&quot; (Hyst: &quot;
comma
id|x.overheat_hyst
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* set an initial fan setting */
id|x.upind
op_assign
id|x.downind
op_assign
l_int|1
suffix:semicolon
id|tune_fan
c_func
(paren
id|fan_up_table
(braket
id|x.upind
)braket
dot
id|fan_setting
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|poll_work
comma
id|poll_temp
comma
l_int|NULL
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|x.timer
)paren
suffix:semicolon
id|x.timer.expires
op_assign
id|jiffies
op_plus
l_int|8
op_star
id|HZ
suffix:semicolon
id|x.timer.function
op_assign
id|schedule_poll
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|x.timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|g4fan_exit
id|g4fan_exit
c_func
(paren
r_void
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|x.timer
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x01
comma
id|x.r1
comma
l_int|1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x20
comma
id|x.r20
comma
l_int|1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x23
comma
id|x.r23
comma
l_int|1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x25
comma
id|x.r25
comma
l_int|1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|x.fan
comma
l_int|0x00
comma
id|x.r0
comma
l_int|1
)paren
suffix:semicolon
id|i2c_del_driver
c_func
(paren
op_amp
id|g4fan_driver
)paren
suffix:semicolon
)brace
DECL|variable|g4fan_init
id|module_init
c_func
(paren
id|g4fan_init
)paren
suffix:semicolon
DECL|variable|g4fan_exit
id|module_exit
c_func
(paren
id|g4fan_exit
)paren
suffix:semicolon
eof
