multiline_comment|/*&n; * IBM Hot Plug Controller Driver&n; *&n; * Written By: Jyoti Shah, IBM Corporation&n; *&n; * Copyright (c) 2001-2002 IBM Corp.&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;gregkh@us.ibm.com&gt;&n; *                  &lt;jshah@us.ibm.com&gt;&n; *&n; */
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;ibmphp.h&quot;
DECL|variable|to_debug
r_static
r_int
id|to_debug
op_assign
id|FALSE
suffix:semicolon
DECL|macro|debug_polling
mdefine_line|#define debug_polling(fmt, arg...)&t;do { if (to_debug) debug (fmt, arg); } while (0)
singleline_comment|//----------------------------------------------------------------------------
singleline_comment|// timeout values
singleline_comment|//----------------------------------------------------------------------------
DECL|macro|CMD_COMPLETE_TOUT_SEC
mdefine_line|#define CMD_COMPLETE_TOUT_SEC&t;60&t;
singleline_comment|// give HPC 60 sec to finish cmd
DECL|macro|HPC_CTLR_WORKING_TOUT
mdefine_line|#define HPC_CTLR_WORKING_TOUT&t;60&t;
singleline_comment|// give HPC 60 sec to finish cmd
DECL|macro|HPC_GETACCESS_TIMEOUT
mdefine_line|#define HPC_GETACCESS_TIMEOUT&t;60&t;
singleline_comment|// seconds
DECL|macro|POLL_INTERVAL_SEC
mdefine_line|#define POLL_INTERVAL_SEC&t;2&t;
singleline_comment|// poll HPC every 2 seconds
DECL|macro|POLL_LATCH_CNT
mdefine_line|#define POLL_LATCH_CNT&t;&t;5&t;
singleline_comment|// poll latch 5 times, then poll slots
singleline_comment|//----------------------------------------------------------------------------
singleline_comment|// Winnipeg Architected Register Offsets
singleline_comment|//----------------------------------------------------------------------------
DECL|macro|WPG_I2CMBUFL_OFFSET
mdefine_line|#define WPG_I2CMBUFL_OFFSET&t;0x08&t;
singleline_comment|// I2C Message Buffer Low
DECL|macro|WPG_I2CMOSUP_OFFSET
mdefine_line|#define WPG_I2CMOSUP_OFFSET&t;0x10&t;
singleline_comment|// I2C Master Operation Setup Reg
DECL|macro|WPG_I2CMCNTL_OFFSET
mdefine_line|#define WPG_I2CMCNTL_OFFSET&t;0x20&t;
singleline_comment|// I2C Master Control Register
DECL|macro|WPG_I2CPARM_OFFSET
mdefine_line|#define WPG_I2CPARM_OFFSET&t;0x40&t;
singleline_comment|// I2C Parameter Register
DECL|macro|WPG_I2CSTAT_OFFSET
mdefine_line|#define WPG_I2CSTAT_OFFSET&t;0x70&t;
singleline_comment|// I2C Status Register
singleline_comment|//----------------------------------------------------------------------------
singleline_comment|// Winnipeg Store Type commands (Add this commands to the register offset)
singleline_comment|//----------------------------------------------------------------------------
DECL|macro|WPG_I2C_AND
mdefine_line|#define WPG_I2C_AND&t;&t;0x1000&t;
singleline_comment|// I2C AND operation
DECL|macro|WPG_I2C_OR
mdefine_line|#define WPG_I2C_OR&t;&t;0x2000&t;
singleline_comment|// I2C OR operation
singleline_comment|//----------------------------------------------------------------------------
singleline_comment|// Command set for I2C Master Operation Setup Regisetr
singleline_comment|//----------------------------------------------------------------------------
DECL|macro|WPG_READATADDR_MASK
mdefine_line|#define WPG_READATADDR_MASK&t;0x00010000&t;
singleline_comment|// read,bytes,I2C shifted,index
DECL|macro|WPG_WRITEATADDR_MASK
mdefine_line|#define WPG_WRITEATADDR_MASK&t;0x40010000&t;
singleline_comment|// write,bytes,I2C shifted,index
DECL|macro|WPG_READDIRECT_MASK
mdefine_line|#define WPG_READDIRECT_MASK&t;0x10010000
DECL|macro|WPG_WRITEDIRECT_MASK
mdefine_line|#define WPG_WRITEDIRECT_MASK&t;0x60010000
singleline_comment|//----------------------------------------------------------------------------
singleline_comment|// bit masks for I2C Master Control Register
singleline_comment|//----------------------------------------------------------------------------
DECL|macro|WPG_I2CMCNTL_STARTOP_MASK
mdefine_line|#define WPG_I2CMCNTL_STARTOP_MASK&t;0x00000002&t;
singleline_comment|// Start the Operation
singleline_comment|//----------------------------------------------------------------------------
singleline_comment|//
singleline_comment|//----------------------------------------------------------------------------
DECL|macro|WPG_I2C_IOREMAP_SIZE
mdefine_line|#define WPG_I2C_IOREMAP_SIZE&t;0x2044&t;
singleline_comment|// size of linear address interval
singleline_comment|//----------------------------------------------------------------------------
singleline_comment|// command index
singleline_comment|//----------------------------------------------------------------------------
DECL|macro|WPG_1ST_SLOT_INDEX
mdefine_line|#define WPG_1ST_SLOT_INDEX&t;0x01&t;
singleline_comment|// index - 1st slot for ctlr
DECL|macro|WPG_CTLR_INDEX
mdefine_line|#define WPG_CTLR_INDEX&t;&t;0x0F&t;
singleline_comment|// index - ctlr
DECL|macro|WPG_1ST_EXTSLOT_INDEX
mdefine_line|#define WPG_1ST_EXTSLOT_INDEX&t;0x10&t;
singleline_comment|// index - 1st ext slot for ctlr
DECL|macro|WPG_1ST_BUS_INDEX
mdefine_line|#define WPG_1ST_BUS_INDEX&t;0x1F&t;
singleline_comment|// index - 1st bus for ctlr
singleline_comment|//----------------------------------------------------------------------------
singleline_comment|// macro utilities
singleline_comment|//----------------------------------------------------------------------------
singleline_comment|// if bits 20,22,25,26,27,29,30 are OFF return TRUE
DECL|macro|HPC_I2CSTATUS_CHECK
mdefine_line|#define HPC_I2CSTATUS_CHECK(s)&t;((u8)((s &amp; 0x00000A76) ? FALSE : TRUE))
singleline_comment|//----------------------------------------------------------------------------
singleline_comment|// global variables
singleline_comment|//----------------------------------------------------------------------------
DECL|variable|ibmphp_shutdown
r_static
r_int
id|ibmphp_shutdown
suffix:semicolon
DECL|variable|tid_poll
r_static
r_int
id|tid_poll
suffix:semicolon
DECL|variable|sem_hpcaccess
r_static
r_struct
id|semaphore
id|sem_hpcaccess
suffix:semicolon
singleline_comment|// lock access to HPC
DECL|variable|semOperations
r_static
r_struct
id|semaphore
id|semOperations
suffix:semicolon
singleline_comment|// lock all operations and
singleline_comment|// access to data structures
DECL|variable|sem_exit
r_static
r_struct
id|semaphore
id|sem_exit
suffix:semicolon
singleline_comment|// make sure polling thread goes away
singleline_comment|//----------------------------------------------------------------------------
singleline_comment|// local function prototypes
singleline_comment|//----------------------------------------------------------------------------
r_static
id|u8
id|i2c_ctrl_read
(paren
r_struct
id|controller
op_star
comma
r_void
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
id|u8
id|i2c_ctrl_write
(paren
r_struct
id|controller
op_star
comma
r_void
op_star
comma
id|u8
comma
id|u8
)paren
suffix:semicolon
r_static
id|u8
id|hpc_writecmdtoindex
(paren
id|u8
comma
id|u8
)paren
suffix:semicolon
r_static
id|u8
id|hpc_readcmdtoindex
(paren
id|u8
comma
id|u8
)paren
suffix:semicolon
r_static
r_void
id|get_hpc_access
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|free_hpc_access
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|poll_hpc
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|update_slot
(paren
r_struct
id|slot
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
r_int
id|process_changeinstatus
(paren
r_struct
id|slot
op_star
comma
r_struct
id|slot
op_star
)paren
suffix:semicolon
r_static
r_int
id|process_changeinlatch
(paren
id|u8
comma
id|u8
comma
r_struct
id|controller
op_star
)paren
suffix:semicolon
r_static
r_int
id|hpc_poll_thread
(paren
r_void
op_star
)paren
suffix:semicolon
r_static
r_int
id|hpc_wait_ctlr_notworking
(paren
r_int
comma
r_struct
id|controller
op_star
comma
r_void
op_star
comma
id|u8
op_star
)paren
suffix:semicolon
singleline_comment|//----------------------------------------------------------------------------
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    ibmphp_hpc_initvars&n;*&n;* Action:  initialize semaphores and variables&n;*---------------------------------------------------------------------*/
DECL|function|ibmphp_hpc_initvars
r_void
id|__init
id|ibmphp_hpc_initvars
(paren
r_void
)paren
(brace
id|debug
(paren
l_string|&quot;%s - Entry&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|init_MUTEX
(paren
op_amp
id|sem_hpcaccess
)paren
suffix:semicolon
id|init_MUTEX
(paren
op_amp
id|semOperations
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
(paren
op_amp
id|sem_exit
)paren
suffix:semicolon
id|to_debug
op_assign
id|FALSE
suffix:semicolon
id|ibmphp_shutdown
op_assign
id|FALSE
suffix:semicolon
id|tid_poll
op_assign
l_int|0
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    i2c_ctrl_read&n;*&n;* Action:  read from HPC over I2C&n;*&n;*---------------------------------------------------------------------*/
DECL|function|i2c_ctrl_read
r_static
id|u8
id|i2c_ctrl_read
(paren
r_struct
id|controller
op_star
id|ctlr_ptr
comma
r_void
op_star
id|WPGBbar
comma
id|u8
id|index
)paren
(brace
id|u8
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
r_void
op_star
id|wpg_addr
suffix:semicolon
singleline_comment|// base addr + offset
id|ulong
id|wpg_data
comma
singleline_comment|// data to/from WPG LOHI format
id|ultemp
comma
id|data
suffix:semicolon
singleline_comment|// actual data HILO format
id|debug_polling
(paren
l_string|&quot;%s - Entry WPGBbar[%lx] index[%x] &bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
id|ulong
)paren
id|WPGBbar
comma
id|index
)paren
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// READ - step 1
singleline_comment|// read at address, byte length, I2C address (shifted), index
singleline_comment|// or read direct, byte length, index
r_if
c_cond
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|0x02
)paren
(brace
id|data
op_assign
id|WPG_READATADDR_MASK
suffix:semicolon
singleline_comment|// fill in I2C address
id|ultemp
op_assign
(paren
id|ulong
)paren
id|ctlr_ptr-&gt;u.wpeg_ctlr.i2c_addr
suffix:semicolon
id|ultemp
op_assign
id|ultemp
op_rshift
l_int|1
suffix:semicolon
id|data
op_or_assign
(paren
id|ultemp
op_lshift
l_int|8
)paren
suffix:semicolon
singleline_comment|// fill in index
id|data
op_or_assign
(paren
id|ulong
)paren
id|index
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|0x04
)paren
(brace
id|data
op_assign
id|WPG_READDIRECT_MASK
suffix:semicolon
singleline_comment|// fill in index
id|ultemp
op_assign
(paren
id|ulong
)paren
id|index
suffix:semicolon
id|ultemp
op_assign
id|ultemp
op_lshift
l_int|8
suffix:semicolon
id|data
op_or_assign
id|ultemp
suffix:semicolon
)brace
r_else
(brace
id|err
(paren
l_string|&quot;this controller type is not supported &bslash;n&quot;
)paren
suffix:semicolon
r_return
id|HPC_ERROR
suffix:semicolon
)brace
id|wpg_data
op_assign
id|swab32
(paren
id|data
)paren
suffix:semicolon
singleline_comment|// swap data before writing
(paren
id|ulong
)paren
id|wpg_addr
op_assign
(paren
id|ulong
)paren
id|WPGBbar
op_plus
(paren
id|ulong
)paren
id|WPG_I2CMOSUP_OFFSET
suffix:semicolon
id|writel
(paren
id|wpg_data
comma
id|wpg_addr
)paren
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// READ - step 2 : clear the message buffer
id|data
op_assign
l_int|0x00000000
suffix:semicolon
id|wpg_data
op_assign
id|swab32
(paren
id|data
)paren
suffix:semicolon
(paren
id|ulong
)paren
id|wpg_addr
op_assign
(paren
id|ulong
)paren
id|WPGBbar
op_plus
(paren
id|ulong
)paren
id|WPG_I2CMBUFL_OFFSET
suffix:semicolon
id|writel
(paren
id|wpg_data
comma
id|wpg_addr
)paren
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// READ - step 3 : issue start operation, I2C master control bit 30:ON
singleline_comment|//                 2020 : [20] OR operation at [20] offset 0x20
id|data
op_assign
id|WPG_I2CMCNTL_STARTOP_MASK
suffix:semicolon
id|wpg_data
op_assign
id|swab32
(paren
id|data
)paren
suffix:semicolon
(paren
id|ulong
)paren
id|wpg_addr
op_assign
(paren
id|ulong
)paren
id|WPGBbar
op_plus
(paren
id|ulong
)paren
id|WPG_I2CMCNTL_OFFSET
op_plus
(paren
id|ulong
)paren
id|WPG_I2C_OR
suffix:semicolon
id|writel
(paren
id|wpg_data
comma
id|wpg_addr
)paren
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// READ - step 4 : wait until start operation bit clears
id|i
op_assign
id|CMD_COMPLETE_TOUT_SEC
suffix:semicolon
r_while
c_loop
(paren
id|i
)paren
(brace
id|long_delay
(paren
l_int|1
op_star
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
(paren
id|ulong
)paren
id|wpg_addr
op_assign
(paren
id|ulong
)paren
id|WPGBbar
op_plus
(paren
id|ulong
)paren
id|WPG_I2CMCNTL_OFFSET
suffix:semicolon
id|wpg_data
op_assign
id|readl
(paren
id|wpg_addr
)paren
suffix:semicolon
id|data
op_assign
id|swab32
(paren
id|wpg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|data
op_amp
id|WPG_I2CMCNTL_STARTOP_MASK
)paren
)paren
r_break
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|debug
(paren
l_string|&quot;%s - Error : WPG timeout&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|HPC_ERROR
suffix:semicolon
)brace
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// READ - step 5 : read I2C status register
id|i
op_assign
id|CMD_COMPLETE_TOUT_SEC
suffix:semicolon
r_while
c_loop
(paren
id|i
)paren
(brace
id|long_delay
(paren
l_int|1
op_star
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
(paren
id|ulong
)paren
id|wpg_addr
op_assign
(paren
id|ulong
)paren
id|WPGBbar
op_plus
(paren
id|ulong
)paren
id|WPG_I2CSTAT_OFFSET
suffix:semicolon
id|wpg_data
op_assign
id|readl
(paren
id|wpg_addr
)paren
suffix:semicolon
id|data
op_assign
id|swab32
(paren
id|wpg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HPC_I2CSTATUS_CHECK
(paren
id|data
)paren
)paren
r_break
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|debug
(paren
l_string|&quot;ctrl_read - Exit Error:I2C timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|HPC_ERROR
suffix:semicolon
)brace
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// READ - step 6 : get DATA
(paren
id|ulong
)paren
id|wpg_addr
op_assign
(paren
id|ulong
)paren
id|WPGBbar
op_plus
(paren
id|ulong
)paren
id|WPG_I2CMBUFL_OFFSET
suffix:semicolon
id|wpg_data
op_assign
id|readl
(paren
id|wpg_addr
)paren
suffix:semicolon
id|data
op_assign
id|swab32
(paren
id|wpg_data
)paren
suffix:semicolon
id|status
op_assign
(paren
id|u8
)paren
id|data
suffix:semicolon
id|debug_polling
(paren
l_string|&quot;%s - Exit index[%x] status[%x]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|index
comma
id|status
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    i2c_ctrl_write&n;*&n;* Action:  write to HPC over I2C&n;*&n;* Return   0 or error codes&n;*---------------------------------------------------------------------*/
DECL|function|i2c_ctrl_write
r_static
id|u8
id|i2c_ctrl_write
(paren
r_struct
id|controller
op_star
id|ctlr_ptr
comma
r_void
op_star
id|WPGBbar
comma
id|u8
id|index
comma
id|u8
id|cmd
)paren
(brace
id|u8
id|rc
suffix:semicolon
r_void
op_star
id|wpg_addr
suffix:semicolon
singleline_comment|// base addr + offset
id|ulong
id|wpg_data
comma
singleline_comment|// data to/from WPG LOHI format 
id|ultemp
comma
id|data
suffix:semicolon
singleline_comment|// actual data HILO format
r_int
id|i
suffix:semicolon
id|debug_polling
(paren
l_string|&quot;%s - Entry WPGBbar[%lx] index[%x] cmd[%x]&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
id|ulong
)paren
id|WPGBbar
comma
id|index
comma
id|cmd
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// WRITE - step 1
singleline_comment|// write at address, byte length, I2C address (shifted), index
singleline_comment|// or write direct, byte length, index
id|data
op_assign
l_int|0x00000000
suffix:semicolon
r_if
c_cond
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|0x02
)paren
(brace
id|data
op_assign
id|WPG_WRITEATADDR_MASK
suffix:semicolon
singleline_comment|// fill in I2C address
id|ultemp
op_assign
(paren
id|ulong
)paren
id|ctlr_ptr-&gt;u.wpeg_ctlr.i2c_addr
suffix:semicolon
id|ultemp
op_assign
id|ultemp
op_rshift
l_int|1
suffix:semicolon
id|data
op_or_assign
(paren
id|ultemp
op_lshift
l_int|8
)paren
suffix:semicolon
singleline_comment|// fill in index
id|data
op_or_assign
(paren
id|ulong
)paren
id|index
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|0x04
)paren
(brace
id|data
op_assign
id|WPG_WRITEDIRECT_MASK
suffix:semicolon
singleline_comment|// fill in index
id|ultemp
op_assign
(paren
id|ulong
)paren
id|index
suffix:semicolon
id|ultemp
op_assign
id|ultemp
op_lshift
l_int|8
suffix:semicolon
id|data
op_or_assign
id|ultemp
suffix:semicolon
)brace
r_else
(brace
id|err
(paren
l_string|&quot;this controller type is not supported &bslash;n&quot;
)paren
suffix:semicolon
r_return
id|HPC_ERROR
suffix:semicolon
)brace
id|wpg_data
op_assign
id|swab32
(paren
id|data
)paren
suffix:semicolon
singleline_comment|// swap data before writing
(paren
id|ulong
)paren
id|wpg_addr
op_assign
(paren
id|ulong
)paren
id|WPGBbar
op_plus
(paren
id|ulong
)paren
id|WPG_I2CMOSUP_OFFSET
suffix:semicolon
id|writel
(paren
id|wpg_data
comma
id|wpg_addr
)paren
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// WRITE - step 2 : clear the message buffer
id|data
op_assign
l_int|0x00000000
op_or
(paren
id|ulong
)paren
id|cmd
suffix:semicolon
id|wpg_data
op_assign
id|swab32
(paren
id|data
)paren
suffix:semicolon
(paren
id|ulong
)paren
id|wpg_addr
op_assign
(paren
id|ulong
)paren
id|WPGBbar
op_plus
(paren
id|ulong
)paren
id|WPG_I2CMBUFL_OFFSET
suffix:semicolon
id|writel
(paren
id|wpg_data
comma
id|wpg_addr
)paren
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// WRITE - step 3 : issue start operation,I2C master control bit 30:ON
singleline_comment|//                 2020 : [20] OR operation at [20] offset 0x20
id|data
op_assign
id|WPG_I2CMCNTL_STARTOP_MASK
suffix:semicolon
id|wpg_data
op_assign
id|swab32
(paren
id|data
)paren
suffix:semicolon
(paren
id|ulong
)paren
id|wpg_addr
op_assign
(paren
id|ulong
)paren
id|WPGBbar
op_plus
(paren
id|ulong
)paren
id|WPG_I2CMCNTL_OFFSET
op_plus
(paren
id|ulong
)paren
id|WPG_I2C_OR
suffix:semicolon
id|writel
(paren
id|wpg_data
comma
id|wpg_addr
)paren
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// WRITE - step 4 : wait until start operation bit clears
id|i
op_assign
id|CMD_COMPLETE_TOUT_SEC
suffix:semicolon
r_while
c_loop
(paren
id|i
)paren
(brace
id|long_delay
(paren
l_int|1
op_star
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
(paren
id|ulong
)paren
id|wpg_addr
op_assign
(paren
id|ulong
)paren
id|WPGBbar
op_plus
(paren
id|ulong
)paren
id|WPG_I2CMCNTL_OFFSET
suffix:semicolon
id|wpg_data
op_assign
id|readl
(paren
id|wpg_addr
)paren
suffix:semicolon
id|data
op_assign
id|swab32
(paren
id|wpg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|data
op_amp
id|WPG_I2CMCNTL_STARTOP_MASK
)paren
)paren
r_break
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|debug
(paren
l_string|&quot;%s - Exit Error:WPG timeout&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|rc
op_assign
id|HPC_ERROR
suffix:semicolon
)brace
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// WRITE - step 5 : read I2C status register
id|i
op_assign
id|CMD_COMPLETE_TOUT_SEC
suffix:semicolon
r_while
c_loop
(paren
id|i
)paren
(brace
id|long_delay
(paren
l_int|1
op_star
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
(paren
id|ulong
)paren
id|wpg_addr
op_assign
(paren
id|ulong
)paren
id|WPGBbar
op_plus
(paren
id|ulong
)paren
id|WPG_I2CSTAT_OFFSET
suffix:semicolon
id|wpg_data
op_assign
id|readl
(paren
id|wpg_addr
)paren
suffix:semicolon
id|data
op_assign
id|swab32
(paren
id|wpg_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HPC_I2CSTATUS_CHECK
(paren
id|data
)paren
)paren
r_break
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|debug
(paren
l_string|&quot;ctrl_read - Error : I2C timeout&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|HPC_ERROR
suffix:semicolon
)brace
id|debug_polling
(paren
l_string|&quot;%s Exit rc[%x]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
(paren
id|rc
)paren
suffix:semicolon
)brace
singleline_comment|//------------------------------------------------------------
singleline_comment|//  Read from ISA type HPC 
singleline_comment|//------------------------------------------------------------
DECL|function|isa_ctrl_read
r_static
id|u8
id|isa_ctrl_read
(paren
r_struct
id|controller
op_star
id|ctlr_ptr
comma
id|u8
id|offset
)paren
(brace
id|u16
id|start_address
suffix:semicolon
id|u16
id|end_address
suffix:semicolon
id|u8
id|data
suffix:semicolon
id|start_address
op_assign
id|ctlr_ptr-&gt;u.isa_ctlr.io_start
suffix:semicolon
id|end_address
op_assign
id|ctlr_ptr-&gt;u.isa_ctlr.io_end
suffix:semicolon
id|data
op_assign
id|inb
(paren
id|start_address
op_plus
id|offset
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
singleline_comment|//--------------------------------------------------------------
singleline_comment|// Write to ISA type HPC
singleline_comment|//--------------------------------------------------------------
DECL|function|isa_ctrl_write
r_static
r_void
id|isa_ctrl_write
(paren
r_struct
id|controller
op_star
id|ctlr_ptr
comma
id|u8
id|offset
comma
id|u8
id|data
)paren
(brace
id|u16
id|start_address
suffix:semicolon
id|u16
id|port_address
suffix:semicolon
id|start_address
op_assign
id|ctlr_ptr-&gt;u.isa_ctlr.io_start
suffix:semicolon
id|port_address
op_assign
id|start_address
op_plus
(paren
id|u16
)paren
id|offset
suffix:semicolon
id|outb
(paren
id|data
comma
id|port_address
)paren
suffix:semicolon
)brace
DECL|function|pci_ctrl_read
r_static
id|u8
id|pci_ctrl_read
(paren
r_struct
id|controller
op_star
id|ctrl
comma
id|u8
id|offset
)paren
(brace
id|u8
id|data
op_assign
l_int|0x00
suffix:semicolon
id|debug
(paren
l_string|&quot;inside pci_ctrl_read&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;ctrl_dev
)paren
id|pci_read_config_byte
(paren
id|ctrl-&gt;ctrl_dev
comma
id|HPC_PCI_OFFSET
op_plus
id|offset
comma
op_amp
id|data
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
DECL|function|pci_ctrl_write
r_static
id|u8
id|pci_ctrl_write
(paren
r_struct
id|controller
op_star
id|ctrl
comma
id|u8
id|offset
comma
id|u8
id|data
)paren
(brace
id|u8
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|debug
(paren
l_string|&quot;inside pci_ctrl_write&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;ctrl_dev
)paren
(brace
id|pci_write_config_byte
(paren
id|ctrl-&gt;ctrl_dev
comma
id|HPC_PCI_OFFSET
op_plus
id|offset
comma
id|data
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ctrl_read
r_static
id|u8
id|ctrl_read
(paren
r_struct
id|controller
op_star
id|ctlr
comma
r_void
op_star
id|base
comma
id|u8
id|offset
)paren
(brace
id|u8
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|ctlr-&gt;ctlr_type
)paren
(brace
r_case
l_int|0
suffix:colon
id|rc
op_assign
id|isa_ctrl_read
(paren
id|ctlr
comma
id|offset
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|rc
op_assign
id|pci_ctrl_read
(paren
id|ctlr
comma
id|offset
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_case
l_int|4
suffix:colon
id|rc
op_assign
id|i2c_ctrl_read
(paren
id|ctlr
comma
id|base
comma
id|offset
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ctrl_write
r_static
id|u8
id|ctrl_write
(paren
r_struct
id|controller
op_star
id|ctlr
comma
r_void
op_star
id|base
comma
id|u8
id|offset
comma
id|u8
id|data
)paren
(brace
id|u8
id|rc
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|ctlr-&gt;ctlr_type
)paren
(brace
r_case
l_int|0
suffix:colon
id|isa_ctrl_write
c_func
(paren
id|ctlr
comma
id|offset
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|rc
op_assign
id|pci_ctrl_write
(paren
id|ctlr
comma
id|offset
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_case
l_int|4
suffix:colon
id|rc
op_assign
id|i2c_ctrl_write
c_func
(paren
id|ctlr
comma
id|base
comma
id|offset
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    hpc_writecmdtoindex()&n;*&n;* Action:  convert a write command to proper index within a controller&n;*&n;* Return   index, HPC_ERROR&n;*---------------------------------------------------------------------*/
DECL|function|hpc_writecmdtoindex
r_static
id|u8
id|hpc_writecmdtoindex
(paren
id|u8
id|cmd
comma
id|u8
id|index
)paren
(brace
id|u8
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|HPC_CTLR_ENABLEIRQ
suffix:colon
singleline_comment|// 0x00.N.15
r_case
id|HPC_CTLR_CLEARIRQ
suffix:colon
singleline_comment|// 0x06.N.15
r_case
id|HPC_CTLR_RESET
suffix:colon
singleline_comment|// 0x07.N.15
r_case
id|HPC_CTLR_IRQSTEER
suffix:colon
singleline_comment|// 0x08.N.15
r_case
id|HPC_CTLR_DISABLEIRQ
suffix:colon
singleline_comment|// 0x01.N.15
r_case
id|HPC_ALLSLOT_ON
suffix:colon
singleline_comment|// 0x11.N.15
r_case
id|HPC_ALLSLOT_OFF
suffix:colon
singleline_comment|// 0x12.N.15
id|rc
op_assign
l_int|0x0F
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HPC_SLOT_OFF
suffix:colon
singleline_comment|// 0x02.Y.0-14
r_case
id|HPC_SLOT_ON
suffix:colon
singleline_comment|// 0x03.Y.0-14
r_case
id|HPC_SLOT_ATTNOFF
suffix:colon
singleline_comment|// 0x04.N.0-14
r_case
id|HPC_SLOT_ATTNON
suffix:colon
singleline_comment|// 0x05.N.0-14
r_case
id|HPC_SLOT_BLINKLED
suffix:colon
singleline_comment|// 0x13.N.0-14
id|rc
op_assign
id|index
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HPC_BUS_33CONVMODE
suffix:colon
r_case
id|HPC_BUS_66CONVMODE
suffix:colon
r_case
id|HPC_BUS_66PCIXMODE
suffix:colon
r_case
id|HPC_BUS_100PCIXMODE
suffix:colon
r_case
id|HPC_BUS_133PCIXMODE
suffix:colon
id|rc
op_assign
id|index
op_plus
id|WPG_1ST_BUS_INDEX
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
(paren
l_string|&quot;hpc_writecmdtoindex - Error invalid cmd[%x]&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|rc
op_assign
id|HPC_ERROR
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    hpc_readcmdtoindex()&n;*&n;* Action:  convert a read command to proper index within a controller&n;*&n;* Return   index, HPC_ERROR&n;*---------------------------------------------------------------------*/
DECL|function|hpc_readcmdtoindex
r_static
id|u8
id|hpc_readcmdtoindex
(paren
id|u8
id|cmd
comma
id|u8
id|index
)paren
(brace
id|u8
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|READ_CTLRSTATUS
suffix:colon
id|rc
op_assign
l_int|0x0F
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_SLOTSTATUS
suffix:colon
r_case
id|READ_ALLSTAT
suffix:colon
id|rc
op_assign
id|index
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_EXTSLOTSTATUS
suffix:colon
id|rc
op_assign
id|index
op_plus
id|WPG_1ST_EXTSLOT_INDEX
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_BUSSTATUS
suffix:colon
id|rc
op_assign
id|index
op_plus
id|WPG_1ST_BUS_INDEX
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_SLOTLATCHLOWREG
suffix:colon
id|rc
op_assign
l_int|0x28
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_REVLEVEL
suffix:colon
id|rc
op_assign
l_int|0x25
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_HPCOPTIONS
suffix:colon
id|rc
op_assign
l_int|0x27
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|rc
op_assign
id|HPC_ERROR
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    HPCreadslot()&n;*&n;* Action:  issue a READ command to HPC&n;*&n;* Input:   pslot   - can not be NULL for READ_ALLSTAT&n;*          pstatus - can be NULL for READ_ALLSTAT&n;*&n;* Return   0 or error codes&n;*---------------------------------------------------------------------*/
DECL|function|ibmphp_hpc_readslot
r_int
id|ibmphp_hpc_readslot
(paren
r_struct
id|slot
op_star
id|pslot
comma
id|u8
id|cmd
comma
id|u8
op_star
id|pstatus
)paren
(brace
r_void
op_star
id|wpg_bbar
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|controller
op_star
id|ctlr_ptr
suffix:semicolon
r_struct
id|list_head
op_star
id|pslotlist
suffix:semicolon
id|u8
id|index
comma
id|status
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|busindex
suffix:semicolon
id|debug_polling
(paren
l_string|&quot;%s - Entry pslot[%lx] cmd[%x] pstatus[%lx]&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
id|ulong
)paren
id|pslot
comma
id|cmd
comma
(paren
id|ulong
)paren
id|pstatus
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pslot
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|pstatus
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|cmd
op_ne
id|READ_ALLSTAT
)paren
op_logical_and
(paren
id|cmd
op_ne
id|READ_BUSSTATUS
)paren
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|err
(paren
l_string|&quot;%s - Error invalid pointer, rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|READ_BUSSTATUS
)paren
(brace
id|busindex
op_assign
id|ibmphp_get_bus_index
(paren
id|pslot-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|busindex
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|err
(paren
l_string|&quot;%s - Exit Error:invalid bus, rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
id|index
op_assign
(paren
id|u8
)paren
id|busindex
suffix:semicolon
)brace
r_else
id|index
op_assign
id|pslot-&gt;ctlr_index
suffix:semicolon
id|index
op_assign
id|hpc_readcmdtoindex
(paren
id|cmd
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
id|HPC_ERROR
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|err
(paren
l_string|&quot;%s - Exit Error:invalid index, rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|ctlr_ptr
op_assign
id|pslot-&gt;ctrl
suffix:semicolon
id|get_hpc_access
(paren
)paren
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// map physical address to logical address
singleline_comment|//--------------------------------------------------------------------
r_if
c_cond
(paren
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|2
)paren
op_logical_or
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|4
)paren
)paren
id|wpg_bbar
op_assign
id|ioremap
(paren
id|ctlr_ptr-&gt;u.wpeg_ctlr.wpegbbar
comma
id|WPG_I2C_IOREMAP_SIZE
)paren
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// check controller status before reading
singleline_comment|//--------------------------------------------------------------------
id|rc
op_assign
id|hpc_wait_ctlr_notworking
(paren
id|HPC_CTLR_WORKING_TOUT
comma
id|ctlr_ptr
comma
id|wpg_bbar
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|READ_ALLSTAT
suffix:colon
singleline_comment|// update the slot structure
id|pslot-&gt;ctrl-&gt;status
op_assign
id|status
suffix:semicolon
id|pslot-&gt;status
op_assign
id|ctrl_read
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|index
)paren
suffix:semicolon
id|rc
op_assign
id|hpc_wait_ctlr_notworking
(paren
id|HPC_CTLR_WORKING_TOUT
comma
id|ctlr_ptr
comma
id|wpg_bbar
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|pslot-&gt;ext_status
op_assign
id|ctrl_read
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|index
op_plus
id|WPG_1ST_EXTSLOT_INDEX
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_SLOTSTATUS
suffix:colon
singleline_comment|// DO NOT update the slot structure
op_star
id|pstatus
op_assign
id|ctrl_read
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_EXTSLOTSTATUS
suffix:colon
singleline_comment|// DO NOT update the slot structure
op_star
id|pstatus
op_assign
id|ctrl_read
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CTLRSTATUS
suffix:colon
singleline_comment|// DO NOT update the slot structure
op_star
id|pstatus
op_assign
id|status
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_BUSSTATUS
suffix:colon
id|pslot-&gt;busstatus
op_assign
id|ctrl_read
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_REVLEVEL
suffix:colon
op_star
id|pstatus
op_assign
id|ctrl_read
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_HPCOPTIONS
suffix:colon
op_star
id|pstatus
op_assign
id|ctrl_read
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_SLOTLATCHLOWREG
suffix:colon
singleline_comment|// DO NOT update the slot structure
op_star
id|pstatus
op_assign
id|ctrl_read
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// Not used
r_case
id|READ_ALLSLOT
suffix:colon
id|list_for_each
(paren
id|pslotlist
comma
op_amp
id|ibmphp_slot_head
)paren
(brace
id|pslot
op_assign
id|list_entry
(paren
id|pslotlist
comma
r_struct
id|slot
comma
id|ibm_slot_list
)paren
suffix:semicolon
id|index
op_assign
id|pslot-&gt;ctlr_index
suffix:semicolon
id|rc
op_assign
id|hpc_wait_ctlr_notworking
(paren
id|HPC_CTLR_WORKING_TOUT
comma
id|ctlr_ptr
comma
id|wpg_bbar
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|pslot-&gt;status
op_assign
id|ctrl_read
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|index
)paren
suffix:semicolon
id|rc
op_assign
id|hpc_wait_ctlr_notworking
(paren
id|HPC_CTLR_WORKING_TOUT
comma
id|ctlr_ptr
comma
id|wpg_bbar
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|pslot-&gt;ext_status
op_assign
id|ctrl_read
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|index
op_plus
id|WPG_1ST_EXTSLOT_INDEX
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
(paren
l_string|&quot;%s - Error ctrl_read failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// cleanup
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// remove physical to logical address mapping
r_if
c_cond
(paren
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|2
)paren
op_logical_or
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|4
)paren
)paren
id|iounmap
(paren
id|wpg_bbar
)paren
suffix:semicolon
id|free_hpc_access
(paren
)paren
suffix:semicolon
id|debug_polling
(paren
l_string|&quot;%s - Exit rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    ibmphp_hpc_writeslot()&n;*&n;* Action: issue a WRITE command to HPC&n;*---------------------------------------------------------------------*/
DECL|function|ibmphp_hpc_writeslot
r_int
id|ibmphp_hpc_writeslot
(paren
r_struct
id|slot
op_star
id|pslot
comma
id|u8
id|cmd
)paren
(brace
r_void
op_star
id|wpg_bbar
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|controller
op_star
id|ctlr_ptr
suffix:semicolon
id|u8
id|index
comma
id|status
suffix:semicolon
r_int
id|busindex
suffix:semicolon
id|u8
id|done
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|debug_polling
(paren
l_string|&quot;%s - Entry pslot[%lx] cmd[%x]&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
id|ulong
)paren
id|pslot
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pslot
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|err
(paren
l_string|&quot;%s - Error Exit rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|HPC_BUS_33CONVMODE
)paren
op_logical_or
(paren
id|cmd
op_eq
id|HPC_BUS_66CONVMODE
)paren
op_logical_or
(paren
id|cmd
op_eq
id|HPC_BUS_66PCIXMODE
)paren
op_logical_or
(paren
id|cmd
op_eq
id|HPC_BUS_100PCIXMODE
)paren
op_logical_or
(paren
id|cmd
op_eq
id|HPC_BUS_133PCIXMODE
)paren
)paren
(brace
id|busindex
op_assign
id|ibmphp_get_bus_index
(paren
id|pslot-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|busindex
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|err
(paren
l_string|&quot;%s - Exit Error:invalid bus, rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
id|index
op_assign
(paren
id|u8
)paren
id|busindex
suffix:semicolon
)brace
r_else
id|index
op_assign
id|pslot-&gt;ctlr_index
suffix:semicolon
id|index
op_assign
id|hpc_writecmdtoindex
(paren
id|cmd
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
id|HPC_ERROR
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|err
(paren
l_string|&quot;%s - Error Exit rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|ctlr_ptr
op_assign
id|pslot-&gt;ctrl
suffix:semicolon
id|get_hpc_access
(paren
)paren
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// map physical address to logical address
singleline_comment|//--------------------------------------------------------------------
r_if
c_cond
(paren
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|2
)paren
op_logical_or
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|4
)paren
)paren
(brace
id|wpg_bbar
op_assign
id|ioremap
(paren
id|ctlr_ptr-&gt;u.wpeg_ctlr.wpegbbar
comma
id|WPG_I2C_IOREMAP_SIZE
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - ctlr id[%x] physical[%lx] logical[%lx] i2c[%x]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ctlr_ptr-&gt;ctlr_id
comma
(paren
id|ulong
)paren
(paren
id|ctlr_ptr-&gt;u.wpeg_ctlr.wpegbbar
)paren
comma
(paren
id|ulong
)paren
id|wpg_bbar
comma
id|ctlr_ptr-&gt;u.wpeg_ctlr.i2c_addr
)paren
suffix:semicolon
)brace
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// check controller status before writing
singleline_comment|//--------------------------------------------------------------------
id|rc
op_assign
id|hpc_wait_ctlr_notworking
(paren
id|HPC_CTLR_WORKING_TOUT
comma
id|ctlr_ptr
comma
id|wpg_bbar
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|ctrl_write
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|index
comma
id|cmd
)paren
suffix:semicolon
singleline_comment|//--------------------------------------------------------------------
singleline_comment|// check controller is still not working on the command
singleline_comment|//--------------------------------------------------------------------
id|timeout
op_assign
id|CMD_COMPLETE_TOUT_SEC
suffix:semicolon
id|done
op_assign
id|FALSE
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
(brace
id|rc
op_assign
id|hpc_wait_ctlr_notworking
(paren
id|HPC_CTLR_WORKING_TOUT
comma
id|ctlr_ptr
comma
id|wpg_bbar
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
r_if
c_cond
(paren
id|NEEDTOCHECK_CMDSTATUS
(paren
id|cmd
)paren
)paren
(brace
r_if
c_cond
(paren
id|CTLR_FINISHED
(paren
id|status
)paren
op_eq
id|HPC_CTLR_FINISHED_YES
)paren
id|done
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
id|done
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
(brace
id|long_delay
(paren
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
OL
l_int|1
)paren
(brace
id|done
op_assign
id|TRUE
suffix:semicolon
id|err
(paren
l_string|&quot;%s - Error command complete timeout&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
id|timeout
op_decrement
suffix:semicolon
)brace
)brace
id|ctlr_ptr-&gt;status
op_assign
id|status
suffix:semicolon
)brace
singleline_comment|// cleanup
singleline_comment|// remove physical to logical address mapping
r_if
c_cond
(paren
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|2
)paren
op_logical_or
(paren
id|ctlr_ptr-&gt;ctlr_type
op_eq
l_int|4
)paren
)paren
id|iounmap
(paren
id|wpg_bbar
)paren
suffix:semicolon
id|free_hpc_access
(paren
)paren
suffix:semicolon
id|debug_polling
(paren
l_string|&quot;%s - Exit rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    get_hpc_access()&n;*&n;* Action: make sure only one process can access HPC at one time&n;*---------------------------------------------------------------------*/
DECL|function|get_hpc_access
r_static
r_void
id|get_hpc_access
(paren
r_void
)paren
(brace
id|down
(paren
op_amp
id|sem_hpcaccess
)paren
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    free_hpc_access()&n;*---------------------------------------------------------------------*/
DECL|function|free_hpc_access
r_void
id|free_hpc_access
(paren
r_void
)paren
(brace
id|up
(paren
op_amp
id|sem_hpcaccess
)paren
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    ibmphp_lock_operations()&n;*&n;* Action: make sure only one process can change the data structure&n;*---------------------------------------------------------------------*/
DECL|function|ibmphp_lock_operations
r_void
id|ibmphp_lock_operations
(paren
r_void
)paren
(brace
id|down
(paren
op_amp
id|semOperations
)paren
suffix:semicolon
id|to_debug
op_assign
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    ibmphp_unlock_operations()&n;*---------------------------------------------------------------------*/
DECL|function|ibmphp_unlock_operations
r_void
id|ibmphp_unlock_operations
(paren
r_void
)paren
(brace
id|debug
(paren
l_string|&quot;%s - Entry&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|up
(paren
op_amp
id|semOperations
)paren
suffix:semicolon
id|to_debug
op_assign
id|FALSE
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    poll_hpc()&n;*---------------------------------------------------------------------*/
DECL|macro|POLL_LATCH_REGISTER
mdefine_line|#define POLL_LATCH_REGISTER&t;0
DECL|macro|POLL_SLOTS
mdefine_line|#define POLL_SLOTS&t;&t;1
DECL|macro|POLL_SLEEP
mdefine_line|#define POLL_SLEEP&t;&t;2
DECL|function|poll_hpc
r_static
r_void
id|poll_hpc
(paren
r_void
)paren
(brace
r_struct
id|slot
id|myslot
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|pslotlist
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|poll_state
op_assign
id|POLL_LATCH_REGISTER
suffix:semicolon
id|u8
id|oldlatchlow
op_assign
l_int|0x00
suffix:semicolon
id|u8
id|curlatchlow
op_assign
l_int|0x00
suffix:semicolon
r_int
id|poll_count
op_assign
l_int|0
suffix:semicolon
id|u8
id|ctrl_count
op_assign
l_int|0x00
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Entry&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|ibmphp_shutdown
)paren
(brace
r_if
c_cond
(paren
id|ibmphp_shutdown
)paren
r_break
suffix:semicolon
multiline_comment|/* try to get the lock to do some kind of harware access */
id|down
(paren
op_amp
id|semOperations
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|poll_state
)paren
(brace
r_case
id|POLL_LATCH_REGISTER
suffix:colon
id|oldlatchlow
op_assign
id|curlatchlow
suffix:semicolon
id|ctrl_count
op_assign
l_int|0x00
suffix:semicolon
id|list_for_each
(paren
id|pslotlist
comma
op_amp
id|ibmphp_slot_head
)paren
(brace
r_if
c_cond
(paren
id|ctrl_count
op_ge
id|ibmphp_get_total_controllers
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
id|pslot
op_assign
id|list_entry
(paren
id|pslotlist
comma
r_struct
id|slot
comma
id|ibm_slot_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pslot-&gt;ctrl-&gt;ctlr_relative_id
op_eq
id|ctrl_count
)paren
(brace
id|ctrl_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|READ_SLOT_LATCH
(paren
id|pslot-&gt;ctrl
)paren
)paren
(brace
id|rc
op_assign
id|ibmphp_hpc_readslot
(paren
id|pslot
comma
id|READ_SLOTLATCHLOWREG
comma
op_amp
id|curlatchlow
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oldlatchlow
op_ne
id|curlatchlow
)paren
id|process_changeinlatch
(paren
id|oldlatchlow
comma
id|curlatchlow
comma
id|pslot-&gt;ctrl
)paren
suffix:semicolon
)brace
)brace
)brace
op_increment
id|poll_count
suffix:semicolon
id|poll_state
op_assign
id|POLL_SLEEP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|POLL_SLOTS
suffix:colon
id|list_for_each
(paren
id|pslotlist
comma
op_amp
id|ibmphp_slot_head
)paren
(brace
id|pslot
op_assign
id|list_entry
(paren
id|pslotlist
comma
r_struct
id|slot
comma
id|ibm_slot_list
)paren
suffix:semicolon
singleline_comment|// make a copy of the old status
id|memcpy
(paren
(paren
r_void
op_star
)paren
op_amp
id|myslot
comma
(paren
r_void
op_star
)paren
id|pslot
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_hpc_readslot
(paren
id|pslot
comma
id|READ_ALLSTAT
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|myslot.status
op_ne
id|pslot-&gt;status
)paren
op_logical_or
(paren
id|myslot.ext_status
op_ne
id|pslot-&gt;ext_status
)paren
)paren
id|process_changeinstatus
(paren
id|pslot
comma
op_amp
id|myslot
)paren
suffix:semicolon
)brace
id|ctrl_count
op_assign
l_int|0x00
suffix:semicolon
id|list_for_each
(paren
id|pslotlist
comma
op_amp
id|ibmphp_slot_head
)paren
(brace
r_if
c_cond
(paren
id|ctrl_count
op_ge
id|ibmphp_get_total_controllers
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
id|pslot
op_assign
id|list_entry
(paren
id|pslotlist
comma
r_struct
id|slot
comma
id|ibm_slot_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pslot-&gt;ctrl-&gt;ctlr_relative_id
op_eq
id|ctrl_count
)paren
(brace
id|ctrl_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|READ_SLOT_LATCH
(paren
id|pslot-&gt;ctrl
)paren
)paren
id|rc
op_assign
id|ibmphp_hpc_readslot
(paren
id|pslot
comma
id|READ_SLOTLATCHLOWREG
comma
op_amp
id|curlatchlow
)paren
suffix:semicolon
)brace
)brace
op_increment
id|poll_count
suffix:semicolon
id|poll_state
op_assign
id|POLL_SLEEP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|POLL_SLEEP
suffix:colon
multiline_comment|/* don&squot;t sleep with a lock on the hardware */
id|up
(paren
op_amp
id|semOperations
)paren
suffix:semicolon
id|long_delay
(paren
id|POLL_INTERVAL_SEC
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_shutdown
)paren
r_break
suffix:semicolon
id|down
(paren
op_amp
id|semOperations
)paren
suffix:semicolon
r_if
c_cond
(paren
id|poll_count
op_ge
id|POLL_LATCH_CNT
)paren
(brace
id|poll_count
op_assign
l_int|0
suffix:semicolon
id|poll_state
op_assign
id|POLL_SLOTS
suffix:semicolon
)brace
r_else
id|poll_state
op_assign
id|POLL_LATCH_REGISTER
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* give up the harware semaphore */
id|up
(paren
op_amp
id|semOperations
)paren
suffix:semicolon
multiline_comment|/* sleep for a short time just for good measure */
id|set_current_state
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
)brace
id|up
(paren
op_amp
id|sem_exit
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------&n; *  Name:    ibmphp_hpc_fillhpslotinfo(hotplug_slot * phpslot)&n; *&n; *  Action:  fill out the hotplug_slot info&n; *&n; *  Input:   pointer to hotplug_slot&n; *&n; *  Return&n; *  Value:   0 or error codes&n; *-----------------------------------------------------------------------*/
DECL|function|ibmphp_hpc_fillhpslotinfo
r_int
id|ibmphp_hpc_fillhpslotinfo
(paren
r_struct
id|hotplug_slot
op_star
id|phpslot
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
r_if
c_cond
(paren
id|phpslot
op_logical_and
id|phpslot
op_member_access_from_pointer
r_private
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|phpslot
op_member_access_from_pointer
r_private
suffix:semicolon
id|rc
op_assign
id|update_slot
(paren
id|pslot
comma
(paren
id|u8
)paren
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
singleline_comment|// power - enabled:1  not:0
id|phpslot-&gt;info-&gt;power_status
op_assign
id|SLOT_POWER
(paren
id|pslot-&gt;status
)paren
suffix:semicolon
singleline_comment|// attention - off:0, on:1, blinking:2
id|phpslot-&gt;info-&gt;attention_status
op_assign
id|SLOT_ATTN
(paren
id|pslot-&gt;status
comma
id|pslot-&gt;ext_status
)paren
suffix:semicolon
singleline_comment|// latch - open:1 closed:0
id|phpslot-&gt;info-&gt;latch_status
op_assign
id|SLOT_LATCH
(paren
id|pslot-&gt;status
)paren
suffix:semicolon
singleline_comment|// pci board - present:1 not:0
r_if
c_cond
(paren
id|SLOT_PRESENT
(paren
id|pslot-&gt;status
)paren
)paren
id|phpslot-&gt;info-&gt;adapter_status
op_assign
l_int|1
suffix:semicolon
r_else
id|phpslot-&gt;info-&gt;adapter_status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;if (pslot-&gt;bus_on-&gt;supported_bus_mode&n;&t;&t;&t;&t;&amp;&amp; (pslot-&gt;bus_on-&gt;supported_speed == BUS_SPEED_66))&n;&t;&t;&t;&t;phpslot-&gt;info-&gt;max_bus_speed_status = BUS_SPEED_66PCIX;&n;&t;&t;&t;else&n;&t;&t;&t;&t;phpslot-&gt;info-&gt;max_bus_speed_status = pslot-&gt;bus_on-&gt;supported_speed;&n;*/
)brace
r_else
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    update_slot&n;*&n;* Action:  fill out slot status and extended status, controller status&n;*&n;* Input:   pointer to slot struct&n;*---------------------------------------------------------------------*/
DECL|function|update_slot
r_static
r_int
id|update_slot
(paren
r_struct
id|slot
op_star
id|pslot
comma
id|u8
id|update
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Entry pslot[%lx]&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
id|ulong
)paren
id|pslot
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_hpc_readslot
(paren
id|pslot
comma
id|READ_ALLSTAT
comma
l_int|NULL
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Exit rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    process_changeinstatus&n;*&n;* Action:  compare old and new slot status, process the change in status&n;*&n;* Input:   pointer to slot struct, old slot struct&n;*&n;* Return   0 or error codes&n;* Value:&n;*&n;* Side&n;* Effects: None.&n;*&n;* Notes:&n;*---------------------------------------------------------------------*/
DECL|function|process_changeinstatus
r_static
r_int
id|process_changeinstatus
(paren
r_struct
id|slot
op_star
id|pslot
comma
r_struct
id|slot
op_star
id|poldslot
)paren
(brace
id|u8
id|status
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|u8
id|disable
op_assign
id|FALSE
suffix:semicolon
id|u8
id|update
op_assign
id|FALSE
suffix:semicolon
id|debug
(paren
l_string|&quot;process_changeinstatus - Entry pslot[%lx], poldslot[%lx]&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|pslot
comma
(paren
id|ulong
)paren
id|poldslot
)paren
suffix:semicolon
singleline_comment|// bit 0 - HPC_SLOT_POWER
r_if
c_cond
(paren
(paren
id|pslot-&gt;status
op_amp
l_int|0x01
)paren
op_ne
(paren
id|poldslot-&gt;status
op_amp
l_int|0x01
)paren
)paren
id|update
op_assign
id|TRUE
suffix:semicolon
singleline_comment|// bit 1 - HPC_SLOT_CONNECT
singleline_comment|// ignore
singleline_comment|// bit 2 - HPC_SLOT_ATTN
r_if
c_cond
(paren
(paren
id|pslot-&gt;status
op_amp
l_int|0x04
)paren
op_ne
(paren
id|poldslot-&gt;status
op_amp
l_int|0x04
)paren
)paren
id|update
op_assign
id|TRUE
suffix:semicolon
singleline_comment|// bit 3 - HPC_SLOT_PRSNT2
singleline_comment|// bit 4 - HPC_SLOT_PRSNT1
r_if
c_cond
(paren
(paren
(paren
id|pslot-&gt;status
op_amp
l_int|0x08
)paren
op_ne
(paren
id|poldslot-&gt;status
op_amp
l_int|0x08
)paren
)paren
op_logical_or
(paren
(paren
id|pslot-&gt;status
op_amp
l_int|0x10
)paren
op_ne
(paren
id|poldslot-&gt;status
op_amp
l_int|0x10
)paren
)paren
)paren
id|update
op_assign
id|TRUE
suffix:semicolon
singleline_comment|// bit 5 - HPC_SLOT_PWRGD
r_if
c_cond
(paren
(paren
id|pslot-&gt;status
op_amp
l_int|0x20
)paren
op_ne
(paren
id|poldslot-&gt;status
op_amp
l_int|0x20
)paren
)paren
singleline_comment|// OFF -&gt; ON: ignore, ON -&gt; OFF: disable slot
r_if
c_cond
(paren
(paren
id|poldslot-&gt;status
op_amp
l_int|0x20
)paren
op_logical_and
(paren
id|SLOT_CONNECT
(paren
id|poldslot-&gt;status
)paren
op_eq
id|HPC_SLOT_CONNECTED
)paren
op_logical_and
(paren
id|SLOT_PRESENT
(paren
id|poldslot-&gt;status
)paren
)paren
)paren
id|disable
op_assign
id|TRUE
suffix:semicolon
singleline_comment|// bit 6 - HPC_SLOT_BUS_SPEED
singleline_comment|// ignore
singleline_comment|// bit 7 - HPC_SLOT_LATCH
r_if
c_cond
(paren
(paren
id|pslot-&gt;status
op_amp
l_int|0x80
)paren
op_ne
(paren
id|poldslot-&gt;status
op_amp
l_int|0x80
)paren
)paren
(brace
id|update
op_assign
id|TRUE
suffix:semicolon
singleline_comment|// OPEN -&gt; CLOSE
r_if
c_cond
(paren
id|pslot-&gt;status
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|SLOT_PWRGD
(paren
id|pslot-&gt;status
)paren
)paren
(brace
singleline_comment|// power goes on and off after closing latch
singleline_comment|// check again to make sure power is still ON
id|long_delay
(paren
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_hpc_readslot
(paren
id|pslot
comma
id|READ_SLOTSTATUS
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SLOT_PWRGD
(paren
id|status
)paren
)paren
id|update
op_assign
id|TRUE
suffix:semicolon
r_else
singleline_comment|// overwrite power in pslot to OFF
id|pslot-&gt;status
op_and_assign
op_complement
id|HPC_SLOT_POWER
suffix:semicolon
)brace
)brace
singleline_comment|// CLOSE -&gt; OPEN 
r_else
r_if
c_cond
(paren
(paren
id|SLOT_PWRGD
(paren
id|poldslot-&gt;status
)paren
op_eq
id|HPC_SLOT_PWRGD_GOOD
)paren
op_logical_and
(paren
id|SLOT_CONNECT
(paren
id|poldslot-&gt;status
)paren
op_eq
id|HPC_SLOT_CONNECTED
)paren
op_logical_and
(paren
id|SLOT_PRESENT
(paren
id|poldslot-&gt;status
)paren
)paren
)paren
(brace
id|disable
op_assign
id|TRUE
suffix:semicolon
)brace
singleline_comment|// else - ignore
)brace
singleline_comment|// bit 4 - HPC_SLOT_BLINK_ATTN
r_if
c_cond
(paren
(paren
id|pslot-&gt;ext_status
op_amp
l_int|0x08
)paren
op_ne
(paren
id|poldslot-&gt;ext_status
op_amp
l_int|0x08
)paren
)paren
id|update
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|disable
)paren
(brace
id|debug
(paren
l_string|&quot;process_changeinstatus - disable slot&bslash;n&quot;
)paren
suffix:semicolon
id|pslot-&gt;flag
op_assign
id|FALSE
suffix:semicolon
id|rc
op_assign
id|ibmphp_disable_slot
(paren
id|pslot-&gt;hotplug_slot
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|update
op_logical_or
id|disable
)paren
(brace
id|ibmphp_update_slot_info
(paren
id|pslot
)paren
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;%s - Exit rc[%d] disable[%x] update[%x]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
comma
id|disable
comma
id|update
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    process_changeinlatch&n;*&n;* Action:  compare old and new latch reg status, process the change&n;*&n;* Input:   old and current latch register status&n;*&n;* Return   0 or error codes&n;* Value:&n;*---------------------------------------------------------------------*/
DECL|function|process_changeinlatch
r_static
r_int
id|process_changeinlatch
(paren
id|u8
id|old
comma
id|u8
r_new
comma
r_struct
id|controller
op_star
id|ctrl
)paren
(brace
r_struct
id|slot
id|myslot
comma
op_star
id|pslot
suffix:semicolon
id|u8
id|i
suffix:semicolon
id|u8
id|mask
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Entry old[%x], new[%x]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|old
comma
r_new
)paren
suffix:semicolon
singleline_comment|// bit 0 reserved, 0 is LSB, check bit 1-6 for 6 slots
r_for
c_loop
(paren
id|i
op_assign
id|ctrl-&gt;starting_slot_num
suffix:semicolon
id|i
op_le
id|ctrl-&gt;ending_slot_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mask
op_assign
l_int|0x01
op_lshift
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mask
op_amp
id|old
)paren
op_ne
(paren
id|mask
op_amp
r_new
)paren
)paren
(brace
id|pslot
op_assign
id|ibmphp_get_slot_from_physical_num
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
(brace
id|memcpy
(paren
(paren
r_void
op_star
)paren
op_amp
id|myslot
comma
(paren
r_void
op_star
)paren
id|pslot
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_hpc_readslot
(paren
id|pslot
comma
id|READ_ALLSTAT
comma
l_int|NULL
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - call process_changeinstatus for slot[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|i
)paren
suffix:semicolon
id|process_changeinstatus
(paren
id|pslot
comma
op_amp
id|myslot
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|err
(paren
l_string|&quot;%s - Error bad pointer for slot[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
id|debug
(paren
l_string|&quot;%s - Exit rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    hpc_poll_thread&n;*&n;* Action:  polling&n;*&n;* Return   0&n;* Value:&n;*---------------------------------------------------------------------*/
DECL|function|hpc_poll_thread
r_static
r_int
id|hpc_poll_thread
(paren
r_void
op_star
id|data
)paren
(brace
id|debug
(paren
l_string|&quot;%s - Entry&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|lock_kernel
(paren
)paren
suffix:semicolon
id|daemonize
(paren
)paren
suffix:semicolon
singleline_comment|//  New name
id|strcpy
(paren
id|current-&gt;comm
comma
l_string|&quot;hpc_poll&quot;
)paren
suffix:semicolon
id|unlock_kernel
(paren
)paren
suffix:semicolon
id|poll_hpc
(paren
)paren
suffix:semicolon
id|tid_poll
op_assign
l_int|0
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    ibmphp_hpc_start_poll_thread&n;*&n;* Action:  start polling thread&n;*---------------------------------------------------------------------*/
DECL|function|ibmphp_hpc_start_poll_thread
r_int
id|__init
id|ibmphp_hpc_start_poll_thread
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Entry&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|tid_poll
op_assign
id|kernel_thread
(paren
id|hpc_poll_thread
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tid_poll
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;%s - Error, thread not started&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;%s - Exit tid_poll[%d] rc[%d]&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|tid_poll
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    ibmphp_hpc_stop_poll_thread&n;*&n;* Action:  stop polling thread and cleanup&n;*---------------------------------------------------------------------*/
DECL|function|ibmphp_hpc_stop_poll_thread
r_void
id|__exit
id|ibmphp_hpc_stop_poll_thread
(paren
r_void
)paren
(brace
id|debug
(paren
l_string|&quot;%s - Entry&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ibmphp_shutdown
op_assign
id|TRUE
suffix:semicolon
id|debug
(paren
l_string|&quot;before locking operations &bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after locking operations &bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|// wait for poll thread to exit
id|debug
(paren
l_string|&quot;before sem_exit down &bslash;n&quot;
)paren
suffix:semicolon
id|down
(paren
op_amp
id|sem_exit
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after sem_exit down &bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|// cleanup
id|debug
(paren
l_string|&quot;before free_hpc_access &bslash;n&quot;
)paren
suffix:semicolon
id|free_hpc_access
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after free_hpc_access &bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after unlock operations &bslash;n&quot;
)paren
suffix:semicolon
id|up
(paren
op_amp
id|sem_exit
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after sem exit up&bslash;n&quot;
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - Exit&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/*----------------------------------------------------------------------&n;* Name:    hpc_wait_ctlr_notworking&n;*&n;* Action:  wait until the controller is in a not working state&n;*&n;* Return   0, HPC_ERROR&n;* Value:&n;*---------------------------------------------------------------------*/
DECL|function|hpc_wait_ctlr_notworking
r_static
r_int
id|hpc_wait_ctlr_notworking
(paren
r_int
id|timeout
comma
r_struct
id|controller
op_star
id|ctlr_ptr
comma
r_void
op_star
id|wpg_bbar
comma
id|u8
op_star
id|pstatus
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|u8
id|done
op_assign
id|FALSE
suffix:semicolon
id|debug_polling
(paren
l_string|&quot;hpc_wait_ctlr_notworking - Entry timeout[%d]&bslash;n&quot;
comma
id|timeout
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
(brace
op_star
id|pstatus
op_assign
id|ctrl_read
(paren
id|ctlr_ptr
comma
id|wpg_bbar
comma
id|WPG_CTLR_INDEX
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pstatus
op_eq
id|HPC_ERROR
)paren
(brace
id|rc
op_assign
id|HPC_ERROR
suffix:semicolon
id|done
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CTLR_WORKING
(paren
op_star
id|pstatus
)paren
op_eq
id|HPC_CTLR_WORKING_NO
)paren
id|done
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
(brace
id|long_delay
(paren
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
OL
l_int|1
)paren
(brace
id|done
op_assign
id|TRUE
suffix:semicolon
id|err
(paren
l_string|&quot;HPCreadslot - Error ctlr timeout&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|HPC_ERROR
suffix:semicolon
)brace
r_else
id|timeout
op_decrement
suffix:semicolon
)brace
)brace
id|debug_polling
(paren
l_string|&quot;hpc_wait_ctlr_notworking - Exit rc[%x] status[%x]&bslash;n&quot;
comma
id|rc
comma
op_star
id|pstatus
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
eof
