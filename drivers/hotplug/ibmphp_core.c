multiline_comment|/*&n; * IBM Hot Plug Controller Driver&n; *&n; * Written By: Chuck Cole, Jyoti Shah, Tong Yu, Irene Zubarev, IBM Corporation&n; *&n; * Copyright (c) 2001 Greg Kroah-Hartman (greg@kroah.com)&n; * Copyright (c) 2001,2002 IBM Corp.&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Send feedback to &lt;gregkh@us.ibm.com&gt;&n; *&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &quot;../../arch/i386/kernel/pci-i386.h&quot;&t;/* for struct irq_routing_table */
macro_line|#include &quot;ibmphp.h&quot;
DECL|macro|attn_on
mdefine_line|#define attn_on(sl)  ibmphp_hpc_writeslot (sl, HPC_SLOT_ATTNON)
DECL|macro|attn_off
mdefine_line|#define attn_off(sl) ibmphp_hpc_writeslot (sl, HPC_SLOT_ATTNOFF)
DECL|macro|attn_LED_blink
mdefine_line|#define attn_LED_blink(sl) ibmphp_hpc_writeslot (sl, HPC_SLOT_BLINKLED)
DECL|macro|get_ctrl_revision
mdefine_line|#define get_ctrl_revision(sl, rev) ibmphp_hpc_readslot (sl, READ_REVLEVEL, rev)
DECL|macro|get_hpc_options
mdefine_line|#define get_hpc_options(sl, opt) ibmphp_hpc_readslot (sl, READ_HPCOPTIONS, opt)
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&quot;0.1&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;IBM Hot Plug PCI Controller Driver&quot;
DECL|variable|ibmphp_debug
r_int
id|ibmphp_debug
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
id|MODULE_PARM
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|debug
comma
l_string|&quot;Debugging mode enabled or not&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
DECL|variable|ops
r_static
r_int
op_star
id|ops
(braket
id|MAX_OPS
op_plus
l_int|1
)braket
suffix:semicolon
DECL|variable|ibmphp_pci_root_ops
r_static
r_struct
id|pci_ops
op_star
id|ibmphp_pci_root_ops
suffix:semicolon
DECL|variable|max_slots
r_static
r_int
id|max_slots
suffix:semicolon
DECL|variable|irqs
r_static
r_int
id|irqs
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* PIC mode IRQ&squot;s we&squot;re using so far (in case MPS tables don&squot;t provide default info for empty slots */
DECL|variable|init_flag
r_static
r_int
id|init_flag
suffix:semicolon
multiline_comment|/*&n;static int get_max_adapter_speed_1 (struct hotplug_slot *, u8 *, u8);&n;&n;static inline int get_max_adapter_speed (struct hotplug_slot *hs, u8 *value)&n;{&n;&t;return get_max_adapter_speed_1 (hs, value, 1);&n;}&n;*/
DECL|function|get_cur_bus_info
r_static
r_inline
r_int
id|get_cur_bus_info
(paren
r_struct
id|slot
op_star
op_star
id|sl
)paren
(brace
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
r_struct
id|slot
op_star
id|slot_cur
op_assign
op_star
id|sl
suffix:semicolon
id|debug
(paren
l_string|&quot;options = %x&bslash;n&quot;
comma
id|slot_cur-&gt;ctrl-&gt;options
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;revision = %x&bslash;n&quot;
comma
id|slot_cur-&gt;ctrl-&gt;revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|READ_BUS_STATUS
(paren
id|slot_cur-&gt;ctrl
)paren
)paren
id|rc
op_assign
id|ibmphp_hpc_readslot
(paren
id|slot_cur
comma
id|READ_BUSSTATUS
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|slot_cur-&gt;bus_on-&gt;current_speed
op_assign
id|CURRENT_BUS_SPEED
(paren
id|slot_cur-&gt;busstatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|READ_BUS_MODE
(paren
id|slot_cur-&gt;ctrl
)paren
)paren
id|slot_cur-&gt;bus_on-&gt;current_bus_mode
op_assign
id|CURRENT_BUS_MODE
(paren
id|slot_cur-&gt;busstatus
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;busstatus = %x, bus_speed = %x, bus_mode = %x&bslash;n&quot;
comma
id|slot_cur-&gt;busstatus
comma
id|slot_cur-&gt;bus_on-&gt;current_speed
comma
id|slot_cur-&gt;bus_on-&gt;current_bus_mode
)paren
suffix:semicolon
op_star
id|sl
op_assign
id|slot_cur
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|slot_update
r_static
r_inline
r_int
id|slot_update
(paren
r_struct
id|slot
op_star
op_star
id|sl
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|ibmphp_hpc_readslot
(paren
op_star
id|sl
comma
id|READ_ALLSTAT
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|init_flag
)paren
r_return
id|get_cur_bus_info
(paren
id|sl
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_max_slots
r_static
r_int
id|get_max_slots
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_int
id|slot_count
op_assign
l_int|0
suffix:semicolon
id|list_for_each
(paren
id|tmp
comma
op_amp
id|ibmphp_slot_head
)paren
op_increment
id|slot_count
suffix:semicolon
r_return
id|slot_count
suffix:semicolon
)brace
multiline_comment|/* This routine will put the correct slot-&gt;device information per slot.  It&squot;s&n; * called from initialization of the slot structures. It will also assign&n; * interrupt numbers per each slot.&n; * Parameters: struct slot&n; * Returns 0 or errors&n; */
DECL|function|ibmphp_init_devno
r_int
id|ibmphp_init_devno
(paren
r_struct
id|slot
op_star
op_star
id|cur_slot
)paren
(brace
r_struct
id|irq_routing_table
op_star
id|rtable
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|loop
suffix:semicolon
r_int
id|i
suffix:semicolon
id|rtable
op_assign
id|pcibios_get_irq_routing_table
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rtable
)paren
(brace
id|err
(paren
l_string|&quot;no BIOS routing table...&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|len
op_assign
(paren
id|rtable-&gt;size
op_minus
r_sizeof
(paren
r_struct
id|irq_routing_table
)paren
)paren
op_div
r_sizeof
(paren
r_struct
id|irq_info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
id|len
suffix:semicolon
id|loop
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|number
op_eq
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|slot
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|bus
op_eq
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|bus
)paren
(brace
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|device
op_assign
id|PCI_SLOT
(paren
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|devfn
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|irq
(braket
id|i
)braket
op_assign
id|IO_APIC_get_PCI_irq_vector
(paren
(paren
r_int
)paren
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|bus
comma
(paren
r_int
)paren
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|device
comma
id|i
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;(*cur_slot)-&gt;irq[0] = %x&bslash;n&quot;
comma
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|irq
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;(*cur_slot)-&gt;irq[1] = %x&bslash;n&quot;
comma
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|irq
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;(*cur_slot)-&gt;irq[2] = %x&bslash;n&quot;
comma
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|irq
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;(*cur_slot)-&gt;irq[3] = %x&bslash;n&quot;
comma
(paren
op_star
id|cur_slot
)paren
op_member_access_from_pointer
id|irq
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;exlusive_irqs = %x&bslash;n&quot;
comma
id|rtable-&gt;exclusive_irqs
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[0].bitmap = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|0
)braket
dot
id|bitmap
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[1].bitmap = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|1
)braket
dot
id|bitmap
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[2].bitmap = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|2
)braket
dot
id|bitmap
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[3].bitmap = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|3
)braket
dot
id|bitmap
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[0].link= %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|0
)braket
dot
id|link
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[1].link = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|1
)braket
dot
id|link
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[2].link = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|2
)braket
dot
id|link
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;rtable-&gt;slots[loop].irq[3].link = %x&bslash;n&quot;
comma
id|rtable-&gt;slots
(braket
id|loop
)braket
dot
id|irq
(braket
l_int|3
)braket
dot
id|link
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;end of init_devno&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|power_on
r_static
r_inline
r_int
id|power_on
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
id|u8
id|cmd
op_assign
id|HPC_SLOT_ON
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|ibmphp_hpc_writeslot
(paren
id|slot_cur
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
(paren
l_string|&quot;power on failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CTLR_RESULT
(paren
id|slot_cur-&gt;ctrl-&gt;status
)paren
)paren
(brace
id|err
(paren
l_string|&quot;command not completed successfully in power_on &bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|long_delay
(paren
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* For ServeRAID cards, and some 66 PCI */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|power_off
r_static
r_inline
r_int
id|power_off
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
id|u8
id|cmd
op_assign
id|HPC_SLOT_OFF
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|ibmphp_hpc_writeslot
(paren
id|slot_cur
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|err
(paren
l_string|&quot;power off failed &bslash;n&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CTLR_RESULT
(paren
id|slot_cur-&gt;ctrl-&gt;status
)paren
)paren
(brace
id|err
(paren
l_string|&quot;command not completed successfully in power_off &bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_attention_status
r_static
r_int
id|set_attention_status
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
id|value
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
id|u8
id|cmd
suffix:semicolon
r_int
id|hpcrc
op_assign
l_int|0
suffix:semicolon
id|debug
(paren
l_string|&quot;set_attention_status - Entry hotplug_slot[%lx] value[%x]&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|hotplug_slot
comma
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
id|cmd
op_assign
l_int|0x00
suffix:semicolon
singleline_comment|// avoid compiler warning
r_if
c_cond
(paren
id|hotplug_slot
)paren
(brace
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
id|HPC_SLOT_ATTN_OFF
suffix:colon
id|cmd
op_assign
id|HPC_SLOT_ATTNOFF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HPC_SLOT_ATTN_ON
suffix:colon
id|cmd
op_assign
id|HPC_SLOT_ATTNON
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HPC_SLOT_ATTN_BLINK
suffix:colon
id|cmd
op_assign
id|HPC_SLOT_BLINKLED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|err
(paren
l_string|&quot;set_attention_status - Error : invalid input [%x]&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
id|hpcrc
op_assign
id|ibmphp_hpc_writeslot
(paren
id|pslot
comma
id|cmd
)paren
suffix:semicolon
r_else
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_else
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|hpcrc
)paren
id|rc
op_assign
id|hpcrc
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;set_attention_status - Exit rc[%d]&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_attention_status
r_static
r_int
id|get_attention_status
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
r_int
id|hpcrc
op_assign
l_int|0
suffix:semicolon
r_struct
id|slot
id|myslot
suffix:semicolon
id|debug
(paren
l_string|&quot;get_attention_status - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|hotplug_slot
comma
(paren
id|ulong
)paren
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hotplug_slot
op_logical_and
id|value
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
(brace
id|memcpy
(paren
(paren
r_void
op_star
)paren
op_amp
id|myslot
comma
(paren
r_void
op_star
)paren
id|pslot
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|hpcrc
op_assign
id|ibmphp_hpc_readslot
(paren
id|pslot
comma
id|READ_SLOTSTATUS
comma
op_amp
(paren
id|myslot.status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpcrc
)paren
id|hpcrc
op_assign
id|ibmphp_hpc_readslot
(paren
id|pslot
comma
id|READ_EXTSLOTSTATUS
comma
op_amp
(paren
id|myslot.ext_status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpcrc
)paren
(brace
op_star
id|value
op_assign
id|SLOT_ATTN
(paren
id|myslot.status
comma
id|myslot.ext_status
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|hpcrc
)paren
id|rc
op_assign
id|hpcrc
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;get_attention_status - Exit rc[%d] hpcrc[%x] value[%x]&bslash;n&quot;
comma
id|rc
comma
id|hpcrc
comma
op_star
id|value
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_latch_status
r_static
r_int
id|get_latch_status
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
r_int
id|hpcrc
op_assign
l_int|0
suffix:semicolon
r_struct
id|slot
id|myslot
suffix:semicolon
id|debug
(paren
l_string|&quot;get_latch_status - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|hotplug_slot
comma
(paren
id|ulong
)paren
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hotplug_slot
op_logical_and
id|value
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
(brace
id|memcpy
(paren
(paren
r_void
op_star
)paren
op_amp
id|myslot
comma
(paren
r_void
op_star
)paren
id|pslot
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|hpcrc
op_assign
id|ibmphp_hpc_readslot
(paren
id|pslot
comma
id|READ_SLOTSTATUS
comma
op_amp
(paren
id|myslot.status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpcrc
)paren
(brace
op_star
id|value
op_assign
id|SLOT_LATCH
(paren
id|myslot.status
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|hpcrc
)paren
id|rc
op_assign
id|hpcrc
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;get_latch_status - Exit rc[%d] hpcrc[%x] value[%x]&bslash;n&quot;
comma
id|rc
comma
id|hpcrc
comma
op_star
id|value
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_power_status
r_static
r_int
id|get_power_status
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
r_int
id|hpcrc
op_assign
l_int|0
suffix:semicolon
r_struct
id|slot
id|myslot
suffix:semicolon
id|debug
(paren
l_string|&quot;get_power_status - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|hotplug_slot
comma
(paren
id|ulong
)paren
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hotplug_slot
op_logical_and
id|value
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
(brace
id|memcpy
(paren
(paren
r_void
op_star
)paren
op_amp
id|myslot
comma
(paren
r_void
op_star
)paren
id|pslot
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|hpcrc
op_assign
id|ibmphp_hpc_readslot
(paren
id|pslot
comma
id|READ_SLOTSTATUS
comma
op_amp
(paren
id|myslot.status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpcrc
)paren
(brace
op_star
id|value
op_assign
id|SLOT_POWER
(paren
id|myslot.status
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|hpcrc
)paren
id|rc
op_assign
id|hpcrc
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;get_power_status - Exit rc[%d] hpcrc[%x] value[%x]&bslash;n&quot;
comma
id|rc
comma
id|hpcrc
comma
op_star
id|value
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_adapter_present
r_static
r_int
id|get_adapter_present
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
comma
id|u8
op_star
id|value
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|slot
op_star
id|pslot
suffix:semicolon
id|u8
id|present
suffix:semicolon
r_int
id|hpcrc
op_assign
l_int|0
suffix:semicolon
r_struct
id|slot
id|myslot
suffix:semicolon
id|debug
(paren
l_string|&quot;get_adapter_status - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|hotplug_slot
comma
(paren
id|ulong
)paren
id|value
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hotplug_slot
op_logical_and
id|value
)paren
(brace
id|pslot
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|pslot
)paren
(brace
id|memcpy
(paren
(paren
r_void
op_star
)paren
op_amp
id|myslot
comma
(paren
r_void
op_star
)paren
id|pslot
comma
r_sizeof
(paren
r_struct
id|slot
)paren
)paren
suffix:semicolon
id|hpcrc
op_assign
id|ibmphp_hpc_readslot
(paren
id|pslot
comma
id|READ_SLOTSTATUS
comma
op_amp
(paren
id|myslot.status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpcrc
)paren
(brace
id|present
op_assign
id|SLOT_PRESENT
(paren
id|myslot.status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|present
op_eq
id|HPC_SLOT_EMPTY
)paren
op_star
id|value
op_assign
l_int|0
suffix:semicolon
r_else
op_star
id|value
op_assign
l_int|1
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|hpcrc
)paren
id|rc
op_assign
id|hpcrc
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;get_adapter_present - Exit rc[%d] hpcrc[%x] value[%x]&bslash;n&quot;
comma
id|rc
comma
id|hpcrc
comma
op_star
id|value
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n;static int get_max_bus_speed (struct hotplug_slot *hotplug_slot, u8 * value)&n;{&n;&t;int rc = -ENODEV;&n;&t;struct slot *pslot;&n;&t;u8 mode = 0;&n;&n;&t;debug (&quot;get_max_bus_speed - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;, (ulong)hotplug_slot, (ulong) value);&n;&n;&t;ibmphp_lock_operations ();&n;&n;&t;if (hotplug_slot &amp;&amp; value) {&n;&t;&t;pslot = (struct slot *) hotplug_slot-&gt;private;&n;&t;&t;if (pslot) {&n;&t;&t;&t;rc = 0;&n;&t;&t;&t;mode = pslot-&gt;bus_on-&gt;supported_bus_mode;&n;&t;&t;&t;*value = pslot-&gt;bus_on-&gt;supported_speed;&n;&t;&t;&t;*value &amp;= 0x0f;&n;&n;&t;&t;&t;if (mode == BUS_MODE_PCIX)&n;&t;&t;&t;&t;*value |= 0x80;&n;&t;&t;&t;else if (mode == BUS_MODE_PCI)&n;&t;&t;&t;&t;*value |= 0x40;&n;&t;&t;&t;else&n;&t;&t;&t;&t;*value |= 0x20;&n;&t;&t;}&n;&t;} else&n;&t;&t;rc = -ENODEV;&n;&n;&t;ibmphp_unlock_operations ();&n;&t;debug (&quot;get_max_bus_speed - Exit rc[%d] value[%x]&bslash;n&quot;, rc, *value);&n;&t;return rc;&n;}&n;&n;static int get_cur_bus_speed (struct hotplug_slot *hotplug_slot, u8 * value)&n;{&n;&t;int rc = -ENODEV;&n;&t;struct slot *pslot;&n;&t;u8 mode = 0;&n;&n;&t;debug (&quot;get_cur_bus_speed - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;, (ulong)hotplug_slot, (ulong) value);&n;&n;&t;ibmphp_lock_operations ();&n;&n;&t;if (hotplug_slot &amp;&amp; value) {&n;&t;&t;pslot = (struct slot *) hotplug_slot-&gt;private;&n;&t;&t;if (pslot) {&n;&t;&t;&t;rc = get_cur_bus_info (&amp;pslot);&n;&t;&t;&t;if (!rc) {&n;&t;&t;&t;&t;mode = pslot-&gt;bus_on-&gt;current_bus_mode;&n;&t;&t;&t;&t;*value = pslot-&gt;bus_on-&gt;current_speed;&n;&t;&t;&t;&t;*value &amp;= 0x0f;&n;&t;&t;&t;&t;&n;&t;&t;&t;&t;if (mode == BUS_MODE_PCIX)&n;&t;&t;&t;&t;&t;*value |= 0x80;&n;&t;&t;&t;&t;else if (mode == BUS_MODE_PCI)&n;&t;&t;&t;&t;&t;*value |= 0x40;&n;&t;&t;&t;&t;else&n;&t;&t;&t;&t;&t;*value |= 0x20;&t;&n;&t;&t;&t;}&n;&t;&t;}&n;&t;} else&n;&t;&t;rc = -ENODEV;&n;&n;&t;ibmphp_unlock_operations ();&n;&t;debug (&quot;get_cur_bus_speed - Exit rc[%d] value[%x]&bslash;n&quot;, rc, *value);&n;&t;return rc;&n;}&n;&n;static int get_max_adapter_speed_1 (struct hotplug_slot *hotplug_slot, u8 * value, u8 flag)&n;{&n;&t;int rc = -ENODEV;&n;&t;struct slot *pslot;&n;&t;int hpcrc = 0;&n;&t;struct slot myslot;&n;&n;&t;debug (&quot;get_max_adapter_speed - Entry hotplug_slot[%lx] pvalue[%lx]&bslash;n&quot;, (ulong)hotplug_slot, (ulong) value);&n;&n;&t;if (flag)&n;&t;&t;ibmphp_lock_operations ();&n;&n;&t;if (hotplug_slot &amp;&amp; value) {&n;&t;&t;pslot = (struct slot *) hotplug_slot-&gt;private;&n;&t;&t;if (pslot) {&n;&t;&t;&t;memcpy ((void *) &amp;myslot, (void *) pslot, sizeof (struct slot));&n;&t;&t;&t;hpcrc = ibmphp_hpc_readslot (pslot, READ_SLOTSTATUS, &amp;(myslot.status));&n;&n;&t;&t;&t;if (!(SLOT_LATCH (myslot.status)) &amp;&amp; (SLOT_PRESENT (myslot.status))) {&n;&t;&t;&t;&t;hpcrc = ibmphp_hpc_readslot (pslot, READ_EXTSLOTSTATUS, &amp;(myslot.ext_status));&n;&t;&t;&t;&t;if (!hpcrc) {&n;&t;&t;&t;&t;&t;*value = SLOT_SPEED (myslot.ext_status);&n;&t;&t;&t;&t;&t;rc = 0;&n;&t;&t;&t;&t;}&n;&t;&t;&t;} else {&n;&t;&t;&t;&t;*value = MAX_ADAPTER_NONE;&n;&t;&t;&t;&t;rc = 0;&n;&t;&t;&t;}&n;                }&n;        } else&n;&t;&t;rc = -ENODEV;&n;&n;&t;if (hpcrc)&n;&t;&t;rc = hpcrc;&n;&n;&t;if (flag)&n;&t;&t;ibmphp_unlock_operations ();&n;&n;&t;debug (&quot;get_adapter_present - Exit rc[%d] hpcrc[%x] value[%x]&bslash;n&quot;, rc, hpcrc, *value);&n;&t;return rc;&n;}&n;&n;static int get_card_bus_names (struct hotplug_slot *hotplug_slot, char * value)&n;{&n;&t;int rc = -ENODEV;&n;&t;struct slot *pslot = NULL;&n;&t;struct pci_dev * dev = NULL;&n;&n;&t;debug (&quot;get_card_bus_names - Entry hotplug_slot[%lx] &bslash;n&quot;, (ulong)hotplug_slot);&n;&n;&t;ibmphp_lock_operations ();&n;&n;&t;if (hotplug_slot) {&n;&t;&t;pslot = (struct slot *) hotplug_slot-&gt;private;&n;&t;&t;if (pslot) {&n;&t;&t;&t;rc = 0;&n;&t;&t;&t;if (pslot-&gt;func)&n;&t;&t;&t;&t;dev = pslot-&gt;func-&gt;dev;&n;&t;&t;&t;else&n;                &t;&t;dev = pci_find_slot (pslot-&gt;bus, (pslot-&gt;device &lt;&lt; 3) | (0x00 &amp; 0x7));&n;&t;&t;&t;if (dev) &n;&t;&t;&t;&t;snprintf (value, 100, &quot;Bus %d : %s&quot;, pslot-&gt;bus,dev-&gt;name);&n;&t;&t;&t;else&n;&t;&t;&t;&t;snprintf (value, 100, &quot;Bus %d&quot;, pslot-&gt;bus);&n;&t;&t;&t;&n;&t;&t;&t;&t;&n;&t;&t;}&n;&t;} else&n;&t;&t;rc = -ENODEV;&n;&n;&t;ibmphp_unlock_operations ();&n;&t;debug (&quot;get_card_bus_names - Exit rc[%d] value[%x]&bslash;n&quot;, rc, *value);&n;&t;return rc;&n;}&n;&n;*/
multiline_comment|/*******************************************************************************&n; * This routine will initialize the ops data structure used in the validate&n; * function. It will also power off empty slots that are powered on since BIOS&n; * leaves those on, albeit disconnected&n; ******************************************************************************/
DECL|function|init_ops
r_static
r_int
id|init_ops
(paren
r_void
)paren
(brace
r_struct
id|slot
op_star
id|slot_cur
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|j
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|MAX_OPS
suffix:semicolon
id|j
op_increment
)paren
(brace
id|ops
(braket
id|j
)braket
op_assign
(paren
r_int
op_star
)paren
id|kmalloc
(paren
(paren
id|max_slots
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ops
(braket
id|j
)braket
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory &bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|ops
(braket
id|ADD
)braket
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ops
(braket
id|REMOVE
)braket
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ops
(braket
id|DETAIL
)braket
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
op_le
id|max_slots
suffix:semicolon
id|j
op_increment
)paren
(brace
id|slot_cur
op_assign
id|ibmphp_get_slot_from_physical_num
(paren
id|j
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;BEFORE GETTING SLOT STATUS, slot # %x&bslash;n&quot;
comma
id|slot_cur-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;ctrl-&gt;revision
op_eq
l_int|0xFF
)paren
r_if
c_cond
(paren
id|get_ctrl_revision
(paren
id|slot_cur
comma
op_amp
id|slot_cur-&gt;ctrl-&gt;revision
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;bus_on-&gt;current_speed
op_eq
l_int|0xFF
)paren
r_if
c_cond
(paren
id|get_cur_bus_info
(paren
op_amp
id|slot_cur
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;ctrl-&gt;options
op_eq
l_int|0xFF
)paren
r_if
c_cond
(paren
id|get_hpc_options
(paren
id|slot_cur
comma
op_amp
id|slot_cur-&gt;ctrl-&gt;options
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|retval
op_assign
id|slot_update
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|debug
(paren
l_string|&quot;status = %x, ext_status = %x&bslash;n&quot;
comma
id|slot_cur-&gt;status
comma
id|slot_cur-&gt;ext_status
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;SLOT_POWER = %x, SLOT_PRESENT = %x, SLOT_LATCH = %x&bslash;n&quot;
comma
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
comma
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
comma
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
(paren
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
multiline_comment|/* No power, adapter, and latch closed */
id|ops
(braket
id|ADD
)braket
(braket
id|j
)braket
op_assign
l_int|1
suffix:semicolon
r_else
id|ops
(braket
id|ADD
)braket
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|ops
(braket
id|DETAIL
)braket
(braket
id|j
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
(paren
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
multiline_comment|/*Power,adapter,latch closed */
id|ops
(braket
id|REMOVE
)braket
(braket
id|j
)braket
op_assign
l_int|1
suffix:semicolon
r_else
id|ops
(braket
id|REMOVE
)braket
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
(brace
id|debug
(paren
l_string|&quot;BEFORE POWER OFF COMMAND&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|power_off
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/*&t;&t;retval = slot_update (&amp;slot_cur);&n;&t; *&t;&t;if (retval)&n;&t; *&t;&t;&t;return retval;&n;&t; *&t;&t;ibmphp_update_slot_info (slot_cur);&n;&t; */
)brace
)brace
id|init_flag
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This operation will check whether the slot is within the bounds and&n; * the operation is valid to perform on that slot&n; * Parameters: slot, operation&n; * Returns: 0 or error codes&n; */
DECL|function|validate
r_static
r_int
id|validate
(paren
r_struct
id|slot
op_star
id|slot_cur
comma
r_int
id|opn
)paren
(brace
r_int
id|number
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot_cur
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|number
op_assign
id|slot_cur-&gt;number
suffix:semicolon
r_if
c_cond
(paren
(paren
id|number
OG
id|max_slots
)paren
op_logical_or
(paren
id|number
OL
l_int|0
)paren
)paren
r_return
op_minus
id|EBADSLT
suffix:semicolon
id|debug
(paren
l_string|&quot;slot_number in validate is %d&bslash;n&quot;
comma
id|slot_cur-&gt;number
)paren
suffix:semicolon
id|retval
op_assign
id|slot_update
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
(paren
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
id|ops
(braket
id|ADD
)braket
(braket
id|number
)braket
op_assign
l_int|1
suffix:semicolon
r_else
id|ops
(braket
id|ADD
)braket
(braket
id|number
)braket
op_assign
l_int|0
suffix:semicolon
id|ops
(braket
id|DETAIL
)braket
(braket
id|number
)braket
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
(paren
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
id|ops
(braket
id|REMOVE
)braket
(braket
id|number
)braket
op_assign
l_int|1
suffix:semicolon
r_else
id|ops
(braket
id|REMOVE
)braket
(braket
id|number
)braket
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|opn
)paren
(brace
r_case
id|ENABLE
suffix:colon
r_if
c_cond
(paren
id|ops
(braket
id|ADD
)braket
(braket
id|number
)braket
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DISABLE
suffix:colon
r_if
c_cond
(paren
id|ops
(braket
id|REMOVE
)braket
(braket
id|number
)braket
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DETAIL
suffix:colon
r_if
c_cond
(paren
id|ops
(braket
id|DETAIL
)braket
(braket
id|number
)braket
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|err
(paren
l_string|&quot;validate failed....&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/********************************************************************************&n; * This routine is for updating the data structures in the hotplug core&n; * Parameters: struct slot&n; * Returns: 0 or error&n; *******************************************************************************/
DECL|function|ibmphp_update_slot_info
r_int
id|ibmphp_update_slot_info
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
r_struct
id|hotplug_slot_info
op_star
id|info
suffix:semicolon
r_char
id|buffer
(braket
l_int|10
)braket
suffix:semicolon
r_int
id|rc
suffix:semicolon
singleline_comment|//&t;u8 bus_speed;
id|info
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|hotplug_slot_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory &bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|snprintf
(paren
id|buffer
comma
l_int|10
comma
l_string|&quot;%d&quot;
comma
id|slot_cur-&gt;number
)paren
suffix:semicolon
id|info-&gt;power_status
op_assign
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
suffix:semicolon
id|info-&gt;attention_status
op_assign
id|SLOT_ATTN
(paren
id|slot_cur-&gt;status
comma
id|slot_cur-&gt;ext_status
)paren
suffix:semicolon
id|info-&gt;latch_status
op_assign
id|SLOT_LATCH
(paren
id|slot_cur-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SLOT_PRESENT
(paren
id|slot_cur-&gt;status
)paren
)paren
(brace
id|info-&gt;adapter_status
op_assign
l_int|0
suffix:semicolon
singleline_comment|//&t;&t;info-&gt;max_adapter_speed_status = MAX_ADAPTER_NONE;
)brace
r_else
(brace
id|info-&gt;adapter_status
op_assign
l_int|1
suffix:semicolon
singleline_comment|//&t;&t;get_max_adapter_speed_1 (slot_cur-&gt;hotplug_slot, &amp;info-&gt;max_adapter_speed_status, 0);
)brace
multiline_comment|/*&n;&t;bus_speed = slot_cur-&gt;bus_on-&gt;current_speed;&n;&t;bus_speed &amp;= 0x0f;&n;                        &n;&t;if (slot_cur-&gt;bus_on-&gt;current_bus_mode == BUS_MODE_PCIX)&n;&t;&t;bus_speed |= 0x80;&n;&t;else if (slot_cur-&gt;bus_on-&gt;current_bus_mode == BUS_MODE_PCI)&n;&t;&t;bus_speed |= 0x40;&n;&t;else&n;&t;&t;bus_speed |= 0x20;&n;&n;&t;info-&gt;cur_bus_speed_status = bus_speed;&n;&t;info-&gt;max_bus_speed_status = slot_cur-&gt;hotplug_slot-&gt;info-&gt;max_bus_speed_status;&n;&t;// To do: card_bus_names &n;*/
id|rc
op_assign
id|pci_hp_change_slot_info
(paren
id|buffer
comma
id|info
)paren
suffix:semicolon
id|kfree
(paren
id|info
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/******************************************************************************&n; * This function will return the pci_func, given bus and devfunc, or NULL.  It&n; * is called from visit routines&n; ******************************************************************************/
DECL|function|ibm_slot_find
r_static
r_struct
id|pci_func
op_star
id|ibm_slot_find
(paren
id|u8
id|busno
comma
id|u8
id|device
comma
id|u8
id|function
)paren
(brace
r_struct
id|pci_func
op_star
id|func_cur
suffix:semicolon
r_struct
id|slot
op_star
id|slot_cur
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
id|list_for_each
(paren
id|tmp
comma
op_amp
id|ibmphp_slot_head
)paren
(brace
id|slot_cur
op_assign
id|list_entry
(paren
id|tmp
comma
r_struct
id|slot
comma
id|ibm_slot_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;func
)paren
(brace
id|func_cur
op_assign
id|slot_cur-&gt;func
suffix:semicolon
r_while
c_loop
(paren
id|func_cur
)paren
(brace
r_if
c_cond
(paren
(paren
id|func_cur-&gt;busno
op_eq
id|busno
)paren
op_logical_and
(paren
id|func_cur-&gt;device
op_eq
id|device
)paren
op_logical_and
(paren
id|func_cur-&gt;function
op_eq
id|function
)paren
)paren
r_return
id|func_cur
suffix:semicolon
id|func_cur
op_assign
id|func_cur-&gt;next
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* This routine is to find the pci_bus from kernel structures.&n; * Parameters: bus number&n; * Returns : pci_bus *  or NULL if not found&n; */
DECL|function|find_bus
r_static
r_struct
id|pci_bus
op_star
id|find_bus
(paren
id|u8
id|busno
)paren
(brace
r_const
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
id|debug
(paren
l_string|&quot;inside find_bus, busno = %x &bslash;n&quot;
comma
id|busno
)paren
suffix:semicolon
id|list_for_each
(paren
id|tmp
comma
op_amp
id|pci_root_buses
)paren
(brace
id|bus
op_assign
(paren
r_struct
id|pci_bus
op_star
)paren
id|pci_bus_b
(paren
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus
)paren
r_if
c_cond
(paren
id|bus-&gt;number
op_eq
id|busno
)paren
r_return
id|bus
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/******************************************************************&n; * This function is here because we can no longer use pci_root_ops&n; ******************************************************************/
DECL|function|get_root_pci_ops
r_static
r_struct
id|pci_ops
op_star
id|get_root_pci_ops
(paren
r_void
)paren
(brace
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bus
op_assign
id|find_bus
(paren
l_int|0
)paren
)paren
)paren
r_return
id|bus-&gt;ops
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*************************************************************&n; * This routine frees up memory used by struct slot, including&n; * the pointers to pci_func, bus, hotplug_slot, controller,&n; * and deregistering from the hotplug core&n; *************************************************************/
DECL|function|free_slots
r_static
r_void
id|free_slots
(paren
r_void
)paren
(brace
r_struct
id|slot
op_star
id|slot_cur
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|list_head
op_star
id|next
suffix:semicolon
id|list_for_each_safe
(paren
id|tmp
comma
id|next
comma
op_amp
id|ibmphp_slot_head
)paren
(brace
id|slot_cur
op_assign
id|list_entry
(paren
id|tmp
comma
r_struct
id|slot
comma
id|ibm_slot_list
)paren
suffix:semicolon
id|pci_hp_deregister
(paren
id|slot_cur-&gt;hotplug_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;hotplug_slot
)paren
(brace
id|kfree
(paren
id|slot_cur-&gt;hotplug_slot
)paren
suffix:semicolon
id|slot_cur-&gt;hotplug_slot
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot_cur-&gt;ctrl
)paren
id|slot_cur-&gt;ctrl
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;bus_on
)paren
id|slot_cur-&gt;bus_on
op_assign
l_int|NULL
suffix:semicolon
id|ibmphp_unconfigure_card
(paren
op_amp
id|slot_cur
comma
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* we don&squot;t want to actually remove the resources, since free_resources will do just that */
id|kfree
(paren
id|slot_cur
)paren
suffix:semicolon
)brace
)brace
DECL|function|ibm_is_pci_dev_in_use
r_static
r_int
id|ibm_is_pci_dev_in_use
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|inuse
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|dev-&gt;driver
op_logical_and
op_logical_neg
id|inuse
op_logical_and
(paren
id|i
OL
l_int|6
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pci_resource_start
(paren
id|dev
comma
id|i
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pci_resource_flags
(paren
id|dev
comma
id|i
)paren
op_amp
id|IORESOURCE_IO
)paren
id|inuse
op_assign
id|check_region
(paren
id|pci_resource_start
(paren
id|dev
comma
id|i
)paren
comma
id|pci_resource_len
(paren
id|dev
comma
id|i
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pci_resource_flags
(paren
id|dev
comma
id|i
)paren
op_amp
id|IORESOURCE_MEM
)paren
id|inuse
op_assign
id|check_mem_region
(paren
id|pci_resource_start
(paren
id|dev
comma
id|i
)paren
comma
id|pci_resource_len
(paren
id|dev
comma
id|i
)paren
)paren
suffix:semicolon
)brace
r_return
id|inuse
suffix:semicolon
)brace
DECL|function|ibm_pci_hp_remove_device
r_static
r_int
id|ibm_pci_hp_remove_device
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|ibm_is_pci_dev_in_use
(paren
id|dev
)paren
)paren
(brace
id|err
(paren
l_string|&quot;***Cannot safely power down device -- it appears to be in use***&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|pci_remove_device
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibm_unconfigure_visit_pci_dev_phase2
r_static
r_int
id|ibm_unconfigure_visit_pci_dev_phase2
(paren
r_struct
id|pci_dev_wrapped
op_star
id|wrapped_dev
comma
r_struct
id|pci_bus_wrapped
op_star
id|wrapped_bus
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|wrapped_dev-&gt;dev
suffix:semicolon
r_struct
id|pci_func
op_star
id|temp_func
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|temp_func
op_assign
id|ibm_slot_find
(paren
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
op_rshift
l_int|3
comma
id|i
op_increment
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|temp_func
op_logical_and
(paren
id|temp_func-&gt;function
op_ne
(paren
id|dev-&gt;devfn
op_amp
l_int|0x07
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
r_if
c_cond
(paren
id|ibm_pci_hp_remove_device
(paren
id|dev
)paren
op_eq
l_int|0
)paren
id|kfree
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Now, remove */
r_else
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|temp_func
)paren
id|temp_func-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
r_else
id|err
(paren
l_string|&quot;No pci_func representation for bus, devfn = %d, %x&bslash;n&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibm_unconfigure_visit_pci_bus_phase2
r_static
r_int
id|ibm_unconfigure_visit_pci_bus_phase2
(paren
r_struct
id|pci_bus_wrapped
op_star
id|wrapped_bus
comma
r_struct
id|pci_dev_wrapped
op_star
id|wrapped_dev
)paren
(brace
r_struct
id|pci_bus
op_star
id|bus
op_assign
id|wrapped_bus-&gt;bus
suffix:semicolon
id|pci_proc_detach_bus
(paren
id|bus
)paren
suffix:semicolon
multiline_comment|/* The cleanup code should live in the kernel... */
id|bus-&gt;self-&gt;subordinate
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* unlink from parent bus */
id|list_del
(paren
op_amp
id|bus-&gt;node
)paren
suffix:semicolon
multiline_comment|/* Now, remove */
r_if
c_cond
(paren
id|bus
)paren
id|kfree
(paren
id|bus
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibm_unconfigure_visit_pci_dev_phase1
r_static
r_int
id|ibm_unconfigure_visit_pci_dev_phase1
(paren
r_struct
id|pci_dev_wrapped
op_star
id|wrapped_dev
comma
r_struct
id|pci_bus_wrapped
op_star
id|wrapped_bus
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|wrapped_dev-&gt;dev
suffix:semicolon
id|debug
(paren
l_string|&quot;attempting removal of driver for device (%x, %x, %x)&bslash;n&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
(paren
id|dev-&gt;devfn
)paren
comma
id|PCI_FUNC
(paren
id|dev-&gt;devfn
)paren
)paren
suffix:semicolon
multiline_comment|/* Now, remove the Linux Driver Representation */
r_if
c_cond
(paren
id|dev-&gt;driver
)paren
(brace
id|debug
(paren
l_string|&quot;is there a driver?&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver-&gt;remove
)paren
(brace
id|dev-&gt;driver-&gt;remove
(paren
id|dev
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;driver was properly removed&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|dev-&gt;driver
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|ibm_is_pci_dev_in_use
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|variable|ibm_unconfigure_functions_phase1
r_static
r_struct
id|pci_visit
id|ibm_unconfigure_functions_phase1
op_assign
(brace
id|post_visit_pci_dev
suffix:colon
id|ibm_unconfigure_visit_pci_dev_phase1
comma
)brace
suffix:semicolon
DECL|variable|ibm_unconfigure_functions_phase2
r_static
r_struct
id|pci_visit
id|ibm_unconfigure_functions_phase2
op_assign
(brace
id|post_visit_pci_bus
suffix:colon
id|ibm_unconfigure_visit_pci_bus_phase2
comma
id|post_visit_pci_dev
suffix:colon
id|ibm_unconfigure_visit_pci_dev_phase2
comma
)brace
suffix:semicolon
DECL|function|ibm_unconfigure_device
r_static
r_int
id|ibm_unconfigure_device
(paren
r_struct
id|pci_func
op_star
id|func
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_dev_wrapped
id|wrapped_dev
suffix:semicolon
r_struct
id|pci_bus_wrapped
id|wrapped_bus
suffix:semicolon
r_struct
id|pci_dev
op_star
id|temp
suffix:semicolon
id|u8
id|j
suffix:semicolon
id|memset
(paren
op_amp
id|wrapped_dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_dev_wrapped
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|wrapped_bus
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_bus_wrapped
)paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;inside ibm_unconfigure_device&bslash;n&quot;
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;func-&gt;device = %x, func-&gt;function = %x&bslash;n&quot;
comma
id|func-&gt;device
comma
id|func-&gt;function
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;func-&gt;device &lt;&lt; 3 | 0x0  = %x&bslash;n&quot;
comma
id|func-&gt;device
op_lshift
l_int|3
op_or
l_int|0x0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|0x08
suffix:semicolon
id|j
op_increment
)paren
(brace
id|temp
op_assign
id|pci_find_slot
(paren
id|func-&gt;busno
comma
(paren
id|func-&gt;device
op_lshift
l_int|3
)paren
op_or
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
)paren
(brace
id|wrapped_dev.dev
op_assign
id|temp
suffix:semicolon
id|wrapped_bus.bus
op_assign
id|temp-&gt;bus
suffix:semicolon
id|rc
op_assign
id|pci_visit_dev
(paren
op_amp
id|ibm_unconfigure_functions_phase1
comma
op_amp
id|wrapped_dev
comma
op_amp
id|wrapped_bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_break
suffix:semicolon
id|rc
op_assign
id|pci_visit_dev
(paren
op_amp
id|ibm_unconfigure_functions_phase2
comma
op_amp
id|wrapped_dev
comma
op_amp
id|wrapped_bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_break
suffix:semicolon
)brace
)brace
id|debug
(paren
l_string|&quot;rc in ibm_unconfigure_device b4 returning is %d &bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|configure_visit_pci_dev
r_static
r_int
id|configure_visit_pci_dev
(paren
r_struct
id|pci_dev_wrapped
op_star
id|wrapped_dev
comma
r_struct
id|pci_bus_wrapped
op_star
id|wrapped_bus
)paren
(brace
singleline_comment|//      struct pci_bus *bus = wrapped_bus-&gt;bus; /* We don&squot;t need this, since we don&squot;t create in the else statement */
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|wrapped_dev-&gt;dev
suffix:semicolon
r_struct
id|pci_func
op_star
id|temp_func
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|temp_func
op_assign
id|ibm_slot_find
(paren
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
op_rshift
l_int|3
comma
id|i
op_increment
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|temp_func
op_logical_and
(paren
id|temp_func-&gt;function
op_ne
(paren
id|dev-&gt;devfn
op_amp
l_int|0x07
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp_func
)paren
id|temp_func-&gt;dev
op_assign
id|dev
suffix:semicolon
r_else
(brace
multiline_comment|/* This should not really happen, since we create functions&n;&t;&t;   first and then call to configure */
id|debug
(paren
l_string|&quot; We shouldn&squot;t come here &bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|temp_func-&gt;dev
)paren
(brace
id|pci_proc_attach_device
(paren
id|temp_func-&gt;dev
)paren
suffix:semicolon
id|pci_announce_device_to_drivers
(paren
id|temp_func-&gt;dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|configure_functions
r_static
r_struct
id|pci_visit
id|configure_functions
op_assign
(brace
id|visit_pci_dev
suffix:colon
id|configure_visit_pci_dev
comma
)brace
suffix:semicolon
DECL|function|ibm_configure_device
r_static
r_int
id|ibm_configure_device
(paren
r_struct
id|pci_func
op_star
id|func
)paren
(brace
r_int
r_char
id|bus
suffix:semicolon
r_struct
id|pci_dev
id|dev0
suffix:semicolon
r_struct
id|pci_bus
op_star
id|child
suffix:semicolon
r_struct
id|pci_dev
op_star
id|temp
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_dev_wrapped
id|wrapped_dev
suffix:semicolon
r_struct
id|pci_bus_wrapped
id|wrapped_bus
suffix:semicolon
id|memset
(paren
op_amp
id|wrapped_dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_dev_wrapped
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|wrapped_bus
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_bus_wrapped
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|dev0
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;dev
op_eq
l_int|NULL
)paren
id|func-&gt;dev
op_assign
id|pci_find_slot
(paren
id|func-&gt;busno
comma
(paren
id|func-&gt;device
op_lshift
l_int|3
)paren
op_or
(paren
id|func-&gt;function
op_amp
l_int|0x7
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;dev
op_eq
l_int|NULL
)paren
(brace
id|dev0.bus
op_assign
id|find_bus
(paren
id|func-&gt;busno
)paren
suffix:semicolon
id|dev0.devfn
op_assign
(paren
(paren
id|func-&gt;device
op_lshift
l_int|3
)paren
op_plus
(paren
id|func-&gt;function
op_amp
l_int|0x7
)paren
)paren
suffix:semicolon
id|dev0.sysdata
op_assign
id|dev0.bus-&gt;sysdata
suffix:semicolon
id|func-&gt;dev
op_assign
id|pci_scan_slot
(paren
op_amp
id|dev0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func-&gt;dev
op_eq
l_int|NULL
)paren
(brace
id|err
(paren
l_string|&quot;ERROR... : pci_dev still NULL &bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|func-&gt;dev-&gt;hdr_type
op_eq
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
id|pci_read_config_byte
(paren
id|func-&gt;dev
comma
id|PCI_SECONDARY_BUS
comma
op_amp
id|bus
)paren
suffix:semicolon
id|child
op_assign
(paren
r_struct
id|pci_bus
op_star
)paren
id|pci_add_new_bus
(paren
id|func-&gt;dev-&gt;bus
comma
(paren
id|func-&gt;dev
)paren
comma
id|bus
)paren
suffix:semicolon
id|pci_do_scan_bus
(paren
id|child
)paren
suffix:semicolon
)brace
id|temp
op_assign
id|func-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|temp
)paren
(brace
id|wrapped_dev.dev
op_assign
id|temp
suffix:semicolon
id|wrapped_bus.bus
op_assign
id|temp-&gt;bus
suffix:semicolon
id|rc
op_assign
id|pci_visit_dev
(paren
op_amp
id|configure_functions
comma
op_amp
id|wrapped_dev
comma
op_amp
id|wrapped_bus
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*******************************************************&n; * Returns whether the bus is empty or not &n; *******************************************************/
DECL|function|is_bus_empty
r_static
r_int
id|is_bus_empty
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|slot
op_star
id|tmp_slot
suffix:semicolon
id|u8
id|i
op_assign
id|slot_cur-&gt;bus_on-&gt;slot_min
suffix:semicolon
r_while
c_loop
(paren
id|i
op_le
id|slot_cur-&gt;bus_on-&gt;slot_max
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|slot_cur-&gt;number
)paren
(brace
id|i
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|tmp_slot
op_assign
id|ibmphp_get_slot_from_physical_num
(paren
id|i
)paren
suffix:semicolon
id|rc
op_assign
id|slot_update
(paren
op_amp
id|tmp_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|SLOT_PRESENT
(paren
id|tmp_slot-&gt;status
)paren
op_logical_and
id|SLOT_POWER
(paren
id|tmp_slot-&gt;status
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/***********************************************************&n; * If the HPC permits and the bus currently empty, tries to set the &n; * bus speed and mode at the maximum card capability&n; ***********************************************************/
DECL|function|set_bus
r_static
r_int
id|set_bus
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
r_int
id|rc
suffix:semicolon
id|u8
id|speed
suffix:semicolon
id|u8
id|cmd
op_assign
l_int|0x0
suffix:semicolon
id|debug
(paren
l_string|&quot;%s - entry slot # %d &bslash;n&quot;
comma
id|__FUNCTION__
comma
id|slot_cur-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SET_BUS_STATUS
(paren
id|slot_cur-&gt;ctrl
)paren
op_logical_and
id|is_bus_empty
(paren
id|slot_cur
)paren
)paren
(brace
id|rc
op_assign
id|slot_update
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|speed
op_assign
id|SLOT_SPEED
(paren
id|slot_cur-&gt;ext_status
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;ext_status = %x, speed = %x&bslash;n&quot;
comma
id|slot_cur-&gt;ext_status
comma
id|speed
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|speed
)paren
(brace
r_case
id|HPC_SLOT_SPEED_33
suffix:colon
id|cmd
op_assign
id|HPC_BUS_33CONVMODE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HPC_SLOT_SPEED_66
suffix:colon
r_if
c_cond
(paren
id|SLOT_PCIX
(paren
id|slot_cur-&gt;ext_status
)paren
)paren
id|cmd
op_assign
id|HPC_BUS_66PCIXMODE
suffix:semicolon
r_else
id|cmd
op_assign
id|HPC_BUS_66CONVMODE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HPC_SLOT_SPEED_133
suffix:colon
r_if
c_cond
(paren
id|slot_cur-&gt;bus_on-&gt;slot_count
OG
l_int|1
)paren
id|cmd
op_assign
id|HPC_BUS_100PCIXMODE
suffix:semicolon
r_else
id|cmd
op_assign
id|HPC_BUS_133PCIXMODE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
(paren
l_string|&quot;wrong slot speed &bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;setting bus speed for slot %d, cmd %x&bslash;n&quot;
comma
id|slot_cur-&gt;number
comma
id|cmd
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_hpc_writeslot
(paren
id|slot_cur
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;%s -Exit &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|print_card_capability
r_static
r_inline
r_void
id|print_card_capability
(paren
r_struct
id|slot
op_star
id|slot_cur
)paren
(brace
id|info
(paren
l_string|&quot;capability of the card is &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|slot_cur-&gt;ext_status
op_amp
id|CARD_INFO
)paren
op_eq
id|PCIX133
)paren
id|info
(paren
l_string|&quot;   133 MHz PCI-X &bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_cur-&gt;ext_status
op_amp
id|CARD_INFO
)paren
op_eq
id|PCIX66
)paren
id|info
(paren
l_string|&quot;    66 MHz PCI-X &bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|slot_cur-&gt;ext_status
op_amp
id|CARD_INFO
)paren
op_eq
id|PCI66
)paren
id|info
(paren
l_string|&quot;    66 MHz PCI &bslash;n&quot;
)paren
suffix:semicolon
r_else
id|info
(paren
l_string|&quot;    33 MHz PCI &bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* This routine will power on the slot, configure the device(s) and find the&n; * drivers for them.&n; * Parameters: hotplug_slot&n; * Returns: 0 or failure codes&n; */
DECL|function|enable_slot
r_static
r_int
id|enable_slot
(paren
r_struct
id|hotplug_slot
op_star
id|hs
)paren
(brace
r_int
id|rc
comma
id|i
comma
id|rcpr
suffix:semicolon
r_struct
id|slot
op_star
id|slot_cur
suffix:semicolon
id|u8
id|function
suffix:semicolon
id|u8
id|faulted
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_func
op_star
id|tmp_func
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;ENABLING SLOT........ &bslash;n&quot;
)paren
suffix:semicolon
id|slot_cur
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hs
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|validate
(paren
id|slot_cur
comma
id|ENABLE
)paren
)paren
)paren
(brace
id|err
(paren
l_string|&quot;validate function failed &bslash;n&quot;
)paren
suffix:semicolon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
multiline_comment|/* need to turn off if was blinking b4 */
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|rc
op_assign
id|slot_update
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|ibmphp_unlock_operations
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|attn_LED_blink
(paren
id|slot_cur
)paren
suffix:semicolon
id|rc
op_assign
id|set_bus
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
(paren
l_string|&quot;was not able to set the bus &bslash;n&quot;
)paren
suffix:semicolon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|rc
op_assign
id|power_on
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
(paren
l_string|&quot;something wrong when powering up... please see below for details&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* need to turn off before on, otherwise, blinking overwrites */
id|attn_off
c_func
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_update
(paren
op_amp
id|slot_cur
)paren
)paren
(brace
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Check to see the error of why it failed */
r_if
c_cond
(paren
op_logical_neg
(paren
id|SLOT_PWRGD
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
id|err
(paren
l_string|&quot;power fault occured trying to power up &bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|SLOT_BUS_SPEED
(paren
id|slot_cur-&gt;status
)paren
)paren
(brace
id|err
(paren
l_string|&quot;bus speed mismatch occured.  please check current bus speed and card capability &bslash;n&quot;
)paren
suffix:semicolon
id|print_card_capability
(paren
id|slot_cur
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SLOT_BUS_MODE
(paren
id|slot_cur-&gt;ext_status
)paren
)paren
id|err
(paren
l_string|&quot;bus mode mismatch occured.  please check current bus mode and card capability &bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;after power_on&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|slot_update
(paren
op_amp
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|rcpr
op_assign
id|power_off
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcpr
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
id|rcpr
suffix:semicolon
)brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
op_logical_and
op_logical_neg
(paren
id|SLOT_PWRGD
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
(brace
id|faulted
op_assign
l_int|1
suffix:semicolon
id|err
(paren
l_string|&quot;power fault occured trying to power up...&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
op_logical_and
(paren
id|SLOT_BUS_SPEED
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
(brace
id|faulted
op_assign
l_int|1
suffix:semicolon
id|err
(paren
l_string|&quot;bus speed mismatch occured.  please check current bus speed and card capability &bslash;n&quot;
)paren
suffix:semicolon
id|print_card_capability
(paren
id|slot_cur
)paren
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t think this case will happen after above checks... but just in case, for paranoia sake */
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|SLOT_POWER
(paren
id|slot_cur-&gt;status
)paren
)paren
)paren
(brace
id|err
(paren
l_string|&quot;power on failed... &bslash;n&quot;
)paren
suffix:semicolon
id|faulted
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|faulted
)paren
(brace
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
multiline_comment|/* need to turn off b4 on */
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|rcpr
op_assign
id|power_off
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcpr
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
id|rcpr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot_update
(paren
op_amp
id|slot_cur
)paren
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|slot_cur-&gt;func
op_assign
(paren
r_struct
id|pci_func
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|pci_func
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot_cur-&gt;func
)paren
(brace
multiline_comment|/* We cannot do update_slot_info here, since no memory for kmalloc n.e.ways, and update_slot_info allocates some */
id|err
(paren
l_string|&quot;out of system memory &bslash;n&quot;
)paren
suffix:semicolon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|rcpr
op_assign
id|power_off
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcpr
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
id|rcpr
suffix:semicolon
)brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|slot_cur-&gt;func
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_func
)paren
)paren
suffix:semicolon
id|slot_cur-&gt;func-&gt;busno
op_assign
id|slot_cur-&gt;bus
suffix:semicolon
id|slot_cur-&gt;func-&gt;device
op_assign
id|slot_cur-&gt;device
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|slot_cur-&gt;func-&gt;irq
(braket
id|i
)braket
op_assign
id|slot_cur-&gt;irq
(braket
id|i
)braket
suffix:semicolon
id|debug
(paren
l_string|&quot;b4 configure_card, slot_cur-&gt;bus = %x, slot_cur-&gt;device = %x&bslash;n&quot;
comma
id|slot_cur-&gt;bus
comma
id|slot_cur-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_configure_card
(paren
id|slot_cur-&gt;func
comma
id|slot_cur-&gt;number
)paren
)paren
(brace
id|err
(paren
l_string|&quot;configure_card was unsuccessful... &bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_unconfigure_card
(paren
op_amp
id|slot_cur
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* true because don&squot;t need to actually deallocate resources, just remove references */
id|debug
(paren
l_string|&quot;after unconfigure_card&bslash;n&quot;
)paren
suffix:semicolon
id|slot_cur-&gt;func
op_assign
l_int|NULL
suffix:semicolon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
multiline_comment|/* need to turn off in case was blinking */
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|rcpr
op_assign
id|power_off
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcpr
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
id|rcpr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot_update
(paren
op_amp
id|slot_cur
)paren
)paren
(brace
id|ibmphp_unlock_operations
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|function
op_assign
l_int|0x00
suffix:semicolon
r_do
(brace
id|tmp_func
op_assign
id|ibm_slot_find
(paren
id|slot_cur-&gt;bus
comma
id|slot_cur-&gt;func-&gt;device
comma
id|function
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_func
op_logical_and
op_logical_neg
(paren
id|tmp_func-&gt;dev
)paren
)paren
id|ibm_configure_device
(paren
id|tmp_func
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|tmp_func
)paren
suffix:semicolon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_update
(paren
op_amp
id|slot_cur
)paren
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ibmphp_print_test
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**************************************************************&n;* HOT REMOVING ADAPTER CARD                                   *&n;* INPUT: POINTER TO THE HOTPLUG SLOT STRUCTURE                *&n;* OUTPUT: SUCCESS 0 ; FAILURE: UNCONFIGURE , VALIDATE         *&n;          DISABLE POWER ,                                    *&n;**************************************************************/
DECL|function|ibmphp_disable_slot
r_int
id|ibmphp_disable_slot
(paren
r_struct
id|hotplug_slot
op_star
id|hotplug_slot
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|slot
op_star
id|slot_cur
op_assign
(paren
r_struct
id|slot
op_star
)paren
id|hotplug_slot
op_member_access_from_pointer
r_private
suffix:semicolon
id|u8
id|flag
op_assign
id|slot_cur-&gt;flag
suffix:semicolon
id|slot_cur-&gt;flag
op_assign
id|TRUE
suffix:semicolon
id|debug
(paren
l_string|&quot;DISABLING SLOT... &bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_lock_operations
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur
op_eq
l_int|NULL
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot_cur-&gt;ctrl
op_eq
l_int|NULL
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flag
op_eq
id|TRUE
)paren
(brace
id|rc
op_assign
id|validate
(paren
id|slot_cur
comma
id|DISABLE
)paren
suffix:semicolon
multiline_comment|/* checking if powered off already &amp; valid slot # */
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/*  Need to turn off if was blinking b4 */
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_update
(paren
op_amp
id|slot_cur
)paren
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
id|attn_LED_blink
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_cur-&gt;func
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* We need this for fncs&squot;s that were there on bootup */
id|slot_cur-&gt;func
op_assign
(paren
r_struct
id|pci_func
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|pci_func
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot_cur-&gt;func
)paren
(brace
id|err
(paren
l_string|&quot;out of system memory &bslash;n&quot;
)paren
suffix:semicolon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|slot_cur-&gt;func
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pci_func
)paren
)paren
suffix:semicolon
id|slot_cur-&gt;func-&gt;busno
op_assign
id|slot_cur-&gt;bus
suffix:semicolon
id|slot_cur-&gt;func-&gt;device
op_assign
id|slot_cur-&gt;device
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ibm_unconfigure_device
(paren
id|slot_cur-&gt;func
)paren
)paren
)paren
(brace
id|err
(paren
l_string|&quot;removing from kernel failed... &bslash;n&quot;
)paren
suffix:semicolon
id|err
(paren
l_string|&quot;Please check to see if it was statically linked or is in use otherwise. (perhaps the driver is not &squot;hot-removable&squot;)&bslash;n&quot;
)paren
suffix:semicolon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|ibmphp_unconfigure_card
(paren
op_amp
id|slot_cur
comma
l_int|0
)paren
suffix:semicolon
id|slot_cur-&gt;func
op_assign
l_int|NULL
suffix:semicolon
id|debug
(paren
l_string|&quot;in disable_slot. after unconfigure_card &bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|err
(paren
l_string|&quot;could not unconfigure card.&bslash;n&quot;
)paren
suffix:semicolon
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
multiline_comment|/* need to turn off if was blinking b4 */
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_update
(paren
op_amp
id|slot_cur
)paren
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flag
)paren
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|rc
op_assign
id|ibmphp_hpc_writeslot
(paren
id|hotplug_slot
op_member_access_from_pointer
r_private
comma
id|HPC_SLOT_OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
id|attn_on
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_update
(paren
op_amp
id|slot_cur
)paren
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flag
)paren
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|attn_off
(paren
id|slot_cur
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_update
(paren
op_amp
id|slot_cur
)paren
)paren
(brace
id|ibmphp_unlock_operations
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flag
)paren
id|rc
op_assign
id|ibmphp_update_slot_info
(paren
id|slot_cur
)paren
suffix:semicolon
r_else
id|rc
op_assign
l_int|0
suffix:semicolon
id|ibmphp_print_test
(paren
)paren
suffix:semicolon
id|ibmphp_unlock_operations
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|ibmphp_hotplug_slot_ops
r_struct
id|hotplug_slot_ops
id|ibmphp_hotplug_slot_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|set_attention_status
suffix:colon
id|set_attention_status
comma
id|enable_slot
suffix:colon
id|enable_slot
comma
id|disable_slot
suffix:colon
id|ibmphp_disable_slot
comma
id|hardware_test
suffix:colon
l_int|NULL
comma
id|get_power_status
suffix:colon
id|get_power_status
comma
id|get_attention_status
suffix:colon
id|get_attention_status
comma
id|get_latch_status
suffix:colon
id|get_latch_status
comma
id|get_adapter_status
suffix:colon
id|get_adapter_present
comma
multiline_comment|/*&t;get_max_bus_speed_status:&t;get_max_bus_speed,&n;&t;get_max_adapter_speed_status:&t;get_max_adapter_speed,&n;&t;get_cur_bus_speed_status:&t;get_cur_bus_speed,&n;&t;get_card_bus_names_status:&t;get_card_bus_names,&n;*/
)brace
suffix:semicolon
DECL|function|ibmphp_unload
r_static
r_void
id|ibmphp_unload
(paren
r_void
)paren
(brace
id|free_slots
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after slots &bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_free_resources
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after resources &bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_free_bus_info_queue
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after bus info &bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_free_ebda_hpc_queue
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after ebda hpc &bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_free_ebda_pci_rsrc_queue
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after ebda pci rsrc &bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ibmphp_init
r_static
r_int
id|__init
id|ibmphp_init
(paren
r_void
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|init_flag
op_assign
l_int|1
suffix:semicolon
id|ibmphp_pci_root_ops
op_assign
id|get_root_pci_ops
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmphp_pci_root_ops
op_eq
l_int|NULL
)paren
(brace
id|err
(paren
l_string|&quot;cannot read bus operations... will not be able to read the cards.  Please check your system &bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ibmphp_debug
op_assign
id|debug
suffix:semicolon
id|ibmphp_hpc_initvars
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|irqs
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ibmphp_access_ebda
(paren
)paren
)paren
)paren
(brace
id|ibmphp_unload
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;after ibmphp_access_ebda () &bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ibmphp_rsrc_init
(paren
)paren
)paren
)paren
(brace
id|ibmphp_unload
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|debug
(paren
l_string|&quot;AFTER Resource &amp; EBDA INITIALIZATIONS &bslash;n&quot;
)paren
suffix:semicolon
id|max_slots
op_assign
id|get_max_slots
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|init_ops
(paren
)paren
)paren
(brace
id|ibmphp_unload
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ibmphp_print_test
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ibmphp_hpc_start_poll_thread
(paren
)paren
)paren
)paren
(brace
id|ibmphp_unload
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* lock ourselves into memory with a module count of -1 &n;&t; * so that no one can unload us. */
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|info
(paren
id|DRIVER_DESC
l_string|&quot; version: &quot;
id|DRIVER_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibmphp_exit
r_static
r_void
id|__exit
id|ibmphp_exit
(paren
r_void
)paren
(brace
id|ibmphp_hpc_stop_poll_thread
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;after polling &bslash;n&quot;
)paren
suffix:semicolon
id|ibmphp_unload
(paren
)paren
suffix:semicolon
id|debug
(paren
l_string|&quot;done &bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|ibmphp_init
id|module_init
(paren
id|ibmphp_init
)paren
suffix:semicolon
DECL|variable|ibmphp_exit
id|module_exit
(paren
id|ibmphp_exit
)paren
suffix:semicolon
eof
