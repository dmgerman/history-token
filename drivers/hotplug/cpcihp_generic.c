multiline_comment|/*&n; * cpcihp_generic.c&n; *&n; * Generic port I/O CompactPCI driver&n; *&n; * Copyright 2002 SOMA Networks, Inc.&n; * Copyright 2001 Intel San Luis Obispo&n; * Copyright 2000,2001 MontaVista Software Inc.&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2 of the License, or (at your&n; * option) any later version.&n; *&n; * THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,&n; * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY &n; * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL &n; * THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, &n; * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, &n; * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR &n; * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF &n; * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING &n; * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS &n; * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; * You should have received a copy of the GNU General Public License along&n; * with this program; if not, write to the Free Software Foundation, Inc.,&n; * 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * This generic CompactPCI hotplug driver should allow using the PCI hotplug&n; * mechanism on any CompactPCI board that exposes the #ENUM signal as a bit&n; * in a system register that can be read through standard port I/O.&n; *&n; * Send feedback to &lt;scottm@somanetworks.com&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &quot;cpci_hotplug.h&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION&t;&quot;0.1&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR&t;&quot;Scott Murray &lt;scottm@somanetworks.com&gt;&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;Generic port I/O CompactPCI Hot Plug Driver&quot;
macro_line|#if !defined(CONFIG_HOTPLUG_CPCI_GENERIC_MODULE)
DECL|macro|MY_NAME
mdefine_line|#define MY_NAME&t;&quot;cpcihp_generic&quot;
macro_line|#else
DECL|macro|MY_NAME
mdefine_line|#define MY_NAME&t;THIS_MODULE-&gt;name
macro_line|#endif
DECL|macro|dbg
mdefine_line|#define dbg(format, arg...)&t;&t;&t;&t;&t;&bslash;&n;&t;do {&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;if(debug)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;printk (KERN_DEBUG &quot;%s: &quot; format &quot;&bslash;n&quot;,&t;&bslash;&n;&t;&t;&t;&t;MY_NAME , ## arg); &t;&t;&bslash;&n;&t;} while(0)
DECL|macro|err
mdefine_line|#define err(format, arg...) printk(KERN_ERR &quot;%s: &quot; format &quot;&bslash;n&quot;, MY_NAME , ## arg)
DECL|macro|info
mdefine_line|#define info(format, arg...) printk(KERN_INFO &quot;%s: &quot; format &quot;&bslash;n&quot;, MY_NAME , ## arg)
DECL|macro|warn
mdefine_line|#define warn(format, arg...) printk(KERN_WARNING &quot;%s: &quot; format &quot;&bslash;n&quot;, MY_NAME , ## arg)
multiline_comment|/* local variables */
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
DECL|variable|bridge
r_static
r_char
op_star
id|bridge
suffix:semicolon
DECL|variable|bridge_busnr
r_static
id|u8
id|bridge_busnr
suffix:semicolon
DECL|variable|bridge_slot
r_static
id|u8
id|bridge_slot
suffix:semicolon
DECL|variable|bus
r_static
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
DECL|variable|first_slot
r_static
id|u8
id|first_slot
suffix:semicolon
DECL|variable|last_slot
r_static
id|u8
id|last_slot
suffix:semicolon
DECL|variable|port
r_static
id|u16
id|port
suffix:semicolon
DECL|variable|enum_bit
r_static
r_int
r_int
id|enum_bit
suffix:semicolon
DECL|variable|enum_mask
r_static
id|u8
id|enum_mask
suffix:semicolon
DECL|variable|generic_hpc_ops
r_static
r_struct
id|cpci_hp_controller_ops
id|generic_hpc_ops
suffix:semicolon
DECL|variable|generic_hpc
r_static
r_struct
id|cpci_hp_controller
id|generic_hpc
suffix:semicolon
multiline_comment|/* The following allows configuring the driver when it&squot;s compiled into the kernel */
macro_line|#ifndef MODULE
DECL|function|cpcihp_generic_setup
r_static
r_int
id|__init
id|cpcihp_generic_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|str
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|bridge
op_assign
id|str
suffix:semicolon
id|p
op_assign
id|strchr
c_func
(paren
id|str
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
id|str
op_assign
id|p
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_logical_and
op_star
id|str
op_logical_and
op_star
id|p
op_eq
l_char|&squot;,&squot;
)paren
)paren
(brace
r_goto
id|setup_error
suffix:semicolon
)brace
id|tmp
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|str
op_logical_or
id|tmp
OG
l_int|0xff
)paren
(brace
id|err
c_func
(paren
l_string|&quot;hotplug bus first slot number out of range&quot;
)paren
suffix:semicolon
r_goto
id|setup_error
suffix:semicolon
)brace
id|first_slot
op_assign
(paren
id|u8
)paren
id|tmp
suffix:semicolon
id|str
op_assign
id|p
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|str
op_logical_and
op_star
id|p
op_eq
l_char|&squot;,&squot;
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|tmp
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|str
op_logical_or
id|tmp
OG
l_int|0xff
)paren
(brace
id|err
c_func
(paren
l_string|&quot;hotplug bus last slot number out of range&quot;
)paren
suffix:semicolon
r_goto
id|setup_error
suffix:semicolon
)brace
id|last_slot
op_assign
(paren
id|u8
)paren
id|tmp
suffix:semicolon
id|str
op_assign
id|p
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|str
op_logical_and
op_star
id|p
op_eq
l_char|&squot;,&squot;
)paren
)paren
(brace
r_goto
id|setup_error
suffix:semicolon
)brace
id|tmp
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|str
op_logical_or
id|tmp
OG
l_int|0xffff
)paren
(brace
id|err
c_func
(paren
l_string|&quot;port number out of range&quot;
)paren
suffix:semicolon
r_goto
id|setup_error
suffix:semicolon
)brace
id|port
op_assign
(paren
id|u16
)paren
id|tmp
suffix:semicolon
id|str
op_assign
id|p
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|str
op_logical_and
op_star
id|p
op_eq
l_char|&squot;,&squot;
)paren
)paren
(brace
r_goto
id|setup_error
suffix:semicolon
)brace
id|tmp
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|str
)paren
(brace
id|err
c_func
(paren
l_string|&quot;invalid #ENUM bit number&quot;
)paren
suffix:semicolon
r_goto
id|setup_error
suffix:semicolon
)brace
id|enum_bit
op_assign
(paren
id|u8
)paren
id|tmp
suffix:semicolon
id|str
op_assign
id|p
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|str
op_logical_and
op_star
id|p
op_eq
l_char|&squot;,&squot;
)paren
(brace
id|tmp
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ne
id|str
)paren
(brace
id|debug
op_assign
(paren
r_int
)paren
id|tmp
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
id|setup_error
suffix:colon
id|bridge
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;cpcihp_generic=&quot;
comma
id|cpcihp_generic_setup
)paren
suffix:semicolon
macro_line|#endif
DECL|function|validate_parameters
r_static
r_int
id|__init
id|validate_parameters
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|str
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge
)paren
(brace
id|info
c_func
(paren
l_string|&quot;not configured, disabling.&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|str
op_assign
id|bridge
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|str
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|tmp
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|p
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|str
op_logical_or
id|tmp
OG
l_int|0xff
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Invalid hotplug bus bridge device bus number&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|bridge_busnr
op_assign
(paren
id|u8
)paren
id|tmp
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;bridge_busnr = 0x%02x&quot;
comma
id|bridge_busnr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_ne
l_char|&squot;:&squot;
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Invalid hotplug bus bridge device&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|str
op_assign
id|p
op_plus
l_int|1
suffix:semicolon
id|tmp
op_assign
id|simple_strtoul
c_func
(paren
id|str
comma
op_amp
id|p
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
id|str
op_logical_or
id|tmp
OG
l_int|0x1f
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Invalid hotplug bus bridge device slot number&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|bridge_slot
op_assign
(paren
id|u8
)paren
id|tmp
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;bridge_slot = 0x%02x&quot;
comma
id|bridge_slot
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;first_slot = 0x%02x&quot;
comma
id|first_slot
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;last_slot = 0x%02x&quot;
comma
id|last_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|first_slot
op_logical_and
id|last_slot
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Need to specify first_slot and last_slot&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|last_slot
OL
id|first_slot
)paren
(brace
id|err
c_func
(paren
l_string|&quot;first_slot must be less than last_slot&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;port = 0x%04x&quot;
comma
id|port
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;enum_bit = 0x%02x&quot;
comma
id|enum_bit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enum_bit
OG
l_int|7
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Invalid #ENUM bit&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|enum_mask
op_assign
l_int|1
op_lshift
id|enum_bit
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|query_enum
r_static
r_int
id|query_enum
c_func
(paren
r_void
)paren
(brace
id|u8
id|value
suffix:semicolon
id|value
op_assign
id|inb_p
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
(paren
(paren
id|value
op_amp
id|enum_mask
)paren
op_eq
id|enum_mask
)paren
suffix:semicolon
)brace
DECL|function|cpcihp_generic_init
r_static
r_int
id|__init
id|cpcihp_generic_init
c_func
(paren
r_void
)paren
(brace
r_int
id|status
suffix:semicolon
r_struct
id|resource
op_star
id|r
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; version: &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
id|status
op_assign
id|validate_parameters
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
r_return
id|status
suffix:semicolon
)brace
id|r
op_assign
id|request_region
c_func
(paren
id|port
comma
l_int|1
comma
l_string|&quot;#ENUM hotswap signal register&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|dev
op_assign
id|pci_find_slot
c_func
(paren
id|bridge_busnr
comma
id|PCI_DEVFN
c_func
(paren
id|bridge_slot
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
id|dev-&gt;hdr_type
op_ne
id|PCI_HEADER_TYPE_BRIDGE
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Invalid bridge device %s&quot;
comma
id|bridge
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|bus
op_assign
id|dev-&gt;subordinate
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|generic_hpc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|cpci_hp_controller
)paren
)paren
suffix:semicolon
id|generic_hpc_ops.query_enum
op_assign
id|query_enum
suffix:semicolon
id|generic_hpc.ops
op_assign
op_amp
id|generic_hpc_ops
suffix:semicolon
id|status
op_assign
id|cpci_hp_register_controller
c_func
(paren
op_amp
id|generic_hpc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not register cPCI hotplug controller&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;registered controller&quot;
)paren
suffix:semicolon
id|status
op_assign
id|cpci_hp_register_bus
c_func
(paren
id|bus
comma
id|first_slot
comma
id|last_slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not register cPCI hotplug bus&quot;
)paren
suffix:semicolon
r_goto
id|init_bus_register_error
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;registered bus&quot;
)paren
suffix:semicolon
id|status
op_assign
id|cpci_hp_start
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Could not started cPCI hotplug system&quot;
)paren
suffix:semicolon
r_goto
id|init_start_error
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;started cpci hp system&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|init_start_error
suffix:colon
id|cpci_hp_unregister_bus
c_func
(paren
id|bus
)paren
suffix:semicolon
id|init_bus_register_error
suffix:colon
id|cpci_hp_unregister_controller
c_func
(paren
op_amp
id|generic_hpc
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;status = %d&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|cpcihp_generic_exit
r_static
r_void
id|__exit
id|cpcihp_generic_exit
c_func
(paren
r_void
)paren
(brace
id|cpci_hp_stop
c_func
(paren
)paren
suffix:semicolon
id|cpci_hp_unregister_bus
c_func
(paren
id|bus
)paren
suffix:semicolon
id|cpci_hp_unregister_controller
c_func
(paren
op_amp
id|generic_hpc
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|port
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|variable|cpcihp_generic_init
id|module_init
c_func
(paren
id|cpcihp_generic_init
)paren
suffix:semicolon
DECL|variable|cpcihp_generic_exit
id|module_exit
c_func
(paren
id|cpcihp_generic_exit
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debugging mode enabled or not&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|bridge
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|bridge
comma
l_string|&quot;Hotswap bus bridge device, &lt;bus&gt;:&lt;slot&gt; (bus and slot are in hexadecimal)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|first_slot
comma
l_string|&quot;b&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|first_slot
comma
l_string|&quot;Hotswap bus first slot number&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|last_slot
comma
l_string|&quot;b&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|last_slot
comma
l_string|&quot;Hotswap bus last slot number&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|port
comma
l_string|&quot;h&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|port
comma
l_string|&quot;#ENUM signal I/O port&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|enum_bit
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|enum_bit
comma
l_string|&quot;#ENUM signal bit (0-7)&quot;
)paren
suffix:semicolon
eof
