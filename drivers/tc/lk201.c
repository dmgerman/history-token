multiline_comment|/*&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/kbd_ll.h&gt;
macro_line|#include &lt;asm/wbflush.h&gt;
macro_line|#include &lt;asm/dec/tc.h&gt;
macro_line|#include &lt;asm/dec/machtype.h&gt;
macro_line|#include &quot;zs.h&quot;
macro_line|#include &quot;lk201.h&quot;
multiline_comment|/* Simple translation table for the SysRq keys */
macro_line|#ifdef CONFIG_MAGIC_SYSRQ
multiline_comment|/*&n; * Actually no translation at all, at least until we figure out&n; * how to define SysRq for LK201 and friends. --macro&n; */
DECL|variable|lk201_sysrq_xlate
r_int
r_char
id|lk201_sysrq_xlate
(braket
l_int|128
)braket
suffix:semicolon
DECL|variable|kbd_sysrq_xlate
r_int
r_char
op_star
id|kbd_sysrq_xlate
op_assign
id|lk201_sysrq_xlate
suffix:semicolon
macro_line|#endif
DECL|macro|KEYB_LINE
mdefine_line|#define KEYB_LINE&t;3
r_static
r_int
id|__init
id|lk201_init
c_func
(paren
r_struct
id|dec_serial
op_star
)paren
suffix:semicolon
r_static
r_void
id|__init
id|lk201_info
c_func
(paren
r_struct
id|dec_serial
op_star
)paren
suffix:semicolon
r_static
r_void
id|lk201_kbd_rx_char
c_func
(paren
r_int
r_char
comma
r_int
r_char
)paren
suffix:semicolon
DECL|variable|lk201_kbdhook
r_struct
id|zs_hook
id|lk201_kbdhook
op_assign
(brace
dot
id|init_channel
op_assign
id|lk201_init
comma
dot
id|init_info
op_assign
id|lk201_info
comma
dot
id|cflags
op_assign
id|B4800
op_or
id|CS8
op_or
id|CSTOPB
op_or
id|CLOCAL
)brace
suffix:semicolon
multiline_comment|/*&n; * This is used during keyboard initialisation&n; */
DECL|variable|lk201_reset_string
r_static
r_int
r_char
id|lk201_reset_string
(braket
)braket
op_assign
(brace
id|LK_CMD_LEDS_ON
comma
id|LK_PARAM_LED_MASK
c_func
(paren
l_int|0xf
)paren
comma
multiline_comment|/* show we are resetting */
id|LK_CMD_SET_DEFAULTS
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_RPT_DOWN
comma
l_int|1
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_RPT_DOWN
comma
l_int|2
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_RPT_DOWN
comma
l_int|3
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_RPT_DOWN
comma
l_int|4
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_DOWN_UP
comma
l_int|5
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_DOWN_UP
comma
l_int|6
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_RPT_DOWN
comma
l_int|7
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_RPT_DOWN
comma
l_int|8
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_RPT_DOWN
comma
l_int|9
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_RPT_DOWN
comma
l_int|10
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_RPT_DOWN
comma
l_int|11
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_RPT_DOWN
comma
l_int|12
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_DOWN
comma
l_int|13
)paren
comma
id|LK_CMD_MODE
c_func
(paren
id|LK_MODE_RPT_DOWN
comma
l_int|14
)paren
comma
id|LK_CMD_ENB_RPT
comma
id|LK_CMD_DIS_KEYCLK
comma
id|LK_CMD_RESUME
comma
id|LK_CMD_ENB_BELL
comma
id|LK_PARAM_VOLUME
c_func
(paren
l_int|4
)paren
comma
id|LK_CMD_LEDS_OFF
comma
id|LK_PARAM_LED_MASK
c_func
(paren
l_int|0xf
)paren
)brace
suffix:semicolon
DECL|function|lk201_reset
r_static
r_int
id|__init
id|lk201_reset
c_func
(paren
r_struct
id|dec_serial
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|lk201_reset_string
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|info-&gt;hook
op_member_access_from_pointer
id|poll_tx_char
c_func
(paren
id|info
comma
id|lk201_reset_string
(braket
id|i
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot; transmit timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|kbd_leds
r_void
id|kbd_leds
c_func
(paren
r_int
r_char
id|leds
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|kbd_setkeycode
r_int
id|kbd_setkeycode
c_func
(paren
r_int
r_int
id|scancode
comma
r_int
r_int
id|keycode
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|kbd_getkeycode
r_int
id|kbd_getkeycode
c_func
(paren
r_int
r_int
id|scancode
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|kbd_translate
r_int
id|kbd_translate
c_func
(paren
r_int
r_char
id|scancode
comma
r_int
r_char
op_star
id|keycode
comma
r_char
id|raw_mode
)paren
(brace
op_star
id|keycode
op_assign
id|scancode
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|kbd_unexpected_up
r_char
id|kbd_unexpected_up
c_func
(paren
r_int
r_char
id|keycode
)paren
(brace
r_return
l_int|0x80
suffix:semicolon
)brace
DECL|function|lk201_kbd_rx_char
r_static
r_void
id|lk201_kbd_rx_char
c_func
(paren
r_int
r_char
id|ch
comma
r_int
r_char
id|stat
)paren
(brace
r_static
r_int
id|shift_state
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|prev_scancode
suffix:semicolon
r_int
r_char
id|c
op_assign
id|scancodeRemap
(braket
id|ch
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stat
op_logical_or
id|stat
op_eq
l_int|4
)paren
(brace
r_switch
c_cond
(paren
id|ch
)paren
(brace
r_case
id|LK_KEY_ACK
suffix:colon
r_break
suffix:semicolon
r_case
id|LK_KEY_LOCK
suffix:colon
id|shift_state
op_xor_assign
id|LK_LOCK
suffix:semicolon
id|handle_scancode
c_func
(paren
id|c
comma
id|shift_state
op_logical_and
id|LK_LOCK
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LK_KEY_SHIFT
suffix:colon
id|shift_state
op_xor_assign
id|LK_SHIFT
suffix:semicolon
id|handle_scancode
c_func
(paren
id|c
comma
id|shift_state
op_logical_and
id|LK_SHIFT
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LK_KEY_CTRL
suffix:colon
id|shift_state
op_xor_assign
id|LK_CTRL
suffix:semicolon
id|handle_scancode
c_func
(paren
id|c
comma
id|shift_state
op_logical_and
id|LK_CTRL
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LK_KEY_COMP
suffix:colon
id|shift_state
op_xor_assign
id|LK_COMP
suffix:semicolon
id|handle_scancode
c_func
(paren
id|c
comma
id|shift_state
op_logical_and
id|LK_COMP
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LK_KEY_RELEASE
suffix:colon
r_if
c_cond
(paren
id|shift_state
op_amp
id|LK_SHIFT
)paren
id|handle_scancode
c_func
(paren
id|scancodeRemap
(braket
id|LK_KEY_SHIFT
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shift_state
op_amp
id|LK_CTRL
)paren
id|handle_scancode
c_func
(paren
id|scancodeRemap
(braket
id|LK_KEY_CTRL
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shift_state
op_amp
id|LK_COMP
)paren
id|handle_scancode
c_func
(paren
id|scancodeRemap
(braket
id|LK_KEY_COMP
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shift_state
op_amp
id|LK_LOCK
)paren
id|handle_scancode
c_func
(paren
id|scancodeRemap
(braket
id|LK_KEY_LOCK
)braket
comma
l_int|0
)paren
suffix:semicolon
id|shift_state
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LK_KEY_REPEAT
suffix:colon
id|handle_scancode
c_func
(paren
id|prev_scancode
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|prev_scancode
op_assign
id|c
suffix:semicolon
id|handle_scancode
c_func
(paren
id|c
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;Error reading LKx01 keyboard: 0x%02x&bslash;n&quot;
comma
id|stat
)paren
suffix:semicolon
)brace
DECL|function|lk201_info
r_static
r_void
id|__init
id|lk201_info
c_func
(paren
r_struct
id|dec_serial
op_star
id|info
)paren
(brace
)brace
DECL|function|lk201_init
r_static
r_int
id|__init
id|lk201_init
c_func
(paren
r_struct
id|dec_serial
op_star
id|info
)paren
(brace
r_int
r_int
id|ch
comma
id|id
op_assign
l_int|0
suffix:semicolon
r_int
id|result
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DECstation LK keyboard driver v0.04... &quot;
)paren
suffix:semicolon
id|result
op_assign
id|lk201_reset
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Detect whether there is an LK201 or an LK401&n;&t; * The LK401 has ALT keys...&n;&t; */
id|info-&gt;hook
op_member_access_from_pointer
id|poll_tx_char
c_func
(paren
id|info
comma
id|LK_CMD_REQ_ID
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ch
op_assign
id|info-&gt;hook
op_member_access_from_pointer
id|poll_rx_char
c_func
(paren
id|info
)paren
)paren
OG
l_int|0
)paren
id|id
op_assign
id|ch
suffix:semicolon
r_switch
c_cond
(paren
id|id
)paren
(brace
r_case
l_int|1
suffix:colon
id|printk
c_func
(paren
l_string|&quot;LK201 detected&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|printk
c_func
(paren
l_string|&quot;LK401 detected&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;unknown keyboard, ID %d,&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;... please report to &lt;linux-mips@oss.sgi.com&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * now we&squot;re ready&n;&t; */
id|info-&gt;hook-&gt;rx_char
op_assign
id|lk201_kbd_rx_char
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|kbd_init_hw
r_void
id|__init
id|kbd_init_hw
c_func
(paren
r_void
)paren
(brace
r_extern
r_int
id|register_zs_hook
c_func
(paren
r_int
r_int
comma
r_struct
id|zs_hook
op_star
)paren
suffix:semicolon
r_extern
r_int
id|unregister_zs_hook
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TURBOCHANNEL
)paren
(brace
r_if
c_cond
(paren
id|mips_machtype
op_ne
id|MACH_DS5000_XX
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * This is not a MAXINE, so:&n;&t;&t;&t; *&n;&t;&t;&t; * kbd_init_hw() is being called before&n;&t;&t;&t; * rs_init() so just register the kbd hook&n;&t;&t;&t; * and let zs_init do the rest :-)&n;&t;&t;&t; */
r_if
c_cond
(paren
id|mips_machtype
op_eq
id|MACH_DS5000_200
)paren
id|printk
c_func
(paren
l_string|&quot;LK201 Support for DS5000/200 not yet ready ...&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|register_zs_hook
c_func
(paren
id|KEYB_LINE
comma
op_amp
id|lk201_kbdhook
)paren
)paren
(brace
id|unregister_zs_hook
c_func
(paren
id|KEYB_LINE
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * TODO: modify dz.c to allow similar hooks&n;&t;&t; * for LK201 handling on DS2100, DS3100, and DS5000/200&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;LK201 Support for DS3100 not yet ready ...&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
eof
