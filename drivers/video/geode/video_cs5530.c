multiline_comment|/*&n; * drivers/video/geode/video_cs5530.c&n; *   -- CS5530 video device&n; *&n; * Copyright (C) 2005 Arcom Control Systems Ltd.&n; *&n; * Based on AMD&squot;s original 2.4 driver:&n; *   Copyright (C) 2004 Advanced Micro Devices, Inc.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; */
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &quot;geodefb.h&quot;
macro_line|#include &quot;video_cs5530.h&quot;
multiline_comment|/*&n; * CS5530 PLL table. This maps pixclocks to the appropriate PLL register&n; * value.&n; */
DECL|struct|cs5530_pll_entry
r_struct
id|cs5530_pll_entry
(brace
DECL|member|pixclock
r_int
id|pixclock
suffix:semicolon
multiline_comment|/* ps */
DECL|member|pll_value
id|u32
id|pll_value
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|cs5530_pll_table
r_static
r_const
r_struct
id|cs5530_pll_entry
id|cs5530_pll_table
(braket
)braket
op_assign
(brace
(brace
l_int|39721
comma
l_int|0x31C45801
comma
)brace
comma
multiline_comment|/*  25.1750 MHz */
(brace
l_int|35308
comma
l_int|0x20E36802
comma
)brace
comma
multiline_comment|/*  28.3220 */
(brace
l_int|31746
comma
l_int|0x33915801
comma
)brace
comma
multiline_comment|/*  31.5000 */
(brace
l_int|27777
comma
l_int|0x31EC4801
comma
)brace
comma
multiline_comment|/*  36.0000 */
(brace
l_int|26666
comma
l_int|0x21E22801
comma
)brace
comma
multiline_comment|/*  37.5000 */
(brace
l_int|25000
comma
l_int|0x33088801
comma
)brace
comma
multiline_comment|/*  40.0000 */
(brace
l_int|22271
comma
l_int|0x33E22801
comma
)brace
comma
multiline_comment|/*  44.9000 */
(brace
l_int|20202
comma
l_int|0x336C4801
comma
)brace
comma
multiline_comment|/*  49.5000 */
(brace
l_int|20000
comma
l_int|0x23088801
comma
)brace
comma
multiline_comment|/*  50.0000 */
(brace
l_int|19860
comma
l_int|0x23088801
comma
)brace
comma
multiline_comment|/*  50.3500 */
(brace
l_int|18518
comma
l_int|0x3708A801
comma
)brace
comma
multiline_comment|/*  54.0000 */
(brace
l_int|17777
comma
l_int|0x23E36802
comma
)brace
comma
multiline_comment|/*  56.2500 */
(brace
l_int|17733
comma
l_int|0x23E36802
comma
)brace
comma
multiline_comment|/*  56.3916 */
(brace
l_int|17653
comma
l_int|0x23E36802
comma
)brace
comma
multiline_comment|/*  56.6444 */
(brace
l_int|16949
comma
l_int|0x37C45801
comma
)brace
comma
multiline_comment|/*  59.0000 */
(brace
l_int|15873
comma
l_int|0x23EC4801
comma
)brace
comma
multiline_comment|/*  63.0000 */
(brace
l_int|15384
comma
l_int|0x37911801
comma
)brace
comma
multiline_comment|/*  65.0000 */
(brace
l_int|14814
comma
l_int|0x37963803
comma
)brace
comma
multiline_comment|/*  67.5000 */
(brace
l_int|14124
comma
l_int|0x37058803
comma
)brace
comma
multiline_comment|/*  70.8000 */
(brace
l_int|13888
comma
l_int|0x3710C805
comma
)brace
comma
multiline_comment|/*  72.0000 */
(brace
l_int|13333
comma
l_int|0x37E22801
comma
)brace
comma
multiline_comment|/*  75.0000 */
(brace
l_int|12698
comma
l_int|0x27915801
comma
)brace
comma
multiline_comment|/*  78.7500 */
(brace
l_int|12500
comma
l_int|0x37D8D802
comma
)brace
comma
multiline_comment|/*  80.0000 */
(brace
l_int|11135
comma
l_int|0x27588802
comma
)brace
comma
multiline_comment|/*  89.8000 */
(brace
l_int|10582
comma
l_int|0x27EC4802
comma
)brace
comma
multiline_comment|/*  94.5000 */
(brace
l_int|10101
comma
l_int|0x27AC6803
comma
)brace
comma
multiline_comment|/*  99.0000 */
(brace
l_int|10000
comma
l_int|0x27088801
comma
)brace
comma
multiline_comment|/* 100.0000 */
(brace
l_int|9259
comma
l_int|0x2710C805
comma
)brace
comma
multiline_comment|/* 108.0000 */
(brace
l_int|8888
comma
l_int|0x27E36802
comma
)brace
comma
multiline_comment|/* 112.5000 */
(brace
l_int|7692
comma
l_int|0x27C58803
comma
)brace
comma
multiline_comment|/* 130.0000 */
(brace
l_int|7407
comma
l_int|0x27316803
comma
)brace
comma
multiline_comment|/* 135.0000 */
(brace
l_int|6349
comma
l_int|0x2F915801
comma
)brace
comma
multiline_comment|/* 157.5000 */
(brace
l_int|6172
comma
l_int|0x2F08A801
comma
)brace
comma
multiline_comment|/* 162.0000 */
(brace
l_int|5714
comma
l_int|0x2FB11802
comma
)brace
comma
multiline_comment|/* 175.0000 */
(brace
l_int|5291
comma
l_int|0x2FEC4802
comma
)brace
comma
multiline_comment|/* 189.0000 */
(brace
l_int|4950
comma
l_int|0x2F963803
comma
)brace
comma
multiline_comment|/* 202.0000 */
(brace
l_int|4310
comma
l_int|0x2FB1B802
comma
)brace
comma
multiline_comment|/* 232.0000 */
)brace
suffix:semicolon
DECL|macro|NUM_CS5530_FREQUENCIES
mdefine_line|#define NUM_CS5530_FREQUENCIES sizeof(cs5530_pll_table)/sizeof(struct cs5530_pll_entry)
DECL|function|cs5530_set_dclk_frequency
r_static
r_void
id|cs5530_set_dclk_frequency
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|geodefb_par
op_star
id|par
op_assign
id|info-&gt;par
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|value
suffix:semicolon
r_int
id|min
comma
id|diff
suffix:semicolon
multiline_comment|/* Search the table for the closest pixclock. */
id|value
op_assign
id|cs5530_pll_table
(braket
l_int|0
)braket
dot
id|pll_value
suffix:semicolon
id|min
op_assign
id|cs5530_pll_table
(braket
l_int|0
)braket
dot
id|pixclock
op_minus
id|info-&gt;var.pixclock
suffix:semicolon
r_if
c_cond
(paren
id|min
OL
l_int|0
)paren
id|min
op_assign
op_minus
id|min
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|NUM_CS5530_FREQUENCIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diff
op_assign
id|cs5530_pll_table
(braket
id|i
)braket
dot
id|pixclock
op_minus
id|info-&gt;var.pixclock
suffix:semicolon
r_if
c_cond
(paren
id|diff
OL
l_int|0L
)paren
id|diff
op_assign
op_minus
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|diff
OL
id|min
)paren
(brace
id|min
op_assign
id|diff
suffix:semicolon
id|value
op_assign
id|cs5530_pll_table
(braket
id|i
)braket
dot
id|pll_value
suffix:semicolon
)brace
)brace
id|writel
c_func
(paren
id|value
comma
id|par-&gt;vid_regs
op_plus
id|CS5530_DOT_CLK_CONFIG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|value
op_or
l_int|0x80000100
comma
id|par-&gt;vid_regs
op_plus
id|CS5530_DOT_CLK_CONFIG
)paren
suffix:semicolon
multiline_comment|/* set reset and bypass */
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
multiline_comment|/* wait for PLL to settle */
id|writel
c_func
(paren
id|value
op_amp
l_int|0x7FFFFFFF
comma
id|par-&gt;vid_regs
op_plus
id|CS5530_DOT_CLK_CONFIG
)paren
suffix:semicolon
multiline_comment|/* clear reset */
id|writel
c_func
(paren
id|value
op_amp
l_int|0x7FFFFEFF
comma
id|par-&gt;vid_regs
op_plus
id|CS5530_DOT_CLK_CONFIG
)paren
suffix:semicolon
multiline_comment|/* clear bypass */
)brace
DECL|function|cs5530_configure_display
r_static
r_void
id|cs5530_configure_display
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|geodefb_par
op_star
id|par
op_assign
id|info-&gt;par
suffix:semicolon
id|u32
id|dcfg
suffix:semicolon
id|dcfg
op_assign
id|readl
c_func
(paren
id|par-&gt;vid_regs
op_plus
id|CS5530_DISPLAY_CONFIG
)paren
suffix:semicolon
multiline_comment|/* Clear bits from existing mode. */
id|dcfg
op_and_assign
op_complement
(paren
id|CS5530_DCFG_CRT_SYNC_SKW_MASK
op_or
id|CS5530_DCFG_PWR_SEQ_DLY_MASK
op_or
id|CS5530_DCFG_CRT_HSYNC_POL
op_or
id|CS5530_DCFG_CRT_VSYNC_POL
op_or
id|CS5530_DCFG_FP_PWR_EN
op_or
id|CS5530_DCFG_FP_DATA_EN
op_or
id|CS5530_DCFG_DAC_PWR_EN
op_or
id|CS5530_DCFG_VSYNC_EN
op_or
id|CS5530_DCFG_HSYNC_EN
)paren
suffix:semicolon
multiline_comment|/* Set default sync skew and power sequence delays.  */
id|dcfg
op_or_assign
(paren
id|CS5530_DCFG_CRT_SYNC_SKW_INIT
op_or
id|CS5530_DCFG_PWR_SEQ_DLY_INIT
op_or
id|CS5530_DCFG_GV_PAL_BYP
)paren
suffix:semicolon
multiline_comment|/* Enable DACs, hsync and vsync for CRTs */
r_if
c_cond
(paren
id|par-&gt;enable_crt
)paren
(brace
id|dcfg
op_or_assign
id|CS5530_DCFG_DAC_PWR_EN
suffix:semicolon
id|dcfg
op_or_assign
id|CS5530_DCFG_HSYNC_EN
op_or
id|CS5530_DCFG_VSYNC_EN
suffix:semicolon
)brace
multiline_comment|/* Enable panel power and data if using a flat panel. */
r_if
c_cond
(paren
id|par-&gt;panel_x
OG
l_int|0
)paren
(brace
id|dcfg
op_or_assign
id|CS5530_DCFG_FP_PWR_EN
suffix:semicolon
id|dcfg
op_or_assign
id|CS5530_DCFG_FP_DATA_EN
suffix:semicolon
)brace
multiline_comment|/* Sync polarities. */
r_if
c_cond
(paren
id|info-&gt;var.sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
id|dcfg
op_or_assign
id|CS5530_DCFG_CRT_HSYNC_POL
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
id|dcfg
op_or_assign
id|CS5530_DCFG_CRT_VSYNC_POL
suffix:semicolon
id|writel
c_func
(paren
id|dcfg
comma
id|par-&gt;vid_regs
op_plus
id|CS5530_DISPLAY_CONFIG
)paren
suffix:semicolon
)brace
DECL|function|cs5530_blank_display
r_static
r_int
id|cs5530_blank_display
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|blank_mode
)paren
(brace
r_struct
id|geodefb_par
op_star
id|par
op_assign
id|info-&gt;par
suffix:semicolon
id|u32
id|dcfg
suffix:semicolon
r_int
id|blank
comma
id|hsync
comma
id|vsync
suffix:semicolon
r_switch
c_cond
(paren
id|blank_mode
)paren
(brace
r_case
id|FB_BLANK_UNBLANK
suffix:colon
id|blank
op_assign
l_int|0
suffix:semicolon
id|hsync
op_assign
l_int|1
suffix:semicolon
id|vsync
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_NORMAL
suffix:colon
id|blank
op_assign
l_int|1
suffix:semicolon
id|hsync
op_assign
l_int|1
suffix:semicolon
id|vsync
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_VSYNC_SUSPEND
suffix:colon
id|blank
op_assign
l_int|1
suffix:semicolon
id|hsync
op_assign
l_int|1
suffix:semicolon
id|vsync
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_HSYNC_SUSPEND
suffix:colon
id|blank
op_assign
l_int|1
suffix:semicolon
id|hsync
op_assign
l_int|0
suffix:semicolon
id|vsync
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_POWERDOWN
suffix:colon
id|blank
op_assign
l_int|1
suffix:semicolon
id|hsync
op_assign
l_int|0
suffix:semicolon
id|vsync
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dcfg
op_assign
id|readl
c_func
(paren
id|par-&gt;vid_regs
op_plus
id|CS5530_DISPLAY_CONFIG
)paren
suffix:semicolon
id|dcfg
op_and_assign
op_complement
(paren
id|CS5530_DCFG_DAC_BL_EN
op_or
id|CS5530_DCFG_DAC_PWR_EN
op_or
id|CS5530_DCFG_HSYNC_EN
op_or
id|CS5530_DCFG_VSYNC_EN
op_or
id|CS5530_DCFG_FP_DATA_EN
op_or
id|CS5530_DCFG_FP_PWR_EN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;enable_crt
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|blank
)paren
id|dcfg
op_or_assign
id|CS5530_DCFG_DAC_BL_EN
op_or
id|CS5530_DCFG_DAC_PWR_EN
suffix:semicolon
r_if
c_cond
(paren
id|hsync
)paren
id|dcfg
op_or_assign
id|CS5530_DCFG_HSYNC_EN
suffix:semicolon
r_if
c_cond
(paren
id|vsync
)paren
id|dcfg
op_or_assign
id|CS5530_DCFG_VSYNC_EN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|par-&gt;panel_x
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|blank
)paren
id|dcfg
op_or_assign
id|CS5530_DCFG_FP_DATA_EN
suffix:semicolon
r_if
c_cond
(paren
id|hsync
op_logical_and
id|vsync
)paren
id|dcfg
op_or_assign
id|CS5530_DCFG_FP_PWR_EN
suffix:semicolon
)brace
id|writel
c_func
(paren
id|dcfg
comma
id|par-&gt;vid_regs
op_plus
id|CS5530_DISPLAY_CONFIG
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|cs5530_vid_ops
r_struct
id|geode_vid_ops
id|cs5530_vid_ops
op_assign
(brace
dot
id|set_dclk
op_assign
id|cs5530_set_dclk_frequency
comma
dot
id|configure_display
op_assign
id|cs5530_configure_display
comma
dot
id|blank_display
op_assign
id|cs5530_blank_display
comma
)brace
suffix:semicolon
eof
