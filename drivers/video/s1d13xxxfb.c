multiline_comment|/* drivers/video/s1d13xxxfb.c&n; *&n; * (c) 2004 Simtec Electronics&n; * (c) 2005 Thibaut VARENE &lt;varenet@parisc-linux.org&gt;&n; *&n; * Driver for Epson S1D13xxx series framebuffer chips&n; *&n; * Adapted from&n; *  linux/drivers/video/skeletonfb.c&n; *  linux/drivers/video/epson1355fb.c&n; *  linux/drivers/video/epson/s1d13xxxfb.c (2.4 driver by Epson)&n; *&n; * Note, currently only tested on S1D13806 with 16bit CRT.&n; * As such, this driver might still contain some hardcoded bits relating to&n; * S1D13806.&n; * Making it work on other S1D13XXX chips should merely be a matter of adding&n; * a few switch()s, some missing glue here and there maybe, and split header&n; * files.&n; *&n; * TODO: - handle dual screen display (CRT and LCD at the same time).&n; *&t; - check_var(), mode change, etc.&n; *&t; - PM untested.&n; *&t; - Accelerated interfaces.&n; *&t; - Probably not SMP safe :)&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License. See the file COPYING in the main directory of this archive for&n; * more details.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;video/s1d13xxxfb.h&gt;
DECL|macro|PFX
mdefine_line|#define PFX &quot;s1d13xxxfb: &quot;
macro_line|#if 0
mdefine_line|#define dbg(fmt, args...) do { printk(KERN_INFO fmt, ## args); } while(0)
macro_line|#else
DECL|macro|dbg
mdefine_line|#define dbg(fmt, args...) do { } while (0)
macro_line|#endif
multiline_comment|/*&n; * Here we define the default struct fb_fix_screeninfo&n; */
DECL|variable|s1d13xxxfb_fix
r_static
r_struct
id|fb_fix_screeninfo
id|__devinitdata
id|s1d13xxxfb_fix
op_assign
(brace
dot
id|id
op_assign
id|S1D_FBID
comma
dot
id|type
op_assign
id|FB_TYPE_PACKED_PIXELS
comma
dot
id|visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
comma
dot
id|xpanstep
op_assign
l_int|0
comma
dot
id|ypanstep
op_assign
l_int|1
comma
dot
id|ywrapstep
op_assign
l_int|0
comma
dot
id|accel
op_assign
id|FB_ACCEL_NONE
comma
)brace
suffix:semicolon
r_static
r_inline
id|u8
DECL|function|s1d13xxxfb_readreg
id|s1d13xxxfb_readreg
c_func
(paren
r_struct
id|s1d13xxxfb_par
op_star
id|par
comma
id|u16
id|regno
)paren
(brace
r_return
id|readb
c_func
(paren
id|par-&gt;regs
op_plus
id|regno
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|s1d13xxxfb_writereg
id|s1d13xxxfb_writereg
c_func
(paren
r_struct
id|s1d13xxxfb_par
op_star
id|par
comma
id|u16
id|regno
comma
id|u8
id|value
)paren
(brace
id|writeb
c_func
(paren
id|value
comma
id|par-&gt;regs
op_plus
id|regno
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|s1d13xxxfb_runinit
id|s1d13xxxfb_runinit
c_func
(paren
r_struct
id|s1d13xxxfb_par
op_star
id|par
comma
r_const
r_struct
id|s1d13xxxfb_regval
op_star
id|initregs
comma
r_const
r_int
r_int
id|size
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|initregs
(braket
id|i
)braket
dot
id|addr
op_eq
id|S1DREG_DELAYOFF
)paren
op_logical_or
(paren
id|initregs
(braket
id|i
)braket
dot
id|addr
op_eq
id|S1DREG_DELAYON
)paren
)paren
id|mdelay
c_func
(paren
(paren
r_int
)paren
id|initregs
(braket
id|i
)braket
dot
id|value
)paren
suffix:semicolon
r_else
(brace
id|s1d13xxxfb_writereg
c_func
(paren
id|par
comma
id|initregs
(braket
id|i
)braket
dot
id|addr
comma
id|initregs
(braket
id|i
)braket
dot
id|value
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* make sure the hardware can cope with us */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|lcd_enable
id|lcd_enable
c_func
(paren
r_struct
id|s1d13xxxfb_par
op_star
id|par
comma
r_int
id|enable
)paren
(brace
id|u8
id|mode
op_assign
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_COM_DISP_MODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enable
)paren
id|mode
op_or_assign
l_int|0x01
suffix:semicolon
r_else
id|mode
op_and_assign
op_complement
l_int|0x01
suffix:semicolon
id|s1d13xxxfb_writereg
c_func
(paren
id|par
comma
id|S1DREG_COM_DISP_MODE
comma
id|mode
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|crt_enable
id|crt_enable
c_func
(paren
r_struct
id|s1d13xxxfb_par
op_star
id|par
comma
r_int
id|enable
)paren
(brace
id|u8
id|mode
op_assign
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_COM_DISP_MODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enable
)paren
id|mode
op_or_assign
l_int|0x02
suffix:semicolon
r_else
id|mode
op_and_assign
op_complement
l_int|0x02
suffix:semicolon
id|s1d13xxxfb_writereg
c_func
(paren
id|par
comma
id|S1DREG_COM_DISP_MODE
comma
id|mode
)paren
suffix:semicolon
)brace
multiline_comment|/* framebuffer control routines */
r_static
r_inline
r_void
DECL|function|s1d13xxxfb_setup_pseudocolour
id|s1d13xxxfb_setup_pseudocolour
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|info-&gt;var.red.length
op_assign
l_int|4
suffix:semicolon
id|info-&gt;var.green.length
op_assign
l_int|4
suffix:semicolon
id|info-&gt;var.blue.length
op_assign
l_int|4
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|s1d13xxxfb_setup_truecolour
id|s1d13xxxfb_setup_truecolour
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
id|info-&gt;var.bits_per_pixel
op_assign
l_int|16
suffix:semicolon
id|info-&gt;var.red.length
op_assign
l_int|5
suffix:semicolon
id|info-&gt;var.red.offset
op_assign
l_int|11
suffix:semicolon
id|info-&gt;var.green.length
op_assign
l_int|6
suffix:semicolon
id|info-&gt;var.green.offset
op_assign
l_int|5
suffix:semicolon
id|info-&gt;var.blue.length
op_assign
l_int|5
suffix:semicolon
id|info-&gt;var.blue.offset
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *      s1d13xxxfb_set_par - Alters the hardware state.&n; *      @info: frame buffer structure&n; *&n; *&t;Using the fb_var_screeninfo in fb_info we set the depth of the&n; *&t;framebuffer. This function alters the par AND the&n; *&t;fb_fix_screeninfo stored in fb_info. It doesn&squot;t not alter var in&n; *&t;fb_info since we are using that data. This means we depend on the&n; *&t;data in var inside fb_info to be supported by the hardware.&n; *&t;xxxfb_check_var is always called before xxxfb_set_par to ensure this.&n; *&n; *&t;XXX TODO: write proper s1d13xxxfb_check_var(), without which that&n; *&t;function is quite useless.&n; */
r_static
r_int
DECL|function|s1d13xxxfb_set_par
id|s1d13xxxfb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|s1d13xxxfb_par
op_star
id|s1dfb
op_assign
id|info-&gt;par
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;s1d13xxxfb_set_par: bpp=%d&bslash;n&quot;
comma
id|info-&gt;var.bits_per_pixel
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s1dfb-&gt;display
op_amp
l_int|0x01
)paren
)paren
multiline_comment|/* LCD */
id|val
op_assign
id|s1d13xxxfb_readreg
c_func
(paren
id|s1dfb
comma
id|S1DREG_LCD_DISP_MODE
)paren
suffix:semicolon
multiline_comment|/* read colour control */
r_else
multiline_comment|/* CRT */
id|val
op_assign
id|s1d13xxxfb_readreg
c_func
(paren
id|s1dfb
comma
id|S1DREG_CRT_DISP_MODE
)paren
suffix:semicolon
multiline_comment|/* read colour control */
id|val
op_and_assign
op_complement
l_int|0x07
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|4
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;pseudo colour 4&bslash;n&quot;
)paren
suffix:semicolon
id|s1d13xxxfb_setup_pseudocolour
c_func
(paren
id|info
)paren
suffix:semicolon
id|val
op_or_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;pseudo colour 8&bslash;n&quot;
)paren
suffix:semicolon
id|s1d13xxxfb_setup_pseudocolour
c_func
(paren
id|info
)paren
suffix:semicolon
id|val
op_or_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;true colour&bslash;n&quot;
)paren
suffix:semicolon
id|s1d13xxxfb_setup_truecolour
c_func
(paren
id|info
)paren
suffix:semicolon
id|val
op_or_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;bpp not supported!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;writing %02x to display mode register&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s1dfb-&gt;display
op_amp
l_int|0x01
)paren
)paren
multiline_comment|/* LCD */
id|s1d13xxxfb_writereg
c_func
(paren
id|s1dfb
comma
id|S1DREG_LCD_DISP_MODE
comma
id|val
)paren
suffix:semicolon
r_else
multiline_comment|/* CRT */
id|s1d13xxxfb_writereg
c_func
(paren
id|s1dfb
comma
id|S1DREG_CRT_DISP_MODE
comma
id|val
)paren
suffix:semicolon
id|info-&gt;fix.line_length
op_assign
id|info-&gt;var.xres
op_star
id|info-&gt;var.bits_per_pixel
suffix:semicolon
id|info-&gt;fix.line_length
op_div_assign
l_int|8
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;setting line_length to %d&bslash;n&quot;
comma
id|info-&gt;fix.line_length
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;done setup&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *  &t;s1d13xxxfb_setcolreg - sets a color register.&n; *      @regno: Which register in the CLUT we are programming&n; *      @red: The red value which can be up to 16 bits wide&n; *&t;@green: The green value which can be up to 16 bits wide&n; *&t;@blue:  The blue value which can be up to 16 bits wide.&n; *&t;@transp: If supported the alpha value which can be up to 16 bits wide.&n; *      @info: frame buffer info structure&n; *&n; *&t;Returns negative errno on error, or zero on success.&n; */
r_static
r_int
DECL|function|s1d13xxxfb_setcolreg
id|s1d13xxxfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|s1d13xxxfb_par
op_star
id|s1dfb
op_assign
id|info-&gt;par
suffix:semicolon
r_int
r_int
id|pseudo_val
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
id|S1D_PALETTE_SIZE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;s1d13xxxfb_setcolreg: %d: rgb=%d,%d,%d, tr=%d&bslash;n&quot;
comma
id|regno
comma
id|red
comma
id|green
comma
id|blue
comma
id|transp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.grayscale
)paren
id|red
op_assign
id|green
op_assign
id|blue
op_assign
(paren
l_int|19595
op_star
id|red
op_plus
l_int|38470
op_star
id|green
op_plus
l_int|7471
op_star
id|blue
)paren
op_rshift
l_int|16
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;fix.visual
)paren
(brace
r_case
id|FB_VISUAL_TRUECOLOR
suffix:colon
r_if
c_cond
(paren
id|regno
op_ge
l_int|16
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* deal with creating pseudo-palette entries */
id|pseudo_val
op_assign
(paren
id|red
op_rshift
l_int|11
)paren
op_lshift
id|info-&gt;var.red.offset
suffix:semicolon
id|pseudo_val
op_or_assign
(paren
id|green
op_rshift
l_int|10
)paren
op_lshift
id|info-&gt;var.green.offset
suffix:semicolon
id|pseudo_val
op_or_assign
(paren
id|blue
op_rshift
l_int|11
)paren
op_lshift
id|info-&gt;var.blue.offset
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;s1d13xxxfb_setcolreg: pseudo %d, val %08x&bslash;n&quot;
comma
id|regno
comma
id|pseudo_val
)paren
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
id|info-&gt;pseudo_palette
)paren
(braket
id|regno
)braket
op_assign
id|pseudo_val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_VISUAL_PSEUDOCOLOR
suffix:colon
id|s1d13xxxfb_writereg
c_func
(paren
id|s1dfb
comma
id|S1DREG_LKUP_ADDR
comma
id|regno
)paren
suffix:semicolon
id|s1d13xxxfb_writereg
c_func
(paren
id|s1dfb
comma
id|S1DREG_LKUP_DATA
comma
id|red
)paren
suffix:semicolon
id|s1d13xxxfb_writereg
c_func
(paren
id|s1dfb
comma
id|S1DREG_LKUP_DATA
comma
id|green
)paren
suffix:semicolon
id|s1d13xxxfb_writereg
c_func
(paren
id|s1dfb
comma
id|S1DREG_LKUP_DATA
comma
id|blue
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;s1d13xxxfb_setcolreg: done&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *      s1d13xxxfb_blank - blanks the display.&n; *      @blank_mode: the blank mode we want.&n; *      @info: frame buffer structure that represents a single frame buffer&n; *&n; *      Blank the screen if blank_mode != 0, else unblank. Return 0 if&n; *      blanking succeeded, != 0 if un-/blanking failed due to e.g. a&n; *      video mode which doesn&squot;t support it. Implements VESA suspend&n; *      and powerdown modes on hardware that supports disabling hsync/vsync:&n; *      blank_mode == 2: suspend vsync&n; *      blank_mode == 3: suspend hsync&n; *      blank_mode == 4: powerdown&n; *&n; *      Returns negative errno on error, or zero on success.&n; */
r_static
r_int
DECL|function|s1d13xxxfb_blank
id|s1d13xxxfb_blank
c_func
(paren
r_int
id|blank_mode
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|s1d13xxxfb_par
op_star
id|par
op_assign
id|info-&gt;par
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;s1d13xxxfb_blank: blank=%d, info=%p&bslash;n&quot;
comma
id|blank_mode
comma
id|info
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|blank_mode
)paren
(brace
r_case
id|FB_BLANK_UNBLANK
suffix:colon
r_case
id|FB_BLANK_NORMAL
suffix:colon
r_if
c_cond
(paren
(paren
id|par-&gt;display
op_amp
l_int|0x01
)paren
op_ne
l_int|0
)paren
id|lcd_enable
c_func
(paren
id|par
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par-&gt;display
op_amp
l_int|0x02
)paren
op_ne
l_int|0
)paren
id|crt_enable
c_func
(paren
id|par
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_VSYNC_SUSPEND
suffix:colon
r_case
id|FB_BLANK_HSYNC_SUSPEND
suffix:colon
r_break
suffix:semicolon
r_case
id|FB_BLANK_POWERDOWN
suffix:colon
id|lcd_enable
c_func
(paren
id|par
comma
l_int|0
)paren
suffix:semicolon
id|crt_enable
c_func
(paren
id|par
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* let fbcon do a soft blank for us */
r_return
(paren
(paren
id|blank_mode
op_eq
id|FB_BLANK_NORMAL
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *      s1d13xxxfb_pan_display - Pans the display.&n; *      @var: frame buffer variable screen structure&n; *      @info: frame buffer structure that represents a single frame buffer&n; *&n; *&t;Pan (or wrap, depending on the `vmode&squot; field) the display using the&n; *  &t;`yoffset&squot; field of the `var&squot; structure (`xoffset&squot;  not yet supported).&n; *  &t;If the values don&squot;t fit, return -EINVAL.&n; *&n; *      Returns negative errno on error, or zero on success.&n; */
r_static
r_int
DECL|function|s1d13xxxfb_pan_display
id|s1d13xxxfb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|s1d13xxxfb_par
op_star
id|par
op_assign
id|info-&gt;par
suffix:semicolon
id|u32
id|start
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xoffset
op_ne
l_int|0
)paren
multiline_comment|/* not yet ... */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yoffset
op_plus
id|info-&gt;var.yres
OG
id|info-&gt;var.yres_virtual
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|start
op_assign
(paren
id|info-&gt;fix.line_length
op_rshift
l_int|1
)paren
op_star
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par-&gt;display
op_amp
l_int|0x01
)paren
)paren
(brace
multiline_comment|/* LCD */
id|s1d13xxxfb_writereg
c_func
(paren
id|par
comma
id|S1DREG_LCD_DISP_START0
comma
(paren
id|start
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|s1d13xxxfb_writereg
c_func
(paren
id|par
comma
id|S1DREG_LCD_DISP_START1
comma
(paren
(paren
id|start
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|s1d13xxxfb_writereg
c_func
(paren
id|par
comma
id|S1DREG_LCD_DISP_START2
comma
(paren
(paren
id|start
op_rshift
l_int|16
)paren
op_amp
l_int|0x0f
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* CRT */
id|s1d13xxxfb_writereg
c_func
(paren
id|par
comma
id|S1DREG_CRT_DISP_START0
comma
(paren
id|start
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|s1d13xxxfb_writereg
c_func
(paren
id|par
comma
id|S1DREG_CRT_DISP_START1
comma
(paren
(paren
id|start
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|s1d13xxxfb_writereg
c_func
(paren
id|par
comma
id|S1DREG_CRT_DISP_START2
comma
(paren
(paren
id|start
op_rshift
l_int|16
)paren
op_amp
l_int|0x0f
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* framebuffer information structures */
DECL|variable|s1d13xxxfb_fbops
r_static
r_struct
id|fb_ops
id|s1d13xxxfb_fbops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|fb_set_par
op_assign
id|s1d13xxxfb_set_par
comma
dot
id|fb_setcolreg
op_assign
id|s1d13xxxfb_setcolreg
comma
dot
id|fb_blank
op_assign
id|s1d13xxxfb_blank
comma
dot
id|fb_pan_display
op_assign
id|s1d13xxxfb_pan_display
comma
multiline_comment|/* to be replaced by any acceleration we can */
dot
id|fb_fillrect
op_assign
id|cfb_fillrect
comma
dot
id|fb_copyarea
op_assign
id|cfb_copyarea
comma
dot
id|fb_imageblit
op_assign
id|cfb_imageblit
comma
dot
id|fb_cursor
op_assign
id|soft_cursor
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_int
id|s1d13xxxfb_width_tab
(braket
l_int|2
)braket
(braket
l_int|4
)braket
id|__devinitdata
op_assign
(brace
(brace
l_int|4
comma
l_int|8
comma
l_int|16
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|9
comma
l_int|12
comma
l_int|18
comma
op_minus
l_int|1
)brace
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *      s1d13xxxfb_fetch_hw_state - Configure the framebuffer according to&n; *&t;hardware setup.&n; *      @info: frame buffer structure&n; *&n; *&t;We setup the framebuffer structures according to the current&n; *&t;hardware setup. On some machines, the BIOS will have filled&n; *&t;the chip registers with such info, on others, these values will&n; *&t;have been written in some init procedure. In any case, the&n; *&t;software values needs to match the hardware ones. This is what&n; *&t;this function ensures.&n; *&n; *&t;Note: some of the hardcoded values here might need some love to&n; *&t;work on various chips, and might need to no longer be hardcoded.&n; */
r_static
r_void
id|__devinit
DECL|function|s1d13xxxfb_fetch_hw_state
id|s1d13xxxfb_fetch_hw_state
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|info-&gt;var
suffix:semicolon
r_struct
id|fb_fix_screeninfo
op_star
id|fix
op_assign
op_amp
id|info-&gt;fix
suffix:semicolon
r_struct
id|s1d13xxxfb_par
op_star
id|par
op_assign
id|info-&gt;par
suffix:semicolon
id|u8
id|panel
comma
id|display
suffix:semicolon
id|u16
id|offset
suffix:semicolon
id|u32
id|xres
comma
id|yres
suffix:semicolon
id|u32
id|xres_virtual
comma
id|yres_virtual
suffix:semicolon
r_int
id|bpp
comma
id|lcd_bpp
suffix:semicolon
r_int
id|is_color
comma
id|is_dual
comma
id|is_tft
suffix:semicolon
r_int
id|lcd_enabled
comma
id|crt_enabled
suffix:semicolon
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
multiline_comment|/* general info */
id|par-&gt;display
op_assign
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_COM_DISP_MODE
)paren
suffix:semicolon
id|crt_enabled
op_assign
(paren
id|par-&gt;display
op_amp
l_int|0x02
)paren
op_ne
l_int|0
suffix:semicolon
id|lcd_enabled
op_assign
(paren
id|par-&gt;display
op_amp
l_int|0x01
)paren
op_ne
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lcd_enabled
op_logical_and
id|crt_enabled
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;Warning: LCD and CRT detected, using LCD&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcd_enabled
)paren
id|display
op_assign
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_LCD_DISP_MODE
)paren
suffix:semicolon
r_else
multiline_comment|/* CRT */
id|display
op_assign
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_CRT_DISP_MODE
)paren
suffix:semicolon
id|bpp
op_assign
id|display
op_amp
l_int|0x07
suffix:semicolon
r_switch
c_cond
(paren
id|bpp
)paren
(brace
r_case
l_int|2
suffix:colon
multiline_comment|/* 4 bpp */
r_case
l_int|3
suffix:colon
multiline_comment|/* 8 bpp */
id|var-&gt;bits_per_pixel
op_assign
l_int|8
suffix:semicolon
id|var-&gt;red.offset
op_assign
id|var-&gt;green.offset
op_assign
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
id|var-&gt;green.length
op_assign
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* 16 bpp */
id|s1d13xxxfb_setup_truecolour
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;bpp: %i&bslash;n&quot;
comma
id|bpp
)paren
suffix:semicolon
)brace
id|fb_alloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
comma
l_int|256
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* LCD info */
id|panel
op_assign
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_PANEL_TYPE
)paren
suffix:semicolon
id|is_color
op_assign
(paren
id|panel
op_amp
l_int|0x04
)paren
op_ne
l_int|0
suffix:semicolon
id|is_dual
op_assign
(paren
id|panel
op_amp
l_int|0x02
)paren
op_ne
l_int|0
suffix:semicolon
id|is_tft
op_assign
(paren
id|panel
op_amp
l_int|0x01
)paren
op_ne
l_int|0
suffix:semicolon
id|lcd_bpp
op_assign
id|s1d13xxxfb_width_tab
(braket
id|is_tft
)braket
(braket
(paren
id|panel
op_rshift
l_int|4
)paren
op_amp
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|lcd_enabled
)paren
(brace
id|xres
op_assign
(paren
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_LCD_DISP_HWIDTH
)paren
op_plus
l_int|1
)paren
op_star
l_int|8
suffix:semicolon
id|yres
op_assign
(paren
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_LCD_DISP_VHEIGHT0
)paren
op_plus
(paren
(paren
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_LCD_DISP_VHEIGHT1
)paren
op_amp
l_int|0x03
)paren
op_lshift
l_int|8
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|offset
op_assign
(paren
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_LCD_MEM_OFF0
)paren
op_plus
(paren
(paren
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_LCD_MEM_OFF1
)paren
op_amp
l_int|0x7
)paren
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* crt */
id|xres
op_assign
(paren
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_CRT_DISP_HWIDTH
)paren
op_plus
l_int|1
)paren
op_star
l_int|8
suffix:semicolon
id|yres
op_assign
(paren
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_CRT_DISP_VHEIGHT0
)paren
op_plus
(paren
(paren
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_CRT_DISP_VHEIGHT1
)paren
op_amp
l_int|0x03
)paren
op_lshift
l_int|8
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|offset
op_assign
(paren
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_CRT_MEM_OFF0
)paren
op_plus
(paren
(paren
id|s1d13xxxfb_readreg
c_func
(paren
id|par
comma
id|S1DREG_CRT_MEM_OFF1
)paren
op_amp
l_int|0x7
)paren
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
)brace
id|xres_virtual
op_assign
id|offset
op_star
l_int|16
op_div
id|var-&gt;bits_per_pixel
suffix:semicolon
id|yres_virtual
op_assign
id|fix-&gt;smem_len
op_div
(paren
id|offset
op_star
l_int|2
)paren
suffix:semicolon
id|var-&gt;xres
op_assign
id|xres
suffix:semicolon
id|var-&gt;yres
op_assign
id|yres
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|xres_virtual
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|yres_virtual
suffix:semicolon
id|var-&gt;xoffset
op_assign
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;line_length
op_assign
id|offset
op_star
l_int|2
suffix:semicolon
id|var-&gt;grayscale
op_assign
op_logical_neg
id|is_color
suffix:semicolon
id|var-&gt;activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|dbg
c_func
(paren
id|PFX
l_string|&quot;bpp=%d, lcd_bpp=%d, &quot;
l_string|&quot;crt_enabled=%d, lcd_enabled=%d&bslash;n&quot;
comma
id|var-&gt;bits_per_pixel
comma
id|lcd_bpp
comma
id|crt_enabled
comma
id|lcd_enabled
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|PFX
l_string|&quot;xres=%d, yres=%d, vxres=%d, vyres=%d &quot;
l_string|&quot;is_color=%d, is_dual=%d, is_tft=%d&bslash;n&quot;
comma
id|xres
comma
id|yres
comma
id|xres_virtual
comma
id|yres_virtual
comma
id|is_color
comma
id|is_dual
comma
id|is_tft
)paren
suffix:semicolon
)brace
r_static
r_int
id|__devexit
DECL|function|s1d13xxxfb_remove
id|s1d13xxxfb_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|platform_device
op_star
id|pdev
op_assign
id|to_platform_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|s1d13xxxfb_par
op_star
id|par
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|info
)paren
(brace
id|par
op_assign
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|par
op_logical_and
id|par-&gt;regs
)paren
(brace
multiline_comment|/* disable output &amp; enable powersave */
id|s1d13xxxfb_writereg
c_func
(paren
id|par
comma
id|S1DREG_COM_DISP_MODE
comma
l_int|0x00
)paren
suffix:semicolon
id|s1d13xxxfb_writereg
c_func
(paren
id|par
comma
id|S1DREG_PS_CNF
comma
l_int|0x11
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|par-&gt;regs
)paren
suffix:semicolon
)brace
id|fb_dealloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;screen_base
)paren
id|iounmap
c_func
(paren
id|info-&gt;screen_base
)paren
suffix:semicolon
id|framebuffer_release
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|release_mem_region
c_func
(paren
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|end
op_minus
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_plus
l_int|1
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
comma
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|end
op_minus
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
op_plus
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__devinit
DECL|function|s1d13xxxfb_probe
id|s1d13xxxfb_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|platform_device
op_star
id|pdev
op_assign
id|to_platform_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|s1d13xxxfb_par
op_star
id|default_par
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_struct
id|s1d13xxxfb_pdata
op_star
id|pdata
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|u8
id|revision
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;probe called: device is %p&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Epson S1D13XXX FB Driver&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* enable platform-dependent hardware glue, if any */
r_if
c_cond
(paren
id|dev-&gt;platform_data
)paren
id|pdata
op_assign
id|dev-&gt;platform_data
suffix:semicolon
r_if
c_cond
(paren
id|pdata
op_logical_and
id|pdata-&gt;platform_init_video
)paren
id|pdata
op_member_access_from_pointer
id|platform_init_video
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;num_resources
op_ne
l_int|2
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;invalid num_resources: %i&bslash;n&quot;
comma
id|pdev-&gt;num_resources
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
multiline_comment|/* resource[0] is VRAM, resource[1] is registers */
r_if
c_cond
(paren
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|flags
op_ne
id|IORESOURCE_MEM
op_logical_or
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|flags
op_ne
id|IORESOURCE_MEM
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;invalid resource type&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|end
op_minus
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_plus
l_int|1
comma
l_string|&quot;s1d13xxxfb mem&quot;
)paren
)paren
(brace
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;request_mem_region failed&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
comma
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|end
op_minus
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
op_plus
l_int|1
comma
l_string|&quot;s1d13xxxfb regs&quot;
)paren
)paren
(brace
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;request_mem_region failed&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
id|info
op_assign
id|framebuffer_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|s1d13xxxfb_par
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
op_star
l_int|256
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
id|default_par
op_assign
id|info-&gt;par
suffix:semicolon
id|default_par-&gt;regs
op_assign
id|ioremap_nocache
c_func
(paren
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
comma
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|end
op_minus
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|default_par-&gt;regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;unable to map registers&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
id|info-&gt;pseudo_palette
op_assign
id|default_par-&gt;pseudo_palette
suffix:semicolon
id|info-&gt;screen_base
op_assign
id|ioremap_nocache
c_func
(paren
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|end
op_minus
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;screen_base
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;unable to map framebuffer&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
id|revision
op_assign
id|s1d13xxxfb_readreg
c_func
(paren
id|default_par
comma
id|S1DREG_REV_CODE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|revision
op_rshift
l_int|2
)paren
op_ne
id|S1D_CHIP_REV
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;chip not found: %i&bslash;n&quot;
comma
(paren
id|revision
op_rshift
l_int|2
)paren
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
id|info-&gt;fix
op_assign
id|s1d13xxxfb_fix
suffix:semicolon
id|info-&gt;fix.mmio_start
op_assign
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
suffix:semicolon
id|info-&gt;fix.mmio_len
op_assign
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|end
op_minus
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
op_plus
l_int|1
suffix:semicolon
id|info-&gt;fix.smem_start
op_assign
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|info-&gt;fix.smem_len
op_assign
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|end
op_minus
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_plus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;regs mapped at 0x%p, fb %d KiB mapped at 0x%p&bslash;n&quot;
comma
id|default_par-&gt;regs
comma
id|info-&gt;fix.smem_len
op_div
l_int|1024
comma
id|info-&gt;screen_base
)paren
suffix:semicolon
id|info-&gt;par
op_assign
id|default_par
suffix:semicolon
id|info-&gt;fbops
op_assign
op_amp
id|s1d13xxxfb_fbops
suffix:semicolon
id|info-&gt;flags
op_assign
id|FBINFO_DEFAULT
op_or
id|FBINFO_HWACCEL_YPAN
suffix:semicolon
multiline_comment|/* perform &quot;manual&quot; chip initialization, if needed */
r_if
c_cond
(paren
id|pdata
op_logical_and
id|pdata-&gt;initregs
)paren
id|s1d13xxxfb_runinit
c_func
(paren
id|info-&gt;par
comma
id|pdata-&gt;initregs
comma
id|pdata-&gt;initregssize
)paren
suffix:semicolon
id|s1d13xxxfb_fetch_hw_state
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
id|info
)paren
OL
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
id|dev_set_drvdata
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
id|info
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fb%d: %s frame buffer device&bslash;n&quot;
comma
id|info-&gt;node
comma
id|info-&gt;fix.id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|bail
suffix:colon
id|s1d13xxxfb_remove
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
DECL|function|s1d13xxxfb_suspend
r_static
r_int
id|s1d13xxxfb_suspend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
comma
id|u32
id|level
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|s1d13xxxfb_par
op_star
id|s1dfb
op_assign
id|info-&gt;par
suffix:semicolon
r_struct
id|s1d13xxxfb_pdata
op_star
id|pdata
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* disable display */
id|lcd_enable
c_func
(paren
id|s1dfb
comma
l_int|0
)paren
suffix:semicolon
id|crt_enable
c_func
(paren
id|s1dfb
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;platform_data
)paren
id|pdata
op_assign
id|dev-&gt;platform_data
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|s1dfb-&gt;disp_save
)paren
id|s1dfb-&gt;disp_save
op_assign
id|kmalloc
c_func
(paren
id|info-&gt;fix.smem_len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s1dfb-&gt;disp_save
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;no memory to save screen&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy_fromio
c_func
(paren
id|s1dfb-&gt;disp_save
comma
id|info-&gt;screen_base
comma
id|info-&gt;fix.smem_len
)paren
suffix:semicolon
macro_line|#else
id|s1dfb-&gt;disp_save
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|s1dfb-&gt;regs_save
)paren
id|s1dfb-&gt;regs_save
op_assign
id|kmalloc
c_func
(paren
id|info-&gt;fix.mmio_len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s1dfb-&gt;regs_save
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;no memory to save registers&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* backup all registers */
id|memcpy_fromio
c_func
(paren
id|s1dfb-&gt;regs_save
comma
id|s1dfb-&gt;regs
comma
id|info-&gt;fix.mmio_len
)paren
suffix:semicolon
multiline_comment|/* now activate power save mode */
id|s1d13xxxfb_writereg
c_func
(paren
id|s1dfb
comma
id|S1DREG_PS_CNF
comma
l_int|0x11
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdata
op_logical_and
id|pdata-&gt;platform_suspend_video
)paren
r_return
id|pdata
op_member_access_from_pointer
id|platform_suspend_video
c_func
(paren
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|s1d13xxxfb_resume
r_static
r_int
id|s1d13xxxfb_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|level
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|s1d13xxxfb_par
op_star
id|s1dfb
op_assign
id|info-&gt;par
suffix:semicolon
r_struct
id|s1d13xxxfb_pdata
op_star
id|pdata
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|level
op_ne
id|RESUME_ENABLE
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* awaken the chip */
id|s1d13xxxfb_writereg
c_func
(paren
id|s1dfb
comma
id|S1DREG_PS_CNF
comma
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* do not let go until SDRAM &quot;wakes up&quot; */
r_while
c_loop
(paren
(paren
id|s1d13xxxfb_readreg
c_func
(paren
id|s1dfb
comma
id|S1DREG_PS_STATUS
)paren
op_amp
l_int|0x01
)paren
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;platform_data
)paren
id|pdata
op_assign
id|dev-&gt;platform_data
suffix:semicolon
r_if
c_cond
(paren
id|s1dfb-&gt;regs_save
)paren
(brace
multiline_comment|/* will write RO regs, *should* get away with it :) */
id|memcpy_toio
c_func
(paren
id|s1dfb-&gt;regs
comma
id|s1dfb-&gt;regs_save
comma
id|info-&gt;fix.mmio_len
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|s1dfb-&gt;regs_save
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s1dfb-&gt;disp_save
)paren
(brace
id|memcpy_toio
c_func
(paren
id|info-&gt;screen_base
comma
id|s1dfb-&gt;disp_save
comma
id|info-&gt;fix.smem_len
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|s1dfb-&gt;disp_save
)paren
suffix:semicolon
multiline_comment|/* XXX kmalloc()&squot;d when? */
)brace
r_if
c_cond
(paren
(paren
id|s1dfb-&gt;display
op_amp
l_int|0x01
)paren
op_ne
l_int|0
)paren
id|lcd_enable
c_func
(paren
id|s1dfb
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s1dfb-&gt;display
op_amp
l_int|0x02
)paren
op_ne
l_int|0
)paren
id|crt_enable
c_func
(paren
id|s1dfb
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdata
op_logical_and
id|pdata-&gt;platform_resume_video
)paren
r_return
id|pdata
op_member_access_from_pointer
id|platform_resume_video
c_func
(paren
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PM */
DECL|variable|s1d13xxxfb_driver
r_static
r_struct
id|device_driver
id|s1d13xxxfb_driver
op_assign
(brace
dot
id|name
op_assign
id|S1D_DEVICENAME
comma
dot
id|bus
op_assign
op_amp
id|platform_bus_type
comma
dot
id|probe
op_assign
id|s1d13xxxfb_probe
comma
dot
id|remove
op_assign
id|s1d13xxxfb_remove
comma
macro_line|#ifdef CONFIG_PM
dot
id|suspend
op_assign
id|s1d13xxxfb_suspend
comma
dot
id|resume
op_assign
id|s1d13xxxfb_resume
macro_line|#endif
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|s1d13xxxfb_init
id|s1d13xxxfb_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|fb_get_options
c_func
(paren
l_string|&quot;s1d13xxxfb&quot;
comma
l_int|NULL
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|driver_register
c_func
(paren
op_amp
id|s1d13xxxfb_driver
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|s1d13xxxfb_exit
id|s1d13xxxfb_exit
c_func
(paren
r_void
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|s1d13xxxfb_driver
)paren
suffix:semicolon
)brace
DECL|variable|s1d13xxxfb_init
id|module_init
c_func
(paren
id|s1d13xxxfb_init
)paren
suffix:semicolon
DECL|variable|s1d13xxxfb_exit
id|module_exit
c_func
(paren
id|s1d13xxxfb_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Framebuffer driver for S1D13xxx devices&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ben Dooks &lt;ben@simtec.co.uk&gt;, Thibaut VARENE &lt;varenet@parisc-linux.org&gt;&quot;
)paren
suffix:semicolon
eof
