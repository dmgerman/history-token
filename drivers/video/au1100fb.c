multiline_comment|/*&n; * BRIEF MODULE DESCRIPTION&n; *&t;Au1100 LCD Driver.&n; *&n; * Copyright 2002 MontaVista Software&n; * Author: MontaVista Software, Inc.&n; *&t;&t;ppopov@mvista.com or source@mvista.com&n; *&n; * Copyright 2002 Alchemy Semiconductor&n; * Author: Alchemy Semiconductor&n; *&n; * Based on:&n; * linux/drivers/video/skeletonfb.c -- Skeleton for a frame buffer device&n; *  Created 28 Dec 1997 by Geert Uytterhoeven&n; *&n; *  This program is free software; you can redistribute&t; it and/or modify it&n; *  under  the terms of&t; the GNU General  Public License as published by the&n; *  Free Software Foundation;  either version 2 of the&t;License, or (at your&n; *  option) any later version.&n; *&n; *  THIS  SOFTWARE  IS PROVIDED&t;  ``AS&t;IS&squot;&squot; AND   ANY&t;EXPRESS OR IMPLIED&n; *  WARRANTIES,&t;  INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN&n; *  NO&t;EVENT  SHALL   THE AUTHOR  BE&t; LIABLE FOR ANY&t;  DIRECT, INDIRECT,&n; *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT&n; *  NOT LIMITED&t;  TO, PROCUREMENT OF  SUBSTITUTE GOODS&t;OR SERVICES; LOSS OF&n; *  USE, DATA,&t;OR PROFITS; OR&t;BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON&n; *  ANY THEORY OF LIABILITY, WHETHER IN&t; CONTRACT, STRICT LIABILITY, OR TORT&n; *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF&n; *  THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; *  You should have received a copy of the  GNU General Public License along&n; *  with this program; if not, write  to the Free Software Foundation, Inc.,&n; *  675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/au1000.h&gt;
macro_line|#include &lt;asm/pb1100.h&gt;
macro_line|#include &quot;au1100fb.h&quot;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-mfb.h&gt;
macro_line|#include &lt;video/fbcon-cfb2.h&gt;
macro_line|#include &lt;video/fbcon-cfb4.h&gt;
macro_line|#include &lt;video/fbcon-cfb8.h&gt;
macro_line|#include &lt;video/fbcon-cfb16.h&gt;
multiline_comment|/*&n; * Sanity check. If this is a new Au1100 based board, search for&n; * the PB1100 ifdefs to make sure you modify the code accordingly.&n; */
macro_line|#if defined(CONFIG_MIPS_PB1100) || defined(CONFIG_MIPS_DB1100) || defined(CONFIG_MIPS_HYDROGEN3)
macro_line|#else
id|error
id|Unknown
id|Au1100
id|board
macro_line|#endif
DECL|macro|CMAPSIZE
mdefine_line|#define CMAPSIZE 16
DECL|variable|my_lcd_index
r_static
r_int
id|my_lcd_index
suffix:semicolon
multiline_comment|/* default is zero */
DECL|variable|p_lcd
r_struct
id|known_lcd_panels
op_star
id|p_lcd
suffix:semicolon
DECL|variable|p_lcd_reg
id|AU1100_LCD
op_star
id|p_lcd_reg
op_assign
(paren
id|AU1100_LCD
op_star
)paren
id|AU1100_LCD_ADDR
suffix:semicolon
DECL|struct|au1100fb_info
r_struct
id|au1100fb_info
(brace
DECL|member|gen
r_struct
id|fb_info_gen
id|gen
suffix:semicolon
DECL|member|fb_virt_start
r_int
r_int
id|fb_virt_start
suffix:semicolon
DECL|member|fb_size
r_int
r_int
id|fb_size
suffix:semicolon
DECL|member|fb_phys
r_int
r_int
id|fb_phys
suffix:semicolon
DECL|member|mmaped
r_int
id|mmaped
suffix:semicolon
DECL|member|nohwcursor
r_int
id|nohwcursor
suffix:semicolon
DECL|member|red
DECL|member|green
DECL|member|blue
DECL|member|pad
DECL|member|palette
r_struct
(brace
r_int
id|red
comma
id|green
comma
id|blue
comma
id|pad
suffix:semicolon
)brace
id|palette
(braket
l_int|256
)braket
suffix:semicolon
macro_line|#if defined(FBCON_HAS_CFB16)
DECL|member|fbcon_cmap16
id|u16
id|fbcon_cmap16
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
DECL|struct|au1100fb_par
r_struct
id|au1100fb_par
(brace
DECL|member|var
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
DECL|member|line_length
r_int
id|line_length
suffix:semicolon
singleline_comment|// in bytes
DECL|member|cmap_len
r_int
id|cmap_len
suffix:semicolon
singleline_comment|// color-map length
)brace
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|au1100fb_info
id|fb_info
suffix:semicolon
DECL|variable|current_par
r_static
r_struct
id|au1100fb_par
id|current_par
suffix:semicolon
DECL|variable|disp
r_static
r_struct
id|display
id|disp
suffix:semicolon
r_int
id|au1100fb_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|au1100fb_setup
c_func
(paren
r_char
op_star
id|options
comma
r_int
op_star
id|ints
)paren
suffix:semicolon
r_static
r_int
id|au1100fb_mmap
c_func
(paren
r_struct
id|fb_info
op_star
id|fb
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
suffix:semicolon
r_static
r_int
id|au1100_blank
c_func
(paren
r_int
id|blank_mode
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|au1100fb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
DECL|function|au1100_nocursor
r_void
suffix:semicolon
DECL|variable|au1100fb_ops
r_static
r_struct
id|fb_ops
id|au1100fb_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|fb_get_fix
suffix:colon
id|fbgen_get_fix
comma
id|fb_get_var
suffix:colon
id|fbgen_get_var
comma
id|fb_set_var
suffix:colon
id|fbgen_set_var
comma
id|fb_get_cmap
suffix:colon
id|fbgen_get_cmap
comma
id|fb_set_cmap
suffix:colon
id|fbgen_set_cmap
comma
id|fb_pan_display
suffix:colon
id|fbgen_pan_display
comma
id|fb_ioctl
suffix:colon
id|au1100fb_ioctl
comma
id|fb_mmap
suffix:colon
id|au1100fb_mmap
comma
)brace
suffix:semicolon
DECL|function|au1100_detect
r_static
r_void
id|au1100_detect
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; *  This function should detect the current video mode settings&n;&t; *  and store it as the default video mode&n;&t; */
multiline_comment|/*&n;&t; * Yeh, well, we&squot;re not going to change any settings so we&squot;re&n;&t; * always stuck with the default ...&n;&t; */
)brace
DECL|function|au1100_encode_fix
r_static
r_int
id|au1100_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_const
r_void
op_star
id|_par
comma
r_struct
id|fb_info_gen
op_star
id|_info
)paren
(brace
r_struct
id|au1100fb_info
op_star
id|info
op_assign
(paren
r_struct
id|au1100fb_info
op_star
)paren
id|_info
suffix:semicolon
r_struct
id|au1100fb_par
op_star
id|par
op_assign
(paren
r_struct
id|au1100fb_par
op_star
)paren
id|_par
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|par-&gt;var
suffix:semicolon
id|memset
c_func
(paren
id|fix
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_fix_screeninfo
)paren
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
id|info-&gt;fb_phys
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|info-&gt;fb_size
suffix:semicolon
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;visual
op_assign
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|8
)paren
ques
c_cond
id|FB_VISUAL_PSEUDOCOLOR
suffix:colon
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
id|fix-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;line_length
op_assign
id|current_par.line_length
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_color_bitfields
r_static
r_void
id|set_color_bitfields
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
multiline_comment|/* RGB 565 */
id|var-&gt;red.offset
op_assign
l_int|11
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.msb_right
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|au1100_decode_var
r_static
r_int
id|au1100_decode_var
c_func
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_void
op_star
id|_par
comma
r_struct
id|fb_info_gen
op_star
id|_info
)paren
(brace
r_struct
id|au1100fb_par
op_star
id|par
op_assign
(paren
r_struct
id|au1100fb_par
op_star
)paren
id|_par
suffix:semicolon
multiline_comment|/*&n;&t; * Don&squot;t allow setting any of these yet: xres and yres don&squot;t&n;&t; * make sense for LCD panels.&n;&t; */
r_if
c_cond
(paren
id|var-&gt;xres
op_ne
id|p_lcd-&gt;xres
op_logical_or
id|var-&gt;yres
op_ne
id|p_lcd-&gt;yres
op_logical_or
id|var-&gt;xres
op_ne
id|p_lcd-&gt;xres
op_logical_or
id|var-&gt;yres
op_ne
id|p_lcd-&gt;yres
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_ne
id|p_lcd-&gt;bpp
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|par
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|au1100fb_par
)paren
)paren
suffix:semicolon
id|par-&gt;var
op_assign
op_star
id|var
suffix:semicolon
multiline_comment|/* FIXME */
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
id|par-&gt;var.bits_per_pixel
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|par-&gt;var.bits_per_pixel
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;color depth %d bpp not supported&bslash;n&quot;
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|set_color_bitfields
c_func
(paren
op_amp
id|par-&gt;var
)paren
suffix:semicolon
id|par-&gt;cmap_len
op_assign
(paren
id|par-&gt;var.bits_per_pixel
op_eq
l_int|8
)paren
ques
c_cond
l_int|256
suffix:colon
l_int|16
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1100_encode_var
r_static
r_int
id|au1100_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_const
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|_info
)paren
(brace
op_star
id|var
op_assign
(paren
(paren
r_struct
id|au1100fb_par
op_star
)paren
id|par
)paren
op_member_access_from_pointer
id|var
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|au1100_get_par
id|au1100_get_par
c_func
(paren
r_void
op_star
id|_par
comma
r_struct
id|fb_info_gen
op_star
id|_info
)paren
(brace
op_star
(paren
r_struct
id|au1100fb_par
op_star
)paren
id|_par
op_assign
id|current_par
suffix:semicolon
)brace
DECL|function|au1100_set_par
r_static
r_void
id|au1100_set_par
c_func
(paren
r_const
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
(brace
multiline_comment|/* nothing to do: we don&squot;t change any settings */
)brace
DECL|function|au1100_getcolreg
r_static
r_int
id|au1100_getcolreg
c_func
(paren
r_int
id|regno
comma
r_int
op_star
id|red
comma
r_int
op_star
id|green
comma
r_int
op_star
id|blue
comma
r_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|au1100fb_info
op_star
id|i
op_assign
(paren
r_struct
id|au1100fb_info
op_star
)paren
id|info
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
op_star
id|red
op_assign
id|i-&gt;palette
(braket
id|regno
)braket
dot
id|red
suffix:semicolon
op_star
id|green
op_assign
id|i-&gt;palette
(braket
id|regno
)braket
dot
id|green
suffix:semicolon
op_star
id|blue
op_assign
id|i-&gt;palette
(braket
id|regno
)braket
dot
id|blue
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1100_setcolreg
r_static
r_int
id|au1100_setcolreg
c_func
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|au1100fb_info
op_star
id|i
op_assign
(paren
r_struct
id|au1100fb_info
op_star
)paren
id|info
suffix:semicolon
id|u32
id|rgbcol
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
id|i-&gt;palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|i-&gt;palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|i-&gt;palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
r_switch
c_cond
(paren
id|p_lcd-&gt;bpp
)paren
(brace
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
id|red
op_rshift_assign
l_int|10
suffix:semicolon
id|green
op_rshift_assign
l_int|10
suffix:semicolon
id|blue
op_rshift_assign
l_int|10
suffix:semicolon
id|p_lcd_reg-&gt;lcd_pallettebase
(braket
id|regno
)braket
op_assign
(paren
id|blue
op_amp
l_int|0x1f
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0x3f
)paren
op_lshift
l_int|5
)paren
op_or
(paren
(paren
id|red
op_amp
l_int|0x1f
)paren
op_lshift
l_int|11
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
id|i-&gt;fbcon_cmap16
(braket
id|regno
)braket
op_assign
(paren
(paren
id|red
op_amp
l_int|0xf800
)paren
op_rshift
l_int|0
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xfc00
)paren
op_rshift
l_int|5
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xf800
)paren
op_rshift
l_int|11
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1100_blank
r_static
r_int
id|au1100_blank
c_func
(paren
r_int
id|blank_mode
comma
r_struct
id|fb_info_gen
op_star
id|_info
)paren
(brace
r_switch
c_cond
(paren
id|blank_mode
)paren
(brace
r_case
id|VESA_NO_BLANKING
suffix:colon
multiline_comment|/* turn on panel */
singleline_comment|//printk(&quot;turn on panel&bslash;n&quot;);
macro_line|#ifdef CONFIG_MIPS_PB1100
id|p_lcd_reg-&gt;lcd_control
op_or_assign
id|LCD_CONTROL_GO
suffix:semicolon
id|au_writew
c_func
(paren
id|au_readw
c_func
(paren
id|PB1100_G_CONTROL
)paren
op_or
id|p_lcd-&gt;mode_backlight
comma
id|PB1100_G_CONTROL
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_MIPS_HYDROGEN3
multiline_comment|/*  Turn controller &amp; power supply on,  GPIO213 */
id|au_writel
c_func
(paren
l_int|0x20002000
comma
l_int|0xB1700008
)paren
suffix:semicolon
id|au_writel
c_func
(paren
l_int|0x00040000
comma
l_int|0xB1900108
)paren
suffix:semicolon
id|au_writel
c_func
(paren
l_int|0x01000100
comma
l_int|0xB1700008
)paren
suffix:semicolon
macro_line|#endif
id|au_sync
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VESA_VSYNC_SUSPEND
suffix:colon
r_case
id|VESA_HSYNC_SUSPEND
suffix:colon
r_case
id|VESA_POWERDOWN
suffix:colon
multiline_comment|/* turn off panel */
singleline_comment|//printk(&quot;turn off panel&bslash;n&quot;);
macro_line|#ifdef CONFIG_MIPS_PB1100
id|au_writew
c_func
(paren
id|au_readw
c_func
(paren
id|PB1100_G_CONTROL
)paren
op_amp
op_complement
id|p_lcd-&gt;mode_backlight
comma
id|PB1100_G_CONTROL
)paren
suffix:semicolon
id|p_lcd_reg-&gt;lcd_control
op_and_assign
op_complement
id|LCD_CONTROL_GO
suffix:semicolon
macro_line|#endif
id|au_sync
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1100_set_disp
r_static
r_void
id|au1100_set_disp
c_func
(paren
r_const
r_void
op_star
id|unused
comma
r_struct
id|display
op_star
id|disp
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
(brace
id|disp-&gt;screen_base
op_assign
(paren
r_char
op_star
)paren
id|fb_info.fb_virt_start
suffix:semicolon
r_switch
c_cond
(paren
id|disp-&gt;var.bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb8
suffix:semicolon
r_if
c_cond
(paren
id|fb_info.nohwcursor
)paren
id|fbcon_cfb8.cursor
op_assign
id|au1100_nocursor
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb16
suffix:semicolon
id|disp-&gt;dispsw_data
op_assign
id|fb_info.fbcon_cmap16
suffix:semicolon
r_if
c_cond
(paren
id|fb_info.nohwcursor
)paren
id|fbcon_cfb16.cursor
op_assign
id|au1100_nocursor
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
id|disp-&gt;dispsw_data
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|au1100fb_mmap
id|au1100fb_mmap
c_func
(paren
r_struct
id|fb_info
op_star
id|_fb
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_int
r_int
id|len
suffix:semicolon
r_int
r_int
id|start
op_assign
l_int|0
comma
id|off
suffix:semicolon
r_struct
id|au1100fb_info
op_star
id|fb
op_assign
(paren
r_struct
id|au1100fb_info
op_star
)paren
id|_fb
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_pgoff
OG
(paren
op_complement
l_int|0UL
op_rshift
id|PAGE_SHIFT
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|start
op_assign
id|fb_info.fb_phys
op_amp
id|PAGE_MASK
suffix:semicolon
id|len
op_assign
id|PAGE_ALIGN
c_func
(paren
(paren
id|start
op_amp
op_complement
id|PAGE_MASK
)paren
op_plus
id|fb_info.fb_size
)paren
suffix:semicolon
id|off
op_assign
id|vma-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
op_plus
id|off
)paren
OG
id|len
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|off
op_add_assign
id|start
suffix:semicolon
id|vma-&gt;vm_pgoff
op_assign
id|off
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|pgprot_val
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
op_and_assign
op_complement
id|_CACHE_MASK
suffix:semicolon
singleline_comment|//pgprot_val(vma-&gt;vm_page_prot) |= _CACHE_CACHABLE_NONCOHERENT;
id|pgprot_val
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
op_or_assign
(paren
l_int|6
op_lshift
l_int|9
)paren
suffix:semicolon
singleline_comment|//CCA=6
multiline_comment|/* This is an IO map - tell maydump to skip this VMA */
id|vma-&gt;vm_flags
op_or_assign
id|VM_IO
suffix:semicolon
r_if
c_cond
(paren
id|io_remap_pfn_range
c_func
(paren
id|vma
comma
id|vma-&gt;vm_start
comma
id|off
op_rshift
id|PAGE_SHIFT
comma
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_page_prot
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|fb-&gt;mmaped
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1100_pan_display
r_int
id|au1100_pan_display
c_func
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1100fb_ioctl
r_static
r_int
id|au1100fb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* nothing to do yet */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|au1100_switch
r_static
r_struct
id|fbgen_hwswitch
id|au1100_switch
op_assign
(brace
id|au1100_detect
comma
id|au1100_encode_fix
comma
id|au1100_decode_var
comma
id|au1100_encode_var
comma
id|au1100_get_par
comma
id|au1100_set_par
comma
id|au1100_getcolreg
comma
id|au1100_setcolreg
comma
id|au1100_pan_display
comma
id|au1100_blank
comma
id|au1100_set_disp
)brace
suffix:semicolon
DECL|function|au1100_setmode
r_int
id|au1100_setmode
c_func
(paren
r_void
)paren
(brace
r_int
id|words
suffix:semicolon
multiline_comment|/* FIXME Need to accomodate for swivel mode and 12bpp, &lt;8bpp*/
r_switch
c_cond
(paren
id|p_lcd-&gt;mode_control
op_amp
id|LCD_CONTROL_SM
)paren
(brace
r_case
id|LCD_CONTROL_SM_0
suffix:colon
r_case
id|LCD_CONTROL_SM_180
suffix:colon
id|words
op_assign
(paren
id|p_lcd-&gt;xres
op_star
id|p_lcd-&gt;yres
op_star
id|p_lcd-&gt;bpp
)paren
op_div
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCD_CONTROL_SM_90
suffix:colon
r_case
id|LCD_CONTROL_SM_270
suffix:colon
multiline_comment|/* is this correct? */
id|words
op_assign
(paren
id|p_lcd-&gt;xres
op_star
id|p_lcd-&gt;bpp
)paren
op_div
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;mode_control reg not initialized&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Setup LCD controller&n;&t; */
id|p_lcd_reg-&gt;lcd_control
op_assign
id|p_lcd-&gt;mode_control
suffix:semicolon
id|p_lcd_reg-&gt;lcd_intstatus
op_assign
l_int|0
suffix:semicolon
id|p_lcd_reg-&gt;lcd_intenable
op_assign
l_int|0
suffix:semicolon
id|p_lcd_reg-&gt;lcd_horztiming
op_assign
id|p_lcd-&gt;mode_horztiming
suffix:semicolon
id|p_lcd_reg-&gt;lcd_verttiming
op_assign
id|p_lcd-&gt;mode_verttiming
suffix:semicolon
id|p_lcd_reg-&gt;lcd_clkcontrol
op_assign
id|p_lcd-&gt;mode_clkcontrol
suffix:semicolon
id|p_lcd_reg-&gt;lcd_words
op_assign
id|words
op_minus
l_int|1
suffix:semicolon
id|p_lcd_reg-&gt;lcd_dmaaddr0
op_assign
id|fb_info.fb_phys
suffix:semicolon
multiline_comment|/* turn on panel */
macro_line|#ifdef CONFIG_MIPS_PB1100
id|au_writew
c_func
(paren
id|au_readw
c_func
(paren
id|PB1100_G_CONTROL
)paren
op_or
id|p_lcd-&gt;mode_backlight
comma
id|PB1100_G_CONTROL
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_MIPS_HYDROGEN3
multiline_comment|/*  Turn controller &amp; power supply on,  GPIO213 */
id|au_writel
c_func
(paren
l_int|0x20002000
comma
l_int|0xB1700008
)paren
suffix:semicolon
id|au_writel
c_func
(paren
l_int|0x00040000
comma
l_int|0xB1900108
)paren
suffix:semicolon
id|au_writel
c_func
(paren
l_int|0x01000100
comma
l_int|0xB1700008
)paren
suffix:semicolon
macro_line|#endif
id|p_lcd_reg-&gt;lcd_control
op_or_assign
id|LCD_CONTROL_GO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1100fb_init
r_int
id|__init
id|au1100fb_init
c_func
(paren
r_void
)paren
(brace
id|uint32
id|sys_clksrc
suffix:semicolon
r_int
r_int
id|page
suffix:semicolon
multiline_comment|/*&n;&t;* Get the panel information/display mode and update the registry&n;&t;*/
id|p_lcd
op_assign
op_amp
id|panels
(braket
id|my_lcd_index
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|p_lcd-&gt;mode_control
op_amp
id|LCD_CONTROL_SM
)paren
(brace
r_case
id|LCD_CONTROL_SM_0
suffix:colon
r_case
id|LCD_CONTROL_SM_180
suffix:colon
id|p_lcd-&gt;xres
op_assign
(paren
id|p_lcd-&gt;mode_horztiming
op_amp
id|LCD_HORZTIMING_PPL
)paren
op_plus
l_int|1
suffix:semicolon
id|p_lcd-&gt;yres
op_assign
(paren
id|p_lcd-&gt;mode_verttiming
op_amp
id|LCD_VERTTIMING_LPP
)paren
op_plus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCD_CONTROL_SM_90
suffix:colon
r_case
id|LCD_CONTROL_SM_270
suffix:colon
id|p_lcd-&gt;yres
op_assign
(paren
id|p_lcd-&gt;mode_horztiming
op_amp
id|LCD_HORZTIMING_PPL
)paren
op_plus
l_int|1
suffix:semicolon
id|p_lcd-&gt;xres
op_assign
(paren
id|p_lcd-&gt;mode_verttiming
op_amp
id|LCD_VERTTIMING_LPP
)paren
op_plus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Panel dimensions x bpp must be divisible by 32&n;&t; */
r_if
c_cond
(paren
(paren
(paren
id|p_lcd-&gt;yres
op_star
id|p_lcd-&gt;bpp
)paren
op_mod
l_int|32
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;VERT %% 32&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|p_lcd-&gt;xres
op_star
id|p_lcd-&gt;bpp
)paren
op_mod
l_int|32
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;HORZ %% 32&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate LCD framebuffer from system memory&n;&t; */
id|fb_info.fb_size
op_assign
(paren
id|p_lcd-&gt;xres
op_star
id|p_lcd-&gt;yres
op_star
id|p_lcd-&gt;bpp
)paren
op_div
l_int|8
suffix:semicolon
id|current_par.var.xres
op_assign
id|p_lcd-&gt;xres
suffix:semicolon
id|current_par.var.xres_virtual
op_assign
id|p_lcd-&gt;xres
suffix:semicolon
id|current_par.var.yres
op_assign
id|p_lcd-&gt;yres
suffix:semicolon
id|current_par.var.yres_virtual
op_assign
id|p_lcd-&gt;yres
suffix:semicolon
id|current_par.var.bits_per_pixel
op_assign
id|p_lcd-&gt;bpp
suffix:semicolon
multiline_comment|/* FIX!!! only works for 8/16 bpp */
id|current_par.line_length
op_assign
id|p_lcd-&gt;xres
op_star
id|p_lcd-&gt;bpp
op_div
l_int|8
suffix:semicolon
multiline_comment|/* in bytes */
id|fb_info.fb_virt_start
op_assign
(paren
r_int
r_int
)paren
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
op_or
id|GFP_DMA
comma
id|get_order
c_func
(paren
id|fb_info.fb_size
op_plus
l_int|0x1000
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_info.fb_virt_start
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to allocate fb memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|fb_info.fb_phys
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|fb_info.fb_virt_start
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set page reserved so that mmap will work. This is necessary&n;&t; * since we&squot;ll be remapping normal memory.&n;&t; */
r_for
c_loop
(paren
id|page
op_assign
id|fb_info.fb_virt_start
suffix:semicolon
id|page
OL
id|PAGE_ALIGN
c_func
(paren
id|fb_info.fb_virt_start
op_plus
id|fb_info.fb_size
)paren
suffix:semicolon
id|page
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|SetPageReserved
c_func
(paren
id|virt_to_page
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|fb_info.fb_virt_start
comma
l_int|0
comma
id|fb_info.fb_size
)paren
suffix:semicolon
multiline_comment|/* set freqctrl now to allow more time to stabilize */
multiline_comment|/* zero-out out LCD bits */
id|sys_clksrc
op_assign
id|au_readl
c_func
(paren
id|SYS_CLKSRC
)paren
op_amp
op_complement
l_int|0x000003e0
suffix:semicolon
id|sys_clksrc
op_or_assign
id|p_lcd-&gt;mode_toyclksrc
suffix:semicolon
id|au_writel
c_func
(paren
id|sys_clksrc
comma
id|SYS_CLKSRC
)paren
suffix:semicolon
multiline_comment|/* FIXME add check to make sure auxpll is what is expected! */
id|au1100_setmode
c_func
(paren
)paren
suffix:semicolon
id|fb_info.gen.parsize
op_assign
r_sizeof
(paren
r_struct
id|au1100fb_par
)paren
suffix:semicolon
id|fb_info.gen.fbhw
op_assign
op_amp
id|au1100_switch
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.gen.info.modename
comma
l_string|&quot;Au1100 LCD&quot;
)paren
suffix:semicolon
id|fb_info.gen.info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|fb_info.gen.info.node
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.gen.info.fbops
op_assign
op_amp
id|au1100fb_ops
suffix:semicolon
id|fb_info.gen.info.disp
op_assign
op_amp
id|disp
suffix:semicolon
id|fb_info.gen.info.switch_con
op_assign
op_amp
id|fbgen_switch
suffix:semicolon
id|fb_info.gen.info.updatevar
op_assign
op_amp
id|fbgen_update_var
suffix:semicolon
id|fb_info.gen.info.blank
op_assign
op_amp
id|fbgen_blank
suffix:semicolon
id|fb_info.gen.info.flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
multiline_comment|/* This should give a reasonable default video mode */
id|fbgen_get_var
c_func
(paren
op_amp
id|disp.var
comma
op_minus
l_int|1
comma
op_amp
id|fb_info.gen.info
)paren
suffix:semicolon
id|fbgen_do_set_var
c_func
(paren
op_amp
id|disp.var
comma
l_int|1
comma
op_amp
id|fb_info.gen
)paren
suffix:semicolon
id|fbgen_set_disp
c_func
(paren
op_minus
l_int|1
comma
op_amp
id|fb_info.gen
)paren
suffix:semicolon
id|fbgen_install_cmap
c_func
(paren
l_int|0
comma
op_amp
id|fb_info.gen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info.gen.info
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fb%d: %s frame buffer device&bslash;n&quot;
comma
id|GET_FB_IDX
c_func
(paren
id|fb_info.gen.info.node
)paren
comma
id|fb_info.gen.info.modename
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|au1100fb_cleanup
r_void
id|au1100fb_cleanup
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|unregister_framebuffer
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
DECL|function|au1100fb_setup
r_void
id|au1100fb_setup
c_func
(paren
r_char
op_star
id|options
comma
r_int
op_star
id|ints
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|num_panels
op_assign
r_sizeof
(paren
id|panels
)paren
op_div
r_sizeof
(paren
r_struct
id|known_lcd_panels
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|this_opt
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_opt
suffix:semicolon
id|this_opt
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;panel:&quot;
comma
l_int|6
)paren
)paren
(brace
macro_line|#if defined(CONFIG_MIPS_PB1100) || defined(CONFIG_MIPS_DB1100)
multiline_comment|/* Read Pb1100 Switch S10 ? */
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_string|&quot;s10&quot;
comma
l_int|3
)paren
)paren
(brace
r_int
id|panel
suffix:semicolon
id|panel
op_assign
op_star
(paren
r_volatile
r_int
op_star
)paren
l_int|0xAE000008
suffix:semicolon
multiline_comment|/* BCSR SWITCHES */
id|panel
op_rshift_assign
l_int|8
suffix:semicolon
id|panel
op_and_assign
l_int|0x0F
suffix:semicolon
r_if
c_cond
(paren
id|panel
op_ge
id|num_panels
)paren
id|panel
op_assign
l_int|0
suffix:semicolon
id|my_lcd_index
op_assign
id|panel
suffix:semicolon
)brace
r_else
macro_line|#endif
multiline_comment|/* Get the panel name, everything else if fixed */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_panels
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
id|panels
(braket
id|i
)braket
dot
id|panel_name
comma
id|strlen
c_func
(paren
id|this_opt
)paren
)paren
)paren
(brace
id|my_lcd_index
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;nohwcursor&quot;
comma
l_int|10
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nohwcursor&bslash;n&quot;
)paren
suffix:semicolon
id|fb_info.nohwcursor
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;au1100fb: Panel %d %s&bslash;n&quot;
comma
id|my_lcd_index
comma
id|panels
(braket
id|my_lcd_index
)braket
dot
id|panel_name
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|au1100fb_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|au1100fb_cleanup
c_func
(paren
r_void
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Pete Popov &lt;ppopov@mvista.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Au1100 LCD framebuffer device driver&quot;
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
eof
