multiline_comment|/*&n; *  linux/drivers/video/pxafb.c&n; *&n; *  Copyright (C) 1999 Eric A. Thomas.&n; *  Copyright (C) 2004 Jean-Frederic Clere.&n; *  Copyright (C) 2004 Ian Campbell.&n; *  Copyright (C) 2004 Jeff Lackey.&n; *   Based on sa1100fb.c Copyright (C) 1999 Eric A. Thomas&n; *  which in turn is&n; *   Based on acornfb.c Copyright (C) Russell King.&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive for&n; * more details.&n; *&n; *&t;        Intel PXA250/210 LCD Controller Frame Buffer Driver&n; *&n; * Please direct your questions and comments on this driver to the following&n; * email address:&n; *&n; *&t;linux-arm-kernel@lists.arm.linux.org.uk&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/cpufreq.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/arch/pxa-regs.h&gt;
macro_line|#include &lt;asm/arch/bitfield.h&gt;
macro_line|#include &lt;asm/arch/pxafb.h&gt;
multiline_comment|/*&n; * Complain if VAR is out of range.&n; */
DECL|macro|DEBUG_VAR
mdefine_line|#define DEBUG_VAR 1
macro_line|#include &quot;pxafb.h&quot;
multiline_comment|/* Bits which should not be set in machine configuration structures */
DECL|macro|LCCR0_INVALID_CONFIG_MASK
mdefine_line|#define LCCR0_INVALID_CONFIG_MASK (LCCR0_OUM|LCCR0_BM|LCCR0_QDM|LCCR0_DIS|LCCR0_EFM|LCCR0_IUM|LCCR0_SFM|LCCR0_LDM|LCCR0_ENB)
DECL|macro|LCCR3_INVALID_CONFIG_MASK
mdefine_line|#define LCCR3_INVALID_CONFIG_MASK (LCCR3_HSP|LCCR3_VSP|LCCR3_PCD|LCCR3_BPP)
DECL|variable|pxafb_backlight_power
r_static
r_void
(paren
op_star
id|pxafb_backlight_power
)paren
(paren
r_int
)paren
suffix:semicolon
DECL|variable|pxafb_lcd_power
r_static
r_void
(paren
op_star
id|pxafb_lcd_power
)paren
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|pxafb_activate_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|pxafb_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|set_ctrlr_state
c_func
(paren
r_struct
id|pxafb_info
op_star
id|fbi
comma
id|u_int
id|state
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB_PXA_PARAMETERS
DECL|macro|PXAFB_OPTIONS_SIZE
mdefine_line|#define PXAFB_OPTIONS_SIZE 256
DECL|variable|__initdata
r_static
r_char
id|g_options
(braket
id|PXAFB_OPTIONS_SIZE
)braket
id|__initdata
op_assign
l_string|&quot;&quot;
suffix:semicolon
macro_line|#endif
DECL|function|pxafb_schedule_work
r_static
r_inline
r_void
id|pxafb_schedule_work
c_func
(paren
r_struct
id|pxafb_info
op_star
id|fbi
comma
id|u_int
id|state
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We need to handle two requests being made at the same time.&n;&t; * There are two important cases:&n;&t; *  1. When we are changing VT (C_REENABLE) while unblanking (C_ENABLE)&n;&t; *     We must perform the unblanking, which will do our REENABLE for us.&n;&t; *  2. When we are blanking, but immediately unblank before we have&n;&t; *     blanked.  We do the &quot;REENABLE&quot; thing here as well, just to be sure.&n;&t; */
r_if
c_cond
(paren
id|fbi-&gt;task_state
op_eq
id|C_ENABLE
op_logical_and
id|state
op_eq
id|C_REENABLE
)paren
id|state
op_assign
(paren
id|u_int
)paren
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fbi-&gt;task_state
op_eq
id|C_DISABLE
op_logical_and
id|state
op_eq
id|C_ENABLE
)paren
id|state
op_assign
id|C_REENABLE
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ne
(paren
id|u_int
)paren
op_minus
l_int|1
)paren
(brace
id|fbi-&gt;task_state
op_assign
id|state
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|fbi-&gt;task
)paren
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|chan_to_field
r_static
r_inline
id|u_int
id|chan_to_field
c_func
(paren
id|u_int
id|chan
comma
r_struct
id|fb_bitfield
op_star
id|bf
)paren
(brace
id|chan
op_and_assign
l_int|0xffff
suffix:semicolon
id|chan
op_rshift_assign
l_int|16
op_minus
id|bf-&gt;length
suffix:semicolon
r_return
id|chan
op_lshift
id|bf-&gt;offset
suffix:semicolon
)brace
r_static
r_int
DECL|function|pxafb_setpalettereg
id|pxafb_setpalettereg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|trans
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
(paren
r_struct
id|pxafb_info
op_star
)paren
id|info
suffix:semicolon
id|u_int
id|val
comma
id|ret
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|regno
OL
id|fbi-&gt;palette_size
)paren
(brace
r_if
c_cond
(paren
id|fbi-&gt;fb.var.grayscale
)paren
(brace
id|val
op_assign
(paren
(paren
id|blue
op_rshift
l_int|8
)paren
op_amp
l_int|0x00ff
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
(paren
(paren
id|red
op_rshift
l_int|0
)paren
op_amp
l_int|0xf800
)paren
suffix:semicolon
id|val
op_or_assign
(paren
(paren
id|green
op_rshift
l_int|5
)paren
op_amp
l_int|0x07e0
)paren
suffix:semicolon
id|val
op_or_assign
(paren
(paren
id|blue
op_rshift
l_int|11
)paren
op_amp
l_int|0x001f
)paren
suffix:semicolon
)brace
id|fbi-&gt;palette_cpu
(braket
id|regno
)braket
op_assign
id|val
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|pxafb_setcolreg
id|pxafb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|trans
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
(paren
r_struct
id|pxafb_info
op_star
)paren
id|info
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
r_int
id|ret
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * If inverse mode was selected, invert all the colours&n;&t; * rather than the register number.  The register number&n;&t; * is what you poke into the framebuffer to produce the&n;&t; * colour you requested.&n;&t; */
r_if
c_cond
(paren
id|fbi-&gt;cmap_inverse
)paren
(brace
id|red
op_assign
l_int|0xffff
op_minus
id|red
suffix:semicolon
id|green
op_assign
l_int|0xffff
op_minus
id|green
suffix:semicolon
id|blue
op_assign
l_int|0xffff
op_minus
id|blue
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If greyscale is true, then we convert the RGB value&n;&t; * to greyscale no matter what visual we are using.&n;&t; */
r_if
c_cond
(paren
id|fbi-&gt;fb.var.grayscale
)paren
id|red
op_assign
id|green
op_assign
id|blue
op_assign
(paren
l_int|19595
op_star
id|red
op_plus
l_int|38470
op_star
id|green
op_plus
l_int|7471
op_star
id|blue
)paren
op_rshift
l_int|16
suffix:semicolon
r_switch
c_cond
(paren
id|fbi-&gt;fb.fix.visual
)paren
(brace
r_case
id|FB_VISUAL_TRUECOLOR
suffix:colon
multiline_comment|/*&n;&t;&t; * 16-bit True Colour.  We encode the RGB value&n;&t;&t; * according to the RGB bitfield information.&n;&t;&t; */
r_if
c_cond
(paren
id|regno
OL
l_int|16
)paren
(brace
id|u32
op_star
id|pal
op_assign
id|fbi-&gt;fb.pseudo_palette
suffix:semicolon
id|val
op_assign
id|chan_to_field
c_func
(paren
id|red
comma
op_amp
id|fbi-&gt;fb.var.red
)paren
suffix:semicolon
id|val
op_or_assign
id|chan_to_field
c_func
(paren
id|green
comma
op_amp
id|fbi-&gt;fb.var.green
)paren
suffix:semicolon
id|val
op_or_assign
id|chan_to_field
c_func
(paren
id|blue
comma
op_amp
id|fbi-&gt;fb.var.blue
)paren
suffix:semicolon
id|pal
(braket
id|regno
)braket
op_assign
id|val
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FB_VISUAL_STATIC_PSEUDOCOLOR
suffix:colon
r_case
id|FB_VISUAL_PSEUDOCOLOR
suffix:colon
id|ret
op_assign
id|pxafb_setpalettereg
c_func
(paren
id|regno
comma
id|red
comma
id|green
comma
id|blue
comma
id|trans
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *  pxafb_bpp_to_lccr3():&n; *    Convert a bits per pixel value to the correct bit pattern for LCCR3&n; */
DECL|function|pxafb_bpp_to_lccr3
r_static
r_int
id|pxafb_bpp_to_lccr3
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|ret
op_assign
id|LCCR3_1BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|ret
op_assign
id|LCCR3_2BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|ret
op_assign
id|LCCR3_4BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|ret
op_assign
id|LCCR3_8BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|ret
op_assign
id|LCCR3_16BPP
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CPU_FREQ
multiline_comment|/*&n; *  pxafb_display_dma_period()&n; *    Calculate the minimum period (in picoseconds) between two DMA&n; *    requests for the LCD controller.  If we hit this, it means we&squot;re&n; *    doing nothing but LCD DMA.&n; */
DECL|function|pxafb_display_dma_period
r_static
r_int
r_int
id|pxafb_display_dma_period
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
multiline_comment|/*&n;        * Period = pixclock * bits_per_byte * bytes_per_transfer&n;        *              / memory_bits_per_pixel;&n;        */
r_return
id|var-&gt;pixclock
op_star
l_int|8
op_star
l_int|16
op_div
id|var-&gt;bits_per_pixel
suffix:semicolon
)brace
r_extern
r_int
r_int
id|get_clk_frequency_khz
c_func
(paren
r_int
id|info
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *  pxafb_check_var():&n; *    Get the video params out of &squot;var&squot;. If a value doesn&squot;t fit, round it up,&n; *    if it&squot;s too big, return -EINVAL.&n; *&n; *    Round up in the following order: bits_per_pixel, xres,&n; *    yres, xres_virtual, yres_virtual, xoffset, yoffset, grayscale,&n; *    bitfields, horizontal timing, vertical timing.&n; */
DECL|function|pxafb_check_var
r_static
r_int
id|pxafb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
(paren
r_struct
id|pxafb_info
op_star
)paren
id|info
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xres
OL
id|MIN_XRES
)paren
id|var-&gt;xres
op_assign
id|MIN_XRES
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres
OL
id|MIN_YRES
)paren
id|var-&gt;yres
op_assign
id|MIN_YRES
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xres
OG
id|fbi-&gt;max_xres
)paren
id|var-&gt;xres
op_assign
id|fbi-&gt;max_xres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres
OG
id|fbi-&gt;max_yres
)paren
id|var-&gt;yres
op_assign
id|fbi-&gt;max_yres
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|max
c_func
(paren
id|var-&gt;xres_virtual
comma
id|var-&gt;xres
)paren
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|max
c_func
(paren
id|var-&gt;yres_virtual
comma
id|var-&gt;yres
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setup the RGB parameters for this display.&n;&t; *&n;&t; * The pixel packing format is described on page 7-11 of the&n;&t; * PXA2XX Developer&squot;s Manual.&n;         */
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|16
)paren
(brace
id|var-&gt;red.offset
op_assign
l_int|11
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;transp.offset
op_assign
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|var-&gt;red.offset
op_assign
id|var-&gt;green.offset
op_assign
id|var-&gt;blue.offset
op_assign
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CPU_FREQ
id|DPRINTK
c_func
(paren
l_string|&quot;dma period = %d ps, clock = %d kHz&bslash;n&quot;
comma
id|pxafb_display_dma_period
c_func
(paren
id|var
)paren
comma
id|get_clk_frequency_khz
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pxafb_set_truecolor
r_static
r_inline
r_void
id|pxafb_set_truecolor
c_func
(paren
id|u_int
id|is_true_color
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;true_color = %d&bslash;n&quot;
comma
id|is_true_color
)paren
suffix:semicolon
singleline_comment|// do your machine-specific setup if needed
)brace
multiline_comment|/*&n; * pxafb_set_par():&n; *&t;Set the user defined part of the display for the specified console&n; */
DECL|function|pxafb_set_par
r_static
r_int
id|pxafb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
(paren
r_struct
id|pxafb_info
op_star
)paren
id|info
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|info-&gt;var
suffix:semicolon
r_int
r_int
id|palette_mem_size
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;set_par&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|16
)paren
id|fbi-&gt;fb.fix.visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|fbi-&gt;cmap_static
)paren
id|fbi-&gt;fb.fix.visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
r_else
(brace
multiline_comment|/*&n;&t;&t; * Some people have weird ideas about wanting static&n;&t;&t; * pseudocolor maps.  I suspect their user space&n;&t;&t; * applications are broken.&n;&t;&t; */
id|fbi-&gt;fb.fix.visual
op_assign
id|FB_VISUAL_STATIC_PSEUDOCOLOR
suffix:semicolon
)brace
id|fbi-&gt;fb.fix.line_length
op_assign
id|var-&gt;xres_virtual
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|16
)paren
id|fbi-&gt;palette_size
op_assign
l_int|0
suffix:semicolon
r_else
id|fbi-&gt;palette_size
op_assign
id|var-&gt;bits_per_pixel
op_eq
l_int|1
ques
c_cond
l_int|4
suffix:colon
l_int|1
op_lshift
id|var-&gt;bits_per_pixel
suffix:semicolon
id|palette_mem_size
op_assign
id|fbi-&gt;palette_size
op_star
r_sizeof
(paren
id|u16
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;palette_mem_size = 0x%08lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|palette_mem_size
)paren
suffix:semicolon
id|fbi-&gt;palette_cpu
op_assign
(paren
id|u16
op_star
)paren
(paren
id|fbi-&gt;map_cpu
op_plus
id|PAGE_SIZE
op_minus
id|palette_mem_size
)paren
suffix:semicolon
id|fbi-&gt;palette_dma
op_assign
id|fbi-&gt;map_dma
op_plus
id|PAGE_SIZE
op_minus
id|palette_mem_size
suffix:semicolon
multiline_comment|/*&n;&t; * Set (any) board control register to handle new color depth&n;&t; */
id|pxafb_set_truecolor
c_func
(paren
id|fbi-&gt;fb.fix.visual
op_eq
id|FB_VISUAL_TRUECOLOR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fbi-&gt;fb.var.bits_per_pixel
op_eq
l_int|16
)paren
id|fb_dealloc_cmap
c_func
(paren
op_amp
id|fbi-&gt;fb.cmap
)paren
suffix:semicolon
r_else
id|fb_alloc_cmap
c_func
(paren
op_amp
id|fbi-&gt;fb.cmap
comma
l_int|1
op_lshift
id|fbi-&gt;fb.var.bits_per_pixel
comma
l_int|0
)paren
suffix:semicolon
id|pxafb_activate_var
c_func
(paren
id|var
comma
id|fbi
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Formal definition of the VESA spec:&n; *  On&n; *  &t;This refers to the state of the display when it is in full operation&n; *  Stand-By&n; *  &t;This defines an optional operating state of minimal power reduction with&n; *  &t;the shortest recovery time&n; *  Suspend&n; *  &t;This refers to a level of power management in which substantial power&n; *  &t;reduction is achieved by the display.  The display can have a longer&n; *  &t;recovery time from this state than from the Stand-by state&n; *  Off&n; *  &t;This indicates that the display is consuming the lowest level of power&n; *  &t;and is non-operational. Recovery from this state may optionally require&n; *  &t;the user to manually power on the monitor&n; *&n; *  Now, the fbdev driver adds an additional state, (blank), where they&n; *  turn off the video (maybe by colormap tricks), but don&squot;t mess with the&n; *  video itself: think of it semantically between on and Stand-By.&n; *&n; *  So here&squot;s what we should do in our fbdev blank routine:&n; *&n; *  &t;VESA_NO_BLANKING (mode 0)&t;Video on,  front/back light on&n; *  &t;VESA_VSYNC_SUSPEND (mode 1)  &t;Video on,  front/back light off&n; *  &t;VESA_HSYNC_SUSPEND (mode 2)  &t;Video on,  front/back light off&n; *  &t;VESA_POWERDOWN (mode 3)&t;&t;Video off, front/back light off&n; *&n; *  This will match the matrox implementation.&n; */
multiline_comment|/*&n; * pxafb_blank():&n; *&t;Blank the display by setting all palette values to zero.  Note, the&n; * &t;16 bpp mode does not really use the palette, so this will not&n; *      blank the display in all modes.&n; */
DECL|function|pxafb_blank
r_static
r_int
id|pxafb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
(paren
r_struct
id|pxafb_info
op_star
)paren
id|info
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;pxafb_blank: blank=%d&bslash;n&quot;
comma
id|blank
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|blank
)paren
(brace
r_case
id|FB_BLANK_POWERDOWN
suffix:colon
r_case
id|FB_BLANK_VSYNC_SUSPEND
suffix:colon
r_case
id|FB_BLANK_HSYNC_SUSPEND
suffix:colon
r_case
id|FB_BLANK_NORMAL
suffix:colon
r_if
c_cond
(paren
id|fbi-&gt;fb.fix.visual
op_eq
id|FB_VISUAL_PSEUDOCOLOR
op_logical_or
id|fbi-&gt;fb.fix.visual
op_eq
id|FB_VISUAL_STATIC_PSEUDOCOLOR
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fbi-&gt;palette_size
suffix:semicolon
id|i
op_increment
)paren
id|pxafb_setpalettereg
c_func
(paren
id|i
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|info
)paren
suffix:semicolon
id|pxafb_schedule_work
c_func
(paren
id|fbi
comma
id|C_DISABLE
)paren
suffix:semicolon
singleline_comment|//TODO if (pxafb_blank_helper) pxafb_blank_helper(blank);
r_break
suffix:semicolon
r_case
id|FB_BLANK_UNBLANK
suffix:colon
singleline_comment|//TODO if (pxafb_blank_helper) pxafb_blank_helper(blank);
r_if
c_cond
(paren
id|fbi-&gt;fb.fix.visual
op_eq
id|FB_VISUAL_PSEUDOCOLOR
op_logical_or
id|fbi-&gt;fb.fix.visual
op_eq
id|FB_VISUAL_STATIC_PSEUDOCOLOR
)paren
id|fb_set_cmap
c_func
(paren
op_amp
id|fbi-&gt;fb.cmap
comma
id|info
)paren
suffix:semicolon
id|pxafb_schedule_work
c_func
(paren
id|fbi
comma
id|C_ENABLE
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pxafb_mmap
r_static
r_int
id|pxafb_mmap
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
(paren
r_struct
id|pxafb_info
op_star
)paren
id|info
suffix:semicolon
r_int
r_int
id|off
op_assign
id|vma-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|off
OL
id|info-&gt;fix.smem_len
)paren
(brace
id|vma-&gt;vm_pgoff
op_add_assign
l_int|1
suffix:semicolon
r_return
id|dma_mmap_writecombine
c_func
(paren
id|fbi-&gt;dev
comma
id|vma
comma
id|fbi-&gt;map_cpu
comma
id|fbi-&gt;map_dma
comma
id|fbi-&gt;map_size
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|pxafb_ops
r_static
r_struct
id|fb_ops
id|pxafb_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|fb_check_var
op_assign
id|pxafb_check_var
comma
dot
id|fb_set_par
op_assign
id|pxafb_set_par
comma
dot
id|fb_setcolreg
op_assign
id|pxafb_setcolreg
comma
dot
id|fb_fillrect
op_assign
id|cfb_fillrect
comma
dot
id|fb_copyarea
op_assign
id|cfb_copyarea
comma
dot
id|fb_imageblit
op_assign
id|cfb_imageblit
comma
dot
id|fb_blank
op_assign
id|pxafb_blank
comma
dot
id|fb_cursor
op_assign
id|soft_cursor
comma
dot
id|fb_mmap
op_assign
id|pxafb_mmap
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Calculate the PCD value from the clock rate (in picoseconds).&n; * We take account of the PPCR clock setting.&n; * From PXA Developer&squot;s Manual:&n; *&n; *   PixelClock =      LCLK&n; *                -------------&n; *                2 ( PCD + 1 )&n; *&n; *   PCD =      LCLK&n; *         ------------- - 1&n; *         2(PixelClock)&n; *&n; * Where:&n; *   LCLK = LCD/Memory Clock&n; *   PCD = LCCR3[7:0]&n; *&n; * PixelClock here is in Hz while the pixclock argument given is the&n; * period in picoseconds. Hence PixelClock = 1 / ( pixclock * 10^-12 )&n; *&n; * The function get_lclk_frequency_10khz returns LCLK in units of&n; * 10khz. Calling the result of this function lclk gives us the&n; * following&n; *&n; *    PCD = (lclk * 10^4 ) * ( pixclock * 10^-12 )&n; *          -------------------------------------- - 1&n; *                          2&n; *&n; * Factoring the 10^4 and 10^-12 out gives 10^-8 == 1 / 100000000 as used below.&n; */
DECL|function|get_pcd
r_static
r_inline
r_int
r_int
id|get_pcd
c_func
(paren
r_int
r_int
id|pixclock
)paren
(brace
r_int
r_int
r_int
id|pcd
suffix:semicolon
multiline_comment|/* FIXME: Need to take into account Double Pixel Clock mode&n;         * (DPC) bit? or perhaps set it based on the various clock&n;         * speeds */
id|pcd
op_assign
(paren
r_int
r_int
r_int
)paren
id|get_lcdclk_frequency_10khz
c_func
(paren
)paren
op_star
id|pixclock
suffix:semicolon
id|pcd
op_div_assign
l_int|100000000
op_star
l_int|2
suffix:semicolon
multiline_comment|/* no need for this, since we should subtract 1 anyway. they cancel */
multiline_comment|/* pcd += 1; */
multiline_comment|/* make up for integer math truncations */
r_return
(paren
r_int
r_int
)paren
id|pcd
suffix:semicolon
)brace
multiline_comment|/*&n; * pxafb_activate_var():&n; *&t;Configures LCD Controller based on entries in var parameter.  Settings are&n; *&t;only written to the controller if changes were made.&n; */
DECL|function|pxafb_activate_var
r_static
r_int
id|pxafb_activate_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|pxafb_info
op_star
id|fbi
)paren
(brace
r_struct
id|pxafb_lcd_reg
id|new_regs
suffix:semicolon
id|u_long
id|flags
suffix:semicolon
id|u_int
id|lines_per_panel
comma
id|pcd
op_assign
id|get_pcd
c_func
(paren
id|var-&gt;pixclock
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring PXA LCD&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;var: xres=%d hslen=%d lm=%d rm=%d&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;hsync_len
comma
id|var-&gt;left_margin
comma
id|var-&gt;right_margin
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;var: yres=%d vslen=%d um=%d bm=%d&bslash;n&quot;
comma
id|var-&gt;yres
comma
id|var-&gt;vsync_len
comma
id|var-&gt;upper_margin
comma
id|var-&gt;lower_margin
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;var: pixclock=%d pcd=%d&bslash;n&quot;
comma
id|var-&gt;pixclock
comma
id|pcd
)paren
suffix:semicolon
macro_line|#if DEBUG_VAR
r_if
c_cond
(paren
id|var-&gt;xres
template_param
l_int|1024
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid xres %d&bslash;n&quot;
comma
id|fbi-&gt;fb.fix.id
comma
id|var-&gt;xres
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
r_case
l_int|2
suffix:colon
r_case
l_int|4
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|16
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid bit depth %d&bslash;n&quot;
comma
id|fbi-&gt;fb.fix.id
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|var-&gt;hsync_len
template_param
l_int|64
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid hsync_len %d&bslash;n&quot;
comma
id|fbi-&gt;fb.fix.id
comma
id|var-&gt;hsync_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;left_margin
template_param
l_int|255
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid left_margin %d&bslash;n&quot;
comma
id|fbi-&gt;fb.fix.id
comma
id|var-&gt;left_margin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;right_margin
template_param
l_int|255
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid right_margin %d&bslash;n&quot;
comma
id|fbi-&gt;fb.fix.id
comma
id|var-&gt;right_margin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres
template_param
l_int|1024
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid yres %d&bslash;n&quot;
comma
id|fbi-&gt;fb.fix.id
comma
id|var-&gt;yres
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vsync_len
template_param
l_int|64
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid vsync_len %d&bslash;n&quot;
comma
id|fbi-&gt;fb.fix.id
comma
id|var-&gt;vsync_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;upper_margin
template_param
l_int|255
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid upper_margin %d&bslash;n&quot;
comma
id|fbi-&gt;fb.fix.id
comma
id|var-&gt;upper_margin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;lower_margin
template_param
l_int|255
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid lower_margin %d&bslash;n&quot;
comma
id|fbi-&gt;fb.fix.id
comma
id|var-&gt;lower_margin
)paren
suffix:semicolon
macro_line|#endif
id|new_regs.lccr0
op_assign
id|fbi-&gt;lccr0
op_or
(paren
id|LCCR0_LDM
op_or
id|LCCR0_SFM
op_or
id|LCCR0_IUM
op_or
id|LCCR0_EFM
op_or
id|LCCR0_QDM
op_or
id|LCCR0_BM
op_or
id|LCCR0_OUM
)paren
suffix:semicolon
id|new_regs.lccr1
op_assign
id|LCCR1_DisWdth
c_func
(paren
id|var-&gt;xres
)paren
op_plus
id|LCCR1_HorSnchWdth
c_func
(paren
id|var-&gt;hsync_len
)paren
op_plus
id|LCCR1_BegLnDel
c_func
(paren
id|var-&gt;left_margin
)paren
op_plus
id|LCCR1_EndLnDel
c_func
(paren
id|var-&gt;right_margin
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we have a dual scan LCD, we need to halve&n;&t; * the YRES parameter.&n;&t; */
id|lines_per_panel
op_assign
id|var-&gt;yres
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fbi-&gt;lccr0
op_amp
id|LCCR0_SDS
)paren
op_eq
id|LCCR0_Dual
)paren
id|lines_per_panel
op_div_assign
l_int|2
suffix:semicolon
id|new_regs.lccr2
op_assign
id|LCCR2_DisHght
c_func
(paren
id|lines_per_panel
)paren
op_plus
id|LCCR2_VrtSnchWdth
c_func
(paren
id|var-&gt;vsync_len
)paren
op_plus
id|LCCR2_BegFrmDel
c_func
(paren
id|var-&gt;upper_margin
)paren
op_plus
id|LCCR2_EndFrmDel
c_func
(paren
id|var-&gt;lower_margin
)paren
suffix:semicolon
id|new_regs.lccr3
op_assign
id|fbi-&gt;lccr3
op_or
id|pxafb_bpp_to_lccr3
c_func
(paren
id|var
)paren
op_or
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
ques
c_cond
id|LCCR3_HorSnchH
suffix:colon
id|LCCR3_HorSnchL
)paren
op_or
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
ques
c_cond
id|LCCR3_VrtSnchH
suffix:colon
id|LCCR3_VrtSnchL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcd
)paren
id|new_regs.lccr3
op_or_assign
id|LCCR3_PixClkDiv
c_func
(paren
id|pcd
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;nlccr0 = 0x%08x&bslash;n&quot;
comma
id|new_regs.lccr0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;nlccr1 = 0x%08x&bslash;n&quot;
comma
id|new_regs.lccr1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;nlccr2 = 0x%08x&bslash;n&quot;
comma
id|new_regs.lccr2
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;nlccr3 = 0x%08x&bslash;n&quot;
comma
id|new_regs.lccr3
)paren
suffix:semicolon
multiline_comment|/* Update shadow copy atomically */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* setup dma descriptors */
id|fbi-&gt;dmadesc_fblow_cpu
op_assign
(paren
r_struct
id|pxafb_dma_descriptor
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|fbi-&gt;palette_cpu
op_minus
l_int|3
op_star
l_int|16
)paren
suffix:semicolon
id|fbi-&gt;dmadesc_fbhigh_cpu
op_assign
(paren
r_struct
id|pxafb_dma_descriptor
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|fbi-&gt;palette_cpu
op_minus
l_int|2
op_star
l_int|16
)paren
suffix:semicolon
id|fbi-&gt;dmadesc_palette_cpu
op_assign
(paren
r_struct
id|pxafb_dma_descriptor
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|fbi-&gt;palette_cpu
op_minus
l_int|1
op_star
l_int|16
)paren
suffix:semicolon
id|fbi-&gt;dmadesc_fblow_dma
op_assign
id|fbi-&gt;palette_dma
op_minus
l_int|3
op_star
l_int|16
suffix:semicolon
id|fbi-&gt;dmadesc_fbhigh_dma
op_assign
id|fbi-&gt;palette_dma
op_minus
l_int|2
op_star
l_int|16
suffix:semicolon
id|fbi-&gt;dmadesc_palette_dma
op_assign
id|fbi-&gt;palette_dma
op_minus
l_int|1
op_star
l_int|16
suffix:semicolon
DECL|macro|BYTES_PER_PANEL
mdefine_line|#define BYTES_PER_PANEL (lines_per_panel * fbi-&gt;fb.fix.line_length)
multiline_comment|/* populate descriptors */
id|fbi-&gt;dmadesc_fblow_cpu-&gt;fdadr
op_assign
id|fbi-&gt;dmadesc_fblow_dma
suffix:semicolon
id|fbi-&gt;dmadesc_fblow_cpu-&gt;fsadr
op_assign
id|fbi-&gt;screen_dma
op_plus
id|BYTES_PER_PANEL
suffix:semicolon
id|fbi-&gt;dmadesc_fblow_cpu-&gt;fidr
op_assign
l_int|0
suffix:semicolon
id|fbi-&gt;dmadesc_fblow_cpu-&gt;ldcmd
op_assign
id|BYTES_PER_PANEL
suffix:semicolon
id|fbi-&gt;fdadr1
op_assign
id|fbi-&gt;dmadesc_fblow_dma
suffix:semicolon
multiline_comment|/* only used in dual-panel mode */
id|fbi-&gt;dmadesc_fbhigh_cpu-&gt;fsadr
op_assign
id|fbi-&gt;screen_dma
suffix:semicolon
id|fbi-&gt;dmadesc_fbhigh_cpu-&gt;fidr
op_assign
l_int|0
suffix:semicolon
id|fbi-&gt;dmadesc_fbhigh_cpu-&gt;ldcmd
op_assign
id|BYTES_PER_PANEL
suffix:semicolon
id|fbi-&gt;dmadesc_palette_cpu-&gt;fsadr
op_assign
id|fbi-&gt;palette_dma
suffix:semicolon
id|fbi-&gt;dmadesc_palette_cpu-&gt;fidr
op_assign
l_int|0
suffix:semicolon
id|fbi-&gt;dmadesc_palette_cpu-&gt;ldcmd
op_assign
(paren
id|fbi-&gt;palette_size
op_star
l_int|2
)paren
op_or
id|LDCMD_PAL
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|16
)paren
(brace
multiline_comment|/* palette shouldn&squot;t be loaded in true-color mode */
id|fbi-&gt;dmadesc_fbhigh_cpu-&gt;fdadr
op_assign
id|fbi-&gt;dmadesc_fbhigh_dma
suffix:semicolon
id|fbi-&gt;fdadr0
op_assign
id|fbi-&gt;dmadesc_fbhigh_dma
suffix:semicolon
multiline_comment|/* no pal just fbhigh */
multiline_comment|/* init it to something, even though we won&squot;t be using it */
id|fbi-&gt;dmadesc_palette_cpu-&gt;fdadr
op_assign
id|fbi-&gt;dmadesc_palette_dma
suffix:semicolon
)brace
r_else
(brace
id|fbi-&gt;dmadesc_palette_cpu-&gt;fdadr
op_assign
id|fbi-&gt;dmadesc_fbhigh_dma
suffix:semicolon
id|fbi-&gt;dmadesc_fbhigh_cpu-&gt;fdadr
op_assign
id|fbi-&gt;dmadesc_palette_dma
suffix:semicolon
id|fbi-&gt;fdadr0
op_assign
id|fbi-&gt;dmadesc_palette_dma
suffix:semicolon
multiline_comment|/* flips back and forth between pal and fbhigh */
)brace
macro_line|#if 0
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_fblow_cpu = 0x%p&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_fblow_cpu
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_fbhigh_cpu = 0x%p&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_fbhigh_cpu
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_palette_cpu = 0x%p&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_palette_cpu
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_fblow_dma = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_fblow_dma
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_fbhigh_dma = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_fbhigh_dma
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_palette_dma = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_palette_dma
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_fblow_cpu-&gt;fdadr = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_fblow_cpu-&gt;fdadr
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_fbhigh_cpu-&gt;fdadr = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_fbhigh_cpu-&gt;fdadr
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_palette_cpu-&gt;fdadr = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_palette_cpu-&gt;fdadr
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_fblow_cpu-&gt;fsadr = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_fblow_cpu-&gt;fsadr
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_fbhigh_cpu-&gt;fsadr = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_fbhigh_cpu-&gt;fsadr
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_palette_cpu-&gt;fsadr = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_palette_cpu-&gt;fsadr
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_fblow_cpu-&gt;ldcmd = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_fblow_cpu-&gt;ldcmd
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_fbhigh_cpu-&gt;ldcmd = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_fbhigh_cpu-&gt;ldcmd
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fbi-&gt;dmadesc_palette_cpu-&gt;ldcmd = 0x%x&bslash;n&quot;
comma
id|fbi-&gt;dmadesc_palette_cpu-&gt;ldcmd
)paren
suffix:semicolon
macro_line|#endif
id|fbi-&gt;reg_lccr0
op_assign
id|new_regs.lccr0
suffix:semicolon
id|fbi-&gt;reg_lccr1
op_assign
id|new_regs.lccr1
suffix:semicolon
id|fbi-&gt;reg_lccr2
op_assign
id|new_regs.lccr2
suffix:semicolon
id|fbi-&gt;reg_lccr3
op_assign
id|new_regs.lccr3
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Only update the registers if the controller is enabled&n;&t; * and something has changed.&n;&t; */
r_if
c_cond
(paren
(paren
id|LCCR0
op_ne
id|fbi-&gt;reg_lccr0
)paren
op_logical_or
(paren
id|LCCR1
op_ne
id|fbi-&gt;reg_lccr1
)paren
op_logical_or
(paren
id|LCCR2
op_ne
id|fbi-&gt;reg_lccr2
)paren
op_logical_or
(paren
id|LCCR3
op_ne
id|fbi-&gt;reg_lccr3
)paren
op_logical_or
(paren
id|FDADR0
op_ne
id|fbi-&gt;fdadr0
)paren
op_logical_or
(paren
id|FDADR1
op_ne
id|fbi-&gt;fdadr1
)paren
)paren
id|pxafb_schedule_work
c_func
(paren
id|fbi
comma
id|C_REENABLE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * NOTE!  The following functions are purely helpers for set_ctrlr_state.&n; * Do not call them directly; set_ctrlr_state does the correct serialisation&n; * to ensure that things happen in the right way 100% of time time.&n; *&t;-- rmk&n; */
DECL|function|__pxafb_backlight_power
r_static
r_inline
r_void
id|__pxafb_backlight_power
c_func
(paren
r_struct
id|pxafb_info
op_star
id|fbi
comma
r_int
id|on
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;backlight o%s&bslash;n&quot;
comma
id|on
ques
c_cond
l_string|&quot;n&quot;
suffix:colon
l_string|&quot;ff&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pxafb_backlight_power
)paren
id|pxafb_backlight_power
c_func
(paren
id|on
)paren
suffix:semicolon
)brace
DECL|function|__pxafb_lcd_power
r_static
r_inline
r_void
id|__pxafb_lcd_power
c_func
(paren
r_struct
id|pxafb_info
op_star
id|fbi
comma
r_int
id|on
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;LCD power o%s&bslash;n&quot;
comma
id|on
ques
c_cond
l_string|&quot;n&quot;
suffix:colon
l_string|&quot;ff&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pxafb_lcd_power
)paren
id|pxafb_lcd_power
c_func
(paren
id|on
)paren
suffix:semicolon
)brace
DECL|function|pxafb_setup_gpio
r_static
r_void
id|pxafb_setup_gpio
c_func
(paren
r_struct
id|pxafb_info
op_star
id|fbi
)paren
(brace
r_int
id|gpio
comma
id|ldd_bits
suffix:semicolon
r_int
r_int
id|lccr0
op_assign
id|fbi-&gt;lccr0
suffix:semicolon
multiline_comment|/*&n;&t; * setup is based on type of panel supported&n;        */
multiline_comment|/* 4 bit interface */
r_if
c_cond
(paren
(paren
id|lccr0
op_amp
id|LCCR0_CMS
)paren
op_eq
id|LCCR0_Mono
op_logical_and
(paren
id|lccr0
op_amp
id|LCCR0_SDS
)paren
op_eq
id|LCCR0_Sngl
op_logical_and
(paren
id|lccr0
op_amp
id|LCCR0_DPD
)paren
op_eq
id|LCCR0_4PixMono
)paren
id|ldd_bits
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* 8 bit interface */
r_else
r_if
c_cond
(paren
(paren
(paren
id|lccr0
op_amp
id|LCCR0_CMS
)paren
op_eq
id|LCCR0_Mono
op_logical_and
(paren
(paren
id|lccr0
op_amp
id|LCCR0_SDS
)paren
op_eq
id|LCCR0_Dual
op_logical_or
(paren
id|lccr0
op_amp
id|LCCR0_DPD
)paren
op_eq
id|LCCR0_8PixMono
)paren
)paren
op_logical_or
(paren
(paren
id|lccr0
op_amp
id|LCCR0_CMS
)paren
op_eq
id|LCCR0_Color
op_logical_and
(paren
id|lccr0
op_amp
id|LCCR0_PAS
)paren
op_eq
id|LCCR0_Pas
op_logical_and
(paren
id|lccr0
op_amp
id|LCCR0_SDS
)paren
op_eq
id|LCCR0_Sngl
)paren
)paren
id|ldd_bits
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* 16 bit interface */
r_else
r_if
c_cond
(paren
(paren
id|lccr0
op_amp
id|LCCR0_CMS
)paren
op_eq
id|LCCR0_Color
op_logical_and
(paren
(paren
id|lccr0
op_amp
id|LCCR0_SDS
)paren
op_eq
id|LCCR0_Dual
op_logical_or
(paren
id|lccr0
op_amp
id|LCCR0_PAS
)paren
op_eq
id|LCCR0_Act
)paren
)paren
id|ldd_bits
op_assign
l_int|16
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pxafb_setup_gpio: unable to determine bits per pixel&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|gpio
op_assign
l_int|58
suffix:semicolon
id|ldd_bits
suffix:semicolon
id|gpio
op_increment
comma
id|ldd_bits
op_decrement
)paren
id|pxa_gpio_mode
c_func
(paren
id|gpio
op_or
id|GPIO_ALT_FN_2_OUT
)paren
suffix:semicolon
id|pxa_gpio_mode
c_func
(paren
id|GPIO74_LCD_FCLK_MD
)paren
suffix:semicolon
id|pxa_gpio_mode
c_func
(paren
id|GPIO75_LCD_LCLK_MD
)paren
suffix:semicolon
id|pxa_gpio_mode
c_func
(paren
id|GPIO76_LCD_PCLK_MD
)paren
suffix:semicolon
id|pxa_gpio_mode
c_func
(paren
id|GPIO77_LCD_ACBIAS_MD
)paren
suffix:semicolon
)brace
DECL|function|pxafb_enable_controller
r_static
r_void
id|pxafb_enable_controller
c_func
(paren
r_struct
id|pxafb_info
op_star
id|fbi
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Enabling LCD controller&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fdadr0 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fbi-&gt;fdadr0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fdadr1 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fbi-&gt;fdadr1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;reg_lccr0 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fbi-&gt;reg_lccr0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;reg_lccr1 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fbi-&gt;reg_lccr1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;reg_lccr2 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fbi-&gt;reg_lccr2
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;reg_lccr3 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fbi-&gt;reg_lccr3
)paren
suffix:semicolon
multiline_comment|/* Sequence from 11.7.10 */
id|LCCR3
op_assign
id|fbi-&gt;reg_lccr3
suffix:semicolon
id|LCCR2
op_assign
id|fbi-&gt;reg_lccr2
suffix:semicolon
id|LCCR1
op_assign
id|fbi-&gt;reg_lccr1
suffix:semicolon
id|LCCR0
op_assign
id|fbi-&gt;reg_lccr0
op_amp
op_complement
id|LCCR0_ENB
suffix:semicolon
id|FDADR0
op_assign
id|fbi-&gt;fdadr0
suffix:semicolon
id|FDADR1
op_assign
id|fbi-&gt;fdadr1
suffix:semicolon
id|LCCR0
op_or_assign
id|LCCR0_ENB
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;FDADR0 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|FDADR0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;FDADR1 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|FDADR1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;LCCR0 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|LCCR0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;LCCR1 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|LCCR1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;LCCR2 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|LCCR2
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;LCCR3 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|LCCR3
)paren
suffix:semicolon
)brace
DECL|function|pxafb_disable_controller
r_static
r_void
id|pxafb_disable_controller
c_func
(paren
r_struct
id|pxafb_info
op_star
id|fbi
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Disabling LCD controller&bslash;n&quot;
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|fbi-&gt;ctrlr_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|LCSR
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* Clear LCD Status Register */
id|LCCR0
op_and_assign
op_complement
id|LCCR0_LDM
suffix:semicolon
multiline_comment|/* Enable LCD Disable Done Interrupt */
id|LCCR0
op_or_assign
id|LCCR0_DIS
suffix:semicolon
multiline_comment|/* Disable LCD Controller */
id|schedule_timeout
c_func
(paren
l_int|20
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|fbi-&gt;ctrlr_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  pxafb_handle_irq: Handle &squot;LCD DONE&squot; interrupts.&n; */
DECL|function|pxafb_handle_irq
r_static
id|irqreturn_t
id|pxafb_handle_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|lcsr
op_assign
id|LCSR
suffix:semicolon
r_if
c_cond
(paren
id|lcsr
op_amp
id|LCSR_LDD
)paren
(brace
id|LCCR0
op_or_assign
id|LCCR0_LDM
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|fbi-&gt;ctrlr_wait
)paren
suffix:semicolon
)brace
id|LCSR
op_assign
id|lcsr
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * This function must be called from task context only, since it will&n; * sleep when disabling the LCD controller, or if we get two contending&n; * processes trying to alter state.&n; */
DECL|function|set_ctrlr_state
r_static
r_void
id|set_ctrlr_state
c_func
(paren
r_struct
id|pxafb_info
op_star
id|fbi
comma
id|u_int
id|state
)paren
(brace
id|u_int
id|old_state
suffix:semicolon
id|down
c_func
(paren
op_amp
id|fbi-&gt;ctrlr_sem
)paren
suffix:semicolon
id|old_state
op_assign
id|fbi-&gt;state
suffix:semicolon
multiline_comment|/*&n;&t; * Hack around fbcon initialisation.&n;&t; */
r_if
c_cond
(paren
id|old_state
op_eq
id|C_STARTUP
op_logical_and
id|state
op_eq
id|C_REENABLE
)paren
id|state
op_assign
id|C_ENABLE
suffix:semicolon
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|C_DISABLE_CLKCHANGE
suffix:colon
multiline_comment|/*&n;&t;&t; * Disable controller for clock change.  If the&n;&t;&t; * controller is already disabled, then do nothing.&n;&t;&t; */
r_if
c_cond
(paren
id|old_state
op_ne
id|C_DISABLE
op_logical_and
id|old_state
op_ne
id|C_DISABLE_PM
)paren
(brace
id|fbi-&gt;state
op_assign
id|state
suffix:semicolon
singleline_comment|//TODO __pxafb_lcd_power(fbi, 0);
id|pxafb_disable_controller
c_func
(paren
id|fbi
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|C_DISABLE_PM
suffix:colon
r_case
id|C_DISABLE
suffix:colon
multiline_comment|/*&n;&t;&t; * Disable controller&n;&t;&t; */
r_if
c_cond
(paren
id|old_state
op_ne
id|C_DISABLE
)paren
(brace
id|fbi-&gt;state
op_assign
id|state
suffix:semicolon
id|__pxafb_backlight_power
c_func
(paren
id|fbi
comma
l_int|0
)paren
suffix:semicolon
id|__pxafb_lcd_power
c_func
(paren
id|fbi
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_state
op_ne
id|C_DISABLE_CLKCHANGE
)paren
id|pxafb_disable_controller
c_func
(paren
id|fbi
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|C_ENABLE_CLKCHANGE
suffix:colon
multiline_comment|/*&n;&t;&t; * Enable the controller after clock change.  Only&n;&t;&t; * do this if we were disabled for the clock change.&n;&t;&t; */
r_if
c_cond
(paren
id|old_state
op_eq
id|C_DISABLE_CLKCHANGE
)paren
(brace
id|fbi-&gt;state
op_assign
id|C_ENABLE
suffix:semicolon
id|pxafb_enable_controller
c_func
(paren
id|fbi
)paren
suffix:semicolon
singleline_comment|//TODO __pxafb_lcd_power(fbi, 1);
)brace
r_break
suffix:semicolon
r_case
id|C_REENABLE
suffix:colon
multiline_comment|/*&n;&t;&t; * Re-enable the controller only if it was already&n;&t;&t; * enabled.  This is so we reprogram the control&n;&t;&t; * registers.&n;&t;&t; */
r_if
c_cond
(paren
id|old_state
op_eq
id|C_ENABLE
)paren
(brace
id|pxafb_disable_controller
c_func
(paren
id|fbi
)paren
suffix:semicolon
id|pxafb_setup_gpio
c_func
(paren
id|fbi
)paren
suffix:semicolon
id|pxafb_enable_controller
c_func
(paren
id|fbi
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|C_ENABLE_PM
suffix:colon
multiline_comment|/*&n;&t;&t; * Re-enable the controller after PM.  This is not&n;&t;&t; * perfect - think about the case where we were doing&n;&t;&t; * a clock change, and we suspended half-way through.&n;&t;&t; */
r_if
c_cond
(paren
id|old_state
op_ne
id|C_DISABLE_PM
)paren
r_break
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|C_ENABLE
suffix:colon
multiline_comment|/*&n;&t;&t; * Power up the LCD screen, enable controller, and&n;&t;&t; * turn on the backlight.&n;&t;&t; */
r_if
c_cond
(paren
id|old_state
op_ne
id|C_ENABLE
)paren
(brace
id|fbi-&gt;state
op_assign
id|C_ENABLE
suffix:semicolon
id|pxafb_setup_gpio
c_func
(paren
id|fbi
)paren
suffix:semicolon
id|pxafb_enable_controller
c_func
(paren
id|fbi
)paren
suffix:semicolon
id|__pxafb_lcd_power
c_func
(paren
id|fbi
comma
l_int|1
)paren
suffix:semicolon
id|__pxafb_backlight_power
c_func
(paren
id|fbi
comma
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|fbi-&gt;ctrlr_sem
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Our LCD controller task (which is called when we blank or unblank)&n; * via keventd.&n; */
DECL|function|pxafb_task
r_static
r_void
id|pxafb_task
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
id|dummy
suffix:semicolon
id|u_int
id|state
op_assign
id|xchg
c_func
(paren
op_amp
id|fbi-&gt;task_state
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|set_ctrlr_state
c_func
(paren
id|fbi
comma
id|state
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CPU_FREQ
multiline_comment|/*&n; * CPU clock speed change handler.  We need to adjust the LCD timing&n; * parameters when the CPU clock is adjusted by the power management&n; * subsystem.&n; *&n; * TODO: Determine why f-&gt;new != 10*get_lclk_frequency_10khz()&n; */
r_static
r_int
DECL|function|pxafb_freq_transition
id|pxafb_freq_transition
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
r_int
r_int
id|val
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
id|TO_INF
c_func
(paren
id|nb
comma
id|freq_transition
)paren
suffix:semicolon
singleline_comment|//TODO struct cpufreq_freqs *f = data;
id|u_int
id|pcd
suffix:semicolon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
id|CPUFREQ_PRECHANGE
suffix:colon
id|set_ctrlr_state
c_func
(paren
id|fbi
comma
id|C_DISABLE_CLKCHANGE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPUFREQ_POSTCHANGE
suffix:colon
id|pcd
op_assign
id|get_pcd
c_func
(paren
id|fbi-&gt;fb.var.pixclock
)paren
suffix:semicolon
id|fbi-&gt;reg_lccr3
op_assign
(paren
id|fbi-&gt;reg_lccr3
op_amp
op_complement
l_int|0xff
)paren
op_or
id|LCCR3_PixClkDiv
c_func
(paren
id|pcd
)paren
suffix:semicolon
id|set_ctrlr_state
c_func
(paren
id|fbi
comma
id|C_ENABLE_CLKCHANGE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|pxafb_freq_policy
id|pxafb_freq_policy
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
r_int
r_int
id|val
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
id|TO_INF
c_func
(paren
id|nb
comma
id|freq_policy
)paren
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|fbi-&gt;fb.var
suffix:semicolon
r_struct
id|cpufreq_policy
op_star
id|policy
op_assign
id|data
suffix:semicolon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
id|CPUFREQ_ADJUST
suffix:colon
r_case
id|CPUFREQ_INCOMPATIBLE
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;min dma period: %d ps, &quot;
l_string|&quot;new clock %d kHz&bslash;n&quot;
comma
id|pxafb_display_dma_period
c_func
(paren
id|var
)paren
comma
id|policy-&gt;max
)paren
suffix:semicolon
singleline_comment|// TODO: fill in min/max values
r_break
suffix:semicolon
macro_line|#if 0
r_case
id|CPUFREQ_NOTIFY
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: got CPUFREQ_NOTIFY&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_do
(brace
)brace
r_while
c_loop
(paren
l_int|0
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* todo: panic if min/max values aren&squot;t fulfilled&n;&t;&t; * [can&squot;t really happen unless there&squot;s a bug in the&n;&t;&t; * CPU policy verification process *&n;&t;&t; */
r_break
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_PM
multiline_comment|/*&n; * Power management hooks.  Note that we won&squot;t be called from IRQ context,&n; * unlike the blank functions above, so we may sleep.&n; */
DECL|function|pxafb_suspend
r_static
r_int
id|pxafb_suspend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
comma
id|u32
id|level
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|level
op_eq
id|SUSPEND_DISABLE
op_logical_or
id|level
op_eq
id|SUSPEND_POWER_DOWN
)paren
id|set_ctrlr_state
c_func
(paren
id|fbi
comma
id|C_DISABLE_PM
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pxafb_resume
r_static
r_int
id|pxafb_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|level
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|level
op_eq
id|RESUME_ENABLE
)paren
id|set_ctrlr_state
c_func
(paren
id|fbi
comma
id|C_ENABLE_PM
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|macro|pxafb_suspend
mdefine_line|#define pxafb_suspend&t;NULL
DECL|macro|pxafb_resume
mdefine_line|#define pxafb_resume&t;NULL
macro_line|#endif
multiline_comment|/*&n; * pxafb_map_video_memory():&n; *      Allocates the DRAM memory for the frame buffer.  This buffer is&n; *&t;remapped into a non-cached, non-buffered, memory region to&n; *      allow palette and pixel writes to occur without flushing the&n; *      cache.  Once this area is remapped, all virtual memory&n; *      access to the video memory should occur at the new region.&n; */
DECL|function|pxafb_map_video_memory
r_static
r_int
id|__init
id|pxafb_map_video_memory
c_func
(paren
r_struct
id|pxafb_info
op_star
id|fbi
)paren
(brace
id|u_long
id|palette_mem_size
suffix:semicolon
multiline_comment|/*&n;&t; * We reserve one page for the palette, plus the size&n;&t; * of the framebuffer.&n;&t; */
id|fbi-&gt;map_size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|fbi-&gt;fb.fix.smem_len
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
id|fbi-&gt;map_cpu
op_assign
id|dma_alloc_writecombine
c_func
(paren
id|fbi-&gt;dev
comma
id|fbi-&gt;map_size
comma
op_amp
id|fbi-&gt;map_dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fbi-&gt;map_cpu
)paren
(brace
multiline_comment|/* prevent initial garbage on screen */
id|memset
c_func
(paren
id|fbi-&gt;map_cpu
comma
l_int|0
comma
id|fbi-&gt;map_size
)paren
suffix:semicolon
id|fbi-&gt;fb.screen_base
op_assign
id|fbi-&gt;map_cpu
op_plus
id|PAGE_SIZE
suffix:semicolon
id|fbi-&gt;screen_dma
op_assign
id|fbi-&gt;map_dma
op_plus
id|PAGE_SIZE
suffix:semicolon
multiline_comment|/*&n;&t;&t; * FIXME: this is actually the wrong thing to place in&n;&t;&t; * smem_start.  But fbdev suffers from the problem that&n;&t;&t; * it needs an API which doesn&squot;t exist (in this case,&n;&t;&t; * dma_writecombine_mmap)&n;&t;&t; */
id|fbi-&gt;fb.fix.smem_start
op_assign
id|fbi-&gt;screen_dma
suffix:semicolon
id|fbi-&gt;palette_size
op_assign
id|fbi-&gt;fb.var.bits_per_pixel
op_eq
l_int|8
ques
c_cond
l_int|256
suffix:colon
l_int|16
suffix:semicolon
id|palette_mem_size
op_assign
id|fbi-&gt;palette_size
op_star
r_sizeof
(paren
id|u16
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;palette_mem_size = 0x%08lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|palette_mem_size
)paren
suffix:semicolon
id|fbi-&gt;palette_cpu
op_assign
(paren
id|u16
op_star
)paren
(paren
id|fbi-&gt;map_cpu
op_plus
id|PAGE_SIZE
op_minus
id|palette_mem_size
)paren
suffix:semicolon
id|fbi-&gt;palette_dma
op_assign
id|fbi-&gt;map_dma
op_plus
id|PAGE_SIZE
op_minus
id|palette_mem_size
suffix:semicolon
)brace
r_return
id|fbi-&gt;map_cpu
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|pxafb_init_fbinfo
r_static
r_struct
id|pxafb_info
op_star
id|__init
id|pxafb_init_fbinfo
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
suffix:semicolon
r_void
op_star
id|addr
suffix:semicolon
r_struct
id|pxafb_mach_info
op_star
id|inf
op_assign
id|dev-&gt;platform_data
suffix:semicolon
multiline_comment|/* Alloc the pxafb_info and pseudo_palette in one step */
id|fbi
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pxafb_info
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
op_star
l_int|16
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fbi
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|fbi
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pxafb_info
)paren
)paren
suffix:semicolon
id|fbi-&gt;dev
op_assign
id|dev
suffix:semicolon
id|strcpy
c_func
(paren
id|fbi-&gt;fb.fix.id
comma
id|PXA_NAME
)paren
suffix:semicolon
id|fbi-&gt;fb.fix.type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fbi-&gt;fb.fix.type_aux
op_assign
l_int|0
suffix:semicolon
id|fbi-&gt;fb.fix.xpanstep
op_assign
l_int|0
suffix:semicolon
id|fbi-&gt;fb.fix.ypanstep
op_assign
l_int|0
suffix:semicolon
id|fbi-&gt;fb.fix.ywrapstep
op_assign
l_int|0
suffix:semicolon
id|fbi-&gt;fb.fix.accel
op_assign
id|FB_ACCEL_NONE
suffix:semicolon
id|fbi-&gt;fb.var.nonstd
op_assign
l_int|0
suffix:semicolon
id|fbi-&gt;fb.var.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|fbi-&gt;fb.var.height
op_assign
op_minus
l_int|1
suffix:semicolon
id|fbi-&gt;fb.var.width
op_assign
op_minus
l_int|1
suffix:semicolon
id|fbi-&gt;fb.var.accel_flags
op_assign
l_int|0
suffix:semicolon
id|fbi-&gt;fb.var.vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
id|fbi-&gt;fb.fbops
op_assign
op_amp
id|pxafb_ops
suffix:semicolon
id|fbi-&gt;fb.flags
op_assign
id|FBINFO_DEFAULT
suffix:semicolon
id|fbi-&gt;fb.node
op_assign
op_minus
l_int|1
suffix:semicolon
id|addr
op_assign
id|fbi
suffix:semicolon
id|addr
op_assign
id|addr
op_plus
r_sizeof
(paren
r_struct
id|pxafb_info
)paren
suffix:semicolon
id|fbi-&gt;fb.pseudo_palette
op_assign
id|addr
suffix:semicolon
id|fbi-&gt;max_xres
op_assign
id|inf-&gt;xres
suffix:semicolon
id|fbi-&gt;fb.var.xres
op_assign
id|inf-&gt;xres
suffix:semicolon
id|fbi-&gt;fb.var.xres_virtual
op_assign
id|inf-&gt;xres
suffix:semicolon
id|fbi-&gt;max_yres
op_assign
id|inf-&gt;yres
suffix:semicolon
id|fbi-&gt;fb.var.yres
op_assign
id|inf-&gt;yres
suffix:semicolon
id|fbi-&gt;fb.var.yres_virtual
op_assign
id|inf-&gt;yres
suffix:semicolon
id|fbi-&gt;max_bpp
op_assign
id|inf-&gt;bpp
suffix:semicolon
id|fbi-&gt;fb.var.bits_per_pixel
op_assign
id|inf-&gt;bpp
suffix:semicolon
id|fbi-&gt;fb.var.pixclock
op_assign
id|inf-&gt;pixclock
suffix:semicolon
id|fbi-&gt;fb.var.hsync_len
op_assign
id|inf-&gt;hsync_len
suffix:semicolon
id|fbi-&gt;fb.var.left_margin
op_assign
id|inf-&gt;left_margin
suffix:semicolon
id|fbi-&gt;fb.var.right_margin
op_assign
id|inf-&gt;right_margin
suffix:semicolon
id|fbi-&gt;fb.var.vsync_len
op_assign
id|inf-&gt;vsync_len
suffix:semicolon
id|fbi-&gt;fb.var.upper_margin
op_assign
id|inf-&gt;upper_margin
suffix:semicolon
id|fbi-&gt;fb.var.lower_margin
op_assign
id|inf-&gt;lower_margin
suffix:semicolon
id|fbi-&gt;fb.var.sync
op_assign
id|inf-&gt;sync
suffix:semicolon
id|fbi-&gt;fb.var.grayscale
op_assign
id|inf-&gt;cmap_greyscale
suffix:semicolon
id|fbi-&gt;cmap_inverse
op_assign
id|inf-&gt;cmap_inverse
suffix:semicolon
id|fbi-&gt;cmap_static
op_assign
id|inf-&gt;cmap_static
suffix:semicolon
id|fbi-&gt;lccr0
op_assign
id|inf-&gt;lccr0
suffix:semicolon
id|fbi-&gt;lccr3
op_assign
id|inf-&gt;lccr3
suffix:semicolon
id|fbi-&gt;state
op_assign
id|C_STARTUP
suffix:semicolon
id|fbi-&gt;task_state
op_assign
(paren
id|u_char
)paren
op_minus
l_int|1
suffix:semicolon
id|fbi-&gt;fb.fix.smem_len
op_assign
id|fbi-&gt;max_xres
op_star
id|fbi-&gt;max_yres
op_star
id|fbi-&gt;max_bpp
op_div
l_int|8
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|fbi-&gt;ctrlr_wait
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|fbi-&gt;task
comma
id|pxafb_task
comma
id|fbi
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|fbi-&gt;ctrlr_sem
)paren
suffix:semicolon
r_return
id|fbi
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_FB_PXA_PARAMETERS
DECL|function|pxafb_parse_options
r_static
r_int
id|__init
id|pxafb_parse_options
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|options
)paren
(brace
r_struct
id|pxafb_mach_info
op_star
id|inf
op_assign
id|dev-&gt;platform_data
suffix:semicolon
r_char
op_star
id|this_opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;options are &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|options
ques
c_cond
id|options
suffix:colon
l_string|&quot;null&quot;
)paren
suffix:semicolon
multiline_comment|/* could be made table driven or similar?... */
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;mode:&quot;
comma
l_int|5
)paren
)paren
(brace
r_const
r_char
op_star
id|name
op_assign
id|this_opt
op_plus
l_int|5
suffix:semicolon
r_int
r_int
id|namelen
op_assign
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
r_int
id|res_specified
op_assign
l_int|0
comma
id|bpp_specified
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|xres
op_assign
l_int|0
comma
id|yres
op_assign
l_int|0
comma
id|bpp
op_assign
l_int|0
suffix:semicolon
r_int
id|yres_specified
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|namelen
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_switch
c_cond
(paren
id|name
(braket
id|i
)braket
)paren
(brace
r_case
l_char|&squot;-&squot;
suffix:colon
id|namelen
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bpp_specified
op_logical_and
op_logical_neg
id|yres_specified
)paren
(brace
id|bpp
op_assign
id|simple_strtoul
c_func
(paren
op_amp
id|name
(braket
id|i
op_plus
l_int|1
)braket
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|bpp_specified
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_goto
id|done
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;x&squot;
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|yres_specified
)paren
(brace
id|yres
op_assign
id|simple_strtoul
c_func
(paren
op_amp
id|name
(braket
id|i
op_plus
l_int|1
)braket
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|yres_specified
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_goto
id|done
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;0&squot;
dot
dot
dot
l_char|&squot;9&squot;
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|done
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
OL
l_int|0
op_logical_and
id|yres_specified
)paren
(brace
id|xres
op_assign
id|simple_strtoul
c_func
(paren
id|name
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|res_specified
op_assign
l_int|1
suffix:semicolon
)brace
id|done
suffix:colon
r_if
c_cond
(paren
id|res_specified
)paren
(brace
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;overriding resolution: %dx%d&bslash;n&quot;
comma
id|xres
comma
id|yres
)paren
suffix:semicolon
id|inf-&gt;xres
op_assign
id|xres
suffix:semicolon
id|inf-&gt;yres
op_assign
id|yres
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bpp_specified
)paren
r_switch
c_cond
(paren
id|bpp
)paren
(brace
r_case
l_int|1
suffix:colon
r_case
l_int|2
suffix:colon
r_case
l_int|4
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|16
suffix:colon
id|inf-&gt;bpp
op_assign
id|bpp
suffix:semicolon
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;overriding bit depth: %d&bslash;n&quot;
comma
id|bpp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;Depth %d is not valid&bslash;n&quot;
comma
id|bpp
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;pixclock:&quot;
comma
l_int|9
)paren
)paren
(brace
id|inf-&gt;pixclock
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|9
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override pixclock: %ld&bslash;n&quot;
comma
id|inf-&gt;pixclock
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;left:&quot;
comma
l_int|5
)paren
)paren
(brace
id|inf-&gt;left_margin
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|5
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override left: %u&bslash;n&quot;
comma
id|inf-&gt;left_margin
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;right:&quot;
comma
l_int|6
)paren
)paren
(brace
id|inf-&gt;right_margin
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override right: %u&bslash;n&quot;
comma
id|inf-&gt;right_margin
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;upper:&quot;
comma
l_int|6
)paren
)paren
(brace
id|inf-&gt;upper_margin
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override upper: %u&bslash;n&quot;
comma
id|inf-&gt;upper_margin
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;lower:&quot;
comma
l_int|6
)paren
)paren
(brace
id|inf-&gt;lower_margin
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override lower: %u&bslash;n&quot;
comma
id|inf-&gt;lower_margin
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;hsynclen:&quot;
comma
l_int|9
)paren
)paren
(brace
id|inf-&gt;hsync_len
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|9
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override hsynclen: %u&bslash;n&quot;
comma
id|inf-&gt;hsync_len
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;vsynclen:&quot;
comma
l_int|9
)paren
)paren
(brace
id|inf-&gt;vsync_len
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|9
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override vsynclen: %u&bslash;n&quot;
comma
id|inf-&gt;vsync_len
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;hsync:&quot;
comma
l_int|6
)paren
)paren
(brace
r_if
c_cond
(paren
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override hsync: Active Low&bslash;n&quot;
)paren
suffix:semicolon
id|inf-&gt;sync
op_and_assign
op_complement
id|FB_SYNC_HOR_HIGH_ACT
suffix:semicolon
)brace
r_else
(brace
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override hsync: Active High&bslash;n&quot;
)paren
suffix:semicolon
id|inf-&gt;sync
op_or_assign
id|FB_SYNC_HOR_HIGH_ACT
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;vsync:&quot;
comma
l_int|6
)paren
)paren
(brace
r_if
c_cond
(paren
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override vsync: Active Low&bslash;n&quot;
)paren
suffix:semicolon
id|inf-&gt;sync
op_and_assign
op_complement
id|FB_SYNC_VERT_HIGH_ACT
suffix:semicolon
)brace
r_else
(brace
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override vsync: Active High&bslash;n&quot;
)paren
suffix:semicolon
id|inf-&gt;sync
op_or_assign
id|FB_SYNC_VERT_HIGH_ACT
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;dpc:&quot;
comma
l_int|4
)paren
)paren
(brace
r_if
c_cond
(paren
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|4
comma
l_int|NULL
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override double pixel clock: false&bslash;n&quot;
)paren
suffix:semicolon
id|inf-&gt;lccr3
op_and_assign
op_complement
id|LCCR3_DPC
suffix:semicolon
)brace
r_else
(brace
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override double pixel clock: true&bslash;n&quot;
)paren
suffix:semicolon
id|inf-&gt;lccr3
op_or_assign
id|LCCR3_DPC
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;outputen:&quot;
comma
l_int|9
)paren
)paren
(brace
r_if
c_cond
(paren
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|9
comma
l_int|NULL
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override output enable: active low&bslash;n&quot;
)paren
suffix:semicolon
id|inf-&gt;lccr3
op_assign
(paren
id|inf-&gt;lccr3
op_amp
op_complement
id|LCCR3_OEP
)paren
op_or
id|LCCR3_OutEnL
suffix:semicolon
)brace
r_else
(brace
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override output enable: active high&bslash;n&quot;
)paren
suffix:semicolon
id|inf-&gt;lccr3
op_assign
(paren
id|inf-&gt;lccr3
op_amp
op_complement
id|LCCR3_OEP
)paren
op_or
id|LCCR3_OutEnH
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;pixclockpol:&quot;
comma
l_int|12
)paren
)paren
(brace
r_if
c_cond
(paren
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|12
comma
l_int|NULL
comma
l_int|0
)paren
op_eq
l_int|0
)paren
(brace
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override pixel clock polarity: falling edge&bslash;n&quot;
)paren
suffix:semicolon
id|inf-&gt;lccr3
op_assign
(paren
id|inf-&gt;lccr3
op_amp
op_complement
id|LCCR3_PCP
)paren
op_or
id|LCCR3_PixFlEdg
suffix:semicolon
)brace
r_else
(brace
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;override pixel clock polarity: rising edge&bslash;n&quot;
)paren
suffix:semicolon
id|inf-&gt;lccr3
op_assign
(paren
id|inf-&gt;lccr3
op_amp
op_complement
id|LCCR3_PCP
)paren
op_or
id|LCCR3_PixRsEdg
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;color&quot;
comma
l_int|5
)paren
)paren
(brace
id|inf-&gt;lccr0
op_assign
(paren
id|inf-&gt;lccr0
op_amp
op_complement
id|LCCR0_CMS
)paren
op_or
id|LCCR0_Color
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;mono&quot;
comma
l_int|4
)paren
)paren
(brace
id|inf-&gt;lccr0
op_assign
(paren
id|inf-&gt;lccr0
op_amp
op_complement
id|LCCR0_CMS
)paren
op_or
id|LCCR0_Mono
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;active&quot;
comma
l_int|6
)paren
)paren
(brace
id|inf-&gt;lccr0
op_assign
(paren
id|inf-&gt;lccr0
op_amp
op_complement
id|LCCR0_PAS
)paren
op_or
id|LCCR0_Act
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;passive&quot;
comma
l_int|7
)paren
)paren
(brace
id|inf-&gt;lccr0
op_assign
(paren
id|inf-&gt;lccr0
op_amp
op_complement
id|LCCR0_PAS
)paren
op_or
id|LCCR0_Pas
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;single&quot;
comma
l_int|6
)paren
)paren
(brace
id|inf-&gt;lccr0
op_assign
(paren
id|inf-&gt;lccr0
op_amp
op_complement
id|LCCR0_SDS
)paren
op_or
id|LCCR0_Sngl
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;dual&quot;
comma
l_int|4
)paren
)paren
(brace
id|inf-&gt;lccr0
op_assign
(paren
id|inf-&gt;lccr0
op_amp
op_complement
id|LCCR0_SDS
)paren
op_or
id|LCCR0_Dual
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;4pix&quot;
comma
l_int|4
)paren
)paren
(brace
id|inf-&gt;lccr0
op_assign
(paren
id|inf-&gt;lccr0
op_amp
op_complement
id|LCCR0_DPD
)paren
op_or
id|LCCR0_4PixMono
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;8pix&quot;
comma
l_int|4
)paren
)paren
(brace
id|inf-&gt;lccr0
op_assign
(paren
id|inf-&gt;lccr0
op_amp
op_complement
id|LCCR0_DPD
)paren
op_or
id|LCCR0_8PixMono
suffix:semicolon
)brace
r_else
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;unknown option: %s&bslash;n&quot;
comma
id|this_opt
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|pxafb_probe
r_int
id|__init
id|pxafb_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|pxafb_info
op_star
id|fbi
suffix:semicolon
r_struct
id|pxafb_mach_info
op_star
id|inf
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;pxafb_probe&bslash;n&quot;
)paren
suffix:semicolon
id|inf
op_assign
id|dev-&gt;platform_data
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|fbi
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inf
)paren
r_goto
id|failed
suffix:semicolon
macro_line|#ifdef CONFIG_FB_PXA_PARAMETERS
id|ret
op_assign
id|pxafb_parse_options
c_func
(paren
id|dev
comma
id|g_options
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|failed
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEBUG_VAR
multiline_comment|/* Check for various illegal bit-combinations. Currently only&n;&t; * a warning is given. */
r_if
c_cond
(paren
id|inf-&gt;lccr0
op_amp
id|LCCR0_INVALID_CONFIG_MASK
)paren
id|dev_warn
c_func
(paren
id|dev
comma
l_string|&quot;machine LCCR0 setting contains illegal bits: %08x&bslash;n&quot;
comma
id|inf-&gt;lccr0
op_amp
id|LCCR0_INVALID_CONFIG_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inf-&gt;lccr3
op_amp
id|LCCR3_INVALID_CONFIG_MASK
)paren
id|dev_warn
c_func
(paren
id|dev
comma
l_string|&quot;machine LCCR3 setting contains illegal bits: %08x&bslash;n&quot;
comma
id|inf-&gt;lccr3
op_amp
id|LCCR3_INVALID_CONFIG_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inf-&gt;lccr0
op_amp
id|LCCR0_DPD
op_logical_and
(paren
(paren
id|inf-&gt;lccr0
op_amp
id|LCCR0_PAS
)paren
op_ne
id|LCCR0_Pas
op_logical_or
(paren
id|inf-&gt;lccr0
op_amp
id|LCCR0_SDS
)paren
op_ne
id|LCCR0_Sngl
op_logical_or
(paren
id|inf-&gt;lccr0
op_amp
id|LCCR0_CMS
)paren
op_ne
id|LCCR0_Mono
)paren
)paren
id|dev_warn
c_func
(paren
id|dev
comma
l_string|&quot;Double Pixel Data (DPD) mode is only valid in passive mono&quot;
l_string|&quot; single panel mode&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inf-&gt;lccr0
op_amp
id|LCCR0_PAS
)paren
op_eq
id|LCCR0_Act
op_logical_and
(paren
id|inf-&gt;lccr0
op_amp
id|LCCR0_SDS
)paren
op_eq
id|LCCR0_Dual
)paren
id|dev_warn
c_func
(paren
id|dev
comma
l_string|&quot;Dual panel only valid in passive mode&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inf-&gt;lccr0
op_amp
id|LCCR0_PAS
)paren
op_eq
id|LCCR0_Pas
op_logical_and
(paren
id|inf-&gt;upper_margin
op_logical_or
id|inf-&gt;lower_margin
)paren
)paren
id|dev_warn
c_func
(paren
id|dev
comma
l_string|&quot;Upper and lower margins must be 0 in passive mode&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;got a %dx%dx%d LCD&bslash;n&quot;
comma
id|inf-&gt;xres
comma
id|inf-&gt;yres
comma
id|inf-&gt;bpp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inf-&gt;xres
op_eq
l_int|0
op_logical_or
id|inf-&gt;yres
op_eq
l_int|0
op_logical_or
id|inf-&gt;bpp
op_eq
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;Invalid resolution or bit depth&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|pxafb_backlight_power
op_assign
id|inf-&gt;pxafb_backlight_power
suffix:semicolon
id|pxafb_lcd_power
op_assign
id|inf-&gt;pxafb_lcd_power
suffix:semicolon
id|fbi
op_assign
id|pxafb_init_fbinfo
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fbi
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to initialize framebuffer device&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
singleline_comment|// only reason for pxafb_init_fbinfo to fail is kmalloc
r_goto
id|failed
suffix:semicolon
)brace
multiline_comment|/* Initialize video memory */
id|ret
op_assign
id|pxafb_map_video_memory
c_func
(paren
id|fbi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to allocate video RAM: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
multiline_comment|/* enable LCD controller clock */
id|pxa_set_cken
c_func
(paren
id|CKEN16_LCD
comma
l_int|1
)paren
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|IRQ_LCD
comma
id|pxafb_handle_irq
comma
id|SA_INTERRUPT
comma
l_string|&quot;LCD&quot;
comma
id|fbi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;request_irq failed: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * This makes sure that our colour bitfield&n;&t; * descriptors are correctly initialised.&n;&t; */
id|pxafb_check_var
c_func
(paren
op_amp
id|fbi-&gt;fb.var
comma
op_amp
id|fbi-&gt;fb
)paren
suffix:semicolon
id|pxafb_set_par
c_func
(paren
op_amp
id|fbi-&gt;fb
)paren
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
id|dev
comma
id|fbi
)paren
suffix:semicolon
id|ret
op_assign
id|register_framebuffer
c_func
(paren
op_amp
id|fbi-&gt;fb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;Failed to register framebuffer device: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
singleline_comment|// TODO
macro_line|#endif
macro_line|#ifdef CONFIG_CPU_FREQ
id|fbi-&gt;freq_transition.notifier_call
op_assign
id|pxafb_freq_transition
suffix:semicolon
id|fbi-&gt;freq_policy.notifier_call
op_assign
id|pxafb_freq_policy
suffix:semicolon
id|cpufreq_register_notifier
c_func
(paren
op_amp
id|fbi-&gt;freq_transition
comma
id|CPUFREQ_TRANSITION_NOTIFIER
)paren
suffix:semicolon
id|cpufreq_register_notifier
c_func
(paren
op_amp
id|fbi-&gt;freq_policy
comma
id|CPUFREQ_POLICY_NOTIFIER
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Ok, now enable the LCD controller&n;&t; */
id|set_ctrlr_state
c_func
(paren
id|fbi
comma
id|C_ENABLE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed
suffix:colon
id|dev_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fbi
)paren
id|kfree
c_func
(paren
id|fbi
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|pxafb_driver
r_static
r_struct
id|device_driver
id|pxafb_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;pxa2xx-fb&quot;
comma
dot
id|bus
op_assign
op_amp
id|platform_bus_type
comma
dot
id|probe
op_assign
id|pxafb_probe
comma
macro_line|#ifdef CONFIG_PM
dot
id|suspend
op_assign
id|pxafb_suspend
comma
dot
id|resume
op_assign
id|pxafb_resume
comma
macro_line|#endif
)brace
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|pxafb_setup
r_int
id|__devinit
id|pxafb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
macro_line|# ifdef CONFIG_FB_PXA_PARAMETERS
id|strlcpy
c_func
(paren
id|g_options
comma
id|options
comma
r_sizeof
(paren
id|g_options
)paren
)paren
suffix:semicolon
macro_line|# endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
macro_line|# ifdef CONFIG_FB_PXA_PARAMETERS
id|module_param_string
c_func
(paren
id|options
comma
id|g_options
comma
r_sizeof
(paren
id|g_options
)paren
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|options
comma
l_string|&quot;LCD parameters (see Documentation/fb/pxafb.txt)&quot;
)paren
suffix:semicolon
macro_line|# endif
macro_line|#endif
DECL|function|pxafb_init
r_int
id|__devinit
id|pxafb_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifndef MODULE
r_char
op_star
id|option
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|fb_get_options
c_func
(paren
l_string|&quot;pxafb&quot;
comma
op_amp
id|option
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|pxafb_setup
c_func
(paren
id|option
)paren
suffix:semicolon
macro_line|#endif
r_return
id|driver_register
c_func
(paren
op_amp
id|pxafb_driver
)paren
suffix:semicolon
)brace
DECL|variable|pxafb_init
id|module_init
c_func
(paren
id|pxafb_init
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;loadable framebuffer driver for PXA&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
