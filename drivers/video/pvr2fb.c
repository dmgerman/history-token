multiline_comment|/* drivers/video/pvr2fb.c&n; *&n; * Frame buffer and fbcon support for the NEC PowerVR2 found within the Sega&n; * Dreamcast.&n; *&n; * Copyright (c) 2001 M. R. Brown &lt;mrbrown@0xd6.org&gt;&n; * Copyright (c) 2001, 2002, 2003 Paul Mundt &lt;lethal@linux-sh.org&gt;&n; *&n; * This file is part of the LinuxDC project (linuxdc.sourceforge.net).&n; *&n; */
multiline_comment|/*&n; * This driver is mostly based on the excellent amifb and vfb sources.  It uses&n; * an odd scheme for converting hardware values to/from framebuffer values,&n; * here are some hacked-up formulas:&n; *&n; *  The Dreamcast has screen offsets from each side of its four borders and&n; *  the start offsets of the display window.  I used these values to calculate&n; *  &squot;pseudo&squot; values (think of them as placeholders) for the fb video mode, so&n; *  that when it came time to convert these values back into their hardware&n; *  values, I could just add mode- specific offsets to get the correct mode&n; *  settings:&n; *&n; *      left_margin = diwstart_h - borderstart_h;&n; *      right_margin = borderstop_h - (diwstart_h + xres);&n; *      upper_margin = diwstart_v - borderstart_v;&n; *      lower_margin = borderstop_v - (diwstart_h + yres);&n; *&n; *      hsync_len = borderstart_h + (hsync_total - borderstop_h);&n; *      vsync_len = borderstart_v + (vsync_total - borderstop_v);&n; *&n; *  Then, when it&squot;s time to convert back to hardware settings, the only&n; *  constants are the borderstart_* offsets, all other values are derived from&n; *  the fb video mode:&n; *  &n; *      // PAL&n; *      borderstart_h = 116;&n; *      borderstart_v = 44;&n; *      ...&n; *      borderstop_h = borderstart_h + hsync_total - hsync_len;&n; *      ...&n; *      diwstart_v = borderstart_v - upper_margin;&n; *&n; *  However, in the current implementation, the borderstart values haven&squot;t had&n; *  the benefit of being fully researched, so some modes may be broken.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#ifdef CONFIG_SH_DREAMCAST
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
macro_line|#include &lt;asm/dc_sysasic.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_MTRR
macro_line|#include &lt;asm/mtrr.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_FB_PVR2_DEBUG
DECL|macro|DPRINTK
macro_line|#  define DPRINTK(fmt, args...) printk(KERN_DEBUG &quot;%s: &quot; fmt, __FUNCTION__ , ## args)
macro_line|#else
DECL|macro|DPRINTK
macro_line|#  define DPRINTK(fmt, args...)
macro_line|#endif
multiline_comment|/* 2D video registers */
DECL|macro|DISP_BASE
mdefine_line|#define DISP_BASE 0xa05f8000
DECL|macro|DISP_BRDRCOLR
mdefine_line|#define DISP_BRDRCOLR (DISP_BASE + 0x40)
DECL|macro|DISP_DIWMODE
mdefine_line|#define DISP_DIWMODE (DISP_BASE + 0x44)
DECL|macro|DISP_DIWADDRL
mdefine_line|#define DISP_DIWADDRL (DISP_BASE + 0x50)
DECL|macro|DISP_DIWADDRS
mdefine_line|#define DISP_DIWADDRS (DISP_BASE + 0x54)
DECL|macro|DISP_DIWSIZE
mdefine_line|#define DISP_DIWSIZE (DISP_BASE + 0x5c)
DECL|macro|DISP_SYNCCONF
mdefine_line|#define DISP_SYNCCONF (DISP_BASE + 0xd0)
DECL|macro|DISP_BRDRHORZ
mdefine_line|#define DISP_BRDRHORZ (DISP_BASE + 0xd4)
DECL|macro|DISP_SYNCSIZE
mdefine_line|#define DISP_SYNCSIZE (DISP_BASE + 0xd8)
DECL|macro|DISP_BRDRVERT
mdefine_line|#define DISP_BRDRVERT (DISP_BASE + 0xdc)
DECL|macro|DISP_DIWCONF
mdefine_line|#define DISP_DIWCONF (DISP_BASE + 0xe8)
DECL|macro|DISP_DIWHSTRT
mdefine_line|#define DISP_DIWHSTRT (DISP_BASE + 0xec)
DECL|macro|DISP_DIWVSTRT
mdefine_line|#define DISP_DIWVSTRT (DISP_BASE + 0xf0)
multiline_comment|/* Pixel clocks, one for TV output, doubled for VGA output */
DECL|macro|TV_CLK
mdefine_line|#define TV_CLK 74239
DECL|macro|VGA_CLK
mdefine_line|#define VGA_CLK 37119
multiline_comment|/* This is for 60Hz - the VTOTAL is doubled for interlaced modes */
DECL|macro|PAL_HTOTAL
mdefine_line|#define PAL_HTOTAL 863
DECL|macro|PAL_VTOTAL
mdefine_line|#define PAL_VTOTAL 312
DECL|macro|NTSC_HTOTAL
mdefine_line|#define NTSC_HTOTAL 857
DECL|macro|NTSC_VTOTAL
mdefine_line|#define NTSC_VTOTAL 262
DECL|enumerator|CT_VGA
DECL|enumerator|CT_NONE
DECL|enumerator|CT_RGB
DECL|enumerator|CT_COMPOSITE
r_enum
(brace
id|CT_VGA
comma
id|CT_NONE
comma
id|CT_RGB
comma
id|CT_COMPOSITE
)brace
suffix:semicolon
DECL|enumerator|VO_PAL
DECL|enumerator|VO_NTSC
DECL|enumerator|VO_VGA
r_enum
(brace
id|VO_PAL
comma
id|VO_NTSC
comma
id|VO_VGA
)brace
suffix:semicolon
DECL|struct|pvr2_params
DECL|member|val
DECL|member|name
r_struct
id|pvr2_params
(brace
id|u_short
id|val
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|pvr2_params
id|cables
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|CT_VGA
comma
l_string|&quot;VGA&quot;
)brace
comma
(brace
id|CT_RGB
comma
l_string|&quot;RGB&quot;
)brace
comma
(brace
id|CT_COMPOSITE
comma
l_string|&quot;COMPOSITE&quot;
)brace
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|pvr2_params
id|outputs
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|VO_PAL
comma
l_string|&quot;PAL&quot;
)brace
comma
(brace
id|VO_NTSC
comma
l_string|&quot;NTSC&quot;
)brace
comma
(brace
id|VO_VGA
comma
l_string|&quot;VGA&quot;
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * This describes the current video mode&n; */
DECL|struct|pvr2fb_par
r_static
r_struct
id|pvr2fb_par
(brace
DECL|member|hsync_total
id|u_short
id|hsync_total
suffix:semicolon
multiline_comment|/* Clocks/line */
DECL|member|vsync_total
id|u_short
id|vsync_total
suffix:semicolon
multiline_comment|/* Lines/field */
DECL|member|borderstart_h
id|u_short
id|borderstart_h
suffix:semicolon
DECL|member|borderstop_h
id|u_short
id|borderstop_h
suffix:semicolon
DECL|member|borderstart_v
id|u_short
id|borderstart_v
suffix:semicolon
DECL|member|borderstop_v
id|u_short
id|borderstop_v
suffix:semicolon
DECL|member|diwstart_h
id|u_short
id|diwstart_h
suffix:semicolon
multiline_comment|/* Horizontal offset of the display field */
DECL|member|diwstart_v
id|u_short
id|diwstart_v
suffix:semicolon
multiline_comment|/* Vertical offset of the display field, for&n;&t;&t;&t;&t;   interlaced modes, this is the long field */
DECL|member|disp_start
id|u_long
id|disp_start
suffix:semicolon
multiline_comment|/* Address of image within VRAM */
DECL|member|is_interlaced
id|u_char
id|is_interlaced
suffix:semicolon
multiline_comment|/* Is the display interlaced? */
DECL|member|is_doublescan
id|u_char
id|is_doublescan
suffix:semicolon
multiline_comment|/* Are scanlines output twice? (doublescan) */
DECL|member|is_lowres
id|u_char
id|is_lowres
suffix:semicolon
multiline_comment|/* Is horizontal pixel-doubling enabled? */
DECL|variable|currentpar
)brace
op_star
id|currentpar
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|fb_info
op_star
id|fb_info
suffix:semicolon
DECL|variable|pvr2fb_inverse
r_static
r_int
id|pvr2fb_inverse
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|fb_fix_screeninfo
id|pvr2_fix
id|__initdata
op_assign
(brace
dot
id|id
op_assign
l_string|&quot;NEC PowerVR2&quot;
comma
dot
id|type
op_assign
id|FB_TYPE_PACKED_PIXELS
comma
dot
id|visual
op_assign
id|FB_VISUAL_TRUECOLOR
comma
dot
id|ypanstep
op_assign
l_int|1
comma
dot
id|ywrapstep
op_assign
l_int|1
comma
dot
id|accel
op_assign
id|FB_ACCEL_NONE
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|fb_var_screeninfo
id|pvr2_var
id|__initdata
op_assign
(brace
dot
id|xres
op_assign
l_int|640
comma
dot
id|yres
op_assign
l_int|480
comma
dot
id|xres_virtual
op_assign
l_int|640
comma
dot
id|yres_virtual
op_assign
l_int|480
comma
dot
id|bits_per_pixel
op_assign
l_int|16
comma
dot
id|red
op_assign
(brace
l_int|11
comma
l_int|5
comma
l_int|0
)brace
comma
dot
id|green
op_assign
(brace
l_int|5
comma
l_int|6
comma
l_int|0
)brace
comma
dot
id|blue
op_assign
(brace
l_int|0
comma
l_int|5
comma
l_int|0
)brace
comma
dot
id|activate
op_assign
id|FB_ACTIVATE_NOW
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
comma
)brace
suffix:semicolon
DECL|macro|VIDEOMEMSIZE
mdefine_line|#define VIDEOMEMSIZE (8*1024*1024)
DECL|variable|videomemory
DECL|variable|videomemorysize
r_static
id|u_long
id|videomemory
op_assign
l_int|0xa5000000
comma
id|videomemorysize
op_assign
id|VIDEOMEMSIZE
suffix:semicolon
DECL|variable|cable_type
r_static
r_int
id|cable_type
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|video_output
r_static
r_int
id|video_output
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|nopan
r_static
r_int
id|nopan
op_assign
l_int|0
suffix:semicolon
DECL|variable|nowrap
r_static
r_int
id|nowrap
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n; * We do all updating, blanking, etc. during the vertical retrace period&n; */
DECL|variable|do_vmode_full
r_static
id|u_short
id|do_vmode_full
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Change the video mode */
DECL|variable|do_vmode_pan
r_static
id|u_short
id|do_vmode_pan
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Update the video mode */
DECL|variable|do_blank
r_static
r_int
id|do_blank
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* (Un)Blank the screen */
DECL|variable|is_blanked
r_static
id|u_short
id|is_blanked
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Is the screen blanked? */
multiline_comment|/* Interface used by the world */
r_int
id|pvr2fb_setup
c_func
(paren
r_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|pvr2fb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|pvr2fb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
id|u_long
id|get_line_length
c_func
(paren
r_int
id|xres_virtual
comma
r_int
id|bpp
)paren
suffix:semicolon
r_static
r_void
id|set_color_bitfields
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
suffix:semicolon
r_static
r_int
id|pvr2fb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|pvr2fb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|pvr2_update_display
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|pvr2_init_display
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|pvr2_do_blank
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|pvr2fb_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
r_static
r_int
id|pvr2_init_cable
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|pvr2_get_param
c_func
(paren
r_const
r_struct
id|pvr2_params
op_star
id|p
comma
r_const
r_char
op_star
id|s
comma
r_int
id|val
comma
r_int
id|size
)paren
suffix:semicolon
DECL|variable|pvr2fb_ops
r_static
r_struct
id|fb_ops
id|pvr2fb_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|fb_setcolreg
op_assign
id|pvr2fb_setcolreg
comma
dot
id|fb_blank
op_assign
id|pvr2fb_blank
comma
dot
id|fb_check_var
op_assign
id|pvr2fb_check_var
comma
dot
id|fb_set_par
op_assign
id|pvr2fb_set_par
comma
dot
id|fb_fillrect
op_assign
id|cfb_fillrect
comma
dot
id|fb_copyarea
op_assign
id|cfb_copyarea
comma
dot
id|fb_imageblit
op_assign
id|cfb_imageblit
comma
dot
id|fb_cursor
op_assign
id|soft_cursor
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|fb_videomode
id|pvr2_modedb
(braket
)braket
id|__initdata
op_assign
(brace
multiline_comment|/*&n;     * Broadcast video modes (PAL and NTSC).  I&squot;m unfamiliar with&n;     * PAL-M and PAL-N, but from what I&squot;ve read both modes parallel PAL and&n;     * NTSC, so it shouldn&squot;t be a problem (I hope).&n;     */
(brace
multiline_comment|/* 640x480 @ 60Hz interlaced (NTSC) */
l_string|&quot;ntsc_640x480i&quot;
comma
l_int|60
comma
l_int|640
comma
l_int|480
comma
id|TV_CLK
comma
l_int|38
comma
l_int|33
comma
l_int|0
comma
l_int|18
comma
l_int|146
comma
l_int|26
comma
id|FB_SYNC_BROADCAST
comma
id|FB_VMODE_INTERLACED
op_or
id|FB_VMODE_YWRAP
)brace
comma
(brace
multiline_comment|/* 640x240 @ 60Hz (NTSC) */
multiline_comment|/* XXX: Broken! Don&squot;t use... */
l_string|&quot;ntsc_640x240&quot;
comma
l_int|60
comma
l_int|640
comma
l_int|240
comma
id|TV_CLK
comma
l_int|38
comma
l_int|33
comma
l_int|0
comma
l_int|0
comma
l_int|146
comma
l_int|22
comma
id|FB_SYNC_BROADCAST
comma
id|FB_VMODE_YWRAP
)brace
comma
(brace
multiline_comment|/* 640x480 @ 60hz (VGA) */
l_string|&quot;vga_640x480&quot;
comma
l_int|60
comma
l_int|640
comma
l_int|480
comma
id|VGA_CLK
comma
l_int|38
comma
l_int|33
comma
l_int|0
comma
l_int|18
comma
l_int|146
comma
l_int|26
comma
l_int|0
comma
id|FB_VMODE_YWRAP
)brace
comma
)brace
suffix:semicolon
DECL|macro|NUM_TOTAL_MODES
mdefine_line|#define NUM_TOTAL_MODES  ARRAY_SIZE(pvr2_modedb)
DECL|macro|DEFMODE_NTSC
mdefine_line|#define DEFMODE_NTSC&t;0
DECL|macro|DEFMODE_PAL
mdefine_line|#define DEFMODE_PAL&t;0
DECL|macro|DEFMODE_VGA
mdefine_line|#define DEFMODE_VGA&t;2
DECL|variable|defmode
r_static
r_int
id|defmode
op_assign
id|DEFMODE_NTSC
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
op_star
id|mode_option
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
DECL|function|pvr2fb_blank
r_static
r_int
id|pvr2fb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|do_blank
op_assign
id|blank
ques
c_cond
id|blank
suffix:colon
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_line_length
r_static
r_inline
id|u_long
id|get_line_length
c_func
(paren
r_int
id|xres_virtual
comma
r_int
id|bpp
)paren
(brace
r_return
(paren
id|u_long
)paren
(paren
(paren
(paren
(paren
id|xres_virtual
op_star
id|bpp
)paren
op_plus
l_int|31
)paren
op_amp
op_complement
l_int|31
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
)brace
DECL|function|set_color_bitfields
r_static
r_void
id|set_color_bitfields
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|16
suffix:colon
multiline_comment|/* RGB 565 */
id|var-&gt;red.offset
op_assign
l_int|11
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
multiline_comment|/* RGB 888 */
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
multiline_comment|/* ARGB 8888 */
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|24
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|pvr2fb_setcolreg
r_static
r_int
id|pvr2fb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|regno
OL
l_int|16
)paren
(brace
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|16
suffix:colon
multiline_comment|/* RGB 565 */
(paren
(paren
id|u16
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|regno
)braket
op_assign
(paren
id|red
op_amp
l_int|0xf800
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xfc00
)paren
op_rshift
l_int|5
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xf800
)paren
op_rshift
l_int|11
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
multiline_comment|/* RGB 888 */
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|regno
)braket
op_assign
(paren
id|red
op_lshift
l_int|16
)paren
op_or
(paren
id|green
op_lshift
l_int|8
)paren
op_or
id|blue
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
multiline_comment|/* ARGB 8888 */
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|regno
)braket
op_assign
(paren
id|transp
op_lshift
l_int|24
)paren
op_or
(paren
id|red
op_lshift
l_int|16
)paren
op_or
(paren
id|green
op_lshift
l_int|8
)paren
op_or
id|blue
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Invalid bit depth %d?!?&bslash;n&quot;
comma
id|info-&gt;var.bits_per_pixel
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2fb_set_par
r_static
r_int
id|pvr2fb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|pvr2fb_par
op_star
id|par
op_assign
(paren
r_struct
id|pvr2fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|info-&gt;var
suffix:semicolon
id|u_long
id|line_length
suffix:semicolon
id|u_short
id|vtotal
suffix:semicolon
multiline_comment|/*&n;&t; * XXX: It&squot;s possible that a user could use a VGA box, change the cable&n;&t; * type in hardware (i.e. switch from VGA&lt;-&gt;composite), then change&n;&t; * modes (i.e. switching to another VT).  If that happens we should&n;&t; * automagically change the output format to cope, but currently I&n;&t; * don&squot;t have a VGA box to make sure this works properly.&n;&t; */
id|cable_type
op_assign
id|pvr2_init_cable
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cable_type
op_eq
id|CT_VGA
op_logical_and
id|video_output
op_ne
id|VO_VGA
)paren
id|video_output
op_assign
id|VO_VGA
suffix:semicolon
id|var-&gt;vmode
op_and_assign
id|FB_VMODE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
op_logical_and
id|video_output
op_ne
id|VO_VGA
)paren
id|par-&gt;is_interlaced
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* &n;&t; * XXX: Need to be more creative with this (i.e. allow doublecan for&n;&t; * PAL/NTSC output).&n;&t; */
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_DOUBLE
op_logical_and
id|video_output
op_eq
id|VO_VGA
)paren
id|par-&gt;is_doublescan
op_assign
l_int|1
suffix:semicolon
id|par-&gt;hsync_total
op_assign
id|var-&gt;left_margin
op_plus
id|var-&gt;xres
op_plus
id|var-&gt;right_margin
op_plus
id|var-&gt;hsync_len
suffix:semicolon
id|par-&gt;vsync_total
op_assign
id|var-&gt;upper_margin
op_plus
id|var-&gt;yres
op_plus
id|var-&gt;lower_margin
op_plus
id|var-&gt;vsync_len
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_BROADCAST
)paren
(brace
id|vtotal
op_assign
id|par-&gt;vsync_total
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;is_interlaced
)paren
id|vtotal
op_div_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|vtotal
OG
(paren
id|PAL_VTOTAL
op_plus
id|NTSC_VTOTAL
)paren
op_div
l_int|2
)paren
(brace
multiline_comment|/* XXX: Check for start values here... */
multiline_comment|/* XXX: Check hardware for PAL-compatibility */
id|par-&gt;borderstart_h
op_assign
l_int|116
suffix:semicolon
id|par-&gt;borderstart_v
op_assign
l_int|44
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* NTSC video output */
id|par-&gt;borderstart_h
op_assign
l_int|126
suffix:semicolon
id|par-&gt;borderstart_v
op_assign
l_int|18
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* VGA mode */
multiline_comment|/* XXX: What else needs to be checked? */
multiline_comment|/* &n;&t;&t; * XXX: We have a little freedom in VGA modes, what ranges&n;&t;&t; * should be here (i.e. hsync/vsync totals, etc.)?&n;&t;&t; */
id|par-&gt;borderstart_h
op_assign
l_int|126
suffix:semicolon
id|par-&gt;borderstart_v
op_assign
l_int|40
suffix:semicolon
)brace
multiline_comment|/* Calculate the remainding offsets */
id|par-&gt;diwstart_h
op_assign
id|par-&gt;borderstart_h
op_plus
id|var-&gt;left_margin
suffix:semicolon
id|par-&gt;diwstart_v
op_assign
id|par-&gt;borderstart_v
op_plus
id|var-&gt;upper_margin
suffix:semicolon
id|par-&gt;borderstop_h
op_assign
id|par-&gt;diwstart_h
op_plus
id|var-&gt;xres
op_plus
id|var-&gt;right_margin
suffix:semicolon
id|par-&gt;borderstop_v
op_assign
id|par-&gt;diwstart_v
op_plus
id|var-&gt;yres
op_plus
id|var-&gt;lower_margin
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|par-&gt;is_interlaced
)paren
id|par-&gt;borderstop_v
op_div_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.xres
OL
l_int|640
)paren
id|par-&gt;is_lowres
op_assign
l_int|1
suffix:semicolon
id|line_length
op_assign
id|get_line_length
c_func
(paren
id|var-&gt;xres_virtual
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|par-&gt;disp_start
op_assign
id|videomemory
op_plus
(paren
id|line_length
op_star
id|var-&gt;yoffset
)paren
op_star
id|line_length
suffix:semicolon
id|info-&gt;fix.line_length
op_assign
id|line_length
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2fb_check_var
r_static
r_int
id|pvr2fb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|u_short
id|vtotal
comma
id|hsync_total
suffix:semicolon
id|u_long
id|line_length
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;pixclock
op_ne
id|TV_CLK
op_logical_or
id|var-&gt;pixclock
op_ne
id|VGA_CLK
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Invalid pixclock value %d&bslash;n&quot;
comma
id|var-&gt;pixclock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|var-&gt;xres
OL
l_int|320
)paren
id|var-&gt;xres
op_assign
l_int|320
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres
OL
l_int|240
)paren
id|var-&gt;yres
op_assign
l_int|240
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xres_virtual
OL
id|var-&gt;xres
)paren
id|var-&gt;xres_virtual
op_assign
id|var-&gt;xres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres_virtual
OL
id|var-&gt;yres
)paren
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_le
l_int|16
)paren
id|var-&gt;bits_per_pixel
op_assign
l_int|16
suffix:semicolon
r_else
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_le
l_int|24
)paren
id|var-&gt;bits_per_pixel
op_assign
l_int|24
suffix:semicolon
r_else
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_le
l_int|32
)paren
id|var-&gt;bits_per_pixel
op_assign
l_int|32
suffix:semicolon
id|set_color_bitfields
c_func
(paren
id|var
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;xoffset
op_logical_or
id|var-&gt;yoffset
OL
l_int|0
op_logical_or
id|var-&gt;yoffset
op_ge
id|var-&gt;yres_virtual
)paren
(brace
id|var-&gt;xoffset
op_assign
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|var-&gt;xoffset
OG
id|var-&gt;xres_virtual
op_minus
id|var-&gt;xres
op_logical_or
id|var-&gt;yoffset
OG
id|var-&gt;yres_virtual
op_minus
id|var-&gt;yres
op_logical_or
id|var-&gt;xoffset
OL
l_int|0
op_logical_or
id|var-&gt;yoffset
OL
l_int|0
)paren
id|var-&gt;xoffset
op_assign
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|var-&gt;xoffset
op_assign
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * XXX: Need to be more creative with this (i.e. allow doublecan for&n;&t; * PAL/NTSC output).&n;&t; */
r_if
c_cond
(paren
id|var-&gt;yres
OL
l_int|480
op_logical_and
id|video_output
op_eq
id|VO_VGA
)paren
id|var-&gt;vmode
op_assign
id|FB_VMODE_DOUBLE
suffix:semicolon
r_if
c_cond
(paren
id|video_output
op_ne
id|VO_VGA
)paren
id|var-&gt;sync
op_assign
id|FB_SYNC_BROADCAST
op_or
id|FB_VMODE_INTERLACED
suffix:semicolon
id|hsync_total
op_assign
id|var-&gt;left_margin
op_plus
id|var-&gt;xres
op_plus
id|var-&gt;right_margin
op_plus
id|var-&gt;hsync_len
suffix:semicolon
id|vtotal
op_assign
id|var-&gt;upper_margin
op_plus
id|var-&gt;yres
op_plus
id|var-&gt;lower_margin
op_plus
id|var-&gt;vsync_len
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_BROADCAST
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
id|vtotal
op_div_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|vtotal
OG
(paren
id|PAL_VTOTAL
op_plus
id|NTSC_VTOTAL
)paren
op_div
l_int|2
)paren
(brace
multiline_comment|/* PAL video output */
multiline_comment|/* XXX: Should be using a range here ... ? */
r_if
c_cond
(paren
id|hsync_total
op_ne
id|PAL_HTOTAL
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;invalid hsync total for PAL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* NTSC video output */
r_if
c_cond
(paren
id|hsync_total
op_ne
id|NTSC_HTOTAL
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;invalid hsync total for NTSC&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Check memory sizes */
id|line_length
op_assign
id|get_line_length
c_func
(paren
id|var-&gt;xres_virtual
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|line_length
op_star
id|var-&gt;yres_virtual
OG
id|videomemorysize
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2_update_display
r_static
r_void
id|pvr2_update_display
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|pvr2fb_par
op_star
id|par
op_assign
(paren
r_struct
id|pvr2fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|info-&gt;var
suffix:semicolon
multiline_comment|/* Update the start address of the display image */
id|ctrl_outl
c_func
(paren
id|par-&gt;disp_start
comma
id|DISP_DIWADDRL
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
id|par-&gt;disp_start
op_plus
id|get_line_length
c_func
(paren
id|var-&gt;xoffset
op_plus
id|var-&gt;xres
comma
id|var-&gt;bits_per_pixel
)paren
comma
id|DISP_DIWADDRS
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Initialize the video mode.  Currently, the 16bpp and 24bpp modes aren&squot;t&n; * very stable.  It&squot;s probably due to the fact that a lot of the 2D video&n; * registers are still undocumented.&n; */
DECL|function|pvr2_init_display
r_static
r_void
id|pvr2_init_display
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|pvr2fb_par
op_star
id|par
op_assign
(paren
r_struct
id|pvr2fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|info-&gt;var
suffix:semicolon
id|u_short
id|diw_height
comma
id|diw_width
comma
id|diw_modulo
op_assign
l_int|1
suffix:semicolon
id|u_short
id|bytesperpixel
op_assign
id|var-&gt;bits_per_pixel
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* hsync and vsync totals */
id|ctrl_outl
c_func
(paren
(paren
id|par-&gt;vsync_total
op_lshift
l_int|16
)paren
op_or
id|par-&gt;hsync_total
comma
id|DISP_SYNCSIZE
)paren
suffix:semicolon
multiline_comment|/* column height, modulo, row width */
multiline_comment|/* since we&squot;re &quot;panning&quot; within vram, we need to offset things based&n;&t; * on the offset from the virtual x start to our real gfx. */
r_if
c_cond
(paren
id|video_output
op_ne
id|VO_VGA
op_logical_and
id|par-&gt;is_interlaced
)paren
id|diw_modulo
op_add_assign
id|info-&gt;fix.line_length
op_div
l_int|4
suffix:semicolon
id|diw_height
op_assign
(paren
id|par-&gt;is_interlaced
ques
c_cond
id|var-&gt;yres
op_div
l_int|2
suffix:colon
id|var-&gt;yres
)paren
suffix:semicolon
id|diw_width
op_assign
id|get_line_length
c_func
(paren
id|var-&gt;xres
comma
id|var-&gt;bits_per_pixel
)paren
op_div
l_int|4
suffix:semicolon
id|ctrl_outl
c_func
(paren
(paren
id|diw_modulo
op_lshift
l_int|20
)paren
op_or
(paren
op_decrement
id|diw_height
op_lshift
l_int|10
)paren
op_or
op_decrement
id|diw_width
comma
id|DISP_DIWSIZE
)paren
suffix:semicolon
multiline_comment|/* display address, long and short fields */
id|ctrl_outl
c_func
(paren
id|par-&gt;disp_start
comma
id|DISP_DIWADDRL
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
id|par-&gt;disp_start
op_plus
id|get_line_length
c_func
(paren
id|var-&gt;xoffset
op_plus
id|var-&gt;xres
comma
id|var-&gt;bits_per_pixel
)paren
comma
id|DISP_DIWADDRS
)paren
suffix:semicolon
multiline_comment|/* border horizontal, border vertical, border color */
id|ctrl_outl
c_func
(paren
(paren
id|par-&gt;borderstart_h
op_lshift
l_int|16
)paren
op_or
id|par-&gt;borderstop_h
comma
id|DISP_BRDRHORZ
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
(paren
id|par-&gt;borderstart_v
op_lshift
l_int|16
)paren
op_or
id|par-&gt;borderstop_v
comma
id|DISP_BRDRVERT
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
l_int|0
comma
id|DISP_BRDRCOLR
)paren
suffix:semicolon
multiline_comment|/* display window start position */
id|ctrl_outl
c_func
(paren
id|par-&gt;diwstart_h
comma
id|DISP_DIWHSTRT
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
(paren
id|par-&gt;diwstart_v
op_lshift
l_int|16
)paren
op_or
id|par-&gt;diwstart_v
comma
id|DISP_DIWVSTRT
)paren
suffix:semicolon
multiline_comment|/* misc. settings */
id|ctrl_outl
c_func
(paren
(paren
l_int|0x16
op_lshift
l_int|16
)paren
op_or
id|par-&gt;is_lowres
comma
id|DISP_DIWCONF
)paren
suffix:semicolon
multiline_comment|/* clock doubler (for VGA), scan doubler, display enable */
id|ctrl_outl
c_func
(paren
(paren
(paren
id|video_output
op_eq
id|VO_VGA
)paren
op_lshift
l_int|23
)paren
op_or
(paren
id|par-&gt;is_doublescan
op_lshift
l_int|1
)paren
op_or
l_int|1
comma
id|DISP_DIWMODE
)paren
suffix:semicolon
multiline_comment|/* bits per pixel */
id|ctrl_outl
c_func
(paren
id|ctrl_inl
c_func
(paren
id|DISP_DIWMODE
)paren
op_or
(paren
op_decrement
id|bytesperpixel
op_lshift
l_int|2
)paren
comma
id|DISP_DIWMODE
)paren
suffix:semicolon
multiline_comment|/* video enable, color sync, interlace, &n;&t; * hsync and vsync polarity (currently unused) */
id|ctrl_outl
c_func
(paren
l_int|0x100
op_or
(paren
(paren
id|par-&gt;is_interlaced
multiline_comment|/*|4*/
)paren
op_lshift
l_int|4
)paren
comma
id|DISP_SYNCCONF
)paren
suffix:semicolon
)brace
multiline_comment|/* Simulate blanking by making the border cover the entire screen */
DECL|macro|BLANK_BIT
mdefine_line|#define BLANK_BIT (1&lt;&lt;3)
DECL|function|pvr2_do_blank
r_static
r_void
id|pvr2_do_blank
c_func
(paren
r_void
)paren
(brace
id|u_long
id|diwconf
suffix:semicolon
id|diwconf
op_assign
id|ctrl_inl
c_func
(paren
id|DISP_DIWCONF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_blank
OG
l_int|0
)paren
id|ctrl_outl
c_func
(paren
id|diwconf
op_or
id|BLANK_BIT
comma
id|DISP_DIWCONF
)paren
suffix:semicolon
r_else
id|ctrl_outl
c_func
(paren
id|diwconf
op_amp
op_complement
id|BLANK_BIT
comma
id|DISP_DIWCONF
)paren
suffix:semicolon
id|is_blanked
op_assign
id|do_blank
OG
l_int|0
ques
c_cond
id|do_blank
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2fb_interrupt
r_static
id|irqreturn_t
id|pvr2fb_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|dev_id
suffix:semicolon
r_if
c_cond
(paren
id|do_vmode_pan
op_logical_or
id|do_vmode_full
)paren
id|pvr2_update_display
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_vmode_full
)paren
id|pvr2_init_display
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_vmode_pan
)paren
id|do_vmode_pan
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|do_vmode_full
)paren
id|do_vmode_full
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|do_blank
)paren
(brace
id|pvr2_do_blank
c_func
(paren
)paren
suffix:semicolon
id|do_blank
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * Determine the cable type and initialize the cable output format.  Don&squot;t do&n; * anything if the cable type has been overidden (via &quot;cable:XX&quot;).&n; */
DECL|macro|PCTRA
mdefine_line|#define PCTRA 0xff80002c
DECL|macro|PDTRA
mdefine_line|#define PDTRA 0xff800030
DECL|macro|VOUTC
mdefine_line|#define VOUTC 0xa0702c00
DECL|function|pvr2_init_cable
r_static
r_int
id|pvr2_init_cable
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|cable_type
OL
l_int|0
)paren
(brace
id|ctrl_outl
c_func
(paren
(paren
id|ctrl_inl
c_func
(paren
id|PCTRA
)paren
op_amp
l_int|0xfff0ffff
)paren
op_or
l_int|0x000a0000
comma
id|PCTRA
)paren
suffix:semicolon
id|cable_type
op_assign
(paren
id|ctrl_inw
c_func
(paren
id|PDTRA
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|3
suffix:semicolon
)brace
multiline_comment|/* Now select the output format (either composite or other) */
multiline_comment|/* XXX: Save the previous val first, as this reg is also AICA&n;&t;  related */
r_if
c_cond
(paren
id|cable_type
op_eq
id|CT_COMPOSITE
)paren
id|ctrl_outl
c_func
(paren
l_int|3
op_lshift
l_int|8
comma
id|VOUTC
)paren
suffix:semicolon
r_else
id|ctrl_outl
c_func
(paren
l_int|0
comma
id|VOUTC
)paren
suffix:semicolon
r_return
id|cable_type
suffix:semicolon
)brace
DECL|function|pvr2fb_init
r_int
id|__init
id|pvr2fb_init
c_func
(paren
r_void
)paren
(brace
id|u_long
id|modememused
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mach_is_dreamcast
c_func
(paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|fb_info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|fb_info
)paren
op_plus
r_sizeof
(paren
r_struct
id|pvr2fb_par
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
op_star
l_int|16
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_info
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to allocate memory for fb_info&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|fb_info
comma
l_int|0
comma
r_sizeof
(paren
id|fb_info
)paren
op_plus
r_sizeof
(paren
r_struct
id|pvr2fb_par
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
op_star
l_int|16
)paren
suffix:semicolon
id|currentpar
op_assign
(paren
r_struct
id|pvr2fb_par
op_star
)paren
(paren
id|fb_info
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Make a guess at the monitor based on the attached cable */
r_if
c_cond
(paren
id|pvr2_init_cable
c_func
(paren
)paren
op_eq
id|CT_VGA
)paren
(brace
id|fb_info-&gt;monspecs.hfmin
op_assign
l_int|30000
suffix:semicolon
id|fb_info-&gt;monspecs.hfmax
op_assign
l_int|70000
suffix:semicolon
id|fb_info-&gt;monspecs.vfmin
op_assign
l_int|60
suffix:semicolon
id|fb_info-&gt;monspecs.vfmax
op_assign
l_int|60
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Not VGA, using a TV (taken from acornfb) */
id|fb_info-&gt;monspecs.hfmin
op_assign
l_int|15469
suffix:semicolon
id|fb_info-&gt;monspecs.hfmax
op_assign
l_int|15781
suffix:semicolon
id|fb_info-&gt;monspecs.vfmin
op_assign
l_int|49
suffix:semicolon
id|fb_info-&gt;monspecs.vfmax
op_assign
l_int|51
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * XXX: This needs to pull default video output via BIOS or other means&n;&t; */
r_if
c_cond
(paren
id|video_output
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cable_type
op_eq
id|CT_VGA
)paren
(brace
id|video_output
op_assign
id|VO_VGA
suffix:semicolon
)brace
r_else
(brace
id|video_output
op_assign
id|VO_NTSC
suffix:semicolon
)brace
)brace
id|pvr2_fix.smem_start
op_assign
id|videomemory
suffix:semicolon
id|pvr2_fix.smem_len
op_assign
id|videomemorysize
suffix:semicolon
id|fb_info-&gt;screen_base
op_assign
id|ioremap_nocache
c_func
(paren
id|pvr2_fix.smem_start
comma
id|pvr2_fix.smem_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_info-&gt;screen_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to remap MMIO space&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|memset_io
c_func
(paren
(paren
r_int
r_int
)paren
id|fb_info-&gt;screen_base
comma
l_int|0
comma
id|pvr2_fix.smem_len
)paren
suffix:semicolon
id|pvr2_fix.ypanstep
op_assign
id|nopan
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|pvr2_fix.ywrapstep
op_assign
id|nowrap
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|fb_info-&gt;fbops
op_assign
op_amp
id|pvr2fb_ops
suffix:semicolon
id|fb_info-&gt;fix
op_assign
id|pvr2_fix
suffix:semicolon
id|fb_info-&gt;par
op_assign
id|currentpar
suffix:semicolon
id|fb_info-&gt;pseudo_palette
op_assign
(paren
r_void
op_star
)paren
(paren
id|fb_info-&gt;par
op_plus
l_int|1
)paren
suffix:semicolon
id|fb_info-&gt;flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
r_if
c_cond
(paren
id|video_output
op_eq
id|VO_VGA
)paren
id|defmode
op_assign
id|DEFMODE_VGA
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mode_option
)paren
id|mode_option
op_assign
l_string|&quot;640x480@60&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_find_mode
c_func
(paren
op_amp
id|fb_info-&gt;var
comma
id|fb_info
comma
id|mode_option
comma
id|pvr2_modedb
comma
id|NUM_TOTAL_MODES
comma
op_amp
id|pvr2_modedb
(braket
id|defmode
)braket
comma
l_int|16
)paren
)paren
id|fb_info-&gt;var
op_assign
id|pvr2_var
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|HW_EVENT_VSYNC
comma
id|pvr2fb_interrupt
comma
l_int|0
comma
l_string|&quot;pvr2 VBL handler&quot;
comma
id|fb_info
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
id|fb_info
)paren
OL
l_int|0
)paren
r_goto
id|reg_failed
suffix:semicolon
id|modememused
op_assign
id|get_line_length
c_func
(paren
id|fb_info-&gt;var.xres_virtual
comma
id|fb_info-&gt;var.bits_per_pixel
)paren
suffix:semicolon
id|modememused
op_mul_assign
id|fb_info-&gt;var.yres_virtual
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fb%d: %s frame buffer device, using %ldk/%ldk of video memory&bslash;n&quot;
comma
id|fb_info-&gt;node
comma
id|fb_info-&gt;fix.id
comma
id|modememused
op_rshift
l_int|10
comma
id|videomemorysize
op_rshift
l_int|10
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fb%d: Mode %dx%d-%d pitch = %ld cable: %s video output: %s&bslash;n&quot;
comma
id|fb_info-&gt;node
comma
id|fb_info-&gt;var.xres
comma
id|fb_info-&gt;var.yres
comma
id|fb_info-&gt;var.bits_per_pixel
comma
id|get_line_length
c_func
(paren
id|fb_info-&gt;var.xres
comma
id|fb_info-&gt;var.bits_per_pixel
)paren
comma
(paren
r_char
op_star
)paren
id|pvr2_get_param
c_func
(paren
id|cables
comma
l_int|NULL
comma
id|cable_type
comma
l_int|3
)paren
comma
(paren
r_char
op_star
)paren
id|pvr2_get_param
c_func
(paren
id|outputs
comma
l_int|NULL
comma
id|video_output
comma
l_int|3
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|reg_failed
suffix:colon
id|free_irq
c_func
(paren
id|HW_EVENT_VSYNC
comma
l_int|0
)paren
suffix:semicolon
id|out_err
suffix:colon
id|kfree
c_func
(paren
id|fb_info
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|pvr2fb_exit
r_static
r_void
id|__exit
id|pvr2fb_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_framebuffer
c_func
(paren
id|fb_info
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|HW_EVENT_VSYNC
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fb_info
)paren
suffix:semicolon
)brace
DECL|function|pvr2_get_param
r_static
r_int
id|__init
id|pvr2_get_param
c_func
(paren
r_const
r_struct
id|pvr2_params
op_star
id|p
comma
r_const
r_char
op_star
id|s
comma
r_int
id|val
comma
r_int
id|size
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|s
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|p
(braket
id|i
)braket
dot
id|name
comma
id|s
comma
id|strlen
c_func
(paren
id|s
)paren
)paren
)paren
r_return
id|p
(braket
id|i
)braket
dot
id|val
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|p
(braket
id|i
)braket
dot
id|val
op_eq
id|val
)paren
r_return
(paren
r_int
)paren
id|p
(braket
id|i
)braket
dot
id|name
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Parse command arguments.  Supported arguments are:&n; *    inverse                             Use inverse color maps&n; *    nomtrr                              Disable MTRR usage&n; *    cable:composite|rgb|vga             Override the video cable type&n; *    output:NTSC|PAL|VGA                 Override the video output format&n; *&n; *    &lt;xres&gt;x&lt;yres&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]   or,&n; *    &lt;name&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]          Startup using this video mode&n; */
macro_line|#ifndef MODULE
DECL|function|pvr2fb_setup
r_int
id|__init
id|pvr2fb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_char
id|cable_arg
(braket
l_int|80
)braket
suffix:semicolon
r_char
id|output_arg
(braket
l_int|80
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;inverse&quot;
)paren
)paren
(brace
id|pvr2fb_inverse
op_assign
l_int|1
suffix:semicolon
id|fb_invert_cmaps
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;cable:&quot;
comma
l_int|6
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|cable_arg
comma
id|this_opt
op_plus
l_int|6
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;output:&quot;
comma
l_int|7
)paren
)paren
(brace
id|strcpy
c_func
(paren
id|output_arg
comma
id|this_opt
op_plus
l_int|7
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;nopan&quot;
comma
l_int|5
)paren
)paren
(brace
id|nopan
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;nowrap&quot;
comma
l_int|6
)paren
)paren
(brace
id|nowrap
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|mode_option
op_assign
id|this_opt
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_star
id|cable_arg
)paren
id|cable_type
op_assign
id|pvr2_get_param
c_func
(paren
id|cables
comma
id|cable_arg
comma
l_int|0
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|output_arg
)paren
id|video_output
op_assign
id|pvr2_get_param
c_func
(paren
id|outputs
comma
id|output_arg
comma
l_int|0
comma
l_int|3
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef MODULE
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|pvr2fb_init
id|module_init
c_func
(paren
id|pvr2fb_init
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|pvr2fb_exit
id|module_exit
c_func
(paren
id|pvr2fb_exit
)paren
suffix:semicolon
eof
