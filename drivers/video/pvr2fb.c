multiline_comment|/* drivers/video/pvr2fb.c&n; *&n; * Frame buffer and fbcon support for the NEC PowerVR2 found within the Sega&n; * Dreamcast.&n; *&n; * Copyright (c) 2001 M. R. Brown &lt;mrbrown@0xd6.org&gt;&n; * Copyright (c) 2001 Paul Mundt  &lt;lethal@chaoticdreams.org&gt;&n; *&n; * This file is part of the LinuxDC project (linuxdc.sourceforge.net).&n; *&n; */
multiline_comment|/*&n; * This driver is mostly based on the excellent amifb and vfb sources.  It uses&n; * an odd scheme for converting hardware values to/from framebuffer values, here are&n; * some hacked-up formulas:&n; *&n; *  The Dreamcast has screen offsets from each side of it&squot;s four borders and the start&n; *  offsets of the display window.  I used these values to calculate &squot;pseudo&squot; values&n; *  (think of them as placeholders) for the fb video mode, so that when it came time&n; *  to convert these values back into their hardware values, I could just add mode-&n; *  specific offsets to get the correct mode settings:&n; *&n; *      left_margin = diwstart_h - borderstart_h;&n; *      right_margin = borderstop_h - (diwstart_h + xres);&n; *      upper_margin = diwstart_v - borderstart_v;&n; *      lower_margin = borderstop_v - (diwstart_h + yres);&n; *&n; *      hsync_len = borderstart_h + (hsync_total - borderstop_h);&n; *      vsync_len = borderstart_v + (vsync_total - borderstop_v);&n; *&n; *  Then, when it&squot;s time to convert back to hardware settings, the only constants&n; *  are the borderstart_* offsets, all other values are derived from the fb video&n; *  mode:&n; *  &n; *      // PAL&n; *      borderstart_h = 116;&n; *      borderstart_v = 44;&n; *      ...&n; *      borderstop_h = borderstart_h + hsync_total - hsync_len;&n; *      ...&n; *      diwstart_v = borderstart_v - upper_margin;&n; *&n; *  However, in the current implementation, the borderstart values haven&squot;t had&n; *  the benefit of being fully researched, so some modes may be broken.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#ifdef CONFIG_SH_DREAMCAST
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/machvec.h&gt;
macro_line|#include &lt;asm/dc_sysasic.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_MTRR
macro_line|#include &lt;asm/mtrr.h&gt;
macro_line|#endif
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-cfb16.h&gt;
macro_line|#include &lt;video/fbcon-cfb24.h&gt;
macro_line|#include &lt;video/fbcon-cfb32.h&gt;
macro_line|#ifdef CONFIG_FB_PVR2_DEBUG
DECL|macro|DPRINTK
macro_line|#  define DPRINTK(fmt, args...) printk(KERN_DEBUG &quot;%s: &quot; fmt, __FUNCTION__ , ## args)
macro_line|#else
DECL|macro|DPRINTK
macro_line|#  define DPRINTK(fmt, args...)
macro_line|#endif
multiline_comment|/* 2D video registers */
DECL|macro|DISP_BASE
mdefine_line|#define DISP_BASE 0xa05f8000
DECL|macro|DISP_BRDRCOLR
mdefine_line|#define DISP_BRDRCOLR (DISP_BASE + 0x40)
DECL|macro|DISP_DIWMODE
mdefine_line|#define DISP_DIWMODE (DISP_BASE + 0x44)
DECL|macro|DISP_DIWADDRL
mdefine_line|#define DISP_DIWADDRL (DISP_BASE + 0x50)
DECL|macro|DISP_DIWADDRS
mdefine_line|#define DISP_DIWADDRS (DISP_BASE + 0x54)
DECL|macro|DISP_DIWSIZE
mdefine_line|#define DISP_DIWSIZE (DISP_BASE + 0x5c)
DECL|macro|DISP_SYNCCONF
mdefine_line|#define DISP_SYNCCONF (DISP_BASE + 0xd0)
DECL|macro|DISP_BRDRHORZ
mdefine_line|#define DISP_BRDRHORZ (DISP_BASE + 0xd4)
DECL|macro|DISP_SYNCSIZE
mdefine_line|#define DISP_SYNCSIZE (DISP_BASE + 0xd8)
DECL|macro|DISP_BRDRVERT
mdefine_line|#define DISP_BRDRVERT (DISP_BASE + 0xdc)
DECL|macro|DISP_DIWCONF
mdefine_line|#define DISP_DIWCONF (DISP_BASE + 0xe8)
DECL|macro|DISP_DIWHSTRT
mdefine_line|#define DISP_DIWHSTRT (DISP_BASE + 0xec)
DECL|macro|DISP_DIWVSTRT
mdefine_line|#define DISP_DIWVSTRT (DISP_BASE + 0xf0)
multiline_comment|/* Pixel clocks, one for TV output, doubled for VGA output */
DECL|macro|TV_CLK
mdefine_line|#define TV_CLK 74239
DECL|macro|VGA_CLK
mdefine_line|#define VGA_CLK 37119
multiline_comment|/* This is for 60Hz - the VTOTAL is doubled for interlaced modes */
DECL|macro|PAL_HTOTAL
mdefine_line|#define PAL_HTOTAL 863
DECL|macro|PAL_VTOTAL
mdefine_line|#define PAL_VTOTAL 312
DECL|macro|NTSC_HTOTAL
mdefine_line|#define NTSC_HTOTAL 857
DECL|macro|NTSC_VTOTAL
mdefine_line|#define NTSC_VTOTAL 262
DECL|enumerator|CT_VGA
DECL|enumerator|CT_NONE
DECL|enumerator|CT_RGB
DECL|enumerator|CT_COMPOSITE
r_enum
(brace
id|CT_VGA
comma
id|CT_NONE
comma
id|CT_RGB
comma
id|CT_COMPOSITE
)brace
suffix:semicolon
DECL|enumerator|VO_PAL
DECL|enumerator|VO_NTSC
DECL|enumerator|VO_VGA
r_enum
(brace
id|VO_PAL
comma
id|VO_NTSC
comma
id|VO_VGA
)brace
suffix:semicolon
DECL|struct|pvr2_params
DECL|member|val
DECL|member|name
r_struct
id|pvr2_params
(brace
id|u_short
id|val
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|pvr2_params
id|cables
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|CT_VGA
comma
l_string|&quot;VGA&quot;
)brace
comma
(brace
id|CT_RGB
comma
l_string|&quot;RGB&quot;
)brace
comma
(brace
id|CT_COMPOSITE
comma
l_string|&quot;COMPOSITE&quot;
)brace
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|pvr2_params
id|outputs
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|VO_PAL
comma
l_string|&quot;PAL&quot;
)brace
comma
(brace
id|VO_NTSC
comma
l_string|&quot;NTSC&quot;
)brace
comma
(brace
id|VO_VGA
comma
l_string|&quot;VGA&quot;
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * This describes the current video mode&n; */
DECL|struct|pvr2fb_par
r_static
r_struct
id|pvr2fb_par
(brace
DECL|member|xres
r_int
id|xres
suffix:semicolon
DECL|member|yres
r_int
id|yres
suffix:semicolon
DECL|member|vxres
r_int
id|vxres
suffix:semicolon
DECL|member|vyres
r_int
id|vyres
suffix:semicolon
DECL|member|xoffset
r_int
id|xoffset
suffix:semicolon
DECL|member|yoffset
r_int
id|yoffset
suffix:semicolon
DECL|member|bpp
id|u_short
id|bpp
suffix:semicolon
DECL|member|pixclock
id|u_long
id|pixclock
suffix:semicolon
DECL|member|hsync_total
id|u_short
id|hsync_total
suffix:semicolon
multiline_comment|/* Clocks/line */
DECL|member|vsync_total
id|u_short
id|vsync_total
suffix:semicolon
multiline_comment|/* Lines/field */
DECL|member|borderstart_h
id|u_short
id|borderstart_h
suffix:semicolon
DECL|member|borderstop_h
id|u_short
id|borderstop_h
suffix:semicolon
DECL|member|borderstart_v
id|u_short
id|borderstart_v
suffix:semicolon
DECL|member|borderstop_v
id|u_short
id|borderstop_v
suffix:semicolon
DECL|member|diwstart_h
id|u_short
id|diwstart_h
suffix:semicolon
multiline_comment|/* Horizontal offset of the display field */
DECL|member|diwstart_v
id|u_short
id|diwstart_v
suffix:semicolon
multiline_comment|/* Vertical offset of the display field, for&n;&t;&t;&t;&t;   interlaced modes, this is the long field */
DECL|member|disp_start
id|u_long
id|disp_start
suffix:semicolon
multiline_comment|/* Address of image within VRAM */
DECL|member|next_line
id|u_long
id|next_line
suffix:semicolon
multiline_comment|/* Modulo for next line */
DECL|member|is_interlaced
id|u_char
id|is_interlaced
suffix:semicolon
multiline_comment|/* Is the display interlaced? */
DECL|member|is_doublescan
id|u_char
id|is_doublescan
suffix:semicolon
multiline_comment|/* Are scanlines output twice? (doublescan) */
DECL|member|is_lowres
id|u_char
id|is_lowres
suffix:semicolon
multiline_comment|/* Is horizontal pixel-doubling enabled? */
DECL|member|bordercolor
id|u_long
id|bordercolor
suffix:semicolon
multiline_comment|/* RGB888 format border color */
DECL|member|vmode
id|u_long
id|vmode
suffix:semicolon
DECL|variable|currentpar
)brace
id|currentpar
suffix:semicolon
DECL|variable|currbpp
r_static
r_int
id|currbpp
suffix:semicolon
DECL|variable|disp
r_static
r_struct
id|display
id|disp
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|fb_info
id|fb_info
suffix:semicolon
DECL|variable|pvr2fb_inverse
r_static
r_int
id|pvr2fb_inverse
op_assign
l_int|0
suffix:semicolon
DECL|member|red
DECL|member|green
DECL|member|blue
DECL|member|alpha
DECL|variable|palette
r_static
r_struct
(brace
id|u_short
id|red
comma
id|green
comma
id|blue
comma
id|alpha
suffix:semicolon
)brace
id|palette
(braket
l_int|256
)braket
suffix:semicolon
r_static
r_union
(brace
macro_line|#ifdef FBCON_HAS_CFB16
DECL|member|cfb16
id|u16
id|cfb16
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB24
DECL|member|cfb24
id|u32
id|cfb24
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
DECL|member|cfb32
id|u32
id|cfb32
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
DECL|variable|fbcon_cmap
)brace
id|fbcon_cmap
suffix:semicolon
DECL|variable|pvr2fb_name
r_static
r_char
id|pvr2fb_name
(braket
l_int|16
)braket
op_assign
l_string|&quot;NEC PowerVR2&quot;
suffix:semicolon
DECL|macro|VIDEOMEMSIZE
mdefine_line|#define VIDEOMEMSIZE (8*1024*1024)
DECL|variable|videomemory
DECL|variable|videomemorysize
r_static
id|u_long
id|videomemory
op_assign
l_int|0xa5000000
comma
id|videomemorysize
op_assign
id|VIDEOMEMSIZE
suffix:semicolon
DECL|variable|cable_type
r_static
r_int
id|cable_type
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|video_output
r_static
r_int
id|video_output
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_MTRR
DECL|variable|enable_mtrr
r_static
r_int
id|enable_mtrr
op_assign
l_int|1
suffix:semicolon
DECL|variable|mtrr_handle
r_static
r_int
id|mtrr_handle
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * We do all updating, blanking, etc. during the vertical retrace period&n; */
DECL|variable|do_vmode_full
r_static
id|u_short
id|do_vmode_full
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Change the video mode */
DECL|variable|do_vmode_pan
r_static
id|u_short
id|do_vmode_pan
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Update the video mode */
DECL|variable|do_blank
r_static
r_int
id|do_blank
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* (Un)Blank the screen */
DECL|variable|is_blanked
r_static
id|u_short
id|is_blanked
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Is the screen blanked? */
multiline_comment|/* Interface used by the world */
r_int
id|pvr2fb_setup
c_func
(paren
r_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|pvr2fb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|pvr2fb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|pvr2fb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|pvr2fb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|pvr2fb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|pvr2fb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|pvr2fb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Interface to the low level console driver&n;&t; */
r_static
r_int
id|pvr2fbcon_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|pvr2fbcon_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Internal/hardware-specific routines&n;&t; */
r_static
r_void
id|do_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
id|u_long
id|get_line_length
c_func
(paren
r_int
id|xres_virtual
comma
r_int
id|bpp
)paren
suffix:semicolon
r_static
r_void
id|set_color_bitfields
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
suffix:semicolon
r_static
r_int
id|pvr2_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|pvr2_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|pvr2_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|pvr2fb_par
op_star
id|par
)paren
suffix:semicolon
r_static
r_int
id|pvr2_decode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|pvr2fb_par
op_star
id|par
)paren
suffix:semicolon
r_static
r_int
id|pvr2_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|pvr2fb_par
op_star
id|par
)paren
suffix:semicolon
r_static
r_void
id|pvr2_get_par
c_func
(paren
r_struct
id|pvr2fb_par
op_star
id|par
)paren
suffix:semicolon
r_static
r_void
id|pvr2_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
suffix:semicolon
r_static
r_void
id|pvr2_pan_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
suffix:semicolon
r_static
r_int
id|pvr2_update_par
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|pvr2_update_display
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|pvr2_init_display
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|pvr2_do_blank
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|pvr2fb_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
r_static
r_int
id|pvr2_init_cable
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|pvr2_get_param
c_func
(paren
r_const
r_struct
id|pvr2_params
op_star
id|p
comma
r_const
r_char
op_star
id|s
comma
r_int
id|val
comma
r_int
id|size
)paren
suffix:semicolon
DECL|variable|pvr2fb_ops
r_static
r_struct
id|fb_ops
id|pvr2fb_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|fb_get_fix
suffix:colon
id|pvr2fb_get_fix
comma
id|fb_get_var
suffix:colon
id|pvr2fb_get_var
comma
id|fb_set_var
suffix:colon
id|pvr2fb_set_var
comma
id|fb_get_cmap
suffix:colon
id|pvr2fb_get_cmap
comma
id|fb_set_cmap
suffix:colon
id|pvr2fb_set_cmap
comma
id|fb_pan_display
suffix:colon
id|pvr2fb_pan_display
comma
id|fb_blank
suffix:colon
id|pvr2fb_blank
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|fb_videomode
id|pvr2_modedb
(braket
)braket
id|__initdata
op_assign
(brace
multiline_comment|/*&n;     * Broadcast video modes (PAL and NTSC).  I&squot;m unfamiliar with&n;     * PAL-M and PAL-N, but from what I&squot;ve read both modes parallel PAL and&n;     * NTSC, so it shouldn&squot;t be a problem (I hope).&n;     */
(brace
multiline_comment|/* 640x480 @ 60Hz interlaced (NTSC) */
l_string|&quot;ntsc_640x480i&quot;
comma
l_int|60
comma
l_int|640
comma
l_int|480
comma
id|TV_CLK
comma
l_int|38
comma
l_int|33
comma
l_int|0
comma
l_int|18
comma
l_int|146
comma
l_int|26
comma
id|FB_SYNC_BROADCAST
comma
id|FB_VMODE_INTERLACED
op_or
id|FB_VMODE_YWRAP
)brace
comma
(brace
multiline_comment|/* 640x240 @ 60Hz (NTSC) */
multiline_comment|/* XXX: Broken! Don&squot;t use... */
l_string|&quot;ntsc_640x240&quot;
comma
l_int|60
comma
l_int|640
comma
l_int|240
comma
id|TV_CLK
comma
l_int|38
comma
l_int|33
comma
l_int|0
comma
l_int|0
comma
l_int|146
comma
l_int|22
comma
id|FB_SYNC_BROADCAST
comma
id|FB_VMODE_YWRAP
)brace
comma
(brace
multiline_comment|/* 640x480 @ 60hz (VGA) */
l_string|&quot;vga_640x480&quot;
comma
l_int|60
comma
l_int|640
comma
l_int|480
comma
id|VGA_CLK
comma
l_int|38
comma
l_int|33
comma
l_int|0
comma
l_int|18
comma
l_int|146
comma
l_int|26
comma
l_int|0
comma
id|FB_VMODE_YWRAP
)brace
comma
)brace
suffix:semicolon
DECL|macro|NUM_TOTAL_MODES
mdefine_line|#define NUM_TOTAL_MODES  ARRAY_SIZE(pvr2_modedb)
DECL|macro|DEFMODE_NTSC
mdefine_line|#define DEFMODE_NTSC&t;0
DECL|macro|DEFMODE_PAL
mdefine_line|#define DEFMODE_PAL&t;0
DECL|macro|DEFMODE_VGA
mdefine_line|#define DEFMODE_VGA&t;2
DECL|variable|defmode
r_static
r_int
id|defmode
op_assign
id|DEFMODE_NTSC
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
op_star
id|mode_option
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Get the fixed part of the display */
DECL|function|pvr2fb_get_fix
r_static
r_int
id|pvr2fb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|pvr2fb_par
id|par
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
id|pvr2_get_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
r_else
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pvr2_decode_var
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
op_amp
id|par
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
r_return
id|pvr2_encode_fix
c_func
(paren
id|fix
comma
op_amp
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the user-defined part of the display */
DECL|function|pvr2fb_get_var
r_static
r_int
id|pvr2fb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
(brace
r_struct
id|pvr2fb_par
id|par
suffix:semicolon
id|pvr2_get_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
id|err
op_assign
id|pvr2_encode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
suffix:semicolon
)brace
r_else
op_star
id|var
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Set the user-defined part of the display */
DECL|function|pvr2fb_set_var
r_static
r_int
id|pvr2fb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
comma
id|activate
op_assign
id|var-&gt;activate
suffix:semicolon
r_int
id|oldxres
comma
id|oldyres
comma
id|oldvxres
comma
id|oldvyres
comma
id|oldbpp
suffix:semicolon
r_struct
id|pvr2fb_par
id|par
suffix:semicolon
r_struct
id|display
op_star
id|display
suffix:semicolon
r_if
c_cond
(paren
id|con
op_ge
l_int|0
)paren
id|display
op_assign
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
r_else
id|display
op_assign
op_amp
id|disp
suffix:semicolon
multiline_comment|/* used during initialization */
multiline_comment|/*&n;&t; * FB_VMODE_CONUPDATE and FB_VMODE_SMOOTH_XPAN are equal!&n;&t; * as FB_VMODE_SMOOTH_XPAN is only used internally&n;&t; */
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_CONUPDATE
)paren
(brace
id|var-&gt;vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
id|var-&gt;xoffset
op_assign
id|display-&gt;var.xoffset
suffix:semicolon
id|var-&gt;yoffset
op_assign
id|display-&gt;var.yoffset
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pvr2_decode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
id|pvr2_encode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
suffix:semicolon
multiline_comment|/* Do memory check and bitfield set here?? */
r_if
c_cond
(paren
(paren
id|activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_NOW
)paren
(brace
id|oldxres
op_assign
id|display-&gt;var.xres
suffix:semicolon
id|oldyres
op_assign
id|display-&gt;var.yres
suffix:semicolon
id|oldvxres
op_assign
id|display-&gt;var.xres_virtual
suffix:semicolon
id|oldvyres
op_assign
id|display-&gt;var.yres_virtual
suffix:semicolon
id|oldbpp
op_assign
id|display-&gt;var.bits_per_pixel
suffix:semicolon
id|display-&gt;var
op_assign
op_star
id|var
suffix:semicolon
r_if
c_cond
(paren
id|oldxres
op_ne
id|var-&gt;xres
op_logical_or
id|oldyres
op_ne
id|var-&gt;yres
op_logical_or
id|oldvxres
op_ne
id|var-&gt;xres_virtual
op_logical_or
id|oldvyres
op_ne
id|var-&gt;yres_virtual
op_logical_or
id|oldbpp
op_ne
id|var-&gt;bits_per_pixel
)paren
(brace
r_struct
id|fb_fix_screeninfo
id|fix
suffix:semicolon
id|pvr2_encode_fix
c_func
(paren
op_amp
id|fix
comma
op_amp
id|par
)paren
suffix:semicolon
id|display-&gt;screen_base
op_assign
(paren
r_char
op_star
)paren
id|fix.smem_start
suffix:semicolon
id|display-&gt;scrollmode
op_assign
id|SCROLL_YREDRAW
suffix:semicolon
id|display-&gt;visual
op_assign
id|fix.visual
suffix:semicolon
id|display-&gt;type
op_assign
id|fix.type
suffix:semicolon
id|display-&gt;type_aux
op_assign
id|fix.type_aux
suffix:semicolon
id|display-&gt;ypanstep
op_assign
id|fix.ypanstep
suffix:semicolon
id|display-&gt;ywrapstep
op_assign
id|fix.ywrapstep
suffix:semicolon
id|display-&gt;line_length
op_assign
id|fix.line_length
suffix:semicolon
id|display-&gt;can_soft_blank
op_assign
l_int|1
suffix:semicolon
id|display-&gt;inverse
op_assign
id|pvr2fb_inverse
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb16
suffix:semicolon
id|display-&gt;dispsw_data
op_assign
id|fbcon_cmap.cfb16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB24
r_case
l_int|24
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb24
suffix:semicolon
id|display-&gt;dispsw_data
op_assign
id|fbcon_cmap.cfb24
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
r_case
l_int|32
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb32
suffix:semicolon
id|display-&gt;dispsw_data
op_assign
id|fbcon_cmap.cfb32
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fb_info.changevar
)paren
(paren
op_star
id|fb_info.changevar
)paren
(paren
id|con
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|oldbpp
op_ne
id|var-&gt;bits_per_pixel
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|display-&gt;cmap
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
id|do_install_cmap
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_eq
id|info-&gt;currcon
)paren
id|pvr2_set_var
c_func
(paren
op_amp
id|display-&gt;var
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Pan or wrap the display.&n; * This call looks only at xoffset, yoffset and the FB_VMODE_YRAP flag&n; */
DECL|function|pvr2fb_pan_display
r_static
r_int
id|pvr2fb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;yoffset
OL
l_int|0
op_logical_or
id|var-&gt;yoffset
op_ge
id|fb_display
(braket
id|con
)braket
dot
id|var.yres_virtual
op_logical_or
id|var-&gt;xoffset
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|var-&gt;xoffset
op_plus
id|fb_display
(braket
id|con
)braket
dot
id|var.xres
OG
id|fb_display
(braket
id|con
)braket
dot
id|var.xres_virtual
op_logical_or
id|var-&gt;yoffset
op_plus
id|fb_display
(braket
id|con
)braket
dot
id|var.yres
OG
id|fb_display
(braket
id|con
)braket
dot
id|var.yres_virtual
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_eq
id|info-&gt;currcon
)paren
id|pvr2_pan_var
c_func
(paren
id|var
)paren
suffix:semicolon
id|fb_display
(braket
id|con
)braket
dot
id|var.xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|fb_display
(braket
id|con
)braket
dot
id|var.yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
id|fb_display
(braket
id|con
)braket
dot
id|var.vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
r_else
id|fb_display
(braket
id|con
)braket
dot
id|var.vmode
op_and_assign
op_complement
id|FB_VMODE_YWRAP
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Get the colormap */
DECL|function|pvr2fb_get_cmap
r_static
r_int
id|pvr2fb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|info-&gt;currcon
)paren
multiline_comment|/* current console? */
r_return
id|fb_get_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|pvr2_getcolreg
comma
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
multiline_comment|/* non default colormap? */
id|fb_copy_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set the colormap */
DECL|function|pvr2fb_set_cmap
r_static
r_int
id|pvr2fb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
(brace
multiline_comment|/* no colormap allocated? */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
comma
l_int|0
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_eq
id|info-&gt;currcon
)paren
multiline_comment|/* current console? */
r_return
id|fb_set_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|pvr2_setcolreg
comma
id|info
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|cmap
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2fbcon_switch
r_static
r_int
id|pvr2fbcon_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* Do we have to save the colormap? */
r_if
c_cond
(paren
id|fb_display
(braket
id|info-&gt;currcon
)braket
dot
id|cmap.len
)paren
id|fb_get_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|info-&gt;currcon
)braket
dot
id|cmap
comma
l_int|1
comma
id|pvr2_getcolreg
comma
id|info
)paren
suffix:semicolon
id|info-&gt;currcon
op_assign
id|con
suffix:semicolon
id|pvr2_set_var
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
)paren
suffix:semicolon
multiline_comment|/* Install new colormap */
id|do_install_cmap
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2fbcon_updatevar
r_static
r_int
id|pvr2fbcon_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|pvr2_pan_var
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2fb_blank
r_static
r_int
id|pvr2fb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|do_blank
op_assign
id|blank
ques
c_cond
id|blank
suffix:colon
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Setup the colormap */
DECL|function|do_install_cmap
r_static
r_void
id|do_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_ne
id|info-&gt;currcon
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|fb_set_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
l_int|1
comma
id|pvr2_setcolreg
comma
id|info
)paren
suffix:semicolon
r_else
id|fb_set_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
l_int|1
comma
id|pvr2_setcolreg
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|get_line_length
r_static
r_inline
id|u_long
id|get_line_length
c_func
(paren
r_int
id|xres_virtual
comma
r_int
id|bpp
)paren
(brace
r_return
(paren
id|u_long
)paren
(paren
(paren
(paren
(paren
id|xres_virtual
op_star
id|bpp
)paren
op_plus
l_int|31
)paren
op_amp
op_complement
l_int|31
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
)brace
DECL|function|set_color_bitfields
r_static
r_void
id|set_color_bitfields
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|16
suffix:colon
multiline_comment|/* RGB 565 */
id|var-&gt;red.offset
op_assign
l_int|11
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
multiline_comment|/* RGB 888 */
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
multiline_comment|/* ARGB 8888 */
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|24
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|pvr2_getcolreg
r_static
r_int
id|pvr2_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
op_star
id|red
op_assign
id|palette
(braket
id|regno
)braket
dot
id|red
suffix:semicolon
op_star
id|green
op_assign
id|palette
(braket
id|regno
)braket
dot
id|green
suffix:semicolon
op_star
id|blue
op_assign
id|palette
(braket
id|regno
)braket
dot
id|blue
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2_setcolreg
r_static
r_int
id|pvr2_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
r_if
c_cond
(paren
id|regno
OL
l_int|16
)paren
(brace
r_switch
c_cond
(paren
id|currbpp
)paren
(brace
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
multiline_comment|/* RGB 565 */
id|fbcon_cmap.cfb16
(braket
id|regno
)braket
op_assign
(paren
id|red
op_amp
l_int|0xf800
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xfc00
)paren
op_rshift
l_int|5
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xf800
)paren
op_rshift
l_int|11
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB24
r_case
l_int|24
suffix:colon
multiline_comment|/* RGB 888 */
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|fbcon_cmap.cfb24
(braket
id|regno
)braket
op_assign
(paren
id|red
op_lshift
l_int|16
)paren
op_or
(paren
id|green
op_lshift
l_int|8
)paren
op_or
id|blue
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
r_case
l_int|32
suffix:colon
multiline_comment|/* ARGB 8888 */
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|fbcon_cmap.cfb32
(braket
id|regno
)braket
op_assign
(paren
id|red
op_lshift
l_int|16
)paren
op_or
(paren
id|green
op_lshift
l_int|8
)paren
op_or
id|blue
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Invalid bit depth %d?!?&bslash;n&quot;
comma
id|currbpp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2_encode_fix
r_static
r_int
id|pvr2_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|pvr2fb_par
op_star
id|par
)paren
(brace
id|memset
c_func
(paren
id|fix
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_fix_screeninfo
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
id|pvr2fb_name
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
id|videomemory
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|videomemorysize
suffix:semicolon
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
(brace
id|fix-&gt;ywrapstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
id|fix-&gt;ypanstep
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|fix-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|1
suffix:semicolon
)brace
id|fix-&gt;line_length
op_assign
id|par-&gt;next_line
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Create a hardware video mode using the framebuffer values.  If a value needs&n; * to be clipped or constrained it&squot;s done here.  This routine needs a bit more&n; * work to make sure we&squot;re doing the right tests at the right time.&n; */
DECL|function|pvr2_decode_var
r_static
r_int
id|pvr2_decode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|pvr2fb_par
op_star
id|par
)paren
(brace
id|u_long
id|line_length
suffix:semicolon
id|u_short
id|vtotal
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;pixclock
op_ne
id|TV_CLK
op_logical_and
id|var-&gt;pixclock
op_ne
id|VGA_CLK
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Invalid pixclock value %d&bslash;n&quot;
comma
id|var-&gt;pixclock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|par-&gt;pixclock
op_assign
id|var-&gt;pixclock
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par-&gt;xres
op_assign
id|var-&gt;xres
)paren
OL
l_int|320
)paren
id|par-&gt;xres
op_assign
l_int|320
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par-&gt;yres
op_assign
id|var-&gt;yres
)paren
OL
l_int|240
)paren
id|par-&gt;yres
op_assign
l_int|240
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par-&gt;vxres
op_assign
id|var-&gt;xres_virtual
)paren
OL
id|par-&gt;xres
)paren
id|par-&gt;vxres
op_assign
id|par-&gt;xres
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par-&gt;vyres
op_assign
id|var-&gt;yres_virtual
)paren
OL
id|par-&gt;yres
)paren
id|par-&gt;vyres
op_assign
id|par-&gt;yres
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par-&gt;bpp
op_assign
id|var-&gt;bits_per_pixel
)paren
op_le
l_int|16
)paren
id|par-&gt;bpp
op_assign
l_int|16
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|par-&gt;bpp
op_assign
id|var-&gt;bits_per_pixel
)paren
op_le
l_int|24
)paren
id|par-&gt;bpp
op_assign
l_int|24
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|par-&gt;bpp
op_assign
id|var-&gt;bits_per_pixel
)paren
op_le
l_int|32
)paren
id|par-&gt;bpp
op_assign
l_int|32
suffix:semicolon
id|currbpp
op_assign
id|par-&gt;bpp
suffix:semicolon
multiline_comment|/*&n;&t; * XXX: It&squot;s possible that a user could use a VGA box, change the cable&n;&t; * type in hardware (i.e. switch from VGA&lt;-&gt;composite), then change modes&n;&t; * (i.e. switching to another VT).  If that happens we should automagically&n;&t; * change the output format to cope, but currently I don&squot;t have a VGA box&n;&t; * to make sure this works properly.&n;&t; */
id|cable_type
op_assign
id|pvr2_init_cable
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cable_type
op_eq
id|CT_VGA
op_logical_and
id|video_output
op_ne
id|VO_VGA
)paren
id|video_output
op_assign
id|VO_VGA
suffix:semicolon
id|par-&gt;vmode
op_assign
id|var-&gt;vmode
op_amp
id|FB_VMODE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
op_logical_and
id|video_output
op_ne
id|VO_VGA
)paren
id|par-&gt;is_interlaced
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* &n;&t; * XXX: Need to be more creative with this (i.e. allow doublecan for&n;&t; * PAL/NTSC output).&n;&t; */
id|par-&gt;is_doublescan
op_assign
(paren
id|par-&gt;yres
OL
l_int|480
op_logical_and
id|video_output
op_eq
id|VO_VGA
)paren
suffix:semicolon
id|par-&gt;hsync_total
op_assign
id|var-&gt;left_margin
op_plus
id|var-&gt;xres
op_plus
id|var-&gt;right_margin
op_plus
id|var-&gt;hsync_len
suffix:semicolon
id|par-&gt;vsync_total
op_assign
id|var-&gt;upper_margin
op_plus
id|var-&gt;yres
op_plus
id|var-&gt;lower_margin
op_plus
id|var-&gt;vsync_len
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_BROADCAST
)paren
(brace
id|vtotal
op_assign
id|par-&gt;vsync_total
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;is_interlaced
)paren
id|vtotal
op_div_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|vtotal
OG
(paren
id|PAL_VTOTAL
op_plus
id|NTSC_VTOTAL
)paren
op_div
l_int|2
)paren
(brace
multiline_comment|/* PAL video output */
multiline_comment|/* XXX: Should be using a range here ... ? */
r_if
c_cond
(paren
id|par-&gt;hsync_total
op_ne
id|PAL_HTOTAL
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;invalid hsync total for PAL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* XXX: Check for start values here... */
multiline_comment|/* XXX: Check hardware for PAL-compatibility */
id|par-&gt;borderstart_h
op_assign
l_int|116
suffix:semicolon
id|par-&gt;borderstart_v
op_assign
l_int|44
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* NTSC video output */
r_if
c_cond
(paren
id|par-&gt;hsync_total
op_ne
id|NTSC_HTOTAL
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;invalid hsync total for NTSC&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|par-&gt;borderstart_h
op_assign
l_int|126
suffix:semicolon
id|par-&gt;borderstart_v
op_assign
l_int|18
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* VGA mode */
multiline_comment|/* XXX: What else needs to be checked? */
multiline_comment|/* &n;&t;&t; * XXX: We have a little freedom in VGA modes, what ranges should&n;&t;&t; * be here (i.e. hsync/vsync totals, etc.)?&n;&t;&t; */
id|par-&gt;borderstart_h
op_assign
l_int|126
suffix:semicolon
id|par-&gt;borderstart_v
op_assign
l_int|40
suffix:semicolon
)brace
multiline_comment|/* Calculate the remainding offsets */
id|par-&gt;borderstop_h
op_assign
id|par-&gt;borderstart_h
op_plus
id|par-&gt;hsync_total
op_minus
id|var-&gt;hsync_len
suffix:semicolon
id|par-&gt;borderstop_v
op_assign
id|par-&gt;borderstart_v
op_plus
id|par-&gt;vsync_total
op_minus
id|var-&gt;vsync_len
suffix:semicolon
id|par-&gt;diwstart_h
op_assign
id|par-&gt;borderstart_h
op_plus
id|var-&gt;left_margin
suffix:semicolon
id|par-&gt;diwstart_v
op_assign
id|par-&gt;borderstart_v
op_plus
id|var-&gt;upper_margin
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|par-&gt;is_interlaced
)paren
id|par-&gt;borderstop_v
op_div_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;xres
OL
l_int|640
)paren
id|par-&gt;is_lowres
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* XXX: Needs testing. */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|par-&gt;vmode
op_xor
id|var-&gt;vmode
)paren
op_amp
id|FB_VMODE_YWRAP
)paren
)paren
(brace
id|par-&gt;xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|par-&gt;yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
(brace
r_if
c_cond
(paren
id|par-&gt;xoffset
op_logical_or
id|par-&gt;yoffset
OL
l_int|0
op_logical_or
id|par-&gt;yoffset
op_ge
id|par-&gt;vyres
)paren
id|par-&gt;xoffset
op_assign
id|par-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|par-&gt;xoffset
template_param
id|par-&gt;vxres
op_minus
id|par-&gt;xres
op_logical_or
id|par-&gt;yoffset
template_param
id|par-&gt;vyres
op_minus
id|par-&gt;yres
)paren
id|par-&gt;xoffset
op_assign
id|par-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
id|par-&gt;xoffset
op_assign
id|par-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check memory sizes */
id|line_length
op_assign
id|get_line_length
c_func
(paren
id|var-&gt;xres_virtual
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|line_length
op_star
id|var-&gt;yres_virtual
OG
id|videomemorysize
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|par-&gt;disp_start
op_assign
id|videomemory
op_plus
(paren
id|get_line_length
c_func
(paren
id|par-&gt;vxres
comma
id|par-&gt;bpp
)paren
op_star
id|par-&gt;yoffset
)paren
op_star
id|get_line_length
c_func
(paren
id|par-&gt;xoffset
comma
id|par-&gt;bpp
)paren
suffix:semicolon
id|par-&gt;next_line
op_assign
id|line_length
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2_encode_var
r_static
r_int
id|pvr2_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|pvr2fb_par
op_star
id|par
)paren
(brace
id|memset
c_func
(paren
id|var
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
)paren
suffix:semicolon
id|var-&gt;xres
op_assign
id|par-&gt;xres
suffix:semicolon
id|var-&gt;yres
op_assign
id|par-&gt;yres
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|par-&gt;vxres
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|par-&gt;vyres
suffix:semicolon
id|var-&gt;xoffset
op_assign
id|par-&gt;xoffset
suffix:semicolon
id|var-&gt;yoffset
op_assign
id|par-&gt;yoffset
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
id|par-&gt;bpp
suffix:semicolon
id|set_color_bitfields
c_func
(paren
id|var
)paren
suffix:semicolon
id|var-&gt;activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|var-&gt;height
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;width
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;pixclock
op_assign
id|par-&gt;pixclock
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;is_doublescan
)paren
id|var-&gt;vmode
op_assign
id|FB_VMODE_DOUBLE
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;is_interlaced
)paren
id|var-&gt;vmode
op_or_assign
id|FB_VMODE_INTERLACED
suffix:semicolon
r_else
id|var-&gt;vmode
op_or_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
id|var-&gt;right_margin
op_assign
id|par-&gt;borderstop_h
op_minus
(paren
id|par-&gt;diwstart_h
op_plus
id|par-&gt;xres
)paren
suffix:semicolon
id|var-&gt;left_margin
op_assign
id|par-&gt;diwstart_h
op_minus
id|par-&gt;borderstart_h
suffix:semicolon
id|var-&gt;hsync_len
op_assign
id|par-&gt;borderstart_h
op_plus
(paren
id|par-&gt;hsync_total
op_minus
id|par-&gt;borderstop_h
)paren
suffix:semicolon
id|var-&gt;upper_margin
op_assign
id|par-&gt;diwstart_v
op_minus
id|par-&gt;borderstart_v
suffix:semicolon
id|var-&gt;lower_margin
op_assign
id|par-&gt;borderstop_v
op_minus
(paren
id|par-&gt;diwstart_v
op_plus
id|par-&gt;yres
)paren
suffix:semicolon
id|var-&gt;vsync_len
op_assign
id|par-&gt;borderstart_v
op_plus
(paren
id|par-&gt;vsync_total
op_minus
id|par-&gt;borderstop_v
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_output
op_ne
id|VO_VGA
)paren
id|var-&gt;sync
op_assign
id|FB_SYNC_BROADCAST
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
id|var-&gt;vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2_get_par
r_static
r_void
id|pvr2_get_par
c_func
(paren
r_struct
id|pvr2fb_par
op_star
id|par
)paren
(brace
op_star
id|par
op_assign
id|currentpar
suffix:semicolon
)brace
multiline_comment|/* Setup the new videomode in hardware */
DECL|function|pvr2_set_var
r_static
r_void
id|pvr2_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|do_vmode_pan
op_assign
l_int|0
suffix:semicolon
id|do_vmode_full
op_assign
l_int|0
suffix:semicolon
id|pvr2_decode_var
c_func
(paren
id|var
comma
op_amp
id|currentpar
)paren
suffix:semicolon
id|do_vmode_full
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* &n; * Pan or wrap the display&n; * This call looks only at xoffset, yoffset and the FB_VMODE_YWRAP flag in `var&squot;.&n; */
DECL|function|pvr2_pan_var
r_static
r_void
id|pvr2_pan_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_struct
id|pvr2fb_par
op_star
id|par
op_assign
op_amp
id|currentpar
suffix:semicolon
id|par-&gt;xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|par-&gt;yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
id|par-&gt;vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
r_else
id|par-&gt;vmode
op_and_assign
op_complement
id|FB_VMODE_YWRAP
suffix:semicolon
id|do_vmode_pan
op_assign
l_int|0
suffix:semicolon
id|pvr2_update_par
c_func
(paren
)paren
suffix:semicolon
id|do_vmode_pan
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|pvr2_update_par
r_static
r_int
id|pvr2_update_par
c_func
(paren
r_void
)paren
(brace
r_struct
id|pvr2fb_par
op_star
id|par
op_assign
op_amp
id|currentpar
suffix:semicolon
id|u_long
id|move
suffix:semicolon
id|move
op_assign
id|get_line_length
c_func
(paren
id|par-&gt;xoffset
comma
id|par-&gt;bpp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;yoffset
)paren
(brace
id|par-&gt;disp_start
op_add_assign
(paren
id|par-&gt;next_line
op_star
id|par-&gt;yoffset
)paren
op_plus
id|move
suffix:semicolon
)brace
r_else
id|par-&gt;disp_start
op_add_assign
id|move
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2_update_display
r_static
r_void
id|pvr2_update_display
c_func
(paren
r_void
)paren
(brace
r_struct
id|pvr2fb_par
op_star
id|par
op_assign
op_amp
id|currentpar
suffix:semicolon
multiline_comment|/* Update the start address of the display image */
id|ctrl_outl
c_func
(paren
id|par-&gt;disp_start
comma
id|DISP_DIWADDRL
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
id|par-&gt;disp_start
op_plus
id|get_line_length
c_func
(paren
id|par-&gt;xoffset
op_plus
id|par-&gt;xres
comma
id|par-&gt;bpp
)paren
comma
id|DISP_DIWADDRS
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Initialize the video mode.  Currently, the 16bpp and 24bpp modes aren&squot;t&n; * very stable.  It&squot;s probably due to the fact that a lot of the 2D video&n; * registers are still undocumented.&n; */
DECL|function|pvr2_init_display
r_static
r_void
id|pvr2_init_display
c_func
(paren
r_void
)paren
(brace
r_struct
id|pvr2fb_par
op_star
id|par
op_assign
op_amp
id|currentpar
suffix:semicolon
id|u_short
id|diw_height
comma
id|diw_width
comma
id|diw_modulo
op_assign
l_int|1
suffix:semicolon
id|u_short
id|bytesperpixel
op_assign
id|par-&gt;bpp
op_div
l_int|8
suffix:semicolon
multiline_comment|/* hsync and vsync totals */
id|ctrl_outl
c_func
(paren
(paren
id|par-&gt;vsync_total
op_lshift
l_int|16
)paren
op_or
id|par-&gt;hsync_total
comma
id|DISP_SYNCSIZE
)paren
suffix:semicolon
multiline_comment|/* column height, modulo, row width */
multiline_comment|/* since we&squot;re &quot;panning&quot; within vram, we need to offset things based&n;&t; * on the offset from the virtual x start to our real gfx. */
r_if
c_cond
(paren
id|video_output
op_ne
id|VO_VGA
op_logical_and
id|par-&gt;is_interlaced
)paren
id|diw_modulo
op_add_assign
id|par-&gt;next_line
op_div
l_int|4
suffix:semicolon
id|diw_height
op_assign
(paren
id|par-&gt;is_interlaced
ques
c_cond
id|par-&gt;yres
op_div
l_int|2
suffix:colon
id|par-&gt;yres
)paren
suffix:semicolon
id|diw_width
op_assign
id|get_line_length
c_func
(paren
id|par-&gt;xres
comma
id|par-&gt;bpp
)paren
op_div
l_int|4
suffix:semicolon
id|ctrl_outl
c_func
(paren
(paren
id|diw_modulo
op_lshift
l_int|20
)paren
op_or
(paren
op_decrement
id|diw_height
op_lshift
l_int|10
)paren
op_or
op_decrement
id|diw_width
comma
id|DISP_DIWSIZE
)paren
suffix:semicolon
multiline_comment|/* display address, long and short fields */
id|ctrl_outl
c_func
(paren
id|par-&gt;disp_start
comma
id|DISP_DIWADDRL
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
id|par-&gt;disp_start
op_plus
id|get_line_length
c_func
(paren
id|par-&gt;xoffset
op_plus
id|par-&gt;xres
comma
id|par-&gt;bpp
)paren
comma
id|DISP_DIWADDRS
)paren
suffix:semicolon
multiline_comment|/* border horizontal, border vertical, border color */
id|ctrl_outl
c_func
(paren
(paren
id|par-&gt;borderstart_h
op_lshift
l_int|16
)paren
op_or
id|par-&gt;borderstop_h
comma
id|DISP_BRDRHORZ
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
(paren
id|par-&gt;borderstart_v
op_lshift
l_int|16
)paren
op_or
id|par-&gt;borderstop_v
comma
id|DISP_BRDRVERT
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
l_int|0
comma
id|DISP_BRDRCOLR
)paren
suffix:semicolon
multiline_comment|/* display window start position */
id|ctrl_outl
c_func
(paren
id|par-&gt;diwstart_h
comma
id|DISP_DIWHSTRT
)paren
suffix:semicolon
id|ctrl_outl
c_func
(paren
(paren
id|par-&gt;diwstart_v
op_lshift
l_int|16
)paren
op_or
id|par-&gt;diwstart_v
comma
id|DISP_DIWVSTRT
)paren
suffix:semicolon
multiline_comment|/* misc. settings */
id|ctrl_outl
c_func
(paren
(paren
l_int|0x16
op_lshift
l_int|16
)paren
op_or
id|par-&gt;is_lowres
comma
id|DISP_DIWCONF
)paren
suffix:semicolon
multiline_comment|/* clock doubler (for VGA), scan doubler, display enable */
id|ctrl_outl
c_func
(paren
(paren
(paren
id|video_output
op_eq
id|VO_VGA
)paren
op_lshift
l_int|23
)paren
op_or
(paren
id|par-&gt;is_doublescan
op_lshift
l_int|1
)paren
op_or
l_int|1
comma
id|DISP_DIWMODE
)paren
suffix:semicolon
multiline_comment|/* bits per pixel */
id|ctrl_outl
c_func
(paren
id|ctrl_inl
c_func
(paren
id|DISP_DIWMODE
)paren
op_or
(paren
op_decrement
id|bytesperpixel
op_lshift
l_int|2
)paren
comma
id|DISP_DIWMODE
)paren
suffix:semicolon
multiline_comment|/* video enable, color sync, interlace, &n;&t; * hsync and vsync polarity (currently unused) */
id|ctrl_outl
c_func
(paren
l_int|0x100
op_or
(paren
(paren
id|par-&gt;is_interlaced
multiline_comment|/*|4*/
)paren
op_lshift
l_int|4
)paren
comma
id|DISP_SYNCCONF
)paren
suffix:semicolon
)brace
multiline_comment|/* Simulate blanking by making the border cover the entire screen */
DECL|macro|BLANK_BIT
mdefine_line|#define BLANK_BIT (1&lt;&lt;3)
DECL|function|pvr2_do_blank
r_static
r_void
id|pvr2_do_blank
c_func
(paren
r_void
)paren
(brace
id|u_long
id|diwconf
suffix:semicolon
id|diwconf
op_assign
id|ctrl_inl
c_func
(paren
id|DISP_DIWCONF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_blank
OG
l_int|0
)paren
id|ctrl_outl
c_func
(paren
id|diwconf
op_or
id|BLANK_BIT
comma
id|DISP_DIWCONF
)paren
suffix:semicolon
r_else
id|ctrl_outl
c_func
(paren
id|diwconf
op_amp
op_complement
id|BLANK_BIT
comma
id|DISP_DIWCONF
)paren
suffix:semicolon
id|is_blanked
op_assign
id|do_blank
OG
l_int|0
ques
c_cond
id|do_blank
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2fb_interrupt
r_static
r_void
id|pvr2fb_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_if
c_cond
(paren
id|do_vmode_pan
op_logical_or
id|do_vmode_full
)paren
id|pvr2_update_display
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_vmode_full
)paren
id|pvr2_init_display
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_vmode_pan
)paren
id|do_vmode_pan
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|do_blank
)paren
(brace
id|pvr2_do_blank
c_func
(paren
)paren
suffix:semicolon
id|do_blank
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_vmode_full
)paren
(brace
id|do_vmode_full
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Determine the cable type and initialize the cable output format.  Don&squot;t do&n; * anything if the cable type has been overidden (via &quot;cable:XX&quot;).&n; */
DECL|macro|PCTRA
mdefine_line|#define PCTRA 0xff80002c
DECL|macro|PDTRA
mdefine_line|#define PDTRA 0xff800030
DECL|macro|VOUTC
mdefine_line|#define VOUTC 0xa0702c00
DECL|function|pvr2_init_cable
r_static
r_int
id|pvr2_init_cable
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|cable_type
OL
l_int|0
)paren
(brace
id|ctrl_outl
c_func
(paren
(paren
id|ctrl_inl
c_func
(paren
id|PCTRA
)paren
op_amp
l_int|0xfff0ffff
)paren
op_or
l_int|0x000a0000
comma
id|PCTRA
)paren
suffix:semicolon
id|cable_type
op_assign
(paren
id|ctrl_inw
c_func
(paren
id|PDTRA
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|3
suffix:semicolon
)brace
multiline_comment|/* Now select the output format (either composite or other) */
multiline_comment|/* XXX: Save the previous val first, as this reg is also AICA&n;&t;  related */
r_if
c_cond
(paren
id|cable_type
op_eq
id|CT_COMPOSITE
)paren
id|ctrl_outl
c_func
(paren
l_int|3
op_lshift
l_int|8
comma
id|VOUTC
)paren
suffix:semicolon
r_else
id|ctrl_outl
c_func
(paren
l_int|0
comma
id|VOUTC
)paren
suffix:semicolon
r_return
id|cable_type
suffix:semicolon
)brace
DECL|function|pvr2fb_init
r_int
id|__init
id|pvr2fb_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
id|u_long
id|modememused
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MACH_DREAMCAST
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* Make a guess at the monitor based on the attached cable */
r_if
c_cond
(paren
id|pvr2_init_cable
c_func
(paren
)paren
op_eq
id|CT_VGA
)paren
(brace
id|fb_info.monspecs.hfmin
op_assign
l_int|30000
suffix:semicolon
id|fb_info.monspecs.hfmax
op_assign
l_int|70000
suffix:semicolon
id|fb_info.monspecs.vfmin
op_assign
l_int|60
suffix:semicolon
id|fb_info.monspecs.vfmax
op_assign
l_int|60
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Not VGA, using a TV (taken from acornfb) */
id|fb_info.monspecs.hfmin
op_assign
l_int|15469
suffix:semicolon
id|fb_info.monspecs.hfmax
op_assign
l_int|15781
suffix:semicolon
id|fb_info.monspecs.vfmin
op_assign
l_int|49
suffix:semicolon
id|fb_info.monspecs.vfmax
op_assign
l_int|51
suffix:semicolon
)brace
multiline_comment|/* XXX: This needs to pull default video output via BIOS or other means */
r_if
c_cond
(paren
id|video_output
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cable_type
op_eq
id|CT_VGA
)paren
id|video_output
op_assign
id|VO_VGA
suffix:semicolon
r_else
id|video_output
op_assign
id|VO_NTSC
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|fb_info.modename
comma
id|pvr2fb_name
)paren
suffix:semicolon
id|fb_info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|fb_info.node
op_assign
id|NODEV
suffix:semicolon
id|fb_info.fbops
op_assign
op_amp
id|pvr2fb_ops
suffix:semicolon
id|fb_info.disp
op_assign
op_amp
id|disp
suffix:semicolon
id|fb_info.currcon
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.switch_con
op_assign
op_amp
id|pvr2fbcon_switch
suffix:semicolon
id|fb_info.updatevar
op_assign
op_amp
id|pvr2fbcon_updatevar
suffix:semicolon
id|fb_info.flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|var
comma
l_int|0
comma
r_sizeof
(paren
id|var
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_output
op_eq
id|VO_VGA
)paren
id|defmode
op_assign
id|DEFMODE_VGA
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_find_mode
c_func
(paren
op_amp
id|var
comma
op_amp
id|fb_info
comma
id|mode_option
comma
id|pvr2_modedb
comma
id|NUM_TOTAL_MODES
comma
op_amp
id|pvr2_modedb
(braket
id|defmode
)braket
comma
l_int|16
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|HW_EVENT_VSYNC
comma
id|pvr2fb_interrupt
comma
l_int|0
comma
l_string|&quot;pvr2 VBL handler&quot;
comma
op_amp
id|currentpar
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;couldn&squot;t register VBL int&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_MTRR
r_if
c_cond
(paren
id|enable_mtrr
)paren
(brace
id|mtrr_handle
op_assign
id|mtrr_add
c_func
(paren
id|videomemory
comma
id|videomemorysize
comma
id|MTRR_TYPE_WRCOMB
comma
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;pvr2fb: MTRR turned on&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|pvr2fb_set_var
c_func
(paren
op_amp
id|var
comma
op_minus
l_int|1
comma
op_amp
id|fb_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|modememused
op_assign
id|get_line_length
c_func
(paren
id|var.xres_virtual
comma
id|var.bits_per_pixel
)paren
suffix:semicolon
id|modememused
op_mul_assign
id|var.yres_virtual
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fb%d: %s frame buffer device, using %ldk/%ldk of video memory&bslash;n&quot;
comma
id|GET_FB_IDX
c_func
(paren
id|fb_info.node
)paren
comma
id|fb_info.modename
comma
id|modememused
op_rshift
l_int|10
comma
id|videomemorysize
op_rshift
l_int|10
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fb%d: Mode %dx%d-%d pitch = %ld cable: %s video output: %s&bslash;n&quot;
comma
id|GET_FB_IDX
c_func
(paren
id|fb_info.node
)paren
comma
id|var.xres
comma
id|var.yres
comma
id|var.bits_per_pixel
comma
id|get_line_length
c_func
(paren
id|var.xres
comma
id|var.bits_per_pixel
)paren
comma
(paren
r_char
op_star
)paren
id|pvr2_get_param
c_func
(paren
id|cables
comma
l_int|NULL
comma
id|cable_type
comma
l_int|3
)paren
comma
(paren
r_char
op_star
)paren
id|pvr2_get_param
c_func
(paren
id|outputs
comma
l_int|NULL
comma
id|video_output
comma
l_int|3
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pvr2fb_exit
r_static
r_void
id|__exit
id|pvr2fb_exit
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_MTRR
r_if
c_cond
(paren
id|enable_mtrr
)paren
(brace
id|mtrr_del
c_func
(paren
id|mtrr_handle
comma
id|videomemory
comma
id|videomemorysize
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;pvr2fb: MTRR turned off&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|unregister_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
suffix:semicolon
)brace
DECL|function|pvr2_get_param
r_static
r_int
id|__init
id|pvr2_get_param
c_func
(paren
r_const
r_struct
id|pvr2_params
op_star
id|p
comma
r_const
r_char
op_star
id|s
comma
r_int
id|val
comma
r_int
id|size
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|s
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|p
(braket
id|i
)braket
dot
id|name
comma
id|s
comma
id|strlen
c_func
(paren
id|s
)paren
)paren
)paren
r_return
id|p
(braket
id|i
)braket
dot
id|val
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|p
(braket
id|i
)braket
dot
id|val
op_eq
id|val
)paren
r_return
(paren
r_int
)paren
id|p
(braket
id|i
)braket
dot
id|name
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Parse command arguments.  Supported arguments are:&n; *    inverse                             Use inverse color maps&n; *    nomtrr                              Disable MTRR usage&n; *    font:&lt;fontname&gt;                     Specify console font&n; *    cable:composite|rgb|vga             Override the video cable type&n; *    output:NTSC|PAL|VGA                 Override the video output format&n; *&n; *    &lt;xres&gt;x&lt;yres&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]   or,&n; *    &lt;name&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]          Startup using this video mode&n; */
macro_line|#ifndef MODULE
DECL|function|pvr2fb_setup
r_int
id|__init
id|pvr2fb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_char
id|cable_arg
(braket
l_int|80
)braket
suffix:semicolon
r_char
id|output_arg
(braket
l_int|80
)braket
suffix:semicolon
id|fb_info.fontname
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;inverse&quot;
)paren
)paren
(brace
id|pvr2fb_inverse
op_assign
l_int|1
suffix:semicolon
id|fb_invert_cmaps
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;font:&quot;
comma
l_int|5
)paren
)paren
id|strcpy
c_func
(paren
id|fb_info.fontname
comma
id|this_opt
op_plus
l_int|5
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;cable:&quot;
comma
l_int|6
)paren
)paren
id|strcpy
c_func
(paren
id|cable_arg
comma
id|this_opt
op_plus
l_int|6
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;output:&quot;
comma
l_int|7
)paren
)paren
id|strcpy
c_func
(paren
id|output_arg
comma
id|this_opt
op_plus
l_int|7
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MTRR
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;nomtrr&quot;
comma
l_int|6
)paren
)paren
id|enable_mtrr
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_else
id|mode_option
op_assign
id|this_opt
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|cable_arg
)paren
id|cable_type
op_assign
id|pvr2_get_param
c_func
(paren
id|cables
comma
id|cable_arg
comma
l_int|0
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|output_arg
)paren
id|video_output
op_assign
id|pvr2_get_param
c_func
(paren
id|outputs
comma
id|output_arg
comma
l_int|0
comma
l_int|3
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef MODULE
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|pvr2fb_init
id|module_init
c_func
(paren
id|pvr2fb_init
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|pvr2fb_exit
id|module_exit
c_func
(paren
id|pvr2fb_exit
)paren
suffix:semicolon
eof
