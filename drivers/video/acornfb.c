multiline_comment|/*&n; *  linux/drivers/video/acornfb.c&n; *&n; *  Copyright (C) 1998-2001 Russell King&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * Frame buffer code for Acorn platforms&n; *&n; * NOTE: Most of the modes with X!=640 will disappear shortly.&n; * NOTE: Startup setting of HS &amp; VS polarity not supported.&n; *       (do we need to support it if we&squot;re coming up in 640x480?)&n; *&n; * FIXME: (things broken by the &quot;new improved&quot; FBCON API)&n; *  - Blanking 8bpp displays with VIDC&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;acornfb.h&quot;
multiline_comment|/*&n; * VIDC machines can&squot;t do 16 or 32BPP modes.&n; */
macro_line|#ifdef HAS_VIDC
DECL|macro|FBCON_HAS_CFB16
macro_line|#undef FBCON_HAS_CFB16
DECL|macro|FBCON_HAS_CFB32
macro_line|#undef FBCON_HAS_CFB32
macro_line|#endif
multiline_comment|/*&n; * Default resolution.&n; * NOTE that it has to be supported in the table towards&n; * the end of this file.&n; */
DECL|macro|DEFAULT_XRES
mdefine_line|#define DEFAULT_XRES&t;640
DECL|macro|DEFAULT_YRES
mdefine_line|#define DEFAULT_YRES&t;480
DECL|macro|DEFAULT_BPP
mdefine_line|#define DEFAULT_BPP&t;4
multiline_comment|/*&n; * define this to debug the video mode selection&n; */
DECL|macro|DEBUG_MODE_SELECTION
macro_line|#undef DEBUG_MODE_SELECTION
multiline_comment|/*&n; * Translation from RISC OS monitor types to actual&n; * HSYNC and VSYNC frequency ranges.  These are&n; * probably not right, but they&squot;re the best info I&n; * have.  Allow 1% either way on the nominal for TVs.&n; */
DECL|macro|NR_MONTYPES
mdefine_line|#define NR_MONTYPES&t;6
DECL|variable|__initdata
r_static
r_struct
id|fb_monspecs
id|monspecs
(braket
id|NR_MONTYPES
)braket
id|__initdata
op_assign
(brace
(brace
l_int|15469
comma
l_int|15781
comma
l_int|49
comma
l_int|51
comma
l_int|0
)brace
comma
multiline_comment|/* TV&t;&t;*/
(brace
l_int|0
comma
l_int|99999
comma
l_int|0
comma
l_int|199
comma
l_int|0
)brace
comma
multiline_comment|/* Multi Freq&t;*/
(brace
l_int|58608
comma
l_int|58608
comma
l_int|64
comma
l_int|64
comma
l_int|0
)brace
comma
multiline_comment|/* Hi-res mono&t;*/
(brace
l_int|30000
comma
l_int|70000
comma
l_int|60
comma
l_int|60
comma
l_int|0
)brace
comma
multiline_comment|/* VGA&t;&t;*/
(brace
l_int|30000
comma
l_int|70000
comma
l_int|56
comma
l_int|75
comma
l_int|0
)brace
comma
multiline_comment|/* SVGA&t;&t;*/
(brace
l_int|30000
comma
l_int|70000
comma
l_int|60
comma
l_int|60
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|fb_info
id|fb_info
suffix:semicolon
DECL|variable|current_par
r_static
r_struct
id|acornfb_par
id|current_par
suffix:semicolon
DECL|variable|current_vidc
r_static
r_struct
id|vidc_timing
id|current_vidc
suffix:semicolon
r_extern
r_int
r_int
id|vram_size
suffix:semicolon
multiline_comment|/* set by setup.c */
macro_line|#ifdef HAS_VIDC
DECL|macro|MAX_SIZE
mdefine_line|#define MAX_SIZE&t;480*1024
multiline_comment|/* CTL     VIDC&t;Actual&n; * 24.000  0&t; 8.000&n; * 25.175  0&t; 8.392&n; * 36.000  0&t;12.000&n; * 24.000  1&t;12.000&n; * 25.175  1&t;12.588&n; * 24.000  2&t;16.000&n; * 25.175  2&t;16.783&n; * 36.000  1&t;18.000&n; * 24.000  3&t;24.000&n; * 36.000  2&t;24.000&n; * 25.175  3&t;25.175&n; * 36.000  3&t;36.000&n; */
DECL|struct|pixclock
r_struct
id|pixclock
(brace
DECL|member|min_clock
id|u_long
id|min_clock
suffix:semicolon
DECL|member|max_clock
id|u_long
id|max_clock
suffix:semicolon
DECL|member|vidc_ctl
id|u_int
id|vidc_ctl
suffix:semicolon
DECL|member|vid_ctl
id|u_int
id|vid_ctl
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|arc_clocks
r_static
r_struct
id|pixclock
id|arc_clocks
(braket
)braket
op_assign
(brace
multiline_comment|/* we allow +/-1% on these */
(brace
l_int|123750
comma
l_int|126250
comma
id|VIDC_CTRL_DIV3
comma
id|VID_CTL_24MHz
)brace
comma
multiline_comment|/*  8.000MHz */
(brace
l_int|82500
comma
l_int|84167
comma
id|VIDC_CTRL_DIV2
comma
id|VID_CTL_24MHz
)brace
comma
multiline_comment|/* 12.000MHz */
(brace
l_int|61875
comma
l_int|63125
comma
id|VIDC_CTRL_DIV1_5
comma
id|VID_CTL_24MHz
)brace
comma
multiline_comment|/* 16.000MHz */
(brace
l_int|41250
comma
l_int|42083
comma
id|VIDC_CTRL_DIV1
comma
id|VID_CTL_24MHz
)brace
comma
multiline_comment|/* 24.000MHz */
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_A5K
DECL|variable|a5k_clocks
r_static
r_struct
id|pixclock
id|a5k_clocks
(braket
)braket
op_assign
(brace
(brace
l_int|117974
comma
l_int|120357
comma
id|VIDC_CTRL_DIV3
comma
id|VID_CTL_25MHz
)brace
comma
multiline_comment|/*  8.392MHz */
(brace
l_int|78649
comma
l_int|80238
comma
id|VIDC_CTRL_DIV2
comma
id|VID_CTL_25MHz
)brace
comma
multiline_comment|/* 12.588MHz */
(brace
l_int|58987
comma
l_int|60178
comma
id|VIDC_CTRL_DIV1_5
comma
id|VID_CTL_25MHz
)brace
comma
multiline_comment|/* 16.588MHz */
(brace
l_int|55000
comma
l_int|56111
comma
id|VIDC_CTRL_DIV2
comma
id|VID_CTL_36MHz
)brace
comma
multiline_comment|/* 18.000MHz */
(brace
l_int|39325
comma
l_int|40119
comma
id|VIDC_CTRL_DIV1
comma
id|VID_CTL_25MHz
)brace
comma
multiline_comment|/* 25.175MHz */
(brace
l_int|27500
comma
l_int|28055
comma
id|VIDC_CTRL_DIV1
comma
id|VID_CTL_36MHz
)brace
comma
multiline_comment|/* 36.000MHz */
)brace
suffix:semicolon
macro_line|#endif
r_static
r_struct
id|pixclock
op_star
DECL|function|acornfb_valid_pixrate
id|acornfb_valid_pixrate
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|u_long
id|pixclock
op_assign
id|var-&gt;pixclock
suffix:semicolon
id|u_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|var-&gt;pixclock
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|arc_clocks
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|pixclock
OG
id|arc_clocks
(braket
id|i
)braket
dot
id|min_clock
op_logical_and
id|pixclock
OL
id|arc_clocks
(braket
id|i
)braket
dot
id|max_clock
)paren
r_return
id|arc_clocks
op_plus
id|i
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_A5K
r_if
c_cond
(paren
id|machine_is_a5k
c_func
(paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|a5k_clocks
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|pixclock
OG
id|a5k_clocks
(braket
id|i
)braket
dot
id|min_clock
op_logical_and
id|pixclock
OL
id|a5k_clocks
(braket
id|i
)braket
dot
id|max_clock
)paren
r_return
id|a5k_clocks
op_plus
id|i
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* VIDC Rules:&n; * hcr  : must be even (interlace, hcr/2 must be even)&n; * hswr : must be even&n; * hdsr : must be odd&n; * hder : must be odd&n; *&n; * vcr  : must be odd&n; * vswr : &gt;= 1&n; * vdsr : &gt;= 1&n; * vder : &gt;= vdsr&n; * if interlaced, then hcr/2 must be even&n; */
r_static
r_void
DECL|function|acornfb_set_timing
id|acornfb_set_timing
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_struct
id|pixclock
op_star
id|pclk
suffix:semicolon
r_struct
id|vidc_timing
id|vidc
suffix:semicolon
id|u_int
id|horiz_correction
suffix:semicolon
id|u_int
id|sync_len
comma
id|display_start
comma
id|display_end
comma
id|cycle
suffix:semicolon
id|u_int
id|is_interlaced
suffix:semicolon
id|u_int
id|vid_ctl
comma
id|vidc_ctl
suffix:semicolon
id|u_int
id|bandwidth
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vidc
comma
l_int|0
comma
r_sizeof
(paren
id|vidc
)paren
)paren
suffix:semicolon
id|pclk
op_assign
id|acornfb_valid_pixrate
c_func
(paren
id|var
)paren
suffix:semicolon
id|vidc_ctl
op_assign
id|pclk-&gt;vidc_ctl
suffix:semicolon
id|vid_ctl
op_assign
id|pclk-&gt;vid_ctl
suffix:semicolon
id|bandwidth
op_assign
id|var-&gt;pixclock
op_star
l_int|8
op_div
id|var-&gt;bits_per_pixel
suffix:semicolon
multiline_comment|/* 25.175, 4bpp = 79.444ns per byte, 317.776ns per word: fifo = 2,6 */
r_if
c_cond
(paren
id|bandwidth
OG
l_int|143500
)paren
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_FIFO_3_7
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bandwidth
OG
l_int|71750
)paren
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_FIFO_2_6
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bandwidth
OG
l_int|35875
)paren
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_FIFO_1_5
suffix:semicolon
r_else
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_FIFO_0_4
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|horiz_correction
op_assign
l_int|19
suffix:semicolon
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_1BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|horiz_correction
op_assign
l_int|11
suffix:semicolon
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_2BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|horiz_correction
op_assign
l_int|7
suffix:semicolon
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_4BPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
l_int|8
suffix:colon
id|horiz_correction
op_assign
l_int|5
suffix:semicolon
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_8BPP
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_COMP_HIGH_ACT
)paren
multiline_comment|/* should be FB_SYNC_COMP */
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_CSYNC
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
)paren
id|vid_ctl
op_or_assign
id|VID_CTL_HS_NHSYNC
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
)paren
id|vid_ctl
op_or_assign
id|VID_CTL_VS_NVSYNC
suffix:semicolon
)brace
id|sync_len
op_assign
id|var-&gt;hsync_len
suffix:semicolon
id|display_start
op_assign
id|sync_len
op_plus
id|var-&gt;left_margin
suffix:semicolon
id|display_end
op_assign
id|display_start
op_plus
id|var-&gt;xres
suffix:semicolon
id|cycle
op_assign
id|display_end
op_plus
id|var-&gt;right_margin
suffix:semicolon
multiline_comment|/* if interlaced, then hcr/2 must be even */
id|is_interlaced
op_assign
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_INTERLACED
suffix:semicolon
r_if
c_cond
(paren
id|is_interlaced
)paren
(brace
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_INTERLACE
suffix:semicolon
r_if
c_cond
(paren
id|cycle
op_amp
l_int|2
)paren
(brace
id|cycle
op_add_assign
l_int|2
suffix:semicolon
id|var-&gt;right_margin
op_add_assign
l_int|2
suffix:semicolon
)brace
)brace
id|vidc.h_cycle
op_assign
(paren
id|cycle
op_minus
l_int|2
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_sync_width
op_assign
(paren
id|sync_len
op_minus
l_int|2
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_border_start
op_assign
(paren
id|display_start
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_display_start
op_assign
(paren
id|display_start
op_minus
id|horiz_correction
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_display_end
op_assign
(paren
id|display_end
op_minus
id|horiz_correction
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_border_end
op_assign
(paren
id|display_end
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_interlace
op_assign
(paren
id|vidc.h_cycle
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|sync_len
op_assign
id|var-&gt;vsync_len
suffix:semicolon
id|display_start
op_assign
id|sync_len
op_plus
id|var-&gt;upper_margin
suffix:semicolon
id|display_end
op_assign
id|display_start
op_plus
id|var-&gt;yres
suffix:semicolon
id|cycle
op_assign
id|display_end
op_plus
id|var-&gt;lower_margin
suffix:semicolon
r_if
c_cond
(paren
id|is_interlaced
)paren
id|cycle
op_assign
(paren
id|cycle
op_minus
l_int|3
)paren
op_div
l_int|2
suffix:semicolon
r_else
id|cycle
op_assign
id|cycle
op_minus
l_int|1
suffix:semicolon
id|vidc.v_cycle
op_assign
id|cycle
suffix:semicolon
id|vidc.v_sync_width
op_assign
id|sync_len
op_minus
l_int|1
suffix:semicolon
id|vidc.v_border_start
op_assign
id|display_start
op_minus
l_int|1
suffix:semicolon
id|vidc.v_display_start
op_assign
id|vidc.v_border_start
suffix:semicolon
id|vidc.v_display_end
op_assign
id|display_end
op_minus
l_int|1
suffix:semicolon
id|vidc.v_border_end
op_assign
id|vidc.v_display_end
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_a5k
c_func
(paren
)paren
)paren
id|__raw_writeb
c_func
(paren
id|vid_ctl
comma
id|IOEB_VID_CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|current_vidc
comma
op_amp
id|vidc
comma
r_sizeof
(paren
id|vidc
)paren
)paren
)paren
(brace
id|current_vidc
op_assign
id|vidc
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0xe0000000
op_or
id|vidc_ctl
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x80000000
op_or
(paren
id|vidc.h_cycle
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x84000000
op_or
(paren
id|vidc.h_sync_width
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x88000000
op_or
(paren
id|vidc.h_border_start
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x8c000000
op_or
(paren
id|vidc.h_display_start
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x90000000
op_or
(paren
id|vidc.h_display_end
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x94000000
op_or
(paren
id|vidc.h_border_end
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x98000000
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x9c000000
op_or
(paren
id|vidc.h_interlace
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0xa0000000
op_or
(paren
id|vidc.v_cycle
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0xa4000000
op_or
(paren
id|vidc.v_sync_width
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0xa8000000
op_or
(paren
id|vidc.v_border_start
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0xac000000
op_or
(paren
id|vidc.v_display_start
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0xb0000000
op_or
(paren
id|vidc.v_display_end
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0xb4000000
op_or
(paren
id|vidc.v_border_end
op_lshift
l_int|14
)paren
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0xb8000000
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0xbc000000
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_MODE_SELECTION
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;VIDC registers for %dx%dx%d:&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-cycle          : %d&bslash;n&quot;
comma
id|vidc.h_cycle
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-sync-width     : %d&bslash;n&quot;
comma
id|vidc.h_sync_width
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-border-start   : %d&bslash;n&quot;
comma
id|vidc.h_border_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-display-start  : %d&bslash;n&quot;
comma
id|vidc.h_display_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-display-end    : %d&bslash;n&quot;
comma
id|vidc.h_display_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-border-end     : %d&bslash;n&quot;
comma
id|vidc.h_border_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-interlace      : %d&bslash;n&quot;
comma
id|vidc.h_interlace
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-cycle          : %d&bslash;n&quot;
comma
id|vidc.v_cycle
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-sync-width     : %d&bslash;n&quot;
comma
id|vidc.v_sync_width
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-border-start   : %d&bslash;n&quot;
comma
id|vidc.v_border_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-display-start  : %d&bslash;n&quot;
comma
id|vidc.v_display_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-display-end    : %d&bslash;n&quot;
comma
id|vidc.v_display_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-border-end     : %d&bslash;n&quot;
comma
id|vidc.v_border_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; VIDC Ctrl (E)    : 0x%08X&bslash;n&quot;
comma
id|vidc_ctl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; IOEB Ctrl        : 0x%08X&bslash;n&quot;
comma
id|vid_ctl
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_int
DECL|function|acornfb_setcolreg
id|acornfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|trans
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_union
id|palette
id|pal
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
id|current_par.palette_size
)paren
r_return
l_int|1
suffix:semicolon
id|pal.p
op_assign
l_int|0
suffix:semicolon
id|pal.vidc.reg
op_assign
id|regno
suffix:semicolon
id|pal.vidc.red
op_assign
id|red
op_rshift
l_int|12
suffix:semicolon
id|pal.vidc.green
op_assign
id|green
op_rshift
l_int|12
suffix:semicolon
id|pal.vidc.blue
op_assign
id|blue
op_rshift
l_int|12
suffix:semicolon
id|current_par.palette
(braket
id|regno
)braket
op_assign
id|pal
suffix:semicolon
id|vidc_writel
c_func
(paren
id|pal.p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef HAS_VIDC20
macro_line|#include &lt;asm/arch/acornfb.h&gt;
DECL|macro|MAX_SIZE
mdefine_line|#define MAX_SIZE&t;2*1024*1024
multiline_comment|/* VIDC20 has a different set of rules from the VIDC:&n; *  hcr  : must be multiple of 4&n; *  hswr : must be even&n; *  hdsr : must be even&n; *  hder : must be even&n; *  vcr  : &gt;= 2, (interlace, must be odd)&n; *  vswr : &gt;= 1&n; *  vdsr : &gt;= 1&n; *  vder : &gt;= vdsr&n; */
DECL|function|acornfb_set_timing
r_static
r_void
id|acornfb_set_timing
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|info-&gt;var
suffix:semicolon
r_struct
id|vidc_timing
id|vidc
suffix:semicolon
id|u_int
id|vcr
comma
id|fsize
suffix:semicolon
id|u_int
id|ext_ctl
comma
id|dat_ctl
suffix:semicolon
id|u_int
id|words_per_line
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vidc
comma
l_int|0
comma
r_sizeof
(paren
id|vidc
)paren
)paren
suffix:semicolon
id|vidc.h_sync_width
op_assign
id|var-&gt;hsync_len
op_minus
l_int|8
suffix:semicolon
id|vidc.h_border_start
op_assign
id|vidc.h_sync_width
op_plus
id|var-&gt;left_margin
op_plus
l_int|8
op_minus
l_int|12
suffix:semicolon
id|vidc.h_display_start
op_assign
id|vidc.h_border_start
op_plus
l_int|12
op_minus
l_int|18
suffix:semicolon
id|vidc.h_display_end
op_assign
id|vidc.h_display_start
op_plus
id|var-&gt;xres
suffix:semicolon
id|vidc.h_border_end
op_assign
id|vidc.h_display_end
op_plus
l_int|18
op_minus
l_int|12
suffix:semicolon
id|vidc.h_cycle
op_assign
id|vidc.h_border_end
op_plus
id|var-&gt;right_margin
op_plus
l_int|12
op_minus
l_int|8
suffix:semicolon
id|vidc.h_interlace
op_assign
id|vidc.h_cycle
op_div
l_int|2
suffix:semicolon
id|vidc.v_sync_width
op_assign
id|var-&gt;vsync_len
op_minus
l_int|1
suffix:semicolon
id|vidc.v_border_start
op_assign
id|vidc.v_sync_width
op_plus
id|var-&gt;upper_margin
suffix:semicolon
id|vidc.v_display_start
op_assign
id|vidc.v_border_start
suffix:semicolon
id|vidc.v_display_end
op_assign
id|vidc.v_display_start
op_plus
id|var-&gt;yres
suffix:semicolon
id|vidc.v_border_end
op_assign
id|vidc.v_display_end
suffix:semicolon
id|vidc.control
op_assign
id|acornfb_default_control
c_func
(paren
)paren
suffix:semicolon
id|vcr
op_assign
id|var-&gt;vsync_len
op_plus
id|var-&gt;upper_margin
op_plus
id|var-&gt;yres
op_plus
id|var-&gt;lower_margin
suffix:semicolon
r_if
c_cond
(paren
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_INTERLACED
)paren
(brace
id|vidc.v_cycle
op_assign
(paren
id|vcr
op_minus
l_int|3
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_INT
suffix:semicolon
)brace
r_else
id|vidc.v_cycle
op_assign
id|vcr
op_minus
l_int|2
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_1BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_2BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_4BPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
l_int|8
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_8BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_16BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_32BPP
suffix:semicolon
r_break
suffix:semicolon
)brace
id|acornfb_vidc20_find_rates
c_func
(paren
op_amp
id|vidc
comma
id|var
)paren
suffix:semicolon
id|fsize
op_assign
id|var-&gt;vsync_len
op_plus
id|var-&gt;upper_margin
op_plus
id|var-&gt;lower_margin
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|current_vidc
comma
op_amp
id|vidc
comma
r_sizeof
(paren
id|vidc
)paren
)paren
)paren
(brace
id|current_vidc
op_assign
id|vidc
suffix:semicolon
id|vidc_writel
c_func
(paren
id|VIDC20_CTRL
op_or
id|vidc.control
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0xd0000000
op_or
id|vidc.pll_ctl
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x80000000
op_or
id|vidc.h_cycle
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x81000000
op_or
id|vidc.h_sync_width
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x82000000
op_or
id|vidc.h_border_start
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x83000000
op_or
id|vidc.h_display_start
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x84000000
op_or
id|vidc.h_display_end
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x85000000
op_or
id|vidc.h_border_end
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x86000000
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x87000000
op_or
id|vidc.h_interlace
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x90000000
op_or
id|vidc.v_cycle
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x91000000
op_or
id|vidc.v_sync_width
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x92000000
op_or
id|vidc.v_border_start
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x93000000
op_or
id|vidc.v_display_start
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x94000000
op_or
id|vidc.v_display_end
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x95000000
op_or
id|vidc.v_border_end
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x96000000
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x97000000
)paren
suffix:semicolon
)brace
id|iomd_writel
c_func
(paren
id|fsize
comma
id|IOMD_FSIZE
)paren
suffix:semicolon
id|ext_ctl
op_assign
id|acornfb_default_econtrol
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_COMP_HIGH_ACT
)paren
multiline_comment|/* should be FB_SYNC_COMP */
id|ext_ctl
op_or_assign
id|VIDC20_ECTL_HS_NCSYNC
op_or
id|VIDC20_ECTL_VS_NCSYNC
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
id|ext_ctl
op_or_assign
id|VIDC20_ECTL_HS_HSYNC
suffix:semicolon
r_else
id|ext_ctl
op_or_assign
id|VIDC20_ECTL_HS_NHSYNC
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
id|ext_ctl
op_or_assign
id|VIDC20_ECTL_VS_VSYNC
suffix:semicolon
r_else
id|ext_ctl
op_or_assign
id|VIDC20_ECTL_VS_NVSYNC
suffix:semicolon
)brace
id|vidc_writel
c_func
(paren
id|VIDC20_ECTL
op_or
id|ext_ctl
)paren
suffix:semicolon
id|words_per_line
op_assign
id|var-&gt;xres
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|current_par.using_vram
op_logical_and
id|info-&gt;fix.smem_len
op_eq
l_int|2048
op_star
l_int|1024
)paren
id|words_per_line
op_div_assign
l_int|2
suffix:semicolon
multiline_comment|/* RiscPC doesn&squot;t use the VIDC&squot;s VRAM control. */
id|dat_ctl
op_assign
id|VIDC20_DCTL_VRAM_DIS
op_or
id|VIDC20_DCTL_SNA
op_or
id|words_per_line
suffix:semicolon
multiline_comment|/* The data bus width is dependent on both the type&n;&t; * and amount of video memory.&n;&t; *     DRAM&t;32bit low&n;&t; * 1MB VRAM&t;32bit&n;&t; * 2MB VRAM&t;64bit&n;&t; */
r_if
c_cond
(paren
id|current_par.using_vram
op_logical_and
id|current_par.vram_half_sam
op_eq
l_int|2048
)paren
id|dat_ctl
op_or_assign
id|VIDC20_DCTL_BUS_D63_0
suffix:semicolon
r_else
id|dat_ctl
op_or_assign
id|VIDC20_DCTL_BUS_D31_0
suffix:semicolon
id|vidc_writel
c_func
(paren
id|VIDC20_DCTL
op_or
id|dat_ctl
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_MODE_SELECTION
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;VIDC registers for %dx%dx%d:&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-cycle          : %d&bslash;n&quot;
comma
id|vidc.h_cycle
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-sync-width     : %d&bslash;n&quot;
comma
id|vidc.h_sync_width
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-border-start   : %d&bslash;n&quot;
comma
id|vidc.h_border_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-display-start  : %d&bslash;n&quot;
comma
id|vidc.h_display_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-display-end    : %d&bslash;n&quot;
comma
id|vidc.h_display_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-border-end     : %d&bslash;n&quot;
comma
id|vidc.h_border_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-interlace      : %d&bslash;n&quot;
comma
id|vidc.h_interlace
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-cycle          : %d&bslash;n&quot;
comma
id|vidc.v_cycle
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-sync-width     : %d&bslash;n&quot;
comma
id|vidc.v_sync_width
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-border-start   : %d&bslash;n&quot;
comma
id|vidc.v_border_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-display-start  : %d&bslash;n&quot;
comma
id|vidc.v_display_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-display-end    : %d&bslash;n&quot;
comma
id|vidc.v_display_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-border-end     : %d&bslash;n&quot;
comma
id|vidc.v_border_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Ext Ctrl  (C)    : 0x%08X&bslash;n&quot;
comma
id|ext_ctl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; PLL Ctrl  (D)    : 0x%08X&bslash;n&quot;
comma
id|vidc.pll_ctl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Ctrl      (E)    : 0x%08X&bslash;n&quot;
comma
id|vidc.control
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Data Ctrl (F)    : 0x%08X&bslash;n&quot;
comma
id|dat_ctl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Fsize            : 0x%08X&bslash;n&quot;
comma
id|fsize
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * We have to take note of the VIDC20&squot;s 16-bit palette here.&n; * The VIDC20 looks up a 16 bit pixel as follows:&n; *&n; *   bits   111111&n; *          5432109876543210&n; *   red            ++++++++  (8 bits,  7 to 0)&n; *  green       ++++++++      (8 bits, 11 to 4)&n; *   blue   ++++++++          (8 bits, 15 to 8)&n; *&n; * We use a pixel which looks like:&n; *&n; *   bits   111111&n; *          5432109876543210&n; *   red               +++++  (5 bits,  4 to  0)&n; *  green         +++++       (5 bits,  9 to  5)&n; *   blue    +++++            (5 bits, 14 to 10)&n; */
r_static
r_int
DECL|function|acornfb_setcolreg
id|acornfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|trans
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_union
id|palette
id|pal
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
id|current_par.palette_size
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|regno
OL
l_int|16
op_logical_and
id|info-&gt;fix.visual
op_eq
id|FB_VISUAL_DIRECTCOLOR
)paren
(brace
id|u32
id|pseudo_val
suffix:semicolon
id|pseudo_val
op_assign
id|regno
op_lshift
id|info-&gt;var.red.offset
suffix:semicolon
id|pseudo_val
op_or_assign
id|regno
op_lshift
id|info-&gt;var.green.offset
suffix:semicolon
id|pseudo_val
op_or_assign
id|regno
op_lshift
id|info-&gt;var.blue.offset
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
id|info-&gt;pseudo_palette
)paren
(braket
id|regno
)braket
op_assign
id|pseudo_val
suffix:semicolon
)brace
id|pal.p
op_assign
l_int|0
suffix:semicolon
id|pal.vidc20.red
op_assign
id|red
op_rshift
l_int|8
suffix:semicolon
id|pal.vidc20.green
op_assign
id|green
op_rshift
l_int|8
suffix:semicolon
id|pal.vidc20.blue
op_assign
id|blue
op_rshift
l_int|8
suffix:semicolon
id|current_par.palette
(braket
id|regno
)braket
op_assign
id|pal
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.bits_per_pixel
op_eq
l_int|16
)paren
(brace
r_int
id|i
suffix:semicolon
id|pal.p
op_assign
l_int|0
suffix:semicolon
id|vidc_writel
c_func
(paren
l_int|0x10000000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_add_assign
l_int|1
)paren
(brace
id|pal.vidc20.red
op_assign
id|current_par.palette
(braket
id|i
op_amp
l_int|31
)braket
dot
id|vidc20.red
suffix:semicolon
id|pal.vidc20.green
op_assign
id|current_par.palette
(braket
(paren
id|i
op_rshift
l_int|1
)paren
op_amp
l_int|31
)braket
dot
id|vidc20.green
suffix:semicolon
id|pal.vidc20.blue
op_assign
id|current_par.palette
(braket
(paren
id|i
op_rshift
l_int|2
)paren
op_amp
l_int|31
)braket
dot
id|vidc20.blue
suffix:semicolon
id|vidc_writel
c_func
(paren
id|pal.p
)paren
suffix:semicolon
multiline_comment|/* Palette register pointer auto-increments */
)brace
)brace
r_else
(brace
id|vidc_writel
c_func
(paren
l_int|0x10000000
op_or
id|regno
)paren
suffix:semicolon
id|vidc_writel
c_func
(paren
id|pal.p
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Before selecting the timing parameters, adjust&n; * the resolution to fit the rules.&n; */
r_static
r_int
DECL|function|acornfb_adjust_timing
id|acornfb_adjust_timing
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
id|u_int
id|fontht
)paren
(brace
id|u_int
id|font_line_len
comma
id|sam_size
comma
id|min_size
comma
id|size
comma
id|nr_y
suffix:semicolon
multiline_comment|/* xres must be even */
id|var-&gt;xres
op_assign
(paren
id|var-&gt;xres
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * We don&squot;t allow xres_virtual to differ from xres&n;&t; */
id|var-&gt;xres_virtual
op_assign
id|var-&gt;xres
suffix:semicolon
id|var-&gt;xoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|current_par.using_vram
)paren
id|sam_size
op_assign
id|current_par.vram_half_sam
op_star
l_int|2
suffix:semicolon
r_else
id|sam_size
op_assign
l_int|16
suffix:semicolon
multiline_comment|/*&n;&t; * Now, find a value for yres_virtual which allows&n;&t; * us to do ywrap scrolling.  The value of&n;&t; * yres_virtual must be such that the end of the&n;&t; * displayable frame buffer must be aligned with&n;&t; * the start of a font line.&n;&t; */
id|font_line_len
op_assign
id|var-&gt;xres
op_star
id|var-&gt;bits_per_pixel
op_star
id|fontht
op_div
l_int|8
suffix:semicolon
id|min_size
op_assign
id|var-&gt;xres
op_star
id|var-&gt;yres
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|8
suffix:semicolon
multiline_comment|/*&n;&t; * If minimum screen size is greater than that we have&n;&t; * available, reject it.&n;&t; */
r_if
c_cond
(paren
id|min_size
OG
id|info-&gt;fix.smem_len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Find int &squot;y&squot;, such that y * fll == s * sam &lt; maxsize&n;&t; * y = s * sam / fll; s = maxsize / sam&n;&t; */
r_for
c_loop
(paren
id|size
op_assign
id|info-&gt;fix.smem_len
suffix:semicolon
id|nr_y
op_assign
id|size
op_div
id|font_line_len
comma
id|min_size
op_le
id|size
suffix:semicolon
id|size
op_sub_assign
id|sam_size
)paren
(brace
r_if
c_cond
(paren
id|nr_y
op_star
id|font_line_len
op_eq
id|size
)paren
r_break
suffix:semicolon
)brace
id|nr_y
op_mul_assign
id|fontht
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;accel_flags
op_amp
id|FB_ACCELF_TEXT
)paren
(brace
r_if
c_cond
(paren
id|min_size
OG
id|size
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * failed, use ypan&n;&t;&t;&t; */
id|size
op_assign
id|info-&gt;fix.smem_len
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|size
op_div
(paren
id|font_line_len
op_div
id|fontht
)paren
suffix:semicolon
)brace
r_else
id|var-&gt;yres_virtual
op_assign
id|nr_y
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|var-&gt;yres_virtual
OG
id|nr_y
)paren
id|var-&gt;yres_virtual
op_assign
id|nr_y
suffix:semicolon
id|current_par.screen_end
op_assign
id|info-&gt;fix.smem_start
op_plus
id|size
suffix:semicolon
multiline_comment|/*&n;&t; * Fix yres &amp; yoffset if needed.&n;&t; */
r_if
c_cond
(paren
id|var-&gt;yres
OG
id|var-&gt;yres_virtual
)paren
id|var-&gt;yres
op_assign
id|var-&gt;yres_virtual
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;yoffset
OG
id|var-&gt;yres_virtual
)paren
id|var-&gt;yoffset
op_assign
id|var-&gt;yres_virtual
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|var-&gt;yoffset
op_plus
id|var-&gt;yres
OG
id|var-&gt;yres_virtual
)paren
id|var-&gt;yoffset
op_assign
id|var-&gt;yres_virtual
op_minus
id|var-&gt;yres
suffix:semicolon
)brace
multiline_comment|/* hsync_len must be even */
id|var-&gt;hsync_len
op_assign
(paren
id|var-&gt;hsync_len
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
macro_line|#ifdef HAS_VIDC
multiline_comment|/* left_margin must be odd */
r_if
c_cond
(paren
(paren
id|var-&gt;left_margin
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|var-&gt;left_margin
op_sub_assign
l_int|1
suffix:semicolon
id|var-&gt;right_margin
op_add_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* right_margin must be odd */
id|var-&gt;right_margin
op_or_assign
l_int|1
suffix:semicolon
macro_line|#elif defined(HAS_VIDC20)
multiline_comment|/* left_margin must be even */
r_if
c_cond
(paren
id|var-&gt;left_margin
op_amp
l_int|1
)paren
(brace
id|var-&gt;left_margin
op_add_assign
l_int|1
suffix:semicolon
id|var-&gt;right_margin
op_sub_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* right_margin must be even */
r_if
c_cond
(paren
id|var-&gt;right_margin
op_amp
l_int|1
)paren
id|var-&gt;right_margin
op_add_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|var-&gt;vsync_len
OL
l_int|1
)paren
id|var-&gt;vsync_len
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_validate_timing
id|acornfb_validate_timing
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_monspecs
op_star
id|monspecs
)paren
(brace
r_int
r_int
id|hs
comma
id|vs
suffix:semicolon
multiline_comment|/*&n;&t; * hs(Hz) = 10^12 / (pixclock * xtotal)&n;&t; * vs(Hz) = hs(Hz) / ytotal&n;&t; *&n;&t; * No need to do long long divisions or anything&n;&t; * like that if you factor it correctly&n;&t; */
id|hs
op_assign
l_int|1953125000
op_div
id|var-&gt;pixclock
suffix:semicolon
id|hs
op_assign
id|hs
op_star
l_int|512
op_div
(paren
id|var-&gt;xres
op_plus
id|var-&gt;left_margin
op_plus
id|var-&gt;right_margin
op_plus
id|var-&gt;hsync_len
)paren
suffix:semicolon
id|vs
op_assign
id|hs
op_div
(paren
id|var-&gt;yres
op_plus
id|var-&gt;upper_margin
op_plus
id|var-&gt;lower_margin
op_plus
id|var-&gt;vsync_len
)paren
suffix:semicolon
r_return
(paren
id|vs
op_ge
id|monspecs-&gt;vfmin
op_logical_and
id|vs
op_le
id|monspecs-&gt;vfmax
op_logical_and
id|hs
op_ge
id|monspecs-&gt;hfmin
op_logical_and
id|hs
op_le
id|monspecs-&gt;hfmax
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|acornfb_update_dma
id|acornfb_update_dma
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|u_int
id|off
op_assign
id|var-&gt;yoffset
op_star
id|info-&gt;fix.line_length
suffix:semicolon
macro_line|#if defined(HAS_MEMC)
id|memc_write
c_func
(paren
id|VDMA_INIT
comma
id|off
op_rshift
l_int|2
)paren
suffix:semicolon
macro_line|#elif defined(HAS_IOMD)
id|iomd_writel
c_func
(paren
id|info-&gt;fix.smem_start
op_plus
id|off
comma
id|IOMD_VIDINIT
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_int
DECL|function|acornfb_check_var
id|acornfb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|u_int
id|fontht
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/*&n;&t; * FIXME: Find the font height&n;&t; */
id|fontht
op_assign
l_int|8
suffix:semicolon
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.msb_right
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
r_case
l_int|2
suffix:colon
r_case
l_int|4
suffix:colon
r_case
l_int|8
suffix:colon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
id|var-&gt;bits_per_pixel
suffix:semicolon
id|var-&gt;green
op_assign
id|var-&gt;red
suffix:semicolon
id|var-&gt;blue
op_assign
id|var-&gt;red
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef HAS_VIDC20
r_case
l_int|16
suffix:colon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|10
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|15
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|24
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check to see if the pixel rate is valid.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|acornfb_valid_pixrate
c_func
(paren
id|var
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * Validate and adjust the resolution to&n;&t; * match the video generator hardware.&n;&t; */
id|err
op_assign
id|acornfb_adjust_timing
c_func
(paren
id|info
comma
id|var
comma
id|fontht
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/*&n;&t; * Validate the timing against the&n;&t; * monitor hardware.&n;&t; */
r_return
id|acornfb_validate_timing
c_func
(paren
id|var
comma
op_amp
id|info-&gt;monspecs
)paren
suffix:semicolon
)brace
DECL|function|acornfb_set_par
r_static
r_int
id|acornfb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|current_par.palette_size
op_assign
l_int|2
suffix:semicolon
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_MONO10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|current_par.palette_size
op_assign
l_int|4
suffix:semicolon
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|current_par.palette_size
op_assign
l_int|16
suffix:semicolon
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|current_par.palette_size
op_assign
id|VIDC_PALETTE_SIZE
suffix:semicolon
macro_line|#ifdef HAS_VIDC
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_STATIC_PSEUDOCOLOR
suffix:semicolon
macro_line|#else
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
macro_line|#ifdef HAS_VIDC20
r_case
l_int|16
suffix:colon
id|current_par.palette_size
op_assign
l_int|32
suffix:semicolon
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|current_par.palette_size
op_assign
id|VIDC_PALETTE_SIZE
suffix:semicolon
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|info-&gt;fix.line_length
op_assign
(paren
id|info-&gt;var.xres
op_star
id|info-&gt;var.bits_per_pixel
)paren
op_div
l_int|8
suffix:semicolon
macro_line|#if defined(HAS_MEMC)
(brace
r_int
r_int
id|size
op_assign
id|info-&gt;fix.smem_len
op_minus
id|VDMA_XFERSIZE
suffix:semicolon
id|memc_write
c_func
(paren
id|VDMA_START
comma
l_int|0
)paren
suffix:semicolon
id|memc_write
c_func
(paren
id|VDMA_END
comma
id|size
op_rshift
l_int|2
)paren
suffix:semicolon
)brace
macro_line|#elif defined(HAS_IOMD)
(brace
r_int
r_int
id|start
comma
id|size
suffix:semicolon
id|u_int
id|control
suffix:semicolon
id|start
op_assign
id|info-&gt;fix.smem_start
suffix:semicolon
id|size
op_assign
id|current_par.screen_end
suffix:semicolon
r_if
c_cond
(paren
id|current_par.using_vram
)paren
(brace
id|size
op_sub_assign
id|current_par.vram_half_sam
suffix:semicolon
id|control
op_assign
id|DMA_CR_E
op_or
(paren
id|current_par.vram_half_sam
op_div
l_int|256
)paren
suffix:semicolon
)brace
r_else
(brace
id|size
op_sub_assign
l_int|16
suffix:semicolon
id|control
op_assign
id|DMA_CR_E
op_or
id|DMA_CR_D
op_or
l_int|16
suffix:semicolon
)brace
id|iomd_writel
c_func
(paren
id|start
comma
id|IOMD_VIDSTART
)paren
suffix:semicolon
id|iomd_writel
c_func
(paren
id|size
comma
id|IOMD_VIDEND
)paren
suffix:semicolon
id|iomd_writel
c_func
(paren
id|control
comma
id|IOMD_VIDCR
)paren
suffix:semicolon
)brace
macro_line|#endif
id|acornfb_update_dma
c_func
(paren
id|info
comma
op_amp
id|info-&gt;var
)paren
suffix:semicolon
id|acornfb_set_timing
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_pan_display
id|acornfb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|u_int
id|y_bottom
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
)paren
id|y_bottom
op_add_assign
id|var-&gt;yres
suffix:semicolon
id|BUG_ON
c_func
(paren
id|y_bottom
OG
id|var-&gt;yres_virtual
)paren
suffix:semicolon
id|acornfb_update_dma
c_func
(paren
id|info
comma
id|var
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Note that we are entered with the kernel locked.&n; */
r_static
r_int
DECL|function|acornfb_mmap
id|acornfb_mmap
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_int
r_int
id|off
comma
id|start
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|off
op_assign
id|vma-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
suffix:semicolon
id|start
op_assign
id|info-&gt;fix.smem_start
suffix:semicolon
id|len
op_assign
id|PAGE_ALIGN
c_func
(paren
id|start
op_amp
op_complement
id|PAGE_MASK
)paren
op_plus
id|info-&gt;fix.smem_len
suffix:semicolon
id|start
op_and_assign
id|PAGE_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
op_plus
id|off
)paren
OG
id|len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|off
op_add_assign
id|start
suffix:semicolon
id|vma-&gt;vm_pgoff
op_assign
id|off
op_rshift
id|PAGE_SHIFT
suffix:semicolon
multiline_comment|/* This is an IO map - tell maydump to skip this VMA */
id|vma-&gt;vm_flags
op_or_assign
id|VM_IO
suffix:semicolon
id|vma-&gt;vm_page_prot
op_assign
id|pgprot_writecombine
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Don&squot;t alter the page protection flags; we want to keep the area&n;&t; * cached for better performance.  This does mean that we may miss&n;&t; * some updates to the screen occasionally, but process switches&n;&t; * should cause the caches and buffers to be flushed often enough.&n;&t; */
r_if
c_cond
(paren
id|io_remap_page_range
c_func
(paren
id|vma
comma
id|vma-&gt;vm_start
comma
id|off
comma
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_page_prot
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|acornfb_ops
r_static
r_struct
id|fb_ops
id|acornfb_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|fb_check_var
op_assign
id|acornfb_check_var
comma
dot
id|fb_set_par
op_assign
id|acornfb_set_par
comma
dot
id|fb_setcolreg
op_assign
id|acornfb_setcolreg
comma
dot
id|fb_pan_display
op_assign
id|acornfb_pan_display
comma
dot
id|fb_fillrect
op_assign
id|cfb_fillrect
comma
dot
id|fb_copyarea
op_assign
id|cfb_copyarea
comma
dot
id|fb_imageblit
op_assign
id|cfb_imageblit
comma
dot
id|fb_mmap
op_assign
id|acornfb_mmap
comma
dot
id|fb_cursor
op_assign
id|soft_cursor
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Everything after here is initialisation!!!&n; */
DECL|variable|__initdata
r_static
r_struct
id|fb_videomode
id|modedb
(braket
)braket
id|__initdata
op_assign
(brace
(brace
multiline_comment|/* 320x256 @ 50Hz */
l_int|NULL
comma
l_int|50
comma
l_int|320
comma
l_int|256
comma
l_int|125000
comma
l_int|92
comma
l_int|62
comma
l_int|35
comma
l_int|19
comma
l_int|38
comma
l_int|2
comma
id|FB_SYNC_COMP_HIGH_ACT
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* 640x250 @ 50Hz, 15.6 kHz hsync */
l_int|NULL
comma
l_int|50
comma
l_int|640
comma
l_int|250
comma
l_int|62500
comma
l_int|185
comma
l_int|123
comma
l_int|38
comma
l_int|21
comma
l_int|76
comma
l_int|3
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* 640x256 @ 50Hz, 15.6 kHz hsync */
l_int|NULL
comma
l_int|50
comma
l_int|640
comma
l_int|256
comma
l_int|62500
comma
l_int|185
comma
l_int|123
comma
l_int|35
comma
l_int|18
comma
l_int|76
comma
l_int|3
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* 640x512 @ 50Hz, 26.8 kHz hsync */
l_int|NULL
comma
l_int|50
comma
l_int|640
comma
l_int|512
comma
l_int|41667
comma
l_int|113
comma
l_int|87
comma
l_int|18
comma
l_int|1
comma
l_int|56
comma
l_int|3
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* 640x250 @ 70Hz, 31.5 kHz hsync */
l_int|NULL
comma
l_int|70
comma
l_int|640
comma
l_int|250
comma
l_int|39722
comma
l_int|48
comma
l_int|16
comma
l_int|109
comma
l_int|88
comma
l_int|96
comma
l_int|2
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* 640x256 @ 70Hz, 31.5 kHz hsync */
l_int|NULL
comma
l_int|70
comma
l_int|640
comma
l_int|256
comma
l_int|39722
comma
l_int|48
comma
l_int|16
comma
l_int|106
comma
l_int|85
comma
l_int|96
comma
l_int|2
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* 640x352 @ 70Hz, 31.5 kHz hsync */
l_int|NULL
comma
l_int|70
comma
l_int|640
comma
l_int|352
comma
l_int|39722
comma
l_int|48
comma
l_int|16
comma
l_int|58
comma
l_int|37
comma
l_int|96
comma
l_int|2
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* 640x480 @ 60Hz, 31.5 kHz hsync */
l_int|NULL
comma
l_int|60
comma
l_int|640
comma
l_int|480
comma
l_int|39722
comma
l_int|48
comma
l_int|16
comma
l_int|32
comma
l_int|11
comma
l_int|96
comma
l_int|2
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* 800x600 @ 56Hz, 35.2 kHz hsync */
l_int|NULL
comma
l_int|56
comma
l_int|800
comma
l_int|600
comma
l_int|27778
comma
l_int|101
comma
l_int|23
comma
l_int|22
comma
l_int|1
comma
l_int|100
comma
l_int|2
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* 896x352 @ 60Hz, 21.8 kHz hsync */
l_int|NULL
comma
l_int|60
comma
l_int|896
comma
l_int|352
comma
l_int|41667
comma
l_int|59
comma
l_int|27
comma
l_int|9
comma
l_int|0
comma
l_int|118
comma
l_int|3
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* 1024x 768 @ 60Hz, 48.4 kHz hsync */
l_int|NULL
comma
l_int|60
comma
l_int|1024
comma
l_int|768
comma
l_int|15385
comma
l_int|160
comma
l_int|24
comma
l_int|29
comma
l_int|3
comma
l_int|136
comma
l_int|6
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
comma
(brace
multiline_comment|/* 1280x1024 @ 60Hz, 63.8 kHz hsync */
l_int|NULL
comma
l_int|60
comma
l_int|1280
comma
l_int|1024
comma
l_int|9090
comma
l_int|186
comma
l_int|96
comma
l_int|38
comma
l_int|1
comma
l_int|160
comma
l_int|3
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
)brace
suffix:semicolon
r_static
r_struct
id|fb_videomode
id|__initdata
DECL|variable|acornfb_default_mode
id|acornfb_default_mode
op_assign
(brace
dot
id|name
op_assign
l_int|NULL
comma
dot
id|refresh
op_assign
l_int|60
comma
dot
id|xres
op_assign
l_int|640
comma
dot
id|yres
op_assign
l_int|480
comma
dot
id|pixclock
op_assign
l_int|39722
comma
dot
id|left_margin
op_assign
l_int|56
comma
dot
id|right_margin
op_assign
l_int|16
comma
dot
id|upper_margin
op_assign
l_int|34
comma
dot
id|lower_margin
op_assign
l_int|9
comma
dot
id|hsync_len
op_assign
l_int|88
comma
dot
id|vsync_len
op_assign
l_int|2
comma
dot
id|sync
op_assign
l_int|0
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
DECL|function|acornfb_init_fbinfo
r_static
r_void
id|__init
id|acornfb_init_fbinfo
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|first
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|first
)paren
r_return
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
id|fb_info.fbops
op_assign
op_amp
id|acornfb_ops
suffix:semicolon
id|fb_info.flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
id|fb_info.pseudo_palette
op_assign
id|current_par.pseudo_palette
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.fix.id
comma
l_string|&quot;Acorn&quot;
)paren
suffix:semicolon
id|fb_info.fix.type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fb_info.fix.type_aux
op_assign
l_int|0
suffix:semicolon
id|fb_info.fix.xpanstep
op_assign
l_int|0
suffix:semicolon
id|fb_info.fix.ypanstep
op_assign
l_int|1
suffix:semicolon
id|fb_info.fix.ywrapstep
op_assign
l_int|1
suffix:semicolon
id|fb_info.fix.line_length
op_assign
l_int|0
suffix:semicolon
id|fb_info.fix.accel
op_assign
id|FB_ACCEL_NONE
suffix:semicolon
multiline_comment|/*&n;&t; * setup initial parameters&n;&t; */
id|memset
c_func
(paren
op_amp
id|fb_info.var
comma
l_int|0
comma
r_sizeof
(paren
id|fb_info.var
)paren
)paren
suffix:semicolon
macro_line|#if defined(HAS_VIDC20)
id|fb_info.var.red.length
op_assign
l_int|8
suffix:semicolon
id|fb_info.var.transp.length
op_assign
l_int|4
suffix:semicolon
macro_line|#elif defined(HAS_VIDC)
id|fb_info.var.red.length
op_assign
l_int|4
suffix:semicolon
id|fb_info.var.transp.length
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|fb_info.var.green
op_assign
id|fb_info.var.red
suffix:semicolon
id|fb_info.var.blue
op_assign
id|fb_info.var.red
suffix:semicolon
id|fb_info.var.nonstd
op_assign
l_int|0
suffix:semicolon
id|fb_info.var.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|fb_info.var.height
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.var.width
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.var.vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
id|fb_info.var.accel_flags
op_assign
id|FB_ACCELF_TEXT
suffix:semicolon
id|current_par.dram_size
op_assign
l_int|0
suffix:semicolon
id|current_par.montype
op_assign
op_minus
l_int|1
suffix:semicolon
id|current_par.dpms
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * setup acornfb options:&n; *&n; *  mon:hmin-hmax:vmin-vmax:dpms:width:height&n; *&t;Set monitor parameters:&n; *&t;&t;hmin   = horizontal minimum frequency (Hz)&n; *&t;&t;hmax   = horizontal maximum frequency (Hz)&t;(optional)&n; *&t;&t;vmin   = vertical minimum frequency (Hz)&n; *&t;&t;vmax   = vertical maximum frequency (Hz)&t;(optional)&n; *&t;&t;dpms   = DPMS supported?&t;&t;&t;(optional)&n; *&t;&t;width  = width of picture in mm.&t;&t;(optional)&n; *&t;&t;height = height of picture in mm.&t;&t;(optional)&n; *&n; * montype:type&n; *&t;Set RISC-OS style monitor type:&n; *&t;&t;0 (or tv)&t;- TV frequency&n; *&t;&t;1 (or multi)&t;- Multi frequency&n; *&t;&t;2 (or hires)&t;- Hi-res monochrome&n; *&t;&t;3 (or vga)&t;- VGA&n; *&t;&t;4 (or svga)&t;- SVGA&n; *&t;&t;auto, or option missing&n; *&t;&t;&t;&t;- try hardware detect&n; *&n; * dram:size&n; *&t;Set the amount of DRAM to use for the frame buffer&n; *&t;(even if you have VRAM).&n; *&t;size can optionally be followed by &squot;M&squot; or &squot;K&squot; for&n; *&t;MB or KB respectively.&n; */
r_static
r_void
id|__init
DECL|function|acornfb_parse_mon
id|acornfb_parse_mon
c_func
(paren
r_char
op_star
id|opt
)paren
(brace
r_char
op_star
id|p
op_assign
id|opt
suffix:semicolon
id|current_par.montype
op_assign
op_minus
l_int|2
suffix:semicolon
id|fb_info.monspecs.hfmin
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;-&squot;
)paren
id|fb_info.monspecs.hfmax
op_assign
id|simple_strtoul
c_func
(paren
id|p
op_plus
l_int|1
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
r_else
id|fb_info.monspecs.hfmax
op_assign
id|fb_info.monspecs.hfmin
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_ne
l_char|&squot;:&squot;
)paren
r_goto
id|bad
suffix:semicolon
id|fb_info.monspecs.vfmin
op_assign
id|simple_strtoul
c_func
(paren
id|p
op_plus
l_int|1
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;-&squot;
)paren
id|fb_info.monspecs.vfmax
op_assign
id|simple_strtoul
c_func
(paren
id|p
op_plus
l_int|1
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
r_else
id|fb_info.monspecs.vfmax
op_assign
id|fb_info.monspecs.vfmin
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_ne
l_char|&squot;:&squot;
)paren
r_goto
id|check_values
suffix:semicolon
id|fb_info.monspecs.dpms
op_assign
id|simple_strtoul
c_func
(paren
id|p
op_plus
l_int|1
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_ne
l_char|&squot;:&squot;
)paren
r_goto
id|check_values
suffix:semicolon
id|fb_info.var.width
op_assign
id|simple_strtoul
c_func
(paren
id|p
op_plus
l_int|1
comma
op_amp
id|p
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_ne
l_char|&squot;:&squot;
)paren
r_goto
id|check_values
suffix:semicolon
id|fb_info.var.height
op_assign
id|simple_strtoul
c_func
(paren
id|p
op_plus
l_int|1
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|check_values
suffix:colon
r_if
c_cond
(paren
id|fb_info.monspecs.hfmax
OL
id|fb_info.monspecs.hfmin
op_logical_or
id|fb_info.monspecs.vfmax
OL
id|fb_info.monspecs.vfmin
)paren
r_goto
id|bad
suffix:semicolon
r_return
suffix:semicolon
id|bad
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Acornfb: bad monitor settings: %s&bslash;n&quot;
comma
id|opt
)paren
suffix:semicolon
id|current_par.montype
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|acornfb_parse_montype
id|acornfb_parse_montype
c_func
(paren
r_char
op_star
id|opt
)paren
(brace
id|current_par.montype
op_assign
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;tv&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|2
suffix:semicolon
id|current_par.montype
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;multi&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|5
suffix:semicolon
id|current_par.montype
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;hires&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|5
suffix:semicolon
id|current_par.montype
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;vga&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|3
suffix:semicolon
id|current_par.montype
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;svga&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|4
suffix:semicolon
id|current_par.montype
op_assign
l_int|4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;auto&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|4
suffix:semicolon
id|current_par.montype
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|isdigit
c_func
(paren
op_star
id|opt
)paren
)paren
id|current_par.montype
op_assign
id|simple_strtoul
c_func
(paren
id|opt
comma
op_amp
id|opt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_par.montype
op_eq
op_minus
l_int|2
op_logical_or
id|current_par.montype
OG
id|NR_MONTYPES
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;acornfb: unknown monitor type: %s&bslash;n&quot;
comma
id|opt
)paren
suffix:semicolon
id|current_par.montype
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|opt
op_logical_and
op_star
id|opt
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|opt
comma
l_string|&quot;,dpms&quot;
)paren
op_eq
l_int|0
)paren
id|current_par.dpms
op_assign
l_int|1
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;acornfb: unknown monitor option: %s&bslash;n&quot;
comma
id|opt
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
id|__init
DECL|function|acornfb_parse_dram
id|acornfb_parse_dram
c_func
(paren
r_char
op_star
id|opt
)paren
(brace
r_int
r_int
id|size
suffix:semicolon
id|size
op_assign
id|simple_strtoul
c_func
(paren
id|opt
comma
op_amp
id|opt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
)paren
(brace
r_switch
c_cond
(paren
op_star
id|opt
)paren
(brace
r_case
l_char|&squot;M&squot;
suffix:colon
r_case
l_char|&squot;m&squot;
suffix:colon
id|size
op_mul_assign
l_int|1024
suffix:semicolon
r_case
l_char|&squot;K&squot;
suffix:colon
r_case
l_char|&squot;k&squot;
suffix:colon
id|size
op_mul_assign
l_int|1024
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
id|current_par.dram_size
op_assign
id|size
suffix:semicolon
)brace
DECL|struct|options
r_static
r_struct
id|options
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|parse
r_void
(paren
op_star
id|parse
)paren
(paren
r_char
op_star
id|opt
)paren
suffix:semicolon
DECL|variable|__initdata
)brace
id|opt_table
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_string|&quot;mon&quot;
comma
id|acornfb_parse_mon
)brace
comma
(brace
l_string|&quot;montype&quot;
comma
id|acornfb_parse_montype
)brace
comma
(brace
l_string|&quot;dram&quot;
comma
id|acornfb_parse_dram
)brace
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
r_int
id|__init
DECL|function|acornfb_setup
id|acornfb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_struct
id|options
op_star
id|optp
suffix:semicolon
r_char
op_star
id|opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
id|acornfb_init_fbinfo
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|opt
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|opt
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|optp
op_assign
id|opt_table
suffix:semicolon
id|optp-&gt;name
suffix:semicolon
id|optp
op_increment
)paren
(brace
r_int
id|optlen
suffix:semicolon
id|optlen
op_assign
id|strlen
c_func
(paren
id|optp-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
id|optp-&gt;name
comma
id|optlen
)paren
op_eq
l_int|0
op_logical_and
id|opt
(braket
id|optlen
)braket
op_eq
l_char|&squot;:&squot;
)paren
(brace
id|optp
op_member_access_from_pointer
id|parse
c_func
(paren
id|opt
op_plus
id|optlen
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|optp-&gt;name
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;acornfb: unknown parameter: %s&bslash;n&quot;
comma
id|opt
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Detect type of monitor connected&n; *  For now, we just assume SVGA&n; */
r_static
r_int
id|__init
DECL|function|acornfb_detect_monitortype
id|acornfb_detect_monitortype
c_func
(paren
r_void
)paren
(brace
r_return
l_int|4
suffix:semicolon
)brace
multiline_comment|/*&n; * This enables the unused memory to be freed on older Acorn machines.&n; */
r_static
r_inline
r_void
DECL|function|free_unused_pages
id|free_unused_pages
c_func
(paren
r_int
r_int
id|virtual_start
comma
r_int
r_int
id|virtual_end
)paren
(brace
r_int
id|mb_freed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Align addresses&n;&t; */
id|virtual_start
op_assign
id|PAGE_ALIGN
c_func
(paren
id|virtual_start
)paren
suffix:semicolon
id|virtual_end
op_assign
id|PAGE_ALIGN
c_func
(paren
id|virtual_end
)paren
suffix:semicolon
r_while
c_loop
(paren
id|virtual_start
OL
id|virtual_end
)paren
(brace
r_struct
id|page
op_star
id|page
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Clear page reserved bit,&n;&t;&t; * set count to 1, and free&n;&t;&t; * the page.&n;&t;&t; */
id|page
op_assign
id|virt_to_page
c_func
(paren
id|virtual_start
)paren
suffix:semicolon
id|ClearPageReserved
c_func
(paren
id|page
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|page-&gt;count
comma
l_int|1
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|virtual_start
)paren
suffix:semicolon
id|virtual_start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|mb_freed
op_add_assign
id|PAGE_SIZE
op_div
l_int|1024
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;acornfb: freed %dK memory&bslash;n&quot;
comma
id|mb_freed
)paren
suffix:semicolon
)brace
r_int
id|__init
DECL|function|acornfb_init
id|acornfb_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|size
suffix:semicolon
id|u_int
id|h_sync
comma
id|v_sync
suffix:semicolon
r_int
id|rc
comma
id|i
suffix:semicolon
id|acornfb_init_fbinfo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_par.montype
op_eq
op_minus
l_int|1
)paren
id|current_par.montype
op_assign
id|acornfb_detect_monitortype
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_par.montype
op_eq
op_minus
l_int|1
op_logical_or
id|current_par.montype
OG
id|NR_MONTYPES
)paren
id|current_par.montype
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|current_par.montype
op_ge
l_int|0
)paren
(brace
id|fb_info.monspecs
op_assign
id|monspecs
(braket
id|current_par.montype
)braket
suffix:semicolon
id|fb_info.monspecs.dpms
op_assign
id|current_par.dpms
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Try to select a suitable default mode&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|modedb
)paren
op_div
r_sizeof
(paren
op_star
id|modedb
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|hs
suffix:semicolon
id|hs
op_assign
id|modedb
(braket
id|i
)braket
dot
id|refresh
op_star
(paren
id|modedb
(braket
id|i
)braket
dot
id|yres
op_plus
id|modedb
(braket
id|i
)braket
dot
id|upper_margin
op_plus
id|modedb
(braket
id|i
)braket
dot
id|lower_margin
op_plus
id|modedb
(braket
id|i
)braket
dot
id|vsync_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|modedb
(braket
id|i
)braket
dot
id|xres
op_eq
id|DEFAULT_XRES
op_logical_and
id|modedb
(braket
id|i
)braket
dot
id|yres
op_eq
id|DEFAULT_YRES
op_logical_and
id|modedb
(braket
id|i
)braket
dot
id|refresh
op_ge
id|fb_info.monspecs.vfmin
op_logical_and
id|modedb
(braket
id|i
)braket
dot
id|refresh
op_le
id|fb_info.monspecs.vfmax
op_logical_and
id|hs
op_ge
id|fb_info.monspecs.hfmin
op_logical_and
id|hs
op_le
id|fb_info.monspecs.hfmax
)paren
(brace
id|acornfb_default_mode
op_assign
id|modedb
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|fb_info.currcon
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.screen_base
op_assign
(paren
r_char
op_star
)paren
id|SCREEN_BASE
suffix:semicolon
id|fb_info.fix.smem_start
op_assign
id|SCREEN_START
suffix:semicolon
id|current_par.using_vram
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * If vram_size is set, we are using VRAM in&n;&t; * a Risc PC.  However, if the user has specified&n;&t; * an amount of DRAM then use that instead.&n;&t; */
r_if
c_cond
(paren
id|vram_size
op_logical_and
op_logical_neg
id|current_par.dram_size
)paren
(brace
id|size
op_assign
id|vram_size
suffix:semicolon
id|current_par.vram_half_sam
op_assign
id|vram_size
op_div
l_int|1024
suffix:semicolon
id|current_par.using_vram
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|current_par.dram_size
)paren
id|size
op_assign
id|current_par.dram_size
suffix:semicolon
r_else
id|size
op_assign
id|MAX_SIZE
suffix:semicolon
multiline_comment|/*&n;&t; * Limit maximum screen size.&n;&t; */
r_if
c_cond
(paren
id|size
OG
id|MAX_SIZE
)paren
id|size
op_assign
id|MAX_SIZE
suffix:semicolon
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|size
)paren
suffix:semicolon
macro_line|#if defined(HAS_VIDC20)
r_if
c_cond
(paren
op_logical_neg
id|current_par.using_vram
)paren
(brace
multiline_comment|/*&n;&t;&t; * RiscPC needs to allocate the DRAM memory&n;&t;&t; * for the framebuffer if we are not using&n;&t;&t; * VRAM.  Archimedes/A5000 machines use a&n;&t;&t; * fixed address for their framebuffers.&n;&t;&t; */
r_int
r_int
id|page
comma
id|top
comma
id|base
suffix:semicolon
r_int
id|order
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
id|base
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;acornfb: unable to allocate screen &quot;
l_string|&quot;memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|top
op_assign
id|base
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
suffix:semicolon
multiline_comment|/* Mark the framebuffer pages as reserved so mmap will work. */
r_for
c_loop
(paren
id|page
op_assign
id|base
suffix:semicolon
id|page
OL
id|PAGE_ALIGN
c_func
(paren
id|base
op_plus
id|size
)paren
suffix:semicolon
id|page
op_add_assign
id|PAGE_SIZE
)paren
id|SetPageReserved
c_func
(paren
id|virt_to_page
c_func
(paren
id|page
)paren
)paren
suffix:semicolon
multiline_comment|/* Hand back any excess pages that we allocated. */
r_for
c_loop
(paren
id|page
op_assign
id|base
op_plus
id|size
suffix:semicolon
id|page
OL
id|top
suffix:semicolon
id|page
op_add_assign
id|PAGE_SIZE
)paren
id|free_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|fb_info.screen_base
op_assign
(paren
r_char
op_star
)paren
id|base
suffix:semicolon
id|fb_info.fix.smem_start
op_assign
id|virt_to_phys
c_func
(paren
id|fb_info.screen_base
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(HAS_VIDC)
multiline_comment|/*&n;&t; * Free unused pages&n;&t; */
id|free_unused_pages
c_func
(paren
id|PAGE_OFFSET
op_plus
id|size
comma
id|PAGE_OFFSET
op_plus
id|MAX_SIZE
)paren
suffix:semicolon
macro_line|#endif
id|fb_info.fix.smem_len
op_assign
id|size
suffix:semicolon
id|current_par.palette_size
op_assign
id|VIDC_PALETTE_SIZE
suffix:semicolon
multiline_comment|/*&n;&t; * Lookup the timing for this resolution.  If we can&squot;t&n;&t; * find it, then we can&squot;t restore it if we change&n;&t; * the resolution, so we disable this feature.&n;&t; */
r_do
(brace
id|rc
op_assign
id|fb_find_mode
c_func
(paren
op_amp
id|fb_info.var
comma
op_amp
id|fb_info
comma
l_int|NULL
comma
id|modedb
comma
r_sizeof
(paren
id|modedb
)paren
op_div
r_sizeof
(paren
op_star
id|modedb
)paren
comma
op_amp
id|acornfb_default_mode
comma
id|DEFAULT_BPP
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If we found an exact match, all ok.&n;&t;&t; */
r_if
c_cond
(paren
id|rc
op_eq
l_int|1
)paren
r_break
suffix:semicolon
id|rc
op_assign
id|fb_find_mode
c_func
(paren
op_amp
id|fb_info.var
comma
op_amp
id|fb_info
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|acornfb_default_mode
comma
id|DEFAULT_BPP
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If we found an exact match, all ok.&n;&t;&t; */
r_if
c_cond
(paren
id|rc
op_eq
l_int|1
)paren
r_break
suffix:semicolon
id|rc
op_assign
id|fb_find_mode
c_func
(paren
op_amp
id|fb_info.var
comma
op_amp
id|fb_info
comma
l_int|NULL
comma
id|modedb
comma
r_sizeof
(paren
id|modedb
)paren
op_div
r_sizeof
(paren
op_star
id|modedb
)paren
comma
op_amp
id|acornfb_default_mode
comma
id|DEFAULT_BPP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_break
suffix:semicolon
id|rc
op_assign
id|fb_find_mode
c_func
(paren
op_amp
id|fb_info.var
comma
op_amp
id|fb_info
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|acornfb_default_mode
comma
id|DEFAULT_BPP
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we didn&squot;t find an exact match, try the&n;&t; * generic database.&n;&t; */
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Acornfb: no valid mode found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|h_sync
op_assign
l_int|1953125000
op_div
id|fb_info.var.pixclock
suffix:semicolon
id|h_sync
op_assign
id|h_sync
op_star
l_int|512
op_div
(paren
id|fb_info.var.xres
op_plus
id|fb_info.var.left_margin
op_plus
id|fb_info.var.right_margin
op_plus
id|fb_info.var.hsync_len
)paren
suffix:semicolon
id|v_sync
op_assign
id|h_sync
op_div
(paren
id|fb_info.var.yres
op_plus
id|fb_info.var.upper_margin
op_plus
id|fb_info.var.lower_margin
op_plus
id|fb_info.var.vsync_len
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Acornfb: %dkB %cRAM, %s, using %dx%d, &quot;
l_string|&quot;%d.%03dkHz, %dHz&bslash;n&quot;
comma
id|fb_info.fix.smem_len
op_div
l_int|1024
comma
id|current_par.using_vram
ques
c_cond
l_char|&squot;V&squot;
suffix:colon
l_char|&squot;D&squot;
comma
id|VIDC_NAME
comma
id|fb_info.var.xres
comma
id|fb_info.var.yres
comma
id|h_sync
op_div
l_int|1000
comma
id|h_sync
op_mod
l_int|1000
comma
id|v_sync
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Acornfb: Monitor: %d.%03d-%d.%03dkHz, %d-%dHz%s&bslash;n&quot;
comma
id|fb_info.monspecs.hfmin
op_div
l_int|1000
comma
id|fb_info.monspecs.hfmin
op_mod
l_int|1000
comma
id|fb_info.monspecs.hfmax
op_div
l_int|1000
comma
id|fb_info.monspecs.hfmax
op_mod
l_int|1000
comma
id|fb_info.monspecs.vfmin
comma
id|fb_info.monspecs.vfmax
comma
id|fb_info.monspecs.dpms
ques
c_cond
l_string|&quot;, DPMS&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fb_set_var
c_func
(paren
op_amp
id|fb_info
comma
op_amp
id|fb_info.var
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Acornfb: unable to set display parameters&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Russell King&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;VIDC 1/1a/20 framebuffer driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
