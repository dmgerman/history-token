multiline_comment|/*&n; * linux/drivers/video/neofb.c -- NeoMagic Framebuffer Driver&n; *&n; * Copyright (c) 2001  Denis Oliver Kropp &lt;dok@convergence.de&gt;&n; *&n; *&n; * Card specific code is based on XFree86&squot;s neomagic driver.&n; * Framebuffer framework code is based on code of cyber2000fb.&n; *&n; * This file is subject to the terms and conditions of the GNU General&n; * Public License.  See the file COPYING in the main directory of this&n; * archive for more details.&n; *&n; * 0.3.3&n; *  - Porting over to new fbdev api. (jsimmons)&n; *  &n; * 0.3.2&n; *  - got rid of all floating point (dok) &n; *&n; * 0.3.1&n; *  - added module license (dok)&n; *&n; * 0.3&n; *  - hardware accelerated clear and move for 2200 and above (dok)&n; *  - maximum allowed dotclock is handled now (dok)&n; *&n; * 0.2.1&n; *  - correct panning after X usage (dok)&n; *  - added module and kernel parameters (dok)&n; *  - no stretching if external display is enabled (dok)&n; *&n; * 0.2&n; *  - initial version (dok)&n; *&n; *&n; * TODO&n; * - ioctl for internal/external switching&n; * - blanking&n; * - 32bit depth support, maybe impossible&n; * - disable pan-on-sync, need specs&n; *&n; * BUGS&n; * - white margin on bootup like with tdfxfb (colormap problem?)&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#ifdef CONFIG_MTRR
macro_line|#include &lt;asm/mtrr.h&gt;
macro_line|#endif
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/neo_reg.h&gt;
DECL|macro|NEOFB_VERSION
mdefine_line|#define NEOFB_VERSION &quot;0.3.3&quot;
DECL|variable|default_par
r_struct
id|neofb_par
id|default_par
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|disabled
r_static
r_int
id|disabled
op_assign
l_int|0
suffix:semicolon
DECL|variable|internal
r_static
r_int
id|internal
op_assign
l_int|0
suffix:semicolon
DECL|variable|external
r_static
r_int
id|external
op_assign
l_int|0
suffix:semicolon
DECL|variable|nostretch
r_static
r_int
id|nostretch
op_assign
l_int|0
suffix:semicolon
DECL|variable|nopciburst
r_static
r_int
id|nopciburst
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;(c) 2001-2002  Denis Oliver Kropp &lt;dok@convergence.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;FBDev driver for NeoMagic PCI Chips&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|disabled
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|disabled
comma
l_string|&quot;Disable this driver&squot;s initialization.&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|internal
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|internal
comma
l_string|&quot;Enable output on internal LCD Display.&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|external
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|external
comma
l_string|&quot;Enable output on external CRT.&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|nostretch
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|nostretch
comma
l_string|&quot;Disable stretching of modes smaller than LCD.&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|nopciburst
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|nopciburst
comma
l_string|&quot;Disable PCI burst mode.&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|bios8
r_static
id|biosMode
id|bios8
(braket
)braket
op_assign
(brace
(brace
l_int|320
comma
l_int|240
comma
l_int|0x40
)brace
comma
(brace
l_int|300
comma
l_int|400
comma
l_int|0x42
)brace
comma
(brace
l_int|640
comma
l_int|400
comma
l_int|0x20
)brace
comma
(brace
l_int|640
comma
l_int|480
comma
l_int|0x21
)brace
comma
(brace
l_int|800
comma
l_int|600
comma
l_int|0x23
)brace
comma
(brace
l_int|1024
comma
l_int|768
comma
l_int|0x25
)brace
comma
)brace
suffix:semicolon
DECL|variable|bios16
r_static
id|biosMode
id|bios16
(braket
)braket
op_assign
(brace
(brace
l_int|320
comma
l_int|200
comma
l_int|0x2e
)brace
comma
(brace
l_int|320
comma
l_int|240
comma
l_int|0x41
)brace
comma
(brace
l_int|300
comma
l_int|400
comma
l_int|0x43
)brace
comma
(brace
l_int|640
comma
l_int|480
comma
l_int|0x31
)brace
comma
(brace
l_int|800
comma
l_int|600
comma
l_int|0x34
)brace
comma
(brace
l_int|1024
comma
l_int|768
comma
l_int|0x37
)brace
comma
)brace
suffix:semicolon
DECL|variable|bios24
r_static
id|biosMode
id|bios24
(braket
)braket
op_assign
(brace
(brace
l_int|640
comma
l_int|480
comma
l_int|0x32
)brace
comma
(brace
l_int|800
comma
l_int|600
comma
l_int|0x35
)brace
comma
(brace
l_int|1024
comma
l_int|768
comma
l_int|0x38
)brace
)brace
suffix:semicolon
macro_line|#ifdef NO_32BIT_SUPPORT_YET
multiline_comment|/* FIXME: guessed values, wrong */
DECL|variable|bios32
r_static
id|biosMode
id|bios32
(braket
)braket
op_assign
(brace
(brace
l_int|640
comma
l_int|480
comma
l_int|0x33
)brace
comma
(brace
l_int|800
comma
l_int|600
comma
l_int|0x36
)brace
comma
(brace
l_int|1024
comma
l_int|768
comma
l_int|0x39
)brace
)brace
suffix:semicolon
macro_line|#endif
DECL|function|neoFindMode
r_static
r_int
id|neoFindMode
c_func
(paren
r_int
id|xres
comma
r_int
id|yres
comma
r_int
id|depth
)paren
(brace
r_int
id|xres_s
suffix:semicolon
r_int
id|i
comma
id|size
suffix:semicolon
id|biosMode
op_star
id|mode
suffix:semicolon
r_switch
c_cond
(paren
id|depth
)paren
(brace
r_case
l_int|8
suffix:colon
id|size
op_assign
r_sizeof
(paren
id|bios8
)paren
op_div
r_sizeof
(paren
id|biosMode
)paren
suffix:semicolon
id|mode
op_assign
id|bios8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|size
op_assign
r_sizeof
(paren
id|bios16
)paren
op_div
r_sizeof
(paren
id|biosMode
)paren
suffix:semicolon
id|mode
op_assign
id|bios16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|size
op_assign
r_sizeof
(paren
id|bios24
)paren
op_div
r_sizeof
(paren
id|biosMode
)paren
suffix:semicolon
id|mode
op_assign
id|bios24
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef NO_32BIT_SUPPORT_YET
r_case
l_int|32
suffix:colon
id|size
op_assign
r_sizeof
(paren
id|bios32
)paren
op_div
r_sizeof
(paren
id|biosMode
)paren
suffix:semicolon
id|mode
op_assign
id|bios32
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|xres
op_le
id|mode
(braket
id|i
)braket
dot
id|x_res
)paren
(brace
id|xres_s
op_assign
id|mode
(braket
id|i
)braket
dot
id|x_res
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mode
(braket
id|i
)braket
dot
id|x_res
op_ne
id|xres_s
)paren
r_return
id|mode
(braket
id|i
op_minus
l_int|1
)braket
dot
id|mode
suffix:semicolon
r_if
c_cond
(paren
id|yres
op_le
id|mode
(braket
id|i
)braket
dot
id|y_res
)paren
r_return
id|mode
(braket
id|i
)braket
dot
id|mode
suffix:semicolon
)brace
)brace
)brace
r_return
id|mode
(braket
id|size
op_minus
l_int|1
)braket
dot
id|mode
suffix:semicolon
)brace
multiline_comment|/*&n; * neoCalcVCLK --&n; *&n; * Determine the closest clock frequency to the one requested.&n; */
DECL|macro|REF_FREQ
mdefine_line|#define REF_FREQ 0xe517&t;&t;/* 14.31818 in 20.12 fixed point */
DECL|macro|MAX_N
mdefine_line|#define MAX_N 127
DECL|macro|MAX_D
mdefine_line|#define MAX_D 31
DECL|macro|MAX_F
mdefine_line|#define MAX_F 1
DECL|function|neoCalcVCLK
r_static
r_void
id|neoCalcVCLK
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|neofb_par
op_star
id|par
comma
r_int
id|freq
)paren
(brace
r_int
id|n
comma
id|d
comma
id|f
suffix:semicolon
r_int
id|n_best
op_assign
l_int|0
comma
id|d_best
op_assign
l_int|0
comma
id|f_best
op_assign
l_int|0
suffix:semicolon
r_int
id|f_best_diff
op_assign
(paren
l_int|0x7ffff
op_lshift
l_int|12
)paren
suffix:semicolon
multiline_comment|/* 20.12 */
r_int
id|f_target
op_assign
(paren
id|freq
op_lshift
l_int|12
)paren
op_div
l_int|1000
suffix:semicolon
multiline_comment|/* 20.12 */
r_for
c_loop
(paren
id|f
op_assign
l_int|0
suffix:semicolon
id|f
op_le
id|MAX_F
suffix:semicolon
id|f
op_increment
)paren
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
op_le
id|MAX_N
suffix:semicolon
id|n
op_increment
)paren
r_for
c_loop
(paren
id|d
op_assign
l_int|0
suffix:semicolon
id|d
op_le
id|MAX_D
suffix:semicolon
id|d
op_increment
)paren
(brace
r_int
id|f_out
suffix:semicolon
multiline_comment|/* 20.12 */
r_int
id|f_diff
suffix:semicolon
multiline_comment|/* 20.12 */
id|f_out
op_assign
(paren
(paren
(paren
(paren
id|n
op_plus
l_int|1
)paren
op_lshift
l_int|12
)paren
op_div
(paren
(paren
id|d
op_plus
l_int|1
)paren
op_star
(paren
l_int|1
op_lshift
id|f
)paren
)paren
)paren
op_rshift
l_int|12
)paren
op_star
id|REF_FREQ
suffix:semicolon
id|f_diff
op_assign
id|abs
c_func
(paren
id|f_out
op_minus
id|f_target
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f_diff
OL
id|f_best_diff
)paren
(brace
id|f_best_diff
op_assign
id|f_diff
suffix:semicolon
id|n_best
op_assign
id|n
suffix:semicolon
id|d_best
op_assign
id|d
suffix:semicolon
id|f_best
op_assign
id|f
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2200
op_logical_or
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2230
op_logical_or
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2360
op_logical_or
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2380
)paren
(brace
multiline_comment|/* NOT_DONE:  We are trying the full range of the 2200 clock.&n;&t;&t;   We should be able to try n up to 2047 */
id|par-&gt;VCLK3NumeratorLow
op_assign
id|n_best
suffix:semicolon
id|par-&gt;VCLK3NumeratorHigh
op_assign
(paren
id|f_best
op_lshift
l_int|7
)paren
suffix:semicolon
)brace
r_else
id|par-&gt;VCLK3NumeratorLow
op_assign
id|n_best
op_or
(paren
id|f_best
op_lshift
l_int|7
)paren
suffix:semicolon
id|par-&gt;VCLK3Denominator
op_assign
id|d_best
suffix:semicolon
macro_line|#ifdef NEOFB_DEBUG
id|printk
c_func
(paren
l_string|&quot;neoVCLK: f:%d NumLow=%d NumHi=%d Den=%d Df=%d&bslash;n&quot;
comma
id|f_target
op_rshift
l_int|12
comma
id|par-&gt;VCLK3NumeratorLow
comma
id|par-&gt;VCLK3NumeratorHigh
comma
id|par-&gt;VCLK3Denominator
comma
id|f_best_diff
op_rshift
l_int|12
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * vgaHWInit --&n; *      Handle the initialization, etc. of a screen.&n; *      Return FALSE on failure.&n; */
DECL|function|vgaHWInit
r_static
r_int
id|vgaHWInit
c_func
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_const
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|neofb_par
op_star
id|par
comma
r_struct
id|xtimings
op_star
id|timings
)paren
(brace
id|par-&gt;MiscOutReg
op_assign
l_int|0x23
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|timings-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
)paren
id|par-&gt;MiscOutReg
op_or_assign
l_int|0x40
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|timings-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
)paren
id|par-&gt;MiscOutReg
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/*&n;&t; * Time Sequencer&n;&t; */
id|par-&gt;Sequencer
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;Sequencer
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
id|par-&gt;Sequencer
(braket
l_int|2
)braket
op_assign
l_int|0x0F
suffix:semicolon
id|par-&gt;Sequencer
(braket
l_int|3
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Font select */
id|par-&gt;Sequencer
(braket
l_int|4
)braket
op_assign
l_int|0x0E
suffix:semicolon
multiline_comment|/* Misc */
multiline_comment|/*&n;&t; * CRTC Controller&n;&t; */
id|par-&gt;CRTC
(braket
l_int|0
)braket
op_assign
(paren
id|timings-&gt;HTotal
op_rshift
l_int|3
)paren
op_minus
l_int|5
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|1
)braket
op_assign
(paren
id|timings-&gt;HDisplay
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|2
)braket
op_assign
(paren
id|timings-&gt;HDisplay
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|3
)braket
op_assign
(paren
(paren
(paren
id|timings-&gt;HTotal
op_rshift
l_int|3
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0x1F
)paren
op_or
l_int|0x80
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|4
)braket
op_assign
(paren
id|timings-&gt;HSyncStart
op_rshift
l_int|3
)paren
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|5
)braket
op_assign
(paren
(paren
(paren
(paren
id|timings-&gt;HTotal
op_rshift
l_int|3
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0x20
)paren
op_lshift
l_int|2
)paren
op_or
(paren
(paren
(paren
id|timings-&gt;HSyncEnd
op_rshift
l_int|3
)paren
)paren
op_amp
l_int|0x1F
)paren
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|6
)braket
op_assign
(paren
id|timings-&gt;VTotal
op_minus
l_int|2
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|7
)braket
op_assign
(paren
(paren
(paren
id|timings-&gt;VTotal
op_minus
l_int|2
)paren
op_amp
l_int|0x100
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|timings-&gt;VDisplay
op_minus
l_int|1
)paren
op_amp
l_int|0x100
)paren
op_rshift
l_int|7
)paren
op_or
(paren
(paren
id|timings-&gt;VSyncStart
op_amp
l_int|0x100
)paren
op_rshift
l_int|6
)paren
op_or
(paren
(paren
(paren
id|timings-&gt;VDisplay
op_minus
l_int|1
)paren
op_amp
l_int|0x100
)paren
op_rshift
l_int|5
)paren
op_or
l_int|0x10
op_or
(paren
(paren
(paren
id|timings-&gt;VTotal
op_minus
l_int|2
)paren
op_amp
l_int|0x200
)paren
op_rshift
l_int|4
)paren
op_or
(paren
(paren
(paren
id|timings-&gt;VDisplay
op_minus
l_int|1
)paren
op_amp
l_int|0x200
)paren
op_rshift
l_int|3
)paren
op_or
(paren
(paren
id|timings-&gt;VSyncStart
op_amp
l_int|0x200
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|8
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|9
)braket
op_assign
(paren
(paren
(paren
id|timings-&gt;VDisplay
op_minus
l_int|1
)paren
op_amp
l_int|0x200
)paren
op_rshift
l_int|4
)paren
op_or
l_int|0x40
suffix:semicolon
r_if
c_cond
(paren
id|timings-&gt;dblscan
)paren
id|par-&gt;CRTC
(braket
l_int|9
)braket
op_or_assign
l_int|0x80
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|10
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|11
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|12
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|13
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|14
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|15
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|16
)braket
op_assign
id|timings-&gt;VSyncStart
op_amp
l_int|0xFF
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|17
)braket
op_assign
(paren
id|timings-&gt;VSyncEnd
op_amp
l_int|0x0F
)paren
op_or
l_int|0x20
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|18
)braket
op_assign
(paren
id|timings-&gt;VDisplay
op_minus
l_int|1
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|19
)braket
op_assign
id|var-&gt;xres_virtual
op_rshift
l_int|4
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|20
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|21
)braket
op_assign
(paren
id|timings-&gt;VDisplay
op_minus
l_int|1
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|22
)braket
op_assign
(paren
id|timings-&gt;VTotal
op_minus
l_int|1
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|23
)braket
op_assign
l_int|0xC3
suffix:semicolon
id|par-&gt;CRTC
(braket
l_int|24
)braket
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/*&n;&t; * are these unnecessary?&n;&t; * vgaHWHBlankKGA(mode, regp, 0, KGA_FIX_OVERSCAN | KGA_ENABLE_ON_ZERO);&n;&t; * vgaHWVBlankKGA(mode, regp, 0, KGA_FIX_OVERSCAN | KGA_ENABLE_ON_ZERO);&n;&t; */
multiline_comment|/*&n;&t; * Graphics Display Controller&n;&t; */
id|par-&gt;Graphics
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;Graphics
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;Graphics
(braket
l_int|2
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;Graphics
(braket
l_int|3
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;Graphics
(braket
l_int|4
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;Graphics
(braket
l_int|5
)braket
op_assign
l_int|0x40
suffix:semicolon
id|par-&gt;Graphics
(braket
l_int|6
)braket
op_assign
l_int|0x05
suffix:semicolon
multiline_comment|/* only map 64k VGA memory !!!! */
id|par-&gt;Graphics
(braket
l_int|7
)braket
op_assign
l_int|0x0F
suffix:semicolon
id|par-&gt;Graphics
(braket
l_int|8
)braket
op_assign
l_int|0xFF
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* standard colormap translation */
id|par-&gt;Attribute
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|2
)braket
op_assign
l_int|0x02
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|3
)braket
op_assign
l_int|0x03
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|4
)braket
op_assign
l_int|0x04
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|5
)braket
op_assign
l_int|0x05
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|6
)braket
op_assign
l_int|0x06
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|7
)braket
op_assign
l_int|0x07
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|8
)braket
op_assign
l_int|0x08
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|9
)braket
op_assign
l_int|0x09
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|10
)braket
op_assign
l_int|0x0A
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|11
)braket
op_assign
l_int|0x0B
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|12
)braket
op_assign
l_int|0x0C
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|13
)braket
op_assign
l_int|0x0D
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|14
)braket
op_assign
l_int|0x0E
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|15
)braket
op_assign
l_int|0x0F
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|16
)braket
op_assign
l_int|0x41
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|17
)braket
op_assign
l_int|0xFF
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|18
)braket
op_assign
l_int|0x0F
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|19
)braket
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;Attribute
(braket
l_int|20
)braket
op_assign
l_int|0x00
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vgaHWLock
r_static
r_void
id|vgaHWLock
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Protect CRTC[0-7] */
id|VGAwCR
c_func
(paren
l_int|0x11
comma
id|VGArCR
c_func
(paren
l_int|0x11
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
)brace
DECL|function|vgaHWUnlock
r_static
r_void
id|vgaHWUnlock
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Unprotect CRTC[0-7] */
id|VGAwCR
c_func
(paren
l_int|0x11
comma
id|VGArCR
c_func
(paren
l_int|0x11
)paren
op_amp
op_complement
l_int|0x80
)paren
suffix:semicolon
)brace
DECL|function|neoLock
r_static
r_void
id|neoLock
c_func
(paren
r_void
)paren
(brace
id|VGAwGR
c_func
(paren
l_int|0x09
comma
l_int|0x00
)paren
suffix:semicolon
id|vgaHWLock
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|neoUnlock
r_static
r_void
id|neoUnlock
c_func
(paren
r_void
)paren
(brace
id|vgaHWUnlock
c_func
(paren
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x09
comma
l_int|0x26
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * vgaHWSeqReset&n; *      perform a sequencer reset.&n; */
DECL|function|vgaHWSeqReset
r_void
id|vgaHWSeqReset
c_func
(paren
r_int
id|start
)paren
(brace
r_if
c_cond
(paren
id|start
)paren
id|VGAwSEQ
c_func
(paren
l_int|0x00
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Synchronous Reset */
r_else
id|VGAwSEQ
c_func
(paren
l_int|0x00
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* End Reset */
)brace
DECL|function|vgaHWProtect
r_void
id|vgaHWProtect
c_func
(paren
r_int
id|on
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
(brace
multiline_comment|/*&n;&t;&t; * Turn off screen and disable sequencer.&n;&t;&t; */
id|tmp
op_assign
id|VGArSEQ
c_func
(paren
l_int|0x01
)paren
suffix:semicolon
id|vgaHWSeqReset
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* start synchronous reset */
id|VGAwSEQ
c_func
(paren
l_int|0x01
comma
id|tmp
op_or
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* disable the display */
id|VGAenablePalette
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Reenable sequencer, then turn on screen.&n;&t;&t; */
id|tmp
op_assign
id|VGArSEQ
c_func
(paren
l_int|0x01
)paren
suffix:semicolon
id|VGAwSEQ
c_func
(paren
l_int|0x01
comma
id|tmp
op_amp
op_complement
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* reenable display */
id|vgaHWSeqReset
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* clear synchronousreset */
id|VGAdisablePalette
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|vgaHWRestore
r_static
r_void
id|vgaHWRestore
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|neofb_par
op_star
id|par
)paren
(brace
r_int
id|i
suffix:semicolon
id|VGAwMISC
c_func
(paren
id|par-&gt;MiscOutReg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|VGAwSEQ
c_func
(paren
id|i
comma
id|par-&gt;Sequencer
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* Ensure CRTC registers 0-7 are unlocked by clearing bit 7 or CRTC[17] */
id|VGAwCR
c_func
(paren
l_int|17
comma
id|par-&gt;CRTC
(braket
l_int|17
)braket
op_amp
op_complement
l_int|0x80
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|25
suffix:semicolon
id|i
op_increment
)paren
id|VGAwCR
c_func
(paren
id|i
comma
id|par-&gt;CRTC
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
id|VGAwGR
c_func
(paren
id|i
comma
id|par-&gt;Graphics
(braket
id|i
)braket
)paren
suffix:semicolon
id|VGAenablePalette
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|21
suffix:semicolon
id|i
op_increment
)paren
id|VGAwATTR
c_func
(paren
id|i
comma
id|par-&gt;Attribute
(braket
id|i
)braket
)paren
suffix:semicolon
id|VGAdisablePalette
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- Hardware specific routines ------------------------- */
multiline_comment|/*&n; * Hardware Acceleration for Neo2200+&n; */
DECL|function|neo2200_wait_idle
r_static
r_inline
r_void
id|neo2200_wait_idle
c_func
(paren
r_struct
id|neofb_par
op_star
id|par
)paren
(brace
r_int
id|waitcycles
suffix:semicolon
r_while
c_loop
(paren
id|par-&gt;neo2200-&gt;bltStat
op_amp
l_int|1
)paren
id|waitcycles
op_increment
suffix:semicolon
)brace
DECL|function|neo2200_wait_fifo
r_static
r_inline
r_void
id|neo2200_wait_fifo
c_func
(paren
r_struct
id|neofb_par
op_star
id|par
comma
r_int
id|requested_fifo_space
)paren
(brace
singleline_comment|//  ndev-&gt;neo.waitfifo_calls++;
singleline_comment|//  ndev-&gt;neo.waitfifo_sum += requested_fifo_space;
multiline_comment|/* FIXME: does not work&n;&t;   if (neo_fifo_space &lt; requested_fifo_space)&n;&t;   {&n;&t;   neo_fifo_waitcycles++;&n;&n;&t;   while (1)&n;&t;   {&n;&t;   neo_fifo_space = (neo2200-&gt;bltStat &gt;&gt; 8);&n;&t;   if (neo_fifo_space &gt;= requested_fifo_space)&n;&t;   break;&n;&t;   }&n;&t;   }&n;&t;   else&n;&t;   {&n;&t;   neo_fifo_cache_hits++;&n;&t;   }&n;&n;&t;   neo_fifo_space -= requested_fifo_space;&n;&t; */
id|neo2200_wait_idle
c_func
(paren
id|par
)paren
suffix:semicolon
)brace
DECL|function|neo2200_accel_init
r_static
r_inline
r_void
id|neo2200_accel_init
c_func
(paren
r_struct
id|fb_info
op_star
id|fb
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_struct
id|neofb_par
op_star
id|par
op_assign
(paren
r_struct
id|neofb_par
op_star
)paren
id|fb-&gt;par
suffix:semicolon
id|Neo2200
op_star
id|neo2200
op_assign
id|par-&gt;neo2200
suffix:semicolon
id|u32
id|bltMod
comma
id|pitch
suffix:semicolon
id|neo2200_wait_idle
c_func
(paren
id|par
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
id|bltMod
op_assign
id|NEO_MODE1_DEPTH8
suffix:semicolon
id|pitch
op_assign
id|var-&gt;xres_virtual
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
r_case
l_int|16
suffix:colon
id|bltMod
op_assign
id|NEO_MODE1_DEPTH16
suffix:semicolon
id|pitch
op_assign
id|var-&gt;xres_virtual
op_star
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;neofb: neo2200_accel_init: unexpected bits per pixel!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|neo2200-&gt;bltStat
op_assign
id|bltMod
op_lshift
l_int|16
suffix:semicolon
id|neo2200-&gt;pitch
op_assign
(paren
id|pitch
op_lshift
l_int|16
)paren
op_or
id|pitch
suffix:semicolon
)brace
r_static
r_void
DECL|function|neo2200_accel_bmove
id|neo2200_accel_bmove
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_struct
id|fb_info
op_star
id|fb
op_assign
(paren
r_struct
id|fb_info
op_star
)paren
id|p-&gt;fb_info
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|p-&gt;fb_info-&gt;var
suffix:semicolon
r_struct
id|neofb_par
op_star
id|par
op_assign
(paren
r_struct
id|neofb_par
op_star
)paren
id|fb-&gt;par
suffix:semicolon
id|Neo2200
op_star
id|neo2200
op_assign
id|par-&gt;neo2200
suffix:semicolon
id|u_long
id|src
comma
id|dst
suffix:semicolon
r_int
id|bpp
comma
id|pitch
comma
id|inc_y
suffix:semicolon
id|u_int
id|fh
comma
id|fw
suffix:semicolon
multiline_comment|/* setting blitting direction does not work, so this case is unaccelerated */
r_if
c_cond
(paren
id|sx
op_ne
id|dx
)paren
(brace
id|neo2200_wait_idle
c_func
(paren
id|par
)paren
suffix:semicolon
id|p-&gt;dispsw
op_member_access_from_pointer
id|bmove
c_func
(paren
id|p
comma
id|sy
comma
id|sx
comma
id|dy
comma
id|dx
comma
id|height
comma
id|width
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bpp
op_assign
(paren
id|var-&gt;bits_per_pixel
op_plus
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
id|pitch
op_assign
id|var-&gt;xres_virtual
op_star
id|bpp
suffix:semicolon
id|fw
op_assign
id|fontwidth
c_func
(paren
id|p
)paren
suffix:semicolon
id|sx
op_mul_assign
id|fw
op_star
id|bpp
suffix:semicolon
id|dx
op_mul_assign
id|fw
op_star
id|bpp
suffix:semicolon
id|width
op_mul_assign
id|fw
suffix:semicolon
id|fh
op_assign
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|sy
op_mul_assign
id|fh
suffix:semicolon
id|dy
op_mul_assign
id|fh
suffix:semicolon
r_if
c_cond
(paren
id|sy
OG
id|dy
)paren
id|inc_y
op_assign
id|fh
suffix:semicolon
r_else
(brace
id|inc_y
op_assign
op_minus
id|fh
suffix:semicolon
id|sy
op_add_assign
(paren
id|height
op_minus
l_int|1
)paren
op_star
id|fh
suffix:semicolon
id|dy
op_add_assign
(paren
id|height
op_minus
l_int|1
)paren
op_star
id|fh
suffix:semicolon
)brace
id|neo2200_wait_fifo
c_func
(paren
id|par
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set blt control */
id|neo2200-&gt;bltCntl
op_assign
id|NEO_BC3_FIFO_EN
op_or
id|NEO_BC3_SKIP_MAPPING
op_or
l_int|0x0c0000
suffix:semicolon
multiline_comment|/* looks silly, but setting the blitting direction did not work */
r_while
c_loop
(paren
id|height
op_decrement
)paren
(brace
id|src
op_assign
id|sx
op_plus
id|sy
op_star
id|pitch
suffix:semicolon
id|dst
op_assign
id|dx
op_plus
id|dy
op_star
id|pitch
suffix:semicolon
id|neo2200_wait_fifo
c_func
(paren
id|par
comma
l_int|3
)paren
suffix:semicolon
id|neo2200-&gt;srcStart
op_assign
id|src
suffix:semicolon
id|neo2200-&gt;dstStart
op_assign
id|dst
suffix:semicolon
id|neo2200-&gt;xyExt
op_assign
(paren
id|fh
op_lshift
l_int|16
)paren
op_or
(paren
id|width
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|sy
op_add_assign
id|inc_y
suffix:semicolon
id|dy
op_add_assign
id|inc_y
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|neo2200_accel_clear
id|neo2200_accel_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_struct
id|fb_info
op_star
id|fb
op_assign
(paren
r_struct
id|fb_info
op_star
)paren
id|p-&gt;fb_info
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|p-&gt;fb_info-&gt;var
suffix:semicolon
r_struct
id|neofb_par
op_star
id|par
op_assign
(paren
r_struct
id|neofb_par
op_star
)paren
id|fb-&gt;par
suffix:semicolon
id|Neo2200
op_star
id|neo2200
op_assign
id|par-&gt;neo2200
suffix:semicolon
id|u_long
id|dst
suffix:semicolon
id|u_int
id|fw
comma
id|fh
suffix:semicolon
id|u32
id|bgx
op_assign
id|attr_bgcol_ec
c_func
(paren
id|p
comma
id|conp
)paren
suffix:semicolon
id|fw
op_assign
id|fontwidth
c_func
(paren
id|p
)paren
suffix:semicolon
id|fh
op_assign
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|dst
op_assign
id|sx
op_star
id|fw
op_plus
id|sy
op_star
id|var-&gt;xres_virtual
op_star
id|fh
suffix:semicolon
id|width
op_assign
id|width
op_star
id|fw
suffix:semicolon
id|height
op_assign
id|height
op_star
id|fh
suffix:semicolon
id|neo2200_wait_fifo
c_func
(paren
id|par
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* set blt control */
id|neo2200-&gt;bltCntl
op_assign
id|NEO_BC3_FIFO_EN
op_or
id|NEO_BC0_SRC_IS_FG
op_or
id|NEO_BC3_SKIP_MAPPING
op_or
l_int|0x0c0000
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
id|neo2200-&gt;fgColor
op_assign
id|bgx
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|neo2200-&gt;fgColor
op_assign
(paren
(paren
id|u16
op_star
)paren
(paren
id|p-&gt;fb_info
)paren
op_member_access_from_pointer
id|pseudo_palette
)paren
(braket
id|bgx
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
id|neo2200-&gt;dstStart
op_assign
id|dst
op_star
(paren
(paren
id|var-&gt;bits_per_pixel
op_plus
l_int|7
)paren
op_div
l_int|8
)paren
suffix:semicolon
id|neo2200-&gt;xyExt
op_assign
(paren
id|height
op_lshift
l_int|16
)paren
op_or
(paren
id|width
op_amp
l_int|0xffff
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
r_static
r_int
DECL|function|neofb_check_var
id|neofb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|neofb_par
op_star
id|par
op_assign
(paren
r_struct
id|neofb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
r_int
id|pixclock
op_assign
id|var-&gt;pixclock
suffix:semicolon
r_struct
id|xtimings
id|timings
suffix:semicolon
r_int
id|memlen
comma
id|vramlen
suffix:semicolon
r_int
id|mode_ok
op_assign
l_int|0
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;neofb_check_var&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pixclock
)paren
id|pixclock
op_assign
l_int|10000
suffix:semicolon
multiline_comment|/* 10ns = 100MHz */
id|timings.pixclock
op_assign
l_int|1000000000
op_div
id|pixclock
suffix:semicolon
r_if
c_cond
(paren
id|timings.pixclock
OL
l_int|1
)paren
id|timings.pixclock
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|timings.pixclock
OG
id|par-&gt;maxClock
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|timings.dblscan
op_assign
id|var-&gt;vmode
op_amp
id|FB_VMODE_DOUBLE
suffix:semicolon
id|timings.interlaced
op_assign
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
suffix:semicolon
id|timings.HDisplay
op_assign
id|var-&gt;xres
suffix:semicolon
id|timings.HSyncStart
op_assign
id|timings.HDisplay
op_plus
id|var-&gt;right_margin
suffix:semicolon
id|timings.HSyncEnd
op_assign
id|timings.HSyncStart
op_plus
id|var-&gt;hsync_len
suffix:semicolon
id|timings.HTotal
op_assign
id|timings.HSyncEnd
op_plus
id|var-&gt;left_margin
suffix:semicolon
id|timings.VDisplay
op_assign
id|var-&gt;yres
suffix:semicolon
id|timings.VSyncStart
op_assign
id|timings.VDisplay
op_plus
id|var-&gt;lower_margin
suffix:semicolon
id|timings.VSyncEnd
op_assign
id|timings.VSyncStart
op_plus
id|var-&gt;vsync_len
suffix:semicolon
id|timings.VTotal
op_assign
id|timings.VSyncEnd
op_plus
id|var-&gt;upper_margin
suffix:semicolon
id|timings.sync
op_assign
id|var-&gt;sync
suffix:semicolon
multiline_comment|/* Is the mode larger than the LCD panel? */
r_if
c_cond
(paren
(paren
id|var-&gt;xres
OG
id|par-&gt;NeoPanelWidth
)paren
op_logical_or
(paren
id|var-&gt;yres
OG
id|par-&gt;NeoPanelHeight
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Mode (%dx%d) larger than the LCD panel (%dx%d)&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|par-&gt;NeoPanelWidth
comma
id|par-&gt;NeoPanelHeight
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Is the mode one of the acceptable sizes? */
r_switch
c_cond
(paren
id|var-&gt;xres
)paren
(brace
r_case
l_int|1280
suffix:colon
r_if
c_cond
(paren
id|var-&gt;yres
op_eq
l_int|1024
)paren
id|mode_ok
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1024
suffix:colon
r_if
c_cond
(paren
id|var-&gt;yres
op_eq
l_int|768
)paren
id|mode_ok
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|800
suffix:colon
r_if
c_cond
(paren
id|var-&gt;yres
op_eq
l_int|600
)paren
id|mode_ok
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|640
suffix:colon
r_if
c_cond
(paren
id|var-&gt;yres
op_eq
l_int|480
)paren
id|mode_ok
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|mode_ok
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Mode (%dx%d) won&squot;t display properly on LCD&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.msb_right
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
multiline_comment|/* PSEUDOCOLOUR, 256 */
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
multiline_comment|/* DIRECTCOLOUR, 64k */
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|11
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
multiline_comment|/* TRUECOLOUR, 16m */
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef NO_32BIT_SUPPORT_YET
r_case
l_int|32
suffix:colon
multiline_comment|/* TRUECOLOUR, 16m */
id|var-&gt;transp.offset
op_assign
l_int|24
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;neofb: no support for %dbpp&bslash;n&quot;
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|vramlen
op_assign
id|info-&gt;fix.smem_len
suffix:semicolon
r_if
c_cond
(paren
id|vramlen
OG
l_int|4
op_star
l_int|1024
op_star
l_int|1024
)paren
id|vramlen
op_assign
l_int|4
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres_virtual
OL
id|var-&gt;yres
)paren
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xres_virtual
OL
id|var-&gt;xres
)paren
id|var-&gt;xres_virtual
op_assign
id|var-&gt;xres
suffix:semicolon
id|memlen
op_assign
id|var-&gt;xres_virtual
op_star
id|var-&gt;bits_per_pixel
op_star
id|var-&gt;yres_virtual
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|memlen
OG
id|vramlen
)paren
(brace
id|var-&gt;yres_virtual
op_assign
id|vramlen
op_star
l_int|8
op_div
(paren
id|var-&gt;xres_virtual
op_star
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|memlen
op_assign
id|var-&gt;xres_virtual
op_star
id|var-&gt;bits_per_pixel
op_star
id|var-&gt;yres_virtual
op_div
l_int|8
suffix:semicolon
)brace
multiline_comment|/* we must round yres/xres down, we already rounded y/xres_virtual up&n;&t;   if it was possible. We should return -EINVAL, but I disagree */
r_if
c_cond
(paren
id|var-&gt;yres_virtual
OL
id|var-&gt;yres
)paren
id|var-&gt;yres
op_assign
id|var-&gt;yres_virtual
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xres_virtual
OL
id|var-&gt;xres
)paren
id|var-&gt;xres
op_assign
id|var-&gt;xres_virtual
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xoffset
op_plus
id|var-&gt;xres
OG
id|var-&gt;xres_virtual
)paren
id|var-&gt;xoffset
op_assign
id|var-&gt;xres_virtual
op_minus
id|var-&gt;xres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yoffset
op_plus
id|var-&gt;yres
OG
id|var-&gt;yres_virtual
)paren
id|var-&gt;yoffset
op_assign
id|var-&gt;yres_virtual
op_minus
id|var-&gt;yres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_ge
l_int|24
op_logical_or
op_logical_neg
id|par-&gt;neo2200
)paren
id|var-&gt;accel_flags
op_and_assign
op_complement
id|FB_ACCELF_TEXT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|neofb_set_par
id|neofb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|neofb_par
op_star
id|par
op_assign
(paren
r_struct
id|neofb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_struct
id|xtimings
id|timings
suffix:semicolon
r_int
r_char
id|temp
suffix:semicolon
r_int
id|i
comma
id|clock_hi
op_assign
l_int|0
suffix:semicolon
r_int
id|lcd_stretch
suffix:semicolon
r_int
id|hoffset
comma
id|voffset
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;neofb_set_par&quot;
)paren
suffix:semicolon
id|neoUnlock
c_func
(paren
)paren
suffix:semicolon
id|vgaHWProtect
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Blank the screen */
id|timings.dblscan
op_assign
id|info-&gt;var.vmode
op_amp
id|FB_VMODE_DOUBLE
suffix:semicolon
id|timings.interlaced
op_assign
id|info-&gt;var.vmode
op_amp
id|FB_VMODE_INTERLACED
suffix:semicolon
id|timings.HDisplay
op_assign
id|info-&gt;var.xres
suffix:semicolon
id|timings.HSyncStart
op_assign
id|timings.HDisplay
op_plus
id|info-&gt;var.right_margin
suffix:semicolon
id|timings.HSyncEnd
op_assign
id|timings.HSyncStart
op_plus
id|info-&gt;var.hsync_len
suffix:semicolon
id|timings.HTotal
op_assign
id|timings.HSyncEnd
op_plus
id|info-&gt;var.left_margin
suffix:semicolon
id|timings.VDisplay
op_assign
id|info-&gt;var.yres
suffix:semicolon
id|timings.VSyncStart
op_assign
id|timings.VDisplay
op_plus
id|info-&gt;var.lower_margin
suffix:semicolon
id|timings.VSyncEnd
op_assign
id|timings.VSyncStart
op_plus
id|info-&gt;var.vsync_len
suffix:semicolon
id|timings.VTotal
op_assign
id|timings.VSyncEnd
op_plus
id|info-&gt;var.upper_margin
suffix:semicolon
id|timings.sync
op_assign
id|info-&gt;var.sync
suffix:semicolon
id|timings.pixclock
op_assign
id|PICOS2KHZ
c_func
(paren
id|info-&gt;var.pixclock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timings.pixclock
OL
l_int|1
)paren
id|timings.pixclock
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * This will allocate the datastructure and initialize all of the&n;&t; * generic VGA registers.&n;&t; */
r_if
c_cond
(paren
id|vgaHWInit
c_func
(paren
op_amp
id|info-&gt;var
comma
id|info
comma
id|par
comma
op_amp
id|timings
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * The default value assigned by vgaHW.c is 0x41, but this does&n;&t; * not work for NeoMagic.&n;&t; */
id|par-&gt;Attribute
(braket
l_int|16
)braket
op_assign
l_int|0x01
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
id|par-&gt;CRTC
(braket
l_int|0x13
)braket
op_assign
id|info-&gt;var.xres_virtual
op_rshift
l_int|3
suffix:semicolon
id|par-&gt;ExtCRTOffset
op_assign
id|info-&gt;var.xres_virtual
op_rshift
l_int|11
suffix:semicolon
id|par-&gt;ExtColorModeSelect
op_assign
l_int|0x11
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|par-&gt;CRTC
(braket
l_int|0x13
)braket
op_assign
id|info-&gt;var.xres_virtual
op_rshift
l_int|2
suffix:semicolon
id|par-&gt;ExtCRTOffset
op_assign
id|info-&gt;var.xres_virtual
op_rshift
l_int|10
suffix:semicolon
id|par-&gt;ExtColorModeSelect
op_assign
l_int|0x13
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|par-&gt;CRTC
(braket
l_int|0x13
)braket
op_assign
(paren
id|info-&gt;var.xres_virtual
op_star
l_int|3
)paren
op_rshift
l_int|3
suffix:semicolon
id|par-&gt;ExtCRTOffset
op_assign
(paren
id|info-&gt;var.xres_virtual
op_star
l_int|3
)paren
op_rshift
l_int|11
suffix:semicolon
id|par-&gt;ExtColorModeSelect
op_assign
l_int|0x14
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef NO_32BIT_SUPPORT_YET
r_case
l_int|32
suffix:colon
multiline_comment|/* FIXME: guessed values */
id|par-&gt;CRTC
(braket
l_int|0x13
)braket
op_assign
id|info-&gt;var.xres_virtual
op_rshift
l_int|1
suffix:semicolon
id|par-&gt;ExtCRTOffset
op_assign
id|info-&gt;var.xres_virtual
op_rshift
l_int|9
suffix:semicolon
id|par-&gt;ExtColorModeSelect
op_assign
l_int|0x15
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|par-&gt;ExtCRTDispAddr
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Vertical Extension */
id|par-&gt;VerticalExt
op_assign
(paren
(paren
(paren
id|timings.VTotal
op_minus
l_int|2
)paren
op_amp
l_int|0x400
)paren
op_rshift
l_int|10
)paren
op_or
(paren
(paren
(paren
id|timings.VDisplay
op_minus
l_int|1
)paren
op_amp
l_int|0x400
)paren
op_rshift
l_int|9
)paren
op_or
(paren
(paren
(paren
id|timings.VSyncStart
)paren
op_amp
l_int|0x400
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|timings.VSyncStart
)paren
op_amp
l_int|0x400
)paren
op_rshift
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Fast write bursts on unless disabled. */
r_if
c_cond
(paren
id|par-&gt;pci_burst
)paren
id|par-&gt;SysIfaceCntl1
op_assign
l_int|0x30
suffix:semicolon
r_else
id|par-&gt;SysIfaceCntl1
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;SysIfaceCntl2
op_assign
l_int|0xc0
suffix:semicolon
multiline_comment|/* VESA Bios sets this to 0x80! */
multiline_comment|/* Enable any user specified display devices. */
id|par-&gt;PanelDispCntlReg1
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;internal_display
)paren
id|par-&gt;PanelDispCntlReg1
op_or_assign
l_int|0x02
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;external_display
)paren
id|par-&gt;PanelDispCntlReg1
op_or_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* If the user did not specify any display devices, then... */
r_if
c_cond
(paren
id|par-&gt;PanelDispCntlReg1
op_eq
l_int|0x00
)paren
(brace
multiline_comment|/* Default to internal (i.e., LCD) only. */
id|par-&gt;PanelDispCntlReg1
op_or_assign
l_int|0x02
suffix:semicolon
)brace
multiline_comment|/* If we are using a fixed mode, then tell the chip we are. */
r_switch
c_cond
(paren
id|info-&gt;var.xres
)paren
(brace
r_case
l_int|1280
suffix:colon
id|par-&gt;PanelDispCntlReg1
op_or_assign
l_int|0x60
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1024
suffix:colon
id|par-&gt;PanelDispCntlReg1
op_or_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|800
suffix:colon
id|par-&gt;PanelDispCntlReg1
op_or_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|640
suffix:colon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* Setup shadow register locking. */
r_switch
c_cond
(paren
id|par-&gt;PanelDispCntlReg1
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* External CRT only mode: */
id|par-&gt;GeneralLockReg
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* We need to program the VCLK for external display only mode. */
id|par-&gt;ProgramVCLK
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* Internal LCD only mode: */
r_case
l_int|0x03
suffix:colon
multiline_comment|/* Simultaneous internal/external (LCD/CRT) mode: */
id|par-&gt;GeneralLockReg
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Don&squot;t program the VCLK when using the LCD. */
id|par-&gt;ProgramVCLK
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If the screen is to be stretched, turn on stretching for the&n;&t; * various modes.&n;&t; *&n;&t; * OPTION_LCD_STRETCH means stretching should be turned off!&n;&t; */
id|par-&gt;PanelDispCntlReg2
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;PanelDispCntlReg3
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;lcd_stretch
op_logical_and
(paren
id|par-&gt;PanelDispCntlReg1
op_eq
l_int|0x02
)paren
op_logical_and
multiline_comment|/* LCD only */
(paren
id|info-&gt;var.xres
op_ne
id|par-&gt;NeoPanelWidth
)paren
)paren
(brace
r_switch
c_cond
(paren
id|info-&gt;var.xres
)paren
(brace
r_case
l_int|320
suffix:colon
multiline_comment|/* Needs testing.  KEM -- 24 May 98 */
r_case
l_int|400
suffix:colon
multiline_comment|/* Needs testing.  KEM -- 24 May 98 */
r_case
l_int|640
suffix:colon
r_case
l_int|800
suffix:colon
r_case
l_int|1024
suffix:colon
id|lcd_stretch
op_assign
l_int|1
suffix:semicolon
id|par-&gt;PanelDispCntlReg2
op_or_assign
l_int|0xC6
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|lcd_stretch
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No stretching in these modes. */
)brace
)brace
r_else
id|lcd_stretch
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * If the screen is to be centerd, turn on the centering for the&n;&t; * various modes.&n;&t; */
id|par-&gt;PanelVertCenterReg1
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;PanelVertCenterReg2
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;PanelVertCenterReg3
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;PanelVertCenterReg4
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;PanelVertCenterReg5
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;PanelHorizCenterReg1
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;PanelHorizCenterReg2
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;PanelHorizCenterReg3
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;PanelHorizCenterReg4
op_assign
l_int|0x00
suffix:semicolon
id|par-&gt;PanelHorizCenterReg5
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;PanelDispCntlReg1
op_amp
l_int|0x02
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;var.xres
op_eq
id|par-&gt;NeoPanelWidth
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * No centering required when the requested display width&n;&t;&t;&t; * equals the panel width.&n;&t;&t;&t; */
)brace
r_else
(brace
id|par-&gt;PanelDispCntlReg2
op_or_assign
l_int|0x01
suffix:semicolon
id|par-&gt;PanelDispCntlReg3
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Calculate the horizontal and vertical offsets. */
r_if
c_cond
(paren
op_logical_neg
id|lcd_stretch
)paren
(brace
id|hoffset
op_assign
(paren
(paren
id|par-&gt;NeoPanelWidth
op_minus
id|info-&gt;var.xres
)paren
op_rshift
l_int|4
)paren
op_minus
l_int|1
suffix:semicolon
id|voffset
op_assign
(paren
(paren
id|par-&gt;NeoPanelHeight
op_minus
id|info-&gt;var.yres
)paren
op_rshift
l_int|1
)paren
op_minus
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Stretched modes cannot be centered. */
id|hoffset
op_assign
l_int|0
suffix:semicolon
id|voffset
op_assign
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|info-&gt;var.xres
)paren
(brace
r_case
l_int|320
suffix:colon
multiline_comment|/* Needs testing.  KEM -- 24 May 98 */
id|par-&gt;PanelHorizCenterReg3
op_assign
id|hoffset
suffix:semicolon
id|par-&gt;PanelVertCenterReg2
op_assign
id|voffset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|400
suffix:colon
multiline_comment|/* Needs testing.  KEM -- 24 May 98 */
id|par-&gt;PanelHorizCenterReg4
op_assign
id|hoffset
suffix:semicolon
id|par-&gt;PanelVertCenterReg1
op_assign
id|voffset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|640
suffix:colon
id|par-&gt;PanelHorizCenterReg1
op_assign
id|hoffset
suffix:semicolon
id|par-&gt;PanelVertCenterReg3
op_assign
id|voffset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|800
suffix:colon
id|par-&gt;PanelHorizCenterReg2
op_assign
id|hoffset
suffix:semicolon
id|par-&gt;PanelVertCenterReg4
op_assign
id|voffset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1024
suffix:colon
id|par-&gt;PanelHorizCenterReg5
op_assign
id|hoffset
suffix:semicolon
id|par-&gt;PanelVertCenterReg5
op_assign
id|voffset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1280
suffix:colon
r_default
suffix:colon
multiline_comment|/* No centering in these modes. */
r_break
suffix:semicolon
)brace
)brace
)brace
id|par-&gt;biosMode
op_assign
id|neoFindMode
c_func
(paren
id|info-&gt;var.xres
comma
id|info-&gt;var.yres
comma
id|info-&gt;var.bits_per_pixel
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Calculate the VCLK that most closely matches the requested dot&n;&t; * clock.&n;&t; */
id|neoCalcVCLK
c_func
(paren
id|info
comma
id|par
comma
id|timings.pixclock
)paren
suffix:semicolon
multiline_comment|/* Since we program the clocks ourselves, always use VCLK3. */
id|par-&gt;MiscOutReg
op_or_assign
l_int|0x0C
suffix:semicolon
multiline_comment|/* linear colormap for non palettized modes */
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
multiline_comment|/* PseudoColor, 256 */
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
multiline_comment|/* DirectColor, 64k */
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|i
comma
l_int|0x3c8
)paren
suffix:semicolon
id|outb
c_func
(paren
id|i
op_lshift
l_int|1
comma
l_int|0x3c9
)paren
suffix:semicolon
id|outb
c_func
(paren
id|i
comma
l_int|0x3c9
)paren
suffix:semicolon
id|outb
c_func
(paren
id|i
op_lshift
l_int|1
comma
l_int|0x3c9
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
macro_line|#ifdef NO_32BIT_SUPPORT_YET
r_case
l_int|32
suffix:colon
macro_line|#endif
multiline_comment|/* TrueColor, 16m */
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|i
comma
l_int|0x3c8
)paren
suffix:semicolon
id|outb
c_func
(paren
id|i
comma
l_int|0x3c9
)paren
suffix:semicolon
id|outb
c_func
(paren
id|i
comma
l_int|0x3c9
)paren
suffix:semicolon
id|outb
c_func
(paren
id|i
comma
l_int|0x3c9
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* alread unlocked above */
multiline_comment|/* BOGUS  VGAwGR (0x09, 0x26); */
multiline_comment|/* don&squot;t know what this is, but it&squot;s 0 from bootup anyway */
id|VGAwGR
c_func
(paren
l_int|0x15
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* was set to 0x01 by my bios in text and vesa modes */
id|VGAwGR
c_func
(paren
l_int|0x0A
comma
id|par-&gt;GeneralLockReg
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The color mode needs to be set before calling vgaHWRestore&n;&t; * to ensure the DAC is initialized properly.&n;&t; *&n;&t; * NOTE: Make sure we don&squot;t change bits make sure we don&squot;t change&n;&t; * any reserved bits.&n;&t; */
id|temp
op_assign
id|VGArGR
c_func
(paren
l_int|0x90
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;fix.accel
)paren
(brace
r_case
id|FB_ACCEL_NEOMAGIC_NM2070
suffix:colon
id|temp
op_and_assign
l_int|0xF0
suffix:semicolon
multiline_comment|/* Save bits 7:4 */
id|temp
op_or_assign
(paren
id|par-&gt;ExtColorModeSelect
op_amp
op_complement
l_int|0xF0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2090
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2093
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2097
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2160
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2200
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2230
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2360
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2380
suffix:colon
id|temp
op_and_assign
l_int|0x70
suffix:semicolon
multiline_comment|/* Save bits 6:4 */
id|temp
op_or_assign
(paren
id|par-&gt;ExtColorModeSelect
op_amp
op_complement
l_int|0x70
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|VGAwGR
c_func
(paren
l_int|0x90
comma
id|temp
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * In some rare cases a lockup might occur if we don&squot;t delay&n;&t; * here. (Reported by Miles Lane)&n;&t; */
singleline_comment|//mdelay(200);
multiline_comment|/*&n;&t; * Disable horizontal and vertical graphics and text expansions so&n;&t; * that vgaHWRestore works properly.&n;&t; */
id|temp
op_assign
id|VGArGR
c_func
(paren
l_int|0x25
)paren
suffix:semicolon
id|temp
op_and_assign
l_int|0x39
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x25
comma
id|temp
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Sleep for 200ms to make sure that the two operations above have&n;&t; * had time to take effect.&n;&t; */
id|mdelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This function handles restoring the generic VGA registers.  */
id|vgaHWRestore
c_func
(paren
id|info
comma
id|par
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x0E
comma
id|par-&gt;ExtCRTDispAddr
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x0F
comma
id|par-&gt;ExtCRTOffset
)paren
suffix:semicolon
id|temp
op_assign
id|VGArGR
c_func
(paren
l_int|0x10
)paren
suffix:semicolon
id|temp
op_and_assign
l_int|0x0F
suffix:semicolon
multiline_comment|/* Save bits 3:0 */
id|temp
op_or_assign
(paren
id|par-&gt;SysIfaceCntl1
op_amp
op_complement
l_int|0x0F
)paren
suffix:semicolon
multiline_comment|/* VESA Bios sets bit 1! */
id|VGAwGR
c_func
(paren
l_int|0x10
comma
id|temp
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x11
comma
id|par-&gt;SysIfaceCntl2
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x15
comma
l_int|0
multiline_comment|/*par-&gt;SingleAddrPage */
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x16
comma
l_int|0
multiline_comment|/*par-&gt;DualAddrPage */
)paren
suffix:semicolon
id|temp
op_assign
id|VGArGR
c_func
(paren
l_int|0x20
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;fix.accel
)paren
(brace
r_case
id|FB_ACCEL_NEOMAGIC_NM2070
suffix:colon
id|temp
op_and_assign
l_int|0xFC
suffix:semicolon
multiline_comment|/* Save bits 7:2 */
id|temp
op_or_assign
(paren
id|par-&gt;PanelDispCntlReg1
op_amp
op_complement
l_int|0xFC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2090
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2093
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2097
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2160
suffix:colon
id|temp
op_and_assign
l_int|0xDC
suffix:semicolon
multiline_comment|/* Save bits 7:6,4:2 */
id|temp
op_or_assign
(paren
id|par-&gt;PanelDispCntlReg1
op_amp
op_complement
l_int|0xDC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2200
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2230
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2360
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2380
suffix:colon
id|temp
op_and_assign
l_int|0x98
suffix:semicolon
multiline_comment|/* Save bits 7,4:3 */
id|temp
op_or_assign
(paren
id|par-&gt;PanelDispCntlReg1
op_amp
op_complement
l_int|0x98
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|VGAwGR
c_func
(paren
l_int|0x20
comma
id|temp
)paren
suffix:semicolon
id|temp
op_assign
id|VGArGR
c_func
(paren
l_int|0x25
)paren
suffix:semicolon
id|temp
op_and_assign
l_int|0x38
suffix:semicolon
multiline_comment|/* Save bits 5:3 */
id|temp
op_or_assign
(paren
id|par-&gt;PanelDispCntlReg2
op_amp
op_complement
l_int|0x38
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x25
comma
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;fix.accel
op_ne
id|FB_ACCEL_NEOMAGIC_NM2070
)paren
(brace
id|temp
op_assign
id|VGArGR
c_func
(paren
l_int|0x30
)paren
suffix:semicolon
id|temp
op_and_assign
l_int|0xEF
suffix:semicolon
multiline_comment|/* Save bits 7:5 and bits 3:0 */
id|temp
op_or_assign
(paren
id|par-&gt;PanelDispCntlReg3
op_amp
op_complement
l_int|0xEF
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x30
comma
id|temp
)paren
suffix:semicolon
)brace
id|VGAwGR
c_func
(paren
l_int|0x28
comma
id|par-&gt;PanelVertCenterReg1
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x29
comma
id|par-&gt;PanelVertCenterReg2
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x2a
comma
id|par-&gt;PanelVertCenterReg3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;fix.accel
op_ne
id|FB_ACCEL_NEOMAGIC_NM2070
)paren
(brace
id|VGAwGR
c_func
(paren
l_int|0x32
comma
id|par-&gt;PanelVertCenterReg4
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x33
comma
id|par-&gt;PanelHorizCenterReg1
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x34
comma
id|par-&gt;PanelHorizCenterReg2
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x35
comma
id|par-&gt;PanelHorizCenterReg3
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2160
)paren
id|VGAwGR
c_func
(paren
l_int|0x36
comma
id|par-&gt;PanelHorizCenterReg4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2200
op_logical_or
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2230
op_logical_or
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2360
op_logical_or
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2380
)paren
(brace
id|VGAwGR
c_func
(paren
l_int|0x36
comma
id|par-&gt;PanelHorizCenterReg4
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x37
comma
id|par-&gt;PanelVertCenterReg5
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x38
comma
id|par-&gt;PanelHorizCenterReg5
)paren
suffix:semicolon
id|clock_hi
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Program VCLK3 if needed. */
r_if
c_cond
(paren
id|par-&gt;ProgramVCLK
op_logical_and
(paren
(paren
id|VGArGR
c_func
(paren
l_int|0x9B
)paren
op_ne
id|par-&gt;VCLK3NumeratorLow
)paren
op_logical_or
(paren
id|VGArGR
c_func
(paren
l_int|0x9F
)paren
op_ne
id|par-&gt;VCLK3Denominator
)paren
op_logical_or
(paren
id|clock_hi
op_logical_and
(paren
(paren
id|VGArGR
c_func
(paren
l_int|0x8F
)paren
op_amp
op_complement
l_int|0x0f
)paren
op_ne
(paren
id|par
op_member_access_from_pointer
id|VCLK3NumeratorHigh
op_amp
op_complement
l_int|0x0F
)paren
)paren
)paren
)paren
)paren
(brace
id|VGAwGR
c_func
(paren
l_int|0x9B
comma
id|par-&gt;VCLK3NumeratorLow
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clock_hi
)paren
(brace
id|temp
op_assign
id|VGArGR
c_func
(paren
l_int|0x8F
)paren
suffix:semicolon
id|temp
op_and_assign
l_int|0x0F
suffix:semicolon
multiline_comment|/* Save bits 3:0 */
id|temp
op_or_assign
(paren
id|par-&gt;VCLK3NumeratorHigh
op_amp
op_complement
l_int|0x0F
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x8F
comma
id|temp
)paren
suffix:semicolon
)brace
id|VGAwGR
c_func
(paren
l_int|0x9F
comma
id|par-&gt;VCLK3Denominator
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|par-&gt;biosMode
)paren
id|VGAwCR
c_func
(paren
l_int|0x23
comma
id|par-&gt;biosMode
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x93
comma
l_int|0xc0
)paren
suffix:semicolon
multiline_comment|/* Gives 5x faster framebuffer writes !!! */
multiline_comment|/* Program vertical extension register */
r_if
c_cond
(paren
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2200
op_logical_or
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2230
op_logical_or
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2360
op_logical_or
id|info-&gt;fix.accel
op_eq
id|FB_ACCEL_NEOMAGIC_NM2380
)paren
(brace
id|VGAwCR
c_func
(paren
l_int|0x70
comma
id|par-&gt;VerticalExt
)paren
suffix:semicolon
)brace
id|vgaHWProtect
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Turn on screen */
multiline_comment|/* Calling this also locks offset registers required in update_start */
id|neoLock
c_func
(paren
)paren
suffix:semicolon
id|info-&gt;fix.line_length
op_assign
id|info-&gt;var.xres_virtual
op_star
(paren
id|info-&gt;var.bits_per_pixel
op_rshift
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.accel_flags
op_amp
id|FB_ACCELF_TEXT
)paren
id|neo2200_accel_init
c_func
(paren
id|info
comma
op_amp
id|info-&gt;var
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|neofb_update_start
r_static
r_void
id|neofb_update_start
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_int
id|oldExtCRTDispAddr
suffix:semicolon
r_int
id|Base
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;neofb_update_start&quot;
)paren
suffix:semicolon
id|Base
op_assign
(paren
id|var-&gt;yoffset
op_star
id|var-&gt;xres_virtual
op_plus
id|var-&gt;xoffset
)paren
op_rshift
l_int|2
suffix:semicolon
id|Base
op_mul_assign
(paren
id|var-&gt;bits_per_pixel
op_plus
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
id|neoUnlock
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * These are the generic starting address registers.&n;&t; */
id|VGAwCR
c_func
(paren
l_int|0x0C
comma
(paren
id|Base
op_amp
l_int|0x00FF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|VGAwCR
c_func
(paren
l_int|0x0D
comma
(paren
id|Base
op_amp
l_int|0x00FF
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure we don&squot;t clobber some other bits that might already&n;&t; * have been set. NOTE: NM2200 has a writable bit 3, but it shouldn&squot;t&n;&t; * be needed.&n;&t; */
id|oldExtCRTDispAddr
op_assign
id|VGArGR
c_func
(paren
l_int|0x0E
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x0E
comma
(paren
(paren
(paren
id|Base
op_rshift
l_int|16
)paren
op_amp
l_int|0x0f
)paren
op_or
(paren
id|oldExtCRTDispAddr
op_amp
l_int|0xf0
)paren
)paren
)paren
suffix:semicolon
id|neoLock
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *    Pan or Wrap the Display&n; */
DECL|function|neofb_pan_display
r_static
r_int
id|neofb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|fb
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
(paren
r_struct
id|fb_info
op_star
)paren
id|fb
suffix:semicolon
id|u_int
id|y_bottom
suffix:semicolon
id|y_bottom
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
)paren
id|y_bottom
op_add_assign
id|var-&gt;yres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xoffset
OG
(paren
id|var-&gt;xres_virtual
op_minus
id|var-&gt;xres
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|y_bottom
OG
id|fb-&gt;var.yres_virtual
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|neofb_update_start
c_func
(paren
id|info
comma
id|var
)paren
suffix:semicolon
id|fb-&gt;var.xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|fb-&gt;var.yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
id|fb-&gt;var.vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
r_else
id|fb-&gt;var.vmode
op_and_assign
op_complement
id|FB_VMODE_YWRAP
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *    (Un)Blank the display.&n; */
DECL|function|neofb_blank
r_static
r_int
id|neofb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|fb
)paren
(brace
singleline_comment|//  struct fb_info *info = (struct fb_info *)fb;
multiline_comment|/*&n;&t; *  Blank the screen if blank_mode != 0, else unblank. If&n;&t; *  blank == NULL then the caller blanks by setting the CLUT&n;&t; *  (Color Look Up Table) to all black. Return 0 if blanking&n;&t; *  succeeded, != 0 if un-/blanking failed due to e.g. a&n;&t; *  video mode which doesn&squot;t support it. Implements VESA&n;&t; *  suspend and powerdown modes on hardware that supports&n;&t; *  disabling hsync/vsync:&n;&t; *    blank_mode == 2: suspend vsync&n;&t; *    blank_mode == 3: suspend hsync&n;&t; *    blank_mode == 4: powerdown&n;&t; *&n;&t; *  wms...Enable VESA DMPS compatible powerdown mode&n;&t; *  run &quot;setterm -powersave powerdown&quot; to take advantage&n;&t; */
r_switch
c_cond
(paren
id|blank
)paren
(brace
r_case
l_int|4
suffix:colon
multiline_comment|/* powerdown - both sync lines down */
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* hsync off */
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* vsync off */
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* just software blanking of screen */
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* case 0, or anything else: unblank */
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|neofb_ops
r_static
r_struct
id|fb_ops
id|neofb_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|fb_check_var
suffix:colon
id|neofb_check_var
comma
id|fb_set_par
suffix:colon
id|neofb_set_par
comma
id|fb_set_var
suffix:colon
id|gen_set_var
comma
id|fb_get_fix
suffix:colon
id|gen_get_fix
comma
id|fb_get_var
suffix:colon
id|gen_get_var
comma
id|fb_get_cmap
suffix:colon
id|gen_get_cmap
comma
id|fb_set_cmap
suffix:colon
id|gen_set_cmap
comma
id|fb_setcolreg
suffix:colon
id|neofb_setcolreg
comma
id|fb_pan_display
suffix:colon
id|neofb_pan_display
comma
id|fb_blank
suffix:colon
id|neofb_blank
comma
id|fb_fillrect
suffix:colon
id|cfb_fillrect
comma
id|fb_copyarea
suffix:colon
id|cfb_copyarea
comma
id|fb_imageblit
suffix:colon
id|cfb_imageblit
comma
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|neofb_var640x480x8
r_static
r_struct
id|fb_var_screeninfo
id|__devinitdata
id|neofb_var640x480x8
op_assign
(brace
id|accel_flags
suffix:colon
id|FB_ACCELF_TEXT
comma
id|xres
suffix:colon
l_int|640
comma
id|yres
suffix:colon
l_int|480
comma
id|xres_virtual
suffix:colon
l_int|640
comma
id|yres_virtual
suffix:colon
l_int|30000
comma
id|bits_per_pixel
suffix:colon
l_int|8
comma
id|pixclock
suffix:colon
l_int|39722
comma
id|left_margin
suffix:colon
l_int|48
comma
id|right_margin
suffix:colon
l_int|16
comma
id|upper_margin
suffix:colon
l_int|33
comma
id|lower_margin
suffix:colon
l_int|10
comma
id|hsync_len
suffix:colon
l_int|96
comma
id|vsync_len
suffix:colon
l_int|2
comma
id|sync
suffix:colon
l_int|0
comma
id|vmode
suffix:colon
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
DECL|variable|neofb_var800x600x8
r_static
r_struct
id|fb_var_screeninfo
id|__devinitdata
id|neofb_var800x600x8
op_assign
(brace
id|accel_flags
suffix:colon
id|FB_ACCELF_TEXT
comma
id|xres
suffix:colon
l_int|800
comma
id|yres
suffix:colon
l_int|600
comma
id|xres_virtual
suffix:colon
l_int|800
comma
id|yres_virtual
suffix:colon
l_int|30000
comma
id|bits_per_pixel
suffix:colon
l_int|8
comma
id|pixclock
suffix:colon
l_int|25000
comma
id|left_margin
suffix:colon
l_int|88
comma
id|right_margin
suffix:colon
l_int|40
comma
id|upper_margin
suffix:colon
l_int|23
comma
id|lower_margin
suffix:colon
l_int|1
comma
id|hsync_len
suffix:colon
l_int|128
comma
id|vsync_len
suffix:colon
l_int|4
comma
id|sync
suffix:colon
id|FB_SYNC_HOR_HIGH_ACT
op_or
id|FB_SYNC_VERT_HIGH_ACT
comma
id|vmode
suffix:colon
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
DECL|variable|neofb_var1024x768x8
r_static
r_struct
id|fb_var_screeninfo
id|__devinitdata
id|neofb_var1024x768x8
op_assign
(brace
id|accel_flags
suffix:colon
id|FB_ACCELF_TEXT
comma
id|xres
suffix:colon
l_int|1024
comma
id|yres
suffix:colon
l_int|768
comma
id|xres_virtual
suffix:colon
l_int|1024
comma
id|yres_virtual
suffix:colon
l_int|30000
comma
id|bits_per_pixel
suffix:colon
l_int|8
comma
id|pixclock
suffix:colon
l_int|15385
comma
id|left_margin
suffix:colon
l_int|160
comma
id|right_margin
suffix:colon
l_int|24
comma
id|upper_margin
suffix:colon
l_int|29
comma
id|lower_margin
suffix:colon
l_int|3
comma
id|hsync_len
suffix:colon
l_int|136
comma
id|vsync_len
suffix:colon
l_int|6
comma
id|sync
suffix:colon
id|FB_SYNC_HOR_HIGH_ACT
op_or
id|FB_SYNC_VERT_HIGH_ACT
comma
id|vmode
suffix:colon
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
macro_line|#ifdef NOT_DONE
DECL|variable|neofb_var1280x1024x8
r_static
r_struct
id|fb_var_screeninfo
id|__devinitdata
id|neofb_var1280x1024x8
op_assign
(brace
id|accel_flags
suffix:colon
id|FB_ACCELF_TEXT
comma
id|xres
suffix:colon
l_int|1280
comma
id|yres
suffix:colon
l_int|1024
comma
id|xres_virtual
suffix:colon
l_int|1280
comma
id|yres_virtual
suffix:colon
l_int|30000
comma
id|bits_per_pixel
suffix:colon
l_int|8
comma
id|pixclock
suffix:colon
l_int|9260
comma
id|left_margin
suffix:colon
l_int|248
comma
id|right_margin
suffix:colon
l_int|48
comma
id|upper_margin
suffix:colon
l_int|38
comma
id|lower_margin
suffix:colon
l_int|1
comma
id|hsync_len
suffix:colon
l_int|112
comma
id|vsync_len
suffix:colon
l_int|3
comma
id|sync
suffix:colon
id|FB_SYNC_HOR_HIGH_ACT
op_or
id|FB_SYNC_VERT_HIGH_ACT
comma
id|vmode
suffix:colon
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|neofb_var
r_static
r_struct
id|fb_var_screeninfo
op_star
id|neofb_var
op_assign
l_int|NULL
suffix:semicolon
DECL|function|neo_map_mmio
r_static
r_int
id|__devinit
id|neo_map_mmio
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|neofb_par
op_star
id|par
op_assign
(paren
r_struct
id|neofb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;neo_map_mmio&quot;
)paren
suffix:semicolon
id|info-&gt;fix.mmio_start
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|info-&gt;fix.mmio_len
op_assign
id|MMIO_SIZE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
(paren
id|info-&gt;fix.mmio_start
comma
id|MMIO_SIZE
comma
l_string|&quot;memory mapped I/O&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;neofb: memory mapped IO in use&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|par-&gt;mmio_vbase
op_assign
id|ioremap
c_func
(paren
id|info-&gt;fix.mmio_start
comma
id|MMIO_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|par-&gt;mmio_vbase
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;neofb: unable to map memory mapped IO&bslash;n&quot;
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|info-&gt;fix.mmio_start
comma
id|info-&gt;fix.mmio_len
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;neofb: mapped io at %p&bslash;n&quot;
comma
id|par-&gt;mmio_vbase
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|neo_unmap_mmio
r_static
r_void
id|__devinit
id|neo_unmap_mmio
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|neofb_par
op_star
id|par
op_assign
(paren
r_struct
id|neofb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;neo_unmap_mmio&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;mmio_vbase
)paren
(brace
id|iounmap
c_func
(paren
id|par-&gt;mmio_vbase
)paren
suffix:semicolon
id|par-&gt;mmio_vbase
op_assign
l_int|NULL
suffix:semicolon
id|release_mem_region
c_func
(paren
id|info-&gt;fix.mmio_start
comma
id|info-&gt;fix.mmio_len
)paren
suffix:semicolon
)brace
)brace
DECL|function|neo_map_video
r_static
r_int
id|__devinit
id|neo_map_video
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|video_len
)paren
(brace
r_struct
id|neofb_par
op_star
id|par
op_assign
(paren
r_struct
id|neofb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;neo_map_video&quot;
)paren
suffix:semicolon
id|info-&gt;fix.smem_start
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|info-&gt;fix.smem_len
op_assign
id|video_len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
(paren
id|info-&gt;fix.smem_start
comma
id|info-&gt;fix.smem_len
comma
l_string|&quot;frame buffer&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;neofb: frame buffer in use&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|info-&gt;screen_base
op_assign
id|ioremap
c_func
(paren
id|info-&gt;fix.smem_start
comma
id|info-&gt;fix.smem_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;screen_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;neofb: unable to map screen memory&bslash;n&quot;
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|info-&gt;fix.smem_start
comma
id|info-&gt;fix.smem_len
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;neofb: mapped framebuffer at %p&bslash;n&quot;
comma
id|info-&gt;screen_base
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MTRR
id|par-&gt;mtrr
op_assign
id|mtrr_add
c_func
(paren
id|info-&gt;fix.smem_start
comma
id|pci_resource_len
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|MTRR_TYPE_WRCOMB
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Clear framebuffer, it&squot;s all white in memory after boot */
id|memset
c_func
(paren
id|info-&gt;screen_base
comma
l_int|0
comma
id|info-&gt;fix.smem_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|neo_unmap_video
r_static
r_void
id|__devinit
id|neo_unmap_video
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|neofb_par
op_star
id|par
op_assign
(paren
r_struct
id|neofb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;neo_unmap_video&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;screen_base
)paren
(brace
macro_line|#ifdef CONFIG_MTRR
id|mtrr_del
c_func
(paren
id|par-&gt;mtrr
comma
id|info-&gt;fix.smem_start
comma
id|info-&gt;fix.smem_len
)paren
suffix:semicolon
macro_line|#endif
id|iounmap
c_func
(paren
id|info-&gt;screen_base
)paren
suffix:semicolon
id|info-&gt;screen_base
op_assign
l_int|NULL
suffix:semicolon
id|release_mem_region
c_func
(paren
id|info-&gt;fix.smem_start
comma
id|info-&gt;fix.smem_len
)paren
suffix:semicolon
)brace
)brace
DECL|function|neo_init_hw
r_static
r_int
id|__devinit
id|neo_init_hw
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|neofb_par
op_star
id|par
op_assign
(paren
r_struct
id|neofb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
id|videoRam
op_assign
l_int|896
suffix:semicolon
r_int
id|maxClock
op_assign
l_int|65000
suffix:semicolon
r_int
id|CursorMem
op_assign
l_int|1024
suffix:semicolon
r_int
id|CursorOff
op_assign
l_int|0x100
suffix:semicolon
r_int
id|linearSize
op_assign
l_int|1024
suffix:semicolon
r_int
id|maxWidth
op_assign
l_int|1024
suffix:semicolon
r_int
id|maxHeight
op_assign
l_int|1024
suffix:semicolon
r_int
r_char
id|type
comma
id|display
suffix:semicolon
r_int
id|w
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;neo_init_hw&quot;
)paren
suffix:semicolon
id|neoUnlock
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;--- Neo extended register dump ---&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|w
op_assign
l_int|0
suffix:semicolon
id|w
OL
l_int|0x85
suffix:semicolon
id|w
op_increment
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;CR %p: %p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|w
comma
(paren
r_void
op_star
)paren
id|VGArCR
c_func
(paren
id|w
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|w
op_assign
l_int|0
suffix:semicolon
id|w
OL
l_int|0xC7
suffix:semicolon
id|w
op_increment
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;GR %p: %p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|w
comma
(paren
r_void
op_star
)paren
id|VGArGR
c_func
(paren
id|w
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Determine the panel type */
id|VGAwGR
c_func
(paren
l_int|0x09
comma
l_int|0x26
)paren
suffix:semicolon
id|type
op_assign
id|VGArGR
c_func
(paren
l_int|0x21
)paren
suffix:semicolon
id|display
op_assign
id|VGArGR
c_func
(paren
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* Determine panel width -- used in NeoValidMode. */
id|w
op_assign
id|VGArGR
c_func
(paren
l_int|0x20
)paren
suffix:semicolon
id|VGAwGR
c_func
(paren
l_int|0x09
comma
l_int|0x00
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|w
op_amp
l_int|0x18
)paren
op_rshift
l_int|3
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|par-&gt;NeoPanelWidth
op_assign
l_int|640
suffix:semicolon
id|par-&gt;NeoPanelHeight
op_assign
l_int|480
suffix:semicolon
id|neofb_var
op_assign
op_amp
id|neofb_var640x480x8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|par-&gt;NeoPanelWidth
op_assign
l_int|800
suffix:semicolon
id|par-&gt;NeoPanelHeight
op_assign
l_int|600
suffix:semicolon
id|neofb_var
op_assign
op_amp
id|neofb_var800x600x8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|par-&gt;NeoPanelWidth
op_assign
l_int|1024
suffix:semicolon
id|par-&gt;NeoPanelHeight
op_assign
l_int|768
suffix:semicolon
id|neofb_var
op_assign
op_amp
id|neofb_var1024x768x8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
multiline_comment|/* 1280x1024 panel support needs to be added */
macro_line|#ifdef NOT_DONE
id|par-&gt;NeoPanelWidth
op_assign
l_int|1280
suffix:semicolon
id|par-&gt;NeoPanelHeight
op_assign
l_int|1024
suffix:semicolon
id|neofb_var
op_assign
op_amp
id|neofb_var1280x1024x8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;neofb: Only 640x480, 800x600 and 1024x768 panels are currently supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|par-&gt;NeoPanelWidth
op_assign
l_int|640
suffix:semicolon
id|par-&gt;NeoPanelHeight
op_assign
l_int|480
suffix:semicolon
id|neofb_var
op_assign
op_amp
id|neofb_var640x480x8
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Panel is a %dx%d %s %s display&bslash;n&quot;
comma
id|par-&gt;NeoPanelWidth
comma
id|par-&gt;NeoPanelHeight
comma
(paren
id|type
op_amp
l_int|0x02
)paren
ques
c_cond
l_string|&quot;color&quot;
suffix:colon
l_string|&quot;monochrome&quot;
comma
(paren
id|type
op_amp
l_int|0x10
)paren
ques
c_cond
l_string|&quot;TFT&quot;
suffix:colon
l_string|&quot;dual scan&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;fix.accel
)paren
(brace
r_case
id|FB_ACCEL_NEOMAGIC_NM2070
suffix:colon
id|videoRam
op_assign
l_int|896
suffix:semicolon
id|maxClock
op_assign
l_int|65000
suffix:semicolon
id|CursorMem
op_assign
l_int|2048
suffix:semicolon
id|CursorOff
op_assign
l_int|0x100
suffix:semicolon
id|linearSize
op_assign
l_int|1024
suffix:semicolon
id|maxWidth
op_assign
l_int|1024
suffix:semicolon
id|maxHeight
op_assign
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2090
suffix:colon
r_case
id|FB_ACCEL_NEOMAGIC_NM2093
suffix:colon
id|videoRam
op_assign
l_int|1152
suffix:semicolon
id|maxClock
op_assign
l_int|80000
suffix:semicolon
id|CursorMem
op_assign
l_int|2048
suffix:semicolon
id|CursorOff
op_assign
l_int|0x100
suffix:semicolon
id|linearSize
op_assign
l_int|2048
suffix:semicolon
id|maxWidth
op_assign
l_int|1024
suffix:semicolon
id|maxHeight
op_assign
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2097
suffix:colon
id|videoRam
op_assign
l_int|1152
suffix:semicolon
id|maxClock
op_assign
l_int|80000
suffix:semicolon
id|CursorMem
op_assign
l_int|1024
suffix:semicolon
id|CursorOff
op_assign
l_int|0x100
suffix:semicolon
id|linearSize
op_assign
l_int|2048
suffix:semicolon
id|maxWidth
op_assign
l_int|1024
suffix:semicolon
id|maxHeight
op_assign
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2160
suffix:colon
id|videoRam
op_assign
l_int|2048
suffix:semicolon
id|maxClock
op_assign
l_int|90000
suffix:semicolon
id|CursorMem
op_assign
l_int|1024
suffix:semicolon
id|CursorOff
op_assign
l_int|0x100
suffix:semicolon
id|linearSize
op_assign
l_int|2048
suffix:semicolon
id|maxWidth
op_assign
l_int|1024
suffix:semicolon
id|maxHeight
op_assign
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2200
suffix:colon
id|videoRam
op_assign
l_int|2560
suffix:semicolon
id|maxClock
op_assign
l_int|110000
suffix:semicolon
id|CursorMem
op_assign
l_int|1024
suffix:semicolon
id|CursorOff
op_assign
l_int|0x1000
suffix:semicolon
id|linearSize
op_assign
l_int|4096
suffix:semicolon
id|maxWidth
op_assign
l_int|1280
suffix:semicolon
id|maxHeight
op_assign
l_int|1024
suffix:semicolon
multiline_comment|/* ???? */
id|par-&gt;neo2200
op_assign
(paren
id|Neo2200
op_star
)paren
id|par-&gt;mmio_vbase
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2230
suffix:colon
id|videoRam
op_assign
l_int|3008
suffix:semicolon
id|maxClock
op_assign
l_int|110000
suffix:semicolon
id|CursorMem
op_assign
l_int|1024
suffix:semicolon
id|CursorOff
op_assign
l_int|0x1000
suffix:semicolon
id|linearSize
op_assign
l_int|4096
suffix:semicolon
id|maxWidth
op_assign
l_int|1280
suffix:semicolon
id|maxHeight
op_assign
l_int|1024
suffix:semicolon
multiline_comment|/* ???? */
id|par-&gt;neo2200
op_assign
(paren
id|Neo2200
op_star
)paren
id|par-&gt;mmio_vbase
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2360
suffix:colon
id|videoRam
op_assign
l_int|4096
suffix:semicolon
id|maxClock
op_assign
l_int|110000
suffix:semicolon
id|CursorMem
op_assign
l_int|1024
suffix:semicolon
id|CursorOff
op_assign
l_int|0x1000
suffix:semicolon
id|linearSize
op_assign
l_int|4096
suffix:semicolon
id|maxWidth
op_assign
l_int|1280
suffix:semicolon
id|maxHeight
op_assign
l_int|1024
suffix:semicolon
multiline_comment|/* ???? */
id|par-&gt;neo2200
op_assign
(paren
id|Neo2200
op_star
)paren
id|par-&gt;mmio_vbase
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2380
suffix:colon
id|videoRam
op_assign
l_int|6144
suffix:semicolon
id|maxClock
op_assign
l_int|110000
suffix:semicolon
id|CursorMem
op_assign
l_int|1024
suffix:semicolon
id|CursorOff
op_assign
l_int|0x1000
suffix:semicolon
id|linearSize
op_assign
l_int|8192
suffix:semicolon
id|maxWidth
op_assign
l_int|1280
suffix:semicolon
id|maxHeight
op_assign
l_int|1024
suffix:semicolon
multiline_comment|/* ???? */
id|par-&gt;neo2200
op_assign
(paren
id|Neo2200
op_star
)paren
id|par-&gt;mmio_vbase
suffix:semicolon
r_break
suffix:semicolon
)brace
id|par-&gt;maxClock
op_assign
id|maxClock
suffix:semicolon
r_return
id|videoRam
op_star
l_int|1024
suffix:semicolon
)brace
DECL|function|neo_alloc_fb_info
r_static
r_struct
id|fb_info
op_star
id|__devinit
id|neo_alloc_fb_info
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_struct
id|neofb_par
op_star
id|par
suffix:semicolon
id|info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|fb_info
)paren
op_plus
r_sizeof
(paren
r_struct
id|display
)paren
op_plus
r_sizeof
(paren
id|u32
)paren
op_star
l_int|16
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_info
)paren
op_plus
r_sizeof
(paren
r_struct
id|display
)paren
)paren
suffix:semicolon
id|par
op_assign
op_amp
id|default_par
suffix:semicolon
id|memset
c_func
(paren
id|par
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|neofb_par
)paren
)paren
suffix:semicolon
id|info-&gt;currcon
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;fix.accel
op_assign
id|id-&gt;driver_data
suffix:semicolon
id|par-&gt;pci_burst
op_assign
op_logical_neg
id|nopciburst
suffix:semicolon
id|par-&gt;lcd_stretch
op_assign
op_logical_neg
id|nostretch
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|internal
op_logical_and
op_logical_neg
id|external
)paren
(brace
id|par-&gt;internal_display
op_assign
l_int|1
suffix:semicolon
id|par-&gt;external_display
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|par-&gt;internal_display
op_assign
id|internal
suffix:semicolon
id|par-&gt;external_display
op_assign
id|external
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|info-&gt;fix.accel
)paren
(brace
r_case
id|FB_ACCEL_NEOMAGIC_NM2070
suffix:colon
id|sprintf
c_func
(paren
id|info-&gt;fix.id
comma
l_string|&quot;MagicGraph 128&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2090
suffix:colon
id|sprintf
c_func
(paren
id|info-&gt;fix.id
comma
l_string|&quot;MagicGraph 128V&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2093
suffix:colon
id|sprintf
c_func
(paren
id|info-&gt;fix.id
comma
l_string|&quot;MagicGraph 128ZV&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2097
suffix:colon
id|sprintf
c_func
(paren
id|info-&gt;fix.id
comma
l_string|&quot;MagicGraph 128ZV+&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2160
suffix:colon
id|sprintf
c_func
(paren
id|info-&gt;fix.id
comma
l_string|&quot;MagicGraph 128XD&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2200
suffix:colon
id|sprintf
c_func
(paren
id|info-&gt;fix.id
comma
l_string|&quot;MagicGraph 256AV&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2230
suffix:colon
id|sprintf
c_func
(paren
id|info-&gt;fix.id
comma
l_string|&quot;MagicGraph 256AV+&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2360
suffix:colon
id|sprintf
c_func
(paren
id|info-&gt;fix.id
comma
l_string|&quot;MagicGraph 256ZX&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_ACCEL_NEOMAGIC_NM2380
suffix:colon
id|sprintf
c_func
(paren
id|info-&gt;fix.id
comma
l_string|&quot;MagicGraph 256XL+&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|info-&gt;fix.type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|info-&gt;fix.type_aux
op_assign
l_int|0
suffix:semicolon
id|info-&gt;fix.xpanstep
op_assign
l_int|0
suffix:semicolon
id|info-&gt;fix.ypanstep
op_assign
l_int|4
suffix:semicolon
id|info-&gt;fix.ywrapstep
op_assign
l_int|0
suffix:semicolon
id|info-&gt;fix.accel
op_assign
id|id-&gt;driver_data
suffix:semicolon
id|info-&gt;var.nonstd
op_assign
l_int|0
suffix:semicolon
id|info-&gt;var.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|info-&gt;var.height
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;var.width
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;var.accel_flags
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;modename
comma
id|info-&gt;fix.id
)paren
suffix:semicolon
id|info-&gt;fbops
op_assign
op_amp
id|neofb_ops
suffix:semicolon
id|info-&gt;changevar
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;switch_con
op_assign
id|gen_switch
suffix:semicolon
id|info-&gt;updatevar
op_assign
id|gen_update_var
suffix:semicolon
id|info-&gt;flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
id|info-&gt;par
op_assign
id|par
suffix:semicolon
id|info-&gt;disp
op_assign
(paren
r_struct
id|display
op_star
)paren
(paren
id|info
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;pseudo_palette
op_assign
(paren
r_void
op_star
)paren
(paren
id|info-&gt;disp
op_plus
l_int|1
)paren
suffix:semicolon
id|fb_alloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
comma
id|NR_PALETTE
comma
l_int|0
)paren
suffix:semicolon
r_return
id|info
suffix:semicolon
)brace
DECL|function|neo_free_fb_info
r_static
r_void
id|__devinit
id|neo_free_fb_info
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info
)paren
(brace
multiline_comment|/*&n;&t;&t; * Free the colourmap&n;&t;&t; */
id|fb_alloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|neofb_probe
r_static
r_int
id|__devinit
id|neofb_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
id|u_int
id|h_sync
comma
id|v_sync
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|video_len
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;neofb_probe&quot;
)paren
suffix:semicolon
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|info
op_assign
id|neo_alloc_fb_info
c_func
(paren
id|dev
comma
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_goto
id|failed
suffix:semicolon
id|err
op_assign
id|neo_map_mmio
c_func
(paren
id|info
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|failed
suffix:semicolon
id|video_len
op_assign
id|neo_init_hw
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_len
OL
l_int|0
)paren
(brace
id|err
op_assign
id|video_len
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|err
op_assign
id|neo_map_video
c_func
(paren
id|info
comma
id|dev
comma
id|video_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|failed
suffix:semicolon
id|gen_set_var
c_func
(paren
id|neofb_var
comma
op_minus
l_int|1
comma
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Calculate the hsync and vsync frequencies.  Note that&n;&t; * we split the 1e12 constant up so that we can preserve&n;&t; * the precision and fit the results into 32-bit registers.&n;&t; *  (1953125000 * 512 = 1e12)&n;&t; */
id|h_sync
op_assign
l_int|1953125000
op_div
id|info-&gt;var.pixclock
suffix:semicolon
id|h_sync
op_assign
id|h_sync
op_star
l_int|512
op_div
(paren
id|info-&gt;var.xres
op_plus
id|info-&gt;var.left_margin
op_plus
id|info-&gt;var.right_margin
op_plus
id|info-&gt;var.hsync_len
)paren
suffix:semicolon
id|v_sync
op_assign
id|h_sync
op_div
(paren
id|info-&gt;var.yres
op_plus
id|info-&gt;var.upper_margin
op_plus
id|info-&gt;var.lower_margin
op_plus
id|info-&gt;var.vsync_len
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;neofb v&quot;
id|NEOFB_VERSION
l_string|&quot;: %dkB VRAM, using %dx%d, %d.%03dkHz, %dHz&bslash;n&quot;
comma
id|info-&gt;fix.smem_len
op_rshift
l_int|10
comma
id|info-&gt;var.xres
comma
id|info-&gt;var.yres
comma
id|h_sync
op_div
l_int|1000
comma
id|h_sync
op_mod
l_int|1000
comma
id|v_sync
)paren
suffix:semicolon
id|err
op_assign
id|register_framebuffer
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|failed
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fb%d: %s frame buffer device&bslash;n&quot;
comma
id|GET_FB_IDX
c_func
(paren
id|info-&gt;node
)paren
comma
id|info-&gt;modename
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Our driver data&n;&t; */
id|dev-&gt;driver_data
op_assign
id|info
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed
suffix:colon
id|neo_unmap_video
c_func
(paren
id|info
)paren
suffix:semicolon
id|neo_unmap_mmio
c_func
(paren
id|info
)paren
suffix:semicolon
id|neo_free_fb_info
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|neofb_remove
r_static
r_void
id|__devexit
id|neofb_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
(paren
r_struct
id|fb_info
op_star
)paren
id|dev-&gt;driver_data
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;neofb_remove&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
)paren
(brace
multiline_comment|/*&n;&t;&t; * If unregister_framebuffer fails, then&n;&t;&t; * we will be leaving hooks that could cause&n;&t;&t; * oopsen laying around.&n;&t;&t; */
r_if
c_cond
(paren
id|unregister_framebuffer
c_func
(paren
id|info
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;neofb: danger danger!  Oopsen imminent!&bslash;n&quot;
)paren
suffix:semicolon
id|neo_unmap_video
c_func
(paren
id|info
)paren
suffix:semicolon
id|neo_unmap_mmio
c_func
(paren
id|info
)paren
suffix:semicolon
id|neo_free_fb_info
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Ensure that the driver data is no longer&n;&t;&t; * valid.&n;&t;&t; */
id|dev-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|neofb_devices
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_NEOMAGIC
comma
id|PCI_CHIP_NM2070
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FB_ACCEL_NEOMAGIC_NM2070
)brace
comma
(brace
id|PCI_VENDOR_ID_NEOMAGIC
comma
id|PCI_CHIP_NM2090
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FB_ACCEL_NEOMAGIC_NM2090
)brace
comma
(brace
id|PCI_VENDOR_ID_NEOMAGIC
comma
id|PCI_CHIP_NM2093
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FB_ACCEL_NEOMAGIC_NM2093
)brace
comma
(brace
id|PCI_VENDOR_ID_NEOMAGIC
comma
id|PCI_CHIP_NM2097
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FB_ACCEL_NEOMAGIC_NM2097
)brace
comma
(brace
id|PCI_VENDOR_ID_NEOMAGIC
comma
id|PCI_CHIP_NM2160
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FB_ACCEL_NEOMAGIC_NM2160
)brace
comma
(brace
id|PCI_VENDOR_ID_NEOMAGIC
comma
id|PCI_CHIP_NM2200
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FB_ACCEL_NEOMAGIC_NM2200
)brace
comma
(brace
id|PCI_VENDOR_ID_NEOMAGIC
comma
id|PCI_CHIP_NM2230
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FB_ACCEL_NEOMAGIC_NM2230
)brace
comma
(brace
id|PCI_VENDOR_ID_NEOMAGIC
comma
id|PCI_CHIP_NM2360
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FB_ACCEL_NEOMAGIC_NM2360
)brace
comma
(brace
id|PCI_VENDOR_ID_NEOMAGIC
comma
id|PCI_CHIP_NM2380
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|FB_ACCEL_NEOMAGIC_NM2380
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|neofb_devices
)paren
suffix:semicolon
DECL|variable|neofb_driver
r_static
r_struct
id|pci_driver
id|neofb_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;neofb&quot;
comma
id|id_table
suffix:colon
id|neofb_devices
comma
id|probe
suffix:colon
id|neofb_probe
comma
id|remove
suffix:colon
id|__devexit_p
c_func
(paren
id|neofb_remove
)paren
)brace
suffix:semicolon
multiline_comment|/* **************************** init-time only **************************** */
DECL|function|neo_init
r_static
r_void
id|__init
id|neo_init
c_func
(paren
r_void
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;neo_init&quot;
)paren
suffix:semicolon
id|pci_register_driver
c_func
(paren
op_amp
id|neofb_driver
)paren
suffix:semicolon
)brace
multiline_comment|/* **************************** exit-time only **************************** */
DECL|function|neo_done
r_static
r_void
id|__exit
id|neo_done
c_func
(paren
r_void
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;neo_done&quot;
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|neofb_driver
)paren
suffix:semicolon
)brace
macro_line|#ifndef MODULE
multiline_comment|/* ************************* init in-kernel code ************************** */
DECL|function|neofb_setup
r_int
id|__init
id|neofb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;neofb_setup&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;disabled&quot;
comma
l_int|8
)paren
)paren
id|disabled
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;internal&quot;
comma
l_int|8
)paren
)paren
id|internal
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;external&quot;
comma
l_int|8
)paren
)paren
id|external
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;nostretch&quot;
comma
l_int|9
)paren
)paren
id|nostretch
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;nopciburst&quot;
comma
l_int|10
)paren
)paren
id|nopciburst
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|initialized
r_static
r_int
id|__init
id|initialized
op_assign
l_int|0
suffix:semicolon
DECL|function|neofb_init
r_int
id|__init
id|neofb_init
c_func
(paren
r_void
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;neofb_init&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disabled
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|initialized
)paren
(brace
id|initialized
op_assign
l_int|1
suffix:semicolon
id|neo_init
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* never return failure, user can hotplug card later... */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* *************************** init module code **************************** */
DECL|function|init_module
r_int
id|__init
id|init_module
c_func
(paren
r_void
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;init_module&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disabled
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|neo_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* never return failure; user can hotplug card later... */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* MODULE */
DECL|variable|neo_done
id|module_exit
c_func
(paren
id|neo_done
)paren
suffix:semicolon
eof
