multiline_comment|/*&n; *&n; * tdfxfb.c&n; *&n; * Author: Hannu Mallat &lt;hmallat@cc.hut.fi&gt;&n; *&n; * Copyright &#xfffd; 1999 Hannu Mallat&n; * All rights reserved&n; *&n; * Created      : Thu Sep 23 18:17:43 1999, hmallat&n; * Last modified: Tue Nov  2 21:19:47 1999, hmallat&n; *&n; * Lots of the information here comes from the Daryll Strauss&squot; Banshee &n; * patches to the XF86 server, and the rest comes from the 3dfx&n; * Banshee specification. I&squot;m very much indebted to Daryll for his&n; * work on the X server.&n; *&n; * Voodoo3 support was contributed Harold Oga. Lots of additions&n; * (proper acceleration, 24 bpp, hardware cursor) and bug fixes by Attila&n; * Kesmarki. Thanks guys!&n; *&n; * Voodoo1 and Voodoo2 support aren&squot;t relevant to this driver as they&n; * behave very differently from the Voodoo3/4/5. For anyone wanting to&n; * use frame buffer on the Voodoo1/2, see the sstfb driver (which is&n; * located at http://www.sourceforge.net/projects/sstfb).&n; * &n; * While I _am_ grateful to 3Dfx for releasing the specs for Banshee,&n; * I do wish the next version is a bit more complete. Without the XF86&n; * patches I couldn&squot;t have gotten even this far... for instance, the&n; * extensions to the VGA register set go completely unmentioned in the&n; * spec! Also, lots of references are made to the &squot;SST core&squot;, but no&n; * spec is publicly available, AFAIK.&n; *&n; * The structure of this driver comes pretty much from the Permedia&n; * driver by Ilario Nardinocchi, which in turn is based on skeletonfb.&n; * &n; * TODO:&n; * - support for 16/32 bpp needs fixing (funky bootup penguin)&n; * - multihead support (basically need to support an array of fb_infos)&n; * - support other architectures (PPC, Alpha); does the fact that the VGA&n; *   core can be accessed only thru I/O (not memory mapped) complicate&n; *   things?&n; *&n; * Version history:&n; *&n; * 0.1.4 (released 2002-05-28) ported over to new fbdev api by James Simmons&n; *&n; * 0.1.3 (released 1999-11-02) added Attila&squot;s panning support, code&n; *&t;&t;&t;       reorg, hwcursor address page size alignment&n; *                             (for mmaping both frame buffer and regs),&n; *                             and my changes to get rid of hardcoded&n; *                             VGA i/o register locations (uses PCI&n; *                             configuration info now)&n; * 0.1.2 (released 1999-10-19) added Attila Kesmarki&squot;s bug fixes and&n; *                             improvements&n; * 0.1.1 (released 1999-10-07) added Voodoo3 support by Harold Oga.&n; * 0.1.0 (released 1999-10-06) initial version&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/nvram.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;video/tdfx.h&gt;
DECL|macro|TDFXFB_DEBUG
macro_line|#undef TDFXFB_DEBUG 
macro_line|#ifdef TDFXFB_DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(a,b...) printk(KERN_DEBUG &quot;fb: %s: &quot; a, __FUNCTION__ , ## b)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(a,b...)
macro_line|#endif 
DECL|macro|BANSHEE_MAX_PIXCLOCK
mdefine_line|#define BANSHEE_MAX_PIXCLOCK 270000
DECL|macro|VOODOO3_MAX_PIXCLOCK
mdefine_line|#define VOODOO3_MAX_PIXCLOCK 300000
DECL|macro|VOODOO5_MAX_PIXCLOCK
mdefine_line|#define VOODOO5_MAX_PIXCLOCK 350000
DECL|variable|__initdata
r_static
r_struct
id|fb_fix_screeninfo
id|tdfx_fix
id|__initdata
op_assign
(brace
dot
id|id
op_assign
l_string|&quot;3Dfx&quot;
comma
dot
id|type
op_assign
id|FB_TYPE_PACKED_PIXELS
comma
dot
id|visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
comma
dot
id|ypanstep
op_assign
l_int|1
comma
dot
id|ywrapstep
op_assign
l_int|1
comma
dot
id|accel
op_assign
id|FB_ACCEL_3DFX_BANSHEE
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|fb_var_screeninfo
id|tdfx_var
id|__initdata
op_assign
(brace
multiline_comment|/* &quot;640x480, 8 bpp @ 60 Hz */
dot
id|xres
op_assign
l_int|640
comma
dot
id|yres
op_assign
l_int|480
comma
dot
id|xres_virtual
op_assign
l_int|640
comma
dot
id|yres_virtual
op_assign
l_int|1024
comma
dot
id|bits_per_pixel
op_assign
l_int|8
comma
dot
id|red
op_assign
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
dot
id|blue
op_assign
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
dot
id|green
op_assign
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
dot
id|activate
op_assign
id|FB_ACTIVATE_NOW
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|accel_flags
op_assign
id|FB_ACCELF_TEXT
comma
dot
id|pixclock
op_assign
l_int|39722
comma
dot
id|left_margin
op_assign
l_int|40
comma
dot
id|right_margin
op_assign
l_int|24
comma
dot
id|upper_margin
op_assign
l_int|32
comma
dot
id|lower_margin
op_assign
l_int|11
comma
dot
id|hsync_len
op_assign
l_int|96
comma
dot
id|vsync_len
op_assign
l_int|2
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
multiline_comment|/*&n; * PCI driver prototypes&n; */
r_static
r_int
id|__devinit
id|tdfxfb_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
suffix:semicolon
r_static
r_void
id|__devexit
id|tdfxfb_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
DECL|variable|tdfxfb_id_table
r_static
r_struct
id|pci_device_id
id|tdfxfb_id_table
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_3DFX
comma
id|PCI_DEVICE_ID_3DFX_BANSHEE
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|PCI_BASE_CLASS_DISPLAY
op_lshift
l_int|16
comma
l_int|0xff0000
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_3DFX
comma
id|PCI_DEVICE_ID_3DFX_VOODOO3
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|PCI_BASE_CLASS_DISPLAY
op_lshift
l_int|16
comma
l_int|0xff0000
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_3DFX
comma
id|PCI_DEVICE_ID_3DFX_VOODOO5
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|PCI_BASE_CLASS_DISPLAY
op_lshift
l_int|16
comma
l_int|0xff0000
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
DECL|variable|tdfxfb_driver
r_static
r_struct
id|pci_driver
id|tdfxfb_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;tdfxfb&quot;
comma
dot
id|id_table
op_assign
id|tdfxfb_id_table
comma
dot
id|probe
op_assign
id|tdfxfb_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|tdfxfb_remove
)paren
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|tdfxfb_id_table
)paren
suffix:semicolon
multiline_comment|/*&n; *  Frame buffer device API&n; */
r_int
id|tdfxfb_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|tdfxfb_setup
c_func
(paren
r_char
op_star
id|options
)paren
suffix:semicolon
r_static
r_int
id|tdfxfb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|fb
)paren
suffix:semicolon
r_static
r_int
id|tdfxfb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|tdfxfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|tdfxfb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|tdfxfb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|banshee_wait_idle
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB_3DFX_ACCEL
r_static
r_void
id|tdfxfb_fillrect
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_fillrect
op_star
id|rect
)paren
suffix:semicolon
r_static
r_void
id|tdfxfb_copyarea
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_copyarea
op_star
id|area
)paren
suffix:semicolon
r_static
r_void
id|tdfxfb_imageblit
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_image
op_star
id|image
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_FB_3DFX_ACCEL */
DECL|variable|tdfxfb_ops
r_static
r_struct
id|fb_ops
id|tdfxfb_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|fb_check_var
op_assign
id|tdfxfb_check_var
comma
dot
id|fb_set_par
op_assign
id|tdfxfb_set_par
comma
dot
id|fb_setcolreg
op_assign
id|tdfxfb_setcolreg
comma
dot
id|fb_blank
op_assign
id|tdfxfb_blank
comma
dot
id|fb_pan_display
op_assign
id|tdfxfb_pan_display
comma
dot
id|fb_sync
op_assign
id|banshee_wait_idle
comma
macro_line|#ifdef CONFIG_FB_3DFX_ACCEL
dot
id|fb_fillrect
op_assign
id|tdfxfb_fillrect
comma
dot
id|fb_copyarea
op_assign
id|tdfxfb_copyarea
comma
dot
id|fb_imageblit
op_assign
id|tdfxfb_imageblit
comma
macro_line|#else
dot
id|fb_fillrect
op_assign
id|cfb_fillrect
comma
dot
id|fb_copyarea
op_assign
id|cfb_copyarea
comma
dot
id|fb_imageblit
op_assign
id|cfb_imageblit
comma
macro_line|#endif
dot
id|fb_cursor
op_assign
id|soft_cursor
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * do_xxx: Hardware-specific functions&n; */
r_static
id|u32
id|do_calc_pll
c_func
(paren
r_int
id|freq
comma
r_int
op_star
id|freq_out
)paren
suffix:semicolon
r_static
r_void
id|do_write_regs
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|banshee_reg
op_star
id|reg
)paren
suffix:semicolon
r_static
r_int
r_int
id|do_lfb_size
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/*&n; * Driver data &n; */
DECL|variable|nopan
r_static
r_int
id|nopan
op_assign
l_int|0
suffix:semicolon
DECL|variable|nowrap
r_static
r_int
id|nowrap
op_assign
l_int|1
suffix:semicolon
singleline_comment|// not implemented (yet)
DECL|variable|__initdata
r_static
r_char
op_star
id|mode_option
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------------------- &n; *                      Hardware-specific funcions&n; * ------------------------------------------------------------------------- */
macro_line|#ifdef VGA_REG_IO 
DECL|function|vga_inb
r_static
r_inline
id|u8
id|vga_inb
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
id|u32
id|reg
)paren
(brace
r_return
id|inb
c_func
(paren
id|reg
)paren
suffix:semicolon
)brace
DECL|function|vga_outb
r_static
r_inline
r_void
id|vga_outb
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
id|u32
id|reg
comma
id|u8
id|val
)paren
(brace
id|outb
c_func
(paren
id|val
comma
id|reg
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|vga_inb
r_static
r_inline
id|u8
id|vga_inb
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
id|u32
id|reg
)paren
(brace
r_return
id|inb
c_func
(paren
id|par-&gt;iobase
op_plus
id|reg
op_minus
l_int|0x300
)paren
suffix:semicolon
)brace
DECL|function|vga_outb
r_static
r_inline
r_void
id|vga_outb
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
id|u32
id|reg
comma
id|u8
id|val
)paren
(brace
id|outb
c_func
(paren
id|val
comma
id|par-&gt;iobase
op_plus
id|reg
op_minus
l_int|0x300
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|gra_outb
r_static
r_inline
r_void
id|gra_outb
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
id|u32
id|idx
comma
id|u8
id|val
)paren
(brace
id|vga_outb
c_func
(paren
id|par
comma
id|GRA_I
comma
id|idx
)paren
suffix:semicolon
id|vga_outb
c_func
(paren
id|par
comma
id|GRA_D
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|seq_outb
r_static
r_inline
r_void
id|seq_outb
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
id|u32
id|idx
comma
id|u8
id|val
)paren
(brace
id|vga_outb
c_func
(paren
id|par
comma
id|SEQ_I
comma
id|idx
)paren
suffix:semicolon
id|vga_outb
c_func
(paren
id|par
comma
id|SEQ_D
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|seq_inb
r_static
r_inline
id|u8
id|seq_inb
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
id|u32
id|idx
)paren
(brace
id|vga_outb
c_func
(paren
id|par
comma
id|SEQ_I
comma
id|idx
)paren
suffix:semicolon
r_return
id|vga_inb
c_func
(paren
id|par
comma
id|SEQ_D
)paren
suffix:semicolon
)brace
DECL|function|crt_outb
r_static
r_inline
r_void
id|crt_outb
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
id|u32
id|idx
comma
id|u8
id|val
)paren
(brace
id|vga_outb
c_func
(paren
id|par
comma
id|CRT_I
comma
id|idx
)paren
suffix:semicolon
id|vga_outb
c_func
(paren
id|par
comma
id|CRT_D
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|crt_inb
r_static
r_inline
id|u8
id|crt_inb
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
id|u32
id|idx
)paren
(brace
id|vga_outb
c_func
(paren
id|par
comma
id|CRT_I
comma
id|idx
)paren
suffix:semicolon
r_return
id|vga_inb
c_func
(paren
id|par
comma
id|CRT_D
)paren
suffix:semicolon
)brace
DECL|function|att_outb
r_static
r_inline
r_void
id|att_outb
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
id|u32
id|idx
comma
id|u8
id|val
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
id|tmp
op_assign
id|vga_inb
c_func
(paren
id|par
comma
id|IS1_R
)paren
suffix:semicolon
id|vga_outb
c_func
(paren
id|par
comma
id|ATT_IW
comma
id|idx
)paren
suffix:semicolon
id|vga_outb
c_func
(paren
id|par
comma
id|ATT_IW
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|vga_disable_video
r_static
r_inline
r_void
id|vga_disable_video
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
)paren
(brace
r_int
r_char
id|s
suffix:semicolon
id|s
op_assign
id|seq_inb
c_func
(paren
id|par
comma
l_int|0x01
)paren
op_or
l_int|0x20
suffix:semicolon
id|seq_outb
c_func
(paren
id|par
comma
l_int|0x00
comma
l_int|0x01
)paren
suffix:semicolon
id|seq_outb
c_func
(paren
id|par
comma
l_int|0x01
comma
id|s
)paren
suffix:semicolon
id|seq_outb
c_func
(paren
id|par
comma
l_int|0x00
comma
l_int|0x03
)paren
suffix:semicolon
)brace
DECL|function|vga_enable_video
r_static
r_inline
r_void
id|vga_enable_video
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
)paren
(brace
r_int
r_char
id|s
suffix:semicolon
id|s
op_assign
id|seq_inb
c_func
(paren
id|par
comma
l_int|0x01
)paren
op_amp
l_int|0xdf
suffix:semicolon
id|seq_outb
c_func
(paren
id|par
comma
l_int|0x00
comma
l_int|0x01
)paren
suffix:semicolon
id|seq_outb
c_func
(paren
id|par
comma
l_int|0x01
comma
id|s
)paren
suffix:semicolon
id|seq_outb
c_func
(paren
id|par
comma
l_int|0x00
comma
l_int|0x03
)paren
suffix:semicolon
)brace
DECL|function|vga_enable_palette
r_static
r_inline
r_void
id|vga_enable_palette
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
)paren
(brace
id|vga_inb
c_func
(paren
id|par
comma
id|IS1_R
)paren
suffix:semicolon
id|vga_outb
c_func
(paren
id|par
comma
id|ATT_IW
comma
l_int|0x20
)paren
suffix:semicolon
)brace
DECL|function|tdfx_inl
r_static
r_inline
id|u32
id|tdfx_inl
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
r_int
r_int
id|reg
)paren
(brace
r_return
id|readl
c_func
(paren
id|par-&gt;regbase_virt
op_plus
id|reg
)paren
suffix:semicolon
)brace
DECL|function|tdfx_outl
r_static
r_inline
r_void
id|tdfx_outl
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
r_int
r_int
id|reg
comma
id|u32
id|val
)paren
(brace
id|writel
c_func
(paren
id|val
comma
id|par-&gt;regbase_virt
op_plus
id|reg
)paren
suffix:semicolon
)brace
DECL|function|banshee_make_room
r_static
r_inline
r_void
id|banshee_make_room
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
r_int
id|size
)paren
(brace
multiline_comment|/* Note: The Voodoo3&squot;s onboard FIFO has 32 slots. This loop&n;&t; * won&squot;t quit if you ask for more. */
r_while
c_loop
(paren
(paren
id|tdfx_inl
c_func
(paren
id|par
comma
id|STATUS
)paren
op_amp
l_int|0x1f
)paren
OL
id|size
op_minus
l_int|1
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|banshee_wait_idle
r_static
r_int
id|banshee_wait_idle
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|1
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|COMMAND_3D
comma
id|COMMAND_3D_NOP
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|i
op_assign
(paren
id|tdfx_inl
c_func
(paren
id|par
comma
id|STATUS
)paren
op_amp
id|STATUS_BUSY
)paren
ques
c_cond
l_int|0
suffix:colon
id|i
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|3
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the color of a palette entry in 8bpp mode &n; */
DECL|function|do_setpalentry
r_static
r_inline
r_void
id|do_setpalentry
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
r_int
id|regno
comma
id|u32
id|c
)paren
(brace
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|2
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DACADDR
comma
id|regno
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DACDATA
comma
id|c
)paren
suffix:semicolon
)brace
DECL|function|do_calc_pll
r_static
id|u32
id|do_calc_pll
c_func
(paren
r_int
id|freq
comma
r_int
op_star
id|freq_out
)paren
(brace
r_int
id|m
comma
id|n
comma
id|k
comma
id|best_m
comma
id|best_n
comma
id|best_k
comma
id|f_cur
comma
id|best_error
suffix:semicolon
r_int
id|fref
op_assign
l_int|14318
suffix:semicolon
multiline_comment|/* this really could be done with more intelligence --&n;&t;   255*63*4 = 64260 iterations is silly */
id|best_error
op_assign
id|freq
suffix:semicolon
id|best_n
op_assign
id|best_m
op_assign
id|best_k
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|1
suffix:semicolon
id|n
OL
l_int|256
suffix:semicolon
id|n
op_increment
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
l_int|1
suffix:semicolon
id|m
OL
l_int|64
suffix:semicolon
id|m
op_increment
)paren
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|4
suffix:semicolon
id|k
op_increment
)paren
(brace
id|f_cur
op_assign
id|fref
op_star
(paren
id|n
op_plus
l_int|2
)paren
op_div
(paren
id|m
op_plus
l_int|2
)paren
op_div
(paren
l_int|1
op_lshift
id|k
)paren
suffix:semicolon
r_if
c_cond
(paren
id|abs
c_func
(paren
id|f_cur
op_minus
id|freq
)paren
OL
id|best_error
)paren
(brace
id|best_error
op_assign
id|abs
c_func
(paren
id|f_cur
op_minus
id|freq
)paren
suffix:semicolon
id|best_n
op_assign
id|n
suffix:semicolon
id|best_m
op_assign
id|m
suffix:semicolon
id|best_k
op_assign
id|k
suffix:semicolon
)brace
)brace
)brace
)brace
id|n
op_assign
id|best_n
suffix:semicolon
id|m
op_assign
id|best_m
suffix:semicolon
id|k
op_assign
id|best_k
suffix:semicolon
op_star
id|freq_out
op_assign
id|fref
op_star
(paren
id|n
op_plus
l_int|2
)paren
op_div
(paren
id|m
op_plus
l_int|2
)paren
op_div
(paren
l_int|1
op_lshift
id|k
)paren
suffix:semicolon
r_return
(paren
id|n
op_lshift
l_int|8
)paren
op_or
(paren
id|m
op_lshift
l_int|2
)paren
op_or
id|k
suffix:semicolon
)brace
DECL|function|do_write_regs
r_static
r_void
id|do_write_regs
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|banshee_reg
op_star
id|reg
)paren
(brace
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
id|i
suffix:semicolon
id|banshee_wait_idle
c_func
(paren
id|info
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|MISCINIT1
comma
id|tdfx_inl
c_func
(paren
id|par
comma
id|MISCINIT1
)paren
op_or
l_int|0x01
)paren
suffix:semicolon
id|crt_outb
c_func
(paren
id|par
comma
l_int|0x11
comma
id|crt_inb
c_func
(paren
id|par
comma
l_int|0x11
)paren
op_amp
l_int|0x7f
)paren
suffix:semicolon
multiline_comment|/* CRT unprotect */
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|3
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|VGAINIT1
comma
id|reg-&gt;vgainit1
op_amp
l_int|0x001FFFFF
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|VIDPROCCFG
comma
id|reg-&gt;vidcfg
op_amp
op_complement
l_int|0x00000001
)paren
suffix:semicolon
macro_line|#if 0
id|tdfx_outl
c_func
(paren
id|par
comma
id|PLLCTRL1
comma
id|reg-&gt;mempll
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|PLLCTRL2
comma
id|reg-&gt;gfxpll
)paren
suffix:semicolon
macro_line|#endif
id|tdfx_outl
c_func
(paren
id|par
comma
id|PLLCTRL0
comma
id|reg-&gt;vidpll
)paren
suffix:semicolon
id|vga_outb
c_func
(paren
id|par
comma
id|MISC_W
comma
id|reg-&gt;misc
(braket
l_int|0x00
)braket
op_or
l_int|0x01
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|seq_outb
c_func
(paren
id|par
comma
id|i
comma
id|reg-&gt;seq
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|25
suffix:semicolon
id|i
op_increment
)paren
id|crt_outb
c_func
(paren
id|par
comma
id|i
comma
id|reg-&gt;crt
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
id|gra_outb
c_func
(paren
id|par
comma
id|i
comma
id|reg-&gt;gra
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|21
suffix:semicolon
id|i
op_increment
)paren
id|att_outb
c_func
(paren
id|par
comma
id|i
comma
id|reg-&gt;att
(braket
id|i
)braket
)paren
suffix:semicolon
id|crt_outb
c_func
(paren
id|par
comma
l_int|0x1a
comma
id|reg-&gt;ext
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|crt_outb
c_func
(paren
id|par
comma
l_int|0x1b
comma
id|reg-&gt;ext
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|vga_enable_palette
c_func
(paren
id|par
)paren
suffix:semicolon
id|vga_enable_video
c_func
(paren
id|par
)paren
suffix:semicolon
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|11
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|VGAINIT0
comma
id|reg-&gt;vgainit0
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DACMODE
comma
id|reg-&gt;dacmode
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|VIDDESKSTRIDE
comma
id|reg-&gt;stride
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|HWCURPATADDR
comma
l_int|0
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|VIDSCREENSIZE
comma
id|reg-&gt;screensize
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|VIDDESKSTART
comma
id|reg-&gt;startaddr
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|VIDPROCCFG
comma
id|reg-&gt;vidcfg
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|VGAINIT1
comma
id|reg-&gt;vgainit1
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|MISCINIT0
comma
id|reg-&gt;miscinit0
)paren
suffix:semicolon
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|8
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|SRCBASE
comma
id|reg-&gt;srcbase
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DSTBASE
comma
id|reg-&gt;dstbase
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|COMMANDEXTRA_2D
comma
l_int|0
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|CLIP0MIN
comma
l_int|0
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|CLIP0MAX
comma
l_int|0x0fff0fff
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|CLIP1MIN
comma
l_int|0
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|CLIP1MAX
comma
l_int|0x0fff0fff
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|SRCXY
comma
l_int|0
)paren
suffix:semicolon
id|banshee_wait_idle
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
DECL|function|do_lfb_size
r_static
r_int
r_int
id|do_lfb_size
c_func
(paren
r_struct
id|tdfx_par
op_star
id|par
comma
r_int
r_int
id|dev_id
)paren
(brace
id|u32
id|draminit0
op_assign
l_int|0
suffix:semicolon
id|u32
id|draminit1
op_assign
l_int|0
suffix:semicolon
id|u32
id|miscinit1
op_assign
l_int|0
suffix:semicolon
id|u32
id|lfbsize
op_assign
l_int|0
suffix:semicolon
r_int
id|sgram_p
op_assign
l_int|0
suffix:semicolon
id|draminit0
op_assign
id|tdfx_inl
c_func
(paren
id|par
comma
id|DRAMINIT0
)paren
suffix:semicolon
id|draminit1
op_assign
id|tdfx_inl
c_func
(paren
id|par
comma
id|DRAMINIT1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev_id
op_eq
id|PCI_DEVICE_ID_3DFX_BANSHEE
)paren
op_logical_or
(paren
id|dev_id
op_eq
id|PCI_DEVICE_ID_3DFX_VOODOO3
)paren
)paren
(brace
id|sgram_p
op_assign
(paren
id|draminit1
op_amp
id|DRAMINIT1_MEM_SDRAM
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|lfbsize
op_assign
id|sgram_p
ques
c_cond
(paren
(paren
(paren
id|draminit0
op_amp
id|DRAMINIT0_SGRAM_NUM
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
op_star
(paren
(paren
id|draminit0
op_amp
id|DRAMINIT0_SGRAM_TYPE
)paren
ques
c_cond
l_int|8
suffix:colon
l_int|4
)paren
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:colon
l_int|16
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Voodoo4/5 */
id|u32
id|chips
comma
id|psize
comma
id|banks
suffix:semicolon
id|chips
op_assign
(paren
(paren
id|draminit0
op_amp
(paren
l_int|1
op_lshift
l_int|26
)paren
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|8
suffix:semicolon
id|psize
op_assign
l_int|1
op_lshift
(paren
(paren
id|draminit0
op_amp
l_int|0x38000000
)paren
op_rshift
l_int|28
)paren
suffix:semicolon
id|banks
op_assign
(paren
(paren
id|draminit0
op_amp
(paren
l_int|1
op_lshift
l_int|30
)paren
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
suffix:semicolon
id|lfbsize
op_assign
id|chips
op_star
id|psize
op_star
id|banks
suffix:semicolon
id|lfbsize
op_lshift_assign
l_int|20
suffix:semicolon
)brace
multiline_comment|/* disable block writes for SDRAM (why?) */
id|miscinit1
op_assign
id|tdfx_inl
c_func
(paren
id|par
comma
id|MISCINIT1
)paren
suffix:semicolon
id|miscinit1
op_or_assign
id|sgram_p
ques
c_cond
l_int|0
suffix:colon
id|MISCINIT1_2DBLOCK_DIS
suffix:semicolon
id|miscinit1
op_or_assign
id|MISCINIT1_CLUT_INV
suffix:semicolon
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|1
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|MISCINIT1
comma
id|miscinit1
)paren
suffix:semicolon
r_return
id|lfbsize
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------- */
DECL|function|tdfxfb_check_var
r_static
r_int
id|tdfxfb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|lpitch
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_ne
l_int|8
op_logical_and
id|var-&gt;bits_per_pixel
op_ne
l_int|16
op_logical_and
id|var-&gt;bits_per_pixel
op_ne
l_int|24
op_logical_and
id|var-&gt;bits_per_pixel
op_ne
l_int|32
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;depth not supported: %u&bslash;n&quot;
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|var-&gt;xres
op_ne
id|var-&gt;xres_virtual
)paren
id|var-&gt;xres_virtual
op_assign
id|var-&gt;xres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres
OG
id|var-&gt;yres_virtual
)paren
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xoffset
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;xoffset not supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Banshee doesn&squot;t support interlace, but Voodoo4/5 and probably Voodoo3 do. */
multiline_comment|/* no direct information about device id now? use max_pixclock for this... */
r_if
c_cond
(paren
(paren
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_INTERLACED
)paren
op_logical_and
(paren
id|par-&gt;max_pixclock
OL
id|VOODOO3_MAX_PIXCLOCK
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;interlace not supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|var-&gt;xres
op_assign
(paren
id|var-&gt;xres
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
suffix:semicolon
multiline_comment|/* could sometimes be 8 */
id|lpitch
op_assign
id|var-&gt;xres
op_star
(paren
(paren
id|var-&gt;bits_per_pixel
op_plus
l_int|7
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xres
template_param
l_int|2048
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;width not supported: %u&bslash;n&quot;
comma
id|var-&gt;xres
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|var-&gt;yres
template_param
l_int|2048
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;height not supported: %u&bslash;n&quot;
comma
id|var-&gt;yres
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lpitch
op_star
id|var-&gt;yres_virtual
OG
id|info-&gt;fix.smem_len
)paren
(brace
id|var-&gt;yres_virtual
op_assign
id|info-&gt;fix.smem_len
op_div
id|lpitch
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres_virtual
OL
id|var-&gt;yres
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;no memory for screen (%ux%ux%u)&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres_virtual
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|PICOS2KHZ
c_func
(paren
id|var-&gt;pixclock
)paren
OG
id|par-&gt;max_pixclock
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;pixclock too high (%ldKHz)&bslash;n&quot;
comma
id|PICOS2KHZ
c_func
(paren
id|var-&gt;pixclock
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
id|var-&gt;red.length
op_assign
id|var-&gt;green.length
op_assign
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|var-&gt;red.offset
op_assign
l_int|11
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
id|var-&gt;green.length
op_assign
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
r_case
l_int|32
suffix:colon
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
id|var-&gt;green.length
op_assign
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
id|var-&gt;height
op_assign
id|var-&gt;width
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;accel_flags
op_assign
id|FB_ACCELF_TEXT
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Checking graphics mode at %dx%d depth %d&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tdfxfb_set_par
r_static
r_int
id|tdfxfb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|hdispend
comma
id|hsyncsta
comma
id|hsyncend
comma
id|htotal
suffix:semicolon
id|u32
id|hd
comma
id|hs
comma
id|he
comma
id|ht
comma
id|hbs
comma
id|hbe
suffix:semicolon
id|u32
id|vd
comma
id|vs
comma
id|ve
comma
id|vt
comma
id|vbs
comma
id|vbe
suffix:semicolon
r_struct
id|banshee_reg
id|reg
suffix:semicolon
r_int
id|fout
comma
id|freq
suffix:semicolon
id|u32
id|wd
comma
id|cpp
suffix:semicolon
id|par-&gt;baseline
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|reg
comma
l_int|0
comma
r_sizeof
(paren
id|reg
)paren
)paren
suffix:semicolon
id|cpp
op_assign
(paren
id|info-&gt;var.bits_per_pixel
op_plus
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
id|reg.vidcfg
op_assign
id|VIDCFG_VIDPROC_ENABLE
op_or
id|VIDCFG_DESK_ENABLE
op_or
id|VIDCFG_CURS_X11
op_or
(paren
(paren
id|cpp
op_minus
l_int|1
)paren
op_lshift
id|VIDCFG_PIXFMT_SHIFT
)paren
op_or
(paren
id|cpp
op_ne
l_int|1
ques
c_cond
id|VIDCFG_CLUT_BYPASS
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* PLL settings */
id|freq
op_assign
id|PICOS2KHZ
c_func
(paren
id|info-&gt;var.pixclock
)paren
suffix:semicolon
id|reg.dacmode
op_assign
l_int|0
suffix:semicolon
id|reg.vidcfg
op_and_assign
op_complement
id|VIDCFG_2X
suffix:semicolon
id|hdispend
op_assign
id|info-&gt;var.xres
suffix:semicolon
id|hsyncsta
op_assign
id|hdispend
op_plus
id|info-&gt;var.right_margin
suffix:semicolon
id|hsyncend
op_assign
id|hsyncsta
op_plus
id|info-&gt;var.hsync_len
suffix:semicolon
id|htotal
op_assign
id|hsyncend
op_plus
id|info-&gt;var.left_margin
suffix:semicolon
r_if
c_cond
(paren
id|freq
OG
id|par-&gt;max_pixclock
op_div
l_int|2
)paren
(brace
id|freq
op_assign
id|freq
OG
id|par-&gt;max_pixclock
ques
c_cond
id|par-&gt;max_pixclock
suffix:colon
id|freq
suffix:semicolon
id|reg.dacmode
op_or_assign
id|DACMODE_2X
suffix:semicolon
id|reg.vidcfg
op_or_assign
id|VIDCFG_2X
suffix:semicolon
id|hdispend
op_rshift_assign
l_int|1
suffix:semicolon
id|hsyncsta
op_rshift_assign
l_int|1
suffix:semicolon
id|hsyncend
op_rshift_assign
l_int|1
suffix:semicolon
id|htotal
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|hd
op_assign
id|wd
op_assign
(paren
id|hdispend
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:semicolon
id|hs
op_assign
(paren
id|hsyncsta
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:semicolon
id|he
op_assign
(paren
id|hsyncend
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:semicolon
id|ht
op_assign
(paren
id|htotal
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:semicolon
id|hbs
op_assign
id|hd
suffix:semicolon
id|hbe
op_assign
id|ht
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;var.vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_DOUBLE
)paren
(brace
id|vbs
op_assign
id|vd
op_assign
(paren
id|info-&gt;var.yres
op_lshift
l_int|1
)paren
op_minus
l_int|1
suffix:semicolon
id|vs
op_assign
id|vd
op_plus
(paren
id|info-&gt;var.lower_margin
op_lshift
l_int|1
)paren
suffix:semicolon
id|ve
op_assign
id|vs
op_plus
(paren
id|info-&gt;var.vsync_len
op_lshift
l_int|1
)paren
suffix:semicolon
id|vbe
op_assign
id|vt
op_assign
id|ve
op_plus
(paren
id|info-&gt;var.upper_margin
op_lshift
l_int|1
)paren
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|vbs
op_assign
id|vd
op_assign
id|info-&gt;var.yres
op_minus
l_int|1
suffix:semicolon
id|vs
op_assign
id|vd
op_plus
id|info-&gt;var.lower_margin
suffix:semicolon
id|ve
op_assign
id|vs
op_plus
id|info-&gt;var.vsync_len
suffix:semicolon
id|vbe
op_assign
id|vt
op_assign
id|ve
op_plus
id|info-&gt;var.upper_margin
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* this is all pretty standard VGA register stuffing */
id|reg.misc
(braket
l_int|0x00
)braket
op_assign
l_int|0x0f
op_or
(paren
id|info-&gt;var.xres
OL
l_int|400
ques
c_cond
l_int|0xa0
suffix:colon
id|info-&gt;var.xres
OL
l_int|480
ques
c_cond
l_int|0x60
suffix:colon
id|info-&gt;var.xres
OL
l_int|768
ques
c_cond
l_int|0xe0
suffix:colon
l_int|0x20
)paren
suffix:semicolon
id|reg.gra
(braket
l_int|0x00
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.gra
(braket
l_int|0x01
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.gra
(braket
l_int|0x02
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.gra
(braket
l_int|0x03
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.gra
(braket
l_int|0x04
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.gra
(braket
l_int|0x05
)braket
op_assign
l_int|0x40
suffix:semicolon
id|reg.gra
(braket
l_int|0x06
)braket
op_assign
l_int|0x05
suffix:semicolon
id|reg.gra
(braket
l_int|0x07
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|reg.gra
(braket
l_int|0x08
)braket
op_assign
l_int|0xff
suffix:semicolon
id|reg.att
(braket
l_int|0x00
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.att
(braket
l_int|0x01
)braket
op_assign
l_int|0x01
suffix:semicolon
id|reg.att
(braket
l_int|0x02
)braket
op_assign
l_int|0x02
suffix:semicolon
id|reg.att
(braket
l_int|0x03
)braket
op_assign
l_int|0x03
suffix:semicolon
id|reg.att
(braket
l_int|0x04
)braket
op_assign
l_int|0x04
suffix:semicolon
id|reg.att
(braket
l_int|0x05
)braket
op_assign
l_int|0x05
suffix:semicolon
id|reg.att
(braket
l_int|0x06
)braket
op_assign
l_int|0x06
suffix:semicolon
id|reg.att
(braket
l_int|0x07
)braket
op_assign
l_int|0x07
suffix:semicolon
id|reg.att
(braket
l_int|0x08
)braket
op_assign
l_int|0x08
suffix:semicolon
id|reg.att
(braket
l_int|0x09
)braket
op_assign
l_int|0x09
suffix:semicolon
id|reg.att
(braket
l_int|0x0a
)braket
op_assign
l_int|0x0a
suffix:semicolon
id|reg.att
(braket
l_int|0x0b
)braket
op_assign
l_int|0x0b
suffix:semicolon
id|reg.att
(braket
l_int|0x0c
)braket
op_assign
l_int|0x0c
suffix:semicolon
id|reg.att
(braket
l_int|0x0d
)braket
op_assign
l_int|0x0d
suffix:semicolon
id|reg.att
(braket
l_int|0x0e
)braket
op_assign
l_int|0x0e
suffix:semicolon
id|reg.att
(braket
l_int|0x0f
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|reg.att
(braket
l_int|0x10
)braket
op_assign
l_int|0x41
suffix:semicolon
id|reg.att
(braket
l_int|0x11
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.att
(braket
l_int|0x12
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|reg.att
(braket
l_int|0x13
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.att
(braket
l_int|0x14
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.seq
(braket
l_int|0x00
)braket
op_assign
l_int|0x03
suffix:semicolon
id|reg.seq
(braket
l_int|0x01
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* fixme: clkdiv2? */
id|reg.seq
(braket
l_int|0x02
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|reg.seq
(braket
l_int|0x03
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.seq
(braket
l_int|0x04
)braket
op_assign
l_int|0x0e
suffix:semicolon
id|reg.crt
(braket
l_int|0x00
)braket
op_assign
id|ht
op_minus
l_int|4
suffix:semicolon
id|reg.crt
(braket
l_int|0x01
)braket
op_assign
id|hd
suffix:semicolon
id|reg.crt
(braket
l_int|0x02
)braket
op_assign
id|hbs
suffix:semicolon
id|reg.crt
(braket
l_int|0x03
)braket
op_assign
l_int|0x80
op_or
(paren
id|hbe
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|reg.crt
(braket
l_int|0x04
)braket
op_assign
id|hs
suffix:semicolon
id|reg.crt
(braket
l_int|0x05
)braket
op_assign
(paren
(paren
id|hbe
op_amp
l_int|0x20
)paren
op_lshift
l_int|2
)paren
op_or
(paren
id|he
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|reg.crt
(braket
l_int|0x06
)braket
op_assign
id|vt
suffix:semicolon
id|reg.crt
(braket
l_int|0x07
)braket
op_assign
(paren
(paren
id|vs
op_amp
l_int|0x200
)paren
op_rshift
l_int|2
)paren
op_or
(paren
(paren
id|vd
op_amp
l_int|0x200
)paren
op_rshift
l_int|3
)paren
op_or
(paren
(paren
id|vt
op_amp
l_int|0x200
)paren
op_rshift
l_int|4
)paren
op_or
l_int|0x10
op_or
(paren
(paren
id|vbs
op_amp
l_int|0x100
)paren
op_rshift
l_int|5
)paren
op_or
(paren
(paren
id|vs
op_amp
l_int|0x100
)paren
op_rshift
l_int|6
)paren
op_or
(paren
(paren
id|vd
op_amp
l_int|0x100
)paren
op_rshift
l_int|7
)paren
op_or
(paren
(paren
id|vt
op_amp
l_int|0x100
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|reg.crt
(braket
l_int|0x08
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.crt
(braket
l_int|0x09
)braket
op_assign
l_int|0x40
op_or
(paren
(paren
id|vbs
op_amp
l_int|0x200
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|reg.crt
(braket
l_int|0x0a
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.crt
(braket
l_int|0x0b
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.crt
(braket
l_int|0x0c
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.crt
(braket
l_int|0x0d
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.crt
(braket
l_int|0x0e
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.crt
(braket
l_int|0x0f
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.crt
(braket
l_int|0x10
)braket
op_assign
id|vs
suffix:semicolon
id|reg.crt
(braket
l_int|0x11
)braket
op_assign
(paren
id|ve
op_amp
l_int|0x0f
)paren
op_or
l_int|0x20
suffix:semicolon
id|reg.crt
(braket
l_int|0x12
)braket
op_assign
id|vd
suffix:semicolon
id|reg.crt
(braket
l_int|0x13
)braket
op_assign
id|wd
suffix:semicolon
id|reg.crt
(braket
l_int|0x14
)braket
op_assign
l_int|0x00
suffix:semicolon
id|reg.crt
(braket
l_int|0x15
)braket
op_assign
id|vbs
suffix:semicolon
id|reg.crt
(braket
l_int|0x16
)braket
op_assign
id|vbe
op_plus
l_int|1
suffix:semicolon
id|reg.crt
(braket
l_int|0x17
)braket
op_assign
l_int|0xc3
suffix:semicolon
id|reg.crt
(braket
l_int|0x18
)braket
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* Banshee&squot;s nonvga stuff */
id|reg.ext
(braket
l_int|0x00
)braket
op_assign
(paren
(paren
(paren
id|ht
op_amp
l_int|0x100
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|hd
op_amp
l_int|0x100
)paren
op_rshift
l_int|6
)paren
op_or
(paren
(paren
id|hbs
op_amp
l_int|0x100
)paren
op_rshift
l_int|4
)paren
op_or
(paren
(paren
id|hbe
op_amp
l_int|0x40
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|hs
op_amp
l_int|0x100
)paren
op_rshift
l_int|2
)paren
op_or
(paren
(paren
id|he
op_amp
l_int|0x20
)paren
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|reg.ext
(braket
l_int|0x01
)braket
op_assign
(paren
(paren
(paren
id|vt
op_amp
l_int|0x400
)paren
op_rshift
l_int|10
)paren
op_or
(paren
(paren
id|vd
op_amp
l_int|0x400
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|vbs
op_amp
l_int|0x400
)paren
op_rshift
l_int|6
)paren
op_or
(paren
(paren
id|vbe
op_amp
l_int|0x400
)paren
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
id|reg.vgainit0
op_assign
id|VGAINIT0_8BIT_DAC
op_or
id|VGAINIT0_EXT_ENABLE
op_or
id|VGAINIT0_WAKEUP_3C3
op_or
id|VGAINIT0_ALT_READBACK
op_or
id|VGAINIT0_EXTSHIFTOUT
suffix:semicolon
id|reg.vgainit1
op_assign
id|tdfx_inl
c_func
(paren
id|par
comma
id|VGAINIT1
)paren
op_amp
l_int|0x1fffff
suffix:semicolon
id|reg.cursloc
op_assign
l_int|0
suffix:semicolon
id|reg.cursc0
op_assign
l_int|0
suffix:semicolon
id|reg.cursc1
op_assign
l_int|0xffffff
suffix:semicolon
id|reg.stride
op_assign
id|info-&gt;var.xres
op_star
id|cpp
suffix:semicolon
id|reg.startaddr
op_assign
id|par-&gt;baseline
op_star
id|reg.stride
suffix:semicolon
id|reg.srcbase
op_assign
id|reg.startaddr
suffix:semicolon
id|reg.dstbase
op_assign
id|reg.startaddr
suffix:semicolon
multiline_comment|/* PLL settings */
id|freq
op_assign
id|PICOS2KHZ
c_func
(paren
id|info-&gt;var.pixclock
)paren
suffix:semicolon
id|reg.dacmode
op_and_assign
op_complement
id|DACMODE_2X
suffix:semicolon
id|reg.vidcfg
op_and_assign
op_complement
id|VIDCFG_2X
suffix:semicolon
r_if
c_cond
(paren
id|freq
OG
id|par-&gt;max_pixclock
op_div
l_int|2
)paren
(brace
id|freq
op_assign
id|freq
OG
id|par-&gt;max_pixclock
ques
c_cond
id|par-&gt;max_pixclock
suffix:colon
id|freq
suffix:semicolon
id|reg.dacmode
op_or_assign
id|DACMODE_2X
suffix:semicolon
id|reg.vidcfg
op_or_assign
id|VIDCFG_2X
suffix:semicolon
)brace
id|reg.vidpll
op_assign
id|do_calc_pll
c_func
(paren
id|freq
comma
op_amp
id|fout
)paren
suffix:semicolon
macro_line|#if 0
id|reg.mempll
op_assign
id|do_calc_pll
c_func
(paren
dot
dot
dot
comma
op_amp
id|fout
)paren
suffix:semicolon
id|reg.gfxpll
op_assign
id|do_calc_pll
c_func
(paren
dot
dot
dot
comma
op_amp
id|fout
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|info-&gt;var.vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_DOUBLE
)paren
(brace
id|reg.screensize
op_assign
id|info-&gt;var.xres
op_or
(paren
id|info-&gt;var.yres
op_lshift
l_int|13
)paren
suffix:semicolon
id|reg.vidcfg
op_or_assign
id|VIDCFG_HALF_MODE
suffix:semicolon
id|reg.crt
(braket
l_int|0x09
)braket
op_or_assign
l_int|0x80
suffix:semicolon
)brace
r_else
(brace
id|reg.screensize
op_assign
id|info-&gt;var.xres
op_or
(paren
id|info-&gt;var.yres
op_lshift
l_int|12
)paren
suffix:semicolon
id|reg.vidcfg
op_and_assign
op_complement
id|VIDCFG_HALF_MODE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|info-&gt;var.vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_INTERLACED
)paren
id|reg.vidcfg
op_or_assign
id|VIDCFG_INTERLACE
suffix:semicolon
id|reg.miscinit0
op_assign
id|tdfx_inl
c_func
(paren
id|par
comma
id|MISCINIT0
)paren
suffix:semicolon
macro_line|#if defined(__BIG_ENDIAN)
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
r_case
l_int|24
suffix:colon
id|reg.miscinit0
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|30
)paren
suffix:semicolon
id|reg.miscinit0
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|31
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|reg.miscinit0
op_or_assign
(paren
l_int|1
op_lshift
l_int|30
)paren
suffix:semicolon
id|reg.miscinit0
op_or_assign
(paren
l_int|1
op_lshift
l_int|31
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|reg.miscinit0
op_or_assign
(paren
l_int|1
op_lshift
l_int|30
)paren
suffix:semicolon
id|reg.miscinit0
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|31
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif 
id|do_write_regs
c_func
(paren
id|info
comma
op_amp
id|reg
)paren
suffix:semicolon
multiline_comment|/* Now change fb_fix_screeninfo according to changes in par */
id|info-&gt;fix.line_length
op_assign
id|info-&gt;var.xres
op_star
(paren
(paren
id|info-&gt;var.bits_per_pixel
op_plus
l_int|7
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
id|info-&gt;fix.visual
op_assign
(paren
id|info-&gt;var.bits_per_pixel
op_eq
l_int|8
)paren
ques
c_cond
id|FB_VISUAL_PSEUDOCOLOR
suffix:colon
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Graphics mode is now set at %dx%d depth %d&bslash;n&quot;
comma
id|info-&gt;var.xres
comma
id|info-&gt;var.yres
comma
id|info-&gt;var.bits_per_pixel
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* A handy macro shamelessly pinched from matroxfb */
DECL|macro|CNVT_TOHW
mdefine_line|#define CNVT_TOHW(val,width) ((((val)&lt;&lt;(width))+0x7FFF-(val))&gt;&gt;16)
DECL|function|tdfxfb_setcolreg
r_static
r_int
id|tdfxfb_setcolreg
c_func
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|rgbcol
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
id|info-&gt;cmap.len
op_logical_or
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;fix.visual
)paren
(brace
r_case
id|FB_VISUAL_PSEUDOCOLOR
suffix:colon
id|rgbcol
op_assign
(paren
(paren
(paren
id|u32
)paren
id|red
op_amp
l_int|0xff00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|green
op_amp
l_int|0xff00
)paren
op_lshift
l_int|0
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|blue
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|do_setpalentry
c_func
(paren
id|par
comma
id|regno
comma
id|rgbcol
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Truecolor has no hardware color palettes. */
r_case
id|FB_VISUAL_TRUECOLOR
suffix:colon
id|rgbcol
op_assign
(paren
id|CNVT_TOHW
c_func
(paren
id|red
comma
id|info-&gt;var.red.length
)paren
op_lshift
id|info-&gt;var.red.offset
)paren
op_or
(paren
id|CNVT_TOHW
c_func
(paren
id|green
comma
id|info-&gt;var.green.length
)paren
op_lshift
id|info-&gt;var.green.offset
)paren
op_or
(paren
id|CNVT_TOHW
c_func
(paren
id|blue
comma
id|info-&gt;var.blue.length
)paren
op_lshift
id|info-&gt;var.blue.offset
)paren
op_or
(paren
id|CNVT_TOHW
c_func
(paren
id|transp
comma
id|info-&gt;var.transp.length
)paren
op_lshift
id|info-&gt;var.transp.offset
)paren
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|regno
)braket
op_assign
id|rgbcol
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;bad depth %u&bslash;n&quot;
comma
id|info-&gt;var.bits_per_pixel
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* 0 unblank, 1 blank, 2 no vsync, 3 no hsync, 4 off */
DECL|function|tdfxfb_blank
r_static
r_int
id|tdfxfb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|dacmode
comma
id|state
op_assign
l_int|0
comma
id|vgablank
op_assign
l_int|0
suffix:semicolon
id|dacmode
op_assign
id|tdfx_inl
c_func
(paren
id|par
comma
id|DACMODE
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|blank
)paren
(brace
r_case
id|FB_BLANK_UNBLANK
suffix:colon
multiline_comment|/* Screen: On; HSync: On, VSync: On */
id|state
op_assign
l_int|0
suffix:semicolon
id|vgablank
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_NORMAL
suffix:colon
multiline_comment|/* Screen: Off; HSync: On, VSync: On */
id|state
op_assign
l_int|0
suffix:semicolon
id|vgablank
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_VSYNC_SUSPEND
suffix:colon
multiline_comment|/* Screen: Off; HSync: On, VSync: Off */
id|state
op_assign
id|BIT
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|vgablank
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_HSYNC_SUSPEND
suffix:colon
multiline_comment|/* Screen: Off; HSync: Off, VSync: On */
id|state
op_assign
id|BIT
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|vgablank
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_POWERDOWN
suffix:colon
multiline_comment|/* Screen: Off; HSync: Off, VSync: Off */
id|state
op_assign
id|BIT
c_func
(paren
l_int|1
)paren
op_or
id|BIT
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|vgablank
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dacmode
op_and_assign
op_complement
(paren
id|BIT
c_func
(paren
l_int|1
)paren
op_or
id|BIT
c_func
(paren
l_int|3
)paren
)paren
suffix:semicolon
id|dacmode
op_or_assign
id|state
suffix:semicolon
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|1
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DACMODE
comma
id|dacmode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vgablank
)paren
id|vga_disable_video
c_func
(paren
id|par
)paren
suffix:semicolon
r_else
id|vga_enable_video
c_func
(paren
id|par
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*   &n; * Set the starting position of the visible screen to var-&gt;yoffset&n; */
DECL|function|tdfxfb_pan_display
r_static
r_int
id|tdfxfb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|nopan
op_logical_or
id|var-&gt;xoffset
op_logical_or
(paren
id|var-&gt;yoffset
OG
id|var-&gt;yres_virtual
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|var-&gt;yoffset
op_plus
id|var-&gt;yres
OG
id|var-&gt;yres_virtual
op_logical_and
id|nowrap
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|addr
op_assign
id|var-&gt;yoffset
op_star
id|info-&gt;fix.line_length
suffix:semicolon
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|1
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|VIDDESKSTART
comma
id|addr
)paren
suffix:semicolon
id|info-&gt;var.xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|info-&gt;var.yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_FB_3DFX_ACCEL
multiline_comment|/*&n; * FillRect 2D command (solidfill or invert (via ROP_XOR))   &n; */
DECL|function|tdfxfb_fillrect
r_static
r_void
id|tdfxfb_fillrect
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_fillrect
op_star
id|rect
)paren
(brace
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|bpp
op_assign
id|info-&gt;var.bits_per_pixel
suffix:semicolon
id|u32
id|stride
op_assign
id|info-&gt;fix.line_length
suffix:semicolon
id|u32
id|fmt
op_assign
id|stride
op_or
(paren
(paren
id|bpp
op_plus
(paren
(paren
id|bpp
op_eq
l_int|8
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|8
)paren
)paren
op_lshift
l_int|13
)paren
suffix:semicolon
r_int
id|tdfx_rop
suffix:semicolon
r_if
c_cond
(paren
id|rect-&gt;rop
op_eq
id|ROP_COPY
)paren
id|tdfx_rop
op_assign
id|TDFX_ROP_COPY
suffix:semicolon
r_else
id|tdfx_rop
op_assign
id|TDFX_ROP_XOR
suffix:semicolon
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|5
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DSTFORMAT
comma
id|fmt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;fix.visual
op_eq
id|FB_VISUAL_PSEUDOCOLOR
)paren
(brace
id|tdfx_outl
c_func
(paren
id|par
comma
id|COLORFORE
comma
id|rect-&gt;color
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FB_VISUAL_TRUECOLOR */
id|tdfx_outl
c_func
(paren
id|par
comma
id|COLORFORE
comma
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|rect-&gt;color
)braket
)paren
suffix:semicolon
)brace
id|tdfx_outl
c_func
(paren
id|par
comma
id|COMMAND_2D
comma
id|COMMAND_2D_FILLRECT
op_or
(paren
id|tdfx_rop
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DSTSIZE
comma
id|rect-&gt;width
op_or
(paren
id|rect-&gt;height
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|LAUNCH_2D
comma
id|rect-&gt;dx
op_or
(paren
id|rect-&gt;dy
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Screen-to-Screen BitBlt 2D command (for the bmove fb op.) &n; */
DECL|function|tdfxfb_copyarea
r_static
r_void
id|tdfxfb_copyarea
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_copyarea
op_star
id|area
)paren
(brace
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|sx
op_assign
id|area-&gt;sx
comma
id|sy
op_assign
id|area-&gt;sy
comma
id|dx
op_assign
id|area-&gt;dx
comma
id|dy
op_assign
id|area-&gt;dy
suffix:semicolon
id|u32
id|bpp
op_assign
id|info-&gt;var.bits_per_pixel
suffix:semicolon
id|u32
id|stride
op_assign
id|info-&gt;fix.line_length
suffix:semicolon
id|u32
id|blitcmd
op_assign
id|COMMAND_2D_S2S_BITBLT
op_or
(paren
id|TDFX_ROP_COPY
op_lshift
l_int|24
)paren
suffix:semicolon
id|u32
id|fmt
op_assign
id|stride
op_or
(paren
(paren
id|bpp
op_plus
(paren
(paren
id|bpp
op_eq
l_int|8
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|8
)paren
)paren
op_lshift
l_int|13
)paren
suffix:semicolon
r_if
c_cond
(paren
id|area-&gt;sx
op_le
id|area-&gt;dx
)paren
(brace
singleline_comment|//-X 
id|blitcmd
op_or_assign
id|BIT
c_func
(paren
l_int|14
)paren
suffix:semicolon
id|sx
op_add_assign
id|area-&gt;width
op_minus
l_int|1
suffix:semicolon
id|dx
op_add_assign
id|area-&gt;width
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|area-&gt;sy
op_le
id|area-&gt;dy
)paren
(brace
singleline_comment|//-Y  
id|blitcmd
op_or_assign
id|BIT
c_func
(paren
l_int|15
)paren
suffix:semicolon
id|sy
op_add_assign
id|area-&gt;height
op_minus
l_int|1
suffix:semicolon
id|dy
op_add_assign
id|area-&gt;height
op_minus
l_int|1
suffix:semicolon
)brace
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|6
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|SRCFORMAT
comma
id|fmt
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DSTFORMAT
comma
id|fmt
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|COMMAND_2D
comma
id|blitcmd
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DSTSIZE
comma
id|area-&gt;width
op_or
(paren
id|area-&gt;height
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DSTXY
comma
id|dx
op_or
(paren
id|dy
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|LAUNCH_2D
comma
id|sx
op_or
(paren
id|sy
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
DECL|function|tdfxfb_imageblit
r_static
r_void
id|tdfxfb_imageblit
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_image
op_star
id|image
)paren
(brace
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
id|size
op_assign
id|image-&gt;height
op_star
(paren
(paren
id|image-&gt;width
op_star
id|image-&gt;depth
op_plus
l_int|7
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
r_int
id|fifo_free
suffix:semicolon
r_int
id|i
comma
id|stride
op_assign
id|info-&gt;fix.line_length
suffix:semicolon
id|u32
id|bpp
op_assign
id|info-&gt;var.bits_per_pixel
suffix:semicolon
id|u32
id|dstfmt
op_assign
id|stride
op_or
(paren
(paren
id|bpp
op_plus
(paren
(paren
id|bpp
op_eq
l_int|8
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|8
)paren
)paren
op_lshift
l_int|13
)paren
suffix:semicolon
id|u8
op_star
id|chardata
op_assign
(paren
id|u8
op_star
)paren
id|image-&gt;data
suffix:semicolon
id|u32
id|srcfmt
suffix:semicolon
r_if
c_cond
(paren
id|image-&gt;depth
op_ne
l_int|1
)paren
(brace
singleline_comment|//banshee_make_room(par, 6 + ((size + 3) &gt;&gt; 2));
singleline_comment|//srcfmt = stride | ((bpp+((bpp==8) ? 0 : 8)) &lt;&lt; 13) | 0x400000;
id|cfb_imageblit
c_func
(paren
id|info
comma
id|image
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|8
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;fix.visual
)paren
(brace
r_case
id|FB_VISUAL_PSEUDOCOLOR
suffix:colon
id|tdfx_outl
c_func
(paren
id|par
comma
id|COLORFORE
comma
id|image-&gt;fg_color
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|COLORBACK
comma
id|image-&gt;bg_color
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_VISUAL_TRUECOLOR
suffix:colon
r_default
suffix:colon
id|tdfx_outl
c_func
(paren
id|par
comma
id|COLORFORE
comma
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|image-&gt;fg_color
)braket
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|COLORBACK
comma
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|image-&gt;bg_color
)braket
)paren
suffix:semicolon
)brace
macro_line|#ifdef __BIG_ENDIAN
id|srcfmt
op_assign
l_int|0x400000
op_or
id|BIT
c_func
(paren
l_int|20
)paren
suffix:semicolon
macro_line|#else
id|srcfmt
op_assign
l_int|0x400000
suffix:semicolon
macro_line|#endif
)brace
id|tdfx_outl
c_func
(paren
id|par
comma
id|SRCXY
comma
l_int|0
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DSTXY
comma
id|image-&gt;dx
op_or
(paren
id|image-&gt;dy
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|COMMAND_2D
comma
id|COMMAND_2D_H2S_BITBLT
op_or
(paren
id|TDFX_ROP_COPY
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|SRCFORMAT
comma
id|srcfmt
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DSTFORMAT
comma
id|dstfmt
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|DSTSIZE
comma
id|image-&gt;width
op_or
(paren
id|image-&gt;height
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* A count of how many free FIFO entries we&squot;ve requested.&n;&t; * When this goes negative, we need to request more. */
id|fifo_free
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Send four bytes at a time of data */
r_for
c_loop
(paren
id|i
op_assign
(paren
id|size
op_rshift
l_int|2
)paren
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|fifo_free
OL
l_int|0
)paren
(brace
id|fifo_free
op_assign
l_int|31
suffix:semicolon
id|banshee_make_room
c_func
(paren
id|par
comma
id|fifo_free
)paren
suffix:semicolon
)brace
id|tdfx_outl
c_func
(paren
id|par
comma
id|LAUNCH_2D
comma
op_star
(paren
id|u32
op_star
)paren
id|chardata
)paren
suffix:semicolon
id|chardata
op_add_assign
l_int|4
suffix:semicolon
)brace
multiline_comment|/* Send the leftovers now */
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|3
)paren
suffix:semicolon
id|i
op_assign
id|size
op_mod
l_int|4
suffix:semicolon
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|tdfx_outl
c_func
(paren
id|par
comma
id|LAUNCH_2D
comma
op_star
id|chardata
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|tdfx_outl
c_func
(paren
id|par
comma
id|LAUNCH_2D
comma
op_star
(paren
id|u16
op_star
)paren
id|chardata
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|tdfx_outl
c_func
(paren
id|par
comma
id|LAUNCH_2D
comma
op_star
(paren
id|u16
op_star
)paren
id|chardata
op_or
(paren
(paren
id|chardata
(braket
l_int|3
)braket
)paren
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_FB_3DFX_ACCEL */
macro_line|#ifdef TDFX_HARDWARE_CURSOR
DECL|function|tdfxfb_cursor
r_static
r_int
id|tdfxfb_cursor
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|fb_cursor
op_star
id|cursor
)paren
(brace
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;&t; * If the cursor is not be changed this means either we want the &n;&t; * current cursor state (if enable is set) or we want to query what&n;&t; * we can do with the cursor (if enable is not set) &n; &t; */
r_if
c_cond
(paren
op_logical_neg
id|cursor-&gt;set
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Too large of a cursor :-( */
r_if
c_cond
(paren
id|cursor-&gt;image.width
OG
l_int|64
op_logical_or
id|cursor-&gt;image.height
OG
l_int|64
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* &n;&t; * If we are going to be changing things we should disable&n;&t; * the cursor first &n;&t; */
r_if
c_cond
(paren
id|info-&gt;cursor.enable
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|par-&gt;DAClock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;cursor.enable
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
(paren
id|par-&gt;hwcursor.timer
)paren
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|VIDPROCCFG
comma
id|par-&gt;hwcursor.disable
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|par-&gt;DAClock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable the Cursor */
r_if
c_cond
(paren
(paren
id|cursor-&gt;set
op_logical_and
id|FB_CUR_SETCUR
)paren
op_logical_and
op_logical_neg
id|cursor-&gt;enable
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* fix cursor color - XFree86 forgets to restore it properly */
r_if
c_cond
(paren
id|cursor-&gt;set
op_logical_and
id|FB_CUR_SETCMAP
)paren
(brace
r_struct
id|fb_cmap
id|cmap
op_assign
id|cursor-&gt;image.cmap
suffix:semicolon
r_int
r_int
id|bg_color
comma
id|fg_color
suffix:semicolon
id|cmap.len
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Voodoo 3+ only support 2 color cursors */
id|fg_color
op_assign
(paren
(paren
id|cmap.red
(braket
id|cmap.start
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|cmap.green
(braket
id|cmap.start
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|cmap.blue
(braket
id|cmap.start
)braket
)paren
)paren
suffix:semicolon
id|bg_color
op_assign
(paren
(paren
id|cmap.red
(braket
id|cmap.start
op_plus
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|cmap.green
(braket
id|cmap.start
op_plus
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|cmap.blue
(braket
id|cmap.start
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|fb_copy_cmap
c_func
(paren
op_amp
id|cmap
comma
op_amp
id|info-&gt;cursor.image.cmap
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|par-&gt;DAClock
comma
id|flags
)paren
suffix:semicolon
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|2
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|HWCURC0
comma
id|bg_color
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|HWCURC1
comma
id|fg_color
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|par-&gt;DAClock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cursor-&gt;set
op_logical_and
id|FB_CUR_SETPOS
)paren
(brace
r_int
id|x
comma
id|y
suffix:semicolon
id|x
op_assign
id|cursor-&gt;image.dx
suffix:semicolon
id|y
op_assign
id|cursor-&gt;image.dy
suffix:semicolon
id|y
op_sub_assign
id|info-&gt;var.yoffset
suffix:semicolon
id|info-&gt;cursor.image.dx
op_assign
id|x
suffix:semicolon
id|info-&gt;cursor.image.dy
op_assign
id|y
suffix:semicolon
id|x
op_add_assign
l_int|63
suffix:semicolon
id|y
op_add_assign
l_int|63
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|par-&gt;DAClock
comma
id|flags
)paren
suffix:semicolon
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|1
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|HWCURLOC
comma
(paren
id|y
op_lshift
l_int|16
)paren
op_plus
id|x
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|par-&gt;DAClock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Not supported so we fake it */
r_if
c_cond
(paren
id|cursor-&gt;set
op_logical_and
id|FB_CUR_SETHOT
)paren
(brace
id|info-&gt;cursor.hot.x
op_assign
id|cursor-&gt;hot.x
suffix:semicolon
id|info-&gt;cursor.hot.y
op_assign
id|cursor-&gt;hot.y
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cursor-&gt;set
op_logical_and
id|FB_CUR_SETSHAPE
)paren
(brace
multiline_comment|/*&n;&t; &t; * Voodoo 3 and above cards use 2 monochrome cursor patterns.&n;&t;&t; *    The reason is so the card can fetch 8 words at a time&n;&t;&t; * and are stored on chip for use for the next 8 scanlines.&n;&t;&t; * This reduces the number of times for access to draw the&n;&t;&t; * cursor for each screen refresh.&n;&t;&t; *    Each pattern is a bitmap of 64 bit wide and 64 bit high&n;&t;&t; * (total of 8192 bits or 1024 Kbytes). The two patterns are&n;&t;&t; * stored in such a way that pattern 0 always resides in the&n;&t;&t; * lower half (least significant 64 bits) of a 128 bit word&n;&t;&t; * and pattern 1 the upper half. If you examine the data of&n;&t;&t; * the cursor image the graphics card uses then from the&n;&t;&t; * begining you see line one of pattern 0, line one of&n;&t;&t; * pattern 1, line two of pattern 0, line two of pattern 1,&n;&t;&t; * etc etc. The linear stride for the cursor is always 16 bytes&n;&t;&t; * (128 bits) which is the maximum cursor width times two for&n;&t;&t; * the two monochrome patterns.&n;&t;&t; */
id|u8
op_star
id|cursorbase
op_assign
(paren
id|u8
op_star
)paren
id|info-&gt;cursor.image.data
suffix:semicolon
r_char
op_star
id|bitmap
op_assign
(paren
r_char
op_star
)paren
id|cursor-&gt;image.data
suffix:semicolon
r_char
op_star
id|mask
op_assign
(paren
r_char
op_star
)paren
id|cursor-&gt;mask
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|k
comma
id|h
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|cursor-&gt;image.height
)paren
(brace
id|j
op_assign
(paren
id|cursor-&gt;image.width
op_plus
l_int|7
)paren
op_rshift
l_int|3
suffix:semicolon
id|k
op_assign
l_int|8
op_minus
id|j
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|j
OG
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
multiline_comment|/* Pattern 0. Copy the cursor bitmap to it */
id|fb_writeb
c_func
(paren
op_star
id|bitmap
comma
id|cursorbase
op_plus
id|h
)paren
suffix:semicolon
id|bitmap
op_increment
suffix:semicolon
multiline_comment|/* Pattern 1. Copy the cursor mask to it */
id|fb_writeb
c_func
(paren
op_star
id|mask
comma
id|cursorbase
op_plus
id|h
op_plus
l_int|8
)paren
suffix:semicolon
id|mask
op_increment
suffix:semicolon
id|h
op_increment
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|k
OG
l_int|0
suffix:semicolon
id|k
op_decrement
)paren
(brace
id|fb_writeb
c_func
(paren
l_int|0
comma
id|cursorbase
op_plus
id|h
)paren
suffix:semicolon
id|fb_writeb
c_func
(paren
op_complement
l_int|0
comma
id|cursorbase
op_plus
id|h
op_plus
l_int|8
)paren
suffix:semicolon
id|h
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|fb_writel
c_func
(paren
l_int|0
comma
id|cursorbase
op_plus
id|h
)paren
suffix:semicolon
id|fb_writel
c_func
(paren
l_int|0
comma
id|cursorbase
op_plus
id|h
op_plus
l_int|4
)paren
suffix:semicolon
id|fb_writel
c_func
(paren
op_complement
l_int|0
comma
id|cursorbase
op_plus
id|h
op_plus
l_int|8
)paren
suffix:semicolon
id|fb_writel
c_func
(paren
op_complement
l_int|0
comma
id|cursorbase
op_plus
id|h
op_plus
l_int|12
)paren
suffix:semicolon
id|h
op_add_assign
l_int|16
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Turn the cursor on */
id|cursor-&gt;enable
op_assign
l_int|1
suffix:semicolon
id|info-&gt;cursor
op_assign
op_star
id|cursor
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|par-&gt;hwcursor.timer
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|par-&gt;DAClock
comma
id|flags
)paren
suffix:semicolon
id|banshee_make_room
c_func
(paren
id|par
comma
l_int|1
)paren
suffix:semicolon
id|tdfx_outl
c_func
(paren
id|par
comma
id|VIDPROCCFG
comma
id|par-&gt;hwcursor.enable
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|par-&gt;DAClock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/**&n; *      tdfxfb_probe - Device Initializiation&n; *&n; *      @pdev:  PCI Device to initialize&n; *      @id:    PCI Device ID&n; *&n; *      Initializes and allocates resources for PCI device @pdev.&n; *&n; */
DECL|function|tdfxfb_probe
r_static
r_int
id|__devinit
id|tdfxfb_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|tdfx_par
op_star
id|default_par
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_int
id|size
comma
id|err
comma
id|lpitch
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tdfxfb: Can&squot;t enable pdev: %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|size
op_assign
r_sizeof
(paren
r_struct
id|tdfx_par
)paren
op_plus
l_int|256
op_star
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|info
op_assign
id|framebuffer_alloc
c_func
(paren
id|size
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|default_par
op_assign
id|info-&gt;par
suffix:semicolon
multiline_comment|/* Configure the default fb_fix_screeninfo first */
r_switch
c_cond
(paren
id|pdev-&gt;device
)paren
(brace
r_case
id|PCI_DEVICE_ID_3DFX_BANSHEE
suffix:colon
id|strcat
c_func
(paren
id|tdfx_fix.id
comma
l_string|&quot; Banshee&quot;
)paren
suffix:semicolon
id|default_par-&gt;max_pixclock
op_assign
id|BANSHEE_MAX_PIXCLOCK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_3DFX_VOODOO3
suffix:colon
id|strcat
c_func
(paren
id|tdfx_fix.id
comma
l_string|&quot; Voodoo3&quot;
)paren
suffix:semicolon
id|default_par-&gt;max_pixclock
op_assign
id|VOODOO3_MAX_PIXCLOCK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_3DFX_VOODOO5
suffix:colon
id|strcat
c_func
(paren
id|tdfx_fix.id
comma
l_string|&quot; Voodoo5&quot;
)paren
suffix:semicolon
id|default_par-&gt;max_pixclock
op_assign
id|VOODOO5_MAX_PIXCLOCK
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tdfx_fix.mmio_start
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|tdfx_fix.mmio_len
op_assign
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|default_par-&gt;regbase_virt
op_assign
id|ioremap_nocache
c_func
(paren
id|tdfx_fix.mmio_start
comma
id|tdfx_fix.mmio_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|default_par-&gt;regbase_virt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;fb: Can&squot;t remap %s register area.&bslash;n&quot;
comma
id|tdfx_fix.id
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
l_string|&quot;tdfx regbase&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tdfxfb: Can&squot;t reserve regbase&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|tdfx_fix.smem_start
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tdfx_fix.smem_len
op_assign
id|do_lfb_size
c_func
(paren
id|default_par
comma
id|pdev-&gt;device
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;fb: Can&squot;t count %s memory.&bslash;n&quot;
comma
id|tdfx_fix.id
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
l_string|&quot;tdfx smem&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tdfxfb: Can&squot;t reserve smem&bslash;n&quot;
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|info-&gt;screen_base
op_assign
id|ioremap_nocache
c_func
(paren
id|tdfx_fix.smem_start
comma
id|tdfx_fix.smem_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;screen_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;fb: Can&squot;t remap %s framebuffer.&bslash;n&quot;
comma
id|tdfx_fix.id
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|default_par-&gt;iobase
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|2
)paren
comma
l_string|&quot;tdfx iobase&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tdfxfb: Can&squot;t reserve iobase&bslash;n&quot;
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;fb: %s memory = %dK&bslash;n&quot;
comma
id|tdfx_fix.id
comma
id|tdfx_fix.smem_len
op_rshift
l_int|10
)paren
suffix:semicolon
id|tdfx_fix.ypanstep
op_assign
id|nopan
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|tdfx_fix.ywrapstep
op_assign
id|nowrap
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|info-&gt;fbops
op_assign
op_amp
id|tdfxfb_ops
suffix:semicolon
id|info-&gt;fix
op_assign
id|tdfx_fix
suffix:semicolon
id|info-&gt;pseudo_palette
op_assign
(paren
r_void
op_star
)paren
(paren
id|default_par
op_plus
l_int|1
)paren
suffix:semicolon
id|info-&gt;flags
op_assign
id|FBINFO_DEFAULT
op_or
id|FBINFO_HWACCEL_YPAN
suffix:semicolon
macro_line|#ifdef CONFIG_FB_3DFX_ACCEL
id|info-&gt;flags
op_or_assign
id|FBINFO_HWACCEL_FILLRECT
op_or
id|FBINFO_HWACCEL_COPYAREA
op_or
id|FBINFO_HWACCEL_IMAGEBLIT
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|mode_option
)paren
id|mode_option
op_assign
l_string|&quot;640x480@60&quot;
suffix:semicolon
id|err
op_assign
id|fb_find_mode
c_func
(paren
op_amp
id|info-&gt;var
comma
id|info
comma
id|mode_option
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_or
id|err
op_eq
l_int|4
)paren
id|info-&gt;var
op_assign
id|tdfx_var
suffix:semicolon
multiline_comment|/* maximize virtual vertical length */
id|lpitch
op_assign
id|info-&gt;var.xres_virtual
op_star
(paren
(paren
id|info-&gt;var.bits_per_pixel
op_plus
l_int|7
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
id|info-&gt;var.yres_virtual
op_assign
id|info-&gt;fix.smem_len
op_div
id|lpitch
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.yres_virtual
OL
id|info-&gt;var.yres
)paren
r_goto
id|out_err
suffix:semicolon
macro_line|#ifdef CONFIG_FB_3DFX_ACCEL
multiline_comment|/*&n;&t; * FIXME: Limit var-&gt;yres_virtual to 4096 because of screen artifacts&n;&t; * during scrolling. This is only present if 2D acceleration is&n;&t; * enabled.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;var.yres_virtual
OG
l_int|4096
)paren
id|info-&gt;var.yres_virtual
op_assign
l_int|4096
suffix:semicolon
macro_line|#endif /* CONFIG_FB_3DFX_ACCEL */
r_if
c_cond
(paren
id|fb_alloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
comma
l_int|256
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tdfxfb: Can&squot;t allocate color map&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
id|info
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tdfxfb: can&squot;t register framebuffer&bslash;n&quot;
)paren
suffix:semicolon
id|fb_dealloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Our driver data&n;&t; */
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_err
suffix:colon
multiline_comment|/*&n;&t; * Cleanup after anything that was remapped/allocated.&n;&t; */
r_if
c_cond
(paren
id|default_par-&gt;regbase_virt
)paren
id|iounmap
c_func
(paren
id|default_par-&gt;regbase_virt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;screen_base
)paren
id|iounmap
c_func
(paren
id|info-&gt;screen_base
)paren
suffix:semicolon
id|framebuffer_release
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/**&n; *      tdfxfb_remove - Device removal&n; *&n; *      @pdev:  PCI Device to cleanup&n; *&n; *      Releases all resources allocated during the course of the driver&squot;s&n; *      lifetime for the PCI device @pdev.&n; *&n; */
DECL|function|tdfxfb_remove
r_static
r_void
id|__devexit
id|tdfxfb_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|tdfx_par
op_star
id|par
op_assign
(paren
r_struct
id|tdfx_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|unregister_framebuffer
c_func
(paren
id|info
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|par-&gt;regbase_virt
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|info-&gt;screen_base
)paren
suffix:semicolon
multiline_comment|/* Clean up after reserved regions */
id|release_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|2
)paren
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|framebuffer_release
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
DECL|function|tdfxfb_init
r_int
id|__init
id|tdfxfb_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifndef MODULE
r_char
op_star
id|option
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|fb_get_options
c_func
(paren
l_string|&quot;tdfxfb&quot;
comma
op_amp
id|option
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|tdfxfb_setup
c_func
(paren
id|option
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pci_module_init
c_func
(paren
op_amp
id|tdfxfb_driver
)paren
suffix:semicolon
)brace
DECL|function|tdfxfb_exit
r_static
r_void
id|__exit
id|tdfxfb_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|tdfxfb_driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Hannu Mallat &lt;hmallat@cc.hut.fi&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;3Dfx framebuffer device driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|tdfxfb_init
id|module_init
c_func
(paren
id|tdfxfb_init
)paren
suffix:semicolon
DECL|variable|tdfxfb_exit
id|module_exit
c_func
(paren
id|tdfxfb_exit
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|tdfxfb_setup
r_void
id|tdfxfb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;nopan&quot;
)paren
)paren
(brace
id|nopan
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;nowrap&quot;
)paren
)paren
(brace
id|nowrap
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|mode_option
op_assign
id|this_opt
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
eof
