multiline_comment|/*-*- linux-c -*-&n; *  linux/drivers/video/i810_accel.c -- Hardware Acceleration&n; *&n; *      Copyright (C) 2001 Antonino Daplas&lt;adaplas@pol.net&gt;&n; *      All Rights Reserved      &n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License. See the file COPYING in the main directory of this archive for&n; *  more details.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &quot;i810_regs.h&quot;
macro_line|#include &quot;i810.h&quot;
DECL|variable|i810fb_rop
r_static
id|u32
id|i810fb_rop
(braket
)braket
op_assign
(brace
id|COLOR_COPY_ROP
comma
multiline_comment|/* ROP_COPY */
id|XOR_ROP
multiline_comment|/* ROP_XOR  */
)brace
suffix:semicolon
multiline_comment|/* Macros */
DECL|macro|PUT_RING
mdefine_line|#define PUT_RING(n) {                                        &bslash;&n;&t;i810_writel(par-&gt;cur_tail, par-&gt;iring.virtual, n);   &bslash;&n;        par-&gt;cur_tail += 4;                                  &bslash;&n;        par-&gt;cur_tail &amp;= RING_SIZE_MASK;                     &bslash;&n;}                                                                      
r_extern
r_inline
r_void
id|flush_cache
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/************************************************************/
multiline_comment|/* BLT Engine Routines */
DECL|function|i810_report_error
r_static
r_inline
r_void
id|i810_report_error
c_func
(paren
id|u8
op_star
id|mmio
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;IIR     : 0x%04x&bslash;n&quot;
l_string|&quot;EIR     : 0x%04x&bslash;n&quot;
l_string|&quot;PGTBL_ER: 0x%04x&bslash;n&quot;
l_string|&quot;IPEIR   : 0x%04x&bslash;n&quot;
l_string|&quot;IPEHR   : 0x%04x&bslash;n&quot;
comma
id|i810_readw
c_func
(paren
id|IIR
comma
id|mmio
)paren
comma
id|i810_readb
c_func
(paren
id|EIR
comma
id|mmio
)paren
comma
id|i810_readl
c_func
(paren
id|PGTBL_ER
comma
id|mmio
)paren
comma
id|i810_readl
c_func
(paren
id|IPEIR
comma
id|mmio
)paren
comma
id|i810_readl
c_func
(paren
id|IPEHR
comma
id|mmio
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * wait_for_space - check ring buffer free space&n; * @space: amount of ringbuffer space needed in bytes&n; * @par: pointer to i810fb_par structure&n; *&n; * DESCRIPTION:&n; * The function waits until a free space from the ringbuffer&n; * is available &n; */
DECL|function|wait_for_space
r_static
r_inline
r_int
id|wait_for_space
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
id|u32
id|space
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|head
comma
id|count
op_assign
id|WAIT_COUNT
comma
id|tail
suffix:semicolon
id|u8
op_star
id|mmio
op_assign
id|par-&gt;mmio_start_virtual
suffix:semicolon
id|tail
op_assign
id|par-&gt;cur_tail
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
id|head
op_assign
id|i810_readl
c_func
(paren
id|IRING
op_plus
l_int|4
comma
id|mmio
)paren
op_amp
id|RBUFFER_HEAD_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tail
op_eq
id|head
)paren
op_logical_or
(paren
id|tail
OG
id|head
op_logical_and
(paren
id|par-&gt;iring.size
op_minus
id|tail
op_plus
id|head
)paren
op_ge
id|space
)paren
op_logical_or
(paren
id|tail
OL
id|head
op_logical_and
(paren
id|head
op_minus
id|tail
)paren
op_ge
id|space
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;ringbuffer lockup!!!&bslash;n&quot;
)paren
suffix:semicolon
id|i810_report_error
c_func
(paren
id|mmio
)paren
suffix:semicolon
id|par-&gt;dev_flags
op_or_assign
id|LOCKUP
suffix:semicolon
id|info-&gt;pixmap.scan_align
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/** &n; * wait_for_engine_idle - waits for all hardware engines to finish&n; * @par: pointer to i810fb_par structure&n; *&n; * DESCRIPTION:&n; * This waits for lring(0), iring(1), and batch(3), etc to finish and&n; * waits until ringbuffer is empty.&n; */
DECL|function|wait_for_engine_idle
r_static
r_inline
r_int
id|wait_for_engine_idle
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u8
op_star
id|mmio
op_assign
id|par-&gt;mmio_start_virtual
suffix:semicolon
r_int
id|count
op_assign
id|WAIT_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|wait_for_space
c_func
(paren
id|info
comma
id|par-&gt;iring.size
)paren
)paren
multiline_comment|/* flush */
r_return
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|i810_readw
c_func
(paren
id|INSTDONE
comma
id|mmio
)paren
op_amp
l_int|0x7B
)paren
op_ne
l_int|0x7B
op_logical_and
op_decrement
id|count
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;accel engine lockup!!!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;INSTDONE: 0x%04x&bslash;n&quot;
comma
id|i810_readl
c_func
(paren
id|INSTDONE
comma
id|mmio
)paren
)paren
suffix:semicolon
id|i810_report_error
c_func
(paren
id|mmio
)paren
suffix:semicolon
id|par-&gt;dev_flags
op_or_assign
id|LOCKUP
suffix:semicolon
id|info-&gt;pixmap.scan_align
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* begin_iring - prepares the ringbuffer &n; * @space: length of sequence in dwords&n; * @par: pointer to i810fb_par structure&n; *&n; * DESCRIPTION:&n; * Checks/waits for sufficent space in ringbuffer of size&n; * space.  Returns the tail of the buffer&n; */
DECL|function|begin_iring
r_static
r_inline
id|u32
id|begin_iring
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
id|u32
id|space
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;dev_flags
op_amp
id|ALWAYS_SYNC
)paren
id|wait_for_engine_idle
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
id|wait_for_space
c_func
(paren
id|info
comma
id|space
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * end_iring - advances the buffer&n; * @par: pointer to i810fb_par structure&n; *&n; * DESCRIPTION:&n; * This advances the tail of the ringbuffer, effectively&n; * beginning the execution of the graphics instruction sequence.&n; */
DECL|function|end_iring
r_static
r_inline
r_void
id|end_iring
c_func
(paren
r_struct
id|i810fb_par
op_star
id|par
)paren
(brace
id|u8
op_star
id|mmio
op_assign
id|par-&gt;mmio_start_virtual
suffix:semicolon
id|i810_writel
c_func
(paren
id|IRING
comma
id|mmio
comma
id|par-&gt;cur_tail
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * source_copy_blit - BLIT transfer operation&n; * @dwidth: width of rectangular graphics data&n; * @dheight: height of rectangular graphics data&n; * @dpitch: bytes per line of destination buffer&n; * @xdir: direction of copy (left to right or right to left)&n; * @src: address of first pixel to read from&n; * @dest: address of first pixel to write to&n; * @from: source address&n; * @where: destination address&n; * @rop: raster operation&n; * @blit_bpp: pixel format which can be different from the &n; *            framebuffer&squot;s pixelformat&n; * @par: pointer to i810fb_par structure&n; *&n; * DESCRIPTION:&n; * This is a BLIT operation typically used when doing&n; * a &squot;Copy and Paste&squot;&n; */
DECL|function|source_copy_blit
r_static
r_inline
r_void
id|source_copy_blit
c_func
(paren
r_int
id|dwidth
comma
r_int
id|dheight
comma
r_int
id|dpitch
comma
r_int
id|xdir
comma
r_int
id|src
comma
r_int
id|dest
comma
r_int
id|rop
comma
r_int
id|blit_bpp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|begin_iring
c_func
(paren
id|info
comma
l_int|24
op_plus
id|IRING_PAD
)paren
)paren
r_return
suffix:semicolon
id|PUT_RING
c_func
(paren
id|BLIT
op_or
id|SOURCE_COPY_BLIT
op_or
l_int|4
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|xdir
op_or
id|rop
op_lshift
l_int|16
op_or
id|dpitch
op_or
id|DYN_COLOR_EN
op_or
id|blit_bpp
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|dheight
op_lshift
l_int|16
op_or
id|dwidth
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|dest
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|dpitch
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|src
)paren
suffix:semicolon
id|end_iring
c_func
(paren
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * color_blit - solid color BLIT operation&n; * @width: width of destination&n; * @height: height of destination&n; * @pitch: pixels per line of the buffer&n; * @dest: address of first pixel to write to&n; * @where: destination&n; * @rop: raster operation&n; * @what: color to transfer&n; * @blit_bpp: pixel format which can be different from the &n; *            framebuffer&squot;s pixelformat&n; * @par: pointer to i810fb_par structure&n; *&n; * DESCRIPTION:&n; * A BLIT operation which can be used for  color fill/rectangular fill&n; */
DECL|function|color_blit
r_static
r_inline
r_void
id|color_blit
c_func
(paren
r_int
id|width
comma
r_int
id|height
comma
r_int
id|pitch
comma
r_int
id|dest
comma
r_int
id|rop
comma
r_int
id|what
comma
r_int
id|blit_bpp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|begin_iring
c_func
(paren
id|info
comma
l_int|24
op_plus
id|IRING_PAD
)paren
)paren
r_return
suffix:semicolon
id|PUT_RING
c_func
(paren
id|BLIT
op_or
id|COLOR_BLT
op_or
l_int|3
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|rop
op_lshift
l_int|16
op_or
id|pitch
op_or
id|SOLIDPATTERN
op_or
id|DYN_COLOR_EN
op_or
id|blit_bpp
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|height
op_lshift
l_int|16
op_or
id|width
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|dest
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|what
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|NOP
)paren
suffix:semicolon
id|end_iring
c_func
(paren
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * mono_src_copy_imm_blit - color expand from system memory to framebuffer&n; * @dwidth: width of destination&n; * @dheight: height of destination&n; * @dpitch: pixels per line of the buffer&n; * @dsize: size of bitmap in double words&n; * @dest: address of first byte of pixel;&n; * @rop: raster operation&n; * @blit_bpp: pixelformat to use which can be different from the &n; *            framebuffer&squot;s pixelformat&n; * @src: address of image data&n; * @bg: backgound color&n; * @fg: forground color&n; * @par: pointer to i810fb_par structure&n; *&n; * DESCRIPTION:&n; * A color expand operation where the  source data is placed in the &n; * ringbuffer itself. Useful for drawing text. &n; *&n; * REQUIREMENT:&n; * The end of a scanline must be padded to the next word.&n; */
DECL|function|mono_src_copy_imm_blit
r_static
r_inline
r_void
id|mono_src_copy_imm_blit
c_func
(paren
r_int
id|dwidth
comma
r_int
id|dheight
comma
r_int
id|dpitch
comma
r_int
id|dsize
comma
r_int
id|blit_bpp
comma
r_int
id|rop
comma
r_int
id|dest
comma
r_const
id|u32
op_star
id|src
comma
r_int
id|bg
comma
r_int
id|fg
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|begin_iring
c_func
(paren
id|info
comma
l_int|24
op_plus
(paren
id|dsize
op_lshift
l_int|2
)paren
op_plus
id|IRING_PAD
)paren
)paren
r_return
suffix:semicolon
id|PUT_RING
c_func
(paren
id|BLIT
op_or
id|MONO_SOURCE_COPY_IMMEDIATE
op_or
(paren
l_int|4
op_plus
id|dsize
)paren
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|DYN_COLOR_EN
op_or
id|blit_bpp
op_or
id|rop
op_lshift
l_int|16
op_or
id|dpitch
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|dheight
op_lshift
l_int|16
op_or
id|dwidth
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|dest
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|bg
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|fg
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dsize
op_decrement
)paren
id|PUT_RING
c_func
(paren
op_star
id|src
op_increment
)paren
suffix:semicolon
id|end_iring
c_func
(paren
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * mono_src_copy_blit - color expand from video memory to framebuffer&n; * @dwidth: width of destination&n; * @dheight: height of destination&n; * @dpitch: pixels per line of the buffer&n; * @qsize: size of bitmap in quad words&n; * @dest: address of first byte of pixel;&n; * @rop: raster operation&n; * @blit_bpp: pixelformat to use which can be different from the &n; *            framebuffer&squot;s pixelformat&n; * @src: address of image data&n; * @bg: backgound color&n; * @fg: forground color&n; * @par: pointer to i810fb_par structure&n; *&n; * DESCRIPTION:&n; * A color expand operation where the  source data is in video memory. &n; * Useful for drawing text. &n; *&n; * REQUIREMENT:&n; * The end of a scanline must be padded to the next word.&n; */
DECL|function|mono_src_copy_blit
r_static
r_inline
r_void
id|mono_src_copy_blit
c_func
(paren
r_int
id|dwidth
comma
r_int
id|dheight
comma
r_int
id|dpitch
comma
r_int
id|qsize
comma
r_int
id|blit_bpp
comma
r_int
id|rop
comma
r_int
id|dest
comma
r_int
id|src
comma
r_int
id|bg
comma
r_int
id|fg
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|begin_iring
c_func
(paren
id|info
comma
l_int|32
op_plus
id|IRING_PAD
)paren
)paren
r_return
suffix:semicolon
id|PUT_RING
c_func
(paren
id|BLIT
op_or
id|MONO_SOURCE_COPY_BLIT
op_or
l_int|6
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|DYN_COLOR_EN
op_or
id|blit_bpp
op_or
id|rop
op_lshift
l_int|16
op_or
id|dpitch
op_or
l_int|1
op_lshift
l_int|27
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|dheight
op_lshift
l_int|16
op_or
id|dwidth
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|dest
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|qsize
op_minus
l_int|1
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|src
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|bg
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|fg
)paren
suffix:semicolon
id|end_iring
c_func
(paren
id|par
)paren
suffix:semicolon
)brace
DECL|function|load_front
r_static
r_inline
r_void
id|load_front
c_func
(paren
r_int
id|offset
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|begin_iring
c_func
(paren
id|info
comma
l_int|8
op_plus
id|IRING_PAD
)paren
)paren
r_return
suffix:semicolon
id|PUT_RING
c_func
(paren
id|PARSER
op_or
id|FLUSH
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
id|NOP
)paren
suffix:semicolon
id|end_iring
c_func
(paren
id|par
)paren
suffix:semicolon
r_if
c_cond
(paren
id|begin_iring
c_func
(paren
id|info
comma
l_int|8
op_plus
id|IRING_PAD
)paren
)paren
r_return
suffix:semicolon
id|PUT_RING
c_func
(paren
id|PARSER
op_or
id|FRONT_BUFFER
op_or
(paren
(paren
id|par-&gt;pitch
op_rshift
l_int|3
)paren
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|PUT_RING
c_func
(paren
(paren
id|par-&gt;fb.offset
op_lshift
l_int|12
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|end_iring
c_func
(paren
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * i810fb_iring_enable - enables/disables the ringbuffer&n; * @mode: enable or disable&n; * @par: pointer to i810fb_par structure&n; *&n; * DESCRIPTION:&n; * Enables or disables the ringbuffer, effectively enabling or&n; * disabling the instruction/acceleration engine.&n; */
DECL|function|i810fb_iring_enable
r_static
r_inline
r_void
id|i810fb_iring_enable
c_func
(paren
r_struct
id|i810fb_par
op_star
id|par
comma
id|u32
id|mode
)paren
(brace
id|u32
id|tmp
suffix:semicolon
id|u8
op_star
id|mmio
op_assign
id|par-&gt;mmio_start_virtual
suffix:semicolon
id|tmp
op_assign
id|i810_readl
c_func
(paren
id|IRING
op_plus
l_int|12
comma
id|mmio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|OFF
)paren
id|tmp
op_and_assign
op_complement
l_int|1
suffix:semicolon
r_else
id|tmp
op_or_assign
l_int|1
suffix:semicolon
id|flush_cache
c_func
(paren
)paren
suffix:semicolon
id|i810_writel
c_func
(paren
id|IRING
op_plus
l_int|12
comma
id|mmio
comma
id|tmp
)paren
suffix:semicolon
)brace
DECL|function|i810fb_fillrect
r_void
id|i810fb_fillrect
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_fillrect
op_star
id|rect
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|dx
comma
id|dy
comma
id|width
comma
id|height
comma
id|dest
comma
id|rop
op_assign
l_int|0
comma
id|color
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;var.accel_flags
op_logical_or
id|par-&gt;dev_flags
op_amp
id|LOCKUP
op_logical_or
id|par-&gt;depth
op_eq
l_int|4
)paren
r_return
id|cfb_fillrect
c_func
(paren
id|info
comma
id|rect
)paren
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;depth
op_eq
l_int|1
)paren
id|color
op_assign
id|rect-&gt;color
suffix:semicolon
r_else
id|color
op_assign
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|rect-&gt;color
)braket
suffix:semicolon
id|rop
op_assign
id|i810fb_rop
(braket
id|rect-&gt;rop
)braket
suffix:semicolon
id|dx
op_assign
id|rect-&gt;dx
op_star
id|par-&gt;depth
suffix:semicolon
id|width
op_assign
id|rect-&gt;width
op_star
id|par-&gt;depth
suffix:semicolon
id|dy
op_assign
id|rect-&gt;dy
suffix:semicolon
id|height
op_assign
id|rect-&gt;height
suffix:semicolon
id|dest
op_assign
id|info-&gt;fix.smem_start
op_plus
(paren
id|dy
op_star
id|info-&gt;fix.line_length
)paren
op_plus
id|dx
suffix:semicolon
id|color_blit
c_func
(paren
id|width
comma
id|height
comma
id|info-&gt;fix.line_length
comma
id|dest
comma
id|rop
comma
id|color
comma
id|par-&gt;blit_bpp
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|i810fb_copyarea
r_void
id|i810fb_copyarea
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_copyarea
op_star
id|region
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|sx
comma
id|sy
comma
id|dx
comma
id|dy
comma
id|pitch
comma
id|width
comma
id|height
comma
id|src
comma
id|dest
comma
id|xdir
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;var.accel_flags
op_logical_or
id|par-&gt;dev_flags
op_amp
id|LOCKUP
op_logical_or
id|par-&gt;depth
op_eq
l_int|4
)paren
r_return
id|cfb_copyarea
c_func
(paren
id|info
comma
id|region
)paren
suffix:semicolon
id|dx
op_assign
id|region-&gt;dx
op_star
id|par-&gt;depth
suffix:semicolon
id|sx
op_assign
id|region-&gt;sx
op_star
id|par-&gt;depth
suffix:semicolon
id|width
op_assign
id|region-&gt;width
op_star
id|par-&gt;depth
suffix:semicolon
id|sy
op_assign
id|region-&gt;sy
suffix:semicolon
id|dy
op_assign
id|region-&gt;dy
suffix:semicolon
id|height
op_assign
id|region-&gt;height
suffix:semicolon
r_if
c_cond
(paren
id|dx
op_le
id|sx
)paren
(brace
id|xdir
op_assign
id|INCREMENT
suffix:semicolon
)brace
r_else
(brace
id|xdir
op_assign
id|DECREMENT
suffix:semicolon
id|sx
op_add_assign
id|width
op_minus
l_int|1
suffix:semicolon
id|dx
op_add_assign
id|width
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dy
op_le
id|sy
)paren
(brace
id|pitch
op_assign
id|info-&gt;fix.line_length
suffix:semicolon
)brace
r_else
(brace
id|pitch
op_assign
(paren
op_minus
(paren
id|info-&gt;fix.line_length
)paren
)paren
op_amp
l_int|0xFFFF
suffix:semicolon
id|sy
op_add_assign
id|height
op_minus
l_int|1
suffix:semicolon
id|dy
op_add_assign
id|height
op_minus
l_int|1
suffix:semicolon
)brace
id|src
op_assign
id|info-&gt;fix.smem_start
op_plus
(paren
id|sy
op_star
id|info-&gt;fix.line_length
)paren
op_plus
id|sx
suffix:semicolon
id|dest
op_assign
id|info-&gt;fix.smem_start
op_plus
(paren
id|dy
op_star
id|info-&gt;fix.line_length
)paren
op_plus
id|dx
suffix:semicolon
id|source_copy_blit
c_func
(paren
id|width
comma
id|height
comma
id|pitch
comma
id|xdir
comma
id|src
comma
id|dest
comma
id|PAT_COPY_ROP
comma
id|par-&gt;blit_bpp
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|i810fb_imageblit
r_void
id|i810fb_imageblit
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_image
op_star
id|image
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|fg
op_assign
l_int|0
comma
id|bg
op_assign
l_int|0
comma
id|size
comma
id|dst
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;var.accel_flags
op_logical_or
id|par-&gt;dev_flags
op_amp
id|LOCKUP
op_logical_or
id|par-&gt;depth
op_eq
l_int|4
op_logical_or
id|image-&gt;depth
op_ne
l_int|1
)paren
r_return
id|cfb_imageblit
c_func
(paren
id|info
comma
id|image
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
id|fg
op_assign
id|image-&gt;fg_color
suffix:semicolon
id|bg
op_assign
id|image-&gt;bg_color
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
r_case
l_int|24
suffix:colon
id|fg
op_assign
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|image-&gt;fg_color
)braket
suffix:semicolon
id|bg
op_assign
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|image-&gt;bg_color
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dst
op_assign
id|info-&gt;fix.smem_start
op_plus
(paren
id|image-&gt;dy
op_star
id|info-&gt;fix.line_length
)paren
op_plus
(paren
id|image-&gt;dx
op_star
id|par-&gt;depth
)paren
suffix:semicolon
id|size
op_assign
(paren
id|image-&gt;width
op_plus
l_int|7
)paren
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
id|size
op_and_assign
op_complement
l_int|1
suffix:semicolon
id|size
op_mul_assign
id|image-&gt;height
suffix:semicolon
id|size
op_add_assign
l_int|7
suffix:semicolon
id|size
op_and_assign
op_complement
l_int|7
suffix:semicolon
id|mono_src_copy_imm_blit
c_func
(paren
id|image-&gt;width
op_star
id|par-&gt;depth
comma
id|image-&gt;height
comma
id|info-&gt;fix.line_length
comma
id|size
op_div
l_int|4
comma
id|par-&gt;blit_bpp
comma
id|PAT_COPY_ROP
comma
id|dst
comma
(paren
id|u32
op_star
)paren
id|image-&gt;data
comma
id|bg
comma
id|fg
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|i810fb_sync
r_int
id|i810fb_sync
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;var.accel_flags
op_logical_or
id|par-&gt;dev_flags
op_amp
id|LOCKUP
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|wait_for_engine_idle
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
DECL|function|i810fb_load_front
r_void
id|i810fb_load_front
c_func
(paren
id|u32
id|offset
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u8
op_star
id|mmio
op_assign
id|par-&gt;mmio_start_virtual
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;var.accel_flags
op_logical_or
id|par-&gt;dev_flags
op_amp
id|LOCKUP
)paren
id|i810_writel
c_func
(paren
id|DPLYBASE
comma
id|mmio
comma
id|par-&gt;fb.physical
op_plus
id|offset
)paren
suffix:semicolon
r_else
id|load_front
c_func
(paren
id|offset
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * i810fb_init_ringbuffer - initialize the ringbuffer&n; * @par: pointer to i810fb_par structure&n; *&n; * DESCRIPTION:&n; * Initializes the ringbuffer by telling the device the&n; * size and location of the ringbuffer.  It also sets &n; * the head and tail pointers = 0&n; */
DECL|function|i810fb_init_ringbuffer
r_void
id|i810fb_init_ringbuffer
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|i810fb_par
op_star
id|par
op_assign
(paren
r_struct
id|i810fb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|tmp1
comma
id|tmp2
suffix:semicolon
id|u8
op_star
id|mmio
op_assign
id|par-&gt;mmio_start_virtual
suffix:semicolon
id|wait_for_engine_idle
c_func
(paren
id|info
)paren
suffix:semicolon
id|i810fb_iring_enable
c_func
(paren
id|par
comma
id|OFF
)paren
suffix:semicolon
id|i810_writel
c_func
(paren
id|IRING
comma
id|mmio
comma
l_int|0
)paren
suffix:semicolon
id|i810_writel
c_func
(paren
id|IRING
op_plus
l_int|4
comma
id|mmio
comma
l_int|0
)paren
suffix:semicolon
id|par-&gt;cur_tail
op_assign
l_int|0
suffix:semicolon
id|tmp2
op_assign
id|i810_readl
c_func
(paren
id|IRING
op_plus
l_int|8
comma
id|mmio
)paren
op_amp
op_complement
id|RBUFFER_START_MASK
suffix:semicolon
id|tmp1
op_assign
id|par-&gt;iring.physical
suffix:semicolon
id|i810_writel
c_func
(paren
id|IRING
op_plus
l_int|8
comma
id|mmio
comma
id|tmp2
op_or
id|tmp1
)paren
suffix:semicolon
id|tmp1
op_assign
id|i810_readl
c_func
(paren
id|IRING
op_plus
l_int|12
comma
id|mmio
)paren
suffix:semicolon
id|tmp1
op_and_assign
op_complement
id|RBUFFER_SIZE_MASK
suffix:semicolon
id|tmp2
op_assign
(paren
id|par-&gt;iring.size
op_minus
id|I810_PAGESIZE
)paren
op_amp
id|RBUFFER_SIZE_MASK
suffix:semicolon
id|i810_writel
c_func
(paren
id|IRING
op_plus
l_int|12
comma
id|mmio
comma
id|tmp1
op_or
id|tmp2
)paren
suffix:semicolon
id|i810fb_iring_enable
c_func
(paren
id|par
comma
id|ON
)paren
suffix:semicolon
)brace
eof
