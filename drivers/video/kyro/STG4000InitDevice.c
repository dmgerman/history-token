multiline_comment|/*&n; *  linux/drivers/video/kyro/STG4000InitDevice.c&n; *&n; *  Copyright (C) 2000 Imagination Technologies Ltd&n; *  Copyright (C) 2002 STMicroelectronics&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &quot;STG4000Reg.h&quot;
multiline_comment|/* SDRAM fixed settings */
DECL|macro|SDRAM_CFG_0
mdefine_line|#define SDRAM_CFG_0   0x49A1
DECL|macro|SDRAM_CFG_1
mdefine_line|#define SDRAM_CFG_1   0xA732
DECL|macro|SDRAM_CFG_2
mdefine_line|#define SDRAM_CFG_2   0x31
DECL|macro|SDRAM_ARB_CFG
mdefine_line|#define SDRAM_ARB_CFG 0xA0
DECL|macro|SDRAM_REFRESH
mdefine_line|#define SDRAM_REFRESH 0x20
multiline_comment|/* Reset values */
DECL|macro|PMX2_SOFTRESET_DAC_RST
mdefine_line|#define PMX2_SOFTRESET_DAC_RST&t;&t;0x0001
DECL|macro|PMX2_SOFTRESET_C1_RST
mdefine_line|#define PMX2_SOFTRESET_C1_RST&t;&t;0x0004
DECL|macro|PMX2_SOFTRESET_C2_RST
mdefine_line|#define PMX2_SOFTRESET_C2_RST&t;&t;0x0008
DECL|macro|PMX2_SOFTRESET_3D_RST
mdefine_line|#define PMX2_SOFTRESET_3D_RST&t;&t;0x0010
DECL|macro|PMX2_SOFTRESET_VIDIN_RST
mdefine_line|#define PMX2_SOFTRESET_VIDIN_RST&t;0x0020
DECL|macro|PMX2_SOFTRESET_TLB_RST
mdefine_line|#define PMX2_SOFTRESET_TLB_RST&t;&t;0x0040
DECL|macro|PMX2_SOFTRESET_SD_RST
mdefine_line|#define PMX2_SOFTRESET_SD_RST&t;&t;0x0080
DECL|macro|PMX2_SOFTRESET_VGA_RST
mdefine_line|#define PMX2_SOFTRESET_VGA_RST&t;&t;0x0100
DECL|macro|PMX2_SOFTRESET_ROM_RST
mdefine_line|#define PMX2_SOFTRESET_ROM_RST&t;&t;0x0200&t;/* reserved bit, do not reset */
DECL|macro|PMX2_SOFTRESET_TA_RST
mdefine_line|#define PMX2_SOFTRESET_TA_RST&t;&t;0x0400
DECL|macro|PMX2_SOFTRESET_REG_RST
mdefine_line|#define PMX2_SOFTRESET_REG_RST&t;&t;0x4000
DECL|macro|PMX2_SOFTRESET_ALL
mdefine_line|#define PMX2_SOFTRESET_ALL&t;&t;0x7fff
multiline_comment|/* Core clock freq */
DECL|macro|CORE_PLL_FREQ
mdefine_line|#define CORE_PLL_FREQ 1000000
multiline_comment|/* Reference Clock freq */
DECL|macro|REF_FREQ
mdefine_line|#define REF_FREQ 14318
multiline_comment|/* PCI Registers */
DECL|variable|CorePllControl
r_static
id|u16
id|CorePllControl
op_assign
l_int|0x70
suffix:semicolon
DECL|macro|PCI_CONFIG_SUBSYS_ID
mdefine_line|#define&t;PCI_CONFIG_SUBSYS_ID&t;0x2e
multiline_comment|/* Misc */
DECL|macro|CORE_PLL_MODE_REG_0_7
mdefine_line|#define CORE_PLL_MODE_REG_0_7      3
DECL|macro|CORE_PLL_MODE_REG_8_15
mdefine_line|#define CORE_PLL_MODE_REG_8_15     2
DECL|macro|CORE_PLL_MODE_CONFIG_REG
mdefine_line|#define CORE_PLL_MODE_CONFIG_REG   1
DECL|macro|DAC_PLL_CONFIG_REG
mdefine_line|#define DAC_PLL_CONFIG_REG         0
DECL|macro|STG_MAX_VCO
mdefine_line|#define STG_MAX_VCO 500000
DECL|macro|STG_MIN_VCO
mdefine_line|#define STG_MIN_VCO 100000
multiline_comment|/* PLL Clock */
DECL|macro|STG4K3_PLL_SCALER
mdefine_line|#define    STG4K3_PLL_SCALER      8&t;/* scale numbers by 2^8 for fixed point calc */
DECL|macro|STG4K3_PLL_MIN_R
mdefine_line|#define    STG4K3_PLL_MIN_R       2&t;/* Minimum multiplier */
DECL|macro|STG4K3_PLL_MAX_R
mdefine_line|#define    STG4K3_PLL_MAX_R       33&t;/* Max */
DECL|macro|STG4K3_PLL_MIN_F
mdefine_line|#define    STG4K3_PLL_MIN_F       2&t;/* Minimum divisor */
DECL|macro|STG4K3_PLL_MAX_F
mdefine_line|#define    STG4K3_PLL_MAX_F       513&t;/* Max */
DECL|macro|STG4K3_PLL_MIN_OD
mdefine_line|#define    STG4K3_PLL_MIN_OD      0&t;/* Min output divider (shift) */
DECL|macro|STG4K3_PLL_MAX_OD
mdefine_line|#define    STG4K3_PLL_MAX_OD      2&t;/* Max */
DECL|macro|STG4K3_PLL_MIN_VCO_SC
mdefine_line|#define    STG4K3_PLL_MIN_VCO_SC  (100000000 &gt;&gt; STG4K3_PLL_SCALER)&t;/* Min VCO rate */
DECL|macro|STG4K3_PLL_MAX_VCO_SC
mdefine_line|#define    STG4K3_PLL_MAX_VCO_SC  (500000000 &gt;&gt; STG4K3_PLL_SCALER)&t;/* Max VCO rate */
DECL|macro|STG4K3_PLL_MINR_VCO_SC
mdefine_line|#define    STG4K3_PLL_MINR_VCO_SC (100000000 &gt;&gt; STG4K3_PLL_SCALER)&t;/* Min VCO rate (restricted) */
DECL|macro|STG4K3_PLL_MAXR_VCO_SC
mdefine_line|#define    STG4K3_PLL_MAXR_VCO_SC (500000000 &gt;&gt; STG4K3_PLL_SCALER)&t;/* Max VCO rate (restricted) */
DECL|macro|STG4K3_PLL_MINR_VCO
mdefine_line|#define    STG4K3_PLL_MINR_VCO    100000000&t;/* Min VCO rate (restricted) */
DECL|macro|STG4K3_PLL_MAX_VCO
mdefine_line|#define    STG4K3_PLL_MAX_VCO     500000000&t;/* Max VCO rate */
DECL|macro|STG4K3_PLL_MAXR_VCO
mdefine_line|#define    STG4K3_PLL_MAXR_VCO    500000000&t;/* Max VCO rate (restricted) */
DECL|macro|OS_DELAY
mdefine_line|#define OS_DELAY(X) &bslash;&n;{ &bslash;&n;volatile u32 i,count=0; &bslash;&n;    for(i=0;i&lt;X;i++) count++; &bslash;&n;}
DECL|function|InitSDRAMRegisters
r_static
id|u32
id|InitSDRAMRegisters
c_func
(paren
r_volatile
id|STG4000REG
id|__iomem
op_star
id|pSTGReg
comma
id|u32
id|dwSubSysID
comma
id|u32
id|dwRevID
)paren
(brace
id|u32
id|adwSDRAMArgCfg0
(braket
)braket
op_assign
(brace
l_int|0xa0
comma
l_int|0x80
comma
l_int|0xa0
comma
l_int|0xa0
comma
l_int|0xa0
)brace
suffix:semicolon
id|u32
id|adwSDRAMCfg1
(braket
)braket
op_assign
(brace
l_int|0x8732
comma
l_int|0x8732
comma
l_int|0xa732
comma
l_int|0xa732
comma
l_int|0x8732
)brace
suffix:semicolon
id|u32
id|adwSDRAMCfg2
(braket
)braket
op_assign
(brace
l_int|0x87d2
comma
l_int|0x87d2
comma
l_int|0xa7d2
comma
l_int|0x87d2
comma
l_int|0xa7d2
)brace
suffix:semicolon
id|u32
id|adwSDRAMRsh
(braket
)braket
op_assign
(brace
l_int|36
comma
l_int|39
comma
l_int|40
)brace
suffix:semicolon
id|u32
id|adwChipSpeed
(braket
)braket
op_assign
(brace
l_int|110
comma
l_int|120
comma
l_int|125
)brace
suffix:semicolon
id|u32
id|dwMemTypeIdx
suffix:semicolon
id|u32
id|dwChipSpeedIdx
suffix:semicolon
multiline_comment|/* Get memory tpye and chip speed indexs from the SubSysDevID */
id|dwMemTypeIdx
op_assign
(paren
id|dwSubSysID
op_amp
l_int|0x70
)paren
op_rshift
l_int|4
suffix:semicolon
id|dwChipSpeedIdx
op_assign
(paren
id|dwSubSysID
op_amp
l_int|0x180
)paren
op_rshift
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|dwMemTypeIdx
OG
l_int|4
op_logical_or
id|dwChipSpeedIdx
OG
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Program SD-RAM interface */
id|STG_WRITE_REG
c_func
(paren
id|SDRAMArbiterConf
comma
id|adwSDRAMArgCfg0
(braket
id|dwMemTypeIdx
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dwRevID
OL
l_int|5
)paren
(brace
id|STG_WRITE_REG
c_func
(paren
id|SDRAMConf0
comma
l_int|0x49A1
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|SDRAMConf1
comma
id|adwSDRAMCfg1
(braket
id|dwMemTypeIdx
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|STG_WRITE_REG
c_func
(paren
id|SDRAMConf0
comma
l_int|0x4DF1
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|SDRAMConf1
comma
id|adwSDRAMCfg2
(braket
id|dwMemTypeIdx
)braket
)paren
suffix:semicolon
)brace
id|STG_WRITE_REG
c_func
(paren
id|SDRAMConf2
comma
l_int|0x31
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|SDRAMRefresh
comma
id|adwSDRAMRsh
(braket
id|dwChipSpeedIdx
)braket
)paren
suffix:semicolon
r_return
id|adwChipSpeed
(braket
id|dwChipSpeedIdx
)braket
op_star
l_int|10000
suffix:semicolon
)brace
DECL|function|ProgramClock
id|u32
id|ProgramClock
c_func
(paren
id|u32
id|refClock
comma
id|u32
id|coreClock
comma
id|u32
op_star
id|FOut
comma
id|u32
op_star
id|ROut
comma
id|u32
op_star
id|POut
)paren
(brace
id|u32
id|R
op_assign
l_int|0
comma
id|F
op_assign
l_int|0
comma
id|OD
op_assign
l_int|0
comma
id|ODIndex
op_assign
l_int|0
suffix:semicolon
id|u32
id|ulBestR
op_assign
l_int|0
comma
id|ulBestF
op_assign
l_int|0
comma
id|ulBestOD
op_assign
l_int|0
suffix:semicolon
id|u32
id|ulBestVCO
op_assign
l_int|0
comma
id|ulBestClk
op_assign
l_int|0
comma
id|ulBestScore
op_assign
l_int|0
suffix:semicolon
id|u32
id|ulScore
comma
id|ulPhaseScore
comma
id|ulVcoScore
suffix:semicolon
id|u32
id|ulTmp
op_assign
l_int|0
comma
id|ulVCO
suffix:semicolon
id|u32
id|ulScaleClockReq
comma
id|ulMinClock
comma
id|ulMaxClock
suffix:semicolon
id|u32
id|ODValues
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* Translate clock in Hz */
id|coreClock
op_mul_assign
l_int|100
suffix:semicolon
multiline_comment|/* in Hz */
id|refClock
op_mul_assign
l_int|1000
suffix:semicolon
multiline_comment|/* in Hz */
multiline_comment|/* Work out acceptable clock&n;&t; * The method calculates ~ +- 0.4% (1/256)&n;&t; */
id|ulMinClock
op_assign
id|coreClock
op_minus
(paren
id|coreClock
op_rshift
l_int|8
)paren
suffix:semicolon
id|ulMaxClock
op_assign
id|coreClock
op_plus
(paren
id|coreClock
op_rshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Scale clock required for use in calculations */
id|ulScaleClockReq
op_assign
id|coreClock
op_rshift
id|STG4K3_PLL_SCALER
suffix:semicolon
multiline_comment|/* Iterate through post divider values */
r_for
c_loop
(paren
id|ODIndex
op_assign
l_int|0
suffix:semicolon
id|ODIndex
OL
l_int|3
suffix:semicolon
id|ODIndex
op_increment
)paren
(brace
id|OD
op_assign
id|ODValues
(braket
id|ODIndex
)braket
suffix:semicolon
id|R
op_assign
id|STG4K3_PLL_MIN_R
suffix:semicolon
multiline_comment|/* loop for pre-divider from min to max  */
r_while
c_loop
(paren
id|R
op_le
id|STG4K3_PLL_MAX_R
)paren
(brace
multiline_comment|/* estimate required feedback multiplier */
id|ulTmp
op_assign
id|R
op_star
(paren
id|ulScaleClockReq
op_lshift
id|OD
)paren
suffix:semicolon
multiline_comment|/* F = ClkRequired * R * (2^OD) / Fref */
id|F
op_assign
(paren
id|u32
)paren
(paren
id|ulTmp
op_div
(paren
id|refClock
op_rshift
id|STG4K3_PLL_SCALER
)paren
)paren
suffix:semicolon
multiline_comment|/* compensate for accuracy */
r_if
c_cond
(paren
id|F
OG
id|STG4K3_PLL_MIN_F
)paren
id|F
op_decrement
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * We should be close to our target frequency (if it&squot;s&n;&t;&t;&t; * achievable with current OD &amp; R) let&squot;s iterate&n;&t;&t;&t; * through F for best fit&n;&t;&t;&t; */
r_while
c_loop
(paren
(paren
id|F
op_ge
id|STG4K3_PLL_MIN_F
)paren
op_logical_and
(paren
id|F
op_le
id|STG4K3_PLL_MAX_F
)paren
)paren
(brace
multiline_comment|/* Calc VCO at full accuracy */
id|ulVCO
op_assign
id|refClock
op_div
id|R
suffix:semicolon
id|ulVCO
op_assign
id|F
op_star
id|ulVCO
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Check it&squot;s within restricted VCO range&n;&t;&t;&t;&t; * unless of course the desired frequency is&n;&t;&t;&t;&t; * above the restricted range, then test&n;&t;&t;&t;&t; * against VCO limit&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|ulVCO
op_ge
id|STG4K3_PLL_MINR_VCO
)paren
op_logical_and
(paren
(paren
id|ulVCO
op_le
id|STG4K3_PLL_MAXR_VCO
)paren
op_logical_or
(paren
(paren
id|coreClock
OG
id|STG4K3_PLL_MAXR_VCO
)paren
op_logical_and
(paren
id|ulVCO
op_le
id|STG4K3_PLL_MAX_VCO
)paren
)paren
)paren
)paren
(brace
id|ulTmp
op_assign
(paren
id|ulVCO
op_rshift
id|OD
)paren
suffix:semicolon
multiline_comment|/* Clock = VCO / (2^OD) */
multiline_comment|/* Is this clock good enough? */
r_if
c_cond
(paren
(paren
id|ulTmp
op_ge
id|ulMinClock
)paren
op_logical_and
(paren
id|ulTmp
op_le
id|ulMaxClock
)paren
)paren
(brace
id|ulPhaseScore
op_assign
(paren
(paren
(paren
id|refClock
op_div
id|R
)paren
op_minus
(paren
id|refClock
op_div
id|STG4K3_PLL_MAX_R
)paren
)paren
)paren
op_div
(paren
(paren
id|refClock
op_minus
(paren
id|refClock
op_div
id|STG4K3_PLL_MAX_R
)paren
)paren
op_rshift
l_int|10
)paren
suffix:semicolon
id|ulVcoScore
op_assign
(paren
(paren
id|ulVCO
op_minus
id|STG4K3_PLL_MINR_VCO
)paren
)paren
op_div
(paren
(paren
id|STG4K3_PLL_MAXR_VCO
op_minus
id|STG4K3_PLL_MINR_VCO
)paren
op_rshift
l_int|10
)paren
suffix:semicolon
id|ulScore
op_assign
id|ulPhaseScore
op_plus
id|ulVcoScore
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ulBestScore
)paren
(brace
id|ulBestVCO
op_assign
id|ulVCO
suffix:semicolon
id|ulBestOD
op_assign
id|OD
suffix:semicolon
id|ulBestF
op_assign
id|F
suffix:semicolon
id|ulBestR
op_assign
id|R
suffix:semicolon
id|ulBestClk
op_assign
id|ulTmp
suffix:semicolon
id|ulBestScore
op_assign
id|ulScore
suffix:semicolon
)brace
multiline_comment|/* is this better, ( aim for highest Score) */
multiline_comment|/*--------------------------------------------------------------------------&n;                             Here we want to use a scoring system which will take account of both the&n;                            value at the phase comparater and the VCO output&n;                             to do this we will use a cumulative score between the two&n;                          The way this ends up is that we choose the first value in the loop anyway&n;                          but we shall keep this code in case new restrictions come into play&n;                          --------------------------------------------------------------------------*/
r_if
c_cond
(paren
(paren
id|ulScore
op_ge
id|ulBestScore
)paren
op_logical_and
(paren
id|OD
OG
l_int|0
)paren
)paren
(brace
id|ulBestVCO
op_assign
id|ulVCO
suffix:semicolon
id|ulBestOD
op_assign
id|OD
suffix:semicolon
id|ulBestF
op_assign
id|F
suffix:semicolon
id|ulBestR
op_assign
id|R
suffix:semicolon
id|ulBestClk
op_assign
id|ulTmp
suffix:semicolon
id|ulBestScore
op_assign
id|ulScore
suffix:semicolon
)brace
)brace
)brace
id|F
op_increment
suffix:semicolon
)brace
id|R
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;   did we find anything?&n;&t;   Then return RFOD&n;&t; */
r_if
c_cond
(paren
id|ulBestScore
)paren
(brace
op_star
id|ROut
op_assign
id|ulBestR
suffix:semicolon
op_star
id|FOut
op_assign
id|ulBestF
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ulBestOD
op_eq
l_int|2
)paren
op_logical_or
(paren
id|ulBestOD
op_eq
l_int|3
)paren
)paren
(brace
op_star
id|POut
op_assign
l_int|3
suffix:semicolon
)brace
r_else
op_star
id|POut
op_assign
id|ulBestOD
suffix:semicolon
)brace
r_return
(paren
id|ulBestClk
)paren
suffix:semicolon
)brace
DECL|function|SetCoreClockPLL
r_int
id|SetCoreClockPLL
c_func
(paren
r_volatile
id|STG4000REG
id|__iomem
op_star
id|pSTGReg
comma
r_struct
id|pci_dev
op_star
id|pDev
)paren
(brace
id|u32
id|F
comma
id|R
comma
id|P
suffix:semicolon
id|u16
id|core_pll
op_assign
l_int|0
comma
id|sub
suffix:semicolon
id|u32
id|ulCoreClock
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|u32
id|ulChipSpeed
suffix:semicolon
id|u8
id|rev
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|IntMask
comma
l_int|0xFFFF
)paren
suffix:semicolon
multiline_comment|/* Disable Primary Core Thread0 */
id|tmp
op_assign
id|STG_READ_REG
c_func
(paren
id|Thread0Enable
)paren
suffix:semicolon
id|CLEAR_BIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|Thread0Enable
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Disable Primary Core Thread1 */
id|tmp
op_assign
id|STG_READ_REG
c_func
(paren
id|Thread1Enable
)paren
suffix:semicolon
id|CLEAR_BIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|Thread1Enable
comma
id|tmp
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|SoftwareReset
comma
id|PMX2_SOFTRESET_REG_RST
op_or
id|PMX2_SOFTRESET_ROM_RST
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|SoftwareReset
comma
id|PMX2_SOFTRESET_REG_RST
op_or
id|PMX2_SOFTRESET_TA_RST
op_or
id|PMX2_SOFTRESET_ROM_RST
)paren
suffix:semicolon
multiline_comment|/* Need to play around to reset TA */
id|STG_WRITE_REG
c_func
(paren
id|TAConfiguration
comma
l_int|0
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|SoftwareReset
comma
id|PMX2_SOFTRESET_REG_RST
op_or
id|PMX2_SOFTRESET_ROM_RST
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|SoftwareReset
comma
id|PMX2_SOFTRESET_REG_RST
op_or
id|PMX2_SOFTRESET_TA_RST
op_or
id|PMX2_SOFTRESET_ROM_RST
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pDev
comma
id|PCI_CONFIG_SUBSYS_ID
comma
op_amp
id|sub
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pDev
comma
id|PCI_REVISION_ID
comma
op_amp
id|rev
)paren
suffix:semicolon
id|ulChipSpeed
op_assign
id|InitSDRAMRegisters
c_func
(paren
id|pSTGReg
comma
(paren
id|u32
)paren
id|sub
comma
(paren
id|u32
)paren
id|rev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ulChipSpeed
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ulCoreClock
op_assign
id|ProgramClock
c_func
(paren
id|REF_FREQ
comma
id|CORE_PLL_FREQ
comma
op_amp
id|F
comma
op_amp
id|R
comma
op_amp
id|P
)paren
suffix:semicolon
id|core_pll
op_or_assign
(paren
(paren
id|P
)paren
op_or
(paren
(paren
id|F
op_minus
l_int|2
)paren
op_lshift
l_int|2
)paren
op_or
(paren
(paren
id|R
op_minus
l_int|2
)paren
op_lshift
l_int|11
)paren
)paren
suffix:semicolon
multiline_comment|/* Set Core PLL Control to Core PLL Mode  */
multiline_comment|/* Send bits 0:7 of the Core PLL Mode register */
id|tmp
op_assign
(paren
(paren
id|CORE_PLL_MODE_REG_0_7
op_lshift
l_int|8
)paren
op_or
(paren
id|core_pll
op_amp
l_int|0x00FF
)paren
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pDev
comma
id|CorePllControl
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Without some delay between the PCI config writes the clock does&n;&t;   not reliably set when the code is compiled -O3&n;&t; */
id|OS_DELAY
c_func
(paren
l_int|1000000
)paren
suffix:semicolon
id|tmp
op_or_assign
id|SET_BIT
c_func
(paren
l_int|14
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pDev
comma
id|CorePllControl
comma
id|tmp
)paren
suffix:semicolon
id|OS_DELAY
c_func
(paren
l_int|1000000
)paren
suffix:semicolon
multiline_comment|/* Send bits 8:15 of the Core PLL Mode register */
id|tmp
op_assign
(paren
(paren
id|CORE_PLL_MODE_REG_8_15
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|core_pll
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pDev
comma
id|CorePllControl
comma
id|tmp
)paren
suffix:semicolon
id|OS_DELAY
c_func
(paren
l_int|1000000
)paren
suffix:semicolon
id|tmp
op_or_assign
id|SET_BIT
c_func
(paren
l_int|14
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pDev
comma
id|CorePllControl
comma
id|tmp
)paren
suffix:semicolon
id|OS_DELAY
c_func
(paren
l_int|1000000
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|SoftwareReset
comma
id|PMX2_SOFTRESET_ALL
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Enable Primary Core Thread0 */
id|tmp
op_assign
(paren
(paren
id|STG_READ_REG
c_func
(paren
id|Thread0Enable
)paren
)paren
op_or
id|SET_BIT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|Thread0Enable
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Enable Primary Core Thread1 */
id|tmp
op_assign
(paren
(paren
id|STG_READ_REG
c_func
(paren
id|Thread1Enable
)paren
)paren
op_or
id|SET_BIT
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|STG_WRITE_REG
c_func
(paren
id|Thread1Enable
comma
id|tmp
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
eof
