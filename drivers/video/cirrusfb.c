multiline_comment|/*&n; * drivers/video/cirrusfb.c - driver for Cirrus Logic chipsets&n; *&n; * Copyright 1999-2001 Jeff Garzik &lt;jgarzik@pobox.com&gt;&n; *&n; * Contributors (thanks, all!)&n; *&n; *&t;David Eger:&n; *&t;Overhaul for Linux 2.6&n; *&n; *      Jeff Rugen:&n; *      Major contributions;  Motorola PowerStack (PPC and PCI) support,&n; *      GD54xx, 1280x1024 mode support, change MCLK based on VCLK.&n; *&n; *&t;Geert Uytterhoeven:&n; *&t;Excellent code review.&n; *&n; *&t;Lars Hecking:&n; *&t;Amiga updates and testing.&n; *&n; * Original cirrusfb author:  Frank Neumann&n; *&n; * Based on retz3fb.c and cirrusfb.c:&n; *      Copyright (C) 1997 Jes Sorensen&n; *      Copyright (C) 1996 Frank Neumann&n; *&n; ***************************************************************&n; *&n; * Format this code with GNU indent &squot;-kr -i8 -pcs&squot; options.&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; *&n; */
DECL|macro|CIRRUSFB_VERSION
mdefine_line|#define CIRRUSFB_VERSION &quot;2.0-pre2&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#ifdef CONFIG_ZORRO
macro_line|#include &lt;linux/zorro.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_PCI
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_AMIGA
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_PPC_PREP
macro_line|#include &lt;asm/processor.h&gt;
DECL|macro|isPReP
mdefine_line|#define isPReP (_machine == _MACH_prep)
macro_line|#else
DECL|macro|isPReP
mdefine_line|#define isPReP 0
macro_line|#endif
macro_line|#include &quot;video/vga.h&quot;
macro_line|#include &quot;video/cirrus.h&quot;
multiline_comment|/*****************************************************************&n; *&n; * debugging and utility macros&n; *&n; */
multiline_comment|/* enable debug output? */
multiline_comment|/* #define CIRRUSFB_DEBUG 1 */
multiline_comment|/* disable runtime assertions? */
multiline_comment|/* #define CIRRUSFB_NDEBUG */
multiline_comment|/* debug output */
macro_line|#ifdef CIRRUSFB_DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...) printk(KERN_DEBUG &quot;%s: &quot; fmt, __FUNCTION__ , ## args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...)
macro_line|#endif
multiline_comment|/* debugging assertions */
macro_line|#ifndef CIRRUSFB_NDEBUG
DECL|macro|assert
mdefine_line|#define assert(expr) &bslash;&n;        if(!(expr)) { &bslash;&n;        printk( &quot;Assertion failed! %s,%s,%s,line=%d&bslash;n&quot;,&bslash;&n;        #expr,__FILE__,__FUNCTION__,__LINE__); &bslash;&n;        }
macro_line|#else
DECL|macro|assert
mdefine_line|#define assert(expr)
macro_line|#endif
macro_line|#ifdef TRUE
DECL|macro|TRUE
macro_line|#undef TRUE
macro_line|#endif
macro_line|#ifdef FALSE
DECL|macro|FALSE
macro_line|#undef FALSE
macro_line|#endif
DECL|macro|TRUE
mdefine_line|#define TRUE  1
DECL|macro|FALSE
mdefine_line|#define FALSE 0
DECL|macro|MB_
mdefine_line|#define MB_ (1024*1024)
DECL|macro|KB_
mdefine_line|#define KB_ (1024)
DECL|macro|MAX_NUM_BOARDS
mdefine_line|#define MAX_NUM_BOARDS 7
multiline_comment|/*****************************************************************&n; *&n; * chipset information&n; *&n; */
multiline_comment|/* board types */
r_typedef
r_enum
(brace
DECL|enumerator|BT_NONE
id|BT_NONE
op_assign
l_int|0
comma
DECL|enumerator|BT_SD64
id|BT_SD64
comma
DECL|enumerator|BT_PICCOLO
id|BT_PICCOLO
comma
DECL|enumerator|BT_PICASSO
id|BT_PICASSO
comma
DECL|enumerator|BT_SPECTRUM
id|BT_SPECTRUM
comma
DECL|enumerator|BT_PICASSO4
id|BT_PICASSO4
comma
multiline_comment|/* GD5446 */
DECL|enumerator|BT_ALPINE
id|BT_ALPINE
comma
multiline_comment|/* GD543x/4x */
DECL|enumerator|BT_GD5480
id|BT_GD5480
comma
DECL|enumerator|BT_LAGUNA
id|BT_LAGUNA
comma
multiline_comment|/* GD546x */
DECL|typedef|cirrusfb_board_t
)brace
id|cirrusfb_board_t
suffix:semicolon
multiline_comment|/*&n; * per-board-type information, used for enumerating and abstracting&n; * chip-specific information&n; * NOTE: MUST be in the same order as cirrusfb_board_t in order to&n; * use direct indexing on this array&n; * NOTE: &squot;__initdata&squot; cannot be used as some of this info&n; * is required at runtime.  Maybe separate into an init-only and&n; * a run-time table?&n; */
DECL|struct|cirrusfb_board_info_rec
r_static
r_const
r_struct
id|cirrusfb_board_info_rec
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
multiline_comment|/* ASCII name of chipset */
DECL|member|maxclock
r_int
id|maxclock
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* maximum video clock */
multiline_comment|/* for  1/4bpp, 8bpp 15/16bpp, 24bpp, 32bpp - numbers from xorg code */
DECL|member|init_sr07
r_int
id|init_sr07
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* init SR07 during init_vgachip() */
DECL|member|init_sr1f
r_int
id|init_sr1f
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* write SR1F during init_vgachip() */
DECL|member|scrn_start_bit19
r_int
id|scrn_start_bit19
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* construct bit 19 of screen start address */
multiline_comment|/* initial SR07 value, then for each mode */
DECL|member|sr07
r_int
r_char
id|sr07
suffix:semicolon
DECL|member|sr07_1bpp
r_int
r_char
id|sr07_1bpp
suffix:semicolon
DECL|member|sr07_1bpp_mux
r_int
r_char
id|sr07_1bpp_mux
suffix:semicolon
DECL|member|sr07_8bpp
r_int
r_char
id|sr07_8bpp
suffix:semicolon
DECL|member|sr07_8bpp_mux
r_int
r_char
id|sr07_8bpp_mux
suffix:semicolon
DECL|member|sr1f
r_int
r_char
id|sr1f
suffix:semicolon
multiline_comment|/* SR1F VGA initial register value */
DECL|variable|cirrusfb_board_info
)brace
id|cirrusfb_board_info
(braket
)braket
op_assign
(brace
(braket
id|BT_SD64
)braket
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;CL SD64&quot;
comma
dot
id|maxclock
op_assign
(brace
multiline_comment|/* guess */
multiline_comment|/* the SD64/P4 have a higher max. videoclock */
l_int|140000
comma
l_int|140000
comma
l_int|140000
comma
l_int|140000
comma
l_int|140000
comma
)brace
comma
dot
id|init_sr07
op_assign
id|TRUE
comma
dot
id|init_sr1f
op_assign
id|TRUE
comma
dot
id|scrn_start_bit19
op_assign
id|TRUE
comma
dot
id|sr07
op_assign
l_int|0xF0
comma
dot
id|sr07_1bpp
op_assign
l_int|0xF0
comma
dot
id|sr07_8bpp
op_assign
l_int|0xF1
comma
dot
id|sr1f
op_assign
l_int|0x20
)brace
comma
(braket
id|BT_PICCOLO
)braket
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;CL Piccolo&quot;
comma
dot
id|maxclock
op_assign
(brace
multiline_comment|/* guess */
l_int|90000
comma
l_int|90000
comma
l_int|90000
comma
l_int|90000
comma
l_int|90000
)brace
comma
dot
id|init_sr07
op_assign
id|TRUE
comma
dot
id|init_sr1f
op_assign
id|TRUE
comma
dot
id|scrn_start_bit19
op_assign
id|FALSE
comma
dot
id|sr07
op_assign
l_int|0x80
comma
dot
id|sr07_1bpp
op_assign
l_int|0x80
comma
dot
id|sr07_8bpp
op_assign
l_int|0x81
comma
dot
id|sr1f
op_assign
l_int|0x22
)brace
comma
(braket
id|BT_PICASSO
)braket
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;CL Picasso&quot;
comma
dot
id|maxclock
op_assign
(brace
multiline_comment|/* guess */
l_int|90000
comma
l_int|90000
comma
l_int|90000
comma
l_int|90000
comma
l_int|90000
)brace
comma
dot
id|init_sr07
op_assign
id|TRUE
comma
dot
id|init_sr1f
op_assign
id|TRUE
comma
dot
id|scrn_start_bit19
op_assign
id|FALSE
comma
dot
id|sr07
op_assign
l_int|0x20
comma
dot
id|sr07_1bpp
op_assign
l_int|0x20
comma
dot
id|sr07_8bpp
op_assign
l_int|0x21
comma
dot
id|sr1f
op_assign
l_int|0x22
)brace
comma
(braket
id|BT_SPECTRUM
)braket
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;CL Spectrum&quot;
comma
dot
id|maxclock
op_assign
(brace
multiline_comment|/* guess */
l_int|90000
comma
l_int|90000
comma
l_int|90000
comma
l_int|90000
comma
l_int|90000
)brace
comma
dot
id|init_sr07
op_assign
id|TRUE
comma
dot
id|init_sr1f
op_assign
id|TRUE
comma
dot
id|scrn_start_bit19
op_assign
id|FALSE
comma
dot
id|sr07
op_assign
l_int|0x80
comma
dot
id|sr07_1bpp
op_assign
l_int|0x80
comma
dot
id|sr07_8bpp
op_assign
l_int|0x81
comma
dot
id|sr1f
op_assign
l_int|0x22
)brace
comma
(braket
id|BT_PICASSO4
)braket
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;CL Picasso4&quot;
comma
dot
id|maxclock
op_assign
(brace
l_int|135100
comma
l_int|135100
comma
l_int|85500
comma
l_int|85500
comma
l_int|0
)brace
comma
dot
id|init_sr07
op_assign
id|TRUE
comma
dot
id|init_sr1f
op_assign
id|FALSE
comma
dot
id|scrn_start_bit19
op_assign
id|TRUE
comma
dot
id|sr07
op_assign
l_int|0x20
comma
dot
id|sr07_1bpp
op_assign
l_int|0x20
comma
dot
id|sr07_8bpp
op_assign
l_int|0x21
comma
dot
id|sr1f
op_assign
l_int|0
)brace
comma
(braket
id|BT_ALPINE
)braket
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;CL Alpine&quot;
comma
dot
id|maxclock
op_assign
(brace
multiline_comment|/* for the GD5430.  GD5446 can do more... */
l_int|85500
comma
l_int|85500
comma
l_int|50000
comma
l_int|28500
comma
l_int|0
)brace
comma
dot
id|init_sr07
op_assign
id|TRUE
comma
dot
id|init_sr1f
op_assign
id|TRUE
comma
dot
id|scrn_start_bit19
op_assign
id|TRUE
comma
dot
id|sr07
op_assign
l_int|0xA0
comma
dot
id|sr07_1bpp
op_assign
l_int|0xA1
comma
dot
id|sr07_1bpp_mux
op_assign
l_int|0xA7
comma
dot
id|sr07_8bpp
op_assign
l_int|0xA1
comma
dot
id|sr07_8bpp_mux
op_assign
l_int|0xA7
comma
dot
id|sr1f
op_assign
l_int|0x1C
)brace
comma
(braket
id|BT_GD5480
)braket
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;CL GD5480&quot;
comma
dot
id|maxclock
op_assign
(brace
l_int|135100
comma
l_int|200000
comma
l_int|200000
comma
l_int|135100
comma
l_int|135100
)brace
comma
dot
id|init_sr07
op_assign
id|TRUE
comma
dot
id|init_sr1f
op_assign
id|TRUE
comma
dot
id|scrn_start_bit19
op_assign
id|TRUE
comma
dot
id|sr07
op_assign
l_int|0x10
comma
dot
id|sr07_1bpp
op_assign
l_int|0x11
comma
dot
id|sr07_8bpp
op_assign
l_int|0x11
comma
dot
id|sr1f
op_assign
l_int|0x1C
)brace
comma
(braket
id|BT_LAGUNA
)braket
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;CL Laguna&quot;
comma
dot
id|maxclock
op_assign
(brace
multiline_comment|/* guess */
l_int|135100
comma
l_int|135100
comma
l_int|135100
comma
l_int|135100
comma
l_int|135100
comma
)brace
comma
dot
id|init_sr07
op_assign
id|FALSE
comma
dot
id|init_sr1f
op_assign
id|FALSE
comma
dot
id|scrn_start_bit19
op_assign
id|TRUE
comma
)brace
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PCI
DECL|macro|CHIP
mdefine_line|#define CHIP(id, btype) &bslash;&n;&t;{ PCI_VENDOR_ID_CIRRUS, PCI_DEVICE_ID_##id, PCI_ANY_ID, PCI_ANY_ID, 0, 0, (btype) }
DECL|variable|cirrusfb_pci_table
r_static
r_struct
id|pci_device_id
id|cirrusfb_pci_table
(braket
)braket
op_assign
(brace
id|CHIP
c_func
(paren
id|CIRRUS_5436
comma
id|BT_ALPINE
)paren
comma
id|CHIP
c_func
(paren
id|CIRRUS_5434_8
comma
id|BT_ALPINE
)paren
comma
id|CHIP
c_func
(paren
id|CIRRUS_5434_4
comma
id|BT_ALPINE
)paren
comma
id|CHIP
c_func
(paren
id|CIRRUS_5430
comma
id|BT_ALPINE
)paren
comma
multiline_comment|/* GD-5440 has identical id */
id|CHIP
c_func
(paren
id|CIRRUS_7543
comma
id|BT_ALPINE
)paren
comma
id|CHIP
c_func
(paren
id|CIRRUS_7548
comma
id|BT_ALPINE
)paren
comma
id|CHIP
c_func
(paren
id|CIRRUS_5480
comma
id|BT_GD5480
)paren
comma
multiline_comment|/* MacPicasso probably */
id|CHIP
c_func
(paren
id|CIRRUS_5446
comma
id|BT_PICASSO4
)paren
comma
multiline_comment|/* Picasso 4 is a GD5446 */
id|CHIP
c_func
(paren
id|CIRRUS_5462
comma
id|BT_LAGUNA
)paren
comma
multiline_comment|/* CL Laguna */
id|CHIP
c_func
(paren
id|CIRRUS_5464
comma
id|BT_LAGUNA
)paren
comma
multiline_comment|/* CL Laguna 3D */
id|CHIP
c_func
(paren
id|CIRRUS_5465
comma
id|BT_LAGUNA
)paren
comma
multiline_comment|/* CL Laguna 3DA*/
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|cirrusfb_pci_table
)paren
suffix:semicolon
DECL|macro|CHIP
macro_line|#undef CHIP
macro_line|#endif /* CONFIG_PCI */
macro_line|#ifdef CONFIG_ZORRO
DECL|variable|cirrusfb_zorro_table
r_static
r_const
r_struct
id|zorro_device_id
id|cirrusfb_zorro_table
(braket
)braket
op_assign
(brace
(brace
dot
id|id
op_assign
id|ZORRO_PROD_HELFRICH_SD64_RAM
comma
dot
id|driver_data
op_assign
id|BT_SD64
comma
)brace
comma
(brace
dot
id|id
op_assign
id|ZORRO_PROD_HELFRICH_PICCOLO_RAM
comma
dot
id|driver_data
op_assign
id|BT_PICCOLO
comma
)brace
comma
(brace
dot
id|id
op_assign
id|ZORRO_PROD_VILLAGE_TRONIC_PICASSO_II_II_PLUS_RAM
comma
dot
id|driver_data
op_assign
id|BT_PICASSO
comma
)brace
comma
(brace
dot
id|id
op_assign
id|ZORRO_PROD_GVP_EGS_28_24_SPECTRUM_RAM
comma
dot
id|driver_data
op_assign
id|BT_SPECTRUM
comma
)brace
comma
(brace
dot
id|id
op_assign
id|ZORRO_PROD_VILLAGE_TRONIC_PICASSO_IV_Z3
comma
dot
id|driver_data
op_assign
id|BT_PICASSO4
comma
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
r_static
r_const
r_struct
(brace
DECL|member|id2
id|zorro_id
id|id2
suffix:semicolon
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
DECL|variable|cirrusfb_zorro_table2
)brace
id|cirrusfb_zorro_table2
(braket
)braket
op_assign
(brace
(braket
id|BT_SD64
)braket
op_assign
(brace
dot
id|id2
op_assign
id|ZORRO_PROD_HELFRICH_SD64_REG
comma
dot
id|size
op_assign
l_int|0x400000
)brace
comma
(braket
id|BT_PICCOLO
)braket
op_assign
(brace
dot
id|id2
op_assign
id|ZORRO_PROD_HELFRICH_PICCOLO_REG
comma
dot
id|size
op_assign
l_int|0x200000
)brace
comma
(braket
id|BT_PICASSO
)braket
op_assign
(brace
dot
id|id2
op_assign
id|ZORRO_PROD_VILLAGE_TRONIC_PICASSO_II_II_PLUS_REG
comma
dot
id|size
op_assign
l_int|0x200000
)brace
comma
(braket
id|BT_SPECTRUM
)braket
op_assign
(brace
dot
id|id2
op_assign
id|ZORRO_PROD_GVP_EGS_28_24_SPECTRUM_REG
comma
dot
id|size
op_assign
l_int|0x200000
)brace
comma
(braket
id|BT_PICASSO4
)braket
op_assign
(brace
dot
id|id2
op_assign
l_int|0
comma
dot
id|size
op_assign
l_int|0x400000
)brace
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_ZORRO */
DECL|struct|cirrusfb_regs
r_struct
id|cirrusfb_regs
(brace
DECL|member|line_length
id|__u32
id|line_length
suffix:semicolon
multiline_comment|/* in BYTES! */
DECL|member|visual
id|__u32
id|visual
suffix:semicolon
DECL|member|type
id|__u32
id|type
suffix:semicolon
DECL|member|freq
r_int
id|freq
suffix:semicolon
DECL|member|nom
r_int
id|nom
suffix:semicolon
DECL|member|den
r_int
id|den
suffix:semicolon
DECL|member|div
r_int
id|div
suffix:semicolon
DECL|member|multiplexing
r_int
id|multiplexing
suffix:semicolon
DECL|member|mclk
r_int
id|mclk
suffix:semicolon
DECL|member|divMCLK
r_int
id|divMCLK
suffix:semicolon
DECL|member|HorizRes
r_int
id|HorizRes
suffix:semicolon
multiline_comment|/* The x resolution in pixel */
DECL|member|HorizTotal
r_int
id|HorizTotal
suffix:semicolon
DECL|member|HorizDispEnd
r_int
id|HorizDispEnd
suffix:semicolon
DECL|member|HorizBlankStart
r_int
id|HorizBlankStart
suffix:semicolon
DECL|member|HorizBlankEnd
r_int
id|HorizBlankEnd
suffix:semicolon
DECL|member|HorizSyncStart
r_int
id|HorizSyncStart
suffix:semicolon
DECL|member|HorizSyncEnd
r_int
id|HorizSyncEnd
suffix:semicolon
DECL|member|VertRes
r_int
id|VertRes
suffix:semicolon
multiline_comment|/* the physical y resolution in scanlines */
DECL|member|VertTotal
r_int
id|VertTotal
suffix:semicolon
DECL|member|VertDispEnd
r_int
id|VertDispEnd
suffix:semicolon
DECL|member|VertSyncStart
r_int
id|VertSyncStart
suffix:semicolon
DECL|member|VertSyncEnd
r_int
id|VertSyncEnd
suffix:semicolon
DECL|member|VertBlankStart
r_int
id|VertBlankStart
suffix:semicolon
DECL|member|VertBlankEnd
r_int
id|VertBlankEnd
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef CIRRUSFB_DEBUG
r_typedef
r_enum
(brace
DECL|enumerator|CRT
id|CRT
comma
DECL|enumerator|SEQ
id|SEQ
DECL|typedef|cirrusfb_dbg_reg_class_t
)brace
id|cirrusfb_dbg_reg_class_t
suffix:semicolon
macro_line|#endif                          /* CIRRUSFB_DEBUG */
multiline_comment|/* info about board */
DECL|struct|cirrusfb_info
r_struct
id|cirrusfb_info
(brace
DECL|member|info
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
DECL|member|fbmem
id|u8
id|__iomem
op_star
id|fbmem
suffix:semicolon
DECL|member|regbase
id|u8
id|__iomem
op_star
id|regbase
suffix:semicolon
DECL|member|mem
id|u8
id|__iomem
op_star
id|mem
suffix:semicolon
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
DECL|member|btype
id|cirrusfb_board_t
id|btype
suffix:semicolon
DECL|member|SFR
r_int
r_char
id|SFR
suffix:semicolon
multiline_comment|/* Shadow of special function register */
DECL|member|fbmem_phys
r_int
r_int
id|fbmem_phys
suffix:semicolon
DECL|member|fbregs_phys
r_int
r_int
id|fbregs_phys
suffix:semicolon
DECL|member|currentmode
r_struct
id|cirrusfb_regs
id|currentmode
suffix:semicolon
DECL|member|blank_mode
r_int
id|blank_mode
suffix:semicolon
DECL|member|pseudo_palette
id|u32
id|pseudo_palette
(braket
l_int|17
)braket
suffix:semicolon
DECL|member|red
DECL|member|green
DECL|member|blue
DECL|member|pad
DECL|member|palette
r_struct
(brace
id|u8
id|red
comma
id|green
comma
id|blue
comma
id|pad
suffix:semicolon
)brace
id|palette
(braket
l_int|256
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_ZORRO
DECL|member|zdev
r_struct
id|zorro_dev
op_star
id|zdev
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PCI
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
macro_line|#endif
DECL|member|unmap
r_void
(paren
op_star
id|unmap
)paren
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|cirrusfb_def_mode
r_static
r_int
id|cirrusfb_def_mode
op_assign
l_int|1
suffix:semicolon
DECL|variable|noaccel
r_static
r_int
id|noaccel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; *    Predefined Video Modes&n; */
r_static
r_const
r_struct
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|var
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
DECL|variable|cirrusfb_predefined
)brace
id|cirrusfb_predefined
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* autodetect mode */
dot
id|name
op_assign
l_string|&quot;Autodetect&quot;
comma
)brace
comma
(brace
multiline_comment|/* 640x480, 31.25 kHz, 60 Hz, 25 MHz PixClock */
dot
id|name
op_assign
l_string|&quot;640x480&quot;
comma
dot
id|var
op_assign
(brace
dot
id|xres
op_assign
l_int|640
comma
dot
id|yres
op_assign
l_int|480
comma
dot
id|xres_virtual
op_assign
l_int|640
comma
dot
id|yres_virtual
op_assign
l_int|480
comma
dot
id|bits_per_pixel
op_assign
l_int|8
comma
dot
id|red
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|green
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|blue
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|pixclock
op_assign
l_int|40000
comma
dot
id|left_margin
op_assign
l_int|48
comma
dot
id|right_margin
op_assign
l_int|16
comma
dot
id|upper_margin
op_assign
l_int|32
comma
dot
id|lower_margin
op_assign
l_int|8
comma
dot
id|hsync_len
op_assign
l_int|96
comma
dot
id|vsync_len
op_assign
l_int|4
comma
dot
id|sync
op_assign
id|FB_SYNC_HOR_HIGH_ACT
op_or
id|FB_SYNC_VERT_HIGH_ACT
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
)brace
)brace
comma
(brace
multiline_comment|/* 800x600, 48 kHz, 76 Hz, 50 MHz PixClock */
dot
id|name
op_assign
l_string|&quot;800x600&quot;
comma
dot
id|var
op_assign
(brace
dot
id|xres
op_assign
l_int|800
comma
dot
id|yres
op_assign
l_int|600
comma
dot
id|xres_virtual
op_assign
l_int|800
comma
dot
id|yres_virtual
op_assign
l_int|600
comma
dot
id|bits_per_pixel
op_assign
l_int|8
comma
dot
id|red
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|green
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|blue
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|pixclock
op_assign
l_int|20000
comma
dot
id|left_margin
op_assign
l_int|128
comma
dot
id|right_margin
op_assign
l_int|16
comma
dot
id|upper_margin
op_assign
l_int|24
comma
dot
id|lower_margin
op_assign
l_int|2
comma
dot
id|hsync_len
op_assign
l_int|96
comma
dot
id|vsync_len
op_assign
l_int|6
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
)brace
)brace
comma
(brace
multiline_comment|/*&n;&t;&t; * Modeline from XF86Config:&n;&t;&t; * Mode &quot;1024x768&quot; 80  1024 1136 1340 1432  768 770 774 805&n;&t;&t; */
multiline_comment|/* 1024x768, 55.8 kHz, 70 Hz, 80 MHz PixClock */
dot
id|name
op_assign
l_string|&quot;1024x768&quot;
comma
dot
id|var
op_assign
(brace
dot
id|xres
op_assign
l_int|1024
comma
dot
id|yres
op_assign
l_int|768
comma
dot
id|xres_virtual
op_assign
l_int|1024
comma
dot
id|yres_virtual
op_assign
l_int|768
comma
dot
id|bits_per_pixel
op_assign
l_int|8
comma
dot
id|red
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|green
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|blue
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|pixclock
op_assign
l_int|12500
comma
dot
id|left_margin
op_assign
l_int|144
comma
dot
id|right_margin
op_assign
l_int|32
comma
dot
id|upper_margin
op_assign
l_int|30
comma
dot
id|lower_margin
op_assign
l_int|2
comma
dot
id|hsync_len
op_assign
l_int|192
comma
dot
id|vsync_len
op_assign
l_int|6
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
)brace
)brace
)brace
suffix:semicolon
DECL|macro|NUM_TOTAL_MODES
mdefine_line|#define NUM_TOTAL_MODES    ARRAY_SIZE(cirrusfb_predefined)
multiline_comment|/****************************************************************************/
multiline_comment|/**** BEGIN PROTOTYPES ******************************************************/
multiline_comment|/*--- Interface used by the world ------------------------------------------*/
r_int
id|cirrusfb_init
(paren
r_void
)paren
suffix:semicolon
r_int
id|cirrusfb_setup
(paren
r_char
op_star
id|options
)paren
suffix:semicolon
r_int
id|cirrusfb_open
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
suffix:semicolon
r_int
id|cirrusfb_release
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
suffix:semicolon
r_int
id|cirrusfb_setcolreg
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_int
id|cirrusfb_check_var
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_int
id|cirrusfb_set_par
(paren
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_int
id|cirrusfb_pan_display
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_int
id|cirrusfb_blank
(paren
r_int
id|blank_mode
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_void
id|cirrusfb_fillrect
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_fillrect
op_star
id|region
)paren
suffix:semicolon
r_void
id|cirrusfb_copyarea
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_copyarea
op_star
id|area
)paren
suffix:semicolon
r_void
id|cirrusfb_imageblit
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_image
op_star
id|image
)paren
suffix:semicolon
multiline_comment|/* function table of the above functions */
DECL|variable|cirrusfb_ops
r_static
r_struct
id|fb_ops
id|cirrusfb_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|fb_open
op_assign
id|cirrusfb_open
comma
dot
id|fb_release
op_assign
id|cirrusfb_release
comma
dot
id|fb_setcolreg
op_assign
id|cirrusfb_setcolreg
comma
dot
id|fb_check_var
op_assign
id|cirrusfb_check_var
comma
dot
id|fb_set_par
op_assign
id|cirrusfb_set_par
comma
dot
id|fb_pan_display
op_assign
id|cirrusfb_pan_display
comma
dot
id|fb_blank
op_assign
id|cirrusfb_blank
comma
dot
id|fb_fillrect
op_assign
id|cirrusfb_fillrect
comma
dot
id|fb_copyarea
op_assign
id|cirrusfb_copyarea
comma
dot
id|fb_imageblit
op_assign
id|cirrusfb_imageblit
comma
dot
id|fb_cursor
op_assign
id|soft_cursor
comma
)brace
suffix:semicolon
multiline_comment|/*--- Hardware Specific Routines -------------------------------------------*/
r_static
r_int
id|cirrusfb_decode_var
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|cirrusfb_regs
op_star
id|regs
comma
r_const
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/*--- Internal routines ----------------------------------------------------*/
r_static
r_void
id|init_vgachip
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
)paren
suffix:semicolon
r_static
r_void
id|switch_monitor
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
id|on
)paren
suffix:semicolon
r_static
r_void
id|WGen
(paren
r_const
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
id|regnum
comma
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_int
r_char
id|RGen
(paren
r_const
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
id|regnum
)paren
suffix:semicolon
r_static
r_void
id|AttrOn
(paren
r_const
r_struct
id|cirrusfb_info
op_star
id|cinfo
)paren
suffix:semicolon
r_static
r_void
id|WHDR
(paren
r_const
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_void
id|WSFR
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_void
id|WSFR2
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_void
id|WClut
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
r_char
id|regnum
comma
r_int
r_char
id|red
comma
r_int
r_char
id|green
comma
r_int
r_char
id|blue
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_void
id|RClut
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
r_char
id|regnum
comma
r_int
r_char
op_star
id|red
comma
r_int
r_char
op_star
id|green
comma
r_int
r_char
op_star
id|blue
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|cirrusfb_WaitBLT
(paren
id|u8
id|__iomem
op_star
id|regbase
)paren
suffix:semicolon
r_static
r_void
id|cirrusfb_BitBLT
(paren
id|u8
id|__iomem
op_star
id|regbase
comma
r_int
id|bits_per_pixel
comma
id|u_short
id|curx
comma
id|u_short
id|cury
comma
id|u_short
id|destx
comma
id|u_short
id|desty
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_short
id|line_length
)paren
suffix:semicolon
r_static
r_void
id|cirrusfb_RectFill
(paren
id|u8
id|__iomem
op_star
id|regbase
comma
r_int
id|bits_per_pixel
comma
id|u_short
id|x
comma
id|u_short
id|y
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_char
id|color
comma
id|u_short
id|line_length
)paren
suffix:semicolon
r_static
r_void
id|bestclock
(paren
r_int
id|freq
comma
r_int
op_star
id|best
comma
r_int
op_star
id|nom
comma
r_int
op_star
id|den
comma
r_int
op_star
id|div
comma
r_int
id|maxfreq
)paren
suffix:semicolon
macro_line|#ifdef CIRRUSFB_DEBUG
r_static
r_void
id|cirrusfb_dump
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|cirrusfb_dbg_reg_dump
(paren
id|caddr_t
id|regbase
)paren
suffix:semicolon
r_static
r_void
id|cirrusfb_dbg_print_regs
(paren
id|caddr_t
id|regbase
comma
id|cirrusfb_dbg_reg_class_t
id|reg_class
comma
dot
dot
dot
)paren
suffix:semicolon
r_static
r_void
id|cirrusfb_dbg_print_byte
(paren
r_const
r_char
op_star
id|name
comma
r_int
r_char
id|val
)paren
suffix:semicolon
macro_line|#endif /* CIRRUSFB_DEBUG */
multiline_comment|/*** END   PROTOTYPES ********************************************************/
multiline_comment|/*****************************************************************************/
multiline_comment|/*** BEGIN Interface Used by the World ***************************************/
DECL|variable|opencount
r_static
r_int
id|opencount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*--- Open /dev/fbx ---------------------------------------------------------*/
DECL|function|cirrusfb_open
r_int
id|cirrusfb_open
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
r_if
c_cond
(paren
id|opencount
op_increment
op_eq
l_int|0
)paren
id|switch_monitor
(paren
id|info-&gt;par
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*--- Close /dev/fbx --------------------------------------------------------*/
DECL|function|cirrusfb_release
r_int
id|cirrusfb_release
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|opencount
op_eq
l_int|0
)paren
id|switch_monitor
(paren
id|info-&gt;par
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**** END   Interface used by the World *************************************/
multiline_comment|/****************************************************************************/
multiline_comment|/**** BEGIN Hardware specific Routines **************************************/
multiline_comment|/* Get a good MCLK value */
DECL|function|cirrusfb_get_mclk
r_static
r_int
id|cirrusfb_get_mclk
(paren
r_int
id|freq
comma
r_int
id|bpp
comma
r_int
op_star
id|div
)paren
(brace
r_int
id|mclk
suffix:semicolon
m_assert
(paren
id|div
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Calculate MCLK, in case VCLK is high enough to require &gt; 50MHz.&n;&t; * Assume a 64-bit data path for now.  The formula is:&n;&t; * ((B * PCLK * 2)/W) * 1.2&n;&t; * B = bytes per pixel, PCLK = pixclock, W = data width in bytes */
id|mclk
op_assign
(paren
(paren
id|bpp
op_div
l_int|8
)paren
op_star
id|freq
op_star
l_int|2
)paren
op_div
l_int|4
suffix:semicolon
id|mclk
op_assign
(paren
id|mclk
op_star
l_int|12
)paren
op_div
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|mclk
OL
l_int|50000
)paren
id|mclk
op_assign
l_int|50000
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;Use MCLK of %ld kHz&bslash;n&quot;
comma
id|mclk
)paren
suffix:semicolon
multiline_comment|/* Calculate value for SR1F.  Multiply by 2 so we can round up. */
id|mclk
op_assign
(paren
(paren
id|mclk
op_star
l_int|16
)paren
op_div
l_int|14318
)paren
suffix:semicolon
id|mclk
op_assign
(paren
id|mclk
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;Set SR1F[5:0] to 0x%lx&bslash;n&quot;
comma
id|mclk
)paren
suffix:semicolon
multiline_comment|/* Determine if we should use MCLK instead of VCLK, and if so, what we&n;&t;   * should divide it by to get VCLK */
r_switch
c_cond
(paren
id|freq
)paren
(brace
r_case
l_int|24751
dot
dot
dot
l_int|25249
suffix:colon
op_star
id|div
op_assign
l_int|2
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;Using VCLK = MCLK/2&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|49501
dot
dot
dot
l_int|50499
suffix:colon
op_star
id|div
op_assign
l_int|1
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;Using VCLK = MCLK&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
op_star
id|div
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|mclk
suffix:semicolon
)brace
DECL|function|cirrusfb_check_var
r_int
id|cirrusfb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|cirrusfb_info
op_star
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_int
id|nom
comma
id|den
suffix:semicolon
multiline_comment|/* translyting from pixels-&gt;bytes */
r_int
id|yres
comma
id|i
suffix:semicolon
r_static
r_struct
(brace
r_int
id|xres
comma
id|yres
suffix:semicolon
)brace
id|modes
(braket
)braket
op_assign
(brace
(brace
l_int|1600
comma
l_int|1280
)brace
comma
(brace
l_int|1280
comma
l_int|1024
)brace
comma
(brace
l_int|1024
comma
l_int|768
)brace
comma
(brace
l_int|800
comma
l_int|600
)brace
comma
(brace
l_int|640
comma
l_int|480
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|0
dot
dot
dot
l_int|1
suffix:colon
id|var-&gt;bits_per_pixel
op_assign
l_int|1
suffix:semicolon
id|nom
op_assign
l_int|4
suffix:semicolon
id|den
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 8 pixel per byte, only 1/4th of mem usable */
r_case
l_int|2
dot
dot
dot
l_int|8
suffix:colon
id|var-&gt;bits_per_pixel
op_assign
l_int|8
suffix:semicolon
id|nom
op_assign
l_int|1
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 1 pixel == 1 byte */
r_case
l_int|9
dot
dot
dot
l_int|16
suffix:colon
id|var-&gt;bits_per_pixel
op_assign
l_int|16
suffix:semicolon
id|nom
op_assign
l_int|2
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 2 bytes per pixel */
r_case
l_int|17
dot
dot
dot
l_int|24
suffix:colon
id|var-&gt;bits_per_pixel
op_assign
l_int|24
suffix:semicolon
id|nom
op_assign
l_int|3
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 3 bytes per pixel */
r_case
l_int|25
dot
dot
dot
l_int|32
suffix:colon
id|var-&gt;bits_per_pixel
op_assign
l_int|32
suffix:semicolon
id|nom
op_assign
l_int|4
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 4 bytes per pixel */
r_default
suffix:colon
id|printk
(paren
l_string|&quot;cirrusfb: mode %dx%dx%d rejected...color depth not supported.&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT - EINVAL error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|var-&gt;xres
op_star
id|nom
op_div
id|den
op_star
id|var-&gt;yres
OG
id|cinfo-&gt;size
)paren
(brace
id|printk
(paren
l_string|&quot;cirrusfb: mode %dx%dx%d rejected...resolution too high to fit into video memory!&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT - EINVAL error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* use highest possible virtual resolution */
r_if
c_cond
(paren
id|var-&gt;xres_virtual
op_eq
op_minus
l_int|1
op_logical_and
id|var-&gt;yres_virtual
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
l_string|&quot;cirrusfb: using maximum available virtual resolution&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|modes
(braket
id|i
)braket
dot
id|xres
op_ne
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|modes
(braket
id|i
)braket
dot
id|xres
op_star
id|nom
op_div
id|den
op_star
id|modes
(braket
id|i
)braket
dot
id|yres
OL
id|cinfo-&gt;size
op_div
l_int|2
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|modes
(braket
id|i
)braket
dot
id|xres
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
l_string|&quot;cirrusfb: could not find a virtual resolution that fits into video memory!!&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT - EINVAL error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|var-&gt;xres_virtual
op_assign
id|modes
(braket
id|i
)braket
dot
id|xres
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|modes
(braket
id|i
)braket
dot
id|yres
suffix:semicolon
id|printk
(paren
l_string|&quot;cirrusfb: virtual resolution set to maximum of %dx%d&bslash;n&quot;
comma
id|var-&gt;xres_virtual
comma
id|var-&gt;yres_virtual
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|var-&gt;xres_virtual
OL
id|var-&gt;xres
)paren
id|var-&gt;xres_virtual
op_assign
id|var-&gt;xres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres_virtual
OL
id|var-&gt;yres
)paren
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xoffset
OL
l_int|0
)paren
id|var-&gt;xoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yoffset
OL
l_int|0
)paren
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* truncate xoffset and yoffset to maximum if too high */
r_if
c_cond
(paren
id|var-&gt;xoffset
OG
id|var-&gt;xres_virtual
op_minus
id|var-&gt;xres
)paren
id|var-&gt;xoffset
op_assign
id|var-&gt;xres_virtual
op_minus
id|var-&gt;xres
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yoffset
OG
id|var-&gt;yres_virtual
op_minus
id|var-&gt;yres
)paren
id|var-&gt;yoffset
op_assign
id|var-&gt;yres_virtual
op_minus
id|var-&gt;yres
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|1
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|1
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
r_if
c_cond
(paren
id|isPReP
)paren
(brace
id|var-&gt;red.offset
op_assign
l_int|2
suffix:semicolon
id|var-&gt;green.offset
op_assign
op_minus
l_int|3
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|var-&gt;red.offset
op_assign
l_int|10
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
)brace
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_if
c_cond
(paren
id|isPReP
)paren
(brace
id|var-&gt;red.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|24
suffix:semicolon
)brace
r_else
(brace
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
)brace
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
r_if
c_cond
(paren
id|isPReP
)paren
(brace
id|var-&gt;red.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|24
suffix:semicolon
)brace
r_else
(brace
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
)brace
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unsupported bpp size: %d&bslash;n&quot;
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
m_assert
(paren
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* should never occur */
r_break
suffix:semicolon
)brace
id|var-&gt;red.msb_right
op_assign
id|var-&gt;green.msb_right
op_assign
id|var-&gt;blue.msb_right
op_assign
id|var-&gt;transp.offset
op_assign
id|var-&gt;transp.length
op_assign
id|var-&gt;transp.msb_right
op_assign
l_int|0
suffix:semicolon
id|yres
op_assign
id|var-&gt;yres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
id|yres
op_mul_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
id|yres
op_assign
(paren
id|yres
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|yres
op_ge
l_int|1280
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;cirrusfb: ERROR: VerticalTotal &gt;= 1280; special treatment required! (TODO)&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT - EINVAL error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cirrusfb_decode_var
r_static
r_int
id|cirrusfb_decode_var
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|cirrusfb_regs
op_star
id|regs
comma
r_const
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|freq
suffix:semicolon
r_int
id|maxclock
suffix:semicolon
r_int
id|maxclockidx
op_assign
l_int|0
suffix:semicolon
r_struct
id|cirrusfb_info
op_star
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_int
id|xres
comma
id|hfront
comma
id|hsync
comma
id|hback
suffix:semicolon
r_int
id|yres
comma
id|vfront
comma
id|vsync
comma
id|vback
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|regs-&gt;line_length
op_assign
id|var-&gt;xres_virtual
op_div
l_int|8
suffix:semicolon
id|regs-&gt;visual
op_assign
id|FB_VISUAL_MONO10
suffix:semicolon
id|maxclockidx
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|regs-&gt;line_length
op_assign
id|var-&gt;xres_virtual
suffix:semicolon
id|regs-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|maxclockidx
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|regs-&gt;line_length
op_assign
id|var-&gt;xres_virtual
op_star
l_int|2
suffix:semicolon
id|regs-&gt;visual
op_assign
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
id|maxclockidx
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|regs-&gt;line_length
op_assign
id|var-&gt;xres_virtual
op_star
l_int|3
suffix:semicolon
id|regs-&gt;visual
op_assign
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
id|maxclockidx
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|regs-&gt;line_length
op_assign
id|var-&gt;xres_virtual
op_star
l_int|4
suffix:semicolon
id|regs-&gt;visual
op_assign
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
id|maxclockidx
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unsupported bpp size: %d&bslash;n&quot;
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
m_assert
(paren
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* should never occur */
r_break
suffix:semicolon
)brace
id|regs-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
multiline_comment|/* convert from ps to kHz */
id|freq
op_assign
l_int|1000000000
op_div
id|var-&gt;pixclock
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;desired pixclock: %ld kHz&bslash;n&quot;
comma
id|freq
)paren
suffix:semicolon
id|maxclock
op_assign
id|cirrusfb_board_info
(braket
id|cinfo-&gt;btype
)braket
dot
id|maxclock
(braket
id|maxclockidx
)braket
suffix:semicolon
id|regs-&gt;multiplexing
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If the frequency is greater than we can support, we might be able&n;&t; * to use multiplexing for the video mode */
r_if
c_cond
(paren
id|freq
OG
id|maxclock
)paren
(brace
r_switch
c_cond
(paren
id|cinfo-&gt;btype
)paren
(brace
r_case
id|BT_ALPINE
suffix:colon
r_case
id|BT_GD5480
suffix:colon
id|regs-&gt;multiplexing
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;cirrusfb: ERROR: Frequency greater than maxclock (%ld kHz)&bslash;n&quot;
comma
id|maxclock
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT - return -EINVAL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
macro_line|#if 0
multiline_comment|/* TODO: If we have a 1MB 5434, we need to put ourselves in a mode where&n;&t; * the VCLK is double the pixel clock. */
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|16
suffix:colon
r_case
l_int|32
suffix:colon
r_if
c_cond
(paren
id|regs-&gt;HorizRes
op_le
l_int|800
)paren
id|freq
op_div_assign
l_int|2
suffix:semicolon
multiline_comment|/* Xbh has this type of clock for 32-bit */
r_break
suffix:semicolon
)brace
macro_line|#endif
id|bestclock
(paren
id|freq
comma
op_amp
id|regs-&gt;freq
comma
op_amp
id|regs-&gt;nom
comma
op_amp
id|regs-&gt;den
comma
op_amp
id|regs-&gt;div
comma
id|maxclock
)paren
suffix:semicolon
id|regs-&gt;mclk
op_assign
id|cirrusfb_get_mclk
(paren
id|freq
comma
id|var-&gt;bits_per_pixel
comma
op_amp
id|regs-&gt;divMCLK
)paren
suffix:semicolon
id|xres
op_assign
id|var-&gt;xres
suffix:semicolon
id|hfront
op_assign
id|var-&gt;right_margin
suffix:semicolon
id|hsync
op_assign
id|var-&gt;hsync_len
suffix:semicolon
id|hback
op_assign
id|var-&gt;left_margin
suffix:semicolon
id|yres
op_assign
id|var-&gt;yres
suffix:semicolon
id|vfront
op_assign
id|var-&gt;lower_margin
suffix:semicolon
id|vsync
op_assign
id|var-&gt;vsync_len
suffix:semicolon
id|vback
op_assign
id|var-&gt;upper_margin
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
(brace
id|yres
op_mul_assign
l_int|2
suffix:semicolon
id|vfront
op_mul_assign
l_int|2
suffix:semicolon
id|vsync
op_mul_assign
l_int|2
suffix:semicolon
id|vback
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
(brace
id|yres
op_assign
(paren
id|yres
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|vfront
op_assign
(paren
id|vfront
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|vsync
op_assign
(paren
id|vsync
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|vback
op_assign
(paren
id|vback
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
)brace
id|regs-&gt;HorizRes
op_assign
id|xres
suffix:semicolon
id|regs-&gt;HorizTotal
op_assign
(paren
id|xres
op_plus
id|hfront
op_plus
id|hsync
op_plus
id|hback
)paren
op_div
l_int|8
op_minus
l_int|5
suffix:semicolon
id|regs-&gt;HorizDispEnd
op_assign
id|xres
op_div
l_int|8
op_minus
l_int|1
suffix:semicolon
id|regs-&gt;HorizBlankStart
op_assign
id|xres
op_div
l_int|8
suffix:semicolon
id|regs-&gt;HorizBlankEnd
op_assign
id|regs-&gt;HorizTotal
op_plus
l_int|5
suffix:semicolon
multiline_comment|/* does not count with &quot;-5&quot; */
id|regs-&gt;HorizSyncStart
op_assign
(paren
id|xres
op_plus
id|hfront
)paren
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
id|regs-&gt;HorizSyncEnd
op_assign
(paren
id|xres
op_plus
id|hfront
op_plus
id|hsync
)paren
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
id|regs-&gt;VertRes
op_assign
id|yres
suffix:semicolon
id|regs-&gt;VertTotal
op_assign
id|yres
op_plus
id|vfront
op_plus
id|vsync
op_plus
id|vback
op_minus
l_int|2
suffix:semicolon
id|regs-&gt;VertDispEnd
op_assign
id|yres
op_minus
l_int|1
suffix:semicolon
id|regs-&gt;VertBlankStart
op_assign
id|yres
suffix:semicolon
id|regs-&gt;VertBlankEnd
op_assign
id|regs-&gt;VertTotal
suffix:semicolon
id|regs-&gt;VertSyncStart
op_assign
id|yres
op_plus
id|vfront
op_minus
l_int|1
suffix:semicolon
id|regs-&gt;VertSyncEnd
op_assign
id|yres
op_plus
id|vfront
op_plus
id|vsync
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|regs-&gt;VertRes
op_ge
l_int|1024
)paren
(brace
id|regs-&gt;VertTotal
op_div_assign
l_int|2
suffix:semicolon
id|regs-&gt;VertSyncStart
op_div_assign
l_int|2
suffix:semicolon
id|regs-&gt;VertSyncEnd
op_div_assign
l_int|2
suffix:semicolon
id|regs-&gt;VertDispEnd
op_div_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|regs-&gt;multiplexing
)paren
(brace
id|regs-&gt;HorizTotal
op_div_assign
l_int|2
suffix:semicolon
id|regs-&gt;HorizSyncStart
op_div_assign
l_int|2
suffix:semicolon
id|regs-&gt;HorizSyncEnd
op_div_assign
l_int|2
suffix:semicolon
id|regs-&gt;HorizDispEnd
op_div_assign
l_int|2
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cirrusfb_set_mclk
r_static
r_void
id|cirrusfb_set_mclk
(paren
r_const
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
id|val
comma
r_int
id|div
)paren
(brace
m_assert
(paren
id|cinfo
op_ne
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|div
op_eq
l_int|2
)paren
(brace
multiline_comment|/* VCLK = MCLK/2 */
r_int
r_char
id|old
op_assign
id|vga_rseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR1E
)paren
suffix:semicolon
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR1E
comma
id|old
op_or
l_int|0x1
)paren
suffix:semicolon
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR1F
comma
l_int|0x40
op_or
(paren
id|val
op_amp
l_int|0x3f
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|div
op_eq
l_int|1
)paren
(brace
multiline_comment|/* VCLK = MCLK */
r_int
r_char
id|old
op_assign
id|vga_rseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR1E
)paren
suffix:semicolon
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR1E
comma
id|old
op_amp
op_complement
l_int|0x1
)paren
suffix:semicolon
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR1F
comma
l_int|0x40
op_or
(paren
id|val
op_amp
l_int|0x3f
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR1F
comma
id|val
op_amp
l_int|0x3f
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*************************************************************************&n;&t;cirrusfb_set_par_foo()&n;&n;&t;actually writes the values for a new video mode into the hardware,&n;**************************************************************************/
DECL|function|cirrusfb_set_par_foo
r_static
r_int
id|cirrusfb_set_par_foo
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|cirrusfb_info
op_star
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|info-&gt;var
suffix:semicolon
r_struct
id|cirrusfb_regs
id|regs
suffix:semicolon
id|u8
id|__iomem
op_star
id|regbase
op_assign
id|cinfo-&gt;regbase
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
r_int
id|offset
op_assign
l_int|0
comma
id|err
suffix:semicolon
r_const
r_struct
id|cirrusfb_board_info_rec
op_star
id|bi
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;Requested mode: %dx%dx%d&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;pixclock: %d&bslash;n&quot;
comma
id|var-&gt;pixclock
)paren
suffix:semicolon
id|init_vgachip
(paren
id|cinfo
)paren
suffix:semicolon
id|err
op_assign
id|cirrusfb_decode_var
c_func
(paren
id|var
comma
op_amp
id|regs
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
multiline_comment|/* should never happen */
id|DPRINTK
c_func
(paren
l_string|&quot;mode change aborted.  invalid var.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|bi
op_assign
op_amp
id|cirrusfb_board_info
(braket
id|cinfo-&gt;btype
)braket
suffix:semicolon
multiline_comment|/* unlock register VGA_CRTC_H_TOTAL..CRT7 */
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_V_SYNC_END
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* previously: 0x00) */
multiline_comment|/* if debugging is enabled, all parameters get output before writing */
id|DPRINTK
(paren
l_string|&quot;CRT0: %ld&bslash;n&quot;
comma
id|regs.HorizTotal
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_H_TOTAL
comma
id|regs.HorizTotal
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT1: %ld&bslash;n&quot;
comma
id|regs.HorizDispEnd
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_H_DISP
comma
id|regs.HorizDispEnd
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT2: %ld&bslash;n&quot;
comma
id|regs.HorizBlankStart
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_H_BLANK_START
comma
id|regs.HorizBlankStart
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT3: 128+%ld&bslash;n&quot;
comma
id|regs.HorizBlankEnd
op_mod
l_int|32
)paren
suffix:semicolon
multiline_comment|/*  + 128: Compatible read */
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_H_BLANK_END
comma
l_int|128
op_plus
(paren
id|regs.HorizBlankEnd
op_mod
l_int|32
)paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT4: %ld&bslash;n&quot;
comma
id|regs.HorizSyncStart
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_H_SYNC_START
comma
id|regs.HorizSyncStart
)paren
suffix:semicolon
id|tmp
op_assign
id|regs.HorizSyncEnd
op_mod
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|regs.HorizBlankEnd
op_amp
l_int|32
)paren
id|tmp
op_add_assign
l_int|128
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT5: %d&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_H_SYNC_END
comma
id|tmp
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT6: %ld&bslash;n&quot;
comma
id|regs.VertTotal
op_amp
l_int|0xff
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_V_TOTAL
comma
(paren
id|regs.VertTotal
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|tmp
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* LineCompare bit #9 */
r_if
c_cond
(paren
id|regs.VertTotal
op_amp
l_int|256
)paren
id|tmp
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|regs.VertDispEnd
op_amp
l_int|256
)paren
id|tmp
op_or_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|regs.VertSyncStart
op_amp
l_int|256
)paren
id|tmp
op_or_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|regs.VertBlankStart
op_amp
l_int|256
)paren
id|tmp
op_or_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|regs.VertTotal
op_amp
l_int|512
)paren
id|tmp
op_or_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|regs.VertDispEnd
op_amp
l_int|512
)paren
id|tmp
op_or_assign
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|regs.VertSyncStart
op_amp
l_int|512
)paren
id|tmp
op_or_assign
l_int|128
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT7: %d&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_OVERFLOW
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* LineCompare bit #8 */
r_if
c_cond
(paren
id|regs.VertBlankStart
op_amp
l_int|512
)paren
id|tmp
op_or_assign
l_int|0x20
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
id|tmp
op_or_assign
l_int|0x80
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT9: %d&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_MAX_SCAN
comma
id|tmp
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT10: %ld&bslash;n&quot;
comma
id|regs.VertSyncStart
op_amp
l_int|0xff
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_V_SYNC_START
comma
(paren
id|regs.VertSyncStart
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT11: 64+32+%ld&bslash;n&quot;
comma
id|regs.VertSyncEnd
op_mod
l_int|16
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_V_SYNC_END
comma
(paren
id|regs.VertSyncEnd
op_mod
l_int|16
op_plus
l_int|64
op_plus
l_int|32
)paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT12: %ld&bslash;n&quot;
comma
id|regs.VertDispEnd
op_amp
l_int|0xff
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_V_DISP_END
comma
(paren
id|regs.VertDispEnd
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT15: %ld&bslash;n&quot;
comma
id|regs.VertBlankStart
op_amp
l_int|0xff
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_V_BLANK_START
comma
(paren
id|regs.VertBlankStart
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT16: %ld&bslash;n&quot;
comma
id|regs.VertBlankEnd
op_amp
l_int|0xff
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_V_BLANK_END
comma
(paren
id|regs.VertBlankEnd
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT18: 0xff&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_LINE_COMPARE
comma
l_int|0xff
)paren
suffix:semicolon
id|tmp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
id|tmp
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|regs.HorizBlankEnd
op_amp
l_int|64
)paren
id|tmp
op_or_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|regs.HorizBlankEnd
op_amp
l_int|128
)paren
id|tmp
op_or_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|regs.VertBlankEnd
op_amp
l_int|256
)paren
id|tmp
op_or_assign
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|regs.VertBlankEnd
op_amp
l_int|512
)paren
id|tmp
op_or_assign
l_int|128
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CRT1a: %d&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|CL_CRT1A
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* set VCLK0 */
multiline_comment|/* hardware RefClock: 14.31818 MHz */
multiline_comment|/* formula: VClk = (OSC * N) / (D * (1+P)) */
multiline_comment|/* Example: VClk = (14.31818 * 91) / (23 * (1+1)) = 28.325 MHz */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRB
comma
id|regs.nom
)paren
suffix:semicolon
id|tmp
op_assign
id|regs.den
op_lshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|regs.div
op_ne
l_int|0
)paren
id|tmp
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cinfo-&gt;btype
op_eq
id|BT_SD64
)paren
op_logical_or
(paren
id|cinfo-&gt;btype
op_eq
id|BT_ALPINE
)paren
op_logical_or
(paren
id|cinfo-&gt;btype
op_eq
id|BT_GD5480
)paren
)paren
id|tmp
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* 6 bit denom; ONLY 5434!!! (bugged me 10 days) */
id|DPRINTK
(paren
l_string|&quot;CL_SEQR1B: %ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|tmp
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1B
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regs.VertRes
op_ge
l_int|1024
)paren
multiline_comment|/* 1280x1024 */
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_MODE
comma
l_int|0xc7
)paren
suffix:semicolon
r_else
multiline_comment|/* mode control: VGA_CRTC_START_HI enable, ROTATE(?), 16bit&n;&t;&t; * address wrap, no compat. */
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_MODE
comma
l_int|0xc3
)paren
suffix:semicolon
multiline_comment|/* HAEH?        vga_wcrt (regbase, VGA_CRTC_V_SYNC_END, 0x20);  * previously: 0x00  unlock VGA_CRTC_H_TOTAL..CRT7 */
multiline_comment|/* don&squot;t know if it would hurt to also program this if no interlaced */
multiline_comment|/* mode is used, but I feel better this way.. :-) */
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_REGS
comma
id|regs.HorizTotal
op_div
l_int|2
)paren
suffix:semicolon
r_else
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_REGS
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* interlace control */
id|vga_wseq
(paren
id|regbase
comma
id|VGA_SEQ_CHARACTER_MAP
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* adjust horizontal/vertical sync type (low/high) */
id|tmp
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* enable display memory &amp; CRTC I/O address for color mode */
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
id|tmp
op_or_assign
l_int|0x40
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
id|tmp
op_or_assign
l_int|0x80
suffix:semicolon
id|WGen
(paren
id|cinfo
comma
id|VGA_MIS_W
comma
id|tmp
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_PRESET_ROW
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Screen A Preset Row-Scan register */
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_CURSOR_START
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* text cursor on and start line */
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_CURSOR_END
comma
l_int|31
)paren
suffix:semicolon
multiline_comment|/* text cursor end line */
multiline_comment|/******************************************************&n;&t; *&n;&t; * 1 bpp&n;&t; *&n;&t; */
multiline_comment|/* programming for different color depths */
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|1
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;cirrusfb: preparing for 1 bit deep display&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_MODE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* mode register */
multiline_comment|/* SR07 */
r_switch
c_cond
(paren
id|cinfo-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
r_case
id|BT_PICCOLO
suffix:colon
r_case
id|BT_PICASSO
suffix:colon
r_case
id|BT_SPECTRUM
suffix:colon
r_case
id|BT_PICASSO4
suffix:colon
r_case
id|BT_ALPINE
suffix:colon
r_case
id|BT_GD5480
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD54xx)&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
id|regs.multiplexing
ques
c_cond
id|bi-&gt;sr07_1bpp_mux
suffix:colon
id|bi-&gt;sr07_1bpp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_LAGUNA
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD546x)&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
id|vga_rseq
(paren
id|regbase
comma
id|CL_SEQR7
)paren
op_amp
op_complement
l_int|0x01
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;cirrusfb: unknown Board&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Extended Sequencer Mode */
r_switch
c_cond
(paren
id|cinfo-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
multiline_comment|/* setting the SEQRF on SD64 is not necessary (only during init) */
id|DPRINTK
(paren
l_string|&quot;(for SD64)&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x1a
)paren
suffix:semicolon
multiline_comment|/*  MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|DPRINTK
(paren
l_string|&quot;(for Piccolo)&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ### ueberall 0x22? */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ##vorher 1c MCLK select */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* evtl d0 bei 1 bit? avoid FIFO underruns..? */
r_break
suffix:semicolon
r_case
id|BT_PICASSO
suffix:colon
id|DPRINTK
(paren
l_string|&quot;(for Picasso)&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ##vorher 22 MCLK select */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xd0
)paren
suffix:semicolon
multiline_comment|/* ## vorher d0 avoid FIFO underruns..? */
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|DPRINTK
(paren
l_string|&quot;(for Spectrum)&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ### ueberall 0x22? */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ##vorher 1c MCLK select */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* evtl d0? avoid FIFO underruns..? */
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
r_case
id|BT_ALPINE
suffix:colon
r_case
id|BT_GD5480
suffix:colon
r_case
id|BT_LAGUNA
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD54xx)&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;cirrusfb: unknown Board&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|WGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* pixel mask: pass-through for first plane */
r_if
c_cond
(paren
id|regs.multiplexing
)paren
id|WHDR
(paren
id|cinfo
comma
l_int|0x4a
)paren
suffix:semicolon
multiline_comment|/* hidden dac reg: 1280x1024 */
r_else
id|WHDR
(paren
id|cinfo
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* hidden dac: nothing */
id|vga_wseq
(paren
id|regbase
comma
id|VGA_SEQ_MEMORY_MODE
comma
l_int|0x06
)paren
suffix:semicolon
multiline_comment|/* memory mode: odd/even, ext. memory */
id|vga_wseq
(paren
id|regbase
comma
id|VGA_SEQ_PLANE_WRITE
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* plane mask: only write to first plane */
id|offset
op_assign
id|var-&gt;xres_virtual
op_div
l_int|16
suffix:semicolon
)brace
multiline_comment|/******************************************************&n;&t; *&n;&t; * 8 bpp&n;&t; *&n;&t; */
r_else
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|8
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;cirrusfb: preparing for 8 bit deep display&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cinfo-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
r_case
id|BT_PICCOLO
suffix:colon
r_case
id|BT_PICASSO
suffix:colon
r_case
id|BT_SPECTRUM
suffix:colon
r_case
id|BT_PICASSO4
suffix:colon
r_case
id|BT_ALPINE
suffix:colon
r_case
id|BT_GD5480
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD54xx)&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
id|regs.multiplexing
ques
c_cond
id|bi-&gt;sr07_8bpp_mux
suffix:colon
id|bi-&gt;sr07_8bpp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_LAGUNA
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD546x)&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
id|vga_rseq
(paren
id|regbase
comma
id|CL_SEQR7
)paren
op_or
l_int|0x01
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;cirrusfb: unknown Board&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cinfo-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x1d
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ### vorher 1c MCLK select */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
r_break
suffix:semicolon
r_case
id|BT_PICASSO
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ### vorher 1c MCLK select */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ### vorher 1c MCLK select */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
macro_line|#ifdef CONFIG_ZORRO
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb8
)paren
suffix:semicolon
multiline_comment|/* ### INCOMPLETE!! */
macro_line|#endif
multiline_comment|/*          vga_wseq (regbase, CL_SEQR1F, 0x1c); */
r_break
suffix:semicolon
r_case
id|BT_ALPINE
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD543x)&bslash;n&quot;
)paren
suffix:semicolon
id|cirrusfb_set_mclk
(paren
id|cinfo
comma
id|regs.mclk
comma
id|regs.divMCLK
)paren
suffix:semicolon
multiline_comment|/* We already set SRF and SR1F */
r_break
suffix:semicolon
r_case
id|BT_GD5480
suffix:colon
r_case
id|BT_LAGUNA
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD54xx)&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;cirrusfb: unknown Board&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_MODE
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* mode register: 256 color mode */
id|WGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* pixel mask: pass-through all planes */
r_if
c_cond
(paren
id|regs.multiplexing
)paren
id|WHDR
(paren
id|cinfo
comma
l_int|0x4a
)paren
suffix:semicolon
multiline_comment|/* hidden dac reg: 1280x1024 */
r_else
id|WHDR
(paren
id|cinfo
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* hidden dac: nothing */
id|vga_wseq
(paren
id|regbase
comma
id|VGA_SEQ_MEMORY_MODE
comma
l_int|0x0a
)paren
suffix:semicolon
multiline_comment|/* memory mode: chain4, ext. memory */
id|vga_wseq
(paren
id|regbase
comma
id|VGA_SEQ_PLANE_WRITE
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* plane mask: enable writing to all 4 planes */
id|offset
op_assign
id|var-&gt;xres_virtual
op_div
l_int|8
suffix:semicolon
)brace
multiline_comment|/******************************************************&n;&t; *&n;&t; * 16 bpp&n;&t; *&n;&t; */
r_else
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|16
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;cirrusfb: preparing for 16 bit deep display&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cinfo-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0xf7
)paren
suffix:semicolon
multiline_comment|/* Extended Sequencer Mode: 256c col. mode */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x1e
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0x87
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICASSO
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0x27
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0x87
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0x27
)paren
suffix:semicolon
multiline_comment|/*          vga_wseq (regbase, CL_SEQR1F, 0x1c);  */
r_break
suffix:semicolon
r_case
id|BT_ALPINE
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD543x)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regs.HorizRes
op_ge
l_int|1024
)paren
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0xa7
)paren
suffix:semicolon
r_else
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0xa3
)paren
suffix:semicolon
id|cirrusfb_set_mclk
(paren
id|cinfo
comma
id|regs.mclk
comma
id|regs.divMCLK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_GD5480
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD5480)&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0x17
)paren
suffix:semicolon
multiline_comment|/* We already set SRF and SR1F */
r_break
suffix:semicolon
r_case
id|BT_LAGUNA
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD546x)&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
id|vga_rseq
(paren
id|regbase
comma
id|CL_SEQR7
)paren
op_amp
op_complement
l_int|0x01
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;CIRRUSFB: unknown Board&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_MODE
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* mode register: 256 color mode */
id|WGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* pixel mask: pass-through all planes */
macro_line|#ifdef CONFIG_PCI
id|WHDR
(paren
id|cinfo
comma
l_int|0xc0
)paren
suffix:semicolon
multiline_comment|/* Copy Xbh */
macro_line|#elif defined(CONFIG_ZORRO)
multiline_comment|/* FIXME: CONFIG_PCI and CONFIG_ZORRO may be defined both */
id|WHDR
(paren
id|cinfo
comma
l_int|0xa0
)paren
suffix:semicolon
multiline_comment|/* hidden dac reg: nothing special */
macro_line|#endif
id|vga_wseq
(paren
id|regbase
comma
id|VGA_SEQ_MEMORY_MODE
comma
l_int|0x0a
)paren
suffix:semicolon
multiline_comment|/* memory mode: chain4, ext. memory */
id|vga_wseq
(paren
id|regbase
comma
id|VGA_SEQ_PLANE_WRITE
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* plane mask: enable writing to all 4 planes */
id|offset
op_assign
id|var-&gt;xres_virtual
op_div
l_int|4
suffix:semicolon
)brace
multiline_comment|/******************************************************&n;&t; *&n;&t; * 32 bpp&n;&t; *&n;&t; */
r_else
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|32
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;cirrusfb: preparing for 24/32 bit deep display&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cinfo-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0xf9
)paren
suffix:semicolon
multiline_comment|/* Extended Sequencer Mode: 256c col. mode */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x1e
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0x85
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICASSO
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0x25
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0x85
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0x25
)paren
suffix:semicolon
multiline_comment|/*          vga_wseq (regbase, CL_SEQR1F, 0x1c);  */
r_break
suffix:semicolon
r_case
id|BT_ALPINE
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD543x)&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0xa9
)paren
suffix:semicolon
id|cirrusfb_set_mclk
(paren
id|cinfo
comma
id|regs.mclk
comma
id|regs.divMCLK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_GD5480
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD5480)&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
l_int|0x19
)paren
suffix:semicolon
multiline_comment|/* We already set SRF and SR1F */
r_break
suffix:semicolon
r_case
id|BT_LAGUNA
suffix:colon
id|DPRINTK
(paren
l_string|&quot; (for GD546x)&bslash;n&quot;
)paren
suffix:semicolon
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR7
comma
id|vga_rseq
(paren
id|regbase
comma
id|CL_SEQR7
)paren
op_amp
op_complement
l_int|0x01
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;cirrusfb: unknown Board&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_MODE
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* mode register: 256 color mode */
id|WGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* pixel mask: pass-through all planes */
id|WHDR
(paren
id|cinfo
comma
l_int|0xc5
)paren
suffix:semicolon
multiline_comment|/* hidden dac reg: 8-8-8 mode (24 or 32) */
id|vga_wseq
(paren
id|regbase
comma
id|VGA_SEQ_MEMORY_MODE
comma
l_int|0x0a
)paren
suffix:semicolon
multiline_comment|/* memory mode: chain4, ext. memory */
id|vga_wseq
(paren
id|regbase
comma
id|VGA_SEQ_PLANE_WRITE
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* plane mask: enable writing to all 4 planes */
id|offset
op_assign
id|var-&gt;xres_virtual
op_div
l_int|4
suffix:semicolon
)brace
multiline_comment|/******************************************************&n;&t; *&n;&t; * unknown/unsupported bpp&n;&t; *&n;&t; */
r_else
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;cirrusfb: What&squot;s this?? requested color depth == %d.&bslash;n&quot;
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
)brace
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_OFFSET
comma
id|offset
op_amp
l_int|0xff
)paren
suffix:semicolon
id|tmp
op_assign
l_int|0x22
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_amp
l_int|0x100
)paren
id|tmp
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* offset overflow bit */
id|vga_wcrt
(paren
id|regbase
comma
id|CL_CRT1B
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* screen start addr #16-18, fastpagemode cycles */
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_SD64
op_logical_or
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO4
op_logical_or
id|cinfo-&gt;btype
op_eq
id|BT_ALPINE
op_logical_or
id|cinfo-&gt;btype
op_eq
id|BT_GD5480
)paren
id|vga_wcrt
(paren
id|regbase
comma
id|CL_CRT1D
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* screen start address bit 19 */
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_CURSOR_HI
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* text cursor location high */
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_CURSOR_LO
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* text cursor location low */
id|vga_wcrt
(paren
id|regbase
comma
id|VGA_CRTC_UNDERLINE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* underline row scanline = at very bottom */
id|vga_wattr
(paren
id|regbase
comma
id|VGA_ATC_MODE
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* controller mode */
id|vga_wattr
(paren
id|regbase
comma
id|VGA_ATC_OVERSCAN
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* overscan (border) color */
id|vga_wattr
(paren
id|regbase
comma
id|VGA_ATC_PLANE_ENABLE
comma
l_int|15
)paren
suffix:semicolon
multiline_comment|/* color plane enable */
id|vga_wattr
(paren
id|regbase
comma
id|CL_AR33
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* pixel panning */
id|vga_wattr
(paren
id|regbase
comma
id|VGA_ATC_COLOR_PAGE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* color select */
multiline_comment|/* [ EGS: SetOffset(); ] */
multiline_comment|/* From SetOffset(): Turn on VideoEnable bit in Attribute controller */
id|AttrOn
(paren
id|cinfo
)paren
suffix:semicolon
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_SR_VALUE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set/reset register */
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_SR_ENABLE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set/reset enable */
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_COMPARE_VALUE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* color compare */
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_DATA_ROTATE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* data rotate */
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_PLANE_READ
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* read map select */
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_MISC
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* miscellaneous register */
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_COMPARE_MASK
comma
l_int|15
)paren
suffix:semicolon
multiline_comment|/* color don&squot;t care */
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_BIT_MASK
comma
l_int|255
)paren
suffix:semicolon
multiline_comment|/* bit mask */
id|vga_wseq
(paren
id|regbase
comma
id|CL_SEQR12
comma
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* graphics cursor attributes: nothing special */
multiline_comment|/* finally, turn on everything - turn off &quot;FullBandwidth&quot; bit */
multiline_comment|/* also, set &quot;DotClock%2&quot; bit where requested */
id|tmp
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/*** FB_VMODE_CLOCK_HALVE in linux/fb.h not defined anymore ?&n;    if (var-&gt;vmode &amp; FB_VMODE_CLOCK_HALVE)&n;&t;tmp |= 0x08;&n;*/
id|vga_wseq
(paren
id|regbase
comma
id|VGA_SEQ_CLOCK_MODE
comma
id|tmp
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CL_SEQR1: %d&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|cinfo-&gt;currentmode
op_assign
id|regs
suffix:semicolon
id|info-&gt;fix.type
op_assign
id|regs.type
suffix:semicolon
id|info-&gt;fix.visual
op_assign
id|regs.visual
suffix:semicolon
id|info-&gt;fix.line_length
op_assign
id|regs.line_length
suffix:semicolon
multiline_comment|/* pan to requested offset */
id|cirrusfb_pan_display
(paren
id|var
comma
id|info
)paren
suffix:semicolon
macro_line|#ifdef CIRRUSFB_DEBUG
id|cirrusfb_dump
(paren
)paren
suffix:semicolon
macro_line|#endif
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* for some reason incomprehensible to me, cirrusfb requires that you write&n; * the registers twice for the settings to take..grr. -dte */
DECL|function|cirrusfb_set_par
r_int
id|cirrusfb_set_par
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|cirrusfb_set_par_foo
(paren
id|info
)paren
suffix:semicolon
r_return
id|cirrusfb_set_par_foo
(paren
id|info
)paren
suffix:semicolon
)brace
DECL|function|cirrusfb_setcolreg
r_int
id|cirrusfb_setcolreg
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|cirrusfb_info
op_star
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;fix.visual
op_eq
id|FB_VISUAL_TRUECOLOR
)paren
(brace
id|u32
id|v
suffix:semicolon
id|red
op_rshift_assign
(paren
l_int|16
op_minus
id|info-&gt;var.red.length
)paren
suffix:semicolon
id|green
op_rshift_assign
(paren
l_int|16
op_minus
id|info-&gt;var.green.length
)paren
suffix:semicolon
id|blue
op_rshift_assign
(paren
l_int|16
op_minus
id|info-&gt;var.blue.length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
l_int|16
)paren
r_return
l_int|1
suffix:semicolon
id|v
op_assign
(paren
id|red
op_lshift
id|info-&gt;var.red.offset
)paren
op_or
(paren
id|green
op_lshift
id|info-&gt;var.green.offset
)paren
op_or
(paren
id|blue
op_lshift
id|info-&gt;var.blue.offset
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
(paren
(paren
id|u8
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|regno
)braket
op_assign
id|v
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
(paren
(paren
id|u16
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|regno
)braket
op_assign
id|v
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|regno
)braket
op_assign
id|v
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|cinfo-&gt;palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|cinfo-&gt;palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|cinfo-&gt;palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.bits_per_pixel
op_eq
l_int|8
)paren
(brace
id|WClut
(paren
id|cinfo
comma
id|regno
comma
id|red
op_rshift
l_int|10
comma
id|green
op_rshift
l_int|10
comma
id|blue
op_rshift
l_int|10
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*************************************************************************&n;&t;cirrusfb_pan_display()&n;&n;&t;performs display panning - provided hardware permits this&n;**************************************************************************/
DECL|function|cirrusfb_pan_display
r_int
id|cirrusfb_pan_display
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|xoffset
op_assign
l_int|0
suffix:semicolon
r_int
id|yoffset
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
r_int
r_char
id|tmp
op_assign
l_int|0
comma
id|tmp2
op_assign
l_int|0
comma
id|xpix
suffix:semicolon
r_struct
id|cirrusfb_info
op_star
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;virtual offset: (%d,%d)&bslash;n&quot;
comma
id|var-&gt;xoffset
comma
id|var-&gt;yoffset
)paren
suffix:semicolon
multiline_comment|/* no range checks for xoffset and yoffset,   */
multiline_comment|/* as fb_pan_display has already done this */
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info-&gt;var.xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|info-&gt;var.yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
id|xoffset
op_assign
id|var-&gt;xoffset
op_star
id|info-&gt;var.bits_per_pixel
op_div
l_int|8
suffix:semicolon
id|yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
id|base
op_assign
id|yoffset
op_star
id|cinfo-&gt;currentmode.line_length
op_plus
id|xoffset
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.bits_per_pixel
op_eq
l_int|1
)paren
(brace
multiline_comment|/* base is already correct */
id|xpix
op_assign
(paren
r_int
r_char
)paren
(paren
id|var-&gt;xoffset
op_mod
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|base
op_div_assign
l_int|4
suffix:semicolon
id|xpix
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|xoffset
op_mod
l_int|4
)paren
op_star
l_int|2
)paren
suffix:semicolon
)brace
id|cirrusfb_WaitBLT
c_func
(paren
id|cinfo-&gt;regbase
)paren
suffix:semicolon
multiline_comment|/* make sure all the BLT&squot;s are done */
multiline_comment|/* lower 8 + 8 bits of screen start address */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_START_LO
comma
(paren
r_int
r_char
)paren
(paren
id|base
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_START_HI
comma
(paren
r_int
r_char
)paren
(paren
id|base
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* construct bits 16, 17 and 18 of screen start address */
r_if
c_cond
(paren
id|base
op_amp
l_int|0x10000
)paren
id|tmp
op_or_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|base
op_amp
l_int|0x20000
)paren
id|tmp
op_or_assign
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
id|base
op_amp
l_int|0x40000
)paren
id|tmp
op_or_assign
l_int|0x08
suffix:semicolon
id|tmp2
op_assign
(paren
id|vga_rcrt
(paren
id|cinfo-&gt;regbase
comma
id|CL_CRT1B
)paren
op_amp
l_int|0xf2
)paren
op_or
id|tmp
suffix:semicolon
multiline_comment|/* 0xf2 is %11110010, exclude tmp bits */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|CL_CRT1B
comma
id|tmp2
)paren
suffix:semicolon
multiline_comment|/* construct bit 19 of screen start address */
r_if
c_cond
(paren
id|cirrusfb_board_info
(braket
id|cinfo-&gt;btype
)braket
dot
id|scrn_start_bit19
)paren
(brace
id|tmp2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|base
op_amp
l_int|0x80000
)paren
id|tmp2
op_assign
l_int|0x80
suffix:semicolon
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|CL_CRT1D
comma
id|tmp2
)paren
suffix:semicolon
)brace
multiline_comment|/* write pixel panning value to AR33; this does not quite work in 8bpp */
multiline_comment|/* ### Piccolo..? Will this work? */
r_if
c_cond
(paren
id|info-&gt;var.bits_per_pixel
op_eq
l_int|1
)paren
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|CL_AR33
comma
id|xpix
)paren
suffix:semicolon
id|cirrusfb_WaitBLT
(paren
id|cinfo-&gt;regbase
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|cirrusfb_blank
r_int
id|cirrusfb_blank
(paren
r_int
id|blank_mode
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/*&n;&t; *  Blank the screen if blank_mode != 0, else unblank. If blank == NULL&n;&t; *  then the caller blanks by setting the CLUT (Color Look Up Table) to all&n;&t; *  black. Return 0 if blanking succeeded, != 0 if un-/blanking failed due&n;&t; *  to e.g. a video mode which doesn&squot;t support it. Implements VESA suspend&n;&t; *  and powerdown modes on hardware that supports disabling hsync/vsync:&n;&t; *    blank_mode == 2: suspend vsync&n;&t; *    blank_mode == 3: suspend hsync&n;&t; *    blank_mode == 4: powerdown&n;&t; */
r_int
r_char
id|val
suffix:semicolon
r_struct
id|cirrusfb_info
op_star
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_int
id|current_mode
op_assign
id|cinfo-&gt;blank_mode
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER, blank mode = %d&bslash;n&quot;
comma
id|blank_mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;state
op_ne
id|FBINFO_STATE_RUNNING
op_logical_or
id|current_mode
op_eq
id|blank_mode
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Undo current */
r_if
c_cond
(paren
id|current_mode
op_ne
id|VESA_NO_BLANKING
)paren
(brace
multiline_comment|/* unblank the screen */
id|val
op_assign
id|vga_rseq
(paren
id|cinfo-&gt;regbase
comma
id|VGA_SEQ_CLOCK_MODE
)paren
suffix:semicolon
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|VGA_SEQ_CLOCK_MODE
comma
id|val
op_amp
l_int|0xdf
)paren
suffix:semicolon
multiline_comment|/* clear &quot;FullBandwidth&quot; bit */
multiline_comment|/* and undo VESA suspend trickery */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GRE
comma
l_int|0x00
)paren
suffix:semicolon
)brace
multiline_comment|/* set new */
r_if
c_cond
(paren
id|blank_mode
op_ne
id|VESA_NO_BLANKING
)paren
(brace
multiline_comment|/* blank the screen */
id|val
op_assign
id|vga_rseq
(paren
id|cinfo-&gt;regbase
comma
id|VGA_SEQ_CLOCK_MODE
)paren
suffix:semicolon
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|VGA_SEQ_CLOCK_MODE
comma
id|val
op_or
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* set &quot;FullBandwidth&quot; bit */
)brace
r_switch
c_cond
(paren
id|blank_mode
)paren
(brace
r_case
id|VESA_NO_BLANKING
suffix:colon
r_break
suffix:semicolon
r_case
id|VESA_VSYNC_SUSPEND
suffix:colon
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GRE
comma
l_int|0x04
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VESA_HSYNC_SUSPEND
suffix:colon
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GRE
comma
l_int|0x02
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VESA_POWERDOWN
suffix:colon
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GRE
comma
l_int|0x06
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 1&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|cinfo-&gt;blank_mode
op_assign
id|blank_mode
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**** END   Hardware specific Routines **************************************/
multiline_comment|/****************************************************************************/
multiline_comment|/**** BEGIN Internal Routines ***********************************************/
DECL|function|init_vgachip
r_static
r_void
id|init_vgachip
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
)paren
(brace
r_const
r_struct
id|cirrusfb_board_info_rec
op_star
id|bi
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|cinfo
op_ne
l_int|NULL
)paren
suffix:semicolon
id|bi
op_assign
op_amp
id|cirrusfb_board_info
(braket
id|cinfo-&gt;btype
)braket
suffix:semicolon
multiline_comment|/* reset board globally */
r_switch
c_cond
(paren
id|cinfo-&gt;btype
)paren
(brace
r_case
id|BT_PICCOLO
suffix:colon
id|WSFR
(paren
id|cinfo
comma
l_int|0x01
)paren
suffix:semicolon
id|udelay
(paren
l_int|500
)paren
suffix:semicolon
id|WSFR
(paren
id|cinfo
comma
l_int|0x51
)paren
suffix:semicolon
id|udelay
(paren
l_int|500
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICASSO
suffix:colon
id|WSFR2
(paren
id|cinfo
comma
l_int|0xff
)paren
suffix:semicolon
id|udelay
(paren
l_int|500
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_SD64
suffix:colon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSFR
(paren
id|cinfo
comma
l_int|0x1f
)paren
suffix:semicolon
id|udelay
(paren
l_int|500
)paren
suffix:semicolon
id|WSFR
(paren
id|cinfo
comma
l_int|0x4f
)paren
suffix:semicolon
id|udelay
(paren
l_int|500
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|CL_CRT51
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* disable flickerfixer */
id|mdelay
(paren
l_int|100
)paren
suffix:semicolon
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GR2F
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* from Klaus&squot; NetBSD driver: */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GR33
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* put blitter into 542x compat */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GR31
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* mode */
r_break
suffix:semicolon
r_case
id|BT_GD5480
suffix:colon
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GR2F
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* from Klaus&squot; NetBSD driver: */
r_break
suffix:semicolon
r_case
id|BT_ALPINE
suffix:colon
multiline_comment|/* Nothing to do to reset the board. */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_ERR
l_string|&quot;cirrusfb: Warning: Unknown board type&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
m_assert
(paren
id|cinfo-&gt;size
OG
l_int|0
)paren
suffix:semicolon
multiline_comment|/* make sure RAM size set by this point */
multiline_comment|/* the P4 is not fully initialized here; I rely on it having been */
multiline_comment|/* inited under AmigaOS already, which seems to work just fine    */
multiline_comment|/* (Klaus advised to do it this way)                              */
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_ne
id|BT_PICASSO4
)paren
(brace
id|WGen
(paren
id|cinfo
comma
id|CL_VSSM
comma
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* EGS: 0x16 */
id|WGen
(paren
id|cinfo
comma
id|CL_POS102
comma
l_int|0x01
)paren
suffix:semicolon
id|WGen
(paren
id|cinfo
comma
id|CL_VSSM
comma
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* EGS: 0x0e */
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_ne
id|BT_SD64
)paren
id|WGen
(paren
id|cinfo
comma
id|CL_VSSM2
comma
l_int|0x01
)paren
suffix:semicolon
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR0
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* reset sequencer logic */
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|VGA_SEQ_CLOCK_MODE
comma
l_int|0x21
)paren
suffix:semicolon
multiline_comment|/* FullBandwidth (video off) and 8/9 dot clock */
id|WGen
(paren
id|cinfo
comma
id|VGA_MIS_W
comma
l_int|0xc1
)paren
suffix:semicolon
multiline_comment|/* polarity (-/-), disable access to display memory, VGA_CRTC_START_HI base address: color */
multiline_comment|/*      vga_wgfx (cinfo-&gt;regbase, CL_GRA, 0xce);    &quot;magic cookie&quot; - doesn&squot;t make any sense to me.. */
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR6
comma
l_int|0x12
)paren
suffix:semicolon
multiline_comment|/* unlock all extension registers */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GR31
comma
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* reset blitter */
r_switch
c_cond
(paren
id|cinfo-&gt;btype
)paren
(brace
r_case
id|BT_GD5480
suffix:colon
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQRF
comma
l_int|0x98
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_ALPINE
suffix:colon
r_break
suffix:semicolon
r_case
id|BT_SD64
suffix:colon
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQRF
comma
l_int|0xb8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR16
comma
l_int|0x0f
)paren
suffix:semicolon
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|VGA_SEQ_PLANE_WRITE
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* plane mask: nothing */
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|VGA_SEQ_CHARACTER_MAP
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* character map select: doesn&squot;t even matter in gx mode */
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|VGA_SEQ_MEMORY_MODE
comma
l_int|0x0e
)paren
suffix:semicolon
multiline_comment|/* memory mode: chain-4, no odd/even, ext. memory */
multiline_comment|/* controller-internal base address of video memory */
r_if
c_cond
(paren
id|bi-&gt;init_sr07
)paren
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR7
comma
id|bi-&gt;sr07
)paren
suffix:semicolon
multiline_comment|/*  vga_wseq (cinfo-&gt;regbase, CL_SEQR8, 0x00); */
multiline_comment|/* EEPROM control: shouldn&squot;t be necessary to write to this at all.. */
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR10
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* graphics cursor X position (incomplete; position gives rem. 3 bits */
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR11
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* graphics cursor Y position (...&quot;... ) */
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR12
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* graphics cursor attributes */
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR13
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* graphics cursor pattern address */
multiline_comment|/* writing these on a P4 might give problems..  */
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_ne
id|BT_PICASSO4
)paren
(brace
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR17
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* configuration readback and ext. color */
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR18
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* signature generator */
)brace
multiline_comment|/* MCLK select etc. */
r_if
c_cond
(paren
id|bi-&gt;init_sr1f
)paren
id|vga_wseq
(paren
id|cinfo-&gt;regbase
comma
id|CL_SEQR1F
comma
id|bi-&gt;sr1f
)paren
suffix:semicolon
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_PRESET_ROW
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Screen A preset row scan: none */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_CURSOR_START
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* Text cursor start: disable text cursor */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_CURSOR_END
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Text cursor end: - */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_START_HI
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Screen start address high: 0 */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_START_LO
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Screen start address low: 0 */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_CURSOR_HI
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* text cursor location high: 0 */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_CURSOR_LO
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* text cursor location low: 0 */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_UNDERLINE
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Underline Row scanline: - */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_MODE
comma
l_int|0xc3
)paren
suffix:semicolon
multiline_comment|/* mode control: timing enable, byte mode, no compat modes */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|VGA_CRTC_LINE_COMPARE
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Line Compare: not needed */
multiline_comment|/* ### add 0x40 for text modes with &gt; 30 MHz pixclock */
id|vga_wcrt
(paren
id|cinfo-&gt;regbase
comma
id|CL_CRT1B
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* ext. display controls: ext.adr. wrap */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|VGA_GFX_SR_VALUE
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Set/Reset registes: - */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|VGA_GFX_SR_ENABLE
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Set/Reset enable: - */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|VGA_GFX_COMPARE_VALUE
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Color Compare: - */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|VGA_GFX_DATA_ROTATE
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Data Rotate: - */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|VGA_GFX_PLANE_READ
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Read Map Select: - */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|VGA_GFX_MODE
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Mode: conf. for 16/4/2 color mode, no odd/even, read/write mode 0 */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|VGA_GFX_MISC
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous: memory map base address, graphics mode */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|VGA_GFX_COMPARE_MASK
comma
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* Color Don&squot;t care: involve all planes */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|VGA_GFX_BIT_MASK
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Bit Mask: no mask at all */
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_ALPINE
)paren
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GRB
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* (5434 can&squot;t have bit 3 set for bitblt) */
r_else
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GRB
comma
l_int|0x28
)paren
suffix:semicolon
multiline_comment|/* Graphics controller mode extensions: finer granularity, 8byte data latches */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GRC
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Color Key compare: - */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GRD
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Color Key compare mask: - */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GRE
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous control: - */
multiline_comment|/*  vga_wgfx (cinfo-&gt;regbase, CL_GR10, 0x00); */
multiline_comment|/* Background color byte 1: - */
multiline_comment|/*  vga_wgfx (cinfo-&gt;regbase, CL_GR11, 0x00); */
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTE0
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Attribute Controller palette registers: &quot;identity mapping&quot; */
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTE1
comma
l_int|0x01
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTE2
comma
l_int|0x02
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTE3
comma
l_int|0x03
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTE4
comma
l_int|0x04
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTE5
comma
l_int|0x05
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTE6
comma
l_int|0x06
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTE7
comma
l_int|0x07
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTE8
comma
l_int|0x08
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTE9
comma
l_int|0x09
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTEA
comma
l_int|0x0a
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTEB
comma
l_int|0x0b
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTEC
comma
l_int|0x0c
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTED
comma
l_int|0x0d
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTEE
comma
l_int|0x0e
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PALETTEF
comma
l_int|0x0f
)paren
suffix:semicolon
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_MODE
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Attribute Controller mode: graphics mode */
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_OVERSCAN
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Overscan color reg.: reg. 0 */
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_PLANE_ENABLE
comma
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* Color Plane enable: Enable all 4 planes */
multiline_comment|/* ###  vga_wattr (cinfo-&gt;regbase, CL_AR33, 0x00); * Pixel Panning: - */
id|vga_wattr
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATC_COLOR_PAGE
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Color Select: - */
id|WGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Pixel mask: no mask */
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_ne
id|BT_ALPINE
op_logical_and
id|cinfo-&gt;btype
op_ne
id|BT_GD5480
)paren
id|WGen
(paren
id|cinfo
comma
id|VGA_MIS_W
comma
l_int|0xc3
)paren
suffix:semicolon
multiline_comment|/* polarity (-/-), enable display mem, VGA_CRTC_START_HI i/o base = color */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GR31
comma
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* BLT Start/status: Blitter reset */
id|vga_wgfx
(paren
id|cinfo-&gt;regbase
comma
id|CL_GR31
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* - &quot; -           : &quot;end-of-reset&quot; */
multiline_comment|/* misc... */
id|WHDR
(paren
id|cinfo
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Hidden DAC register: - */
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;cirrusfb: This board has %ld bytes of DRAM memory&bslash;n&quot;
comma
id|cinfo-&gt;size
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|switch_monitor
r_static
r_void
id|switch_monitor
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
id|on
)paren
(brace
macro_line|#ifdef CONFIG_ZORRO /* only works on Zorro boards */
r_static
r_int
id|IsOn
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX not ok for multiple boards */
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO4
)paren
r_return
suffix:semicolon
multiline_comment|/* nothing to switch */
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_ALPINE
)paren
r_return
suffix:semicolon
multiline_comment|/* nothing to switch */
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_GD5480
)paren
r_return
suffix:semicolon
multiline_comment|/* nothing to switch */
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
r_if
c_cond
(paren
(paren
id|on
op_logical_and
op_logical_neg
id|IsOn
)paren
op_logical_or
(paren
op_logical_neg
id|on
op_logical_and
id|IsOn
)paren
)paren
id|WSFR
(paren
id|cinfo
comma
l_int|0xff
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|on
)paren
(brace
r_switch
c_cond
(paren
id|cinfo-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|WSFR
(paren
id|cinfo
comma
id|cinfo-&gt;SFR
op_or
l_int|0x21
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|WSFR
(paren
id|cinfo
comma
id|cinfo-&gt;SFR
op_or
l_int|0x28
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSFR
(paren
id|cinfo
comma
l_int|0x6f
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|cinfo-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|WSFR
(paren
id|cinfo
comma
id|cinfo-&gt;SFR
op_amp
l_int|0xde
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|WSFR
(paren
id|cinfo
comma
id|cinfo-&gt;SFR
op_amp
l_int|0xd7
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSFR
(paren
id|cinfo
comma
l_int|0x4f
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
)brace
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ZORRO */
)brace
multiline_comment|/******************************************/
multiline_comment|/* Linux 2.6-style  accelerated functions */
multiline_comment|/******************************************/
DECL|function|cirrusfb_prim_fillrect
r_static
r_void
id|cirrusfb_prim_fillrect
c_func
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_const
r_struct
id|fb_fillrect
op_star
id|region
)paren
(brace
r_int
id|m
suffix:semicolon
multiline_comment|/* bytes per pixel */
r_if
c_cond
(paren
id|cinfo-&gt;info-&gt;var.bits_per_pixel
op_eq
l_int|1
)paren
(brace
id|cirrusfb_RectFill
c_func
(paren
id|cinfo-&gt;regbase
comma
id|cinfo-&gt;info-&gt;var.bits_per_pixel
comma
id|region-&gt;dx
op_div
l_int|8
comma
id|region-&gt;dy
comma
id|region-&gt;width
op_div
l_int|8
comma
id|region-&gt;height
comma
id|region-&gt;color
comma
id|cinfo-&gt;currentmode.line_length
)paren
suffix:semicolon
)brace
r_else
(brace
id|m
op_assign
(paren
id|cinfo-&gt;info-&gt;var.bits_per_pixel
op_plus
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
id|cirrusfb_RectFill
c_func
(paren
id|cinfo-&gt;regbase
comma
id|cinfo-&gt;info-&gt;var.bits_per_pixel
comma
id|region-&gt;dx
op_star
id|m
comma
id|region-&gt;dy
comma
id|region-&gt;width
op_star
id|m
comma
id|region-&gt;height
comma
id|region-&gt;color
comma
id|cinfo-&gt;currentmode.line_length
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|cirrusfb_fillrect
r_void
id|cirrusfb_fillrect
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_fillrect
op_star
id|region
)paren
(brace
r_struct
id|cirrusfb_info
op_star
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_struct
id|fb_fillrect
id|modded
suffix:semicolon
r_int
id|vxres
comma
id|vyres
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;state
op_ne
id|FBINFO_STATE_RUNNING
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|FBINFO_HWACCEL_DISABLED
)paren
(brace
id|cfb_fillrect
c_func
(paren
id|info
comma
id|region
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|vxres
op_assign
id|info-&gt;var.xres_virtual
suffix:semicolon
id|vyres
op_assign
id|info-&gt;var.yres_virtual
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|modded
comma
id|region
comma
r_sizeof
(paren
r_struct
id|fb_fillrect
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|modded.width
op_logical_or
op_logical_neg
id|modded.height
op_logical_or
id|modded.dx
op_ge
id|vxres
op_logical_or
id|modded.dy
op_ge
id|vyres
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|modded.dx
op_plus
id|modded.width
OG
id|vxres
)paren
(brace
id|modded.width
op_assign
id|vxres
op_minus
id|modded.dx
suffix:semicolon
)brace
r_if
c_cond
(paren
id|modded.dy
op_plus
id|modded.height
OG
id|vyres
)paren
(brace
id|modded.height
op_assign
id|vyres
op_minus
id|modded.dy
suffix:semicolon
)brace
id|cirrusfb_prim_fillrect
c_func
(paren
id|cinfo
comma
op_amp
id|modded
)paren
suffix:semicolon
)brace
DECL|function|cirrusfb_prim_copyarea
r_static
r_void
id|cirrusfb_prim_copyarea
c_func
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_const
r_struct
id|fb_copyarea
op_star
id|area
)paren
(brace
r_int
id|m
suffix:semicolon
multiline_comment|/* bytes per pixel */
r_if
c_cond
(paren
id|cinfo-&gt;info-&gt;var.bits_per_pixel
op_eq
l_int|1
)paren
(brace
id|cirrusfb_BitBLT
c_func
(paren
id|cinfo-&gt;regbase
comma
id|cinfo-&gt;info-&gt;var.bits_per_pixel
comma
id|area-&gt;sx
op_div
l_int|8
comma
id|area-&gt;sy
comma
id|area-&gt;dx
op_div
l_int|8
comma
id|area-&gt;dy
comma
id|area-&gt;width
op_div
l_int|8
comma
id|area-&gt;height
comma
id|cinfo-&gt;currentmode.line_length
)paren
suffix:semicolon
)brace
r_else
(brace
id|m
op_assign
(paren
id|cinfo-&gt;info-&gt;var.bits_per_pixel
op_plus
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
id|cirrusfb_BitBLT
c_func
(paren
id|cinfo-&gt;regbase
comma
id|cinfo-&gt;info-&gt;var.bits_per_pixel
comma
id|area-&gt;sx
op_star
id|m
comma
id|area-&gt;sy
comma
id|area-&gt;dx
op_star
id|m
comma
id|area-&gt;dy
comma
id|area-&gt;width
op_star
id|m
comma
id|area-&gt;height
comma
id|cinfo-&gt;currentmode.line_length
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|cirrusfb_copyarea
r_void
id|cirrusfb_copyarea
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_copyarea
op_star
id|area
)paren
(brace
r_struct
id|cirrusfb_info
op_star
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_struct
id|fb_copyarea
id|modded
suffix:semicolon
id|u32
id|vxres
comma
id|vyres
suffix:semicolon
id|modded.sx
op_assign
id|area-&gt;sx
suffix:semicolon
id|modded.sy
op_assign
id|area-&gt;sy
suffix:semicolon
id|modded.dx
op_assign
id|area-&gt;dx
suffix:semicolon
id|modded.dy
op_assign
id|area-&gt;dy
suffix:semicolon
id|modded.width
op_assign
id|area-&gt;width
suffix:semicolon
id|modded.height
op_assign
id|area-&gt;height
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;state
op_ne
id|FBINFO_STATE_RUNNING
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|FBINFO_HWACCEL_DISABLED
)paren
(brace
id|cfb_copyarea
c_func
(paren
id|info
comma
id|area
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|vxres
op_assign
id|info-&gt;var.xres_virtual
suffix:semicolon
id|vyres
op_assign
id|info-&gt;var.yres_virtual
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|modded.width
op_logical_or
op_logical_neg
id|modded.height
op_logical_or
id|modded.sx
op_ge
id|vxres
op_logical_or
id|modded.sy
op_ge
id|vyres
op_logical_or
id|modded.dx
op_ge
id|vxres
op_logical_or
id|modded.dy
op_ge
id|vyres
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|modded.sx
op_plus
id|modded.width
OG
id|vxres
)paren
(brace
id|modded.width
op_assign
id|vxres
op_minus
id|modded.sx
suffix:semicolon
)brace
r_if
c_cond
(paren
id|modded.dx
op_plus
id|modded.width
OG
id|vxres
)paren
(brace
id|modded.width
op_assign
id|vxres
op_minus
id|modded.dx
suffix:semicolon
)brace
r_if
c_cond
(paren
id|modded.sy
op_plus
id|modded.height
OG
id|vyres
)paren
(brace
id|modded.height
op_assign
id|vyres
op_minus
id|modded.sy
suffix:semicolon
)brace
r_if
c_cond
(paren
id|modded.dy
op_plus
id|modded.height
OG
id|vyres
)paren
(brace
id|modded.height
op_assign
id|vyres
op_minus
id|modded.dy
suffix:semicolon
)brace
id|cirrusfb_prim_copyarea
c_func
(paren
id|cinfo
comma
op_amp
id|modded
)paren
suffix:semicolon
)brace
DECL|function|cirrusfb_imageblit
r_void
id|cirrusfb_imageblit
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_image
op_star
id|image
)paren
(brace
r_struct
id|cirrusfb_info
op_star
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
id|cirrusfb_WaitBLT
c_func
(paren
id|cinfo-&gt;regbase
)paren
suffix:semicolon
id|cfb_imageblit
c_func
(paren
id|info
comma
id|image
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PPC_PREP
DECL|macro|PREP_VIDEO_BASE
mdefine_line|#define PREP_VIDEO_BASE ((volatile unsigned long) 0xC0000000)
DECL|macro|PREP_IO_BASE
mdefine_line|#define PREP_IO_BASE    ((volatile unsigned char *) 0x80000000)
DECL|function|get_prep_addrs
r_static
r_void
id|get_prep_addrs
(paren
r_int
r_int
op_star
id|display
comma
r_int
r_int
op_star
id|registers
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|display
op_assign
id|PREP_VIDEO_BASE
suffix:semicolon
op_star
id|registers
op_assign
(paren
r_int
r_int
)paren
id|PREP_IO_BASE
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_PPC_PREP */
macro_line|#ifdef CONFIG_PCI
DECL|variable|release_io_ports
r_static
r_int
id|release_io_ports
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pulled the logic from XFree86 Cirrus driver to get the memory size,&n; * based on the DRAM bandwidth bit and DRAM bank switching bit.  This&n; * works with 1MB, 2MB and 4MB configurations (which the Motorola boards&n; * seem to have. */
DECL|function|cirrusfb_get_memsize
r_static
r_int
r_int
id|cirrusfb_get_memsize
(paren
id|u8
id|__iomem
op_star
id|regbase
)paren
(brace
r_int
r_int
id|mem
suffix:semicolon
r_int
r_char
id|SRF
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|SRF
op_assign
id|vga_rseq
(paren
id|regbase
comma
id|CL_SEQRF
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|SRF
op_amp
l_int|0x18
)paren
)paren
(brace
r_case
l_int|0x08
suffix:colon
id|mem
op_assign
l_int|512
op_star
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x10
suffix:colon
id|mem
op_assign
l_int|1024
op_star
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 64-bit DRAM data bus width; assume 2MB. Also indicates 2MB memory&n;&t;&t;   * on the 5430. */
r_case
l_int|0x18
suffix:colon
id|mem
op_assign
l_int|2048
op_star
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;CLgenfb: Unknown memory size!&bslash;n&quot;
)paren
suffix:semicolon
id|mem
op_assign
l_int|1024
op_star
l_int|1024
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SRF
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* If DRAM bank switching is enabled, there must be twice as much&n;&t;&t;   * memory installed. (4MB on the 5434) */
id|mem
op_mul_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* TODO: Handling of GD5446/5480 (see XF86 sources ...) */
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|mem
suffix:semicolon
)brace
DECL|function|get_pci_addrs
r_static
r_void
id|get_pci_addrs
(paren
r_const
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_int
op_star
id|display
comma
r_int
r_int
op_star
id|registers
)paren
(brace
m_assert
(paren
id|pdev
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|display
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|registers
op_ne
l_int|NULL
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|display
op_assign
l_int|0
suffix:semicolon
op_star
id|registers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This is a best-guess for now */
r_if
c_cond
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|IORESOURCE_IO
)paren
(brace
op_star
id|display
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
op_star
id|registers
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|display
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
op_star
id|registers
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
)brace
m_assert
(paren
op_star
id|display
op_ne
l_int|0
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|cirrusfb_pci_unmap
r_static
r_void
id|cirrusfb_pci_unmap
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|cinfo-&gt;pdev
suffix:semicolon
id|iounmap
c_func
(paren
id|cinfo-&gt;fbmem
)paren
suffix:semicolon
macro_line|#if 0 /* if system didn&squot;t claim this region, we would... */
id|release_mem_region
c_func
(paren
l_int|0xA0000
comma
l_int|65535
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|release_io_ports
)paren
id|release_region
c_func
(paren
l_int|0x3C0
comma
l_int|32
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|framebuffer_release
c_func
(paren
id|cinfo-&gt;info
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PCI */
macro_line|#ifdef CONFIG_ZORRO
DECL|function|cirrusfb_zorro_unmap
r_static
r_void
id|__devexit
id|cirrusfb_zorro_unmap
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
)paren
(brace
id|zorro_release_device
c_func
(paren
id|cinfo-&gt;zdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO4
)paren
(brace
id|cinfo-&gt;regbase
op_sub_assign
l_int|0x600000
suffix:semicolon
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|cinfo-&gt;regbase
)paren
suffix:semicolon
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|cinfo-&gt;fbmem
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|zorro_resource_start
c_func
(paren
id|cinfo-&gt;zdev
)paren
OG
l_int|0x01000000
)paren
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|cinfo-&gt;fbmem
)paren
suffix:semicolon
)brace
id|framebuffer_release
c_func
(paren
id|cinfo-&gt;info
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ZORRO */
DECL|function|cirrusfb_set_fbinfo
r_static
r_int
id|cirrusfb_set_fbinfo
c_func
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|cinfo-&gt;info
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|info-&gt;var
suffix:semicolon
id|info-&gt;par
op_assign
id|cinfo
suffix:semicolon
id|info-&gt;pseudo_palette
op_assign
id|cinfo-&gt;pseudo_palette
suffix:semicolon
id|info-&gt;flags
op_assign
id|FBINFO_DEFAULT
op_or
id|FBINFO_HWACCEL_XPAN
op_or
id|FBINFO_HWACCEL_YPAN
op_or
id|FBINFO_HWACCEL_FILLRECT
op_or
id|FBINFO_HWACCEL_COPYAREA
suffix:semicolon
r_if
c_cond
(paren
id|noaccel
)paren
id|info-&gt;flags
op_or_assign
id|FBINFO_HWACCEL_DISABLED
suffix:semicolon
id|info-&gt;fbops
op_assign
op_amp
id|cirrusfb_ops
suffix:semicolon
id|info-&gt;screen_base
op_assign
id|cinfo-&gt;fbmem
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_GD5480
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|16
)paren
id|info-&gt;screen_base
op_add_assign
l_int|1
op_star
id|MB_
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|24
op_logical_or
id|var-&gt;bits_per_pixel
op_eq
l_int|32
)paren
id|info-&gt;screen_base
op_add_assign
l_int|2
op_star
id|MB_
suffix:semicolon
)brace
multiline_comment|/* Fill fix common fields */
id|strlcpy
c_func
(paren
id|info-&gt;fix.id
comma
id|cirrusfb_board_info
(braket
id|cinfo-&gt;btype
)braket
dot
id|name
comma
r_sizeof
(paren
id|info-&gt;fix.id
)paren
)paren
suffix:semicolon
multiline_comment|/* monochrome: only 1 memory plane */
multiline_comment|/* 8 bit and above: Use whole memory area */
id|info-&gt;fix.smem_start
op_assign
id|cinfo-&gt;fbmem_phys
suffix:semicolon
id|info-&gt;fix.smem_len
op_assign
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|1
)paren
ques
c_cond
id|cinfo-&gt;size
op_div
l_int|4
suffix:colon
id|cinfo-&gt;size
suffix:semicolon
id|info-&gt;fix.type
op_assign
id|cinfo-&gt;currentmode.type
suffix:semicolon
id|info-&gt;fix.type_aux
op_assign
l_int|0
suffix:semicolon
id|info-&gt;fix.visual
op_assign
id|cinfo-&gt;currentmode.visual
suffix:semicolon
id|info-&gt;fix.xpanstep
op_assign
l_int|1
suffix:semicolon
id|info-&gt;fix.ypanstep
op_assign
l_int|1
suffix:semicolon
id|info-&gt;fix.ywrapstep
op_assign
l_int|0
suffix:semicolon
id|info-&gt;fix.line_length
op_assign
id|cinfo-&gt;currentmode.line_length
suffix:semicolon
multiline_comment|/* FIXME: map region at 0xB8000 if available, fill in here */
id|info-&gt;fix.mmio_start
op_assign
id|cinfo-&gt;fbregs_phys
suffix:semicolon
id|info-&gt;fix.mmio_len
op_assign
l_int|0
suffix:semicolon
id|info-&gt;fix.accel
op_assign
id|FB_ACCEL_NONE
suffix:semicolon
id|fb_alloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
comma
l_int|256
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cirrusfb_register
r_static
r_int
id|cirrusfb_register
c_func
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
)paren
(brace
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_int
id|err
suffix:semicolon
id|cirrusfb_board_t
id|btype
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;cirrusfb: Driver for Cirrus Logic based graphic boards, v&quot;
id|CIRRUSFB_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|info
op_assign
id|cinfo-&gt;info
suffix:semicolon
id|btype
op_assign
id|cinfo-&gt;btype
suffix:semicolon
multiline_comment|/* sanity checks */
m_assert
(paren
id|btype
op_ne
id|BT_NONE
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;cirrusfb: (RAM start set to: 0x%p)&bslash;n&quot;
comma
id|cinfo-&gt;fbmem
)paren
suffix:semicolon
multiline_comment|/* Make pretend we&squot;ve set the var so our structures are in a &quot;good&quot; */
multiline_comment|/* state, even though we haven&squot;t written the mode to the hw yet...  */
id|info-&gt;var
op_assign
id|cirrusfb_predefined
(braket
id|cirrusfb_def_mode
)braket
dot
id|var
suffix:semicolon
id|info-&gt;var.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|err
op_assign
id|cirrusfb_decode_var
c_func
(paren
op_amp
id|info-&gt;var
comma
op_amp
id|cinfo-&gt;currentmode
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
multiline_comment|/* should never happen */
id|DPRINTK
c_func
(paren
l_string|&quot;choking on default var... umm, no good.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_unmap_cirrusfb
suffix:semicolon
)brace
multiline_comment|/* set all the vital stuff */
id|cirrusfb_set_fbinfo
c_func
(paren
id|cinfo
)paren
suffix:semicolon
id|err
op_assign
id|register_framebuffer
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;cirrusfb: could not register fb device; err = %d!&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_goto
id|err_dealloc_cmap
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_dealloc_cmap
suffix:colon
id|fb_dealloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
)paren
suffix:semicolon
id|err_unmap_cirrusfb
suffix:colon
id|cinfo
op_member_access_from_pointer
id|unmap
c_func
(paren
id|cinfo
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|cirrusfb_cleanup
r_static
r_void
id|__devexit
id|cirrusfb_cleanup
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|cirrusfb_info
op_star
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|switch_monitor
(paren
id|cinfo
comma
l_int|0
)paren
suffix:semicolon
id|unregister_framebuffer
(paren
id|info
)paren
suffix:semicolon
id|fb_dealloc_cmap
(paren
op_amp
id|info-&gt;cmap
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;Framebuffer unregistered&bslash;n&quot;
)paren
suffix:semicolon
id|cinfo
op_member_access_from_pointer
id|unmap
c_func
(paren
id|cinfo
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PCI
DECL|function|cirrusfb_pci_register
r_static
r_int
id|cirrusfb_pci_register
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|cirrusfb_info
op_star
id|cinfo
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
id|cirrusfb_board_t
id|btype
suffix:semicolon
r_int
r_int
id|board_addr
comma
id|board_size
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cirrusfb: Cannot enable PCI device&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|info
op_assign
id|framebuffer_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|cirrusfb_info
)paren
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cirrusfb: could not allocate memory&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_disable
suffix:semicolon
)brace
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
id|cinfo-&gt;info
op_assign
id|info
suffix:semicolon
id|cinfo-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|cinfo-&gt;btype
op_assign
id|btype
op_assign
(paren
id|cirrusfb_board_t
)paren
id|ent-&gt;driver_data
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot; Found PCI device, base address 0 is 0x%lx, btype set to %d&bslash;n&quot;
comma
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|btype
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot; base address 1 is 0x%lx&bslash;n&quot;
comma
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isPReP
)paren
(brace
id|pci_write_config_dword
(paren
id|pdev
comma
id|PCI_BASE_ADDRESS_0
comma
l_int|0x00000000
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PPC_PREP
id|get_prep_addrs
(paren
op_amp
id|board_addr
comma
op_amp
id|cinfo-&gt;fbregs_phys
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* PReP dies if we ioremap the IO registers, but it works w/out... */
id|cinfo-&gt;regbase
op_assign
(paren
r_char
id|__iomem
op_star
)paren
id|cinfo-&gt;fbregs_phys
suffix:semicolon
)brace
r_else
(brace
id|DPRINTK
(paren
l_string|&quot;Attempt to get PCI info for Cirrus Graphics Card&bslash;n&quot;
)paren
suffix:semicolon
id|get_pci_addrs
(paren
id|pdev
comma
op_amp
id|board_addr
comma
op_amp
id|cinfo-&gt;fbregs_phys
)paren
suffix:semicolon
id|cinfo-&gt;regbase
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* FIXME: this forces VGA.  alternatives? */
)brace
id|DPRINTK
(paren
l_string|&quot;Board address: 0x%lx, register address: 0x%lx&bslash;n&quot;
comma
id|board_addr
comma
id|cinfo-&gt;fbregs_phys
)paren
suffix:semicolon
id|board_size
op_assign
(paren
id|btype
op_eq
id|BT_GD5480
)paren
ques
c_cond
l_int|32
op_star
id|MB_
suffix:colon
id|cirrusfb_get_memsize
(paren
id|cinfo-&gt;regbase
)paren
suffix:semicolon
id|ret
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
l_string|&quot;cirrusfb&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cirrusfb: cannot reserve region 0x%lx, abort&bslash;n&quot;
comma
id|board_addr
)paren
suffix:semicolon
r_goto
id|err_release_fb
suffix:semicolon
)brace
macro_line|#if 0 /* if the system didn&squot;t claim this region, we would... */
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
l_int|0xA0000
comma
l_int|65535
comma
l_string|&quot;cirrusfb&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cirrusfb: cannot reserve region 0x%lx, abort&bslash;n&quot;
comma
l_int|0xA0000L
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err_release_regions
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|request_region
c_func
(paren
l_int|0x3C0
comma
l_int|32
comma
l_string|&quot;cirrusfb&quot;
)paren
)paren
id|release_io_ports
op_assign
l_int|1
suffix:semicolon
id|cinfo-&gt;fbmem
op_assign
id|ioremap
c_func
(paren
id|board_addr
comma
id|board_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cinfo-&gt;fbmem
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_release_legacy
suffix:semicolon
)brace
id|cinfo-&gt;fbmem_phys
op_assign
id|board_addr
suffix:semicolon
id|cinfo-&gt;size
op_assign
id|board_size
suffix:semicolon
id|cinfo-&gt;unmap
op_assign
id|cirrusfb_pci_unmap
suffix:semicolon
id|printk
(paren
l_string|&quot; RAM (%lu kB) at 0xx%lx, &quot;
comma
id|cinfo-&gt;size
op_div
id|KB_
comma
id|board_addr
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;Cirrus Logic chipset on PCI bus&bslash;n&quot;
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|info
)paren
suffix:semicolon
r_return
id|cirrusfb_register
c_func
(paren
id|cinfo
)paren
suffix:semicolon
id|err_release_legacy
suffix:colon
r_if
c_cond
(paren
id|release_io_ports
)paren
id|release_region
c_func
(paren
l_int|0x3C0
comma
l_int|32
)paren
suffix:semicolon
macro_line|#if 0
id|release_mem_region
c_func
(paren
l_int|0xA0000
comma
l_int|65535
)paren
suffix:semicolon
id|err_release_regions
suffix:colon
macro_line|#endif
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_release_fb
suffix:colon
id|framebuffer_release
c_func
(paren
id|info
)paren
suffix:semicolon
id|err_disable
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|cirrusfb_pci_unregister
r_void
id|__devexit
id|cirrusfb_pci_unregister
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|cirrusfb_cleanup
(paren
id|info
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|cirrusfb_pci_driver
r_static
r_struct
id|pci_driver
id|cirrusfb_pci_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;cirrusfb&quot;
comma
dot
id|id_table
op_assign
id|cirrusfb_pci_table
comma
dot
id|probe
op_assign
id|cirrusfb_pci_register
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|cirrusfb_pci_unregister
)paren
comma
macro_line|#ifdef CONFIG_PM
macro_line|#if 0
dot
id|suspend
op_assign
id|cirrusfb_pci_suspend
comma
dot
id|resume
op_assign
id|cirrusfb_pci_resume
comma
macro_line|#endif
macro_line|#endif
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PCI */
macro_line|#ifdef CONFIG_ZORRO
DECL|function|cirrusfb_zorro_register
r_static
r_int
id|cirrusfb_zorro_register
c_func
(paren
r_struct
id|zorro_dev
op_star
id|z
comma
r_const
r_struct
id|zorro_device_id
op_star
id|ent
)paren
(brace
r_struct
id|cirrusfb_info
op_star
id|cinfo
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
id|cirrusfb_board_t
id|btype
suffix:semicolon
r_struct
id|zorro_dev
op_star
id|z2
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|board_addr
comma
id|board_size
comma
id|size
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|btype
op_assign
id|ent-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|cirrusfb_zorro_table2
(braket
id|btype
)braket
dot
id|id2
)paren
id|z2
op_assign
id|zorro_find_device
c_func
(paren
id|cirrusfb_zorro_table2
(braket
id|btype
)braket
dot
id|id2
comma
l_int|NULL
)paren
suffix:semicolon
id|size
op_assign
id|cirrusfb_zorro_table2
(braket
id|btype
)braket
dot
id|size
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cirrusfb: %s board detected; &quot;
comma
id|cirrusfb_board_info
(braket
id|btype
)braket
dot
id|name
)paren
suffix:semicolon
id|info
op_assign
id|framebuffer_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|cirrusfb_info
)paren
comma
op_amp
id|z-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;cirrusfb: could not allocate memory&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|cinfo
op_assign
id|info-&gt;par
suffix:semicolon
id|cinfo-&gt;info
op_assign
id|info
suffix:semicolon
id|cinfo-&gt;btype
op_assign
id|btype
suffix:semicolon
m_assert
(paren
id|z
OG
l_int|0
)paren
suffix:semicolon
m_assert
(paren
id|z2
op_ge
l_int|0
)paren
suffix:semicolon
m_assert
(paren
id|btype
op_ne
id|BT_NONE
)paren
suffix:semicolon
id|cinfo-&gt;zdev
op_assign
id|z
suffix:semicolon
id|board_addr
op_assign
id|zorro_resource_start
c_func
(paren
id|z
)paren
suffix:semicolon
id|board_size
op_assign
id|zorro_resource_len
c_func
(paren
id|z
)paren
suffix:semicolon
id|cinfo-&gt;size
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zorro_request_device
c_func
(paren
id|z
comma
l_string|&quot;cirrusfb&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cirrusfb: cannot reserve region 0x%lx, abort&bslash;n&quot;
comma
id|board_addr
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err_release_fb
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot; RAM (%lu MB) at $%lx, &quot;
comma
id|board_size
op_div
id|MB_
comma
id|board_addr
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|btype
op_eq
id|BT_PICASSO4
)paren
(brace
id|printk
(paren
l_string|&quot; REG at $%lx&bslash;n&quot;
comma
id|board_addr
op_plus
l_int|0x600000
)paren
suffix:semicolon
multiline_comment|/* To be precise, for the P4 this is not the */
multiline_comment|/* begin of the board, but the begin of RAM. */
multiline_comment|/* for P4, map in its address space in 2 chunks (### TEST! ) */
multiline_comment|/* (note the ugly hardcoded 16M number) */
id|cinfo-&gt;regbase
op_assign
id|ioremap
(paren
id|board_addr
comma
l_int|16777216
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cinfo-&gt;regbase
)paren
r_goto
id|err_release_region
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;cirrusfb: Virtual address for board set to: $%p&bslash;n&quot;
comma
id|cinfo-&gt;regbase
)paren
suffix:semicolon
id|cinfo-&gt;regbase
op_add_assign
l_int|0x600000
suffix:semicolon
id|cinfo-&gt;fbregs_phys
op_assign
id|board_addr
op_plus
l_int|0x600000
suffix:semicolon
id|cinfo-&gt;fbmem_phys
op_assign
id|board_addr
op_plus
l_int|16777216
suffix:semicolon
id|cinfo-&gt;fbmem
op_assign
id|ioremap
(paren
id|cinfo-&gt;fbmem_phys
comma
l_int|16777216
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cinfo-&gt;fbmem
)paren
r_goto
id|err_unmap_regbase
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot; REG at $%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|z2-&gt;resource.start
)paren
suffix:semicolon
id|cinfo-&gt;fbmem_phys
op_assign
id|board_addr
suffix:semicolon
r_if
c_cond
(paren
id|board_addr
OG
l_int|0x01000000
)paren
id|cinfo-&gt;fbmem
op_assign
id|ioremap
(paren
id|board_addr
comma
id|board_size
)paren
suffix:semicolon
r_else
id|cinfo-&gt;fbmem
op_assign
(paren
id|caddr_t
)paren
id|ZTWO_VADDR
(paren
id|board_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cinfo-&gt;fbmem
)paren
r_goto
id|err_release_region
suffix:semicolon
multiline_comment|/* set address for REG area of board */
id|cinfo-&gt;regbase
op_assign
(paren
id|caddr_t
)paren
id|ZTWO_VADDR
(paren
id|z2-&gt;resource.start
)paren
suffix:semicolon
id|cinfo-&gt;fbregs_phys
op_assign
id|z2-&gt;resource.start
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;cirrusfb: Virtual address for board set to: $%p&bslash;n&quot;
comma
id|cinfo-&gt;regbase
)paren
suffix:semicolon
)brace
id|cinfo-&gt;unmap
op_assign
id|cirrusfb_zorro_unmap
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;Cirrus Logic chipset on Zorro bus&bslash;n&quot;
)paren
suffix:semicolon
id|zorro_set_drvdata
c_func
(paren
id|z
comma
id|info
)paren
suffix:semicolon
r_return
id|cirrusfb_register
c_func
(paren
id|cinfo
)paren
suffix:semicolon
id|err_unmap_regbase
suffix:colon
multiline_comment|/* Parental advisory: explicit hack */
id|iounmap
c_func
(paren
id|cinfo-&gt;regbase
op_minus
l_int|0x600000
)paren
suffix:semicolon
id|err_release_region
suffix:colon
id|release_region
c_func
(paren
id|board_addr
comma
id|board_size
)paren
suffix:semicolon
id|err_release_fb
suffix:colon
id|framebuffer_release
c_func
(paren
id|info
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|cirrusfb_zorro_unregister
r_void
id|__devexit
id|cirrusfb_zorro_unregister
c_func
(paren
r_struct
id|zorro_dev
op_star
id|z
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|zorro_get_drvdata
c_func
(paren
id|z
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|cirrusfb_cleanup
(paren
id|info
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|cirrusfb_zorro_driver
r_static
r_struct
id|zorro_driver
id|cirrusfb_zorro_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;cirrusfb&quot;
comma
dot
id|id_table
op_assign
id|cirrusfb_zorro_table
comma
dot
id|probe
op_assign
id|cirrusfb_zorro_register
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|cirrusfb_zorro_unregister
)paren
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_ZORRO */
DECL|function|cirrusfb_init
r_int
id|__init
id|cirrusfb_init
c_func
(paren
r_void
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef MODULE
r_char
op_star
id|option
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|fb_get_options
c_func
(paren
l_string|&quot;cirrusfb&quot;
comma
op_amp
id|option
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|cirrusfb_setup
c_func
(paren
id|option
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ZORRO
id|error
op_or_assign
id|zorro_module_init
c_func
(paren
op_amp
id|cirrusfb_zorro_driver
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PCI
id|error
op_or_assign
id|pci_module_init
c_func
(paren
op_amp
id|cirrusfb_pci_driver
)paren
suffix:semicolon
macro_line|#endif
r_return
id|error
suffix:semicolon
)brace
macro_line|#ifndef MODULE
DECL|function|cirrusfb_setup
r_int
id|__init
id|cirrusfb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
comma
id|s
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;cirrusfb_setup: option &squot;%s&squot;&bslash;n&quot;
comma
id|this_opt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_TOTAL_MODES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
(paren
id|s
comma
l_string|&quot;mode:%s&quot;
comma
id|cirrusfb_predefined
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
(paren
id|this_opt
comma
id|s
)paren
op_eq
l_int|0
)paren
id|cirrusfb_def_mode
op_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;noaccel&quot;
)paren
)paren
id|noaccel
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;     *  Modularization&n;     */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Copyright 1999,2000 Jeff Garzik &lt;jgarzik@pobox.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Accelerated FBDev driver for Cirrus Logic chips&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|function|cirrusfb_exit
r_void
id|__exit
id|cirrusfb_exit
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PCI
id|pci_unregister_driver
c_func
(paren
op_amp
id|cirrusfb_pci_driver
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ZORRO
id|zorro_unregister_driver
c_func
(paren
op_amp
id|cirrusfb_zorro_driver
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|cirrusfb_init
id|module_init
c_func
(paren
id|cirrusfb_init
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|cirrusfb_exit
id|module_exit
c_func
(paren
id|cirrusfb_exit
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/**********************************************************************/
multiline_comment|/* about the following functions - I have used the same names for the */
multiline_comment|/* functions as Markus Wild did in his Retina driver for NetBSD as    */
multiline_comment|/* they just made sense for this purpose. Apart from that, I wrote    */
multiline_comment|/* these functions myself.                                            */
multiline_comment|/**********************************************************************/
multiline_comment|/*** WGen() - write into one of the external/general registers ***/
DECL|function|WGen
r_static
r_void
id|WGen
(paren
r_const
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
id|regnum
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_int
id|regofs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
multiline_comment|/* Picasso II specific hack */
multiline_comment|/*              if (regnum == VGA_PEL_IR || regnum == VGA_PEL_D || regnum == CL_VSSM2) */
r_if
c_cond
(paren
id|regnum
op_eq
id|VGA_PEL_IR
op_logical_or
id|regnum
op_eq
id|VGA_PEL_D
)paren
id|regofs
op_assign
l_int|0xfff
suffix:semicolon
)brace
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|regofs
op_plus
id|regnum
comma
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/*** RGen() - read out one of the external/general registers ***/
DECL|function|RGen
r_static
r_int
r_char
id|RGen
(paren
r_const
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
id|regnum
)paren
(brace
r_int
r_int
id|regofs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
multiline_comment|/* Picasso II specific hack */
multiline_comment|/*              if (regnum == VGA_PEL_IR || regnum == VGA_PEL_D || regnum == CL_VSSM2) */
r_if
c_cond
(paren
id|regnum
op_eq
id|VGA_PEL_IR
op_logical_or
id|regnum
op_eq
id|VGA_PEL_D
)paren
id|regofs
op_assign
l_int|0xfff
suffix:semicolon
)brace
r_return
id|vga_r
(paren
id|cinfo-&gt;regbase
comma
id|regofs
op_plus
id|regnum
)paren
suffix:semicolon
)brace
multiline_comment|/*** AttrOn() - turn on VideoEnable for Attribute controller ***/
DECL|function|AttrOn
r_static
r_void
id|AttrOn
(paren
r_const
r_struct
id|cirrusfb_info
op_star
id|cinfo
)paren
(brace
m_assert
(paren
id|cinfo
op_ne
l_int|NULL
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vga_rcrt
(paren
id|cinfo-&gt;regbase
comma
id|CL_CRT24
)paren
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* if we&squot;re just in &quot;write value&quot; mode, write back the */
multiline_comment|/* same value as before to not modify anything */
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATT_IW
comma
id|vga_r
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATT_R
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* turn on video bit */
multiline_comment|/*      vga_w (cinfo-&gt;regbase, VGA_ATT_IW, 0x20); */
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATT_IW
comma
l_int|0x33
)paren
suffix:semicolon
multiline_comment|/* dummy write on Reg0 to be on &quot;write index&quot; mode next time */
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|VGA_ATT_IW
comma
l_int|0x00
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*** WHDR() - write into the Hidden DAC register ***/
multiline_comment|/* as the HDR is the only extension register that requires special treatment&n; * (the other extension registers are accessible just like the &quot;ordinary&quot;&n; * registers of their functional group) here is a specialized routine for&n; * accessing the HDR&n; */
DECL|function|WHDR
r_static
r_void
id|WHDR
(paren
r_const
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_char
id|dummy
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
multiline_comment|/* Klaus&squot; hint for correct access to HDR on some boards */
multiline_comment|/* first write 0 to pixel mask (3c6) */
id|WGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
comma
l_int|0x00
)paren
suffix:semicolon
id|udelay
(paren
l_int|200
)paren
suffix:semicolon
multiline_comment|/* next read dummy from pixel address (3c8) */
id|dummy
op_assign
id|RGen
(paren
id|cinfo
comma
id|VGA_PEL_IW
)paren
suffix:semicolon
id|udelay
(paren
l_int|200
)paren
suffix:semicolon
)brace
multiline_comment|/* now do the usual stuff to access the HDR */
id|dummy
op_assign
id|RGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
)paren
suffix:semicolon
id|udelay
(paren
l_int|200
)paren
suffix:semicolon
id|dummy
op_assign
id|RGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
)paren
suffix:semicolon
id|udelay
(paren
l_int|200
)paren
suffix:semicolon
id|dummy
op_assign
id|RGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
)paren
suffix:semicolon
id|udelay
(paren
l_int|200
)paren
suffix:semicolon
id|dummy
op_assign
id|RGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
)paren
suffix:semicolon
id|udelay
(paren
l_int|200
)paren
suffix:semicolon
id|WGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
comma
id|val
)paren
suffix:semicolon
id|udelay
(paren
l_int|200
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
multiline_comment|/* now first reset HDR access counter */
id|dummy
op_assign
id|RGen
(paren
id|cinfo
comma
id|VGA_PEL_IW
)paren
suffix:semicolon
id|udelay
(paren
l_int|200
)paren
suffix:semicolon
multiline_comment|/* and at the end, restore the mask value */
multiline_comment|/* ## is this mask always 0xff? */
id|WGen
(paren
id|cinfo
comma
id|VGA_PEL_MSK
comma
l_int|0xff
)paren
suffix:semicolon
id|udelay
(paren
l_int|200
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*** WSFR() - write to the &quot;special function register&quot; (SFR) ***/
DECL|function|WSFR
r_static
r_void
id|WSFR
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
r_char
id|val
)paren
(brace
macro_line|#ifdef CONFIG_ZORRO
m_assert
(paren
id|cinfo-&gt;regbase
op_ne
l_int|NULL
)paren
suffix:semicolon
id|cinfo-&gt;SFR
op_assign
id|val
suffix:semicolon
id|z_writeb
(paren
id|val
comma
id|cinfo-&gt;regbase
op_plus
l_int|0x8000
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* The Picasso has a second register for switching the monitor bit */
DECL|function|WSFR2
r_static
r_void
id|WSFR2
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
r_char
id|val
)paren
(brace
macro_line|#ifdef CONFIG_ZORRO
multiline_comment|/* writing an arbitrary value to this one causes the monitor switcher */
multiline_comment|/* to flip to Amiga display */
m_assert
(paren
id|cinfo-&gt;regbase
op_ne
l_int|NULL
)paren
suffix:semicolon
id|cinfo-&gt;SFR
op_assign
id|val
suffix:semicolon
id|z_writeb
(paren
id|val
comma
id|cinfo-&gt;regbase
op_plus
l_int|0x9000
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*** WClut - set CLUT entry (range: 0..63) ***/
DECL|function|WClut
r_static
r_void
id|WClut
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
r_char
id|regnum
comma
r_int
r_char
id|red
comma
r_int
r_char
id|green
comma
r_int
r_char
id|blue
)paren
(brace
r_int
r_int
id|data
op_assign
id|VGA_PEL_D
suffix:semicolon
multiline_comment|/* address write mode register is not translated.. */
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|VGA_PEL_IW
comma
id|regnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO
op_logical_or
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO4
op_logical_or
id|cinfo-&gt;btype
op_eq
id|BT_ALPINE
op_logical_or
id|cinfo-&gt;btype
op_eq
id|BT_GD5480
)paren
(brace
multiline_comment|/* but DAC data register IS, at least for Picasso II */
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO
)paren
id|data
op_add_assign
l_int|0xfff
suffix:semicolon
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|data
comma
id|red
)paren
suffix:semicolon
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|data
comma
id|green
)paren
suffix:semicolon
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|data
comma
id|blue
)paren
suffix:semicolon
)brace
r_else
(brace
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|data
comma
id|blue
)paren
suffix:semicolon
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|data
comma
id|green
)paren
suffix:semicolon
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|data
comma
id|red
)paren
suffix:semicolon
)brace
)brace
macro_line|#if 0
multiline_comment|/*** RClut - read CLUT entry (range 0..63) ***/
r_static
r_void
id|RClut
(paren
r_struct
id|cirrusfb_info
op_star
id|cinfo
comma
r_int
r_char
id|regnum
comma
r_int
r_char
op_star
id|red
comma
r_int
r_char
op_star
id|green
comma
r_int
r_char
op_star
id|blue
)paren
(brace
r_int
r_int
id|data
op_assign
id|VGA_PEL_D
suffix:semicolon
id|vga_w
(paren
id|cinfo-&gt;regbase
comma
id|VGA_PEL_IR
comma
id|regnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO
op_logical_or
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO4
op_logical_or
id|cinfo-&gt;btype
op_eq
id|BT_ALPINE
op_logical_or
id|cinfo-&gt;btype
op_eq
id|BT_GD5480
)paren
(brace
r_if
c_cond
(paren
id|cinfo-&gt;btype
op_eq
id|BT_PICASSO
)paren
id|data
op_add_assign
l_int|0xfff
suffix:semicolon
op_star
id|red
op_assign
id|vga_r
(paren
id|cinfo-&gt;regbase
comma
id|data
)paren
suffix:semicolon
op_star
id|green
op_assign
id|vga_r
(paren
id|cinfo-&gt;regbase
comma
id|data
)paren
suffix:semicolon
op_star
id|blue
op_assign
id|vga_r
(paren
id|cinfo-&gt;regbase
comma
id|data
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|blue
op_assign
id|vga_r
(paren
id|cinfo-&gt;regbase
comma
id|data
)paren
suffix:semicolon
op_star
id|green
op_assign
id|vga_r
(paren
id|cinfo-&gt;regbase
comma
id|data
)paren
suffix:semicolon
op_star
id|red
op_assign
id|vga_r
(paren
id|cinfo-&gt;regbase
comma
id|data
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*******************************************************************&n;&t;cirrusfb_WaitBLT()&n;&n;&t;Wait for the BitBLT engine to complete a possible earlier job&n;*********************************************************************/
multiline_comment|/* FIXME: use interrupts instead */
DECL|function|cirrusfb_WaitBLT
r_static
r_void
id|cirrusfb_WaitBLT
(paren
id|u8
id|__iomem
op_star
id|regbase
)paren
(brace
multiline_comment|/* now busy-wait until we&squot;re done */
r_while
c_loop
(paren
id|vga_rgfx
(paren
id|regbase
comma
id|CL_GR31
)paren
op_amp
l_int|0x08
)paren
multiline_comment|/* do nothing */
suffix:semicolon
)brace
multiline_comment|/*******************************************************************&n;&t;cirrusfb_BitBLT()&n;&n;&t;perform accelerated &quot;scrolling&quot;&n;********************************************************************/
DECL|function|cirrusfb_BitBLT
r_static
r_void
id|cirrusfb_BitBLT
(paren
id|u8
id|__iomem
op_star
id|regbase
comma
r_int
id|bits_per_pixel
comma
id|u_short
id|curx
comma
id|u_short
id|cury
comma
id|u_short
id|destx
comma
id|u_short
id|desty
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_short
id|line_length
)paren
(brace
id|u_short
id|nwidth
comma
id|nheight
suffix:semicolon
id|u_long
id|nsrc
comma
id|ndest
suffix:semicolon
id|u_char
id|bltmode
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|nwidth
op_assign
id|width
op_minus
l_int|1
suffix:semicolon
id|nheight
op_assign
id|height
op_minus
l_int|1
suffix:semicolon
id|bltmode
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* if source adr &lt; dest addr, do the Blt backwards */
r_if
c_cond
(paren
id|cury
op_le
id|desty
)paren
(brace
r_if
c_cond
(paren
id|cury
op_eq
id|desty
)paren
(brace
multiline_comment|/* if src and dest are on the same line, check x */
r_if
c_cond
(paren
id|curx
OL
id|destx
)paren
id|bltmode
op_or_assign
l_int|0x01
suffix:semicolon
)brace
r_else
id|bltmode
op_or_assign
l_int|0x01
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|bltmode
)paren
(brace
multiline_comment|/* standard case: forward blitting */
id|nsrc
op_assign
(paren
id|cury
op_star
id|line_length
)paren
op_plus
id|curx
suffix:semicolon
id|ndest
op_assign
(paren
id|desty
op_star
id|line_length
)paren
op_plus
id|destx
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* this means start addresses are at the end, counting backwards */
id|nsrc
op_assign
id|cury
op_star
id|line_length
op_plus
id|curx
op_plus
id|nheight
op_star
id|line_length
op_plus
id|nwidth
suffix:semicolon
id|ndest
op_assign
id|desty
op_star
id|line_length
op_plus
id|destx
op_plus
id|nheight
op_star
id|line_length
op_plus
id|nwidth
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   run-down of registers to be programmed:&n;&t;   destination pitch&n;&t;   source pitch&n;&t;   BLT width/height&n;&t;   source start&n;&t;   destination start&n;&t;   BLT mode&n;&t;   BLT ROP&n;&t;   VGA_GFX_SR_VALUE / VGA_GFX_SR_ENABLE: &quot;fill color&quot;&n;&t;   start/stop&n;&t; */
id|cirrusfb_WaitBLT
c_func
(paren
id|regbase
)paren
suffix:semicolon
multiline_comment|/* pitch: set to line_length */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR24
comma
id|line_length
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* dest pitch low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR25
comma
(paren
id|line_length
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* dest pitch hi */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR26
comma
id|line_length
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* source pitch low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR27
comma
(paren
id|line_length
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* source pitch hi */
multiline_comment|/* BLT width: actual number of pixels - 1 */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR20
comma
id|nwidth
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* BLT width low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR21
comma
(paren
id|nwidth
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT width hi */
multiline_comment|/* BLT height: actual number of lines -1 */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR22
comma
id|nheight
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* BLT height low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR23
comma
(paren
id|nheight
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT width hi */
multiline_comment|/* BLT destination */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR28
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR29
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest mid */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR2A
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest hi */
multiline_comment|/* BLT source */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR2C
comma
(paren
id|u_char
)paren
(paren
id|nsrc
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT src low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR2D
comma
(paren
id|u_char
)paren
(paren
id|nsrc
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT src mid */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR2E
comma
(paren
id|u_char
)paren
(paren
id|nsrc
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT src hi */
multiline_comment|/* BLT mode */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR30
comma
id|bltmode
)paren
suffix:semicolon
multiline_comment|/* BLT mode */
multiline_comment|/* BLT ROP: SrcCopy */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR32
comma
l_int|0x0d
)paren
suffix:semicolon
multiline_comment|/* BLT ROP */
multiline_comment|/* and finally: GO! */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR31
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* BLT Start/status */
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************&n;&t;cirrusfb_RectFill()&n;&n;&t;perform accelerated rectangle fill&n;********************************************************************/
DECL|function|cirrusfb_RectFill
r_static
r_void
id|cirrusfb_RectFill
(paren
id|u8
id|__iomem
op_star
id|regbase
comma
r_int
id|bits_per_pixel
comma
id|u_short
id|x
comma
id|u_short
id|y
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_char
id|color
comma
id|u_short
id|line_length
)paren
(brace
id|u_short
id|nwidth
comma
id|nheight
suffix:semicolon
id|u_long
id|ndest
suffix:semicolon
id|u_char
id|op
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|nwidth
op_assign
id|width
op_minus
l_int|1
suffix:semicolon
id|nheight
op_assign
id|height
op_minus
l_int|1
suffix:semicolon
id|ndest
op_assign
(paren
id|y
op_star
id|line_length
)paren
op_plus
id|x
suffix:semicolon
id|cirrusfb_WaitBLT
c_func
(paren
id|regbase
)paren
suffix:semicolon
multiline_comment|/* pitch: set to line_length */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR24
comma
id|line_length
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* dest pitch low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR25
comma
(paren
id|line_length
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* dest pitch hi */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR26
comma
id|line_length
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* source pitch low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR27
comma
(paren
id|line_length
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* source pitch hi */
multiline_comment|/* BLT width: actual number of pixels - 1 */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR20
comma
id|nwidth
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* BLT width low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR21
comma
(paren
id|nwidth
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT width hi */
multiline_comment|/* BLT height: actual number of lines -1 */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR22
comma
id|nheight
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* BLT height low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR23
comma
(paren
id|nheight
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT width hi */
multiline_comment|/* BLT destination */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR28
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR29
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest mid */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR2A
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest hi */
multiline_comment|/* BLT source: set to 0 (is a dummy here anyway) */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR2C
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* BLT src low */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR2D
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* BLT src mid */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR2E
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* BLT src hi */
multiline_comment|/* This is a ColorExpand Blt, using the */
multiline_comment|/* same color for foreground and background */
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_SR_VALUE
comma
id|color
)paren
suffix:semicolon
multiline_comment|/* foreground color */
id|vga_wgfx
(paren
id|regbase
comma
id|VGA_GFX_SR_ENABLE
comma
id|color
)paren
suffix:semicolon
multiline_comment|/* background color */
id|op
op_assign
l_int|0xc0
suffix:semicolon
r_if
c_cond
(paren
id|bits_per_pixel
op_eq
l_int|16
)paren
(brace
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR10
comma
id|color
)paren
suffix:semicolon
multiline_comment|/* foreground color */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR11
comma
id|color
)paren
suffix:semicolon
multiline_comment|/* background color */
id|op
op_assign
l_int|0x50
suffix:semicolon
id|op
op_assign
l_int|0xd0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bits_per_pixel
op_eq
l_int|32
)paren
(brace
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR10
comma
id|color
)paren
suffix:semicolon
multiline_comment|/* foreground color */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR11
comma
id|color
)paren
suffix:semicolon
multiline_comment|/* background color */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR12
comma
id|color
)paren
suffix:semicolon
multiline_comment|/* foreground color */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR13
comma
id|color
)paren
suffix:semicolon
multiline_comment|/* background color */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR14
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* foreground color */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR15
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* background color */
id|op
op_assign
l_int|0x50
suffix:semicolon
id|op
op_assign
l_int|0xf0
suffix:semicolon
)brace
multiline_comment|/* BLT mode: color expand, Enable 8x8 copy (faster?) */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR30
comma
id|op
)paren
suffix:semicolon
multiline_comment|/* BLT mode */
multiline_comment|/* BLT ROP: SrcCopy */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR32
comma
l_int|0x0d
)paren
suffix:semicolon
multiline_comment|/* BLT ROP */
multiline_comment|/* and finally: GO! */
id|vga_wgfx
(paren
id|regbase
comma
id|CL_GR31
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* BLT Start/status */
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * bestclock() - determine closest possible clock lower(?) than the&n; * desired pixel clock&n; **************************************************************************/
DECL|function|bestclock
r_static
r_void
id|bestclock
(paren
r_int
id|freq
comma
r_int
op_star
id|best
comma
r_int
op_star
id|nom
comma
r_int
op_star
id|den
comma
r_int
op_star
id|div
comma
r_int
id|maxfreq
)paren
(brace
r_int
id|n
comma
id|h
comma
id|d
comma
id|f
suffix:semicolon
m_assert
(paren
id|best
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|nom
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|den
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|div
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|maxfreq
OG
l_int|0
)paren
suffix:semicolon
op_star
id|nom
op_assign
l_int|0
suffix:semicolon
op_star
id|den
op_assign
l_int|0
suffix:semicolon
op_star
id|div
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freq
OL
l_int|8000
)paren
id|freq
op_assign
l_int|8000
suffix:semicolon
r_if
c_cond
(paren
id|freq
OG
id|maxfreq
)paren
id|freq
op_assign
id|maxfreq
suffix:semicolon
op_star
id|best
op_assign
l_int|0
suffix:semicolon
id|f
op_assign
id|freq
op_star
l_int|10
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|32
suffix:semicolon
id|n
OL
l_int|128
suffix:semicolon
id|n
op_increment
)paren
(brace
id|d
op_assign
(paren
l_int|143181
op_star
id|n
)paren
op_div
id|f
suffix:semicolon
r_if
c_cond
(paren
(paren
id|d
op_ge
l_int|7
)paren
op_logical_and
(paren
id|d
op_le
l_int|63
)paren
)paren
(brace
r_if
c_cond
(paren
id|d
OG
l_int|31
)paren
id|d
op_assign
(paren
id|d
op_div
l_int|2
)paren
op_star
l_int|2
suffix:semicolon
id|h
op_assign
(paren
l_int|14318
op_star
id|n
)paren
op_div
id|d
suffix:semicolon
r_if
c_cond
(paren
id|abs
(paren
id|h
op_minus
id|freq
)paren
OL
id|abs
(paren
op_star
id|best
op_minus
id|freq
)paren
)paren
(brace
op_star
id|best
op_assign
id|h
suffix:semicolon
op_star
id|nom
op_assign
id|n
suffix:semicolon
r_if
c_cond
(paren
id|d
OL
l_int|32
)paren
(brace
op_star
id|den
op_assign
id|d
suffix:semicolon
op_star
id|div
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|den
op_assign
id|d
op_div
l_int|2
suffix:semicolon
op_star
id|div
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
id|d
op_assign
(paren
(paren
l_int|143181
op_star
id|n
)paren
op_plus
id|f
op_minus
l_int|1
)paren
op_div
id|f
suffix:semicolon
r_if
c_cond
(paren
(paren
id|d
op_ge
l_int|7
)paren
op_logical_and
(paren
id|d
op_le
l_int|63
)paren
)paren
(brace
r_if
c_cond
(paren
id|d
OG
l_int|31
)paren
id|d
op_assign
(paren
id|d
op_div
l_int|2
)paren
op_star
l_int|2
suffix:semicolon
id|h
op_assign
(paren
l_int|14318
op_star
id|n
)paren
op_div
id|d
suffix:semicolon
r_if
c_cond
(paren
id|abs
(paren
id|h
op_minus
id|freq
)paren
OL
id|abs
(paren
op_star
id|best
op_minus
id|freq
)paren
)paren
(brace
op_star
id|best
op_assign
id|h
suffix:semicolon
op_star
id|nom
op_assign
id|n
suffix:semicolon
r_if
c_cond
(paren
id|d
OL
l_int|32
)paren
(brace
op_star
id|den
op_assign
id|d
suffix:semicolon
op_star
id|div
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|den
op_assign
id|d
op_div
l_int|2
suffix:semicolon
op_star
id|div
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
)brace
id|DPRINTK
(paren
l_string|&quot;Best possible values for given frequency:&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;        best: %ld kHz  nom: %ld  den: %ld  div: %ld&bslash;n&quot;
comma
id|freq
comma
op_star
id|nom
comma
op_star
id|den
comma
op_star
id|div
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n; *&n; * debugging functions&n; *&n; * -------------------------------------------------------------------------&n; */
macro_line|#ifdef CIRRUSFB_DEBUG
multiline_comment|/**&n; * cirrusfb_dbg_print_byte&n; * @name: name associated with byte value to be displayed&n; * @val: byte value to be displayed&n; *&n; * DESCRIPTION:&n; * Display an indented string, along with a hexidecimal byte value, and&n; * its decoded bits.  Bits 7 through 0 are listed in left-to-right&n; * order.&n; */
r_static
DECL|function|cirrusfb_dbg_print_byte
r_void
id|cirrusfb_dbg_print_byte
(paren
r_const
r_char
op_star
id|name
comma
r_int
r_char
id|val
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;%8s = 0x%02X (bits 7-0: %c%c%c%c%c%c%c%c)&bslash;n&quot;
comma
id|name
comma
id|val
comma
id|val
op_amp
l_int|0x80
ques
c_cond
l_char|&squot;1&squot;
suffix:colon
l_char|&squot;0&squot;
comma
id|val
op_amp
l_int|0x40
ques
c_cond
l_char|&squot;1&squot;
suffix:colon
l_char|&squot;0&squot;
comma
id|val
op_amp
l_int|0x20
ques
c_cond
l_char|&squot;1&squot;
suffix:colon
l_char|&squot;0&squot;
comma
id|val
op_amp
l_int|0x10
ques
c_cond
l_char|&squot;1&squot;
suffix:colon
l_char|&squot;0&squot;
comma
id|val
op_amp
l_int|0x08
ques
c_cond
l_char|&squot;1&squot;
suffix:colon
l_char|&squot;0&squot;
comma
id|val
op_amp
l_int|0x04
ques
c_cond
l_char|&squot;1&squot;
suffix:colon
l_char|&squot;0&squot;
comma
id|val
op_amp
l_int|0x02
ques
c_cond
l_char|&squot;1&squot;
suffix:colon
l_char|&squot;0&squot;
comma
id|val
op_amp
l_int|0x01
ques
c_cond
l_char|&squot;1&squot;
suffix:colon
l_char|&squot;0&squot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * cirrusfb_dbg_print_regs&n; * @base: If using newmmio, the newmmio base address, otherwise %NULL&n; * @reg_class: type of registers to read: %CRT, or %SEQ&n; *&n; * DESCRIPTION:&n; * Dumps the given list of VGA CRTC registers.  If @base is %NULL,&n; * old-style I/O ports are queried for information, otherwise MMIO is&n; * used at the given @base address to query the information.&n; */
r_static
DECL|function|cirrusfb_dbg_print_regs
r_void
id|cirrusfb_dbg_print_regs
(paren
id|caddr_t
id|regbase
comma
id|cirrusfb_dbg_reg_class_t
id|reg_class
comma
dot
dot
dot
)paren
(brace
id|va_list
id|list
suffix:semicolon
r_int
r_char
id|val
op_assign
l_int|0
suffix:semicolon
r_int
id|reg
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
id|va_start
(paren
id|list
comma
id|reg_class
)paren
suffix:semicolon
id|name
op_assign
id|va_arg
(paren
id|list
comma
r_char
op_star
)paren
suffix:semicolon
r_while
c_loop
(paren
id|name
op_ne
l_int|NULL
)paren
(brace
id|reg
op_assign
id|va_arg
(paren
id|list
comma
r_int
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|reg_class
)paren
(brace
r_case
id|CRT
suffix:colon
id|val
op_assign
id|vga_rcrt
(paren
id|regbase
comma
(paren
r_int
r_char
)paren
id|reg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ
suffix:colon
id|val
op_assign
id|vga_rseq
(paren
id|regbase
comma
(paren
r_int
r_char
)paren
id|reg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* should never occur */
m_assert
(paren
id|FALSE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cirrusfb_dbg_print_byte
(paren
id|name
comma
id|val
)paren
suffix:semicolon
id|name
op_assign
id|va_arg
(paren
id|list
comma
r_char
op_star
)paren
suffix:semicolon
)brace
id|va_end
(paren
id|list
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * cirrusfb_dump&n; * @cirrusfbinfo:&n; *&n; * DESCRIPTION:&n; */
r_static
DECL|function|cirrusfb_dump
r_void
id|cirrusfb_dump
(paren
r_void
)paren
(brace
id|cirrusfb_dbg_reg_dump
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * cirrusfb_dbg_reg_dump&n; * @base: If using newmmio, the newmmio base address, otherwise %NULL&n; *&n; * DESCRIPTION:&n; * Dumps a list of interesting VGA and CIRRUSFB registers.  If @base is %NULL,&n; * old-style I/O ports are queried for information, otherwise MMIO is&n; * used at the given @base address to query the information.&n; */
r_static
DECL|function|cirrusfb_dbg_reg_dump
r_void
id|cirrusfb_dbg_reg_dump
(paren
id|caddr_t
id|regbase
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;CIRRUSFB VGA CRTC register dump:&bslash;n&quot;
)paren
suffix:semicolon
id|cirrusfb_dbg_print_regs
(paren
id|regbase
comma
id|CRT
comma
l_string|&quot;CR00&quot;
comma
l_int|0x00
comma
l_string|&quot;CR01&quot;
comma
l_int|0x01
comma
l_string|&quot;CR02&quot;
comma
l_int|0x02
comma
l_string|&quot;CR03&quot;
comma
l_int|0x03
comma
l_string|&quot;CR04&quot;
comma
l_int|0x04
comma
l_string|&quot;CR05&quot;
comma
l_int|0x05
comma
l_string|&quot;CR06&quot;
comma
l_int|0x06
comma
l_string|&quot;CR07&quot;
comma
l_int|0x07
comma
l_string|&quot;CR08&quot;
comma
l_int|0x08
comma
l_string|&quot;CR09&quot;
comma
l_int|0x09
comma
l_string|&quot;CR0A&quot;
comma
l_int|0x0A
comma
l_string|&quot;CR0B&quot;
comma
l_int|0x0B
comma
l_string|&quot;CR0C&quot;
comma
l_int|0x0C
comma
l_string|&quot;CR0D&quot;
comma
l_int|0x0D
comma
l_string|&quot;CR0E&quot;
comma
l_int|0x0E
comma
l_string|&quot;CR0F&quot;
comma
l_int|0x0F
comma
l_string|&quot;CR10&quot;
comma
l_int|0x10
comma
l_string|&quot;CR11&quot;
comma
l_int|0x11
comma
l_string|&quot;CR12&quot;
comma
l_int|0x12
comma
l_string|&quot;CR13&quot;
comma
l_int|0x13
comma
l_string|&quot;CR14&quot;
comma
l_int|0x14
comma
l_string|&quot;CR15&quot;
comma
l_int|0x15
comma
l_string|&quot;CR16&quot;
comma
l_int|0x16
comma
l_string|&quot;CR17&quot;
comma
l_int|0x17
comma
l_string|&quot;CR18&quot;
comma
l_int|0x18
comma
l_string|&quot;CR22&quot;
comma
l_int|0x22
comma
l_string|&quot;CR24&quot;
comma
l_int|0x24
comma
l_string|&quot;CR26&quot;
comma
l_int|0x26
comma
l_string|&quot;CR2D&quot;
comma
l_int|0x2D
comma
l_string|&quot;CR2E&quot;
comma
l_int|0x2E
comma
l_string|&quot;CR2F&quot;
comma
l_int|0x2F
comma
l_string|&quot;CR30&quot;
comma
l_int|0x30
comma
l_string|&quot;CR31&quot;
comma
l_int|0x31
comma
l_string|&quot;CR32&quot;
comma
l_int|0x32
comma
l_string|&quot;CR33&quot;
comma
l_int|0x33
comma
l_string|&quot;CR34&quot;
comma
l_int|0x34
comma
l_string|&quot;CR35&quot;
comma
l_int|0x35
comma
l_string|&quot;CR36&quot;
comma
l_int|0x36
comma
l_string|&quot;CR37&quot;
comma
l_int|0x37
comma
l_string|&quot;CR38&quot;
comma
l_int|0x38
comma
l_string|&quot;CR39&quot;
comma
l_int|0x39
comma
l_string|&quot;CR3A&quot;
comma
l_int|0x3A
comma
l_string|&quot;CR3B&quot;
comma
l_int|0x3B
comma
l_string|&quot;CR3C&quot;
comma
l_int|0x3C
comma
l_string|&quot;CR3D&quot;
comma
l_int|0x3D
comma
l_string|&quot;CR3E&quot;
comma
l_int|0x3E
comma
l_string|&quot;CR3F&quot;
comma
l_int|0x3F
comma
l_int|NULL
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;CIRRUSFB VGA SEQ register dump:&bslash;n&quot;
)paren
suffix:semicolon
id|cirrusfb_dbg_print_regs
(paren
id|regbase
comma
id|SEQ
comma
l_string|&quot;SR00&quot;
comma
l_int|0x00
comma
l_string|&quot;SR01&quot;
comma
l_int|0x01
comma
l_string|&quot;SR02&quot;
comma
l_int|0x02
comma
l_string|&quot;SR03&quot;
comma
l_int|0x03
comma
l_string|&quot;SR04&quot;
comma
l_int|0x04
comma
l_string|&quot;SR08&quot;
comma
l_int|0x08
comma
l_string|&quot;SR09&quot;
comma
l_int|0x09
comma
l_string|&quot;SR0A&quot;
comma
l_int|0x0A
comma
l_string|&quot;SR0B&quot;
comma
l_int|0x0B
comma
l_string|&quot;SR0D&quot;
comma
l_int|0x0D
comma
l_string|&quot;SR10&quot;
comma
l_int|0x10
comma
l_string|&quot;SR11&quot;
comma
l_int|0x11
comma
l_string|&quot;SR12&quot;
comma
l_int|0x12
comma
l_string|&quot;SR13&quot;
comma
l_int|0x13
comma
l_string|&quot;SR14&quot;
comma
l_int|0x14
comma
l_string|&quot;SR15&quot;
comma
l_int|0x15
comma
l_string|&quot;SR16&quot;
comma
l_int|0x16
comma
l_string|&quot;SR17&quot;
comma
l_int|0x17
comma
l_string|&quot;SR18&quot;
comma
l_int|0x18
comma
l_string|&quot;SR19&quot;
comma
l_int|0x19
comma
l_string|&quot;SR1A&quot;
comma
l_int|0x1A
comma
l_string|&quot;SR1B&quot;
comma
l_int|0x1B
comma
l_string|&quot;SR1C&quot;
comma
l_int|0x1C
comma
l_string|&quot;SR1D&quot;
comma
l_int|0x1D
comma
l_string|&quot;SR1E&quot;
comma
l_int|0x1E
comma
l_string|&quot;SR1F&quot;
comma
l_int|0x1F
comma
l_int|NULL
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* CIRRUSFB_DEBUG */
eof
