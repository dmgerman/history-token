multiline_comment|/*&n; *  SGI GBE frame buffer driver&n; *&n; *  Copyright (C) 1999 Silicon Graphics, Inc. - Jeffrey Newquist&n; *  Copyright (C) 2002 Vivien Chappelier &lt;vivien.chappelier@linux-mips.org&gt;&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License. See the file COPYING in the main directory of this archive for&n; *  more details.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#ifdef CONFIG_X86
macro_line|#include &lt;asm/mtrr.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_MIPS
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/tlbflush.h&gt;
macro_line|#include &lt;video/gbe.h&gt;
DECL|variable|gbe
r_static
r_struct
id|sgi_gbe
op_star
id|gbe
suffix:semicolon
DECL|struct|gbefb_par
r_struct
id|gbefb_par
(brace
DECL|member|var
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
DECL|member|timing
r_struct
id|gbe_timing_info
id|timing
suffix:semicolon
DECL|member|valid
r_int
id|valid
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_SGI_IP32
DECL|macro|GBE_BASE
mdefine_line|#define GBE_BASE&t;0x16000000 /* SGI O2 */
macro_line|#endif
macro_line|#ifdef CONFIG_X86_VISWS
DECL|macro|GBE_BASE
mdefine_line|#define GBE_BASE&t;0xd0000000 /* SGI Visual Workstation */
macro_line|#endif
multiline_comment|/* macro for fastest write-though access to the framebuffer */
macro_line|#ifdef CONFIG_MIPS
macro_line|#ifdef CONFIG_CPU_R10000
DECL|macro|pgprot_fb
mdefine_line|#define pgprot_fb(_prot) (((_prot) &amp; (~_CACHE_MASK)) | _CACHE_UNCACHED_ACCELERATED)
macro_line|#else
DECL|macro|pgprot_fb
mdefine_line|#define pgprot_fb(_prot) (((_prot) &amp; (~_CACHE_MASK)) | _CACHE_CACHABLE_NO_WA)
macro_line|#endif
macro_line|#endif
macro_line|#ifdef CONFIG_X86
DECL|macro|pgprot_fb
mdefine_line|#define pgprot_fb(_prot) ((_prot) | _PAGE_PCD)
macro_line|#endif
multiline_comment|/*&n; *  RAM we reserve for the frame buffer. This defines the maximum screen&n; *  size&n; */
macro_line|#if CONFIG_FB_GBE_MEM &gt; 8
macro_line|#error GBE Framebuffer cannot use more than 8MB of memory
macro_line|#endif
DECL|macro|TILE_SHIFT
mdefine_line|#define TILE_SHIFT 16
DECL|macro|TILE_SIZE
mdefine_line|#define TILE_SIZE (1 &lt;&lt; TILE_SHIFT)
DECL|macro|TILE_MASK
mdefine_line|#define TILE_MASK (TILE_SIZE - 1)
DECL|variable|gbe_mem_size
r_static
r_int
r_int
id|gbe_mem_size
op_assign
id|CONFIG_FB_GBE_MEM
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
DECL|variable|gbe_mem
r_static
r_void
op_star
id|gbe_mem
suffix:semicolon
DECL|variable|gbe_dma_addr
r_static
id|dma_addr_t
id|gbe_dma_addr
suffix:semicolon
DECL|variable|gbe_mem_phys
r_int
r_int
id|gbe_mem_phys
suffix:semicolon
r_static
r_struct
(brace
DECL|member|cpu
r_uint16
op_star
id|cpu
suffix:semicolon
DECL|member|dma
id|dma_addr_t
id|dma
suffix:semicolon
DECL|variable|gbe_tiles
)brace
id|gbe_tiles
suffix:semicolon
DECL|variable|gbe_revision
r_static
r_int
id|gbe_revision
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|fb_info
id|fb_info
suffix:semicolon
DECL|variable|ypan
DECL|variable|ywrap
r_static
r_int
id|ypan
comma
id|ywrap
suffix:semicolon
DECL|variable|pseudo_palette
r_static
r_uint32
id|pseudo_palette
(braket
l_int|256
)braket
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
op_star
id|mode_option
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* default CRT mode */
DECL|variable|__initdata
r_static
r_struct
id|fb_var_screeninfo
id|default_var_CRT
id|__initdata
op_assign
(brace
multiline_comment|/* 640x480, 60 Hz, Non-Interlaced (25.175 MHz dotclock) */
dot
id|xres
op_assign
l_int|640
comma
dot
id|yres
op_assign
l_int|480
comma
dot
id|xres_virtual
op_assign
l_int|640
comma
dot
id|yres_virtual
op_assign
l_int|480
comma
dot
id|xoffset
op_assign
l_int|0
comma
dot
id|yoffset
op_assign
l_int|0
comma
dot
id|bits_per_pixel
op_assign
l_int|8
comma
dot
id|grayscale
op_assign
l_int|0
comma
dot
id|red
op_assign
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
dot
id|green
op_assign
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
dot
id|blue
op_assign
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
dot
id|transp
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
dot
id|nonstd
op_assign
l_int|0
comma
dot
id|activate
op_assign
l_int|0
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|accel_flags
op_assign
l_int|0
comma
dot
id|pixclock
op_assign
l_int|39722
comma
multiline_comment|/* picoseconds */
dot
id|left_margin
op_assign
l_int|48
comma
dot
id|right_margin
op_assign
l_int|16
comma
dot
id|upper_margin
op_assign
l_int|33
comma
dot
id|lower_margin
op_assign
l_int|10
comma
dot
id|hsync_len
op_assign
l_int|96
comma
dot
id|vsync_len
op_assign
l_int|2
comma
dot
id|sync
op_assign
l_int|0
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
comma
)brace
suffix:semicolon
multiline_comment|/* default LCD mode */
DECL|variable|__initdata
r_static
r_struct
id|fb_var_screeninfo
id|default_var_LCD
id|__initdata
op_assign
(brace
multiline_comment|/* 1600x1024, 8 bpp */
dot
id|xres
op_assign
l_int|1600
comma
dot
id|yres
op_assign
l_int|1024
comma
dot
id|xres_virtual
op_assign
l_int|1600
comma
dot
id|yres_virtual
op_assign
l_int|1024
comma
dot
id|xoffset
op_assign
l_int|0
comma
dot
id|yoffset
op_assign
l_int|0
comma
dot
id|bits_per_pixel
op_assign
l_int|8
comma
dot
id|grayscale
op_assign
l_int|0
comma
dot
id|red
op_assign
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
dot
id|green
op_assign
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
dot
id|blue
op_assign
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
dot
id|transp
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
dot
id|nonstd
op_assign
l_int|0
comma
dot
id|activate
op_assign
l_int|0
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|accel_flags
op_assign
l_int|0
comma
dot
id|pixclock
op_assign
l_int|9353
comma
dot
id|left_margin
op_assign
l_int|20
comma
dot
id|right_margin
op_assign
l_int|30
comma
dot
id|upper_margin
op_assign
l_int|37
comma
dot
id|lower_margin
op_assign
l_int|3
comma
dot
id|hsync_len
op_assign
l_int|20
comma
dot
id|vsync_len
op_assign
l_int|3
comma
dot
id|sync
op_assign
l_int|0
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
multiline_comment|/* default modedb mode */
multiline_comment|/* 640x480, 60 Hz, Non-Interlaced (25.172 MHz dotclock) */
DECL|variable|__initdata
r_static
r_struct
id|fb_videomode
id|default_mode_CRT
id|__initdata
op_assign
(brace
dot
id|refresh
op_assign
l_int|60
comma
dot
id|xres
op_assign
l_int|640
comma
dot
id|yres
op_assign
l_int|480
comma
dot
id|pixclock
op_assign
l_int|39722
comma
dot
id|left_margin
op_assign
l_int|48
comma
dot
id|right_margin
op_assign
l_int|16
comma
dot
id|upper_margin
op_assign
l_int|33
comma
dot
id|lower_margin
op_assign
l_int|10
comma
dot
id|hsync_len
op_assign
l_int|96
comma
dot
id|vsync_len
op_assign
l_int|2
comma
dot
id|sync
op_assign
l_int|0
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
comma
)brace
suffix:semicolon
multiline_comment|/* 1600x1024 SGI flatpanel 1600sw */
DECL|variable|__initdata
r_static
r_struct
id|fb_videomode
id|default_mode_LCD
id|__initdata
op_assign
(brace
multiline_comment|/* 1600x1024, 8 bpp */
dot
id|xres
op_assign
l_int|1600
comma
dot
id|yres
op_assign
l_int|1024
comma
dot
id|pixclock
op_assign
l_int|9353
comma
dot
id|left_margin
op_assign
l_int|20
comma
dot
id|right_margin
op_assign
l_int|30
comma
dot
id|upper_margin
op_assign
l_int|37
comma
dot
id|lower_margin
op_assign
l_int|3
comma
dot
id|hsync_len
op_assign
l_int|20
comma
dot
id|vsync_len
op_assign
l_int|3
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
comma
)brace
suffix:semicolon
DECL|variable|default_mode
r_struct
id|fb_videomode
op_star
id|default_mode
op_assign
op_amp
id|default_mode_CRT
suffix:semicolon
DECL|variable|default_var
r_struct
id|fb_var_screeninfo
op_star
id|default_var
op_assign
op_amp
id|default_var_CRT
suffix:semicolon
DECL|variable|flat_panel_enabled
r_static
r_int
id|flat_panel_enabled
op_assign
l_int|0
suffix:semicolon
DECL|variable|par_current
r_static
r_struct
id|gbefb_par
id|par_current
suffix:semicolon
DECL|function|gbe_reset
r_static
r_void
id|gbe_reset
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Turn on dotclock PLL */
id|gbe-&gt;ctrlstat
op_assign
l_int|0x300aa000
suffix:semicolon
)brace
multiline_comment|/*&n; * Function:&t;gbe_turn_off&n; * Parameters:&t;(None)&n; * Description:&t;This should turn off the monitor and gbe.  This is used&n; *              when switching between the serial console and the graphics&n; *              console.&n; */
DECL|function|gbe_turn_off
r_void
id|gbe_turn_off
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|val
comma
id|x
comma
id|y
comma
id|vpixen_off
suffix:semicolon
multiline_comment|/* check if pixel counter is on */
id|val
op_assign
id|gbe-&gt;vt_xy
suffix:semicolon
r_if
c_cond
(paren
id|GET_GBE_FIELD
c_func
(paren
id|VT_XY
comma
id|FREEZE
comma
id|val
)paren
op_eq
l_int|1
)paren
r_return
suffix:semicolon
multiline_comment|/* turn off DMA */
id|val
op_assign
id|gbe-&gt;ovr_control
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|OVR_CONTROL
comma
id|OVR_DMA_ENABLE
comma
id|val
comma
l_int|0
)paren
suffix:semicolon
id|gbe-&gt;ovr_control
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|val
op_assign
id|gbe-&gt;frm_control
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_CONTROL
comma
id|FRM_DMA_ENABLE
comma
id|val
comma
l_int|0
)paren
suffix:semicolon
id|gbe-&gt;frm_control
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|val
op_assign
id|gbe-&gt;did_control
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|DID_CONTROL
comma
id|DID_DMA_ENABLE
comma
id|val
comma
l_int|0
)paren
suffix:semicolon
id|gbe-&gt;did_control
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* We have to wait through two vertical retrace periods before&n;&t; * the pixel DMA is turned off for sure. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|gbe-&gt;frm_inhwctrl
suffix:semicolon
r_if
c_cond
(paren
id|GET_GBE_FIELD
c_func
(paren
id|FRM_INHWCTRL
comma
id|FRM_DMA_ENABLE
comma
id|val
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|gbe-&gt;ovr_inhwctrl
suffix:semicolon
r_if
c_cond
(paren
id|GET_GBE_FIELD
c_func
(paren
id|OVR_INHWCTRL
comma
id|OVR_DMA_ENABLE
comma
id|val
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|gbe-&gt;did_inhwctrl
suffix:semicolon
r_if
c_cond
(paren
id|GET_GBE_FIELD
c_func
(paren
id|DID_INHWCTRL
comma
id|DID_DMA_ENABLE
comma
id|val
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|10000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: turn off DMA timed out&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* wait for vpixen_off */
id|val
op_assign
id|gbe-&gt;vt_vpixen
suffix:semicolon
id|vpixen_off
op_assign
id|GET_GBE_FIELD
c_func
(paren
id|VT_VPIXEN
comma
id|VPIXEN_OFF
comma
id|val
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|gbe-&gt;vt_xy
suffix:semicolon
id|x
op_assign
id|GET_GBE_FIELD
c_func
(paren
id|VT_XY
comma
id|X
comma
id|val
)paren
suffix:semicolon
id|y
op_assign
id|GET_GBE_FIELD
c_func
(paren
id|VT_XY
comma
id|Y
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|y
OL
id|vpixen_off
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|100000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: wait for vpixen_off timed out&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|gbe-&gt;vt_xy
suffix:semicolon
id|x
op_assign
id|GET_GBE_FIELD
c_func
(paren
id|VT_XY
comma
id|X
comma
id|val
)paren
suffix:semicolon
id|y
op_assign
id|GET_GBE_FIELD
c_func
(paren
id|VT_XY
comma
id|Y
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|y
OG
id|vpixen_off
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|10000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: wait for vpixen_off timed out&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* turn off pixel counter */
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_XY
comma
id|FREEZE
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
id|gbe-&gt;vt_xy
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|gbe-&gt;vt_xy
suffix:semicolon
r_if
c_cond
(paren
id|GET_GBE_FIELD
c_func
(paren
id|VT_XY
comma
id|FREEZE
comma
id|val
)paren
op_ne
l_int|1
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|10000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: turn off pixel clock timed out&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* turn off dot clock */
id|val
op_assign
id|gbe-&gt;dotclock
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|DOTCLK
comma
id|RUN
comma
id|val
comma
l_int|0
)paren
suffix:semicolon
id|gbe-&gt;dotclock
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|gbe-&gt;dotclock
suffix:semicolon
r_if
c_cond
(paren
id|GET_GBE_FIELD
c_func
(paren
id|DOTCLK
comma
id|RUN
comma
id|val
)paren
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|10000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: turn off dotclock timed out&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* reset the frame DMA FIFO */
id|val
op_assign
id|gbe-&gt;frm_size_tile
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_SIZE_TILE
comma
id|FRM_FIFO_RESET
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
id|gbe-&gt;frm_size_tile
op_assign
id|val
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_SIZE_TILE
comma
id|FRM_FIFO_RESET
comma
id|val
comma
l_int|0
)paren
suffix:semicolon
id|gbe-&gt;frm_size_tile
op_assign
id|val
suffix:semicolon
)brace
DECL|function|gbe_turn_on
r_static
r_void
id|gbe_turn_on
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|val
comma
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Check if pixel counter is off, for unknown reason this&n;&t; * code hangs Visual Workstations&n;&t; */
r_if
c_cond
(paren
id|gbe_revision
OL
l_int|2
)paren
(brace
id|val
op_assign
id|gbe-&gt;vt_xy
suffix:semicolon
r_if
c_cond
(paren
id|GET_GBE_FIELD
c_func
(paren
id|VT_XY
comma
id|FREEZE
comma
id|val
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
multiline_comment|/* turn on dot clock */
id|val
op_assign
id|gbe-&gt;dotclock
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|DOTCLK
comma
id|RUN
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
id|gbe-&gt;dotclock
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|gbe-&gt;dotclock
suffix:semicolon
r_if
c_cond
(paren
id|GET_GBE_FIELD
c_func
(paren
id|DOTCLK
comma
id|RUN
comma
id|val
)paren
op_ne
l_int|1
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|10000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: turn on dotclock timed out&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* turn on pixel counter */
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_XY
comma
id|FREEZE
comma
id|val
comma
l_int|0
)paren
suffix:semicolon
id|gbe-&gt;vt_xy
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|gbe-&gt;vt_xy
suffix:semicolon
r_if
c_cond
(paren
id|GET_GBE_FIELD
c_func
(paren
id|VT_XY
comma
id|FREEZE
comma
id|val
)paren
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|10000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: turn on pixel clock timed out&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* turn on DMA */
id|val
op_assign
id|gbe-&gt;frm_control
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_CONTROL
comma
id|FRM_DMA_ENABLE
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
id|gbe-&gt;frm_control
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|gbe-&gt;frm_inhwctrl
suffix:semicolon
r_if
c_cond
(paren
id|GET_GBE_FIELD
c_func
(paren
id|FRM_INHWCTRL
comma
id|FRM_DMA_ENABLE
comma
id|val
)paren
op_ne
l_int|1
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|10000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: turn on DMA timed out&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Blank the display.&n; */
DECL|function|gbefb_blank
r_static
r_int
id|gbefb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* 0 unblank, 1 blank, 2 no vsync, 3 no hsync, 4 off */
r_switch
c_cond
(paren
id|blank
)paren
(brace
r_case
id|FB_BLANK_UNBLANK
suffix:colon
multiline_comment|/* unblank */
id|gbe_turn_on
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_NORMAL
suffix:colon
multiline_comment|/* blank */
id|gbe_turn_off
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Nothing */
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  Setup flatpanel related registers.&n; */
DECL|function|gbefb_setup_flatpanel
r_static
r_void
id|gbefb_setup_flatpanel
c_func
(paren
r_struct
id|gbe_timing_info
op_star
id|timing
)paren
(brace
r_int
id|fp_wid
comma
id|fp_hgt
comma
id|fp_vbs
comma
id|fp_vbe
suffix:semicolon
id|u32
id|outputVal
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_FLAGS
comma
id|HDRV_INVERT
comma
id|outputVal
comma
(paren
id|timing-&gt;flags
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_FLAGS
comma
id|VDRV_INVERT
comma
id|outputVal
comma
(paren
id|timing-&gt;flags
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
id|gbe-&gt;vt_flags
op_assign
id|outputVal
suffix:semicolon
multiline_comment|/* Turn on the flat panel */
id|fp_wid
op_assign
l_int|1600
suffix:semicolon
id|fp_hgt
op_assign
l_int|1024
suffix:semicolon
id|fp_vbs
op_assign
l_int|0
suffix:semicolon
id|fp_vbe
op_assign
l_int|1600
suffix:semicolon
id|timing-&gt;pll_m
op_assign
l_int|4
suffix:semicolon
id|timing-&gt;pll_n
op_assign
l_int|1
suffix:semicolon
id|timing-&gt;pll_p
op_assign
l_int|0
suffix:semicolon
id|outputVal
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FP_DE
comma
id|ON
comma
id|outputVal
comma
id|fp_vbs
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FP_DE
comma
id|OFF
comma
id|outputVal
comma
id|fp_vbe
)paren
suffix:semicolon
id|gbe-&gt;fp_de
op_assign
id|outputVal
suffix:semicolon
id|outputVal
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FP_HDRV
comma
id|OFF
comma
id|outputVal
comma
id|fp_wid
)paren
suffix:semicolon
id|gbe-&gt;fp_hdrv
op_assign
id|outputVal
suffix:semicolon
id|outputVal
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FP_VDRV
comma
id|ON
comma
id|outputVal
comma
l_int|1
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FP_VDRV
comma
id|OFF
comma
id|outputVal
comma
id|fp_hgt
op_plus
l_int|1
)paren
suffix:semicolon
id|gbe-&gt;fp_vdrv
op_assign
id|outputVal
suffix:semicolon
)brace
DECL|struct|gbe_pll_info
r_struct
id|gbe_pll_info
(brace
DECL|member|clock_rate
r_int
id|clock_rate
suffix:semicolon
DECL|member|fvco_min
r_int
id|fvco_min
suffix:semicolon
DECL|member|fvco_max
r_int
id|fvco_max
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|gbe_pll_table
r_static
r_struct
id|gbe_pll_info
id|gbe_pll_table
(braket
l_int|2
)braket
op_assign
(brace
(brace
l_int|20
comma
l_int|80
comma
l_int|220
)brace
comma
(brace
l_int|27
comma
l_int|80
comma
l_int|220
)brace
comma
)brace
suffix:semicolon
DECL|function|compute_gbe_timing
r_static
r_int
id|compute_gbe_timing
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|gbe_timing_info
op_star
id|timing
)paren
(brace
r_int
id|pll_m
comma
id|pll_n
comma
id|pll_p
comma
id|error
comma
id|best_m
comma
id|best_n
comma
id|best_p
comma
id|best_error
suffix:semicolon
r_int
id|pixclock
suffix:semicolon
r_struct
id|gbe_pll_info
op_star
id|gbe_pll
suffix:semicolon
r_if
c_cond
(paren
id|gbe_revision
OL
l_int|2
)paren
id|gbe_pll
op_assign
op_amp
id|gbe_pll_table
(braket
l_int|0
)braket
suffix:semicolon
r_else
id|gbe_pll
op_assign
op_amp
id|gbe_pll_table
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Determine valid resolution and timing&n;&t; * GBE crystal runs at 20Mhz or 27Mhz&n;&t; * pll_m, pll_n, pll_p define the following frequencies&n;&t; * fvco = pll_m * 20Mhz / pll_n&n;&t; * fout = fvco / (2**pll_p) */
id|best_error
op_assign
l_int|1000000000
suffix:semicolon
id|best_n
op_assign
id|best_m
op_assign
id|best_p
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|pll_p
op_assign
l_int|0
suffix:semicolon
id|pll_p
OL
l_int|4
suffix:semicolon
id|pll_p
op_increment
)paren
r_for
c_loop
(paren
id|pll_m
op_assign
l_int|1
suffix:semicolon
id|pll_m
OL
l_int|256
suffix:semicolon
id|pll_m
op_increment
)paren
r_for
c_loop
(paren
id|pll_n
op_assign
l_int|1
suffix:semicolon
id|pll_n
OL
l_int|64
suffix:semicolon
id|pll_n
op_increment
)paren
(brace
id|pixclock
op_assign
(paren
l_int|1000000
op_div
id|gbe_pll-&gt;clock_rate
)paren
op_star
(paren
id|pll_n
op_lshift
id|pll_p
)paren
op_div
id|pll_m
suffix:semicolon
id|error
op_assign
id|var-&gt;pixclock
op_minus
id|pixclock
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
id|error
op_assign
op_minus
id|error
suffix:semicolon
r_if
c_cond
(paren
id|error
template_param
id|gbe_pll-&gt;fvco_min
op_div
id|gbe_pll-&gt;clock_rate
op_logical_and
id|pll_m
op_div
id|pll_n
OL
id|gbe_pll-&gt;fvco_max
op_div
id|gbe_pll-&gt;clock_rate
)paren
(brace
id|best_error
op_assign
id|error
suffix:semicolon
id|best_m
op_assign
id|pll_m
suffix:semicolon
id|best_n
op_assign
id|pll_n
suffix:semicolon
id|best_p
op_assign
id|pll_p
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|best_n
op_logical_or
op_logical_neg
id|best_m
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Resolution to high */
id|pixclock
op_assign
(paren
l_int|1000000
op_div
id|gbe_pll-&gt;clock_rate
)paren
op_star
(paren
id|best_n
op_lshift
id|best_p
)paren
op_div
id|best_m
suffix:semicolon
multiline_comment|/* set video timing information */
r_if
c_cond
(paren
id|timing
)paren
(brace
id|timing-&gt;width
op_assign
id|var-&gt;xres
suffix:semicolon
id|timing-&gt;height
op_assign
id|var-&gt;yres
suffix:semicolon
id|timing-&gt;pll_m
op_assign
id|best_m
suffix:semicolon
id|timing-&gt;pll_n
op_assign
id|best_n
suffix:semicolon
id|timing-&gt;pll_p
op_assign
id|best_p
suffix:semicolon
id|timing-&gt;cfreq
op_assign
id|gbe_pll-&gt;clock_rate
op_star
l_int|1000
op_star
id|timing-&gt;pll_m
op_div
(paren
id|timing-&gt;pll_n
op_lshift
id|timing-&gt;pll_p
)paren
suffix:semicolon
id|timing-&gt;htotal
op_assign
id|var-&gt;left_margin
op_plus
id|var-&gt;xres
op_plus
id|var-&gt;right_margin
op_plus
id|var-&gt;hsync_len
suffix:semicolon
id|timing-&gt;vtotal
op_assign
id|var-&gt;upper_margin
op_plus
id|var-&gt;yres
op_plus
id|var-&gt;lower_margin
op_plus
id|var-&gt;vsync_len
suffix:semicolon
id|timing-&gt;fields_sec
op_assign
l_int|1000
op_star
id|timing-&gt;cfreq
op_div
id|timing-&gt;htotal
op_star
l_int|1000
op_div
id|timing-&gt;vtotal
suffix:semicolon
id|timing-&gt;hblank_start
op_assign
id|var-&gt;xres
suffix:semicolon
id|timing-&gt;vblank_start
op_assign
id|var-&gt;yres
suffix:semicolon
id|timing-&gt;hblank_end
op_assign
id|timing-&gt;htotal
suffix:semicolon
id|timing-&gt;hsync_start
op_assign
id|var-&gt;xres
op_plus
id|var-&gt;right_margin
op_plus
l_int|1
suffix:semicolon
id|timing-&gt;hsync_end
op_assign
id|timing-&gt;hsync_start
op_plus
id|var-&gt;hsync_len
suffix:semicolon
id|timing-&gt;vblank_end
op_assign
id|timing-&gt;vtotal
suffix:semicolon
id|timing-&gt;vsync_start
op_assign
id|var-&gt;yres
op_plus
id|var-&gt;lower_margin
op_plus
l_int|1
suffix:semicolon
id|timing-&gt;vsync_end
op_assign
id|timing-&gt;vsync_start
op_plus
id|var-&gt;vsync_len
suffix:semicolon
)brace
r_return
id|pixclock
suffix:semicolon
)brace
DECL|function|gbe_set_timing_info
r_static
r_void
id|gbe_set_timing_info
c_func
(paren
r_struct
id|gbe_timing_info
op_star
id|timing
)paren
(brace
r_int
id|temp
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
multiline_comment|/* setup dot clock PLL */
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|DOTCLK
comma
id|M
comma
id|val
comma
id|timing-&gt;pll_m
op_minus
l_int|1
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|DOTCLK
comma
id|N
comma
id|val
comma
id|timing-&gt;pll_n
op_minus
l_int|1
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|DOTCLK
comma
id|P
comma
id|val
comma
id|timing-&gt;pll_p
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|DOTCLK
comma
id|RUN
comma
id|val
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* do not start yet */
id|gbe-&gt;dotclock
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
multiline_comment|/* setup pixel counter */
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_XYMAX
comma
id|MAXX
comma
id|val
comma
id|timing-&gt;htotal
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_XYMAX
comma
id|MAXY
comma
id|val
comma
id|timing-&gt;vtotal
)paren
suffix:semicolon
id|gbe-&gt;vt_xymax
op_assign
id|val
suffix:semicolon
multiline_comment|/* setup video timing signals */
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_VSYNC
comma
id|VSYNC_ON
comma
id|val
comma
id|timing-&gt;vsync_start
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_VSYNC
comma
id|VSYNC_OFF
comma
id|val
comma
id|timing-&gt;vsync_end
)paren
suffix:semicolon
id|gbe-&gt;vt_vsync
op_assign
id|val
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_HSYNC
comma
id|HSYNC_ON
comma
id|val
comma
id|timing-&gt;hsync_start
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_HSYNC
comma
id|HSYNC_OFF
comma
id|val
comma
id|timing-&gt;hsync_end
)paren
suffix:semicolon
id|gbe-&gt;vt_hsync
op_assign
id|val
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_VBLANK
comma
id|VBLANK_ON
comma
id|val
comma
id|timing-&gt;vblank_start
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_VBLANK
comma
id|VBLANK_OFF
comma
id|val
comma
id|timing-&gt;vblank_end
)paren
suffix:semicolon
id|gbe-&gt;vt_vblank
op_assign
id|val
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_HBLANK
comma
id|HBLANK_ON
comma
id|val
comma
id|timing-&gt;hblank_start
op_minus
l_int|5
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_HBLANK
comma
id|HBLANK_OFF
comma
id|val
comma
id|timing-&gt;hblank_end
op_minus
l_int|3
)paren
suffix:semicolon
id|gbe-&gt;vt_hblank
op_assign
id|val
suffix:semicolon
multiline_comment|/* setup internal timing signals */
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_VCMAP
comma
id|VCMAP_ON
comma
id|val
comma
id|timing-&gt;vblank_start
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_VCMAP
comma
id|VCMAP_OFF
comma
id|val
comma
id|timing-&gt;vblank_end
)paren
suffix:semicolon
id|gbe-&gt;vt_vcmap
op_assign
id|val
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_HCMAP
comma
id|HCMAP_ON
comma
id|val
comma
id|timing-&gt;hblank_start
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_HCMAP
comma
id|HCMAP_OFF
comma
id|val
comma
id|timing-&gt;hblank_end
)paren
suffix:semicolon
id|gbe-&gt;vt_hcmap
op_assign
id|val
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|temp
op_assign
id|timing-&gt;vblank_start
op_minus
id|timing-&gt;vblank_end
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|temp
OG
l_int|0
)paren
id|temp
op_assign
op_minus
id|temp
suffix:semicolon
r_if
c_cond
(paren
id|flat_panel_enabled
)paren
id|gbefb_setup_flatpanel
c_func
(paren
id|timing
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|DID_START_XY
comma
id|DID_STARTY
comma
id|val
comma
(paren
id|u32
)paren
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timing-&gt;hblank_end
op_ge
l_int|20
)paren
id|SET_GBE_FIELD
c_func
(paren
id|DID_START_XY
comma
id|DID_STARTX
comma
id|val
comma
id|timing-&gt;hblank_end
op_minus
l_int|20
)paren
suffix:semicolon
r_else
id|SET_GBE_FIELD
c_func
(paren
id|DID_START_XY
comma
id|DID_STARTX
comma
id|val
comma
id|timing-&gt;htotal
op_minus
(paren
l_int|20
op_minus
id|timing-&gt;hblank_end
)paren
)paren
suffix:semicolon
id|gbe-&gt;did_start_xy
op_assign
id|val
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|CRS_START_XY
comma
id|CRS_STARTY
comma
id|val
comma
(paren
id|u32
)paren
(paren
id|temp
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timing-&gt;hblank_end
op_ge
id|GBE_CRS_MAGIC
)paren
id|SET_GBE_FIELD
c_func
(paren
id|CRS_START_XY
comma
id|CRS_STARTX
comma
id|val
comma
id|timing-&gt;hblank_end
op_minus
id|GBE_CRS_MAGIC
)paren
suffix:semicolon
r_else
id|SET_GBE_FIELD
c_func
(paren
id|CRS_START_XY
comma
id|CRS_STARTX
comma
id|val
comma
id|timing-&gt;htotal
op_minus
(paren
id|GBE_CRS_MAGIC
op_minus
id|timing-&gt;hblank_end
)paren
)paren
suffix:semicolon
id|gbe-&gt;crs_start_xy
op_assign
id|val
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VC_START_XY
comma
id|VC_STARTY
comma
id|val
comma
(paren
id|u32
)paren
id|temp
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VC_START_XY
comma
id|VC_STARTX
comma
id|val
comma
id|timing-&gt;hblank_end
op_minus
l_int|4
)paren
suffix:semicolon
id|gbe-&gt;vc_start_xy
op_assign
id|val
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|temp
op_assign
id|timing-&gt;hblank_end
op_minus
id|GBE_PIXEN_MAGIC_ON
suffix:semicolon
r_if
c_cond
(paren
id|temp
OL
l_int|0
)paren
id|temp
op_add_assign
id|timing-&gt;htotal
suffix:semicolon
multiline_comment|/* allow blank to wrap around */
id|SET_GBE_FIELD
c_func
(paren
id|VT_HPIXEN
comma
id|HPIXEN_ON
comma
id|val
comma
id|temp
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_HPIXEN
comma
id|HPIXEN_OFF
comma
id|val
comma
(paren
(paren
id|temp
op_plus
id|timing-&gt;width
op_minus
id|GBE_PIXEN_MAGIC_OFF
)paren
op_mod
id|timing-&gt;htotal
)paren
)paren
suffix:semicolon
id|gbe-&gt;vt_hpixen
op_assign
id|val
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_VPIXEN
comma
id|VPIXEN_ON
comma
id|val
comma
id|timing-&gt;vblank_end
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_VPIXEN
comma
id|VPIXEN_OFF
comma
id|val
comma
id|timing-&gt;vblank_start
)paren
suffix:semicolon
id|gbe-&gt;vt_vpixen
op_assign
id|val
suffix:semicolon
multiline_comment|/* turn off sync on green */
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|VT_FLAGS
comma
id|SYNC_LOW
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
id|gbe-&gt;vt_flags
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/*&n; *  Set the hardware according to &squot;par&squot;.&n; */
DECL|function|gbefb_set_par
r_static
r_int
id|gbefb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
r_int
id|wholeTilesX
comma
id|partTilesX
comma
id|maxPixelsPerTileX
suffix:semicolon
r_int
id|height_pix
suffix:semicolon
r_int
id|xpmax
comma
id|ypmax
suffix:semicolon
multiline_comment|/* Monitor resolution */
r_int
id|bytesPerPixel
suffix:semicolon
multiline_comment|/* Bytes per pixel */
r_struct
id|gbefb_par
op_star
id|par
op_assign
(paren
r_struct
id|gbefb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|compute_gbe_timing
c_func
(paren
op_amp
id|info-&gt;var
comma
op_amp
id|par-&gt;timing
)paren
suffix:semicolon
id|bytesPerPixel
op_assign
id|info-&gt;var.bits_per_pixel
op_div
l_int|8
suffix:semicolon
id|info-&gt;fix.line_length
op_assign
id|info-&gt;var.xres_virtual
op_star
id|bytesPerPixel
suffix:semicolon
id|xpmax
op_assign
id|par-&gt;timing.width
suffix:semicolon
id|ypmax
op_assign
id|par-&gt;timing.height
suffix:semicolon
multiline_comment|/* turn off GBE */
id|gbe_turn_off
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* set timing info */
id|gbe_set_timing_info
c_func
(paren
op_amp
id|par-&gt;timing
)paren
suffix:semicolon
multiline_comment|/* initialize DIDs */
id|val
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|bytesPerPixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|SET_GBE_FIELD
c_func
(paren
id|WID
comma
id|TYP
comma
id|val
comma
id|GBE_CMODE_I8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|SET_GBE_FIELD
c_func
(paren
id|WID
comma
id|TYP
comma
id|val
comma
id|GBE_CMODE_ARGB5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|SET_GBE_FIELD
c_func
(paren
id|WID
comma
id|TYP
comma
id|val
comma
id|GBE_CMODE_RGB8
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SET_GBE_FIELD
c_func
(paren
id|WID
comma
id|BUF
comma
id|val
comma
id|GBE_BMODE_BOTH
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|gbe-&gt;mode_regs
(braket
id|i
)braket
op_assign
id|val
suffix:semicolon
multiline_comment|/* Initialize interrupts */
id|gbe-&gt;vt_intr01
op_assign
l_int|0xffffffff
suffix:semicolon
id|gbe-&gt;vt_intr23
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* HACK:&n;&t;   The GBE hardware uses a tiled memory to screen mapping. Tiles are&n;&t;   blocks of 512x128, 256x128 or 128x128 pixels, respectively for 8bit,&n;&t;   16bit and 32 bit modes (64 kB). They cover the screen with partial&n;&t;   tiles on the right and/or bottom of the screen if needed.&n;&t;   For exemple in 640x480 8 bit mode the mapping is:&n;&n;&t;   &lt;-------- 640 -----&gt;&n;&t;   &lt;---- 512 ----&gt;&lt;128|384 offscreen&gt;&n;&t;   ^  ^&n;&t;   | 128    [tile 0]        [tile 1]&n;&t;   |  v&n;&t;   ^&n;&t;   4 128    [tile 2]        [tile 3]&n;&t;   8  v&n;&t;   0  ^&n;&t;   128    [tile 4]        [tile 5]&n;&t;   |  v&n;&t;   |  ^&n;&t;   v  96    [tile 6]        [tile 7]&n;&t;   32 offscreen&n;&n;&t;   Tiles have the advantage that they can be allocated individually in&n;&t;   memory. However, this mapping is not linear at all, which is not&n;&t;   really convienient. In order to support linear addressing, the GBE&n;&t;   DMA hardware is fooled into thinking the screen is only one tile&n;&t;   large and but has a greater height, so that the DMA transfer covers&n;&t;   the same region.&n;&t;   Tiles are still allocated as independent chunks of 64KB of&n;&t;   continuous physical memory and remapped so that the kernel sees the&n;&t;   framebuffer as a continuous virtual memory. The GBE tile table is&n;&t;   set up so that each tile references one of these 64k blocks:&n;&n;&t;   GBE -&gt; tile list    framebuffer           TLB   &lt;------------ CPU&n;&t;          [ tile 0 ] -&gt; [ 64KB ]  &lt;- [ 16x 4KB page entries ]     ^&n;&t;             ...           ...              ...       linear virtual FB&n;&t;          [ tile n ] -&gt; [ 64KB ]  &lt;- [ 16x 4KB page entries ]     v&n;&n;&n;&t;   The GBE hardware is then told that the buffer is 512*tweaked_height,&n;&t;   with tweaked_height = real_width*real_height/pixels_per_tile.&n;&t;   Thus the GBE hardware will scan the first tile, filing the first 64k&n;&t;   covered region of the screen, and then will proceed to the next&n;&t;   tile, until the whole screen is covered.&n;&n;&t;   Here is what would happen at 640x480 8bit:&n;&n;&t;   normal tiling               linear&n;&t;   ^   11111111111111112222    11111111111111111111  ^&n;&t;   128 11111111111111112222    11111111111111111111 102 lines&n;&t;       11111111111111112222    11111111111111111111  v&n;&t;   V   11111111111111112222    11111111222222222222&n;&t;       33333333333333334444    22222222222222222222&n;&t;       33333333333333334444    22222222222222222222&n;&t;       &lt;      512     &gt;        &lt;  256 &gt;               102*640+256 = 64k&n;&n;&t;   NOTE: The only mode for which this is not working is 800x600 8bit,&n;&t;   as 800*600/512 = 937.5 which is not integer and thus causes&n;&t;   flickering.&n;&t;   I guess this is not so important as one can use 640x480 8bit or&n;&t;   800x600 16bit anyway.&n;&t; */
multiline_comment|/* Tell gbe about the tiles table location */
multiline_comment|/* tile_ptr -&gt; [ tile 1 ] -&gt; FB mem */
multiline_comment|/*             [ tile 2 ] -&gt; FB mem */
multiline_comment|/*               ...                */
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_CONTROL
comma
id|FRM_TILE_PTR
comma
id|val
comma
id|gbe_tiles.dma
op_rshift
l_int|9
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_CONTROL
comma
id|FRM_DMA_ENABLE
comma
id|val
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* do not start */
id|SET_GBE_FIELD
c_func
(paren
id|FRM_CONTROL
comma
id|FRM_LINEAR
comma
id|val
comma
l_int|0
)paren
suffix:semicolon
id|gbe-&gt;frm_control
op_assign
id|val
suffix:semicolon
id|maxPixelsPerTileX
op_assign
l_int|512
op_div
id|bytesPerPixel
suffix:semicolon
id|wholeTilesX
op_assign
l_int|1
suffix:semicolon
id|partTilesX
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize the framebuffer */
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_SIZE_TILE
comma
id|FRM_WIDTH_TILE
comma
id|val
comma
id|wholeTilesX
)paren
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_SIZE_TILE
comma
id|FRM_RHS
comma
id|val
comma
id|partTilesX
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|bytesPerPixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_SIZE_TILE
comma
id|FRM_DEPTH
comma
id|val
comma
id|GBE_FRM_DEPTH_8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_SIZE_TILE
comma
id|FRM_DEPTH
comma
id|val
comma
id|GBE_FRM_DEPTH_16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_SIZE_TILE
comma
id|FRM_DEPTH
comma
id|val
comma
id|GBE_FRM_DEPTH_32
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|gbe-&gt;frm_size_tile
op_assign
id|val
suffix:semicolon
multiline_comment|/* compute tweaked height */
id|height_pix
op_assign
id|xpmax
op_star
id|ypmax
op_div
id|maxPixelsPerTileX
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
id|SET_GBE_FIELD
c_func
(paren
id|FRM_SIZE_PIXEL
comma
id|FB_HEIGHT_PIX
comma
id|val
comma
id|height_pix
)paren
suffix:semicolon
id|gbe-&gt;frm_size_pixel
op_assign
id|val
suffix:semicolon
multiline_comment|/* turn off DID and overlay DMA */
id|gbe-&gt;did_control
op_assign
l_int|0
suffix:semicolon
id|gbe-&gt;ovr_width_tile
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Turn off mouse cursor */
id|gbe-&gt;crs_ctl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Turn on GBE */
id|gbe_turn_on
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initialize the gamma map */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
id|gbe-&gt;gmap
(braket
id|i
)braket
op_assign
(paren
id|i
op_lshift
l_int|24
)paren
op_or
(paren
id|i
op_lshift
l_int|16
)paren
op_or
(paren
id|i
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Initialize the color map */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|1000
op_logical_and
id|gbe-&gt;cm_fifo
op_ge
l_int|63
suffix:semicolon
id|j
op_increment
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|1000
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: cmap FIFO timeout&bslash;n&quot;
)paren
suffix:semicolon
id|gbe-&gt;cmap
(braket
id|i
)braket
op_assign
(paren
id|i
op_lshift
l_int|8
)paren
op_or
(paren
id|i
op_lshift
l_int|16
)paren
op_or
(paren
id|i
op_lshift
l_int|24
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gbefb_encode_fix
r_static
r_void
id|gbefb_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|memset
c_func
(paren
id|fix
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_fix_screeninfo
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
l_string|&quot;SGI GBE&quot;
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
(paren
r_int
r_int
)paren
id|gbe_mem
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|gbe_mem_size
suffix:semicolon
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;accel
op_assign
id|FB_ACCEL_NONE
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|fix-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;line_length
op_assign
id|var-&gt;xres_virtual
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|8
suffix:semicolon
id|fix-&gt;mmio_start
op_assign
id|GBE_BASE
suffix:semicolon
id|fix-&gt;mmio_len
op_assign
r_sizeof
(paren
r_struct
id|sgi_gbe
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Set a single color register. The values supplied are already&n; *  rounded down to the hardware&squot;s capabilities (according to the&n; *  entries in the var structure). Return != 0 for invalid regno.&n; */
DECL|function|gbefb_setcolreg
r_static
r_int
id|gbefb_setcolreg
c_func
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
multiline_comment|/* wait for the color map FIFO to have a free entry */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
op_logical_and
id|gbe-&gt;cm_fifo
op_ge
l_int|63
suffix:semicolon
id|i
op_increment
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|1000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: cmap FIFO timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|gbe-&gt;cmap
(braket
id|regno
)braket
op_assign
(paren
id|red
op_lshift
l_int|24
)paren
op_or
(paren
id|green
op_lshift
l_int|16
)paren
op_or
(paren
id|blue
op_lshift
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
r_case
l_int|16
suffix:colon
id|red
op_rshift_assign
l_int|3
suffix:semicolon
id|green
op_rshift_assign
l_int|3
suffix:semicolon
id|blue
op_rshift_assign
l_int|3
suffix:semicolon
id|pseudo_palette
(braket
id|regno
)braket
op_assign
(paren
id|red
op_lshift
id|info-&gt;var.red.offset
)paren
op_or
(paren
id|green
op_lshift
id|info-&gt;var.green.offset
)paren
op_or
(paren
id|blue
op_lshift
id|info-&gt;var.blue.offset
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|pseudo_palette
(braket
id|regno
)braket
op_assign
(paren
id|red
op_lshift
id|info-&gt;var.red.offset
)paren
op_or
(paren
id|green
op_lshift
id|info-&gt;var.green.offset
)paren
op_or
(paren
id|blue
op_lshift
id|info-&gt;var.blue.offset
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  Check video mode validity, eventually modify var to best match.&n; */
DECL|function|gbefb_check_var
r_static
r_int
id|gbefb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
r_int
id|line_length
suffix:semicolon
r_struct
id|gbe_timing_info
id|timing
suffix:semicolon
multiline_comment|/* Limit bpp to 8, 16, and 32 */
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_le
l_int|8
)paren
id|var-&gt;bits_per_pixel
op_assign
l_int|8
suffix:semicolon
r_else
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_le
l_int|16
)paren
id|var-&gt;bits_per_pixel
op_assign
l_int|16
suffix:semicolon
r_else
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_le
l_int|32
)paren
id|var-&gt;bits_per_pixel
op_assign
l_int|32
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Check the mode can be mapped linearly with the tile table trick. */
multiline_comment|/* This requires width x height x bytes/pixel be a multiple of 512 */
r_if
c_cond
(paren
(paren
id|var-&gt;xres
op_star
id|var-&gt;yres
op_star
id|var-&gt;bits_per_pixel
)paren
op_amp
l_int|4095
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|var-&gt;grayscale
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No grayscale for now */
r_if
c_cond
(paren
(paren
id|var-&gt;pixclock
op_assign
id|compute_gbe_timing
c_func
(paren
id|var
comma
op_amp
id|timing
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Adjust virtual resolution, if necessary */
r_if
c_cond
(paren
id|var-&gt;xres
OG
id|var-&gt;xres_virtual
op_logical_or
(paren
op_logical_neg
id|ywrap
op_logical_and
op_logical_neg
id|ypan
)paren
)paren
id|var-&gt;xres_virtual
op_assign
id|var-&gt;xres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres
OG
id|var-&gt;yres_virtual
op_logical_or
(paren
op_logical_neg
id|ywrap
op_logical_and
op_logical_neg
id|ypan
)paren
)paren
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_CONUPDATE
)paren
(brace
id|var-&gt;vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
id|var-&gt;xoffset
op_assign
id|info-&gt;var.xoffset
suffix:semicolon
id|var-&gt;yoffset
op_assign
id|info-&gt;var.yoffset
suffix:semicolon
)brace
multiline_comment|/* No grayscale for now */
id|var-&gt;grayscale
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Memory limit */
id|line_length
op_assign
id|var-&gt;xres_virtual
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|line_length
op_star
id|var-&gt;yres_virtual
OG
id|gbe_mem_size
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Virtual resolution too high */
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
multiline_comment|/* RGB 1555 */
id|var-&gt;red.offset
op_assign
l_int|10
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
multiline_comment|/* RGB 8888 */
id|var-&gt;red.offset
op_assign
l_int|24
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;left_margin
op_assign
id|timing.htotal
op_minus
id|timing.hsync_end
suffix:semicolon
id|var-&gt;right_margin
op_assign
id|timing.hsync_start
op_minus
id|timing.width
suffix:semicolon
id|var-&gt;upper_margin
op_assign
id|timing.vtotal
op_minus
id|timing.vsync_end
suffix:semicolon
id|var-&gt;lower_margin
op_assign
id|timing.vsync_start
op_minus
id|timing.height
suffix:semicolon
id|var-&gt;hsync_len
op_assign
id|timing.hsync_end
op_minus
id|timing.hsync_start
suffix:semicolon
id|var-&gt;vsync_len
op_assign
id|timing.vsync_end
op_minus
id|timing.vsync_start
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gbefb_mmap
r_static
r_int
id|gbefb_mmap
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_int
r_int
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_int
r_int
id|offset
op_assign
id|vma-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
r_int
r_int
id|phys_addr
comma
id|phys_size
suffix:semicolon
id|u16
op_star
id|tile
suffix:semicolon
multiline_comment|/* check range */
r_if
c_cond
(paren
id|vma-&gt;vm_pgoff
OG
(paren
op_complement
l_int|0UL
op_rshift
id|PAGE_SHIFT
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_plus
id|size
OG
id|gbe_mem_size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* remap using the fastest write-through mode on architecture */
multiline_comment|/* try not polluting the cache when possible */
id|pgprot_val
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
op_assign
id|pgprot_fb
c_func
(paren
id|pgprot_val
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
)paren
suffix:semicolon
id|vma-&gt;vm_flags
op_or_assign
id|VM_IO
op_or
id|VM_RESERVED
suffix:semicolon
id|vma-&gt;vm_file
op_assign
id|file
suffix:semicolon
multiline_comment|/* look for the starting tile */
id|tile
op_assign
op_amp
id|gbe_tiles.cpu
(braket
id|offset
op_rshift
id|TILE_SHIFT
)braket
suffix:semicolon
id|addr
op_assign
id|vma-&gt;vm_start
suffix:semicolon
id|offset
op_and_assign
id|TILE_MASK
suffix:semicolon
multiline_comment|/* remap each tile separately */
r_do
(brace
id|phys_addr
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
(paren
op_star
id|tile
)paren
)paren
op_lshift
id|TILE_SHIFT
)paren
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
(paren
id|offset
op_plus
id|size
)paren
OL
id|TILE_SIZE
)paren
id|phys_size
op_assign
id|size
suffix:semicolon
r_else
id|phys_size
op_assign
id|TILE_SIZE
op_minus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|remap_pfn_range
c_func
(paren
id|vma
comma
id|addr
comma
id|phys_addr
op_rshift
id|PAGE_SHIFT
comma
id|phys_size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|size
op_sub_assign
id|phys_size
suffix:semicolon
id|addr
op_add_assign
id|phys_size
suffix:semicolon
id|tile
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|gbefb_ops
r_static
r_struct
id|fb_ops
id|gbefb_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|fb_check_var
op_assign
id|gbefb_check_var
comma
dot
id|fb_set_par
op_assign
id|gbefb_set_par
comma
dot
id|fb_setcolreg
op_assign
id|gbefb_setcolreg
comma
dot
id|fb_mmap
op_assign
id|gbefb_mmap
comma
dot
id|fb_blank
op_assign
id|gbefb_blank
comma
dot
id|fb_fillrect
op_assign
id|cfb_fillrect
comma
dot
id|fb_copyarea
op_assign
id|cfb_copyarea
comma
dot
id|fb_imageblit
op_assign
id|cfb_imageblit
comma
dot
id|fb_cursor
op_assign
id|soft_cursor
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Initialization&n; */
DECL|function|gbefb_setup
r_int
id|__init
id|gbefb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;monitor:&quot;
comma
l_int|8
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
op_plus
l_int|8
comma
l_string|&quot;crt&quot;
comma
l_int|3
)paren
)paren
(brace
id|flat_panel_enabled
op_assign
l_int|0
suffix:semicolon
id|default_var
op_assign
op_amp
id|default_var_CRT
suffix:semicolon
id|default_mode
op_assign
op_amp
id|default_mode_CRT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
op_plus
l_int|8
comma
l_string|&quot;1600sw&quot;
comma
l_int|6
)paren
op_logical_or
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
op_plus
l_int|8
comma
l_string|&quot;lcd&quot;
comma
l_int|3
)paren
)paren
(brace
id|flat_panel_enabled
op_assign
l_int|1
suffix:semicolon
id|default_var
op_assign
op_amp
id|default_var_LCD
suffix:semicolon
id|default_mode
op_assign
op_amp
id|default_mode_LCD
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;mem:&quot;
comma
l_int|4
)paren
)paren
(brace
id|gbe_mem_size
op_assign
id|memparse
c_func
(paren
id|this_opt
op_plus
l_int|4
comma
op_amp
id|this_opt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gbe_mem_size
OG
id|CONFIG_FB_GBE_MEM
op_star
l_int|1024
op_star
l_int|1024
)paren
id|gbe_mem_size
op_assign
id|CONFIG_FB_GBE_MEM
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
r_if
c_cond
(paren
id|gbe_mem_size
OL
id|TILE_SIZE
)paren
id|gbe_mem_size
op_assign
id|TILE_SIZE
suffix:semicolon
)brace
r_else
id|mode_option
op_assign
id|this_opt
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gbefb_init
r_int
id|__init
id|gbefb_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef MODULE
r_char
op_star
id|options
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|fb_get_options
c_func
(paren
l_string|&quot;gbefb&quot;
comma
op_amp
id|options
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|gbefb_setup
c_func
(paren
id|options
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|GBE_BASE
comma
r_sizeof
(paren
r_struct
id|sgi_gbe
)paren
comma
l_string|&quot;GBE&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: couldn&squot;t reserve mmio region&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|gbe
op_assign
(paren
r_struct
id|sgi_gbe
op_star
)paren
id|ioremap
c_func
(paren
id|GBE_BASE
comma
r_sizeof
(paren
r_struct
id|sgi_gbe
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gbe
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: couldn&squot;t map mmio region&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out_release_mem_region
suffix:semicolon
)brace
id|gbe_revision
op_assign
id|gbe-&gt;ctrlstat
op_amp
l_int|15
suffix:semicolon
id|gbe_tiles.cpu
op_assign
id|dma_alloc_coherent
c_func
(paren
l_int|NULL
comma
id|GBE_TLB_SIZE
op_star
r_sizeof
(paren
r_uint16
)paren
comma
op_amp
id|gbe_tiles.dma
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gbe_tiles.cpu
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: couldn&squot;t allocate tiles table&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_unmap
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gbe_mem_phys
)paren
(brace
multiline_comment|/* memory was allocated at boot time */
id|gbe_mem
op_assign
id|ioremap_nocache
c_func
(paren
id|gbe_mem_phys
comma
id|gbe_mem_size
)paren
suffix:semicolon
id|gbe_dma_addr
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* try to allocate memory with the classical allocator&n;&t;&t; * this has high chance to fail on low memory machines */
id|gbe_mem
op_assign
id|dma_alloc_coherent
c_func
(paren
l_int|NULL
comma
id|gbe_mem_size
comma
op_amp
id|gbe_dma_addr
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|gbe_mem_phys
op_assign
(paren
r_int
r_int
)paren
id|gbe_dma_addr
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_X86
id|mtrr_add
c_func
(paren
id|gbe_mem_phys
comma
id|gbe_mem_size
comma
id|MTRR_TYPE_WRCOMB
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|gbe_mem
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: couldn&squot;t map framebuffer&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out_tiles_free
suffix:semicolon
)brace
multiline_comment|/* map framebuffer memory into tiles table */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|gbe_mem_size
op_rshift
id|TILE_SHIFT
)paren
suffix:semicolon
id|i
op_increment
)paren
id|gbe_tiles.cpu
(braket
id|i
)braket
op_assign
(paren
id|gbe_mem_phys
op_rshift
id|TILE_SHIFT
)paren
op_plus
id|i
suffix:semicolon
id|fb_info.fbops
op_assign
op_amp
id|gbefb_ops
suffix:semicolon
id|fb_info.pseudo_palette
op_assign
id|pseudo_palette
suffix:semicolon
id|fb_info.flags
op_assign
id|FBINFO_DEFAULT
suffix:semicolon
id|fb_info.screen_base
op_assign
id|gbe_mem
suffix:semicolon
id|fb_alloc_cmap
c_func
(paren
op_amp
id|fb_info.cmap
comma
l_int|256
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reset GBE */
id|gbe_reset
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* turn on default video mode */
r_if
c_cond
(paren
id|fb_find_mode
c_func
(paren
op_amp
id|par_current.var
comma
op_amp
id|fb_info
comma
id|mode_option
comma
l_int|NULL
comma
l_int|0
comma
id|default_mode
comma
l_int|8
)paren
op_eq
l_int|0
)paren
id|par_current.var
op_assign
op_star
id|default_var
suffix:semicolon
id|fb_info.var
op_assign
id|par_current.var
suffix:semicolon
id|gbefb_check_var
c_func
(paren
op_amp
id|par_current.var
comma
op_amp
id|fb_info
)paren
suffix:semicolon
id|gbefb_encode_fix
c_func
(paren
op_amp
id|fb_info.fix
comma
op_amp
id|fb_info.var
)paren
suffix:semicolon
id|fb_info.par
op_assign
op_amp
id|par_current
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
OL
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gbefb: couldn&squot;t register framebuffer&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_gbe_unmap
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fb%d: %s rev %d @ 0x%08x using %dkB memory&bslash;n&quot;
comma
id|fb_info.node
comma
id|fb_info.fix.id
comma
id|gbe_revision
comma
(paren
r_int
)paren
id|GBE_BASE
comma
id|gbe_mem_size
op_rshift
l_int|10
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_gbe_unmap
suffix:colon
r_if
c_cond
(paren
id|gbe_dma_addr
)paren
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|gbe_mem_size
comma
id|gbe_mem
comma
id|gbe_mem_phys
)paren
suffix:semicolon
r_else
id|iounmap
c_func
(paren
id|gbe_mem
)paren
suffix:semicolon
id|out_tiles_free
suffix:colon
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|GBE_TLB_SIZE
op_star
r_sizeof
(paren
r_uint16
)paren
comma
(paren
r_void
op_star
)paren
id|gbe_tiles.cpu
comma
id|gbe_tiles.dma
)paren
suffix:semicolon
id|out_unmap
suffix:colon
id|iounmap
c_func
(paren
id|gbe
)paren
suffix:semicolon
id|out_release_mem_region
suffix:colon
id|release_mem_region
c_func
(paren
id|GBE_BASE
comma
r_sizeof
(paren
r_struct
id|sgi_gbe
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|gbefb_exit
r_void
id|__exit
id|gbefb_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
suffix:semicolon
id|gbe_turn_off
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gbe_dma_addr
)paren
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|gbe_mem_size
comma
id|gbe_mem
comma
id|gbe_mem_phys
)paren
suffix:semicolon
r_else
id|iounmap
c_func
(paren
id|gbe_mem
)paren
suffix:semicolon
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|GBE_TLB_SIZE
op_star
r_sizeof
(paren
r_uint16
)paren
comma
(paren
r_void
op_star
)paren
id|gbe_tiles.cpu
comma
id|gbe_tiles.dma
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|GBE_BASE
comma
r_sizeof
(paren
r_struct
id|sgi_gbe
)paren
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|gbe
)paren
suffix:semicolon
)brace
DECL|variable|gbefb_init
id|module_init
c_func
(paren
id|gbefb_init
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|gbefb_exit
id|module_exit
c_func
(paren
id|gbefb_exit
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
