multiline_comment|/*&n; * linux/drivers/video/sstfb.c -- voodoo graphics frame buffer&n; *&n; *     Copyright (c) 2000-2002 Ghozlane Toumi &lt;gtoumi@laposte.net&gt;&n; *&n; *     Created 15 Jan 2000 by Ghozlane Toumi&n; *&n; * Contributions (and many thanks) :&n; *&n; * 03/2001 James Simmons   &lt;jsimmons@infradead.org&gt;&n; * 04/2001 Paul Mundt      &lt;lethal@chaoticdreams.org&gt;&n; * 05/2001 Urs Ganse       &lt;ursg@uni.de&gt;&n; *&t;(initial work on voodoo2 port, interlace)&n; * 09/2002 Helge Deller    &lt;deller@gmx.de&gt;&n; *&t;(enable driver on big-endian machines (hppa), ioctl fixes)&n; * 12/2002 Helge Deller    &lt;deller@gmx.de&gt;&n; *&t;(port driver to new frambuffer infrastructure)&n; * 01/2003 Helge Deller    &lt;deller@gmx.de&gt;&n; *&t;(initial work on fb hardware acceleration for voodoo2)&n; *&n; */
multiline_comment|/*&n; * The voodoo1 has the following memory mapped address space:&n; * 0x000000 - 0x3fffff : registers              (4MB)&n; * 0x400000 - 0x7fffff : linear frame buffer    (4MB)&n; * 0x800000 - 0xffffff : texture memory         (8MB)&n; */
multiline_comment|/*&n; * misc notes, TODOs, toASKs, and deep thoughts&n;&n;-TODO: at one time or another test that the mode is acceptable by the monitor&n;-ASK: Can I choose different ordering for the color bitfields (rgba argb ...)&n;      wich one should i use ? is there any preferred one ? It seems ARGB is&n;      the one ...&n;-TODO: in  set_var check the validity of timings (hsync vsync)...&n;-TODO: check and recheck the use of sst_wait_idle : we don&squot;t flush the fifo via&n;       a nop command. so it&squot;s ok as long as the commands we pass don&squot;t go&n;       through the fifo. warning: issuing a nop command seems to need pci_fifo&n;-FIXME: in case of failure in the init sequence, be sure we return to a safe&n;        state.&n;-FIXME: 4MB boards have banked memory (FbiInit2 bits 1 &amp; 20)&n; */
multiline_comment|/*&n; * debug info&n; * SST_DEBUG : enable debugging&n; * SST_DEBUG_REG : debug registers&n; *   0 :  no debug&n; *   1 : dac calls, [un]set_bits, FbiInit&n; *   2 : insane debug level (log every register read/write)&n; * SST_DEBUG_FUNC : functions&n; *   0 : no debug&n; *   1 : function call / debug ioctl&n; *   2 : variables&n; *   3 : flood . you don&squot;t want to do that. trust me.&n; * SST_DEBUG_VAR : debug display/var structs&n; *   0 : no debug&n; *   1 : dumps display, fb_var&n; *&n; * sstfb specific ioctls:&n; *   &t;&t;toggle vga (0x46db) : toggle vga_pass_through&n; *   &t;&t;fill fb    (0x46dc) : fills fb&n; *   &t;&t;test disp  (0x46de) : draws a test image&n; */
DECL|macro|SST_DEBUG
macro_line|#undef SST_DEBUG
DECL|macro|SST_DEBUG_REG
mdefine_line|#define SST_DEBUG_REG   0
DECL|macro|SST_DEBUG_FUNC
mdefine_line|#define SST_DEBUG_FUNC  0
DECL|macro|SST_DEBUG_VAR
mdefine_line|#define SST_DEBUG_VAR   0
multiline_comment|/* enable 24/32 bpp functions ? (completely untested!) */
DECL|macro|EN_24_32_BPP
macro_line|#undef EN_24_32_BPP
multiline_comment|/*&n;  Default video mode .&n;  0 800x600@60  took from glide&n;  1 640x480@75  took from glide&n;  2 1024x768@76 std fb.mode&n;  3 640x480@60  glide default */
DECL|macro|DEFAULT_MODE
mdefine_line|#define DEFAULT_MODE 3 
multiline_comment|/*&n; * Includes&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/ioctl.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;video/sstfb.h&gt;
multiline_comment|/* initialized by setup */
DECL|variable|vgapass
r_static
r_int
id|vgapass
suffix:semicolon
multiline_comment|/* enable Vga passthrough cable */
DECL|variable|mem
r_static
r_int
id|mem
suffix:semicolon
multiline_comment|/* mem size in MB, 0 = autodetect */
DECL|variable|clipping
r_static
r_int
id|clipping
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* use clipping (slower, safer) */
DECL|variable|gfxclk
r_static
r_int
id|gfxclk
suffix:semicolon
multiline_comment|/* force FBI freq in Mhz . Dangerous */
DECL|variable|slowpci
r_static
r_int
id|slowpci
suffix:semicolon
multiline_comment|/* slow PCI settings */
DECL|variable|__devinitdata
r_static
r_char
op_star
id|mode_option
id|__devinitdata
suffix:semicolon
r_enum
(brace
DECL|enumerator|ID_VOODOO1
id|ID_VOODOO1
op_assign
l_int|0
comma
DECL|enumerator|ID_VOODOO2
id|ID_VOODOO2
op_assign
l_int|1
comma
)brace
suffix:semicolon
DECL|macro|IS_VOODOO2
mdefine_line|#define IS_VOODOO2(par) ((par)-&gt;type == ID_VOODOO2)
DECL|variable|__devinitdata
r_static
r_struct
id|sst_spec
id|voodoo_spec
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;Voodoo Graphics&quot;
comma
dot
id|default_gfx_clock
op_assign
l_int|50000
comma
dot
id|max_gfxclk
op_assign
l_int|60
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;Voodoo2&quot;
comma
dot
id|default_gfx_clock
op_assign
l_int|75000
comma
dot
id|max_gfxclk
op_assign
l_int|85
)brace
comma
)brace
suffix:semicolon
DECL|variable|sstfb_default
r_static
r_struct
id|fb_var_screeninfo
id|sstfb_default
op_assign
macro_line|#if ( DEFAULT_MODE == 0 )
(brace
multiline_comment|/* 800x600@60, 16 bpp .borowed from glide/sst1/include/sst1init.h */
l_int|800
comma
l_int|600
comma
l_int|800
comma
l_int|600
comma
l_int|0
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
(brace
l_int|11
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|5
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|25000
comma
l_int|86
comma
l_int|41
comma
l_int|23
comma
l_int|1
comma
l_int|127
comma
l_int|4
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
macro_line|#elif ( DEFAULT_MODE == 1 )
(brace
multiline_comment|/* 640x480@75, 16 bpp .borowed from glide/sst1/include/sst1init.h */
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|480
comma
l_int|0
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
(brace
l_int|11
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|5
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|31746
comma
l_int|118
comma
l_int|17
comma
l_int|16
comma
l_int|1
comma
l_int|63
comma
l_int|3
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
macro_line|#elif ( DEFAULT_MODE == 2 )
(brace
multiline_comment|/* 1024x768@76 took from my /etc/fb.modes */
l_int|1024
comma
l_int|768
comma
l_int|1024
comma
l_int|768
comma
l_int|0
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
(brace
l_int|11
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|5
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|11764
comma
l_int|208
comma
l_int|8
comma
l_int|36
comma
l_int|16
comma
l_int|120
comma
l_int|3
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
macro_line|#elif ( DEFAULT_MODE == 3 )
(brace
multiline_comment|/* 640x480@60 , 16bpp glide default ?*/
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|480
comma
l_int|0
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
(brace
l_int|11
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|5
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|39721
comma
l_int|38
comma
l_int|26
comma
l_int|25
comma
l_int|18
comma
l_int|96
comma
l_int|2
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
macro_line|#elif
macro_line|#error &quot;Invalid DEFAULT_MODE value !&quot;
macro_line|#endif
multiline_comment|/*&n; * debug functions&n; */
r_static
r_void
id|sstfb_drawdebugimage
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_dump_regs
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
macro_line|#if (SST_DEBUG_REG &gt; 0)
DECL|function|sst_dbg_print_read_reg
r_static
r_void
id|sst_dbg_print_read_reg
c_func
(paren
id|u32
id|reg
comma
id|u32
id|val
)paren
(brace
r_const
r_char
op_star
id|regname
suffix:semicolon
r_switch
c_cond
(paren
id|reg
)paren
(brace
r_case
id|FBIINIT0
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit0&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT1
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit1&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT2
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit2&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT3
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit3&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT4
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit4&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT5
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit5&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT6
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit6&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|regname
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|regname
op_eq
l_int|NULL
)paren
id|r_ddprintk
c_func
(paren
l_string|&quot;sst_read(%#x): %#x&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
r_else
id|r_dprintk
c_func
(paren
l_string|&quot; sst_read(%s): %#x&bslash;n&quot;
comma
id|regname
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|sst_dbg_print_write_reg
r_static
r_void
id|sst_dbg_print_write_reg
c_func
(paren
id|u32
id|reg
comma
id|u32
id|val
)paren
(brace
r_const
r_char
op_star
id|regname
suffix:semicolon
r_switch
c_cond
(paren
id|reg
)paren
(brace
r_case
id|FBIINIT0
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit0&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT1
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit1&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT2
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit2&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT3
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit3&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT4
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit4&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT5
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit5&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT6
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit6&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|regname
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|regname
op_eq
l_int|NULL
)paren
id|r_ddprintk
c_func
(paren
l_string|&quot;sst_write(%#x, %#x)&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
r_else
id|r_dprintk
c_func
(paren
l_string|&quot; sst_write(%s, %#x)&bslash;n&quot;
comma
id|regname
comma
id|val
)paren
suffix:semicolon
)brace
macro_line|#else /*  (SST_DEBUG_REG &gt; 0) */
DECL|macro|sst_dbg_print_read_reg
macro_line|#  define sst_dbg_print_read_reg(reg, val)&t;do {} while(0)
DECL|macro|sst_dbg_print_write_reg
macro_line|#  define sst_dbg_print_write_reg(reg, val)&t;do {} while(0)
macro_line|#endif /*  (SST_DEBUG_REG &gt; 0) */
multiline_comment|/*&n; * hardware access functions&n; */
multiline_comment|/* register access */
DECL|macro|sst_read
mdefine_line|#define sst_read(reg)&t;&t;__sst_read(par-&gt;mmio_vbase, reg)
DECL|macro|sst_write
mdefine_line|#define sst_write(reg,val)&t;__sst_write(par-&gt;mmio_vbase, reg, val)
DECL|macro|sst_set_bits
mdefine_line|#define sst_set_bits(reg,val)&t;__sst_set_bits(par-&gt;mmio_vbase, reg, val)
DECL|macro|sst_unset_bits
mdefine_line|#define sst_unset_bits(reg,val)&t;__sst_unset_bits(par-&gt;mmio_vbase, reg, val)
DECL|macro|sst_dac_read
mdefine_line|#define sst_dac_read(reg)&t;__sst_dac_read(par-&gt;mmio_vbase, reg)
DECL|macro|sst_dac_write
mdefine_line|#define sst_dac_write(reg,val)&t;__sst_dac_write(par-&gt;mmio_vbase, reg, val)
DECL|macro|dac_i_read
mdefine_line|#define dac_i_read(reg)&t;&t;__dac_i_read(par-&gt;mmio_vbase, reg)
DECL|macro|dac_i_write
mdefine_line|#define dac_i_write(reg,val)&t;__dac_i_write(par-&gt;mmio_vbase, reg, val)
DECL|function|__sst_read
r_static
r_inline
id|u32
id|__sst_read
c_func
(paren
id|u_long
id|vbase
comma
id|u32
id|reg
)paren
(brace
id|u32
id|ret
op_assign
id|readl
c_func
(paren
id|vbase
op_plus
id|reg
)paren
suffix:semicolon
id|sst_dbg_print_read_reg
c_func
(paren
id|reg
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|__sst_write
r_static
r_inline
r_void
id|__sst_write
c_func
(paren
id|u_long
id|vbase
comma
id|u32
id|reg
comma
id|u32
id|val
)paren
(brace
id|sst_dbg_print_write_reg
c_func
(paren
id|reg
comma
id|val
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|vbase
op_plus
id|reg
)paren
suffix:semicolon
)brace
DECL|function|__sst_set_bits
r_static
r_inline
r_void
id|__sst_set_bits
c_func
(paren
id|u_long
id|vbase
comma
id|u32
id|reg
comma
id|u32
id|val
)paren
(brace
id|r_dprintk
c_func
(paren
l_string|&quot;sst_set_bits(%#x, %#x)&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
id|__sst_write
c_func
(paren
id|vbase
comma
id|reg
comma
id|__sst_read
c_func
(paren
id|vbase
comma
id|reg
)paren
op_or
id|val
)paren
suffix:semicolon
)brace
DECL|function|__sst_unset_bits
r_static
r_inline
r_void
id|__sst_unset_bits
c_func
(paren
id|u_long
id|vbase
comma
id|u32
id|reg
comma
id|u32
id|val
)paren
(brace
id|r_dprintk
c_func
(paren
l_string|&quot;sst_unset_bits(%#x, %#x)&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
id|__sst_write
c_func
(paren
id|vbase
comma
id|reg
comma
id|__sst_read
c_func
(paren
id|vbase
comma
id|reg
)paren
op_amp
op_complement
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * wait for the fbi chip. ASK: what happens if the fbi is stuck ?&n; *&n; * the FBI is supposed to be ready if we receive 5 time&n; * in a row a &quot;idle&quot; answer to our requests&n; */
DECL|macro|sst_wait_idle
mdefine_line|#define sst_wait_idle() __sst_wait_idle(par-&gt;mmio_vbase)
DECL|function|__sst_wait_idle
r_static
r_int
id|__sst_wait_idle
c_func
(paren
id|u_long
id|vbase
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if (doFBINOP) __sst_write(vbase, NOPCMD, 0); */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|__sst_read
c_func
(paren
id|vbase
comma
id|STATUS
)paren
op_amp
id|STATUS_FBI_BUSY
)paren
(brace
id|f_dddprintk
c_func
(paren
l_string|&quot;status: busy&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME basicaly, this is a busy wait. maybe not that good. oh well;&n; * this is a small loop after all.&n; * Or maybe we should use mdelay() or udelay() here instead ? */
id|count
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|count
op_increment
suffix:semicolon
id|f_dddprintk
c_func
(paren
l_string|&quot;status: idle(%d)&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_ge
l_int|5
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* XXX  do something to avoid hanging the machine if the voodoo is out */
)brace
)brace
multiline_comment|/* dac access */
multiline_comment|/* dac_read should be remaped to FbiInit2 (via the pci reg init_enable) */
DECL|function|__sst_dac_read
r_static
id|u8
id|__sst_dac_read
c_func
(paren
id|u_long
id|vbase
comma
id|u8
id|reg
)paren
(brace
id|u8
id|ret
suffix:semicolon
id|reg
op_and_assign
l_int|0x07
suffix:semicolon
id|__sst_write
c_func
(paren
id|vbase
comma
id|DAC_DATA
comma
(paren
(paren
id|u32
)paren
id|reg
op_lshift
l_int|8
)paren
op_or
id|DAC_READ_CMD
)paren
suffix:semicolon
id|__sst_wait_idle
c_func
(paren
id|vbase
)paren
suffix:semicolon
multiline_comment|/* udelay(10); */
id|ret
op_assign
id|__sst_read
c_func
(paren
id|vbase
comma
id|DAC_READ
)paren
op_amp
l_int|0xff
suffix:semicolon
id|r_dprintk
c_func
(paren
l_string|&quot;sst_dac_read(%#x): %#x&bslash;n&quot;
comma
id|reg
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|__sst_dac_write
r_static
r_void
id|__sst_dac_write
c_func
(paren
id|u_long
id|vbase
comma
id|u8
id|reg
comma
id|u8
id|val
)paren
(brace
id|r_dprintk
c_func
(paren
l_string|&quot;sst_dac_write(%#x, %#x)&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
id|reg
op_and_assign
l_int|0x07
suffix:semicolon
id|__sst_write
c_func
(paren
id|vbase
comma
id|DAC_DATA
comma
(paren
(paren
(paren
id|u32
)paren
id|reg
op_lshift
l_int|8
)paren
)paren
op_or
(paren
id|u32
)paren
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/* indexed access to ti/att dacs */
DECL|function|__dac_i_read
r_static
id|u32
id|__dac_i_read
c_func
(paren
id|u_long
id|vbase
comma
id|u8
id|reg
)paren
(brace
id|u32
id|ret
suffix:semicolon
id|__sst_dac_write
c_func
(paren
id|vbase
comma
id|DACREG_ADDR_I
comma
id|reg
)paren
suffix:semicolon
id|ret
op_assign
id|__sst_dac_read
c_func
(paren
id|vbase
comma
id|DACREG_DATA_I
)paren
suffix:semicolon
id|r_dprintk
c_func
(paren
l_string|&quot;sst_dac_read_i(%#x): %#x&bslash;n&quot;
comma
id|reg
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|__dac_i_write
r_static
r_void
id|__dac_i_write
c_func
(paren
id|u_long
id|vbase
comma
id|u8
id|reg
comma
id|u8
id|val
)paren
(brace
id|r_dprintk
c_func
(paren
l_string|&quot;sst_dac_write_i(%#x, %#x)&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
id|__sst_dac_write
c_func
(paren
id|vbase
comma
id|DACREG_ADDR_I
comma
id|reg
)paren
suffix:semicolon
id|__sst_dac_write
c_func
(paren
id|vbase
comma
id|DACREG_DATA_I
comma
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/* compute the m,n,p  , returns the real freq&n; * (ics datasheet :  N &lt;-&gt; N1 , P &lt;-&gt; N2)&n; *&n; * Fout= Fref * (M+2)/( 2^P * (N+2))&n; *  we try to get close to the asked freq&n; *  with P as high, and M as low as possible&n; * range:&n; * ti/att : 0 &lt;= M &lt;= 255; 0 &lt;= P &lt;= 3; 0&lt;= N &lt;= 63&n; * ics    : 1 &lt;= M &lt;= 127; 0 &lt;= P &lt;= 3; 1&lt;= N &lt;= 31&n; * we&squot;ll use the lowest limitation, should be precise enouth&n; */
DECL|function|sst_calc_pll
r_static
r_int
id|sst_calc_pll
c_func
(paren
r_const
r_int
id|freq
comma
r_int
op_star
id|freq_out
comma
r_struct
id|pll_timing
op_star
id|t
)paren
(brace
r_int
id|m
comma
id|m2
comma
id|n
comma
id|p
comma
id|best_err
comma
id|fout
suffix:semicolon
r_int
id|best_n
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|best_m
op_assign
op_minus
l_int|1
suffix:semicolon
id|best_err
op_assign
id|freq
suffix:semicolon
id|p
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* f * 2^P = vco should be less than VCOmax ~ 250 MHz for ics*/
r_while
c_loop
(paren
(paren
(paren
l_int|1
op_lshift
id|p
)paren
op_star
id|freq
OG
id|VCO_MAX
)paren
op_logical_and
(paren
id|p
op_ge
l_int|0
)paren
)paren
id|p
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|1
suffix:semicolon
id|n
OL
l_int|32
suffix:semicolon
id|n
op_increment
)paren
(brace
multiline_comment|/* calc 2 * m so we can round it later*/
id|m2
op_assign
(paren
l_int|2
op_star
id|freq
op_star
(paren
l_int|1
op_lshift
id|p
)paren
op_star
(paren
id|n
op_plus
l_int|2
)paren
)paren
op_div
id|DAC_FREF
op_minus
l_int|4
suffix:semicolon
id|m
op_assign
(paren
id|m2
op_mod
l_int|2
)paren
ques
c_cond
id|m2
op_div
l_int|2
op_plus
l_int|1
suffix:colon
id|m2
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|m
op_ge
l_int|128
)paren
r_break
suffix:semicolon
id|fout
op_assign
(paren
id|DAC_FREF
op_star
(paren
id|m
op_plus
l_int|2
)paren
)paren
op_div
(paren
(paren
l_int|1
op_lshift
id|p
)paren
op_star
(paren
id|n
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|abs
c_func
(paren
id|fout
op_minus
id|freq
)paren
OL
id|best_err
)paren
op_logical_and
(paren
id|m
OG
l_int|0
)paren
)paren
(brace
id|best_n
op_assign
id|n
suffix:semicolon
id|best_m
op_assign
id|m
suffix:semicolon
id|best_err
op_assign
id|abs
c_func
(paren
id|fout
op_minus
id|freq
)paren
suffix:semicolon
multiline_comment|/* we get the lowest m , allowing 0.5% error in freq*/
r_if
c_cond
(paren
l_int|200
op_star
id|best_err
OL
id|freq
)paren
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|best_n
op_eq
op_minus
l_int|1
)paren
multiline_comment|/* unlikely, but who knows ? */
r_return
op_minus
id|EINVAL
suffix:semicolon
id|t-&gt;p
op_assign
id|p
suffix:semicolon
id|t-&gt;n
op_assign
id|best_n
suffix:semicolon
id|t-&gt;m
op_assign
id|best_m
suffix:semicolon
op_star
id|freq_out
op_assign
(paren
id|DAC_FREF
op_star
(paren
id|t-&gt;m
op_plus
l_int|2
)paren
)paren
op_div
(paren
(paren
l_int|1
op_lshift
id|t-&gt;p
)paren
op_star
(paren
id|t-&gt;n
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|f_ddprintk
(paren
l_string|&quot;m: %d, n: %d, p: %d, F: %dKhz&bslash;n&quot;
comma
id|t-&gt;m
comma
id|t-&gt;n
comma
id|t-&gt;p
comma
op_star
id|freq_out
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * clear lfb screen&n; */
DECL|function|sstfb_clear_screen
r_static
r_void
id|sstfb_clear_screen
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* clear screen */
id|fb_memset
c_func
(paren
id|info-&gt;screen_base
comma
l_int|0
comma
id|info-&gt;fix.smem_len
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *      sstfb_check_var - Optional function.  Validates a var passed in.&n; *      @var: frame buffer variable screen structure&n; *      @info: frame buffer structure that represents a single frame buffer&n; */
DECL|function|sstfb_check_var
r_static
r_int
id|sstfb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
id|hSyncOff
op_assign
id|var-&gt;xres
op_plus
id|var-&gt;right_margin
op_plus
id|var-&gt;left_margin
suffix:semicolon
r_int
id|vSyncOff
op_assign
id|var-&gt;yres
op_plus
id|var-&gt;lower_margin
op_plus
id|var-&gt;upper_margin
suffix:semicolon
r_int
id|vBackPorch
op_assign
id|var-&gt;left_margin
comma
id|yDim
op_assign
id|var-&gt;yres
suffix:semicolon
r_int
id|vSyncOn
op_assign
id|var-&gt;vsync_len
suffix:semicolon
r_int
id|tiles_in_X
comma
id|real_length
suffix:semicolon
r_int
r_int
id|freq
suffix:semicolon
r_if
c_cond
(paren
id|sst_calc_pll
c_func
(paren
id|PICOS2KHZ
c_func
(paren
id|var-&gt;pixclock
)paren
comma
op_amp
id|freq
comma
op_amp
id|par-&gt;pll
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Pixclock at %ld KHZ out of range&bslash;n&quot;
comma
id|PICOS2KHZ
c_func
(paren
id|var-&gt;pixclock
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|var-&gt;pixclock
op_assign
id|KHZ2PICOS
c_func
(paren
id|freq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
id|vBackPorch
op_add_assign
(paren
id|vBackPorch
op_mod
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
(brace
id|vBackPorch
op_lshift_assign
l_int|1
suffix:semicolon
id|yDim
op_lshift_assign
l_int|1
suffix:semicolon
id|vSyncOn
op_lshift_assign
l_int|1
suffix:semicolon
id|vSyncOff
op_lshift_assign
l_int|1
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|0
dot
dot
dot
l_int|16
suffix:colon
id|var-&gt;bits_per_pixel
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|17
dot
dot
dot
l_int|24
suffix:colon
id|var-&gt;bits_per_pixel
op_assign
l_int|24
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|25
dot
dot
dot
l_int|32
suffix:colon
id|var-&gt;bits_per_pixel
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|eprintk
c_func
(paren
l_string|&quot;Unsupported bpp %d&bslash;n&quot;
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* validity tests */
r_if
c_cond
(paren
(paren
id|var-&gt;xres
op_le
l_int|1
)paren
op_logical_or
(paren
id|yDim
op_le
l_int|0
)paren
op_logical_or
(paren
id|var-&gt;hsync_len
op_le
l_int|1
)paren
op_logical_or
(paren
id|hSyncOff
op_le
l_int|1
)paren
op_logical_or
(paren
id|var-&gt;left_margin
op_le
l_int|2
)paren
op_logical_or
(paren
id|vSyncOn
op_le
l_int|0
)paren
op_logical_or
(paren
id|vSyncOff
op_le
l_int|0
)paren
op_logical_or
(paren
id|vBackPorch
op_le
l_int|0
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IS_VOODOO2
c_func
(paren
id|par
)paren
)paren
(brace
multiline_comment|/* Voodoo 2 limits */
id|tiles_in_X
op_assign
(paren
id|var-&gt;xres
op_plus
l_int|63
)paren
op_div
l_int|64
op_star
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|var-&gt;xres
op_minus
l_int|1
)paren
op_ge
id|POW2
c_func
(paren
l_int|11
)paren
)paren
op_logical_or
(paren
id|yDim
op_ge
id|POW2
c_func
(paren
l_int|11
)paren
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Unsupported resolution %dx%d&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|var-&gt;hsync_len
op_minus
l_int|1
)paren
op_ge
id|POW2
c_func
(paren
l_int|9
)paren
)paren
op_logical_or
(paren
(paren
id|hSyncOff
op_minus
l_int|1
)paren
op_ge
id|POW2
c_func
(paren
l_int|11
)paren
)paren
op_logical_or
(paren
(paren
id|var-&gt;left_margin
op_minus
l_int|2
)paren
op_ge
id|POW2
c_func
(paren
l_int|9
)paren
)paren
op_logical_or
(paren
id|vSyncOn
op_ge
id|POW2
c_func
(paren
l_int|13
)paren
)paren
op_logical_or
(paren
id|vSyncOff
op_ge
id|POW2
c_func
(paren
l_int|13
)paren
)paren
op_logical_or
(paren
id|vBackPorch
op_ge
id|POW2
c_func
(paren
l_int|9
)paren
)paren
op_logical_or
(paren
id|tiles_in_X
op_ge
id|POW2
c_func
(paren
l_int|6
)paren
)paren
op_logical_or
(paren
id|tiles_in_X
op_le
l_int|0
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Unsupported Timings&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Voodoo limits */
id|tiles_in_X
op_assign
(paren
id|var-&gt;xres
op_plus
l_int|63
)paren
op_div
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Interlace/Doublescan not supported %#x&bslash;n&quot;
comma
id|var-&gt;vmode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|var-&gt;xres
op_minus
l_int|1
)paren
op_ge
id|POW2
c_func
(paren
l_int|10
)paren
)paren
op_logical_or
(paren
id|var-&gt;yres
op_ge
id|POW2
c_func
(paren
l_int|10
)paren
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Unsupported resolution %dx%d&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|var-&gt;hsync_len
op_minus
l_int|1
)paren
op_ge
id|POW2
c_func
(paren
l_int|8
)paren
)paren
op_logical_or
(paren
(paren
id|hSyncOff
op_minus
l_int|1
)paren
op_ge
id|POW2
c_func
(paren
l_int|10
)paren
)paren
op_logical_or
(paren
(paren
id|var-&gt;left_margin
op_minus
l_int|2
)paren
op_ge
id|POW2
c_func
(paren
l_int|8
)paren
)paren
op_logical_or
(paren
id|vSyncOn
op_ge
id|POW2
c_func
(paren
l_int|12
)paren
)paren
op_logical_or
(paren
id|vSyncOff
op_ge
id|POW2
c_func
(paren
l_int|12
)paren
)paren
op_logical_or
(paren
id|vBackPorch
op_ge
id|POW2
c_func
(paren
l_int|8
)paren
)paren
op_logical_or
(paren
id|tiles_in_X
op_ge
id|POW2
c_func
(paren
l_int|4
)paren
)paren
op_logical_or
(paren
id|tiles_in_X
op_le
l_int|0
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Unsupported Timings&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* it seems that the fbi uses tiles of 64x16 pixels to &quot;map&quot; the mem */
multiline_comment|/* FIXME: i don&squot;t like this... looks wrong */
id|real_length
op_assign
id|tiles_in_X
op_star
(paren
id|IS_VOODOO2
c_func
(paren
id|par
)paren
ques
c_cond
l_int|32
suffix:colon
l_int|64
)paren
op_star
(paren
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|16
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|real_length
op_star
id|yDim
)paren
OG
id|info-&gt;fix.smem_len
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Not enough video memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|var-&gt;sync
op_and_assign
(paren
id|FB_SYNC_HOR_HIGH_ACT
op_or
id|FB_SYNC_VERT_HIGH_ACT
)paren
suffix:semicolon
id|var-&gt;vmode
op_and_assign
(paren
id|FB_VMODE_INTERLACED
op_or
id|FB_VMODE_DOUBLE
)paren
suffix:semicolon
id|var-&gt;xoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;height
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;width
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * correct the color bit fields&n;&t; */
multiline_comment|/* var-&gt;{red|green|blue}.msb_right = 0; */
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|16
suffix:colon
multiline_comment|/* RGB 565  LfbMode 0 */
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|11
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|24
suffix:colon
multiline_comment|/* RGB 888 LfbMode 4 */
r_case
l_int|32
suffix:colon
multiline_comment|/* ARGB 8888 LfbMode 5 */
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* in 24bpp we fake a 32 bpp mode */
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *      sstfb_set_par - Optional function.  Alters the hardware state.&n; *      @info: frame buffer structure that represents a single frame buffer&n; */
DECL|function|sstfb_set_par
r_static
r_int
id|sstfb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|lfbmode
comma
id|fbiinit1
comma
id|fbiinit2
comma
id|fbiinit3
comma
id|fbiinit5
comma
id|fbiinit6
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_dev
op_star
id|sst_dev
op_assign
id|par-&gt;dev
suffix:semicolon
r_int
r_int
id|freq
suffix:semicolon
r_int
id|ntiles
suffix:semicolon
id|par-&gt;hSyncOff
op_assign
id|info-&gt;var.xres
op_plus
id|info-&gt;var.right_margin
op_plus
id|info-&gt;var.left_margin
suffix:semicolon
id|par-&gt;yDim
op_assign
id|info-&gt;var.yres
suffix:semicolon
id|par-&gt;vSyncOn
op_assign
id|info-&gt;var.vsync_len
suffix:semicolon
id|par-&gt;vSyncOff
op_assign
id|info-&gt;var.yres
op_plus
id|info-&gt;var.lower_margin
op_plus
id|info-&gt;var.upper_margin
suffix:semicolon
id|par-&gt;vBackPorch
op_assign
id|info-&gt;var.upper_margin
suffix:semicolon
multiline_comment|/* We need par-&gt;pll */
id|sst_calc_pll
c_func
(paren
id|PICOS2KHZ
c_func
(paren
id|info-&gt;var.pixclock
)paren
comma
op_amp
id|freq
comma
op_amp
id|par-&gt;pll
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
id|par-&gt;vBackPorch
op_add_assign
(paren
id|par-&gt;vBackPorch
op_mod
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
(brace
id|par-&gt;vBackPorch
op_lshift_assign
l_int|1
suffix:semicolon
id|par-&gt;yDim
op_lshift_assign
l_int|1
suffix:semicolon
id|par-&gt;vSyncOn
op_lshift_assign
l_int|1
suffix:semicolon
id|par-&gt;vSyncOff
op_lshift_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IS_VOODOO2
c_func
(paren
id|par
)paren
)paren
(brace
multiline_comment|/* voodoo2 has 32 pixel wide tiles , BUT stange things&n;&t;&t;   happen with odd number of tiles */
id|par-&gt;tiles_in_X
op_assign
(paren
id|info-&gt;var.xres
op_plus
l_int|63
)paren
op_div
l_int|64
op_star
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* voodoo1 has 64 pixels wide tiles. */
id|par-&gt;tiles_in_X
op_assign
(paren
id|info-&gt;var.xres
op_plus
l_int|63
)paren
op_div
l_int|64
suffix:semicolon
)brace
id|f_ddprintk
c_func
(paren
l_string|&quot;hsync_len hSyncOff vsync_len vSyncOff&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;%-7d %-8d %-7d %-8d&bslash;n&quot;
comma
id|info-&gt;var.hsync_len
comma
id|par-&gt;hSyncOff
comma
id|par-&gt;vSyncOn
comma
id|par-&gt;vSyncOff
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;left_margin upper_margin xres yres Freq&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;%-10d %-10d %-4d %-4d %-8ld&bslash;n&quot;
comma
id|info-&gt;var.left_margin
comma
id|info-&gt;var.upper_margin
comma
id|info-&gt;var.xres
comma
id|info-&gt;var.yres
comma
id|PICOS2KHZ
c_func
(paren
id|info-&gt;var.pixclock
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|NOPCMD
comma
l_int|0
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBIINIT1
comma
id|VIDEO_RESET
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBIINIT0
comma
id|FBI_RESET
op_or
id|FIFO_RESET
)paren
suffix:semicolon
id|sst_unset_bits
c_func
(paren
id|FBIINIT2
comma
id|EN_DRAM_REFRESH
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*sst_unset_bits (FBIINIT0, FBI_RESET); / reenable FBI ? */
id|sst_write
c_func
(paren
id|BACKPORCH
comma
id|par-&gt;vBackPorch
op_lshift
l_int|16
op_or
(paren
id|info-&gt;var.left_margin
op_minus
l_int|2
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|VIDEODIMENSIONS
comma
id|par-&gt;yDim
op_lshift
l_int|16
op_or
(paren
id|info-&gt;var.xres
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|HSYNC
comma
(paren
id|par-&gt;hSyncOff
op_minus
l_int|1
)paren
op_lshift
l_int|16
op_or
(paren
id|info-&gt;var.hsync_len
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|VSYNC
comma
id|par-&gt;vSyncOff
op_lshift
l_int|16
op_or
id|par-&gt;vSyncOn
)paren
suffix:semicolon
id|fbiinit2
op_assign
id|sst_read
c_func
(paren
id|FBIINIT2
)paren
suffix:semicolon
id|fbiinit3
op_assign
id|sst_read
c_func
(paren
id|FBIINIT3
)paren
suffix:semicolon
multiline_comment|/* everything is reset. we enable fbiinit2/3 remap : dac acces ok */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
op_or
id|PCI_REMAP_DAC
)paren
suffix:semicolon
id|par-&gt;dac_sw
dot
id|set_vidmod
c_func
(paren
id|info
comma
id|info-&gt;var.bits_per_pixel
)paren
suffix:semicolon
multiline_comment|/* set video clock */
id|par-&gt;dac_sw
dot
id|set_pll
c_func
(paren
id|info
comma
op_amp
id|par-&gt;pll
comma
id|VID_CLOCK
)paren
suffix:semicolon
multiline_comment|/* disable fbiinit2/3 remap */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
multiline_comment|/* restore fbiinit2/3 */
id|sst_write
c_func
(paren
id|FBIINIT2
comma
id|fbiinit2
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|FBIINIT3
comma
id|fbiinit3
)paren
suffix:semicolon
id|fbiinit1
op_assign
(paren
id|sst_read
c_func
(paren
id|FBIINIT1
)paren
op_amp
id|VIDEO_MASK
)paren
op_or
id|EN_DATA_OE
op_or
id|EN_BLANK_OE
op_or
id|EN_HVSYNC_OE
op_or
id|EN_DCLK_OE
multiline_comment|/* | (15 &lt;&lt; TILES_IN_X_SHIFT) */
op_or
id|SEL_INPUT_VCLK_2X
multiline_comment|/* | (2 &lt;&lt; VCLK_2X_SEL_DEL_SHIFT)&n;&t;            | (2 &lt;&lt; VCLK_DEL_SHIFT) */
suffix:semicolon
multiline_comment|/* try with vclk_in_delay =0 (bits 29:30) , vclk_out_delay =0 (bits(27:28)&n; in (near) future set them accordingly to revision + resolution (cf glide)&n; first understand what it stands for :)&n; FIXME: there are some artefacts... check for the vclk_in_delay&n; lets try with 6ns delay in both vclk_out &amp; in...&n; doh... they&squot;re still there :&bslash;&n;*/
id|ntiles
op_assign
id|par-&gt;tiles_in_X
suffix:semicolon
r_if
c_cond
(paren
id|IS_VOODOO2
c_func
(paren
id|par
)paren
)paren
(brace
id|fbiinit1
op_or_assign
(paren
(paren
id|ntiles
op_amp
l_int|0x20
)paren
op_rshift
l_int|5
)paren
op_lshift
id|TILES_IN_X_MSB_SHIFT
op_or
(paren
(paren
id|ntiles
op_amp
l_int|0x1e
)paren
op_rshift
l_int|1
)paren
op_lshift
id|TILES_IN_X_SHIFT
suffix:semicolon
multiline_comment|/* as the only value of importance for us in fbiinit6 is tiles in X (lsb),&n;   and as reading fbinit 6 will return crap (see FBIINIT6_DEFAULT) we just&n;   write our value. BTW due to the dac unable to read odd number of tiles, this&n;   field is always null ... */
id|fbiinit6
op_assign
(paren
id|ntiles
op_amp
l_int|0x1
)paren
op_lshift
id|TILES_IN_X_LSB_SHIFT
suffix:semicolon
)brace
r_else
id|fbiinit1
op_or_assign
id|ntiles
op_lshift
id|TILES_IN_X_SHIFT
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|16
suffix:colon
id|fbiinit1
op_or_assign
id|SEL_SOURCE_VCLK_2X_SEL
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
multiline_comment|/* sst_set_bits(FBIINIT1, SEL_SOURCE_VCLK_2X_DIV2 | EN_24BPP);*/
id|fbiinit1
op_or_assign
id|SEL_SOURCE_VCLK_2X_SEL
op_or
id|EN_24BPP
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sst_write
c_func
(paren
id|FBIINIT1
comma
id|fbiinit1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_VOODOO2
c_func
(paren
id|par
)paren
)paren
(brace
id|sst_write
c_func
(paren
id|FBIINIT6
comma
id|fbiinit6
)paren
suffix:semicolon
id|fbiinit5
op_assign
id|sst_read
c_func
(paren
id|FBIINIT5
)paren
op_amp
id|FBIINIT5_MASK
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
id|fbiinit5
op_or_assign
id|INTERLACE
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
id|fbiinit5
op_or_assign
id|VDOUBLESCAN
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
id|fbiinit5
op_or_assign
id|HSYNC_HIGH
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
id|fbiinit5
op_or_assign
id|VSYNC_HIGH
suffix:semicolon
id|sst_write
c_func
(paren
id|FBIINIT5
comma
id|fbiinit5
)paren
suffix:semicolon
)brace
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|sst_unset_bits
c_func
(paren
id|FBIINIT1
comma
id|VIDEO_RESET
)paren
suffix:semicolon
id|sst_unset_bits
c_func
(paren
id|FBIINIT0
comma
id|FBI_RESET
op_or
id|FIFO_RESET
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBIINIT2
comma
id|EN_DRAM_REFRESH
)paren
suffix:semicolon
multiline_comment|/* disables fbiinit writes */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_FIFO_WR
)paren
suffix:semicolon
multiline_comment|/* set lfbmode : set mode + front buffer for reads/writes&n;&t;   + disable pipeline */
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|16
suffix:colon
id|lfbmode
op_assign
id|LFB_565
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|24
suffix:colon
id|lfbmode
op_assign
id|LFB_888
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|lfbmode
op_assign
id|LFB_8888
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#if defined(__BIG_ENDIAN)
multiline_comment|/* Enable byte-swizzle functionality in hardware.&n;&t; * With this enabled, all our read- and write-accesses to&n;&t; * the voodoo framebuffer can be done in native format, and&n;&t; * the hardware will automatically convert it to little-endian.&n;&t; * - tested on HP-PARISC, Helge Deller &lt;deller@gmx.de&gt; */
id|lfbmode
op_or_assign
(paren
id|LFB_WORD_SWIZZLE_WR
op_or
id|LFB_BYTE_SWIZZLE_WR
op_or
id|LFB_WORD_SWIZZLE_RD
op_or
id|LFB_BYTE_SWIZZLE_RD
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|clipping
)paren
(brace
id|sst_write
c_func
(paren
id|LFBMODE
comma
id|lfbmode
op_or
id|EN_PXL_PIPELINE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set &quot;clipping&quot; dimensions. If clipping is disabled and&n;&t; * writes to offscreen areas of the framebuffer are performed,&n;&t; * the &quot;behaviour is undefined&quot; (_very_ undefined) - Urs&n;&t; */
multiline_comment|/* btw, it requires enabling pixel pipeline in LFBMODE .&n;&t;   off screen read/writes will just wrap and read/print pixels&n;&t;   on screen. Ugly but not that dangerous */
id|f_ddprintk
c_func
(paren
l_string|&quot;setting clipping dimensions 0..%d, 0..%d&bslash;n&quot;
comma
id|info-&gt;var.xres
op_minus
l_int|1
comma
id|par-&gt;yDim
op_minus
l_int|1
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|CLIP_LEFT_RIGHT
comma
id|info-&gt;var.xres
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|CLIP_LOWY_HIGHY
comma
id|par-&gt;yDim
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBZMODE
comma
id|EN_CLIPPING
op_or
id|EN_RGB_WRITE
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no clipping : direct access, no pipeline */
id|sst_write
c_func
(paren
id|LFBMODE
comma
id|lfbmode
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *      sstfb_setcolreg - Optional function. Sets a color register.&n; *      @regno: hardware colormap register&n; *      @red: frame buffer colormap structure&n; *      @green: The green value which can be up to 16 bits wide&n; *      @blue:  The blue value which can be up to 16 bits wide.&n; *      @transp: If supported the alpha value which can be up to 16 bits wide.&n; *      @info: frame buffer info structure&n; */
DECL|function|sstfb_setcolreg
r_static
r_int
id|sstfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|u32
id|col
suffix:semicolon
id|f_dddprintk
c_func
(paren
l_string|&quot;sstfb_setcolreg&bslash;n&quot;
)paren
suffix:semicolon
id|f_dddprintk
c_func
(paren
l_string|&quot;%-2d rgbt: %#x, %#x, %#x, %#x&bslash;n&quot;
comma
id|regno
comma
id|red
comma
id|green
comma
id|blue
comma
id|transp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
l_int|16
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|red
op_rshift_assign
(paren
l_int|16
op_minus
id|info-&gt;var.red.length
)paren
suffix:semicolon
id|green
op_rshift_assign
(paren
l_int|16
op_minus
id|info-&gt;var.green.length
)paren
suffix:semicolon
id|blue
op_rshift_assign
(paren
l_int|16
op_minus
id|info-&gt;var.blue.length
)paren
suffix:semicolon
id|transp
op_rshift_assign
(paren
l_int|16
op_minus
id|info-&gt;var.transp.length
)paren
suffix:semicolon
id|col
op_assign
(paren
id|red
op_lshift
id|info-&gt;var.red.offset
)paren
op_or
(paren
id|green
op_lshift
id|info-&gt;var.green.offset
)paren
op_or
(paren
id|blue
op_lshift
id|info-&gt;var.blue.offset
)paren
op_or
(paren
id|transp
op_lshift
id|info-&gt;var.transp.offset
)paren
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
id|info-&gt;pseudo_palette
)paren
(braket
id|regno
)braket
op_assign
id|col
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sstfb_ioctl
r_static
r_int
id|sstfb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_struct
id|pci_dev
op_star
id|sst_dev
op_assign
id|par-&gt;dev
suffix:semicolon
id|u32
id|fbiinit0
comma
id|tmp
comma
id|val
suffix:semicolon
id|u_long
id|p
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* dump current FBIINIT values to system log */
r_case
id|_IO
c_func
(paren
l_char|&squot;F&squot;
comma
l_int|0xdb
)paren
suffix:colon
multiline_comment|/* 0x46db */
r_return
id|sstfb_dump_regs
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* fills lfb with #arg pixels */
r_case
id|_IOW
c_func
(paren
l_char|&squot;F&squot;
comma
l_int|0xdc
comma
id|u32
)paren
suffix:colon
multiline_comment|/* 0x46dc */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|val
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
id|info-&gt;fix.smem_len
)paren
id|val
op_assign
id|info-&gt;fix.smem_len
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;filling %#x &bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
id|val
suffix:semicolon
id|p
op_add_assign
l_int|2
)paren
id|writew
c_func
(paren
id|p
op_rshift
l_int|6
comma
id|info-&gt;screen_base
op_plus
id|p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* change VGA pass_through mode */
r_case
id|_IOW
c_func
(paren
l_char|&squot;F&squot;
comma
l_int|0xdd
comma
id|u32
)paren
suffix:colon
multiline_comment|/* 0x46dd */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|val
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|val
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
op_amp
id|tmp
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|tmp
op_or
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
id|fbiinit0
op_assign
id|sst_read
(paren
id|FBIINIT0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
id|sst_write
c_func
(paren
id|FBIINIT0
comma
id|fbiinit0
op_amp
op_complement
id|EN_VGA_PASSTHROUGH
)paren
suffix:semicolon
id|iprintk
c_func
(paren
l_string|&quot;Disabling VGA pass-through&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|sst_write
c_func
(paren
id|FBIINIT0
comma
id|fbiinit0
op_or
id|EN_VGA_PASSTHROUGH
)paren
suffix:semicolon
id|iprintk
c_func
(paren
l_string|&quot;Enabling VGA pass-through&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|tmp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* draw test image  */
r_case
id|_IO
c_func
(paren
l_char|&squot;F&squot;
comma
l_int|0xde
)paren
suffix:colon
multiline_comment|/* 0x46de */
id|f_dprintk
c_func
(paren
l_string|&quot;test color display at %d bpp&bslash;n&quot;
comma
id|info-&gt;var.bits_per_pixel
)paren
suffix:semicolon
id|sstfb_drawdebugimage
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * Screen-to-Screen BitBlt 2D command (for the bmove fb op.) - Voodoo2 only&n; */
macro_line|#if 0
r_static
r_void
id|sstfb_copyarea
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_copyarea
op_star
id|area
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|stride
op_assign
id|info-&gt;fix.line_length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_VOODOO2
c_func
(paren
id|par
)paren
)paren
r_return
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTSRCBASEADDR
comma
l_int|0
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTDSTBASEADDR
comma
l_int|0
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTROP
comma
id|BLTROP_COPY
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTXYSTRIDES
comma
id|stride
op_or
(paren
id|stride
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTSRCXY
comma
id|area-&gt;sx
op_or
(paren
id|area-&gt;sy
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTDSTXY
comma
id|area-&gt;dx
op_or
(paren
id|area-&gt;dy
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTSIZE
comma
id|area-&gt;width
op_or
(paren
id|area-&gt;height
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTCOMMAND
comma
id|BLT_SCR2SCR_BITBLT
op_or
id|LAUNCH_BITBLT
op_or
(paren
id|BLT_16BPP_FMT
op_lshift
l_int|3
)paren
multiline_comment|/* | BIT(14) */
op_or
id|BIT
c_func
(paren
l_int|15
)paren
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * FillRect 2D command (solidfill or invert (via ROP_XOR)) - Voodoo2 only&n; */
DECL|function|sstfb_fillrect
r_static
r_void
id|sstfb_fillrect
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_fillrect
op_star
id|rect
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|stride
op_assign
id|info-&gt;fix.line_length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_VOODOO2
c_func
(paren
id|par
)paren
)paren
r_return
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTCLIPX
comma
id|info-&gt;var.xres
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTCLIPY
comma
id|info-&gt;var.yres
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTDSTBASEADDR
comma
l_int|0
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTCOLOR
comma
id|rect-&gt;color
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTROP
comma
id|rect-&gt;rop
op_eq
id|ROP_COPY
ques
c_cond
id|BLTROP_COPY
suffix:colon
id|BLTROP_XOR
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTXYSTRIDES
comma
id|stride
op_or
(paren
id|stride
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTDSTXY
comma
id|rect-&gt;dx
op_or
(paren
id|rect-&gt;dy
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTSIZE
comma
id|rect-&gt;width
op_or
(paren
id|rect-&gt;height
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|BLTCOMMAND
comma
id|BLT_RECFILL_BITBLT
op_or
id|LAUNCH_BITBLT
op_or
(paren
id|BLT_16BPP_FMT
op_lshift
l_int|3
)paren
multiline_comment|/* | BIT(14) */
op_or
id|BIT
c_func
(paren
l_int|15
)paren
op_or
id|BIT
c_func
(paren
l_int|16
)paren
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * get lfb size &n; */
DECL|function|sst_get_memsize
r_static
r_int
id|__devinit
id|sst_get_memsize
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
id|__u32
op_star
id|memsize
)paren
(brace
id|u_long
id|fbbase_virt
op_assign
(paren
id|u_long
)paren
id|info-&gt;screen_base
suffix:semicolon
multiline_comment|/* force memsize */
r_if
c_cond
(paren
(paren
id|mem
op_ge
l_int|1
)paren
op_logical_and
(paren
id|mem
op_le
l_int|4
)paren
)paren
(brace
op_star
id|memsize
op_assign
(paren
id|mem
op_star
l_int|0x100000
)paren
suffix:semicolon
id|iprintk
c_func
(paren
l_string|&quot;supplied memsize: %#x&bslash;n&quot;
comma
op_star
id|memsize
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|writel
c_func
(paren
l_int|0xdeadbeef
comma
id|fbbase_virt
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xdeadbeef
comma
id|fbbase_virt
op_plus
l_int|0x100000
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xdeadbeef
comma
id|fbbase_virt
op_plus
l_int|0x200000
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;0MB: %#x, 1MB: %#x, 2MB: %#x&bslash;n&quot;
comma
id|readl
c_func
(paren
id|fbbase_virt
)paren
comma
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x100000
)paren
comma
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x200000
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xabcdef01
comma
id|fbbase_virt
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;0MB: %#x, 1MB: %#x, 2MB: %#x&bslash;n&quot;
comma
id|readl
c_func
(paren
id|fbbase_virt
)paren
comma
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x100000
)paren
comma
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x200000
)paren
)paren
suffix:semicolon
multiline_comment|/* checks for 4mb lfb, then 2, then defaults to 1 */
r_if
c_cond
(paren
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x200000
)paren
op_eq
l_int|0xdeadbeef
)paren
op_star
id|memsize
op_assign
l_int|0x400000
suffix:semicolon
r_else
r_if
c_cond
(paren
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x100000
)paren
op_eq
l_int|0xdeadbeef
)paren
op_star
id|memsize
op_assign
l_int|0x200000
suffix:semicolon
r_else
op_star
id|memsize
op_assign
l_int|0x100000
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;detected memsize: %dMB&bslash;n&quot;
comma
op_star
id|memsize
op_rshift
l_int|20
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* &n; * DAC detection routines &n; */
multiline_comment|/* fbi should be idle, and fifo emty and mem disabled */
multiline_comment|/* supposed to detect AT&amp;T ATT20C409 and Ti TVP3409 ramdacs */
DECL|function|sst_detect_att
r_static
r_int
id|__devinit
id|sst_detect_att
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
id|i
comma
id|mir
comma
id|dir
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* backdoor */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* read 4 times RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* the fifth time,  CR0 is read */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* the 6th, manufacturer id register */
id|mir
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/*the 7th, device ID register */
id|dir
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;mir: %#x, dir: %#x&bslash;n&quot;
comma
id|mir
comma
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mir
op_eq
id|DACREG_MIR_ATT
)paren
op_logical_and
(paren
id|dir
op_eq
id|DACREG_DIR_ATT
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sst_detect_ti
r_static
r_int
id|__devinit
id|sst_detect_ti
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
id|i
comma
id|mir
comma
id|dir
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* backdoor */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* read 4 times RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* the fifth time,  CR0 is read */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* the 6th, manufacturer id register */
id|mir
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/*the 7th, device ID register */
id|dir
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;mir: %#x, dir: %#x&bslash;n&quot;
comma
id|mir
comma
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mir
op_eq
id|DACREG_MIR_TI
)paren
op_logical_and
(paren
id|dir
op_eq
id|DACREG_DIR_TI
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * try to detect ICS5342  ramdac&n; * we get the 1st byte (M value) of preset f1,f7 and fB&n; * why those 3 ? mmmh... for now, i&squot;ll do it the glide way...&n; * and ask questions later. anyway, it seems that all the freq registers are&n; * realy at their default state (cf specs) so i ask again, why those 3 regs ?&n; * mmmmh.. it seems that&squot;s much more ugly than i thought. we use f0 and fA for&n; * pll programming, so in fact, we *hope* that the f1, f7 &amp; fB won&squot;t be&n; * touched...&n; * is it realy safe ? how can i reset this ramdac ? geee...&n; */
DECL|function|sst_detect_ics
r_static
r_int
id|__devinit
id|sst_detect_ics
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
id|m_clk0_1
comma
id|m_clk0_7
comma
id|m_clk1_b
suffix:semicolon
r_int
id|n_clk0_1
comma
id|n_clk0_7
comma
id|n_clk1_b
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLRMA
comma
l_int|0x1
)paren
suffix:semicolon
multiline_comment|/* f1 */
id|m_clk0_1
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|n_clk0_1
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLRMA
comma
l_int|0x7
)paren
suffix:semicolon
multiline_comment|/* f7 */
id|m_clk0_7
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|n_clk0_7
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLRMA
comma
l_int|0xb
)paren
suffix:semicolon
multiline_comment|/* fB */
id|m_clk1_b
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|n_clk1_b
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;m_clk0_1: %#x, m_clk0_7: %#x, m_clk1_b: %#x&bslash;n&quot;
comma
id|m_clk0_1
comma
id|m_clk0_7
comma
id|m_clk1_b
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;n_clk0_1: %#x, n_clk0_7: %#x, n_clk1_b: %#x&bslash;n&quot;
comma
id|n_clk0_1
comma
id|n_clk0_7
comma
id|n_clk1_b
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|m_clk0_1
op_eq
id|DACREG_ICS_PLL_CLK0_1_INI
)paren
op_logical_and
(paren
id|m_clk0_7
op_eq
id|DACREG_ICS_PLL_CLK0_7_INI
)paren
op_logical_and
(paren
id|m_clk1_b
op_eq
id|DACREG_ICS_PLL_CLK1_B_INI
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * gfx, video, pci fifo should be reset, dram refresh disabled&n; * see detect_dac&n; */
DECL|function|sst_set_pll_att_ti
r_static
r_int
id|sst_set_pll_att_ti
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|pll_timing
op_star
id|t
comma
r_const
r_int
id|clock
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u8
id|cr0
comma
id|cc
suffix:semicolon
multiline_comment|/* enable indexed mode */
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* backdoor */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* 1 time:  RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* 2 RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* 3 //  */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* 4 //  */
id|cr0
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* 5 CR0 */
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_RMR
comma
(paren
id|cr0
op_amp
l_int|0xf0
)paren
op_or
id|DACREG_CR0_EN_INDEXED
op_or
id|DACREG_CR0_8BIT
op_or
id|DACREG_CR0_PWDOWN
)paren
suffix:semicolon
multiline_comment|/* so, now we are in indexed mode . dunno if its common, but&n;&t;   i find this way of doing things a little bit weird :p */
id|udelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
id|cc
op_assign
id|dac_i_read
c_func
(paren
id|DACREG_CC_I
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|clock
)paren
(brace
r_case
id|VID_CLOCK
suffix:colon
id|dac_i_write
c_func
(paren
id|DACREG_AC0_I
comma
id|t-&gt;m
)paren
suffix:semicolon
id|dac_i_write
c_func
(paren
id|DACREG_AC1_I
comma
id|t-&gt;p
op_lshift
l_int|6
op_or
id|t-&gt;n
)paren
suffix:semicolon
id|dac_i_write
c_func
(paren
id|DACREG_CC_I
comma
(paren
id|cc
op_amp
l_int|0x0f
)paren
op_or
id|DACREG_CC_CLKA
op_or
id|DACREG_CC_CLKA_C
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GFX_CLOCK
suffix:colon
id|dac_i_write
c_func
(paren
id|DACREG_BD0_I
comma
id|t-&gt;m
)paren
suffix:semicolon
id|dac_i_write
c_func
(paren
id|DACREG_BD1_I
comma
id|t-&gt;p
op_lshift
l_int|6
op_or
id|t-&gt;n
)paren
suffix:semicolon
id|dac_i_write
c_func
(paren
id|DACREG_CC_I
comma
(paren
id|cc
op_amp
l_int|0xf0
)paren
op_or
id|DACREG_CC_CLKB
op_or
id|DACREG_CC_CLKB_D
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;%s: wrong clock code &squot;%d&squot;&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|clock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
multiline_comment|/* power up the dac &amp; return to &quot;normal&quot; non-indexed mode */
id|dac_i_write
c_func
(paren
id|DACREG_CR0_I
comma
id|cr0
op_amp
op_complement
id|DACREG_CR0_PWDOWN
op_amp
op_complement
id|DACREG_CR0_EN_INDEXED
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sst_set_pll_ics
r_static
r_int
id|sst_set_pll_ics
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|pll_timing
op_star
id|t
comma
r_const
r_int
id|clock
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u8
id|pll_ctrl
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLRMA
comma
id|DACREG_ICS_PLL_CTRL
)paren
suffix:semicolon
id|pll_ctrl
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|clock
)paren
(brace
r_case
id|VID_CLOCK
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLWMA
comma
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* CLK0, f0 */
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
id|t-&gt;m
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
id|t-&gt;p
op_lshift
l_int|5
op_or
id|t-&gt;n
)paren
suffix:semicolon
multiline_comment|/* selects freq f0 for clock 0 */
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLWMA
comma
id|DACREG_ICS_PLL_CTRL
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
(paren
id|pll_ctrl
op_amp
l_int|0xd8
)paren
op_or
id|DACREG_ICS_CLK0
op_or
id|DACREG_ICS_CLK0_0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GFX_CLOCK
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLWMA
comma
l_int|0xa
)paren
suffix:semicolon
multiline_comment|/* CLK1, fA */
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
id|t-&gt;m
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
id|t-&gt;p
op_lshift
l_int|5
op_or
id|t-&gt;n
)paren
suffix:semicolon
multiline_comment|/* selects freq fA for clock 1 */
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLWMA
comma
id|DACREG_ICS_PLL_CTRL
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
(paren
id|pll_ctrl
op_amp
l_int|0xef
)paren
op_or
id|DACREG_ICS_CLK1_A
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;%s: wrong clock code &squot;%d&squot;&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|clock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sst_set_vidmod_att_ti
r_static
r_void
id|sst_set_vidmod_att_ti
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_int
id|bpp
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u8
id|cr0
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* backdoor */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* read 4 times RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* the fifth time,  CR0 is read */
id|cr0
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* backdoor */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* read 4 times RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* cr0 */
r_switch
c_cond
(paren
id|bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_RMR
comma
(paren
id|cr0
op_amp
l_int|0x0f
)paren
op_or
id|DACREG_CR0_16BPP
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_RMR
comma
(paren
id|cr0
op_amp
l_int|0x0f
)paren
op_or
id|DACREG_CR0_24BPP
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;%s: bad depth &squot;%u&squot;&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|bpp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|sst_set_vidmod_ics
r_static
r_void
id|sst_set_vidmod_ics
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_int
id|bpp
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_switch
c_cond
(paren
id|bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_CMD
comma
id|DACREG_ICS_CMD_16BPP
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_CMD
comma
id|DACREG_ICS_CMD_24BPP
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;%s: bad depth &squot;%u&squot;&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|bpp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * detect dac type&n; * prerequisite : write to FbiInitx enabled, video and fbi and pci fifo reset,&n; * dram refresh disabled, FbiInit remaped.&n; * TODO: mmh.. maybe i shoud put the &quot;prerequisite&quot; in the func ...&n; */
DECL|variable|__devinitdata
r_static
r_struct
id|dac_switch
id|dacs
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;TI TVP3409&quot;
comma
dot
id|detect
op_assign
id|sst_detect_ti
comma
dot
id|set_pll
op_assign
id|sst_set_pll_att_ti
comma
dot
id|set_vidmod
op_assign
id|sst_set_vidmod_att_ti
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;AT&amp;T ATT20C409&quot;
comma
dot
id|detect
op_assign
id|sst_detect_att
comma
dot
id|set_pll
op_assign
id|sst_set_pll_att_ti
comma
dot
id|set_vidmod
op_assign
id|sst_set_vidmod_att_ti
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;ICS ICS5342&quot;
comma
dot
id|detect
op_assign
id|sst_detect_ics
comma
dot
id|set_pll
op_assign
id|sst_set_pll_ics
comma
dot
id|set_vidmod
op_assign
id|sst_set_vidmod_ics
)brace
comma
)brace
suffix:semicolon
DECL|function|sst_detect_dactype
r_static
r_int
id|__devinit
id|sst_detect_dactype
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|sstfb_par
op_star
id|par
)paren
(brace
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|dacs
)paren
op_div
r_sizeof
(paren
id|dacs
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ret
op_assign
id|dacs
(braket
id|i
)braket
dot
id|detect
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_return
l_int|0
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;%s found %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dacs
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
id|par-&gt;dac_sw
op_assign
id|dacs
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Internal Routines&n; */
DECL|function|sst_init
r_static
r_int
id|__devinit
id|sst_init
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|sstfb_par
op_star
id|par
)paren
(brace
id|u32
id|fbiinit0
comma
id|fbiinit1
comma
id|fbiinit4
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|par-&gt;dev
suffix:semicolon
r_struct
id|pll_timing
id|gfx_timings
suffix:semicolon
r_struct
id|sst_spec
op_star
id|spec
suffix:semicolon
r_int
id|Fout
suffix:semicolon
id|spec
op_assign
op_amp
id|voodoo_spec
(braket
id|par-&gt;type
)braket
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot; fbiinit0   fbiinit1   fbiinit2   fbiinit3   fbiinit4  &quot;
l_string|&quot; fbiinit6&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;%0#10x %0#10x %0#10x %0#10x %0#10x %0#10x&bslash;n&quot;
comma
id|sst_read
c_func
(paren
id|FBIINIT0
)paren
comma
id|sst_read
c_func
(paren
id|FBIINIT1
)paren
comma
id|sst_read
c_func
(paren
id|FBIINIT2
)paren
comma
id|sst_read
c_func
(paren
id|FBIINIT3
)paren
comma
id|sst_read
c_func
(paren
id|FBIINIT4
)paren
comma
id|sst_read
c_func
(paren
id|FBIINIT6
)paren
)paren
suffix:semicolon
multiline_comment|/* disable video clock */
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_VCLK_DISABLE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* enable writing to init registers, disable pci fifo */
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
multiline_comment|/* reset video */
id|sst_set_bits
c_func
(paren
id|FBIINIT1
comma
id|VIDEO_RESET
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* reset gfx + pci fifo */
id|sst_set_bits
c_func
(paren
id|FBIINIT0
comma
id|FBI_RESET
op_or
id|FIFO_RESET
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* unreset fifo */
multiline_comment|/*sst_unset_bits(FBIINIT0, FIFO_RESET);&n;&t;sst_wait_idle();*/
multiline_comment|/* unreset FBI */
multiline_comment|/*sst_unset_bits(FBIINIT0, FBI_RESET);&n;&t;sst_wait_idle();*/
multiline_comment|/* disable dram refresh */
id|sst_unset_bits
c_func
(paren
id|FBIINIT2
comma
id|EN_DRAM_REFRESH
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* remap fbinit2/3 to dac */
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
op_or
id|PCI_REMAP_DAC
)paren
suffix:semicolon
multiline_comment|/* detect dac type */
r_if
c_cond
(paren
op_logical_neg
id|sst_detect_dactype
c_func
(paren
id|info
comma
id|par
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Unknown dac type&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//FIXME watch it: we are not in a safe state, bad bad bad.
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set graphic clock */
id|par-&gt;gfx_clock
op_assign
id|spec-&gt;default_gfx_clock
suffix:semicolon
r_if
c_cond
(paren
(paren
id|gfxclk
OG
l_int|10
)paren
op_logical_and
(paren
id|gfxclk
OL
id|spec-&gt;max_gfxclk
)paren
)paren
(brace
id|iprintk
c_func
(paren
l_string|&quot;Using supplied graphic freq : %dMHz&bslash;n&quot;
comma
id|gfxclk
)paren
suffix:semicolon
id|par-&gt;gfx_clock
op_assign
id|gfxclk
op_star
l_int|1000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gfxclk
)paren
(brace
id|wprintk
(paren
l_string|&quot;%dMhz is way out of spec! Using default&bslash;n&quot;
comma
id|gfxclk
)paren
suffix:semicolon
)brace
id|sst_calc_pll
c_func
(paren
id|par-&gt;gfx_clock
comma
op_amp
id|Fout
comma
op_amp
id|gfx_timings
)paren
suffix:semicolon
id|par-&gt;dac_sw
dot
id|set_pll
c_func
(paren
id|info
comma
op_amp
id|gfx_timings
comma
id|GFX_CLOCK
)paren
suffix:semicolon
multiline_comment|/* disable fbiinit remap */
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
op_or
id|PCI_EN_FIFO_WR
)paren
suffix:semicolon
multiline_comment|/* defaults init registers */
multiline_comment|/* FbiInit0: unreset gfx, unreset fifo */
id|fbiinit0
op_assign
id|FBIINIT0_DEFAULT
suffix:semicolon
id|fbiinit1
op_assign
id|FBIINIT1_DEFAULT
suffix:semicolon
id|fbiinit4
op_assign
id|FBIINIT4_DEFAULT
suffix:semicolon
r_if
c_cond
(paren
id|vgapass
)paren
id|fbiinit0
op_and_assign
op_complement
id|EN_VGA_PASSTHROUGH
suffix:semicolon
r_else
id|fbiinit0
op_or_assign
id|EN_VGA_PASSTHROUGH
suffix:semicolon
r_if
c_cond
(paren
id|slowpci
)paren
(brace
id|fbiinit1
op_or_assign
id|SLOW_PCI_WRITES
suffix:semicolon
id|fbiinit4
op_or_assign
id|SLOW_PCI_READS
suffix:semicolon
)brace
r_else
(brace
id|fbiinit1
op_and_assign
op_complement
id|SLOW_PCI_WRITES
suffix:semicolon
id|fbiinit4
op_and_assign
op_complement
id|SLOW_PCI_READS
suffix:semicolon
)brace
id|sst_write
c_func
(paren
id|FBIINIT0
comma
id|fbiinit0
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|FBIINIT1
comma
id|fbiinit1
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|FBIINIT2
comma
id|FBIINIT2_DEFAULT
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|FBIINIT3
comma
id|FBIINIT3_DEFAULT
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|FBIINIT4
comma
id|fbiinit4
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_VOODOO2
c_func
(paren
id|par
)paren
)paren
(brace
id|sst_write
c_func
(paren
id|FBIINIT6
comma
id|FBIINIT6_DEFAULT
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
)brace
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_FIFO_WR
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_VCLK_ENABLE
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sst_shutdown
r_static
r_void
id|__devexit
id|sst_shutdown
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|par-&gt;dev
suffix:semicolon
r_struct
id|pll_timing
id|gfx_timings
suffix:semicolon
r_int
id|Fout
suffix:semicolon
multiline_comment|/* reset video, gfx, fifo, disable dram + remap fbiinit2/3 */
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBIINIT1
comma
id|VIDEO_RESET
op_or
id|EN_BLANKING
)paren
suffix:semicolon
id|sst_unset_bits
c_func
(paren
id|FBIINIT2
comma
id|EN_DRAM_REFRESH
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBIINIT0
comma
id|FBI_RESET
op_or
id|FIFO_RESET
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
op_or
id|PCI_REMAP_DAC
)paren
suffix:semicolon
multiline_comment|/* set 20Mhz gfx clock */
id|sst_calc_pll
c_func
(paren
l_int|20000
comma
op_amp
id|Fout
comma
op_amp
id|gfx_timings
)paren
suffix:semicolon
id|par-&gt;dac_sw
dot
id|set_pll
c_func
(paren
id|info
comma
op_amp
id|gfx_timings
comma
id|GFX_CLOCK
)paren
suffix:semicolon
multiline_comment|/* TODO maybe shutdown the dac, vrefresh and so on... */
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
id|sst_unset_bits
c_func
(paren
id|FBIINIT0
comma
id|FBI_RESET
op_or
id|FIFO_RESET
op_or
id|EN_VGA_PASSTHROUGH
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_VCLK_DISABLE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* maybe keep fbiinit* and PCI_INIT_enable in the fb_info struct&n;&t; * from start ? */
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_INIT_ENABLE
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Interface to the world&n; */
DECL|function|sstfb_setup
r_int
id|__init
id|sstfb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;option %s&bslash;n&quot;
comma
id|this_opt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;vganopass&quot;
)paren
)paren
id|vgapass
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;vgapass&quot;
)paren
)paren
id|vgapass
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;clipping&quot;
)paren
)paren
id|clipping
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;noclipping&quot;
)paren
)paren
id|clipping
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;fastpci&quot;
)paren
)paren
id|slowpci
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;slowpci&quot;
)paren
)paren
id|slowpci
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;mem:&quot;
comma
l_int|4
)paren
)paren
id|mem
op_assign
id|simple_strtoul
(paren
id|this_opt
op_plus
l_int|4
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;gfxclk:&quot;
comma
l_int|7
)paren
)paren
id|gfxclk
op_assign
id|simple_strtoul
(paren
id|this_opt
op_plus
l_int|7
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
id|mode_option
op_assign
id|this_opt
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sstfb_ops
r_static
r_struct
id|fb_ops
id|sstfb_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|fb_check_var
op_assign
id|sstfb_check_var
comma
dot
id|fb_set_par
op_assign
id|sstfb_set_par
comma
dot
id|fb_setcolreg
op_assign
id|sstfb_setcolreg
comma
dot
id|fb_fillrect
op_assign
id|cfb_fillrect
comma
multiline_comment|/* sstfb_fillrect */
dot
id|fb_copyarea
op_assign
id|cfb_copyarea
comma
multiline_comment|/* sstfb_copyarea */
dot
id|fb_imageblit
op_assign
id|cfb_imageblit
comma
dot
id|fb_cursor
op_assign
id|soft_cursor
comma
dot
id|fb_ioctl
op_assign
id|sstfb_ioctl
comma
)brace
suffix:semicolon
DECL|function|sstfb_probe
r_static
r_int
id|__devinit
id|sstfb_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_struct
id|fb_fix_screeninfo
op_star
id|fix
suffix:semicolon
r_struct
id|sstfb_par
op_star
id|par
suffix:semicolon
r_struct
id|sst_spec
op_star
id|spec
suffix:semicolon
r_int
id|err
suffix:semicolon
r_struct
id|all_info
(brace
r_struct
id|fb_info
id|info
suffix:semicolon
r_struct
id|sstfb_par
id|par
suffix:semicolon
id|u32
id|pseudo_palette
(braket
l_int|16
)braket
suffix:semicolon
)brace
op_star
id|all
suffix:semicolon
multiline_comment|/* Enable device in PCI config. */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;cannot enable device&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Allocate the fb and par structures.  */
id|all
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|all
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|all
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|all
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|all
)paren
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|all
)paren
suffix:semicolon
id|info
op_assign
op_amp
id|all-&gt;info
suffix:semicolon
id|par
op_assign
id|info-&gt;par
op_assign
op_amp
id|all-&gt;par
suffix:semicolon
id|fix
op_assign
op_amp
id|info-&gt;fix
suffix:semicolon
id|par-&gt;type
op_assign
id|id-&gt;driver_data
suffix:semicolon
id|spec
op_assign
op_amp
id|voodoo_spec
(braket
id|par-&gt;type
)braket
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;found device : %s&bslash;n&quot;
comma
id|spec-&gt;name
)paren
suffix:semicolon
id|par-&gt;dev
op_assign
id|pdev
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_REVISION_ID
comma
op_amp
id|par-&gt;revision
)paren
suffix:semicolon
id|fix-&gt;mmio_start
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|fix-&gt;mmio_len
op_assign
l_int|0x400000
suffix:semicolon
id|fix-&gt;smem_start
op_assign
id|fix-&gt;mmio_start
op_plus
l_int|0x400000
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|fix-&gt;mmio_start
comma
id|fix-&gt;mmio_len
comma
l_string|&quot;sstfb MMIO&quot;
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;cannot reserve mmio memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail_mmio_mem
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|fix-&gt;smem_start
comma
l_int|0x400000
comma
l_string|&quot;sstfb FB&quot;
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;cannot reserve fb memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail_fb_mem
suffix:semicolon
)brace
id|par-&gt;mmio_vbase
op_assign
(paren
id|u_long
)paren
id|ioremap_nocache
c_func
(paren
id|fix-&gt;mmio_start
comma
id|fix-&gt;mmio_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|par-&gt;mmio_vbase
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;cannot remap register area %#lx&bslash;n&quot;
comma
id|fix-&gt;mmio_start
)paren
suffix:semicolon
r_goto
id|fail_mmio_remap
suffix:semicolon
)brace
id|info-&gt;screen_base
op_assign
id|ioremap_nocache
c_func
(paren
id|fix-&gt;smem_start
comma
l_int|0x400000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;screen_base
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;cannot remap framebuffer %#lx&bslash;n&quot;
comma
id|fix-&gt;smem_start
)paren
suffix:semicolon
r_goto
id|fail_fb_remap
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sst_init
c_func
(paren
id|info
comma
id|par
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Init failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|sst_get_memsize
c_func
(paren
id|info
comma
op_amp
id|fix-&gt;smem_len
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|fix-&gt;id
comma
id|spec-&gt;name
comma
r_sizeof
(paren
id|fix-&gt;id
)paren
)paren
suffix:semicolon
id|iprintk
c_func
(paren
l_string|&quot;%s (revision %d) with %s dac&bslash;n&quot;
comma
id|fix-&gt;id
comma
id|par-&gt;revision
comma
id|par-&gt;dac_sw.name
)paren
suffix:semicolon
id|iprintk
c_func
(paren
l_string|&quot;framebuffer at %#lx, mapped to 0x%p, size %dMB&bslash;n&quot;
comma
id|fix-&gt;smem_start
comma
id|info-&gt;screen_base
comma
id|fix-&gt;smem_len
op_rshift
l_int|20
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;regbase_virt: %#lx&bslash;n&quot;
comma
id|par-&gt;mmio_vbase
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;membase_phys: %#lx&bslash;n&quot;
comma
id|fix-&gt;smem_start
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;fbbase_virt: %p&bslash;n&quot;
comma
id|info-&gt;screen_base
)paren
suffix:semicolon
id|info-&gt;flags
op_assign
id|FBINFO_DEFAULT
suffix:semicolon
id|info-&gt;fbops
op_assign
op_amp
id|sstfb_ops
suffix:semicolon
id|info-&gt;currcon
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;pseudo_palette
op_assign
op_amp
id|all-&gt;pseudo_palette
suffix:semicolon
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
id|fix-&gt;accel
op_assign
id|FB_ACCEL_NONE
suffix:semicolon
multiline_comment|/* FIXME */
multiline_comment|/*&n;&t; * According to the specs, the linelength must be of 1024 *pixels*&n;&t; * and the 24bpp mode is in fact a 32 bpp mode.&n;&t; */
id|fix-&gt;line_length
op_assign
l_int|2048
suffix:semicolon
multiline_comment|/* default value, for 24 or 32bit: 4096 */
r_if
c_cond
(paren
id|mode_option
op_logical_and
id|fb_find_mode
c_func
(paren
op_amp
id|info-&gt;var
comma
id|info
comma
id|mode_option
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|16
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;can&squot;t set supplied video mode. Using default&bslash;n&quot;
)paren
suffix:semicolon
id|info-&gt;var
op_assign
id|sstfb_default
suffix:semicolon
)brace
r_else
id|info-&gt;var
op_assign
id|sstfb_default
suffix:semicolon
r_if
c_cond
(paren
id|sstfb_check_var
c_func
(paren
op_amp
id|info-&gt;var
comma
id|info
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;invalid default video mode.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sstfb_set_par
c_func
(paren
id|info
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;can&squot;t set default video mode.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|fb_alloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
comma
l_int|256
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* register fb */
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
id|info
)paren
OL
l_int|0
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;can&squot;t register framebuffer.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|1
)paren
multiline_comment|/* set to 0 to see an initial bitmap instead */
id|sstfb_clear_screen
c_func
(paren
id|info
)paren
suffix:semicolon
r_else
id|sstfb_drawdebugimage
c_func
(paren
id|info
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fb%d: %s frame buffer device at 0x%p&bslash;n&quot;
comma
id|info-&gt;node
comma
id|fix-&gt;id
comma
id|info-&gt;screen_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|iounmap
c_func
(paren
id|info-&gt;screen_base
)paren
suffix:semicolon
id|fail_fb_remap
suffix:colon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|par-&gt;mmio_vbase
)paren
suffix:semicolon
id|fail_mmio_remap
suffix:colon
id|release_mem_region
c_func
(paren
id|fix-&gt;smem_start
comma
l_int|0x400000
)paren
suffix:semicolon
id|fail_fb_mem
suffix:colon
id|release_mem_region
c_func
(paren
id|fix-&gt;mmio_start
comma
id|info-&gt;fix.mmio_len
)paren
suffix:semicolon
id|fail_mmio_mem
suffix:colon
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* no voodoo detected */
)brace
DECL|function|sstfb_remove
r_static
r_void
id|__devexit
id|sstfb_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|sstfb_par
op_star
id|par
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
id|info
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|sst_shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
id|unregister_framebuffer
c_func
(paren
id|info
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|info-&gt;screen_base
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|par-&gt;mmio_vbase
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|info-&gt;fix.smem_start
comma
l_int|0x400000
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|info-&gt;fix.mmio_start
comma
id|info-&gt;fix.mmio_len
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
DECL|variable|sstfb_id_tbl
r_static
r_struct
id|pci_device_id
id|sstfb_id_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_3DFX
comma
id|PCI_DEVICE_ID_3DFX_VOODOO
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|ID_VOODOO1
)brace
comma
(brace
id|PCI_VENDOR_ID_3DFX
comma
id|PCI_DEVICE_ID_3DFX_VOODOO2
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|ID_VOODOO2
)brace
comma
(brace
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|variable|sstfb_driver
r_static
r_struct
id|pci_driver
id|sstfb_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;sstfb&quot;
comma
dot
id|id_table
op_assign
id|sstfb_id_tbl
comma
dot
id|probe
op_assign
id|sstfb_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|sstfb_remove
)paren
comma
)brace
suffix:semicolon
DECL|function|sstfb_init
r_int
id|__devinit
id|sstfb_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|sstfb_driver
)paren
suffix:semicolon
)brace
DECL|function|sstfb_exit
r_void
id|__devexit
id|sstfb_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|sstfb_driver
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * testing and debugging functions&n; */
DECL|function|sstfb_dump_regs
r_static
r_int
id|sstfb_dump_regs
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
macro_line|#ifdef SST_DEBUG
r_static
r_struct
(brace
id|u32
id|reg
suffix:semicolon
r_const
r_char
op_star
id|reg_name
suffix:semicolon
)brace
id|pci_regs
(braket
)braket
op_assign
(brace
(brace
id|PCI_INIT_ENABLE
comma
l_string|&quot;initenable&quot;
)brace
comma
(brace
id|PCI_VCLK_ENABLE
comma
l_string|&quot;enable vclk&quot;
)brace
comma
(brace
id|PCI_VCLK_DISABLE
comma
l_string|&quot;disable vclk&quot;
)brace
comma
)brace
suffix:semicolon
r_static
r_struct
(brace
id|u32
id|reg
suffix:semicolon
r_const
r_char
op_star
id|reg_name
suffix:semicolon
)brace
id|sst_regs
(braket
)braket
op_assign
(brace
(brace
id|FBIINIT0
comma
l_string|&quot;fbiinit0&quot;
)brace
comma
(brace
id|FBIINIT1
comma
l_string|&quot;fbiinit1&quot;
)brace
comma
(brace
id|FBIINIT2
comma
l_string|&quot;fbiinit2&quot;
)brace
comma
(brace
id|FBIINIT3
comma
l_string|&quot;fbiinit3&quot;
)brace
comma
(brace
id|FBIINIT4
comma
l_string|&quot;fbiinit4&quot;
)brace
comma
(brace
id|FBIINIT5
comma
l_string|&quot;fbiinit5&quot;
)brace
comma
(brace
id|FBIINIT6
comma
l_string|&quot;fbiinit6&quot;
)brace
comma
(brace
id|FBIINIT7
comma
l_string|&quot;fbiinit7&quot;
)brace
comma
(brace
id|LFBMODE
comma
l_string|&quot;lfbmode&quot;
)brace
comma
(brace
id|FBZMODE
comma
l_string|&quot;fbzmode&quot;
)brace
comma
)brace
suffix:semicolon
r_const
r_int
id|pci_s
op_assign
r_sizeof
(paren
id|pci_regs
)paren
op_div
r_sizeof
(paren
id|pci_regs
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_const
r_int
id|sst_s
op_assign
r_sizeof
(paren
id|sst_regs
)paren
op_div
r_sizeof
(paren
id|sst_regs
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_struct
id|sstfb_par
op_star
id|par
op_assign
(paren
r_struct
id|sstfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|par-&gt;dev
suffix:semicolon
id|u32
id|pci_res
(braket
id|pci_s
)braket
suffix:semicolon
id|u32
id|sst_res
(braket
id|sst_s
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pci_s
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|pci_regs
(braket
id|i
)braket
dot
id|reg
comma
op_amp
id|pci_res
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sst_s
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sst_res
(braket
id|i
)braket
op_assign
id|sst_read
c_func
(paren
id|sst_regs
(braket
id|i
)braket
dot
id|reg
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;hardware register dump:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pci_s
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s %0#10x&bslash;n&quot;
comma
id|pci_regs
(braket
id|i
)braket
dot
id|reg_name
comma
id|pci_res
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sst_s
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s %0#10x&bslash;n&quot;
comma
id|sst_regs
(braket
id|i
)braket
dot
id|reg_name
comma
id|sst_res
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
)brace
DECL|function|sstfb_fillrect_softw
r_static
r_void
id|sstfb_fillrect_softw
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_fillrect
op_star
id|rect
)paren
(brace
r_int
r_int
id|fbbase_virt
op_assign
(paren
r_int
r_int
)paren
id|info-&gt;screen_base
suffix:semicolon
r_int
id|x
comma
id|y
comma
id|w
op_assign
id|info-&gt;var.bits_per_pixel
op_eq
l_int|16
ques
c_cond
l_int|2
suffix:colon
l_int|4
suffix:semicolon
id|u32
id|color
op_assign
id|rect-&gt;color
comma
id|height
op_assign
id|rect-&gt;height
suffix:semicolon
r_int
r_int
id|p
suffix:semicolon
r_if
c_cond
(paren
id|w
op_eq
l_int|2
)paren
id|color
op_or_assign
id|color
op_lshift
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
id|rect-&gt;dy
suffix:semicolon
id|height
suffix:semicolon
id|y
op_increment
comma
id|height
op_decrement
)paren
(brace
id|p
op_assign
id|fbbase_virt
op_plus
id|y
op_star
id|info-&gt;fix.line_length
op_plus
id|rect-&gt;dx
op_star
id|w
suffix:semicolon
id|x
op_assign
id|rect-&gt;width
suffix:semicolon
r_if
c_cond
(paren
id|w
op_eq
l_int|2
)paren
id|x
op_rshift_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|x
)paren
(brace
id|writel
c_func
(paren
id|color
comma
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
id|x
op_decrement
suffix:semicolon
)brace
)brace
)brace
DECL|function|sstfb_drawrect_XY
r_static
r_void
id|sstfb_drawrect_XY
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|x
comma
r_int
id|y
comma
r_int
id|w
comma
r_int
id|h
comma
r_int
id|color
comma
r_int
id|hwfunc
)paren
(brace
r_struct
id|fb_fillrect
id|rect
suffix:semicolon
id|rect.dx
op_assign
id|x
suffix:semicolon
id|rect.dy
op_assign
id|y
suffix:semicolon
id|rect.height
op_assign
id|h
suffix:semicolon
id|rect.width
op_assign
id|w
suffix:semicolon
id|rect.color
op_assign
id|color
suffix:semicolon
id|rect.rop
op_assign
id|ROP_COPY
suffix:semicolon
r_if
c_cond
(paren
id|hwfunc
)paren
id|sstfb_fillrect
c_func
(paren
id|info
comma
op_amp
id|rect
)paren
suffix:semicolon
r_else
id|sstfb_fillrect_softw
c_func
(paren
id|info
comma
op_amp
id|rect
)paren
suffix:semicolon
)brace
multiline_comment|/* print some squares on the fb */
DECL|function|sstfb_drawdebugimage
r_static
r_void
id|sstfb_drawdebugimage
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_static
r_int
id|idx
suffix:semicolon
multiline_comment|/* clear screen */
id|sstfb_clear_screen
c_func
(paren
id|info
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_amp
l_int|1
suffix:semicolon
multiline_comment|/* white rect */
id|sstfb_drawrect_XY
c_func
(paren
id|info
comma
l_int|0
comma
l_int|0
comma
l_int|50
comma
l_int|50
comma
l_int|0xffff
comma
id|idx
)paren
suffix:semicolon
multiline_comment|/* blue rect */
id|sstfb_drawrect_XY
c_func
(paren
id|info
comma
l_int|50
comma
l_int|50
comma
l_int|50
comma
l_int|50
comma
l_int|0x001f
comma
id|idx
)paren
suffix:semicolon
multiline_comment|/* green rect */
id|sstfb_drawrect_XY
c_func
(paren
id|info
comma
l_int|100
comma
l_int|100
comma
l_int|80
comma
l_int|80
comma
l_int|0x07e0
comma
id|idx
)paren
suffix:semicolon
multiline_comment|/* red rect */
id|sstfb_drawrect_XY
c_func
(paren
id|info
comma
l_int|250
comma
l_int|250
comma
l_int|120
comma
l_int|100
comma
l_int|0xf800
comma
id|idx
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|sstfb_init
id|module_init
c_func
(paren
id|sstfb_init
)paren
suffix:semicolon
DECL|variable|sstfb_exit
id|module_exit
c_func
(paren
id|sstfb_exit
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;(c) 2000,2002 Ghozlane Toumi &lt;gtoumi@laposte.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;FBDev driver for 3dfx Voodoo Graphics and Voodoo2 based video boards&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mem
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mem
comma
l_string|&quot;Size of frame buffer memory in MB (1, 2, 4 MB, default=autodetect)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|vgapass
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|vgapass
comma
l_string|&quot;Enable VGA PassThrough mode (0 or 1) (default=0)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|clipping
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|clipping
comma
l_string|&quot;Enable clipping (slower, safer) (0 or 1) (default=1)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|gfxclk
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|gfxclk
comma
l_string|&quot;Force graphic chip frequency in MHz. DANGEROUS. (default=auto)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|slowpci
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|slowpci
comma
l_string|&quot;Uses slow PCI settings (0 or 1) (default=0)&quot;
)paren
suffix:semicolon
eof
