multiline_comment|/*&n; * linux/drivers/video/sstfb.c -- voodoo graphics frame buffer&n; *&n; *     Copyright (c) 2000,2001 Ghozlane Toumi &lt;gtoumi@messel.emse.fr&gt;&n; *&n; *     Created 15 Jan 2000 by Ghozlane Toumi&n; *&n; * Contributions (and many thanks) :&n; *&n; * 03/2001 James Simmons   &lt;jsimmons@linux-fbdev.org&gt;&n; * 04/2001 Paul Mundt      &lt;lethal@chaoticdreams.org&gt;&n; * 05/2001 Urs Ganse       &lt;urs.ganse@t-online.de&gt;&n; *     (initial work on voodoo2 port)&n; *&n; *&n; * $Id: sstfb.c,v 1.26.4.1 2001/08/29 01:30:37 ghoz Exp $&n; */
multiline_comment|/*&n; * The voodoo1 has the following memory mapped adress space:&n; * 0x000000 - 0x3fffff : registers              (4Mb)&n; * 0x400000 - 0x7fffff : linear frame buffer    (4Mb)&n; * 0x800000 - 0xffffff : texture memory         (8Mb)&n; */
multiline_comment|/*&n; * misc notes, TODOs, toASKs, and deep thoughts&n;&n;-TODO: at one time or another test that the mode is acceptable by the monitor&n;-ASK: I can choose different ordering for the color bitfields (rgba argb ...) &n;      wich one should i use ? is there any preferred one ? It seems ARGB is &n;      the one ...&n;-ASK: later: how to cope with endianness ? the fbi chip has builtin functions&n;      to do byte swizling /swapping, maybe use that ...&n;-TODO: check the error paths . if something get wrong, the error doesn&squot;t seem &n;      to be very well handled...if handled at all.. not good. &n;-ASK: ioremap ou ioremap_nocache ? : nocache is safe&n;-TODO: in  set_var check the validity of timings (hsync vsync)...&n;-FIXME: I&squot;m not sure i like all the functions with no parameters.. change them &n;        to use a sstfb_par or sstfb_info or something like that.&n;-TODO: check and recheck the use of sst_wait_idle : we dont flush the fifo via &n;       a nop command . so it&squot;s ok as long as the commands we pass don&squot;t go &n;       through the fifo. warning: issuing a nop command seems to need pci_fifo &n;       enabled&n;-ASK: the 24 bits mode is NOT packed . how do i differenciate from a packed mode ?&n;      set a pseudo alpha value not used ?&n;-ASK: how does the 32 bpp work ? should i enable the pipeline so alpha values &n;      are used ?&n;-TODO: check how the voodoo graphics can cope with 24/32 bpp (engine is 16bpp &n;       only)&n;-ASK: Do i ioremap the complete area devoted to the lfb (4Mb), or check the &n;      real size, then unmap and remap to the real size of the lfb ? &n;      ... map all the area.&n;-FIXME: in case of failure in the init sequence, be sure we return to a safe &n;        state.&n;-FIXME: 4MB boards have banked memory (FbiInit2 bits 1 &amp; 20)&n;-ASK: I stole &quot;inverse&quot; but seems it doesn&squot;t work... check what it realy does...&n;Notes&n;-TODO: change struct sst_info fb_info from static to array/dynamic&n;  TTT comments is for code i&squot;ve put there for debuging the &quot;weird peinguin &n;  &t;syndrome&quot;, it should disapear soon&n;&n; *&n; */
multiline_comment|/*&n; * debug info&n; * SST_DEBUG : enable debugging&n; * SST_DEBUG_REG : debug registers&n; *   0 :  no debug&n; *   1 : dac calls, [un]set_bits, FbiInit&n; *   2 : insane debug level (log every register read/write)&n; * SST_DEBUG_FUNC : functions&n; *   0 : no debug&n; *   1 : function call / debug ioctl&n; *   2 : variables&n; *   3 : flood . you don&squot;t want to do that. trust me.&n; * SST_DEBUG_VAR : debug display/var structs&n; *   0 : no debug&n; *   1 : dumps display, fb_var&n; * SST_DEBUG_IOCTL : enable sstfb specific ioctls&n; *   0 : disable&n; *   1 : enable debug ioctls :&n; *   &t;&t;toggle vga (0x46db) : toggle vga_pass_through&n; *   &t;&t;fill fb    (0x46dc) : fills fb&n; *   &t;&t;dump var   (0x46dd) : logs display[0-5].var&n; *   &t;&t;test disp  (0x46de) : draws a test motif&n; */
multiline_comment|/* #define SST_DEBUG */
DECL|macro|SST_DEBUG
macro_line|#undef SST_DEBUG
DECL|macro|SST_DEBUG_REG
mdefine_line|#define SST_DEBUG_REG   0
DECL|macro|SST_DEBUG_FUNC
mdefine_line|#define SST_DEBUG_FUNC  0
DECL|macro|SST_DEBUG_VAR
mdefine_line|#define SST_DEBUG_VAR   0
DECL|macro|SST_DEBUG_IOCTL
mdefine_line|#define SST_DEBUG_IOCTL 1
multiline_comment|/* #define EN_24_32_BPP  */
multiline_comment|/* enable 24/32 bpp functions for testing only */
DECL|macro|EN_24_32_BPP
macro_line|#undef EN_24_32_BPP
multiline_comment|/*&n;  Default video mode .&n;  0 800x600@60  took from glide&n;  1 640x480@75  took from glide&n;  2 1024x768@76 std fb.mode&n;  3 640x480@60  glide default */
DECL|macro|DEFAULT_MODE
mdefine_line|#define DEFAULT_MODE 1
multiline_comment|/*&n; * Includes&n; */
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/ioctl.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-cfb16.h&gt;
macro_line|#ifdef  EN_24_32_BPP
macro_line|#  include &lt;video/fbcon-cfb24.h&gt;
macro_line|#  include &lt;video/fbcon-cfb32.h&gt;
macro_line|#endif
macro_line|#include &quot;sstfb.h&quot;
multiline_comment|/* void Dump_regs(void); */
multiline_comment|/* sst default init registers */
DECL|macro|FBIINIT0_DEFAULT
mdefine_line|#define FBIINIT0_DEFAULT EN_VGA_PASSTHROUGH
DECL|macro|FBIINIT1_DEFAULT
mdefine_line|#define FBIINIT1_DEFAULT &t;&bslash;&n;&t;(&t;&t;&t;&bslash;&n;&t;  FAST_PCI_WRITES&t;&bslash;&n;/*&t;  SLOW_PCI_WRITES*/&t;&bslash;&n;&t;| VIDEO_RESET&t;&t;&bslash;&n;&t;| 10 &lt;&lt; TILES_IN_X_SHIFT&bslash;&n;&t;| SEL_SOURCE_VCLK_2X_SEL&bslash;&n;&t;| EN_LFB_READ&t;&t;&bslash;&n;&t;)
DECL|macro|FBIINIT2_DEFAULT
mdefine_line|#define FBIINIT2_DEFAULT&t;&bslash;&n;&t;(&t;&t;&t;&bslash;&n;&t; SWAP_DACVSYNC&t;&t;&bslash;&n;&t;| EN_DRAM_OE&t;&t;&bslash;&n;&t;| DRAM_REFRESH_16&t;&bslash;&n;&t;| EN_DRAM_REFRESH&t;&bslash;&n;&t;| EN_FAST_RAS_READ&t;&bslash;&n;&t;| EN_RD_AHEAD_FIFO&t;&bslash;&n;&t;| EN_FAST_RD_AHEAD_WR&t;&bslash;&n;&t;)
DECL|macro|FBIINIT3_DEFAULT
mdefine_line|#define FBIINIT3_DEFAULT &t;&bslash;&n;&t;( DISABLE_TEXTURE )
DECL|macro|FBIINIT4_DEFAULT
mdefine_line|#define FBIINIT4_DEFAULT&t;&bslash;&n;&t;(&t;&t;&t;&bslash;&n;&t;  FAST_PCI_READS&t;&bslash;&n;/*&t;  SLOW_PCI_READS*/&t;&bslash;&n;&t;| LFB_READ_AHEAD&t;&bslash;&n;&t;)
multiline_comment|/* Careful with this one : writing back the data just read will trash the DAC&n;   reading some fields give logic value on pins, but setting this field will&n;   set the source signal driving the pin. conclusion : just use the default&n;   as a base before writing back .&n;*/
DECL|macro|FBIINIT6_DEFAULT
mdefine_line|#define FBIINIT6_DEFAULT&t;(0x0)
multiline_comment|/********/
DECL|variable|num_sst
r_int
id|num_sst
suffix:semicolon
multiline_comment|/* =0*/
multiline_comment|/* number of initialized boards */
multiline_comment|/* initialized by setup */
DECL|variable|inverse
r_static
r_int
id|inverse
suffix:semicolon
multiline_comment|/* =0 */
multiline_comment|/* invert colormap */
DECL|variable|vgapass
r_static
r_int
id|vgapass
suffix:semicolon
multiline_comment|/* =0 */
multiline_comment|/* enable Vga passthrough cable */
DECL|variable|mem
r_static
r_int
id|mem
suffix:semicolon
multiline_comment|/* =0 */
multiline_comment|/* mem size in Mb , 0 = autodetect */
DECL|variable|clipping
r_static
r_int
id|clipping
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* use clipping (slower, safer) */
DECL|variable|gfxclk
r_static
r_int
id|gfxclk
suffix:semicolon
multiline_comment|/* =0 */
multiline_comment|/* force FBI freq in Mhz . Dangerous */
DECL|variable|slowpci
r_static
r_int
id|slowpci
suffix:semicolon
multiline_comment|/* =0 */
multiline_comment|/* slow PCI settings */
DECL|variable|dev
r_static
r_int
id|dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* specify device (0..n) */
DECL|variable|mode_option
r_static
r_char
op_star
id|mode_option
suffix:semicolon
macro_line|#if defined(FBCON_HAS_CFB16) || defined(FBCON_HAS_CFB24) || defined(FBCON_HAS_CFB32)
r_union
(brace
macro_line|#  ifdef FBCON_HAS_CFB16
DECL|member|cfb16
id|u16
id|cfb16
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#  endif
macro_line|#ifdef EN_24_32_BPP
macro_line|#  if defined (FBCON_HAS_CFB24) || defined(FBCON_HAS_CFB32)
DECL|member|cfb32
id|u32
id|cfb32
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#  endif
macro_line|#endif
DECL|variable|fbcon_cmap
)brace
id|fbcon_cmap
suffix:semicolon
macro_line|#endif
DECL|member|red
DECL|member|green
DECL|member|blue
DECL|member|transp
DECL|variable|palette
r_static
r_struct
(brace
id|u_int
id|red
comma
id|green
comma
id|blue
comma
id|transp
suffix:semicolon
)brace
id|palette
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|sstfb_info
id|fb_info
suffix:semicolon
DECL|variable|disp
r_static
r_struct
id|display
id|disp
suffix:semicolon
multiline_comment|/********/
multiline_comment|/* Interface to ze oueurld  */
r_int
id|sstfb_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|sstfb_setup
c_func
(paren
r_char
op_star
id|options
)paren
suffix:semicolon
multiline_comment|/* Framebuffer API */
r_static
r_int
id|sstfb_open
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
suffix:semicolon
r_static
r_int
id|sstfb_release
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
suffix:semicolon
r_static
r_int
id|sstfb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/* Interface to the low level console driver */
r_static
r_int
id|sstfbcon_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sstfbcon_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/* Internal routines */
r_static
r_void
id|sstfb_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_set_par
c_func
(paren
r_const
r_struct
id|sstfb_par
op_star
id|par
comma
r_struct
id|sstfb_info
op_star
id|sst_info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_decode_var
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|sstfb_par
op_star
id|par
comma
r_const
r_struct
id|sstfb_info
op_star
id|sst_info
)paren
suffix:semicolon
r_static
r_int
id|sstfb_encode_var
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_const
r_struct
id|sstfb_par
op_star
id|par
comma
r_const
r_struct
id|sstfb_info
op_star
id|sst_info
)paren
suffix:semicolon
r_static
r_void
id|sstfb_test16
c_func
(paren
r_struct
id|sstfb_info
op_star
id|sst_info
)paren
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_static
r_void
id|sstfb_test32
c_func
(paren
r_struct
id|sstfb_info
op_star
id|sst_info
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Low level routines */
r_static
r_int
id|sst_get_memsize
c_func
(paren
id|u_long
op_star
id|memsize
)paren
suffix:semicolon
r_static
r_int
id|sst_wait_idle
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sst_detect_dactype
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sst_detect_att
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sst_detect_ti
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sst_detect_ics
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sst_calc_pll
c_func
(paren
r_const
r_int
id|freq
comma
r_int
op_star
id|freq_out
comma
r_struct
id|pll_timing
op_star
id|t
)paren
suffix:semicolon
r_static
r_int
id|sst_set_pll_att_ti
c_func
(paren
r_const
r_struct
id|pll_timing
op_star
id|t
comma
r_const
r_int
id|clock
)paren
suffix:semicolon
r_static
r_int
id|sst_set_pll_ics
c_func
(paren
r_const
r_struct
id|pll_timing
op_star
id|t
comma
r_const
r_int
id|clock
)paren
suffix:semicolon
r_static
r_void
id|sst_set_vidmod_att_ti
c_func
(paren
r_const
r_int
id|bpp
)paren
suffix:semicolon
r_static
r_void
id|sst_set_vidmod_ics
c_func
(paren
r_const
r_int
id|bpp
)paren
suffix:semicolon
r_static
r_int
id|sst_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_static
r_void
id|sst_shutdown
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|sstfb_ops
r_static
r_struct
id|fb_ops
id|sstfb_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|fb_open
suffix:colon
id|sstfb_open
comma
id|fb_release
suffix:colon
id|sstfb_release
comma
id|fb_get_fix
suffix:colon
id|sstfb_get_fix
comma
id|fb_get_var
suffix:colon
id|sstfb_get_var
comma
id|fb_set_var
suffix:colon
id|sstfb_set_var
comma
id|fb_get_cmap
suffix:colon
id|sstfb_get_cmap
comma
id|fb_set_cmap
suffix:colon
id|sstfb_set_cmap
comma
id|fb_setcolreg
suffix:colon
id|sstfb_setcolreg
comma
id|fb_pan_display
suffix:colon
id|sstfb_pan_display
comma
id|fb_ioctl
suffix:colon
id|sstfb_ioctl
comma
)brace
suffix:semicolon
macro_line|#ifndef DEFAULT_MODE
DECL|macro|DEFAULT_MODE
macro_line|#  define DEFAULT_MODE 0
macro_line|#endif
DECL|variable|sstfb_default
r_static
r_struct
id|fb_var_screeninfo
id|sstfb_default
op_assign
macro_line|#if ( DEFAULT_MODE == 0 )
(brace
multiline_comment|/* 800x600@60, 16 bpp .borowed from glide/sst1/include/sst1init.h */
l_int|800
comma
l_int|600
comma
l_int|800
comma
l_int|600
comma
l_int|0
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
(brace
l_int|11
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|5
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|25000
comma
l_int|86
comma
l_int|41
comma
l_int|23
comma
l_int|1
comma
l_int|127
comma
l_int|4
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
macro_line|#endif
macro_line|#if ( DEFAULT_MODE == 1 )
(brace
multiline_comment|/* 640x480@75, 16 bpp .borowed from glide/sst1/include/sst1init.h */
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|480
comma
l_int|0
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
(brace
l_int|11
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|5
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|31746
comma
l_int|118
comma
l_int|17
comma
l_int|16
comma
l_int|1
comma
l_int|63
comma
l_int|3
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
macro_line|#endif
macro_line|#if ( DEFAULT_MODE == 2 )
(brace
multiline_comment|/* 1024x768@76 took from my /etc/fb.modes */
l_int|1024
comma
l_int|768
comma
l_int|1024
comma
l_int|768
comma
l_int|0
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
(brace
l_int|11
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|5
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|11764
comma
l_int|208
comma
l_int|8
comma
l_int|36
comma
l_int|16
comma
l_int|120
comma
l_int|3
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
macro_line|#endif
macro_line|#if ( DEFAULT_MODE == 3 )
(brace
multiline_comment|/* 640x480@60 , 16bpp glide default ?*/
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|480
comma
l_int|0
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
(brace
l_int|11
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|5
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|5
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|39721
comma
l_int|38
comma
l_int|26
comma
l_int|25
comma
l_int|18
comma
l_int|96
comma
l_int|2
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|dacs
r_static
r_struct
id|dac_switch
id|dacs
(braket
)braket
op_assign
(brace
(brace
id|name
suffix:colon
l_string|&quot;TI TVP3409&quot;
comma
id|detect
suffix:colon
id|sst_detect_ti
comma
id|set_pll
suffix:colon
id|sst_set_pll_att_ti
comma
id|set_vidmod
suffix:colon
id|sst_set_vidmod_att_ti
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;AT&amp;T ATT20C409&quot;
comma
id|detect
suffix:colon
id|sst_detect_att
comma
id|set_pll
suffix:colon
id|sst_set_pll_att_ti
comma
id|set_vidmod
suffix:colon
id|sst_set_vidmod_att_ti
)brace
comma
(brace
id|name
suffix:colon
l_string|&quot;ICS ICS5342&quot;
comma
id|detect
suffix:colon
id|sst_detect_ics
comma
id|set_pll
suffix:colon
id|sst_set_pll_ics
comma
id|set_vidmod
suffix:colon
id|sst_set_vidmod_ics
)brace
comma
)brace
suffix:semicolon
DECL|variable|voodoo1_spec
r_static
r_struct
id|sst_spec
id|voodoo1_spec
op_assign
(brace
id|name
suffix:colon
l_string|&quot;Voodoo Graphics&quot;
comma
id|default_gfx_clock
suffix:colon
l_int|50000
comma
id|max_gfxclk
suffix:colon
l_int|60
comma
)brace
suffix:semicolon
DECL|variable|voodoo2_spec
r_static
r_struct
id|sst_spec
id|voodoo2_spec
op_assign
(brace
id|name
suffix:colon
l_string|&quot;Voodoo2&quot;
comma
id|default_gfx_clock
suffix:colon
l_int|75000
comma
id|max_gfxclk
suffix:colon
l_int|85
comma
)brace
suffix:semicolon
multiline_comment|/*&n; *&n; *  Definitions&n; *&n; */
macro_line|#if (SST_DEBUG_VAR &gt; 0)
multiline_comment|/* debug info / dump a fb_var_screeninfo */
DECL|function|sst_dbg_print_var
r_static
r_void
id|sst_dbg_print_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot; {%d, %d, %d, %d, %d, %d, %d, %d,&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;xres_virtual
comma
id|var-&gt;yres_virtual
comma
id|var-&gt;xoffset
comma
id|var-&gt;yoffset
comma
id|var-&gt;bits_per_pixel
comma
id|var-&gt;grayscale
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot; {%d, %d, %d}, {%d, %d, %d}, {%d, %d, %d}, {%d, %d, %d},&bslash;n&quot;
comma
id|var-&gt;red.offset
comma
id|var-&gt;red.length
comma
id|var-&gt;red.msb_right
comma
id|var-&gt;green.offset
comma
id|var-&gt;green.length
comma
id|var-&gt;green.msb_right
comma
id|var-&gt;blue.offset
comma
id|var-&gt;blue.length
comma
id|var-&gt;blue.msb_right
comma
id|var-&gt;transp.offset
comma
id|var-&gt;transp.length
comma
id|var-&gt;transp.msb_right
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot; %d, %d, %d, %d, %d,&bslash;n&quot;
comma
id|var-&gt;nonstd
comma
id|var-&gt;activate
comma
id|var-&gt;height
comma
id|var-&gt;width
comma
id|var-&gt;accel_flags
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot; %d, %d, %d, %d, %d, %d, %d,&bslash;n&quot;
comma
id|var-&gt;pixclock
comma
id|var-&gt;left_margin
comma
id|var-&gt;right_margin
comma
id|var-&gt;upper_margin
comma
id|var-&gt;lower_margin
comma
id|var-&gt;hsync_len
comma
id|var-&gt;vsync_len
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot; %#x, %#x}&bslash;n&quot;
comma
id|var-&gt;sync
comma
id|var-&gt;vmode
)paren
suffix:semicolon
)brace
macro_line|#endif /* (SST_DEBUG_VAR &gt; 0) */
DECL|function|sst_dbg_print_read_reg
r_static
r_void
id|sst_dbg_print_read_reg
(paren
id|u32
id|reg
comma
id|u32
id|val
)paren
(brace
macro_line|#if (SST_DEBUG_REG &gt; 0) /* i need the init registers :) */
r_char
op_star
id|regname
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|reg
)paren
(brace
r_case
id|FBIINIT0
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit0&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT1
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit1&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT2
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit2&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT3
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit3&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT4
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit4&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT6
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit6&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|regname
op_eq
l_int|NULL
)paren
id|r_ddprintk
c_func
(paren
l_string|&quot;sst_read(%#x): %#x&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
r_else
id|r_dprintk
c_func
(paren
l_string|&quot; sst_read(%s): %#x&bslash;n&quot;
comma
id|regname
comma
id|val
)paren
suffix:semicolon
macro_line|#endif /*  (SST_DEBUG_REG &gt; 0) */
)brace
DECL|function|sst_dbg_print_write_reg
r_static
r_void
id|sst_dbg_print_write_reg
(paren
id|u32
id|reg
comma
id|u32
id|val
)paren
(brace
macro_line|#if (SST_DEBUG_REG &gt; 0) /* i need the init registers :) */
r_char
op_star
id|regname
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|reg
)paren
(brace
r_case
id|FBIINIT0
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit0&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT1
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit1&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT2
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit2&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT3
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit3&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT4
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit4&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIINIT6
suffix:colon
id|regname
op_assign
l_string|&quot;FbiInit6&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|regname
op_eq
l_int|NULL
)paren
id|r_ddprintk
c_func
(paren
l_string|&quot;sst_write(%#x, %#x)&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
r_else
id|r_dprintk
c_func
(paren
l_string|&quot; sst_write(%s, %#x)&bslash;n&quot;
comma
id|regname
comma
id|val
)paren
suffix:semicolon
macro_line|#endif /*  (SST_DEBUG_REG &gt; 0) */
)brace
multiline_comment|/* register access */
DECL|function|sst_read
r_static
r_inline
id|u32
id|sst_read
c_func
(paren
id|u32
id|reg
)paren
(brace
id|u32
id|ret
suffix:semicolon
id|ret
op_assign
id|readl
c_func
(paren
id|fb_info.mmio.vbase
op_plus
id|reg
)paren
suffix:semicolon
id|sst_dbg_print_read_reg
c_func
(paren
id|reg
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sst_write
r_static
r_inline
r_void
id|sst_write
c_func
(paren
id|u32
id|reg
comma
id|u32
id|val
)paren
(brace
id|sst_dbg_print_write_reg
c_func
(paren
id|reg
comma
id|val
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|fb_info.mmio.vbase
op_plus
id|reg
)paren
suffix:semicolon
)brace
DECL|function|sst_set_bits
r_static
r_inline
r_void
id|sst_set_bits
c_func
(paren
id|u32
id|reg
comma
id|u32
id|val
)paren
(brace
id|r_dprintk
c_func
(paren
l_string|&quot;sst_set_bits(%#x, %#x)&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|reg
comma
id|sst_read
c_func
(paren
id|reg
)paren
op_or
id|val
)paren
suffix:semicolon
)brace
DECL|function|sst_unset_bits
r_static
r_inline
r_void
id|sst_unset_bits
c_func
(paren
id|u32
id|reg
comma
id|u32
id|val
)paren
(brace
id|r_dprintk
c_func
(paren
l_string|&quot;sst_unset_bits(%#x, %#x)&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|reg
comma
id|sst_read
c_func
(paren
id|reg
)paren
op_amp
op_complement
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/* dac access */
multiline_comment|/* dac_read should be remaped to FbiInit2 (via the pci reg init_enable) */
DECL|function|sst_dac_read
r_static
id|u8
id|sst_dac_read
c_func
(paren
id|u8
id|reg
)paren
(brace
id|u8
id|ret
suffix:semicolon
macro_line|#ifdef SST_DEBUG
r_if
c_cond
(paren
(paren
id|reg
op_amp
l_int|0x07
)paren
op_ne
id|reg
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;bug line %d: register adress &squot;%d&squot; is to high&bslash;n&quot;
comma
id|__LINE__
comma
id|reg
)paren
suffix:semicolon
)brace
macro_line|#endif
id|reg
op_and_assign
l_int|0x07
suffix:semicolon
id|sst_write
c_func
(paren
id|DAC_DATA
comma
(paren
(paren
id|u32
)paren
id|reg
op_lshift
l_int|8
)paren
op_or
id|DAC_READ_CMD
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*udelay(10);*/
id|ret
op_assign
(paren
id|sst_read
c_func
(paren
id|DAC_READ
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|r_dprintk
c_func
(paren
l_string|&quot;sst_dac_read(%#x): %#x&bslash;n&quot;
comma
id|reg
comma
id|ret
)paren
suffix:semicolon
r_return
(paren
id|u8
)paren
id|ret
suffix:semicolon
)brace
DECL|function|sst_dac_write
r_static
r_void
id|sst_dac_write
c_func
(paren
id|u8
id|reg
comma
id|u8
id|val
)paren
(brace
id|r_dprintk
c_func
(paren
l_string|&quot;sst_dac_write(%#x, %#x)&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
macro_line|#ifdef SST_DEBUG
r_if
c_cond
(paren
(paren
id|reg
op_amp
l_int|0x07
)paren
op_ne
id|reg
)paren
id|dprintk
c_func
(paren
l_string|&quot;bug line %d: register adress &squot;%d&squot; is to high&bslash;n&quot;
comma
id|__LINE__
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
id|reg
op_and_assign
l_int|0x07
suffix:semicolon
id|sst_write
c_func
(paren
id|DAC_DATA
comma
(paren
(paren
(paren
id|u32
)paren
id|reg
op_lshift
l_int|8
)paren
)paren
op_or
(paren
id|u32
)paren
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/* indexed access to ti/att dacs */
DECL|function|dac_i_read
r_static
r_inline
id|u32
id|dac_i_read
c_func
(paren
id|u8
id|reg
)paren
(brace
id|u32
id|ret
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ADDR_I
comma
id|reg
)paren
suffix:semicolon
id|ret
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_DATA_I
)paren
suffix:semicolon
id|r_dprintk
c_func
(paren
l_string|&quot;sst_dac_read_i(%#x): %#x&bslash;n&quot;
comma
id|reg
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dac_i_write
r_static
r_inline
r_void
id|dac_i_write
c_func
(paren
id|u8
id|reg
comma
id|u8
id|val
)paren
(brace
id|r_dprintk
c_func
(paren
l_string|&quot;sst_dac_write_i(%#x, %#x)&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ADDR_I
comma
id|reg
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_DATA_I
comma
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&n; *  Internal routines&n; *&n; */
DECL|function|sstfb_install_cmap
r_static
r_void
id|sstfb_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_install_cmap(con: %d)&bslash;n&quot;
comma
id|con
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;currcon: %d&bslash;n&quot;
comma
id|info-&gt;currcon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
op_ne
id|info-&gt;currcon
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|fb_set_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
l_int|1
comma
id|info
)paren
suffix:semicolon
r_else
id|fb_set_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
l_int|1
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|sstfb_getcolreg
r_static
r_int
id|sstfb_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|f_ddprintk
c_func
(paren
l_string|&quot;sstfb_getcolreg&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
l_int|16
)paren
r_return
l_int|1
suffix:semicolon
op_star
id|red
op_assign
id|palette
(braket
id|regno
)braket
dot
id|red
suffix:semicolon
op_star
id|green
op_assign
id|palette
(braket
id|regno
)braket
dot
id|green
suffix:semicolon
op_star
id|blue
op_assign
id|palette
(braket
id|regno
)braket
dot
id|blue
suffix:semicolon
op_star
id|transp
op_assign
id|palette
(braket
id|regno
)braket
dot
id|transp
suffix:semicolon
id|f_dddprintk
c_func
(paren
l_string|&quot;%-2d rvba: %#x, %#x, %#x, %#x&bslash;n&quot;
comma
id|regno
comma
op_star
id|red
comma
op_star
id|green
comma
op_star
id|blue
comma
op_star
id|transp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sstfb_setcolreg
r_static
r_int
id|sstfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|u32
id|col
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;sstfb_setcolreg&bslash;n&quot;
)paren
suffix:semicolon
id|f_dddprintk
c_func
(paren
l_string|&quot;%-2d rvba: %#x, %#x, %#x, %#x&bslash;n&quot;
comma
id|regno
comma
id|red
comma
id|green
comma
id|blue
comma
id|transp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
l_int|16
)paren
r_return
l_int|1
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
id|red
op_rshift_assign
(paren
l_int|16
op_minus
id|disp.var.red.length
)paren
suffix:semicolon
id|green
op_rshift_assign
(paren
l_int|16
op_minus
id|disp.var.green.length
)paren
suffix:semicolon
id|blue
op_rshift_assign
(paren
l_int|16
op_minus
id|disp.var.blue.length
)paren
suffix:semicolon
id|transp
op_rshift_assign
(paren
l_int|16
op_minus
id|disp.var.transp.length
)paren
suffix:semicolon
id|col
op_assign
(paren
id|red
op_lshift
id|disp.var.red.offset
)paren
op_or
(paren
id|green
op_lshift
id|disp.var.green.offset
)paren
op_or
(paren
id|blue
op_lshift
id|disp.var.blue.offset
)paren
op_or
(paren
id|transp
op_lshift
id|disp.var.transp.offset
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|disp.var.bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
id|fbcon_cmap.cfb16
(braket
id|regno
)braket
op_assign
(paren
id|u16
)paren
id|col
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef EN_24_32_BPP
macro_line|#ifdef FBCON_HAS_CFB24
r_case
l_int|24
suffix:colon
id|fbcon_cmap.cfb32
(braket
id|regno
)braket
op_assign
id|col
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
r_case
l_int|32
suffix:colon
id|fbcon_cmap.cfb32
(braket
id|regno
)braket
op_assign
id|col
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_default
suffix:colon
id|eprintk
c_func
(paren
l_string|&quot;bug line %d: bad depth &squot;%u&squot;&bslash;n&quot;
comma
id|__LINE__
comma
id|disp.var.bits_per_pixel
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|f_dddprintk
c_func
(paren
l_string|&quot;bpp: %d . encoded color: %#x&bslash;n&quot;
comma
id|disp.var.bits_per_pixel
comma
id|col
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set par according to var ( checks var ) */
DECL|function|sstfb_decode_var
r_static
r_int
id|sstfb_decode_var
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|sstfb_par
op_star
id|par
comma
r_const
r_struct
id|sstfb_info
op_star
id|sst_info
)paren
(brace
r_int
id|real_length
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_decode_var&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Check var validity */
r_if
c_cond
(paren
(paren
id|var-&gt;xres
OG
l_int|1024
)paren
op_logical_or
(paren
op_logical_neg
id|var-&gt;xres
)paren
op_logical_or
(paren
op_logical_neg
id|var-&gt;xres
)paren
)paren
(brace
id|eprintk
(paren
l_string|&quot;Unsupported resolution %dx%d&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
op_ne
id|FB_VMODE_NONINTERLACED
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Interlace non supported %#x&bslash;n&quot;
comma
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|par
comma
l_int|0
comma
r_sizeof
(paren
id|par
)paren
)paren
suffix:semicolon
id|par-&gt;xDim
op_assign
id|var-&gt;xres
suffix:semicolon
id|par-&gt;hSyncOn
op_assign
id|var-&gt;hsync_len
suffix:semicolon
id|par-&gt;hSyncOff
op_assign
id|var-&gt;xres
op_plus
id|var-&gt;right_margin
op_plus
id|var-&gt;left_margin
suffix:semicolon
id|par-&gt;hBackPorch
op_assign
id|var-&gt;left_margin
suffix:semicolon
id|par-&gt;yDim
op_assign
id|var-&gt;yres
suffix:semicolon
id|par-&gt;vSyncOn
op_assign
id|var-&gt;vsync_len
suffix:semicolon
id|par-&gt;vSyncOff
op_assign
id|var-&gt;yres
op_plus
id|var-&gt;lower_margin
op_plus
id|var-&gt;upper_margin
suffix:semicolon
id|par-&gt;vBackPorch
op_assign
id|var-&gt;upper_margin
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|0
dot
dot
dot
l_int|16
suffix:colon
id|par-&gt;bpp
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|17
dot
dot
dot
l_int|24
suffix:colon
id|par-&gt;bpp
op_assign
l_int|24
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|25
dot
dot
dot
l_int|32
suffix:colon
id|par-&gt;bpp
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|eprintk
(paren
l_string|&quot;Unsupported bpp %d&bslash;n&quot;
comma
id|par-&gt;bpp
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sst_info-&gt;is_voodoo2
)paren
(brace
multiline_comment|/* voodoo2 has 32 pixel wide tiles , BUT stange things&n;&t;&t; happen with odd number of tiles */
id|par-&gt;tiles_in_X
op_assign
(paren
id|par-&gt;xDim
op_plus
l_int|63
)paren
op_div
l_int|64
op_star
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* voodoo1 has 64 pixels wide tiles. */
id|par-&gt;tiles_in_X
op_assign
(paren
id|par-&gt;xDim
op_plus
l_int|63
)paren
op_div
l_int|64
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  mem check&n;&t; */
multiline_comment|/* it seems that the fbi uses tiles of 64x16 pixels to &quot;map&quot; the mem*/
multiline_comment|/* FIXME: i don&squot;t like this... looks wrong*/
id|real_length
op_assign
id|par-&gt;tiles_in_X
op_star
(paren
id|sst_info-&gt;is_voodoo2
ques
c_cond
l_int|32
suffix:colon
l_int|64
)paren
op_star
(paren
(paren
id|par-&gt;bpp
op_eq
l_int|16
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
)paren
suffix:semicolon
multiline_comment|/*shoud this function change var ? for instance with yvirt &gt; yres  ?*/
r_if
c_cond
(paren
(paren
id|real_length
op_star
id|var-&gt;yres
)paren
OG
id|fb_info.video.len
)paren
(brace
id|eprintk
(paren
l_string|&quot;Not enough video memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|par-&gt;freq
op_assign
id|PS2KHZ
c_func
(paren
id|var-&gt;pixclock
)paren
suffix:semicolon
multiline_comment|/* TODO add checks for timings */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* sets var according to par (basicaly, sets sane values) */
DECL|function|sstfb_encode_var
r_static
r_int
id|sstfb_encode_var
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_const
r_struct
id|sstfb_par
op_star
id|par
comma
r_const
r_struct
id|sstfb_info
op_star
id|sst_info
)paren
(brace
id|memset
c_func
(paren
id|var
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
)paren
suffix:semicolon
id|var-&gt;xres
op_assign
id|par-&gt;xDim
suffix:semicolon
id|var-&gt;yres
op_assign
id|par-&gt;yDim
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|par-&gt;xDim
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|par-&gt;yDim
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
id|par-&gt;bpp
suffix:semicolon
multiline_comment|/* {x|y}offset = 0 ; sync=0 */
id|var-&gt;height
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;width
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;pixclock
op_assign
id|KHZ2PS
c_func
(paren
id|par-&gt;freq
)paren
suffix:semicolon
id|var-&gt;left_margin
op_assign
id|par-&gt;hBackPorch
suffix:semicolon
id|var-&gt;right_margin
op_assign
id|par-&gt;hSyncOff
op_minus
id|par-&gt;xDim
op_minus
id|par-&gt;hBackPorch
suffix:semicolon
id|var-&gt;upper_margin
op_assign
id|par-&gt;vBackPorch
suffix:semicolon
id|var-&gt;lower_margin
op_assign
id|par-&gt;vSyncOff
op_minus
id|par-&gt;yDim
op_minus
id|par-&gt;vBackPorch
suffix:semicolon
id|var-&gt;hsync_len
op_assign
id|par-&gt;hSyncOn
suffix:semicolon
id|var-&gt;vsync_len
op_assign
id|par-&gt;vSyncOn
suffix:semicolon
id|var-&gt;vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
multiline_comment|/*&n;&t; * correct the color bit fields&n;&t; */
multiline_comment|/* var-&gt;{red|green|blue}.msb_right    = 0; */
r_switch
c_cond
(paren
id|par-&gt;bpp
)paren
(brace
r_case
l_int|16
suffix:colon
multiline_comment|/* RGB 565  LfbMode 0 */
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|11
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|24
suffix:colon
multiline_comment|/* RGB 888 LfbMode 4 */
r_case
l_int|32
suffix:colon
multiline_comment|/* ARGB 8888 LfbMode 5 */
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* in 24bpp we fake a 32 bpp mode */
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|eprintk
(paren
l_string|&quot;bug line %d: bad depth &squot;%u&squot;&bslash;n&quot;
comma
id|__LINE__
comma
id|par-&gt;bpp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Frame buffer API&n; */
DECL|function|sstfb_open
r_static
r_int
id|sstfb_open
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_open(user: %d)&bslash;n&quot;
comma
id|user
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sstfb_release
r_static
r_int
id|sstfb_release
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_release(user: %d)&bslash;n&quot;
comma
id|user
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sstfb_get_fix
r_static
r_int
id|sstfb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
DECL|macro|sst_info
mdefine_line|#define sst_info&t;((struct sstfb_info *) info)
r_struct
id|fb_var_screeninfo
op_star
id|var
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_get_fix(con: %d)&bslash;n&quot;
comma
id|con
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
id|var
op_assign
op_amp
id|sstfb_default
suffix:semicolon
r_else
id|var
op_assign
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
id|sst_info-&gt;info.modename
)paren
suffix:semicolon
multiline_comment|/* lfb phys address = membase + 4Mb */
id|fix-&gt;smem_start
op_assign
id|sst_info-&gt;video.base
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|sst_info-&gt;video.len
suffix:semicolon
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
multiline_comment|/*&n;&t; *   According to the specs, the linelength must be of 1024 *pixels*.&n;&t; * and the 24bpp mode is in fact a 32 bpp mode.&n;&t; */
id|fix-&gt;line_length
op_assign
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|16
)paren
ques
c_cond
l_int|2048
suffix:colon
l_int|4096
suffix:semicolon
r_return
l_int|0
suffix:semicolon
DECL|macro|sst_info
macro_line|#undef sst_info
)brace
DECL|function|sstfb_get_var
r_static
r_int
id|sstfb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_get_var(con: %d)&bslash;n&quot;
comma
id|con
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
op_star
id|var
op_assign
id|sstfb_default
suffix:semicolon
r_else
op_star
id|var
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var
suffix:semicolon
id|print_var
c_func
(paren
id|var
comma
l_string|&quot;var&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sstfb_set_var
r_static
r_int
id|sstfb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
DECL|macro|sst_info
mdefine_line|#define sst_info&t;((struct sstfb_info *) info)&t;
r_struct
id|sstfb_par
id|par
suffix:semicolon
r_struct
id|display
op_star
id|display
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|old_bpp
comma
id|old_xres
comma
id|old_yres
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_set_var(con: %d)&bslash;n&quot;
comma
id|con
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;xres yres vxres vyres bpp activate&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;%-4d %-4d %-5d %-5d %-3d %#-8x&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;xres_virtual
comma
id|var-&gt;yres_virtual
comma
id|var-&gt;bits_per_pixel
comma
id|var-&gt;activate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
OL
l_int|0
)paren
id|display
op_assign
op_amp
id|disp
suffix:semicolon
r_else
id|display
op_assign
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
id|err
op_assign
id|sstfb_decode_var
c_func
(paren
id|var
comma
op_amp
id|par
comma
id|sst_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|sstfb_encode_var
(paren
id|var
comma
op_amp
id|par
comma
id|sst_info
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
(brace
r_case
id|FB_ACTIVATE_TEST
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|FB_ACTIVATE_NXTOPEN
suffix:colon
r_case
id|FB_ACTIVATE_NOW
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|old_xres
op_assign
id|display-&gt;var.xres
suffix:semicolon
id|old_yres
op_assign
id|display-&gt;var.yres
suffix:semicolon
id|old_bpp
op_assign
id|display-&gt;var.bits_per_pixel
suffix:semicolon
id|display-&gt;var
op_assign
op_star
id|var
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old_xres
op_ne
id|var-&gt;xres
)paren
op_logical_or
(paren
id|old_yres
op_ne
id|var-&gt;yres
)paren
op_logical_or
(paren
id|old_bpp
op_ne
id|var-&gt;bits_per_pixel
)paren
)paren
(brace
multiline_comment|/* 2-3  lignes redondantes avec get_fix */
id|info-&gt;screen_base
op_assign
(paren
r_char
op_star
)paren
id|sst_info-&gt;video.vbase
suffix:semicolon
id|display-&gt;visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
id|display-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|display-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
id|display-&gt;ypanstep
op_assign
l_int|0
suffix:semicolon
id|display-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|display-&gt;line_length
op_assign
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|16
)paren
ques
c_cond
l_int|2048
suffix:colon
l_int|4096
suffix:semicolon
id|display-&gt;inverse
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb16
suffix:semicolon
id|display-&gt;dispsw_data
op_assign
id|fbcon_cmap.cfb16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef EN_24_32_BPP
macro_line|#if defined (FBCON_HAS_CFB24) || defined (FBCON_HAS_CFB32 )
r_case
l_int|24
suffix:colon
multiline_comment|/*24bpp non packed &lt;=&gt; 32 bpp */
r_case
l_int|32
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb32
suffix:semicolon
id|display-&gt;dispsw_data
op_assign
id|fbcon_cmap.cfb32
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_default
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
r_break
suffix:semicolon
)brace
id|display-&gt;scrollmode
op_assign
id|SCROLL_YREDRAW
suffix:semicolon
r_if
c_cond
(paren
id|sst_info-&gt;info.changevar
)paren
(brace
id|v_dprintk
c_func
(paren
l_string|&quot;fb_info.changevar(con: %d)&bslash;n&quot;
comma
id|con
)paren
suffix:semicolon
(paren
op_star
id|sst_info-&gt;info.changevar
)paren
(paren
id|con
)paren
suffix:semicolon
id|v_dprintk
c_func
(paren
l_string|&quot;fb_info.changevar: done &bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|v_dprintk
c_func
(paren
l_string|&quot;fb_info.changevar() == NULL . &bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|con
OL
l_int|0
)paren
op_logical_or
(paren
id|con
op_eq
id|info-&gt;currcon
)paren
)paren
(brace
id|sstfb_set_par
(paren
op_amp
id|par
comma
id|sst_info
)paren
suffix:semicolon
)brace
id|print_var
c_func
(paren
id|var
comma
l_string|&quot;var&quot;
)paren
suffix:semicolon
id|print_var
c_func
(paren
op_amp
id|display-&gt;var
comma
l_string|&quot;&amp;display-&gt;var&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_bpp
op_ne
id|var-&gt;bits_per_pixel
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|display-&gt;cmap
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
id|sstfb_install_cmap
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
DECL|macro|sst_info
macro_line|#undef sst_info
)brace
DECL|function|sstfb_set_cmap
r_static
r_int
id|sstfb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|display
op_star
id|d
op_assign
(paren
id|con
OL
l_int|0
)paren
ques
c_cond
id|info-&gt;disp
suffix:colon
id|fb_display
op_plus
id|con
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_set_cmap&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;con: %d, currcon: %d, d-&gt;cmap.len %d&bslash;n&quot;
comma
id|con
comma
id|info-&gt;currcon
comma
id|d-&gt;cmap.len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;cmap.len
op_ne
l_int|16
)paren
(brace
multiline_comment|/* or test if cmap.len == 0 ? */
r_int
id|err
suffix:semicolon
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|d-&gt;cmap
comma
l_int|16
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* cmap size=16 */
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_eq
id|info-&gt;currcon
)paren
(brace
r_return
id|fb_set_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
id|fb_copy_cmap
c_func
(paren
id|cmap
comma
op_amp
id|d-&gt;cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sstfb_get_cmap
r_static
r_int
id|sstfb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_get_cmap&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;con %d, curcon %d, cmap.len %d&bslash;n&quot;
comma
id|con
comma
id|info-&gt;currcon
comma
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
suffix:semicolon
multiline_comment|/* FIXME: check if con = -1 ? cf sstfb_set_cmap...  */
r_if
c_cond
(paren
id|con
op_eq
id|info-&gt;currcon
)paren
r_return
id|fb_get_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|sstfb_getcolreg
comma
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|fb_copy_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TODO */
DECL|function|sstfb_pan_display
r_static
r_int
id|sstfb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_pan_display&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|sstfb_ioctl
r_static
r_int
id|sstfb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
DECL|macro|sst_info
mdefine_line|#define sst_info&t;((struct sstfb_info *) info)&t;
macro_line|#if (SST_DEBUG_IOCTL &gt;0)
r_int
id|i
suffix:semicolon
id|u_long
id|p
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|u32
id|fbiinit0
suffix:semicolon
r_struct
id|pci_dev
op_star
id|sst_dev
op_assign
id|sst_info-&gt;dev
suffix:semicolon
macro_line|#endif
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_ioctl(%x)&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
macro_line|#if (SST_DEBUG_IOCTL &gt;0)
r_switch
c_cond
(paren
id|cmd
)paren
(brace
macro_line|#  if (SST_DEBUG_VAR &gt;0)
multiline_comment|/* tmp ioctl : dumps fb_display[0-5] */
r_case
id|_IO
c_func
(paren
l_char|&squot;F&squot;
comma
l_int|0xdb
)paren
suffix:colon
multiline_comment|/* 0x46db */
id|f_dprintk
c_func
(paren
l_string|&quot;dumping fb_display[0-5].var&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|print_var
c_func
(paren
op_amp
id|fb_display
(braket
id|i
)braket
dot
id|var
comma
l_string|&quot;var(%d)&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#  endif /* (SST_DEBUG_VAR &gt;0) */
multiline_comment|/* fills the lfb up to *(u32*)arg */
r_case
id|_IOW
c_func
(paren
l_char|&squot;F&squot;
comma
l_int|0xdc
comma
id|u32
)paren
suffix:colon
multiline_comment|/* 0x46dc */
r_if
c_cond
(paren
op_star
(paren
id|u32
op_star
)paren
id|arg
OG
l_int|0x400000
)paren
op_star
(paren
id|u32
op_star
)paren
id|arg
op_assign
l_int|0x400000
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;filling %#x &bslash;n&quot;
comma
op_star
(paren
id|u32
op_star
)paren
id|arg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
op_star
(paren
id|u32
op_star
)paren
id|arg
suffix:semicolon
id|p
op_add_assign
l_int|2
)paren
id|writew
c_func
(paren
id|p
op_rshift
l_int|6
comma
id|sst_info-&gt;video.vbase
op_plus
id|p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* change VGA pass_through */
r_case
id|_IOW
c_func
(paren
l_char|&squot;F&squot;
comma
l_int|0xdd
comma
id|u32
)paren
suffix:colon
multiline_comment|/* 0x46dd */
id|f_dprintk
c_func
(paren
l_string|&quot;switch VGA pass-through&bslash;n&quot;
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
op_amp
id|tmp
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|tmp
op_or
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
id|fbiinit0
op_assign
id|sst_read
(paren
id|FBIINIT0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
id|u32
op_star
)paren
id|arg
)paren
(brace
id|sst_write
c_func
(paren
id|FBIINIT0
comma
id|fbiinit0
op_amp
op_complement
id|EN_VGA_PASSTHROUGH
)paren
suffix:semicolon
id|iprintk
(paren
l_string|&quot;Disabling VGA pass-through&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|sst_write
c_func
(paren
id|FBIINIT0
comma
id|fbiinit0
op_or
id|EN_VGA_PASSTHROUGH
)paren
suffix:semicolon
id|iprintk
(paren
l_string|&quot;Enabling VGA pass-through&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|tmp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|_IO
c_func
(paren
l_char|&squot;F&squot;
comma
l_int|0xde
)paren
suffix:colon
multiline_comment|/* 0x46de */
id|f_dprintk
c_func
(paren
l_string|&quot;test color display&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;currcon: %d, bpp %d&bslash;n&quot;
comma
id|info-&gt;currcon
comma
id|fb_display
(braket
id|currcon
)braket
dot
id|var.bits_per_pixel
)paren
suffix:semicolon
id|memset_io
c_func
(paren
id|sst_info-&gt;video.vbase
comma
l_int|0
comma
id|sst_info-&gt;video.len
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fb_display
(braket
id|info-&gt;currcon
)braket
dot
id|var.bits_per_pixel
)paren
(brace
multiline_comment|/* FIXME broken : if we call this ioctl from a tty not bound to the fb, we use its depth and not the current one ... */
r_case
l_int|16
suffix:colon
id|sstfb_test16
c_func
(paren
id|sst_info
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#  ifdef EN_24_32_BPP
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|sstfb_test32
c_func
(paren
id|sst_info
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#  endif
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;bug line %d: bad depth &squot;%u&squot;&bslash;n&quot;
comma
id|__LINE__
comma
id|fb_display
(braket
id|info-&gt;currcon
)braket
dot
id|var.bits_per_pixel
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* (SST_DEBUG_IOCTL &gt;0) */
r_return
op_minus
id|EINVAL
suffix:semicolon
DECL|macro|sst_info
macro_line|#undef sst_info
)brace
multiline_comment|/*&n; * Low level routines&n; */
multiline_comment|/* get lfb size */
DECL|function|sst_get_memsize
r_static
r_int
id|sst_get_memsize
c_func
(paren
id|u_long
op_star
id|memsize
)paren
(brace
id|u32
id|fbbase_virt
op_assign
id|fb_info.video.vbase
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sst_get_memsize&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* force memsize */
r_if
c_cond
(paren
(paren
id|mem
op_ge
l_int|1
)paren
op_logical_and
(paren
id|mem
op_le
l_int|4
)paren
)paren
(brace
op_star
id|memsize
op_assign
(paren
id|mem
op_star
l_int|0x100000
)paren
suffix:semicolon
id|iprintk
c_func
(paren
l_string|&quot;supplied memsize: %#lx&bslash;n&quot;
comma
op_star
id|memsize
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|writel
(paren
l_int|0xdeadbeef
comma
id|fbbase_virt
)paren
suffix:semicolon
id|writel
(paren
l_int|0xdeadbeef
comma
id|fbbase_virt
op_plus
l_int|0x100000
)paren
suffix:semicolon
id|writel
(paren
l_int|0xdeadbeef
comma
id|fbbase_virt
op_plus
l_int|0x200000
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;0Mb: %#x, 1Mb: %#x, 2Mb: %#x&bslash;n&quot;
comma
id|readl
c_func
(paren
id|fbbase_virt
)paren
comma
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x100000
)paren
comma
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x200000
)paren
)paren
suffix:semicolon
id|writel
(paren
l_int|0xabcdef01
comma
id|fbbase_virt
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;0Mb: %#x, 1Mb: %#x, 2Mb: %#x&bslash;n&quot;
comma
id|readl
c_func
(paren
id|fbbase_virt
)paren
comma
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x100000
)paren
comma
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x200000
)paren
)paren
suffix:semicolon
multiline_comment|/* checks for 4mb lfb , then 2, then defaults to 1*/
r_if
c_cond
(paren
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x200000
)paren
op_eq
l_int|0xdeadbeef
)paren
(brace
op_star
id|memsize
op_assign
l_int|0x400000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|readl
c_func
(paren
id|fbbase_virt
op_plus
l_int|0x100000
)paren
op_eq
l_int|0xdeadbeef
)paren
(brace
op_star
id|memsize
op_assign
l_int|0x200000
suffix:semicolon
)brace
r_else
(brace
op_star
id|memsize
op_assign
l_int|0x100000
suffix:semicolon
)brace
id|f_ddprintk
c_func
(paren
l_string|&quot;detected memsize: %#lx&bslash;n&quot;
comma
op_star
id|memsize
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * wait for the fbi chip. ASK: what happens if the fbi is stuck ?&n; *&n; * the FBI is supposed to be ready if we receive 5 time&n; * in a row a &quot;idle&quot; answer to our requests&n; */
DECL|function|sst_wait_idle
r_static
r_int
id|sst_wait_idle
c_func
(paren
r_void
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;sst_wait_idle&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|sst_read
c_func
(paren
id|STATUS
)paren
op_amp
id|STATUS_FBI_BUSY
)paren
(brace
id|f_dddprintk
c_func
(paren
l_string|&quot;status: busy&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME basicaly, this is a busy wait. maybe not that good. oh well; this is a small loop after all ...*/
id|count
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|count
op_increment
suffix:semicolon
id|f_dddprintk
c_func
(paren
l_string|&quot;status: idle(%d)&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_ge
l_int|5
)paren
r_return
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * detect dac type&n; * prerequisite : write to FbiInitx enabled, video and fbi and pci fifo reset,&n; * dram refresh disabled, FbiInit remaped.&n; * TODO: mmh.. maybe i shoud put the &quot;prerequisite&quot; in the func ...&n; */
DECL|function|sst_detect_dactype
r_static
r_int
id|__init
id|sst_detect_dactype
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sst_detect_dactype&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|dacs
)paren
op_div
r_sizeof
(paren
id|dacs
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ret
op_assign
id|dacs
(braket
id|i
)braket
dot
id|detect
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_return
l_int|0
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;found %s&bslash;n&quot;
comma
id|dacs
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
id|fb_info.dac_sw
op_assign
op_amp
id|dacs
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* fbi should be idle, and fifo emty and mem disabled */
multiline_comment|/* supposed to detect AT&amp;T ATT20C409 and Ti TVP3409 ramdacs */
DECL|function|sst_detect_att
r_static
r_int
id|__init
(paren
id|sst_detect_att
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
comma
id|mir
comma
id|dir
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sst_detect_att&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* backdoor */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* read 4 times RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* the fifth time,  CR0 is read */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* the 6th, manufacturer id register */
id|mir
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/*the 7th, device ID register */
id|dir
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;mir: %#x, dir: %#x&bslash;n&quot;
comma
id|mir
comma
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mir
op_eq
id|DACREG_MIR_ATT
)paren
op_logical_and
(paren
id|dir
op_eq
id|DACREG_DIR_ATT
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sst_detect_ti
r_static
r_int
id|__init
(paren
id|sst_detect_ti
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
comma
id|mir
comma
id|dir
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sst_detect_ti&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* backdoor */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* read 4 times RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* the fifth time,  CR0 is read */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* the 6th, manufacturer id register */
id|mir
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/*the 7th, device ID register */
id|dir
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;mir: %#x, dir: %#x&bslash;n&quot;
comma
id|mir
comma
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mir
op_eq
id|DACREG_MIR_TI
)paren
op_logical_and
(paren
id|dir
op_eq
id|DACREG_DIR_TI
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * try to detect ICS5342  ramdac&n; * we get the 1st byte (M value) of preset f1,f7 and fB&n; * why those 3 ? mmmh... for now, i&squot;ll do it the glide way...&n; * and ask questions later. anyway, it seems that all the freq registers are&n; * realy at their default state (cf specs) so i ask again, why those 3 regs ?&n; * mmmmh.. it seems that&squot;s much more ugly than i thought. we use f0 and fA for&n; * pll programming, so in fact, we *hope* that the f1, f7 &amp; fB won&squot;t be&n; * touched...&n; * is it realy safe ? how can i reset this ramdac ? geee...&n; */
DECL|function|sst_detect_ics
r_static
r_int
id|__init
id|sst_detect_ics
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|m_clk0_1
comma
id|m_clk0_7
comma
id|m_clk1_b
suffix:semicolon
r_int
id|n_clk0_1
comma
id|n_clk0_7
comma
id|n_clk1_b
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sst_detect_ics&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLRMA
comma
l_int|0x1
)paren
suffix:semicolon
multiline_comment|/* f1 */
id|m_clk0_1
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|n_clk0_1
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLRMA
comma
l_int|0x7
)paren
suffix:semicolon
multiline_comment|/* f7 */
id|m_clk0_7
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|n_clk0_7
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLRMA
comma
l_int|0xb
)paren
suffix:semicolon
multiline_comment|/* fB */
id|m_clk1_b
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|n_clk1_b
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;m_clk0_1: %#x, m_clk0_7: %#x, m_clk1_b: %#x&bslash;n&quot;
comma
id|m_clk0_1
comma
id|m_clk0_7
comma
id|m_clk1_b
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;n_clk0_1: %#x, n_clk0_7: %#x, n_clk1_b: %#x&bslash;n&quot;
comma
id|n_clk0_1
comma
id|n_clk0_7
comma
id|n_clk1_b
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|m_clk0_1
op_eq
id|DACREG_ICS_PLL_CLK0_1_INI
)paren
op_logical_and
(paren
id|m_clk0_7
op_eq
id|DACREG_ICS_PLL_CLK0_7_INI
)paren
op_logical_and
(paren
id|m_clk1_b
op_eq
id|DACREG_ICS_PLL_CLK1_B_INI
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* compute the m,n,p  , returns the real freq&n; * (ics datasheet :  N &lt;-&gt; N1 , P &lt;-&gt; N2)&n; *&n; * Fout= Fref * (M+2)/( 2^P * (N+2))&n; *  we try to get close to the asked freq&n; *  with P as high, and M as low as possible&n; * range:&n; * ti/att : 0 &lt;= M &lt;= 255; 0 &lt;= P &lt;= 3; 0&lt;= N &lt;= 63&n; * ics    : 1 &lt;= M &lt;= 127; 0 &lt;= P &lt;= 3; 1&lt;= N &lt;= 31&n; * we&squot;ll use the lowest limitation, should be precise enouth&n; */
DECL|function|sst_calc_pll
r_static
r_int
id|sst_calc_pll
c_func
(paren
r_const
r_int
id|freq
comma
r_int
op_star
id|freq_out
comma
r_struct
id|pll_timing
op_star
id|t
)paren
(brace
r_int
id|m
comma
id|m2
comma
id|n
comma
id|p
comma
id|best_err
comma
id|fout
suffix:semicolon
r_int
id|best_n
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|best_m
op_assign
op_minus
l_int|1
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sst_calc_pll(%dKhz)&bslash;n&quot;
comma
id|freq
)paren
suffix:semicolon
id|best_err
op_assign
id|freq
suffix:semicolon
id|p
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* f * 2^P = vco should be less than VCOmax ~ 250 MHz for ics*/
r_while
c_loop
(paren
(paren
(paren
l_int|1
op_lshift
id|p
)paren
op_star
id|freq
OG
id|VCO_MAX
)paren
op_logical_and
(paren
id|p
op_ge
l_int|0
)paren
)paren
id|p
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|1
suffix:semicolon
id|n
OL
l_int|32
suffix:semicolon
id|n
op_increment
)paren
(brace
multiline_comment|/* calc 2 * m so we can round it later*/
id|m2
op_assign
(paren
l_int|2
op_star
id|freq
op_star
(paren
l_int|1
op_lshift
id|p
)paren
op_star
(paren
id|n
op_plus
l_int|2
)paren
)paren
op_div
id|DAC_FREF
op_minus
l_int|4
suffix:semicolon
id|m
op_assign
(paren
id|m2
op_mod
l_int|2
)paren
ques
c_cond
id|m2
op_div
l_int|2
op_plus
l_int|1
suffix:colon
id|m2
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|m
op_ge
l_int|128
)paren
r_break
suffix:semicolon
id|fout
op_assign
(paren
id|DAC_FREF
op_star
(paren
id|m
op_plus
l_int|2
)paren
)paren
op_div
(paren
(paren
l_int|1
op_lshift
id|p
)paren
op_star
(paren
id|n
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ABS
c_func
(paren
id|fout
op_minus
id|freq
)paren
OL
id|best_err
)paren
op_logical_and
(paren
id|m
OG
l_int|0
)paren
)paren
(brace
id|best_n
op_assign
id|n
suffix:semicolon
id|best_m
op_assign
id|m
suffix:semicolon
id|best_err
op_assign
id|ABS
c_func
(paren
id|fout
op_minus
id|freq
)paren
suffix:semicolon
multiline_comment|/* we get the lowest m , allowing 0.5% error in freq*/
r_if
c_cond
(paren
l_int|200
op_star
id|best_err
OL
id|freq
)paren
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|best_n
op_eq
op_minus
l_int|1
)paren
multiline_comment|/* unlikely, but who knows ? */
r_return
op_minus
id|EINVAL
suffix:semicolon
id|t-&gt;p
op_assign
id|p
suffix:semicolon
id|t-&gt;n
op_assign
id|best_n
suffix:semicolon
id|t-&gt;m
op_assign
id|best_m
suffix:semicolon
op_star
id|freq_out
op_assign
(paren
id|DAC_FREF
op_star
(paren
id|t-&gt;m
op_plus
l_int|2
)paren
)paren
op_div
(paren
(paren
l_int|1
op_lshift
id|t-&gt;p
)paren
op_star
(paren
id|t-&gt;n
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|f_ddprintk
(paren
l_string|&quot;m: %d, n: %d, p: %d, F: %dKhz&bslash;n&quot;
comma
id|t-&gt;m
comma
id|t-&gt;n
comma
id|t-&gt;p
comma
op_star
id|freq_out
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * gfx, video, pci fifo should be reset, dram refresh disabled&n; * see detect_dac&n; */
DECL|function|sst_set_pll_att_ti
r_static
r_int
id|sst_set_pll_att_ti
c_func
(paren
r_const
r_struct
id|pll_timing
op_star
id|t
comma
r_const
r_int
id|clock
)paren
(brace
id|u8
id|cr0
comma
id|cc
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sst_set_pll_att_ti&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* enable indexed mode */
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* backdoor */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* 1 time:  RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* 2 RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* 3 //  */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* 4 //  */
id|cr0
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* 5 CR0 */
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_RMR
comma
(paren
id|cr0
op_amp
l_int|0xf0
)paren
op_or
id|DACREG_CR0_EN_INDEXED
op_or
id|DACREG_CR0_8BIT
op_or
id|DACREG_CR0_PWDOWN
)paren
suffix:semicolon
multiline_comment|/* so, now we are in indexed mode . dunno if its common, but&n;&t;   i find this way of doing things a little bit weird :p */
id|udelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
id|cc
op_assign
id|dac_i_read
c_func
(paren
id|DACREG_CC_I
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|clock
)paren
(brace
r_case
id|VID_CLOCK
suffix:colon
id|dac_i_write
c_func
(paren
id|DACREG_AC0_I
comma
id|t-&gt;m
)paren
suffix:semicolon
id|dac_i_write
c_func
(paren
id|DACREG_AC1_I
comma
id|t-&gt;p
op_lshift
l_int|6
op_or
id|t-&gt;n
)paren
suffix:semicolon
id|dac_i_write
c_func
(paren
id|DACREG_CC_I
comma
(paren
id|cc
op_amp
l_int|0x0f
)paren
op_or
id|DACREG_CC_CLKA
op_or
id|DACREG_CC_CLKA_C
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GFX_CLOCK
suffix:colon
id|dac_i_write
c_func
(paren
id|DACREG_BD0_I
comma
id|t-&gt;m
)paren
suffix:semicolon
id|dac_i_write
c_func
(paren
id|DACREG_BD1_I
comma
id|t-&gt;p
op_lshift
l_int|6
op_or
id|t-&gt;n
)paren
suffix:semicolon
id|dac_i_write
c_func
(paren
id|DACREG_CC_I
comma
(paren
id|cc
op_amp
l_int|0xf0
)paren
op_or
id|DACREG_CC_CLKB
op_or
id|DACREG_CC_CLKB_D
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;bug line %d: wrong clock code &squot;%d&squot;&bslash;n&quot;
comma
id|__LINE__
comma
id|clock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
multiline_comment|/* power up the dac &amp; return to &quot;normal&quot; non-indexed mode */
id|dac_i_write
c_func
(paren
id|DACREG_CR0_I
comma
id|cr0
op_amp
op_complement
id|DACREG_CR0_PWDOWN
op_amp
op_complement
id|DACREG_CR0_EN_INDEXED
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sst_set_pll_ics
r_static
r_int
id|sst_set_pll_ics
c_func
(paren
r_const
r_struct
id|pll_timing
op_star
id|t
comma
r_const
r_int
id|clock
)paren
(brace
id|u8
id|pll_ctrl
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sst_set_pll_ics&bslash;n&quot;
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLRMA
comma
id|DACREG_ICS_PLL_CTRL
)paren
suffix:semicolon
id|pll_ctrl
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_ICS_PLLDATA
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|clock
)paren
(brace
r_case
id|VID_CLOCK
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLWMA
comma
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* CLK0, f0 */
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
id|t-&gt;m
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
id|t-&gt;p
op_lshift
l_int|5
op_or
id|t-&gt;n
)paren
suffix:semicolon
multiline_comment|/* selects freq f0 for clock 0 */
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLWMA
comma
id|DACREG_ICS_PLL_CTRL
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
(paren
id|pll_ctrl
op_amp
l_int|0xd8
)paren
op_or
id|DACREG_ICS_CLK0
op_or
id|DACREG_ICS_CLK0_0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GFX_CLOCK
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLWMA
comma
l_int|0xa
)paren
suffix:semicolon
multiline_comment|/* CLK1, fA */
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
id|t-&gt;m
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
id|t-&gt;p
op_lshift
l_int|5
op_or
id|t-&gt;n
)paren
suffix:semicolon
multiline_comment|/* selects freq fA for clock 1 */
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLWMA
comma
id|DACREG_ICS_PLL_CTRL
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_PLLDATA
comma
(paren
id|pll_ctrl
op_amp
l_int|0xef
)paren
op_or
id|DACREG_ICS_CLK1_A
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;bug line %d: wrong clock code &squot;%d&squot;&bslash;n&quot;
comma
id|__LINE__
comma
id|clock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sstfb_set_par
r_static
r_int
id|sstfb_set_par
c_func
(paren
r_const
r_struct
id|sstfb_par
op_star
id|par
comma
r_struct
id|sstfb_info
op_star
id|sst_info
)paren
(brace
id|u32
id|lfbmode
comma
id|fbiinit1
comma
id|fbiinit2
comma
id|fbiinit3
comma
id|fbiinit6
op_assign
l_int|0
suffix:semicolon
r_int
id|ntiles
suffix:semicolon
r_struct
id|pll_timing
id|pll
suffix:semicolon
r_int
id|fout
suffix:semicolon
r_struct
id|pci_dev
op_star
id|sst_dev
op_assign
id|sst_info-&gt;dev
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sst_set_par(%dx%d)&bslash;n&quot;
comma
id|par-&gt;xDim
comma
id|par-&gt;yDim
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;hSyncOn hSyncOff vSyncOn vSyncOff&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;%-7d %-8d %-7d %-8d&bslash;n&quot;
comma
id|par-&gt;hSyncOn
comma
id|par-&gt;hSyncOff
comma
id|par-&gt;vSyncOn
comma
id|par-&gt;vSyncOff
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;hBackPorch vBackPorch xDim yDim Freq&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;%-10d %-10d %-4d %-4d %-8d&bslash;n&quot;
comma
id|par-&gt;hBackPorch
comma
id|par-&gt;vBackPorch
comma
id|par-&gt;xDim
comma
id|par-&gt;yDim
comma
id|par-&gt;freq
)paren
suffix:semicolon
id|sst_calc_pll
(paren
id|par-&gt;freq
comma
op_amp
id|fout
comma
op_amp
id|pll
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|NOPCMD
comma
l_int|0
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBIINIT1
comma
id|VIDEO_RESET
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBIINIT0
comma
id|FBI_RESET
op_or
id|FIFO_RESET
)paren
suffix:semicolon
id|sst_unset_bits
c_func
(paren
id|FBIINIT2
comma
id|EN_DRAM_REFRESH
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*sst_unset_bits (FBIINIT0, FBI_RESET); / reenable FBI ? */
id|sst_write
c_func
(paren
id|BACKPORCH
comma
id|par-&gt;vBackPorch
op_lshift
l_int|16
op_or
(paren
id|par-&gt;hBackPorch
op_minus
l_int|2
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|VIDEODIMENSIONS
comma
(paren
id|par-&gt;yDim
op_minus
l_int|1
)paren
op_lshift
l_int|16
op_or
(paren
id|par-&gt;xDim
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|HSYNC
comma
(paren
id|par-&gt;hSyncOff
op_minus
l_int|1
)paren
op_lshift
l_int|16
op_or
(paren
id|par-&gt;hSyncOn
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|VSYNC
comma
id|par-&gt;vSyncOff
op_lshift
l_int|16
op_or
id|par-&gt;vSyncOn
)paren
suffix:semicolon
id|fbiinit2
op_assign
id|sst_read
c_func
(paren
id|FBIINIT2
)paren
suffix:semicolon
id|fbiinit3
op_assign
id|sst_read
c_func
(paren
id|FBIINIT3
)paren
suffix:semicolon
multiline_comment|/* everything is reset. we enable fbiinit2/3 remap : dac acces ok */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
op_or
id|PCI_REMAP_DAC
)paren
suffix:semicolon
id|sst_info-&gt;dac_sw
op_member_access_from_pointer
id|set_vidmod
c_func
(paren
id|par-&gt;bpp
)paren
suffix:semicolon
multiline_comment|/* set video clock */
id|sst_info-&gt;dac_sw
op_member_access_from_pointer
id|set_pll
c_func
(paren
op_amp
id|pll
comma
id|VID_CLOCK
)paren
suffix:semicolon
multiline_comment|/* disable fbiinit2/3 remap */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
multiline_comment|/* restore fbiinit2/3 */
id|sst_write
c_func
(paren
id|FBIINIT2
comma
id|fbiinit2
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|FBIINIT3
comma
id|fbiinit3
)paren
suffix:semicolon
id|fbiinit1
op_assign
(paren
id|sst_read
c_func
(paren
id|FBIINIT1
)paren
op_amp
id|VIDEO_MASK
)paren
op_or
id|EN_DATA_OE
op_or
id|EN_BLANK_OE
op_or
id|EN_HVSYNC_OE
op_or
id|EN_DCLK_OE
multiline_comment|/*&t;            | (15 &lt;&lt; TILES_IN_X_SHIFT)*/
op_or
id|SEL_INPUT_VCLK_2X
multiline_comment|/*&t;            | (2 &lt;&lt; VCLK_2X_SEL_DEL_SHIFT)&n;&t;            | (2 &lt;&lt; VCLK_DEL_SHIFT)*/
suffix:semicolon
multiline_comment|/* try with vclk_in_delay =0 (bits 29:30) , vclk_out_delay =0 (bits(27:28)&n; in (near) future set them accordingly to revision + resolution (cf glide)&n; first understand what it stands for :)&n; FIXME: there are some artefacts... check for the vclk_in_delay&n; lets try with 6ns delay in both vclk_out &amp; in...&n; doh... they&squot;re still there :&bslash;&n;*/
id|ntiles
op_assign
id|par-&gt;tiles_in_X
suffix:semicolon
r_if
c_cond
(paren
id|sst_info-&gt;is_voodoo2
)paren
(brace
id|fbiinit1
op_or_assign
(paren
(paren
id|ntiles
op_amp
l_int|0x20
)paren
op_rshift
l_int|5
)paren
op_lshift
id|TILES_IN_X_MSB_SHIFT
op_or
(paren
(paren
id|ntiles
op_amp
l_int|0x1e
)paren
op_rshift
l_int|1
)paren
op_lshift
id|TILES_IN_X_SHIFT
suffix:semicolon
multiline_comment|/* as the only value of importance for us in fbiinit6 is tiles in X (lsb),&n;   and as reading fbinit 6 will return crap (see FBIINIT6_DEFAULT) we just&n;   write our value. BTW due to the dac unable to read odd number of tiles, this&n;   field is always null ... */
id|fbiinit6
op_assign
(paren
id|ntiles
op_amp
l_int|0x1
)paren
op_lshift
id|TILES_IN_X_LSB_SHIFT
suffix:semicolon
)brace
r_else
id|fbiinit1
op_or_assign
id|ntiles
op_lshift
id|TILES_IN_X_SHIFT
suffix:semicolon
r_switch
c_cond
(paren
id|par-&gt;bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|fbiinit1
op_or_assign
id|SEL_SOURCE_VCLK_2X_SEL
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
multiline_comment|/*&t;orig&t;sst_set_bits(FBIINIT1, SEL_SOURCE_VCLK_2X_DIV2 | EN_24BPP); */
id|fbiinit1
op_or_assign
id|SEL_SOURCE_VCLK_2X_SEL
op_or
id|EN_24BPP
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;bug line %d: bad depth &squot;%u&squot;&bslash;n&quot;
comma
id|__LINE__
comma
id|par-&gt;bpp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sst_write
c_func
(paren
id|FBIINIT1
comma
id|fbiinit1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sst_info-&gt;is_voodoo2
)paren
id|sst_write
c_func
(paren
id|FBIINIT6
comma
id|fbiinit6
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|sst_unset_bits
c_func
(paren
id|FBIINIT1
comma
id|VIDEO_RESET
)paren
suffix:semicolon
id|sst_unset_bits
c_func
(paren
id|FBIINIT0
comma
id|FBI_RESET
op_or
id|FIFO_RESET
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBIINIT2
comma
id|EN_DRAM_REFRESH
)paren
suffix:semicolon
multiline_comment|/* disables fbiinit writes */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_FIFO_WR
)paren
suffix:semicolon
multiline_comment|/* set lfbmode : set mode + front buffer for reads/writes&n;&t;   + disable pipeline + disable byte swapping */
r_switch
c_cond
(paren
id|par-&gt;bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|lfbmode
op_assign
id|LFB_565
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|24
suffix:colon
id|lfbmode
op_assign
id|LFB_888
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|lfbmode
op_assign
id|LFB_8888
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;bug line %d: bad depth &squot;%u&squot;&bslash;n&quot;
comma
id|__LINE__
comma
id|par-&gt;bpp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|clipping
)paren
(brace
id|sst_write
c_func
(paren
id|LFBMODE
comma
id|lfbmode
op_or
id|EN_PXL_PIPELINE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set &quot;clipping&quot; dimensions. If clipping is disabled and&n;&t; * writes to offscreen areas of the framebuffer are performed,&n;&t; * the &quot;behaviour is undefined&quot; (_very_ undefined) - Urs&n;&t; */
multiline_comment|/* btw, it requires enabling pixel pipeline in LFBMODE .&n;&t;   off screen read/writes will just wrap and read/print pixels&n;&t;   on screen. Ugly but not that dangerous */
id|f_ddprintk
c_func
(paren
l_string|&quot;setting clipping dimensions 0..%d, 0..%d&bslash;n&quot;
comma
id|par-&gt;xDim
op_minus
l_int|1
comma
id|par-&gt;yDim
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* warning the fields are 9bits wide on voodoo1 , 11 (or 10) on voodoo2,&n;   make sure we check the values before playing with the registers.. */
id|sst_write
c_func
(paren
id|CLIP_LEFT_RIGHT
comma
id|par-&gt;xDim
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|CLIP_LOWY_HIGHY
comma
id|par-&gt;yDim
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBZMODE
comma
id|EN_CLIPPING
op_or
id|EN_RGB_WRITE
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no clipping : direct access, no pipeline */
id|sst_write
c_func
(paren
id|LFBMODE
comma
id|lfbmode
)paren
suffix:semicolon
)brace
id|sst_info-&gt;current_par
op_assign
op_star
id|par
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sst_set_vidmod_att_ti
r_static
r_void
id|sst_set_vidmod_att_ti
c_func
(paren
r_const
r_int
id|bpp
)paren
(brace
id|u8
id|cr0
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sst_set_vidmod_att_ti(bpp: %d)&bslash;n&quot;
comma
id|bpp
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* backdoor */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* read 4 times RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* the fifth time,  CR0 is read */
id|cr0
op_assign
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_write
c_func
(paren
id|DACREG_WMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* backdoor */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* read 4 times RMR */
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
id|sst_dac_read
c_func
(paren
id|DACREG_RMR
)paren
suffix:semicolon
multiline_comment|/* cr0 */
r_switch
c_cond
(paren
id|bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_RMR
comma
(paren
id|cr0
op_amp
l_int|0x0f
)paren
op_or
id|DACREG_CR0_16BPP
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_RMR
comma
(paren
id|cr0
op_amp
l_int|0x0f
)paren
op_or
id|DACREG_CR0_24BPP
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;bug line %d: bad depth &squot;%u&squot;&bslash;n&quot;
comma
id|__LINE__
comma
id|bpp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|sst_set_vidmod_ics
r_static
r_void
id|sst_set_vidmod_ics
c_func
(paren
r_const
r_int
id|bpp
)paren
(brace
id|f_dprintk
c_func
(paren
l_string|&quot;sst_set_vidmod_ics(bpp: %d)&bslash;n&quot;
comma
id|bpp
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_CMD
comma
id|DACREG_ICS_CMD_16BPP
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef EN_24_32_BPP
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|sst_dac_write
c_func
(paren
id|DACREG_ICS_CMD
comma
id|DACREG_ICS_CMD_24BPP
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;bug line %d: bad depth &squot;%u&squot;&bslash;n&quot;
comma
id|__LINE__
comma
id|bpp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|sst_init
r_static
r_int
id|__init
id|sst_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|pll_timing
id|gfx_timings
suffix:semicolon
r_int
id|Fout
suffix:semicolon
r_int
id|dac_ok
suffix:semicolon
id|u32
id|fbiinit0
comma
id|fbiinit1
comma
id|fbiinit4
suffix:semicolon
r_struct
id|pci_dev
op_star
id|sst_dev
op_assign
id|fb_info.dev
suffix:semicolon
multiline_comment|/* or define a macro ?*/
id|f_dprintk
c_func
(paren
l_string|&quot;sst_init&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot; fbiinit0   fbiinit1   fbiinit2   fbiinit3   fbiinit4  &quot;
l_string|&quot; fbiinit6&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;%0#10x %0#10x %0#10x %0#10x %0#10x %0#10x&bslash;n&quot;
comma
id|sst_read
c_func
(paren
id|FBIINIT0
)paren
comma
id|sst_read
c_func
(paren
id|FBIINIT1
)paren
comma
id|sst_read
c_func
(paren
id|FBIINIT2
)paren
comma
id|sst_read
c_func
(paren
id|FBIINIT3
)paren
comma
id|sst_read
c_func
(paren
id|FBIINIT4
)paren
comma
id|sst_read
c_func
(paren
id|FBIINIT6
)paren
)paren
suffix:semicolon
multiline_comment|/* disable video clock */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_VCLK_DISABLE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* enable writing to init registers ,disable pci fifo*/
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
multiline_comment|/* reset video */
id|sst_set_bits
c_func
(paren
id|FBIINIT1
comma
id|VIDEO_RESET
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* reset gfx + pci fifo */
id|sst_set_bits
c_func
(paren
id|FBIINIT0
comma
id|FBI_RESET
op_or
id|FIFO_RESET
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* unreset fifo */
multiline_comment|/*sst_unset_bits(FBIINIT0, FIFO_RESET);&n;&t;sst_wait_idle();*/
multiline_comment|/* unreset FBI */
multiline_comment|/*sst_unset_bits(FBIINIT0, FBI_RESET);&n;&t;sst_wait_idle();*/
multiline_comment|/* disable dram refresh */
id|sst_unset_bits
c_func
(paren
id|FBIINIT2
comma
id|EN_DRAM_REFRESH
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* remap fbinit2/3 to dac */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
op_or
id|PCI_REMAP_DAC
)paren
suffix:semicolon
multiline_comment|/* detect dac type */
id|dac_ok
op_assign
id|sst_detect_dactype
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dac_ok
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Unknown dac type&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set graphic clock */
r_if
c_cond
(paren
id|dac_ok
)paren
(brace
id|fb_info.gfx_clock
op_assign
id|fb_info.spec-&gt;default_gfx_clock
suffix:semicolon
r_if
c_cond
(paren
(paren
id|gfxclk
OG
l_int|10
)paren
op_logical_and
(paren
id|gfxclk
OL
id|fb_info.spec-&gt;max_gfxclk
)paren
)paren
(brace
id|iprintk
(paren
l_string|&quot;Using supplied graphic freq : %dMHz&bslash;n&quot;
comma
id|gfxclk
)paren
suffix:semicolon
id|fb_info.gfx_clock
op_assign
id|gfxclk
op_star
l_int|1000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gfxclk
)paren
(brace
id|wprintk
(paren
l_string|&quot;You fool, %dMhz is way out of spec! Using default&bslash;n&quot;
comma
id|gfxclk
)paren
suffix:semicolon
)brace
id|sst_calc_pll
c_func
(paren
id|fb_info.gfx_clock
comma
op_amp
id|Fout
comma
op_amp
id|gfx_timings
)paren
suffix:semicolon
id|fb_info.dac_sw
op_member_access_from_pointer
id|set_pll
c_func
(paren
op_amp
id|gfx_timings
comma
id|GFX_CLOCK
)paren
suffix:semicolon
)brace
multiline_comment|/* disable fbiinit remap */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
op_or
id|PCI_EN_FIFO_WR
)paren
suffix:semicolon
multiline_comment|/* defaults init registers */
multiline_comment|/* FbiInit0: unreset gfx, unreset fifo */
id|fbiinit0
op_assign
id|FBIINIT0_DEFAULT
suffix:semicolon
id|fbiinit1
op_assign
id|FBIINIT1_DEFAULT
suffix:semicolon
id|fbiinit4
op_assign
id|FBIINIT4_DEFAULT
suffix:semicolon
r_if
c_cond
(paren
id|vgapass
)paren
id|fbiinit0
op_and_assign
op_complement
id|EN_VGA_PASSTHROUGH
suffix:semicolon
r_else
id|fbiinit0
op_or_assign
id|EN_VGA_PASSTHROUGH
suffix:semicolon
r_if
c_cond
(paren
id|slowpci
)paren
(brace
id|fbiinit1
op_or_assign
id|SLOW_PCI_WRITES
suffix:semicolon
id|fbiinit4
op_or_assign
id|SLOW_PCI_READS
suffix:semicolon
)brace
r_else
(brace
id|fbiinit1
op_and_assign
op_complement
id|SLOW_PCI_WRITES
suffix:semicolon
id|fbiinit4
op_and_assign
op_complement
id|SLOW_PCI_READS
suffix:semicolon
)brace
id|sst_write
c_func
(paren
id|FBIINIT0
comma
id|fbiinit0
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|FBIINIT1
comma
id|fbiinit1
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|FBIINIT2
comma
id|FBIINIT2_DEFAULT
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|FBIINIT3
comma
id|FBIINIT3_DEFAULT
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|sst_write
c_func
(paren
id|FBIINIT4
comma
id|fbiinit4
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fb_info.is_voodoo2
)paren
(brace
id|sst_write
c_func
(paren
id|FBIINIT6
comma
id|FBIINIT6_DEFAULT
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
)brace
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_FIFO_WR
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_VCLK_ENABLE
comma
l_int|0
)paren
suffix:semicolon
r_return
id|dac_ok
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|sst_shutdown
r_static
r_void
id|__exit
id|sst_shutdown
c_func
(paren
r_void
)paren
(brace
r_struct
id|pll_timing
id|gfx_timings
suffix:semicolon
r_int
id|Fout
suffix:semicolon
r_struct
id|pci_dev
op_star
id|sst_dev
op_assign
id|fb_info.dev
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sst_shutdown&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* reset video, gfx, fifo, disable dram + remap fbiinit2/3 */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBIINIT1
comma
id|VIDEO_RESET
op_or
id|EN_BLANKING
)paren
suffix:semicolon
id|sst_unset_bits
c_func
(paren
id|FBIINIT2
comma
id|EN_DRAM_REFRESH
)paren
suffix:semicolon
id|sst_set_bits
c_func
(paren
id|FBIINIT0
comma
id|FBI_RESET
op_or
id|FIFO_RESET
)paren
suffix:semicolon
id|sst_wait_idle
c_func
(paren
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
op_or
id|PCI_REMAP_DAC
)paren
suffix:semicolon
multiline_comment|/*set 20Mhz gfx clock */
id|sst_calc_pll
c_func
(paren
l_int|20000
comma
op_amp
id|Fout
comma
op_amp
id|gfx_timings
)paren
suffix:semicolon
id|fb_info.dac_sw
op_member_access_from_pointer
id|set_pll
c_func
(paren
op_amp
id|gfx_timings
comma
id|GFX_CLOCK
)paren
suffix:semicolon
multiline_comment|/* TODO maybe shutdown the dac, vrefresh and so on... */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
id|PCI_EN_INIT_WR
)paren
suffix:semicolon
id|sst_unset_bits
c_func
(paren
id|FBIINIT0
comma
id|FBI_RESET
op_or
id|FIFO_RESET
op_or
id|EN_VGA_PASSTHROUGH
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_VCLK_DISABLE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* maybe keep fbiinit* and PCI_INIT_enable in the fb_info struct at the beginining ? */
id|pci_write_config_dword
c_func
(paren
id|sst_dev
comma
id|PCI_INIT_ENABLE
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
multiline_comment|/*&n; * Interface to the world&n; */
DECL|function|sstfb_setup
r_int
id|__init
id|sstfb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_setup&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;option %s&bslash;n&quot;
comma
id|this_opt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;inverse&quot;
)paren
)paren
(brace
id|inverse
op_assign
l_int|1
suffix:semicolon
id|fb_invert_cmaps
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;vganopass&quot;
)paren
)paren
id|vgapass
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;vgapass&quot;
)paren
)paren
id|vgapass
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;clipping&quot;
)paren
)paren
id|clipping
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;noclipping&quot;
)paren
)paren
id|clipping
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;fastpci&quot;
)paren
)paren
id|slowpci
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;slowpci&quot;
)paren
)paren
id|slowpci
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;mem:&quot;
comma
l_int|4
)paren
)paren
id|mem
op_assign
id|simple_strtoul
(paren
id|this_opt
op_plus
l_int|4
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;gfxclk:&quot;
comma
l_int|7
)paren
)paren
id|gfxclk
op_assign
id|simple_strtoul
(paren
id|this_opt
op_plus
l_int|7
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;dev:&quot;
comma
l_int|4
)paren
)paren
id|dev
op_assign
id|simple_strtoul
(paren
id|this_opt
op_plus
l_int|4
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
id|mode_option
op_assign
id|this_opt
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sstfb_init
r_int
id|__init
id|sstfb_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
DECL|macro|sst_dev
mdefine_line|#define sst_dev&t;(fb_info.dev)
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_init&bslash;n&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Compile date: &quot;
id|__DATE__
l_string|&quot; &quot;
id|__TIME__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|fb_info
comma
l_int|0
comma
r_sizeof
(paren
id|fb_info
)paren
)paren
suffix:semicolon
id|pci_for_each_dev
c_func
(paren
id|pdev
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;vendor
op_ne
id|PCI_VENDOR_ID_3DFX
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_3DFX_VOODOO
)paren
(brace
id|fb_info.is_voodoo2
op_assign
l_int|0
suffix:semicolon
id|fb_info.spec
op_assign
op_amp
id|voodoo1_spec
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_3DFX_VOODOO2
)paren
(brace
id|fb_info.is_voodoo2
op_assign
l_int|1
suffix:semicolon
id|fb_info.spec
op_assign
op_amp
id|voodoo2_spec
suffix:semicolon
)brace
r_else
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
l_int|0
)paren
(brace
id|dev
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|f_ddprintk
c_func
(paren
l_string|&quot;found device : %s&bslash;n&quot;
comma
id|fb_info.spec-&gt;name
)paren
suffix:semicolon
id|fb_info.dev
op_assign
id|pdev
suffix:semicolon
id|fb_info.mmio.base
op_assign
id|sst_dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|sst_dev
comma
id|PCI_REVISION_ID
comma
op_amp
id|fb_info.revision
)paren
suffix:semicolon
id|fb_info.mmio.vbase
op_assign
(paren
id|u32
)paren
id|ioremap_nocache
c_func
(paren
id|fb_info.mmio.base
comma
l_int|0x400000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_info.mmio.vbase
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;cannot remap register area %#lx&bslash;n&quot;
comma
id|fb_info.mmio.base
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|fb_info.video.base
op_assign
id|fb_info.mmio.base
op_plus
l_int|0x400000
suffix:semicolon
id|fb_info.video.vbase
op_assign
(paren
id|u32
)paren
id|ioremap_nocache
c_func
(paren
id|fb_info.video.base
comma
l_int|0x400000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_info.video.vbase
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;cannot remap framebuffer %#lx&bslash;n&quot;
comma
id|fb_info.video.base
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|fb_info.mmio.vbase
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sst_init
c_func
(paren
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;Init failed&bslash;n&quot;
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|fb_info.mmio.vbase
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|fb_info.video.vbase
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|sst_get_memsize
c_func
(paren
op_amp
id|fb_info.video.len
)paren
suffix:semicolon
id|fb_info.configured
op_assign
l_int|1
suffix:semicolon
id|strncpy
c_func
(paren
id|fb_info.info.modename
comma
id|fb_info.spec-&gt;name
comma
l_int|16
)paren
suffix:semicolon
id|iprintk
c_func
(paren
l_string|&quot;%s with %s dac&bslash;n&quot;
comma
id|fb_info.info.modename
comma
id|fb_info.dac_sw-&gt;name
)paren
suffix:semicolon
id|iprintk
c_func
(paren
l_string|&quot;framebuffer at %#lx, mapped to %#lx,&quot;
l_string|&quot; size %ldMb&bslash;n&quot;
comma
id|fb_info.video.base
comma
id|fb_info.video.vbase
comma
id|fb_info.video.len
op_rshift
l_int|20
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;revision: %d&bslash;n&quot;
comma
id|fb_info.revision
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;regbase_virt: %#lx&bslash;n&quot;
comma
id|fb_info.mmio.vbase
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;membase_phys: %#lx&bslash;n&quot;
comma
id|fb_info.video.base
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;fbbase_virt: %#lx&bslash;n&quot;
comma
id|fb_info.video.vbase
)paren
suffix:semicolon
id|fb_info.info.node
op_assign
id|NODEV
suffix:semicolon
id|fb_info.info.flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
id|fb_info.info.fbops
op_assign
op_amp
id|sstfb_ops
suffix:semicolon
id|fb_info.info.disp
op_assign
op_amp
id|disp
suffix:semicolon
id|fb_info.info.currcon
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|fb_info.info.switch_con
op_assign
op_amp
id|sstfbcon_switch
suffix:semicolon
id|fb_info.info.updatevar
op_assign
op_amp
id|sstfbcon_updatevar
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mode_option
op_logical_and
op_logical_neg
id|fb_find_mode
c_func
(paren
op_amp
id|var
comma
op_amp
id|fb_info.info
comma
id|mode_option
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|16
)paren
)paren
(brace
id|var
op_assign
id|sstfb_default
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sstfb_set_var
c_func
(paren
op_amp
id|var
comma
op_minus
l_int|1
comma
op_amp
id|fb_info.info
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;can&squot;t set supplied video mode. Using default&bslash;n&quot;
)paren
suffix:semicolon
id|var
op_assign
id|sstfb_default
suffix:semicolon
r_if
c_cond
(paren
id|sstfb_set_var
c_func
(paren
op_amp
id|var
comma
op_minus
l_int|1
comma
op_amp
id|fb_info.info
)paren
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;can&squot;t set default video mode.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
)brace
multiline_comment|/*clear fb */
id|memset_io
c_func
(paren
id|fb_info.video.vbase
comma
l_int|0
comma
id|fb_info.video.len
)paren
suffix:semicolon
multiline_comment|/* print some squares ... */
id|sstfb_test16
c_func
(paren
op_amp
id|fb_info
)paren
suffix:semicolon
multiline_comment|/* FIXME this is only for 16bpp */
multiline_comment|/* register fb */
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info.info
)paren
OL
l_int|0
)paren
(brace
id|eprintk
c_func
(paren
l_string|&quot;can&squot;t register framebuffer.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fb%d: %s frame buffer device&bslash;n&quot;
comma
id|GET_FB_IDX
c_func
(paren
id|fb_info.info.node
)paren
comma
id|fb_info.info.modename
)paren
suffix:semicolon
id|num_sst
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_le
l_int|0
)paren
multiline_comment|/* we use the first card only for now (==0) */
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* no voodoo detected */
DECL|macro|sst_dev
macro_line|#undef sst_dev
)brace
multiline_comment|/*&n; * console driver&n; */
DECL|function|sstfbcon_switch
r_static
r_int
id|sstfbcon_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
DECL|macro|sst_info
mdefine_line|#define sst_info&t; ((struct sstfb_info *) info)
r_struct
id|sstfb_par
id|par
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sstfbcon_switch(con: %d)&bslash;n&quot;
comma
id|con
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;currcon: %d&bslash;n&quot;
comma
id|info-&gt;currcon
)paren
suffix:semicolon
id|v_dprintk
c_func
(paren
l_string|&quot;currcon: %d&bslash;n&quot;
comma
id|info-&gt;currcon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;currcon
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|fb_display
(braket
id|info-&gt;currcon
)braket
dot
id|cmap.len
)paren
id|fb_get_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|info-&gt;currcon
)braket
dot
id|cmap
comma
l_int|1
comma
id|sstfb_getcolreg
comma
id|info
)paren
suffix:semicolon
)brace
id|info-&gt;currcon
op_assign
id|con
suffix:semicolon
id|fb_display
(braket
id|con
)braket
dot
id|var.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|print_var
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
l_string|&quot;&amp;fb_display[con: %d].var&quot;
comma
id|con
)paren
suffix:semicolon
id|sstfb_decode_var
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
op_amp
id|par
comma
id|sst_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|par
comma
op_amp
(paren
id|sst_info-&gt;current_par
)paren
comma
r_sizeof
(paren
id|par
)paren
)paren
)paren
(brace
id|sstfb_set_par
c_func
(paren
op_amp
id|par
comma
id|sst_info
)paren
suffix:semicolon
)brace
id|sstfb_install_cmap
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
DECL|macro|sst_info
macro_line|#undef sst_info
)brace
DECL|function|sstfbcon_updatevar
r_static
r_int
id|sstfbcon_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|f_dprintk
c_func
(paren
l_string|&quot;sstfbcon_updatevar&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* print some squares on the fb (presuming 16bpp)  */
DECL|function|sstfb_test16
r_static
r_void
id|sstfb_test16
c_func
(paren
r_struct
id|sstfb_info
op_star
id|sst_info
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|u_long
id|p
suffix:semicolon
id|u_long
id|fbbase_virt
op_assign
id|sst_info-&gt;video.vbase
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_test16&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* rect blanc 20x100+200+0 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|fbbase_virt
op_plus
l_int|2048
op_star
id|i
op_plus
l_int|400
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|10
suffix:semicolon
id|j
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0xffffffff
comma
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
multiline_comment|/* rect bleu 180x200+0+0 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|200
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|fbbase_virt
op_plus
l_int|2048
op_star
id|i
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|90
suffix:semicolon
id|j
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0x001f001f
comma
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
multiline_comment|/* carre vert 40x40+100+0 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|fbbase_virt
op_plus
l_int|2048
op_star
id|i
op_plus
l_int|200
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|20
suffix:semicolon
id|j
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0x07e007e0
comma
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
multiline_comment|/*carre rouge 40x40+100+40 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|fbbase_virt
op_plus
l_int|2048
op_star
(paren
id|i
op_plus
l_int|40
)paren
op_plus
l_int|200
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|20
suffix:semicolon
id|j
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0xf800f800
comma
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* print some squares on the fb (24/32bpp)  */
macro_line|#ifdef EN_24_32_BPP
DECL|function|sstfb_test32
r_static
r_void
id|sstfb_test32
c_func
(paren
r_struct
id|sstfb_info
op_star
id|sst_info
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|u_long
id|p
suffix:semicolon
id|u32
id|fbbase_virt
op_assign
id|sst_info-&gt;video.vbase
suffix:semicolon
id|f_dprintk
c_func
(paren
l_string|&quot;sstfb_test32&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* rect blanc 20x100+200+0 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|fbbase_virt
op_plus
l_int|4096
op_star
id|i
op_plus
l_int|800
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|20
suffix:semicolon
id|j
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0x00ffffff
comma
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
multiline_comment|/* rect bleu 180x200+0+0 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|200
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|fbbase_virt
op_plus
l_int|4096
op_star
id|i
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|180
suffix:semicolon
id|j
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0x000000ff
comma
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
multiline_comment|/* carre vert 40x40+100+0 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|fbbase_virt
op_plus
l_int|4096
op_star
id|i
op_plus
l_int|400
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|40
suffix:semicolon
id|j
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0x0000ff00
comma
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
multiline_comment|/*carre rouge 40x40+100+10 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|fbbase_virt
op_plus
l_int|4096
op_star
(paren
id|i
op_plus
l_int|40
)paren
op_plus
l_int|400
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|40
suffix:semicolon
id|j
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0x00ff0000
comma
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif /* EN_24_32_BPP */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|f_dprintk
c_func
(paren
l_string|&quot;init_module&bslash;n&quot;
)paren
suffix:semicolon
id|sstfb_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_sst
op_eq
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|f_dprintk
c_func
(paren
l_string|&quot;cleanup_module&bslash;n&quot;
)paren
suffix:semicolon
id|f_ddprintk
c_func
(paren
l_string|&quot;conf %d&bslash;n&quot;
comma
id|fb_info.configured
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fb_info.configured
)paren
(brace
id|sst_shutdown
c_func
(paren
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|fb_info.mmio.vbase
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|fb_info.video.vbase
)paren
suffix:semicolon
id|unregister_framebuffer
c_func
(paren
op_amp
id|fb_info.info
)paren
suffix:semicolon
)brace
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;(c) 2000,2001 Ghozlane Toumi &lt;gtoumi@messel.emse.fr&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;FBDev driver for 3dfx Voodoo Graphics and Voodoo2 based video boards&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mem
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mem
comma
l_string|&quot;Size of frame buffer memory in MiB (1, 2, 4 Mb, default=autodetect)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|vgapass
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|vgapass
comma
l_string|&quot;Enable VGA PassThrough cable (0 or 1) (default=0)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|inverse
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|inverse
comma
l_string|&quot;Inverse colormap (0 or 1) (default=0)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|clipping
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|clipping
comma
l_string|&quot;Enable clipping (slower, safer) (0 or 1) (default=1)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|gfxclk
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|gfxclk
comma
l_string|&quot;Force graphic chip frequency in Mhz. DANGEROUS. (default=auto)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|slowpci
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|slowpci
comma
l_string|&quot;Uses slow PCI settings (0 or 1) (default=0)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dev
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dev
comma
l_string|&quot;Attach to device ID (0..n) (default=1st device)&quot;
)paren
suffix:semicolon
macro_line|#endif&t;/* MODULE */
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
macro_line|#if 0
r_void
id|Dump_regs
(paren
r_void
)paren
(brace
r_struct
(brace
id|u32
id|reg
suffix:semicolon
r_char
op_star
id|reg_name
suffix:semicolon
)brace
id|pci_regs
(braket
)braket
op_assign
(brace
(brace
id|PCI_INIT_ENABLE
comma
l_string|&quot;initenable&quot;
)brace
comma
(brace
id|PCI_VCLK_ENABLE
comma
l_string|&quot;enable vclk&quot;
)brace
comma
(brace
id|PCI_VCLK_DISABLE
comma
l_string|&quot;disable vclk&quot;
)brace
comma
)brace
suffix:semicolon
r_struct
(brace
id|u32
id|reg
suffix:semicolon
r_char
op_star
id|reg_name
suffix:semicolon
)brace
id|sst_regs
(braket
)braket
op_assign
(brace
(brace
id|FBIINIT0
comma
l_string|&quot;fbiinit0&quot;
)brace
comma
(brace
id|FBIINIT1
comma
l_string|&quot;fbiinit1&quot;
)brace
comma
(brace
id|FBIINIT2
comma
l_string|&quot;fbiinit2&quot;
)brace
comma
(brace
id|FBIINIT3
comma
l_string|&quot;fbiinit3&quot;
)brace
comma
(brace
id|FBIINIT4
comma
l_string|&quot;fbiinit4&quot;
)brace
comma
(brace
id|FBIINIT5
comma
l_string|&quot;fbiinit5&quot;
)brace
comma
(brace
id|FBIINIT6
comma
l_string|&quot;fbiinit6&quot;
)brace
comma
(brace
id|FBIINIT7
comma
l_string|&quot;fbiinit7&quot;
)brace
comma
(brace
id|LFBMODE
comma
l_string|&quot;lfbmode&quot;
)brace
comma
(brace
id|FBZMODE
comma
l_string|&quot;fbzmode&quot;
)brace
comma
)brace
suffix:semicolon
id|u32
id|pci_res
(braket
r_sizeof
(paren
id|pci_regs
)paren
op_div
r_sizeof
(paren
id|pci_regs
(braket
l_int|0
)braket
)paren
)braket
suffix:semicolon
id|u32
id|sst_res
(braket
r_sizeof
(paren
id|sst_regs
)paren
op_div
r_sizeof
(paren
id|sst_regs
(braket
l_int|0
)braket
)paren
)braket
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|fb_info.dev
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|pci_regs
)paren
op_div
r_sizeof
(paren
id|pci_regs
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pci_read_config_dword
(paren
id|dev
comma
id|pci_regs
(braket
id|i
)braket
dot
id|reg
comma
op_amp
id|pci_res
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|sst_regs
)paren
op_div
r_sizeof
(paren
id|sst_regs
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sst_res
(braket
id|i
)braket
op_assign
id|sst_read
c_func
(paren
id|sst_regs
(braket
id|i
)braket
dot
id|reg
)paren
suffix:semicolon
)brace
id|dprintk
(paren
l_string|&quot;Dump regs&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|pci_regs
)paren
op_div
r_sizeof
(paren
id|pci_regs
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s = %0#10x&bslash;n&quot;
comma
id|pci_regs
(braket
id|i
)braket
dot
id|reg_name
comma
id|pci_res
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|sst_regs
)paren
op_div
r_sizeof
(paren
id|sst_regs
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s = %0#10x&bslash;n&quot;
comma
id|sst_regs
(braket
id|i
)braket
dot
id|reg_name
comma
id|sst_res
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
