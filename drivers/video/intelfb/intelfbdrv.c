multiline_comment|/*&n; * intelfb&n; *&n; * Linux framebuffer driver for Intel(R) 830M/845G/852GM/855GM/865G&n; * integrated graphics chips.&n; *&n; * Copyright &#xfffd; 2002, 2003 David Dawes &lt;dawes@xfree86.org&gt;&n; *                   2004 Sylvain Meyer&n; *&n; * This driver consists of two parts.  The first part (intelfbdrv.c) provides&n; * the basic fbdev interfaces, is derived in part from the radeonfb and&n; * vesafb drivers, and is covered by the GPL.  The second part (intelfbhw.c)&n; * provides the code to program the hardware.  Most of it is derived from&n; * the i810/i830 XFree86 driver.  The HW-specific code is covered here&n; * under a dual license (GPL and MIT/XFree86 license).&n; *&n; * Author: David Dawes&n; *&n; */
multiline_comment|/* $DHD: intelfb/intelfbdrv.c,v 1.20 2003/06/27 15:17:40 dawes Exp $ */
multiline_comment|/*&n; * Changes:&n; *    01/2003 - Initial driver (0.1.0), no mode switching, no acceleration.&n; *&t;&t;This initial version is a basic core that works a lot like&n; *&t;&t;the vesafb driver.  It must be built-in to the kernel,&n; *&t;&t;and the initial video mode must be set with vga=XXX at&n; *&t;&t;boot time.  (David Dawes)&n; *&n; *    01/2003 - Version 0.2.0: Mode switching added, colormap support&n; *&t;&t;implemented, Y panning, and soft screen blanking implemented.&n; *&t;&t;No acceleration yet.  (David Dawes)&n; *&n; *    01/2003 - Version 0.3.0: fbcon acceleration support added.  Module&n; *&t;&t;option handling added.  (David Dawes)&n; *&n; *    01/2003 - Version 0.4.0: fbcon HW cursor support added.  (David Dawes)&n; *&n; *    01/2003 - Version 0.4.1: Add auto-generation of built-in modes.&n; *&t;&t;(David Dawes)&n; *&n; *    02/2003 - Version 0.4.2: Add check for active non-CRT devices, and&n; *&t;&t;mode validation checks.  (David Dawes)&n; *&n; *    02/2003 - Version 0.4.3: Check when the VC is in graphics mode so that&n; *&t;&t;acceleration is disabled while an XFree86 server is running.&n; *&t;&t;(David Dawes)&n; *&n; *    02/2003 - Version 0.4.4: Monitor DPMS support.  (David Dawes)&n; *&n; *    02/2003 - Version 0.4.5: Basic XFree86 + fbdev working.  (David Dawes)&n; *&n; *    02/2003 - Version 0.5.0: Modify to work with the 2.5.32 kernel as well&n; *&t;&t;as 2.4.x kernels.  (David Dawes)&n; *&n; *    02/2003 - Version 0.6.0: Split out HW-specifics into a separate file.&n; *&t;&t;(David Dawes)&n; *&n; *    02/2003 - Version 0.7.0: Test on 852GM/855GM.  Acceleration and HW&n; *&t;&t;cursor are disabled on this platform.  (David Dawes)&n; *&n; *    02/2003 - Version 0.7.1: Test on 845G.  Acceleration is disabled&n; *&t;&t;on this platform.  (David Dawes)&n; *&n; *    02/2003 - Version 0.7.2: Test on 830M.  Acceleration and HW&n; *&t;&t;cursor are disabled on this platform.  (David Dawes)&n; *&n; *    02/2003 - Version 0.7.3: Fix 8-bit modes for mobile platforms&n; *&t;&t;(David Dawes)&n; *&n; *    02/2003 - Version 0.7.4: Add checks for FB and FBCON_HAS_CFB* configured&n; *&t;&t;in the kernel, and add mode bpp verification and default&n; *&t;&t;bpp selection based on which FBCON_HAS_CFB* are configured.&n; *&t;&t;(David Dawes)&n; *&n; *    02/2003 - Version 0.7.5: Add basic package/install scripts based on the&n; *&t;&t;DRI packaging scripts.  (David Dawes)&n; *&n; *    04/2003 - Version 0.7.6: Fix typo that affects builds with SMP-enabled&n; *&t;&t;kernels.  (David Dawes, reported by Anupam).&n; *&n; *    06/2003 - Version 0.7.7:&n; *              Fix Makefile.kernel build problem (Tsutomu Yasuda).&n; *&t;&t;Fix mis-placed #endif (2.4.21 kernel).&n; *&n; *    09/2004 - Version 0.9.0 - by Sylvain Meyer&n; *              Port to linux 2.6 kernel fbdev&n; *              Fix HW accel and HW cursor on i845G&n; *              Use of agpgart for fb memory reservation&n; *              Add mtrr support&n; *&n; *    10/2004 - Version 0.9.1&n; *              Use module_param instead of old MODULE_PARM&n; *              Some cleanup&n; *&n; *    11/2004 - Version 0.9.2&n; *              Add vram option to reserve more memory than stolen by BIOS&n; *              Fix intelfbhw_pan_display typo&n; *              Add __initdata annotations&n; *&n; * TODO:&n; *&n; *&n; * Wish List:&n; *&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#ifdef CONFIG_MTRR
macro_line|#include &lt;asm/mtrr.h&gt;
macro_line|#endif
macro_line|#include &quot;intelfb.h&quot;
macro_line|#include &quot;intelfbdrv.h&quot;
macro_line|#include &quot;intelfbhw.h&quot;
multiline_comment|/*&n; * Limiting the class to PCI_CLASS_DISPLAY_VGA prevents function 1 of the&n; * mobile chipsets from being registered.&n; */
macro_line|#if DETECT_VGA_CLASS_ONLY
DECL|macro|INTELFB_CLASS_MASK
mdefine_line|#define INTELFB_CLASS_MASK ~0 &lt;&lt; 8
macro_line|#else
DECL|macro|INTELFB_CLASS_MASK
mdefine_line|#define INTELFB_CLASS_MASK 0
macro_line|#endif
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|intelfb_pci_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_830M
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|PCI_CLASS_DISPLAY_VGA
op_lshift
l_int|8
comma
id|INTELFB_CLASS_MASK
comma
id|INTEL_830M
)brace
comma
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_845G
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|PCI_CLASS_DISPLAY_VGA
op_lshift
l_int|8
comma
id|INTELFB_CLASS_MASK
comma
id|INTEL_845G
)brace
comma
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_85XGM
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|PCI_CLASS_DISPLAY_VGA
op_lshift
l_int|8
comma
id|INTELFB_CLASS_MASK
comma
id|INTEL_85XGM
)brace
comma
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_865G
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|PCI_CLASS_DISPLAY_VGA
op_lshift
l_int|8
comma
id|INTELFB_CLASS_MASK
comma
id|INTEL_865G
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
multiline_comment|/* Global data */
DECL|variable|num_registered
r_static
r_int
id|num_registered
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fb ops */
DECL|variable|intel_fb_ops
r_static
r_struct
id|fb_ops
id|intel_fb_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|fb_check_var
op_assign
id|intelfb_check_var
comma
dot
id|fb_set_par
op_assign
id|intelfb_set_par
comma
dot
id|fb_setcolreg
op_assign
id|intelfb_setcolreg
comma
dot
id|fb_blank
op_assign
id|intelfb_blank
comma
dot
id|fb_pan_display
op_assign
id|intelfb_pan_display
comma
dot
id|fb_fillrect
op_assign
id|intelfb_fillrect
comma
dot
id|fb_copyarea
op_assign
id|intelfb_copyarea
comma
dot
id|fb_imageblit
op_assign
id|intelfb_imageblit
comma
dot
id|fb_cursor
op_assign
id|intelfb_cursor
comma
dot
id|fb_sync
op_assign
id|intelfb_sync
comma
dot
id|fb_ioctl
op_assign
id|intelfb_ioctl
)brace
suffix:semicolon
multiline_comment|/* PCI driver module table */
DECL|variable|intelfb_driver
r_static
r_struct
id|pci_driver
id|intelfb_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Intel(R) &quot;
id|SUPPORTED_CHIPSETS
l_string|&quot; Framebuffer Driver&quot;
comma
dot
id|id_table
op_assign
id|intelfb_pci_table
comma
dot
id|probe
op_assign
id|intelfb_pci_register
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|intelfb_pci_unregister
)paren
)brace
suffix:semicolon
multiline_comment|/* Module description/parameters */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;David Dawes &lt;dawes@tungstengraphics.com&gt;, &quot;
l_string|&quot;Sylvain Meyer &lt;sylvain.meyer@worldonline.fr&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Framebuffer driver for Intel(R) &quot;
id|SUPPORTED_CHIPSETS
l_string|&quot; chipsets&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual BSD/GPL&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|intelfb_pci_table
)paren
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|accel
id|__initdata
op_assign
l_int|1
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|vram
id|__initdata
op_assign
l_int|4
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|hwcursor
id|__initdata
op_assign
l_int|1
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|mtrr
id|__initdata
op_assign
l_int|1
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|fixed
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|noinit
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|noregister
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|probeonly
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|idonly
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|bailearly
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
op_star
id|mode
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
id|module_param
c_func
(paren
id|accel
comma
r_bool
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|accel
comma
l_string|&quot;Enable console acceleration&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|vram
comma
r_int
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|vram
comma
l_string|&quot;System RAM to allocate to framebuffer in MiB&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|hwcursor
comma
r_bool
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|hwcursor
comma
l_string|&quot;Enable HW cursor&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|mtrr
comma
r_bool
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mtrr
comma
l_string|&quot;Enable MTRR support&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|fixed
comma
r_bool
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|fixed
comma
l_string|&quot;Disable mode switching&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|noinit
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|noinit
comma
l_string|&quot;Don&squot;t initialise graphics mode when loading&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|noregister
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|noregister
comma
l_string|&quot;Don&squot;t register, just probe and exit (debug)&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|probeonly
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|probeonly
comma
l_string|&quot;Do a minimal probe (debug)&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|idonly
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|idonly
comma
l_string|&quot;Just identify without doing anything else (debug)&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|bailearly
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|bailearly
comma
l_string|&quot;Bail out early, depending on value (debug)&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|mode
comma
id|charp
comma
id|S_IRUGO
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mode
comma
l_string|&quot;Initial video mode &bslash;&quot;&lt;xres&gt;x&lt;yres&gt;[-&lt;depth&gt;][@&lt;refresh&gt;]&bslash;&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/***************************************************************&n; *                     modules entry points                    *&n; ***************************************************************/
multiline_comment|/* module load/unload entry points */
r_int
id|__init
DECL|function|intelfb_init
id|intelfb_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifndef MODULE
r_char
op_star
id|option
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_init&bslash;n&quot;
)paren
suffix:semicolon
id|INF_MSG
c_func
(paren
l_string|&quot;Framebuffer driver for &quot;
l_string|&quot;Intel(R) &quot;
id|SUPPORTED_CHIPSETS
l_string|&quot; chipsets&bslash;n&quot;
)paren
suffix:semicolon
id|INF_MSG
c_func
(paren
l_string|&quot;Version &quot;
id|INTELFB_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idonly
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#ifndef MODULE
r_if
c_cond
(paren
id|fb_get_options
c_func
(paren
l_string|&quot;intelfb&quot;
comma
op_amp
id|option
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|intelfb_setup
c_func
(paren
id|option
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pci_module_init
c_func
(paren
op_amp
id|intelfb_driver
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|intelfb_exit
id|intelfb_exit
c_func
(paren
r_void
)paren
(brace
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_exit&bslash;n&quot;
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|intelfb_driver
)paren
suffix:semicolon
)brace
macro_line|#ifndef MODULE
DECL|macro|OPT_EQUAL
mdefine_line|#define OPT_EQUAL(opt, name) (!strncmp(opt, name, strlen(name)))
DECL|macro|OPT_INTVAL
mdefine_line|#define OPT_INTVAL(opt, name) simple_strtoul(opt + strlen(name), NULL, 0)
DECL|macro|OPT_STRVAL
mdefine_line|#define OPT_STRVAL(opt, name) (opt + strlen(name))
r_static
id|__inline__
r_char
op_star
DECL|function|get_opt_string
id|get_opt_string
c_func
(paren
r_const
r_char
op_star
id|this_opt
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_const
r_char
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|ret
suffix:semicolon
id|p
op_assign
id|OPT_STRVAL
c_func
(paren
id|this_opt
comma
id|name
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|p
(braket
id|i
)braket
op_logical_and
id|p
(braket
id|i
)braket
op_ne
l_char|&squot; &squot;
op_logical_and
id|p
(braket
id|i
)braket
op_ne
l_char|&squot;,&squot;
)paren
id|i
op_increment
suffix:semicolon
id|ret
op_assign
id|kmalloc
c_func
(paren
id|i
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|strncpy
c_func
(paren
id|ret
comma
id|p
comma
id|i
)paren
suffix:semicolon
id|ret
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
id|__inline__
r_int
DECL|function|get_opt_int
id|get_opt_int
c_func
(paren
r_const
r_char
op_star
id|this_opt
comma
r_const
r_char
op_star
id|name
comma
r_int
op_star
id|ret
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|OPT_EQUAL
c_func
(paren
id|this_opt
comma
id|name
)paren
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|ret
op_assign
id|OPT_INTVAL
c_func
(paren
id|this_opt
comma
id|name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
id|__inline__
r_int
DECL|function|get_opt_bool
id|get_opt_bool
c_func
(paren
r_const
r_char
op_star
id|this_opt
comma
r_const
r_char
op_star
id|name
comma
r_int
op_star
id|ret
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|OPT_EQUAL
c_func
(paren
id|this_opt
comma
id|name
)paren
)paren
(brace
r_if
c_cond
(paren
id|this_opt
(braket
id|strlen
c_func
(paren
id|name
)paren
)braket
op_eq
l_char|&squot;=&squot;
)paren
op_star
id|ret
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
op_star
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|OPT_EQUAL
c_func
(paren
id|this_opt
comma
l_string|&quot;no&quot;
)paren
op_logical_and
id|OPT_EQUAL
c_func
(paren
id|this_opt
op_plus
l_int|2
comma
id|name
)paren
)paren
op_star
id|ret
op_assign
l_int|0
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_int
id|__init
DECL|function|intelfb_setup
id|intelfb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_setup&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
(brace
id|DBG_MSG
c_func
(paren
l_string|&quot;no options&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|DBG_MSG
c_func
(paren
l_string|&quot;options: %s&bslash;n&quot;
comma
id|options
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * These are the built-in options analogous to the module parameters&n;&t; * defined above.&n;&t; *&n;&t; * The syntax is:&n;&t; *&n;&t; *    video=intelfb:[mode][,&lt;param&gt;=&lt;val&gt;] ...&n;&t; *&n;&t; * e.g.,&n;&t; *&n;&t; *    video=intelfb:1024x768-16@75,accel=0&n;&t; */
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|get_opt_bool
c_func
(paren
id|this_opt
comma
l_string|&quot;accel&quot;
comma
op_amp
id|accel
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|get_opt_int
c_func
(paren
id|this_opt
comma
l_string|&quot;vram&quot;
comma
op_amp
id|vram
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|get_opt_bool
c_func
(paren
id|this_opt
comma
l_string|&quot;hwcursor&quot;
comma
op_amp
id|hwcursor
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|get_opt_bool
c_func
(paren
id|this_opt
comma
l_string|&quot;mtrr&quot;
comma
op_amp
id|mtrr
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|get_opt_bool
c_func
(paren
id|this_opt
comma
l_string|&quot;fixed&quot;
comma
op_amp
id|fixed
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|get_opt_bool
c_func
(paren
id|this_opt
comma
l_string|&quot;init&quot;
comma
op_amp
id|noinit
)paren
)paren
id|noinit
op_assign
op_logical_neg
id|noinit
suffix:semicolon
r_else
r_if
c_cond
(paren
id|OPT_EQUAL
c_func
(paren
id|this_opt
comma
l_string|&quot;mode=&quot;
)paren
)paren
id|mode
op_assign
id|get_opt_string
c_func
(paren
id|this_opt
comma
l_string|&quot;mode=&quot;
)paren
suffix:semicolon
r_else
id|mode
op_assign
id|this_opt
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|intelfb_init
id|module_init
c_func
(paren
id|intelfb_init
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|intelfb_exit
id|module_exit
c_func
(paren
id|intelfb_exit
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/***************************************************************&n; *                     mtrr support functions                  *&n; ***************************************************************/
macro_line|#ifdef CONFIG_MTRR
DECL|function|set_mtrr
r_static
r_inline
r_void
id|__devinit
id|set_mtrr
c_func
(paren
r_struct
id|intelfb_info
op_star
id|dinfo
)paren
(brace
id|dinfo-&gt;mtrr_reg
op_assign
id|mtrr_add
c_func
(paren
id|dinfo-&gt;aperture.physical
comma
id|dinfo-&gt;aperture.size
comma
id|MTRR_TYPE_WRCOMB
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;mtrr_reg
OL
l_int|0
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;unable to set MTRR&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dinfo-&gt;has_mtrr
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|unset_mtrr
r_static
r_inline
r_void
id|unset_mtrr
c_func
(paren
r_struct
id|intelfb_info
op_star
id|dinfo
)paren
(brace
r_if
c_cond
(paren
id|dinfo-&gt;has_mtrr
)paren
id|mtrr_del
c_func
(paren
id|dinfo-&gt;mtrr_reg
comma
id|dinfo-&gt;aperture.physical
comma
id|dinfo-&gt;aperture.size
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|set_mtrr
mdefine_line|#define set_mtrr(x) WRN_MSG(&quot;MTRR is disabled in the kernel&bslash;n&quot;)
DECL|macro|unset_mtrr
mdefine_line|#define unset_mtrr(x) do { } while (0)
macro_line|#endif /* CONFIG_MTRR */
multiline_comment|/***************************************************************&n; *                        driver init / cleanup                *&n; ***************************************************************/
r_static
r_void
DECL|function|cleanup
id|cleanup
c_func
(paren
r_struct
id|intelfb_info
op_star
id|dinfo
)paren
(brace
id|DBG_MSG
c_func
(paren
l_string|&quot;cleanup&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dinfo
)paren
r_return
suffix:semicolon
id|fb_dealloc_cmap
c_func
(paren
op_amp
id|dinfo-&gt;info-&gt;cmap
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dinfo-&gt;info-&gt;pixmap.addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;registered
)paren
id|unregister_framebuffer
c_func
(paren
id|dinfo-&gt;info
)paren
suffix:semicolon
id|unset_mtrr
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;fbmem_gart
op_logical_and
id|dinfo-&gt;gtt_fb_mem
)paren
(brace
id|agp_unbind_memory
c_func
(paren
id|dinfo-&gt;gtt_fb_mem
)paren
suffix:semicolon
id|agp_free_memory
c_func
(paren
id|dinfo-&gt;gtt_fb_mem
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dinfo-&gt;gtt_cursor_mem
)paren
(brace
id|agp_unbind_memory
c_func
(paren
id|dinfo-&gt;gtt_cursor_mem
)paren
suffix:semicolon
id|agp_free_memory
c_func
(paren
id|dinfo-&gt;gtt_cursor_mem
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dinfo-&gt;gtt_ring_mem
)paren
(brace
id|agp_unbind_memory
c_func
(paren
id|dinfo-&gt;gtt_ring_mem
)paren
suffix:semicolon
id|agp_free_memory
c_func
(paren
id|dinfo-&gt;gtt_ring_mem
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dinfo-&gt;mmio_base
)paren
id|iounmap
c_func
(paren
(paren
r_void
id|__iomem
op_star
)paren
id|dinfo-&gt;mmio_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;aperture
dot
r_virtual
)paren
id|iounmap
c_func
(paren
(paren
r_void
id|__iomem
op_star
)paren
id|dinfo-&gt;aperture
dot
r_virtual
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;mmio_base_phys
)paren
id|release_mem_region
c_func
(paren
id|dinfo-&gt;mmio_base_phys
comma
id|INTEL_REG_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;aperture.physical
)paren
id|release_mem_region
c_func
(paren
id|dinfo-&gt;aperture.physical
comma
id|dinfo-&gt;aperture.size
)paren
suffix:semicolon
id|framebuffer_release
c_func
(paren
id|dinfo-&gt;info
)paren
suffix:semicolon
)brace
DECL|macro|bailout
mdefine_line|#define bailout(dinfo) do {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;DBG_MSG(&quot;bailout&bslash;n&quot;);&t;&t;&t;&t;&t;&t;&bslash;&n;&t;cleanup(dinfo);&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;INF_MSG(&quot;Not going to register framebuffer, exiting...&bslash;n&quot;);&t;&bslash;&n;&t;return -ENODEV;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;} while (0)
r_static
r_int
id|__devinit
DECL|function|intelfb_pci_register
id|intelfb_pci_register
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_struct
id|intelfb_info
op_star
id|dinfo
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|err
comma
id|dvo
suffix:semicolon
r_int
id|aperture_size
comma
id|stolen_size
suffix:semicolon
r_struct
id|agp_kern_info
id|gtt_info
suffix:semicolon
r_int
id|agp_memtype
suffix:semicolon
r_const
r_char
op_star
id|s
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_pci_register&bslash;n&quot;
)paren
suffix:semicolon
id|num_registered
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|num_registered
op_ne
l_int|1
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Attempted to register %d devices &quot;
l_string|&quot;(should be only 1).&bslash;n&quot;
comma
id|num_registered
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|info
op_assign
id|framebuffer_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|intelfb_info
)paren
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Could not allocate memory for intelfb_info.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fb_alloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
comma
l_int|256
comma
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Could not allocate cmap for intelfb_info.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_cmap
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dinfo
op_assign
id|info-&gt;par
suffix:semicolon
id|dinfo-&gt;info
op_assign
id|info
suffix:semicolon
id|dinfo-&gt;fbops
op_assign
op_amp
id|intel_fb_ops
suffix:semicolon
id|dinfo-&gt;pdev
op_assign
id|pdev
suffix:semicolon
multiline_comment|/* Reserve pixmap space. */
id|info-&gt;pixmap.addr
op_assign
id|kmalloc
c_func
(paren
l_int|64
op_star
l_int|1024
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;pixmap.addr
op_eq
l_int|NULL
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Cannot reserve pixmap memory.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_pixmap
suffix:semicolon
)brace
id|memset
c_func
(paren
id|info-&gt;pixmap.addr
comma
l_int|0
comma
l_int|64
op_star
l_int|1024
)paren
suffix:semicolon
multiline_comment|/* set early this option because it could be changed by tv encoder&n;&t;   driver */
id|dinfo-&gt;fixed_mode
op_assign
id|fixed
suffix:semicolon
multiline_comment|/* Enable device. */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Cannot enable device.&bslash;n&quot;
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Set base addresses. */
id|dinfo-&gt;aperture.physical
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|dinfo-&gt;aperture.size
op_assign
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|dinfo-&gt;mmio_base_phys
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;fb aperture: 0x%lx/0x%lx, MMIO region: 0x%lx/0x%lx&bslash;n&quot;
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Reserve the fb and MMIO regions */
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|dinfo-&gt;aperture.physical
comma
id|dinfo-&gt;aperture.size
comma
id|INTELFB_MODULE_NAME
)paren
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Cannot reserve FB region.&bslash;n&quot;
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|dinfo-&gt;mmio_base_phys
comma
id|INTEL_REG_SIZE
comma
id|INTELFB_MODULE_NAME
)paren
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Cannot reserve MMIO region.&bslash;n&quot;
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Map the fb and MMIO regions */
id|dinfo-&gt;aperture
dot
r_virtual
op_assign
(paren
id|u8
id|__iomem
op_star
)paren
id|ioremap_nocache
(paren
id|dinfo-&gt;aperture.physical
comma
id|dinfo-&gt;aperture.size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dinfo-&gt;aperture
dot
r_virtual
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Cannot remap FB region.&bslash;n&quot;
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dinfo-&gt;mmio_base
op_assign
(paren
id|u8
id|__iomem
op_star
)paren
id|ioremap_nocache
c_func
(paren
id|dinfo-&gt;mmio_base_phys
comma
id|INTEL_REG_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dinfo-&gt;mmio_base
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Cannot remap MMIO region.&bslash;n&quot;
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Get the chipset info. */
id|dinfo-&gt;pci_chipset
op_assign
id|pdev-&gt;device
suffix:semicolon
r_if
c_cond
(paren
id|intelfbhw_get_chipset
c_func
(paren
id|pdev
comma
op_amp
id|dinfo-&gt;name
comma
op_amp
id|dinfo-&gt;chipset
comma
op_amp
id|dinfo-&gt;mobile
)paren
)paren
(brace
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intelfbhw_get_memory
c_func
(paren
id|pdev
comma
op_amp
id|aperture_size
comma
op_amp
id|stolen_size
)paren
)paren
(brace
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|INF_MSG
c_func
(paren
l_string|&quot;%02x:%02x.%d: %s, aperture size %dMB, &quot;
l_string|&quot;stolen memory %dkB&bslash;n&quot;
comma
id|pdev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|pdev-&gt;devfn
)paren
comma
id|dinfo-&gt;name
comma
id|BtoMB
c_func
(paren
id|aperture_size
)paren
comma
id|BtoKB
c_func
(paren
id|stolen_size
)paren
)paren
suffix:semicolon
multiline_comment|/* Set these from the options. */
id|dinfo-&gt;accel
op_assign
id|accel
suffix:semicolon
id|dinfo-&gt;hwcursor
op_assign
id|hwcursor
suffix:semicolon
r_if
c_cond
(paren
id|NOACCEL_CHIPSET
c_func
(paren
id|dinfo
)paren
op_logical_and
id|dinfo-&gt;accel
op_eq
l_int|1
)paren
(brace
id|INF_MSG
c_func
(paren
l_string|&quot;Acceleration is not supported for the %s chipset.&bslash;n&quot;
comma
id|dinfo-&gt;name
)paren
suffix:semicolon
id|dinfo-&gt;accel
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Framebuffer parameters - Use all the stolen memory if &gt;= vram */
r_if
c_cond
(paren
id|ROUND_UP_TO_PAGE
c_func
(paren
id|stolen_size
)paren
op_ge
id|MB
c_func
(paren
id|vram
)paren
)paren
(brace
id|dinfo-&gt;fb.size
op_assign
id|ROUND_UP_TO_PAGE
c_func
(paren
id|stolen_size
)paren
suffix:semicolon
id|dinfo-&gt;fbmem_gart
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|dinfo-&gt;fb.size
op_assign
id|MB
c_func
(paren
id|vram
)paren
suffix:semicolon
id|dinfo-&gt;fbmem_gart
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Allocate space for the ring buffer and HW cursor if enabled. */
r_if
c_cond
(paren
id|dinfo-&gt;accel
)paren
(brace
id|dinfo-&gt;ring.size
op_assign
id|RINGBUFFER_SIZE
suffix:semicolon
id|dinfo-&gt;ring_tail_mask
op_assign
id|dinfo-&gt;ring.size
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dinfo-&gt;hwcursor
)paren
(brace
id|dinfo-&gt;cursor.size
op_assign
id|HW_CURSOR_SIZE
suffix:semicolon
)brace
multiline_comment|/* Use agpgart to manage the GATT */
r_if
c_cond
(paren
id|agp_backend_acquire
c_func
(paren
)paren
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;cannot acquire agp&bslash;n&quot;
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* get the current gatt info */
r_if
c_cond
(paren
id|agp_copy_info
c_func
(paren
op_amp
id|gtt_info
)paren
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;cannot get agp info&bslash;n&quot;
)paren
suffix:semicolon
id|agp_backend_release
c_func
(paren
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* set the mem offsets - set them after the already used pages */
r_if
c_cond
(paren
id|dinfo-&gt;accel
)paren
(brace
id|dinfo-&gt;ring.offset
op_assign
(paren
id|stolen_size
op_rshift
l_int|12
)paren
op_plus
id|gtt_info.current_memory
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dinfo-&gt;hwcursor
)paren
(brace
id|dinfo-&gt;cursor.offset
op_assign
(paren
id|stolen_size
op_rshift
l_int|12
)paren
op_plus
op_plus
id|gtt_info.current_memory
op_plus
(paren
id|dinfo-&gt;ring.size
op_rshift
l_int|12
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dinfo-&gt;fbmem_gart
)paren
(brace
id|dinfo-&gt;fb.offset
op_assign
(paren
id|stolen_size
op_rshift
l_int|12
)paren
op_plus
op_plus
id|gtt_info.current_memory
op_plus
(paren
id|dinfo-&gt;ring.size
op_rshift
l_int|12
)paren
op_plus
(paren
id|dinfo-&gt;cursor.size
op_rshift
l_int|12
)paren
suffix:semicolon
)brace
multiline_comment|/* Allocate memories (which aren&squot;t stolen) */
r_if
c_cond
(paren
id|dinfo-&gt;accel
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dinfo-&gt;gtt_ring_mem
op_assign
id|agp_allocate_memory
c_func
(paren
id|dinfo-&gt;ring.size
op_rshift
l_int|12
comma
id|AGP_NORMAL_MEMORY
)paren
)paren
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;cannot allocate ring buffer memory&bslash;n&quot;
)paren
suffix:semicolon
id|agp_backend_release
c_func
(paren
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|agp_bind_memory
c_func
(paren
id|dinfo-&gt;gtt_ring_mem
comma
id|dinfo-&gt;ring.offset
)paren
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;cannot bind ring buffer memory&bslash;n&quot;
)paren
suffix:semicolon
id|agp_backend_release
c_func
(paren
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|dinfo-&gt;ring.physical
op_assign
id|dinfo-&gt;aperture.physical
op_plus
(paren
id|dinfo-&gt;ring.offset
op_lshift
l_int|12
)paren
suffix:semicolon
id|dinfo-&gt;ring
dot
r_virtual
op_assign
id|dinfo-&gt;aperture
dot
r_virtual
op_plus
(paren
id|dinfo-&gt;ring.offset
op_lshift
l_int|12
)paren
suffix:semicolon
id|dinfo-&gt;ring_head
op_assign
id|dinfo-&gt;ring
dot
r_virtual
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dinfo-&gt;hwcursor
)paren
(brace
id|agp_memtype
op_assign
id|dinfo-&gt;mobile
ques
c_cond
id|AGP_PHYSICAL_MEMORY
suffix:colon
id|AGP_NORMAL_MEMORY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dinfo-&gt;gtt_cursor_mem
op_assign
id|agp_allocate_memory
c_func
(paren
id|dinfo-&gt;cursor.size
op_rshift
l_int|12
comma
id|agp_memtype
)paren
)paren
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;cannot allocate cursor memory&bslash;n&quot;
)paren
suffix:semicolon
id|agp_backend_release
c_func
(paren
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|agp_bind_memory
c_func
(paren
id|dinfo-&gt;gtt_cursor_mem
comma
id|dinfo-&gt;cursor.offset
)paren
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;cannot bind cursor memory&bslash;n&quot;
)paren
suffix:semicolon
id|agp_backend_release
c_func
(paren
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dinfo-&gt;mobile
)paren
id|dinfo-&gt;cursor.physical
op_assign
id|dinfo-&gt;gtt_cursor_mem-&gt;physical
suffix:semicolon
r_else
id|dinfo-&gt;cursor.physical
op_assign
id|dinfo-&gt;aperture.physical
op_plus
(paren
id|dinfo-&gt;cursor.offset
op_lshift
l_int|12
)paren
suffix:semicolon
id|dinfo-&gt;cursor
dot
r_virtual
op_assign
id|dinfo-&gt;aperture
dot
r_virtual
op_plus
(paren
id|dinfo-&gt;cursor.offset
op_lshift
l_int|12
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dinfo-&gt;fbmem_gart
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dinfo-&gt;gtt_fb_mem
op_assign
id|agp_allocate_memory
c_func
(paren
id|dinfo-&gt;fb.size
op_rshift
l_int|12
comma
id|AGP_NORMAL_MEMORY
)paren
)paren
)paren
(brace
id|WRN_MSG
c_func
(paren
l_string|&quot;cannot allocate framebuffer memory - use &quot;
l_string|&quot;the stolen one&bslash;n&quot;
)paren
suffix:semicolon
id|dinfo-&gt;fbmem_gart
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|agp_bind_memory
c_func
(paren
id|dinfo-&gt;gtt_fb_mem
comma
id|dinfo-&gt;fb.offset
)paren
)paren
(brace
id|WRN_MSG
c_func
(paren
l_string|&quot;cannot bind framebuffer memory - use &quot;
l_string|&quot;the stolen one&bslash;n&quot;
)paren
suffix:semicolon
id|dinfo-&gt;fbmem_gart
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* update framebuffer memory parameters */
r_if
c_cond
(paren
op_logical_neg
id|dinfo-&gt;fbmem_gart
)paren
id|dinfo-&gt;fb.offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* starts at offset 0 */
id|dinfo-&gt;fb.physical
op_assign
id|dinfo-&gt;aperture.physical
op_plus
(paren
id|dinfo-&gt;fb.offset
op_lshift
l_int|12
)paren
suffix:semicolon
id|dinfo-&gt;fb
dot
r_virtual
op_assign
id|dinfo-&gt;aperture
dot
r_virtual
op_plus
(paren
id|dinfo-&gt;fb.offset
op_lshift
l_int|12
)paren
suffix:semicolon
id|dinfo-&gt;fb_start
op_assign
id|dinfo-&gt;fb.offset
op_lshift
l_int|12
suffix:semicolon
multiline_comment|/* release agpgart */
id|agp_backend_release
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtrr
)paren
id|set_mtrr
c_func
(paren
id|dinfo
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;fb: 0x%x(+ 0x%x)/0x%x (0x%x)&bslash;n&quot;
comma
id|dinfo-&gt;fb.physical
comma
id|dinfo-&gt;fb.offset
comma
id|dinfo-&gt;fb.size
comma
(paren
id|u32
id|__iomem
)paren
id|dinfo-&gt;fb
dot
r_virtual
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;MMIO: 0x%x/0x%x (0x%x)&bslash;n&quot;
comma
id|dinfo-&gt;mmio_base_phys
comma
id|INTEL_REG_SIZE
comma
(paren
id|u32
id|__iomem
)paren
id|dinfo-&gt;mmio_base
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;ring buffer: 0x%x/0x%x (0x%x)&bslash;n&quot;
comma
id|dinfo-&gt;ring.physical
comma
id|dinfo-&gt;ring.size
comma
(paren
id|u32
id|__iomem
)paren
id|dinfo-&gt;ring
dot
r_virtual
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;HW cursor: 0x%x/0x%x (0x%x) (offset 0x%x) (phys 0x%x)&bslash;n&quot;
comma
id|dinfo-&gt;cursor.physical
comma
id|dinfo-&gt;cursor.size
comma
(paren
id|u32
id|__iomem
)paren
id|dinfo-&gt;cursor
dot
r_virtual
comma
id|dinfo-&gt;cursor.offset
comma
id|dinfo-&gt;cursor.physical
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;options: vram = %d, accel = %d, hwcursor = %d, fixed = %d, &quot;
l_string|&quot;noinit = %d&bslash;n&quot;
comma
id|vram
comma
id|accel
comma
id|hwcursor
comma
id|fixed
comma
id|noinit
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;options: mode = &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|mode
ques
c_cond
id|mode
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|probeonly
)paren
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check if the LVDS port or any DVO ports are enabled.  If so,&n;&t; * don&squot;t allow mode switching&n;&t; */
id|dvo
op_assign
id|intelfbhw_check_non_crt
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvo
)paren
(brace
id|dinfo-&gt;fixed_mode
op_assign
l_int|1
suffix:semicolon
id|WRN_MSG
c_func
(paren
l_string|&quot;Non-CRT device is enabled ( &quot;
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|dvo
)paren
(brace
r_if
c_cond
(paren
id|dvo
op_amp
l_int|1
)paren
(brace
id|s
op_assign
id|intelfbhw_dvo_to_string
c_func
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
)paren
id|printk
c_func
(paren
l_string|&quot;%s &quot;
comma
id|s
)paren
suffix:semicolon
)brace
id|dvo
op_rshift_assign
l_int|1
suffix:semicolon
op_increment
id|i
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;).  Disabling mode switching.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bailearly
op_eq
l_int|1
)paren
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FIXED_MODE
c_func
(paren
id|dinfo
)paren
op_logical_and
id|ORIG_VIDEO_ISVGA
op_ne
id|VIDEO_TYPE_VLFB
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Video mode must be programmed at boot time.&bslash;n&quot;
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bailearly
op_eq
l_int|2
)paren
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
multiline_comment|/* Initialise dinfo and related data. */
multiline_comment|/* If an initial mode was programmed at boot time, get its details. */
r_if
c_cond
(paren
id|ORIG_VIDEO_ISVGA
op_eq
id|VIDEO_TYPE_VLFB
)paren
id|get_initial_mode
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bailearly
op_eq
l_int|3
)paren
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FIXED_MODE
c_func
(paren
id|dinfo
)paren
)paren
(brace
multiline_comment|/* remap fb address */
id|update_dinfo
c_func
(paren
id|dinfo
comma
op_amp
id|dinfo-&gt;initial_var
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bailearly
op_eq
l_int|4
)paren
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intelfb_set_fbinfo
c_func
(paren
id|dinfo
)paren
)paren
(brace
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bailearly
op_eq
l_int|5
)paren
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
id|color_table
(braket
id|i
)braket
suffix:semicolon
id|dinfo-&gt;palette
(braket
id|i
)braket
dot
id|red
op_assign
id|default_red
(braket
id|j
)braket
suffix:semicolon
id|dinfo-&gt;palette
(braket
id|i
)braket
dot
id|green
op_assign
id|default_grn
(braket
id|j
)braket
suffix:semicolon
id|dinfo-&gt;palette
(braket
id|i
)braket
dot
id|blue
op_assign
id|default_blu
(braket
id|j
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bailearly
op_eq
l_int|6
)paren
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dinfo
)paren
suffix:semicolon
multiline_comment|/* Save the initial register state. */
id|i
op_assign
id|intelfbhw_read_hw_state
c_func
(paren
id|dinfo
comma
op_amp
id|dinfo-&gt;save_state
comma
id|bailearly
OG
l_int|6
ques
c_cond
id|bailearly
op_minus
l_int|6
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
(brace
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfbhw_read_hw_state returned %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
)brace
id|intelfbhw_print_hw_state
c_func
(paren
id|dinfo
comma
op_amp
id|dinfo-&gt;save_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bailearly
op_eq
l_int|18
)paren
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
multiline_comment|/* Cursor initialisation */
r_if
c_cond
(paren
id|dinfo-&gt;hwcursor
)paren
(brace
id|intelfbhw_cursor_init
c_func
(paren
id|dinfo
)paren
suffix:semicolon
id|intelfbhw_cursor_reset
c_func
(paren
id|dinfo
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bailearly
op_eq
l_int|19
)paren
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
multiline_comment|/* 2d acceleration init */
r_if
c_cond
(paren
id|dinfo-&gt;accel
)paren
id|intelfbhw_2d_start
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bailearly
op_eq
l_int|20
)paren
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|noregister
)paren
id|bailout
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
id|dinfo-&gt;info
)paren
OL
l_int|0
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Cannot register framebuffer.&bslash;n&quot;
)paren
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dinfo-&gt;registered
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_pixmap
suffix:colon
id|fb_dealloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
)paren
suffix:semicolon
id|err_out_cmap
suffix:colon
id|framebuffer_release
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_void
id|__devexit
DECL|function|intelfb_pci_unregister
id|intelfb_pci_unregister
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|intelfb_info
op_star
id|dinfo
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_pci_unregister&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dinfo
)paren
r_return
suffix:semicolon
id|cleanup
c_func
(paren
id|dinfo
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************&n; *                       helper functions                      *&n; ***************************************************************/
r_int
id|__inline__
DECL|function|intelfb_var_to_depth
id|intelfb_var_to_depth
c_func
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_var_to_depth: bpp: %d, green.length is %d&bslash;n&quot;
comma
id|var-&gt;bits_per_pixel
comma
id|var-&gt;green.length
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|16
suffix:colon
r_return
(paren
id|var-&gt;green.length
op_eq
l_int|6
)paren
ques
c_cond
l_int|16
suffix:colon
l_int|15
suffix:semicolon
r_case
l_int|32
suffix:colon
r_return
l_int|24
suffix:semicolon
r_default
suffix:colon
r_return
id|var-&gt;bits_per_pixel
suffix:semicolon
)brace
)brace
r_static
id|__inline__
r_int
DECL|function|var_to_refresh
id|var_to_refresh
c_func
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_int
id|xtot
op_assign
id|var-&gt;xres
op_plus
id|var-&gt;left_margin
op_plus
id|var-&gt;right_margin
op_plus
id|var-&gt;hsync_len
suffix:semicolon
r_int
id|ytot
op_assign
id|var-&gt;yres
op_plus
id|var-&gt;upper_margin
op_plus
id|var-&gt;lower_margin
op_plus
id|var-&gt;vsync_len
suffix:semicolon
r_return
(paren
l_int|1000000000
op_div
id|var-&gt;pixclock
op_star
l_int|1000
op_plus
l_int|500
)paren
op_div
id|xtot
op_div
id|ytot
suffix:semicolon
)brace
multiline_comment|/***************************************************************&n; *                Various intialisation functions              *&n; ***************************************************************/
r_static
r_void
id|__devinit
DECL|function|get_initial_mode
id|get_initial_mode
c_func
(paren
r_struct
id|intelfb_info
op_star
id|dinfo
)paren
(brace
r_struct
id|fb_var_screeninfo
op_star
id|var
suffix:semicolon
r_int
id|xtot
comma
id|ytot
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;get_initial_mode&bslash;n&quot;
)paren
suffix:semicolon
id|dinfo-&gt;initial_vga
op_assign
l_int|1
suffix:semicolon
id|dinfo-&gt;initial_fb_base
op_assign
id|screen_info.lfb_base
suffix:semicolon
id|dinfo-&gt;initial_video_ram
op_assign
id|screen_info.lfb_size
op_star
id|KB
c_func
(paren
l_int|64
)paren
suffix:semicolon
id|dinfo-&gt;initial_pitch
op_assign
id|screen_info.lfb_linelength
suffix:semicolon
id|var
op_assign
op_amp
id|dinfo-&gt;initial_var
suffix:semicolon
id|memset
c_func
(paren
id|var
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|var
)paren
)paren
suffix:semicolon
id|var-&gt;xres
op_assign
id|screen_info.lfb_width
suffix:semicolon
id|var-&gt;yres
op_assign
id|screen_info.lfb_height
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
id|screen_info.lfb_depth
suffix:semicolon
r_switch
c_cond
(paren
id|screen_info.lfb_depth
)paren
(brace
r_case
l_int|15
suffix:colon
id|var-&gt;bits_per_pixel
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|var-&gt;bits_per_pixel
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DBG_MSG
c_func
(paren
l_string|&quot;Initial info: FB is 0x%x/0x%x (%d kByte)&bslash;n&quot;
comma
id|dinfo-&gt;initial_fb_base
comma
id|dinfo-&gt;initial_video_ram
comma
id|BtoKB
c_func
(paren
id|dinfo-&gt;initial_video_ram
)paren
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;Initial info: mode is %dx%d-%d (%d)&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
comma
id|dinfo-&gt;initial_pitch
)paren
suffix:semicolon
multiline_comment|/* Dummy timing values (assume 60Hz) */
id|var-&gt;left_margin
op_assign
(paren
id|var-&gt;xres
op_div
l_int|8
)paren
op_amp
l_int|0xf8
suffix:semicolon
id|var-&gt;right_margin
op_assign
l_int|32
suffix:semicolon
id|var-&gt;upper_margin
op_assign
l_int|16
suffix:semicolon
id|var-&gt;lower_margin
op_assign
l_int|4
suffix:semicolon
id|var-&gt;hsync_len
op_assign
(paren
id|var-&gt;xres
op_div
l_int|8
)paren
op_amp
l_int|0xf8
suffix:semicolon
id|var-&gt;vsync_len
op_assign
l_int|4
suffix:semicolon
id|xtot
op_assign
id|var-&gt;xres
op_plus
id|var-&gt;left_margin
op_plus
id|var-&gt;right_margin
op_plus
id|var-&gt;hsync_len
suffix:semicolon
id|ytot
op_assign
id|var-&gt;yres
op_plus
id|var-&gt;upper_margin
op_plus
id|var-&gt;lower_margin
op_plus
id|var-&gt;vsync_len
suffix:semicolon
id|var-&gt;pixclock
op_assign
l_int|10000000
op_div
id|xtot
op_star
l_int|1000
op_div
id|ytot
op_star
l_int|100
op_div
l_int|60
suffix:semicolon
id|var-&gt;height
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;width
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
OG
l_int|8
)paren
(brace
id|var-&gt;red.offset
op_assign
id|screen_info.red_pos
suffix:semicolon
id|var-&gt;red.length
op_assign
id|screen_info.red_size
suffix:semicolon
id|var-&gt;green.offset
op_assign
id|screen_info.green_pos
suffix:semicolon
id|var-&gt;green.length
op_assign
id|screen_info.green_size
suffix:semicolon
id|var-&gt;blue.offset
op_assign
id|screen_info.blue_pos
suffix:semicolon
id|var-&gt;blue.length
op_assign
id|screen_info.blue_size
suffix:semicolon
id|var-&gt;transp.offset
op_assign
id|screen_info.rsvd_pos
suffix:semicolon
id|var-&gt;transp.length
op_assign
id|screen_info.rsvd_size
suffix:semicolon
)brace
r_else
(brace
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
)brace
)brace
r_static
r_int
id|__devinit
DECL|function|intelfb_init_var
id|intelfb_init_var
c_func
(paren
r_struct
id|intelfb_info
op_star
id|dinfo
)paren
(brace
r_struct
id|fb_var_screeninfo
op_star
id|var
suffix:semicolon
r_int
id|msrc
op_assign
l_int|0
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_init_var&bslash;n&quot;
)paren
suffix:semicolon
id|var
op_assign
op_amp
id|dinfo-&gt;info-&gt;var
suffix:semicolon
r_if
c_cond
(paren
id|FIXED_MODE
c_func
(paren
id|dinfo
)paren
)paren
(brace
id|memcpy
c_func
(paren
id|var
comma
op_amp
id|dinfo-&gt;initial_var
comma
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
)paren
suffix:semicolon
id|msrc
op_assign
l_int|5
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|mode
)paren
(brace
id|msrc
op_assign
id|fb_find_mode
c_func
(paren
id|var
comma
id|dinfo-&gt;info
comma
id|mode
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msrc
)paren
id|msrc
op_or_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|msrc
)paren
(brace
id|msrc
op_assign
id|fb_find_mode
c_func
(paren
id|var
comma
id|dinfo-&gt;info
comma
id|PREFERRED_MODE
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|msrc
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Cannot find a suitable video mode.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|INF_MSG
c_func
(paren
l_string|&quot;Initial video mode is %dx%d-%d@%d.&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
comma
id|var_to_refresh
c_func
(paren
id|var
)paren
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;Initial video mode is from %d.&bslash;n&quot;
comma
id|msrc
)paren
suffix:semicolon
macro_line|#if ALLOCATE_FOR_PANNING
multiline_comment|/* Allow use of half of the video ram for panning */
id|var-&gt;xres_virtual
op_assign
id|var-&gt;xres
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|dinfo-&gt;fb.size
op_div
l_int|2
op_div
(paren
id|var-&gt;bits_per_pixel
op_star
id|var-&gt;xres
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres_virtual
OL
id|var-&gt;yres
)paren
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
suffix:semicolon
macro_line|#else
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dinfo-&gt;accel
)paren
id|var-&gt;accel_flags
op_or_assign
id|FB_ACCELF_TEXT
suffix:semicolon
r_else
id|var-&gt;accel_flags
op_and_assign
op_complement
id|FB_ACCELF_TEXT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__devinit
DECL|function|intelfb_set_fbinfo
id|intelfb_set_fbinfo
c_func
(paren
r_struct
id|intelfb_info
op_star
id|dinfo
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|dinfo-&gt;info
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_set_fbinfo&bslash;n&quot;
)paren
suffix:semicolon
id|info-&gt;flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
id|info-&gt;fbops
op_assign
op_amp
id|intel_fb_ops
suffix:semicolon
id|info-&gt;pseudo_palette
op_assign
id|dinfo-&gt;pseudo_palette
suffix:semicolon
id|info-&gt;pixmap.size
op_assign
l_int|64
op_star
l_int|1024
suffix:semicolon
id|info-&gt;pixmap.buf_align
op_assign
l_int|8
suffix:semicolon
id|info-&gt;pixmap.flags
op_assign
id|FB_PIXMAP_SYSTEM
suffix:semicolon
r_if
c_cond
(paren
id|intelfb_init_var
c_func
(paren
id|dinfo
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|info-&gt;pixmap.scan_align
op_assign
l_int|1
suffix:semicolon
id|update_dinfo
c_func
(paren
id|dinfo
comma
op_amp
id|info-&gt;var
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Update dinfo to match the active video mode. */
r_static
r_void
DECL|function|update_dinfo
id|update_dinfo
c_func
(paren
r_struct
id|intelfb_info
op_star
id|dinfo
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|DBG_MSG
c_func
(paren
l_string|&quot;update_dinfo&bslash;n&quot;
)paren
suffix:semicolon
id|dinfo-&gt;bpp
op_assign
id|var-&gt;bits_per_pixel
suffix:semicolon
id|dinfo-&gt;depth
op_assign
id|intelfb_var_to_depth
c_func
(paren
id|var
)paren
suffix:semicolon
id|dinfo-&gt;xres
op_assign
id|var-&gt;xres
suffix:semicolon
id|dinfo-&gt;yres
op_assign
id|var-&gt;xres
suffix:semicolon
id|dinfo-&gt;pixclock
op_assign
id|var-&gt;pixclock
suffix:semicolon
id|intelfb_get_fix
c_func
(paren
op_amp
id|dinfo-&gt;info-&gt;fix
comma
id|dinfo-&gt;info
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dinfo-&gt;bpp
)paren
(brace
r_case
l_int|8
suffix:colon
id|dinfo-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|dinfo-&gt;pitch
op_assign
id|var-&gt;xres_virtual
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|dinfo-&gt;visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
id|dinfo-&gt;pitch
op_assign
id|var-&gt;xres_virtual
op_star
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|dinfo-&gt;visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
id|dinfo-&gt;pitch
op_assign
id|var-&gt;xres_virtual
op_star
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Make sure the line length is a aligned correctly. */
id|dinfo-&gt;pitch
op_assign
id|ROUND_UP_TO
c_func
(paren
id|dinfo-&gt;pitch
comma
id|STRIDE_ALIGNMENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FIXED_MODE
c_func
(paren
id|dinfo
)paren
)paren
id|dinfo-&gt;pitch
op_assign
id|dinfo-&gt;initial_pitch
suffix:semicolon
id|dinfo-&gt;info-&gt;screen_base
op_assign
(paren
r_char
id|__iomem
op_star
)paren
id|dinfo-&gt;fb
dot
r_virtual
suffix:semicolon
id|dinfo-&gt;info-&gt;fix.line_length
op_assign
id|dinfo-&gt;pitch
suffix:semicolon
id|dinfo-&gt;info-&gt;fix.visual
op_assign
id|dinfo-&gt;visual
suffix:semicolon
)brace
multiline_comment|/* fbops functions */
r_static
r_int
DECL|function|intelfb_get_fix
id|intelfb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|intelfb_info
op_star
id|dinfo
op_assign
id|GET_DINFO
c_func
(paren
id|info
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_get_fix&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|fix
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|fix
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
id|dinfo-&gt;name
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
id|dinfo-&gt;fb.physical
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|dinfo-&gt;fb.size
suffix:semicolon
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;visual
op_assign
id|dinfo-&gt;visual
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|8
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;line_length
op_assign
id|dinfo-&gt;pitch
suffix:semicolon
id|fix-&gt;mmio_start
op_assign
id|dinfo-&gt;mmio_base_phys
suffix:semicolon
id|fix-&gt;mmio_len
op_assign
id|INTEL_REG_SIZE
suffix:semicolon
id|fix-&gt;accel
op_assign
id|FB_ACCEL_I830
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***************************************************************&n; *                       fbdev interface                       *&n; ***************************************************************/
r_static
r_int
DECL|function|intelfb_check_var
id|intelfb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|change_var
op_assign
l_int|0
suffix:semicolon
r_struct
id|fb_var_screeninfo
id|v
suffix:semicolon
r_struct
id|intelfb_info
op_star
id|dinfo
suffix:semicolon
r_static
r_int
id|first
op_assign
l_int|1
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_check_var: accel_flags is %d&bslash;n&quot;
comma
id|var-&gt;accel_flags
)paren
suffix:semicolon
id|dinfo
op_assign
id|GET_DINFO
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intelfbhw_validate_mode
c_func
(paren
id|dinfo
comma
id|var
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|v
op_assign
op_star
id|var
suffix:semicolon
multiline_comment|/* Check for a supported bpp. */
r_if
c_cond
(paren
id|v.bits_per_pixel
op_le
l_int|8
)paren
(brace
id|v.bits_per_pixel
op_assign
l_int|8
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|v.bits_per_pixel
op_le
l_int|16
)paren
(brace
r_if
c_cond
(paren
id|v.bits_per_pixel
op_eq
l_int|16
)paren
id|v.green.length
op_assign
l_int|6
suffix:semicolon
id|v.bits_per_pixel
op_assign
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|v.bits_per_pixel
op_le
l_int|32
)paren
(brace
id|v.bits_per_pixel
op_assign
l_int|32
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
id|change_var
op_assign
(paren
(paren
id|info-&gt;var.xres
op_ne
id|var-&gt;xres
)paren
op_logical_or
(paren
id|info-&gt;var.yres
op_ne
id|var-&gt;yres
)paren
op_logical_or
(paren
id|info-&gt;var.xres_virtual
op_ne
id|var-&gt;xres_virtual
)paren
op_logical_or
(paren
id|info-&gt;var.yres_virtual
op_ne
id|var-&gt;yres_virtual
)paren
op_logical_or
(paren
id|info-&gt;var.bits_per_pixel
op_ne
id|var-&gt;bits_per_pixel
)paren
op_logical_or
id|memcmp
c_func
(paren
op_amp
id|info-&gt;var.red
comma
op_amp
id|var-&gt;red
comma
r_sizeof
(paren
id|var-&gt;red
)paren
)paren
op_logical_or
id|memcmp
c_func
(paren
op_amp
id|info-&gt;var.green
comma
op_amp
id|var-&gt;green
comma
r_sizeof
(paren
id|var-&gt;green
)paren
)paren
op_logical_or
id|memcmp
c_func
(paren
op_amp
id|info-&gt;var.blue
comma
op_amp
id|var-&gt;blue
comma
r_sizeof
(paren
id|var-&gt;blue
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FIXED_MODE
c_func
(paren
id|dinfo
)paren
op_logical_and
(paren
id|change_var
op_logical_or
id|var-&gt;yres_virtual
OG
id|dinfo-&gt;initial_var.yres_virtual
op_logical_or
id|var-&gt;yres_virtual
OL
id|dinfo-&gt;initial_var.yres
op_logical_or
id|var-&gt;xoffset
op_logical_or
id|var-&gt;nonstd
)paren
)paren
(brace
r_if
c_cond
(paren
id|first
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Changing the video mode is not supported.&bslash;n&quot;
)paren
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|intelfb_var_to_depth
c_func
(paren
op_amp
id|v
)paren
)paren
(brace
r_case
l_int|8
suffix:colon
id|v.red.offset
op_assign
id|v.green.offset
op_assign
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
id|v.red.length
op_assign
id|v.green.length
op_assign
id|v.blue.length
op_assign
l_int|8
suffix:semicolon
id|v.transp.offset
op_assign
id|v.transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
id|v.red.offset
op_assign
l_int|10
suffix:semicolon
id|v.green.offset
op_assign
l_int|5
suffix:semicolon
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
id|v.red.length
op_assign
id|v.green.length
op_assign
id|v.blue.length
op_assign
l_int|5
suffix:semicolon
id|v.transp.offset
op_assign
id|v.transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|v.red.offset
op_assign
l_int|11
suffix:semicolon
id|v.green.offset
op_assign
l_int|5
suffix:semicolon
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
id|v.red.length
op_assign
l_int|5
suffix:semicolon
id|v.green.length
op_assign
l_int|6
suffix:semicolon
id|v.blue.length
op_assign
l_int|5
suffix:semicolon
id|v.transp.offset
op_assign
id|v.transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|v.red.offset
op_assign
l_int|16
suffix:semicolon
id|v.green.offset
op_assign
l_int|8
suffix:semicolon
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
id|v.red.length
op_assign
id|v.green.length
op_assign
id|v.blue.length
op_assign
l_int|8
suffix:semicolon
id|v.transp.offset
op_assign
id|v.transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|v.red.offset
op_assign
l_int|16
suffix:semicolon
id|v.green.offset
op_assign
l_int|8
suffix:semicolon
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
id|v.red.length
op_assign
id|v.green.length
op_assign
id|v.blue.length
op_assign
l_int|8
suffix:semicolon
id|v.transp.offset
op_assign
l_int|24
suffix:semicolon
id|v.transp.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.xoffset
OL
l_int|0
)paren
id|v.xoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|v.yoffset
OL
l_int|0
)paren
id|v.yoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|v.xoffset
OG
id|v.xres_virtual
op_minus
id|v.xres
)paren
id|v.xoffset
op_assign
id|v.xres_virtual
op_minus
id|v.xres
suffix:semicolon
r_if
c_cond
(paren
id|v.yoffset
OG
id|v.yres_virtual
op_minus
id|v.yres
)paren
id|v.yoffset
op_assign
id|v.yres_virtual
op_minus
id|v.yres
suffix:semicolon
id|v.red.msb_right
op_assign
id|v.green.msb_right
op_assign
id|v.blue.msb_right
op_assign
id|v.transp.msb_right
op_assign
l_int|0
suffix:semicolon
op_star
id|var
op_assign
id|v
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|intelfb_set_par
id|intelfb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|intelfb_hwstate
id|hw
suffix:semicolon
r_struct
id|intelfb_info
op_star
id|dinfo
op_assign
id|GET_DINFO
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FIXED_MODE
c_func
(paren
id|dinfo
)paren
)paren
(brace
id|ERR_MSG
c_func
(paren
l_string|&quot;Changing the video mode is not supported.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_set_par (%dx%d-%d)&bslash;n&quot;
comma
id|info-&gt;var.xres
comma
id|info-&gt;var.yres
comma
id|info-&gt;var.bits_per_pixel
)paren
suffix:semicolon
id|intelfb_blank
c_func
(paren
id|FB_BLANK_POWERDOWN
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;accel
)paren
id|intelfbhw_2d_stop
c_func
(paren
id|dinfo
)paren
suffix:semicolon
id|hw
op_assign
id|dinfo-&gt;save_state
suffix:semicolon
r_if
c_cond
(paren
id|intelfbhw_mode_to_hw
c_func
(paren
id|dinfo
comma
op_amp
id|hw
comma
op_amp
id|info-&gt;var
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|intelfbhw_program_mode
c_func
(paren
id|dinfo
comma
op_amp
id|hw
comma
l_int|0
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#if REGDUMP &gt; 0
id|intelfbhw_read_hw_state
c_func
(paren
id|dinfo
comma
op_amp
id|hw
comma
l_int|0
)paren
suffix:semicolon
id|intelfbhw_print_hw_state
c_func
(paren
id|dinfo
comma
op_amp
id|hw
)paren
suffix:semicolon
macro_line|#endif
id|update_dinfo
c_func
(paren
id|dinfo
comma
op_amp
id|info-&gt;var
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;accel
)paren
id|intelfbhw_2d_start
c_func
(paren
id|dinfo
)paren
suffix:semicolon
id|intelfb_pan_display
c_func
(paren
op_amp
id|info-&gt;var
comma
id|info
)paren
suffix:semicolon
id|intelfb_blank
c_func
(paren
id|FB_BLANK_UNBLANK
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACCEL
c_func
(paren
id|dinfo
comma
id|info
)paren
)paren
(brace
id|info-&gt;flags
op_assign
id|FBINFO_DEFAULT
op_or
id|FBINFO_HWACCEL_YPAN
op_or
id|FBINFO_HWACCEL_COPYAREA
op_or
id|FBINFO_HWACCEL_FILLRECT
op_or
id|FBINFO_HWACCEL_IMAGEBLIT
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;flags
op_assign
id|FBINFO_DEFAULT
op_or
id|FBINFO_HWACCEL_YPAN
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|intelfb_setcolreg
id|intelfb_setcolreg
c_func
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|intelfb_info
op_star
id|dinfo
op_assign
id|GET_DINFO
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#if VERBOSE &gt; 0
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_setcolreg: regno %d, depth %d&bslash;n&quot;
comma
id|regno
comma
id|dinfo-&gt;depth
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|dinfo-&gt;depth
)paren
(brace
r_case
l_int|8
suffix:colon
(brace
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|dinfo-&gt;palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|dinfo-&gt;palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|dinfo-&gt;palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
id|intelfbhw_setcolreg
c_func
(paren
id|dinfo
comma
id|regno
comma
id|red
comma
id|green
comma
id|blue
comma
id|transp
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
id|dinfo-&gt;pseudo_palette
(braket
id|regno
)braket
op_assign
(paren
(paren
id|red
op_amp
l_int|0xf800
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xf800
)paren
op_rshift
l_int|6
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xf800
)paren
op_rshift
l_int|11
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|dinfo-&gt;pseudo_palette
(braket
id|regno
)braket
op_assign
(paren
id|red
op_amp
l_int|0xf800
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xfc00
)paren
op_rshift
l_int|5
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xf800
)paren
op_rshift
l_int|11
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|dinfo-&gt;pseudo_palette
(braket
id|regno
)braket
op_assign
(paren
(paren
id|red
op_amp
l_int|0xff00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|green
op_amp
l_int|0xff00
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|intelfb_blank
id|intelfb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|intelfbhw_do_blank
c_func
(paren
id|blank
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|intelfb_pan_display
id|intelfb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|intelfbhw_pan_display
c_func
(paren
id|var
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* When/if we have our own ioctls. */
r_static
r_int
DECL|function|intelfb_ioctl
id|intelfb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_void
DECL|function|intelfb_fillrect
id|intelfb_fillrect
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_fillrect
op_star
id|rect
)paren
(brace
r_struct
id|intelfb_info
op_star
id|dinfo
op_assign
id|GET_DINFO
c_func
(paren
id|info
)paren
suffix:semicolon
id|u32
id|rop
comma
id|color
suffix:semicolon
macro_line|#if VERBOSE &gt; 0
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_fillrect&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ACCEL
c_func
(paren
id|dinfo
comma
id|info
)paren
op_logical_or
id|dinfo-&gt;depth
op_eq
l_int|4
)paren
r_return
id|cfb_fillrect
c_func
(paren
id|info
comma
id|rect
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rect-&gt;rop
op_eq
id|ROP_COPY
)paren
id|rop
op_assign
id|PAT_ROP_GXCOPY
suffix:semicolon
r_else
singleline_comment|// ROP_XOR
id|rop
op_assign
id|PAT_ROP_GXXOR
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;depth
op_ne
l_int|8
)paren
id|color
op_assign
id|dinfo-&gt;pseudo_palette
(braket
id|rect-&gt;color
)braket
suffix:semicolon
r_else
id|color
op_assign
id|rect-&gt;color
suffix:semicolon
id|intelfbhw_do_fillrect
c_func
(paren
id|dinfo
comma
id|rect-&gt;dx
comma
id|rect-&gt;dy
comma
id|rect-&gt;width
comma
id|rect-&gt;height
comma
id|color
comma
id|dinfo-&gt;pitch
comma
id|info-&gt;var.bits_per_pixel
comma
id|rop
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|intelfb_copyarea
id|intelfb_copyarea
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_copyarea
op_star
id|region
)paren
(brace
r_struct
id|intelfb_info
op_star
id|dinfo
op_assign
id|GET_DINFO
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#if VERBOSE &gt; 0
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_copyarea&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ACCEL
c_func
(paren
id|dinfo
comma
id|info
)paren
op_logical_or
id|dinfo-&gt;depth
op_eq
l_int|4
)paren
r_return
id|cfb_copyarea
c_func
(paren
id|info
comma
id|region
)paren
suffix:semicolon
id|intelfbhw_do_bitblt
c_func
(paren
id|dinfo
comma
id|region-&gt;sx
comma
id|region-&gt;sy
comma
id|region-&gt;dx
comma
id|region-&gt;dy
comma
id|region-&gt;width
comma
id|region-&gt;height
comma
id|dinfo-&gt;pitch
comma
id|info-&gt;var.bits_per_pixel
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|intelfb_imageblit
id|intelfb_imageblit
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_image
op_star
id|image
)paren
(brace
r_struct
id|intelfb_info
op_star
id|dinfo
op_assign
id|GET_DINFO
c_func
(paren
id|info
)paren
suffix:semicolon
id|u32
id|fgcolor
comma
id|bgcolor
suffix:semicolon
macro_line|#if VERBOSE &gt; 0
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_imageblit&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ACCEL
c_func
(paren
id|dinfo
comma
id|info
)paren
op_logical_or
id|dinfo-&gt;depth
op_eq
l_int|4
op_logical_or
id|image-&gt;depth
op_ne
l_int|1
)paren
r_return
id|cfb_imageblit
c_func
(paren
id|info
comma
id|image
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;depth
op_ne
l_int|8
)paren
(brace
id|fgcolor
op_assign
id|dinfo-&gt;pseudo_palette
(braket
id|image-&gt;fg_color
)braket
suffix:semicolon
id|bgcolor
op_assign
id|dinfo-&gt;pseudo_palette
(braket
id|image-&gt;bg_color
)braket
suffix:semicolon
)brace
r_else
(brace
id|fgcolor
op_assign
id|image-&gt;fg_color
suffix:semicolon
id|bgcolor
op_assign
id|image-&gt;bg_color
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|intelfbhw_do_drawglyph
c_func
(paren
id|dinfo
comma
id|fgcolor
comma
id|bgcolor
comma
id|image-&gt;width
comma
id|image-&gt;height
comma
id|image-&gt;data
comma
id|image-&gt;dx
comma
id|image-&gt;dy
comma
id|dinfo-&gt;pitch
comma
id|info-&gt;var.bits_per_pixel
)paren
)paren
r_return
id|cfb_imageblit
c_func
(paren
id|info
comma
id|image
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|intelfb_cursor
id|intelfb_cursor
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|fb_cursor
op_star
id|cursor
)paren
(brace
r_struct
id|intelfb_info
op_star
id|dinfo
op_assign
id|GET_DINFO
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#if VERBOSE &gt; 0
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_cursor&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|dinfo-&gt;hwcursor
)paren
r_return
id|soft_cursor
c_func
(paren
id|info
comma
id|cursor
)paren
suffix:semicolon
id|intelfbhw_cursor_hide
c_func
(paren
id|dinfo
)paren
suffix:semicolon
multiline_comment|/* If XFree killed the cursor - restore it */
r_if
c_cond
(paren
id|INREG
c_func
(paren
id|CURSOR_A_BASEADDR
)paren
op_ne
id|dinfo-&gt;cursor.offset
op_lshift
l_int|12
)paren
(brace
id|u32
id|fg
comma
id|bg
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;the cursor was killed - restore it !!&bslash;n&quot;
)paren
suffix:semicolon
id|DBG_MSG
c_func
(paren
l_string|&quot;size %d, %d   pos %d, %d&bslash;n&quot;
comma
id|cursor-&gt;image.width
comma
id|cursor-&gt;image.height
comma
id|cursor-&gt;image.dx
comma
id|cursor-&gt;image.dy
)paren
suffix:semicolon
id|intelfbhw_cursor_init
c_func
(paren
id|dinfo
)paren
suffix:semicolon
id|intelfbhw_cursor_reset
c_func
(paren
id|dinfo
)paren
suffix:semicolon
id|intelfbhw_cursor_setpos
c_func
(paren
id|dinfo
comma
id|cursor-&gt;image.dx
comma
id|cursor-&gt;image.dy
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;depth
op_ne
l_int|8
)paren
(brace
id|fg
op_assign
id|dinfo-&gt;pseudo_palette
(braket
id|cursor-&gt;image.fg_color
)braket
suffix:semicolon
id|bg
op_assign
id|dinfo-&gt;pseudo_palette
(braket
id|cursor-&gt;image.bg_color
)braket
suffix:semicolon
)brace
r_else
(brace
id|fg
op_assign
id|cursor-&gt;image.fg_color
suffix:semicolon
id|bg
op_assign
id|cursor-&gt;image.bg_color
suffix:semicolon
)brace
id|intelfbhw_cursor_setcolor
c_func
(paren
id|dinfo
comma
id|bg
comma
id|fg
)paren
suffix:semicolon
id|intelfbhw_cursor_load
c_func
(paren
id|dinfo
comma
id|cursor-&gt;image.width
comma
id|cursor-&gt;image.height
comma
id|dinfo-&gt;cursor_src
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cursor-&gt;enable
)paren
id|intelfbhw_cursor_show
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cursor-&gt;set
op_amp
id|FB_CUR_SETPOS
)paren
(brace
id|u32
id|dx
comma
id|dy
suffix:semicolon
id|dx
op_assign
id|cursor-&gt;image.dx
op_minus
id|info-&gt;var.xoffset
suffix:semicolon
id|dy
op_assign
id|cursor-&gt;image.dy
op_minus
id|info-&gt;var.yoffset
suffix:semicolon
id|intelfbhw_cursor_setpos
c_func
(paren
id|dinfo
comma
id|dx
comma
id|dy
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cursor-&gt;set
op_amp
id|FB_CUR_SETSIZE
)paren
(brace
r_if
c_cond
(paren
id|cursor-&gt;image.width
OG
l_int|64
op_logical_or
id|cursor-&gt;image.height
OG
l_int|64
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|intelfbhw_cursor_reset
c_func
(paren
id|dinfo
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cursor-&gt;set
op_amp
id|FB_CUR_SETCMAP
)paren
(brace
id|u32
id|fg
comma
id|bg
suffix:semicolon
r_if
c_cond
(paren
id|dinfo-&gt;depth
op_ne
l_int|8
)paren
(brace
id|fg
op_assign
id|dinfo-&gt;pseudo_palette
(braket
id|cursor-&gt;image.fg_color
)braket
suffix:semicolon
id|bg
op_assign
id|dinfo-&gt;pseudo_palette
(braket
id|cursor-&gt;image.bg_color
)braket
suffix:semicolon
)brace
r_else
(brace
id|fg
op_assign
id|cursor-&gt;image.fg_color
suffix:semicolon
id|bg
op_assign
id|cursor-&gt;image.bg_color
suffix:semicolon
)brace
id|intelfbhw_cursor_setcolor
c_func
(paren
id|dinfo
comma
id|bg
comma
id|fg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cursor-&gt;set
op_amp
(paren
id|FB_CUR_SETSHAPE
op_or
id|FB_CUR_SETIMAGE
)paren
)paren
(brace
id|u32
id|s_pitch
op_assign
(paren
id|ROUND_UP_TO
c_func
(paren
id|cursor-&gt;image.width
comma
l_int|8
)paren
op_div
l_int|8
)paren
suffix:semicolon
id|u32
id|size
op_assign
id|s_pitch
op_star
id|cursor-&gt;image.height
suffix:semicolon
id|u8
op_star
id|dat
op_assign
(paren
id|u8
op_star
)paren
id|cursor-&gt;image.data
suffix:semicolon
id|u8
op_star
id|msk
op_assign
(paren
id|u8
op_star
)paren
id|cursor-&gt;mask
suffix:semicolon
id|u8
id|src
(braket
l_int|64
)braket
suffix:semicolon
id|u32
id|i
suffix:semicolon
r_if
c_cond
(paren
id|cursor-&gt;image.depth
op_ne
l_int|1
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_switch
c_cond
(paren
id|cursor-&gt;rop
)paren
(brace
r_case
id|ROP_XOR
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
id|src
(braket
id|i
)braket
op_assign
id|dat
(braket
id|i
)braket
op_xor
id|msk
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ROP_COPY
suffix:colon
r_default
suffix:colon
(brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
id|src
(braket
id|i
)braket
op_assign
id|dat
(braket
id|i
)braket
op_amp
id|msk
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* save the bitmap to restore it when XFree will&n;&t;&t;   make the cursor dirty */
id|memcpy
c_func
(paren
id|dinfo-&gt;cursor_src
comma
id|src
comma
id|size
)paren
suffix:semicolon
id|intelfbhw_cursor_load
c_func
(paren
id|dinfo
comma
id|cursor-&gt;image.width
comma
id|cursor-&gt;image.height
comma
id|src
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cursor-&gt;enable
)paren
id|intelfbhw_cursor_show
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|intelfb_sync
id|intelfb_sync
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|intelfb_info
op_star
id|dinfo
op_assign
id|GET_DINFO
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#if VERBOSE &gt; 0
id|DBG_MSG
c_func
(paren
l_string|&quot;intelfb_sync&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dinfo-&gt;ring_lockup
)paren
r_return
l_int|0
suffix:semicolon
id|intelfbhw_do_sync
c_func
(paren
id|dinfo
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
