multiline_comment|/*&n; *  ATI Mach64 GX Support&n; */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &quot;mach64.h&quot;
macro_line|#include &quot;atyfb.h&quot;
multiline_comment|/* Definitions for the ICS 2595 == ATI 18818_1 Clockchip */
DECL|macro|REF_FREQ_2595
mdefine_line|#define REF_FREQ_2595       1432  /*  14.33 MHz  (exact   14.31818) */
DECL|macro|REF_DIV_2595
mdefine_line|#define REF_DIV_2595          46  /* really 43 on ICS 2595 !!!  */
multiline_comment|/* ohne Prescaler */
DECL|macro|MAX_FREQ_2595
mdefine_line|#define MAX_FREQ_2595      15938  /* 159.38 MHz  (really 170.486) */
DECL|macro|MIN_FREQ_2595
mdefine_line|#define MIN_FREQ_2595       8000  /*  80.00 MHz  (        85.565) */
multiline_comment|/* mit Prescaler 2, 4, 8 */
DECL|macro|ABS_MIN_FREQ_2595
mdefine_line|#define ABS_MIN_FREQ_2595   1000  /*  10.00 MHz  (really  10.697) */
DECL|macro|N_ADJ_2595
mdefine_line|#define N_ADJ_2595           257
DECL|macro|STOP_BITS_2595
mdefine_line|#define STOP_BITS_2595     0x1800
DECL|macro|MIN_N_408
mdefine_line|#define MIN_N_408&t;&t;2
DECL|macro|MIN_N_1703
mdefine_line|#define MIN_N_1703&t;&t;6
DECL|macro|MIN_M
mdefine_line|#define MIN_M&t;&t;2
DECL|macro|MAX_M
mdefine_line|#define MAX_M&t;&t;30
DECL|macro|MIN_N
mdefine_line|#define MIN_N&t;&t;35
DECL|macro|MAX_N
mdefine_line|#define MAX_N&t;&t;255-8
multiline_comment|/*&n;     *  Support Functions&n;     */
DECL|function|aty_dac_waste4
r_static
r_void
id|aty_dac_waste4
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
)paren
(brace
(paren
r_void
)paren
id|aty_ld_8
c_func
(paren
id|DAC_REGS
comma
id|info
)paren
suffix:semicolon
(paren
r_void
)paren
id|aty_ld_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|info
)paren
suffix:semicolon
(paren
r_void
)paren
id|aty_ld_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|info
)paren
suffix:semicolon
(paren
r_void
)paren
id|aty_ld_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|info
)paren
suffix:semicolon
(paren
r_void
)paren
id|aty_ld_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|aty_StrobeClock
r_static
r_void
id|aty_StrobeClock
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
)paren
(brace
id|u8
id|tmp
suffix:semicolon
id|udelay
c_func
(paren
l_int|26
)paren
suffix:semicolon
id|tmp
op_assign
id|aty_ld_8
c_func
(paren
id|CLOCK_CNTL
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
op_plus
id|info-&gt;clk_wr_offset
comma
id|tmp
op_or
id|CLOCK_STROBE
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;     *  IBM RGB514 DAC and Clock Chip&n;     */
DECL|function|aty_st_514
r_static
r_void
id|aty_st_514
c_func
(paren
r_int
id|offset
comma
id|u8
id|val
comma
r_const
r_struct
id|fb_info_aty
op_star
id|info
)paren
(brace
id|aty_st_8
c_func
(paren
id|DAC_CNTL
comma
l_int|1
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* right addr byte */
id|aty_st_8
c_func
(paren
id|DAC_W_INDEX
comma
id|offset
op_amp
l_int|0xff
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* left addr byte */
id|aty_st_8
c_func
(paren
id|DAC_DATA
comma
(paren
id|offset
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_MASK
comma
id|val
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_CNTL
comma
l_int|0
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|aty_set_dac_514
r_static
r_int
id|aty_set_dac_514
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
comma
id|u32
id|bpp
comma
id|u32
id|accel
)paren
(brace
r_static
r_struct
(brace
id|u8
id|pixel_dly
suffix:semicolon
id|u8
id|misc2_cntl
suffix:semicolon
id|u8
id|pixel_rep
suffix:semicolon
id|u8
id|pixel_cntl_index
suffix:semicolon
id|u8
id|pixel_cntl_v1
suffix:semicolon
)brace
id|tab
(braket
l_int|3
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0x41
comma
l_int|0x03
comma
l_int|0x71
comma
l_int|0x45
)brace
comma
multiline_comment|/* 8 bpp */
(brace
l_int|0
comma
l_int|0x45
comma
l_int|0x04
comma
l_int|0x0c
comma
l_int|0x01
)brace
comma
multiline_comment|/* 555 */
(brace
l_int|0
comma
l_int|0x45
comma
l_int|0x06
comma
l_int|0x0e
comma
l_int|0x00
)brace
comma
multiline_comment|/* XRGB */
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|bpp
)paren
(brace
r_case
l_int|8
suffix:colon
r_default
suffix:colon
id|i
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|i
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|i
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
)brace
id|aty_st_514
c_func
(paren
l_int|0x90
comma
l_int|0x00
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* VRAM Mask Low */
id|aty_st_514
c_func
(paren
l_int|0x04
comma
id|tab
(braket
id|i
)braket
dot
id|pixel_dly
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Horizontal Sync Control */
id|aty_st_514
c_func
(paren
l_int|0x05
comma
l_int|0x00
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Power Management */
id|aty_st_514
c_func
(paren
l_int|0x02
comma
l_int|0x01
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Misc Clock Control */
id|aty_st_514
c_func
(paren
l_int|0x71
comma
id|tab
(braket
id|i
)braket
dot
id|misc2_cntl
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Misc Control 2 */
id|aty_st_514
c_func
(paren
l_int|0x0a
comma
id|tab
(braket
id|i
)braket
dot
id|pixel_rep
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Pixel Format */
id|aty_st_514
c_func
(paren
id|tab
(braket
id|i
)braket
dot
id|pixel_cntl_index
comma
id|tab
(braket
id|i
)braket
dot
id|pixel_cntl_v1
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Misc Control 2 / 16 BPP Control / 32 BPP Control */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aty_var_to_pll_514
r_static
r_int
id|aty_var_to_pll_514
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
id|u32
id|vclk_per
comma
id|u8
id|bpp
comma
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
multiline_comment|/*&n;     *  FIXME: use real calculations instead of using fixed values from the old&n;     *&t;       driver&n;     */
r_static
r_struct
(brace
id|u32
id|limit
suffix:semicolon
multiline_comment|/* pixlock rounding limit (arbitrary) */
id|u8
id|m
suffix:semicolon
multiline_comment|/* (df&lt;&lt;6) | vco_div_count */
id|u8
id|n
suffix:semicolon
multiline_comment|/* ref_div_count */
)brace
id|RGB514_clocks
(braket
l_int|7
)braket
op_assign
(brace
(brace
l_int|8000
comma
(paren
l_int|3
op_lshift
l_int|6
)paren
op_or
l_int|20
comma
l_int|9
)brace
comma
multiline_comment|/*  7395 ps / 135.2273 MHz */
(brace
l_int|10000
comma
(paren
l_int|1
op_lshift
l_int|6
)paren
op_or
l_int|19
comma
l_int|3
)brace
comma
multiline_comment|/*  9977 ps / 100.2273 MHz */
(brace
l_int|13000
comma
(paren
l_int|1
op_lshift
l_int|6
)paren
op_or
l_int|2
comma
l_int|3
)brace
comma
multiline_comment|/* 12509 ps /  79.9432 MHz */
(brace
l_int|14000
comma
(paren
l_int|2
op_lshift
l_int|6
)paren
op_or
l_int|8
comma
l_int|7
)brace
comma
multiline_comment|/* 13394 ps /  74.6591 MHz */
(brace
l_int|16000
comma
(paren
l_int|1
op_lshift
l_int|6
)paren
op_or
l_int|44
comma
l_int|6
)brace
comma
multiline_comment|/* 15378 ps /  65.0284 MHz */
(brace
l_int|25000
comma
(paren
l_int|1
op_lshift
l_int|6
)paren
op_or
l_int|15
comma
l_int|5
)brace
comma
multiline_comment|/* 17460 ps /  57.2727 MHz */
(brace
l_int|50000
comma
(paren
l_int|0
op_lshift
l_int|6
)paren
op_or
l_int|53
comma
l_int|7
)brace
comma
multiline_comment|/* 33145 ps /  30.1705 MHz */
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|RGB514_clocks
)paren
op_div
r_sizeof
(paren
op_star
id|RGB514_clocks
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|vclk_per
op_le
id|RGB514_clocks
(braket
id|i
)braket
dot
id|limit
)paren
(brace
id|pll-&gt;ibm514.m
op_assign
id|RGB514_clocks
(braket
id|i
)braket
dot
id|m
suffix:semicolon
id|pll-&gt;ibm514.n
op_assign
id|RGB514_clocks
(braket
id|i
)braket
dot
id|n
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|aty_pll_514_to_var
r_static
id|u32
id|aty_pll_514_to_var
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
id|u8
id|df
comma
id|vco_div_count
comma
id|ref_div_count
suffix:semicolon
id|df
op_assign
id|pll-&gt;ibm514.m
op_rshift
l_int|6
suffix:semicolon
id|vco_div_count
op_assign
id|pll-&gt;ibm514.m
op_amp
l_int|0x3f
suffix:semicolon
id|ref_div_count
op_assign
id|pll-&gt;ibm514.n
suffix:semicolon
r_return
(paren
(paren
id|info-&gt;ref_clk_per
op_star
id|ref_div_count
)paren
op_lshift
(paren
l_int|3
op_minus
id|df
)paren
)paren
op_div
(paren
id|vco_div_count
op_plus
l_int|65
)paren
suffix:semicolon
)brace
DECL|function|aty_set_pll_514
r_static
r_void
id|aty_set_pll_514
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
id|aty_st_514
c_func
(paren
l_int|0x06
comma
l_int|0x02
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* DAC Operation */
id|aty_st_514
c_func
(paren
l_int|0x10
comma
l_int|0x01
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* PLL Control 1 */
id|aty_st_514
c_func
(paren
l_int|0x70
comma
l_int|0x01
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Misc Control 1 */
id|aty_st_514
c_func
(paren
l_int|0x8f
comma
l_int|0x1f
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* PLL Ref. Divider Input */
id|aty_st_514
c_func
(paren
l_int|0x03
comma
l_int|0x00
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Sync Control */
id|aty_st_514
c_func
(paren
l_int|0x05
comma
l_int|0x00
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Power Management */
id|aty_st_514
c_func
(paren
l_int|0x20
comma
id|pll-&gt;ibm514.m
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* F0 / M0 */
id|aty_st_514
c_func
(paren
l_int|0x21
comma
id|pll-&gt;ibm514.n
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* F1 / N0 */
)brace
DECL|variable|aty_dac_ibm514
r_const
r_struct
id|aty_dac_ops
id|aty_dac_ibm514
op_assign
(brace
id|set_dac
suffix:colon
id|aty_set_dac_514
comma
)brace
suffix:semicolon
DECL|variable|aty_pll_ibm514
r_const
r_struct
id|aty_pll_ops
id|aty_pll_ibm514
op_assign
(brace
id|var_to_pll
suffix:colon
id|aty_var_to_pll_514
comma
id|pll_to_var
suffix:colon
id|aty_pll_514_to_var
comma
id|set_pll
suffix:colon
id|aty_set_pll_514
comma
)brace
suffix:semicolon
multiline_comment|/*&n;     *  ATI 68860-B DAC&n;     */
DECL|function|aty_set_dac_ATI68860_B
r_static
r_int
id|aty_set_dac_ATI68860_B
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
comma
id|u32
id|bpp
comma
id|u32
id|accel
)paren
(brace
id|u32
id|gModeReg
comma
id|devSetupRegA
comma
id|temp
comma
id|mask
suffix:semicolon
id|gModeReg
op_assign
l_int|0
suffix:semicolon
id|devSetupRegA
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|bpp
)paren
(brace
r_case
l_int|8
suffix:colon
id|gModeReg
op_assign
l_int|0x83
suffix:semicolon
id|devSetupRegA
op_assign
l_int|0x60
op_or
l_int|0x00
multiline_comment|/*(info-&gt;mach64DAC8Bit ? 0x00 : 0x01) */
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
id|gModeReg
op_assign
l_int|0xA0
suffix:semicolon
id|devSetupRegA
op_assign
l_int|0x60
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|gModeReg
op_assign
l_int|0xA1
suffix:semicolon
id|devSetupRegA
op_assign
l_int|0x60
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|gModeReg
op_assign
l_int|0xC0
suffix:semicolon
id|devSetupRegA
op_assign
l_int|0x60
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|gModeReg
op_assign
l_int|0xE3
suffix:semicolon
id|devSetupRegA
op_assign
l_int|0x60
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|accel
)paren
(brace
id|gModeReg
op_assign
l_int|0x80
suffix:semicolon
id|devSetupRegA
op_assign
l_int|0x61
suffix:semicolon
)brace
id|temp
op_assign
id|aty_ld_8
c_func
(paren
id|DAC_CNTL
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_CNTL
comma
(paren
id|temp
op_amp
op_complement
id|DAC_EXT_SEL_RS2
)paren
op_or
id|DAC_EXT_SEL_RS3
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
l_int|0x1D
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|3
comma
id|gModeReg
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
comma
l_int|0x02
comma
id|info
)paren
suffix:semicolon
id|temp
op_assign
id|aty_ld_8
c_func
(paren
id|DAC_CNTL
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_CNTL
comma
id|temp
op_or
id|DAC_EXT_SEL_RS2
op_or
id|DAC_EXT_SEL_RS3
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;total_vram
OL
id|MEM_SIZE_1M
)paren
id|mask
op_assign
l_int|0x04
suffix:semicolon
r_else
r_if
c_cond
(paren
id|info-&gt;total_vram
op_eq
id|MEM_SIZE_1M
)paren
id|mask
op_assign
l_int|0x08
suffix:semicolon
r_else
id|mask
op_assign
l_int|0x0C
suffix:semicolon
multiline_comment|/* The following assumes that the BIOS has correctly set R7 of the&n;     * Device Setup Register A at boot time.&n;     */
DECL|macro|A860_DELAY_L
mdefine_line|#define A860_DELAY_L&t;0x80
id|temp
op_assign
id|aty_ld_8
c_func
(paren
id|DAC_REGS
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
comma
(paren
id|devSetupRegA
op_or
id|mask
)paren
op_or
(paren
id|temp
op_amp
id|A860_DELAY_L
)paren
comma
id|info
)paren
suffix:semicolon
id|temp
op_assign
id|aty_ld_8
c_func
(paren
id|DAC_CNTL
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_CNTL
comma
(paren
id|temp
op_amp
op_complement
(paren
id|DAC_EXT_SEL_RS2
op_or
id|DAC_EXT_SEL_RS3
)paren
)paren
comma
id|info
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|BUS_CNTL
comma
l_int|0x890e20f1
comma
id|info
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DAC_CNTL
comma
l_int|0x47052100
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|aty_dac_ati68860b
r_const
r_struct
id|aty_dac_ops
id|aty_dac_ati68860b
op_assign
(brace
id|set_dac
suffix:colon
id|aty_set_dac_ATI68860_B
comma
)brace
suffix:semicolon
multiline_comment|/*&n;     *  AT&amp;T 21C498 DAC&n;     */
DECL|function|aty_set_dac_ATT21C498
r_static
r_int
id|aty_set_dac_ATT21C498
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
comma
id|u32
id|bpp
comma
id|u32
id|accel
)paren
(brace
id|u32
id|dotClock
suffix:semicolon
r_int
id|muxmode
op_assign
l_int|0
suffix:semicolon
r_int
id|DACMask
op_assign
l_int|0
suffix:semicolon
id|dotClock
op_assign
l_int|100000000
op_div
id|pll-&gt;ics2595.period_in_ps
suffix:semicolon
r_switch
c_cond
(paren
id|bpp
)paren
(brace
r_case
l_int|8
suffix:colon
r_if
c_cond
(paren
id|dotClock
OG
l_int|8000
)paren
(brace
id|DACMask
op_assign
l_int|0x24
suffix:semicolon
id|muxmode
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|DACMask
op_assign
l_int|0x04
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
id|DACMask
op_assign
l_int|0x16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|DACMask
op_assign
l_int|0x36
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|DACMask
op_assign
l_int|0xE6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|DACMask
op_assign
l_int|0xE6
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|1
multiline_comment|/* info-&gt;mach64DAC8Bit */
)paren
id|DACMask
op_or_assign
l_int|0x02
suffix:semicolon
id|aty_dac_waste4
c_func
(paren
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|DACMask
comma
id|info
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|BUS_CNTL
comma
l_int|0x890e20f1
comma
id|info
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DAC_CNTL
comma
l_int|0x00072000
comma
id|info
)paren
suffix:semicolon
r_return
id|muxmode
suffix:semicolon
)brace
DECL|variable|aty_dac_att21c498
r_const
r_struct
id|aty_dac_ops
id|aty_dac_att21c498
op_assign
(brace
id|set_dac
suffix:colon
id|aty_set_dac_ATT21C498
comma
)brace
suffix:semicolon
multiline_comment|/*&n;     *  ATI 18818 / ICS 2595 Clock Chip&n;     */
DECL|function|aty_var_to_pll_18818
r_static
r_int
id|aty_var_to_pll_18818
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
id|u32
id|vclk_per
comma
id|u8
id|bpp
comma
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
id|u32
id|MHz100
suffix:semicolon
multiline_comment|/* in 0.01 MHz */
id|u32
id|program_bits
suffix:semicolon
id|u32
id|post_divider
suffix:semicolon
multiline_comment|/* Calculate the programming word */
id|MHz100
op_assign
l_int|100000000
op_div
id|vclk_per
suffix:semicolon
id|program_bits
op_assign
op_minus
l_int|1
suffix:semicolon
id|post_divider
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|MHz100
OG
id|MAX_FREQ_2595
)paren
(brace
id|MHz100
op_assign
id|MAX_FREQ_2595
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|MHz100
OL
id|ABS_MIN_FREQ_2595
)paren
(brace
id|program_bits
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* MHz100 = 257 */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|MHz100
OL
id|MIN_FREQ_2595
)paren
(brace
id|MHz100
op_mul_assign
l_int|2
suffix:semicolon
id|post_divider
op_mul_assign
l_int|2
suffix:semicolon
)brace
)brace
id|MHz100
op_mul_assign
l_int|1000
suffix:semicolon
id|MHz100
op_assign
(paren
id|REF_DIV_2595
op_star
id|MHz100
)paren
op_div
id|REF_FREQ_2595
suffix:semicolon
id|MHz100
op_add_assign
l_int|500
suffix:semicolon
multiline_comment|/* + 0.5 round */
id|MHz100
op_div_assign
l_int|1000
suffix:semicolon
r_if
c_cond
(paren
id|program_bits
op_eq
op_minus
l_int|1
)paren
(brace
id|program_bits
op_assign
id|MHz100
op_minus
id|N_ADJ_2595
suffix:semicolon
r_switch
c_cond
(paren
id|post_divider
)paren
(brace
r_case
l_int|1
suffix:colon
id|program_bits
op_or_assign
l_int|0x0600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|program_bits
op_or_assign
l_int|0x0400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|program_bits
op_or_assign
l_int|0x0200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
id|program_bits
op_or_assign
id|STOP_BITS_2595
suffix:semicolon
id|pll-&gt;ics2595.program_bits
op_assign
id|program_bits
suffix:semicolon
id|pll-&gt;ics2595.locationAddr
op_assign
l_int|0
suffix:semicolon
id|pll-&gt;ics2595.post_divider
op_assign
id|post_divider
suffix:semicolon
id|pll-&gt;ics2595.period_in_ps
op_assign
id|vclk_per
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aty_pll_18818_to_var
r_static
id|u32
id|aty_pll_18818_to_var
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
r_return
id|pll-&gt;ics2595.period_in_ps
suffix:semicolon
multiline_comment|/* default for now */
)brace
DECL|function|aty_ICS2595_put1bit
r_static
r_void
id|aty_ICS2595_put1bit
c_func
(paren
id|u8
id|data
comma
r_const
r_struct
id|fb_info_aty
op_star
id|info
)paren
(brace
id|u8
id|tmp
suffix:semicolon
id|data
op_and_assign
l_int|0x01
suffix:semicolon
id|tmp
op_assign
id|aty_ld_8
c_func
(paren
id|CLOCK_CNTL
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
op_plus
id|info-&gt;clk_wr_offset
comma
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
op_or
(paren
id|data
op_lshift
l_int|2
)paren
comma
id|info
)paren
suffix:semicolon
id|tmp
op_assign
id|aty_ld_8
c_func
(paren
id|CLOCK_CNTL
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
op_plus
id|info-&gt;clk_wr_offset
comma
(paren
id|tmp
op_amp
op_complement
l_int|0x08
)paren
op_or
(paren
l_int|0
op_lshift
l_int|3
)paren
comma
id|info
)paren
suffix:semicolon
id|aty_StrobeClock
c_func
(paren
id|info
)paren
suffix:semicolon
id|tmp
op_assign
id|aty_ld_8
c_func
(paren
id|CLOCK_CNTL
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
op_plus
id|info-&gt;clk_wr_offset
comma
(paren
id|tmp
op_amp
op_complement
l_int|0x08
)paren
op_or
(paren
l_int|1
op_lshift
l_int|3
)paren
comma
id|info
)paren
suffix:semicolon
id|aty_StrobeClock
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|aty_set_pll18818
r_static
r_void
id|aty_set_pll18818
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
id|u32
id|program_bits
suffix:semicolon
id|u32
id|locationAddr
suffix:semicolon
id|u32
id|i
suffix:semicolon
id|u8
id|old_clock_cntl
suffix:semicolon
id|u8
id|old_crtc_ext_disp
suffix:semicolon
id|old_clock_cntl
op_assign
id|aty_ld_8
c_func
(paren
id|CLOCK_CNTL
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
op_plus
id|info-&gt;clk_wr_offset
comma
l_int|0
comma
id|info
)paren
suffix:semicolon
id|old_crtc_ext_disp
op_assign
id|aty_ld_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|old_crtc_ext_disp
op_or
(paren
id|CRTC_EXT_DISP_EN
op_rshift
l_int|24
)paren
comma
id|info
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
multiline_comment|/* delay for 50 (15) ms */
id|program_bits
op_assign
id|pll-&gt;ics2595.program_bits
suffix:semicolon
id|locationAddr
op_assign
id|pll-&gt;ics2595.locationAddr
suffix:semicolon
multiline_comment|/* Program the clock chip */
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
op_plus
id|info-&gt;clk_wr_offset
comma
l_int|0
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Strobe = 0 */
id|aty_StrobeClock
c_func
(paren
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
op_plus
id|info-&gt;clk_wr_offset
comma
l_int|1
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Strobe = 0 */
id|aty_StrobeClock
c_func
(paren
id|info
)paren
suffix:semicolon
id|aty_ICS2595_put1bit
c_func
(paren
l_int|1
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Send start bits */
id|aty_ICS2595_put1bit
c_func
(paren
l_int|0
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Start bit */
id|aty_ICS2595_put1bit
c_func
(paren
l_int|0
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Read / ~Write */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Location 0..4 */
id|aty_ICS2595_put1bit
c_func
(paren
id|locationAddr
op_amp
l_int|1
comma
id|info
)paren
suffix:semicolon
id|locationAddr
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
op_plus
l_int|1
op_plus
l_int|2
op_plus
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|aty_ICS2595_put1bit
c_func
(paren
id|program_bits
op_amp
l_int|1
comma
id|info
)paren
suffix:semicolon
id|program_bits
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* delay for 1 ms */
(paren
r_void
)paren
id|aty_ld_8
c_func
(paren
id|DAC_REGS
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Clear DAC Counter */
id|aty_st_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|old_crtc_ext_disp
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
op_plus
id|info-&gt;clk_wr_offset
comma
id|old_clock_cntl
op_or
id|CLOCK_STROBE
comma
id|info
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* delay for 50 (15) ms */
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
op_plus
id|info-&gt;clk_wr_offset
comma
(paren
(paren
id|pll-&gt;ics2595.locationAddr
op_amp
l_int|0x0F
)paren
op_or
id|CLOCK_STROBE
)paren
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|aty_pll_ati18818_1
r_const
r_struct
id|aty_pll_ops
id|aty_pll_ati18818_1
op_assign
(brace
id|var_to_pll
suffix:colon
id|aty_var_to_pll_18818
comma
id|pll_to_var
suffix:colon
id|aty_pll_18818_to_var
comma
id|set_pll
suffix:colon
id|aty_set_pll18818
comma
)brace
suffix:semicolon
multiline_comment|/*&n;     *  STG 1703 Clock Chip&n;     */
DECL|function|aty_var_to_pll_1703
r_static
r_int
id|aty_var_to_pll_1703
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
id|u32
id|vclk_per
comma
id|u8
id|bpp
comma
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
id|u32
id|mhz100
suffix:semicolon
multiline_comment|/* in 0.01 MHz */
id|u32
id|program_bits
suffix:semicolon
multiline_comment|/* u32 post_divider; */
id|u32
id|mach64MinFreq
comma
id|mach64MaxFreq
comma
id|mach64RefFreq
suffix:semicolon
id|u32
id|temp
comma
id|tempB
suffix:semicolon
id|u16
id|remainder
comma
id|preRemainder
suffix:semicolon
r_int
id|divider
op_assign
l_int|0
comma
id|tempA
suffix:semicolon
multiline_comment|/* Calculate the programming word */
id|mhz100
op_assign
l_int|100000000
op_div
id|vclk_per
suffix:semicolon
id|mach64MinFreq
op_assign
id|MIN_FREQ_2595
suffix:semicolon
id|mach64MaxFreq
op_assign
id|MAX_FREQ_2595
suffix:semicolon
id|mach64RefFreq
op_assign
id|REF_FREQ_2595
suffix:semicolon
multiline_comment|/* 14.32 MHz */
multiline_comment|/* Calculate program word */
r_if
c_cond
(paren
id|mhz100
op_eq
l_int|0
)paren
id|program_bits
op_assign
l_int|0xE0
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|mhz100
OL
id|mach64MinFreq
)paren
id|mhz100
op_assign
id|mach64MinFreq
suffix:semicolon
r_if
c_cond
(paren
id|mhz100
OG
id|mach64MaxFreq
)paren
id|mhz100
op_assign
id|mach64MaxFreq
suffix:semicolon
id|divider
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|mhz100
OL
(paren
id|mach64MinFreq
op_lshift
l_int|3
)paren
)paren
(brace
id|mhz100
op_lshift_assign
l_int|1
suffix:semicolon
id|divider
op_add_assign
l_int|0x20
suffix:semicolon
)brace
id|temp
op_assign
(paren
r_int
r_int
)paren
(paren
id|mhz100
)paren
suffix:semicolon
id|temp
op_assign
(paren
r_int
r_int
)paren
(paren
id|temp
op_star
(paren
id|MIN_N_1703
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|temp
op_sub_assign
(paren
r_int
)paren
(paren
id|mach64RefFreq
op_lshift
l_int|1
)paren
suffix:semicolon
id|tempA
op_assign
id|MIN_N_1703
suffix:semicolon
id|preRemainder
op_assign
l_int|0xffff
suffix:semicolon
r_do
(brace
id|tempB
op_assign
id|temp
suffix:semicolon
id|remainder
op_assign
id|tempB
op_mod
id|mach64RefFreq
suffix:semicolon
id|tempB
op_assign
id|tempB
op_div
id|mach64RefFreq
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tempB
op_amp
l_int|0xffff
)paren
op_le
l_int|127
op_logical_and
(paren
id|remainder
op_le
id|preRemainder
)paren
)paren
(brace
id|preRemainder
op_assign
id|remainder
suffix:semicolon
id|divider
op_and_assign
op_complement
l_int|0x1f
suffix:semicolon
id|divider
op_or_assign
id|tempA
suffix:semicolon
id|divider
op_assign
(paren
id|divider
op_amp
l_int|0x00ff
)paren
op_plus
(paren
(paren
id|tempB
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|temp
op_add_assign
id|mhz100
suffix:semicolon
id|tempA
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|tempA
op_le
(paren
id|MIN_N_1703
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|program_bits
op_assign
id|divider
suffix:semicolon
)brace
id|pll-&gt;ics2595.program_bits
op_assign
id|program_bits
suffix:semicolon
id|pll-&gt;ics2595.locationAddr
op_assign
l_int|0
suffix:semicolon
id|pll-&gt;ics2595.post_divider
op_assign
id|divider
suffix:semicolon
multiline_comment|/* fuer nix */
id|pll-&gt;ics2595.period_in_ps
op_assign
id|vclk_per
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aty_pll_1703_to_var
r_static
id|u32
id|aty_pll_1703_to_var
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
r_return
id|pll-&gt;ics2595.period_in_ps
suffix:semicolon
multiline_comment|/* default for now */
)brace
DECL|function|aty_set_pll_1703
r_static
r_void
id|aty_set_pll_1703
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
id|u32
id|program_bits
suffix:semicolon
id|u32
id|locationAddr
suffix:semicolon
r_char
id|old_crtc_ext_disp
suffix:semicolon
id|old_crtc_ext_disp
op_assign
id|aty_ld_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|old_crtc_ext_disp
op_or
(paren
id|CRTC_EXT_DISP_EN
op_rshift
l_int|24
)paren
comma
id|info
)paren
suffix:semicolon
id|program_bits
op_assign
id|pll-&gt;ics2595.program_bits
suffix:semicolon
id|locationAddr
op_assign
id|pll-&gt;ics2595.locationAddr
suffix:semicolon
multiline_comment|/* Program clock */
id|aty_dac_waste4
c_func
(paren
id|info
)paren
suffix:semicolon
(paren
r_void
)paren
id|aty_ld_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
(paren
id|locationAddr
op_lshift
l_int|1
)paren
op_plus
l_int|0x20
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
l_int|0
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
(paren
id|program_bits
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
(paren
id|program_bits
op_amp
l_int|0xFF
)paren
comma
id|info
)paren
suffix:semicolon
(paren
r_void
)paren
id|aty_ld_8
c_func
(paren
id|DAC_REGS
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Clear DAC Counter */
id|aty_st_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|old_crtc_ext_disp
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|aty_pll_stg1703
r_const
r_struct
id|aty_pll_ops
id|aty_pll_stg1703
op_assign
(brace
id|var_to_pll
suffix:colon
id|aty_var_to_pll_1703
comma
id|pll_to_var
suffix:colon
id|aty_pll_1703_to_var
comma
id|set_pll
suffix:colon
id|aty_set_pll_1703
comma
)brace
suffix:semicolon
multiline_comment|/*&n;     *  Chrontel 8398 Clock Chip&n;     */
DECL|function|aty_var_to_pll_8398
r_static
r_int
id|aty_var_to_pll_8398
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
id|u32
id|vclk_per
comma
id|u8
id|bpp
comma
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
id|u32
id|tempA
comma
id|tempB
comma
id|fOut
comma
id|longMHz100
comma
id|diff
comma
id|preDiff
suffix:semicolon
id|u32
id|mhz100
suffix:semicolon
multiline_comment|/* in 0.01 MHz */
id|u32
id|program_bits
suffix:semicolon
multiline_comment|/* u32 post_divider; */
id|u32
id|mach64MinFreq
comma
id|mach64MaxFreq
comma
id|mach64RefFreq
suffix:semicolon
id|u16
id|m
comma
id|n
comma
id|k
op_assign
l_int|0
comma
id|save_m
comma
id|save_n
comma
id|twoToKth
suffix:semicolon
multiline_comment|/* Calculate the programming word */
id|mhz100
op_assign
l_int|100000000
op_div
id|vclk_per
suffix:semicolon
id|mach64MinFreq
op_assign
id|MIN_FREQ_2595
suffix:semicolon
id|mach64MaxFreq
op_assign
id|MAX_FREQ_2595
suffix:semicolon
id|mach64RefFreq
op_assign
id|REF_FREQ_2595
suffix:semicolon
multiline_comment|/* 14.32 MHz */
id|save_m
op_assign
l_int|0
suffix:semicolon
id|save_n
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Calculate program word */
r_if
c_cond
(paren
id|mhz100
op_eq
l_int|0
)paren
id|program_bits
op_assign
l_int|0xE0
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|mhz100
OL
id|mach64MinFreq
)paren
id|mhz100
op_assign
id|mach64MinFreq
suffix:semicolon
r_if
c_cond
(paren
id|mhz100
OG
id|mach64MaxFreq
)paren
id|mhz100
op_assign
id|mach64MaxFreq
suffix:semicolon
id|longMHz100
op_assign
id|mhz100
op_star
l_int|256
op_div
l_int|100
suffix:semicolon
multiline_comment|/* 8 bit scale this */
r_while
c_loop
(paren
id|mhz100
OL
(paren
id|mach64MinFreq
op_lshift
l_int|3
)paren
)paren
(brace
id|mhz100
op_lshift_assign
l_int|1
suffix:semicolon
id|k
op_increment
suffix:semicolon
)brace
id|twoToKth
op_assign
l_int|1
op_lshift
id|k
suffix:semicolon
id|diff
op_assign
l_int|0
suffix:semicolon
id|preDiff
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
r_for
c_loop
(paren
id|m
op_assign
id|MIN_M
suffix:semicolon
id|m
op_le
id|MAX_M
suffix:semicolon
id|m
op_increment
)paren
(brace
r_for
c_loop
(paren
id|n
op_assign
id|MIN_N
suffix:semicolon
id|n
op_le
id|MAX_N
suffix:semicolon
id|n
op_increment
)paren
(brace
id|tempA
op_assign
(paren
l_float|14.31818
op_star
l_int|65536
)paren
suffix:semicolon
id|tempA
op_mul_assign
(paren
id|n
op_plus
l_int|8
)paren
suffix:semicolon
multiline_comment|/* 43..256 */
id|tempB
op_assign
id|twoToKth
op_star
l_int|256
suffix:semicolon
id|tempB
op_mul_assign
(paren
id|m
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 4..32 */
id|fOut
op_assign
id|tempA
op_div
id|tempB
suffix:semicolon
multiline_comment|/* 8 bit scale */
r_if
c_cond
(paren
id|longMHz100
OG
id|fOut
)paren
id|diff
op_assign
id|longMHz100
op_minus
id|fOut
suffix:semicolon
r_else
id|diff
op_assign
id|fOut
op_minus
id|longMHz100
suffix:semicolon
r_if
c_cond
(paren
id|diff
OL
id|preDiff
)paren
(brace
id|save_m
op_assign
id|m
suffix:semicolon
id|save_n
op_assign
id|n
suffix:semicolon
id|preDiff
op_assign
id|diff
suffix:semicolon
)brace
)brace
)brace
id|program_bits
op_assign
(paren
id|k
op_lshift
l_int|6
)paren
op_plus
(paren
id|save_m
)paren
op_plus
(paren
id|save_n
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|pll-&gt;ics2595.program_bits
op_assign
id|program_bits
suffix:semicolon
id|pll-&gt;ics2595.locationAddr
op_assign
l_int|0
suffix:semicolon
id|pll-&gt;ics2595.post_divider
op_assign
l_int|0
suffix:semicolon
id|pll-&gt;ics2595.period_in_ps
op_assign
id|vclk_per
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aty_pll_8398_to_var
r_static
id|u32
id|aty_pll_8398_to_var
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
r_return
id|pll-&gt;ics2595.period_in_ps
suffix:semicolon
multiline_comment|/* default for now */
)brace
DECL|function|aty_set_pll_8398
r_static
r_void
id|aty_set_pll_8398
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
id|u32
id|program_bits
suffix:semicolon
id|u32
id|locationAddr
suffix:semicolon
r_char
id|old_crtc_ext_disp
suffix:semicolon
r_char
id|tmp
suffix:semicolon
id|old_crtc_ext_disp
op_assign
id|aty_ld_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|old_crtc_ext_disp
op_or
(paren
id|CRTC_EXT_DISP_EN
op_rshift
l_int|24
)paren
comma
id|info
)paren
suffix:semicolon
id|program_bits
op_assign
id|pll-&gt;ics2595.program_bits
suffix:semicolon
id|locationAddr
op_assign
id|pll-&gt;ics2595.locationAddr
suffix:semicolon
multiline_comment|/* Program clock */
id|tmp
op_assign
id|aty_ld_8
c_func
(paren
id|DAC_CNTL
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_CNTL
comma
id|tmp
op_or
id|DAC_EXT_SEL_RS2
op_or
id|DAC_EXT_SEL_RS3
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
comma
id|locationAddr
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|1
comma
(paren
id|program_bits
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|1
comma
(paren
id|program_bits
op_amp
l_int|0xff
)paren
comma
id|info
)paren
suffix:semicolon
id|tmp
op_assign
id|aty_ld_8
c_func
(paren
id|DAC_CNTL
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_CNTL
comma
(paren
id|tmp
op_amp
op_complement
id|DAC_EXT_SEL_RS2
)paren
op_or
id|DAC_EXT_SEL_RS3
comma
id|info
)paren
suffix:semicolon
(paren
r_void
)paren
id|aty_ld_8
c_func
(paren
id|DAC_REGS
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Clear DAC Counter */
id|aty_st_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|old_crtc_ext_disp
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|aty_pll_ch8398
r_const
r_struct
id|aty_pll_ops
id|aty_pll_ch8398
op_assign
(brace
id|var_to_pll
suffix:colon
id|aty_var_to_pll_8398
comma
id|pll_to_var
suffix:colon
id|aty_pll_8398_to_var
comma
id|set_pll
suffix:colon
id|aty_set_pll_8398
comma
)brace
suffix:semicolon
multiline_comment|/*&n;     *  AT&amp;T 20C408 Clock Chip&n;     */
DECL|function|aty_var_to_pll_408
r_static
r_int
id|aty_var_to_pll_408
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
id|u32
id|vclk_per
comma
id|u8
id|bpp
comma
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
id|u32
id|mhz100
suffix:semicolon
multiline_comment|/* in 0.01 MHz */
id|u32
id|program_bits
suffix:semicolon
multiline_comment|/* u32 post_divider; */
id|u32
id|mach64MinFreq
comma
id|mach64MaxFreq
comma
id|mach64RefFreq
suffix:semicolon
id|u32
id|temp
comma
id|tempB
suffix:semicolon
id|u16
id|remainder
comma
id|preRemainder
suffix:semicolon
r_int
id|divider
op_assign
l_int|0
comma
id|tempA
suffix:semicolon
multiline_comment|/* Calculate the programming word */
id|mhz100
op_assign
l_int|100000000
op_div
id|vclk_per
suffix:semicolon
id|mach64MinFreq
op_assign
id|MIN_FREQ_2595
suffix:semicolon
id|mach64MaxFreq
op_assign
id|MAX_FREQ_2595
suffix:semicolon
id|mach64RefFreq
op_assign
id|REF_FREQ_2595
suffix:semicolon
multiline_comment|/* 14.32 MHz */
multiline_comment|/* Calculate program word */
r_if
c_cond
(paren
id|mhz100
op_eq
l_int|0
)paren
id|program_bits
op_assign
l_int|0xFF
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|mhz100
OL
id|mach64MinFreq
)paren
id|mhz100
op_assign
id|mach64MinFreq
suffix:semicolon
r_if
c_cond
(paren
id|mhz100
OG
id|mach64MaxFreq
)paren
id|mhz100
op_assign
id|mach64MaxFreq
suffix:semicolon
r_while
c_loop
(paren
id|mhz100
OL
(paren
id|mach64MinFreq
op_lshift
l_int|3
)paren
)paren
(brace
id|mhz100
op_lshift_assign
l_int|1
suffix:semicolon
id|divider
op_add_assign
l_int|0x40
suffix:semicolon
)brace
id|temp
op_assign
(paren
r_int
r_int
)paren
id|mhz100
suffix:semicolon
id|temp
op_assign
(paren
r_int
r_int
)paren
(paren
id|temp
op_star
(paren
id|MIN_N_408
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|temp
op_sub_assign
(paren
(paren
r_int
)paren
(paren
id|mach64RefFreq
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
id|tempA
op_assign
id|MIN_N_408
suffix:semicolon
id|preRemainder
op_assign
l_int|0xFFFF
suffix:semicolon
r_do
(brace
id|tempB
op_assign
id|temp
suffix:semicolon
id|remainder
op_assign
id|tempB
op_mod
id|mach64RefFreq
suffix:semicolon
id|tempB
op_assign
id|tempB
op_div
id|mach64RefFreq
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|tempB
op_amp
l_int|0xFFFF
)paren
op_le
l_int|255
)paren
op_logical_and
(paren
id|remainder
op_le
id|preRemainder
)paren
)paren
(brace
id|preRemainder
op_assign
id|remainder
suffix:semicolon
id|divider
op_and_assign
op_complement
l_int|0x3f
suffix:semicolon
id|divider
op_or_assign
id|tempA
suffix:semicolon
id|divider
op_assign
(paren
id|divider
op_amp
l_int|0x00FF
)paren
op_plus
(paren
(paren
id|tempB
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|temp
op_add_assign
id|mhz100
suffix:semicolon
id|tempA
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|tempA
op_le
l_int|32
)paren
(brace
suffix:semicolon
)brace
id|program_bits
op_assign
id|divider
suffix:semicolon
)brace
id|pll-&gt;ics2595.program_bits
op_assign
id|program_bits
suffix:semicolon
id|pll-&gt;ics2595.locationAddr
op_assign
l_int|0
suffix:semicolon
id|pll-&gt;ics2595.post_divider
op_assign
id|divider
suffix:semicolon
multiline_comment|/* fuer nix */
id|pll-&gt;ics2595.period_in_ps
op_assign
id|vclk_per
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aty_pll_408_to_var
r_static
id|u32
id|aty_pll_408_to_var
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
r_return
id|pll-&gt;ics2595.period_in_ps
suffix:semicolon
multiline_comment|/* default for now */
)brace
DECL|function|aty_set_pll_408
r_static
r_void
id|aty_set_pll_408
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
id|u32
id|program_bits
suffix:semicolon
id|u32
id|locationAddr
suffix:semicolon
id|u8
id|tmpA
comma
id|tmpB
comma
id|tmpC
suffix:semicolon
r_char
id|old_crtc_ext_disp
suffix:semicolon
id|old_crtc_ext_disp
op_assign
id|aty_ld_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|old_crtc_ext_disp
op_or
(paren
id|CRTC_EXT_DISP_EN
op_rshift
l_int|24
)paren
comma
id|info
)paren
suffix:semicolon
id|program_bits
op_assign
id|pll-&gt;ics2595.program_bits
suffix:semicolon
id|locationAddr
op_assign
id|pll-&gt;ics2595.locationAddr
suffix:semicolon
multiline_comment|/* Program clock */
id|aty_dac_waste4
c_func
(paren
id|info
)paren
suffix:semicolon
id|tmpB
op_assign
id|aty_ld_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|info
)paren
op_or
l_int|1
suffix:semicolon
id|aty_dac_waste4
c_func
(paren
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|tmpB
comma
id|info
)paren
suffix:semicolon
id|tmpA
op_assign
id|tmpB
suffix:semicolon
id|tmpC
op_assign
id|tmpA
suffix:semicolon
id|tmpA
op_or_assign
l_int|8
suffix:semicolon
id|tmpB
op_assign
l_int|1
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
comma
id|tmpB
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|tmpA
comma
id|info
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|400
)paren
suffix:semicolon
multiline_comment|/* delay for 400 us */
id|locationAddr
op_assign
(paren
id|locationAddr
op_lshift
l_int|2
)paren
op_plus
l_int|0x40
suffix:semicolon
id|tmpB
op_assign
id|locationAddr
suffix:semicolon
id|tmpA
op_assign
id|program_bits
op_rshift
l_int|8
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
comma
id|tmpB
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|tmpA
comma
id|info
)paren
suffix:semicolon
id|tmpB
op_assign
id|locationAddr
op_plus
l_int|1
suffix:semicolon
id|tmpA
op_assign
(paren
id|u8
)paren
id|program_bits
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
comma
id|tmpB
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|tmpA
comma
id|info
)paren
suffix:semicolon
id|tmpB
op_assign
id|locationAddr
op_plus
l_int|2
suffix:semicolon
id|tmpA
op_assign
l_int|0x77
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
comma
id|tmpB
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|tmpA
comma
id|info
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|400
)paren
suffix:semicolon
multiline_comment|/* delay for 400 us */
id|tmpA
op_assign
id|tmpC
op_amp
(paren
op_complement
(paren
l_int|1
op_or
l_int|8
)paren
)paren
suffix:semicolon
id|tmpB
op_assign
l_int|1
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
comma
id|tmpB
comma
id|info
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_REGS
op_plus
l_int|2
comma
id|tmpA
comma
id|info
)paren
suffix:semicolon
(paren
r_void
)paren
id|aty_ld_8
c_func
(paren
id|DAC_REGS
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Clear DAC Counter */
id|aty_st_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|old_crtc_ext_disp
comma
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|aty_pll_att20c408
r_const
r_struct
id|aty_pll_ops
id|aty_pll_att20c408
op_assign
(brace
id|var_to_pll
suffix:colon
id|aty_var_to_pll_408
comma
id|pll_to_var
suffix:colon
id|aty_pll_408_to_var
comma
id|set_pll
suffix:colon
id|aty_set_pll_408
comma
)brace
suffix:semicolon
multiline_comment|/*&n;     *  Unsupported DAC and Clock Chip&n;     */
DECL|function|aty_set_dac_unsupported
r_static
r_int
id|aty_set_dac_unsupported
c_func
(paren
r_const
r_struct
id|fb_info_aty
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
comma
id|u32
id|bpp
comma
id|u32
id|accel
)paren
(brace
id|aty_st_le32
c_func
(paren
id|BUS_CNTL
comma
l_int|0x890e20f1
comma
id|info
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DAC_CNTL
comma
l_int|0x47052100
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* new in 2.2.3p1 from Geert. ???????? */
id|aty_st_le32
c_func
(paren
id|BUS_CNTL
comma
l_int|0x590e10ff
comma
id|info
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DAC_CNTL
comma
l_int|0x47012100
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dummy
r_static
r_int
id|dummy
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|aty_dac_unsupported
r_const
r_struct
id|aty_dac_ops
id|aty_dac_unsupported
op_assign
(brace
id|set_dac
suffix:colon
id|aty_set_dac_unsupported
comma
)brace
suffix:semicolon
DECL|variable|aty_pll_unsupported
r_const
r_struct
id|aty_pll_ops
id|aty_pll_unsupported
op_assign
(brace
id|var_to_pll
suffix:colon
(paren
r_void
op_star
)paren
id|dummy
comma
id|pll_to_var
suffix:colon
(paren
r_void
op_star
)paren
id|dummy
comma
id|set_pll
suffix:colon
(paren
r_void
op_star
)paren
id|dummy
comma
)brace
suffix:semicolon
eof
