multiline_comment|/*&n; *  ATI Frame Buffer Device Driver Core&n; *&n; *&t;Copyright (C) 1997-2001  Geert Uytterhoeven&n; *&t;Copyright (C) 1998  Bernd Harries&n; *&t;Copyright (C) 1998  Eddie C. Dost  (ecd@skynet.be)&n; *&n; *  This driver supports the following ATI graphics chips:&n; *    - ATI Mach64&n; *&n; *  To do: add support for&n; *    - ATI Rage128 (from aty128fb.c)&n; *    - ATI Radeon (from radeonfb.c)&n; *&n; *  This driver is partly based on the PowerMac console driver:&n; *&n; *&t;Copyright (C) 1996 Paul Mackerras&n; *&n; *  and on the PowerMac ATI/mach64 display driver:&n; *&n; *&t;Copyright (C) 1997 Michael AK Tesch&n; *&n; *&t;      with work by Jon Howell&n; *&t;&t;&t;   Harry AC Eaton&n; *&t;&t;&t;   Anthony Tong &lt;atong@uiuc.edu&gt;&n; *&n; *  Generic LCD support written by Daniel Mantione, ported from 2.4.20 by Alex Kern&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License. See the file COPYING in the main directory of this archive for&n; *  more details.&n; *  &n; *  Many thanks to Nitya from ATI devrel for support and patience !&n; */
multiline_comment|/******************************************************************************&n;&n;  TODO:&n;&n;    - cursor support on all cards and all ramdacs.&n;    - cursor parameters controlable via ioctl()s.&n;    - guess PLL and MCLK based on the original PLL register values initialized&n;      by the BIOS or Open Firmware (if they are initialized).&n;&n;&t;&t;&t;&t;&t;&t;(Anyone to help with this?)&n;&n;******************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;video/mach64.h&gt;
macro_line|#include &quot;atyfb.h&quot;
macro_line|#ifdef __powerpc__
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &quot;../macmodes.h&quot;
macro_line|#endif
macro_line|#ifdef __sparc__
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &lt;asm/fbio.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_ADB_PMU
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_BOOTX_TEXT
macro_line|#include &lt;asm/btext.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
macro_line|#include &lt;asm/backlight.h&gt;
macro_line|#endif
multiline_comment|/*&n; * Debug flags.&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG
multiline_comment|/* Make sure n * PAGE_SIZE is protected at end of Aperture for GUI-regs */
multiline_comment|/*  - must be large enough to catch all GUI-Regs   */
multiline_comment|/*  - must be aligned to a PAGE boundary           */
DECL|macro|GUI_RESERVE
mdefine_line|#define GUI_RESERVE&t;(1 * PAGE_SIZE)
multiline_comment|/* FIXME: remove the FAIL definition */
DECL|macro|FAIL
mdefine_line|#define FAIL(x) do { printk(x &quot;&bslash;n&quot;); return -EINVAL; } while (0)
multiline_comment|/*&n;     *  The Hardware parameters for each card&n;     */
DECL|struct|aty_cmap_regs
r_struct
id|aty_cmap_regs
(brace
DECL|member|windex
id|u8
id|windex
suffix:semicolon
DECL|member|lut
id|u8
id|lut
suffix:semicolon
DECL|member|mask
id|u8
id|mask
suffix:semicolon
DECL|member|rindex
id|u8
id|rindex
suffix:semicolon
DECL|member|cntl
id|u8
id|cntl
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|pci_mmap_map
r_struct
id|pci_mmap_map
(brace
DECL|member|voff
r_int
r_int
id|voff
suffix:semicolon
DECL|member|poff
r_int
r_int
id|poff
suffix:semicolon
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
DECL|member|prot_flag
r_int
r_int
id|prot_flag
suffix:semicolon
DECL|member|prot_mask
r_int
r_int
id|prot_mask
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|fb_fix_screeninfo
id|atyfb_fix
id|__initdata
op_assign
(brace
dot
id|id
op_assign
l_string|&quot;ATY Mach64&quot;
comma
dot
id|type
op_assign
id|FB_TYPE_PACKED_PIXELS
comma
dot
id|visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
comma
dot
id|xpanstep
op_assign
l_int|8
comma
dot
id|ypanstep
op_assign
l_int|1
comma
)brace
suffix:semicolon
multiline_comment|/*&n;     *  Frame buffer device API&n;     */
r_static
r_int
id|atyfb_open
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
suffix:semicolon
r_static
r_int
id|atyfb_release
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
suffix:semicolon
r_static
r_int
id|atyfb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|atyfb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|atyfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|atyfb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|atyfb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|atyfb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_extern
r_void
id|atyfb_fillrect
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_fillrect
op_star
id|rect
)paren
suffix:semicolon
r_extern
r_void
id|atyfb_copyarea
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_copyarea
op_star
id|area
)paren
suffix:semicolon
r_extern
r_void
id|atyfb_imageblit
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_image
op_star
id|image
)paren
suffix:semicolon
macro_line|#ifdef __sparc__
r_static
r_int
id|atyfb_mmap
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|atyfb_sync
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;     *  Internal routines&n;     */
r_static
r_int
id|aty_init
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_char
op_star
id|name
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ATARI
r_static
r_int
id|store_video_par
c_func
(paren
r_char
op_star
id|videopar
comma
r_int
r_char
id|m64_num
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|aty_set_crtc
c_func
(paren
r_const
r_struct
id|atyfb_par
op_star
id|par
comma
r_const
r_struct
id|crtc
op_star
id|crtc
)paren
suffix:semicolon
r_static
r_int
id|aty_var_to_crtc
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|crtc
op_star
id|crtc
)paren
suffix:semicolon
r_static
r_int
id|aty_crtc_to_var
c_func
(paren
r_const
r_struct
id|crtc
op_star
id|crtc
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
suffix:semicolon
r_static
r_void
id|set_off_pitch
c_func
(paren
r_struct
id|atyfb_par
op_star
id|par
comma
r_const
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PPC
r_static
r_int
id|read_aty_sense
c_func
(paren
r_const
r_struct
id|atyfb_par
op_star
id|par
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;     *  Interface used by the world&n;     */
r_int
id|atyfb_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifndef MODULE
r_int
id|atyfb_setup
c_func
(paren
r_char
op_star
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|atyfb_ops
r_static
r_struct
id|fb_ops
id|atyfb_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|fb_open
op_assign
id|atyfb_open
comma
dot
id|fb_release
op_assign
id|atyfb_release
comma
dot
id|fb_check_var
op_assign
id|atyfb_check_var
comma
dot
id|fb_set_par
op_assign
id|atyfb_set_par
comma
dot
id|fb_setcolreg
op_assign
id|atyfb_setcolreg
comma
dot
id|fb_pan_display
op_assign
id|atyfb_pan_display
comma
dot
id|fb_blank
op_assign
id|atyfb_blank
comma
dot
id|fb_ioctl
op_assign
id|atyfb_ioctl
comma
dot
id|fb_fillrect
op_assign
id|atyfb_fillrect
comma
dot
id|fb_copyarea
op_assign
id|atyfb_copyarea
comma
dot
id|fb_imageblit
op_assign
id|atyfb_imageblit
comma
dot
id|fb_cursor
op_assign
id|soft_cursor
comma
macro_line|#ifdef __sparc__
dot
id|fb_mmap
op_assign
id|atyfb_mmap
comma
macro_line|#endif
dot
id|fb_sync
op_assign
id|atyfb_sync
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|curblink
id|__initdata
op_assign
l_int|1
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|noaccel
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
id|u32
id|default_vram
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|default_pll
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|default_mclk
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|default_xclk
id|__initdata
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef MODULE
DECL|variable|__initdata
r_static
r_char
op_star
id|mode_option
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PPC
DECL|variable|__initdata
r_static
r_int
id|default_vmode
id|__initdata
op_assign
id|VMODE_CHOOSE
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|default_cmode
id|__initdata
op_assign
id|CMODE_CHOOSE
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ATARI
DECL|variable|__initdata
r_static
r_int
r_int
id|mach64_count
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|phys_vmembase
(braket
id|FB_MAX
)braket
id|__initdata
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|phys_size
(braket
id|FB_MAX
)braket
id|__initdata
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|phys_guiregbase
(braket
id|FB_MAX
)braket
id|__initdata
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FB_ATY_GX
DECL|variable|__initdata
r_static
r_char
id|m64n_gx
(braket
)braket
id|__initdata
op_assign
l_string|&quot;mach64GX (ATI888GX00)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_cx
(braket
)braket
id|__initdata
op_assign
l_string|&quot;mach64CX (ATI888CX00)&quot;
suffix:semicolon
macro_line|#endif /* CONFIG_FB_ATY_GX */
macro_line|#ifdef CONFIG_FB_ATY_CT
DECL|variable|__initdata
r_static
r_char
id|m64n_ct
(braket
)braket
id|__initdata
op_assign
l_string|&quot;mach64CT (ATI264CT)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_et
(braket
)braket
id|__initdata
op_assign
l_string|&quot;mach64ET (ATI264ET)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_vta3
(braket
)braket
id|__initdata
op_assign
l_string|&quot;mach64VTA3 (ATI264VT)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_vta4
(braket
)braket
id|__initdata
op_assign
l_string|&quot;mach64VTA4 (ATI264VT)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_vtb
(braket
)braket
id|__initdata
op_assign
l_string|&quot;mach64VTB (ATI264VTB)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_vt4
(braket
)braket
id|__initdata
op_assign
l_string|&quot;mach64VT4 (ATI264VT4)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_gt
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE (GT)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_gtb
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE II+ (GTB)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_iic_p
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE IIC (PCI)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_iic_a
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE IIC (AGP)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_lt
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE LT&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_ltg
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE LT-G&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_gtc_ba
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE PRO (BGA, AGP)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_gtc_ba1
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE PRO (BGA, AGP, 1x only)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_gtc_bp
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE PRO (BGA, PCI)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_gtc_pp
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE PRO (PQFP, PCI)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_gtc_ppl
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE PRO (PQFP, PCI, limited 3D)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_xl
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE (XL)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_ltp_a
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE LT PRO (AGP)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_ltp_p
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE LT PRO (PCI)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_mob_p
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE Mobility P/M (AGP 2x)&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|m64n_mob_a
(braket
)braket
id|__initdata
op_assign
l_string|&quot;3D RAGE Mobility L (AGP 2x)&quot;
suffix:semicolon
macro_line|#endif /* CONFIG_FB_ATY_CT */
r_static
r_struct
(brace
DECL|member|pci_id
DECL|member|chip_type
id|u16
id|pci_id
comma
id|chip_type
suffix:semicolon
DECL|member|rev_mask
DECL|member|rev_val
id|u8
id|rev_mask
comma
id|rev_val
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|pll
DECL|member|mclk
DECL|member|xclk
r_int
id|pll
comma
id|mclk
comma
id|xclk
suffix:semicolon
DECL|member|features
id|u32
id|features
suffix:semicolon
DECL|variable|__initdata
)brace
id|aty_chips
(braket
)braket
id|__initdata
op_assign
(brace
macro_line|#ifdef CONFIG_FB_ATY_GX
multiline_comment|/* Mach64 GX */
(brace
l_int|0x4758
comma
l_int|0x00d7
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_gx
comma
l_int|135
comma
l_int|50
comma
l_int|50
comma
id|M64F_GX
)brace
comma
(brace
l_int|0x4358
comma
l_int|0x0057
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_cx
comma
l_int|135
comma
l_int|50
comma
l_int|50
comma
id|M64F_GX
)brace
comma
macro_line|#endif&t;&t;&t;&t;/* CONFIG_FB_ATY_GX */
macro_line|#ifdef CONFIG_FB_ATY_CT
multiline_comment|/* Mach64 CT */
(brace
l_int|0x4354
comma
l_int|0x4354
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_ct
comma
l_int|135
comma
l_int|60
comma
l_int|60
comma
id|M64F_CT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_CT_BUS
op_or
id|M64F_MAGIC_FIFO
)brace
comma
(brace
l_int|0x4554
comma
l_int|0x4554
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_et
comma
l_int|135
comma
l_int|60
comma
l_int|60
comma
id|M64F_CT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_CT_BUS
op_or
id|M64F_MAGIC_FIFO
)brace
comma
multiline_comment|/* Mach64 VT */
(brace
l_int|0x5654
comma
l_int|0x5654
comma
l_int|0xc7
comma
l_int|0x00
comma
id|m64n_vta3
comma
l_int|170
comma
l_int|67
comma
l_int|67
comma
id|M64F_VT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_VT_BUS
op_or
id|M64F_MAGIC_FIFO
op_or
id|M64F_FIFO_24
)brace
comma
(brace
l_int|0x5654
comma
l_int|0x5654
comma
l_int|0xc7
comma
l_int|0x40
comma
id|m64n_vta4
comma
l_int|200
comma
l_int|67
comma
l_int|67
comma
id|M64F_VT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_VT_BUS
op_or
id|M64F_MAGIC_FIFO
op_or
id|M64F_FIFO_24
op_or
id|M64F_MAGIC_POSTDIV
)brace
comma
(brace
l_int|0x5654
comma
l_int|0x5654
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_vtb
comma
l_int|200
comma
l_int|67
comma
l_int|67
comma
id|M64F_VT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_VT_BUS
op_or
id|M64F_GTB_DSP
op_or
id|M64F_FIFO_24
)brace
comma
(brace
l_int|0x5655
comma
l_int|0x5655
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_vtb
comma
l_int|200
comma
l_int|67
comma
l_int|67
comma
id|M64F_VT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_VT_BUS
op_or
id|M64F_GTB_DSP
op_or
id|M64F_FIFO_24
op_or
id|M64F_SDRAM_MAGIC_PLL
)brace
comma
(brace
l_int|0x5656
comma
l_int|0x5656
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_vt4
comma
l_int|230
comma
l_int|83
comma
l_int|83
comma
id|M64F_VT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_GTB_DSP
)brace
comma
multiline_comment|/* Mach64 GT (3D RAGE) */
(brace
l_int|0x4754
comma
l_int|0x4754
comma
l_int|0x07
comma
l_int|0x00
comma
id|m64n_gt
comma
l_int|135
comma
l_int|63
comma
l_int|63
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_MAGIC_FIFO
op_or
id|M64F_FIFO_24
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x4754
comma
l_int|0x4754
comma
l_int|0x07
comma
l_int|0x01
comma
id|m64n_gt
comma
l_int|170
comma
l_int|67
comma
l_int|67
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_GTB_DSP
op_or
id|M64F_FIFO_24
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x4754
comma
l_int|0x4754
comma
l_int|0x07
comma
l_int|0x02
comma
id|m64n_gt
comma
l_int|200
comma
l_int|67
comma
l_int|67
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_GTB_DSP
op_or
id|M64F_FIFO_24
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x4755
comma
l_int|0x4755
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_gtb
comma
l_int|200
comma
l_int|67
comma
l_int|67
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_GTB_DSP
op_or
id|M64F_FIFO_24
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x4756
comma
l_int|0x4756
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_iic_p
comma
l_int|230
comma
l_int|83
comma
l_int|83
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_GTB_DSP
op_or
id|M64F_FIFO_24
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x4757
comma
l_int|0x4757
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_iic_a
comma
l_int|230
comma
l_int|83
comma
l_int|83
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_GTB_DSP
op_or
id|M64F_FIFO_24
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x475a
comma
l_int|0x475a
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_iic_a
comma
l_int|230
comma
l_int|83
comma
l_int|83
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_GTB_DSP
op_or
id|M64F_FIFO_24
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
multiline_comment|/* Mach64 LT */
(brace
l_int|0x4c54
comma
l_int|0x4c54
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_lt
comma
l_int|135
comma
l_int|63
comma
l_int|63
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_GTB_DSP
)brace
comma
(brace
l_int|0x4c47
comma
l_int|0x4c47
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_ltg
comma
l_int|230
comma
l_int|63
comma
l_int|63
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_GTB_DSP
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
op_or
id|M64F_LT_SLEEP
op_or
id|M64F_G3_PB_1024x768
)brace
comma
multiline_comment|/* Mach64 GTC (3D RAGE PRO) */
(brace
l_int|0x4742
comma
l_int|0x4742
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_gtc_ba
comma
l_int|230
comma
l_int|100
comma
l_int|100
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x4744
comma
l_int|0x4744
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_gtc_ba1
comma
l_int|230
comma
l_int|100
comma
l_int|100
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x4749
comma
l_int|0x4749
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_gtc_bp
comma
l_int|230
comma
l_int|100
comma
l_int|100
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
op_or
id|M64F_MAGIC_VRAM_SIZE
)brace
comma
(brace
l_int|0x4750
comma
l_int|0x4750
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_gtc_pp
comma
l_int|230
comma
l_int|100
comma
l_int|100
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x4751
comma
l_int|0x4751
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_gtc_ppl
comma
l_int|230
comma
l_int|100
comma
l_int|100
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
multiline_comment|/* 3D RAGE XL */
(brace
l_int|0x4752
comma
l_int|0x4752
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_xl
comma
l_int|235
comma
l_int|83
comma
l_int|63
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_SDRAM_MAGIC_PLL
op_or
id|M64F_EXTRA_BRIGHT
op_or
id|M64F_XL_DLL
)brace
comma
multiline_comment|/* Mach64 LT PRO */
(brace
l_int|0x4c42
comma
l_int|0x4c42
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_ltp_a
comma
l_int|236
comma
l_int|75
comma
l_int|100
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x4c44
comma
l_int|0x4c44
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_ltp_p
comma
l_int|230
comma
l_int|100
comma
l_int|100
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x4c49
comma
l_int|0x4c49
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_ltp_p
comma
l_int|230
comma
l_int|100
comma
l_int|100
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_EXTRA_BRIGHT
op_or
id|M64F_G3_PB_1_1
op_or
id|M64F_G3_PB_1024x768
)brace
comma
(brace
l_int|0x4c50
comma
l_int|0x4c50
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_ltp_p
comma
l_int|230
comma
l_int|100
comma
l_int|100
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
multiline_comment|/* 3D RAGE Mobility */
(brace
l_int|0x4c4d
comma
l_int|0x4c4d
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_mob_p
comma
l_int|230
comma
l_int|83
comma
l_int|125
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_MOBIL_BUS
op_or
id|M64F_XL_DLL
op_or
id|M64F_EXTRA_BRIGHT
)brace
comma
(brace
l_int|0x4c4e
comma
l_int|0x4c4e
comma
l_int|0x00
comma
l_int|0x00
comma
id|m64n_mob_a
comma
l_int|230
comma
l_int|83
comma
l_int|125
comma
id|M64F_GT
op_or
id|M64F_INTEGRATED
op_or
id|M64F_RESET_3D
op_or
id|M64F_GTB_DSP
op_or
id|M64F_MOBIL_BUS
)brace
comma
macro_line|#endif&t;&t;&t;&t;/* CONFIG_FB_ATY_CT */
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ram_dram
(braket
)braket
id|__initdata
op_assign
l_string|&quot;DRAM&quot;
suffix:semicolon
macro_line|#ifdef CONFIG_FB_ATY_GX
DECL|variable|__initdata
r_static
r_char
id|ram_vram
(braket
)braket
id|__initdata
op_assign
l_string|&quot;VRAM&quot;
suffix:semicolon
macro_line|#endif /* CONFIG_FB_ATY_GX */
macro_line|#ifdef CONFIG_FB_ATY_CT
DECL|variable|__initdata
r_static
r_char
id|ram_edo
(braket
)braket
id|__initdata
op_assign
l_string|&quot;EDO&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ram_sdram
(braket
)braket
id|__initdata
op_assign
l_string|&quot;SDRAM&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ram_sgram
(braket
)braket
id|__initdata
op_assign
l_string|&quot;SGRAM&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ram_wram
(braket
)braket
id|__initdata
op_assign
l_string|&quot;WRAM&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ram_off
(braket
)braket
id|__initdata
op_assign
l_string|&quot;OFF&quot;
suffix:semicolon
macro_line|#endif /* CONFIG_FB_ATY_CT */
DECL|variable|__initdata
r_static
r_char
id|ram_resv
(braket
)braket
id|__initdata
op_assign
l_string|&quot;RESV&quot;
suffix:semicolon
DECL|variable|pseudo_palette
r_static
id|u32
id|pseudo_palette
(braket
l_int|17
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_FB_ATY_GX
DECL|variable|__initdata
r_static
r_char
op_star
id|aty_gx_ram
(braket
l_int|8
)braket
id|__initdata
op_assign
(brace
id|ram_dram
comma
id|ram_vram
comma
id|ram_vram
comma
id|ram_dram
comma
id|ram_dram
comma
id|ram_vram
comma
id|ram_vram
comma
id|ram_resv
)brace
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_FB_ATY_GX */
macro_line|#ifdef CONFIG_FB_ATY_CT
DECL|variable|__initdata
r_static
r_char
op_star
id|aty_ct_ram
(braket
l_int|8
)braket
id|__initdata
op_assign
(brace
id|ram_off
comma
id|ram_dram
comma
id|ram_edo
comma
id|ram_edo
comma
id|ram_sdram
comma
id|ram_sgram
comma
id|ram_wram
comma
id|ram_resv
)brace
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_FB_ATY_CT */
macro_line|#if defined(CONFIG_PPC)
multiline_comment|/*&n;     *  Apple monitor sense&n;     */
DECL|function|read_aty_sense
r_static
r_int
id|__init
id|read_aty_sense
c_func
(paren
r_const
r_struct
id|atyfb_par
op_star
id|par
)paren
(brace
r_int
id|sense
comma
id|i
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|GP_IO
comma
l_int|0x31003100
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* drive outputs high */
id|__delay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|GP_IO
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* turn off outputs */
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|i
op_assign
id|aty_ld_le32
c_func
(paren
id|GP_IO
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* get primary sense value */
id|sense
op_assign
(paren
(paren
id|i
op_amp
l_int|0x3000
)paren
op_rshift
l_int|3
)paren
op_or
(paren
id|i
op_amp
l_int|0x100
)paren
suffix:semicolon
multiline_comment|/* drive each sense line low in turn and collect the other 2 */
id|aty_st_le32
c_func
(paren
id|GP_IO
comma
l_int|0x20000000
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* drive A low */
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|i
op_assign
id|aty_ld_le32
c_func
(paren
id|GP_IO
comma
id|par
)paren
suffix:semicolon
id|sense
op_or_assign
(paren
(paren
id|i
op_amp
l_int|0x1000
)paren
op_rshift
l_int|7
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x100
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|GP_IO
comma
l_int|0x20002000
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* drive A high again */
id|__delay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|GP_IO
comma
l_int|0x10000000
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* drive B low */
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|i
op_assign
id|aty_ld_le32
c_func
(paren
id|GP_IO
comma
id|par
)paren
suffix:semicolon
id|sense
op_or_assign
(paren
(paren
id|i
op_amp
l_int|0x2000
)paren
op_rshift
l_int|10
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|0x100
)paren
op_rshift
l_int|6
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|GP_IO
comma
l_int|0x10001000
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* drive B high again */
id|__delay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|GP_IO
comma
l_int|0x01000000
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* drive C low */
id|__delay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|sense
op_or_assign
(paren
id|aty_ld_le32
c_func
(paren
id|GP_IO
comma
id|par
)paren
op_amp
l_int|0x3000
)paren
op_rshift
l_int|12
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|GP_IO
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* turn off outputs */
r_return
id|sense
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* defined(CONFIG_PPC) */
macro_line|#if defined(CONFIG_PMAC_PBOOK) || defined(CONFIG_PMAC_BACKLIGHT) || defined (CONFIG_FB_ATY_GENERIC_LCD)
DECL|function|aty_st_lcd
r_static
r_void
id|aty_st_lcd
c_func
(paren
r_int
id|index
comma
id|u32
id|val
comma
r_const
r_struct
id|atyfb_par
op_star
id|par
)paren
(brace
r_int
r_int
id|temp
suffix:semicolon
multiline_comment|/* write addr byte */
id|temp
op_assign
id|aty_ld_le32
c_func
(paren
id|LCD_INDEX
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|LCD_INDEX
comma
(paren
id|temp
op_amp
op_complement
id|LCD_INDEX_MASK
)paren
op_or
id|index
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* write the register value */
id|aty_st_le32
c_func
(paren
id|LCD_DATA
comma
id|val
comma
id|par
)paren
suffix:semicolon
)brace
DECL|function|aty_ld_lcd
r_static
id|u32
id|aty_ld_lcd
c_func
(paren
r_int
id|index
comma
r_const
r_struct
id|atyfb_par
op_star
id|par
)paren
(brace
r_int
r_int
id|temp
suffix:semicolon
multiline_comment|/* write addr byte */
id|temp
op_assign
id|aty_ld_le32
c_func
(paren
id|LCD_INDEX
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|LCD_INDEX
comma
(paren
id|temp
op_amp
op_complement
id|LCD_INDEX_MASK
)paren
op_or
id|index
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* read the register value */
r_return
id|aty_ld_le32
c_func
(paren
id|LCD_DATA
comma
id|par
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_PMAC_PBOOK || CONFIG_PMAC_BACKLIGHT || CONFIG_FB_ATY_GENERIC_LCD */
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
DECL|function|atyfb_monitors_enabled
r_static
r_void
id|atyfb_monitors_enabled
c_func
(paren
r_struct
id|atyfb_par
op_star
id|par
comma
r_struct
id|crtc
op_star
id|crtc
)paren
(brace
r_if
c_cond
(paren
id|par-&gt;lcd_table
op_ne
l_int|0
)paren
(brace
id|crtc-&gt;monitors_enabled
op_assign
id|aty_ld_lcd
c_func
(paren
id|LCD_GEN_CTRL
comma
id|par
)paren
op_amp
l_int|3
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/*&n;     *  CRTC programming&n;     */
DECL|function|aty_set_crtc
r_static
r_void
id|aty_set_crtc
c_func
(paren
r_const
r_struct
id|atyfb_par
op_star
id|par
comma
r_const
r_struct
id|crtc
op_star
id|crtc
)paren
(brace
id|aty_st_le32
c_func
(paren
id|CRTC_H_TOTAL_DISP
comma
id|crtc-&gt;h_tot_disp
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CRTC_H_SYNC_STRT_WID
comma
id|crtc-&gt;h_sync_strt_wid
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CRTC_V_TOTAL_DISP
comma
id|crtc-&gt;v_tot_disp
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CRTC_V_SYNC_STRT_WID
comma
id|crtc-&gt;v_sync_strt_wid
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CRTC_VLINE_CRNT_VLINE
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CRTC_OFF_PITCH
comma
id|crtc-&gt;off_pitch
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|crtc-&gt;gen_cntl
comma
id|par
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Setting up CRTC&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CRTC_GEN_CNTL: %x&bslash;n&quot;
comma
id|crtc-&gt;gen_cntl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CRTC_H_TOTAL_DISP: %x&bslash;n&quot;
comma
id|crtc-&gt;h_tot_disp
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CRTC_H_SYNC_STRT_WID: %x&bslash;n&quot;
comma
id|crtc-&gt;h_sync_strt_wid
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CRTC_V_TOTAL_DISP: %x&bslash;n&quot;
comma
id|crtc-&gt;v_tot_disp
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CRTC_V_SYNC_STRT_WID: %x&bslash;n&quot;
comma
id|crtc-&gt;v_sync_strt_wid
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
multiline_comment|/* After setting the CRTC registers we should set the LCD&n;&t; * registers.&n;&t; */
r_if
c_cond
(paren
id|par-&gt;lcd_table
op_ne
l_int|0
)paren
(brace
id|u32
id|v
suffix:semicolon
multiline_comment|/* Enable/disable horizontal stretching */
id|v
op_assign
id|aty_ld_lcd
c_func
(paren
id|HORZ_STRETCHING
comma
id|par
)paren
suffix:semicolon
id|v
op_assign
id|v
op_amp
op_complement
(paren
id|HORZ_STRETCH_RATIO
op_or
id|HORZ_STRETCH_EN
op_or
id|AUTO_HORZ_RATIO
)paren
suffix:semicolon
id|v
op_assign
id|v
op_or
id|HORZ_STRETCH_MODE
suffix:semicolon
multiline_comment|/* Use interpolation instead of duplication. */
r_if
c_cond
(paren
id|crtc-&gt;h_stretching
op_ne
l_int|0
)paren
id|v
op_assign
id|v
op_or
id|HORZ_STRETCH_EN
op_or
id|crtc-&gt;h_stretching
suffix:semicolon
id|aty_st_lcd
c_func
(paren
id|HORZ_STRETCHING
comma
id|v
comma
id|par
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HORZ_STRETCHING: %x&bslash;n&quot;
comma
id|v
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Enable/disable vertital stretching */
id|v
op_assign
id|aty_ld_lcd
c_func
(paren
id|VERT_STRETCHING
comma
id|par
)paren
suffix:semicolon
id|v
op_assign
id|v
op_amp
op_complement
(paren
id|VERT_STRETCH_RATIO0
op_or
id|VERT_STRETCH_EN
)paren
suffix:semicolon
id|v
op_assign
id|v
op_or
id|VERT_STRETCH_USE0
suffix:semicolon
multiline_comment|/* Use VERT_STRETCH_RATIO0. */
r_if
c_cond
(paren
id|crtc-&gt;v_stretching
op_ne
l_int|0
)paren
id|v
op_assign
id|v
op_or
id|VERT_STRETCH_EN
op_or
id|crtc-&gt;v_stretching
suffix:semicolon
id|aty_st_lcd
c_func
(paren
id|VERT_STRETCHING
comma
id|v
comma
id|par
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;VERT_STRETCHING: %x&bslash;n&quot;
comma
id|v
)paren
suffix:semicolon
macro_line|#endif
id|v
op_assign
id|aty_ld_lcd
c_func
(paren
id|EXT_VERT_STRETCH
comma
id|par
)paren
suffix:semicolon
id|v
op_assign
id|v
op_amp
op_complement
id|AUTO_VERT_RATIO
suffix:semicolon
multiline_comment|/* Forbit the chip to guess the vertical&n;&t;                                      expansion (used for vga compatibility) */
id|v
op_assign
id|v
op_or
id|VERT_STRETCH_MODE
suffix:semicolon
multiline_comment|/* Use interpolation instead of duplication. */
id|aty_st_lcd
c_func
(paren
id|EXT_VERT_STRETCH
comma
id|v
comma
id|par
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;EXT_VERT_STRETCH: %x&bslash;n&quot;
comma
id|v
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Don&squot;t use shadowing. Don&squot;t divide the horizontal paramters.&n;&t;&t;   (VGA compatibility junk that might be enabled.)&n;&t;&t;   Enable only the monitors that were enabled before we switched the&n;&t;&t;   video mode.&n;&t;&t; */
id|v
op_assign
id|aty_ld_lcd
c_func
(paren
id|LCD_GEN_CTRL
comma
id|par
)paren
suffix:semicolon
id|v
op_assign
id|v
op_amp
op_complement
(paren
id|HORZ_DIVBY2_EN
op_or
id|SCLK_SEL
op_or
id|USE_SHADOWED_VEND
op_or
id|SHADOW_EN
op_or
id|LCD_ON
op_or
id|CRT_ON
)paren
suffix:semicolon
id|v
op_assign
id|v
op_or
id|DONT_SHADOW_VPAR
op_or
id|crtc-&gt;monitors_enabled
suffix:semicolon
id|aty_st_lcd
c_func
(paren
id|LCD_GEN_CTRL
comma
id|v
comma
id|par
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;LCD_GEN_CTRL: %x&bslash;n&quot;
comma
id|v
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif /* CONFIG_FB_ATY_GENERIC_LCD */
)brace
DECL|function|aty_var_to_crtc
r_static
r_int
id|aty_var_to_crtc
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|crtc
op_star
id|crtc
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|xres
comma
id|yres
comma
id|ryres
comma
id|vxres
comma
id|vyres
comma
id|xoffset
comma
id|yoffset
comma
id|bpp
suffix:semicolon
id|u32
id|left
comma
id|right
comma
id|upper
comma
id|lower
comma
id|hslen
comma
id|vslen
comma
id|sync
comma
id|vmode
suffix:semicolon
id|u32
id|h_total
comma
id|h_disp
comma
id|h_sync_strt
comma
id|h_sync_dly
comma
id|h_sync_wid
comma
id|h_sync_pol
suffix:semicolon
id|u32
id|v_total
comma
id|v_disp
comma
id|v_sync_strt
comma
id|v_sync_wid
comma
id|v_sync_pol
comma
id|c_sync
suffix:semicolon
id|u32
id|pix_width
comma
id|dp_pix_width
comma
id|dp_chain_mask
suffix:semicolon
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
id|u32
id|lcd_hsync_start
comma
id|lcd_htotal
comma
id|lcd_vsync_start
comma
id|lcd_vtotal
suffix:semicolon
macro_line|#endif
multiline_comment|/* input */
id|xres
op_assign
id|var-&gt;xres
suffix:semicolon
id|yres
op_assign
id|var-&gt;yres
suffix:semicolon
id|ryres
op_assign
id|yres
suffix:semicolon
id|vxres
op_assign
id|var-&gt;xres_virtual
suffix:semicolon
id|vyres
op_assign
id|var-&gt;yres_virtual
suffix:semicolon
id|xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
id|bpp
op_assign
id|var-&gt;bits_per_pixel
suffix:semicolon
id|left
op_assign
id|var-&gt;left_margin
suffix:semicolon
id|right
op_assign
id|var-&gt;right_margin
suffix:semicolon
id|upper
op_assign
id|var-&gt;upper_margin
suffix:semicolon
id|lower
op_assign
id|var-&gt;lower_margin
suffix:semicolon
id|hslen
op_assign
id|var-&gt;hsync_len
suffix:semicolon
id|vslen
op_assign
id|var-&gt;vsync_len
suffix:semicolon
id|sync
op_assign
id|var-&gt;sync
suffix:semicolon
id|vmode
op_assign
id|var-&gt;vmode
suffix:semicolon
multiline_comment|/* convert (and round up) and validate */
id|xres
op_assign
(paren
id|xres
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
suffix:semicolon
id|xoffset
op_assign
(paren
id|xoffset
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
suffix:semicolon
id|vxres
op_assign
(paren
id|vxres
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|vxres
OL
id|xres
op_plus
id|xoffset
)paren
id|vxres
op_assign
id|xres
op_plus
id|xoffset
suffix:semicolon
id|h_disp
op_assign
id|xres
op_div
l_int|8
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|h_disp
OG
l_int|0xff
)paren
id|FAIL
c_func
(paren
l_string|&quot;h_disp too large&quot;
)paren
suffix:semicolon
id|h_sync_strt
op_assign
id|h_disp
op_plus
(paren
id|right
op_div
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|h_sync_strt
OG
l_int|0x1ff
)paren
id|FAIL
c_func
(paren
l_string|&quot;h_sync_start too large&quot;
)paren
suffix:semicolon
id|h_sync_dly
op_assign
id|right
op_amp
l_int|7
suffix:semicolon
id|h_sync_wid
op_assign
(paren
id|hslen
op_plus
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|h_sync_wid
OG
l_int|0x1f
)paren
id|FAIL
c_func
(paren
l_string|&quot;h_sync_wid too large&quot;
)paren
suffix:semicolon
id|h_total
op_assign
id|h_sync_strt
op_plus
id|h_sync_wid
op_plus
(paren
id|h_sync_dly
op_plus
id|left
op_plus
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|h_total
OG
l_int|0x1ff
)paren
id|FAIL
c_func
(paren
l_string|&quot;h_total too large&quot;
)paren
suffix:semicolon
id|h_sync_pol
op_assign
id|sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|vyres
OL
id|yres
op_plus
id|yoffset
)paren
id|vyres
op_assign
id|yres
op_plus
id|yoffset
suffix:semicolon
id|v_disp
op_assign
id|yres
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|v_disp
OG
l_int|0x7ff
)paren
id|FAIL
c_func
(paren
l_string|&quot;v_disp too large&quot;
)paren
suffix:semicolon
id|v_sync_strt
op_assign
id|v_disp
op_plus
id|lower
suffix:semicolon
r_if
c_cond
(paren
id|v_sync_strt
OG
l_int|0x7ff
)paren
id|FAIL
c_func
(paren
l_string|&quot;v_sync_strt too large&quot;
)paren
suffix:semicolon
id|v_sync_wid
op_assign
id|vslen
suffix:semicolon
r_if
c_cond
(paren
id|v_sync_wid
OG
l_int|0x1f
)paren
id|FAIL
c_func
(paren
l_string|&quot;v_sync_wid too large&quot;
)paren
suffix:semicolon
id|v_total
op_assign
id|v_sync_strt
op_plus
id|v_sync_wid
op_plus
id|upper
suffix:semicolon
r_if
c_cond
(paren
id|v_total
OG
l_int|0x7ff
)paren
id|FAIL
c_func
(paren
l_string|&quot;v_total too large&quot;
)paren
suffix:semicolon
id|v_sync_pol
op_assign
id|sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* In double scan mode, the vertical parameters need to be doubled.&n;&t;   But in interlaced mode, there is no need to half the vertical parameters.&n;&t;   Code has been tested in 1024x768, 43 Hz interlaced and 640x480, 60 Hz&n;&t;   double scan.&n;&t; */
r_if
c_cond
(paren
(paren
id|vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_DOUBLE
)paren
(brace
id|ryres
op_lshift_assign
l_int|1
suffix:semicolon
id|v_total
op_lshift_assign
l_int|1
suffix:semicolon
id|v_disp
op_lshift_assign
l_int|1
suffix:semicolon
id|v_sync_strt
op_lshift_assign
l_int|1
suffix:semicolon
id|v_sync_wid
op_lshift_assign
l_int|1
suffix:semicolon
)brace
id|c_sync
op_assign
id|sync
op_amp
id|FB_SYNC_COMP_HIGH_ACT
ques
c_cond
id|CRTC_CSYNC_EN
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|bpp
op_le
l_int|8
)paren
(brace
id|bpp
op_assign
l_int|8
suffix:semicolon
id|pix_width
op_assign
id|CRTC_PIX_WIDTH_8BPP
suffix:semicolon
id|dp_pix_width
op_assign
id|HOST_8BPP
op_or
id|SRC_8BPP
op_or
id|DST_8BPP
op_or
id|BYTE_ORDER_LSB_TO_MSB
suffix:semicolon
id|dp_chain_mask
op_assign
l_int|0x8080
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bpp
op_le
l_int|16
)paren
(brace
id|bpp
op_assign
l_int|16
suffix:semicolon
id|pix_width
op_assign
id|CRTC_PIX_WIDTH_15BPP
suffix:semicolon
id|dp_pix_width
op_assign
id|HOST_15BPP
op_or
id|SRC_15BPP
op_or
id|DST_15BPP
op_or
id|BYTE_ORDER_LSB_TO_MSB
suffix:semicolon
id|dp_chain_mask
op_assign
l_int|0x4210
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bpp
op_le
l_int|24
op_logical_and
id|M64_HAS
c_func
(paren
id|INTEGRATED
)paren
)paren
(brace
id|bpp
op_assign
l_int|24
suffix:semicolon
id|pix_width
op_assign
id|CRTC_PIX_WIDTH_24BPP
suffix:semicolon
id|dp_pix_width
op_assign
id|HOST_8BPP
op_or
id|SRC_8BPP
op_or
id|DST_8BPP
op_or
id|BYTE_ORDER_LSB_TO_MSB
suffix:semicolon
id|dp_chain_mask
op_assign
l_int|0x8080
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bpp
op_le
l_int|32
)paren
(brace
id|bpp
op_assign
l_int|32
suffix:semicolon
id|pix_width
op_assign
id|CRTC_PIX_WIDTH_32BPP
suffix:semicolon
id|dp_pix_width
op_assign
id|HOST_32BPP
op_or
id|SRC_32BPP
op_or
id|DST_32BPP
op_or
id|BYTE_ORDER_LSB_TO_MSB
suffix:semicolon
id|dp_chain_mask
op_assign
l_int|0x8080
suffix:semicolon
)brace
r_else
id|FAIL
c_func
(paren
l_string|&quot;invalid bpp&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vxres
op_star
id|vyres
op_star
id|bpp
op_div
l_int|8
OG
id|info-&gt;fix.smem_len
)paren
id|FAIL
c_func
(paren
l_string|&quot;not enough video RAM&quot;
)paren
suffix:semicolon
multiline_comment|/*&t;if ((vmode &amp; FB_VMODE_MASK) != FB_VMODE_NONINTERLACED)&n;&t;&t;FAIL(&quot;invalid vmode&quot;); */
multiline_comment|/* output */
id|var-&gt;xres_virtual
op_assign
id|vxres
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|vyres
suffix:semicolon
id|crtc-&gt;off_pitch
op_assign
(paren
(paren
id|yoffset
op_star
id|vxres
op_plus
id|xoffset
)paren
op_star
id|bpp
op_div
l_int|64
)paren
op_or
(paren
id|vxres
op_lshift
l_int|19
)paren
suffix:semicolon
id|crtc-&gt;gen_cntl
op_assign
id|pix_width
op_or
id|c_sync
op_or
id|CRTC_EXT_DISP_EN
op_or
id|CRTC_ENABLE
suffix:semicolon
multiline_comment|/* Enable doublescan mode if requested */
r_if
c_cond
(paren
(paren
id|vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_DOUBLE
)paren
id|crtc-&gt;gen_cntl
op_or_assign
id|CRTC_DBL_SCAN_EN
suffix:semicolon
multiline_comment|/* Enable interlaced mode if requested */
r_if
c_cond
(paren
(paren
id|vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_INTERLACED
)paren
id|crtc-&gt;gen_cntl
op_or_assign
id|CRTC_INTERLACE_EN
suffix:semicolon
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
multiline_comment|/* We can only program the real mode parameters to the CRTC&n;&t;   if the LCD monitor is switched off. Otherwise we will have to&n;&t;   use the parameters the LCD monitor prefers, effectively setting&n;&t;   a completely different mode which simulates the requested&n;&t;   video mode.&n;&t; */
id|atyfb_monitors_enabled
c_func
(paren
id|par
comma
id|crtc
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par-&gt;lcd_table
op_ne
l_int|0
)paren
op_logical_and
(paren
(paren
id|crtc-&gt;monitors_enabled
op_amp
id|LCD_ON
)paren
op_ne
l_int|0
)paren
op_logical_and
(paren
(paren
id|xres
OG
id|par-&gt;lcd_width
)paren
op_logical_or
(paren
id|ryres
OG
id|par-&gt;lcd_height
)paren
)paren
)paren
(brace
multiline_comment|/* We cannot display the mode on the LCD. If the CRT is enabled&n;&t;&t;   we can turn off the LCD.&n;&t;&t;   If the CRT is off, it isn&squot;t a good idea to switch it on; we don&squot;t&n;&t;&t;   know if one is connected. So it&squot;s better to fail then.&n;&t;&t; */
r_if
c_cond
(paren
id|crtc-&gt;monitors_enabled
op_amp
id|CRT_ON
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Disabling lcd monitor because video mode does not fit.&bslash;n&quot;
)paren
suffix:semicolon
id|crtc-&gt;monitors_enabled
op_and_assign
(paren
op_complement
id|LCD_ON
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;Video mode exceeds size of lcd monitor.&bslash;nConnect this computer to a conventional monitor if you really need this mode.&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|par-&gt;lcd_table
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|crtc-&gt;monitors_enabled
op_amp
id|LCD_ON
)paren
op_eq
l_int|0
)paren
)paren
(brace
macro_line|#endif /* CONFIG_FB_ATY_GENERIC_LCD */
id|crtc-&gt;h_tot_disp
op_assign
id|h_total
op_or
(paren
id|h_disp
op_lshift
l_int|16
)paren
suffix:semicolon
id|crtc-&gt;h_sync_strt_wid
op_assign
(paren
id|h_sync_strt
op_amp
l_int|0xff
)paren
op_or
(paren
id|h_sync_dly
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|h_sync_strt
op_amp
l_int|0x100
)paren
op_lshift
l_int|4
)paren
op_or
(paren
id|h_sync_wid
op_lshift
l_int|16
)paren
op_or
(paren
id|h_sync_pol
op_lshift
l_int|21
)paren
suffix:semicolon
id|crtc-&gt;v_tot_disp
op_assign
id|v_total
op_or
(paren
id|v_disp
op_lshift
l_int|16
)paren
suffix:semicolon
id|crtc-&gt;v_sync_strt_wid
op_assign
id|v_sync_strt
op_or
(paren
id|v_sync_wid
op_lshift
l_int|16
)paren
op_or
(paren
id|v_sync_pol
op_lshift
l_int|21
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
multiline_comment|/* No hardware stretching please! */
id|crtc-&gt;h_stretching
op_assign
l_int|0
suffix:semicolon
id|crtc-&gt;v_stretching
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* This is horror! When we simulate, say 640x480 on an 800x600&n;&t;&t;   lcd monitor, the CRTC should be programmed 800x600 values for&n;&t;&t;   the non visible part, but 640x480 for the visible part.&n;&t;&t;   This code has been tested on a laptop with it&squot;s 800x600 lcd&n;&t;&t;   monitor and a conventional monitor both switched on.&n;&t;&t;   Tested modes: 640x400, 720x400, 800x600, 320x200-doublescan,&n;&t;&t;      800x600-interlaced&n;&t;&t; */
id|lcd_htotal
op_assign
id|h_disp
op_plus
id|par-&gt;lcd_hblank_width
suffix:semicolon
id|lcd_hsync_start
op_assign
id|h_disp
op_plus
id|par-&gt;lcd_right
suffix:semicolon
id|lcd_vtotal
op_assign
id|v_disp
op_plus
id|par-&gt;lcd_vblank_width
suffix:semicolon
id|lcd_vsync_start
op_assign
id|v_disp
op_plus
id|par-&gt;lcd_lower
suffix:semicolon
id|crtc-&gt;h_tot_disp
op_assign
(paren
id|lcd_htotal
)paren
op_or
(paren
id|h_disp
op_lshift
l_int|16
)paren
suffix:semicolon
id|crtc-&gt;h_sync_strt_wid
op_assign
(paren
id|lcd_hsync_start
op_amp
l_int|0xff
)paren
op_or
(paren
id|par-&gt;lcd_hsync_delay
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|lcd_hsync_start
op_amp
l_int|0x100
)paren
op_lshift
l_int|4
)paren
op_or
(paren
id|par-&gt;lcd_hsync_width
op_lshift
l_int|16
)paren
suffix:semicolon
id|crtc-&gt;v_tot_disp
op_assign
id|lcd_vtotal
op_or
(paren
id|v_disp
op_lshift
l_int|16
)paren
suffix:semicolon
id|crtc-&gt;v_sync_strt_wid
op_assign
id|lcd_vsync_start
op_or
(paren
id|par-&gt;lcd_vsync_width
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* To simulate the requested video mode, we use the hardware stretcher,&n;&t;&t;   which zooms the image to the dimensions of the LCD screen. It has&n;&t;&t;   two modes; replication and blending. Replication duplicates some&n;&t;&t;   pixels, blending interpolates between pixels. We use blending.&n;&t;&t;   The formula for blending is:&n;&t;&t;      h_stretching=(source_with/dest_width)*4096&n;&t;&t;      v_stretching=(source_lines/dest_lines)*1024&n;&t;&t; */
r_if
c_cond
(paren
id|xres
op_ne
id|par-&gt;lcd_width
)paren
id|crtc-&gt;h_stretching
op_assign
(paren
id|xres
op_star
l_int|4096
)paren
op_div
id|par-&gt;lcd_width
suffix:semicolon
r_else
id|crtc-&gt;h_stretching
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ryres
op_ne
id|par-&gt;lcd_height
)paren
id|crtc-&gt;v_stretching
op_assign
(paren
id|ryres
op_star
l_int|1024
)paren
op_div
id|par-&gt;lcd_height
suffix:semicolon
r_else
id|crtc-&gt;v_stretching
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The prefered mode for the lcd is not interlaced, so disable it if&n;&t;&t;   it was enabled. For doublescan there is no problem, because we can&n;&t;&t;   compensate for it in the hardware stretching (we stretch half as much)&n;&t;&t; */
id|crtc-&gt;gen_cntl
op_and_assign
op_complement
id|CRTC_INTERLACE_EN
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_FB_ATY_GENERIC_LCD */
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|MAGIC_FIFO
)paren
)paren
(brace
multiline_comment|/* Not VTB/GTB */
multiline_comment|/* FIXME: magic FIFO values */
id|crtc-&gt;gen_cntl
op_or_assign
id|aty_ld_le32
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|par
)paren
op_amp
l_int|0x000e0000
suffix:semicolon
)brace
id|crtc-&gt;dp_pix_width
op_assign
id|dp_pix_width
suffix:semicolon
id|crtc-&gt;dp_chain_mask
op_assign
id|dp_chain_mask
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aty_crtc_to_var
r_static
r_int
id|aty_crtc_to_var
c_func
(paren
r_const
r_struct
id|crtc
op_star
id|crtc
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|u32
id|xres
comma
id|yres
comma
id|bpp
comma
id|left
comma
id|right
comma
id|upper
comma
id|lower
comma
id|hslen
comma
id|vslen
comma
id|sync
suffix:semicolon
id|u32
id|h_total
comma
id|h_disp
comma
id|h_sync_strt
comma
id|h_sync_dly
comma
id|h_sync_wid
comma
id|h_sync_pol
suffix:semicolon
id|u32
id|v_total
comma
id|v_disp
comma
id|v_sync_strt
comma
id|v_sync_wid
comma
id|v_sync_pol
comma
id|c_sync
suffix:semicolon
id|u32
id|pix_width
suffix:semicolon
id|u32
id|double_scan
comma
id|interlace
suffix:semicolon
multiline_comment|/* input */
id|h_total
op_assign
id|crtc-&gt;h_tot_disp
op_amp
l_int|0x1ff
suffix:semicolon
id|h_disp
op_assign
(paren
id|crtc-&gt;h_tot_disp
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|h_sync_strt
op_assign
(paren
id|crtc-&gt;h_sync_strt_wid
op_amp
l_int|0xff
)paren
op_or
(paren
(paren
id|crtc-&gt;h_sync_strt_wid
op_rshift
l_int|4
)paren
op_amp
l_int|0x100
)paren
suffix:semicolon
id|h_sync_dly
op_assign
(paren
id|crtc-&gt;h_sync_strt_wid
op_rshift
l_int|8
)paren
op_amp
l_int|0x7
suffix:semicolon
id|h_sync_wid
op_assign
(paren
id|crtc-&gt;h_sync_strt_wid
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
suffix:semicolon
id|h_sync_pol
op_assign
(paren
id|crtc-&gt;h_sync_strt_wid
op_rshift
l_int|21
)paren
op_amp
l_int|0x1
suffix:semicolon
id|v_total
op_assign
id|crtc-&gt;v_tot_disp
op_amp
l_int|0x7ff
suffix:semicolon
id|v_disp
op_assign
(paren
id|crtc-&gt;v_tot_disp
op_rshift
l_int|16
)paren
op_amp
l_int|0x7ff
suffix:semicolon
id|v_sync_strt
op_assign
id|crtc-&gt;v_sync_strt_wid
op_amp
l_int|0x7ff
suffix:semicolon
id|v_sync_wid
op_assign
(paren
id|crtc-&gt;v_sync_strt_wid
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
suffix:semicolon
id|v_sync_pol
op_assign
(paren
id|crtc-&gt;v_sync_strt_wid
op_rshift
l_int|21
)paren
op_amp
l_int|0x1
suffix:semicolon
id|c_sync
op_assign
id|crtc-&gt;gen_cntl
op_amp
id|CRTC_CSYNC_EN
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|pix_width
op_assign
id|crtc-&gt;gen_cntl
op_amp
id|CRTC_PIX_WIDTH_MASK
suffix:semicolon
id|double_scan
op_assign
id|crtc-&gt;gen_cntl
op_amp
id|CRTC_DBL_SCAN_EN
suffix:semicolon
id|interlace
op_assign
id|crtc-&gt;gen_cntl
op_amp
id|CRTC_INTERLACE_EN
suffix:semicolon
multiline_comment|/* convert */
id|xres
op_assign
(paren
id|h_disp
op_plus
l_int|1
)paren
op_star
l_int|8
suffix:semicolon
id|yres
op_assign
id|v_disp
op_plus
l_int|1
suffix:semicolon
id|left
op_assign
(paren
id|h_total
op_minus
id|h_sync_strt
op_minus
id|h_sync_wid
)paren
op_star
l_int|8
op_minus
id|h_sync_dly
suffix:semicolon
id|right
op_assign
(paren
id|h_sync_strt
op_minus
id|h_disp
)paren
op_star
l_int|8
op_plus
id|h_sync_dly
suffix:semicolon
id|hslen
op_assign
id|h_sync_wid
op_star
l_int|8
suffix:semicolon
id|upper
op_assign
id|v_total
op_minus
id|v_sync_strt
op_minus
id|v_sync_wid
suffix:semicolon
id|lower
op_assign
id|v_sync_strt
op_minus
id|v_disp
suffix:semicolon
id|vslen
op_assign
id|v_sync_wid
suffix:semicolon
id|sync
op_assign
(paren
id|h_sync_pol
ques
c_cond
l_int|0
suffix:colon
id|FB_SYNC_HOR_HIGH_ACT
)paren
op_or
(paren
id|v_sync_pol
ques
c_cond
l_int|0
suffix:colon
id|FB_SYNC_VERT_HIGH_ACT
)paren
op_or
(paren
id|c_sync
ques
c_cond
id|FB_SYNC_COMP_HIGH_ACT
suffix:colon
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|pix_width
)paren
(brace
macro_line|#if 0
r_case
id|CRTC_PIX_WIDTH_4BPP
suffix:colon
id|bpp
op_assign
l_int|4
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|CRTC_PIX_WIDTH_8BPP
suffix:colon
id|bpp
op_assign
l_int|8
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CRTC_PIX_WIDTH_15BPP
suffix:colon
multiline_comment|/* RGB 555 */
id|bpp
op_assign
l_int|16
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|10
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#if 0
r_case
id|CRTC_PIX_WIDTH_16BPP
suffix:colon
multiline_comment|/* RGB 565 */
id|bpp
op_assign
l_int|16
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|11
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|CRTC_PIX_WIDTH_24BPP
suffix:colon
multiline_comment|/* RGB 888 */
id|bpp
op_assign
l_int|24
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CRTC_PIX_WIDTH_32BPP
suffix:colon
multiline_comment|/* ARGB 8888 */
id|bpp
op_assign
l_int|32
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|16
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|8
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|24
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|FAIL
c_func
(paren
l_string|&quot;Invalid pixel width&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* output */
id|var-&gt;xres
op_assign
id|xres
suffix:semicolon
id|var-&gt;yres
op_assign
id|yres
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
id|bpp
suffix:semicolon
id|var-&gt;left_margin
op_assign
id|left
suffix:semicolon
id|var-&gt;right_margin
op_assign
id|right
suffix:semicolon
id|var-&gt;upper_margin
op_assign
id|upper
suffix:semicolon
id|var-&gt;lower_margin
op_assign
id|lower
suffix:semicolon
id|var-&gt;hsync_len
op_assign
id|hslen
suffix:semicolon
id|var-&gt;vsync_len
op_assign
id|vslen
suffix:semicolon
id|var-&gt;sync
op_assign
id|sync
suffix:semicolon
id|var-&gt;vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
multiline_comment|/* In double scan mode, the vertical parameters are doubled, so we need to&n;&t;   half them to get the right values.&n;&t;   In interlaced mode the values are already correct, so no correction is&n;&t;   necessary.&n;&t;   Code has been tested in 1024x768, 43 Hz interlaced and 640x480, 60 Hz&n;&t;   doublesscan.&n;&t; */
r_if
c_cond
(paren
id|interlace
)paren
id|var-&gt;vmode
op_assign
id|FB_VMODE_INTERLACED
suffix:semicolon
r_if
c_cond
(paren
id|double_scan
)paren
(brace
id|var-&gt;vmode
op_assign
id|FB_VMODE_DOUBLE
suffix:semicolon
id|var-&gt;yres
op_rshift_assign
l_int|1
suffix:semicolon
id|var-&gt;upper_margin
op_rshift_assign
l_int|1
suffix:semicolon
id|var-&gt;lower_margin
op_rshift_assign
l_int|1
suffix:semicolon
id|var-&gt;vsync_len
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------- */
DECL|function|atyfb_set_par
r_static
r_int
id|atyfb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|info-&gt;var
suffix:semicolon
id|u32
id|i
comma
id|xres
comma
id|pixclock
suffix:semicolon
r_int
id|err
suffix:semicolon
id|u8
id|tmp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|aty_var_to_crtc
c_func
(paren
id|info
comma
id|var
comma
op_amp
id|par-&gt;crtc
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
id|pixclock
op_assign
id|var-&gt;pixclock
suffix:semicolon
id|xres
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
r_if
c_cond
(paren
(paren
id|par-&gt;lcd_table
op_ne
l_int|0
)paren
op_logical_and
(paren
(paren
id|par-&gt;crtc.monitors_enabled
op_amp
id|LCD_ON
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|pixclock
op_assign
id|par-&gt;lcd_pixclock
suffix:semicolon
id|xres
op_assign
id|var-&gt;xres
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|err
op_assign
id|par-&gt;pll_ops
op_member_access_from_pointer
id|var_to_pll
c_func
(paren
id|info
comma
id|pixclock
comma
id|var-&gt;bits_per_pixel
comma
id|xres
comma
op_amp
id|par-&gt;pll
)paren
)paren
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|par-&gt;accel_flags
op_assign
id|var-&gt;accel_flags
suffix:semicolon
multiline_comment|/* hack */
r_if
c_cond
(paren
id|par-&gt;blitter_may_be_busy
)paren
id|wait_for_idle
c_func
(paren
id|par
)paren
suffix:semicolon
id|tmp
op_assign
id|aty_ld_8
c_func
(paren
id|CRTC_GEN_CNTL
op_plus
l_int|3
comma
id|par
)paren
suffix:semicolon
id|aty_set_crtc
c_func
(paren
id|par
comma
op_amp
id|par-&gt;crtc
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
macro_line|#if 1
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
comma
id|CLOCK_STROBE
op_or
id|CLOCK_DIV
comma
id|par
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|MOBIL_BUS
)paren
op_logical_and
id|M64_HAS
c_func
(paren
id|XL_DLL
)paren
)paren
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
op_plus
id|par-&gt;clk_wr_offset
comma
id|CLOCK_STROBE
op_or
id|CLOCK_DIV
op_or
(paren
id|par-&gt;clock
op_amp
id|CLOCK_SEL
)paren
comma
id|par
)paren
suffix:semicolon
r_else
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
op_plus
id|par-&gt;clk_wr_offset
comma
id|CLOCK_STROBE
comma
id|par
)paren
suffix:semicolon
macro_line|#endif
id|par-&gt;dac_ops
op_member_access_from_pointer
id|set_dac
c_func
(paren
id|info
comma
op_amp
id|par-&gt;pll
comma
id|var-&gt;bits_per_pixel
comma
id|par-&gt;accel_flags
)paren
suffix:semicolon
id|par-&gt;pll_ops
op_member_access_from_pointer
id|set_pll
c_func
(paren
id|info
comma
op_amp
id|par-&gt;pll
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|M64_HAS
c_func
(paren
id|INTEGRATED
)paren
)paren
(brace
multiline_comment|/* Don&squot;t forget MEM_CNTL */
id|i
op_assign
id|aty_ld_le32
c_func
(paren
id|MEM_CNTL
comma
id|par
)paren
op_amp
l_int|0xf0ffffff
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
id|i
op_or_assign
l_int|0x02000000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|i
op_or_assign
l_int|0x03000000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|i
op_or_assign
l_int|0x06000000
suffix:semicolon
r_break
suffix:semicolon
)brace
id|aty_st_le32
c_func
(paren
id|MEM_CNTL
comma
id|i
comma
id|par
)paren
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
id|aty_ld_le32
c_func
(paren
id|MEM_CNTL
comma
id|par
)paren
op_amp
l_int|0xf00fffff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|M64_HAS
c_func
(paren
id|MAGIC_POSTDIV
)paren
)paren
id|i
op_or_assign
id|par-&gt;mem_refresh_rate
op_lshift
l_int|20
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|8
suffix:colon
r_case
l_int|24
suffix:colon
id|i
op_or_assign
l_int|0x00000000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|i
op_or_assign
l_int|0x04000000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|i
op_or_assign
l_int|0x08000000
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|CT_BUS
)paren
)paren
(brace
id|aty_st_le32
c_func
(paren
id|DAC_CNTL
comma
l_int|0x87010184
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|BUS_CNTL
comma
l_int|0x680000f9
comma
id|par
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|VT_BUS
)paren
)paren
(brace
id|aty_st_le32
c_func
(paren
id|DAC_CNTL
comma
l_int|0x87010184
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|BUS_CNTL
comma
l_int|0x680000f9
comma
id|par
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|MOBIL_BUS
)paren
)paren
(brace
id|aty_st_le32
c_func
(paren
id|DAC_CNTL
comma
l_int|0x80010102
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|BUS_CNTL
comma
l_int|0x7b33a040
comma
id|par
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* GT */
id|aty_st_le32
c_func
(paren
id|DAC_CNTL
comma
l_int|0x86010102
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|BUS_CNTL
comma
l_int|0x7b23a040
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|EXT_MEM_CNTL
comma
id|aty_ld_le32
c_func
(paren
id|EXT_MEM_CNTL
comma
id|par
)paren
op_or
l_int|0x5000001
comma
id|par
)paren
suffix:semicolon
)brace
id|aty_st_le32
c_func
(paren
id|MEM_CNTL
comma
id|i
comma
id|par
)paren
suffix:semicolon
)brace
id|aty_st_8
c_func
(paren
id|DAC_MASK
comma
l_int|0xff
comma
id|par
)paren
suffix:semicolon
id|info-&gt;fix.line_length
op_assign
id|var-&gt;xres_virtual
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|8
suffix:semicolon
id|info-&gt;fix.visual
op_assign
id|var-&gt;bits_per_pixel
op_le
l_int|8
ques
c_cond
id|FB_VISUAL_PSEUDOCOLOR
suffix:colon
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
multiline_comment|/* Initialize the graphics engine */
r_if
c_cond
(paren
id|par-&gt;accel_flags
op_amp
id|FB_ACCELF_TEXT
)paren
id|aty_init_engine
c_func
(paren
id|par
comma
id|info
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_BOOTX_TEXT
id|btext_update_display
c_func
(paren
id|info-&gt;fix.smem_start
comma
(paren
(paren
(paren
id|par-&gt;crtc.h_tot_disp
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
op_plus
l_int|1
)paren
op_star
l_int|8
comma
(paren
(paren
id|par-&gt;crtc.v_tot_disp
op_rshift
l_int|16
)paren
op_amp
l_int|0x7ff
)paren
op_plus
l_int|1
comma
id|var-&gt;bits_per_pixel
comma
id|var-&gt;xres_virtaul
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|8
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_BOOTX_TEXT */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|atyfb_check_var
r_static
r_int
id|atyfb_check_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|pixclock
comma
id|xres
suffix:semicolon
r_union
id|aty_pll
id|pll
suffix:semicolon
r_struct
id|crtc
id|crtc
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|aty_var_to_crtc
c_func
(paren
id|info
comma
id|var
comma
op_amp
id|crtc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Alert! aty_var_to_crtc can modify monitors_enabled which is&n;&t;&t;   important for the pixclock decision */
id|pixclock
op_assign
id|var-&gt;pixclock
suffix:semicolon
id|xres
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* non LCD */
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
r_if
c_cond
(paren
(paren
id|par-&gt;lcd_table
op_ne
l_int|0
)paren
op_logical_and
(paren
(paren
id|crtc.monitors_enabled
op_amp
id|LCD_ON
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|pixclock
op_assign
id|par-&gt;lcd_pixclock
suffix:semicolon
id|xres
op_assign
id|var-&gt;xres
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pixclock
op_eq
l_int|0
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;Invalid pixclock&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
op_assign
id|par-&gt;pll_ops
op_member_access_from_pointer
id|var_to_pll
c_func
(paren
id|info
comma
id|pixclock
comma
id|var-&gt;bits_per_pixel
comma
id|xres
comma
op_amp
id|pll
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;accel_flags
op_amp
id|FB_ACCELF_TEXT
)paren
id|info-&gt;var.accel_flags
op_assign
id|FB_ACCELF_TEXT
suffix:semicolon
r_else
id|info-&gt;var.accel_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0 /* fbmon is not done. uncomment for 2.5.x -brad */
r_if
c_cond
(paren
op_logical_neg
id|fbmon_valid_timings
c_func
(paren
id|pixclock
comma
id|htotal
comma
id|vtotal
comma
id|info
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
id|aty_crtc_to_var
c_func
(paren
op_amp
id|crtc
comma
id|var
)paren
suffix:semicolon
id|var-&gt;pixclock
op_assign
id|par-&gt;pll_ops
op_member_access_from_pointer
id|pll_to_var
c_func
(paren
id|info
comma
op_amp
id|pll
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* In the display mode set code we need to make desisions depending on&n;&t; * wether the LCD or CRT monitor is enabled.&n;&t; * This is going to give problems in the unlikely case that someone&n;&t; * for example turns on the LCD monitor just after we tested what&n;&t; * monitors are enabled. Since the consequences are very serious&n;&t; * (the graphic card crashes and sends the wrong signals to the lcd&n;&t; *  monitor which gets brighter and brighter; to prevent it from&n;&t; * damage the computer must be switched off as soon as possible)&n;&t; * we need to prevent this.&n;&t; *&n;&t; * As far as I know there is no way to prevent people switching on the&n;&t; * LCD monitor while we are programming the video card. So the best way&n;&t; * to do it, is detect what monitors are enabled before programming the&n;&t; * video chip. After programming the video chip, we write this information&n;&t; * back to the video chip, switching the LCD off again if someone enabled&n;&t; * it. But isn&squot;t the card already crashed before we have the chance to&n;&t; * turn the display back off? I don&squot;t think so because the CRTC is disabled&n;&t; * while we program it.&n;&t; */
DECL|function|set_off_pitch
r_static
r_void
id|set_off_pitch
c_func
(paren
r_struct
id|atyfb_par
op_star
id|par
comma
r_const
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|u32
id|xoffset
op_assign
id|info-&gt;var.xoffset
suffix:semicolon
id|u32
id|yoffset
op_assign
id|info-&gt;var.yoffset
suffix:semicolon
id|u32
id|vxres
op_assign
id|info-&gt;var.xres_virtual
suffix:semicolon
id|u32
id|bpp
op_assign
id|info-&gt;var.bits_per_pixel
suffix:semicolon
id|par-&gt;crtc.off_pitch
op_assign
(paren
(paren
id|yoffset
op_star
id|vxres
op_plus
id|xoffset
)paren
op_star
id|bpp
op_div
l_int|64
)paren
op_or
(paren
id|vxres
op_lshift
l_int|19
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CRTC_OFF_PITCH
comma
id|par-&gt;crtc.off_pitch
comma
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Open/Release the frame buffer device&n;     */
DECL|function|atyfb_open
r_static
r_int
id|atyfb_open
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
macro_line|#ifdef __sparc__
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|user
)paren
(brace
id|par-&gt;open
op_increment
suffix:semicolon
id|par-&gt;mmaped
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|default_var
r_struct
id|fb_var_screeninfo
id|default_var
op_assign
(brace
multiline_comment|/* 640x480, 60 Hz, Non-Interlaced (25.175 MHz dotclock) */
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|480
comma
l_int|0
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|39722
comma
l_int|48
comma
l_int|16
comma
l_int|33
comma
l_int|10
comma
l_int|96
comma
l_int|2
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
DECL|function|atyfb_release
r_static
r_int
id|atyfb_release
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
macro_line|#ifdef __sparc__
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|user
)paren
(brace
id|par-&gt;open
op_decrement
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|wait_for_idle
c_func
(paren
id|par
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|par-&gt;open
)paren
(brace
r_int
id|was_mmaped
op_assign
id|par-&gt;mmaped
suffix:semicolon
id|par-&gt;mmaped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|was_mmaped
)paren
(brace
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
multiline_comment|/* Now reset the default display config, we have no&n;&t;&t;&t;&t; * idea what the program(s) which mmap&squot;d the chip did&n;&t;&t;&t;&t; * to the configuration, nor whether it restored it&n;&t;&t;&t;&t; * correctly.&n;&t;&t;&t;&t; */
id|var
op_assign
id|default_var
suffix:semicolon
r_if
c_cond
(paren
id|noaccel
)paren
id|var.accel_flags
op_and_assign
op_complement
id|FB_ACCELF_TEXT
suffix:semicolon
r_else
id|var.accel_flags
op_or_assign
id|FB_ACCELF_TEXT
suffix:semicolon
r_if
c_cond
(paren
id|var.yres
op_eq
id|var.yres_virtual
)paren
(brace
id|u32
id|vram
op_assign
(paren
id|info-&gt;fix.smem_len
op_minus
(paren
id|PAGE_SIZE
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|var.yres_virtual
op_assign
(paren
(paren
id|vram
op_star
l_int|8
)paren
op_div
id|var.bits_per_pixel
)paren
op_div
id|var.xres_virtual
suffix:semicolon
r_if
c_cond
(paren
id|var.yres_virtual
OL
id|var.yres
)paren
id|var.yres_virtual
op_assign
id|var.yres
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#endif
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Pan or Wrap the Display&n;     *&n;     *  This call looks only at xoffset, yoffset and the FB_VMODE_YWRAP flag&n;     */
DECL|function|atyfb_pan_display
r_static
r_int
id|atyfb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|xres
comma
id|yres
comma
id|xoffset
comma
id|yoffset
suffix:semicolon
id|xres
op_assign
(paren
(paren
(paren
id|par-&gt;crtc.h_tot_disp
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
op_plus
l_int|1
)paren
op_star
l_int|8
suffix:semicolon
id|yres
op_assign
(paren
(paren
id|par-&gt;crtc.v_tot_disp
op_rshift
l_int|16
)paren
op_amp
l_int|0x7ff
)paren
op_plus
l_int|1
suffix:semicolon
id|xoffset
op_assign
(paren
id|var-&gt;xoffset
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
suffix:semicolon
id|yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
id|xoffset
op_plus
id|xres
OG
id|info-&gt;var.xres_virtual
op_logical_or
id|yoffset
op_plus
id|yres
OG
id|info-&gt;var.yres_virtual
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info-&gt;var.xoffset
op_assign
id|xoffset
suffix:semicolon
id|info-&gt;var.yoffset
op_assign
id|yoffset
suffix:semicolon
id|set_off_pitch
c_func
(paren
id|par
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
DECL|macro|ATYIO_CLKR
mdefine_line|#define ATYIO_CLKR&t;&t;0x41545900&t;/* ATY&bslash;00 */
DECL|macro|ATYIO_CLKW
mdefine_line|#define ATYIO_CLKW&t;&t;0x41545901&t;/* ATY&bslash;01 */
DECL|struct|atyclk
r_struct
id|atyclk
(brace
DECL|member|ref_clk_per
id|u32
id|ref_clk_per
suffix:semicolon
DECL|member|pll_ref_div
id|u8
id|pll_ref_div
suffix:semicolon
DECL|member|mclk_fb_div
id|u8
id|mclk_fb_div
suffix:semicolon
DECL|member|mclk_post_div
id|u8
id|mclk_post_div
suffix:semicolon
multiline_comment|/* 1,2,3,4,8 */
DECL|member|vclk_fb_div
id|u8
id|vclk_fb_div
suffix:semicolon
DECL|member|vclk_post_div
id|u8
id|vclk_post_div
suffix:semicolon
multiline_comment|/* 1,2,3,4,6,8,12 */
DECL|member|dsp_xclks_per_row
id|u32
id|dsp_xclks_per_row
suffix:semicolon
multiline_comment|/* 0-16383 */
DECL|member|dsp_loop_latency
id|u32
id|dsp_loop_latency
suffix:semicolon
multiline_comment|/* 0-15 */
DECL|member|dsp_precision
id|u32
id|dsp_precision
suffix:semicolon
multiline_comment|/* 0-7 */
DECL|member|dsp_on
id|u32
id|dsp_on
suffix:semicolon
multiline_comment|/* 0-2047 */
DECL|member|dsp_off
id|u32
id|dsp_off
suffix:semicolon
multiline_comment|/* 0-2047 */
)brace
suffix:semicolon
DECL|macro|ATYIO_FEATR
mdefine_line|#define ATYIO_FEATR&t;&t;0x41545902&t;/* ATY&bslash;02 */
DECL|macro|ATYIO_FEATW
mdefine_line|#define ATYIO_FEATW&t;&t;0x41545903&t;/* ATY&bslash;03 */
macro_line|#endif
DECL|function|atyfb_ioctl
r_static
r_int
id|atyfb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
macro_line|#if defined(__sparc__) || (defined(DEBUG) &amp;&amp; defined(CONFIG_FB_ATY_CT))
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* __sparc__ || DEBUG */
macro_line|#ifdef __sparc__
r_struct
id|fbtype
id|fbtyp
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|cmd
)paren
(brace
macro_line|#ifdef __sparc__
r_case
id|FBIOGTYPE
suffix:colon
id|fbtyp.fb_type
op_assign
id|FBTYPE_PCI_GENERIC
suffix:semicolon
id|fbtyp.fb_width
op_assign
id|info-&gt;var.xres_virtual
suffix:semicolon
id|fbtyp.fb_height
op_assign
id|info-&gt;var.yres_virtual
suffix:semicolon
id|fbtyp.fb_depth
op_assign
id|info-&gt;var.bits_per_pixel
suffix:semicolon
id|fbtyp.fb_cmsize
op_assign
id|info-&gt;cmap.len
suffix:semicolon
id|fbtyp.fb_size
op_assign
id|info-&gt;fix.smem_len
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
(paren
r_struct
id|fbtype
op_star
)paren
id|arg
comma
op_amp
id|fbtyp
comma
r_sizeof
(paren
id|fbtyp
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* __sparc__ */
macro_line|#if defined(DEBUG) &amp;&amp; defined(CONFIG_FB_ATY_CT)
r_case
id|ATYIO_CLKR
suffix:colon
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|INTEGRATED
)paren
)paren
(brace
r_struct
id|atyclk
id|clk
suffix:semicolon
r_union
id|aty_pll
op_star
id|pll
op_assign
op_amp
(paren
id|par-&gt;pll
)paren
suffix:semicolon
id|u32
id|dsp_config
op_assign
id|pll-&gt;ct.dsp_config
suffix:semicolon
id|u32
id|dsp_on_off
op_assign
id|pll-&gt;ct.dsp_on_off
suffix:semicolon
id|clk.ref_clk_per
op_assign
id|par-&gt;ref_clk_per
suffix:semicolon
id|clk.pll_ref_div
op_assign
id|par-&gt;pll_ref_div
suffix:semicolon
id|clk.mclk_fb_div
op_assign
id|par-&gt;mclk_fb_div
suffix:semicolon
multiline_comment|/* clk.mclk_post_div = pll-&gt;ct.mclk_post_div_real; */
id|clk.vclk_fb_div
op_assign
id|pll-&gt;ct.vclk_fb_div
suffix:semicolon
id|clk.vclk_post_div
op_assign
id|pll-&gt;ct.vclk_post_div_real
suffix:semicolon
id|clk.dsp_xclks_per_row
op_assign
id|dsp_config
op_amp
l_int|0x3fff
suffix:semicolon
id|clk.dsp_loop_latency
op_assign
(paren
id|dsp_config
op_rshift
l_int|16
)paren
op_amp
l_int|0xf
suffix:semicolon
id|clk.dsp_precision
op_assign
(paren
id|dsp_config
op_rshift
l_int|20
)paren
op_amp
l_int|7
suffix:semicolon
id|clk.dsp_on
op_assign
id|dsp_on_off
op_amp
l_int|0x7ff
suffix:semicolon
id|clk.dsp_off
op_assign
(paren
id|dsp_on_off
op_rshift
l_int|16
)paren
op_amp
l_int|0x7ff
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
(paren
r_struct
id|atyclk
op_star
)paren
id|arg
comma
op_amp
id|clk
comma
r_sizeof
(paren
id|clk
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATYIO_CLKW
suffix:colon
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|INTEGRATED
)paren
)paren
(brace
r_struct
id|atyclk
id|clk
suffix:semicolon
r_union
id|aty_pll
op_star
id|pll
op_assign
op_amp
(paren
id|par-&gt;pll
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|clk
comma
(paren
r_struct
id|atyclk
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|clk
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|par-&gt;ref_clk_per
op_assign
id|clk.ref_clk_per
suffix:semicolon
id|par-&gt;pll_ref_div
op_assign
id|clk.pll_ref_div
suffix:semicolon
id|par-&gt;mclk_fb_div
op_assign
id|clk.mclk_fb_div
suffix:semicolon
multiline_comment|/* pll-&gt;ct.mclk_post_div_real = clk.mclk_post_div; */
id|pll-&gt;ct.vclk_fb_div
op_assign
id|clk.vclk_fb_div
suffix:semicolon
id|pll-&gt;ct.vclk_post_div_real
op_assign
id|clk.vclk_post_div
suffix:semicolon
id|pll-&gt;ct.dsp_config
op_assign
(paren
id|clk
dot
id|dsp_xclks_per_row
op_amp
l_int|0x3fff
)paren
op_or
(paren
(paren
id|clk
dot
id|dsp_loop_latency
op_amp
l_int|0xf
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|clk.dsp_precision
op_amp
l_int|7
)paren
op_lshift
l_int|20
)paren
suffix:semicolon
id|pll-&gt;ct.dsp_on_off
op_assign
(paren
id|clk
dot
id|dsp_on
op_amp
l_int|0x7ff
)paren
op_or
(paren
(paren
id|clk
dot
id|dsp_off
op_amp
l_int|0x7ff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* aty_calc_pll_ct(info, &amp;pll-&gt;ct); */
id|aty_set_pll_ct
c_func
(paren
id|info
comma
id|pll
)paren
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATYIO_FEATR
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|par-&gt;features
comma
(paren
id|u32
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATYIO_FEATW
suffix:colon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|par-&gt;features
comma
(paren
id|u32
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DEBUG &amp;&amp; CONFIG_FB_ATY_CT */
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|atyfb_sync
r_static
r_int
id|atyfb_sync
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;blitter_may_be_busy
)paren
id|wait_for_idle
c_func
(paren
id|par
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef __sparc__
DECL|function|atyfb_mmap
r_static
r_int
id|atyfb_mmap
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
r_int
id|size
comma
id|page
comma
id|map_size
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|map_offset
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|off
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|par-&gt;mmap_map
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_pgoff
OG
(paren
op_complement
l_int|0UL
op_rshift
id|PAGE_SHIFT
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|off
op_assign
id|vma-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
multiline_comment|/* To stop the swapper from even considering these pages. */
id|vma-&gt;vm_flags
op_or_assign
(paren
id|VM_SHM
op_or
id|VM_LOCKED
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|vma-&gt;vm_pgoff
op_eq
l_int|0
)paren
op_logical_and
(paren
id|size
op_eq
id|info-&gt;fix.smem_len
)paren
)paren
op_logical_or
(paren
(paren
id|off
op_eq
id|info-&gt;fix.smem_len
)paren
op_logical_and
(paren
id|size
op_eq
id|PAGE_SIZE
)paren
)paren
)paren
id|off
op_add_assign
l_int|0x8000000000000000UL
suffix:semicolon
id|vma-&gt;vm_pgoff
op_assign
id|off
op_rshift
id|PAGE_SHIFT
suffix:semicolon
multiline_comment|/* propagate off changes */
multiline_comment|/* Each page, see which map applies */
r_for
c_loop
(paren
id|page
op_assign
l_int|0
suffix:semicolon
id|page
OL
id|size
suffix:semicolon
)paren
(brace
id|map_size
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|par-&gt;mmap_map
(braket
id|i
)braket
dot
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|start
op_assign
id|par-&gt;mmap_map
(braket
id|i
)braket
dot
id|voff
suffix:semicolon
r_int
r_int
id|end
op_assign
id|start
op_plus
id|par-&gt;mmap_map
(braket
id|i
)braket
dot
id|size
suffix:semicolon
r_int
r_int
id|offset
op_assign
id|off
op_plus
id|page
suffix:semicolon
r_if
c_cond
(paren
id|start
OG
id|offset
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_ge
id|end
)paren
r_continue
suffix:semicolon
id|map_size
op_assign
id|par-&gt;mmap_map
(braket
id|i
)braket
dot
id|size
op_minus
(paren
id|offset
op_minus
id|start
)paren
suffix:semicolon
id|map_offset
op_assign
id|par-&gt;mmap_map
(braket
id|i
)braket
dot
id|poff
op_plus
(paren
id|offset
op_minus
id|start
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|map_size
)paren
(brace
id|page
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|page
op_plus
id|map_size
OG
id|size
)paren
id|map_size
op_assign
id|size
op_minus
id|page
suffix:semicolon
id|pgprot_val
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
op_and_assign
op_complement
(paren
id|par-&gt;mmap_map
(braket
id|i
)braket
dot
id|prot_mask
)paren
suffix:semicolon
id|pgprot_val
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
op_or_assign
id|par-&gt;mmap_map
(braket
id|i
)braket
dot
id|prot_flag
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma
comma
id|vma-&gt;vm_start
op_plus
id|page
comma
id|map_offset
comma
id|map_size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|page
op_add_assign
id|map_size
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|map_size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|vma-&gt;vm_flags
op_or_assign
id|VM_IO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|par-&gt;mmaped
)paren
id|par-&gt;mmaped
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
(brace
DECL|member|yoffset
id|u32
id|yoffset
suffix:semicolon
DECL|member|r
id|u8
id|r
(braket
l_int|2
)braket
(braket
l_int|256
)braket
suffix:semicolon
DECL|member|g
id|u8
id|g
(braket
l_int|2
)braket
(braket
l_int|256
)braket
suffix:semicolon
DECL|member|b
id|u8
id|b
(braket
l_int|2
)braket
(braket
l_int|256
)braket
suffix:semicolon
DECL|variable|atyfb_save
)brace
id|atyfb_save
suffix:semicolon
DECL|function|atyfb_save_palette
r_static
r_void
id|atyfb_save_palette
c_func
(paren
r_struct
id|atyfb_par
op_star
id|par
comma
r_int
id|enter
)paren
(brace
r_int
id|i
comma
id|tmp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp
op_assign
id|aty_ld_8
c_func
(paren
id|DAC_CNTL
comma
id|par
)paren
op_amp
l_int|0xfc
suffix:semicolon
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|EXTRA_BRIGHT
)paren
)paren
id|tmp
op_or_assign
l_int|0x2
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_CNTL
comma
id|tmp
comma
id|par
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_MASK
comma
l_int|0xff
comma
id|par
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|i
comma
op_amp
id|par-&gt;aty_cmap_regs-&gt;rindex
)paren
suffix:semicolon
id|atyfb_save.r
(braket
id|enter
)braket
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|atyfb_save.g
(braket
id|enter
)braket
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|atyfb_save.b
(braket
id|enter
)braket
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|i
comma
op_amp
id|par-&gt;aty_cmap_regs-&gt;windex
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|atyfb_save.r
(braket
l_int|1
op_minus
id|enter
)braket
(braket
id|i
)braket
comma
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|atyfb_save.g
(braket
l_int|1
op_minus
id|enter
)braket
(braket
id|i
)braket
comma
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|atyfb_save.b
(braket
l_int|1
op_minus
id|enter
)braket
(braket
id|i
)braket
comma
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
)paren
suffix:semicolon
)brace
)brace
DECL|function|atyfb_palette
r_static
r_void
id|atyfb_palette
c_func
(paren
r_int
id|enter
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FB_MAX
suffix:semicolon
id|i
op_increment
)paren
(brace
id|info
op_assign
id|registered_fb
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info
op_logical_and
id|info-&gt;fbops
op_eq
op_amp
id|atyfb_ops
op_logical_and
id|info-&gt;display_fg
op_logical_and
id|info-&gt;display_fg-&gt;vc_num
op_eq
id|i
)paren
(brace
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|atyfb_save_palette
c_func
(paren
id|par
comma
id|enter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enter
)paren
(brace
id|atyfb_save.yoffset
op_assign
id|info-&gt;var.yoffset
suffix:semicolon
id|info-&gt;var.yoffset
op_assign
l_int|0
suffix:semicolon
id|set_off_pitch
c_func
(paren
id|par
comma
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;var.yoffset
op_assign
id|atyfb_save.yoffset
suffix:semicolon
id|set_off_pitch
c_func
(paren
id|par
comma
id|info
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* __sparc__ */
macro_line|#ifdef CONFIG_PMAC_PBOOK
DECL|variable|first_display
r_static
r_struct
id|fb_info
op_star
id|first_display
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Power management routines. Those are used for PowerBook sleep.&n; *&n; * It appears that Rage LT and Rage LT Pro have different power&n; * management registers. There&squot;s is some confusion about which&n; * chipID is a Rage LT or LT pro :(&n; */
DECL|function|aty_power_mgmt_LT
r_static
r_int
id|aty_power_mgmt_LT
c_func
(paren
r_int
id|sleep
comma
r_struct
id|atyfb_par
op_star
id|par
)paren
(brace
r_int
r_int
id|pm
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|pm
op_assign
id|aty_ld_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
(paren
id|pm
op_amp
op_complement
id|PWR_MGT_MODE_MASK
)paren
op_or
id|PWR_MGT_MODE_REG
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|pm
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
id|aty_ld_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|par
)paren
suffix:semicolon
id|timeout
op_assign
l_int|200000
suffix:semicolon
r_if
c_cond
(paren
id|sleep
)paren
(brace
multiline_comment|/* Sleep */
id|pm
op_and_assign
op_complement
id|PWR_MGT_ON
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|pm
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
id|aty_ld_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|par
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pm
op_and_assign
op_complement
(paren
id|PWR_BLON
op_or
id|AUTO_PWR_UP
)paren
suffix:semicolon
id|pm
op_or_assign
id|SUSPEND_NOW
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|pm
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
id|aty_ld_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|par
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pm
op_or_assign
id|PWR_MGT_ON
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|pm
comma
id|par
)paren
suffix:semicolon
r_do
(brace
id|pm
op_assign
id|aty_ld_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|par
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_decrement
id|timeout
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|pm
op_amp
id|PWR_MGT_STATUS_MASK
)paren
op_ne
id|PWR_MGT_STATUS_SUSPEND
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Wakeup */
id|pm
op_and_assign
op_complement
id|PWR_MGT_ON
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|pm
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
id|aty_ld_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|par
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pm
op_or_assign
(paren
id|PWR_BLON
op_or
id|AUTO_PWR_UP
)paren
suffix:semicolon
id|pm
op_and_assign
op_complement
id|SUSPEND_NOW
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|pm
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
id|aty_ld_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|par
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pm
op_or_assign
id|PWR_MGT_ON
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|pm
comma
id|par
)paren
suffix:semicolon
r_do
(brace
id|pm
op_assign
id|aty_ld_le32
c_func
(paren
id|POWER_MANAGEMENT_LG
comma
id|par
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_decrement
id|timeout
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|pm
op_amp
id|PWR_MGT_STATUS_MASK
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
r_return
id|timeout
ques
c_cond
id|PBOOK_SLEEP_OK
suffix:colon
id|PBOOK_SLEEP_REFUSE
suffix:semicolon
)brace
DECL|function|aty_power_mgmt_LTPro
r_static
r_int
id|aty_power_mgmt_LTPro
c_func
(paren
r_int
id|sleep
comma
r_struct
id|atyfb_par
op_star
id|par
)paren
(brace
r_int
r_int
id|pm
suffix:semicolon
r_int
id|timeout
suffix:semicolon
id|pm
op_assign
id|aty_ld_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
(paren
id|pm
op_amp
op_complement
id|PWR_MGT_MODE_MASK
)paren
op_or
id|PWR_MGT_MODE_REG
suffix:semicolon
id|aty_st_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|pm
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
id|aty_ld_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|par
)paren
suffix:semicolon
id|timeout
op_assign
l_int|200
suffix:semicolon
r_if
c_cond
(paren
id|sleep
)paren
(brace
multiline_comment|/* Sleep */
id|pm
op_and_assign
op_complement
id|PWR_MGT_ON
suffix:semicolon
id|aty_st_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|pm
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
id|aty_ld_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|par
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pm
op_and_assign
op_complement
(paren
id|PWR_BLON
op_or
id|AUTO_PWR_UP
)paren
suffix:semicolon
id|pm
op_or_assign
id|SUSPEND_NOW
suffix:semicolon
id|aty_st_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|pm
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
id|aty_ld_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|par
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pm
op_or_assign
id|PWR_MGT_ON
suffix:semicolon
id|aty_st_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|pm
comma
id|par
)paren
suffix:semicolon
r_do
(brace
id|pm
op_assign
id|aty_ld_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|par
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_decrement
id|timeout
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|pm
op_amp
id|PWR_MGT_STATUS_MASK
)paren
op_ne
id|PWR_MGT_STATUS_SUSPEND
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Wakeup */
id|pm
op_and_assign
op_complement
id|PWR_MGT_ON
suffix:semicolon
id|aty_st_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|pm
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
id|aty_ld_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|par
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pm
op_and_assign
op_complement
id|SUSPEND_NOW
suffix:semicolon
id|pm
op_or_assign
(paren
id|PWR_BLON
op_or
id|AUTO_PWR_UP
)paren
suffix:semicolon
id|aty_st_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|pm
comma
id|par
)paren
suffix:semicolon
id|pm
op_assign
id|aty_ld_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|par
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pm
op_or_assign
id|PWR_MGT_ON
suffix:semicolon
id|aty_st_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|pm
comma
id|par
)paren
suffix:semicolon
r_do
(brace
id|pm
op_assign
id|aty_ld_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|par
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_decrement
id|timeout
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|pm
op_amp
id|PWR_MGT_STATUS_MASK
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|timeout
ques
c_cond
id|PBOOK_SLEEP_OK
suffix:colon
id|PBOOK_SLEEP_REFUSE
suffix:semicolon
)brace
DECL|function|aty_power_mgmt
r_static
r_int
id|aty_power_mgmt
c_func
(paren
r_int
id|sleep
comma
r_struct
id|atyfb_par
op_star
id|par
)paren
(brace
r_return
id|M64_HAS
c_func
(paren
id|LT_SLEEP
)paren
ques
c_cond
id|aty_power_mgmt_LT
c_func
(paren
id|sleep
comma
id|par
)paren
suffix:colon
id|aty_power_mgmt_LTPro
c_func
(paren
id|sleep
comma
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Save the contents of the frame buffer when we go to sleep,&n; * and restore it when we wake up again.&n; */
DECL|function|aty_sleep_notify
r_static
r_int
id|aty_sleep_notify
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
(brace
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_struct
id|atyfb_par
op_star
id|par
suffix:semicolon
r_int
id|result
suffix:semicolon
id|result
op_assign
id|PBOOK_SLEEP_OK
suffix:semicolon
r_for
c_loop
(paren
id|info
op_assign
id|first_display
suffix:semicolon
id|info
op_ne
l_int|NULL
suffix:semicolon
id|info
op_assign
id|par-&gt;next
)paren
(brace
r_int
id|nb
suffix:semicolon
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|nb
op_assign
id|info-&gt;var.yres
op_star
id|info-&gt;fix.line_length
suffix:semicolon
r_switch
c_cond
(paren
id|when
)paren
(brace
r_case
id|PBOOK_SLEEP_REQUEST
suffix:colon
id|par-&gt;save_framebuffer
op_assign
id|vmalloc
c_func
(paren
id|nb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;save_framebuffer
op_eq
l_int|NULL
)paren
r_return
id|PBOOK_SLEEP_REFUSE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PBOOK_SLEEP_REJECT
suffix:colon
r_if
c_cond
(paren
id|par-&gt;save_framebuffer
)paren
(brace
id|vfree
c_func
(paren
id|par-&gt;save_framebuffer
)paren
suffix:semicolon
id|par-&gt;save_framebuffer
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PBOOK_SLEEP_NOW
suffix:colon
r_if
c_cond
(paren
id|par-&gt;blitter_may_be_busy
)paren
id|wait_for_idle
c_func
(paren
id|par
)paren
suffix:semicolon
multiline_comment|/* Stop accel engine (stop bus mastering) */
r_if
c_cond
(paren
id|par-&gt;accel_flags
op_amp
id|FB_ACCELF_TEXT
)paren
id|aty_reset_engine
c_func
(paren
id|par
)paren
suffix:semicolon
multiline_comment|/* Backup fb content */
r_if
c_cond
(paren
id|par-&gt;save_framebuffer
)paren
id|memcpy_fromio
c_func
(paren
id|par-&gt;save_framebuffer
comma
(paren
r_void
op_star
)paren
id|info-&gt;screen_base
comma
id|nb
)paren
suffix:semicolon
multiline_comment|/* Blank display and LCD */
id|atyfb_blank
c_func
(paren
id|VESA_POWERDOWN
op_plus
l_int|1
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Set chip to &quot;suspend&quot; mode */
id|result
op_assign
id|aty_power_mgmt
c_func
(paren
l_int|1
comma
id|par
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PBOOK_WAKE
suffix:colon
multiline_comment|/* Wakeup chip */
id|result
op_assign
id|aty_power_mgmt
c_func
(paren
l_int|0
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* Restore fb content */
r_if
c_cond
(paren
id|par-&gt;save_framebuffer
)paren
(brace
id|memcpy_toio
c_func
(paren
(paren
r_void
op_star
)paren
id|info-&gt;screen_base
comma
id|par-&gt;save_framebuffer
comma
id|nb
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|par-&gt;save_framebuffer
)paren
suffix:semicolon
id|par-&gt;save_framebuffer
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Restore display */
id|atyfb_set_par
c_func
(paren
id|info
)paren
suffix:semicolon
id|atyfb_blank
c_func
(paren
l_int|0
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|variable|aty_sleep_notifier
r_static
r_struct
id|pmu_sleep_notifier
id|aty_sleep_notifier
op_assign
(brace
id|aty_sleep_notify
comma
id|SLEEP_LEVEL_VIDEO
comma
)brace
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_PMAC_PBOOK */
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
multiline_comment|/*&n;     *   LCD backlight control&n;     */
DECL|variable|backlight_conv
r_static
r_int
id|backlight_conv
(braket
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x3f
comma
l_int|0x4c
comma
l_int|0x59
comma
l_int|0x66
comma
l_int|0x73
comma
l_int|0x80
comma
l_int|0x8d
comma
l_int|0x9a
comma
l_int|0xa7
comma
l_int|0xb4
comma
l_int|0xc1
comma
l_int|0xcf
comma
l_int|0xdc
comma
l_int|0xe9
comma
l_int|0xff
)brace
suffix:semicolon
DECL|function|aty_set_backlight_enable
r_static
r_int
id|aty_set_backlight_enable
c_func
(paren
r_int
id|on
comma
r_int
id|level
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
(paren
r_struct
id|fb_info
op_star
)paren
id|data
suffix:semicolon
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
r_int
id|reg
op_assign
id|aty_ld_lcd
c_func
(paren
id|LCD_MISC_CNTL
comma
id|par
)paren
suffix:semicolon
id|reg
op_or_assign
(paren
id|BLMOD_EN
op_or
id|BIASMOD_EN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|on
op_logical_and
id|level
OG
id|BACKLIGHT_OFF
)paren
(brace
id|reg
op_and_assign
op_complement
id|BIAS_MOD_LEVEL_MASK
suffix:semicolon
id|reg
op_or_assign
(paren
id|backlight_conv
(braket
id|level
)braket
op_lshift
id|BIAS_MOD_LEVEL_SHIFT
)paren
suffix:semicolon
)brace
r_else
(brace
id|reg
op_and_assign
op_complement
id|BIAS_MOD_LEVEL_MASK
suffix:semicolon
id|reg
op_or_assign
(paren
id|backlight_conv
(braket
l_int|0
)braket
op_lshift
id|BIAS_MOD_LEVEL_SHIFT
)paren
suffix:semicolon
)brace
id|aty_st_lcd
c_func
(paren
id|LCD_MISC_CNTL
comma
id|reg
comma
id|par
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aty_set_backlight_level
r_static
r_int
id|aty_set_backlight_level
c_func
(paren
r_int
id|level
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|aty_set_backlight_enable
c_func
(paren
l_int|1
comma
id|level
comma
id|data
)paren
suffix:semicolon
)brace
DECL|variable|aty_backlight_controller
r_static
r_struct
id|backlight_controller
id|aty_backlight_controller
op_assign
(brace
id|aty_set_backlight_enable
comma
id|aty_set_backlight_level
)brace
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_PMAC_BACKLIGHT */
multiline_comment|/*&n;     *  Initialisation&n;     */
DECL|variable|fb_list
r_static
r_struct
id|fb_info
op_star
id|fb_list
op_assign
l_int|NULL
suffix:semicolon
DECL|function|aty_init
r_static
r_int
id|__init
id|aty_init
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_const
r_char
op_star
id|chipname
op_assign
l_int|NULL
comma
op_star
id|ramname
op_assign
l_int|NULL
comma
op_star
id|xtal
suffix:semicolon
r_int
id|j
comma
id|pll
comma
id|mclk
comma
id|xclk
comma
id|gtb_memsize
suffix:semicolon
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
id|u32
id|chip_id
comma
id|i
suffix:semicolon
id|u16
id|type
suffix:semicolon
id|u8
id|rev
suffix:semicolon
macro_line|#if defined(CONFIG_PPC)
r_int
id|sense
suffix:semicolon
macro_line|#endif
id|u8
id|pll_ref_div
suffix:semicolon
id|par-&gt;aty_cmap_regs
op_assign
(paren
r_struct
id|aty_cmap_regs
op_star
)paren
(paren
id|par-&gt;ati_regbase
op_plus
l_int|0xc0
)paren
suffix:semicolon
id|chip_id
op_assign
id|aty_ld_le32
c_func
(paren
id|CONFIG_CHIP_ID
comma
id|par
)paren
suffix:semicolon
id|type
op_assign
id|chip_id
op_amp
id|CFG_CHIP_TYPE
suffix:semicolon
id|rev
op_assign
(paren
id|chip_id
op_amp
id|CFG_CHIP_REV
)paren
op_rshift
l_int|24
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
r_sizeof
(paren
id|aty_chips
)paren
op_div
r_sizeof
(paren
op_star
id|aty_chips
)paren
)paren
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|type
op_eq
id|aty_chips
(braket
id|j
)braket
dot
id|chip_type
op_logical_and
(paren
id|rev
op_amp
id|aty_chips
(braket
id|j
)braket
dot
id|rev_mask
)paren
op_eq
id|aty_chips
(braket
id|j
)braket
dot
id|rev_val
)paren
(brace
id|chipname
op_assign
id|aty_chips
(braket
id|j
)braket
dot
id|name
suffix:semicolon
id|pll
op_assign
id|aty_chips
(braket
id|j
)braket
dot
id|pll
suffix:semicolon
id|mclk
op_assign
id|aty_chips
(braket
id|j
)braket
dot
id|mclk
suffix:semicolon
id|xclk
op_assign
id|aty_chips
(braket
id|j
)braket
dot
id|xclk
suffix:semicolon
id|par-&gt;features
op_assign
id|aty_chips
(braket
id|j
)braket
dot
id|features
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;atyfb: Unknown mach64 0x%04x rev 0x%04x&bslash;n&quot;
comma
id|type
comma
id|rev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|found
suffix:colon
id|printk
c_func
(paren
l_string|&quot;atyfb: %s [0x%04x rev 0x%02x] &quot;
comma
id|chipname
comma
id|type
comma
id|rev
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB_ATY_GX
r_if
c_cond
(paren
op_logical_neg
id|M64_HAS
c_func
(paren
id|INTEGRATED
)paren
)paren
(brace
id|u32
id|stat0
suffix:semicolon
id|u8
id|dac_type
comma
id|dac_subtype
comma
id|clk_type
suffix:semicolon
id|stat0
op_assign
id|aty_ld_le32
c_func
(paren
id|CONFIG_STAT0
comma
id|par
)paren
suffix:semicolon
id|par-&gt;bus_type
op_assign
(paren
id|stat0
op_rshift
l_int|0
)paren
op_amp
l_int|0x07
suffix:semicolon
id|par-&gt;ram_type
op_assign
(paren
id|stat0
op_rshift
l_int|3
)paren
op_amp
l_int|0x07
suffix:semicolon
id|ramname
op_assign
id|aty_gx_ram
(braket
id|par-&gt;ram_type
)braket
suffix:semicolon
multiline_comment|/* FIXME: clockchip/RAMDAC probing? */
id|dac_type
op_assign
(paren
id|aty_ld_le32
c_func
(paren
id|DAC_CNTL
comma
id|par
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x07
suffix:semicolon
macro_line|#ifdef CONFIG_ATARI
id|clk_type
op_assign
id|CLK_ATI18818_1
suffix:semicolon
id|dac_type
op_assign
(paren
id|stat0
op_rshift
l_int|9
)paren
op_amp
l_int|0x07
suffix:semicolon
r_if
c_cond
(paren
id|dac_type
op_eq
l_int|0x07
)paren
id|dac_subtype
op_assign
id|DAC_ATT20C408
suffix:semicolon
r_else
id|dac_subtype
op_assign
(paren
id|aty_ld_8
c_func
(paren
id|SCRATCH_REG1
op_plus
l_int|1
comma
id|par
)paren
op_amp
l_int|0xF0
)paren
op_or
id|dac_type
suffix:semicolon
macro_line|#else
id|dac_type
op_assign
id|DAC_IBMRGB514
suffix:semicolon
id|dac_subtype
op_assign
id|DAC_IBMRGB514
suffix:semicolon
id|clk_type
op_assign
id|CLK_IBMRGB514
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|dac_subtype
)paren
(brace
r_case
id|DAC_IBMRGB514
suffix:colon
id|par-&gt;dac_ops
op_assign
op_amp
id|aty_dac_ibm514
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DAC_ATI68860_B
suffix:colon
r_case
id|DAC_ATI68860_C
suffix:colon
id|par-&gt;dac_ops
op_assign
op_amp
id|aty_dac_ati68860b
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DAC_ATT20C408
suffix:colon
r_case
id|DAC_ATT21C498
suffix:colon
id|par-&gt;dac_ops
op_assign
op_amp
id|aty_dac_att21c498
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot; atyfb_set_par: DAC type not implemented yet!&bslash;n&quot;
)paren
suffix:semicolon
id|par-&gt;dac_ops
op_assign
op_amp
id|aty_dac_unsupported
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|clk_type
)paren
(brace
r_case
id|CLK_ATI18818_1
suffix:colon
id|par-&gt;pll_ops
op_assign
op_amp
id|aty_pll_ati18818_1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLK_STG1703
suffix:colon
id|par-&gt;pll_ops
op_assign
op_amp
id|aty_pll_stg1703
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLK_CH8398
suffix:colon
id|par-&gt;pll_ops
op_assign
op_amp
id|aty_pll_ch8398
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLK_ATT20C408
suffix:colon
id|par-&gt;pll_ops
op_assign
op_amp
id|aty_pll_att20c408
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLK_IBMRGB514
suffix:colon
id|par-&gt;pll_ops
op_assign
op_amp
id|aty_pll_ibm514
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot; atyfb_set_par: CLK type not implemented yet!&quot;
)paren
suffix:semicolon
id|par-&gt;pll_ops
op_assign
op_amp
id|aty_pll_unsupported
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_FB_ATY_GX */
macro_line|#ifdef CONFIG_FB_ATY_CT
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|INTEGRATED
)paren
)paren
(brace
id|par-&gt;bus_type
op_assign
id|PCI
suffix:semicolon
id|par-&gt;ram_type
op_assign
(paren
id|aty_ld_le32
c_func
(paren
id|CONFIG_STAT0
comma
id|par
)paren
op_amp
l_int|0x07
)paren
suffix:semicolon
id|ramname
op_assign
id|aty_ct_ram
(braket
id|par-&gt;ram_type
)braket
suffix:semicolon
id|par-&gt;dac_ops
op_assign
op_amp
id|aty_dac_ct
suffix:semicolon
id|par-&gt;pll_ops
op_assign
op_amp
id|aty_pll_ct
suffix:semicolon
multiline_comment|/* for many chips, the mclk is 67 MHz for SDRAM, 63 MHz otherwise */
r_if
c_cond
(paren
id|xclk
op_eq
l_int|67
op_logical_and
id|par-&gt;ram_type
OL
id|SDRAM
)paren
id|xclk
op_assign
l_int|63
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_FB_ATY_CT */
id|par-&gt;ref_clk_per
op_assign
l_int|1000000000000ULL
op_div
l_int|14318180
suffix:semicolon
id|xtal
op_assign
l_string|&quot;14.31818&quot;
suffix:semicolon
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|GTB_DSP
)paren
op_logical_and
(paren
id|pll_ref_div
op_assign
id|aty_ld_pll
c_func
(paren
id|PLL_REF_DIV
comma
id|par
)paren
)paren
)paren
(brace
r_int
id|diff1
comma
id|diff2
suffix:semicolon
id|diff1
op_assign
l_int|510
op_star
l_int|14
op_div
id|pll_ref_div
op_minus
id|pll
suffix:semicolon
id|diff2
op_assign
l_int|510
op_star
l_int|29
op_div
id|pll_ref_div
op_minus
id|pll
suffix:semicolon
r_if
c_cond
(paren
id|diff1
OL
l_int|0
)paren
id|diff1
op_assign
op_minus
id|diff1
suffix:semicolon
r_if
c_cond
(paren
id|diff2
OL
l_int|0
)paren
id|diff2
op_assign
op_minus
id|diff2
suffix:semicolon
r_if
c_cond
(paren
id|diff2
OL
id|diff1
)paren
(brace
id|par-&gt;ref_clk_per
op_assign
l_int|1000000000000ULL
op_div
l_int|29498928
suffix:semicolon
id|xtal
op_assign
l_string|&quot;29.498928&quot;
suffix:semicolon
)brace
)brace
id|i
op_assign
id|aty_ld_le32
c_func
(paren
id|MEM_CNTL
comma
id|par
)paren
suffix:semicolon
id|gtb_memsize
op_assign
id|M64_HAS
c_func
(paren
id|GTB_DSP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gtb_memsize
)paren
r_switch
c_cond
(paren
id|i
op_amp
l_int|0xF
)paren
(brace
multiline_comment|/* 0xF used instead of MEM_SIZE_ALIAS */
r_case
id|MEM_SIZE_512K
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x80000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_1M
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x100000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_2M_GTB
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x200000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_4M_GTB
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x400000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_6M_GTB
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x600000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_8M_GTB
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x800000
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x80000
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|i
op_amp
id|MEM_SIZE_ALIAS
)paren
(brace
r_case
id|MEM_SIZE_512K
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x80000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_1M
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x100000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_2M
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x200000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_4M
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x400000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_6M
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x600000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_8M
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x800000
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|info-&gt;fix.smem_len
op_assign
l_int|0x80000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|MAGIC_VRAM_SIZE
)paren
)paren
(brace
r_if
c_cond
(paren
id|aty_ld_le32
c_func
(paren
id|CONFIG_STAT1
comma
id|par
)paren
op_amp
l_int|0x40000000
)paren
id|info-&gt;fix.smem_len
op_add_assign
l_int|0x400000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|default_vram
)paren
(brace
id|info-&gt;fix.smem_len
op_assign
id|default_vram
op_star
l_int|1024
suffix:semicolon
id|i
op_assign
id|i
op_amp
op_complement
(paren
id|gtb_memsize
ques
c_cond
l_int|0xF
suffix:colon
id|MEM_SIZE_ALIAS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;fix.smem_len
op_le
l_int|0x80000
)paren
id|i
op_or_assign
id|MEM_SIZE_512K
suffix:semicolon
r_else
r_if
c_cond
(paren
id|info-&gt;fix.smem_len
op_le
l_int|0x100000
)paren
id|i
op_or_assign
id|MEM_SIZE_1M
suffix:semicolon
r_else
r_if
c_cond
(paren
id|info-&gt;fix.smem_len
op_le
l_int|0x200000
)paren
id|i
op_or_assign
id|gtb_memsize
ques
c_cond
id|MEM_SIZE_2M_GTB
suffix:colon
id|MEM_SIZE_2M
suffix:semicolon
r_else
r_if
c_cond
(paren
id|info-&gt;fix.smem_len
op_le
l_int|0x400000
)paren
id|i
op_or_assign
id|gtb_memsize
ques
c_cond
id|MEM_SIZE_4M_GTB
suffix:colon
id|MEM_SIZE_4M
suffix:semicolon
r_else
r_if
c_cond
(paren
id|info-&gt;fix.smem_len
op_le
l_int|0x600000
)paren
id|i
op_or_assign
id|gtb_memsize
ques
c_cond
id|MEM_SIZE_6M_GTB
suffix:colon
id|MEM_SIZE_6M
suffix:semicolon
r_else
id|i
op_or_assign
id|gtb_memsize
ques
c_cond
id|MEM_SIZE_8M_GTB
suffix:colon
id|MEM_SIZE_8M
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|MEM_CNTL
comma
id|i
comma
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Reg Block 0 (CT-compatible block) is at mmio_start &n;&t; *  Reg Block 1 (multimedia extensions) is at mmio_start - 0x400&n;&t; */
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|GX
)paren
)paren
(brace
id|info-&gt;fix.mmio_len
op_assign
l_int|0x400
suffix:semicolon
id|info-&gt;fix.accel
op_assign
id|FB_ACCEL_ATI_MACH64GX
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|CT
)paren
)paren
(brace
id|info-&gt;fix.mmio_len
op_assign
l_int|0x400
suffix:semicolon
id|info-&gt;fix.accel
op_assign
id|FB_ACCEL_ATI_MACH64CT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|VT
)paren
)paren
(brace
id|info-&gt;fix.mmio_start
op_assign
op_minus
l_int|0x400
suffix:semicolon
id|info-&gt;fix.mmio_len
op_assign
l_int|0x800
suffix:semicolon
id|info-&gt;fix.accel
op_assign
id|FB_ACCEL_ATI_MACH64VT
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* if (M64_HAS(GT)) */
id|info-&gt;fix.mmio_start
op_assign
op_minus
l_int|0x400
suffix:semicolon
id|info-&gt;fix.mmio_len
op_assign
l_int|0x800
suffix:semicolon
id|info-&gt;fix.accel
op_assign
id|FB_ACCEL_ATI_MACH64GT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|default_pll
)paren
id|pll
op_assign
id|default_pll
suffix:semicolon
r_if
c_cond
(paren
id|default_mclk
)paren
id|mclk
op_assign
id|default_mclk
suffix:semicolon
r_if
c_cond
(paren
id|default_xclk
)paren
id|xclk
op_assign
id|default_xclk
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d%c %s, %s MHz XTAL, %d MHz PLL, %d Mhz MCLK, %d Mhz XCLK&bslash;n&quot;
comma
id|info-&gt;fix.smem_len
op_eq
l_int|0x80000
ques
c_cond
l_int|512
suffix:colon
(paren
id|info-&gt;fix.smem_len
op_rshift
l_int|20
)paren
comma
id|info-&gt;fix.smem_len
op_eq
l_int|0x80000
ques
c_cond
l_char|&squot;K&squot;
suffix:colon
l_char|&squot;M&squot;
comma
id|ramname
comma
id|xtal
comma
id|pll
comma
id|mclk
comma
id|xclk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xclk
OL
l_int|44
)paren
id|par-&gt;mem_refresh_rate
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 000 = 10 Mhz - 43 Mhz */
r_else
r_if
c_cond
(paren
id|xclk
OL
l_int|50
)paren
id|par-&gt;mem_refresh_rate
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 001 = 44 Mhz - 49 Mhz */
r_else
r_if
c_cond
(paren
id|xclk
OL
l_int|55
)paren
id|par-&gt;mem_refresh_rate
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* 010 = 50 Mhz - 54 Mhz */
r_else
r_if
c_cond
(paren
id|xclk
OL
l_int|66
)paren
id|par-&gt;mem_refresh_rate
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* 011 = 55 Mhz - 65 Mhz */
r_else
r_if
c_cond
(paren
id|xclk
OL
l_int|75
)paren
id|par-&gt;mem_refresh_rate
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* 100 = 66 Mhz - 74 Mhz */
r_else
r_if
c_cond
(paren
id|xclk
OL
l_int|80
)paren
id|par-&gt;mem_refresh_rate
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* 101 = 75 Mhz - 79 Mhz */
r_else
r_if
c_cond
(paren
id|xclk
OL
l_int|100
)paren
id|par-&gt;mem_refresh_rate
op_assign
l_int|6
suffix:semicolon
multiline_comment|/* 110 = 80 Mhz - 100 Mhz */
r_else
id|par-&gt;mem_refresh_rate
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* 111 = 100 Mhz and above */
id|par-&gt;pll_per
op_assign
l_int|1000000
op_div
id|pll
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mclk
OL
l_int|0
)paren
op_logical_or
(paren
id|xclk
OL
l_int|0
)paren
)paren
(brace
id|par-&gt;mclk_per
op_assign
l_int|0
suffix:semicolon
id|par-&gt;xclk_per
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|par-&gt;mclk_per
op_assign
l_int|1000000
op_div
id|mclk
suffix:semicolon
id|par-&gt;xclk_per
op_assign
l_int|1000000
op_div
id|xclk
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|INTEGRATED
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BUS_CNTL DAC_CNTL MEM_CNTL EXT_MEM_CNTL CRTC_GEN_CNTL &quot;
l_string|&quot;DSP_CONFIG DSP_ON_OFF CLOCK_CNTL&bslash;n&quot;
l_string|&quot;%08x %08x %08x %08x     %08x      %08x   %08x   %08x&bslash;n&quot;
l_string|&quot;PLL&quot;
comma
id|aty_ld_le32
c_func
(paren
id|BUS_CNTL
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|DAC_CNTL
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|MEM_CNTL
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|EXT_MEM_CNTL
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|DSP_CONFIG
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|DSP_ON_OFF
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|CLOCK_CNTL
comma
id|par
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|aty_ld_pll
c_func
(paren
id|i
comma
id|par
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;vor init_pll&bslash;n&quot;
)paren
suffix:semicolon
id|par-&gt;pll_ops
op_member_access_from_pointer
id|init_pll
c_func
(paren
id|info
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;after init_pll&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|INTEGRATED
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BUS_CNTL DAC_CNTL MEM_CNTL EXT_MEM_CNTL CRTC_GEN_CNTL &quot;
l_string|&quot;DSP_CONFIG DSP_ON_OFF CLOCK_CNTL&bslash;n&quot;
l_string|&quot;%08x %08x %08x %08x     %08x      %08x   %08x   %08x&bslash;n&quot;
l_string|&quot;PLL&quot;
comma
id|aty_ld_le32
c_func
(paren
id|BUS_CNTL
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|DAC_CNTL
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|MEM_CNTL
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|EXT_MEM_CNTL
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|DSP_CONFIG
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|DSP_ON_OFF
comma
id|par
)paren
comma
id|aty_ld_le32
c_func
(paren
id|CLOCK_CNTL
comma
id|par
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|aty_ld_pll
c_func
(paren
id|i
comma
id|par
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; *  Last page of 8 MB (4 MB on ISA) aperture is MMIO&n;&t; *  FIXME: we should use the auxiliary aperture instead so we can access&n;&t; *  the full 8 MB of video RAM on 8 MB boards&n;&t; */
r_if
c_cond
(paren
id|info-&gt;fix.smem_len
op_eq
l_int|0x800000
op_logical_or
(paren
id|par-&gt;bus_type
op_eq
id|ISA
op_logical_and
id|info-&gt;fix.smem_len
op_eq
l_int|0x400000
)paren
)paren
id|info-&gt;fix.smem_len
op_sub_assign
id|GUI_RESERVE
suffix:semicolon
multiline_comment|/* Clear the video memory */
id|fb_memset
c_func
(paren
(paren
r_void
op_star
)paren
id|info-&gt;screen_base
comma
l_int|0
comma
id|info-&gt;fix.smem_len
)paren
suffix:semicolon
id|info-&gt;node
op_assign
id|NODEV
suffix:semicolon
id|info-&gt;fbops
op_assign
op_amp
id|atyfb_ops
suffix:semicolon
id|info-&gt;pseudo_palette
op_assign
id|pseudo_palette
suffix:semicolon
id|info-&gt;flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|G3_PB_1_1
)paren
op_logical_and
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerBook1,1&quot;
)paren
)paren
(brace
multiline_comment|/* these bits let the 101 powerbook wake up from sleep -- paulus */
id|aty_st_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|aty_ld_lcd
c_func
(paren
id|POWER_MANAGEMENT
comma
id|par
)paren
op_or
(paren
id|USE_F32KHZ
op_or
id|TRISTATE_MEM_EN
)paren
comma
id|par
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|MOBIL_BUS
)paren
)paren
id|register_backlight_controller
c_func
(paren
op_amp
id|aty_backlight_controller
comma
id|info
comma
l_string|&quot;ati&quot;
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_PMAC_BACKLIGHT */
macro_line|#ifdef MODULE
id|var
op_assign
id|default_var
suffix:semicolon
macro_line|#else&t;&t;&t;&t;/* !MODULE */
id|memset
c_func
(paren
op_amp
id|var
comma
l_int|0
comma
r_sizeof
(paren
id|var
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PPC
r_if
c_cond
(paren
id|_machine
op_eq
id|_MACH_Pmac
)paren
(brace
multiline_comment|/*&n;&t;&t; *  FIXME: The NVRAM stuff should be put in a Mac-specific file, as it&n;&t;&t; *         applies to all Mac video cards&n;&t;&t; */
r_if
c_cond
(paren
id|mode_option
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mac_find_mode
(paren
op_amp
id|var
comma
id|info
comma
id|mode_option
comma
l_int|8
)paren
)paren
id|var
op_assign
id|default_var
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|default_vmode
op_eq
id|VMODE_CHOOSE
)paren
(brace
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|G3_PB_1024x768
)paren
)paren
multiline_comment|/* G3 PowerBook with 1024x768 LCD */
id|default_vmode
op_assign
id|VMODE_1024_768_60
suffix:semicolon
r_else
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
l_string|&quot;iMac&quot;
)paren
)paren
id|default_vmode
op_assign
id|VMODE_1024_768_75
suffix:semicolon
r_else
r_if
c_cond
(paren
id|machine_is_compatible
(paren
l_string|&quot;PowerBook2,1&quot;
)paren
)paren
multiline_comment|/* iBook with 800x600 LCD */
id|default_vmode
op_assign
id|VMODE_800_600_60
suffix:semicolon
r_else
id|default_vmode
op_assign
id|VMODE_640_480_67
suffix:semicolon
id|sense
op_assign
id|read_aty_sense
c_func
(paren
id|par
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;atyfb: monitor sense=%x, mode %d&bslash;n&quot;
comma
id|sense
comma
id|mac_map_monitor_sense
c_func
(paren
id|sense
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|default_vmode
op_le
l_int|0
op_logical_or
id|default_vmode
OG
id|VMODE_MAX
)paren
id|default_vmode
op_assign
id|VMODE_640_480_60
suffix:semicolon
r_if
c_cond
(paren
id|default_cmode
template_param
id|CMODE_32
)paren
id|default_cmode
op_assign
id|CMODE_8
suffix:semicolon
r_if
c_cond
(paren
id|mac_vmode_to_var
(paren
id|default_vmode
comma
id|default_cmode
comma
op_amp
id|var
)paren
)paren
id|var
op_assign
id|default_var
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|fb_find_mode
(paren
op_amp
id|var
comma
id|info
comma
id|mode_option
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|8
)paren
)paren
id|var
op_assign
id|default_var
suffix:semicolon
macro_line|#else&t;&t;&t;&t;/* !CONFIG_PPC */
macro_line|#ifdef __sparc__
r_if
c_cond
(paren
id|mode_option
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fb_find_mode
c_func
(paren
op_amp
id|var
comma
id|info
comma
id|mode_option
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|8
)paren
)paren
id|var
op_assign
id|default_var
suffix:semicolon
)brace
r_else
id|var
op_assign
id|default_var
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
id|fb_find_mode
c_func
(paren
op_amp
id|var
comma
id|info
comma
id|mode_option
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|8
)paren
)paren
id|var
op_assign
id|default_var
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* !__sparc__ */
macro_line|#endif&t;&t;&t;&t;/* !CONFIG_PPC */
macro_line|#endif&t;&t;&t;&t;/* !MODULE */
r_if
c_cond
(paren
id|noaccel
)paren
id|var.accel_flags
op_and_assign
op_complement
id|FB_ACCELF_TEXT
suffix:semicolon
r_else
id|var.accel_flags
op_or_assign
id|FB_ACCELF_TEXT
suffix:semicolon
r_if
c_cond
(paren
id|var.yres
op_eq
id|var.yres_virtual
)paren
(brace
id|u32
id|vram
op_assign
(paren
id|info-&gt;fix.smem_len
op_minus
(paren
id|PAGE_SIZE
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|var.yres_virtual
op_assign
(paren
(paren
id|vram
op_star
l_int|8
)paren
op_div
id|var.bits_per_pixel
)paren
op_div
id|var.xres_virtual
suffix:semicolon
r_if
c_cond
(paren
id|var.yres_virtual
OL
id|var.yres
)paren
id|var.yres_virtual
op_assign
id|var.yres
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atyfb_check_var
c_func
(paren
op_amp
id|var
comma
id|info
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;atyfb: can&squot;t set default video mode&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef __sparc__
id|atyfb_save_palette
c_func
(paren
id|par
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FB_ATY_CT
r_if
c_cond
(paren
id|curblink
op_logical_and
id|M64_HAS
c_func
(paren
id|INTEGRATED
)paren
)paren
id|par-&gt;cursor
op_assign
id|aty_init_cursor
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_FB_ATY_CT */
id|info-&gt;var
op_assign
id|var
suffix:semicolon
id|fb_alloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
comma
l_int|256
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
id|info
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|fb_list
op_assign
id|info
suffix:semicolon
macro_line|#ifdef DEBUG
(brace
multiline_comment|/* dump non shadow CRTC, pll, LCD registers */
r_int
id|i
suffix:semicolon
id|u32
id|base
suffix:semicolon
multiline_comment|/* CRTC registers */
id|base
op_assign
l_int|0x2000
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Mach64 non-shadow register values:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_assign
id|i
op_plus
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n0x%04X: &quot;
comma
id|base
op_plus
id|i
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; %08X&quot;
comma
id|aty_ld_le32
c_func
(paren
id|i
comma
id|par
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* PLL registers */
id|base
op_assign
l_int|0x00
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Mach64 PLL register values:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|16
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n0x%02X: &quot;
comma
id|base
op_plus
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_mod
l_int|4
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%02X&quot;
comma
id|aty_ld_pll
c_func
(paren
id|i
comma
id|par
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
r_if
c_cond
(paren
id|par-&gt;lcd_table
op_ne
l_int|0
)paren
(brace
multiline_comment|/* LCD registers */
id|base
op_assign
l_int|0x00
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;LCD register values:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_mod
l_int|4
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n0x%02X: &quot;
comma
id|base
op_plus
id|i
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; %08X&quot;
comma
id|aty_ld_lcd
c_func
(paren
id|i
comma
id|par
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_FB_ATY_GENERIC_LCD */
)brace
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;fb%d: %s frame buffer device on %s&bslash;n&quot;
comma
id|minor
c_func
(paren
id|info-&gt;node
)paren
comma
id|info-&gt;fix.id
comma
id|name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|atyfb_init
r_int
id|__init
id|atyfb_init
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined(CONFIG_PCI)
r_int
r_int
id|addr
comma
id|res_start
comma
id|res_size
suffix:semicolon
r_struct
id|atyfb_par
op_star
id|default_par
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef __sparc__
r_extern
r_void
(paren
op_star
id|prom_palette
)paren
(paren
r_int
)paren
suffix:semicolon
r_extern
r_int
id|con_is_present
c_func
(paren
r_void
)paren
suffix:semicolon
r_struct
id|pcidev_cookie
op_star
id|pcp
suffix:semicolon
r_char
id|prop
(braket
l_int|128
)braket
suffix:semicolon
r_int
id|node
comma
id|len
comma
id|j
suffix:semicolon
id|u32
id|mem
comma
id|chip_id
suffix:semicolon
multiline_comment|/* Do not attach when we have a serial console. */
r_if
c_cond
(paren
op_logical_neg
id|con_is_present
c_func
(paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
macro_line|#else
id|u16
id|tmp
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_FB_ATY_GENERIC_LCD)
id|u16
id|lcd_ofs
suffix:semicolon
id|u32
id|driv_inf_tab
comma
id|sig
comma
id|rom_addr
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_ATI
comma
id|PCI_ANY_ID
comma
id|pdev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|pdev
op_member_access_from_pointer
r_class
op_rshift
l_int|16
)paren
op_eq
id|PCI_BASE_CLASS_DISPLAY
)paren
(brace
r_struct
id|resource
op_star
id|rp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
r_sizeof
(paren
id|aty_chips
)paren
op_div
r_sizeof
(paren
op_star
id|aty_chips
)paren
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|aty_chips
(braket
id|i
)braket
dot
id|pci_id
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_continue
suffix:semicolon
id|info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|fb_info
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;atyfb_init: can&squot;t alloc fb_info&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_info
)paren
)paren
suffix:semicolon
id|default_par
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|atyfb_par
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|default_par
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;atyfb_init: can&squot;t alloc atyfb_par&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|memset
c_func
(paren
id|default_par
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|atyfb_par
)paren
)paren
suffix:semicolon
id|info-&gt;fix
op_assign
id|atyfb_fix
suffix:semicolon
id|info-&gt;par
op_assign
id|default_par
suffix:semicolon
id|rp
op_assign
op_amp
id|pdev-&gt;resource
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|rp
op_assign
op_amp
id|pdev-&gt;resource
(braket
l_int|1
)braket
suffix:semicolon
id|addr
op_assign
id|rp-&gt;start
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_continue
suffix:semicolon
id|res_start
op_assign
id|rp-&gt;start
suffix:semicolon
id|res_size
op_assign
id|rp-&gt;end
op_minus
id|rp-&gt;start
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
(paren
id|res_start
comma
id|res_size
comma
l_string|&quot;atyfb&quot;
)paren
)paren
r_continue
suffix:semicolon
macro_line|#ifdef __sparc__
multiline_comment|/*&n;&t;&t;&t; * Map memory-mapped registers.&n;&t;&t;&t; */
id|default_par-&gt;ati_regbase
op_assign
id|addr
op_plus
l_int|0x7ffc00UL
suffix:semicolon
id|info-&gt;fix.mmio_start
op_assign
id|addr
op_plus
l_int|0x7ffc00UL
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Map in big-endian aperture.&n;&t;&t;&t; */
id|info-&gt;screen_base
op_assign
(paren
r_char
op_star
)paren
(paren
id|addr
op_plus
l_int|0x800000UL
)paren
suffix:semicolon
id|info-&gt;fix.smem_start
op_assign
id|addr
op_plus
l_int|0x800000UL
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Figure mmap addresses from PCI config space.&n;&t;&t;&t; * Split Framebuffer in big- and little-endian halfs.&n;&t;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
op_logical_and
id|pdev-&gt;resource
(braket
id|i
)braket
dot
id|start
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* nothing */
suffix:semicolon
id|j
op_assign
id|i
op_plus
l_int|4
suffix:semicolon
id|default_par-&gt;mmap_map
op_assign
id|kmalloc
c_func
(paren
id|j
op_star
r_sizeof
(paren
op_star
id|default_par-&gt;mmap_map
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|default_par-&gt;mmap_map
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;atyfb_init: can&squot;t alloc mmap_map&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|res_start
comma
id|res_size
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|memset
c_func
(paren
id|default_par-&gt;mmap_map
comma
l_int|0
comma
id|j
op_star
r_sizeof
(paren
op_star
id|default_par-&gt;mmap_map
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|2
suffix:semicolon
id|i
OL
l_int|6
op_logical_and
id|pdev-&gt;resource
(braket
id|i
)braket
dot
id|start
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|rp
op_assign
op_amp
id|pdev-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_int
id|io
comma
id|breg
op_assign
id|PCI_BASE_ADDRESS_0
op_plus
(paren
id|i
op_lshift
l_int|2
)paren
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
id|u32
id|size
comma
id|pbase
suffix:semicolon
id|base
op_assign
id|rp-&gt;start
suffix:semicolon
id|io
op_assign
(paren
id|rp-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
suffix:semicolon
id|size
op_assign
id|rp-&gt;end
op_minus
id|base
op_plus
l_int|1
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|breg
comma
op_amp
id|pbase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io
)paren
id|size
op_and_assign
op_complement
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Map the framebuffer a second time, this time without&n;&t;&t;&t;&t; * the braindead _PAGE_IE setting. This is used by the&n;&t;&t;&t;&t; * fixed Xserver, but we need to maintain the old mapping&n;&t;&t;&t;&t; * to stay compatible with older ones...&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|base
op_eq
id|addr
)paren
(brace
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|voff
op_assign
(paren
id|pbase
op_plus
l_int|0x10000000
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|poff
op_assign
id|base
op_amp
id|PAGE_MASK
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|size
op_assign
(paren
id|size
op_plus
op_complement
id|PAGE_MASK
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|prot_mask
op_assign
id|_PAGE_CACHE
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|prot_flag
op_assign
id|_PAGE_E
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t; * Here comes the old framebuffer mapping with _PAGE_IE&n;&t;&t;&t;&t; * set for the big endian half of the framebuffer...&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|base
op_eq
id|addr
)paren
(brace
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|voff
op_assign
(paren
id|pbase
op_plus
l_int|0x800000
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|poff
op_assign
(paren
id|base
op_plus
l_int|0x800000
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|size
op_assign
l_int|0x800000
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|prot_mask
op_assign
id|_PAGE_CACHE
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|prot_flag
op_assign
id|_PAGE_E
op_or
id|_PAGE_IE
suffix:semicolon
id|size
op_sub_assign
l_int|0x800000
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|voff
op_assign
id|pbase
op_amp
id|PAGE_MASK
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|poff
op_assign
id|base
op_amp
id|PAGE_MASK
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|size
op_assign
(paren
id|size
op_plus
op_complement
id|PAGE_MASK
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|prot_mask
op_assign
id|_PAGE_CACHE
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
id|j
)braket
dot
id|prot_flag
op_assign
id|_PAGE_E
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pdev-&gt;device
op_ne
id|XL_CHIP_ID
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Fix PROMs idea of MEM_CNTL settings...&n;&t;&t;&t;&t; */
id|mem
op_assign
id|aty_ld_le32
c_func
(paren
id|MEM_CNTL
comma
id|default_par
)paren
suffix:semicolon
id|chip_id
op_assign
id|aty_ld_le32
c_func
(paren
id|CONFIG_CHIP_ID
comma
id|default_par
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|chip_id
op_amp
id|CFG_CHIP_TYPE
)paren
op_eq
id|VT_CHIP_ID
)paren
op_logical_and
op_logical_neg
(paren
(paren
id|chip_id
op_rshift
l_int|24
)paren
op_amp
l_int|1
)paren
)paren
(brace
r_switch
c_cond
(paren
id|mem
op_amp
l_int|0x0f
)paren
(brace
r_case
l_int|3
suffix:colon
id|mem
op_assign
(paren
id|mem
op_amp
op_complement
(paren
l_int|0x0f
)paren
)paren
op_or
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|mem
op_assign
(paren
id|mem
op_amp
op_complement
(paren
l_int|0x0f
)paren
)paren
op_or
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|mem
op_assign
(paren
id|mem
op_amp
op_complement
(paren
l_int|0x0f
)paren
)paren
op_or
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
id|mem
op_assign
(paren
id|mem
op_amp
op_complement
(paren
l_int|0x0f
)paren
)paren
op_or
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|aty_ld_le32
c_func
(paren
id|CONFIG_STAT0
comma
id|default_par
)paren
op_amp
l_int|7
)paren
op_ge
id|SDRAM
)paren
id|mem
op_and_assign
op_complement
(paren
l_int|0x00700000
)paren
suffix:semicolon
)brace
id|mem
op_and_assign
op_complement
(paren
l_int|0xcf80e000
)paren
suffix:semicolon
multiline_comment|/* Turn off all undocumented bits. */
id|aty_st_le32
c_func
(paren
id|MEM_CNTL
comma
id|mem
comma
id|default_par
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * If this is the console device, we will set default video&n;&t;&t;&t; * settings to what the PROM left us with.&n;&t;&t;&t; */
id|node
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;aliases&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
)paren
(brace
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;screen&quot;
comma
id|prop
comma
r_sizeof
(paren
id|prop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|prop
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|node
op_assign
id|prom_finddevice
c_func
(paren
id|prop
)paren
suffix:semicolon
)brace
r_else
(brace
id|node
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
id|pcp-&gt;prom_node
)paren
(brace
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|default_var
suffix:semicolon
r_int
r_int
id|N
comma
id|P
comma
id|Q
comma
id|M
comma
id|T
comma
id|R
suffix:semicolon
id|u32
id|v_total
comma
id|h_total
suffix:semicolon
r_struct
id|crtc
id|crtc
suffix:semicolon
id|u8
id|pll_regs
(braket
l_int|16
)braket
suffix:semicolon
id|u8
id|clock_cntl
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|prom_getintdefault
c_func
(paren
id|node
comma
l_string|&quot;width&quot;
comma
l_int|1024
)paren
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|prom_getintdefault
c_func
(paren
id|node
comma
l_string|&quot;height&quot;
comma
l_int|768
)paren
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
id|prom_getintdefault
c_func
(paren
id|node
comma
l_string|&quot;depth&quot;
comma
l_int|8
)paren
suffix:semicolon
id|var-&gt;xoffset
op_assign
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
id|crtc.h_tot_disp
op_assign
id|aty_ld_le32
c_func
(paren
id|CRTC_H_TOTAL_DISP
comma
id|default_par
)paren
suffix:semicolon
id|crtc.h_sync_strt_wid
op_assign
id|aty_ld_le32
c_func
(paren
id|CRTC_H_SYNC_STRT_WID
comma
id|default_par
)paren
suffix:semicolon
id|crtc.v_tot_disp
op_assign
id|aty_ld_le32
c_func
(paren
id|CRTC_V_TOTAL_DISP
comma
id|default_par
)paren
suffix:semicolon
id|crtc.v_sync_strt_wid
op_assign
id|aty_ld_le32
c_func
(paren
id|CRTC_V_SYNC_STRT_WID
comma
id|default_par
)paren
suffix:semicolon
id|crtc.gen_cntl
op_assign
id|aty_ld_le32
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|default_par
)paren
suffix:semicolon
id|aty_crtc_to_var
c_func
(paren
op_amp
id|crtc
comma
id|var
)paren
suffix:semicolon
id|h_total
op_assign
id|var-&gt;xres
op_plus
id|var-&gt;right_margin
op_plus
id|var-&gt;hsync_len
op_plus
id|var-&gt;left_margin
suffix:semicolon
id|v_total
op_assign
id|var-&gt;yres
op_plus
id|var-&gt;lower_margin
op_plus
id|var-&gt;vsync_len
op_plus
id|var-&gt;upper_margin
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Read the PLL to figure actual Refresh Rate.&n;&t;&t;&t;&t; */
id|clock_cntl
op_assign
id|aty_ld_8
c_func
(paren
id|CLOCK_CNTL
comma
id|default_par
)paren
suffix:semicolon
multiline_comment|/* printk(&quot;atyfb: CLOCK_CNTL: %02x&bslash;n&quot;, clock_cntl); */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|pll_regs
(braket
id|i
)braket
op_assign
id|aty_ld_pll
c_func
(paren
id|i
comma
id|default_par
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * PLL Reference Divider M:&n;&t;&t;&t;&t; */
id|M
op_assign
id|pll_regs
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * PLL Feedback Divider N (Dependant on CLOCK_CNTL):&n;&t;&t;&t;&t; */
id|N
op_assign
id|pll_regs
(braket
l_int|7
op_plus
(paren
id|clock_cntl
op_amp
l_int|3
)paren
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * PLL Post Divider P (Dependant on CLOCK_CNTL):&n;&t;&t;&t;&t; */
id|P
op_assign
l_int|1
op_lshift
(paren
id|pll_regs
(braket
l_int|6
)braket
op_rshift
(paren
(paren
id|clock_cntl
op_amp
l_int|3
)paren
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * PLL Divider Q:&n;&t;&t;&t;&t; */
id|Q
op_assign
id|N
op_div
id|P
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Target Frequency:&n;&t;&t;&t;&t; *&n;&t;&t;&t;&t; *      T * M&n;&t;&t;&t;&t; * Q = -------&n;&t;&t;&t;&t; *      2 * R&n;&t;&t;&t;&t; *&n;&t;&t;&t;&t; * where R is XTALIN (= 14318 or 29498 kHz).&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|XL_CHIP_ID
)paren
id|R
op_assign
l_int|29498
suffix:semicolon
r_else
id|R
op_assign
l_int|14318
suffix:semicolon
id|T
op_assign
l_int|2
op_star
id|Q
op_star
id|R
op_div
id|M
suffix:semicolon
id|default_var.pixclock
op_assign
l_int|1000000000
op_div
id|T
suffix:semicolon
)brace
macro_line|#else&t;&t;&t;&t;/* __sparc__ */
id|info-&gt;fix.mmio_start
op_assign
l_int|0x7ff000
op_plus
id|addr
suffix:semicolon
id|default_par-&gt;ati_regbase
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|info-&gt;fix.mmio_start
comma
l_int|0x1000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|default_par-&gt;ati_regbase
)paren
(brace
id|kfree
c_func
(paren
id|default_par
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|res_start
comma
id|res_size
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|info-&gt;fix.mmio_start
op_add_assign
l_int|0xc00
suffix:semicolon
id|default_par-&gt;ati_regbase
op_add_assign
l_int|0xc00
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Enable memory-space accesses using config-space&n;&t;&t;&t; * command register.&n;&t;&t;&t; */
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp
op_amp
id|PCI_COMMAND_MEMORY
)paren
)paren
(brace
id|tmp
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
id|tmp
)paren
suffix:semicolon
)brace
macro_line|#ifdef __BIG_ENDIAN
multiline_comment|/* Use the big-endian aperture */
id|addr
op_add_assign
l_int|0x800000
suffix:semicolon
macro_line|#endif
multiline_comment|/* Map in frame buffer */
id|info-&gt;fix.smem_start
op_assign
id|addr
suffix:semicolon
id|info-&gt;screen_base
op_assign
(paren
r_char
op_star
)paren
id|ioremap
c_func
(paren
id|addr
comma
l_int|0x800000
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
multiline_comment|/* To support an LCD panel, we should know it&squot;s dimensions and&n;&t;       it&squot;s desired pixel clock.&n;&t;       There are two ways to do it:&n;&t;         - Check the startup video mode and calculate the panel&n;&t;&t;   size from it. This is unreliable.&n;&t;&t; - Read it from the driver information table in the video BIOS.&n;&n;&t;       So, we try to find a BIOS and get access to it.&n;&t;    */
id|rom_addr
op_assign
l_int|0xc0000
op_plus
(paren
(paren
id|aty_ld_le32
c_func
(paren
id|SCRATCH_REG1
comma
id|default_par
)paren
op_amp
l_int|0x7f
)paren
op_lshift
l_int|11
)paren
suffix:semicolon
id|default_par-&gt;bios_base_phys
op_assign
id|rom_addr
suffix:semicolon
id|default_par-&gt;bios_base
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|rom_addr
comma
l_int|0x10000
)paren
suffix:semicolon
multiline_comment|/* The BIOS starts with 0xaa55. */
r_if
c_cond
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
id|default_par-&gt;bios_base
)paren
op_eq
l_int|0xaa55
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;atyfb: Mach64 BIOS is located at %x, mapped at %x.&bslash;n&quot;
comma
(paren
id|u32
)paren
id|default_par-&gt;bios_base_phys
comma
(paren
id|u32
)paren
id|default_par-&gt;bios_base
)paren
suffix:semicolon
multiline_comment|/* Address of driver information table is at offset 0x78. */
id|driv_inf_tab
op_assign
id|default_par-&gt;bios_base
op_plus
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|default_par-&gt;bios_base
op_plus
l_int|0x78
)paren
)paren
suffix:semicolon
multiline_comment|/* Check for the driver information table signature. */
id|sig
op_assign
(paren
op_star
(paren
id|u32
op_star
)paren
id|driv_inf_tab
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sig
op_eq
l_int|0x54504c24
)paren
op_logical_or
multiline_comment|/* Rage LT pro */
(paren
id|sig
op_eq
l_int|0x544d5224
)paren
op_logical_or
multiline_comment|/* Rage mobility */
(paren
id|sig
op_eq
l_int|0x54435824
)paren
op_logical_or
multiline_comment|/* Rage XC */
(paren
id|sig
op_eq
l_int|0x544c5824
)paren
)paren
(brace
multiline_comment|/* Rage XL */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;atyfb: BIOS contains driver information table.&bslash;n&quot;
)paren
suffix:semicolon
id|lcd_ofs
op_assign
(paren
op_star
(paren
id|u16
op_star
)paren
(paren
id|driv_inf_tab
op_plus
l_int|10
)paren
)paren
suffix:semicolon
id|default_par-&gt;lcd_table
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lcd_ofs
op_ne
l_int|0
)paren
(brace
id|default_par-&gt;lcd_table
op_assign
id|default_par-&gt;bios_base
op_plus
id|lcd_ofs
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|default_par-&gt;lcd_table
op_ne
l_int|0
)paren
(brace
r_char
id|model
(braket
l_int|24
)braket
suffix:semicolon
r_char
id|strbuf
(braket
l_int|16
)braket
suffix:semicolon
r_char
id|refresh_rates_buf
(braket
l_int|100
)braket
suffix:semicolon
r_int
id|id
comma
id|tech
comma
id|f
comma
id|i
comma
id|m
comma
id|default_refresh_rate
suffix:semicolon
r_char
op_star
id|txtcolour
suffix:semicolon
r_char
op_star
id|txtmonitor
suffix:semicolon
r_char
op_star
id|txtdual
suffix:semicolon
r_char
op_star
id|txtformat
suffix:semicolon
id|u16
id|width
comma
id|height
comma
id|panel_type
comma
id|refresh_rates
suffix:semicolon
id|u16
op_star
id|lcdmodeptr
suffix:semicolon
id|u32
id|format
suffix:semicolon
id|u8
id|lcd_refresh_rates
(braket
l_int|16
)braket
op_assign
(brace
l_int|50
comma
l_int|56
comma
l_int|60
comma
l_int|67
comma
l_int|70
comma
l_int|72
comma
l_int|75
comma
l_int|76
comma
l_int|85
comma
l_int|90
comma
l_int|100
comma
l_int|120
comma
l_int|140
comma
l_int|150
comma
l_int|160
comma
l_int|200
)brace
suffix:semicolon
multiline_comment|/* The most important information is the panel size at&n;&t;&t;   offset 25 and 27, but there&squot;s some other nice information&n;&t;&t;   which we print to the screen.&n;&t;&t; */
id|id
op_assign
op_star
(paren
id|u8
op_star
)paren
id|default_par-&gt;lcd_table
suffix:semicolon
id|strncpy
c_func
(paren
id|model
comma
(paren
r_char
op_star
)paren
id|default_par-&gt;lcd_table
op_plus
l_int|1
comma
l_int|24
)paren
suffix:semicolon
id|model
(braket
l_int|23
)braket
op_assign
l_int|0
suffix:semicolon
id|width
op_assign
id|default_par-&gt;lcd_width
op_assign
op_star
(paren
id|u16
op_star
)paren
(paren
id|default_par-&gt;lcd_table
op_plus
l_int|25
)paren
suffix:semicolon
id|height
op_assign
id|default_par-&gt;lcd_height
op_assign
op_star
(paren
id|u16
op_star
)paren
(paren
id|default_par-&gt;lcd_table
op_plus
l_int|27
)paren
suffix:semicolon
id|panel_type
op_assign
op_star
(paren
id|u16
op_star
)paren
(paren
id|default_par-&gt;lcd_table
op_plus
l_int|29
)paren
suffix:semicolon
r_if
c_cond
(paren
id|panel_type
op_amp
l_int|1
)paren
id|txtcolour
op_assign
l_string|&quot;colour&quot;
suffix:semicolon
r_else
id|txtcolour
op_assign
l_string|&quot;monochrome&quot;
suffix:semicolon
r_if
c_cond
(paren
id|panel_type
op_amp
l_int|2
)paren
id|txtdual
op_assign
l_string|&quot;dual (split) &quot;
suffix:semicolon
r_else
id|txtdual
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|tech
op_assign
(paren
id|panel_type
op_rshift
l_int|2
)paren
op_amp
l_int|63
suffix:semicolon
r_switch
c_cond
(paren
id|tech
)paren
(brace
r_case
l_int|0
suffix:colon
id|txtmonitor
op_assign
l_string|&quot;passive matrix&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|txtmonitor
op_assign
l_string|&quot;active matrix&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|txtmonitor
op_assign
l_string|&quot;active addressed STN&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|txtmonitor
op_assign
l_string|&quot;EL&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|txtmonitor
op_assign
l_string|&quot;plasma&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|txtmonitor
op_assign
l_string|&quot;unknown&quot;
suffix:semicolon
)brace
id|format
op_assign
op_star
(paren
id|u32
op_star
)paren
(paren
id|default_par-&gt;lcd_table
op_plus
l_int|57
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tech
op_eq
l_int|0
op_logical_or
id|tech
op_eq
l_int|2
)paren
(brace
r_switch
c_cond
(paren
id|format
op_amp
l_int|7
)paren
(brace
r_case
l_int|0
suffix:colon
id|txtformat
op_assign
l_string|&quot;12 bit interface&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|txtformat
op_assign
l_string|&quot;16 bit interface&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|txtformat
op_assign
l_string|&quot;24 bit interface&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|txtformat
op_assign
l_string|&quot;unkown format&quot;
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|format
op_amp
l_int|7
)paren
(brace
r_case
l_int|0
suffix:colon
id|txtformat
op_assign
l_string|&quot;8 colours&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|txtformat
op_assign
l_string|&quot;512 colours&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|txtformat
op_assign
l_string|&quot;4096 colours&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|txtformat
op_assign
l_string|&quot;262144 colours (LT mode)&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|txtformat
op_assign
l_string|&quot;16777216 colours&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|txtformat
op_assign
l_string|&quot;262144 colours (FDPI-2 mode)&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|txtformat
op_assign
l_string|&quot;unkown format&quot;
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;atyfb: %s%s %s monitor detected: %s&bslash;n        id=%d, %dx%d pixels, %s&bslash;n&quot;
comma
id|txtdual
comma
id|txtcolour
comma
id|txtmonitor
comma
id|model
comma
id|id
comma
id|width
comma
id|height
comma
id|txtformat
)paren
suffix:semicolon
id|refresh_rates_buf
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|refresh_rates
op_assign
op_star
(paren
id|u16
op_star
)paren
(paren
id|default_par-&gt;lcd_table
op_plus
l_int|62
)paren
suffix:semicolon
id|m
op_assign
l_int|1
suffix:semicolon
id|f
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|refresh_rates
op_amp
id|m
)paren
(brace
r_if
c_cond
(paren
id|f
op_eq
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|strbuf
comma
l_string|&quot;%d&quot;
comma
id|lcd_refresh_rates
(braket
id|i
)braket
)paren
suffix:semicolon
id|f
op_increment
suffix:semicolon
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|strbuf
comma
l_string|&quot;,%d&quot;
comma
id|lcd_refresh_rates
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|strcat
c_func
(paren
id|refresh_rates_buf
comma
id|strbuf
)paren
suffix:semicolon
)brace
id|m
op_assign
id|m
op_lshift
l_int|1
suffix:semicolon
)brace
id|default_refresh_rate
op_assign
(paren
op_star
(paren
id|u8
op_star
)paren
(paren
id|default_par-&gt;lcd_table
op_plus
l_int|61
)paren
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;        supports %s Hz refresh rates, default %d Hz&bslash;n&quot;
comma
id|refresh_rates_buf
comma
id|lcd_refresh_rates
(braket
id|default_refresh_rate
)braket
)paren
suffix:semicolon
multiline_comment|/* We now need to determine the crtc parameters for the&n;&t;&t;   lcd monitor. This is tricky, because they are not stored&n;&t;&t;   individually in the BIOS. Instead, the BIOS contains a&n;&t;&t;   table of display modes that work for this monitor.&n;&n;&t;&t;   The idea is that we search for a mode of the same dimensions&n;&t;&t;   as the dimensions of the lcd monitor. Say our lcd monitor&n;&t;&t;   is 800x600 pixels, we search for a 800x600 monitor.&n;&t;&t;   The CRTC parameters we find here are the ones that we need&n;&t;&t;   to use to simulate other resolutions on the lcd screen.&n;&t;&t; */
id|lcdmodeptr
op_assign
(paren
id|u16
op_star
)paren
(paren
id|default_par-&gt;lcd_table
op_plus
l_int|64
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|lcdmodeptr
op_ne
l_int|0
)paren
(brace
id|u32
id|modeptr
suffix:semicolon
id|u16
id|mwidth
comma
id|mheight
suffix:semicolon
id|modeptr
op_assign
id|default_par-&gt;bios_base
op_plus
op_star
id|lcdmodeptr
suffix:semicolon
id|mwidth
op_assign
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|modeptr
op_plus
l_int|0
)paren
)paren
suffix:semicolon
id|mheight
op_assign
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|modeptr
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mwidth
op_eq
id|width
op_logical_and
id|mheight
op_eq
id|height
)paren
(brace
id|default_par-&gt;lcd_pixclock
op_assign
l_int|100000000
op_div
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|modeptr
op_plus
l_int|9
)paren
)paren
suffix:semicolon
id|default_par-&gt;lcd_htotal
op_assign
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|modeptr
op_plus
l_int|17
)paren
)paren
op_amp
l_int|511
suffix:semicolon
id|default_par-&gt;lcd_hdisp
op_assign
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|modeptr
op_plus
l_int|19
)paren
)paren
op_amp
l_int|511
suffix:semicolon
id|default_par-&gt;lcd_hsync_start
op_assign
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|modeptr
op_plus
l_int|21
)paren
)paren
op_amp
l_int|511
suffix:semicolon
id|default_par-&gt;lcd_hsync_delay
op_assign
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|modeptr
op_plus
l_int|21
)paren
)paren
op_rshift
l_int|9
)paren
op_amp
l_int|7
suffix:semicolon
id|default_par-&gt;lcd_hsync_width
op_assign
op_star
(paren
(paren
id|u8
op_star
)paren
(paren
id|modeptr
op_plus
l_int|23
)paren
)paren
op_amp
l_int|63
suffix:semicolon
id|default_par-&gt;lcd_vtotal
op_assign
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|modeptr
op_plus
l_int|24
)paren
)paren
op_amp
l_int|2047
suffix:semicolon
id|default_par-&gt;lcd_vdisp
op_assign
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|modeptr
op_plus
l_int|26
)paren
)paren
op_amp
l_int|2047
suffix:semicolon
id|default_par-&gt;lcd_vsync_start
op_assign
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|modeptr
op_plus
l_int|28
)paren
)paren
op_amp
l_int|2047
suffix:semicolon
id|default_par-&gt;lcd_vsync_width
op_assign
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|modeptr
op_plus
l_int|28
)paren
)paren
op_rshift
l_int|11
)paren
op_amp
l_int|31
suffix:semicolon
id|default_par-&gt;lcd_right
op_assign
id|default_par-&gt;lcd_hsync_start
op_minus
id|default_par-&gt;lcd_hdisp
suffix:semicolon
id|default_par-&gt;lcd_lower
op_assign
id|default_par-&gt;lcd_vsync_start
op_minus
id|default_par-&gt;lcd_vdisp
suffix:semicolon
id|default_par-&gt;lcd_hblank_width
op_assign
id|default_par-&gt;lcd_htotal
op_minus
id|default_par-&gt;lcd_hdisp
suffix:semicolon
id|default_par-&gt;lcd_vblank_width
op_assign
id|default_par-&gt;lcd_vtotal
op_minus
id|default_par-&gt;lcd_vdisp
suffix:semicolon
r_break
suffix:semicolon
)brace
id|lcdmodeptr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|lcdmodeptr
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;atyfb: LCD monitor CRTC parameters not found!!!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* To do: Switch to CRT if possible. */
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;        LCD CRTC parameters: %d %d %d %d %d %d %d %d %d %d&bslash;n&quot;
comma
id|default_par-&gt;lcd_pixclock
comma
id|default_par-&gt;lcd_htotal
comma
id|default_par-&gt;lcd_hdisp
comma
id|default_par-&gt;lcd_hsync_start
comma
id|default_par-&gt;lcd_hsync_delay
comma
id|default_par-&gt;lcd_hsync_width
comma
id|default_par-&gt;lcd_vtotal
comma
id|default_par-&gt;lcd_vdisp
comma
id|default_par-&gt;lcd_vsync_start
comma
id|default_par-&gt;lcd_vsync_width
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_FB_ATY_GENERIC_LCD */
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;screen_base
)paren
(brace
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|res_start
comma
id|res_size
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* __sparc__ */
r_if
c_cond
(paren
op_logical_neg
id|aty_init
c_func
(paren
id|info
comma
l_string|&quot;PCI&quot;
)paren
)paren
(brace
macro_line|#ifdef __sparc__&t;
r_if
c_cond
(paren
id|default_par-&gt;mmap_map
)paren
id|kfree
c_func
(paren
id|default_par-&gt;mmap_map
)paren
suffix:semicolon
macro_line|#endif
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|res_start
comma
id|res_size
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
macro_line|#ifdef __sparc__
r_if
c_cond
(paren
op_logical_neg
id|prom_palette
)paren
id|prom_palette
op_assign
id|atyfb_palette
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Add /dev/fb mmap values.&n;&t;&t;&t; */
id|default_par-&gt;mmap_map
(braket
l_int|0
)braket
dot
id|voff
op_assign
l_int|0x8000000000000000UL
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
l_int|0
)braket
dot
id|poff
op_assign
(paren
r_int
r_int
)paren
id|info-&gt;screen_base
op_amp
id|PAGE_MASK
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
l_int|0
)braket
dot
id|size
op_assign
id|info-&gt;fix.smem_len
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
l_int|0
)braket
dot
id|prot_mask
op_assign
id|_PAGE_CACHE
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
l_int|0
)braket
dot
id|prot_flag
op_assign
id|_PAGE_E
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
l_int|1
)braket
dot
id|voff
op_assign
id|default_par-&gt;mmap_map
(braket
l_int|0
)braket
dot
id|voff
op_plus
id|info-&gt;fix.smem_len
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
l_int|1
)braket
dot
id|poff
op_assign
id|default_par-&gt;ati_regbase
op_amp
id|PAGE_MASK
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
l_int|1
)braket
dot
id|size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
l_int|1
)braket
dot
id|prot_mask
op_assign
id|_PAGE_CACHE
suffix:semicolon
id|default_par-&gt;mmap_map
(braket
l_int|1
)braket
dot
id|prot_flag
op_assign
id|_PAGE_E
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* __sparc__ */
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_if
c_cond
(paren
id|first_display
op_eq
l_int|NULL
)paren
id|pmu_register_sleep_notifier
c_func
(paren
op_amp
id|aty_sleep_notifier
)paren
suffix:semicolon
id|default_par-&gt;next
op_assign
id|first_display
suffix:semicolon
macro_line|#endif
)brace
)brace
macro_line|#elif defined(CONFIG_ATARI)
r_struct
id|atyfb_par
op_star
id|default_par
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_int
id|m64_num
suffix:semicolon
id|u32
id|clock_r
suffix:semicolon
r_for
c_loop
(paren
id|m64_num
op_assign
l_int|0
suffix:semicolon
id|m64_num
OL
id|mach64_count
suffix:semicolon
id|m64_num
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|phys_vmembase
(braket
id|m64_num
)braket
op_logical_or
op_logical_neg
id|phys_size
(braket
id|m64_num
)braket
op_logical_or
op_logical_neg
id|phys_guiregbase
(braket
id|m64_num
)braket
)paren
(brace
id|printk
(paren
l_string|&quot; phys_*[%d] parameters not set =&gt; returning early. &bslash;n&quot;
comma
id|m64_num
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|fb_info
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;atyfb_init: can&squot;t alloc fb_info&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_info
)paren
)paren
suffix:semicolon
id|info-&gt;fix
op_assign
id|atyfb_fix
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Map the video memory (physical address given) to somewhere in the&n;&t;&t; *  kernel address space.&n;&t;&t; */
id|info-&gt;screen_base
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|phys_vmembase
(braket
id|m64_num
)braket
comma
id|phys_size
(braket
id|m64_num
)braket
)paren
suffix:semicolon
id|info-&gt;fix.smem_start
op_assign
id|info-&gt;screen_base
suffix:semicolon
multiline_comment|/* Fake! */
id|default_par-&gt;ati_regbase
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|phys_guiregbase
(braket
id|m64_num
)braket
comma
l_int|0x10000
)paren
op_plus
l_int|0xFC00ul
suffix:semicolon
id|info-&gt;fix.mmio_start
op_assign
id|default_par-&gt;ati_regbase
suffix:semicolon
multiline_comment|/* Fake! */
id|aty_st_le32
c_func
(paren
id|CLOCK_CNTL
comma
l_int|0x12345678
comma
id|default_par
)paren
suffix:semicolon
id|clock_r
op_assign
id|aty_ld_le32
c_func
(paren
id|CLOCK_CNTL
comma
id|default_par
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|clock_r
op_amp
l_int|0x003F
)paren
(brace
r_case
l_int|0x12
suffix:colon
id|default_par-&gt;clk_wr_offset
op_assign
l_int|3
suffix:semicolon
multiline_comment|/*  */
r_break
suffix:semicolon
r_case
l_int|0x34
suffix:colon
id|default_par-&gt;clk_wr_offset
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Medusa ST-IO ISA Adapter etc. */
r_break
suffix:semicolon
r_case
l_int|0x16
suffix:colon
id|default_par-&gt;clk_wr_offset
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*  */
r_break
suffix:semicolon
r_case
l_int|0x38
suffix:colon
id|default_par-&gt;clk_wr_offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Panther 1 ISA Adapter (Gerald) */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|aty_init
c_func
(paren
id|info
comma
l_string|&quot;ISA bus&quot;
)paren
)paren
(brace
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* This is insufficient! kernel_map has added two large chunks!! */
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_ATARI */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef MODULE
DECL|function|atyfb_setup
r_int
id|__init
id|atyfb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;noblink&quot;
comma
l_int|7
)paren
)paren
(brace
id|curblink
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;noaccel&quot;
comma
l_int|7
)paren
)paren
(brace
id|noaccel
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;vram:&quot;
comma
l_int|5
)paren
)paren
id|default_vram
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|5
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;pll:&quot;
comma
l_int|4
)paren
)paren
id|default_pll
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|4
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;mclk:&quot;
comma
l_int|5
)paren
)paren
id|default_mclk
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|5
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;xclk:&quot;
comma
l_int|5
)paren
)paren
id|default_xclk
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|5
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PPC
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;vmode:&quot;
comma
l_int|6
)paren
)paren
(brace
r_int
r_int
id|vmode
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vmode
OG
l_int|0
op_logical_and
id|vmode
op_le
id|VMODE_MAX
)paren
id|default_vmode
op_assign
id|vmode
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;cmode:&quot;
comma
l_int|6
)paren
)paren
(brace
r_int
r_int
id|cmode
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmode
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|8
suffix:colon
id|default_cmode
op_assign
id|CMODE_8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
r_case
l_int|16
suffix:colon
id|default_cmode
op_assign
id|CMODE_16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|default_cmode
op_assign
id|CMODE_32
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_ATARI
multiline_comment|/*&n;&t;&t; * Why do we need this silly Mach64 argument?&n;&t;&t; * We are already here because of mach64= so its redundant.&n;&t;&t; */
r_else
r_if
c_cond
(paren
id|MACH_IS_ATARI
op_logical_and
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;Mach64:&quot;
comma
l_int|7
)paren
)paren
)paren
(brace
r_static
r_int
r_char
id|m64_num
suffix:semicolon
r_static
r_char
id|mach64_str
(braket
l_int|80
)braket
suffix:semicolon
id|strncpy
c_func
(paren
id|mach64_str
comma
id|this_opt
op_plus
l_int|7
comma
l_int|80
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|store_video_par
c_func
(paren
id|mach64_str
comma
id|m64_num
)paren
)paren
(brace
id|m64_num
op_increment
suffix:semicolon
id|mach64_count
op_assign
id|m64_num
suffix:semicolon
)brace
)brace
macro_line|#endif
r_else
id|mode_option
op_assign
id|this_opt
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* !MODULE */
macro_line|#ifdef CONFIG_ATARI
DECL|function|store_video_par
r_static
r_int
id|__init
id|store_video_par
c_func
(paren
r_char
op_star
id|video_str
comma
r_int
r_char
id|m64_num
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
r_int
id|vmembase
comma
id|size
comma
id|guiregbase
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;store_video_par() &squot;%s&squot; &bslash;n&quot;
comma
id|video_str
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strsep
c_func
(paren
op_amp
id|video_str
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|mach64_invalid
suffix:semicolon
id|vmembase
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strsep
c_func
(paren
op_amp
id|video_str
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|mach64_invalid
suffix:semicolon
id|size
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strsep
c_func
(paren
op_amp
id|video_str
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|mach64_invalid
suffix:semicolon
id|guiregbase
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|phys_vmembase
(braket
id|m64_num
)braket
op_assign
id|vmembase
suffix:semicolon
id|phys_size
(braket
id|m64_num
)braket
op_assign
id|size
suffix:semicolon
id|phys_guiregbase
(braket
id|m64_num
)braket
op_assign
id|guiregbase
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; stored them all: $%08lX $%08lX $%08lX &bslash;n&quot;
comma
id|vmembase
comma
id|size
comma
id|guiregbase
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|mach64_invalid
suffix:colon
id|phys_vmembase
(braket
id|m64_num
)braket
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_ATARI */
multiline_comment|/*&n;#ifdef CONFIG_FB_ATY_CT&n;   * Erase HW Cursor *&n;    if (par-&gt;cursor &amp;&amp; (info-&gt;currcon &gt;= 0))&n;&t;atyfb_cursor(&amp;fb_display[par-&gt;currcon], CM_ERASE,&n;&t;&t;     par-&gt;cursor-&gt;pos.x, par-&gt;cursor-&gt;pos.y);&n;#endif * CONFIG_FB_ATY_CT *&n;&n;#ifdef CONFIG_FB_ATY_CT&n;    * Install hw cursor *&n;    if (par-&gt;cursor) {&n;&t;aty_set_cursor_color(info);&n;&t;aty_set_cursor_shape(info);&n;    }&n;#endif * CONFIG_FB_ATY_CT */
multiline_comment|/*&n;     *  Blank the display.&n;     */
DECL|function|atyfb_blank
r_static
r_int
id|atyfb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u8
id|gen_cntl
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
r_if
c_cond
(paren
(paren
id|_machine
op_eq
id|_MACH_Pmac
)paren
op_logical_and
id|blank
)paren
id|set_backlight_enable
c_func
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_PMAC_BACKLIGHT */
id|gen_cntl
op_assign
id|aty_ld_8
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|par
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blank
OG
l_int|0
)paren
r_switch
c_cond
(paren
id|blank
op_minus
l_int|1
)paren
(brace
r_case
id|VESA_NO_BLANKING
suffix:colon
id|gen_cntl
op_or_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VESA_VSYNC_SUSPEND
suffix:colon
id|gen_cntl
op_or_assign
l_int|0x8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VESA_HSYNC_SUSPEND
suffix:colon
id|gen_cntl
op_or_assign
l_int|0x4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VESA_POWERDOWN
suffix:colon
id|gen_cntl
op_or_assign
l_int|0x4c
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|gen_cntl
op_and_assign
op_complement
(paren
l_int|0x4c
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|gen_cntl
comma
id|par
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
r_if
c_cond
(paren
(paren
id|_machine
op_eq
id|_MACH_Pmac
)paren
op_logical_and
op_logical_neg
id|blank
)paren
id|set_backlight_enable
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_PMAC_BACKLIGHT */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Set a single color register. The values supplied are already&n;     *  rounded down to the hardware&squot;s capabilities (according to the&n;     *  entries in the var structure). Return != 0 for invalid regno.&n;     */
DECL|function|atyfb_setcolreg
r_static
r_int
id|atyfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
id|i
comma
id|scale
suffix:semicolon
id|u32
op_star
id|pal
op_assign
id|info-&gt;pseudo_palette
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|i
op_assign
id|aty_ld_8
c_func
(paren
id|DAC_CNTL
comma
id|par
)paren
op_amp
l_int|0xfc
suffix:semicolon
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|EXTRA_BRIGHT
)paren
)paren
id|i
op_or_assign
l_int|0x2
suffix:semicolon
multiline_comment|/*DAC_CNTL|0x2 turns off the extra brightness for gt */
id|aty_st_8
c_func
(paren
id|DAC_CNTL
comma
id|i
comma
id|par
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|DAC_MASK
comma
l_int|0xff
comma
id|par
)paren
suffix:semicolon
id|scale
op_assign
(paren
id|M64_HAS
c_func
(paren
id|INTEGRATED
)paren
op_logical_and
id|info-&gt;var.bits_per_pixel
op_eq
l_int|16
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ATARI
id|out_8
c_func
(paren
op_amp
id|par-&gt;aty_cmap_regs-&gt;windex
comma
id|regno
op_lshift
id|scale
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
comma
id|red
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
comma
id|green
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
comma
id|blue
)paren
suffix:semicolon
macro_line|#else
id|writeb
c_func
(paren
id|regno
op_lshift
id|scale
comma
op_amp
id|par-&gt;aty_cmap_regs-&gt;windex
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|red
comma
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|green
comma
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|blue
comma
op_amp
id|par-&gt;aty_cmap_regs-&gt;lut
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|regno
OL
l_int|16
)paren
r_switch
c_cond
(paren
id|info-&gt;var.bits_per_pixel
)paren
(brace
r_case
l_int|16
suffix:colon
id|pal
(braket
id|regno
)braket
op_assign
(paren
id|regno
op_lshift
l_int|10
)paren
op_or
(paren
id|regno
op_lshift
l_int|5
)paren
op_or
id|regno
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|pal
(braket
id|regno
)braket
op_assign
(paren
id|regno
op_lshift
l_int|16
)paren
op_or
(paren
id|regno
op_lshift
l_int|8
)paren
op_or
id|regno
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|i
op_assign
(paren
id|regno
op_lshift
l_int|8
)paren
op_or
id|regno
suffix:semicolon
id|pal
(braket
id|regno
)braket
op_assign
(paren
id|i
op_lshift
l_int|16
)paren
op_or
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|__init
id|init_module
c_func
(paren
r_void
)paren
(brace
id|atyfb_init
c_func
(paren
)paren
suffix:semicolon
r_return
id|fb_list
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENXIO
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|fb_list
suffix:semicolon
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|unregister_framebuffer
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#ifndef __sparc__
r_if
c_cond
(paren
id|par-&gt;ati_regbase
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|par-&gt;ati_regbase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;screen_base
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|info-&gt;screen_base
)paren
suffix:semicolon
macro_line|#ifdef __BIG_ENDIAN
r_if
c_cond
(paren
id|info-&gt;cursor
op_logical_and
id|par-&gt;cursor-&gt;ram
)paren
id|iounmap
c_func
(paren
id|par-&gt;cursor-&gt;ram
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_if
c_cond
(paren
id|info-&gt;cursor
)paren
id|kfree
c_func
(paren
id|info-&gt;cursor
)paren
suffix:semicolon
macro_line|#ifdef __sparc__
r_if
c_cond
(paren
id|par-&gt;mmap_map
)paren
id|kfree
c_func
(paren
id|par-&gt;mmap_map
)paren
suffix:semicolon
macro_line|#endif
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
macro_line|#endif
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
