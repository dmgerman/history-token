multiline_comment|/*&n; *  ATI Mach64 CT/VT/GT/LT Cursor Support&n; */
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#ifdef __sparc__
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &lt;asm/fbio.h&gt;
macro_line|#endif
macro_line|#include &lt;video/mach64.h&gt;
macro_line|#include &quot;atyfb.h&quot;
multiline_comment|/*&n; * The hardware cursor definition requires 2 bits per pixel. The&n; * Cursor size reguardless of the visible cursor size is 64 pixels&n; * by 64 lines. The total memory required to define the cursor is&n; * 16 bytes / line for 64 lines or 1024 bytes of data. The data&n; * must be in a contigiuos format. The 2 bit cursor code values are&n; * as follows:&n; *&n; *&t;00 - pixel colour = CURSOR_CLR_0&n; *&t;01 - pixel colour = CURSOR_CLR_1&n; *&t;10 - pixel colour = transparent (current display pixel)&n; *&t;11 - pixel colour = 1&squot;s complement of current display pixel&n; *&n; *&t;Cursor Offset        64 pixels&t;&t; Actual Displayed Area&n; *            &bslash;_________________________/&n; *&t;      |&t;&t;&t;|&t;|&t;|&n; *&t;      |&lt;---------------&gt;|&t;|&t;|&n; *&t;      | CURS_HORZ_OFFSET|&t;|&t;|&n; *&t;      |&t;&t;&t;|_______|&t;|  64 Lines&n; *&t;      |&t;&t;&t;   ^&t;|&t;|&n; *&t;      |&t;&t;&t;   |&t;|&t;|&n; *&t;      |&t;&t;CURS_VERT_OFFSET|&t;|&n; *&t;      |&t;&t;&t;   |&t;|&t;|&n; *&t;      |____________________|____|&t;|&n; *&n; *&n; * The Screen position of the top left corner of the displayed&n; * cursor is specificed by CURS_HORZ_VERT_POSN. Care must be taken&n; * when the cursor hot spot is not the top left corner and the&n; * physical cursor position becomes negative. It will be be displayed&n; * if either the horizontal or vertical cursor position is negative&n; *&n; * If x becomes negative the cursor manager must adjust the CURS_HORZ_OFFSET&n; * to a larger number and saturate CUR_HORZ_POSN to zero.&n; *&n; * if Y becomes negative, CUR_VERT_OFFSET must be adjusted to a larger number,&n; * CUR_OFFSET must be adjusted to a point to the appropraite line in the cursor&n; * definitation and CUR_VERT_POSN must be saturated to zero.&n; */
multiline_comment|/*&n;     *  Hardware Cursor support.&n;     */
DECL|variable|cursor_bits_lookup
r_static
r_const
id|u8
id|cursor_bits_lookup
(braket
l_int|16
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x40
comma
l_int|0x10
comma
l_int|0x50
comma
l_int|0x04
comma
l_int|0x44
comma
l_int|0x14
comma
l_int|0x54
comma
l_int|0x01
comma
l_int|0x41
comma
l_int|0x11
comma
l_int|0x51
comma
l_int|0x05
comma
l_int|0x45
comma
l_int|0x15
comma
l_int|0x55
)brace
suffix:semicolon
DECL|variable|cursor_mask_lookup
r_static
r_const
id|u8
id|cursor_mask_lookup
(braket
l_int|16
)braket
op_assign
(brace
l_int|0xaa
comma
l_int|0x2a
comma
l_int|0x8a
comma
l_int|0x0a
comma
l_int|0xa2
comma
l_int|0x22
comma
l_int|0x82
comma
l_int|0x02
comma
l_int|0xa8
comma
l_int|0x28
comma
l_int|0x88
comma
l_int|0x08
comma
l_int|0xa0
comma
l_int|0x20
comma
l_int|0x80
comma
l_int|0x00
)brace
suffix:semicolon
DECL|function|atyfb_cursor
r_int
id|atyfb_cursor
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_struct
id|fb_cursor
op_star
id|cursor
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u16
id|xoff
comma
id|yoff
suffix:semicolon
r_int
id|x
comma
id|y
suffix:semicolon
macro_line|#ifdef __sparc__
r_if
c_cond
(paren
id|par-&gt;mmaped
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|par-&gt;asleep
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* Hide cursor */
id|wait_for_fifo
c_func
(paren
l_int|1
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|GEN_TEST_CNTL
comma
id|aty_ld_le32
c_func
(paren
id|GEN_TEST_CNTL
comma
id|par
)paren
op_amp
op_complement
id|HWCURSOR_ENABLE
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set position */
r_if
c_cond
(paren
id|cursor-&gt;set
op_amp
id|FB_CUR_SETPOS
)paren
(brace
id|x
op_assign
id|cursor-&gt;image.dx
op_minus
id|cursor-&gt;hot.x
op_minus
id|info-&gt;var.xoffset
suffix:semicolon
r_if
c_cond
(paren
id|x
OL
l_int|0
)paren
(brace
id|xoff
op_assign
op_minus
id|x
suffix:semicolon
id|x
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|xoff
op_assign
l_int|0
suffix:semicolon
)brace
id|y
op_assign
id|cursor-&gt;image.dy
op_minus
id|cursor-&gt;hot.y
op_minus
id|info-&gt;var.yoffset
suffix:semicolon
r_if
c_cond
(paren
id|y
OL
l_int|0
)paren
(brace
id|yoff
op_assign
op_minus
id|y
suffix:semicolon
id|y
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|yoff
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * In doublescan mode, the cursor location also needs to be&n;&t;&t; * doubled.&n;&t;&t; */
r_if
c_cond
(paren
id|par-&gt;crtc.gen_cntl
op_amp
id|CRTC_DBL_SCAN_EN
)paren
id|y
op_lshift_assign
l_int|1
suffix:semicolon
id|wait_for_fifo
c_func
(paren
l_int|4
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CUR_OFFSET
comma
(paren
id|info-&gt;fix.smem_len
op_rshift
l_int|3
)paren
op_plus
(paren
id|yoff
op_lshift
l_int|1
)paren
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CUR_HORZ_VERT_OFF
comma
(paren
(paren
id|u32
)paren
(paren
l_int|64
op_minus
id|cursor-&gt;image.height
op_plus
id|yoff
)paren
op_lshift
l_int|16
)paren
op_or
id|xoff
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CUR_HORZ_VERT_POSN
comma
(paren
(paren
id|u32
)paren
id|y
op_lshift
l_int|16
)paren
op_or
id|x
comma
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/* Set color map */
r_if
c_cond
(paren
id|cursor-&gt;set
op_amp
id|FB_CUR_SETCMAP
)paren
(brace
id|u32
id|fg_idx
comma
id|bg_idx
comma
id|fg
comma
id|bg
suffix:semicolon
id|fg_idx
op_assign
id|cursor-&gt;image.fg_color
suffix:semicolon
id|bg_idx
op_assign
id|cursor-&gt;image.bg_color
suffix:semicolon
id|fg
op_assign
(paren
id|info-&gt;cmap.red
(braket
id|fg_idx
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|info-&gt;cmap.green
(braket
id|fg_idx
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|info-&gt;cmap.blue
(braket
id|fg_idx
)braket
op_lshift
l_int|8
)paren
op_or
l_int|15
suffix:semicolon
id|bg
op_assign
(paren
id|info-&gt;cmap.red
(braket
id|bg_idx
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|info-&gt;cmap.green
(braket
id|bg_idx
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|info-&gt;cmap.blue
(braket
id|bg_idx
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|wait_for_fifo
c_func
(paren
l_int|2
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CUR_CLR0
comma
id|bg
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CUR_CLR1
comma
id|fg
comma
id|par
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cursor-&gt;set
op_amp
(paren
id|FB_CUR_SETSHAPE
op_or
id|FB_CUR_SETIMAGE
)paren
)paren
(brace
id|u8
op_star
id|src
op_assign
(paren
id|u8
op_star
)paren
id|cursor-&gt;image.data
suffix:semicolon
id|u8
op_star
id|msk
op_assign
(paren
id|u8
op_star
)paren
id|cursor-&gt;mask
suffix:semicolon
id|u8
id|__iomem
op_star
id|dst
op_assign
(paren
id|u8
id|__iomem
op_star
)paren
id|info-&gt;sprite.addr
suffix:semicolon
r_int
r_int
id|width
op_assign
(paren
id|cursor-&gt;image.width
op_plus
l_int|7
)paren
op_rshift
l_int|3
suffix:semicolon
r_int
r_int
id|height
op_assign
id|cursor-&gt;image.height
suffix:semicolon
r_int
r_int
id|align
op_assign
id|info-&gt;sprite.scan_align
suffix:semicolon
r_int
r_int
id|i
comma
id|j
comma
id|offset
suffix:semicolon
id|u8
id|m
comma
id|b
suffix:semicolon
singleline_comment|// Clear cursor image with 1010101010...
id|fb_memset
c_func
(paren
id|dst
comma
l_int|0xaa
comma
l_int|1024
)paren
suffix:semicolon
id|offset
op_assign
id|align
op_minus
id|width
op_star
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|height
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|width
suffix:semicolon
id|j
op_increment
)paren
(brace
id|b
op_assign
op_star
id|src
op_increment
suffix:semicolon
id|m
op_assign
op_star
id|msk
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|cursor-&gt;rop
)paren
(brace
r_case
id|ROP_XOR
suffix:colon
singleline_comment|// Upper 4 bits of mask data
id|fb_writeb
c_func
(paren
id|cursor_mask_lookup
(braket
id|m
op_rshift
l_int|4
)braket
op_or
id|cursor_bits_lookup
(braket
(paren
id|b
op_xor
id|m
)paren
op_rshift
l_int|4
)braket
comma
id|dst
op_increment
)paren
suffix:semicolon
singleline_comment|// Lower 4 bits of mask
id|fb_writeb
c_func
(paren
id|cursor_mask_lookup
(braket
id|m
op_amp
l_int|0x0f
)braket
op_or
id|cursor_bits_lookup
(braket
(paren
id|b
op_xor
id|m
)paren
op_amp
l_int|0x0f
)braket
comma
id|dst
op_increment
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ROP_COPY
suffix:colon
singleline_comment|// Upper 4 bits of mask data
id|fb_writeb
c_func
(paren
id|cursor_mask_lookup
(braket
id|m
op_rshift
l_int|4
)braket
op_or
id|cursor_bits_lookup
(braket
(paren
id|b
op_amp
id|m
)paren
op_rshift
l_int|4
)braket
comma
id|dst
op_increment
)paren
suffix:semicolon
singleline_comment|// Lower 4 bits of mask
id|fb_writeb
c_func
(paren
id|cursor_mask_lookup
(braket
id|m
op_amp
l_int|0x0f
)braket
op_or
id|cursor_bits_lookup
(braket
(paren
id|b
op_amp
id|m
)paren
op_amp
l_int|0x0f
)braket
comma
id|dst
op_increment
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|dst
op_add_assign
id|offset
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cursor-&gt;enable
)paren
(brace
id|wait_for_fifo
c_func
(paren
l_int|1
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|GEN_TEST_CNTL
comma
id|aty_ld_le32
c_func
(paren
id|GEN_TEST_CNTL
comma
id|par
)paren
op_or
id|HWCURSOR_ENABLE
comma
id|par
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aty_init_cursor
r_int
id|__init
id|aty_init_cursor
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
id|info-&gt;fix.smem_len
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
macro_line|#ifdef __sparc__
id|addr
op_assign
(paren
r_int
r_int
)paren
id|info-&gt;screen_base
op_minus
l_int|0x800000
op_plus
id|info-&gt;fix.smem_len
suffix:semicolon
id|info-&gt;sprite.addr
op_assign
(paren
id|u8
op_star
)paren
id|addr
suffix:semicolon
macro_line|#else
macro_line|#ifdef __BIG_ENDIAN
id|addr
op_assign
id|info-&gt;fix.smem_start
op_minus
l_int|0x800000
op_plus
id|info-&gt;fix.smem_len
suffix:semicolon
id|info-&gt;sprite.addr
op_assign
(paren
id|u8
op_star
)paren
id|ioremap
c_func
(paren
id|addr
comma
l_int|1024
)paren
suffix:semicolon
macro_line|#else
id|addr
op_assign
(paren
r_int
r_int
)paren
id|info-&gt;screen_base
op_plus
id|info-&gt;fix.smem_len
suffix:semicolon
id|info-&gt;sprite.addr
op_assign
(paren
id|u8
op_star
)paren
id|addr
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;sprite.addr
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|info-&gt;sprite.size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|info-&gt;sprite.scan_align
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* Scratch pad 64 bytes wide */
id|info-&gt;sprite.buf_align
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* and 64 lines tall. */
id|info-&gt;sprite.flags
op_assign
id|FB_PIXMAP_IO
suffix:semicolon
id|info-&gt;fbops-&gt;fb_cursor
op_assign
id|atyfb_cursor
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
