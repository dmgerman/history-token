multiline_comment|/*&n; *  ATI Mach64 Hardware Acceleration&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;video/mach64.h&gt;
macro_line|#include &quot;atyfb.h&quot;
multiline_comment|/*&n;     *  Generic Mach64 routines&n;     */
multiline_comment|/* this is for DMA GUI engine! work in progress */
r_typedef
r_struct
(brace
DECL|member|frame_buf_offset
id|u32
id|frame_buf_offset
suffix:semicolon
DECL|member|system_mem_addr
id|u32
id|system_mem_addr
suffix:semicolon
DECL|member|command
id|u32
id|command
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
suffix:semicolon
DECL|typedef|BM_DESCRIPTOR_ENTRY
)brace
id|BM_DESCRIPTOR_ENTRY
suffix:semicolon
DECL|macro|LAST_DESCRIPTOR
mdefine_line|#define LAST_DESCRIPTOR (1 &lt;&lt; 31)
DECL|macro|SYSTEM_TO_FRAME_BUFFER
mdefine_line|#define SYSTEM_TO_FRAME_BUFFER 0
DECL|function|rotation24bpp
r_static
id|u32
id|rotation24bpp
c_func
(paren
id|u32
id|dx
comma
id|u32
id|direction
)paren
(brace
id|u32
id|rotation
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_amp
id|DST_X_LEFT_TO_RIGHT
)paren
(brace
id|rotation
op_assign
(paren
id|dx
op_div
l_int|4
)paren
op_mod
l_int|6
suffix:semicolon
)brace
r_else
(brace
id|rotation
op_assign
(paren
(paren
id|dx
op_plus
l_int|2
)paren
op_div
l_int|4
)paren
op_mod
l_int|6
suffix:semicolon
)brace
r_return
(paren
(paren
id|rotation
op_lshift
l_int|8
)paren
op_or
id|DST_24_ROTATION_ENABLE
)paren
suffix:semicolon
)brace
DECL|function|aty_reset_engine
r_void
id|aty_reset_engine
c_func
(paren
r_const
r_struct
id|atyfb_par
op_star
id|par
)paren
(brace
multiline_comment|/* reset engine */
id|aty_st_le32
c_func
(paren
id|GEN_TEST_CNTL
comma
id|aty_ld_le32
c_func
(paren
id|GEN_TEST_CNTL
comma
id|par
)paren
op_amp
op_complement
id|GUI_ENGINE_ENABLE
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* enable engine */
id|aty_st_le32
c_func
(paren
id|GEN_TEST_CNTL
comma
id|aty_ld_le32
c_func
(paren
id|GEN_TEST_CNTL
comma
id|par
)paren
op_or
id|GUI_ENGINE_ENABLE
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* ensure engine is not locked up by clearing any FIFO or */
multiline_comment|/* HOST errors */
id|aty_st_le32
c_func
(paren
id|BUS_CNTL
comma
id|aty_ld_le32
c_func
(paren
id|BUS_CNTL
comma
id|par
)paren
op_or
id|BUS_HOST_ERR_ACK
op_or
id|BUS_FIFO_ERR_ACK
comma
id|par
)paren
suffix:semicolon
)brace
DECL|function|reset_GTC_3D_engine
r_static
r_void
id|reset_GTC_3D_engine
c_func
(paren
r_const
r_struct
id|atyfb_par
op_star
id|par
)paren
(brace
id|aty_st_le32
c_func
(paren
id|SCALE_3D_CNTL
comma
l_int|0xc0
comma
id|par
)paren
suffix:semicolon
id|mdelay
c_func
(paren
id|GTC_3D_RESET_DELAY
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|SETUP_CNTL
comma
l_int|0x00
comma
id|par
)paren
suffix:semicolon
id|mdelay
c_func
(paren
id|GTC_3D_RESET_DELAY
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|SCALE_3D_CNTL
comma
l_int|0x00
comma
id|par
)paren
suffix:semicolon
id|mdelay
c_func
(paren
id|GTC_3D_RESET_DELAY
)paren
suffix:semicolon
)brace
DECL|function|aty_init_engine
r_void
id|aty_init_engine
c_func
(paren
r_struct
id|atyfb_par
op_star
id|par
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|u32
id|pitch_value
suffix:semicolon
multiline_comment|/* determine modal information from global mode structure */
id|pitch_value
op_assign
id|info-&gt;var.xres_virtual
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.bits_per_pixel
op_eq
l_int|24
)paren
(brace
multiline_comment|/* In 24 bpp, the engine is in 8 bpp - this requires that all */
multiline_comment|/* horizontal coordinates and widths must be adjusted */
id|pitch_value
op_mul_assign
l_int|3
suffix:semicolon
)brace
multiline_comment|/* On GTC (RagePro), we need to reset the 3D engine before */
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|RESET_3D
)paren
)paren
id|reset_GTC_3D_engine
c_func
(paren
id|par
)paren
suffix:semicolon
multiline_comment|/* Reset engine, enable, and clear any engine errors */
id|aty_reset_engine
c_func
(paren
id|par
)paren
suffix:semicolon
multiline_comment|/* Ensure that vga page pointers are set to zero - the upper */
multiline_comment|/* page pointers are set to 1 to handle overflows in the */
multiline_comment|/* lower page */
id|aty_st_le32
c_func
(paren
id|MEM_VGA_WP_SEL
comma
l_int|0x00010000
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|MEM_VGA_RP_SEL
comma
l_int|0x00010000
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* ---- Setup standard engine context ---- */
multiline_comment|/* All GUI registers here are FIFOed - therefore, wait for */
multiline_comment|/* the appropriate number of empty FIFO entries */
id|wait_for_fifo
c_func
(paren
l_int|14
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* enable all registers to be loaded for context loads */
id|aty_st_le32
c_func
(paren
id|CONTEXT_MASK
comma
l_int|0xFFFFFFFF
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set destination pitch to modal pitch, set offset to zero */
id|aty_st_le32
c_func
(paren
id|DST_OFF_PITCH
comma
(paren
id|pitch_value
op_div
l_int|8
)paren
op_lshift
l_int|22
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* zero these registers (set them to a known state) */
id|aty_st_le32
c_func
(paren
id|DST_Y_X
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DST_HEIGHT
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DST_BRES_ERR
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DST_BRES_INC
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DST_BRES_DEC
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set destination drawing attributes */
id|aty_st_le32
c_func
(paren
id|DST_CNTL
comma
id|DST_LAST_PEL
op_or
id|DST_Y_TOP_TO_BOTTOM
op_or
id|DST_X_LEFT_TO_RIGHT
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set source pitch to modal pitch, set offset to zero */
id|aty_st_le32
c_func
(paren
id|SRC_OFF_PITCH
comma
(paren
id|pitch_value
op_div
l_int|8
)paren
op_lshift
l_int|22
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set these registers to a known state */
id|aty_st_le32
c_func
(paren
id|SRC_Y_X
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|SRC_HEIGHT1_WIDTH1
comma
l_int|1
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|SRC_Y_X_START
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|SRC_HEIGHT2_WIDTH2
comma
l_int|1
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set source pixel retrieving attributes */
id|aty_st_le32
c_func
(paren
id|SRC_CNTL
comma
id|SRC_LINE_X_LEFT_TO_RIGHT
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set host attributes */
id|wait_for_fifo
c_func
(paren
l_int|13
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|HOST_CNTL
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set pattern attributes */
id|aty_st_le32
c_func
(paren
id|PAT_REG0
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|PAT_REG1
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|PAT_CNTL
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set scissors to modal size */
id|aty_st_le32
c_func
(paren
id|SC_LEFT
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|SC_TOP
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|SC_BOTTOM
comma
id|par-&gt;crtc.vyres
op_minus
l_int|1
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|SC_RIGHT
comma
id|pitch_value
op_minus
l_int|1
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set background color to minimum value (usually BLACK) */
id|aty_st_le32
c_func
(paren
id|DP_BKGD_CLR
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set foreground color to maximum value (usually WHITE) */
id|aty_st_le32
c_func
(paren
id|DP_FRGD_CLR
comma
l_int|0xFFFFFFFF
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set write mask to effect all pixel bits */
id|aty_st_le32
c_func
(paren
id|DP_WRITE_MASK
comma
l_int|0xFFFFFFFF
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set foreground mix to overpaint and background mix to */
multiline_comment|/* no-effect */
id|aty_st_le32
c_func
(paren
id|DP_MIX
comma
id|FRGD_MIX_S
op_or
id|BKGD_MIX_D
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set primary source pixel channel to foreground color */
multiline_comment|/* register */
id|aty_st_le32
c_func
(paren
id|DP_SRC
comma
id|FRGD_SRC_FRGD_CLR
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set compare functionality to false (no-effect on */
multiline_comment|/* destination) */
id|wait_for_fifo
c_func
(paren
l_int|3
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CLR_CMP_CLR
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CLR_CMP_MASK
comma
l_int|0xFFFFFFFF
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CLR_CMP_CNTL
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* set pixel depth */
id|wait_for_fifo
c_func
(paren
l_int|2
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_PIX_WIDTH
comma
id|par-&gt;crtc.dp_pix_width
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_CHAIN_MASK
comma
id|par-&gt;crtc.dp_chain_mask
comma
id|par
)paren
suffix:semicolon
id|wait_for_fifo
c_func
(paren
l_int|5
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|SCALE_3D_CNTL
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|Z_CNTL
comma
l_int|0
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|CRTC_INT_CNTL
comma
id|aty_ld_le32
c_func
(paren
id|CRTC_INT_CNTL
comma
id|par
)paren
op_amp
op_complement
l_int|0x20
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|GUI_TRAJ_CNTL
comma
l_int|0x100023
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* insure engine is idle before leaving */
id|wait_for_idle
c_func
(paren
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Accelerated functions&n;     */
DECL|function|draw_rect
r_static
r_inline
r_void
id|draw_rect
c_func
(paren
id|s16
id|x
comma
id|s16
id|y
comma
id|u16
id|width
comma
id|u16
id|height
comma
r_struct
id|atyfb_par
op_star
id|par
)paren
(brace
multiline_comment|/* perform rectangle fill */
id|wait_for_fifo
c_func
(paren
l_int|2
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DST_Y_X
comma
(paren
id|x
op_lshift
l_int|16
)paren
op_or
id|y
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DST_HEIGHT_WIDTH
comma
(paren
id|width
op_lshift
l_int|16
)paren
op_or
id|height
comma
id|par
)paren
suffix:semicolon
id|par-&gt;blitter_may_be_busy
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|atyfb_copyarea
r_void
id|atyfb_copyarea
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_copyarea
op_star
id|area
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|dy
op_assign
id|area-&gt;dy
comma
id|sy
op_assign
id|area-&gt;sy
comma
id|direction
op_assign
id|DST_LAST_PEL
suffix:semicolon
id|u32
id|sx
op_assign
id|area-&gt;sx
comma
id|dx
op_assign
id|area-&gt;dx
comma
id|width
op_assign
id|area-&gt;width
comma
id|rotation
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;asleep
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|area-&gt;width
op_logical_or
op_logical_neg
id|area-&gt;height
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|par-&gt;accel_flags
)paren
(brace
r_if
c_cond
(paren
id|par-&gt;blitter_may_be_busy
)paren
id|wait_for_idle
c_func
(paren
id|par
)paren
suffix:semicolon
id|cfb_copyarea
c_func
(paren
id|info
comma
id|area
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;var.bits_per_pixel
op_eq
l_int|24
)paren
(brace
multiline_comment|/* In 24 bpp, the engine is in 8 bpp - this requires that all */
multiline_comment|/* horizontal coordinates and widths must be adjusted */
id|sx
op_mul_assign
l_int|3
suffix:semicolon
id|dx
op_mul_assign
l_int|3
suffix:semicolon
id|width
op_mul_assign
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|area-&gt;sy
OL
id|area-&gt;dy
)paren
(brace
id|dy
op_add_assign
id|area-&gt;height
op_minus
l_int|1
suffix:semicolon
id|sy
op_add_assign
id|area-&gt;height
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|direction
op_or_assign
id|DST_Y_TOP_TO_BOTTOM
suffix:semicolon
r_if
c_cond
(paren
id|sx
OL
id|dx
)paren
(brace
id|dx
op_add_assign
id|width
op_minus
l_int|1
suffix:semicolon
id|sx
op_add_assign
id|width
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|direction
op_or_assign
id|DST_X_LEFT_TO_RIGHT
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.bits_per_pixel
op_eq
l_int|24
)paren
(brace
id|rotation
op_assign
id|rotation24bpp
c_func
(paren
id|dx
comma
id|direction
)paren
suffix:semicolon
)brace
id|wait_for_fifo
c_func
(paren
l_int|4
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_SRC
comma
id|FRGD_SRC_BLIT
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|SRC_Y_X
comma
(paren
id|sx
op_lshift
l_int|16
)paren
op_or
id|sy
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|SRC_HEIGHT1_WIDTH1
comma
(paren
id|width
op_lshift
l_int|16
)paren
op_or
id|area-&gt;height
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DST_CNTL
comma
id|direction
op_or
id|rotation
comma
id|par
)paren
suffix:semicolon
id|draw_rect
c_func
(paren
id|dx
comma
id|dy
comma
id|width
comma
id|area-&gt;height
comma
id|par
)paren
suffix:semicolon
)brace
DECL|function|atyfb_fillrect
r_void
id|atyfb_fillrect
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_fillrect
op_star
id|rect
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|color
op_assign
id|rect-&gt;color
comma
id|dx
op_assign
id|rect-&gt;dx
comma
id|width
op_assign
id|rect-&gt;width
comma
id|rotation
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;asleep
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rect-&gt;width
op_logical_or
op_logical_neg
id|rect-&gt;height
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|par-&gt;accel_flags
)paren
(brace
r_if
c_cond
(paren
id|par-&gt;blitter_may_be_busy
)paren
id|wait_for_idle
c_func
(paren
id|par
)paren
suffix:semicolon
id|cfb_fillrect
c_func
(paren
id|info
comma
id|rect
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|color
op_or_assign
(paren
id|rect-&gt;color
op_lshift
l_int|8
)paren
suffix:semicolon
id|color
op_or_assign
(paren
id|rect-&gt;color
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;var.bits_per_pixel
op_eq
l_int|24
)paren
(brace
multiline_comment|/* In 24 bpp, the engine is in 8 bpp - this requires that all */
multiline_comment|/* horizontal coordinates and widths must be adjusted */
id|dx
op_mul_assign
l_int|3
suffix:semicolon
id|width
op_mul_assign
l_int|3
suffix:semicolon
id|rotation
op_assign
id|rotation24bpp
c_func
(paren
id|dx
comma
id|DST_X_LEFT_TO_RIGHT
)paren
suffix:semicolon
)brace
id|wait_for_fifo
c_func
(paren
l_int|3
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_FRGD_CLR
comma
id|color
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_SRC
comma
id|BKGD_SRC_BKGD_CLR
op_or
id|FRGD_SRC_FRGD_CLR
op_or
id|MONO_SRC_ONE
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DST_CNTL
comma
id|DST_LAST_PEL
op_or
id|DST_Y_TOP_TO_BOTTOM
op_or
id|DST_X_LEFT_TO_RIGHT
op_or
id|rotation
comma
id|par
)paren
suffix:semicolon
id|draw_rect
c_func
(paren
id|dx
comma
id|rect-&gt;dy
comma
id|width
comma
id|rect-&gt;height
comma
id|par
)paren
suffix:semicolon
)brace
DECL|function|atyfb_imageblit
r_void
id|atyfb_imageblit
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_struct
id|fb_image
op_star
id|image
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|src_bytes
comma
id|dx
op_assign
id|image-&gt;dx
comma
id|dy
op_assign
id|image-&gt;dy
comma
id|width
op_assign
id|image-&gt;width
suffix:semicolon
id|u32
id|pix_width_save
comma
id|pix_width
comma
id|host_cntl
comma
id|rotation
op_assign
l_int|0
comma
id|src
comma
id|mix
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;asleep
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|image-&gt;width
op_logical_or
op_logical_neg
id|image-&gt;height
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|par-&gt;accel_flags
op_logical_or
(paren
id|image-&gt;depth
op_ne
l_int|1
op_logical_and
id|info-&gt;var.bits_per_pixel
op_ne
id|image-&gt;depth
)paren
)paren
(brace
r_if
c_cond
(paren
id|par-&gt;blitter_may_be_busy
)paren
id|wait_for_idle
c_func
(paren
id|par
)paren
suffix:semicolon
id|cfb_imageblit
c_func
(paren
id|info
comma
id|image
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|wait_for_idle
c_func
(paren
id|par
)paren
suffix:semicolon
id|pix_width
op_assign
id|pix_width_save
op_assign
id|aty_ld_le32
c_func
(paren
id|DP_PIX_WIDTH
comma
id|par
)paren
suffix:semicolon
id|host_cntl
op_assign
id|aty_ld_le32
c_func
(paren
id|HOST_CNTL
comma
id|par
)paren
op_or
id|HOST_BYTE_ALIGN
suffix:semicolon
r_switch
c_cond
(paren
id|image-&gt;depth
)paren
(brace
r_case
l_int|1
suffix:colon
id|pix_width
op_and_assign
op_complement
(paren
id|BYTE_ORDER_MASK
op_or
id|HOST_MASK
)paren
suffix:semicolon
id|pix_width
op_or_assign
(paren
id|BYTE_ORDER_MSB_TO_LSB
op_or
id|HOST_1BPP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|pix_width
op_and_assign
op_complement
(paren
id|BYTE_ORDER_MASK
op_or
id|HOST_MASK
)paren
suffix:semicolon
id|pix_width
op_or_assign
(paren
id|BYTE_ORDER_MSB_TO_LSB
op_or
id|HOST_4BPP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|pix_width
op_and_assign
op_complement
id|HOST_MASK
suffix:semicolon
id|pix_width
op_or_assign
id|HOST_8BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
id|pix_width
op_and_assign
op_complement
id|HOST_MASK
suffix:semicolon
id|pix_width
op_or_assign
id|HOST_15BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|pix_width
op_and_assign
op_complement
id|HOST_MASK
suffix:semicolon
id|pix_width
op_or_assign
id|HOST_16BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|pix_width
op_and_assign
op_complement
id|HOST_MASK
suffix:semicolon
id|pix_width
op_or_assign
id|HOST_24BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|pix_width
op_and_assign
op_complement
id|HOST_MASK
suffix:semicolon
id|pix_width
op_or_assign
id|HOST_32BPP
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;var.bits_per_pixel
op_eq
l_int|24
)paren
(brace
multiline_comment|/* In 24 bpp, the engine is in 8 bpp - this requires that all */
multiline_comment|/* horizontal coordinates and widths must be adjusted */
id|dx
op_mul_assign
l_int|3
suffix:semicolon
id|width
op_mul_assign
l_int|3
suffix:semicolon
id|rotation
op_assign
id|rotation24bpp
c_func
(paren
id|dx
comma
id|DST_X_LEFT_TO_RIGHT
)paren
suffix:semicolon
id|pix_width
op_and_assign
op_complement
id|DST_MASK
suffix:semicolon
id|pix_width
op_or_assign
id|DST_8BPP
suffix:semicolon
multiline_comment|/*&n;&t;&t; * since Rage 3D IIc we have DP_HOST_TRIPLE_EN bit&n;&t;&t; * this hwaccelerated triple has an issue with not aligned data&n;&t;&t; */
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|HW_TRIPLE
)paren
op_logical_and
id|image-&gt;width
op_mod
l_int|8
op_eq
l_int|0
)paren
id|pix_width
op_or_assign
id|DP_HOST_TRIPLE_EN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|image-&gt;depth
op_eq
l_int|1
)paren
(brace
id|u32
id|fg
comma
id|bg
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;fix.visual
op_eq
id|FB_VISUAL_TRUECOLOR
op_logical_or
id|info-&gt;fix.visual
op_eq
id|FB_VISUAL_DIRECTCOLOR
)paren
(brace
id|fg
op_assign
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|image-&gt;fg_color
)braket
suffix:semicolon
id|bg
op_assign
(paren
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;pseudo_palette
)paren
)paren
(braket
id|image-&gt;bg_color
)braket
suffix:semicolon
)brace
r_else
(brace
id|fg
op_assign
id|image-&gt;fg_color
suffix:semicolon
id|bg
op_assign
id|image-&gt;bg_color
suffix:semicolon
)brace
id|wait_for_fifo
c_func
(paren
l_int|2
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_BKGD_CLR
comma
id|bg
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_FRGD_CLR
comma
id|fg
comma
id|par
)paren
suffix:semicolon
id|src
op_assign
id|MONO_SRC_HOST
op_or
id|FRGD_SRC_FRGD_CLR
op_or
id|BKGD_SRC_BKGD_CLR
suffix:semicolon
id|mix
op_assign
id|FRGD_MIX_S
op_or
id|BKGD_MIX_S
suffix:semicolon
)brace
r_else
(brace
id|src
op_assign
id|MONO_SRC_ONE
op_or
id|FRGD_SRC_HOST
suffix:semicolon
id|mix
op_assign
id|FRGD_MIX_D_XOR_S
op_or
id|BKGD_MIX_D
suffix:semicolon
)brace
id|wait_for_fifo
c_func
(paren
l_int|6
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_WRITE_MASK
comma
l_int|0xFFFFFFFF
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_PIX_WIDTH
comma
id|pix_width
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_MIX
comma
id|mix
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_SRC
comma
id|src
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|HOST_CNTL
comma
id|host_cntl
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DST_CNTL
comma
id|DST_Y_TOP_TO_BOTTOM
op_or
id|DST_X_LEFT_TO_RIGHT
op_or
id|rotation
comma
id|par
)paren
suffix:semicolon
id|draw_rect
c_func
(paren
id|dx
comma
id|dy
comma
id|width
comma
id|image-&gt;height
comma
id|par
)paren
suffix:semicolon
id|src_bytes
op_assign
(paren
(paren
(paren
id|image-&gt;width
op_star
id|image-&gt;depth
)paren
op_plus
l_int|7
)paren
op_div
l_int|8
)paren
op_star
id|image-&gt;height
suffix:semicolon
multiline_comment|/* manual triple each pixel */
r_if
c_cond
(paren
id|info-&gt;var.bits_per_pixel
op_eq
l_int|24
op_logical_and
op_logical_neg
(paren
id|pix_width
op_amp
id|DP_HOST_TRIPLE_EN
)paren
)paren
(brace
r_int
id|inbit
comma
id|outbit
comma
id|mult24
comma
id|byte_id_in_dword
comma
id|width
suffix:semicolon
id|u8
op_star
id|pbitmapin
op_assign
(paren
id|u8
op_star
)paren
id|image-&gt;data
comma
op_star
id|pbitmapout
suffix:semicolon
id|u32
id|hostdword
suffix:semicolon
r_for
c_loop
(paren
id|width
op_assign
id|image-&gt;width
comma
id|inbit
op_assign
l_int|7
comma
id|mult24
op_assign
l_int|0
suffix:semicolon
id|src_bytes
suffix:semicolon
)paren
(brace
r_for
c_loop
(paren
id|hostdword
op_assign
l_int|0
comma
id|pbitmapout
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|hostdword
comma
id|byte_id_in_dword
op_assign
l_int|0
suffix:semicolon
id|byte_id_in_dword
OL
l_int|4
op_logical_and
id|src_bytes
suffix:semicolon
id|byte_id_in_dword
op_increment
comma
id|pbitmapout
op_increment
)paren
(brace
r_for
c_loop
(paren
id|outbit
op_assign
l_int|7
suffix:semicolon
id|outbit
op_ge
l_int|0
suffix:semicolon
id|outbit
op_decrement
)paren
(brace
op_star
id|pbitmapout
op_or_assign
(paren
(paren
(paren
op_star
id|pbitmapin
op_rshift
id|inbit
)paren
op_amp
l_int|1
)paren
op_lshift
id|outbit
)paren
suffix:semicolon
id|mult24
op_increment
suffix:semicolon
multiline_comment|/* next bit */
r_if
c_cond
(paren
id|mult24
op_eq
l_int|3
)paren
(brace
id|mult24
op_assign
l_int|0
suffix:semicolon
id|inbit
op_decrement
suffix:semicolon
id|width
op_decrement
suffix:semicolon
)brace
multiline_comment|/* next byte */
r_if
c_cond
(paren
id|inbit
OL
l_int|0
op_logical_or
id|width
op_eq
l_int|0
)paren
(brace
id|src_bytes
op_decrement
suffix:semicolon
id|pbitmapin
op_increment
suffix:semicolon
id|inbit
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|width
op_eq
l_int|0
)paren
(brace
id|width
op_assign
id|image-&gt;width
suffix:semicolon
id|outbit
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
)brace
id|wait_for_fifo
c_func
(paren
l_int|1
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|HOST_DATA0
comma
id|hostdword
comma
id|par
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|u32
op_star
id|pbitmap
comma
id|dwords
op_assign
(paren
id|src_bytes
op_plus
l_int|3
)paren
op_div
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|pbitmap
op_assign
(paren
id|u32
op_star
)paren
(paren
id|image-&gt;data
)paren
suffix:semicolon
id|dwords
suffix:semicolon
id|dwords
op_decrement
comma
id|pbitmap
op_increment
)paren
(brace
id|wait_for_fifo
c_func
(paren
l_int|1
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|HOST_DATA0
comma
id|le32_to_cpup
c_func
(paren
id|pbitmap
)paren
comma
id|par
)paren
suffix:semicolon
)brace
)brace
id|wait_for_idle
c_func
(paren
id|par
)paren
suffix:semicolon
multiline_comment|/* restore pix_width */
id|wait_for_fifo
c_func
(paren
l_int|1
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DP_PIX_WIDTH
comma
id|pix_width_save
comma
id|par
)paren
suffix:semicolon
)brace
eof
