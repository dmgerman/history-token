multiline_comment|/*&n; *  ATI Mach64 CT/VT/GT/LT Support&n; */
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;video/mach64.h&gt;
macro_line|#include &quot;atyfb.h&quot;
DECL|macro|DEBUG
macro_line|#undef DEBUG
r_static
r_int
id|aty_valid_pll_ct
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
id|u32
id|vclk_per
comma
r_struct
id|pll_ct
op_star
id|pll
)paren
suffix:semicolon
r_static
r_int
id|aty_dsp_gt
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
id|u32
id|bpp
comma
r_struct
id|pll_ct
op_star
id|pll
)paren
suffix:semicolon
r_static
r_int
id|aty_var_to_pll_ct
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
id|u32
id|vclk_per
comma
id|u32
id|bpp
comma
r_union
id|aty_pll
op_star
id|pll
)paren
suffix:semicolon
r_static
id|u32
id|aty_pll_to_var_ct
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
suffix:semicolon
DECL|function|aty_ld_pll_ct
id|u8
id|aty_ld_pll_ct
c_func
(paren
r_int
id|offset
comma
r_const
r_struct
id|atyfb_par
op_star
id|par
)paren
(brace
id|u8
id|res
suffix:semicolon
multiline_comment|/* write addr byte */
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL_ADDR
comma
(paren
id|offset
op_lshift
l_int|2
)paren
op_amp
id|PLL_ADDR
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* read the register value */
id|res
op_assign
id|aty_ld_8
c_func
(paren
id|CLOCK_CNTL_DATA
comma
id|par
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|aty_st_pll_ct
r_void
id|aty_st_pll_ct
c_func
(paren
r_int
id|offset
comma
id|u8
id|val
comma
r_const
r_struct
id|atyfb_par
op_star
id|par
)paren
(brace
multiline_comment|/* write addr byte */
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL_ADDR
comma
(paren
(paren
id|offset
op_lshift
l_int|2
)paren
op_amp
id|PLL_ADDR
)paren
op_or
id|PLL_WR_EN
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* write the register value */
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL_DATA
comma
id|val
op_amp
id|PLL_DATA
comma
id|par
)paren
suffix:semicolon
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL_ADDR
comma
(paren
(paren
id|offset
op_lshift
l_int|2
)paren
op_amp
id|PLL_ADDR
)paren
op_amp
op_complement
id|PLL_WR_EN
comma
id|par
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * by Daniel Mantione&n; *                                  &lt;daniel.mantione@freepascal.org&gt;&n; *&n; *&n; * ATI Mach64 CT clock synthesis description.&n; *&n; * All clocks on the Mach64 can be calculated using the same principle:&n; *&n; *       XTALIN * x * FB_DIV&n; * CLK = ----------------------&n; *       PLL_REF_DIV * POST_DIV&n; *&n; * XTALIN is a fixed speed clock. Common speeds are 14.31 MHz and 29.50 MHz.&n; * PLL_REF_DIV can be set by the user, but is the same for all clocks.&n; * FB_DIV can be set by the user for each clock individually, it should be set&n; * between 128 and 255, the chip will generate a bad clock signal for too low&n; * values.&n; * x depends on the type of clock; usually it is 2, but for the MCLK it can also&n; * be set to 4.&n; * POST_DIV can be set by the user for each clock individually, Possible values&n; * are 1,2,4,8 and for some clocks other values are available too.&n; * CLK is of course the clock speed that is generated.&n; *&n; * The Mach64 has these clocks:&n; *&n; * MCLK&t;&t;&t;The clock rate of the chip&n; * XCLK&t;&t;&t;The clock rate of the on-chip memory&n; * VCLK0&t;&t;First pixel clock of first CRT controller&n; * VCLK1    Second pixel clock of first CRT controller&n; * VCLK2&t;&t;Third pixel clock of first CRT controller&n; * VCLK3    Fourth pixel clock of first CRT controller&n; * VCLK&t;&t;&t;Selected pixel clock, one of VCLK0, VCLK1, VCLK2, VCLK3&n; * V2CLK&t;&t;Pixel clock of the second CRT controller.&n; * SCLK&t;&t;&t;Multi-purpose clock&n; *&n; * - MCLK and XCLK use the same FB_DIV&n; * - VCLK0 .. VCLK3 use the same FB_DIV&n; * - V2CLK is needed when the second CRTC is used (can be used for dualhead);&n; *   i.e. CRT monitor connected to laptop has different resolution than built&n; *   in LCD monitor.&n; * - SCLK is not available on all cards; it is know to exist on the Rage LT-PRO,&n; *   Rage XL and Rage Mobility. It is know not to exist on the Mach64 VT.&n; * - V2CLK is not available on all cards, most likely only the Rage LT-PRO,&n; *   the Rage XL and the Rage Mobility&n; *&n; * SCLK can be used to:&n; * - Clock the chip instead of MCLK&n; * - Replace XTALIN with a user defined frequency&n; * - Generate the pixel clock for the LCD monitor (instead of VCLK)&n; */
multiline_comment|/*&n;  * It can be quite hard to calculate XCLK and MCLK if they don&squot;t run at the&n;  * same frequency. Luckily, until now all cards that need asynchrone clock&n;  * speeds seem to have SCLK.&n;  * So this driver uses SCLK to clock the chip and XCLK to clock the memory.&n;  */
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/*&n; *  PLL programming (Mach64 CT family)&n; *&n; *&n; * This procedure sets the display fifo. The display fifo is a buffer that&n; * contains data read from the video memory that waits to be processed by&n; * the CRT controller.&n; *&n; * On the more modern Mach64 variants, the chip doesn&squot;t calculate the&n; * interval after which the display fifo has to be reloaded from memory&n; * automatically, the driver has to do it instead.&n; */
DECL|macro|Maximum_DSP_PRECISION
mdefine_line|#define Maximum_DSP_PRECISION 7
DECL|variable|postdividers
r_static
id|u8
id|postdividers
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|4
comma
l_int|8
comma
l_int|3
)brace
suffix:semicolon
DECL|function|aty_dsp_gt
r_static
r_int
id|aty_dsp_gt
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
id|u32
id|bpp
comma
r_struct
id|pll_ct
op_star
id|pll
)paren
(brace
id|u32
id|dsp_off
comma
id|dsp_on
comma
id|dsp_xclks
suffix:semicolon
id|u32
id|multiplier
comma
id|divider
comma
id|ras_multiplier
comma
id|ras_divider
comma
id|tmp
suffix:semicolon
id|u8
id|vshift
comma
id|xshift
suffix:semicolon
id|s8
id|dsp_precision
suffix:semicolon
id|multiplier
op_assign
(paren
(paren
id|u32
)paren
id|pll-&gt;mclk_fb_div
)paren
op_star
id|pll-&gt;vclk_post_div_real
suffix:semicolon
id|divider
op_assign
(paren
(paren
id|u32
)paren
id|pll-&gt;vclk_fb_div
)paren
op_star
id|pll-&gt;xclk_ref_div
suffix:semicolon
id|ras_multiplier
op_assign
id|pll-&gt;xclkmaxrasdelay
suffix:semicolon
id|ras_divider
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|bpp
op_ge
l_int|8
)paren
id|divider
op_assign
id|divider
op_star
(paren
id|bpp
op_rshift
l_int|2
)paren
suffix:semicolon
id|vshift
op_assign
(paren
l_int|6
op_minus
l_int|2
)paren
op_minus
id|pll-&gt;xclk_post_div
suffix:semicolon
multiline_comment|/* FIFO is 64 bits wide in accelerator mode ... */
r_if
c_cond
(paren
id|bpp
op_eq
l_int|0
)paren
id|vshift
op_decrement
suffix:semicolon
multiline_comment|/* ... but only 32 bits in VGA mode. */
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
r_if
c_cond
(paren
id|pll-&gt;xres
op_ne
l_int|0
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|multiplier
op_assign
id|multiplier
op_star
id|par-&gt;lcd_width
suffix:semicolon
id|divider
op_assign
id|divider
op_star
id|pll-&gt;xres
op_amp
op_complement
l_int|7
suffix:semicolon
id|ras_multiplier
op_assign
id|ras_multiplier
op_star
id|par-&gt;lcd_width
suffix:semicolon
id|ras_divider
op_assign
id|ras_divider
op_star
id|pll-&gt;xres
op_amp
op_complement
l_int|7
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* If we don&squot;t do this, 32 bits for multiplier &amp; divider won&squot;t be&n;&t;enough in certain situations! */
r_while
c_loop
(paren
(paren
(paren
id|multiplier
op_or
id|divider
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|multiplier
op_assign
id|multiplier
op_rshift
l_int|1
suffix:semicolon
id|divider
op_assign
id|divider
op_rshift
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Determine DSP precision first */
id|tmp
op_assign
(paren
(paren
id|multiplier
op_star
id|pll-&gt;fifo_size
)paren
op_lshift
id|vshift
)paren
op_div
id|divider
suffix:semicolon
r_for
c_loop
(paren
id|dsp_precision
op_assign
op_minus
l_int|5
suffix:semicolon
id|tmp
suffix:semicolon
id|dsp_precision
op_increment
)paren
id|tmp
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dsp_precision
OL
l_int|0
)paren
id|dsp_precision
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dsp_precision
OG
id|Maximum_DSP_PRECISION
)paren
id|dsp_precision
op_assign
id|Maximum_DSP_PRECISION
suffix:semicolon
id|xshift
op_assign
l_int|6
op_minus
id|dsp_precision
suffix:semicolon
id|vshift
op_add_assign
id|xshift
suffix:semicolon
multiline_comment|/* Move on to dsp_off */
id|dsp_off
op_assign
(paren
(paren
id|multiplier
op_star
(paren
id|pll-&gt;fifo_size
op_minus
l_int|1
)paren
)paren
op_lshift
id|vshift
)paren
op_div
id|divider
op_minus
(paren
l_int|1
op_lshift
(paren
id|vshift
op_minus
id|xshift
)paren
)paren
suffix:semicolon
multiline_comment|/*    if (bpp == 0)&n;        dsp_on = ((multiplier * 20 &lt;&lt; vshift) + divider) / divider;&n;    else */
(brace
id|dsp_on
op_assign
(paren
(paren
id|multiplier
op_lshift
id|vshift
)paren
op_plus
id|divider
)paren
op_div
id|divider
suffix:semicolon
id|tmp
op_assign
(paren
(paren
id|ras_multiplier
op_lshift
id|xshift
)paren
op_plus
id|ras_divider
)paren
op_div
id|ras_divider
suffix:semicolon
r_if
c_cond
(paren
id|dsp_on
OL
id|tmp
)paren
id|dsp_on
op_assign
id|tmp
suffix:semicolon
id|dsp_on
op_assign
id|dsp_on
op_plus
(paren
id|tmp
op_star
l_int|2
)paren
op_plus
(paren
id|pll-&gt;xclkpagefaultdelay
op_lshift
id|xshift
)paren
suffix:semicolon
)brace
multiline_comment|/* Calculate rounding factor and apply it to dsp_on */
id|tmp
op_assign
(paren
(paren
l_int|1
op_lshift
(paren
id|Maximum_DSP_PRECISION
op_minus
id|dsp_precision
)paren
)paren
op_minus
l_int|1
)paren
op_rshift
l_int|1
suffix:semicolon
id|dsp_on
op_assign
(paren
(paren
id|dsp_on
op_plus
id|tmp
)paren
op_div
(paren
id|tmp
op_plus
l_int|1
)paren
)paren
op_star
(paren
id|tmp
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp_on
op_ge
(paren
(paren
id|dsp_off
op_div
(paren
id|tmp
op_plus
l_int|1
)paren
)paren
op_star
(paren
id|tmp
op_plus
l_int|1
)paren
)paren
)paren
(brace
id|dsp_on
op_assign
id|dsp_off
op_minus
(paren
id|multiplier
op_lshift
id|vshift
)paren
op_div
id|divider
suffix:semicolon
id|dsp_on
op_assign
(paren
id|dsp_on
op_div
(paren
id|tmp
op_plus
l_int|1
)paren
)paren
op_star
(paren
id|tmp
op_plus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Last but not least:  dsp_xclks */
id|dsp_xclks
op_assign
(paren
(paren
id|multiplier
op_lshift
(paren
id|vshift
op_plus
l_int|5
)paren
)paren
op_plus
id|divider
)paren
op_div
id|divider
suffix:semicolon
multiline_comment|/* Get register values. */
id|pll-&gt;dsp_on_off
op_assign
(paren
id|dsp_on
op_lshift
l_int|16
)paren
op_plus
id|dsp_off
suffix:semicolon
id|pll-&gt;dsp_config
op_assign
(paren
id|dsp_precision
op_lshift
l_int|20
)paren
op_or
(paren
id|pll-&gt;dsp_loop_latency
op_lshift
l_int|16
)paren
op_or
id|dsp_xclks
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;atyfb(%s): dsp_config 0x%08x, dsp_on_off 0x%08x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pll-&gt;dsp_config
comma
id|pll-&gt;dsp_on_off
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aty_valid_pll_ct
r_static
r_int
id|aty_valid_pll_ct
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
id|u32
id|vclk_per
comma
r_struct
id|pll_ct
op_star
id|pll
)paren
(brace
id|u32
id|q
suffix:semicolon
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
macro_line|#ifdef DEBUG
r_int
id|pllvclk
suffix:semicolon
macro_line|#endif
multiline_comment|/* FIXME: use the VTB/GTB /{3,6,12} post dividers if they&squot;re better suited */
id|q
op_assign
id|par-&gt;ref_clk_per
op_star
id|pll-&gt;pll_ref_div
op_star
l_int|4
op_div
id|vclk_per
suffix:semicolon
r_if
c_cond
(paren
id|q
template_param
l_int|255
op_star
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;atyfb: vclk out of range&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|pll-&gt;vclk_post_div
op_assign
(paren
id|q
OL
l_int|128
op_star
l_int|8
)paren
suffix:semicolon
id|pll-&gt;vclk_post_div
op_add_assign
(paren
id|q
OL
l_int|64
op_star
l_int|8
)paren
suffix:semicolon
id|pll-&gt;vclk_post_div
op_add_assign
(paren
id|q
OL
l_int|32
op_star
l_int|8
)paren
suffix:semicolon
)brace
id|pll-&gt;vclk_post_div_real
op_assign
id|postdividers
(braket
id|pll-&gt;vclk_post_div
)braket
suffix:semicolon
singleline_comment|//    pll-&gt;vclk_post_div &lt;&lt;= 6;
id|pll-&gt;vclk_fb_div
op_assign
id|q
op_star
id|pll-&gt;vclk_post_div_real
op_div
l_int|8
suffix:semicolon
macro_line|#ifdef DEBUG
id|pllvclk
op_assign
(paren
l_int|1000000
op_star
l_int|2
op_star
id|pll-&gt;vclk_fb_div
)paren
op_div
(paren
id|par-&gt;ref_clk_per
op_star
id|pll-&gt;pll_ref_div
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;atyfb(%s): pllvclk=%d MHz, vclk=%d MHz&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pllvclk
comma
id|pllvclk
op_div
id|pll-&gt;vclk_post_div_real
)paren
suffix:semicolon
macro_line|#endif
id|pll-&gt;pll_vclk_cntl
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* VCLK = PLL_VCLK/VCLKx_POST */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aty_var_to_pll_ct
r_static
r_int
id|aty_var_to_pll_ct
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
id|u32
id|vclk_per
comma
id|u32
id|bpp
comma
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|aty_valid_pll_ct
c_func
(paren
id|info
comma
id|vclk_per
comma
op_amp
id|pll-&gt;ct
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|GTB_DSP
)paren
op_logical_and
(paren
id|err
op_assign
id|aty_dsp_gt
c_func
(paren
id|info
comma
id|bpp
comma
op_amp
id|pll-&gt;ct
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/*aty_calc_pll_ct(info, &amp;pll-&gt;ct);*/
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aty_pll_to_var_ct
r_static
id|u32
id|aty_pll_to_var_ct
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|ret
suffix:semicolon
id|ret
op_assign
id|par-&gt;ref_clk_per
op_star
id|pll-&gt;ct.pll_ref_div
op_star
id|pll-&gt;ct.vclk_post_div_real
op_div
id|pll-&gt;ct.vclk_fb_div
op_div
l_int|2
suffix:semicolon
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
r_if
c_cond
(paren
id|pll-&gt;ct.xres
OG
l_int|0
)paren
(brace
id|ret
op_mul_assign
id|par-&gt;lcd_width
suffix:semicolon
id|ret
op_div_assign
id|pll-&gt;ct.xres
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;atyfb(%s): calculated 0x%08X(%i)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ret
comma
id|ret
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
DECL|function|aty_set_pll_ct
r_void
id|aty_set_pll_ct
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
r_const
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u32
id|crtc_gen_cntl
comma
id|lcd_gen_cntrl
suffix:semicolon
id|u8
id|tmp
comma
id|tmp2
suffix:semicolon
id|lcd_gen_cntrl
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;atyfb(%s): about to program:&bslash;n&quot;
l_string|&quot;pll_ext_cntl=0x%02x pll_gen_cntl=0x%02x pll_vclk_cntl=0x%02x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pll-&gt;ct.pll_ext_cntl
comma
id|pll-&gt;ct.pll_gen_cntl
comma
id|pll-&gt;ct.pll_vclk_cntl
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;atyfb(%s): setting clock %lu for FeedBackDivider %i, ReferenceDivider %i, PostDivider %i(%i)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|par-&gt;clk_wr_offset
comma
id|pll-&gt;ct.vclk_fb_div
comma
id|pll-&gt;ct.pll_ref_div
comma
id|pll-&gt;ct.vclk_post_div
comma
id|pll-&gt;ct.vclk_post_div_real
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
r_if
c_cond
(paren
id|par-&gt;lcd_table
op_ne
l_int|0
)paren
(brace
multiline_comment|/* turn off LCD */
id|lcd_gen_cntrl
op_assign
id|aty_ld_lcd
c_func
(paren
id|LCD_GEN_CNTL
comma
id|par
)paren
suffix:semicolon
id|aty_st_lcd
c_func
(paren
id|LCD_GEN_CNTL
comma
id|lcd_gen_cntrl
op_amp
op_complement
id|LCD_ON
comma
id|par
)paren
suffix:semicolon
)brace
macro_line|#endif
id|aty_st_8
c_func
(paren
id|CLOCK_CNTL
comma
id|par-&gt;clk_wr_offset
op_or
id|CLOCK_STROBE
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* Temporarily switch to accelerator mode */
id|crtc_gen_cntl
op_assign
id|aty_ld_le32
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|par
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|crtc_gen_cntl
op_amp
id|CRTC_EXT_DISP_EN
)paren
)paren
id|aty_st_le32
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|crtc_gen_cntl
op_or
id|CRTC_EXT_DISP_EN
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* Reset VCLK generator */
id|aty_st_pll_ct
c_func
(paren
id|PLL_VCLK_CNTL
comma
id|pll-&gt;ct.pll_vclk_cntl
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* Set post-divider */
id|tmp2
op_assign
id|par-&gt;clk_wr_offset
op_lshift
l_int|1
suffix:semicolon
id|tmp
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|VCLK_POST_DIV
comma
id|par
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
l_int|0x03U
op_lshift
id|tmp2
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
(paren
id|pll-&gt;ct.vclk_post_div
op_amp
l_int|0x03U
)paren
op_lshift
id|tmp2
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|VCLK_POST_DIV
comma
id|tmp
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* Set extended post-divider */
id|tmp
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|PLL_EXT_CNTL
comma
id|par
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
l_int|0x10U
op_lshift
id|par-&gt;clk_wr_offset
)paren
suffix:semicolon
id|tmp
op_and_assign
l_int|0xF0U
suffix:semicolon
id|tmp
op_or_assign
id|pll-&gt;ct.pll_ext_cntl
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|PLL_EXT_CNTL
comma
id|tmp
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* Set feedback divider */
id|tmp
op_assign
id|VCLK0_FB_DIV
op_plus
id|par-&gt;clk_wr_offset
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|tmp
comma
(paren
id|pll-&gt;ct.vclk_fb_div
op_amp
l_int|0xFFU
)paren
comma
id|par
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|PLL_GEN_CNTL
comma
(paren
id|pll-&gt;ct.pll_gen_cntl
op_amp
(paren
op_complement
(paren
id|PLL_OVERRIDE
op_or
id|PLL_MCLK_RST
)paren
)paren
)paren
op_or
id|OSC_EN
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* End VCLK generator reset */
id|aty_st_pll_ct
c_func
(paren
id|PLL_VCLK_CNTL
comma
id|pll-&gt;ct.pll_vclk_cntl
op_amp
op_complement
(paren
id|PLL_VCLK_RST
)paren
comma
id|par
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|PLL_GEN_CNTL
comma
id|pll-&gt;ct.pll_gen_cntl
comma
id|par
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|PLL_VCLK_CNTL
comma
id|pll-&gt;ct.pll_vclk_cntl
comma
id|par
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Restore mode register */
r_if
c_cond
(paren
op_logical_neg
(paren
id|crtc_gen_cntl
op_amp
id|CRTC_EXT_DISP_EN
)paren
)paren
id|aty_st_le32
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|crtc_gen_cntl
comma
id|par
)paren
suffix:semicolon
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|GTB_DSP
)paren
)paren
(brace
id|u8
id|dll_cntl
suffix:semicolon
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|XL_DLL
)paren
)paren
id|dll_cntl
op_assign
l_int|0x80
suffix:semicolon
r_else
r_if
c_cond
(paren
id|par-&gt;ram_type
op_ge
id|SDRAM
)paren
id|dll_cntl
op_assign
l_int|0xa6
suffix:semicolon
r_else
id|dll_cntl
op_assign
l_int|0xa0
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|DLL_CNTL
comma
id|dll_cntl
comma
id|par
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|VFC_CNTL
comma
l_int|0x1b
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DSP_CONFIG
comma
id|pll-&gt;ct.dsp_config
comma
id|par
)paren
suffix:semicolon
id|aty_st_le32
c_func
(paren
id|DSP_ON_OFF
comma
id|pll-&gt;ct.dsp_on_off
comma
id|par
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|DLL_CNTL
comma
id|dll_cntl
comma
id|par
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|DLL_CNTL
comma
id|dll_cntl
op_or
l_int|0x40
comma
id|par
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|DLL_CNTL
comma
id|dll_cntl
op_amp
op_complement
l_int|0x40
comma
id|par
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_FB_ATY_GENERIC_LCD
r_if
c_cond
(paren
id|par-&gt;lcd_table
op_ne
l_int|0
)paren
(brace
multiline_comment|/* restore LCD */
id|aty_st_lcd
c_func
(paren
id|LCD_GEN_CNTL
comma
id|lcd_gen_cntrl
comma
id|par
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|aty_get_pll_ct
r_void
id|__init
id|aty_get_pll_ct
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u8
id|tmp
comma
id|clock
suffix:semicolon
id|clock
op_assign
id|aty_ld_8
c_func
(paren
id|CLOCK_CNTL
comma
id|par
)paren
op_amp
l_int|0x03U
suffix:semicolon
id|tmp
op_assign
id|clock
op_lshift
l_int|1
suffix:semicolon
id|pll-&gt;ct.vclk_post_div
op_assign
(paren
id|aty_ld_pll_ct
c_func
(paren
id|VCLK_POST_DIV
comma
id|par
)paren
op_rshift
id|tmp
)paren
op_amp
l_int|0x03U
suffix:semicolon
id|pll-&gt;ct.pll_ext_cntl
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|PLL_EXT_CNTL
comma
id|par
)paren
op_amp
l_int|0x0FU
suffix:semicolon
id|pll-&gt;ct.vclk_fb_div
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|VCLK0_FB_DIV
op_plus
id|clock
comma
id|par
)paren
op_amp
l_int|0xFFU
suffix:semicolon
id|pll-&gt;ct.pll_ref_div
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|PLL_REF_DIV
comma
id|par
)paren
suffix:semicolon
id|pll-&gt;ct.mclk_fb_div
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|MCLK_FB_DIV
comma
id|par
)paren
suffix:semicolon
id|pll-&gt;ct.pll_gen_cntl
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|PLL_GEN_CNTL
comma
id|par
)paren
suffix:semicolon
id|pll-&gt;ct.pll_vclk_cntl
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|PLL_VCLK_CNTL
comma
id|par
)paren
suffix:semicolon
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|GTB_DSP
)paren
)paren
(brace
id|pll-&gt;ct.dsp_config
op_assign
id|aty_ld_le32
c_func
(paren
id|DSP_CONFIG
comma
id|par
)paren
suffix:semicolon
id|pll-&gt;ct.dsp_on_off
op_assign
id|aty_ld_le32
c_func
(paren
id|DSP_ON_OFF
comma
id|par
)paren
suffix:semicolon
)brace
)brace
DECL|function|aty_init_pll_ct
r_int
id|__init
id|aty_init_pll_ct
c_func
(paren
r_const
r_struct
id|fb_info
op_star
id|info
comma
r_union
id|aty_pll
op_star
id|pll
)paren
(brace
r_struct
id|atyfb_par
op_star
id|par
op_assign
(paren
r_struct
id|atyfb_par
op_star
)paren
id|info-&gt;par
suffix:semicolon
id|u8
id|mpost_div
comma
id|xpost_div
comma
id|sclk_post_div_real
comma
id|sclk_fb_div
comma
id|spll_cntl2
suffix:semicolon
id|u32
id|q
comma
id|i
comma
id|memcntl
comma
id|trp
suffix:semicolon
id|u32
id|dsp_config
comma
id|dsp_on_off
comma
id|vga_dsp_config
comma
id|vga_dsp_on_off
suffix:semicolon
macro_line|#ifdef DEBUG
r_int
id|pllmclk
comma
id|pllsclk
suffix:semicolon
macro_line|#endif
id|pll-&gt;ct.pll_ext_cntl
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|PLL_EXT_CNTL
comma
id|par
)paren
suffix:semicolon
id|pll-&gt;ct.xclk_post_div
op_assign
id|pll-&gt;ct.pll_ext_cntl
op_amp
l_int|0x07
suffix:semicolon
id|pll-&gt;ct.xclk_ref_div
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|pll-&gt;ct.xclk_post_div
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|1
suffix:colon
r_case
l_int|2
suffix:colon
r_case
l_int|3
suffix:colon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|pll-&gt;ct.xclk_ref_div
op_assign
l_int|3
suffix:semicolon
id|pll-&gt;ct.xclk_post_div
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;atyfb: Unsupported xclk source:  %d.&bslash;n&quot;
comma
id|pll-&gt;ct.xclk_post_div
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pll-&gt;ct.mclk_fb_mult
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|pll-&gt;ct.pll_ext_cntl
op_amp
id|PLL_MFB_TIMES_4_2B
)paren
(brace
id|pll-&gt;ct.mclk_fb_mult
op_assign
l_int|4
suffix:semicolon
id|pll-&gt;ct.xclk_post_div
op_sub_assign
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;atyfb(%s): mclk_fb_mult=%d, xclk_post_div=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pll-&gt;ct.mclk_fb_mult
comma
id|pll-&gt;ct.xclk_post_div
)paren
suffix:semicolon
macro_line|#endif
id|memcntl
op_assign
id|aty_ld_le32
c_func
(paren
id|MEM_CNTL
comma
id|par
)paren
suffix:semicolon
id|trp
op_assign
(paren
id|memcntl
op_amp
l_int|0x300
)paren
op_rshift
l_int|8
suffix:semicolon
id|pll-&gt;ct.xclkpagefaultdelay
op_assign
(paren
(paren
id|memcntl
op_amp
l_int|0xc00
)paren
op_rshift
l_int|10
)paren
op_plus
(paren
(paren
id|memcntl
op_amp
l_int|0x1000
)paren
op_rshift
l_int|12
)paren
op_plus
id|trp
op_plus
l_int|2
suffix:semicolon
id|pll-&gt;ct.xclkmaxrasdelay
op_assign
(paren
(paren
id|memcntl
op_amp
l_int|0x70000
)paren
op_rshift
l_int|16
)paren
op_plus
id|trp
op_plus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|FIFO_32
)paren
)paren
(brace
id|pll-&gt;ct.fifo_size
op_assign
l_int|32
suffix:semicolon
)brace
r_else
(brace
id|pll-&gt;ct.fifo_size
op_assign
l_int|24
suffix:semicolon
id|pll-&gt;ct.xclkpagefaultdelay
op_add_assign
l_int|2
suffix:semicolon
id|pll-&gt;ct.xclkmaxrasdelay
op_add_assign
l_int|3
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|par-&gt;ram_type
)paren
(brace
r_case
id|DRAM
suffix:colon
r_if
c_cond
(paren
id|info-&gt;fix.smem_len
op_le
id|ONE_MB
)paren
(brace
id|pll-&gt;ct.dsp_loop_latency
op_assign
l_int|10
suffix:semicolon
)brace
r_else
(brace
id|pll-&gt;ct.dsp_loop_latency
op_assign
l_int|8
suffix:semicolon
id|pll-&gt;ct.xclkpagefaultdelay
op_add_assign
l_int|2
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|EDO
suffix:colon
r_case
id|PSEUDO_EDO
suffix:colon
r_if
c_cond
(paren
id|info-&gt;fix.smem_len
op_le
id|ONE_MB
)paren
(brace
id|pll-&gt;ct.dsp_loop_latency
op_assign
l_int|9
suffix:semicolon
)brace
r_else
(brace
id|pll-&gt;ct.dsp_loop_latency
op_assign
l_int|8
suffix:semicolon
id|pll-&gt;ct.xclkpagefaultdelay
op_add_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SDRAM
suffix:colon
r_if
c_cond
(paren
id|info-&gt;fix.smem_len
op_le
id|ONE_MB
)paren
(brace
id|pll-&gt;ct.dsp_loop_latency
op_assign
l_int|11
suffix:semicolon
)brace
r_else
(brace
id|pll-&gt;ct.dsp_loop_latency
op_assign
l_int|10
suffix:semicolon
id|pll-&gt;ct.xclkpagefaultdelay
op_add_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SGRAM
suffix:colon
id|pll-&gt;ct.dsp_loop_latency
op_assign
l_int|8
suffix:semicolon
id|pll-&gt;ct.xclkpagefaultdelay
op_add_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|pll-&gt;ct.dsp_loop_latency
op_assign
l_int|11
suffix:semicolon
id|pll-&gt;ct.xclkpagefaultdelay
op_add_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pll-&gt;ct.xclkmaxrasdelay
op_le
id|pll-&gt;ct.xclkpagefaultdelay
)paren
id|pll-&gt;ct.xclkmaxrasdelay
op_assign
id|pll-&gt;ct.xclkpagefaultdelay
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Allow BIOS to override */
id|dsp_config
op_assign
id|aty_ld_le32
c_func
(paren
id|DSP_CONFIG
comma
id|par
)paren
suffix:semicolon
id|dsp_on_off
op_assign
id|aty_ld_le32
c_func
(paren
id|DSP_ON_OFF
comma
id|par
)paren
suffix:semicolon
id|vga_dsp_config
op_assign
id|aty_ld_le32
c_func
(paren
id|VGA_DSP_CONFIG
comma
id|par
)paren
suffix:semicolon
id|vga_dsp_on_off
op_assign
id|aty_ld_le32
c_func
(paren
id|VGA_DSP_ON_OFF
comma
id|par
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp_config
)paren
id|pll-&gt;ct.dsp_loop_latency
op_assign
(paren
id|dsp_config
op_amp
id|DSP_LOOP_LATENCY
)paren
op_rshift
l_int|16
suffix:semicolon
macro_line|#if 0
id|FIXME
suffix:colon
id|is
id|it
id|relevant
r_for
c_loop
id|us
ques
c_cond
r_if
c_cond
(paren
(paren
op_logical_neg
id|dsp_on_off
op_logical_and
op_logical_neg
id|M64_HAS
c_func
(paren
id|RESET_3D
)paren
)paren
op_logical_or
(paren
(paren
id|dsp_on_off
op_eq
id|vga_dsp_on_off
)paren
op_logical_and
(paren
op_logical_neg
id|dsp_config
op_logical_or
op_logical_neg
(paren
(paren
id|dsp_config
op_xor
id|vga_dsp_config
)paren
op_amp
id|DSP_XCLKS_PER_QW
)paren
)paren
)paren
)paren
(brace
id|vga_dsp_on_off
op_and_assign
id|VGA_DSP_OFF
suffix:semicolon
id|vga_dsp_config
op_and_assign
id|VGA_DSP_XCLKS_PER_QW
suffix:semicolon
r_if
c_cond
(paren
id|ATIDivide
c_func
(paren
id|vga_dsp_on_off
comma
id|vga_dsp_config
comma
l_int|5
comma
l_int|1
)paren
OG
l_int|24
)paren
id|pll-&gt;ct.fifo_size
op_assign
l_int|32
suffix:semicolon
r_else
id|pll-&gt;ct.fifo_size
op_assign
l_int|24
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Exit if the user does not want us to tamper with the clock&n;&t;rates of her chip. */
r_if
c_cond
(paren
id|par-&gt;mclk_per
op_eq
l_int|0
)paren
(brace
id|u8
id|mclk_fb_div
comma
id|pll_ext_cntl
suffix:semicolon
id|pll-&gt;ct.pll_ref_div
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|PLL_REF_DIV
comma
id|par
)paren
suffix:semicolon
id|pll_ext_cntl
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|PLL_EXT_CNTL
comma
id|par
)paren
suffix:semicolon
id|pll-&gt;ct.xclk_post_div_real
op_assign
id|postdividers
(braket
id|pll_ext_cntl
op_amp
l_int|0x07
)braket
suffix:semicolon
id|mclk_fb_div
op_assign
id|aty_ld_pll_ct
c_func
(paren
id|MCLK_FB_DIV
comma
id|par
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pll_ext_cntl
op_amp
id|PLL_MFB_TIMES_4_2B
)paren
id|mclk_fb_div
op_lshift_assign
l_int|1
suffix:semicolon
id|pll-&gt;ct.mclk_fb_div
op_assign
id|mclk_fb_div
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pll-&gt;ct.pll_ref_div
op_assign
id|par-&gt;pll_per
op_star
l_int|2
op_star
l_int|255
op_div
id|par-&gt;ref_clk_per
suffix:semicolon
multiline_comment|/* FIXME: use the VTB/GTB /3 post divider if it&squot;s better suited */
id|q
op_assign
id|par-&gt;ref_clk_per
op_star
id|pll-&gt;ct.pll_ref_div
op_star
l_int|8
op_div
(paren
id|pll-&gt;ct.mclk_fb_mult
op_star
id|par-&gt;xclk_per
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
template_param
l_int|255
op_star
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;atxfb: xclk out of range&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|xpost_div
op_assign
(paren
id|q
OL
l_int|128
op_star
l_int|8
)paren
suffix:semicolon
id|xpost_div
op_add_assign
(paren
id|q
OL
l_int|64
op_star
l_int|8
)paren
suffix:semicolon
id|xpost_div
op_add_assign
(paren
id|q
OL
l_int|32
op_star
l_int|8
)paren
suffix:semicolon
)brace
id|pll-&gt;ct.xclk_post_div_real
op_assign
id|postdividers
(braket
id|xpost_div
)braket
suffix:semicolon
id|pll-&gt;ct.mclk_fb_div
op_assign
id|q
op_star
id|pll-&gt;ct.xclk_post_div_real
op_div
l_int|8
suffix:semicolon
macro_line|#ifdef DEBUG
id|pllmclk
op_assign
(paren
l_int|1000000
op_star
id|pll-&gt;ct.mclk_fb_mult
op_star
id|pll-&gt;ct.mclk_fb_div
)paren
op_div
(paren
id|par-&gt;ref_clk_per
op_star
id|pll-&gt;ct.pll_ref_div
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;atyfb(%s): pllmclk=%d MHz, xclk=%d MHz&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pllmclk
comma
id|pllmclk
op_div
id|pll-&gt;ct.xclk_post_div_real
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|SDRAM_MAGIC_PLL
)paren
op_logical_and
(paren
id|par-&gt;ram_type
op_ge
id|SDRAM
)paren
)paren
id|pll-&gt;ct.pll_gen_cntl
op_assign
id|OSC_EN
suffix:semicolon
r_else
id|pll-&gt;ct.pll_gen_cntl
op_assign
id|OSC_EN
op_or
id|DLL_PWDN
multiline_comment|/* | FORCE_DCLK_TRI_STATE */
suffix:semicolon
r_if
c_cond
(paren
id|M64_HAS
c_func
(paren
id|MAGIC_POSTDIV
)paren
)paren
id|pll-&gt;ct.pll_ext_cntl
op_assign
l_int|0
suffix:semicolon
r_else
id|pll-&gt;ct.pll_ext_cntl
op_assign
id|xpost_div
suffix:semicolon
r_if
c_cond
(paren
id|pll-&gt;ct.mclk_fb_mult
op_eq
l_int|4
)paren
id|pll-&gt;ct.pll_ext_cntl
op_or_assign
id|PLL_MFB_TIMES_4_2B
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;mclk_per
op_eq
id|par-&gt;xclk_per
)paren
(brace
id|pll-&gt;ct.pll_gen_cntl
op_or_assign
(paren
id|xpost_div
op_lshift
l_int|4
)paren
suffix:semicolon
multiline_comment|/* mclk == xclk */
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;* The chip clock is not equal to the memory clock.&n;&t;&t;* Therefore we will use sclk to clock the chip.&n;&t;&t;*/
id|pll-&gt;ct.pll_gen_cntl
op_or_assign
(paren
l_int|6
op_lshift
l_int|4
)paren
suffix:semicolon
multiline_comment|/* mclk == sclk */
id|q
op_assign
id|par-&gt;ref_clk_per
op_star
id|pll-&gt;ct.pll_ref_div
op_star
l_int|4
op_div
id|par-&gt;mclk_per
suffix:semicolon
r_if
c_cond
(paren
id|q
template_param
l_int|255
op_star
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;atyfb: mclk out of range&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|mpost_div
op_assign
(paren
id|q
OL
l_int|128
op_star
l_int|8
)paren
suffix:semicolon
id|mpost_div
op_add_assign
(paren
id|q
OL
l_int|64
op_star
l_int|8
)paren
suffix:semicolon
id|mpost_div
op_add_assign
(paren
id|q
OL
l_int|32
op_star
l_int|8
)paren
suffix:semicolon
)brace
id|sclk_post_div_real
op_assign
id|postdividers
(braket
id|mpost_div
)braket
suffix:semicolon
id|sclk_fb_div
op_assign
id|q
op_star
id|sclk_post_div_real
op_div
l_int|8
suffix:semicolon
id|spll_cntl2
op_assign
id|mpost_div
op_lshift
l_int|4
suffix:semicolon
macro_line|#ifdef DEBUG
id|pllsclk
op_assign
(paren
l_int|1000000
op_star
l_int|2
op_star
id|sclk_fb_div
)paren
op_div
(paren
id|par-&gt;ref_clk_per
op_star
id|pll-&gt;ct.pll_ref_div
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;atyfb(%s): use sclk, pllsclk=%d MHz, sclk=mclk=%d MHz&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|pllsclk
comma
id|pllsclk
op_div
id|sclk_post_div_real
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t;* This disables the sclk, crashes the computer as reported:&n;&t;&t;* aty_st_pll_ct(SPLL_CNTL2, 3, info);&n;&t;&t;*&n;&t;&t;* So it seems the sclk must be enabled before it is used;&n;&t;&t;* so PLL_GEN_CNTL must be programmed *after* the sclk.&n;&t;&t;*/
id|aty_st_pll_ct
c_func
(paren
id|SCLK_FB_DIV
comma
id|sclk_fb_div
comma
id|par
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|SPLL_CNTL2
comma
id|spll_cntl2
comma
id|par
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * The sclk has been started. However, I believe the first clock&n;&t;&t; * ticks it generates are not very stable. Hope this primitive loop&n;&t;&t; * helps for Rage Mobilities that sometimes crash when&n;&t;&t; * we switch to sclk. (Daniel Mantione, 13-05-2003)&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|0x1ffff
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
)brace
id|aty_st_pll_ct
c_func
(paren
id|PLL_REF_DIV
comma
id|pll-&gt;ct.pll_ref_div
comma
id|par
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|PLL_GEN_CNTL
comma
id|pll-&gt;ct.pll_gen_cntl
comma
id|par
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|MCLK_FB_DIV
comma
id|pll-&gt;ct.mclk_fb_div
comma
id|par
)paren
suffix:semicolon
id|aty_st_pll_ct
c_func
(paren
id|PLL_EXT_CNTL
comma
id|pll-&gt;ct.pll_ext_cntl
comma
id|par
)paren
suffix:semicolon
multiline_comment|/* Disable the extra precision pixel clock controls since we do not use them. */
id|aty_st_pll_ct
c_func
(paren
id|EXT_VPLL_CNTL
comma
id|aty_ld_pll_ct
c_func
(paren
id|EXT_VPLL_CNTL
comma
id|par
)paren
op_amp
op_complement
(paren
id|EXT_VPLL_EN
op_or
id|EXT_VPLL_VGA_EN
op_or
id|EXT_VPLL_INSYNC
)paren
comma
id|par
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dummy
r_static
r_int
id|dummy
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|aty_dac_ct
r_const
r_struct
id|aty_dac_ops
id|aty_dac_ct
op_assign
(brace
dot
id|set_dac
op_assign
(paren
r_void
op_star
)paren
id|dummy
comma
)brace
suffix:semicolon
DECL|variable|aty_pll_ct
r_const
r_struct
id|aty_pll_ops
id|aty_pll_ct
op_assign
(brace
dot
id|var_to_pll
op_assign
id|aty_var_to_pll_ct
comma
dot
id|pll_to_var
op_assign
id|aty_pll_to_var_ct
comma
dot
id|set_pll
op_assign
id|aty_set_pll_ct
comma
dot
id|get_pll
op_assign
id|aty_get_pll_ct
comma
dot
id|init_pll
op_assign
id|aty_init_pll_ct
)brace
suffix:semicolon
eof
