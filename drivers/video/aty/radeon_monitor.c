macro_line|#include &quot;radeonfb.h&quot;
macro_line|#include &quot;../edid.h&quot;
macro_line|#ifdef CONFIG_PPC_OF
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#endif /* CONFIG_PPC_OF */
DECL|variable|radeonfb_default_var
r_static
r_struct
id|fb_var_screeninfo
id|radeonfb_default_var
op_assign
(brace
dot
id|xres
op_assign
l_int|640
comma
dot
id|yres
op_assign
l_int|480
comma
dot
id|xres_virtual
op_assign
l_int|640
comma
dot
id|yres_virtual
op_assign
l_int|480
comma
dot
id|bits_per_pixel
op_assign
l_int|8
comma
dot
id|red
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|green
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|blue
op_assign
(brace
dot
id|length
op_assign
l_int|8
)brace
comma
dot
id|activate
op_assign
id|FB_ACTIVATE_NOW
comma
dot
id|height
op_assign
op_minus
l_int|1
comma
dot
id|width
op_assign
op_minus
l_int|1
comma
dot
id|pixclock
op_assign
l_int|39721
comma
dot
id|left_margin
op_assign
l_int|40
comma
dot
id|right_margin
op_assign
l_int|24
comma
dot
id|upper_margin
op_assign
l_int|32
comma
dot
id|lower_margin
op_assign
l_int|11
comma
dot
id|hsync_len
op_assign
l_int|96
comma
dot
id|vsync_len
op_assign
l_int|2
comma
dot
id|vmode
op_assign
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
DECL|function|radeon_get_mon_name
r_static
r_char
op_star
id|radeon_get_mon_name
c_func
(paren
r_int
id|type
)paren
(brace
r_char
op_star
id|pret
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|MT_NONE
suffix:colon
id|pret
op_assign
l_string|&quot;no&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MT_CRT
suffix:colon
id|pret
op_assign
l_string|&quot;CRT&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MT_DFP
suffix:colon
id|pret
op_assign
l_string|&quot;DFP&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MT_LCD
suffix:colon
id|pret
op_assign
l_string|&quot;LCD&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MT_CTV
suffix:colon
id|pret
op_assign
l_string|&quot;CTV&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MT_STV
suffix:colon
id|pret
op_assign
l_string|&quot;STV&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|pret
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PPC_OF
multiline_comment|/*&n; * Try to find monitor informations &amp; EDID data out of the Open Firmware&n; * device-tree. This also contains some &quot;hacks&quot; to work around a few machine&n; * models with broken OF probing by hard-coding known EDIDs for some Mac&n; * laptops internal LVDS panel. (XXX: not done yet)&n; */
DECL|function|radeon_parse_montype_prop
r_static
r_int
id|__devinit
id|radeon_parse_montype_prop
c_func
(paren
r_struct
id|device_node
op_star
id|dp
comma
id|u8
op_star
op_star
id|out_EDID
comma
r_int
id|hdno
)paren
(brace
r_static
r_char
op_star
id|propnames
(braket
)braket
op_assign
(brace
l_string|&quot;DFP,EDID&quot;
comma
l_string|&quot;LCD,EDID&quot;
comma
l_string|&quot;EDID&quot;
comma
l_string|&quot;EDID1&quot;
comma
l_string|&quot;EDID2&quot;
comma
l_int|NULL
)brace
suffix:semicolon
id|u8
op_star
id|pedid
op_assign
l_int|NULL
suffix:semicolon
id|u8
op_star
id|pmt
op_assign
l_int|NULL
suffix:semicolon
id|u8
op_star
id|tmp
suffix:semicolon
r_int
id|i
comma
id|mt
op_assign
id|MT_NONE
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;analyzing OF properties...&bslash;n&quot;
)paren
suffix:semicolon
id|pmt
op_assign
(paren
id|u8
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
l_string|&quot;display-type&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmt
)paren
r_return
id|MT_NONE
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;display-type: %s&bslash;n&quot;
comma
id|pmt
)paren
suffix:semicolon
multiline_comment|/* OF says &quot;LCD&quot; for DFP as well, we discriminate from the caller of this&n;&t; * function&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|pmt
comma
l_string|&quot;LCD&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|pmt
comma
l_string|&quot;DFP&quot;
)paren
)paren
id|mt
op_assign
id|MT_DFP
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|pmt
comma
l_string|&quot;CRT&quot;
)paren
)paren
id|mt
op_assign
id|MT_CRT
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|pmt
comma
l_string|&quot;NONE&quot;
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;radeonfb: Unknown OF display-type: %s&bslash;n&quot;
comma
id|pmt
)paren
suffix:semicolon
r_return
id|MT_NONE
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|propnames
(braket
id|i
)braket
op_ne
l_int|NULL
suffix:semicolon
op_increment
id|i
)paren
(brace
id|pedid
op_assign
(paren
id|u8
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
id|propnames
(braket
id|i
)braket
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pedid
op_ne
l_int|NULL
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* We didn&squot;t find the EDID in the leaf node, some cards will actually&n;&t; * put EDID1/EDID2 in the parent, look for these (typically M6 tipb).&n;&t; * single-head cards have hdno == -1 and skip this step&n;&t; */
r_if
c_cond
(paren
id|pedid
op_eq
l_int|NULL
op_logical_and
id|dp-&gt;parent
op_logical_and
(paren
id|hdno
op_ne
op_minus
l_int|1
)paren
)paren
id|pedid
op_assign
id|get_property
c_func
(paren
id|dp-&gt;parent
comma
(paren
id|hdno
op_eq
l_int|0
)paren
ques
c_cond
l_string|&quot;EDID1&quot;
suffix:colon
l_string|&quot;EDID2&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pedid
op_eq
l_int|NULL
op_logical_and
id|dp-&gt;parent
op_logical_and
(paren
id|hdno
op_eq
l_int|0
)paren
)paren
id|pedid
op_assign
id|get_property
c_func
(paren
id|dp-&gt;parent
comma
l_string|&quot;EDID&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pedid
op_eq
l_int|NULL
)paren
r_return
id|mt
suffix:semicolon
id|tmp
op_assign
(paren
id|u8
op_star
)paren
id|kmalloc
c_func
(paren
id|EDID_LENGTH
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
r_return
id|mt
suffix:semicolon
id|memcpy
c_func
(paren
id|tmp
comma
id|pedid
comma
id|EDID_LENGTH
)paren
suffix:semicolon
op_star
id|out_EDID
op_assign
id|tmp
suffix:semicolon
r_return
id|mt
suffix:semicolon
)brace
DECL|function|radeon_probe_OF_head
r_static
r_int
id|__devinit
id|radeon_probe_OF_head
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_int
id|head_no
comma
id|u8
op_star
op_star
id|out_EDID
)paren
(brace
r_struct
id|device_node
op_star
id|dp
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;radeon_probe_OF_head&bslash;n&quot;
)paren
suffix:semicolon
id|dp
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|rinfo-&gt;pdev
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dp
op_eq
l_int|NULL
)paren
r_return
id|MT_NONE
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;has_CRTC2
)paren
(brace
r_char
op_star
id|pname
suffix:semicolon
r_int
id|len
comma
id|second
op_assign
l_int|0
suffix:semicolon
id|dp
op_assign
id|dp-&gt;child
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
id|dp
)paren
r_return
id|MT_NONE
suffix:semicolon
id|pname
op_assign
(paren
r_char
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
l_string|&quot;name&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pname
)paren
r_return
id|MT_NONE
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|pname
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;head: %s (letter: %c, head_no: %d)&bslash;n&quot;
comma
id|pname
comma
id|pname
(braket
id|len
op_minus
l_int|1
)braket
comma
id|head_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pname
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;A&squot;
op_logical_and
id|head_no
op_eq
l_int|0
)paren
(brace
r_int
id|mt
op_assign
id|radeon_parse_montype_prop
c_func
(paren
id|dp
comma
id|out_EDID
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Maybe check for LVDS_GEN_CNTL here ? I need to check out&n;&t;&t;&t;&t; * what OF does when booting with lid closed&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|mt
op_eq
id|MT_DFP
op_logical_and
id|rinfo-&gt;is_mobility
)paren
id|mt
op_assign
id|MT_LCD
suffix:semicolon
r_return
id|mt
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pname
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;B&squot;
op_logical_and
id|head_no
op_eq
l_int|1
)paren
r_return
id|radeon_parse_montype_prop
c_func
(paren
id|dp
comma
id|out_EDID
comma
l_int|1
)paren
suffix:semicolon
id|second
op_assign
l_int|1
suffix:semicolon
id|dp
op_assign
id|dp-&gt;sibling
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|second
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|head_no
OG
l_int|0
)paren
r_return
id|MT_NONE
suffix:semicolon
r_return
id|radeon_parse_montype_prop
c_func
(paren
id|dp
comma
id|out_EDID
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|MT_NONE
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PPC_OF */
DECL|function|radeon_get_panel_info_BIOS
r_static
r_int
id|__devinit
id|radeon_get_panel_info_BIOS
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
)paren
(brace
r_int
r_int
id|tmp
comma
id|tmp0
suffix:semicolon
r_char
id|stmp
(braket
l_int|30
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;bios_seg
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp
op_assign
id|BIOS_IN16
c_func
(paren
id|rinfo-&gt;fp_bios_start
op_plus
l_int|0x40
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;radeonfb: Failed to detect DFP panel info using BIOS&bslash;n&quot;
)paren
suffix:semicolon
id|rinfo-&gt;panel_info.pwr_delay
op_assign
l_int|200
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|24
suffix:semicolon
id|i
op_increment
)paren
(brace
id|stmp
(braket
id|i
)braket
op_assign
id|BIOS_IN8
c_func
(paren
id|tmp
op_plus
id|i
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|stmp
(braket
l_int|24
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;radeonfb: panel ID string: %s&bslash;n&quot;
comma
id|stmp
)paren
suffix:semicolon
id|rinfo-&gt;panel_info.xres
op_assign
id|BIOS_IN16
c_func
(paren
id|tmp
op_plus
l_int|25
)paren
suffix:semicolon
id|rinfo-&gt;panel_info.yres
op_assign
id|BIOS_IN16
c_func
(paren
id|tmp
op_plus
l_int|27
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;radeonfb: detected LVDS panel size from BIOS: %dx%d&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.xres
comma
id|rinfo-&gt;panel_info.yres
)paren
suffix:semicolon
id|rinfo-&gt;panel_info.pwr_delay
op_assign
id|BIOS_IN16
c_func
(paren
id|tmp
op_plus
l_int|44
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;BIOS provided panel power delay: %d&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.pwr_delay
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;panel_info.pwr_delay
OG
l_int|2000
op_logical_or
id|rinfo-&gt;panel_info.pwr_delay
op_le
l_int|0
)paren
id|rinfo-&gt;panel_info.pwr_delay
op_assign
l_int|2000
suffix:semicolon
multiline_comment|/*&n;&t; * Some panels only work properly with some divider combinations&n;&t; */
id|rinfo-&gt;panel_info.ref_divider
op_assign
id|BIOS_IN16
c_func
(paren
id|tmp
op_plus
l_int|46
)paren
suffix:semicolon
id|rinfo-&gt;panel_info.post_divider
op_assign
id|BIOS_IN8
c_func
(paren
id|tmp
op_plus
l_int|48
)paren
suffix:semicolon
id|rinfo-&gt;panel_info.fbk_divider
op_assign
id|BIOS_IN16
c_func
(paren
id|tmp
op_plus
l_int|49
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;panel_info.ref_divider
op_ne
l_int|0
op_logical_and
id|rinfo-&gt;panel_info.fbk_divider
OG
l_int|3
)paren
(brace
id|rinfo-&gt;panel_info.use_bios_dividers
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeondb: BIOS provided dividers will be used&bslash;n&quot;
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;ref_divider = %x&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.ref_divider
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;post_divider = %x&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.post_divider
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;fbk_divider = %x&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.fbk_divider
)paren
suffix:semicolon
)brace
id|RTRACE
c_func
(paren
l_string|&quot;Scanning BIOS table ...&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp0
op_assign
id|BIOS_IN16
c_func
(paren
id|tmp
op_plus
l_int|64
op_plus
id|i
op_star
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp0
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot; %d x %d&bslash;n&quot;
comma
id|BIOS_IN16
c_func
(paren
id|tmp0
)paren
comma
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|BIOS_IN16
c_func
(paren
id|tmp0
)paren
op_eq
id|rinfo-&gt;panel_info.xres
)paren
op_logical_and
(paren
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|2
)paren
op_eq
id|rinfo-&gt;panel_info.yres
)paren
)paren
(brace
id|rinfo-&gt;panel_info.hblank
op_assign
(paren
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|17
)paren
op_minus
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|19
)paren
)paren
op_star
l_int|8
suffix:semicolon
id|rinfo-&gt;panel_info.hOver_plus
op_assign
(paren
(paren
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|21
)paren
op_minus
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|19
)paren
op_minus
l_int|1
)paren
op_star
l_int|8
)paren
op_amp
l_int|0x7fff
suffix:semicolon
id|rinfo-&gt;panel_info.hSync_width
op_assign
id|BIOS_IN8
c_func
(paren
id|tmp0
op_plus
l_int|23
)paren
op_star
l_int|8
suffix:semicolon
id|rinfo-&gt;panel_info.vblank
op_assign
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|24
)paren
op_minus
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|26
)paren
suffix:semicolon
id|rinfo-&gt;panel_info.vOver_plus
op_assign
(paren
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|28
)paren
op_amp
l_int|0x7ff
)paren
op_minus
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|26
)paren
suffix:semicolon
id|rinfo-&gt;panel_info.vSync_width
op_assign
(paren
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|28
)paren
op_amp
l_int|0xf800
)paren
op_rshift
l_int|11
suffix:semicolon
id|rinfo-&gt;panel_info.clock
op_assign
id|BIOS_IN16
c_func
(paren
id|tmp0
op_plus
l_int|9
)paren
suffix:semicolon
multiline_comment|/* Assume high active syncs for now until ATI tells me more... maybe we&n;&t;&t;&t; * can probe register values here ?&n;&t;&t;&t; */
id|rinfo-&gt;panel_info.hAct_high
op_assign
l_int|1
suffix:semicolon
id|rinfo-&gt;panel_info.vAct_high
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Mark panel infos valid */
id|rinfo-&gt;panel_info.valid
op_assign
l_int|1
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;Found panel in BIOS table:&bslash;n&quot;
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;  hblank: %d&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.hblank
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;  hOver_plus: %d&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.hOver_plus
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;  hSync_width: %d&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.hSync_width
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;  vblank: %d&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.vblank
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;  vOver_plus: %d&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.vOver_plus
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;  vSync_width: %d&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.vSync_width
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;  clock: %d&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.clock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|RTRACE
c_func
(paren
l_string|&quot;Didn&squot;t find panel in BIOS table !&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Try to extract the connector informations from the BIOS. This&n; * doesn&squot;t quite work yet, but it&squot;s output is still useful for&n; * debugging&n; */
DECL|function|radeon_parse_connector_info
r_static
r_void
id|__devinit
id|radeon_parse_connector_info
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
)paren
(brace
r_int
id|offset
comma
id|chips
comma
id|connectors
comma
id|tmp
comma
id|i
comma
id|conn
comma
id|type
suffix:semicolon
r_static
r_char
op_star
id|__conn_type_table
(braket
l_int|16
)braket
op_assign
(brace
l_string|&quot;NONE&quot;
comma
l_string|&quot;Proprietary&quot;
comma
l_string|&quot;CRT&quot;
comma
l_string|&quot;DVI-I&quot;
comma
l_string|&quot;DVI-D&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Unknown&quot;
comma
l_string|&quot;Unknown&quot;
)brace
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;bios_seg
)paren
r_return
suffix:semicolon
id|offset
op_assign
id|BIOS_IN16
c_func
(paren
id|rinfo-&gt;fp_bios_start
op_plus
l_int|0x50
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;radeonfb: No connector info table detected&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t do much more at this point but displaying the data if&n;&t; * DEBUG is enabled&n;&t; */
id|chips
op_assign
id|BIOS_IN8
c_func
(paren
id|offset
op_increment
)paren
op_rshift
l_int|4
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;%d chips in connector info&bslash;n&quot;
comma
id|chips
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|chips
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp
op_assign
id|BIOS_IN8
c_func
(paren
id|offset
op_increment
)paren
suffix:semicolon
id|connectors
op_assign
id|tmp
op_amp
l_int|0x0f
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot; - chip %d has %d connectors&bslash;n&quot;
comma
id|tmp
op_rshift
l_int|4
comma
id|connectors
)paren
suffix:semicolon
r_for
c_loop
(paren
id|conn
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
id|conn
op_increment
)paren
(brace
id|tmp
op_assign
id|BIOS_IN16
c_func
(paren
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|offset
op_add_assign
l_int|2
suffix:semicolon
id|type
op_assign
(paren
id|tmp
op_rshift
l_int|12
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;  * connector %d of type %d (%s) : %04x&bslash;n&quot;
comma
id|conn
comma
id|type
comma
id|__conn_type_table
(braket
id|type
)braket
comma
id|tmp
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Probe physical connection of a CRT. This code comes from XFree&n; * as well and currently is only implemented for the CRT DAC, the&n; * code for the TVDAC is commented out in XFree as &quot;non working&quot;&n; */
DECL|function|radeon_crt_is_connected
r_static
r_int
id|__devinit
id|radeon_crt_is_connected
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_int
id|is_crt_dac
)paren
(brace
r_int
id|connected
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* the monitor either wasn&squot;t connected or it is a non-DDC CRT.&n;     * try to probe it&n;     */
r_if
c_cond
(paren
id|is_crt_dac
)paren
(brace
r_int
r_int
id|ulOrigVCLK_ECP_CNTL
suffix:semicolon
r_int
r_int
id|ulOrigDAC_CNTL
suffix:semicolon
r_int
r_int
id|ulOrigDAC_EXT_CNTL
suffix:semicolon
r_int
r_int
id|ulOrigCRTC_EXT_CNTL
suffix:semicolon
r_int
r_int
id|ulData
suffix:semicolon
r_int
r_int
id|ulMask
suffix:semicolon
id|ulOrigVCLK_ECP_CNTL
op_assign
id|INPLL
c_func
(paren
id|VCLK_ECP_CNTL
)paren
suffix:semicolon
id|ulData
op_assign
id|ulOrigVCLK_ECP_CNTL
suffix:semicolon
id|ulData
op_and_assign
op_complement
(paren
id|PIXCLK_ALWAYS_ONb
op_or
id|PIXCLK_DAC_ALWAYS_ONb
)paren
suffix:semicolon
id|ulMask
op_assign
op_complement
(paren
id|PIXCLK_ALWAYS_ONb
op_or
id|PIXCLK_DAC_ALWAYS_ONb
)paren
suffix:semicolon
id|OUTPLLP
c_func
(paren
id|VCLK_ECP_CNTL
comma
id|ulData
comma
id|ulMask
)paren
suffix:semicolon
id|ulOrigCRTC_EXT_CNTL
op_assign
id|INREG
c_func
(paren
id|CRTC_EXT_CNTL
)paren
suffix:semicolon
id|ulData
op_assign
id|ulOrigCRTC_EXT_CNTL
suffix:semicolon
id|ulData
op_or_assign
id|CRTC_CRT_ON
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_EXT_CNTL
comma
id|ulData
)paren
suffix:semicolon
id|ulOrigDAC_EXT_CNTL
op_assign
id|INREG
c_func
(paren
id|DAC_EXT_CNTL
)paren
suffix:semicolon
id|ulData
op_assign
id|ulOrigDAC_EXT_CNTL
suffix:semicolon
id|ulData
op_and_assign
op_complement
id|DAC_FORCE_DATA_MASK
suffix:semicolon
id|ulData
op_or_assign
(paren
id|DAC_FORCE_BLANK_OFF_EN
op_or
id|DAC_FORCE_DATA_EN
op_or
id|DAC_FORCE_DATA_SEL_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RV250
)paren
op_logical_or
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RV280
)paren
)paren
id|ulData
op_or_assign
(paren
l_int|0x01b6
op_lshift
id|DAC_FORCE_DATA_SHIFT
)paren
suffix:semicolon
r_else
id|ulData
op_or_assign
(paren
l_int|0x01ac
op_lshift
id|DAC_FORCE_DATA_SHIFT
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|DAC_EXT_CNTL
comma
id|ulData
)paren
suffix:semicolon
id|ulOrigDAC_CNTL
op_assign
id|INREG
c_func
(paren
id|DAC_CNTL
)paren
suffix:semicolon
id|ulData
op_assign
id|ulOrigDAC_CNTL
suffix:semicolon
id|ulData
op_or_assign
id|DAC_CMP_EN
suffix:semicolon
id|ulData
op_and_assign
op_complement
(paren
id|DAC_RANGE_CNTL_MASK
op_or
id|DAC_PDWN
)paren
suffix:semicolon
id|ulData
op_or_assign
l_int|0x2
suffix:semicolon
id|OUTREG
c_func
(paren
id|DAC_CNTL
comma
id|ulData
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|ulData
op_assign
id|INREG
c_func
(paren
id|DAC_CNTL
)paren
suffix:semicolon
id|connected
op_assign
(paren
id|DAC_CMP_OUTPUT
op_amp
id|ulData
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|ulData
op_assign
id|ulOrigVCLK_ECP_CNTL
suffix:semicolon
id|ulMask
op_assign
l_int|0xFFFFFFFFL
suffix:semicolon
id|OUTPLLP
c_func
(paren
id|VCLK_ECP_CNTL
comma
id|ulData
comma
id|ulMask
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|DAC_CNTL
comma
id|ulOrigDAC_CNTL
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|DAC_EXT_CNTL
comma
id|ulOrigDAC_EXT_CNTL
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_EXT_CNTL
comma
id|ulOrigCRTC_EXT_CNTL
)paren
suffix:semicolon
)brace
r_return
id|connected
ques
c_cond
id|MT_CRT
suffix:colon
id|MT_NONE
suffix:semicolon
)brace
multiline_comment|/*&n; * Parse the &quot;monitor_layout&quot; string if any. This code is mostly&n; * copied from XFree&squot;s radeon driver&n; */
DECL|function|radeon_parse_monitor_layout
r_static
r_int
id|__devinit
id|radeon_parse_monitor_layout
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_const
r_char
op_star
id|monitor_layout
)paren
(brace
r_char
id|s1
(braket
l_int|5
)braket
comma
id|s2
(braket
l_int|5
)braket
suffix:semicolon
r_int
id|i
op_assign
l_int|0
comma
id|second
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|monitor_layout
)paren
r_return
l_int|0
suffix:semicolon
id|s
op_assign
id|monitor_layout
suffix:semicolon
r_do
(brace
r_switch
c_cond
(paren
op_star
id|s
)paren
(brace
r_case
l_char|&squot;,&squot;
suffix:colon
id|s1
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|second
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot; &squot;
suffix:colon
r_case
l_char|&squot;&bslash;0&squot;
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|i
OG
l_int|4
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|second
)paren
id|s2
(braket
id|i
)braket
op_assign
op_star
id|s
suffix:semicolon
r_else
id|s1
(braket
id|i
)braket
op_assign
op_star
id|s
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_star
id|s
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|second
)paren
id|s2
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|s1
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|s2
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|s1
comma
l_string|&quot;CRT&quot;
)paren
op_eq
l_int|0
)paren
id|rinfo-&gt;mon1_type
op_assign
id|MT_CRT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|s1
comma
l_string|&quot;TMDS&quot;
)paren
op_eq
l_int|0
)paren
id|rinfo-&gt;mon1_type
op_assign
id|MT_DFP
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|s1
comma
l_string|&quot;LVDS&quot;
)paren
op_eq
l_int|0
)paren
id|rinfo-&gt;mon1_type
op_assign
id|MT_LCD
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|s2
comma
l_string|&quot;CRT&quot;
)paren
op_eq
l_int|0
)paren
id|rinfo-&gt;mon2_type
op_assign
id|MT_CRT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|s2
comma
l_string|&quot;TMDS&quot;
)paren
op_eq
l_int|0
)paren
id|rinfo-&gt;mon2_type
op_assign
id|MT_DFP
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|s2
comma
l_string|&quot;LVDS&quot;
)paren
op_eq
l_int|0
)paren
id|rinfo-&gt;mon2_type
op_assign
id|MT_LCD
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Probe display on both primary and secondary card&squot;s connector (if any)&n; * by various available techniques (i2c, OF device tree, BIOS, ...) and&n; * try to retreive EDID. The algorithm here comes from XFree&squot;s radeon&n; * driver&n; */
DECL|function|radeon_probe_screens
r_void
id|__devinit
id|radeon_probe_screens
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_const
r_char
op_star
id|monitor_layout
comma
r_int
id|ignore_edid
)paren
(brace
macro_line|#ifdef CONFIG_FB_RADEON_I2C
r_int
id|ddc_crt2_used
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_int
id|tmp
comma
id|i
suffix:semicolon
id|radeon_parse_connector_info
c_func
(paren
id|rinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|radeon_parse_monitor_layout
c_func
(paren
id|rinfo
comma
id|monitor_layout
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * If user specified a monitor_layout option, use it instead&n;&t;&t; * of auto-detecting. Maybe we should only use this argument&n;&t;&t; * on the first radeon card probed or provide a way to specify&n;&t;&t; * a layout for each card ?&n;&t;&t; */
id|RTRACE
c_func
(paren
l_string|&quot;Using specified monitor layout: %s&quot;
comma
id|monitor_layout
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB_RADEON_I2C
r_if
c_cond
(paren
op_logical_neg
id|ignore_edid
)paren
(brace
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_ne
id|MT_NONE
)paren
r_if
c_cond
(paren
op_logical_neg
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|ddc_dvi
comma
op_amp
id|rinfo-&gt;mon1_EDID
)paren
)paren
(brace
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|ddc_crt2
comma
op_amp
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
id|ddc_crt2_used
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rinfo-&gt;mon2_type
op_ne
id|MT_NONE
)paren
r_if
c_cond
(paren
op_logical_neg
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|ddc_vga
comma
op_amp
id|rinfo-&gt;mon2_EDID
)paren
op_logical_and
op_logical_neg
id|ddc_crt2_used
)paren
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|ddc_crt2
comma
op_amp
id|rinfo-&gt;mon2_EDID
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_FB_RADEON_I2C */
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
)paren
(brace
r_if
c_cond
(paren
id|rinfo-&gt;mon2_type
op_ne
id|MT_NONE
)paren
(brace
id|rinfo-&gt;mon1_type
op_assign
id|rinfo-&gt;mon2_type
suffix:semicolon
id|rinfo-&gt;mon1_EDID
op_assign
id|rinfo-&gt;mon2_EDID
suffix:semicolon
)brace
r_else
(brace
id|rinfo-&gt;mon1_type
op_assign
id|MT_CRT
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: No valid monitor, assuming CRT on first port&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|rinfo-&gt;mon2_type
op_assign
id|MT_NONE
suffix:semicolon
id|rinfo-&gt;mon2_EDID
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Auto-detecting display type (well... trying to ...)&n;&t;&t; */
id|RTRACE
c_func
(paren
l_string|&quot;Starting monitor auto detection...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if DEBUG &amp;&amp; defined(CONFIG_FB_RADEON_I2C)
(brace
id|u8
op_star
id|EDIDs
(braket
l_int|4
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
r_int
id|mon_types
(braket
l_int|4
)braket
op_assign
(brace
id|MT_NONE
comma
id|MT_NONE
comma
id|MT_NONE
comma
id|MT_NONE
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|mon_types
(braket
id|i
)braket
op_assign
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|i
op_plus
l_int|1
comma
op_amp
id|EDIDs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif /* DEBUG */
multiline_comment|/*&n;&t;&t; * Old single head cards&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;has_CRTC2
)paren
(brace
macro_line|#ifdef CONFIG_PPC_OF
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
)paren
id|rinfo-&gt;mon1_type
op_assign
id|radeon_probe_OF_head
c_func
(paren
id|rinfo
comma
l_int|0
comma
op_amp
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PPC_OF */
macro_line|#ifdef CONFIG_FB_RADEON_I2C
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
)paren
id|rinfo-&gt;mon1_type
op_assign
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|ddc_dvi
comma
op_amp
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
)paren
id|rinfo-&gt;mon1_type
op_assign
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|ddc_vga
comma
op_amp
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
)paren
id|rinfo-&gt;mon1_type
op_assign
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|ddc_crt2
comma
op_amp
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_FB_RADEON_I2C */
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
)paren
id|rinfo-&gt;mon1_type
op_assign
id|MT_CRT
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Check for cards with reversed DACs or TMDS controllers using BIOS&n;&t;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;bios_seg
op_logical_and
(paren
id|tmp
op_assign
id|BIOS_IN16
c_func
(paren
id|rinfo-&gt;fp_bios_start
op_plus
l_int|0x50
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|tmp0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|BIOS_IN8
c_func
(paren
id|tmp
op_plus
id|i
op_star
l_int|2
)paren
op_logical_and
id|i
OG
l_int|1
)paren
r_break
suffix:semicolon
id|tmp0
op_assign
id|BIOS_IN16
c_func
(paren
id|tmp
op_plus
id|i
op_star
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|tmp0
op_amp
l_int|0x01
)paren
)paren
op_logical_and
(paren
(paren
(paren
id|tmp0
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
)paren
op_eq
id|ddc_dvi
)paren
)paren
(brace
id|rinfo-&gt;reversed_DAC
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Reversed DACs detected&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
(paren
id|tmp0
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
)paren
op_eq
id|ddc_dvi
)paren
op_logical_and
(paren
(paren
id|tmp0
op_rshift
l_int|4
)paren
op_amp
l_int|0x01
)paren
)paren
(brace
id|rinfo-&gt;reversed_TMDS
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Reversed TMDS detected&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;&t;&t; * Probe primary head (DVI or laptop internal panel)&n;&t;&t; */
macro_line|#ifdef CONFIG_PPC_OF
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
)paren
id|rinfo-&gt;mon1_type
op_assign
id|radeon_probe_OF_head
c_func
(paren
id|rinfo
comma
l_int|0
comma
op_amp
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PPC_OF */
macro_line|#ifdef CONFIG_FB_RADEON_I2C
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
)paren
id|rinfo-&gt;mon1_type
op_assign
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|ddc_dvi
comma
op_amp
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
)paren
(brace
id|rinfo-&gt;mon1_type
op_assign
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|ddc_crt2
comma
op_amp
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_ne
id|MT_NONE
)paren
id|ddc_crt2_used
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_FB_RADEON_I2C */
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
op_logical_and
id|rinfo-&gt;is_mobility
op_logical_and
(paren
(paren
id|rinfo-&gt;bios_seg
op_logical_and
(paren
id|INREG
c_func
(paren
id|BIOS_4_SCRATCH
)paren
op_amp
l_int|4
)paren
)paren
op_logical_or
(paren
id|INREG
c_func
(paren
id|LVDS_GEN_CNTL
)paren
op_amp
id|LVDS_ON
)paren
)paren
)paren
(brace
id|rinfo-&gt;mon1_type
op_assign
id|MT_LCD
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Non-DDC laptop panel detected&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
)paren
id|rinfo-&gt;mon1_type
op_assign
id|radeon_crt_is_connected
c_func
(paren
id|rinfo
comma
id|rinfo-&gt;reversed_DAC
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Probe secondary head (mostly VGA, can be DVI)&n;&t;&t; */
macro_line|#ifdef CONFIG_PPC_OF
r_if
c_cond
(paren
id|rinfo-&gt;mon2_type
op_eq
id|MT_NONE
)paren
id|rinfo-&gt;mon2_type
op_assign
id|radeon_probe_OF_head
c_func
(paren
id|rinfo
comma
l_int|1
comma
op_amp
id|rinfo-&gt;mon2_EDID
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PPC_OF */
macro_line|#ifdef CONFIG_FB_RADEON_I2C
r_if
c_cond
(paren
id|rinfo-&gt;mon2_type
op_eq
id|MT_NONE
)paren
id|rinfo-&gt;mon2_type
op_assign
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|ddc_vga
comma
op_amp
id|rinfo-&gt;mon2_EDID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon2_type
op_eq
id|MT_NONE
op_logical_and
op_logical_neg
id|ddc_crt2_used
)paren
id|rinfo-&gt;mon2_type
op_assign
id|radeon_probe_i2c_connector
c_func
(paren
id|rinfo
comma
id|ddc_crt2
comma
op_amp
id|rinfo-&gt;mon2_EDID
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_FB_RADEON_I2C */
r_if
c_cond
(paren
id|rinfo-&gt;mon2_type
op_eq
id|MT_NONE
)paren
id|rinfo-&gt;mon2_type
op_assign
id|radeon_crt_is_connected
c_func
(paren
id|rinfo
comma
op_logical_neg
id|rinfo-&gt;reversed_DAC
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If we only detected port 2, we swap them, if none detected,&n;&t;&t; * assume CRT (maybe fallback to old BIOS_SCRATCH stuff ? or look&n;&t;&t; * at FP registers ?)&n;&t;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_NONE
)paren
(brace
r_if
c_cond
(paren
id|rinfo-&gt;mon2_type
op_ne
id|MT_NONE
)paren
(brace
id|rinfo-&gt;mon1_type
op_assign
id|rinfo-&gt;mon2_type
suffix:semicolon
id|rinfo-&gt;mon1_EDID
op_assign
id|rinfo-&gt;mon2_EDID
suffix:semicolon
)brace
r_else
id|rinfo-&gt;mon1_type
op_assign
id|MT_CRT
suffix:semicolon
id|rinfo-&gt;mon2_type
op_assign
id|MT_NONE
suffix:semicolon
id|rinfo-&gt;mon2_EDID
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Deal with reversed TMDS&n;&t;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;reversed_TMDS
)paren
(brace
multiline_comment|/* Always keep internal TMDS as primary head */
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_DFP
op_logical_or
id|rinfo-&gt;mon2_type
op_eq
id|MT_DFP
)paren
(brace
r_int
id|tmp_type
op_assign
id|rinfo-&gt;mon1_type
suffix:semicolon
id|u8
op_star
id|tmp_EDID
op_assign
id|rinfo-&gt;mon1_EDID
suffix:semicolon
id|rinfo-&gt;mon1_type
op_assign
id|rinfo-&gt;mon2_type
suffix:semicolon
id|rinfo-&gt;mon1_EDID
op_assign
id|rinfo-&gt;mon2_EDID
suffix:semicolon
id|rinfo-&gt;mon2_type
op_assign
id|tmp_type
suffix:semicolon
id|rinfo-&gt;mon2_EDID
op_assign
id|tmp_EDID
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_CRT
op_logical_or
id|rinfo-&gt;mon2_type
op_eq
id|MT_CRT
)paren
id|rinfo-&gt;reversed_DAC
op_xor_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|ignore_edid
)paren
(brace
r_if
c_cond
(paren
id|rinfo-&gt;mon1_EDID
)paren
id|kfree
c_func
(paren
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
id|rinfo-&gt;mon1_EDID
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon2_EDID
)paren
id|kfree
c_func
(paren
id|rinfo-&gt;mon2_EDID
)paren
suffix:semicolon
id|rinfo-&gt;mon2_EDID
op_assign
l_int|NULL
suffix:semicolon
)brace
id|bail
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Monitor 1 type %s found&bslash;n&quot;
comma
id|radeon_get_mon_name
c_func
(paren
id|rinfo-&gt;mon1_type
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon1_EDID
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: EDID probed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;has_CRTC2
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Monitor 2 type %s found&bslash;n&quot;
comma
id|radeon_get_mon_name
c_func
(paren
id|rinfo-&gt;mon2_type
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon2_EDID
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: EDID probed&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This functions applyes any arch/model/machine specific fixups&n; * to the panel info. It may eventually alter EDID block as&n; * well or whatever is specific to a given model and not probed&n; * properly by the default code&n; */
DECL|function|radeon_fixup_panel_info
r_static
r_void
id|radeon_fixup_panel_info
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
)paren
(brace
macro_line|#ifdef CONFIG_PPC_OF
multiline_comment|/*&n;&t; * LCD Flat panels should use fixed dividers, we enfore that on&n;&t; * PowerMac only for now...&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;panel_info.use_bios_dividers
op_logical_and
id|rinfo-&gt;mon1_type
op_eq
id|MT_LCD
op_logical_and
id|rinfo-&gt;is_mobility
)paren
(brace
r_int
id|ppll_div_sel
op_assign
id|INREG8
c_func
(paren
id|CLOCK_CNTL_INDEX
op_plus
l_int|1
)paren
op_amp
l_int|0x3
suffix:semicolon
id|u32
id|ppll_divn
op_assign
id|INPLL
c_func
(paren
id|PPLL_DIV_0
op_plus
id|ppll_div_sel
)paren
suffix:semicolon
id|rinfo-&gt;panel_info.ref_divider
op_assign
id|rinfo-&gt;pll.ref_div
suffix:semicolon
id|rinfo-&gt;panel_info.fbk_divider
op_assign
id|ppll_divn
op_amp
l_int|0x7ff
suffix:semicolon
id|rinfo-&gt;panel_info.post_divider
op_assign
(paren
id|ppll_divn
op_rshift
l_int|16
)paren
op_amp
l_int|0x7
suffix:semicolon
id|rinfo-&gt;panel_info.use_bios_dividers
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;radeonfb: Using Firmware dividers 0x%08x &quot;
l_string|&quot;from PPLL %d&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.fbk_divider
op_or
(paren
id|rinfo-&gt;panel_info.post_divider
op_lshift
l_int|16
)paren
comma
id|ppll_div_sel
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PPC_OF */
)brace
multiline_comment|/*&n; * Fill up panel infos from a mode definition, either returned by the EDID&n; * or from the default mode when we can&squot;t do any better&n; */
DECL|function|radeon_var_to_panel_info
r_static
r_void
id|radeon_var_to_panel_info
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|rinfo-&gt;panel_info.xres
op_assign
id|var-&gt;xres
suffix:semicolon
id|rinfo-&gt;panel_info.yres
op_assign
id|var-&gt;yres
suffix:semicolon
id|rinfo-&gt;panel_info.clock
op_assign
l_int|100000000
op_div
id|var-&gt;pixclock
suffix:semicolon
id|rinfo-&gt;panel_info.hOver_plus
op_assign
id|var-&gt;right_margin
suffix:semicolon
id|rinfo-&gt;panel_info.hSync_width
op_assign
id|var-&gt;hsync_len
suffix:semicolon
id|rinfo-&gt;panel_info.hblank
op_assign
id|var-&gt;left_margin
op_plus
(paren
id|var-&gt;right_margin
op_plus
id|var-&gt;hsync_len
)paren
suffix:semicolon
id|rinfo-&gt;panel_info.vOver_plus
op_assign
id|var-&gt;lower_margin
suffix:semicolon
id|rinfo-&gt;panel_info.vSync_width
op_assign
id|var-&gt;vsync_len
suffix:semicolon
id|rinfo-&gt;panel_info.vblank
op_assign
id|var-&gt;upper_margin
op_plus
(paren
id|var-&gt;lower_margin
op_plus
id|var-&gt;vsync_len
)paren
suffix:semicolon
id|rinfo-&gt;panel_info.hAct_high
op_assign
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
op_ne
l_int|0
suffix:semicolon
id|rinfo-&gt;panel_info.vAct_high
op_assign
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
op_ne
l_int|0
suffix:semicolon
id|rinfo-&gt;panel_info.valid
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* We use a default of 200ms for the panel power delay, &n;&t; * I need to have a real schedule() instead of mdelay&squot;s in the panel code.&n;&t; * we might be possible to figure out a better power delay either from&n;&t; * MacOS OF tree or from the EDID block (proprietary extensions ?)&n;&t; */
id|rinfo-&gt;panel_info.pwr_delay
op_assign
l_int|200
suffix:semicolon
)brace
DECL|function|radeon_var_to_videomode
r_static
r_void
id|radeon_var_to_videomode
c_func
(paren
r_struct
id|fb_videomode
op_star
id|mode
comma
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|mode-&gt;xres
op_assign
id|var-&gt;xres
suffix:semicolon
id|mode-&gt;yres
op_assign
id|var-&gt;yres
suffix:semicolon
id|mode-&gt;pixclock
op_assign
id|var-&gt;pixclock
suffix:semicolon
id|mode-&gt;left_margin
op_assign
id|var-&gt;left_margin
suffix:semicolon
id|mode-&gt;right_margin
op_assign
id|var-&gt;right_margin
suffix:semicolon
id|mode-&gt;upper_margin
op_assign
id|var-&gt;upper_margin
suffix:semicolon
id|mode-&gt;lower_margin
op_assign
id|var-&gt;lower_margin
suffix:semicolon
id|mode-&gt;hsync_len
op_assign
id|var-&gt;hsync_len
suffix:semicolon
id|mode-&gt;vsync_len
op_assign
id|var-&gt;vsync_len
suffix:semicolon
id|mode-&gt;sync
op_assign
id|var-&gt;sync
suffix:semicolon
id|mode-&gt;vmode
op_assign
id|var-&gt;vmode
suffix:semicolon
)brace
DECL|function|radeon_videomode_to_var
r_static
r_void
id|radeon_videomode_to_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_const
r_struct
id|fb_videomode
op_star
id|mode
)paren
(brace
id|var-&gt;xres
op_assign
id|mode-&gt;xres
suffix:semicolon
id|var-&gt;yres
op_assign
id|mode-&gt;yres
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|mode-&gt;xres
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|mode-&gt;yres
suffix:semicolon
id|var-&gt;xoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;pixclock
op_assign
id|mode-&gt;pixclock
suffix:semicolon
id|var-&gt;left_margin
op_assign
id|mode-&gt;left_margin
suffix:semicolon
id|var-&gt;right_margin
op_assign
id|mode-&gt;right_margin
suffix:semicolon
id|var-&gt;upper_margin
op_assign
id|mode-&gt;upper_margin
suffix:semicolon
id|var-&gt;lower_margin
op_assign
id|mode-&gt;lower_margin
suffix:semicolon
id|var-&gt;hsync_len
op_assign
id|mode-&gt;hsync_len
suffix:semicolon
id|var-&gt;vsync_len
op_assign
id|mode-&gt;vsync_len
suffix:semicolon
id|var-&gt;sync
op_assign
id|mode-&gt;sync
suffix:semicolon
id|var-&gt;vmode
op_assign
id|mode-&gt;vmode
suffix:semicolon
)brace
multiline_comment|/*&n; * Build the modedb for head 1 (head 2 will come later), check panel infos&n; * from either BIOS or EDID, and pick up the default mode&n; */
DECL|function|radeon_check_modes
r_void
id|__devinit
id|radeon_check_modes
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_const
r_char
op_star
id|mode_option
)paren
(brace
r_int
id|has_default_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Fill default var first&n;&t; */
id|rinfo-&gt;info-&gt;var
op_assign
id|radeonfb_default_var
suffix:semicolon
multiline_comment|/*&n;&t; * First check out what BIOS has to say&n;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_LCD
)paren
id|radeon_get_panel_info_BIOS
c_func
(paren
id|rinfo
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Parse EDID detailed timings and deduce panel infos if any. Right now&n;&t; * we only deal with first entry returned by parse_EDID, we may do better&n;&t; * some day...&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;panel_info.use_bios_dividers
op_logical_and
id|rinfo-&gt;mon1_type
op_ne
id|MT_CRT
op_logical_and
id|rinfo-&gt;mon1_EDID
)paren
(brace
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;Parsing EDID data for panel info&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fb_parse_edid
c_func
(paren
id|rinfo-&gt;mon1_EDID
comma
op_amp
id|var
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|var.xres
op_ge
id|rinfo-&gt;panel_info.xres
op_logical_and
id|var.yres
op_ge
id|rinfo-&gt;panel_info.yres
)paren
id|radeon_var_to_panel_info
c_func
(paren
id|rinfo
comma
op_amp
id|var
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Do any additional platform/arch fixups to the panel infos&n;&t; */
id|radeon_fixup_panel_info
c_func
(paren
id|rinfo
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we have some valid panel infos, we setup the default mode based on&n;&t; * those&n;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_ne
id|MT_CRT
op_logical_and
id|rinfo-&gt;panel_info.valid
)paren
(brace
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|rinfo-&gt;info-&gt;var
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;Setting up default mode based on panel info&bslash;n&quot;
)paren
suffix:semicolon
id|var-&gt;xres
op_assign
id|rinfo-&gt;panel_info.xres
suffix:semicolon
id|var-&gt;yres
op_assign
id|rinfo-&gt;panel_info.yres
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|rinfo-&gt;panel_info.xres
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|rinfo-&gt;panel_info.yres
suffix:semicolon
id|var-&gt;xoffset
op_assign
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
l_int|8
suffix:semicolon
id|var-&gt;pixclock
op_assign
l_int|100000000
op_div
id|rinfo-&gt;panel_info.clock
suffix:semicolon
id|var-&gt;left_margin
op_assign
(paren
id|rinfo-&gt;panel_info.hblank
op_minus
id|rinfo-&gt;panel_info.hOver_plus
op_minus
id|rinfo-&gt;panel_info.hSync_width
)paren
suffix:semicolon
id|var-&gt;right_margin
op_assign
id|rinfo-&gt;panel_info.hOver_plus
suffix:semicolon
id|var-&gt;upper_margin
op_assign
(paren
id|rinfo-&gt;panel_info.vblank
op_minus
id|rinfo-&gt;panel_info.vOver_plus
op_minus
id|rinfo-&gt;panel_info.vSync_width
)paren
suffix:semicolon
id|var-&gt;lower_margin
op_assign
id|rinfo-&gt;panel_info.vOver_plus
suffix:semicolon
id|var-&gt;hsync_len
op_assign
id|rinfo-&gt;panel_info.hSync_width
suffix:semicolon
id|var-&gt;vsync_len
op_assign
id|rinfo-&gt;panel_info.vSync_width
suffix:semicolon
id|var-&gt;sync
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;panel_info.hAct_high
)paren
id|var-&gt;sync
op_or_assign
id|FB_SYNC_HOR_HIGH_ACT
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;panel_info.vAct_high
)paren
id|var-&gt;sync
op_or_assign
id|FB_SYNC_VERT_HIGH_ACT
suffix:semicolon
id|var-&gt;vmode
op_assign
l_int|0
suffix:semicolon
id|has_default_mode
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now build modedb from EDID&n;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;mon1_EDID
)paren
(brace
id|rinfo-&gt;mon1_modedb
op_assign
id|fb_create_modedb
c_func
(paren
id|rinfo-&gt;mon1_EDID
comma
op_amp
id|rinfo-&gt;mon1_dbsize
)paren
suffix:semicolon
id|fb_get_monitor_limits
c_func
(paren
id|rinfo-&gt;mon1_EDID
comma
op_amp
id|rinfo-&gt;info-&gt;monspecs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Finally, if we don&squot;t have panel infos we need to figure some (or&n;&t; * we try to read it from card), we try to pick a default mode&n;&t; * and create some panel infos. Whatever...&n;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_ne
id|MT_CRT
op_logical_and
op_logical_neg
id|rinfo-&gt;panel_info.valid
)paren
(brace
r_struct
id|fb_videomode
op_star
id|modedb
suffix:semicolon
r_int
id|dbsize
suffix:semicolon
r_char
id|modename
(braket
l_int|32
)braket
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;Guessing panel info...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;panel_info.xres
op_eq
l_int|0
op_logical_or
id|rinfo-&gt;panel_info.yres
op_eq
l_int|0
)paren
(brace
id|u32
id|tmp
op_assign
id|INREG
c_func
(paren
id|FP_HORZ_STRETCH
)paren
op_amp
id|HORZ_PANEL_SIZE
suffix:semicolon
id|rinfo-&gt;panel_info.xres
op_assign
(paren
(paren
id|tmp
op_rshift
id|HORZ_PANEL_SHIFT
)paren
op_plus
l_int|1
)paren
op_star
l_int|8
suffix:semicolon
id|tmp
op_assign
id|INREG
c_func
(paren
id|FP_VERT_STRETCH
)paren
op_amp
id|VERT_PANEL_SIZE
suffix:semicolon
id|rinfo-&gt;panel_info.yres
op_assign
(paren
id|tmp
op_rshift
id|VERT_PANEL_SHIFT
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rinfo-&gt;panel_info.xres
op_eq
l_int|0
op_logical_or
id|rinfo-&gt;panel_info.yres
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;radeonfb: Can&squot;t find panel size, going back to CRT&bslash;n&quot;
)paren
suffix:semicolon
id|rinfo-&gt;mon1_type
op_assign
id|MT_CRT
suffix:semicolon
r_goto
id|pickup_default
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;radeonfb: Assuming panel size %dx%d&bslash;n&quot;
comma
id|rinfo-&gt;panel_info.xres
comma
id|rinfo-&gt;panel_info.yres
)paren
suffix:semicolon
id|modedb
op_assign
id|rinfo-&gt;mon1_modedb
suffix:semicolon
id|dbsize
op_assign
id|rinfo-&gt;mon1_dbsize
suffix:semicolon
id|snprintf
c_func
(paren
id|modename
comma
l_int|31
comma
l_string|&quot;%dx%d&quot;
comma
id|rinfo-&gt;panel_info.xres
comma
id|rinfo-&gt;panel_info.yres
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fb_find_mode
c_func
(paren
op_amp
id|rinfo-&gt;info-&gt;var
comma
id|rinfo-&gt;info
comma
id|modename
comma
id|modedb
comma
id|dbsize
comma
l_int|NULL
comma
l_int|8
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;radeonfb: Can&squot;t find mode for panel size, going back to CRT&bslash;n&quot;
)paren
suffix:semicolon
id|rinfo-&gt;mon1_type
op_assign
id|MT_CRT
suffix:semicolon
r_goto
id|pickup_default
suffix:semicolon
)brace
id|has_default_mode
op_assign
l_int|1
suffix:semicolon
id|radeon_var_to_panel_info
c_func
(paren
id|rinfo
comma
op_amp
id|rinfo-&gt;info-&gt;var
)paren
suffix:semicolon
)brace
id|pickup_default
suffix:colon
multiline_comment|/*&n;&t; * Pick up a random default mode&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|has_default_mode
op_logical_or
id|mode_option
)paren
(brace
r_struct
id|fb_videomode
id|default_mode
suffix:semicolon
r_if
c_cond
(paren
id|has_default_mode
)paren
id|radeon_var_to_videomode
c_func
(paren
op_amp
id|default_mode
comma
op_amp
id|rinfo-&gt;info-&gt;var
)paren
suffix:semicolon
r_else
id|radeon_var_to_videomode
c_func
(paren
op_amp
id|default_mode
comma
op_amp
id|radeonfb_default_var
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fb_find_mode
c_func
(paren
op_amp
id|rinfo-&gt;info-&gt;var
comma
id|rinfo-&gt;info
comma
id|mode_option
comma
id|rinfo-&gt;mon1_modedb
comma
id|rinfo-&gt;mon1_dbsize
comma
op_amp
id|default_mode
comma
l_int|8
)paren
op_eq
l_int|0
)paren
id|rinfo-&gt;info-&gt;var
op_assign
id|radeonfb_default_var
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * The code below is used to pick up a mode in check_var and&n; * set_var. It should be made generic&n; */
multiline_comment|/*&n; * This is used when looking for modes. We assign a &quot;goodness&quot; value&n; * to a mode in the modedb depending how &quot;close&quot; it is from what we&n; * are looking for.&n; * Currently, we don&squot;t compare that much, we could do better but&n; * the current fbcon doesn&squot;t quite mind ;)&n; */
DECL|function|radeon_compare_modes
r_static
r_int
id|radeon_compare_modes
c_func
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_const
r_struct
id|fb_videomode
op_star
id|mode
)paren
(brace
r_int
id|goodness
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yres
op_eq
id|mode-&gt;yres
)paren
id|goodness
op_add_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xres
op_eq
id|mode-&gt;xres
)paren
id|goodness
op_add_assign
l_int|9
suffix:semicolon
r_return
id|goodness
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called by check_var, it gets the passed in mode parameter, and&n; * outputs a valid mode matching the passed-in one as closely as possible.&n; * We need something better ultimately. Things like fbcon basically pass us out&n; * current mode with xres/yres hacked, while things like XFree will actually&n; * produce a full timing that we should respect as much as possible.&n; *&n; * This is why I added the FB_ACTIVATE_FIND that is used by fbcon. Without this,&n; * we do a simple spec match, that&squot;s all. With it, we actually look for a mode in&n; * either our monitor modedb or the vesa one if none&n; *&n; */
DECL|function|radeon_match_mode
r_int
id|radeon_match_mode
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_struct
id|fb_var_screeninfo
op_star
id|dest
comma
r_const
r_struct
id|fb_var_screeninfo
op_star
id|src
)paren
(brace
r_const
r_struct
id|fb_videomode
op_star
id|db
op_assign
id|vesa_modes
suffix:semicolon
r_int
id|i
comma
id|dbsize
op_assign
l_int|34
suffix:semicolon
r_int
id|has_rmx
comma
id|native_db
op_assign
l_int|0
suffix:semicolon
r_int
id|goodness
op_assign
l_int|0
suffix:semicolon
r_const
r_struct
id|fb_videomode
op_star
id|candidate
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Start with a copy of the requested mode */
id|memcpy
c_func
(paren
id|dest
comma
id|src
comma
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
)paren
suffix:semicolon
multiline_comment|/* Check if we have a modedb built from EDID */
r_if
c_cond
(paren
id|rinfo-&gt;mon1_modedb
)paren
(brace
id|db
op_assign
id|rinfo-&gt;mon1_modedb
suffix:semicolon
id|dbsize
op_assign
id|rinfo-&gt;mon1_dbsize
suffix:semicolon
id|native_db
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Check if we have a scaler allowing any fancy mode */
id|has_rmx
op_assign
id|rinfo-&gt;mon1_type
op_eq
id|MT_LCD
op_logical_or
id|rinfo-&gt;mon1_type
op_eq
id|MT_DFP
suffix:semicolon
multiline_comment|/* If we have a scaler and are passed FB_ACTIVATE_TEST or&n;&t; * FB_ACTIVATE_NOW, just do basic checking and return if the&n;&t; * mode match&n;&t; */
r_if
c_cond
(paren
(paren
id|src-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_TEST
op_logical_or
(paren
id|src-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_NOW
)paren
(brace
multiline_comment|/* We don&squot;t have an RMX, validate timings. If we don&squot;t have&n;&t; &t; * monspecs, we should be paranoid and not let use go above&n;&t;&t; * 640x480-60, but I assume userland knows what it&squot;s doing here&n;&t;&t; * (though I may be proven wrong...)&n;&t;&t; */
r_if
c_cond
(paren
id|has_rmx
op_eq
l_int|0
op_logical_and
id|rinfo-&gt;mon1_modedb
)paren
r_if
c_cond
(paren
id|fb_validate_mode
c_func
(paren
(paren
r_struct
id|fb_var_screeninfo
op_star
)paren
id|src
comma
id|rinfo-&gt;info
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Now look for a mode in the database */
r_while
c_loop
(paren
id|db
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dbsize
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|g
suffix:semicolon
r_if
c_cond
(paren
id|db
(braket
id|i
)braket
dot
id|yres
OL
id|src-&gt;yres
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|db
(braket
id|i
)braket
dot
id|xres
OL
id|src-&gt;xres
)paren
r_continue
suffix:semicolon
id|g
op_assign
id|radeon_compare_modes
c_func
(paren
id|src
comma
op_amp
id|db
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* If the new mode is at least as good as the previous one,&n;&t;&t;&t; * then it&squot;s our new candidate&n;&t;&t;&t; */
r_if
c_cond
(paren
id|g
op_ge
id|goodness
)paren
(brace
id|candidate
op_assign
op_amp
id|db
(braket
id|i
)braket
suffix:semicolon
id|goodness
op_assign
id|g
suffix:semicolon
)brace
)brace
id|db
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* If we have a scaler, we allow any mode from the database */
r_if
c_cond
(paren
id|native_db
op_logical_and
id|has_rmx
)paren
(brace
id|db
op_assign
id|vesa_modes
suffix:semicolon
id|dbsize
op_assign
l_int|34
suffix:semicolon
id|native_db
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* If we have found a match, return it */
r_if
c_cond
(paren
id|candidate
op_ne
l_int|NULL
)paren
(brace
id|radeon_videomode_to_var
c_func
(paren
id|dest
comma
id|candidate
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If we haven&squot;t and don&squot;t have a scaler, fail */
r_if
c_cond
(paren
op_logical_neg
id|has_rmx
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
