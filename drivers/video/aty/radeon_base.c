multiline_comment|/*&n; *&t;drivers/video/radeonfb.c&n; *&t;framebuffer driver for ATI Radeon chipset video boards&n; *&n; *&t;Copyright 2003&t;Ben. Herrenschmidt &lt;benh@kernel.crashing.org&gt;&n; *&t;Copyright 2000&t;Ani Joshi &lt;ajoshi@kernel.crashing.org&gt;&n; *&n; *&t;i2c bits from Luca Tettamanti &lt;kronos@kronoz.cjb.net&gt;&n; *&t;&n; *&t;Special thanks to ATI DevRel team for their hardware donations.&n; *&n; *&t;...Insert GPL boilerplate here...&n; *&n; *&t;Significant portions of this driver apdated from XFree86 Radeon&n; *&t;driver which has the following copyright notice:&n; *&n; *&t;Copyright 2000 ATI Technologies Inc., Markham, Ontario, and&n; *                     VA Linux Systems Inc., Fremont, California.&n; *&n; *&t;All Rights Reserved.&n; *&n; *&t;Permission is hereby granted, free of charge, to any person obtaining&n; *&t;a copy of this software and associated documentation files (the&n; *&t;&quot;Software&quot;), to deal in the Software without restriction, including&n; *&t;without limitation on the rights to use, copy, modify, merge,&n; *&t;publish, distribute, sublicense, and/or sell copies of the Software,&n; *&t;and to permit persons to whom the Software is furnished to do so,&n; *&t;subject to the following conditions:&n; *&n; *&t;The above copyright notice and this permission notice (including the&n; *&t;next paragraph) shall be included in all copies or substantial&n; *&t;portions of the Software.&n; *&n; *&t;THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,&n; * &t;EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF&n; *&t;MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND&n; *&t;NON-INFRINGEMENT.  IN NO EVENT SHALL ATI, VA LINUX SYSTEMS AND/OR&n; *&t;THEIR SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,&n; *&t;WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,&n; *&t;OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER&n; *&t;DEALINGS IN THE SOFTWARE.&n; *&n; *&t;XFree86 driver authors:&n; *&n; *&t;   Kevin E. Martin &lt;martin@xfree86.org&gt;&n; *&t;   Rickard E. Faith &lt;faith@valinux.com&gt;&n; *&t;   Alan Hourihane &lt;alanh@fairlite.demon.co.uk&gt;&n; *&n; */
DECL|macro|RADEON_VERSION
mdefine_line|#define RADEON_VERSION&t;&quot;0.2.0&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#ifdef CONFIG_PPC_OF
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &quot;../macmodes.h&quot;
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
macro_line|#include &lt;asm/backlight.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_BOOTX_TEXT
macro_line|#include &lt;asm/btext.h&gt;
macro_line|#endif
macro_line|#endif /* CONFIG_PPC_OF */
macro_line|#ifdef CONFIG_MTRR
macro_line|#include &lt;asm/mtrr.h&gt;
macro_line|#endif
macro_line|#include &lt;video/radeon.h&gt;
macro_line|#include &lt;linux/radeonfb.h&gt;
macro_line|#include &quot;../edid.h&quot; 
singleline_comment|// MOVE THAT TO include/video
macro_line|#include &quot;ati_ids.h&quot;
macro_line|#include &quot;radeonfb.h&quot;&t;&t;    
DECL|macro|MAX_MAPPED_VRAM
mdefine_line|#define MAX_MAPPED_VRAM&t;(2048*2048*4)
DECL|macro|MIN_MAPPED_VRAM
mdefine_line|#define MIN_MAPPED_VRAM&t;(1024*768*1)
DECL|macro|CHIP_DEF
mdefine_line|#define CHIP_DEF(id, family, flags)&t;&t;&t;&t;&t;&bslash;&n;&t;{ PCI_VENDOR_ID_ATI, id, PCI_ANY_ID, PCI_ANY_ID, 0, 0, (flags) | (CHIP_FAMILY_##family) }
DECL|variable|radeonfb_pci_table
r_static
r_struct
id|pci_device_id
id|radeonfb_pci_table
(braket
)braket
op_assign
(brace
multiline_comment|/* Mobility M6 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RADEON_LY
comma
id|RV100
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RADEON_LZ
comma
id|RV100
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
multiline_comment|/* Radeon VE/7000 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV100_QY
comma
id|RV100
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV100_QZ
comma
id|RV100
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* Radeon IGP320M (U1) */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RS100_4336
comma
id|RS100
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_IGP
op_or
id|CHIP_IS_MOBILITY
)paren
comma
multiline_comment|/* Radeon IGP320 (A3) */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RS100_4136
comma
id|RS100
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_IGP
)paren
comma
multiline_comment|/* IGP330M/340M/350M (U2) */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RS200_4337
comma
id|RS200
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_IGP
op_or
id|CHIP_IS_MOBILITY
)paren
comma
multiline_comment|/* IGP330/340/350 (A4) */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RS200_4137
comma
id|RS200
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_IGP
)paren
comma
multiline_comment|/* Mobility 7000 IGP */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RS250_4437
comma
id|RS200
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_IGP
op_or
id|CHIP_IS_MOBILITY
)paren
comma
multiline_comment|/* 7000 IGP (A4+) */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RS250_4237
comma
id|RS200
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_IGP
)paren
comma
multiline_comment|/* 8500 AIW */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R200_BB
comma
id|R200
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R200_BC
comma
id|R200
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* 8700/8800 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R200_QH
comma
id|R200
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* 8500 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R200_QL
comma
id|R200
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* 9100 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R200_QM
comma
id|R200
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* Mobility M7 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RADEON_LW
comma
id|RV200
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RADEON_LX
comma
id|RV200
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
multiline_comment|/* 7500 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV200_QW
comma
id|RV200
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV200_QX
comma
id|RV200
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* Mobility M9 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV250_Ld
comma
id|RV250
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV250_Le
comma
id|RV250
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV250_Lf
comma
id|RV250
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV250_Lg
comma
id|RV250
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
multiline_comment|/* 9000/Pro */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV250_If
comma
id|RV250
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV250_Ig
comma
id|RV250
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* Mobility 9100 IGP (U3) */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RS300_5835
comma
id|RS300
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_IGP
op_or
id|CHIP_IS_MOBILITY
)paren
comma
multiline_comment|/* 9100 IGP (A5) */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RS300_5834
comma
id|RS300
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_IGP
)paren
comma
multiline_comment|/* Mobility 9200 (M9+) */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV280_5C61
comma
id|RV280
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV280_5C63
comma
id|RV280
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
multiline_comment|/* 9200 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV280_5960
comma
id|RV280
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV280_5961
comma
id|RV280
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV280_5962
comma
id|RV280
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV280_5964
comma
id|RV280
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* 9500 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R300_AD
comma
id|R300
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R300_AE
comma
id|R300
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* 9600TX / FireGL Z1 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R300_AF
comma
id|R300
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R300_AG
comma
id|R300
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* 9700/9500/Pro/FireGL X1 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R300_ND
comma
id|R300
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R300_NE
comma
id|R300
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R300_NF
comma
id|R300
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R300_NG
comma
id|R300
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* Mobility M10/M11 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV350_NP
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV350_NQ
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV350_NR
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV350_NS
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV350_NT
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV350_NV
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
op_or
id|CHIP_IS_MOBILITY
)paren
comma
multiline_comment|/* 9600/FireGL T2 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV350_AP
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV350_AQ
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV360_AR
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV350_AS
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV350_AT
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RV350_AV
comma
id|RV350
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* 9800/Pro/FileGL X2 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R350_AH
comma
id|R350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R350_AI
comma
id|R350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R350_AJ
comma
id|R350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R350_AK
comma
id|R350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R350_NH
comma
id|R350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R350_NI
comma
id|R350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R360_NJ
comma
id|R350
comma
id|CHIP_HAS_CRTC2
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_R350_NK
comma
id|R350
comma
id|CHIP_HAS_CRTC2
)paren
comma
multiline_comment|/* Original Radeon/7200 */
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RADEON_QD
comma
id|RADEON
comma
l_int|0
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RADEON_QE
comma
id|RADEON
comma
l_int|0
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RADEON_QF
comma
id|RADEON
comma
l_int|0
)paren
comma
id|CHIP_DEF
c_func
(paren
id|PCI_CHIP_RADEON_QG
comma
id|RADEON
comma
l_int|0
)paren
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|radeonfb_pci_table
)paren
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|reg
id|u16
id|reg
suffix:semicolon
DECL|member|val
id|u32
id|val
suffix:semicolon
DECL|typedef|reg_val
)brace
id|reg_val
suffix:semicolon
multiline_comment|/* these common regs are cleared before mode setting so they do not&n; * interfere with anything&n; */
DECL|variable|common_regs
r_static
id|reg_val
id|common_regs
(braket
)braket
op_assign
(brace
(brace
id|OVR_CLR
comma
l_int|0
)brace
comma
(brace
id|OVR_WID_LEFT_RIGHT
comma
l_int|0
)brace
comma
(brace
id|OVR_WID_TOP_BOTTOM
comma
l_int|0
)brace
comma
(brace
id|OV0_SCALE_CNTL
comma
l_int|0
)brace
comma
(brace
id|SUBPIC_CNTL
comma
l_int|0
)brace
comma
(brace
id|VIPH_CONTROL
comma
l_int|0
)brace
comma
(brace
id|I2C_CNTL_1
comma
l_int|0
)brace
comma
(brace
id|GEN_INT_CNTL
comma
l_int|0
)brace
comma
(brace
id|CAP0_TRIG_CNTL
comma
l_int|0
)brace
comma
(brace
id|CAP1_TRIG_CNTL
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * globals&n; */
DECL|variable|mode_option
r_static
r_char
op_star
id|mode_option
suffix:semicolon
DECL|variable|monitor_layout
r_static
r_char
op_star
id|monitor_layout
suffix:semicolon
DECL|variable|noaccel
r_static
r_int
id|noaccel
op_assign
l_int|0
suffix:semicolon
DECL|variable|nomodeset
r_static
r_int
id|nomodeset
op_assign
l_int|0
suffix:semicolon
DECL|variable|ignore_edid
r_static
r_int
id|ignore_edid
op_assign
l_int|0
suffix:semicolon
DECL|variable|mirror
r_static
r_int
id|mirror
op_assign
l_int|0
suffix:semicolon
DECL|variable|panel_yres
r_static
r_int
id|panel_yres
op_assign
l_int|0
suffix:semicolon
DECL|variable|force_dfp
r_static
r_int
id|force_dfp
op_assign
l_int|0
suffix:semicolon
DECL|variable|force_measure_pll
r_static
r_int
id|force_measure_pll
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_MTRR
DECL|variable|nomtrr
r_static
r_int
id|nomtrr
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * prototypes&n; */
macro_line|#ifdef CONFIG_PPC_OF
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
r_static
r_int
id|radeon_set_backlight_enable
c_func
(paren
r_int
id|on
comma
r_int
id|level
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|radeon_set_backlight_level
c_func
(paren
r_int
id|level
comma
r_void
op_star
id|data
)paren
suffix:semicolon
DECL|variable|radeon_backlight_controller
r_static
r_struct
id|backlight_controller
id|radeon_backlight_controller
op_assign
(brace
id|radeon_set_backlight_enable
comma
id|radeon_set_backlight_level
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_BACKLIGHT */
macro_line|#endif /* CONFIG_PPC_OF */
DECL|function|radeon_unmap_ROM
r_static
r_void
id|radeon_unmap_ROM
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;bios_seg
)paren
r_return
suffix:semicolon
id|pci_unmap_rom
c_func
(paren
id|dev
comma
id|rinfo-&gt;bios_seg
)paren
suffix:semicolon
)brace
DECL|function|radeon_map_ROM
r_static
r_int
id|__devinit
id|radeon_map_ROM
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_void
id|__iomem
op_star
id|rom
suffix:semicolon
id|u16
id|dptr
suffix:semicolon
id|u8
id|rom_type
suffix:semicolon
r_int
id|rom_size
suffix:semicolon
multiline_comment|/* If this is a primary card, there is a shadow copy of the&n;&t; * ROM somewhere in the first meg. We will just ignore the copy&n;&t; * and use the ROM directly.&n;&t; */
multiline_comment|/* Fix from ATI for problem with Radeon hardware not leaving ROM enabled */
r_int
r_int
id|temp
suffix:semicolon
id|temp
op_assign
id|INREG
c_func
(paren
id|MPP_TB_CONFIG
)paren
suffix:semicolon
id|temp
op_and_assign
l_int|0x00ffffffu
suffix:semicolon
id|temp
op_or_assign
l_int|0x04
op_lshift
l_int|24
suffix:semicolon
id|OUTREG
c_func
(paren
id|MPP_TB_CONFIG
comma
id|temp
)paren
suffix:semicolon
id|temp
op_assign
id|INREG
c_func
(paren
id|MPP_TB_CONFIG
)paren
suffix:semicolon
id|rom
op_assign
id|pci_map_rom
c_func
(paren
id|dev
comma
op_amp
id|rom_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rom
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;radeonfb: ROM failed to map&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|rinfo-&gt;bios_seg
op_assign
id|rom
suffix:semicolon
multiline_comment|/* Very simple test to make sure it appeared */
r_if
c_cond
(paren
id|BIOS_IN16
c_func
(paren
l_int|0
)paren
op_ne
l_int|0xaa55
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;radeonfb: Invalid ROM signature %x should be 0xaa55&bslash;n&quot;
comma
id|BIOS_IN16
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
multiline_comment|/* Look for the PCI data to check the ROM type */
id|dptr
op_assign
id|BIOS_IN16
c_func
(paren
l_int|0x18
)paren
suffix:semicolon
multiline_comment|/* Check the PCI data signature. If it&squot;s wrong, we still assume a normal x86 ROM&n;&t; * for now, until I&squot;ve verified this works everywhere. The goal here is more&n;&t; * to phase out Open Firmware images.&n;&t; *&n;&t; * Currently, we only look at the first PCI data, we could iteratre and deal with&n;&t; * them all, and we should use fb_bios_start relative to start of image and not&n;&t; * relative start of ROM, but so far, I never found a dual-image ATI card&n;&t; *&n;&t; * typedef struct {&n;&t; * &t;u32&t;signature;&t;+ 0x00&n;&t; * &t;u16&t;vendor;&t;&t;+ 0x04&n;&t; * &t;u16&t;device;&t;&t;+ 0x06&n;&t; * &t;u16&t;reserved_1;&t;+ 0x08&n;&t; * &t;u16&t;dlen;&t;&t;+ 0x0a&n;&t; * &t;u8&t;drevision;&t;+ 0x0c&n;&t; * &t;u8&t;class_hi;&t;+ 0x0d&n;&t; * &t;u16&t;class_lo;&t;+ 0x0e&n;&t; * &t;u16&t;ilen;&t;&t;+ 0x10&n;&t; * &t;u16&t;irevision;&t;+ 0x12&n;&t; * &t;u8&t;type;&t;&t;+ 0x14&n;&t; * &t;u8&t;indicator;&t;+ 0x15&n;&t; * &t;u16&t;reserved_2;&t;+ 0x16&n;&t; * } pci_data_t;&n;&t; */
r_if
c_cond
(paren
id|BIOS_IN32
c_func
(paren
id|dptr
)paren
op_ne
(paren
(paren
l_char|&squot;R&squot;
op_lshift
l_int|24
)paren
op_or
(paren
l_char|&squot;I&squot;
op_lshift
l_int|16
)paren
op_or
(paren
l_char|&squot;C&squot;
op_lshift
l_int|8
)paren
op_or
l_char|&squot;P&squot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;radeonfb: PCI DATA signature in ROM incorrect: %08x&bslash;n&quot;
comma
id|BIOS_IN32
c_func
(paren
id|dptr
)paren
)paren
suffix:semicolon
r_goto
id|anyway
suffix:semicolon
)brace
id|rom_type
op_assign
id|BIOS_IN8
c_func
(paren
id|dptr
op_plus
l_int|0x14
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rom_type
)paren
(brace
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Found Intel x86 BIOS ROM Image&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Found Open Firmware ROM Image&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
r_case
l_int|2
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Found HP PA-RISC ROM Image&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Found unknown type %d ROM Image&bslash;n&quot;
comma
id|rom_type
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|anyway
suffix:colon
multiline_comment|/* Locate the flat panel infos, do some sanity checking !!! */
id|rinfo-&gt;fp_bios_start
op_assign
id|BIOS_IN16
c_func
(paren
l_int|0x48
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed
suffix:colon
id|rinfo-&gt;bios_seg
op_assign
l_int|NULL
suffix:semicolon
id|radeon_unmap_ROM
c_func
(paren
id|rinfo
comma
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_X86
DECL|function|radeon_find_mem_vbios
r_static
r_int
id|__devinit
id|radeon_find_mem_vbios
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
)paren
(brace
multiline_comment|/* I simplified this code as we used to miss the signatures in&n;&t; * a lot of case. It&squot;s now closer to XFree, we just don&squot;t check&n;&t; * for signatures at all... Something better will have to be done&n;&t; * if we end up having conflicts&n;&t; */
id|u32
id|segstart
suffix:semicolon
r_void
id|__iomem
op_star
id|rom_base
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|segstart
op_assign
l_int|0x000c0000
suffix:semicolon
id|segstart
OL
l_int|0x000f0000
suffix:semicolon
id|segstart
op_add_assign
l_int|0x00001000
)paren
(brace
id|rom_base
op_assign
id|ioremap
c_func
(paren
id|segstart
comma
l_int|0x10000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rom_base
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|rom_base
)paren
op_eq
l_int|0x55
op_logical_and
id|readb
c_func
(paren
id|rom_base
op_plus
l_int|1
)paren
op_eq
l_int|0xaa
)paren
r_break
suffix:semicolon
id|iounmap
c_func
(paren
id|rom_base
)paren
suffix:semicolon
id|rom_base
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rom_base
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* Locate the flat panel infos, do some sanity checking !!! */
id|rinfo-&gt;bios_seg
op_assign
id|rom_base
suffix:semicolon
id|rinfo-&gt;fp_bios_start
op_assign
id|BIOS_IN16
c_func
(paren
l_int|0x48
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_PPC_OF
multiline_comment|/*&n; * Read XTAL (ref clock), SCLK and MCLK from Open Firmware device&n; * tree. Hopefully, ATI OF driver is kind enough to fill these&n; */
DECL|function|radeon_read_xtal_OF
r_static
r_int
id|__devinit
id|radeon_read_xtal_OF
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
)paren
(brace
r_struct
id|device_node
op_star
id|dp
suffix:semicolon
id|u32
op_star
id|val
suffix:semicolon
id|dp
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|rinfo-&gt;pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dp
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;radeonfb: Cannot match card to OF node !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|val
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
l_string|&quot;ATY,RefCLK&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|val
op_logical_or
op_logical_neg
op_star
id|val
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;radeonfb: No ATY,RefCLK property !&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|rinfo-&gt;pll.ref_clk
op_assign
(paren
op_star
id|val
)paren
op_div
l_int|10
suffix:semicolon
id|val
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
l_string|&quot;ATY,SCLK&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_logical_and
op_star
id|val
)paren
id|rinfo-&gt;pll.sclk
op_assign
(paren
op_star
id|val
)paren
op_div
l_int|10
suffix:semicolon
id|val
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
l_string|&quot;ATY,MCLK&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_logical_and
op_star
id|val
)paren
id|rinfo-&gt;pll.mclk
op_assign
(paren
op_star
id|val
)paren
op_div
l_int|10
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PPC_OF */
multiline_comment|/*&n; * Read PLL infos from chip registers&n; */
DECL|function|radeon_probe_pll_params
r_static
r_int
id|__devinit
id|radeon_probe_pll_params
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
)paren
(brace
r_int
r_char
id|ppll_div_sel
suffix:semicolon
r_int
id|Ns
comma
id|Nm
comma
id|M
suffix:semicolon
r_int
id|sclk
comma
id|mclk
comma
id|tmp
comma
id|ref_div
suffix:semicolon
r_int
id|hTotal
comma
id|vTotal
comma
id|num
comma
id|denom
comma
id|m
comma
id|n
suffix:semicolon
r_int
r_int
r_int
id|hz
comma
id|vclk
suffix:semicolon
r_int
id|xtal
suffix:semicolon
r_struct
id|timeval
id|start_tv
comma
id|stop_tv
suffix:semicolon
r_int
id|total_secs
comma
id|total_usecs
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Ugh, we cut interrupts, bad bad bad, but we want some precision&n;&t; * here, so... --BenH&n;&t; */
multiline_comment|/* Flush PCI buffers ? */
id|tmp
op_assign
id|INREG
c_func
(paren
id|DEVICE_ID
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000000
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
(paren
id|INREG
c_func
(paren
id|CRTC_VLINE_CRNT_VLINE
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x3ff
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|start_tv
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000000
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
(paren
id|INREG
c_func
(paren
id|CRTC_VLINE_CRNT_VLINE
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x3ff
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000000
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
(paren
id|INREG
c_func
(paren
id|CRTC_VLINE_CRNT_VLINE
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x3ff
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|stop_tv
)paren
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
id|total_secs
op_assign
id|stop_tv.tv_sec
op_minus
id|start_tv.tv_sec
suffix:semicolon
r_if
c_cond
(paren
id|total_secs
OG
l_int|10
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|total_usecs
op_assign
id|stop_tv.tv_usec
op_minus
id|start_tv.tv_usec
suffix:semicolon
id|total_usecs
op_add_assign
id|total_secs
op_star
l_int|1000000
suffix:semicolon
r_if
c_cond
(paren
id|total_usecs
OL
l_int|0
)paren
id|total_usecs
op_assign
op_minus
id|total_usecs
suffix:semicolon
id|hz
op_assign
l_int|1000000
op_div
id|total_usecs
suffix:semicolon
id|hTotal
op_assign
(paren
(paren
id|INREG
c_func
(paren
id|CRTC_H_TOTAL_DISP
)paren
op_amp
l_int|0x1ff
)paren
op_plus
l_int|1
)paren
op_star
l_int|8
suffix:semicolon
id|vTotal
op_assign
(paren
(paren
id|INREG
c_func
(paren
id|CRTC_V_TOTAL_DISP
)paren
op_amp
l_int|0x3ff
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|vclk
op_assign
(paren
r_int
r_int
)paren
id|hTotal
op_star
(paren
r_int
r_int
)paren
id|vTotal
op_star
id|hz
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|INPLL
c_func
(paren
id|PPLL_REF_DIV
)paren
op_amp
l_int|0x30000
)paren
op_rshift
l_int|16
)paren
(brace
r_case
l_int|0
suffix:colon
r_default
suffix:colon
id|num
op_assign
l_int|1
suffix:semicolon
id|denom
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|n
op_assign
(paren
(paren
id|INPLL
c_func
(paren
id|X_MPLL_REF_FB_DIV
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|m
op_assign
(paren
id|INPLL
c_func
(paren
id|X_MPLL_REF_FB_DIV
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|num
op_assign
l_int|2
op_star
id|n
suffix:semicolon
id|denom
op_assign
l_int|2
op_star
id|m
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|n
op_assign
(paren
(paren
id|INPLL
c_func
(paren
id|X_MPLL_REF_FB_DIV
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|m
op_assign
(paren
id|INPLL
c_func
(paren
id|X_MPLL_REF_FB_DIV
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|num
op_assign
l_int|2
op_star
id|n
suffix:semicolon
id|denom
op_assign
l_int|2
op_star
id|m
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ppll_div_sel
op_assign
id|INREG
c_func
(paren
id|CLOCK_CNTL_INDEX
op_plus
l_int|1
)paren
op_amp
l_int|0x3
suffix:semicolon
id|n
op_assign
(paren
id|INPLL
c_func
(paren
id|PPLL_DIV_0
op_plus
id|ppll_div_sel
)paren
op_amp
l_int|0x7ff
)paren
suffix:semicolon
id|m
op_assign
(paren
id|INPLL
c_func
(paren
id|PPLL_REF_DIV
)paren
op_amp
l_int|0x3ff
)paren
suffix:semicolon
id|num
op_mul_assign
id|n
suffix:semicolon
id|denom
op_mul_assign
id|m
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|INPLL
c_func
(paren
id|PPLL_DIV_0
op_plus
id|ppll_div_sel
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x7
)paren
(brace
r_case
l_int|1
suffix:colon
id|denom
op_mul_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|denom
op_mul_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|denom
op_mul_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|denom
op_mul_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|denom
op_mul_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|denom
op_mul_assign
l_int|12
suffix:semicolon
r_break
suffix:semicolon
)brace
id|vclk
op_mul_assign
id|denom
suffix:semicolon
id|do_div
c_func
(paren
id|vclk
comma
l_int|1000
op_star
id|num
)paren
suffix:semicolon
id|xtal
op_assign
id|vclk
suffix:semicolon
r_if
c_cond
(paren
(paren
id|xtal
OG
l_int|26900
)paren
op_logical_and
(paren
id|xtal
OL
l_int|27100
)paren
)paren
id|xtal
op_assign
l_int|2700
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|xtal
OG
l_int|14200
)paren
op_logical_and
(paren
id|xtal
OL
l_int|14400
)paren
)paren
id|xtal
op_assign
l_int|1432
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|xtal
OG
l_int|29400
)paren
op_logical_and
(paren
id|xtal
OL
l_int|29600
)paren
)paren
id|xtal
op_assign
l_int|2950
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;xtal calculation failed: %ld&bslash;n&quot;
comma
id|xtal
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|tmp
op_assign
id|INPLL
c_func
(paren
id|X_MPLL_REF_FB_DIV
)paren
suffix:semicolon
id|ref_div
op_assign
id|INPLL
c_func
(paren
id|PPLL_REF_DIV
)paren
op_amp
l_int|0x3ff
suffix:semicolon
id|Ns
op_assign
(paren
id|tmp
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
suffix:semicolon
id|Nm
op_assign
(paren
id|tmp
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|M
op_assign
(paren
id|tmp
op_amp
l_int|0xff
)paren
suffix:semicolon
id|sclk
op_assign
id|round_div
c_func
(paren
(paren
l_int|2
op_star
id|Ns
op_star
id|xtal
)paren
comma
(paren
l_int|2
op_star
id|M
)paren
)paren
suffix:semicolon
id|mclk
op_assign
id|round_div
c_func
(paren
(paren
l_int|2
op_star
id|Nm
op_star
id|xtal
)paren
comma
(paren
l_int|2
op_star
id|M
)paren
)paren
suffix:semicolon
multiline_comment|/* we&squot;re done, hopefully these are sane values */
id|rinfo-&gt;pll.ref_clk
op_assign
id|xtal
suffix:semicolon
id|rinfo-&gt;pll.ref_div
op_assign
id|ref_div
suffix:semicolon
id|rinfo-&gt;pll.sclk
op_assign
id|sclk
suffix:semicolon
id|rinfo-&gt;pll.mclk
op_assign
id|mclk
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Retreive PLL infos by different means (BIOS, Open Firmware, register probing...)&n; */
DECL|function|radeon_get_pllinfo
r_static
r_void
id|__devinit
id|radeon_get_pllinfo
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
)paren
(brace
multiline_comment|/*&n;&t; * In the case nothing works, these are defaults; they are mostly&n;&t; * incomplete, however.  It does provide ppll_max and _min values&n;&t; * even for most other methods, however.&n;&t; */
r_switch
c_cond
(paren
id|rinfo-&gt;chipset
)paren
(brace
r_case
id|PCI_DEVICE_ID_ATI_RADEON_QW
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_QX
suffix:colon
id|rinfo-&gt;pll.ppll_max
op_assign
l_int|35000
suffix:semicolon
id|rinfo-&gt;pll.ppll_min
op_assign
l_int|12000
suffix:semicolon
id|rinfo-&gt;pll.mclk
op_assign
l_int|23000
suffix:semicolon
id|rinfo-&gt;pll.sclk
op_assign
l_int|23000
suffix:semicolon
id|rinfo-&gt;pll.ref_clk
op_assign
l_int|2700
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_QL
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_QN
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_QO
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_Ql
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_BB
suffix:colon
id|rinfo-&gt;pll.ppll_max
op_assign
l_int|35000
suffix:semicolon
id|rinfo-&gt;pll.ppll_min
op_assign
l_int|12000
suffix:semicolon
id|rinfo-&gt;pll.mclk
op_assign
l_int|27500
suffix:semicolon
id|rinfo-&gt;pll.sclk
op_assign
l_int|27500
suffix:semicolon
id|rinfo-&gt;pll.ref_clk
op_assign
l_int|2700
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_Id
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_Ie
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_If
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_Ig
suffix:colon
id|rinfo-&gt;pll.ppll_max
op_assign
l_int|35000
suffix:semicolon
id|rinfo-&gt;pll.ppll_min
op_assign
l_int|12000
suffix:semicolon
id|rinfo-&gt;pll.mclk
op_assign
l_int|25000
suffix:semicolon
id|rinfo-&gt;pll.sclk
op_assign
l_int|25000
suffix:semicolon
id|rinfo-&gt;pll.ref_clk
op_assign
l_int|2700
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_ND
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_NE
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_NF
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_NG
suffix:colon
id|rinfo-&gt;pll.ppll_max
op_assign
l_int|40000
suffix:semicolon
id|rinfo-&gt;pll.ppll_min
op_assign
l_int|20000
suffix:semicolon
id|rinfo-&gt;pll.mclk
op_assign
l_int|27000
suffix:semicolon
id|rinfo-&gt;pll.sclk
op_assign
l_int|27000
suffix:semicolon
id|rinfo-&gt;pll.ref_clk
op_assign
l_int|2700
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_QD
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_QE
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_QF
suffix:colon
r_case
id|PCI_DEVICE_ID_ATI_RADEON_QG
suffix:colon
r_default
suffix:colon
id|rinfo-&gt;pll.ppll_max
op_assign
l_int|35000
suffix:semicolon
id|rinfo-&gt;pll.ppll_min
op_assign
l_int|12000
suffix:semicolon
id|rinfo-&gt;pll.mclk
op_assign
l_int|16600
suffix:semicolon
id|rinfo-&gt;pll.sclk
op_assign
l_int|16600
suffix:semicolon
id|rinfo-&gt;pll.ref_clk
op_assign
l_int|2700
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rinfo-&gt;pll.ref_div
op_assign
id|INPLL
c_func
(paren
id|PPLL_REF_DIV
)paren
op_amp
l_int|0x3ff
suffix:semicolon
macro_line|#ifdef CONFIG_PPC_OF
multiline_comment|/*&n;&t; * Retreive PLL infos from Open Firmware first&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|force_measure_pll
op_logical_and
id|radeon_read_xtal_OF
c_func
(paren
id|rinfo
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Retreived PLL infos from Open Firmware&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PPC_OF */
multiline_comment|/*&n;&t; * Check out if we have an X86 which gave us some PLL informations&n;&t; * and if yes, retreive them&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|force_measure_pll
op_logical_and
id|rinfo-&gt;bios_seg
)paren
(brace
id|u16
id|pll_info_block
op_assign
id|BIOS_IN16
c_func
(paren
id|rinfo-&gt;fp_bios_start
op_plus
l_int|0x30
)paren
suffix:semicolon
id|rinfo-&gt;pll.sclk
op_assign
id|BIOS_IN16
c_func
(paren
id|pll_info_block
op_plus
l_int|0x08
)paren
suffix:semicolon
id|rinfo-&gt;pll.mclk
op_assign
id|BIOS_IN16
c_func
(paren
id|pll_info_block
op_plus
l_int|0x0a
)paren
suffix:semicolon
id|rinfo-&gt;pll.ref_clk
op_assign
id|BIOS_IN16
c_func
(paren
id|pll_info_block
op_plus
l_int|0x0e
)paren
suffix:semicolon
id|rinfo-&gt;pll.ref_div
op_assign
id|BIOS_IN16
c_func
(paren
id|pll_info_block
op_plus
l_int|0x10
)paren
suffix:semicolon
id|rinfo-&gt;pll.ppll_min
op_assign
id|BIOS_IN32
c_func
(paren
id|pll_info_block
op_plus
l_int|0x12
)paren
suffix:semicolon
id|rinfo-&gt;pll.ppll_max
op_assign
id|BIOS_IN32
c_func
(paren
id|pll_info_block
op_plus
l_int|0x16
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Retreived PLL infos from BIOS&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We didn&squot;t get PLL parameters from either OF or BIOS, we try to&n;&t; * probe them&n;&t; */
r_if
c_cond
(paren
id|radeon_probe_pll_params
c_func
(paren
id|rinfo
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Retreived PLL infos from registers&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Fall back to already-set defaults...&n;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;radeonfb: Used default PLL infos&bslash;n&quot;
)paren
suffix:semicolon
id|found
suffix:colon
multiline_comment|/*&n;&t; * Some methods fail to retreive SCLK and MCLK values, we apply default&n;&t; * settings in this case (200Mhz). If that really happne often, we could&n;&t; * fetch from registers instead...&n;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;pll.mclk
op_eq
l_int|0
)paren
id|rinfo-&gt;pll.mclk
op_assign
l_int|20000
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;pll.sclk
op_eq
l_int|0
)paren
id|rinfo-&gt;pll.sclk
op_assign
l_int|20000
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;radeonfb: Reference=%d.%02d MHz (RefDiv=%d) Memory=%d.%02d Mhz, System=%d.%02d MHz&bslash;n&quot;
comma
id|rinfo-&gt;pll.ref_clk
op_div
l_int|100
comma
id|rinfo-&gt;pll.ref_clk
op_mod
l_int|100
comma
id|rinfo-&gt;pll.ref_div
comma
id|rinfo-&gt;pll.mclk
op_div
l_int|100
comma
id|rinfo-&gt;pll.mclk
op_mod
l_int|100
comma
id|rinfo-&gt;pll.sclk
op_div
l_int|100
comma
id|rinfo-&gt;pll.sclk
op_mod
l_int|100
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;radeonfb: PLL min %d max %d&bslash;n&quot;
comma
id|rinfo-&gt;pll.ppll_min
comma
id|rinfo-&gt;pll.ppll_max
)paren
suffix:semicolon
)brace
DECL|function|radeonfb_check_var
r_static
r_int
id|radeonfb_check_var
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|radeonfb_info
op_star
id|rinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_struct
id|fb_var_screeninfo
id|v
suffix:semicolon
r_int
id|nom
comma
id|den
suffix:semicolon
r_int
r_int
id|pitch
suffix:semicolon
r_if
c_cond
(paren
id|radeon_match_mode
c_func
(paren
id|rinfo
comma
op_amp
id|v
comma
id|var
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|v.bits_per_pixel
)paren
(brace
r_case
l_int|0
dot
dot
dot
l_int|8
suffix:colon
id|v.bits_per_pixel
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
dot
dot
dot
l_int|16
suffix:colon
id|v.bits_per_pixel
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|17
dot
dot
dot
l_int|24
suffix:colon
macro_line|#if 0 /* Doesn&squot;t seem to work */
id|v.bits_per_pixel
op_assign
l_int|24
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif&t;&t;&t;
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
l_int|25
dot
dot
dot
l_int|32
suffix:colon
id|v.bits_per_pixel
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|var_to_depth
c_func
(paren
op_amp
id|v
)paren
)paren
(brace
r_case
l_int|8
suffix:colon
id|nom
op_assign
id|den
op_assign
l_int|1
suffix:semicolon
id|v.red.offset
op_assign
id|v.green.offset
op_assign
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
id|v.red.length
op_assign
id|v.green.length
op_assign
id|v.blue.length
op_assign
l_int|8
suffix:semicolon
id|v.transp.offset
op_assign
id|v.transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
id|nom
op_assign
l_int|2
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
id|v.red.offset
op_assign
l_int|10
suffix:semicolon
id|v.green.offset
op_assign
l_int|5
suffix:semicolon
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
id|v.red.length
op_assign
id|v.green.length
op_assign
id|v.blue.length
op_assign
l_int|5
suffix:semicolon
id|v.transp.offset
op_assign
id|v.transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|nom
op_assign
l_int|2
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
id|v.red.offset
op_assign
l_int|11
suffix:semicolon
id|v.green.offset
op_assign
l_int|5
suffix:semicolon
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
id|v.red.length
op_assign
l_int|5
suffix:semicolon
id|v.green.length
op_assign
l_int|6
suffix:semicolon
id|v.blue.length
op_assign
l_int|5
suffix:semicolon
id|v.transp.offset
op_assign
id|v.transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|nom
op_assign
l_int|4
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
id|v.red.offset
op_assign
l_int|16
suffix:semicolon
id|v.green.offset
op_assign
l_int|8
suffix:semicolon
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
id|v.red.length
op_assign
id|v.blue.length
op_assign
id|v.green.length
op_assign
l_int|8
suffix:semicolon
id|v.transp.offset
op_assign
id|v.transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|nom
op_assign
l_int|4
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
id|v.red.offset
op_assign
l_int|16
suffix:semicolon
id|v.green.offset
op_assign
l_int|8
suffix:semicolon
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
id|v.red.length
op_assign
id|v.blue.length
op_assign
id|v.green.length
op_assign
l_int|8
suffix:semicolon
id|v.transp.offset
op_assign
l_int|24
suffix:semicolon
id|v.transp.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;radeonfb: mode %dx%dx%d rejected, color depth invalid&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.yres_virtual
OL
id|v.yres
)paren
id|v.yres_virtual
op_assign
id|v.yres
suffix:semicolon
r_if
c_cond
(paren
id|v.xres_virtual
OL
id|v.xres
)paren
id|v.xres_virtual
op_assign
id|v.xres
suffix:semicolon
multiline_comment|/* XXX I&squot;m adjusting xres_virtual to the pitch, that may help XFree&n;&t; * with some panels, though I don&squot;t quite like this solution&n;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;info-&gt;flags
op_amp
id|FBINFO_HWACCEL_DISABLED
)paren
(brace
id|v.xres_virtual
op_assign
id|v.xres_virtual
op_amp
op_complement
l_int|7ul
suffix:semicolon
)brace
r_else
(brace
id|pitch
op_assign
(paren
(paren
id|v.xres_virtual
op_star
(paren
(paren
id|v.bits_per_pixel
op_plus
l_int|1
)paren
op_div
l_int|8
)paren
op_plus
l_int|0x3f
)paren
op_amp
op_complement
(paren
l_int|0x3f
)paren
)paren
op_rshift
l_int|6
suffix:semicolon
id|v.xres_virtual
op_assign
(paren
id|pitch
op_lshift
l_int|6
)paren
op_div
(paren
(paren
id|v.bits_per_pixel
op_plus
l_int|1
)paren
op_div
l_int|8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|v.xres_virtual
op_star
id|v.yres_virtual
op_star
id|nom
)paren
op_div
id|den
)paren
OG
id|rinfo-&gt;mapped_vram
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|v.xres_virtual
OL
id|v.xres
)paren
id|v.xres
op_assign
id|v.xres_virtual
suffix:semicolon
r_if
c_cond
(paren
id|v.xoffset
OL
l_int|0
)paren
id|v.xoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|v.yoffset
OL
l_int|0
)paren
id|v.yoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|v.xoffset
OG
id|v.xres_virtual
op_minus
id|v.xres
)paren
id|v.xoffset
op_assign
id|v.xres_virtual
op_minus
id|v.xres
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|v.yoffset
OG
id|v.yres_virtual
op_minus
id|v.yres
)paren
id|v.yoffset
op_assign
id|v.yres_virtual
op_minus
id|v.yres
op_minus
l_int|1
suffix:semicolon
id|v.red.msb_right
op_assign
id|v.green.msb_right
op_assign
id|v.blue.msb_right
op_assign
id|v.transp.offset
op_assign
id|v.transp.length
op_assign
id|v.transp.msb_right
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|var
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeonfb_pan_display
r_static
r_int
id|radeonfb_pan_display
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|radeonfb_info
op_star
id|rinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
(paren
id|var-&gt;xoffset
op_plus
id|var-&gt;xres
OG
id|var-&gt;xres_virtual
)paren
op_logical_or
(paren
id|var-&gt;yoffset
op_plus
id|var-&gt;yres
OG
id|var-&gt;yres_virtual
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;asleep
)paren
r_return
l_int|0
suffix:semicolon
id|radeon_fifo_wait
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_OFFSET
comma
(paren
(paren
id|var-&gt;yoffset
op_star
id|var-&gt;xres_virtual
op_plus
id|var-&gt;xoffset
)paren
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|8
)paren
op_amp
op_complement
l_int|7
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeonfb_ioctl
r_static
r_int
id|radeonfb_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|radeonfb_info
op_star
id|rinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
id|u32
id|value
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/*&n;&t;&t; * TODO:  set mirror accordingly for non-Mobility chipsets with 2 CRTC&squot;s&n;&t;&t; *        and do something better using 2nd CRTC instead of just hackish&n;&t;&t; *        routing to second output&n;&t;&t; */
r_case
id|FBIO_RADEON_SET_MIRROR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;is_mobility
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|rc
op_assign
id|get_user
c_func
(paren
id|value
comma
(paren
id|__u32
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|radeon_fifo_wait
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_amp
l_int|0x01
)paren
(brace
id|tmp
op_assign
id|INREG
c_func
(paren
id|LVDS_GEN_CNTL
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|LVDS_ON
op_or
id|LVDS_BLON
)paren
suffix:semicolon
)brace
r_else
(brace
id|tmp
op_assign
id|INREG
c_func
(paren
id|LVDS_GEN_CNTL
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|LVDS_ON
op_or
id|LVDS_BLON
)paren
suffix:semicolon
)brace
id|OUTREG
c_func
(paren
id|LVDS_GEN_CNTL
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_amp
l_int|0x02
)paren
(brace
id|tmp
op_assign
id|INREG
c_func
(paren
id|CRTC_EXT_CNTL
)paren
suffix:semicolon
id|tmp
op_or_assign
id|CRTC_CRT_ON
suffix:semicolon
id|mirror
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|tmp
op_assign
id|INREG
c_func
(paren
id|CRTC_EXT_CNTL
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
id|CRTC_CRT_ON
suffix:semicolon
id|mirror
op_assign
l_int|0
suffix:semicolon
)brace
id|OUTREG
c_func
(paren
id|CRTC_EXT_CNTL
comma
id|tmp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIO_RADEON_GET_MIRROR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;is_mobility
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|tmp
op_assign
id|INREG
c_func
(paren
id|LVDS_GEN_CNTL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|LVDS_ON
op_or
id|LVDS_BLON
)paren
op_amp
id|tmp
)paren
id|value
op_or_assign
l_int|0x01
suffix:semicolon
id|tmp
op_assign
id|INREG
c_func
(paren
id|CRTC_EXT_CNTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CRTC_CRT_ON
op_amp
id|tmp
)paren
id|value
op_or_assign
l_int|0x02
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|value
comma
(paren
id|__u32
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|radeon_screen_blank
r_static
r_int
id|radeon_screen_blank
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_int
id|blank
comma
r_int
id|mode_switch
)paren
(brace
id|u32
id|val
suffix:semicolon
id|u32
id|tmp_pix_clks
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;lock_blank
)paren
r_return
l_int|0
suffix:semicolon
id|radeon_engine_idle
c_func
(paren
)paren
suffix:semicolon
id|val
op_assign
id|INREG
c_func
(paren
id|CRTC_EXT_CNTL
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
(paren
id|CRTC_DISPLAY_DIS
op_or
id|CRTC_HSYNC_DIS
op_or
id|CRTC_VSYNC_DIS
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|blank
)paren
(brace
r_case
id|FB_BLANK_UNBLANK
suffix:colon
r_case
id|FB_BLANK_NORMAL
suffix:colon
r_break
suffix:semicolon
r_case
id|FB_BLANK_VSYNC_SUSPEND
suffix:colon
id|val
op_or_assign
(paren
id|CRTC_DISPLAY_DIS
op_or
id|CRTC_VSYNC_DIS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_HSYNC_SUSPEND
suffix:colon
id|val
op_or_assign
(paren
id|CRTC_DISPLAY_DIS
op_or
id|CRTC_HSYNC_DIS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_BLANK_POWERDOWN
suffix:colon
id|val
op_or_assign
(paren
id|CRTC_DISPLAY_DIS
op_or
id|CRTC_VSYNC_DIS
op_or
id|CRTC_HSYNC_DIS
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|OUTREG
c_func
(paren
id|CRTC_EXT_CNTL
comma
id|val
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rinfo-&gt;mon1_type
)paren
(brace
r_case
id|MT_DFP
suffix:colon
r_if
c_cond
(paren
id|mode_switch
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|blank
op_eq
id|FB_BLANK_UNBLANK
op_logical_or
id|blank
op_eq
id|FB_BLANK_NORMAL
)paren
id|OUTREGP
c_func
(paren
id|FP_GEN_CNTL
comma
(paren
id|FP_FPON
op_or
id|FP_TMDS_EN
)paren
comma
op_complement
(paren
id|FP_FPON
op_or
id|FP_TMDS_EN
)paren
)paren
suffix:semicolon
r_else
id|OUTREGP
c_func
(paren
id|FP_GEN_CNTL
comma
l_int|0
comma
op_complement
(paren
id|FP_FPON
op_or
id|FP_TMDS_EN
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MT_LCD
suffix:colon
id|val
op_assign
id|INREG
c_func
(paren
id|LVDS_GEN_CNTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blank
op_eq
id|FB_BLANK_UNBLANK
op_logical_or
id|blank
op_eq
id|FB_BLANK_NORMAL
)paren
(brace
id|u32
id|target_val
op_assign
(paren
id|val
op_amp
op_complement
id|LVDS_DISPLAY_DIS
)paren
op_or
id|LVDS_BLON
op_or
id|LVDS_ON
op_or
id|LVDS_ON
op_or
(paren
id|rinfo-&gt;init_state.lvds_gen_cntl
op_amp
id|LVDS_DIGON
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_xor
id|target_val
)paren
op_eq
id|LVDS_DISPLAY_DIS
)paren
id|OUTREG
c_func
(paren
id|LVDS_GEN_CNTL
comma
id|target_val
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|val
op_xor
id|target_val
)paren
op_ne
l_int|0
)paren
(brace
id|del_timer_sync
c_func
(paren
op_amp
id|rinfo-&gt;lvds_timer
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|LVDS_GEN_CNTL
comma
id|target_val
op_amp
op_complement
id|LVDS_ON
)paren
suffix:semicolon
id|rinfo-&gt;init_state.lvds_gen_cntl
op_and_assign
op_complement
id|LVDS_STATE_MASK
suffix:semicolon
id|rinfo-&gt;init_state.lvds_gen_cntl
op_or_assign
id|target_val
op_amp
id|LVDS_STATE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|mode_switch
)paren
(brace
id|msleep
c_func
(paren
id|rinfo-&gt;panel_info.pwr_delay
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|LVDS_GEN_CNTL
comma
id|target_val
)paren
suffix:semicolon
)brace
r_else
(brace
id|rinfo-&gt;pending_lvds_gen_cntl
op_assign
id|target_val
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|rinfo-&gt;lvds_timer
comma
id|jiffies
op_plus
id|msecs_to_jiffies
c_func
(paren
id|rinfo-&gt;panel_info.pwr_delay
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|val
op_or_assign
id|LVDS_DISPLAY_DIS
suffix:semicolon
id|OUTREG
c_func
(paren
id|LVDS_GEN_CNTL
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t do a full switch-off on a simple mode switch */
r_if
c_cond
(paren
id|mode_switch
)paren
r_break
suffix:semicolon
multiline_comment|/* Asic bug, when turning off LVDS_ON, we have to make sure&n;&t;&t;&t; * RADEON_PIXCLK_LVDS_ALWAYS_ON bit is off&n;&t;&t;&t; */
id|tmp_pix_clks
op_assign
id|INPLL
c_func
(paren
id|PIXCLKS_CNTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;is_mobility
op_logical_or
id|rinfo-&gt;is_IGP
)paren
id|OUTPLLP
c_func
(paren
id|PIXCLKS_CNTL
comma
l_int|0
comma
op_complement
id|PIXCLK_LVDS_ALWAYS_ONb
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
(paren
id|LVDS_BLON
op_or
id|LVDS_ON
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|LVDS_GEN_CNTL
comma
id|val
)paren
suffix:semicolon
id|rinfo-&gt;init_state.lvds_gen_cntl
op_and_assign
op_complement
id|LVDS_STATE_MASK
suffix:semicolon
id|rinfo-&gt;init_state.lvds_gen_cntl
op_or_assign
id|val
op_amp
id|LVDS_STATE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;is_mobility
op_logical_or
id|rinfo-&gt;is_IGP
)paren
id|OUTPLL
c_func
(paren
id|PIXCLKS_CNTL
comma
id|tmp_pix_clks
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MT_CRT
suffix:colon
singleline_comment|// todo: powerdown DAC
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* let fbcon do a soft blank for us */
r_return
(paren
id|blank
op_eq
id|FB_BLANK_NORMAL
)paren
ques
c_cond
op_minus
id|EINVAL
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|radeonfb_blank
r_int
id|radeonfb_blank
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|radeonfb_info
op_star
id|rinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;asleep
)paren
r_return
l_int|0
suffix:semicolon
id|radeon_screen_blank
c_func
(paren
id|rinfo
comma
id|blank
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeonfb_setcolreg
r_static
r_int
id|radeonfb_setcolreg
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|radeonfb_info
op_star
id|rinfo
op_assign
id|info-&gt;par
suffix:semicolon
id|u32
id|pindex
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|rinfo-&gt;palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|rinfo-&gt;palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|rinfo-&gt;palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
multiline_comment|/* default */
id|pindex
op_assign
id|regno
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;asleep
)paren
(brace
id|u32
id|dac_cntl2
comma
id|vclk_cntl
op_assign
l_int|0
suffix:semicolon
id|radeon_fifo_wait
c_func
(paren
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;is_mobility
)paren
(brace
id|vclk_cntl
op_assign
id|INPLL
c_func
(paren
id|VCLK_ECP_CNTL
)paren
suffix:semicolon
id|OUTPLL
c_func
(paren
id|VCLK_ECP_CNTL
comma
id|vclk_cntl
op_amp
op_complement
id|PIXCLK_DAC_ALWAYS_ONb
)paren
suffix:semicolon
)brace
multiline_comment|/* Make sure we are on first palette */
r_if
c_cond
(paren
id|rinfo-&gt;has_CRTC2
)paren
(brace
id|dac_cntl2
op_assign
id|INREG
c_func
(paren
id|DAC_CNTL2
)paren
suffix:semicolon
id|dac_cntl2
op_and_assign
op_complement
id|DAC2_PALETTE_ACCESS_CNTL
suffix:semicolon
id|OUTREG
c_func
(paren
id|DAC_CNTL2
comma
id|dac_cntl2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rinfo-&gt;bpp
op_eq
l_int|16
)paren
(brace
id|pindex
op_assign
id|regno
op_star
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;depth
op_eq
l_int|16
op_logical_and
id|regno
OG
l_int|63
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;depth
op_eq
l_int|15
op_logical_and
id|regno
OG
l_int|31
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* For 565, the green component is mixed one order below */
r_if
c_cond
(paren
id|rinfo-&gt;depth
op_eq
l_int|16
)paren
(brace
id|OUTREG
c_func
(paren
id|PALETTE_INDEX
comma
id|pindex
op_rshift
l_int|1
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|PALETTE_DATA
comma
(paren
id|rinfo-&gt;palette
(braket
id|regno
op_rshift
l_int|1
)braket
dot
id|red
op_lshift
l_int|16
)paren
op_or
(paren
id|green
op_lshift
l_int|8
)paren
op_or
(paren
id|rinfo-&gt;palette
(braket
id|regno
op_rshift
l_int|1
)braket
dot
id|blue
)paren
)paren
suffix:semicolon
id|green
op_assign
id|rinfo-&gt;palette
(braket
id|regno
op_lshift
l_int|1
)braket
dot
id|green
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rinfo-&gt;depth
op_ne
l_int|16
op_logical_or
id|regno
OL
l_int|32
)paren
(brace
id|OUTREG
c_func
(paren
id|PALETTE_INDEX
comma
id|pindex
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|PALETTE_DATA
comma
(paren
id|red
op_lshift
l_int|16
)paren
op_or
(paren
id|green
op_lshift
l_int|8
)paren
op_or
id|blue
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rinfo-&gt;is_mobility
)paren
id|OUTPLL
c_func
(paren
id|VCLK_ECP_CNTL
comma
id|vclk_cntl
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|regno
OL
l_int|16
)paren
(brace
id|u32
op_star
id|pal
op_assign
id|info-&gt;pseudo_palette
suffix:semicolon
r_switch
c_cond
(paren
id|rinfo-&gt;depth
)paren
(brace
r_case
l_int|15
suffix:colon
id|pal
(braket
id|regno
)braket
op_assign
(paren
id|regno
op_lshift
l_int|10
)paren
op_or
(paren
id|regno
op_lshift
l_int|5
)paren
op_or
id|regno
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|pal
(braket
id|regno
)braket
op_assign
(paren
id|regno
op_lshift
l_int|11
)paren
op_or
(paren
id|regno
op_lshift
l_int|5
)paren
op_or
id|regno
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|pal
(braket
id|regno
)braket
op_assign
(paren
id|regno
op_lshift
l_int|16
)paren
op_or
(paren
id|regno
op_lshift
l_int|8
)paren
op_or
id|regno
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|i
op_assign
(paren
id|regno
op_lshift
l_int|8
)paren
op_or
id|regno
suffix:semicolon
id|pal
(braket
id|regno
)braket
op_assign
(paren
id|i
op_lshift
l_int|16
)paren
op_or
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeon_save_state
r_static
r_void
id|radeon_save_state
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_struct
id|radeon_regs
op_star
id|save
)paren
(brace
multiline_comment|/* CRTC regs */
id|save-&gt;crtc_gen_cntl
op_assign
id|INREG
c_func
(paren
id|CRTC_GEN_CNTL
)paren
suffix:semicolon
id|save-&gt;crtc_ext_cntl
op_assign
id|INREG
c_func
(paren
id|CRTC_EXT_CNTL
)paren
suffix:semicolon
id|save-&gt;crtc_more_cntl
op_assign
id|INREG
c_func
(paren
id|CRTC_MORE_CNTL
)paren
suffix:semicolon
id|save-&gt;dac_cntl
op_assign
id|INREG
c_func
(paren
id|DAC_CNTL
)paren
suffix:semicolon
id|save-&gt;crtc_h_total_disp
op_assign
id|INREG
c_func
(paren
id|CRTC_H_TOTAL_DISP
)paren
suffix:semicolon
id|save-&gt;crtc_h_sync_strt_wid
op_assign
id|INREG
c_func
(paren
id|CRTC_H_SYNC_STRT_WID
)paren
suffix:semicolon
id|save-&gt;crtc_v_total_disp
op_assign
id|INREG
c_func
(paren
id|CRTC_V_TOTAL_DISP
)paren
suffix:semicolon
id|save-&gt;crtc_v_sync_strt_wid
op_assign
id|INREG
c_func
(paren
id|CRTC_V_SYNC_STRT_WID
)paren
suffix:semicolon
id|save-&gt;crtc_pitch
op_assign
id|INREG
c_func
(paren
id|CRTC_PITCH
)paren
suffix:semicolon
id|save-&gt;surface_cntl
op_assign
id|INREG
c_func
(paren
id|SURFACE_CNTL
)paren
suffix:semicolon
multiline_comment|/* FP regs */
id|save-&gt;fp_crtc_h_total_disp
op_assign
id|INREG
c_func
(paren
id|FP_CRTC_H_TOTAL_DISP
)paren
suffix:semicolon
id|save-&gt;fp_crtc_v_total_disp
op_assign
id|INREG
c_func
(paren
id|FP_CRTC_V_TOTAL_DISP
)paren
suffix:semicolon
id|save-&gt;fp_gen_cntl
op_assign
id|INREG
c_func
(paren
id|FP_GEN_CNTL
)paren
suffix:semicolon
id|save-&gt;fp_h_sync_strt_wid
op_assign
id|INREG
c_func
(paren
id|FP_H_SYNC_STRT_WID
)paren
suffix:semicolon
id|save-&gt;fp_horz_stretch
op_assign
id|INREG
c_func
(paren
id|FP_HORZ_STRETCH
)paren
suffix:semicolon
id|save-&gt;fp_v_sync_strt_wid
op_assign
id|INREG
c_func
(paren
id|FP_V_SYNC_STRT_WID
)paren
suffix:semicolon
id|save-&gt;fp_vert_stretch
op_assign
id|INREG
c_func
(paren
id|FP_VERT_STRETCH
)paren
suffix:semicolon
id|save-&gt;lvds_gen_cntl
op_assign
id|INREG
c_func
(paren
id|LVDS_GEN_CNTL
)paren
suffix:semicolon
id|save-&gt;lvds_pll_cntl
op_assign
id|INREG
c_func
(paren
id|LVDS_PLL_CNTL
)paren
suffix:semicolon
id|save-&gt;tmds_crc
op_assign
id|INREG
c_func
(paren
id|TMDS_CRC
)paren
suffix:semicolon
id|save-&gt;tmds_transmitter_cntl
op_assign
id|INREG
c_func
(paren
id|TMDS_TRANSMITTER_CNTL
)paren
suffix:semicolon
id|save-&gt;vclk_ecp_cntl
op_assign
id|INPLL
c_func
(paren
id|VCLK_ECP_CNTL
)paren
suffix:semicolon
)brace
DECL|function|radeon_write_pll_regs
r_static
r_void
id|radeon_write_pll_regs
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_struct
id|radeon_regs
op_star
id|mode
)paren
(brace
r_int
id|i
suffix:semicolon
id|radeon_fifo_wait
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* Workaround from XFree */
r_if
c_cond
(paren
id|rinfo-&gt;is_mobility
)paren
(brace
multiline_comment|/* A temporal workaround for the occational blanking on certain laptop panels. &n;&t;           This appears to related to the PLL divider registers (fail to lock?).  &n;&t;&t;   It occurs even when all dividers are the same with their old settings.  &n;&t;           In this case we really don&squot;t need to fiddle with PLL registers. &n;&t;           By doing this we can avoid the blanking problem with some panels.&n;&t;        */
r_if
c_cond
(paren
(paren
id|mode-&gt;ppll_ref_div
op_eq
(paren
id|INPLL
c_func
(paren
id|PPLL_REF_DIV
)paren
op_amp
id|PPLL_REF_DIV_MASK
)paren
)paren
op_logical_and
(paren
id|mode-&gt;ppll_div_3
op_eq
(paren
id|INPLL
c_func
(paren
id|PPLL_DIV_3
)paren
op_amp
(paren
id|PPLL_POST3_DIV_MASK
op_or
id|PPLL_FB3_DIV_MASK
)paren
)paren
)paren
)paren
(brace
multiline_comment|/* We still have to force a switch to PPLL div 3 thanks to&n;&t;&t;&t; * an XFree86 driver bug which will switch it away in some cases&n;&t;&t;&t; * even when using UseFDev */
id|OUTREGP
c_func
(paren
id|CLOCK_CNTL_INDEX
comma
id|PPLL_DIV_SEL_MASK
comma
op_complement
id|PPLL_DIV_SEL_MASK
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Swich VCKL clock input to CPUCLK so it stays fed while PPLL updates*/
id|OUTPLLP
c_func
(paren
id|VCLK_ECP_CNTL
comma
id|VCLK_SRC_SEL_CPUCLK
comma
op_complement
id|VCLK_SRC_SEL_MASK
)paren
suffix:semicolon
multiline_comment|/* Reset PPLL &amp; enable atomic update */
id|OUTPLLP
c_func
(paren
id|PPLL_CNTL
comma
id|PPLL_RESET
op_or
id|PPLL_ATOMIC_UPDATE_EN
op_or
id|PPLL_VGA_ATOMIC_UPDATE_EN
comma
op_complement
(paren
id|PPLL_RESET
op_or
id|PPLL_ATOMIC_UPDATE_EN
op_or
id|PPLL_VGA_ATOMIC_UPDATE_EN
)paren
)paren
suffix:semicolon
multiline_comment|/* Switch to PPLL div 3 */
id|OUTREGP
c_func
(paren
id|CLOCK_CNTL_INDEX
comma
id|PPLL_DIV_SEL_MASK
comma
op_complement
id|PPLL_DIV_SEL_MASK
)paren
suffix:semicolon
multiline_comment|/* Set PPLL ref. div */
r_if
c_cond
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_R300
op_logical_or
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RS300
op_logical_or
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_R350
op_logical_or
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RV350
)paren
(brace
r_if
c_cond
(paren
id|mode-&gt;ppll_ref_div
op_amp
id|R300_PPLL_REF_DIV_ACC_MASK
)paren
(brace
multiline_comment|/* When restoring console mode, use saved PPLL_REF_DIV&n;&t;&t;&t; * setting.&n;&t;&t;&t; */
id|OUTPLLP
c_func
(paren
id|PPLL_REF_DIV
comma
id|mode-&gt;ppll_ref_div
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* R300 uses ref_div_acc field as real ref divider */
id|OUTPLLP
c_func
(paren
id|PPLL_REF_DIV
comma
(paren
id|mode-&gt;ppll_ref_div
op_lshift
id|R300_PPLL_REF_DIV_ACC_SHIFT
)paren
comma
op_complement
id|R300_PPLL_REF_DIV_ACC_MASK
)paren
suffix:semicolon
)brace
)brace
r_else
id|OUTPLLP
c_func
(paren
id|PPLL_REF_DIV
comma
id|mode-&gt;ppll_ref_div
comma
op_complement
id|PPLL_REF_DIV_MASK
)paren
suffix:semicolon
multiline_comment|/* Set PPLL divider 3 &amp; post divider*/
id|OUTPLLP
c_func
(paren
id|PPLL_DIV_3
comma
id|mode-&gt;ppll_div_3
comma
op_complement
id|PPLL_FB3_DIV_MASK
)paren
suffix:semicolon
id|OUTPLLP
c_func
(paren
id|PPLL_DIV_3
comma
id|mode-&gt;ppll_div_3
comma
op_complement
id|PPLL_POST3_DIV_MASK
)paren
suffix:semicolon
multiline_comment|/* Write update */
r_while
c_loop
(paren
id|INPLL
c_func
(paren
id|PPLL_REF_DIV
)paren
op_amp
id|PPLL_ATOMIC_UPDATE_R
)paren
suffix:semicolon
id|OUTPLLP
c_func
(paren
id|PPLL_REF_DIV
comma
id|PPLL_ATOMIC_UPDATE_W
comma
op_complement
id|PPLL_ATOMIC_UPDATE_W
)paren
suffix:semicolon
multiline_comment|/* Wait read update complete */
multiline_comment|/* FIXME: Certain revisions of R300 can&squot;t recover here.  Not sure of&n;&t;   the cause yet, but this workaround will mask the problem for now.&n;&t;   Other chips usually will pass at the very first test, so the&n;&t;   workaround shouldn&squot;t have any effect on them. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
l_int|10000
op_logical_and
id|INPLL
c_func
(paren
id|PPLL_REF_DIV
)paren
op_amp
id|PPLL_ATOMIC_UPDATE_R
)paren
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
id|OUTPLL
c_func
(paren
id|HTOTAL_CNTL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Clear reset &amp; atomic update */
id|OUTPLLP
c_func
(paren
id|PPLL_CNTL
comma
l_int|0
comma
op_complement
(paren
id|PPLL_RESET
op_or
id|PPLL_SLEEP
op_or
id|PPLL_ATOMIC_UPDATE_EN
op_or
id|PPLL_VGA_ATOMIC_UPDATE_EN
)paren
)paren
suffix:semicolon
multiline_comment|/* We may want some locking ... oh well */
id|msleep
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Switch back VCLK source to PPLL */
id|OUTPLLP
c_func
(paren
id|VCLK_ECP_CNTL
comma
id|VCLK_SRC_SEL_PPLLCLK
comma
op_complement
id|VCLK_SRC_SEL_MASK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Timer function for delayed LVDS panel power up/down&n; */
DECL|function|radeon_lvds_timer_func
r_static
r_void
id|radeon_lvds_timer_func
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|radeonfb_info
op_star
id|rinfo
op_assign
(paren
r_struct
id|radeonfb_info
op_star
)paren
id|data
suffix:semicolon
id|radeon_fifo_wait
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|LVDS_GEN_CNTL
comma
id|rinfo-&gt;pending_lvds_gen_cntl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;pending_pixclks_cntl
)paren
(brace
id|OUTPLL
c_func
(paren
id|PIXCLKS_CNTL
comma
id|rinfo-&gt;pending_pixclks_cntl
)paren
suffix:semicolon
id|rinfo-&gt;pending_pixclks_cntl
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Apply a video mode. This will apply the whole register set, including&n; * the PLL registers, to the card&n; */
DECL|function|radeon_write_mode
r_static
r_void
id|radeon_write_mode
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_struct
id|radeon_regs
op_star
id|mode
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|primary_mon
op_assign
id|PRIMARY_MONITOR
c_func
(paren
id|rinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nomodeset
)paren
r_return
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|rinfo-&gt;lvds_timer
)paren
suffix:semicolon
id|radeon_screen_blank
c_func
(paren
id|rinfo
comma
id|FB_BLANK_POWERDOWN
comma
l_int|1
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|radeon_fifo_wait
c_func
(paren
l_int|31
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
id|OUTREG
c_func
(paren
id|common_regs
(braket
id|i
)braket
dot
id|reg
comma
id|common_regs
(braket
id|i
)braket
dot
id|val
)paren
suffix:semicolon
multiline_comment|/* Apply surface registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|OUTREG
c_func
(paren
id|SURFACE0_LOWER_BOUND
op_plus
l_int|0x10
op_star
id|i
comma
id|mode-&gt;surf_lower_bound
(braket
id|i
)braket
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|SURFACE0_UPPER_BOUND
op_plus
l_int|0x10
op_star
id|i
comma
id|mode-&gt;surf_upper_bound
(braket
id|i
)braket
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|SURFACE0_INFO
op_plus
l_int|0x10
op_star
id|i
comma
id|mode-&gt;surf_info
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|OUTREG
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|mode-&gt;crtc_gen_cntl
)paren
suffix:semicolon
id|OUTREGP
c_func
(paren
id|CRTC_EXT_CNTL
comma
id|mode-&gt;crtc_ext_cntl
comma
op_complement
(paren
id|CRTC_HSYNC_DIS
op_or
id|CRTC_VSYNC_DIS
op_or
id|CRTC_DISPLAY_DIS
)paren
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_MORE_CNTL
comma
id|mode-&gt;crtc_more_cntl
)paren
suffix:semicolon
id|OUTREGP
c_func
(paren
id|DAC_CNTL
comma
id|mode-&gt;dac_cntl
comma
id|DAC_RANGE_CNTL
op_or
id|DAC_BLANKING
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_H_TOTAL_DISP
comma
id|mode-&gt;crtc_h_total_disp
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_H_SYNC_STRT_WID
comma
id|mode-&gt;crtc_h_sync_strt_wid
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_V_TOTAL_DISP
comma
id|mode-&gt;crtc_v_total_disp
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_V_SYNC_STRT_WID
comma
id|mode-&gt;crtc_v_sync_strt_wid
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_OFFSET
comma
l_int|0
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_OFFSET_CNTL
comma
l_int|0
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_PITCH
comma
id|mode-&gt;crtc_pitch
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|SURFACE_CNTL
comma
id|mode-&gt;surface_cntl
)paren
suffix:semicolon
id|radeon_write_pll_regs
c_func
(paren
id|rinfo
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|primary_mon
op_eq
id|MT_DFP
)paren
op_logical_or
(paren
id|primary_mon
op_eq
id|MT_LCD
)paren
)paren
(brace
id|radeon_fifo_wait
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|FP_CRTC_H_TOTAL_DISP
comma
id|mode-&gt;fp_crtc_h_total_disp
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|FP_CRTC_V_TOTAL_DISP
comma
id|mode-&gt;fp_crtc_v_total_disp
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|FP_H_SYNC_STRT_WID
comma
id|mode-&gt;fp_h_sync_strt_wid
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|FP_V_SYNC_STRT_WID
comma
id|mode-&gt;fp_v_sync_strt_wid
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|FP_HORZ_STRETCH
comma
id|mode-&gt;fp_horz_stretch
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|FP_VERT_STRETCH
comma
id|mode-&gt;fp_vert_stretch
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|FP_GEN_CNTL
comma
id|mode-&gt;fp_gen_cntl
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|TMDS_CRC
comma
id|mode-&gt;tmds_crc
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|TMDS_TRANSMITTER_CNTL
comma
id|mode-&gt;tmds_transmitter_cntl
)paren
suffix:semicolon
)brace
id|radeon_screen_blank
c_func
(paren
id|rinfo
comma
id|FB_BLANK_UNBLANK
comma
l_int|1
)paren
suffix:semicolon
id|radeon_fifo_wait
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|OUTPLL
c_func
(paren
id|VCLK_ECP_CNTL
comma
id|mode-&gt;vclk_ecp_cntl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Calculate the PLL values for a given mode&n; */
DECL|function|radeon_calc_pll_regs
r_static
r_void
id|radeon_calc_pll_regs
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
comma
r_struct
id|radeon_regs
op_star
id|regs
comma
r_int
r_int
id|freq
)paren
(brace
r_const
r_struct
(brace
r_int
id|divider
suffix:semicolon
r_int
id|bitvalue
suffix:semicolon
)brace
op_star
id|post_div
comma
id|post_divs
(braket
)braket
op_assign
(brace
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|2
comma
l_int|1
)brace
comma
(brace
l_int|4
comma
l_int|2
)brace
comma
(brace
l_int|8
comma
l_int|3
)brace
comma
(brace
l_int|3
comma
l_int|4
)brace
comma
(brace
l_int|16
comma
l_int|5
)brace
comma
(brace
l_int|6
comma
l_int|6
)brace
comma
(brace
l_int|12
comma
l_int|7
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
r_int
id|fb_div
comma
id|pll_output_freq
op_assign
l_int|0
suffix:semicolon
r_int
id|uses_dvo
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check if the DVO port is enabled and sourced from the primary CRTC. I&squot;m&n;&t; * not sure which model starts having FP2_GEN_CNTL, I assume anything more&n;&t; * recent than an r(v)100...&n;&t; */
macro_line|#if 1
multiline_comment|/* XXX I had reports of flicker happening with the cinema display&n;&t; * on TMDS1 that seem to be fixed if I also forbit odd dividers in&n;&t; * this case. This could just be a bandwidth calculation issue, I&n;&t; * haven&squot;t implemented the bandwidth code yet, but in the meantime,&n;&t; * forcing uses_dvo to 1 fixes it and shouln&squot;t have bad side effects,&n;&t; * I haven&squot;t seen a case were were absolutely needed an odd PLL&n;&t; * divider. I&squot;ll find a better fix once I have more infos on the&n;&t; * real cause of the problem.&n;&t; */
r_while
c_loop
(paren
id|rinfo-&gt;has_CRTC2
)paren
(brace
id|u32
id|fp2_gen_cntl
op_assign
id|INREG
c_func
(paren
id|FP2_GEN_CNTL
)paren
suffix:semicolon
id|u32
id|disp_output_cntl
suffix:semicolon
r_int
id|source
suffix:semicolon
multiline_comment|/* FP2 path not enabled */
r_if
c_cond
(paren
(paren
id|fp2_gen_cntl
op_amp
id|FP2_ON
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* Not all chip revs have the same format for this register,&n;&t;&t; * extract the source selection&n;&t;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_R200
op_logical_or
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_R300
op_logical_or
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_R350
op_logical_or
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RV350
)paren
(brace
id|source
op_assign
(paren
id|fp2_gen_cntl
op_rshift
l_int|10
)paren
op_amp
l_int|0x3
suffix:semicolon
multiline_comment|/* sourced from transform unit, check for transform unit&n;&t;&t;&t; * own source&n;&t;&t;&t; */
r_if
c_cond
(paren
id|source
op_eq
l_int|3
)paren
(brace
id|disp_output_cntl
op_assign
id|INREG
c_func
(paren
id|DISP_OUTPUT_CNTL
)paren
suffix:semicolon
id|source
op_assign
(paren
id|disp_output_cntl
op_rshift
l_int|12
)paren
op_amp
l_int|0x3
suffix:semicolon
)brace
)brace
r_else
id|source
op_assign
(paren
id|fp2_gen_cntl
op_rshift
l_int|13
)paren
op_amp
l_int|0x1
suffix:semicolon
multiline_comment|/* sourced from CRTC2 -&gt; exit */
r_if
c_cond
(paren
id|source
op_eq
l_int|1
)paren
r_break
suffix:semicolon
multiline_comment|/* so we end up on CRTC1, let&squot;s set uses_dvo to 1 now */
id|uses_dvo
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#else
id|uses_dvo
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|freq
OG
id|rinfo-&gt;pll.ppll_max
)paren
id|freq
op_assign
id|rinfo-&gt;pll.ppll_max
suffix:semicolon
r_if
c_cond
(paren
id|freq
op_star
l_int|12
OL
id|rinfo-&gt;pll.ppll_min
)paren
id|freq
op_assign
id|rinfo-&gt;pll.ppll_min
op_div
l_int|12
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;freq = %lu, PLL min = %u, PLL max = %u&bslash;n&quot;
comma
id|freq
comma
id|rinfo-&gt;pll.ppll_min
comma
id|rinfo-&gt;pll.ppll_max
)paren
suffix:semicolon
r_for
c_loop
(paren
id|post_div
op_assign
op_amp
id|post_divs
(braket
l_int|0
)braket
suffix:semicolon
id|post_div-&gt;divider
suffix:semicolon
op_increment
id|post_div
)paren
(brace
id|pll_output_freq
op_assign
id|post_div-&gt;divider
op_star
id|freq
suffix:semicolon
multiline_comment|/* If we output to the DVO port (external TMDS), we don&squot;t allow an&n;&t;&t; * odd PLL divider as those aren&squot;t supported on this path&n;&t;&t; */
r_if
c_cond
(paren
id|uses_dvo
op_logical_and
(paren
id|post_div-&gt;divider
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pll_output_freq
op_ge
id|rinfo-&gt;pll.ppll_min
op_logical_and
id|pll_output_freq
op_le
id|rinfo-&gt;pll.ppll_max
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* If we fall through the bottom, try the &quot;default value&quot;&n;&t;   given by the terminal post_div-&gt;bitvalue */
r_if
c_cond
(paren
op_logical_neg
id|post_div-&gt;divider
)paren
(brace
id|post_div
op_assign
op_amp
id|post_divs
(braket
id|post_div-&gt;bitvalue
)braket
suffix:semicolon
id|pll_output_freq
op_assign
id|post_div-&gt;divider
op_star
id|freq
suffix:semicolon
)brace
id|RTRACE
c_func
(paren
l_string|&quot;ref_div = %d, ref_clk = %d, output_freq = %d&bslash;n&quot;
comma
id|rinfo-&gt;pll.ref_div
comma
id|rinfo-&gt;pll.ref_clk
comma
id|pll_output_freq
)paren
suffix:semicolon
id|fb_div
op_assign
id|round_div
c_func
(paren
id|rinfo-&gt;pll.ref_div
op_star
id|pll_output_freq
comma
id|rinfo-&gt;pll.ref_clk
)paren
suffix:semicolon
id|regs-&gt;ppll_ref_div
op_assign
id|rinfo-&gt;pll.ref_div
suffix:semicolon
id|regs-&gt;ppll_div_3
op_assign
id|fb_div
op_or
(paren
id|post_div-&gt;bitvalue
op_lshift
l_int|16
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;post div = 0x%x&bslash;n&quot;
comma
id|post_div-&gt;bitvalue
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;fb_div = 0x%x&bslash;n&quot;
comma
id|fb_div
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;ppll_div_3 = 0x%x&bslash;n&quot;
comma
id|regs-&gt;ppll_div_3
)paren
suffix:semicolon
)brace
DECL|function|radeonfb_set_par
r_int
id|radeonfb_set_par
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|radeonfb_info
op_star
id|rinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|mode
op_assign
op_amp
id|info-&gt;var
suffix:semicolon
r_struct
id|radeon_regs
id|newmode
suffix:semicolon
r_int
id|hTotal
comma
id|vTotal
comma
id|hSyncStart
comma
id|hSyncEnd
comma
id|hSyncPol
comma
id|vSyncStart
comma
id|vSyncEnd
comma
id|vSyncPol
comma
id|cSync
suffix:semicolon
id|u8
id|hsync_adj_tab
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0x12
comma
l_int|9
comma
l_int|9
comma
l_int|6
comma
l_int|5
)brace
suffix:semicolon
id|u8
id|hsync_fudge_fp
(braket
)braket
op_assign
(brace
l_int|2
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|5
comma
l_int|5
)brace
suffix:semicolon
id|u32
id|sync
comma
id|h_sync_pol
comma
id|v_sync_pol
comma
id|dotClock
comma
id|pixClock
suffix:semicolon
r_int
id|i
comma
id|freq
suffix:semicolon
r_int
id|format
op_assign
l_int|0
suffix:semicolon
r_int
id|nopllcalc
op_assign
l_int|0
suffix:semicolon
r_int
id|hsync_start
comma
id|hsync_fudge
comma
id|bytpp
comma
id|hsync_wid
comma
id|vsync_wid
suffix:semicolon
r_int
id|primary_mon
op_assign
id|PRIMARY_MONITOR
c_func
(paren
id|rinfo
)paren
suffix:semicolon
r_int
id|depth
op_assign
id|var_to_depth
c_func
(paren
id|mode
)paren
suffix:semicolon
multiline_comment|/* We always want engine to be idle on a mode switch, even&n;&t; * if we won&squot;t actually change the mode&n;&t; */
id|radeon_engine_idle
c_func
(paren
)paren
suffix:semicolon
id|hSyncStart
op_assign
id|mode-&gt;xres
op_plus
id|mode-&gt;right_margin
suffix:semicolon
id|hSyncEnd
op_assign
id|hSyncStart
op_plus
id|mode-&gt;hsync_len
suffix:semicolon
id|hTotal
op_assign
id|hSyncEnd
op_plus
id|mode-&gt;left_margin
suffix:semicolon
id|vSyncStart
op_assign
id|mode-&gt;yres
op_plus
id|mode-&gt;lower_margin
suffix:semicolon
id|vSyncEnd
op_assign
id|vSyncStart
op_plus
id|mode-&gt;vsync_len
suffix:semicolon
id|vTotal
op_assign
id|vSyncEnd
op_plus
id|mode-&gt;upper_margin
suffix:semicolon
id|pixClock
op_assign
id|mode-&gt;pixclock
suffix:semicolon
id|sync
op_assign
id|mode-&gt;sync
suffix:semicolon
id|h_sync_pol
op_assign
id|sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|v_sync_pol
op_assign
id|sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|primary_mon
op_eq
id|MT_DFP
op_logical_or
id|primary_mon
op_eq
id|MT_LCD
)paren
(brace
r_if
c_cond
(paren
id|rinfo-&gt;panel_info.xres
OL
id|mode-&gt;xres
)paren
id|mode-&gt;xres
op_assign
id|rinfo-&gt;panel_info.xres
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;panel_info.yres
OL
id|mode-&gt;yres
)paren
id|mode-&gt;yres
op_assign
id|rinfo-&gt;panel_info.yres
suffix:semicolon
id|hTotal
op_assign
id|mode-&gt;xres
op_plus
id|rinfo-&gt;panel_info.hblank
suffix:semicolon
id|hSyncStart
op_assign
id|mode-&gt;xres
op_plus
id|rinfo-&gt;panel_info.hOver_plus
suffix:semicolon
id|hSyncEnd
op_assign
id|hSyncStart
op_plus
id|rinfo-&gt;panel_info.hSync_width
suffix:semicolon
id|vTotal
op_assign
id|mode-&gt;yres
op_plus
id|rinfo-&gt;panel_info.vblank
suffix:semicolon
id|vSyncStart
op_assign
id|mode-&gt;yres
op_plus
id|rinfo-&gt;panel_info.vOver_plus
suffix:semicolon
id|vSyncEnd
op_assign
id|vSyncStart
op_plus
id|rinfo-&gt;panel_info.vSync_width
suffix:semicolon
id|h_sync_pol
op_assign
op_logical_neg
id|rinfo-&gt;panel_info.hAct_high
suffix:semicolon
id|v_sync_pol
op_assign
op_logical_neg
id|rinfo-&gt;panel_info.vAct_high
suffix:semicolon
id|pixClock
op_assign
l_int|100000000
op_div
id|rinfo-&gt;panel_info.clock
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;panel_info.use_bios_dividers
)paren
(brace
id|nopllcalc
op_assign
l_int|1
suffix:semicolon
id|newmode.ppll_div_3
op_assign
id|rinfo-&gt;panel_info.fbk_divider
op_or
(paren
id|rinfo-&gt;panel_info.post_divider
op_lshift
l_int|16
)paren
suffix:semicolon
id|newmode.ppll_ref_div
op_assign
id|rinfo-&gt;panel_info.ref_divider
suffix:semicolon
)brace
)brace
id|dotClock
op_assign
l_int|1000000000
op_div
id|pixClock
suffix:semicolon
id|freq
op_assign
id|dotClock
op_div
l_int|10
suffix:semicolon
multiline_comment|/* x100 */
id|RTRACE
c_func
(paren
l_string|&quot;hStart = %d, hEnd = %d, hTotal = %d&bslash;n&quot;
comma
id|hSyncStart
comma
id|hSyncEnd
comma
id|hTotal
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;vStart = %d, vEnd = %d, vTotal = %d&bslash;n&quot;
comma
id|vSyncStart
comma
id|vSyncEnd
comma
id|vTotal
)paren
suffix:semicolon
id|hsync_wid
op_assign
(paren
id|hSyncEnd
op_minus
id|hSyncStart
)paren
op_div
l_int|8
suffix:semicolon
id|vsync_wid
op_assign
id|vSyncEnd
op_minus
id|vSyncStart
suffix:semicolon
r_if
c_cond
(paren
id|hsync_wid
op_eq
l_int|0
)paren
id|hsync_wid
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hsync_wid
OG
l_int|0x3f
)paren
multiline_comment|/* max */
id|hsync_wid
op_assign
l_int|0x3f
suffix:semicolon
r_if
c_cond
(paren
id|vsync_wid
op_eq
l_int|0
)paren
id|vsync_wid
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|vsync_wid
OG
l_int|0x1f
)paren
multiline_comment|/* max */
id|vsync_wid
op_assign
l_int|0x1f
suffix:semicolon
id|hSyncPol
op_assign
id|mode-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|vSyncPol
op_assign
id|mode-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|cSync
op_assign
id|mode-&gt;sync
op_amp
id|FB_SYNC_COMP_HIGH_ACT
ques
c_cond
(paren
l_int|1
op_lshift
l_int|4
)paren
suffix:colon
l_int|0
suffix:semicolon
id|format
op_assign
id|radeon_get_dstbpp
c_func
(paren
id|depth
)paren
suffix:semicolon
id|bytpp
op_assign
id|mode-&gt;bits_per_pixel
op_rshift
l_int|3
suffix:semicolon
r_if
c_cond
(paren
(paren
id|primary_mon
op_eq
id|MT_DFP
)paren
op_logical_or
(paren
id|primary_mon
op_eq
id|MT_LCD
)paren
)paren
id|hsync_fudge
op_assign
id|hsync_fudge_fp
(braket
id|format
op_minus
l_int|1
)braket
suffix:semicolon
r_else
id|hsync_fudge
op_assign
id|hsync_adj_tab
(braket
id|format
op_minus
l_int|1
)braket
suffix:semicolon
id|hsync_start
op_assign
id|hSyncStart
op_minus
l_int|8
op_plus
id|hsync_fudge
suffix:semicolon
id|newmode.crtc_gen_cntl
op_assign
id|CRTC_EXT_DISP_EN
op_or
id|CRTC_EN
op_or
(paren
id|format
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Clear auto-center etc... */
id|newmode.crtc_more_cntl
op_assign
id|rinfo-&gt;init_state.crtc_more_cntl
suffix:semicolon
id|newmode.crtc_more_cntl
op_and_assign
l_int|0xfffffff0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|primary_mon
op_eq
id|MT_DFP
)paren
op_logical_or
(paren
id|primary_mon
op_eq
id|MT_LCD
)paren
)paren
(brace
id|newmode.crtc_ext_cntl
op_assign
id|VGA_ATI_LINEAR
op_or
id|XCRT_CNT_EN
suffix:semicolon
r_if
c_cond
(paren
id|mirror
)paren
id|newmode.crtc_ext_cntl
op_or_assign
id|CRTC_CRT_ON
suffix:semicolon
id|newmode.crtc_gen_cntl
op_and_assign
op_complement
(paren
id|CRTC_DBL_SCAN_EN
op_or
id|CRTC_INTERLACE_EN
)paren
suffix:semicolon
)brace
r_else
(brace
id|newmode.crtc_ext_cntl
op_assign
id|VGA_ATI_LINEAR
op_or
id|XCRT_CNT_EN
op_or
id|CRTC_CRT_ON
suffix:semicolon
)brace
id|newmode.dac_cntl
op_assign
multiline_comment|/* INREG(DAC_CNTL) | */
id|DAC_MASK_ALL
op_or
id|DAC_VGA_ADR_EN
op_or
id|DAC_8BIT_EN
suffix:semicolon
id|newmode.crtc_h_total_disp
op_assign
(paren
(paren
(paren
(paren
id|hTotal
op_div
l_int|8
)paren
op_minus
l_int|1
)paren
op_amp
l_int|0x3ff
)paren
op_or
(paren
(paren
(paren
id|mode-&gt;xres
op_div
l_int|8
)paren
op_minus
l_int|1
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|newmode.crtc_h_sync_strt_wid
op_assign
(paren
(paren
id|hsync_start
op_amp
l_int|0x1fff
)paren
op_or
(paren
id|hsync_wid
op_lshift
l_int|16
)paren
op_or
(paren
id|h_sync_pol
op_lshift
l_int|23
)paren
)paren
suffix:semicolon
id|newmode.crtc_v_total_disp
op_assign
(paren
(paren
id|vTotal
op_minus
l_int|1
)paren
op_amp
l_int|0xffff
)paren
op_or
(paren
(paren
id|mode-&gt;yres
op_minus
l_int|1
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|newmode.crtc_v_sync_strt_wid
op_assign
(paren
(paren
(paren
id|vSyncStart
op_minus
l_int|1
)paren
op_amp
l_int|0xfff
)paren
op_or
(paren
id|vsync_wid
op_lshift
l_int|16
)paren
op_or
(paren
id|v_sync_pol
op_lshift
l_int|23
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|FBINFO_HWACCEL_DISABLED
)paren
)paren
(brace
multiline_comment|/* We first calculate the engine pitch */
id|rinfo-&gt;pitch
op_assign
(paren
(paren
id|mode-&gt;xres_virtual
op_star
(paren
(paren
id|mode-&gt;bits_per_pixel
op_plus
l_int|1
)paren
op_div
l_int|8
)paren
op_plus
l_int|0x3f
)paren
op_amp
op_complement
(paren
l_int|0x3f
)paren
)paren
op_rshift
l_int|6
suffix:semicolon
multiline_comment|/* Then, re-multiply it to get the CRTC pitch */
id|newmode.crtc_pitch
op_assign
(paren
id|rinfo-&gt;pitch
op_lshift
l_int|3
)paren
op_div
(paren
(paren
id|mode-&gt;bits_per_pixel
op_plus
l_int|1
)paren
op_div
l_int|8
)paren
suffix:semicolon
)brace
r_else
id|newmode.crtc_pitch
op_assign
(paren
id|mode-&gt;xres_virtual
op_rshift
l_int|3
)paren
suffix:semicolon
id|newmode.crtc_pitch
op_or_assign
(paren
id|newmode.crtc_pitch
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * It looks like recent chips have a problem with SURFACE_CNTL,&n;&t; * setting SURF_TRANSLATION_DIS completely disables the&n;&t; * swapper as well, so we leave it unset now.&n;&t; */
id|newmode.surface_cntl
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(__BIG_ENDIAN)
multiline_comment|/* Setup swapping on both apertures, though we currently&n;&t; * only use aperture 0, enabling swapper on aperture 1&n;&t; * won&squot;t harm&n;&t; */
r_switch
c_cond
(paren
id|mode-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|16
suffix:colon
id|newmode.surface_cntl
op_or_assign
id|NONSURF_AP0_SWP_16BPP
suffix:semicolon
id|newmode.surface_cntl
op_or_assign
id|NONSURF_AP1_SWP_16BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|newmode.surface_cntl
op_or_assign
id|NONSURF_AP0_SWP_32BPP
suffix:semicolon
id|newmode.surface_cntl
op_or_assign
id|NONSURF_AP1_SWP_32BPP
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Clear surface registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|newmode.surf_lower_bound
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|newmode.surf_upper_bound
(braket
id|i
)braket
op_assign
l_int|0x1f
suffix:semicolon
id|newmode.surf_info
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|RTRACE
c_func
(paren
l_string|&quot;h_total_disp = 0x%x&bslash;t   hsync_strt_wid = 0x%x&bslash;n&quot;
comma
id|newmode.crtc_h_total_disp
comma
id|newmode.crtc_h_sync_strt_wid
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;v_total_disp = 0x%x&bslash;t   vsync_strt_wid = 0x%x&bslash;n&quot;
comma
id|newmode.crtc_v_total_disp
comma
id|newmode.crtc_v_sync_strt_wid
)paren
suffix:semicolon
id|rinfo-&gt;bpp
op_assign
id|mode-&gt;bits_per_pixel
suffix:semicolon
id|rinfo-&gt;depth
op_assign
id|depth
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;pixclock = %lu&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|pixClock
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;freq = %lu&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|freq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nopllcalc
)paren
id|radeon_calc_pll_regs
c_func
(paren
id|rinfo
comma
op_amp
id|newmode
comma
id|freq
)paren
suffix:semicolon
id|newmode.vclk_ecp_cntl
op_assign
id|rinfo-&gt;init_state.vclk_ecp_cntl
suffix:semicolon
r_if
c_cond
(paren
(paren
id|primary_mon
op_eq
id|MT_DFP
)paren
op_logical_or
(paren
id|primary_mon
op_eq
id|MT_LCD
)paren
)paren
(brace
r_int
r_int
id|hRatio
comma
id|vRatio
suffix:semicolon
r_if
c_cond
(paren
id|mode-&gt;xres
OG
id|rinfo-&gt;panel_info.xres
)paren
id|mode-&gt;xres
op_assign
id|rinfo-&gt;panel_info.xres
suffix:semicolon
r_if
c_cond
(paren
id|mode-&gt;yres
OG
id|rinfo-&gt;panel_info.yres
)paren
id|mode-&gt;yres
op_assign
id|rinfo-&gt;panel_info.yres
suffix:semicolon
id|newmode.fp_horz_stretch
op_assign
(paren
(paren
(paren
id|rinfo-&gt;panel_info.xres
op_div
l_int|8
)paren
op_minus
l_int|1
)paren
op_lshift
id|HORZ_PANEL_SHIFT
)paren
suffix:semicolon
id|newmode.fp_vert_stretch
op_assign
(paren
(paren
id|rinfo-&gt;panel_info.yres
op_minus
l_int|1
)paren
op_lshift
id|VERT_PANEL_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode-&gt;xres
op_ne
id|rinfo-&gt;panel_info.xres
)paren
(brace
id|hRatio
op_assign
id|round_div
c_func
(paren
id|mode-&gt;xres
op_star
id|HORZ_STRETCH_RATIO_MAX
comma
id|rinfo-&gt;panel_info.xres
)paren
suffix:semicolon
id|newmode.fp_horz_stretch
op_assign
(paren
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|hRatio
)paren
op_amp
id|HORZ_STRETCH_RATIO_MASK
)paren
)paren
op_or
(paren
id|newmode.fp_horz_stretch
op_amp
(paren
id|HORZ_PANEL_SIZE
op_or
id|HORZ_FP_LOOP_STRETCH
op_or
id|HORZ_AUTO_RATIO_INC
)paren
)paren
)paren
suffix:semicolon
id|newmode.fp_horz_stretch
op_or_assign
(paren
id|HORZ_STRETCH_BLEND
op_or
id|HORZ_STRETCH_ENABLE
)paren
suffix:semicolon
)brace
id|newmode.fp_horz_stretch
op_and_assign
op_complement
id|HORZ_AUTO_RATIO
suffix:semicolon
r_if
c_cond
(paren
id|mode-&gt;yres
op_ne
id|rinfo-&gt;panel_info.yres
)paren
(brace
id|vRatio
op_assign
id|round_div
c_func
(paren
id|mode-&gt;yres
op_star
id|VERT_STRETCH_RATIO_MAX
comma
id|rinfo-&gt;panel_info.yres
)paren
suffix:semicolon
id|newmode.fp_vert_stretch
op_assign
(paren
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|vRatio
)paren
op_amp
id|VERT_STRETCH_RATIO_MASK
)paren
)paren
op_or
(paren
id|newmode.fp_vert_stretch
op_amp
(paren
id|VERT_PANEL_SIZE
op_or
id|VERT_STRETCH_RESERVED
)paren
)paren
)paren
suffix:semicolon
id|newmode.fp_vert_stretch
op_or_assign
(paren
id|VERT_STRETCH_BLEND
op_or
id|VERT_STRETCH_ENABLE
)paren
suffix:semicolon
)brace
id|newmode.fp_vert_stretch
op_and_assign
op_complement
id|VERT_AUTO_RATIO_EN
suffix:semicolon
id|newmode.fp_gen_cntl
op_assign
(paren
id|rinfo-&gt;init_state.fp_gen_cntl
op_amp
(paren
id|u32
)paren
op_complement
(paren
id|FP_SEL_CRTC2
op_or
id|FP_RMX_HVSYNC_CONTROL_EN
op_or
id|FP_DFP_SYNC_SEL
op_or
id|FP_CRT_SYNC_SEL
op_or
id|FP_CRTC_LOCK_8DOT
op_or
id|FP_USE_SHADOW_EN
op_or
id|FP_CRTC_USE_SHADOW_VEND
op_or
id|FP_CRT_SYNC_ALT
)paren
)paren
suffix:semicolon
id|newmode.fp_gen_cntl
op_or_assign
(paren
id|FP_CRTC_DONT_SHADOW_VPAR
op_or
id|FP_CRTC_DONT_SHADOW_HEND
)paren
suffix:semicolon
id|newmode.lvds_gen_cntl
op_assign
id|rinfo-&gt;init_state.lvds_gen_cntl
suffix:semicolon
id|newmode.lvds_pll_cntl
op_assign
id|rinfo-&gt;init_state.lvds_pll_cntl
suffix:semicolon
id|newmode.tmds_crc
op_assign
id|rinfo-&gt;init_state.tmds_crc
suffix:semicolon
id|newmode.tmds_transmitter_cntl
op_assign
id|rinfo-&gt;init_state.tmds_transmitter_cntl
suffix:semicolon
r_if
c_cond
(paren
id|primary_mon
op_eq
id|MT_LCD
)paren
(brace
id|newmode.lvds_gen_cntl
op_or_assign
(paren
id|LVDS_ON
op_or
id|LVDS_BLON
)paren
suffix:semicolon
id|newmode.fp_gen_cntl
op_and_assign
op_complement
(paren
id|FP_FPON
op_or
id|FP_TMDS_EN
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DFP */
id|newmode.fp_gen_cntl
op_or_assign
(paren
id|FP_FPON
op_or
id|FP_TMDS_EN
)paren
suffix:semicolon
id|newmode.tmds_transmitter_cntl
op_assign
(paren
id|TMDS_RAN_PAT_RST
op_or
id|TMDS_ICHCSEL
)paren
op_amp
op_complement
(paren
id|TMDS_PLLRST
)paren
suffix:semicolon
multiline_comment|/* TMDS_PLL_EN bit is reversed on RV (and mobility) chips */
r_if
c_cond
(paren
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_R300
)paren
op_logical_or
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_R350
)paren
op_logical_or
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RV350
)paren
op_logical_or
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_R200
)paren
op_logical_or
op_logical_neg
id|rinfo-&gt;has_CRTC2
)paren
id|newmode.tmds_transmitter_cntl
op_and_assign
op_complement
id|TMDS_PLL_EN
suffix:semicolon
r_else
id|newmode.tmds_transmitter_cntl
op_or_assign
id|TMDS_PLL_EN
suffix:semicolon
id|newmode.crtc_ext_cntl
op_and_assign
op_complement
id|CRTC_CRT_ON
suffix:semicolon
)brace
id|newmode.fp_crtc_h_total_disp
op_assign
(paren
(paren
(paren
id|rinfo-&gt;panel_info.hblank
op_div
l_int|8
)paren
op_amp
l_int|0x3ff
)paren
op_or
(paren
(paren
(paren
id|mode-&gt;xres
op_div
l_int|8
)paren
op_minus
l_int|1
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|newmode.fp_crtc_v_total_disp
op_assign
(paren
id|rinfo-&gt;panel_info.vblank
op_amp
l_int|0xffff
)paren
op_or
(paren
(paren
id|mode-&gt;yres
op_minus
l_int|1
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|newmode.fp_h_sync_strt_wid
op_assign
(paren
(paren
id|rinfo-&gt;panel_info.hOver_plus
op_amp
l_int|0x1fff
)paren
op_or
(paren
id|hsync_wid
op_lshift
l_int|16
)paren
op_or
(paren
id|h_sync_pol
op_lshift
l_int|23
)paren
)paren
suffix:semicolon
id|newmode.fp_v_sync_strt_wid
op_assign
(paren
(paren
id|rinfo-&gt;panel_info.vOver_plus
op_amp
l_int|0xfff
)paren
op_or
(paren
id|vsync_wid
op_lshift
l_int|16
)paren
op_or
(paren
id|v_sync_pol
op_lshift
l_int|23
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* do it! */
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;asleep
)paren
(brace
id|radeon_write_mode
(paren
id|rinfo
comma
op_amp
id|newmode
)paren
suffix:semicolon
multiline_comment|/* (re)initialize the engine */
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|FBINFO_HWACCEL_DISABLED
)paren
)paren
id|radeonfb_engine_init
(paren
id|rinfo
)paren
suffix:semicolon
)brace
multiline_comment|/* Update fix */
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|FBINFO_HWACCEL_DISABLED
)paren
)paren
id|info-&gt;fix.line_length
op_assign
id|rinfo-&gt;pitch
op_star
l_int|64
suffix:semicolon
r_else
id|info-&gt;fix.line_length
op_assign
id|mode-&gt;xres_virtual
op_star
(paren
(paren
id|mode-&gt;bits_per_pixel
op_plus
l_int|1
)paren
op_div
l_int|8
)paren
suffix:semicolon
id|info-&gt;fix.visual
op_assign
id|rinfo-&gt;depth
op_eq
l_int|8
ques
c_cond
id|FB_VISUAL_PSEUDOCOLOR
suffix:colon
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
macro_line|#ifdef CONFIG_BOOTX_TEXT
multiline_comment|/* Update debug text engine */
id|btext_update_display
c_func
(paren
id|rinfo-&gt;fb_base_phys
comma
id|mode-&gt;xres
comma
id|mode-&gt;yres
comma
id|rinfo-&gt;depth
comma
id|info-&gt;fix.line_length
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|radeonfb_ops
r_static
r_struct
id|fb_ops
id|radeonfb_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|fb_check_var
op_assign
id|radeonfb_check_var
comma
dot
id|fb_set_par
op_assign
id|radeonfb_set_par
comma
dot
id|fb_setcolreg
op_assign
id|radeonfb_setcolreg
comma
dot
id|fb_pan_display
op_assign
id|radeonfb_pan_display
comma
dot
id|fb_blank
op_assign
id|radeonfb_blank
comma
dot
id|fb_ioctl
op_assign
id|radeonfb_ioctl
comma
dot
id|fb_sync
op_assign
id|radeonfb_sync
comma
dot
id|fb_fillrect
op_assign
id|radeonfb_fillrect
comma
dot
id|fb_copyarea
op_assign
id|radeonfb_copyarea
comma
dot
id|fb_imageblit
op_assign
id|radeonfb_imageblit
comma
dot
id|fb_cursor
op_assign
id|soft_cursor
comma
)brace
suffix:semicolon
DECL|function|radeon_set_fbinfo
r_static
r_int
id|__devinit
id|radeon_set_fbinfo
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|rinfo-&gt;info
suffix:semicolon
id|info-&gt;par
op_assign
id|rinfo
suffix:semicolon
id|info-&gt;pseudo_palette
op_assign
id|rinfo-&gt;pseudo_palette
suffix:semicolon
id|info-&gt;flags
op_assign
id|FBINFO_DEFAULT
op_or
id|FBINFO_HWACCEL_COPYAREA
op_or
id|FBINFO_HWACCEL_FILLRECT
op_or
id|FBINFO_HWACCEL_XPAN
op_or
id|FBINFO_HWACCEL_YPAN
suffix:semicolon
id|info-&gt;fbops
op_assign
op_amp
id|radeonfb_ops
suffix:semicolon
id|info-&gt;screen_base
op_assign
id|rinfo-&gt;fb_base
suffix:semicolon
id|info-&gt;screen_size
op_assign
id|rinfo-&gt;mapped_vram
suffix:semicolon
multiline_comment|/* Fill fix common fields */
id|strlcpy
c_func
(paren
id|info-&gt;fix.id
comma
id|rinfo-&gt;name
comma
r_sizeof
(paren
id|info-&gt;fix.id
)paren
)paren
suffix:semicolon
id|info-&gt;fix.smem_start
op_assign
id|rinfo-&gt;fb_base_phys
suffix:semicolon
id|info-&gt;fix.smem_len
op_assign
id|rinfo-&gt;video_ram
suffix:semicolon
id|info-&gt;fix.type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|info-&gt;fix.visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|info-&gt;fix.xpanstep
op_assign
l_int|8
suffix:semicolon
id|info-&gt;fix.ypanstep
op_assign
l_int|1
suffix:semicolon
id|info-&gt;fix.ywrapstep
op_assign
l_int|0
suffix:semicolon
id|info-&gt;fix.type_aux
op_assign
l_int|0
suffix:semicolon
id|info-&gt;fix.mmio_start
op_assign
id|rinfo-&gt;mmio_base_phys
suffix:semicolon
id|info-&gt;fix.mmio_len
op_assign
id|RADEON_REGSIZE
suffix:semicolon
id|info-&gt;fix.accel
op_assign
id|FB_ACCEL_ATI_RADEON
suffix:semicolon
id|fb_alloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
comma
l_int|256
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|noaccel
)paren
id|info-&gt;flags
op_or_assign
id|FBINFO_HWACCEL_DISABLED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
multiline_comment|/* TODO: Dbl check these tables, we don&squot;t go up to full ON backlight&n; * in these, possibly because we noticed MacOS doesn&squot;t, but I&squot;d prefer&n; * having some more official numbers from ATI&n; */
DECL|variable|backlight_conv_m6
r_static
r_int
id|backlight_conv_m6
(braket
)braket
op_assign
(brace
l_int|0xff
comma
l_int|0xc0
comma
l_int|0xb5
comma
l_int|0xaa
comma
l_int|0x9f
comma
l_int|0x94
comma
l_int|0x89
comma
l_int|0x7e
comma
l_int|0x73
comma
l_int|0x68
comma
l_int|0x5d
comma
l_int|0x52
comma
l_int|0x47
comma
l_int|0x3c
comma
l_int|0x31
comma
l_int|0x24
)brace
suffix:semicolon
DECL|variable|backlight_conv_m7
r_static
r_int
id|backlight_conv_m7
(braket
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x3f
comma
l_int|0x4a
comma
l_int|0x55
comma
l_int|0x60
comma
l_int|0x6b
comma
l_int|0x76
comma
l_int|0x81
comma
l_int|0x8c
comma
l_int|0x97
comma
l_int|0xa2
comma
l_int|0xad
comma
l_int|0xb8
comma
l_int|0xc3
comma
l_int|0xce
comma
l_int|0xd9
)brace
suffix:semicolon
DECL|macro|BACKLIGHT_LVDS_OFF
mdefine_line|#define BACKLIGHT_LVDS_OFF
DECL|macro|BACKLIGHT_DAC_OFF
macro_line|#undef BACKLIGHT_DAC_OFF
multiline_comment|/* We turn off the LCD completely instead of just dimming the backlight.&n; * This provides some greater power saving and the display is useless&n; * without backlight anyway.&n; */
DECL|function|radeon_set_backlight_enable
r_static
r_int
id|radeon_set_backlight_enable
c_func
(paren
r_int
id|on
comma
r_int
id|level
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|radeonfb_info
op_star
id|rinfo
op_assign
(paren
r_struct
id|radeonfb_info
op_star
)paren
id|data
suffix:semicolon
id|u32
id|lvds_gen_cntl
comma
id|tmpPixclksCntl
suffix:semicolon
r_int
op_star
id|conv_table
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_ne
id|MT_LCD
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Pardon me for that hack... maybe some day we can figure&n;&t; * out in what direction backlight should work on a given&n;&t; * panel ?&n;&t; */
r_if
c_cond
(paren
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RV200
op_logical_or
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RV250
op_logical_or
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RV280
op_logical_or
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RV350
)paren
op_logical_and
op_logical_neg
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerBook4,3&quot;
)paren
op_logical_and
op_logical_neg
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerBook6,3&quot;
)paren
op_logical_and
op_logical_neg
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerBook6,5&quot;
)paren
)paren
id|conv_table
op_assign
id|backlight_conv_m7
suffix:semicolon
r_else
id|conv_table
op_assign
id|backlight_conv_m6
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|rinfo-&gt;lvds_timer
)paren
suffix:semicolon
id|radeon_engine_idle
c_func
(paren
)paren
suffix:semicolon
id|lvds_gen_cntl
op_assign
id|INREG
c_func
(paren
id|LVDS_GEN_CNTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|on
op_logical_and
(paren
id|level
OG
id|BACKLIGHT_OFF
)paren
)paren
(brace
id|lvds_gen_cntl
op_and_assign
op_complement
id|LVDS_DISPLAY_DIS
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lvds_gen_cntl
op_amp
id|LVDS_BLON
)paren
op_logical_or
op_logical_neg
(paren
id|lvds_gen_cntl
op_amp
id|LVDS_ON
)paren
)paren
(brace
id|lvds_gen_cntl
op_or_assign
id|LVDS_BLON
multiline_comment|/* | LVDS_EN | LVDS_DIGON */
suffix:semicolon
id|OUTREG
c_func
(paren
id|LVDS_GEN_CNTL
comma
id|lvds_gen_cntl
)paren
suffix:semicolon
id|lvds_gen_cntl
op_and_assign
op_complement
id|LVDS_BL_MOD_LEVEL_MASK
suffix:semicolon
id|lvds_gen_cntl
op_or_assign
(paren
id|conv_table
(braket
id|level
)braket
op_lshift
id|LVDS_BL_MOD_LEVEL_SHIFT
)paren
suffix:semicolon
id|lvds_gen_cntl
op_or_assign
id|LVDS_ON
suffix:semicolon
id|rinfo-&gt;pending_lvds_gen_cntl
op_assign
id|lvds_gen_cntl
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|rinfo-&gt;lvds_timer
comma
id|jiffies
op_plus
id|msecs_to_jiffies
c_func
(paren
id|rinfo-&gt;panel_info.pwr_delay
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|lvds_gen_cntl
op_and_assign
op_complement
id|LVDS_BL_MOD_LEVEL_MASK
suffix:semicolon
id|lvds_gen_cntl
op_or_assign
(paren
id|conv_table
(braket
id|level
)braket
op_lshift
id|LVDS_BL_MOD_LEVEL_SHIFT
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|LVDS_GEN_CNTL
comma
id|lvds_gen_cntl
)paren
suffix:semicolon
)brace
id|rinfo-&gt;init_state.lvds_gen_cntl
op_and_assign
op_complement
id|LVDS_STATE_MASK
suffix:semicolon
id|rinfo-&gt;init_state.lvds_gen_cntl
op_or_assign
id|rinfo-&gt;pending_lvds_gen_cntl
op_amp
id|LVDS_STATE_MASK
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Asic bug, when turning off LVDS_ON, we have to make sure&n;&t;&t;   RADEON_PIXCLK_LVDS_ALWAYS_ON bit is off&n;&t;&t;*/
id|tmpPixclksCntl
op_assign
id|INPLL
c_func
(paren
id|PIXCLKS_CNTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;is_mobility
op_logical_or
id|rinfo-&gt;is_IGP
)paren
id|OUTPLLP
c_func
(paren
id|PIXCLKS_CNTL
comma
l_int|0
comma
op_complement
id|PIXCLK_LVDS_ALWAYS_ONb
)paren
suffix:semicolon
id|lvds_gen_cntl
op_and_assign
op_complement
id|LVDS_BL_MOD_LEVEL_MASK
suffix:semicolon
id|lvds_gen_cntl
op_or_assign
(paren
id|conv_table
(braket
l_int|0
)braket
op_lshift
id|LVDS_BL_MOD_LEVEL_SHIFT
)paren
suffix:semicolon
id|lvds_gen_cntl
op_or_assign
id|LVDS_DISPLAY_DIS
suffix:semicolon
id|OUTREG
c_func
(paren
id|LVDS_GEN_CNTL
comma
id|lvds_gen_cntl
)paren
suffix:semicolon
id|lvds_gen_cntl
op_and_assign
op_complement
(paren
id|LVDS_ON
op_or
id|LVDS_BLON
multiline_comment|/* | LVDS_EN | LVDS_DIGON */
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|LVDS_GEN_CNTL
comma
id|lvds_gen_cntl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;is_mobility
op_logical_or
id|rinfo-&gt;is_IGP
)paren
id|OUTPLL
c_func
(paren
id|PIXCLKS_CNTL
comma
id|tmpPixclksCntl
)paren
suffix:semicolon
)brace
id|rinfo-&gt;init_state.lvds_gen_cntl
op_and_assign
op_complement
id|LVDS_STATE_MASK
suffix:semicolon
id|rinfo-&gt;init_state.lvds_gen_cntl
op_or_assign
(paren
id|lvds_gen_cntl
op_amp
id|LVDS_STATE_MASK
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeon_set_backlight_level
r_static
r_int
id|radeon_set_backlight_level
c_func
(paren
r_int
id|level
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|radeon_set_backlight_enable
c_func
(paren
l_int|1
comma
id|level
comma
id|data
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PMAC_BACKLIGHT */
multiline_comment|/*&n; * This reconfigure the card&squot;s internal memory map. In theory, we&squot;d like&n; * to setup the card&squot;s memory at the same address as it&squot;s PCI bus address,&n; * and the AGP aperture right after that so that system RAM on 32 bits&n; * machines at least, is directly accessible. However, doing so would&n; * conflict with the current XFree drivers...&n; * Ultimately, I hope XFree, GATOS and ATI binary drivers will all agree&n; * on the proper way to set this up and duplicate this here. In the meantime,&n; * I put the card&squot;s memory at 0 in card space and AGP at some random high&n; * local (0xe0000000 for now) that will be changed by XFree/DRI anyway&n; */
macro_line|#ifdef CONFIG_PPC_OF
DECL|macro|SET_MC_FB_FROM_APERTURE
macro_line|#undef SET_MC_FB_FROM_APERTURE
DECL|function|fixup_memory_mappings
r_static
r_void
id|fixup_memory_mappings
c_func
(paren
r_struct
id|radeonfb_info
op_star
id|rinfo
)paren
(brace
id|u32
id|save_crtc_gen_cntl
comma
id|save_crtc2_gen_cntl
op_assign
l_int|0
suffix:semicolon
id|u32
id|save_crtc_ext_cntl
suffix:semicolon
id|u32
id|aper_base
comma
id|aper_size
suffix:semicolon
id|u32
id|agp_base
suffix:semicolon
multiline_comment|/* First, we disable display to avoid interfering */
r_if
c_cond
(paren
id|rinfo-&gt;has_CRTC2
)paren
(brace
id|save_crtc2_gen_cntl
op_assign
id|INREG
c_func
(paren
id|CRTC2_GEN_CNTL
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC2_GEN_CNTL
comma
id|save_crtc2_gen_cntl
op_or
id|CRTC2_DISP_REQ_EN_B
)paren
suffix:semicolon
)brace
id|save_crtc_gen_cntl
op_assign
id|INREG
c_func
(paren
id|CRTC_GEN_CNTL
)paren
suffix:semicolon
id|save_crtc_ext_cntl
op_assign
id|INREG
c_func
(paren
id|CRTC_EXT_CNTL
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_EXT_CNTL
comma
id|save_crtc_ext_cntl
op_or
id|CRTC_DISPLAY_DIS
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|save_crtc_gen_cntl
op_or
id|CRTC_DISP_REQ_EN_B
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|aper_base
op_assign
id|INREG
c_func
(paren
id|CONFIG_APER_0_BASE
)paren
suffix:semicolon
id|aper_size
op_assign
id|INREG
c_func
(paren
id|CONFIG_APER_SIZE
)paren
suffix:semicolon
macro_line|#ifdef SET_MC_FB_FROM_APERTURE
multiline_comment|/* Set framebuffer to be at the same address as set in PCI BAR */
id|OUTREG
c_func
(paren
id|MC_FB_LOCATION
comma
(paren
(paren
id|aper_base
op_plus
id|aper_size
op_minus
l_int|1
)paren
op_amp
l_int|0xffff0000
)paren
op_or
(paren
id|aper_base
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|rinfo-&gt;fb_local_base
op_assign
id|aper_base
suffix:semicolon
macro_line|#else
id|OUTREG
c_func
(paren
id|MC_FB_LOCATION
comma
l_int|0x7fff0000
)paren
suffix:semicolon
id|rinfo-&gt;fb_local_base
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|agp_base
op_assign
id|aper_base
op_plus
id|aper_size
suffix:semicolon
r_if
c_cond
(paren
id|agp_base
op_amp
l_int|0xf0000000
)paren
id|agp_base
op_assign
(paren
id|aper_base
op_or
l_int|0x0fffffff
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Set AGP to be just after the framebuffer on a 256Mb boundary. This&n;&t; * assumes the FB isn&squot;t mapped to 0xf0000000 or above, but this is&n;&t; * always the case on PPCs afaik.&n;&t; */
macro_line|#ifdef SET_MC_FB_FROM_APERTURE
id|OUTREG
c_func
(paren
id|MC_AGP_LOCATION
comma
l_int|0xffff0000
op_or
(paren
id|agp_base
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
macro_line|#else
id|OUTREG
c_func
(paren
id|MC_AGP_LOCATION
comma
l_int|0xffffe000
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Fixup the display base addresses &amp; engine offsets while we&n;&t; * are at it as well&n;&t; */
macro_line|#ifdef SET_MC_FB_FROM_APERTURE
id|OUTREG
c_func
(paren
id|DISPLAY_BASE_ADDR
comma
id|aper_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;has_CRTC2
)paren
id|OUTREG
c_func
(paren
id|CRTC2_DISPLAY_BASE_ADDR
comma
id|aper_base
)paren
suffix:semicolon
macro_line|#else
id|OUTREG
c_func
(paren
id|DISPLAY_BASE_ADDR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;has_CRTC2
)paren
id|OUTREG
c_func
(paren
id|CRTC2_DISPLAY_BASE_ADDR
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* Restore display settings */
id|OUTREG
c_func
(paren
id|CRTC_GEN_CNTL
comma
id|save_crtc_gen_cntl
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC_EXT_CNTL
comma
id|save_crtc_ext_cntl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;has_CRTC2
)paren
id|OUTREG
c_func
(paren
id|CRTC2_GEN_CNTL
comma
id|save_crtc2_gen_cntl
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;aper_base: %08x MC_FB_LOC to: %08x, MC_AGP_LOC to: %08x&bslash;n&quot;
comma
id|aper_base
comma
(paren
(paren
id|aper_base
op_plus
id|aper_size
op_minus
l_int|1
)paren
op_amp
l_int|0xffff0000
)paren
op_or
(paren
id|aper_base
op_rshift
l_int|16
)paren
comma
l_int|0xffff0000
op_or
(paren
id|agp_base
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PPC_OF */
multiline_comment|/*&n; * Sysfs&n; */
DECL|function|radeon_show_one_edid
r_static
id|ssize_t
id|radeon_show_one_edid
c_func
(paren
r_char
op_star
id|buf
comma
id|loff_t
id|off
comma
r_int
id|count
comma
r_const
id|u8
op_star
id|edid
)paren
(brace
r_if
c_cond
(paren
id|off
OG
id|EDID_LENGTH
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|off
op_plus
id|count
OG
id|EDID_LENGTH
)paren
id|count
op_assign
id|EDID_LENGTH
op_minus
id|off
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|edid
op_plus
id|off
comma
id|count
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|radeon_show_edid1
r_static
id|ssize_t
id|radeon_show_edid1
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|buf
comma
id|loff_t
id|off
comma
r_int
id|count
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|container_of
c_func
(paren
id|kobj
comma
r_struct
id|device
comma
id|kobj
)paren
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|to_pci_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|radeonfb_info
op_star
id|rinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_return
id|radeon_show_one_edid
c_func
(paren
id|buf
comma
id|off
comma
id|count
comma
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
)brace
DECL|function|radeon_show_edid2
r_static
id|ssize_t
id|radeon_show_edid2
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|buf
comma
id|loff_t
id|off
comma
r_int
id|count
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|container_of
c_func
(paren
id|kobj
comma
r_struct
id|device
comma
id|kobj
)paren
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|to_pci_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|radeonfb_info
op_star
id|rinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_return
id|radeon_show_one_edid
c_func
(paren
id|buf
comma
id|off
comma
id|count
comma
id|rinfo-&gt;mon2_EDID
)paren
suffix:semicolon
)brace
DECL|variable|edid1_attr
r_static
r_struct
id|bin_attribute
id|edid1_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;edid1&quot;
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|mode
op_assign
l_int|0444
comma
)brace
comma
dot
id|size
op_assign
id|EDID_LENGTH
comma
dot
id|read
op_assign
id|radeon_show_edid1
comma
)brace
suffix:semicolon
DECL|variable|edid2_attr
r_static
r_struct
id|bin_attribute
id|edid2_attr
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;edid2&quot;
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|mode
op_assign
l_int|0444
comma
)brace
comma
dot
id|size
op_assign
id|EDID_LENGTH
comma
dot
id|read
op_assign
id|radeon_show_edid2
comma
)brace
suffix:semicolon
DECL|function|radeonfb_pci_register
r_static
r_int
id|radeonfb_pci_register
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_struct
id|radeonfb_info
op_star
id|rinfo
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;radeonfb_pci_register BEGIN&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Enable device in PCI config */
id|ret
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;radeonfb: Cannot enable PCI device&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|info
op_assign
id|framebuffer_alloc
c_func
(paren
r_sizeof
(paren
r_struct
id|radeonfb_info
)paren
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;radeonfb: could not allocate memory&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_disable
suffix:semicolon
)brace
id|rinfo
op_assign
id|info-&gt;par
suffix:semicolon
id|rinfo-&gt;info
op_assign
id|info
suffix:semicolon
id|rinfo-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|rinfo-&gt;reg_lock
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|rinfo-&gt;lvds_timer
)paren
suffix:semicolon
id|rinfo-&gt;lvds_timer.function
op_assign
id|radeon_lvds_timer_func
suffix:semicolon
id|rinfo-&gt;lvds_timer.data
op_assign
(paren
r_int
r_int
)paren
id|rinfo
suffix:semicolon
id|strcpy
c_func
(paren
id|rinfo-&gt;name
comma
l_string|&quot;ATI Radeon XX &quot;
)paren
suffix:semicolon
id|rinfo-&gt;name
(braket
l_int|11
)braket
op_assign
id|ent-&gt;device
op_rshift
l_int|8
suffix:semicolon
id|rinfo-&gt;name
(braket
l_int|12
)braket
op_assign
id|ent-&gt;device
op_amp
l_int|0xFF
suffix:semicolon
id|rinfo-&gt;family
op_assign
id|ent-&gt;driver_data
op_amp
id|CHIP_FAMILY_MASK
suffix:semicolon
id|rinfo-&gt;chipset
op_assign
id|pdev-&gt;device
suffix:semicolon
id|rinfo-&gt;has_CRTC2
op_assign
(paren
id|ent-&gt;driver_data
op_amp
id|CHIP_HAS_CRTC2
)paren
op_ne
l_int|0
suffix:semicolon
id|rinfo-&gt;is_mobility
op_assign
(paren
id|ent-&gt;driver_data
op_amp
id|CHIP_IS_MOBILITY
)paren
op_ne
l_int|0
suffix:semicolon
id|rinfo-&gt;is_IGP
op_assign
(paren
id|ent-&gt;driver_data
op_amp
id|CHIP_IS_IGP
)paren
op_ne
l_int|0
suffix:semicolon
multiline_comment|/* Set base addrs */
id|rinfo-&gt;fb_base_phys
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|rinfo-&gt;mmio_base_phys
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* request the mem regions */
id|ret
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
l_string|&quot;radeonfb&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;radeonfb: cannot reserve PCI regions.&quot;
l_string|&quot;  Someone already got them?&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_release_fb
suffix:semicolon
)brace
multiline_comment|/* map the regions */
id|rinfo-&gt;mmio_base
op_assign
id|ioremap
c_func
(paren
id|rinfo-&gt;mmio_base_phys
comma
id|RADEON_REGSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;mmio_base
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;radeonfb: cannot map MMIO&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_release_pci
suffix:semicolon
)brace
multiline_comment|/* On PPC, the firmware sets up a memory mapping that tends&n;&t; * to cause lockups when enabling the engine. We reconfigure&n;&t; * the card internal memory mappings properly&n;&t; */
macro_line|#ifdef CONFIG_PPC_OF
id|fixup_memory_mappings
c_func
(paren
id|rinfo
)paren
suffix:semicolon
macro_line|#else&t;
id|rinfo-&gt;fb_local_base
op_assign
id|INREG
c_func
(paren
id|MC_FB_LOCATION
)paren
op_lshift
l_int|16
suffix:semicolon
macro_line|#endif /* CONFIG_PPC_OF */
multiline_comment|/* framebuffer size */
r_if
c_cond
(paren
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RS100
)paren
op_logical_or
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RS200
)paren
op_logical_or
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RS300
)paren
)paren
(brace
id|u32
id|tom
op_assign
id|INREG
c_func
(paren
id|NB_TOM
)paren
suffix:semicolon
id|tmp
op_assign
(paren
(paren
(paren
(paren
id|tom
op_rshift
l_int|16
)paren
op_minus
(paren
id|tom
op_amp
l_int|0xffff
)paren
op_plus
l_int|1
)paren
op_lshift
l_int|6
)paren
op_star
l_int|1024
)paren
suffix:semicolon
id|radeon_fifo_wait
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|MC_FB_LOCATION
comma
id|tom
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|DISPLAY_BASE_ADDR
comma
(paren
id|tom
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|CRTC2_DISPLAY_BASE_ADDR
comma
(paren
id|tom
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|OUTREG
c_func
(paren
id|OV0_BASE_ADDR
comma
(paren
id|tom
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* This is supposed to fix the crtc2 noise problem. */
id|OUTREG
c_func
(paren
id|GRPH2_BUFFER_CNTL
comma
id|INREG
c_func
(paren
id|GRPH2_BUFFER_CNTL
)paren
op_amp
op_complement
l_int|0x7f0000
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RS100
)paren
op_logical_or
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_RS200
)paren
)paren
(brace
multiline_comment|/* This is to workaround the asic bug for RMX, some versions&n;                of BIOS dosen&squot;t have this register initialized correctly.&n;             */
id|OUTREGP
c_func
(paren
id|CRTC_MORE_CNTL
comma
id|CRTC_H_CUTOFF_ACTIVE_EN
comma
op_complement
id|CRTC_H_CUTOFF_ACTIVE_EN
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|tmp
op_assign
id|INREG
c_func
(paren
id|CONFIG_MEMSIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* mem size is bits [28:0], mask off the rest */
id|rinfo-&gt;video_ram
op_assign
id|tmp
op_amp
id|CONFIG_MEMSIZE_MASK
suffix:semicolon
multiline_comment|/* ram type */
id|tmp
op_assign
id|INREG
c_func
(paren
id|MEM_SDRAM_MODE_REG
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|MEM_CFG_TYPE
op_amp
id|tmp
)paren
op_rshift
l_int|30
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* SDR SGRAM (2:1) */
id|strcpy
c_func
(paren
id|rinfo-&gt;ram_type
comma
l_string|&quot;SDR SGRAM&quot;
)paren
suffix:semicolon
id|rinfo-&gt;ram.ml
op_assign
l_int|4
suffix:semicolon
id|rinfo-&gt;ram.mb
op_assign
l_int|4
suffix:semicolon
id|rinfo-&gt;ram.trcd
op_assign
l_int|1
suffix:semicolon
id|rinfo-&gt;ram.trp
op_assign
l_int|2
suffix:semicolon
id|rinfo-&gt;ram.twr
op_assign
l_int|1
suffix:semicolon
id|rinfo-&gt;ram.cl
op_assign
l_int|2
suffix:semicolon
id|rinfo-&gt;ram.loop_latency
op_assign
l_int|16
suffix:semicolon
id|rinfo-&gt;ram.rloop
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* DDR SGRAM */
id|strcpy
c_func
(paren
id|rinfo-&gt;ram_type
comma
l_string|&quot;DDR SGRAM&quot;
)paren
suffix:semicolon
id|rinfo-&gt;ram.ml
op_assign
l_int|4
suffix:semicolon
id|rinfo-&gt;ram.mb
op_assign
l_int|4
suffix:semicolon
id|rinfo-&gt;ram.trcd
op_assign
l_int|3
suffix:semicolon
id|rinfo-&gt;ram.trp
op_assign
l_int|3
suffix:semicolon
id|rinfo-&gt;ram.twr
op_assign
l_int|2
suffix:semicolon
id|rinfo-&gt;ram.cl
op_assign
l_int|3
suffix:semicolon
id|rinfo-&gt;ram.tr2w
op_assign
l_int|1
suffix:semicolon
id|rinfo-&gt;ram.loop_latency
op_assign
l_int|16
suffix:semicolon
id|rinfo-&gt;ram.rloop
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* 64-bit SDR SGRAM */
id|strcpy
c_func
(paren
id|rinfo-&gt;ram_type
comma
l_string|&quot;SDR SGRAM 64&quot;
)paren
suffix:semicolon
id|rinfo-&gt;ram.ml
op_assign
l_int|4
suffix:semicolon
id|rinfo-&gt;ram.mb
op_assign
l_int|8
suffix:semicolon
id|rinfo-&gt;ram.trcd
op_assign
l_int|3
suffix:semicolon
id|rinfo-&gt;ram.trp
op_assign
l_int|3
suffix:semicolon
id|rinfo-&gt;ram.twr
op_assign
l_int|1
suffix:semicolon
id|rinfo-&gt;ram.cl
op_assign
l_int|3
suffix:semicolon
id|rinfo-&gt;ram.tr2w
op_assign
l_int|1
suffix:semicolon
id|rinfo-&gt;ram.loop_latency
op_assign
l_int|17
suffix:semicolon
id|rinfo-&gt;ram.rloop
op_assign
l_int|17
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Hack to get around some busted production M6&squot;s&n;&t; * reporting no ram&n;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;video_ram
op_eq
l_int|0
)paren
(brace
r_switch
c_cond
(paren
id|pdev-&gt;device
)paren
(brace
r_case
id|PCI_CHIP_RADEON_LY
suffix:colon
r_case
id|PCI_CHIP_RADEON_LZ
suffix:colon
id|rinfo-&gt;video_ram
op_assign
l_int|8192
op_star
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_ERR
l_string|&quot;radeonfb: no video RAM reported&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|err_unmap_rom
suffix:semicolon
)brace
)brace
id|RTRACE
c_func
(paren
l_string|&quot;radeonfb: probed %s %ldk videoram&bslash;n&quot;
comma
(paren
id|rinfo-&gt;ram_type
)paren
comma
(paren
id|rinfo-&gt;video_ram
op_div
l_int|1024
)paren
)paren
suffix:semicolon
id|rinfo-&gt;mapped_vram
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|MAX_MAPPED_VRAM
comma
id|rinfo-&gt;video_ram
)paren
suffix:semicolon
r_do
(brace
id|rinfo-&gt;fb_base
op_assign
id|ioremap
(paren
id|rinfo-&gt;fb_base_phys
comma
id|rinfo-&gt;mapped_vram
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rinfo-&gt;fb_base
op_eq
l_int|0
op_logical_and
(paren
(paren
id|rinfo-&gt;mapped_vram
op_div_assign
l_int|2
)paren
op_ge
id|MIN_MAPPED_VRAM
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;fb_base
)paren
id|memset_io
c_func
(paren
id|rinfo-&gt;fb_base
comma
l_int|0
comma
id|rinfo-&gt;mapped_vram
)paren
suffix:semicolon
r_else
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;radeonfb: cannot map FB&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_unmap_rom
suffix:semicolon
)brace
id|RTRACE
c_func
(paren
l_string|&quot;radeonfb: mapped %ldk videoram&bslash;n&quot;
comma
id|rinfo-&gt;mapped_vram
op_div
l_int|1024
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check for required workaround for PLL accesses&n;&t; */
id|rinfo-&gt;R300_cg_workaround
op_assign
(paren
id|rinfo-&gt;family
op_eq
id|CHIP_FAMILY_R300
op_logical_and
(paren
id|INREG
c_func
(paren
id|CONFIG_CNTL
)paren
op_amp
id|CFG_ATI_REV_ID_MASK
)paren
op_eq
id|CFG_ATI_REV_A11
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Map the BIOS ROM if any and retreive PLL parameters from&n;&t; * the BIOS. We skip that on mobility chips as the real panel&n;&t; * values we need aren&squot;t in the ROM but in the BIOS image in&n;&t; * memory. This is definitely not the best meacnism though,&n;&t; * we really need the arch code to tell us which is the &quot;primary&quot;&n;&t; * video adapter to use the memory image (or better, the arch&n;&t; * should provide us a copy of the BIOS image to shield us from&n;&t; * archs who would store that elsewhere and/or could initialize&n;&t; * more than one adapter during boot).&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;is_mobility
)paren
id|radeon_map_ROM
c_func
(paren
id|rinfo
comma
id|pdev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * On x86, the primary display on laptop may have it&squot;s BIOS&n;&t; * ROM elsewhere, try to locate it at the legacy memory hole.&n;&t; * We probably need to make sure this is the primary display,&n;&t; * but that is difficult without some arch support.&n;&t; */
macro_line|#ifdef CONFIG_X86
r_if
c_cond
(paren
id|rinfo-&gt;bios_seg
op_eq
l_int|NULL
)paren
id|radeon_find_mem_vbios
c_func
(paren
id|rinfo
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* If both above failed, try the BIOS ROM again for mobility&n;&t; * chips&n;&t; */
r_if
c_cond
(paren
id|rinfo-&gt;bios_seg
op_eq
l_int|NULL
op_logical_and
id|rinfo-&gt;is_mobility
)paren
id|radeon_map_ROM
c_func
(paren
id|rinfo
comma
id|pdev
)paren
suffix:semicolon
multiline_comment|/* Get informations about the board&squot;s PLL */
id|radeon_get_pllinfo
c_func
(paren
id|rinfo
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB_RADEON_I2C
multiline_comment|/* Register I2C bus */
id|radeon_create_i2c_busses
c_func
(paren
id|rinfo
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* set all the vital stuff */
id|radeon_set_fbinfo
(paren
id|rinfo
)paren
suffix:semicolon
multiline_comment|/* Probe screen types */
id|radeon_probe_screens
c_func
(paren
id|rinfo
comma
id|monitor_layout
comma
id|ignore_edid
)paren
suffix:semicolon
multiline_comment|/* Build mode list, check out panel native model */
id|radeon_check_modes
c_func
(paren
id|rinfo
comma
id|mode_option
)paren
suffix:semicolon
multiline_comment|/* Register some sysfs stuff (should be done better) */
r_if
c_cond
(paren
id|rinfo-&gt;mon1_EDID
)paren
id|sysfs_create_bin_file
c_func
(paren
op_amp
id|rinfo-&gt;pdev-&gt;dev.kobj
comma
op_amp
id|edid1_attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon2_EDID
)paren
id|sysfs_create_bin_file
c_func
(paren
op_amp
id|rinfo-&gt;pdev-&gt;dev.kobj
comma
op_amp
id|edid2_attr
)paren
suffix:semicolon
multiline_comment|/* save current mode regs before we switch into the new one&n;&t; * so we can restore this upon __exit&n;&t; */
id|radeon_save_state
(paren
id|rinfo
comma
op_amp
id|rinfo-&gt;init_state
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* Enable PM on mobility chips */
r_if
c_cond
(paren
id|rinfo-&gt;is_mobility
)paren
(brace
multiline_comment|/* Find PM registers in config space */
id|rinfo-&gt;pm_reg
op_assign
id|pci_find_capability
c_func
(paren
id|pdev
comma
id|PCI_CAP_ID_PM
)paren
suffix:semicolon
multiline_comment|/* Enable dynamic PM of chip clocks */
id|radeon_pm_enable_dynamic_mode
c_func
(paren
id|rinfo
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;radeonfb: Power Management enabled for Mobility chipsets&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|register_framebuffer
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;radeonfb: could not register framebuffer&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_unmap_fb
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_MTRR
id|rinfo-&gt;mtrr_hdl
op_assign
id|nomtrr
ques
c_cond
op_minus
l_int|1
suffix:colon
id|mtrr_add
c_func
(paren
id|rinfo-&gt;fb_base_phys
comma
id|rinfo-&gt;video_ram
comma
id|MTRR_TYPE_WRCOMB
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
r_if
c_cond
(paren
id|rinfo-&gt;mon1_type
op_eq
id|MT_LCD
)paren
(brace
id|register_backlight_controller
c_func
(paren
op_amp
id|radeon_backlight_controller
comma
id|rinfo
comma
l_string|&quot;ati&quot;
)paren
suffix:semicolon
id|register_backlight_controller
c_func
(paren
op_amp
id|radeon_backlight_controller
comma
id|rinfo
comma
l_string|&quot;mnca&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|printk
(paren
l_string|&quot;radeonfb: %s %s %ld MB&bslash;n&quot;
comma
id|rinfo-&gt;name
comma
id|rinfo-&gt;ram_type
comma
(paren
id|rinfo-&gt;video_ram
op_div
(paren
l_int|1024
op_star
l_int|1024
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;bios_seg
)paren
id|radeon_unmap_ROM
c_func
(paren
id|rinfo
comma
id|pdev
)paren
suffix:semicolon
id|RTRACE
c_func
(paren
l_string|&quot;radeonfb_pci_register END&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_unmap_fb
suffix:colon
id|iounmap
c_func
(paren
id|rinfo-&gt;fb_base
)paren
suffix:semicolon
id|err_unmap_rom
suffix:colon
r_if
c_cond
(paren
id|rinfo-&gt;mon1_EDID
)paren
id|kfree
c_func
(paren
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon2_EDID
)paren
id|kfree
c_func
(paren
id|rinfo-&gt;mon2_EDID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon1_modedb
)paren
id|fb_destroy_modedb
c_func
(paren
id|rinfo-&gt;mon1_modedb
)paren
suffix:semicolon
id|fb_dealloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB_RADEON_I2C
id|radeon_delete_i2c_busses
c_func
(paren
id|rinfo
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|rinfo-&gt;bios_seg
)paren
id|radeon_unmap_ROM
c_func
(paren
id|rinfo
comma
id|pdev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|rinfo-&gt;mmio_base
)paren
suffix:semicolon
id|err_release_pci
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_release_fb
suffix:colon
id|framebuffer_release
c_func
(paren
id|info
)paren
suffix:semicolon
id|err_disable
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|radeonfb_pci_unregister
r_static
r_void
id|__devexit
id|radeonfb_pci_unregister
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|fb_info
op_star
id|info
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|radeonfb_info
op_star
id|rinfo
op_assign
id|info-&gt;par
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rinfo
)paren
r_return
suffix:semicolon
multiline_comment|/* restore original state&n;&t; * &n;&t; * Doesn&squot;t quite work yet, possibly because of the PPC hacking&n;&t; * I do on startup, disable for now. --BenH&n;&t; */
id|radeon_write_mode
(paren
id|rinfo
comma
op_amp
id|rinfo-&gt;init_state
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|rinfo-&gt;lvds_timer
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MTRR
r_if
c_cond
(paren
id|rinfo-&gt;mtrr_hdl
op_ge
l_int|0
)paren
id|mtrr_del
c_func
(paren
id|rinfo-&gt;mtrr_hdl
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|unregister_framebuffer
c_func
(paren
id|info
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|rinfo-&gt;mmio_base
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|rinfo-&gt;fb_base
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon1_EDID
)paren
id|kfree
c_func
(paren
id|rinfo-&gt;mon1_EDID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon2_EDID
)paren
id|kfree
c_func
(paren
id|rinfo-&gt;mon2_EDID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rinfo-&gt;mon1_modedb
)paren
id|fb_destroy_modedb
c_func
(paren
id|rinfo-&gt;mon1_modedb
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB_RADEON_I2C
id|radeon_delete_i2c_busses
c_func
(paren
id|rinfo
)paren
suffix:semicolon
macro_line|#endif        
id|fb_dealloc_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
)paren
suffix:semicolon
id|framebuffer_release
c_func
(paren
id|info
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
DECL|variable|radeonfb_driver
r_static
r_struct
id|pci_driver
id|radeonfb_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;radeonfb&quot;
comma
dot
id|id_table
op_assign
id|radeonfb_pci_table
comma
dot
id|probe
op_assign
id|radeonfb_pci_register
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|radeonfb_pci_unregister
)paren
comma
macro_line|#ifdef CONFIG_PM
dot
id|suspend
op_assign
id|radeonfb_pci_suspend
comma
dot
id|resume
op_assign
id|radeonfb_pci_resume
comma
macro_line|#endif /* CONFIG_PM */
)brace
suffix:semicolon
r_int
id|__init
id|radeonfb_setup
(paren
r_char
op_star
id|options
)paren
suffix:semicolon
DECL|function|radeonfb_init
r_int
id|__init
id|radeonfb_init
(paren
r_void
)paren
(brace
macro_line|#ifndef MODULE
r_char
op_star
id|option
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|fb_get_options
c_func
(paren
l_string|&quot;radeonfb&quot;
comma
op_amp
id|option
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|radeonfb_setup
c_func
(paren
id|option
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pci_module_init
(paren
op_amp
id|radeonfb_driver
)paren
suffix:semicolon
)brace
DECL|function|radeonfb_exit
r_void
id|__exit
id|radeonfb_exit
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|radeonfb_driver
)paren
suffix:semicolon
)brace
DECL|function|radeonfb_setup
r_int
id|__init
id|radeonfb_setup
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_opt
op_assign
id|strsep
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;noaccel&quot;
comma
l_int|7
)paren
)paren
(brace
id|noaccel
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;mirror&quot;
comma
l_int|6
)paren
)paren
(brace
id|mirror
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;force_dfp&quot;
comma
l_int|9
)paren
)paren
(brace
id|force_dfp
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;panel_yres:&quot;
comma
l_int|11
)paren
)paren
(brace
id|panel_yres
op_assign
id|simple_strtoul
c_func
(paren
(paren
id|this_opt
op_plus
l_int|11
)paren
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MTRR
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;nomtrr&quot;
comma
l_int|6
)paren
)paren
(brace
id|nomtrr
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;nomodeset&quot;
comma
l_int|9
)paren
)paren
(brace
id|nomodeset
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;force_measure_pll&quot;
comma
l_int|17
)paren
)paren
(brace
id|force_measure_pll
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;ignore_edid&quot;
comma
l_int|11
)paren
)paren
(brace
id|ignore_edid
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|mode_option
op_assign
id|this_opt
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|radeonfb_init
id|module_init
c_func
(paren
id|radeonfb_init
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|radeonfb_exit
id|module_exit
c_func
(paren
id|radeonfb_exit
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ani Joshi&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;framebuffer driver for ATI Radeon chipset&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|noaccel
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|noaccel
comma
l_string|&quot;bool: disable acceleration&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|nomodeset
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|nomodeset
comma
l_string|&quot;bool: disable actual setting of video mode&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|mirror
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mirror
comma
l_string|&quot;bool: mirror the display to both monitors&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|force_dfp
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|force_dfp
comma
l_string|&quot;bool: force display to dfp&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|ignore_edid
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ignore_edid
comma
l_string|&quot;bool: Ignore EDID data when doing DDC probe&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|monitor_layout
comma
id|charp
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|monitor_layout
comma
l_string|&quot;Specify monitor mapping (like XFree86)&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|force_measure_pll
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|force_measure_pll
comma
l_string|&quot;Force measurement of PLL (debug)&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MTRR
id|module_param
c_func
(paren
id|nomtrr
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|nomtrr
comma
l_string|&quot;bool: disable use of MTRR registers&quot;
)paren
suffix:semicolon
macro_line|#endif
id|module_param
c_func
(paren
id|panel_yres
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|panel_yres
comma
l_string|&quot;int: set panel yres&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|mode_option
comma
id|charp
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mode_option
comma
l_string|&quot;Specify resolution as &bslash;&quot;&lt;xres&gt;x&lt;yres&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]&bslash;&quot; &quot;
)paren
suffix:semicolon
eof
