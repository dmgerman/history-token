multiline_comment|/*&n; *  Fast C2P (Chunky-to-Planar) Conversion&n; *&n; *  Copyright (C) 2003 Geert Uytterhoeven&n; *&n; *  NOTES:&n; *    - This code was inspired by Scout&squot;s C2P tutorial&n; *    - It assumes to run on a big endian system&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License. See the file COPYING in the main directory of this archive&n; *  for more details.&n; */
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &quot;c2p.h&quot;
multiline_comment|/*&n;     *  Basic transpose step&n;     */
DECL|macro|_transp
mdefine_line|#define _transp(d, i1, i2, shift, mask)&t;&t;&t;&bslash;&n;    do {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;u32 t = (d[i1] ^ (d[i2] &gt;&gt; shift)) &amp; mask;&t;&bslash;&n;&t;d[i1] ^= t;&t;&t;&t;&t;&t;&bslash;&n;&t;d[i2] ^= t &lt;&lt; shift;&t;&t;&t;&t;&bslash;&n;    } while (0)
DECL|function|get_mask
r_static
r_inline
id|u32
id|get_mask
c_func
(paren
r_int
id|n
)paren
(brace
r_switch
c_cond
(paren
id|n
)paren
(brace
r_case
l_int|1
suffix:colon
r_return
l_int|0x55555555
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_return
l_int|0x33333333
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
r_return
l_int|0x0f0f0f0f
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
r_return
l_int|0x00ff00ff
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
r_return
l_int|0x0000ffff
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|transp_nx1
mdefine_line|#define transp_nx1(d, n)&t;&t;&t;&t;&bslash;&n;    do {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;u32 mask = get_mask(n);&t;&t;&t;&t;&bslash;&n;&t;/* First block */&t;&t;&t;&t;&bslash;&n;&t;_transp(d, 0, 1, n, mask);&t;&t;&t;&bslash;&n;&t;/* Second block */&t;&t;&t;&t;&bslash;&n;&t;_transp(d, 2, 3, n, mask);&t;&t;&t;&bslash;&n;&t;/* Third block */&t;&t;&t;&t;&bslash;&n;&t;_transp(d, 4, 5, n, mask);&t;&t;&t;&bslash;&n;&t;/* Fourth block */&t;&t;&t;&t;&bslash;&n;&t;_transp(d, 6, 7, n, mask);&t;&t;&t;&bslash;&n;    } while (0)
DECL|macro|transp_nx2
mdefine_line|#define transp_nx2(d, n)&t;&t;&t;&t;&bslash;&n;    do {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;u32 mask = get_mask(n);&t;&t;&t;&t;&bslash;&n;&t;/* First block */&t;&t;&t;&t;&bslash;&n;&t;_transp(d, 0, 2, n, mask);&t;&t;&t;&bslash;&n;&t;_transp(d, 1, 3, n, mask);&t;&t;&t;&bslash;&n;&t;/* Second block */&t;&t;&t;&t;&bslash;&n;&t;_transp(d, 4, 6, n, mask);&t;&t;&t;&bslash;&n;&t;_transp(d, 5, 7, n, mask);&t;&t;&t;&bslash;&n;    } while (0)
DECL|macro|transp_nx4
mdefine_line|#define transp_nx4(d, n)&t;&t;&t;&t;&bslash;&n;    do {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;u32 mask = get_mask(n);&t;&t;&t;&t;&bslash;&n;&t;_transp(d, 0, 4, n, mask);&t;&t;&t;&bslash;&n;&t;_transp(d, 1, 5, n, mask);&t;&t;&t;&bslash;&n;&t;_transp(d, 2, 6, n, mask);&t;&t;&t;&bslash;&n;&t;_transp(d, 3, 7, n, mask);&t;&t;&t;&bslash;&n;    } while (0)
DECL|macro|transp
mdefine_line|#define transp(d, n, m)&t;transp_nx ## m(d, n)
multiline_comment|/*&n;     *  Perform a full C2P step on 32 8-bit pixels, stored in 8 32-bit words&n;     *  containing&n;     *    - 32 8-bit chunky pixels on input&n;     *    - permuted planar data on output&n;     */
DECL|function|c2p_8bpp
r_static
r_void
id|c2p_8bpp
c_func
(paren
id|u32
id|d
(braket
l_int|8
)braket
)paren
(brace
id|transp
c_func
(paren
id|d
comma
l_int|16
comma
l_int|4
)paren
suffix:semicolon
id|transp
c_func
(paren
id|d
comma
l_int|8
comma
l_int|2
)paren
suffix:semicolon
id|transp
c_func
(paren
id|d
comma
l_int|4
comma
l_int|1
)paren
suffix:semicolon
id|transp
c_func
(paren
id|d
comma
l_int|2
comma
l_int|4
)paren
suffix:semicolon
id|transp
c_func
(paren
id|d
comma
l_int|1
comma
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Array containing the permution indices of the planar data after c2p&n;     */
DECL|variable|perm_c2p_8bpp
r_static
r_const
r_int
id|perm_c2p_8bpp
(braket
l_int|8
)braket
op_assign
(brace
l_int|7
comma
l_int|5
comma
l_int|3
comma
l_int|1
comma
l_int|6
comma
l_int|4
comma
l_int|2
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n;     *  Compose two values, using a bitmask as decision value&n;     *  This is equivalent to (a &amp; mask) | (b &amp; ~mask)&n;     */
DECL|function|comp
r_static
r_inline
r_int
r_int
id|comp
c_func
(paren
r_int
r_int
id|a
comma
r_int
r_int
id|b
comma
r_int
r_int
id|mask
)paren
(brace
r_return
(paren
(paren
id|a
op_xor
id|b
)paren
op_amp
id|mask
)paren
op_xor
id|b
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Store a full block of planar data after c2p conversion&n;     */
DECL|function|store_planar
r_static
r_inline
r_void
id|store_planar
c_func
(paren
r_char
op_star
id|dst
comma
id|u32
id|dst_inc
comma
id|u32
id|bpp
comma
id|u32
id|d
(braket
l_int|8
)braket
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bpp
suffix:semicolon
id|i
op_increment
comma
id|dst
op_add_assign
id|dst_inc
)paren
op_star
(paren
id|u32
op_star
)paren
id|dst
op_assign
id|d
(braket
id|perm_c2p_8bpp
(braket
id|i
)braket
)braket
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Store a partial block of planar data after c2p conversion&n;     */
DECL|function|store_planar_masked
r_static
r_inline
r_void
id|store_planar_masked
c_func
(paren
r_char
op_star
id|dst
comma
id|u32
id|dst_inc
comma
id|u32
id|bpp
comma
id|u32
id|d
(braket
l_int|8
)braket
comma
id|u32
id|mask
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bpp
suffix:semicolon
id|i
op_increment
comma
id|dst
op_add_assign
id|dst_inc
)paren
op_star
(paren
id|u32
op_star
)paren
id|dst
op_assign
id|comp
c_func
(paren
id|d
(braket
id|perm_c2p_8bpp
(braket
id|i
)braket
)braket
comma
op_star
(paren
id|u32
op_star
)paren
id|dst
comma
id|mask
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *  c2p - Copy 8-bit chunky image data to a planar frame buffer&n;     *  @dst: Starting address of the planar frame buffer&n;     *  @dx: Horizontal destination offset (in pixels)&n;     *  @dy: Vertical destination offset (in pixels)&n;     *  @width: Image width (in pixels)&n;     *  @height: Image height (in pixels)&n;     *  @dst_nextline: Frame buffer offset to the next line (in bytes)&n;     *  @dst_nextplane: Frame buffer offset to the next plane (in bytes)&n;     *  @src_nextline: Image offset to the next line (in bytes)&n;     *  @bpp: Bits per pixel of the planar frame buffer (1-8)&n;     */
DECL|function|c2p
r_void
id|c2p
c_func
(paren
id|u8
op_star
id|dst
comma
r_const
id|u8
op_star
id|src
comma
id|u32
id|dx
comma
id|u32
id|dy
comma
id|u32
id|width
comma
id|u32
id|height
comma
id|u32
id|dst_nextline
comma
id|u32
id|dst_nextplane
comma
id|u32
id|src_nextline
comma
id|u32
id|bpp
)paren
(brace
r_int
id|dst_idx
suffix:semicolon
id|u32
id|d
(braket
l_int|8
)braket
comma
id|first
comma
id|last
comma
id|w
suffix:semicolon
r_const
id|u8
op_star
id|c
suffix:semicolon
id|u8
op_star
id|p
suffix:semicolon
id|dst
op_add_assign
id|dy
op_star
id|dst_nextline
op_plus
(paren
id|dx
op_amp
op_complement
l_int|31
)paren
suffix:semicolon
id|dst_idx
op_assign
id|dx
op_mod
l_int|32
suffix:semicolon
id|first
op_assign
op_complement
l_int|0UL
op_rshift
id|dst_idx
suffix:semicolon
id|last
op_assign
op_complement
(paren
op_complement
l_int|0UL
op_rshift
(paren
(paren
id|dst_idx
op_plus
id|width
)paren
op_mod
l_int|32
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|height
op_decrement
)paren
(brace
id|c
op_assign
id|src
suffix:semicolon
id|p
op_assign
id|dst
suffix:semicolon
id|w
op_assign
id|width
suffix:semicolon
r_if
c_cond
(paren
id|dst_idx
op_plus
id|width
op_le
l_int|32
)paren
(brace
multiline_comment|/* Single destination word */
id|first
op_and_assign
id|last
suffix:semicolon
id|memset
c_func
(paren
id|d
comma
l_int|0
comma
r_sizeof
(paren
id|d
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u8
op_star
)paren
id|d
op_plus
id|dst_idx
comma
id|c
comma
id|width
)paren
suffix:semicolon
id|c
op_add_assign
id|width
suffix:semicolon
id|c2p_8bpp
c_func
(paren
id|d
)paren
suffix:semicolon
id|store_planar_masked
c_func
(paren
id|p
comma
id|dst_nextplane
comma
id|bpp
comma
id|d
comma
id|first
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Multiple destination words */
id|w
op_assign
id|width
suffix:semicolon
multiline_comment|/* Leading bits */
r_if
c_cond
(paren
id|dst_idx
)paren
(brace
id|w
op_assign
l_int|32
op_minus
id|dst_idx
suffix:semicolon
id|memset
c_func
(paren
id|d
comma
l_int|0
comma
id|dst_idx
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
id|u8
op_star
)paren
id|d
op_plus
id|dst_idx
comma
id|c
comma
id|w
)paren
suffix:semicolon
id|c
op_add_assign
id|w
suffix:semicolon
id|c2p_8bpp
c_func
(paren
id|d
)paren
suffix:semicolon
id|store_planar_masked
c_func
(paren
id|p
comma
id|dst_nextplane
comma
id|bpp
comma
id|d
comma
id|first
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
id|w
op_assign
id|width
op_minus
id|w
suffix:semicolon
)brace
multiline_comment|/* Main chunk */
r_while
c_loop
(paren
id|w
op_ge
l_int|32
)paren
(brace
id|memcpy
c_func
(paren
id|d
comma
id|c
comma
l_int|32
)paren
suffix:semicolon
id|c
op_add_assign
l_int|32
suffix:semicolon
id|c2p_8bpp
c_func
(paren
id|d
)paren
suffix:semicolon
id|store_planar
c_func
(paren
id|p
comma
id|dst_nextplane
comma
id|bpp
comma
id|d
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
id|w
op_sub_assign
l_int|32
suffix:semicolon
)brace
multiline_comment|/* Trailing bits */
id|w
op_mod_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|w
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|d
comma
id|c
comma
id|w
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
id|u8
op_star
)paren
id|d
op_plus
id|w
comma
l_int|0
comma
l_int|32
op_minus
id|w
)paren
suffix:semicolon
id|c2p_8bpp
c_func
(paren
id|d
)paren
suffix:semicolon
id|store_planar_masked
c_func
(paren
id|p
comma
id|dst_nextplane
comma
id|bpp
comma
id|d
comma
id|last
)paren
suffix:semicolon
)brace
)brace
id|src
op_add_assign
id|src_nextline
suffix:semicolon
id|dst
op_add_assign
id|dst_nextline
suffix:semicolon
)brace
)brace
eof
