multiline_comment|/*&n; * pnp_proc.c: /proc/bus/pnp interface for Plug and Play devices&n; *&n; * Written by David Hinds, dahinds@users.sourceforge.net&n; */
singleline_comment|//#include &lt;pcmcia/config.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
singleline_comment|//#include &lt;pcmcia/k_compat.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/pnpbios.h&gt;
DECL|variable|proc_pnp
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_pnp
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|proc_pnp_boot
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_pnp_boot
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|node_info
r_static
r_struct
id|pnp_dev_node_info
id|node_info
suffix:semicolon
DECL|function|proc_read_devices
r_static
r_int
id|proc_read_devices
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|pos
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|pnp_bios_node
op_star
id|node
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u8
id|nodenum
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_ne
l_int|0
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|node
op_assign
id|pnpbios_kmalloc
c_func
(paren
id|node_info.max_node_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|nodenum
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xff
op_logical_and
id|nodenum
op_ne
l_int|0xff
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pnp_bios_get_dev_node
c_func
(paren
op_amp
id|nodenum
comma
l_int|1
comma
id|node
)paren
)paren
r_break
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%02x&bslash;t%08x&bslash;t%02x:%02x:%02x&bslash;t%04x&bslash;n&quot;
comma
id|node-&gt;handle
comma
id|node-&gt;eisa_id
comma
id|node-&gt;type_code
(braket
l_int|0
)braket
comma
id|node-&gt;type_code
(braket
l_int|1
)braket
comma
id|node-&gt;type_code
(braket
l_int|2
)braket
comma
id|node-&gt;flags
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
DECL|function|proc_read_node
r_static
r_int
id|proc_read_node
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|pos
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|pnp_bios_node
op_star
id|node
suffix:semicolon
r_int
id|boot
op_assign
(paren
r_int
)paren
id|data
op_rshift
l_int|8
suffix:semicolon
id|u8
id|nodenum
op_assign
(paren
r_int
)paren
id|data
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
op_ne
l_int|0
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|node
op_assign
id|pnpbios_kmalloc
c_func
(paren
id|node_info.max_node_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|pnp_bios_get_dev_node
c_func
(paren
op_amp
id|nodenum
comma
id|boot
comma
id|node
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|len
op_assign
id|node-&gt;size
op_minus
r_sizeof
(paren
r_struct
id|pnp_bios_node
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|node-&gt;data
comma
id|len
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|proc_write_node
r_static
r_int
id|proc_write_node
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|pnp_bios_node
op_star
id|node
suffix:semicolon
r_int
id|boot
op_assign
(paren
r_int
)paren
id|data
op_rshift
l_int|8
suffix:semicolon
id|u8
id|nodenum
op_assign
(paren
r_int
)paren
id|data
suffix:semicolon
id|node
op_assign
id|pnpbios_kmalloc
c_func
(paren
id|node_info.max_node_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|pnp_bios_get_dev_node
c_func
(paren
op_amp
id|nodenum
comma
id|boot
comma
id|node
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
id|node-&gt;size
op_minus
r_sizeof
(paren
r_struct
id|pnp_bios_node
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
c_func
(paren
id|node-&gt;data
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pnp_bios_set_dev_node
c_func
(paren
id|node-&gt;handle
comma
id|boot
comma
id|node
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * When this is called, pnpbios functions are assumed to&n; * work and the pnpbios_dont_use_current_config flag&n; * should already have been set to the appropriate value&n; */
DECL|function|pnpbios_proc_init
r_void
id|pnpbios_proc_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|pnp_bios_node
op_star
id|node
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
r_char
id|name
(braket
l_int|3
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u8
id|nodenum
suffix:semicolon
r_if
c_cond
(paren
id|pnp_bios_dev_node_info
c_func
(paren
op_amp
id|node_info
)paren
op_ne
l_int|0
)paren
r_return
suffix:semicolon
id|proc_pnp
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;pnp&quot;
comma
id|proc_bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_pnp
)paren
r_return
suffix:semicolon
id|proc_pnp_boot
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;boot&quot;
comma
id|proc_pnp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_pnp_boot
)paren
r_return
suffix:semicolon
id|create_proc_read_entry
c_func
(paren
l_string|&quot;devices&quot;
comma
l_int|0
comma
id|proc_pnp
comma
id|proc_read_devices
comma
l_int|NULL
)paren
suffix:semicolon
id|node
op_assign
id|pnpbios_kmalloc
c_func
(paren
id|node_info.max_node_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|nodenum
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xff
op_logical_and
id|nodenum
op_ne
l_int|0xff
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pnp_bios_get_dev_node
c_func
(paren
op_amp
id|nodenum
comma
l_int|1
comma
id|node
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%02x&quot;
comma
id|node-&gt;handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnpbios_dont_use_current_config
)paren
(brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
id|name
comma
l_int|0
comma
id|proc_pnp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
id|ent-&gt;read_proc
op_assign
id|proc_read_node
suffix:semicolon
id|ent-&gt;write_proc
op_assign
id|proc_write_node
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
)paren
(paren
id|node-&gt;handle
)paren
suffix:semicolon
)brace
)brace
id|ent
op_assign
id|create_proc_entry
c_func
(paren
id|name
comma
l_int|0
comma
id|proc_pnp_boot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent
)paren
(brace
id|ent-&gt;read_proc
op_assign
id|proc_read_node
suffix:semicolon
id|ent-&gt;write_proc
op_assign
id|proc_write_node
suffix:semicolon
id|ent-&gt;data
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
)paren
(paren
id|node-&gt;handle
op_plus
l_int|0x100
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
DECL|function|pnpbios_proc_done
r_void
id|pnpbios_proc_done
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
id|name
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_pnp
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0xff
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%02x&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnpbios_dont_use_current_config
)paren
id|remove_proc_entry
c_func
(paren
id|name
comma
id|proc_pnp
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|name
comma
id|proc_pnp_boot
)paren
suffix:semicolon
)brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;boot&quot;
comma
id|proc_pnp
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;devices&quot;
comma
id|proc_pnp
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;pnp&quot;
comma
id|proc_bus
)paren
suffix:semicolon
)brace
eof
