multiline_comment|/*&n; * pnpbios -- PnP BIOS driver&n; *&n; * This driver provides access to Plug-&squot;n&squot;-Play services provided by&n; * the PnP BIOS firmware, described in the following documents:&n; *   Plug and Play BIOS Specification, Version 1.0A, 5 May 1994&n; *   Plug and Play BIOS Clarification Paper, 6 October 1994&n; *     Compaq Computer Corporation, Phoenix Technologies Ltd., Intel Corp.&n; * &n; * Originally (C) 1998 Christian Schmidt &lt;schmidt@digadd.de&gt;&n; * Modifications (C) 1998 Tom Lees &lt;tom@lpsg.demon.co.uk&gt;&n; * Minor reorganizations by David Hinds &lt;dahinds@users.sourceforge.net&gt;&n; * Further modifications (C) 2001, 2002 by:&n; *   Alan Cox &lt;alan@redhat.com&gt;&n; *   Thomas Hood &lt;jdthood@mail.com&gt;&n; *   Brian Gerst &lt;bgerst@didntduck.org&gt;&n; *&n; * Ported to the PnP Layer and several additional improvements (C) 2002&n; * by Adam Belay &lt;ambx1@neo.rr.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/linkage.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pnpbios.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/pnp.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;asm/desc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
multiline_comment|/*&n; *&n; * PnP BIOS INTERFACE&n; *&n; */
multiline_comment|/* PnP BIOS signature: &quot;$PnP&quot; */
DECL|macro|PNP_SIGNATURE
mdefine_line|#define PNP_SIGNATURE   ((&squot;$&squot; &lt;&lt; 0) + (&squot;P&squot; &lt;&lt; 8) + (&squot;n&squot; &lt;&lt; 16) + (&squot;P&squot; &lt;&lt; 24))
macro_line|#pragma pack(1)
DECL|union|pnp_bios_expansion_header
r_union
id|pnp_bios_expansion_header
(brace
r_struct
(brace
DECL|member|signature
id|u32
id|signature
suffix:semicolon
multiline_comment|/* &quot;$PnP&quot; */
DECL|member|version
id|u8
id|version
suffix:semicolon
multiline_comment|/* in BCD */
DECL|member|length
id|u8
id|length
suffix:semicolon
multiline_comment|/* length in bytes, currently 21h */
DECL|member|control
id|u16
id|control
suffix:semicolon
multiline_comment|/* system capabilities */
DECL|member|checksum
id|u8
id|checksum
suffix:semicolon
multiline_comment|/* all bytes must add up to 0 */
DECL|member|eventflag
id|u32
id|eventflag
suffix:semicolon
multiline_comment|/* phys. address of the event flag */
DECL|member|rmoffset
id|u16
id|rmoffset
suffix:semicolon
multiline_comment|/* real mode entry point */
DECL|member|rmcseg
id|u16
id|rmcseg
suffix:semicolon
DECL|member|pm16offset
id|u16
id|pm16offset
suffix:semicolon
multiline_comment|/* 16 bit protected mode entry */
DECL|member|pm16cseg
id|u32
id|pm16cseg
suffix:semicolon
DECL|member|deviceID
id|u32
id|deviceID
suffix:semicolon
multiline_comment|/* EISA encoded system ID or 0 */
DECL|member|rmdseg
id|u16
id|rmdseg
suffix:semicolon
multiline_comment|/* real mode data segment */
DECL|member|pm16dseg
id|u32
id|pm16dseg
suffix:semicolon
multiline_comment|/* 16 bit pm data segment base */
DECL|member|fields
)brace
id|fields
suffix:semicolon
DECL|member|chars
r_char
id|chars
(braket
l_int|0x21
)braket
suffix:semicolon
multiline_comment|/* To calculate the checksum */
)brace
suffix:semicolon
macro_line|#pragma pack()
r_static
r_struct
(brace
DECL|member|offset
id|u16
id|offset
suffix:semicolon
DECL|member|segment
id|u16
id|segment
suffix:semicolon
DECL|variable|pnp_bios_callpoint
)brace
id|pnp_bios_callpoint
suffix:semicolon
DECL|variable|pnp_bios_hdr
r_static
r_union
id|pnp_bios_expansion_header
op_star
id|pnp_bios_hdr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* The PnP BIOS entries in the GDT */
DECL|macro|PNP_GDT
mdefine_line|#define PNP_GDT    (GDT_ENTRY_PNPBIOS_BASE * 8)
DECL|macro|PNP_CS32
mdefine_line|#define PNP_CS32   (PNP_GDT+0x00)&t;/* segment for calling fn */
DECL|macro|PNP_CS16
mdefine_line|#define PNP_CS16   (PNP_GDT+0x08)&t;/* code segment for BIOS */
DECL|macro|PNP_DS
mdefine_line|#define PNP_DS     (PNP_GDT+0x10)&t;/* data segment for BIOS */
DECL|macro|PNP_TS1
mdefine_line|#define PNP_TS1    (PNP_GDT+0x18)&t;/* transfer data segment */
DECL|macro|PNP_TS2
mdefine_line|#define PNP_TS2    (PNP_GDT+0x20)&t;/* another data segment */
multiline_comment|/* &n; * These are some opcodes for a &quot;static asmlinkage&quot;&n; * As this code is *not* executed inside the linux kernel segment, but in a&n; * alias at offset 0, we need a far return that can not be compiled by&n; * default (please, prove me wrong! this is *really* ugly!) &n; * This is the only way to get the bios to return into the kernel code,&n; * because the bios code runs in 16 bit protected mode and therefore can only&n; * return to the caller if the call is within the first 64kB, and the linux&n; * kernel begins at offset 3GB...&n; */
id|asmlinkage
r_void
id|pnp_bios_callfunc
c_func
(paren
r_void
)paren
suffix:semicolon
id|__asm__
c_func
(paren
l_string|&quot;.text&t;&t;&t;&bslash;n&quot;
id|__ALIGN_STR
l_string|&quot;&bslash;n&quot;
l_string|&quot;pnp_bios_callfunc:&bslash;n&quot;
l_string|&quot;&t;pushl %edx&t;&bslash;n&quot;
l_string|&quot;&t;pushl %ecx&t;&bslash;n&quot;
l_string|&quot;&t;pushl %ebx&t;&bslash;n&quot;
l_string|&quot;&t;pushl %eax&t;&bslash;n&quot;
l_string|&quot;&t;lcallw *pnp_bios_callpoint&bslash;n&quot;
l_string|&quot;&t;addl $16, %esp&t;&bslash;n&quot;
l_string|&quot;&t;lret&t;&t;&bslash;n&quot;
l_string|&quot;.previous&t;&t;&bslash;n&quot;
)paren
suffix:semicolon
DECL|macro|Q_SET_SEL
mdefine_line|#define Q_SET_SEL(cpu, selname, address, size) &bslash;&n;do { &bslash;&n;set_base(cpu_gdt_table[cpu][(selname) &gt;&gt; 3], __va((u32)(address))); &bslash;&n;set_limit(cpu_gdt_table[cpu][(selname) &gt;&gt; 3], size); &bslash;&n;} while(0)
DECL|macro|Q2_SET_SEL
mdefine_line|#define Q2_SET_SEL(cpu, selname, address, size) &bslash;&n;do { &bslash;&n;set_base(cpu_gdt_table[cpu][(selname) &gt;&gt; 3], (u32)(address)); &bslash;&n;set_limit(cpu_gdt_table[cpu][(selname) &gt;&gt; 3], size); &bslash;&n;} while(0)
multiline_comment|/*&n; * At some point we want to use this stack frame pointer to unwind&n; * after PnP BIOS oopses. &n; */
DECL|variable|pnp_bios_fault_esp
id|u32
id|pnp_bios_fault_esp
suffix:semicolon
DECL|variable|pnp_bios_fault_eip
id|u32
id|pnp_bios_fault_eip
suffix:semicolon
DECL|variable|pnp_bios_is_utter_crap
id|u32
id|pnp_bios_is_utter_crap
op_assign
l_int|0
suffix:semicolon
DECL|variable|pnp_bios_lock
r_static
id|spinlock_t
id|pnp_bios_lock
suffix:semicolon
DECL|function|call_pnp_bios
r_static
r_inline
id|u16
id|call_pnp_bios
c_func
(paren
id|u16
id|func
comma
id|u16
id|arg1
comma
id|u16
id|arg2
comma
id|u16
id|arg3
comma
id|u16
id|arg4
comma
id|u16
id|arg5
comma
id|u16
id|arg6
comma
id|u16
id|arg7
comma
r_void
op_star
id|ts1_base
comma
id|u32
id|ts1_size
comma
r_void
op_star
id|ts2_base
comma
id|u32
id|ts2_size
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|status
suffix:semicolon
multiline_comment|/*&n;&t; * PnP BIOSes are generally not terribly re-entrant.&n;&t; * Also, don&squot;t rely on them to save everything correctly.&n;&t; */
r_if
c_cond
(paren
id|pnp_bios_is_utter_crap
)paren
(brace
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
)brace
multiline_comment|/* On some boxes IRQ&squot;s during PnP BIOS calls are deadly.  */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pnp_bios_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* The lock prevents us bouncing CPU here */
r_if
c_cond
(paren
id|ts1_size
)paren
id|Q2_SET_SEL
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|PNP_TS1
comma
id|ts1_base
comma
id|ts1_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ts2_size
)paren
id|Q2_SET_SEL
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|PNP_TS2
comma
id|ts2_base
comma
id|ts2_size
)paren
suffix:semicolon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;pushl %%ebp&bslash;n&bslash;t&quot;
l_string|&quot;pushl %%edi&bslash;n&bslash;t&quot;
l_string|&quot;pushl %%esi&bslash;n&bslash;t&quot;
l_string|&quot;pushl %%ds&bslash;n&bslash;t&quot;
l_string|&quot;pushl %%es&bslash;n&bslash;t&quot;
l_string|&quot;pushl %%fs&bslash;n&bslash;t&quot;
l_string|&quot;pushl %%gs&bslash;n&bslash;t&quot;
l_string|&quot;pushfl&bslash;n&bslash;t&quot;
l_string|&quot;movl %%esp, pnp_bios_fault_esp&bslash;n&bslash;t&quot;
l_string|&quot;movl $1f, pnp_bios_fault_eip&bslash;n&bslash;t&quot;
l_string|&quot;lcall %5,%6&bslash;n&bslash;t&quot;
l_string|&quot;1:popfl&bslash;n&bslash;t&quot;
l_string|&quot;popl %%gs&bslash;n&bslash;t&quot;
l_string|&quot;popl %%fs&bslash;n&bslash;t&quot;
l_string|&quot;popl %%es&bslash;n&bslash;t&quot;
l_string|&quot;popl %%ds&bslash;n&bslash;t&quot;
l_string|&quot;popl %%esi&bslash;n&bslash;t&quot;
l_string|&quot;popl %%edi&bslash;n&bslash;t&quot;
l_string|&quot;popl %%ebp&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=a&quot;
(paren
id|status
)paren
suffix:colon
l_string|&quot;0&quot;
(paren
(paren
id|func
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|arg1
)paren
op_lshift
l_int|16
)paren
)paren
comma
l_string|&quot;b&quot;
(paren
(paren
id|arg2
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|arg3
)paren
op_lshift
l_int|16
)paren
)paren
comma
l_string|&quot;c&quot;
(paren
(paren
id|arg4
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|arg5
)paren
op_lshift
l_int|16
)paren
)paren
comma
l_string|&quot;d&quot;
(paren
(paren
id|arg6
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|arg7
)paren
op_lshift
l_int|16
)paren
)paren
comma
l_string|&quot;i&quot;
(paren
id|PNP_CS32
)paren
comma
l_string|&quot;i&quot;
(paren
l_int|0
)paren
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pnp_bios_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* If we get here and this is set then the PnP BIOS faulted on us. */
r_if
c_cond
(paren
id|pnp_bios_is_utter_crap
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PnPBIOS: Warning! Your PnP BIOS caused a fatal error. Attempting to continue&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PnPBIOS: You may need to reboot with the &bslash;&quot;nobiospnp&bslash;&quot; option to operate stably&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PnPBIOS: Check with your vendor for an updated BIOS&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; *&n; * UTILITY FUNCTIONS&n; *&n; */
DECL|function|pnpbios_warn_unexpected_status
r_static
r_void
id|pnpbios_warn_unexpected_status
c_func
(paren
r_const
r_char
op_star
id|module
comma
id|u16
id|status
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PnPBIOS: %s: Unexpected status 0x%x&bslash;n&quot;
comma
id|module
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|pnpbios_kmalloc
r_void
op_star
id|pnpbios_kmalloc
c_func
(paren
r_int
id|size
comma
r_int
id|f
)paren
(brace
r_void
op_star
id|p
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PnPBIOS: kmalloc() failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
multiline_comment|/*&n; * Call this only after init time&n; */
DECL|function|pnp_bios_present
r_static
r_int
id|pnp_bios_present
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|pnp_bios_hdr
op_ne
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&n; * PnP BIOS ACCESS FUNCTIONS&n; *&n; */
DECL|macro|PNP_GET_NUM_SYS_DEV_NODES
mdefine_line|#define PNP_GET_NUM_SYS_DEV_NODES       0x00
DECL|macro|PNP_GET_SYS_DEV_NODE
mdefine_line|#define PNP_GET_SYS_DEV_NODE            0x01
DECL|macro|PNP_SET_SYS_DEV_NODE
mdefine_line|#define PNP_SET_SYS_DEV_NODE            0x02
DECL|macro|PNP_GET_EVENT
mdefine_line|#define PNP_GET_EVENT                   0x03
DECL|macro|PNP_SEND_MESSAGE
mdefine_line|#define PNP_SEND_MESSAGE                0x04
DECL|macro|PNP_GET_DOCKING_STATION_INFORMATION
mdefine_line|#define PNP_GET_DOCKING_STATION_INFORMATION 0x05
DECL|macro|PNP_SET_STATIC_ALLOCED_RES_INFO
mdefine_line|#define PNP_SET_STATIC_ALLOCED_RES_INFO 0x09
DECL|macro|PNP_GET_STATIC_ALLOCED_RES_INFO
mdefine_line|#define PNP_GET_STATIC_ALLOCED_RES_INFO 0x0a
DECL|macro|PNP_GET_APM_ID_TABLE
mdefine_line|#define PNP_GET_APM_ID_TABLE            0x0b
DECL|macro|PNP_GET_PNP_ISA_CONFIG_STRUC
mdefine_line|#define PNP_GET_PNP_ISA_CONFIG_STRUC    0x40
DECL|macro|PNP_GET_ESCD_INFO
mdefine_line|#define PNP_GET_ESCD_INFO               0x41
DECL|macro|PNP_READ_ESCD
mdefine_line|#define PNP_READ_ESCD                   0x42
DECL|macro|PNP_WRITE_ESCD
mdefine_line|#define PNP_WRITE_ESCD                  0x43
multiline_comment|/*&n; * Call PnP BIOS with function 0x00, &quot;get number of system device nodes&quot;&n; */
DECL|function|__pnp_bios_dev_node_info
r_static
r_int
id|__pnp_bios_dev_node_info
c_func
(paren
r_struct
id|pnp_dev_node_info
op_star
id|data
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_GET_NUM_SYS_DEV_NODES
comma
l_int|0
comma
id|PNP_TS1
comma
l_int|2
comma
id|PNP_TS1
comma
id|PNP_DS
comma
l_int|0
comma
l_int|0
comma
id|data
comma
r_sizeof
(paren
r_struct
id|pnp_dev_node_info
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|data-&gt;no_nodes
op_and_assign
l_int|0xff
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|pnp_bios_dev_node_info
r_int
id|pnp_bios_dev_node_info
c_func
(paren
r_struct
id|pnp_dev_node_info
op_star
id|data
)paren
(brace
r_int
id|status
op_assign
id|__pnp_bios_dev_node_info
c_func
(paren
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|pnpbios_warn_unexpected_status
c_func
(paren
l_string|&quot;dev_node_info&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Note that some PnP BIOSes (e.g., on Sony Vaio laptops) die a horrible&n; * death if they are asked to access the &quot;current&quot; configuration.&n; * Therefore, if it&squot;s a matter of indifference, it&squot;s better to call&n; * get_dev_node() and set_dev_node() with boot=1 rather than with boot=0.&n; */
multiline_comment|/* &n; * Call PnP BIOS with function 0x01, &quot;get system device node&quot;&n; * Input: *nodenum = desired node, &n; *        boot = whether to get nonvolatile boot (!=0)&n; *               or volatile current (0) config&n; * Output: *nodenum=next node or 0xff if no more nodes&n; */
DECL|function|__pnp_bios_get_dev_node
r_static
r_int
id|__pnp_bios_get_dev_node
c_func
(paren
id|u8
op_star
id|nodenum
comma
r_char
id|boot
comma
r_struct
id|pnp_bios_node
op_star
id|data
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|boot
op_amp
id|pnpbios_dont_use_current_config
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_GET_SYS_DEV_NODE
comma
l_int|0
comma
id|PNP_TS1
comma
l_int|0
comma
id|PNP_TS2
comma
id|boot
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
id|PNP_DS
comma
l_int|0
comma
id|nodenum
comma
r_sizeof
(paren
r_char
)paren
comma
id|data
comma
l_int|65536
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|pnp_bios_get_dev_node
r_int
id|pnp_bios_get_dev_node
c_func
(paren
id|u8
op_star
id|nodenum
comma
r_char
id|boot
comma
r_struct
id|pnp_bios_node
op_star
id|data
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|__pnp_bios_get_dev_node
c_func
(paren
id|nodenum
comma
id|boot
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|pnpbios_warn_unexpected_status
c_func
(paren
l_string|&quot;get_dev_node&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Call PnP BIOS with function 0x02, &quot;set system device node&quot;&n; * Input: *nodenum = desired node, &n; *        boot = whether to set nonvolatile boot (!=0)&n; *               or volatile current (0) config&n; */
DECL|function|__pnp_bios_set_dev_node
r_static
r_int
id|__pnp_bios_set_dev_node
c_func
(paren
id|u8
id|nodenum
comma
r_char
id|boot
comma
r_struct
id|pnp_bios_node
op_star
id|data
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|boot
op_amp
id|pnpbios_dont_use_current_config
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_SET_SYS_DEV_NODE
comma
id|nodenum
comma
l_int|0
comma
id|PNP_TS1
comma
id|boot
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
id|PNP_DS
comma
l_int|0
comma
l_int|0
comma
id|data
comma
l_int|65536
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|pnp_bios_set_dev_node
r_int
id|pnp_bios_set_dev_node
c_func
(paren
id|u8
id|nodenum
comma
r_char
id|boot
comma
r_struct
id|pnp_bios_node
op_star
id|data
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|__pnp_bios_set_dev_node
c_func
(paren
id|nodenum
comma
id|boot
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|pnpbios_warn_unexpected_status
c_func
(paren
l_string|&quot;set_dev_node&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|boot
)paren
(brace
multiline_comment|/* Update devlist */
id|status
op_assign
id|pnp_bios_get_dev_node
c_func
(paren
op_amp
id|nodenum
comma
id|boot
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
macro_line|#if needed
multiline_comment|/*&n; * Call PnP BIOS with function 0x03, &quot;get event&quot;&n; */
DECL|function|pnp_bios_get_event
r_static
r_int
id|pnp_bios_get_event
c_func
(paren
id|u16
op_star
id|event
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_GET_EVENT
comma
l_int|0
comma
id|PNP_TS1
comma
id|PNP_DS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|event
comma
r_sizeof
(paren
id|u16
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if needed
multiline_comment|/* &n; * Call PnP BIOS with function 0x04, &quot;send message&quot;&n; */
DECL|function|pnp_bios_send_message
r_static
r_int
id|pnp_bios_send_message
c_func
(paren
id|u16
id|message
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_SEND_MESSAGE
comma
id|message
comma
id|PNP_DS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_HOTPLUG
multiline_comment|/*&n; * Call PnP BIOS with function 0x05, &quot;get docking station information&quot;&n; */
DECL|function|pnp_bios_dock_station_info
r_static
r_int
id|pnp_bios_dock_station_info
c_func
(paren
r_struct
id|pnp_docking_station_info
op_star
id|data
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_GET_DOCKING_STATION_INFORMATION
comma
l_int|0
comma
id|PNP_TS1
comma
id|PNP_DS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|data
comma
r_sizeof
(paren
r_struct
id|pnp_docking_station_info
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if needed
multiline_comment|/*&n; * Call PnP BIOS with function 0x09, &quot;set statically allocated resource&n; * information&quot;&n; */
DECL|function|pnp_bios_set_stat_res
r_static
r_int
id|pnp_bios_set_stat_res
c_func
(paren
r_char
op_star
id|info
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_SET_STATIC_ALLOCED_RES_INFO
comma
l_int|0
comma
id|PNP_TS1
comma
id|PNP_DS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|info
comma
op_star
(paren
(paren
id|u16
op_star
)paren
id|info
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Call PnP BIOS with function 0x0a, &quot;get statically allocated resource&n; * information&quot;&n; */
DECL|function|__pnp_bios_get_stat_res
r_static
r_int
id|__pnp_bios_get_stat_res
c_func
(paren
r_char
op_star
id|info
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_GET_STATIC_ALLOCED_RES_INFO
comma
l_int|0
comma
id|PNP_TS1
comma
id|PNP_DS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|info
comma
l_int|65536
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|pnp_bios_get_stat_res
r_int
id|pnp_bios_get_stat_res
c_func
(paren
r_char
op_star
id|info
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|__pnp_bios_get_stat_res
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|pnpbios_warn_unexpected_status
c_func
(paren
l_string|&quot;get_stat_res&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#if needed
multiline_comment|/*&n; * Call PnP BIOS with function 0x0b, &quot;get APM id table&quot;&n; */
DECL|function|pnp_bios_apm_id_table
r_static
r_int
id|pnp_bios_apm_id_table
c_func
(paren
r_char
op_star
id|table
comma
id|u16
op_star
id|size
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_GET_APM_ID_TABLE
comma
l_int|0
comma
id|PNP_TS2
comma
l_int|0
comma
id|PNP_TS1
comma
id|PNP_DS
comma
l_int|0
comma
l_int|0
comma
id|table
comma
op_star
id|size
comma
id|size
comma
r_sizeof
(paren
id|u16
)paren
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Call PnP BIOS with function 0x40, &quot;get isa pnp configuration structure&quot;&n; */
DECL|function|__pnp_bios_isapnp_config
r_static
r_int
id|__pnp_bios_isapnp_config
c_func
(paren
r_struct
id|pnp_isa_config_struc
op_star
id|data
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_GET_PNP_ISA_CONFIG_STRUC
comma
l_int|0
comma
id|PNP_TS1
comma
id|PNP_DS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|data
comma
r_sizeof
(paren
r_struct
id|pnp_isa_config_struc
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|pnp_bios_isapnp_config
r_int
id|pnp_bios_isapnp_config
c_func
(paren
r_struct
id|pnp_isa_config_struc
op_star
id|data
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|__pnp_bios_isapnp_config
c_func
(paren
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|pnpbios_warn_unexpected_status
c_func
(paren
l_string|&quot;isapnp_config&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Call PnP BIOS with function 0x41, &quot;get ESCD info&quot;&n; */
DECL|function|__pnp_bios_escd_info
r_static
r_int
id|__pnp_bios_escd_info
c_func
(paren
r_struct
id|escd_info_struc
op_star
id|data
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|ESCD_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_GET_ESCD_INFO
comma
l_int|0
comma
id|PNP_TS1
comma
l_int|2
comma
id|PNP_TS1
comma
l_int|4
comma
id|PNP_TS1
comma
id|PNP_DS
comma
id|data
comma
r_sizeof
(paren
r_struct
id|escd_info_struc
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|pnp_bios_escd_info
r_int
id|pnp_bios_escd_info
c_func
(paren
r_struct
id|escd_info_struc
op_star
id|data
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|__pnp_bios_escd_info
c_func
(paren
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|pnpbios_warn_unexpected_status
c_func
(paren
l_string|&quot;escd_info&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Call PnP BIOS function 0x42, &quot;read ESCD&quot;&n; * nvram_base is determined by calling escd_info&n; */
DECL|function|__pnp_bios_read_escd
r_static
r_int
id|__pnp_bios_read_escd
c_func
(paren
r_char
op_star
id|data
comma
id|u32
id|nvram_base
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|ESCD_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_READ_ESCD
comma
l_int|0
comma
id|PNP_TS1
comma
id|PNP_TS2
comma
id|PNP_DS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|data
comma
l_int|65536
comma
(paren
r_void
op_star
)paren
id|nvram_base
comma
l_int|65536
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|pnp_bios_read_escd
r_int
id|pnp_bios_read_escd
c_func
(paren
r_char
op_star
id|data
comma
id|u32
id|nvram_base
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|__pnp_bios_read_escd
c_func
(paren
id|data
comma
id|nvram_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|pnpbios_warn_unexpected_status
c_func
(paren
l_string|&quot;read_escd&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#if needed
multiline_comment|/*&n; * Call PnP BIOS function 0x43, &quot;write ESCD&quot;&n; */
DECL|function|pnp_bios_write_escd
r_static
r_int
id|pnp_bios_write_escd
c_func
(paren
r_char
op_star
id|data
comma
id|u32
id|nvram_base
)paren
(brace
id|u16
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
id|ESCD_FUNCTION_NOT_SUPPORTED
suffix:semicolon
id|status
op_assign
id|call_pnp_bios
c_func
(paren
id|PNP_WRITE_ESCD
comma
l_int|0
comma
id|PNP_TS1
comma
id|PNP_TS2
comma
id|PNP_DS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|data
comma
l_int|65536
comma
id|nvram_base
comma
l_int|65536
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *&n; * DOCKING FUNCTIONS&n; *&n; */
macro_line|#ifdef CONFIG_HOTPLUG
DECL|variable|unloading
r_static
r_int
id|unloading
op_assign
l_int|0
suffix:semicolon
DECL|variable|unload_sem
r_static
r_struct
id|completion
id|unload_sem
suffix:semicolon
multiline_comment|/*&n; * (Much of this belongs in a shared routine somewhere)&n; */
DECL|function|pnp_dock_event
r_static
r_int
id|pnp_dock_event
c_func
(paren
r_int
id|dock
comma
r_struct
id|pnp_docking_station_info
op_star
id|info
)paren
(brace
r_char
op_star
id|argv
(braket
l_int|3
)braket
comma
op_star
op_star
id|envp
comma
op_star
id|buf
comma
op_star
id|scratch
suffix:semicolon
r_int
id|i
op_assign
l_int|0
comma
id|value
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hotplug_path
(braket
l_int|0
)braket
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|current-&gt;fs-&gt;root
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|envp
op_assign
(paren
r_char
op_star
op_star
)paren
id|pnpbios_kmalloc
(paren
l_int|20
op_star
r_sizeof
(paren
r_char
op_star
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf
op_assign
id|pnpbios_kmalloc
(paren
l_int|256
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|kfree
(paren
id|envp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* only one standardized param to hotplug command: type */
id|argv
(braket
l_int|0
)braket
op_assign
id|hotplug_path
suffix:semicolon
id|argv
(braket
l_int|1
)braket
op_assign
l_string|&quot;dock&quot;
suffix:semicolon
id|argv
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* minimal command environment */
id|envp
(braket
id|i
op_increment
)braket
op_assign
l_string|&quot;HOME=/&quot;
suffix:semicolon
id|envp
(braket
id|i
op_increment
)braket
op_assign
l_string|&quot;PATH=/sbin:/bin:/usr/sbin:/usr/bin&quot;
suffix:semicolon
macro_line|#ifdef&t;DEBUG
multiline_comment|/* hint that policy agent should enter no-stdout debug mode */
id|envp
(braket
id|i
op_increment
)braket
op_assign
l_string|&quot;DEBUG=kernel&quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/* extensible set of named bus-specific parameters,&n;&t; * supporting multiple driver selection algorithms.&n;&t; */
id|scratch
op_assign
id|buf
suffix:semicolon
multiline_comment|/* action:  add, remove */
id|envp
(braket
id|i
op_increment
)braket
op_assign
id|scratch
suffix:semicolon
id|scratch
op_add_assign
id|sprintf
(paren
id|scratch
comma
l_string|&quot;ACTION=%s&quot;
comma
id|dock
ques
c_cond
l_string|&quot;add&quot;
suffix:colon
l_string|&quot;remove&quot;
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Report the ident for the dock */
id|envp
(braket
id|i
op_increment
)braket
op_assign
id|scratch
suffix:semicolon
id|scratch
op_add_assign
id|sprintf
(paren
id|scratch
comma
l_string|&quot;DOCK=%x/%x/%x&quot;
comma
id|info-&gt;location_id
comma
id|info-&gt;serial
comma
id|info-&gt;capabilities
)paren
suffix:semicolon
id|envp
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|value
op_assign
id|call_usermodehelper
(paren
id|argv
(braket
l_int|0
)braket
comma
id|argv
comma
id|envp
)paren
suffix:semicolon
id|kfree
(paren
id|buf
)paren
suffix:semicolon
id|kfree
(paren
id|envp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Poll the PnP docking at regular intervals&n; */
DECL|function|pnp_dock_thread
r_static
r_int
id|pnp_dock_thread
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
r_static
r_struct
id|pnp_docking_station_info
id|now
suffix:semicolon
r_int
id|docked
op_assign
op_minus
l_int|1
comma
id|d
op_assign
l_int|0
suffix:semicolon
id|daemonize
c_func
(paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|current-&gt;comm
comma
l_string|&quot;kpnpbiosd&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|unloading
op_logical_and
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_int
id|status
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Poll every 2 seconds&n;&t;&t; */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_star
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|status
op_assign
id|pnp_bios_dock_station_info
c_func
(paren
op_amp
id|now
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * No dock to manage&n;&t;&t;&t; */
r_case
id|PNP_FUNCTION_NOT_SUPPORTED
suffix:colon
id|complete_and_exit
c_func
(paren
op_amp
id|unload_sem
comma
l_int|0
)paren
suffix:semicolon
r_case
id|PNP_SYSTEM_NOT_DOCKED
suffix:colon
id|d
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PNP_SUCCESS
suffix:colon
id|d
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|pnpbios_warn_unexpected_status
c_func
(paren
l_string|&quot;pnp_dock_thread&quot;
comma
id|status
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d
op_ne
id|docked
)paren
(brace
r_if
c_cond
(paren
id|pnp_dock_event
c_func
(paren
id|d
comma
op_amp
id|now
)paren
op_eq
l_int|0
)paren
(brace
id|docked
op_assign
id|d
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PnPBIOS: Docking station %stached&bslash;n&quot;
comma
id|docked
ques
c_cond
l_string|&quot;at&quot;
suffix:colon
l_string|&quot;de&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
)brace
id|complete_and_exit
c_func
(paren
op_amp
id|unload_sem
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif   /* CONFIG_HOTPLUG */
multiline_comment|/* pnp current resource reading functions */
DECL|function|add_irqresource
r_static
r_void
id|add_irqresource
c_func
(paren
r_struct
id|pnp_dev
op_star
id|dev
comma
r_int
id|irq
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|dev-&gt;irq_resource
(braket
id|i
)braket
dot
id|flags
op_amp
id|IORESOURCE_UNSET
)paren
op_logical_and
id|i
OL
id|DEVICE_COUNT_IRQ
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|DEVICE_COUNT_IRQ
)paren
(brace
id|dev-&gt;irq_resource
(braket
id|i
)braket
dot
id|start
op_assign
(paren
r_int
r_int
)paren
id|irq
suffix:semicolon
id|dev-&gt;irq_resource
(braket
id|i
)braket
dot
id|flags
op_assign
id|IORESOURCE_IRQ
suffix:semicolon
singleline_comment|// Also clears _UNSET flag
)brace
)brace
DECL|function|add_dmaresource
r_static
r_void
id|add_dmaresource
c_func
(paren
r_struct
id|pnp_dev
op_star
id|dev
comma
r_int
id|dma
)paren
(brace
r_int
id|i
op_assign
l_int|8
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|dev-&gt;dma_resource
(braket
id|i
)braket
dot
id|flags
op_amp
id|IORESOURCE_UNSET
)paren
op_logical_and
id|i
OL
id|DEVICE_COUNT_DMA
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|DEVICE_COUNT_DMA
)paren
(brace
id|dev-&gt;dma_resource
(braket
id|i
)braket
dot
id|start
op_assign
(paren
r_int
r_int
)paren
id|dma
suffix:semicolon
id|dev-&gt;dma_resource
(braket
id|i
)braket
dot
id|flags
op_assign
id|IORESOURCE_DMA
suffix:semicolon
singleline_comment|// Also clears _UNSET flag
)brace
)brace
DECL|function|add_ioresource
r_static
r_void
id|add_ioresource
c_func
(paren
r_struct
id|pnp_dev
op_star
id|dev
comma
r_int
id|io
comma
r_int
id|len
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_amp
id|IORESOURCE_UNSET
)paren
op_logical_and
id|i
OL
id|DEVICE_COUNT_RESOURCE
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|DEVICE_COUNT_RESOURCE
)paren
(brace
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
(paren
r_int
r_int
)paren
id|io
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_assign
(paren
r_int
r_int
)paren
(paren
id|io
op_plus
id|len
op_minus
l_int|1
)paren
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
singleline_comment|// Also clears _UNSET flag
)brace
)brace
DECL|function|add_memresource
r_static
r_void
id|add_memresource
c_func
(paren
r_struct
id|pnp_dev
op_star
id|dev
comma
r_int
id|mem
comma
r_int
id|len
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_amp
id|IORESOURCE_UNSET
)paren
op_logical_and
id|i
OL
id|DEVICE_COUNT_RESOURCE
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|DEVICE_COUNT_RESOURCE
)paren
(brace
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_assign
(paren
r_int
r_int
)paren
(paren
id|mem
op_plus
id|len
op_minus
l_int|1
)paren
suffix:semicolon
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
singleline_comment|// Also clears _UNSET flag
)brace
)brace
DECL|function|node_current_resource_data_to_dev
r_static
r_int
r_char
op_star
id|node_current_resource_data_to_dev
c_func
(paren
r_struct
id|pnp_bios_node
op_star
id|node
comma
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_int
r_char
op_star
id|p
op_assign
id|node-&gt;data
comma
op_star
id|lastp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * First, set resource info to default values&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEVICE_COUNT_RESOURCE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_assign
l_int|0
suffix:semicolon
singleline_comment|// &quot;disabled&quot;
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_assign
id|IORESOURCE_UNSET
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEVICE_COUNT_IRQ
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;irq_resource
(braket
id|i
)braket
dot
id|start
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
singleline_comment|// &quot;disabled&quot;
id|dev-&gt;irq_resource
(braket
id|i
)braket
dot
id|flags
op_assign
id|IORESOURCE_UNSET
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEVICE_COUNT_DMA
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;dma_resource
(braket
id|i
)braket
dot
id|start
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
singleline_comment|// &quot;disabled&quot;
id|dev-&gt;dma_resource
(braket
id|i
)braket
dot
id|flags
op_assign
id|IORESOURCE_UNSET
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Fill in dev resource info&n;&t; */
r_while
c_loop
(paren
(paren
r_char
op_star
)paren
id|p
OL
(paren
(paren
r_char
op_star
)paren
id|node-&gt;data
op_plus
id|node-&gt;size
)paren
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|lastp
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
(brace
singleline_comment|// large item
r_switch
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x7f
)paren
(brace
r_case
l_int|0x01
suffix:colon
singleline_comment|// memory
(brace
r_int
id|io
op_assign
op_star
(paren
r_int
op_star
)paren
op_amp
id|p
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|len
op_assign
op_star
(paren
r_int
op_star
)paren
op_amp
id|p
(braket
l_int|10
)braket
suffix:semicolon
id|add_memresource
c_func
(paren
id|dev
comma
id|io
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x02
suffix:colon
singleline_comment|// device name
(brace
r_int
id|len
op_assign
op_star
(paren
r_int
op_star
)paren
op_amp
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;name
comma
id|p
op_plus
l_int|3
comma
id|len
op_ge
l_int|80
ques
c_cond
l_int|79
suffix:colon
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x05
suffix:colon
singleline_comment|// 32-bit memory
(brace
r_int
id|io
op_assign
op_star
(paren
r_int
op_star
)paren
op_amp
id|p
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|len
op_assign
op_star
(paren
r_int
op_star
)paren
op_amp
id|p
(braket
l_int|16
)braket
suffix:semicolon
id|add_memresource
c_func
(paren
id|dev
comma
id|io
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x06
suffix:colon
singleline_comment|// fixed location 32-bit memory
(brace
r_int
id|io
op_assign
op_star
(paren
r_int
op_star
)paren
op_amp
id|p
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|len
op_assign
op_star
(paren
r_int
op_star
)paren
op_amp
id|p
(braket
l_int|8
)braket
suffix:semicolon
id|add_memresource
c_func
(paren
id|dev
comma
id|io
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* switch */
id|lastp
op_assign
id|p
op_plus
l_int|3
suffix:semicolon
id|p
op_assign
id|p
op_plus
id|p
(braket
l_int|1
)braket
op_plus
id|p
(braket
l_int|2
)braket
op_star
l_int|256
op_plus
l_int|3
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|p
(braket
l_int|0
)braket
op_rshift
l_int|3
)paren
op_eq
l_int|0x0f
)paren
(brace
singleline_comment|// end tag
id|p
op_assign
id|p
op_plus
l_int|2
suffix:semicolon
r_goto
id|end
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_rshift
l_int|3
)paren
(brace
r_case
l_int|0x04
suffix:colon
singleline_comment|// irq
(brace
r_int
id|i
comma
id|mask
comma
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|mask
op_assign
id|p
(braket
l_int|1
)braket
op_plus
id|p
(braket
l_int|2
)braket
op_star
l_int|256
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
comma
id|mask
op_assign
id|mask
op_rshift
l_int|1
)paren
r_if
c_cond
(paren
id|mask
op_amp
l_int|0x01
)paren
(brace
id|irq
op_assign
id|i
suffix:semicolon
)brace
id|add_irqresource
c_func
(paren
id|dev
comma
id|irq
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x05
suffix:colon
singleline_comment|// dma
(brace
r_int
id|i
comma
id|mask
comma
id|dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|mask
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|mask
op_assign
id|mask
op_rshift
l_int|1
)paren
r_if
c_cond
(paren
id|mask
op_amp
l_int|0x01
)paren
(brace
id|dma
op_assign
id|i
suffix:semicolon
)brace
id|add_dmaresource
c_func
(paren
id|dev
comma
id|dma
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x08
suffix:colon
singleline_comment|// io
(brace
r_int
id|io
op_assign
id|p
(braket
l_int|2
)braket
op_plus
id|p
(braket
l_int|3
)braket
op_star
l_int|256
suffix:semicolon
r_int
id|len
op_assign
id|p
(braket
l_int|7
)braket
suffix:semicolon
id|add_ioresource
c_func
(paren
id|dev
comma
id|io
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x09
suffix:colon
singleline_comment|// fixed location io
(brace
r_int
id|io
op_assign
id|p
(braket
l_int|1
)braket
op_plus
id|p
(braket
l_int|2
)braket
op_star
l_int|256
suffix:semicolon
r_int
id|len
op_assign
id|p
(braket
l_int|3
)braket
suffix:semicolon
id|add_ioresource
c_func
(paren
id|dev
comma
id|io
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* switch */
id|lastp
op_assign
id|p
op_plus
l_int|1
suffix:semicolon
id|p
op_assign
id|p
op_plus
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x07
)paren
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* while */
id|end
suffix:colon
r_if
c_cond
(paren
(paren
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_eq
l_int|0
)paren
op_logical_and
(paren
id|dev-&gt;irq_resource
(braket
l_int|0
)braket
dot
id|start
op_eq
op_minus
l_int|1
)paren
op_logical_and
(paren
id|dev-&gt;dma_resource
(braket
l_int|0
)braket
dot
id|start
op_eq
op_minus
l_int|1
)paren
)paren
id|dev-&gt;active
op_assign
l_int|0
suffix:semicolon
r_else
id|dev-&gt;active
op_assign
l_int|1
suffix:semicolon
r_return
(paren
r_int
r_char
op_star
)paren
id|p
suffix:semicolon
)brace
multiline_comment|/* pnp possible resource reading functions */
DECL|function|read_lgtag_mem
r_static
r_void
id|read_lgtag_mem
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_int
id|depnum
comma
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_struct
id|pnp_mem
op_star
id|mem
suffix:semicolon
id|mem
op_assign
id|pnpbios_kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pnp_mem
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pnp_mem
)paren
)paren
suffix:semicolon
id|mem-&gt;min
op_assign
(paren
(paren
id|p
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|p
(braket
l_int|2
)braket
)paren
op_lshift
l_int|8
suffix:semicolon
id|mem-&gt;max
op_assign
(paren
(paren
id|p
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|p
(braket
l_int|4
)braket
)paren
op_lshift
l_int|8
suffix:semicolon
id|mem-&gt;align
op_assign
(paren
id|p
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
op_or
id|p
(braket
l_int|6
)braket
suffix:semicolon
id|mem-&gt;size
op_assign
(paren
(paren
id|p
(braket
l_int|9
)braket
op_lshift
l_int|8
)paren
op_or
id|p
(braket
l_int|8
)braket
)paren
op_lshift
l_int|8
suffix:semicolon
id|mem-&gt;flags
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|pnp_add_mem_resource
c_func
(paren
id|dev
comma
id|depnum
comma
id|mem
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|read_lgtag_mem32
r_static
r_void
id|read_lgtag_mem32
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_int
id|depnum
comma
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_struct
id|pnp_mem32
op_star
id|mem
suffix:semicolon
id|mem
op_assign
id|pnpbios_kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pnp_mem32
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pnp_mem32
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mem-&gt;data
comma
id|p
comma
l_int|17
)paren
suffix:semicolon
id|pnp_add_mem32_resource
c_func
(paren
id|dev
comma
id|depnum
comma
id|mem
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|read_lgtag_fmem32
r_static
r_void
id|read_lgtag_fmem32
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_int
id|depnum
comma
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_struct
id|pnp_mem32
op_star
id|mem
suffix:semicolon
id|mem
op_assign
id|pnpbios_kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pnp_mem32
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pnp_mem32
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|mem-&gt;data
comma
id|p
comma
l_int|17
)paren
suffix:semicolon
id|pnp_add_mem32_resource
c_func
(paren
id|dev
comma
id|depnum
comma
id|mem
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|read_smtag_irq
r_static
r_void
id|read_smtag_irq
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_int
id|depnum
comma
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_struct
id|pnp_irq
op_star
id|irq
suffix:semicolon
id|irq
op_assign
id|pnpbios_kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pnp_irq
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|irq
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pnp_irq
)paren
)paren
suffix:semicolon
id|irq-&gt;map
op_assign
(paren
id|p
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|p
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
l_int|2
)paren
id|irq-&gt;flags
op_assign
id|p
(braket
l_int|3
)braket
suffix:semicolon
id|pnp_add_irq_resource
c_func
(paren
id|dev
comma
id|depnum
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|read_smtag_dma
r_static
r_void
id|read_smtag_dma
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_int
id|depnum
comma
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_struct
id|pnp_dma
op_star
id|dma
suffix:semicolon
id|dma
op_assign
id|pnpbios_kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pnp_dma
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|dma
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pnp_dma
)paren
)paren
suffix:semicolon
id|dma-&gt;map
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|dma-&gt;flags
op_assign
id|p
(braket
l_int|2
)braket
suffix:semicolon
id|pnp_add_dma_resource
c_func
(paren
id|dev
comma
id|depnum
comma
id|dma
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|read_smtag_port
r_static
r_void
id|read_smtag_port
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_int
id|depnum
comma
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_struct
id|pnp_port
op_star
id|port
suffix:semicolon
id|port
op_assign
id|pnpbios_kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pnp_port
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|port
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pnp_port
)paren
)paren
suffix:semicolon
id|port-&gt;min
op_assign
(paren
id|p
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|p
(braket
l_int|2
)braket
suffix:semicolon
id|port-&gt;max
op_assign
(paren
id|p
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_or
id|p
(braket
l_int|4
)braket
suffix:semicolon
id|port-&gt;align
op_assign
id|p
(braket
l_int|6
)braket
suffix:semicolon
id|port-&gt;size
op_assign
id|p
(braket
l_int|7
)braket
suffix:semicolon
id|port-&gt;flags
op_assign
id|p
(braket
l_int|1
)braket
ques
c_cond
id|PNP_PORT_FLAG_16BITADDR
suffix:colon
l_int|0
suffix:semicolon
id|pnp_add_port_resource
c_func
(paren
id|dev
comma
id|depnum
comma
id|port
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|read_smtag_fport
r_static
r_void
id|read_smtag_fport
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_int
id|depnum
comma
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_struct
id|pnp_port
op_star
id|port
suffix:semicolon
id|port
op_assign
id|pnpbios_kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pnp_port
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|port
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pnp_port
)paren
)paren
suffix:semicolon
id|port-&gt;min
op_assign
id|port-&gt;max
op_assign
(paren
id|p
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|port-&gt;size
op_assign
id|p
(braket
l_int|3
)braket
suffix:semicolon
id|port-&gt;align
op_assign
l_int|0
suffix:semicolon
id|port-&gt;flags
op_assign
id|PNP_PORT_FLAG_FIXED
suffix:semicolon
id|pnp_add_port_resource
c_func
(paren
id|dev
comma
id|depnum
comma
id|port
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|node_possible_resource_data_to_dev
r_static
r_int
r_char
op_star
id|node_possible_resource_data_to_dev
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_struct
id|pnp_bios_node
op_star
id|node
comma
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_int
r_char
op_star
id|lastp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|len
comma
id|depnum
comma
id|dependent
suffix:semicolon
r_if
c_cond
(paren
(paren
r_char
op_star
)paren
id|p
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pnp_build_resource
c_func
(paren
id|dev
comma
l_int|0
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|depnum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*this is the first so it should be 0 */
id|dependent
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
r_char
op_star
)paren
id|p
OL
(paren
(paren
r_char
op_star
)paren
id|node-&gt;data
op_plus
id|node-&gt;size
)paren
)paren
(brace
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
(brace
singleline_comment|// large item
id|len
op_assign
(paren
id|p
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|p
(braket
l_int|1
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x7f
)paren
(brace
r_case
l_int|0x01
suffix:colon
singleline_comment|// memory
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|9
)paren
r_goto
id|__skip
suffix:semicolon
id|read_lgtag_mem
c_func
(paren
id|p
comma
id|len
comma
id|depnum
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x05
suffix:colon
singleline_comment|// 32-bit memory
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|17
)paren
r_goto
id|__skip
suffix:semicolon
id|read_lgtag_mem32
c_func
(paren
id|p
comma
id|len
comma
id|depnum
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x06
suffix:colon
singleline_comment|// fixed location 32-bit memory
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|17
)paren
r_goto
id|__skip
suffix:semicolon
id|read_lgtag_fmem32
c_func
(paren
id|p
comma
id|len
comma
id|depnum
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* switch */
id|lastp
op_assign
id|p
op_plus
l_int|3
suffix:semicolon
id|p
op_assign
id|p
op_plus
id|p
(braket
l_int|1
)braket
op_plus
id|p
(braket
l_int|2
)braket
op_star
l_int|256
op_plus
l_int|3
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|len
op_assign
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x07
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|p
(braket
l_int|0
)braket
op_rshift
l_int|3
)paren
op_amp
l_int|0x0f
)paren
(brace
r_case
l_int|0x0f
suffix:colon
(brace
id|p
op_assign
id|p
op_plus
l_int|2
suffix:semicolon
r_return
(paren
r_int
r_char
op_star
)paren
id|p
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x04
suffix:colon
singleline_comment|// irq
(brace
r_if
c_cond
(paren
id|len
template_param
l_int|3
)paren
r_goto
id|__skip
suffix:semicolon
id|read_smtag_irq
c_func
(paren
id|p
comma
id|len
comma
id|depnum
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x05
suffix:colon
singleline_comment|// dma
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|2
)paren
r_goto
id|__skip
suffix:semicolon
id|read_smtag_dma
c_func
(paren
id|p
comma
id|len
comma
id|depnum
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x06
suffix:colon
singleline_comment|// start dep
(brace
r_if
c_cond
(paren
id|len
OG
l_int|1
)paren
r_goto
id|__skip
suffix:semicolon
id|dependent
op_assign
l_int|0x100
op_or
id|PNP_RES_PRIORITY_ACCEPTABLE
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
id|dependent
op_assign
l_int|0x100
op_or
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|pnp_build_resource
c_func
(paren
id|dev
comma
id|dependent
)paren
suffix:semicolon
id|depnum
op_assign
id|pnp_get_max_depnum
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x07
suffix:colon
singleline_comment|// end dep
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|0
)paren
r_goto
id|__skip
suffix:semicolon
id|depnum
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x08
suffix:colon
singleline_comment|// io
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|7
)paren
r_goto
id|__skip
suffix:semicolon
id|read_smtag_port
c_func
(paren
id|p
comma
id|len
comma
id|depnum
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x09
suffix:colon
singleline_comment|// fixed location io
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|3
)paren
r_goto
id|__skip
suffix:semicolon
id|read_smtag_fport
c_func
(paren
id|p
comma
id|len
comma
id|depnum
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* switch */
id|__skip
suffix:colon
id|p
op_add_assign
id|len
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* while */
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* pnp resource writing functions */
DECL|function|write_lgtag_mem
r_static
r_void
id|write_lgtag_mem
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_struct
id|pnp_mem
op_star
id|mem
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
suffix:semicolon
id|p
(braket
l_int|2
)braket
op_assign
(paren
id|mem-&gt;min
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|3
)braket
op_assign
(paren
(paren
id|mem-&gt;min
op_rshift
l_int|8
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|4
)braket
op_assign
(paren
id|mem-&gt;max
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|5
)braket
op_assign
(paren
(paren
id|mem-&gt;max
op_rshift
l_int|8
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|6
)braket
op_assign
id|mem-&gt;align
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|7
)braket
op_assign
(paren
id|mem-&gt;align
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|8
)braket
op_assign
(paren
id|mem-&gt;size
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|9
)braket
op_assign
(paren
(paren
id|mem-&gt;size
op_rshift
l_int|8
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|1
)braket
op_assign
id|mem-&gt;flags
op_amp
l_int|0xff
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|write_smtag_irq
r_static
r_void
id|write_smtag_irq
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_struct
id|pnp_irq
op_star
id|irq
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|irq
)paren
r_return
suffix:semicolon
id|p
(braket
l_int|1
)braket
op_assign
id|irq-&gt;map
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|2
)braket
op_assign
(paren
id|irq-&gt;map
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
l_int|2
)paren
id|p
(braket
l_int|3
)braket
op_assign
id|irq-&gt;flags
op_amp
l_int|0xff
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|write_smtag_dma
r_static
r_void
id|write_smtag_dma
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_struct
id|pnp_dma
op_star
id|dma
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dma
)paren
r_return
suffix:semicolon
id|p
(braket
l_int|1
)braket
op_assign
id|dma-&gt;map
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|2
)braket
op_assign
id|dma-&gt;flags
op_amp
l_int|0xff
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|write_smtag_port
r_static
r_void
id|write_smtag_port
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_struct
id|pnp_port
op_star
id|port
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
r_return
suffix:semicolon
id|p
(braket
l_int|2
)braket
op_assign
id|port-&gt;min
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|3
)braket
op_assign
(paren
id|port-&gt;min
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|4
)braket
op_assign
id|port-&gt;max
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|5
)braket
op_assign
(paren
id|port-&gt;max
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|6
)braket
op_assign
id|port-&gt;align
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|7
)braket
op_assign
id|port-&gt;size
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|1
)braket
op_assign
id|port-&gt;flags
op_amp
l_int|0xff
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|write_smtag_fport
r_static
r_void
id|write_smtag_fport
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|size
comma
r_struct
id|pnp_port
op_star
id|port
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
r_return
suffix:semicolon
id|p
(braket
l_int|1
)braket
op_assign
id|port-&gt;min
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|2
)braket
op_assign
(paren
id|port-&gt;min
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|p
(braket
l_int|3
)braket
op_assign
id|port-&gt;size
op_amp
l_int|0xff
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|node_set_resources
r_static
r_int
id|node_set_resources
c_func
(paren
r_struct
id|pnp_bios_node
op_star
id|node
comma
r_struct
id|pnp_cfg
op_star
id|config
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|p
op_assign
(paren
r_char
op_star
)paren
id|node-&gt;data
comma
op_star
id|lastp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|len
comma
id|port
op_assign
l_int|0
comma
id|irq
op_assign
l_int|0
comma
id|dma
op_assign
l_int|0
comma
id|mem
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
r_char
op_star
)paren
id|p
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_while
c_loop
(paren
(paren
r_char
op_star
)paren
id|p
OL
(paren
(paren
r_char
op_star
)paren
id|node-&gt;data
op_plus
id|node-&gt;size
)paren
)paren
(brace
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
(brace
singleline_comment|// large item
id|len
op_assign
(paren
id|p
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|p
(braket
l_int|1
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x7f
)paren
(brace
r_case
l_int|0x01
suffix:colon
singleline_comment|// memory
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|9
)paren
r_goto
id|__skip
suffix:semicolon
id|write_lgtag_mem
c_func
(paren
id|p
comma
id|len
comma
id|config-&gt;mem
(braket
id|mem
)braket
)paren
suffix:semicolon
id|mem
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x05
suffix:colon
singleline_comment|// 32-bit memory
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|17
)paren
r_goto
id|__skip
suffix:semicolon
multiline_comment|/* FIXME */
r_break
suffix:semicolon
)brace
r_case
l_int|0x06
suffix:colon
singleline_comment|// fixed location 32-bit memory
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|17
)paren
r_goto
id|__skip
suffix:semicolon
multiline_comment|/* FIXME */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* switch */
id|lastp
op_assign
id|p
op_plus
l_int|3
suffix:semicolon
id|p
op_assign
id|p
op_plus
id|p
(braket
l_int|1
)braket
op_plus
id|p
(braket
l_int|2
)braket
op_star
l_int|256
op_plus
l_int|3
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|len
op_assign
id|p
(braket
l_int|0
)braket
op_amp
l_int|0x07
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|p
(braket
l_int|0
)braket
op_rshift
l_int|3
)paren
op_amp
l_int|0x0f
)paren
(brace
r_case
l_int|0x0f
suffix:colon
(brace
r_goto
id|done
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x04
suffix:colon
singleline_comment|// irq
(brace
r_if
c_cond
(paren
id|len
template_param
l_int|3
)paren
r_goto
id|__skip
suffix:semicolon
id|write_smtag_irq
c_func
(paren
id|p
comma
id|len
comma
id|config-&gt;irq
(braket
id|irq
)braket
)paren
suffix:semicolon
id|irq
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x05
suffix:colon
singleline_comment|// dma
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|2
)paren
r_goto
id|__skip
suffix:semicolon
id|write_smtag_dma
c_func
(paren
id|p
comma
id|len
comma
id|config-&gt;dma
(braket
id|dma
)braket
)paren
suffix:semicolon
id|dma
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x08
suffix:colon
singleline_comment|// io
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|7
)paren
r_goto
id|__skip
suffix:semicolon
id|write_smtag_port
c_func
(paren
id|p
comma
id|len
comma
id|config-&gt;port
(braket
id|port
)braket
)paren
suffix:semicolon
id|port
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x09
suffix:colon
singleline_comment|// fixed location io
(brace
r_if
c_cond
(paren
id|len
op_ne
l_int|3
)paren
r_goto
id|__skip
suffix:semicolon
id|write_smtag_fport
c_func
(paren
id|p
comma
id|len
comma
id|config-&gt;port
(braket
id|port
)braket
)paren
suffix:semicolon
id|port
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* switch */
id|__skip
suffix:colon
id|p
op_add_assign
id|len
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* while */
multiline_comment|/* we never got an end tag so this data is corrupt or invalid */
r_return
op_minus
id|EINVAL
suffix:semicolon
id|done
suffix:colon
id|error
op_assign
id|pnp_bios_set_dev_node
c_func
(paren
id|node-&gt;handle
comma
(paren
r_char
)paren
l_int|0
comma
id|node
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|pnpbios_get_resources
r_static
r_int
id|pnpbios_get_resources
c_func
(paren
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_struct
id|pnp_dev_node_info
id|node_info
suffix:semicolon
id|u8
id|nodenum
op_assign
id|dev-&gt;number
suffix:semicolon
r_struct
id|pnp_bios_node
op_star
id|node
suffix:semicolon
r_if
c_cond
(paren
id|pnp_bios_dev_node_info
c_func
(paren
op_amp
id|node_info
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|node
op_assign
id|pnpbios_kmalloc
c_func
(paren
id|node_info.max_node_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pnp_bios_get_dev_node
c_func
(paren
op_amp
id|nodenum
comma
(paren
r_char
)paren
l_int|0
comma
id|node
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|node_current_resource_data_to_dev
c_func
(paren
id|node
comma
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pnpbios_set_resources
r_static
r_int
id|pnpbios_set_resources
c_func
(paren
r_struct
id|pnp_dev
op_star
id|dev
comma
r_struct
id|pnp_cfg
op_star
id|config
comma
r_char
id|flags
)paren
(brace
r_struct
id|pnp_dev_node_info
id|node_info
suffix:semicolon
id|u8
id|nodenum
op_assign
id|dev-&gt;number
suffix:semicolon
r_struct
id|pnp_bios_node
op_star
id|node
suffix:semicolon
id|node
op_assign
id|pnpbios_kmalloc
c_func
(paren
id|node_info.max_node_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pnp_bios_dev_node_info
c_func
(paren
op_amp
id|node_info
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pnp_bios_get_dev_node
c_func
(paren
op_amp
id|nodenum
comma
(paren
r_char
)paren
l_int|1
comma
id|node
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|node_set_resources
c_func
(paren
id|node
comma
id|config
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pnpbios_disable_resources
r_static
r_int
id|pnpbios_disable_resources
c_func
(paren
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_struct
id|pnp_cfg
op_star
id|config
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pnp_cfg
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* first we need to set everything to a disabled value */
r_struct
id|pnp_port
id|port
op_assign
(brace
id|max
suffix:colon
l_int|0
comma
id|min
suffix:colon
l_int|0
comma
id|align
suffix:colon
l_int|0
comma
id|size
suffix:colon
l_int|0
comma
id|flags
suffix:colon
l_int|0
comma
id|pad
suffix:colon
l_int|0
comma
)brace
suffix:semicolon
r_struct
id|pnp_mem
id|mem
op_assign
(brace
id|max
suffix:colon
l_int|0
comma
id|min
suffix:colon
l_int|0
comma
id|align
suffix:colon
l_int|0
comma
id|size
suffix:colon
l_int|0
comma
id|flags
suffix:colon
l_int|0
comma
id|pad
suffix:colon
l_int|0
comma
)brace
suffix:semicolon
r_struct
id|pnp_dma
id|dma
op_assign
(brace
id|map
suffix:colon
l_int|0
comma
id|flags
suffix:colon
l_int|0
comma
)brace
suffix:semicolon
r_struct
id|pnp_irq
id|irq
op_assign
(brace
id|map
suffix:colon
l_int|0
comma
id|flags
suffix:colon
l_int|0
comma
id|pad
suffix:colon
l_int|0
comma
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|pnp_dev_node_info
id|node_info
suffix:semicolon
id|u8
id|nodenum
op_assign
id|dev-&gt;number
suffix:semicolon
r_struct
id|pnp_bios_node
op_star
id|node
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|config
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|config
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pnp_cfg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|dev-&gt;active
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|config-&gt;port
(braket
id|i
)braket
op_assign
op_amp
id|port
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|config-&gt;mem
(braket
id|i
)braket
op_assign
op_amp
id|mem
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|config-&gt;irq
(braket
id|i
)braket
op_assign
op_amp
id|irq
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|config-&gt;dma
(braket
id|i
)braket
op_assign
op_amp
id|dma
suffix:semicolon
id|dev-&gt;active
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pnp_bios_dev_node_info
c_func
(paren
op_amp
id|node_info
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|node
op_assign
id|pnpbios_kmalloc
c_func
(paren
id|node_info.max_node_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pnp_bios_get_dev_node
c_func
(paren
op_amp
id|nodenum
comma
(paren
r_char
)paren
l_int|1
comma
id|node
)paren
)paren
r_goto
id|failed
suffix:semicolon
r_if
c_cond
(paren
id|node_set_resources
c_func
(paren
id|node
comma
id|config
)paren
OL
l_int|0
)paren
(brace
r_goto
id|failed
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|config
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed
suffix:colon
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|config
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* PnP Layer support */
DECL|variable|pnpbios_protocol
r_static
r_struct
id|pnp_protocol
id|pnpbios_protocol
op_assign
(brace
id|name
suffix:colon
l_string|&quot;Plug and Play BIOS&quot;
comma
id|get
suffix:colon
id|pnpbios_get_resources
comma
id|set
suffix:colon
id|pnpbios_set_resources
comma
id|disable
suffix:colon
id|pnpbios_disable_resources
comma
)brace
suffix:semicolon
DECL|function|insert_device
r_static
r_int
r_inline
id|insert_device
c_func
(paren
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_struct
id|list_head
op_star
id|pos
suffix:semicolon
r_struct
id|pnp_dev
op_star
id|pnp_dev
suffix:semicolon
id|list_for_each
(paren
id|pos
comma
op_amp
id|pnpbios_protocol.devices
)paren
(brace
id|pnp_dev
op_assign
id|list_entry
c_func
(paren
id|pos
comma
r_struct
id|pnp_dev
comma
id|dev_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;number
op_eq
id|pnp_dev-&gt;number
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pnp_add_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|HEX
mdefine_line|#define HEX(id,a) hex[((id)&gt;&gt;a) &amp; 15]
DECL|macro|CHAR
mdefine_line|#define CHAR(id,a) (0x40 + (((id)&gt;&gt;a) &amp; 31))
singleline_comment|//
DECL|function|pnpid32_to_pnpid
r_static
r_void
r_inline
id|pnpid32_to_pnpid
c_func
(paren
id|u32
id|id
comma
r_char
op_star
id|str
)paren
(brace
r_const
r_char
op_star
id|hex
op_assign
l_string|&quot;0123456789abcdef&quot;
suffix:semicolon
id|id
op_assign
id|be32_to_cpu
c_func
(paren
id|id
)paren
suffix:semicolon
id|str
(braket
l_int|0
)braket
op_assign
id|CHAR
c_func
(paren
id|id
comma
l_int|26
)paren
suffix:semicolon
id|str
(braket
l_int|1
)braket
op_assign
id|CHAR
c_func
(paren
id|id
comma
l_int|21
)paren
suffix:semicolon
id|str
(braket
l_int|2
)braket
op_assign
id|CHAR
c_func
(paren
id|id
comma
l_int|16
)paren
suffix:semicolon
id|str
(braket
l_int|3
)braket
op_assign
id|HEX
c_func
(paren
id|id
comma
l_int|12
)paren
suffix:semicolon
id|str
(braket
l_int|4
)braket
op_assign
id|HEX
c_func
(paren
id|id
comma
l_int|8
)paren
suffix:semicolon
id|str
(braket
l_int|5
)braket
op_assign
id|HEX
c_func
(paren
id|id
comma
l_int|4
)paren
suffix:semicolon
id|str
(braket
l_int|6
)braket
op_assign
id|HEX
c_func
(paren
id|id
comma
l_int|0
)paren
suffix:semicolon
id|str
(braket
l_int|7
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|//
DECL|macro|CHAR
macro_line|#undef CHAR
DECL|macro|HEX
macro_line|#undef HEX
DECL|function|build_devlist
r_static
r_void
id|__init
id|build_devlist
c_func
(paren
r_void
)paren
(brace
id|u8
id|nodenum
suffix:semicolon
r_char
id|id
(braket
l_int|7
)braket
suffix:semicolon
r_int
r_char
op_star
id|pos
suffix:semicolon
r_int
r_int
id|nodes_got
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|devs
op_assign
l_int|0
suffix:semicolon
r_struct
id|pnp_bios_node
op_star
id|node
suffix:semicolon
r_struct
id|pnp_dev_node_info
id|node_info
suffix:semicolon
r_struct
id|pnp_dev
op_star
id|dev
suffix:semicolon
r_struct
id|pnp_id
op_star
id|dev_id
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pnp_bios_dev_node_info
c_func
(paren
op_amp
id|node_info
)paren
op_ne
l_int|0
)paren
r_return
suffix:semicolon
id|node
op_assign
id|pnpbios_kmalloc
c_func
(paren
id|node_info.max_node_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|nodenum
op_assign
l_int|0
suffix:semicolon
id|nodenum
OL
l_int|0xff
suffix:semicolon
)paren
(brace
id|u8
id|thisnodenum
op_assign
id|nodenum
suffix:semicolon
multiline_comment|/* We build the list from the &quot;boot&quot; config because&n;&t;&t; * asking for the &quot;current&quot; config causes some&n;&t;&t; * BIOSes to crash.&n;&t;&t; */
r_if
c_cond
(paren
id|pnp_bios_get_dev_node
c_func
(paren
op_amp
id|nodenum
comma
(paren
r_char
)paren
l_int|0
comma
id|node
)paren
)paren
r_break
suffix:semicolon
id|nodes_got
op_increment
suffix:semicolon
id|dev
op_assign
id|pnpbios_kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pnp_dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_break
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pnp_dev
)paren
)paren
suffix:semicolon
id|dev_id
op_assign
id|pnpbios_kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pnp_id
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_id
)paren
r_break
suffix:semicolon
id|memset
c_func
(paren
id|dev_id
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pnp_id
)paren
)paren
suffix:semicolon
id|pnp_init_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;number
op_assign
id|thisnodenum
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;Unknown Device&quot;
comma
l_int|13
)paren
suffix:semicolon
id|dev-&gt;name
(braket
l_int|14
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|pnpid32_to_pnpid
c_func
(paren
id|node-&gt;eisa_id
comma
id|id
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dev_id-&gt;id
comma
id|id
comma
l_int|8
)paren
suffix:semicolon
id|pnp_add_id
c_func
(paren
id|dev_id
comma
id|dev
)paren
suffix:semicolon
id|pos
op_assign
id|node_current_resource_data_to_dev
c_func
(paren
id|node
comma
id|dev
)paren
suffix:semicolon
id|node_possible_resource_data_to_dev
c_func
(paren
id|pos
comma
id|node
comma
id|dev
)paren
suffix:semicolon
id|dev-&gt;protocol
op_assign
op_amp
id|pnpbios_protocol
suffix:semicolon
r_if
c_cond
(paren
id|insert_device
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
id|devs
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|nodenum
op_le
id|thisnodenum
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PnPBIOS: build_devlist: Node number 0x%x is out of sequence following node 0x%x. Aborting.&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|nodenum
comma
(paren
r_int
r_int
)paren
id|thisnodenum
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PnPBIOS: %i node%s reported by PnP BIOS; %i recorded by driver&bslash;n&quot;
comma
id|nodes_got
comma
id|nodes_got
op_ne
l_int|1
ques
c_cond
l_string|&quot;s&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|devs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&n; * INIT AND EXIT&n; *&n; */
r_extern
r_int
id|is_sony_vaio_laptop
suffix:semicolon
DECL|variable|pnpbios_disabled
r_static
r_int
id|pnpbios_disabled
suffix:semicolon
multiline_comment|/* = 0 */
DECL|variable|dont_reserve_resources
r_static
r_int
id|dont_reserve_resources
suffix:semicolon
multiline_comment|/* = 0 */
DECL|variable|pnpbios_dont_use_current_config
r_int
id|pnpbios_dont_use_current_config
suffix:semicolon
multiline_comment|/* = 0 */
macro_line|#ifndef MODULE
DECL|function|pnpbios_setup
r_static
r_int
id|__init
id|pnpbios_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|invert
suffix:semicolon
r_while
c_loop
(paren
(paren
id|str
op_ne
l_int|NULL
)paren
op_logical_and
(paren
op_star
id|str
op_ne
l_char|&squot;&bslash;0&squot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|str
comma
l_string|&quot;off&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
id|pnpbios_disabled
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|str
comma
l_string|&quot;on&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
id|pnpbios_disabled
op_assign
l_int|0
suffix:semicolon
id|invert
op_assign
(paren
id|strncmp
c_func
(paren
id|str
comma
l_string|&quot;no-&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|invert
)paren
id|str
op_add_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|str
comma
l_string|&quot;curr&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
id|pnpbios_dont_use_current_config
op_assign
id|invert
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|str
comma
l_string|&quot;res&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
id|dont_reserve_resources
op_assign
id|invert
suffix:semicolon
id|str
op_assign
id|strchr
c_func
(paren
id|str
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|str
op_ne
l_int|NULL
)paren
id|str
op_add_assign
id|strspn
c_func
(paren
id|str
comma
l_string|&quot;, &bslash;t&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;pnpbios=&quot;
comma
id|pnpbios_setup
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|pnpbios_init
id|subsys_initcall
c_func
(paren
id|pnpbios_init
)paren
suffix:semicolon
DECL|function|pnpbios_init
r_int
id|__init
id|pnpbios_init
c_func
(paren
r_void
)paren
(brace
r_union
id|pnp_bios_expansion_header
op_star
id|check
suffix:semicolon
id|u8
id|sum
suffix:semicolon
r_int
id|i
comma
id|length
comma
id|r
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|pnp_bios_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pnpbios_disabled
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PnPBIOS: Disabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_sony_vaio_laptop
)paren
id|pnpbios_dont_use_current_config
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n; &t; * Search the defined area (0xf0000-0xffff0) for a valid PnP BIOS&n;&t; * structure and, if one is found, sets up the selectors and&n;&t; * entry points&n;&t; */
r_for
c_loop
(paren
id|check
op_assign
(paren
r_union
id|pnp_bios_expansion_header
op_star
)paren
id|__va
c_func
(paren
l_int|0xf0000
)paren
suffix:semicolon
id|check
OL
(paren
r_union
id|pnp_bios_expansion_header
op_star
)paren
id|__va
c_func
(paren
l_int|0xffff0
)paren
suffix:semicolon
(paren
(paren
r_void
op_star
)paren
(paren
id|check
)paren
)paren
op_add_assign
l_int|16
)paren
(brace
r_if
c_cond
(paren
id|check-&gt;fields.signature
op_ne
id|PNP_SIGNATURE
)paren
r_continue
suffix:semicolon
id|length
op_assign
id|check-&gt;fields.length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|length
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|sum
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_increment
)paren
id|sum
op_add_assign
id|check-&gt;chars
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sum
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|check-&gt;fields.version
OL
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PnPBIOS: PnP BIOS version %d.%d is not supported&bslash;n&quot;
comma
id|check-&gt;fields.version
op_rshift
l_int|4
comma
id|check-&gt;fields.version
op_amp
l_int|15
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PnPBIOS: Found PnP BIOS installation structure at 0x%p&bslash;n&quot;
comma
id|check
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PnPBIOS: PnP BIOS version %d.%d, entry 0x%x:0x%x, dseg 0x%x&bslash;n&quot;
comma
id|check-&gt;fields.version
op_rshift
l_int|4
comma
id|check-&gt;fields.version
op_amp
l_int|15
comma
id|check-&gt;fields.pm16cseg
comma
id|check-&gt;fields.pm16offset
comma
id|check-&gt;fields.pm16dseg
)paren
suffix:semicolon
id|pnp_bios_callpoint.offset
op_assign
id|check-&gt;fields.pm16offset
suffix:semicolon
id|pnp_bios_callpoint.segment
op_assign
id|PNP_CS16
suffix:semicolon
id|pnp_bios_hdr
op_assign
id|check
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Q2_SET_SEL
c_func
(paren
id|i
comma
id|PNP_CS32
comma
op_amp
id|pnp_bios_callfunc
comma
l_int|64
op_star
l_int|1024
)paren
suffix:semicolon
id|Q_SET_SEL
c_func
(paren
id|i
comma
id|PNP_CS16
comma
id|check-&gt;fields.pm16cseg
comma
l_int|64
op_star
l_int|1024
)paren
suffix:semicolon
id|Q_SET_SEL
c_func
(paren
id|i
comma
id|PNP_DS
comma
id|check-&gt;fields.pm16dseg
comma
l_int|64
op_star
l_int|1024
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pnp_bios_present
c_func
(paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|pnp_protocol_register
c_func
(paren
op_amp
id|pnpbios_protocol
)paren
suffix:semicolon
id|build_devlist
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*if ( ! dont_reserve_resources )*/
multiline_comment|/*reserve_resources();*/
macro_line|#ifdef CONFIG_PROC_FS
id|r
op_assign
id|pnpbios_proc_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pnpbios_thread_init
r_static
r_int
id|__init
id|pnpbios_thread_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_HOTPLUG
id|init_completion
c_func
(paren
op_amp
id|unload_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kernel_thread
c_func
(paren
id|pnp_dock_thread
comma
l_int|NULL
comma
id|CLONE_KERNEL
)paren
OG
l_int|0
)paren
id|unloading
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef MODULE
multiline_comment|/* init/main.c calls pnpbios_init early */
multiline_comment|/* Start the kernel thread later: */
DECL|variable|pnpbios_thread_init
id|module_init
c_func
(paren
id|pnpbios_thread_init
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/*&n; * N.B.: Building pnpbios as a module hasn&squot;t been fully implemented&n; */
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|function|pnpbios_init_all
r_static
r_int
id|__init
id|pnpbios_init_all
c_func
(paren
r_void
)paren
(brace
r_int
id|r
suffix:semicolon
id|r
op_assign
id|pnpbios_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
id|r
op_assign
id|pnpbios_thread_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pnpbios_exit
r_static
r_void
id|__exit
id|pnpbios_exit
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_HOTPLUG
id|unloading
op_assign
l_int|1
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|unload_sem
)paren
suffix:semicolon
macro_line|#endif
id|pnpbios_proc_exit
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* We ought to free resources here */
r_return
suffix:semicolon
)brace
DECL|variable|pnpbios_init_all
id|module_init
c_func
(paren
id|pnpbios_init_all
)paren
suffix:semicolon
DECL|variable|pnpbios_exit
id|module_exit
c_func
(paren
id|pnpbios_exit
)paren
suffix:semicolon
macro_line|#endif
eof
