multiline_comment|/* $Id: tpam_crcpc.c,v 1.1.2.2 2001/09/23 22:25:03 kai Exp $&n; *&n; * Turbo PAM ISDN driver for Linux. (Kernel Driver - CRC encoding)&n; *&n; * Copyright 1998-2000 AUVERTECH T&#xfffd;l&#xfffd;com&n; * Copyright 2001 Stelian Pop &lt;stelian.pop@fr.alcove.com&gt;, Alc&#xfffd;ve&n; *&n; * This software may be used and distributed according to the terms&n; * of the GNU General Public License, incorporated herein by reference.&n; *&n; * For all support questions please contact: &lt;support@auvertech.fr&gt;&n; *&n; */
multiline_comment|/*+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++&n;&n;Module Name:&n;&n;    crcpc.c&n;&n;Abstract:&n;&n;    Modem HDLC coding&n;    Software HDLC coding / decoding&n;&n;Revision History:&n;&n;---------------------------------------------------------------------------*/
macro_line|#include &lt;linux/crc16.h&gt;
macro_line|#include &quot;tpam.h&quot;
DECL|macro|HDLC_CTRL_CHAR_CMPL_MASK
mdefine_line|#define  HDLC_CTRL_CHAR_CMPL_MASK&t;0x20&t;/* HDLC control character complement mask */
DECL|macro|HDLC_FLAG
mdefine_line|#define  HDLC_FLAG&t;&t;&t;0x7E&t;/* HDLC flag */
DECL|macro|HDLC_CTRL_ESC
mdefine_line|#define  HDLC_CTRL_ESC&t;&t;&t;0x7D&t;/* HDLC control escapr character */
DECL|macro|HDLC_LIKE_FCS_INIT_VAL
mdefine_line|#define  HDLC_LIKE_FCS_INIT_VAL&t;&t;0xFFFF&t;/* FCS initial value (0xFFFF for new equipment or 0) */
DECL|macro|HDLC_FCS_OK
mdefine_line|#define  HDLC_FCS_OK&t;&t;&t;0xF0B8&t;/* This value is the only valid value of FCS */
DECL|macro|TRUE
mdefine_line|#define TRUE&t;1
DECL|macro|FALSE
mdefine_line|#define FALSE&t;0
DECL|variable|ap_t_ctrl_char_complemented
r_static
id|u8
id|ap_t_ctrl_char_complemented
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/* list of characters to complement */
DECL|function|ap_hdlc_like_ctrl_char_list
r_static
r_void
id|ap_hdlc_like_ctrl_char_list
(paren
id|u32
id|ctrl_char
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
op_increment
id|i
)paren
id|ap_t_ctrl_char_complemented
(braket
id|i
)braket
op_assign
id|FALSE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
(paren
id|ctrl_char
op_rshift
id|i
)paren
op_amp
l_int|0x0001
)paren
id|ap_t_ctrl_char_complemented
(braket
id|i
)braket
op_assign
id|TRUE
suffix:semicolon
id|ap_t_ctrl_char_complemented
(braket
id|HDLC_FLAG
)braket
op_assign
id|TRUE
suffix:semicolon
id|ap_t_ctrl_char_complemented
(braket
id|HDLC_CTRL_ESC
)braket
op_assign
id|TRUE
suffix:semicolon
)brace
DECL|function|init_CRC
r_void
id|init_CRC
c_func
(paren
r_void
)paren
(brace
id|ap_hdlc_like_ctrl_char_list
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
)brace
DECL|function|hdlc_encode_modem
r_void
id|hdlc_encode_modem
c_func
(paren
id|u8
op_star
id|buffer_in
comma
id|u32
id|lng_in
comma
id|u8
op_star
id|buffer_out
comma
id|u32
op_star
id|lng_out
)paren
(brace
id|u16
id|fcs
suffix:semicolon
r_register
id|u8
id|data
suffix:semicolon
r_register
id|u8
op_star
id|p_data_out
op_assign
id|buffer_out
suffix:semicolon
id|fcs
op_assign
id|HDLC_LIKE_FCS_INIT_VAL
suffix:semicolon
multiline_comment|/*&n;&t; *   Insert HDLC flag at the beginning of the frame&n;&t; */
op_star
id|p_data_out
op_increment
op_assign
id|HDLC_FLAG
suffix:semicolon
DECL|macro|ESCAPE_CHAR
mdefine_line|#define ESCAPE_CHAR(data_out, data) &bslash;&n;&t;if (ap_t_ctrl_char_complemented[data]) { &bslash;&n;&t;&t;*data_out++ = HDLC_CTRL_ESC; &bslash;&n;&t;&t;*data_out++ = data ^ 0x20; &bslash;&n;&t;} &bslash;&n;&t;else &bslash;&n;&t;&t;*data_out++ = data;
r_while
c_loop
(paren
id|lng_in
op_decrement
)paren
(brace
id|data
op_assign
op_star
id|buffer_in
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; *   FCS calculation&n;&t;&t; */
id|fcs
op_assign
id|crc16_byte
c_func
(paren
id|fcs
comma
id|data
)paren
suffix:semicolon
id|ESCAPE_CHAR
c_func
(paren
id|p_data_out
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Add FCS and closing flag&n;&t; */
id|fcs
op_xor_assign
l_int|0xFFFF
suffix:semicolon
singleline_comment|// Complement
id|data
op_assign
(paren
id|u8
)paren
(paren
id|fcs
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* LSB */
id|ESCAPE_CHAR
c_func
(paren
id|p_data_out
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
(paren
id|u8
)paren
(paren
(paren
id|fcs
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* MSB */
id|ESCAPE_CHAR
c_func
(paren
id|p_data_out
comma
id|data
)paren
suffix:semicolon
DECL|macro|ESCAPE_CHAR
macro_line|#undef ESCAPE_CHAR
op_star
id|p_data_out
op_increment
op_assign
id|HDLC_FLAG
suffix:semicolon
op_star
id|lng_out
op_assign
(paren
id|u32
)paren
(paren
id|p_data_out
op_minus
id|buffer_out
)paren
suffix:semicolon
)brace
DECL|function|hdlc_no_accm_encode
r_void
id|hdlc_no_accm_encode
c_func
(paren
id|u8
op_star
id|buffer_in
comma
id|u32
id|lng_in
comma
id|u8
op_star
id|buffer_out
comma
id|u32
op_star
id|lng_out
)paren
(brace
id|u16
id|fcs
suffix:semicolon
r_register
id|u8
id|data
suffix:semicolon
r_register
id|u8
op_star
id|p_data_out
op_assign
id|buffer_out
suffix:semicolon
multiline_comment|/*&n;&t; *   Insert HDLC flag at the beginning of the frame&n;&t; */
id|fcs
op_assign
id|HDLC_LIKE_FCS_INIT_VAL
suffix:semicolon
r_while
c_loop
(paren
id|lng_in
op_decrement
)paren
(brace
id|data
op_assign
op_star
id|buffer_in
op_increment
suffix:semicolon
multiline_comment|/* calculate FCS */
id|fcs
op_assign
id|crc16_byte
c_func
(paren
id|fcs
comma
id|data
)paren
suffix:semicolon
op_star
id|p_data_out
op_increment
op_assign
id|data
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Add FCS and closing flag&n;&t; */
id|fcs
op_xor_assign
l_int|0xFFFF
suffix:semicolon
singleline_comment|// Complement
id|data
op_assign
(paren
id|u8
)paren
(paren
id|fcs
)paren
suffix:semicolon
op_star
id|p_data_out
op_increment
op_assign
id|data
suffix:semicolon
id|data
op_assign
(paren
id|u8
)paren
(paren
(paren
id|fcs
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
singleline_comment|// revense MSB / LSB
op_star
id|p_data_out
op_increment
op_assign
id|data
suffix:semicolon
op_star
id|lng_out
op_assign
(paren
id|u32
)paren
(paren
id|p_data_out
op_minus
id|buffer_out
)paren
suffix:semicolon
)brace
DECL|function|hdlc_no_accm_decode
id|u32
id|hdlc_no_accm_decode
c_func
(paren
id|u8
op_star
id|buffer_in
comma
id|u32
id|lng_in
)paren
(brace
id|u16
id|fcs
suffix:semicolon
id|u32
id|lng
op_assign
id|lng_in
suffix:semicolon
r_register
id|u8
id|data
suffix:semicolon
multiline_comment|/*&n;&t; *   Insert HDLC flag at the beginning of the frame&n;&t; */
id|fcs
op_assign
id|HDLC_LIKE_FCS_INIT_VAL
suffix:semicolon
r_while
c_loop
(paren
id|lng_in
op_decrement
)paren
(brace
id|data
op_assign
op_star
id|buffer_in
op_increment
suffix:semicolon
multiline_comment|/* calculate FCS */
id|fcs
op_assign
id|crc16_byte
c_func
(paren
id|fcs
comma
id|data
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fcs
op_eq
id|HDLC_FCS_OK
)paren
r_return
(paren
id|lng
op_minus
l_int|2
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
eof
