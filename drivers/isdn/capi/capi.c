multiline_comment|/* $Id: capi.c,v 1.1.4.1.2.2 2001/12/21 15:00:17 kai Exp $&n; *&n; * CAPI 2.0 Interface for Linux&n; *&n; * Copyright 1996 by Carsten Paeth &lt;calle@calle.de&gt;&n; *&n; * This software may be used and distributed according to the terms&n; * of the GNU General Public License, incorporated herein by reference.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#ifdef CONFIG_PPP
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/ppp_defs.h&gt;
macro_line|#include &lt;linux/if_ppp.h&gt;
macro_line|#endif /* CONFIG_PPP */
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/capi.h&gt;
macro_line|#include &lt;linux/kernelcapi.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/isdn/capiutil.h&gt;
macro_line|#include &lt;linux/isdn/capicmd.h&gt;
macro_line|#if defined(CONFIG_ISDN_CAPI_CAPIFS) || defined(CONFIG_ISDN_CAPI_CAPIFS_MODULE)
macro_line|#include &quot;capifs.h&quot;
macro_line|#endif
DECL|variable|revision
r_static
r_char
op_star
id|revision
op_assign
l_string|&quot;$Revision: 1.1.4.1.2.2 $&quot;
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;CAPI4Linux: Userspace /dev/capi20 interface&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Carsten Paeth&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|_DEBUG_REFCOUNT
macro_line|#undef _DEBUG_REFCOUNT&t;&t;/* alloc/free and open/close debug */
DECL|macro|_DEBUG_TTYFUNCS
macro_line|#undef _DEBUG_TTYFUNCS&t;&t;/* call to tty_driver */
DECL|macro|_DEBUG_DATAFLOW
macro_line|#undef _DEBUG_DATAFLOW&t;&t;/* data flow */
multiline_comment|/* -------- driver information -------------------------------------- */
DECL|variable|capi_major
r_int
id|capi_major
op_assign
l_int|68
suffix:semicolon
multiline_comment|/* allocated */
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
DECL|variable|capi_ttymajor
r_int
id|capi_ttymajor
op_assign
l_int|191
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|MODULE_PARM
c_func
(paren
id|capi_major
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
id|MODULE_PARM
c_func
(paren
id|capi_ttymajor
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
multiline_comment|/* -------- defines ------------------------------------------------- */
DECL|macro|CAPINC_MAX_RECVQUEUE
mdefine_line|#define CAPINC_MAX_RECVQUEUE&t;10
DECL|macro|CAPINC_MAX_SENDQUEUE
mdefine_line|#define CAPINC_MAX_SENDQUEUE&t;10
DECL|macro|CAPI_MAX_BLKSIZE
mdefine_line|#define CAPI_MAX_BLKSIZE&t;2048
multiline_comment|/* -------- data structures ----------------------------------------- */
r_struct
id|capidev
suffix:semicolon
r_struct
id|capincci
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_struct
id|capiminor
suffix:semicolon
DECL|struct|capiminor
r_struct
id|capiminor
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|nccip
r_struct
id|capincci
op_star
id|nccip
suffix:semicolon
DECL|member|minor
r_int
r_int
id|minor
suffix:semicolon
DECL|member|ap
r_struct
id|capi20_appl
op_star
id|ap
suffix:semicolon
DECL|member|ncci
id|u32
id|ncci
suffix:semicolon
DECL|member|datahandle
id|u16
id|datahandle
suffix:semicolon
DECL|member|msgid
id|u16
id|msgid
suffix:semicolon
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
DECL|member|ttyinstop
r_int
id|ttyinstop
suffix:semicolon
DECL|member|ttyoutstop
r_int
id|ttyoutstop
suffix:semicolon
DECL|member|ttyskb
r_struct
id|sk_buff
op_star
id|ttyskb
suffix:semicolon
DECL|member|ttyopencount
id|atomic_t
id|ttyopencount
suffix:semicolon
DECL|member|inqueue
r_struct
id|sk_buff_head
id|inqueue
suffix:semicolon
DECL|member|inbytes
r_int
id|inbytes
suffix:semicolon
DECL|member|outqueue
r_struct
id|sk_buff_head
id|outqueue
suffix:semicolon
DECL|member|outbytes
r_int
id|outbytes
suffix:semicolon
multiline_comment|/* transmit path */
DECL|struct|datahandle_queue
r_struct
id|datahandle_queue
(brace
DECL|member|next
r_struct
id|datahandle_queue
op_star
id|next
suffix:semicolon
DECL|member|datahandle
id|u16
id|datahandle
suffix:semicolon
DECL|member|ackqueue
)brace
op_star
id|ackqueue
suffix:semicolon
DECL|member|nack
r_int
id|nack
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
DECL|struct|capincci
r_struct
id|capincci
(brace
DECL|member|next
r_struct
id|capincci
op_star
id|next
suffix:semicolon
DECL|member|ncci
id|u32
id|ncci
suffix:semicolon
DECL|member|cdev
r_struct
id|capidev
op_star
id|cdev
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
DECL|member|minorp
r_struct
id|capiminor
op_star
id|minorp
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
)brace
suffix:semicolon
DECL|struct|capidev
r_struct
id|capidev
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|ap
r_struct
id|capi20_appl
id|ap
suffix:semicolon
DECL|member|errcode
id|u16
id|errcode
suffix:semicolon
DECL|member|userflags
r_int
id|userflags
suffix:semicolon
DECL|member|recvqueue
r_struct
id|sk_buff_head
id|recvqueue
suffix:semicolon
DECL|member|recvwait
id|wait_queue_head_t
id|recvwait
suffix:semicolon
DECL|member|nccis
r_struct
id|capincci
op_star
id|nccis
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* -------- global variables ---------------------------------------- */
DECL|variable|capidev_list_lock
r_static
id|rwlock_t
id|capidev_list_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|capidev_list
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
DECL|variable|capiminor_list_lock
r_static
id|rwlock_t
id|capiminor_list_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|capiminor_list
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
multiline_comment|/* -------- datahandles --------------------------------------------- */
DECL|function|capincci_add_ack
r_static
r_int
id|capincci_add_ack
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
comma
id|u16
id|datahandle
)paren
(brace
r_struct
id|datahandle_queue
op_star
id|n
comma
op_star
op_star
id|pp
suffix:semicolon
id|n
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|n
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: alloc datahandle failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|n-&gt;next
op_assign
l_int|0
suffix:semicolon
id|n-&gt;datahandle
op_assign
id|datahandle
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|mp-&gt;ackqueue
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
op_star
id|pp
op_assign
id|n
suffix:semicolon
id|mp-&gt;nack
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capiminor_del_ack
r_static
r_int
id|capiminor_del_ack
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
comma
id|u16
id|datahandle
)paren
(brace
r_struct
id|datahandle_queue
op_star
op_star
id|pp
comma
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|mp-&gt;ackqueue
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|datahandle
op_eq
id|datahandle
)paren
(brace
id|p
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
id|mp-&gt;nack
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|capiminor_del_all_ack
r_static
r_void
id|capiminor_del_all_ack
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
)paren
(brace
r_struct
id|datahandle_queue
op_star
op_star
id|pp
comma
op_star
id|p
suffix:semicolon
id|pp
op_assign
op_amp
id|mp-&gt;ackqueue
suffix:semicolon
r_while
c_loop
(paren
op_star
id|pp
)paren
(brace
id|p
op_assign
op_star
id|pp
suffix:semicolon
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
id|mp-&gt;nack
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/* -------- struct capiminor ---------------------------------------- */
DECL|function|capiminor_alloc
r_static
r_struct
id|capiminor
op_star
id|capiminor_alloc
c_func
(paren
r_struct
id|capi20_appl
op_star
id|ap
comma
id|u32
id|ncci
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
comma
op_star
id|p
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
r_int
id|minor
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|mp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mp
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: can&squot;t alloc capiminor&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capiminor_alloc %d&bslash;n&quot;
comma
id|GET_USE_COUNT
c_func
(paren
id|THIS_MODULE
)paren
)paren
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
id|mp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|capiminor
)paren
)paren
suffix:semicolon
id|mp-&gt;ap
op_assign
id|ap
suffix:semicolon
id|mp-&gt;ncci
op_assign
id|ncci
suffix:semicolon
id|mp-&gt;msgid
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
comma
l_int|0
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|mp-&gt;inqueue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|capiminor_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|capiminor_list
)paren
(brace
id|p
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|capiminor
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;minor
OG
id|minor
)paren
(brace
id|mp-&gt;minor
op_assign
id|minor
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|mp-&gt;list
comma
op_amp
id|p-&gt;list
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|minor
op_increment
suffix:semicolon
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|capiminor_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l
op_eq
op_amp
id|capiminor_list
)paren
(brace
id|kfree
c_func
(paren
id|mp
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|mp
suffix:semicolon
)brace
DECL|function|capiminor_free
r_static
r_void
id|capiminor_free
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|capiminor_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mp-&gt;list
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|capiminor_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;ttyskb
)paren
id|kfree_skb
c_func
(paren
id|mp-&gt;ttyskb
)paren
suffix:semicolon
id|mp-&gt;ttyskb
op_assign
l_int|0
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|mp-&gt;inqueue
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
suffix:semicolon
id|capiminor_del_all_ack
c_func
(paren
id|mp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mp
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capiminor_free %d&bslash;n&quot;
comma
id|GET_USE_COUNT
c_func
(paren
id|THIS_MODULE
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capiminor_find
r_struct
id|capiminor
op_star
id|capiminor_find
c_func
(paren
r_int
r_int
id|minor
)paren
(brace
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_struct
id|capiminor
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|capiminor_list_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|capiminor_list
)paren
(brace
id|p
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|capiminor
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;minor
op_eq
id|minor
)paren
r_break
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|capiminor_list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l
op_eq
op_amp
id|capiminor_list
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
multiline_comment|/* -------- struct capincci ----------------------------------------- */
DECL|function|capincci_alloc
r_static
r_struct
id|capincci
op_star
id|capincci_alloc
c_func
(paren
r_struct
id|capidev
op_star
id|cdev
comma
id|u32
id|ncci
)paren
(brace
r_struct
id|capincci
op_star
id|np
comma
op_star
op_star
id|pp
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_struct
id|capiminor
op_star
id|mp
op_assign
l_int|0
suffix:semicolon
id|kdev_t
id|kdev
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|np
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|np
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|np
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|capincci
)paren
)paren
suffix:semicolon
id|np-&gt;ncci
op_assign
id|ncci
suffix:semicolon
id|np-&gt;cdev
op_assign
id|cdev
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
id|mp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;userflags
op_amp
id|CAPIFLAG_HIGHJACKING
)paren
id|mp
op_assign
id|np-&gt;minorp
op_assign
id|capiminor_alloc
c_func
(paren
op_amp
id|cdev-&gt;ap
comma
id|ncci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp
)paren
(brace
id|mp-&gt;nccip
op_assign
id|np
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;set mp-&gt;nccip&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_ISDN_CAPI_CAPIFS) || defined(CONFIG_ISDN_CAPI_CAPIFS_MODULE)
id|kdev
op_assign
id|mk_kdev
c_func
(paren
id|capi_ttymajor
comma
id|mp-&gt;minor
)paren
suffix:semicolon
id|capifs_new_ncci
c_func
(paren
l_int|0
comma
id|mp-&gt;minor
comma
id|kdev
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
r_for
c_loop
(paren
id|pp
op_assign
op_amp
id|cdev-&gt;nccis
suffix:semicolon
op_star
id|pp
suffix:semicolon
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
op_star
id|pp
op_assign
id|np
suffix:semicolon
r_return
id|np
suffix:semicolon
)brace
DECL|function|capincci_free
r_static
r_void
id|capincci_free
c_func
(paren
r_struct
id|capidev
op_star
id|cdev
comma
id|u32
id|ncci
)paren
(brace
r_struct
id|capincci
op_star
id|np
comma
op_star
op_star
id|pp
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|pp
op_assign
op_amp
id|cdev-&gt;nccis
suffix:semicolon
r_while
c_loop
(paren
op_star
id|pp
)paren
(brace
id|np
op_assign
op_star
id|pp
suffix:semicolon
r_if
c_cond
(paren
id|ncci
op_eq
l_int|0xffffffff
op_logical_or
id|np-&gt;ncci
op_eq
id|ncci
)paren
(brace
op_star
id|pp
op_assign
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_if
c_cond
(paren
(paren
id|mp
op_assign
id|np-&gt;minorp
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#if defined(CONFIG_ISDN_CAPI_CAPIFS) || defined(CONFIG_ISDN_CAPI_CAPIFS_MODULE)
id|capifs_free_ncci
c_func
(paren
l_char|&squot;r&squot;
comma
id|mp-&gt;minor
)paren
suffix:semicolon
id|capifs_free_ncci
c_func
(paren
l_int|0
comma
id|mp-&gt;minor
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp-&gt;tty
)paren
(brace
id|mp-&gt;nccip
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;reset mp-&gt;nccip&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tty_hangup
c_func
(paren
id|mp-&gt;tty
)paren
suffix:semicolon
)brace
r_else
(brace
id|capiminor_free
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|kfree
c_func
(paren
id|np
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pp
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_else
(brace
id|pp
op_assign
op_amp
(paren
op_star
id|pp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)brace
)brace
DECL|function|capincci_find
r_static
r_struct
id|capincci
op_star
id|capincci_find
c_func
(paren
r_struct
id|capidev
op_star
id|cdev
comma
id|u32
id|ncci
)paren
(brace
r_struct
id|capincci
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|cdev-&gt;nccis
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;ncci
op_eq
id|ncci
)paren
r_break
suffix:semicolon
)brace
r_return
id|p
suffix:semicolon
)brace
multiline_comment|/* -------- struct capidev ------------------------------------------ */
DECL|function|capidev_alloc
r_static
r_struct
id|capidev
op_star
id|capidev_alloc
c_func
(paren
r_void
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|cdev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|cdev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
)paren
r_return
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|cdev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|capidev
)paren
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|capidev_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|cdev-&gt;list
comma
op_amp
id|capidev_list
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|capidev_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|cdev
suffix:semicolon
)brace
DECL|function|capidev_free
r_static
r_void
id|capidev_free
c_func
(paren
r_struct
id|capidev
op_star
id|cdev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;ap.applid
)paren
(brace
id|capi20_release
c_func
(paren
op_amp
id|cdev-&gt;ap
)paren
suffix:semicolon
id|cdev-&gt;ap.applid
op_assign
l_int|0
suffix:semicolon
)brace
id|skb_queue_purge
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|capidev_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|cdev-&gt;list
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|capidev_list_lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cdev
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
multiline_comment|/* -------- handle data queue --------------------------------------- */
r_static
r_struct
id|sk_buff
op_star
DECL|function|gen_data_b3_resp_for
id|gen_data_b3_resp_for
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
id|nskb
op_assign
id|alloc_skb
c_func
(paren
id|CAPI_DATA_B3_RESP_LEN
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nskb
)paren
(brace
id|u16
id|datahandle
op_assign
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
id|CAPIMSG_BASELEN
op_plus
l_int|4
op_plus
l_int|4
op_plus
l_int|2
)paren
suffix:semicolon
r_int
r_char
op_star
id|s
op_assign
id|skb_put
c_func
(paren
id|nskb
comma
id|CAPI_DATA_B3_RESP_LEN
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|s
comma
l_int|0
comma
id|CAPI_DATA_B3_RESP_LEN
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|s
comma
l_int|2
comma
id|mp-&gt;ap-&gt;applid
)paren
suffix:semicolon
id|capimsg_setu8
(paren
id|s
comma
l_int|4
comma
id|CAPI_DATA_B3
)paren
suffix:semicolon
id|capimsg_setu8
(paren
id|s
comma
l_int|5
comma
id|CAPI_RESP
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|s
comma
l_int|6
comma
id|mp-&gt;msgid
op_increment
)paren
suffix:semicolon
id|capimsg_setu32
c_func
(paren
id|s
comma
l_int|8
comma
id|mp-&gt;ncci
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|s
comma
l_int|12
comma
id|datahandle
)paren
suffix:semicolon
)brace
r_return
id|nskb
suffix:semicolon
)brace
DECL|function|handle_recv_skb
r_static
r_int
id|handle_recv_skb
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
r_int
r_int
id|datalen
suffix:semicolon
id|u16
id|errcode
comma
id|datahandle
suffix:semicolon
id|datalen
op_assign
id|skb-&gt;len
op_minus
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tty
)paren
(brace
r_if
c_cond
(paren
id|mp-&gt;tty-&gt;ldisc.receive_buf
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: ldisc has no receive_buf function&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mp-&gt;ttyinstop
)paren
(brace
macro_line|#if defined(_DEBUG_DATAFLOW) || defined(_DEBUG_TTYFUNCS)
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: recv tty throttled&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mp-&gt;tty-&gt;ldisc.receive_room
op_logical_and
id|mp-&gt;tty-&gt;ldisc
dot
id|receive_room
c_func
(paren
id|mp-&gt;tty
)paren
OL
id|datalen
)paren
(brace
macro_line|#if defined(_DEBUG_DATAFLOW) || defined(_DEBUG_TTYFUNCS)
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: no room in tty&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|nskb
op_assign
id|gen_data_b3_resp_for
c_func
(paren
id|mp
comma
id|skb
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: gen_data_b3_resp failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|datahandle
op_assign
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
id|CAPIMSG_BASELEN
op_plus
l_int|4
)paren
suffix:semicolon
id|errcode
op_assign
id|capi20_put_message
c_func
(paren
id|mp-&gt;ap
comma
id|nskb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_ne
id|CAPI_NOERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: send DATA_B3_RESP failed=%x&bslash;n&quot;
comma
id|errcode
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|nskb
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
(paren
r_void
)paren
id|skb_pull
c_func
(paren
id|skb
comma
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
macro_line|#ifdef _DEBUG_DATAFLOW
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: DATA_B3_RESP %u len=%d =&gt; ldisc&bslash;n&quot;
comma
id|datahandle
comma
id|skb-&gt;len
)paren
suffix:semicolon
macro_line|#endif
id|mp-&gt;tty-&gt;ldisc
dot
id|receive_buf
c_func
(paren
id|mp-&gt;tty
comma
id|skb-&gt;data
comma
l_int|0
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef _DEBUG_DATAFLOW
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: currently no receiver&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|handle_minor_recv
r_static
r_void
id|handle_minor_recv
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|mp-&gt;inqueue
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_int
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|mp-&gt;inbytes
op_sub_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|handle_recv_skb
c_func
(paren
id|mp
comma
id|skb
)paren
OL
l_int|0
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|mp-&gt;inqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;inbytes
op_add_assign
id|len
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
DECL|function|handle_minor_send
r_static
r_int
id|handle_minor_send
c_func
(paren
r_struct
id|capiminor
op_star
id|mp
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u16
id|len
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|u16
id|errcode
suffix:semicolon
id|u16
id|datahandle
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tty
op_logical_and
id|mp-&gt;ttyoutstop
)paren
(brace
macro_line|#if defined(_DEBUG_DATAFLOW) || defined(_DEBUG_TTYFUNCS)
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: send: tty stopped&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|datahandle
op_assign
id|mp-&gt;datahandle
suffix:semicolon
id|len
op_assign
(paren
id|u16
)paren
id|skb-&gt;len
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
id|memset
c_func
(paren
id|skb-&gt;data
comma
l_int|0
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|0
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|2
comma
id|mp-&gt;ap-&gt;applid
)paren
suffix:semicolon
id|capimsg_setu8
(paren
id|skb-&gt;data
comma
l_int|4
comma
id|CAPI_DATA_B3
)paren
suffix:semicolon
id|capimsg_setu8
(paren
id|skb-&gt;data
comma
l_int|5
comma
id|CAPI_REQ
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|6
comma
id|mp-&gt;msgid
op_increment
)paren
suffix:semicolon
id|capimsg_setu32
c_func
(paren
id|skb-&gt;data
comma
l_int|8
comma
id|mp-&gt;ncci
)paren
suffix:semicolon
multiline_comment|/* NCCI */
id|capimsg_setu32
c_func
(paren
id|skb-&gt;data
comma
l_int|12
comma
(paren
id|u32
)paren
id|skb-&gt;data
)paren
suffix:semicolon
multiline_comment|/* Data32 */
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|16
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Data length */
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|18
comma
id|datahandle
)paren
suffix:semicolon
id|capimsg_setu16
c_func
(paren
id|skb-&gt;data
comma
l_int|20
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Flags */
r_if
c_cond
(paren
id|capincci_add_ack
c_func
(paren
id|mp
comma
id|datahandle
)paren
OL
l_int|0
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
id|skb_queue_head
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|errcode
op_assign
id|capi20_put_message
c_func
(paren
id|mp-&gt;ap
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_eq
id|CAPI_NOERROR
)paren
(brace
id|mp-&gt;datahandle
op_increment
suffix:semicolon
id|count
op_increment
suffix:semicolon
id|mp-&gt;outbytes
op_sub_assign
id|len
suffix:semicolon
macro_line|#ifdef _DEBUG_DATAFLOW
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi: DATA_B3_REQ %u len=%u&bslash;n&quot;
comma
id|datahandle
comma
id|len
)paren
suffix:semicolon
macro_line|#endif
r_continue
suffix:semicolon
)brace
id|capiminor_del_ack
c_func
(paren
id|mp
comma
id|datahandle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
op_eq
id|CAPI_SENDQUEUEFULL
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
id|skb_queue_head
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* ups, drop packet */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: put_message = %x&bslash;n&quot;
comma
id|errcode
)paren
suffix:semicolon
id|mp-&gt;outbytes
op_sub_assign
id|len
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
multiline_comment|/* -------- function called by lower level -------------------------- */
DECL|function|capi_recv_message
r_static
r_void
id|capi_recv_message
c_func
(paren
r_struct
id|capi20_appl
op_star
id|ap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
id|ap
op_member_access_from_pointer
r_private
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
id|u16
id|datahandle
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
r_struct
id|capincci
op_star
id|np
suffix:semicolon
id|u32
id|ncci
suffix:semicolon
r_if
c_cond
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_CONNECT_B3_CONF
)paren
(brace
id|u16
id|info
op_assign
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
l_int|12
)paren
suffix:semicolon
singleline_comment|// Info field
r_if
c_cond
(paren
id|info
op_eq
l_int|0
)paren
id|capincci_alloc
c_func
(paren
id|cdev
comma
id|CAPIMSG_NCCI
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_CONNECT_B3_IND
)paren
(brace
id|capincci_alloc
c_func
(paren
id|cdev
comma
id|CAPIMSG_NCCI
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_ne
id|CAPI_DATA_B3
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ncci
op_assign
id|CAPIMSG_CONTROL
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_for
c_loop
(paren
id|np
op_assign
id|cdev-&gt;nccis
suffix:semicolon
id|np
op_logical_and
id|np-&gt;ncci
op_ne
id|ncci
suffix:semicolon
id|np
op_assign
id|np-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BUG: capi_signal: ncci not found&bslash;n&quot;
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_ISDN_CAPI_MIDDLEWARE
id|skb_queue_tail
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
macro_line|#else /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|mp
op_assign
id|np-&gt;minorp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_IND
)paren
(brace
id|datahandle
op_assign
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
id|CAPIMSG_BASELEN
op_plus
l_int|4
op_plus
l_int|4
op_plus
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef _DEBUG_DATAFLOW
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi_signal: DATA_B3_IND %u len=%d&bslash;n&quot;
comma
id|datahandle
comma
id|skb-&gt;len
op_minus
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
macro_line|#endif
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;inqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;inbytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|handle_minor_recv
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_CONF
)paren
(brace
id|datahandle
op_assign
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
id|CAPIMSG_BASELEN
op_plus
l_int|4
)paren
suffix:semicolon
macro_line|#ifdef _DEBUG_DATAFLOW
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi_signal: DATA_B3_CONF %u 0x%x&bslash;n&quot;
comma
id|datahandle
comma
id|CAPIMSG_U16
c_func
(paren
id|skb-&gt;data
comma
id|CAPIMSG_BASELEN
op_plus
l_int|4
op_plus
l_int|2
)paren
)paren
suffix:semicolon
macro_line|#endif
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
(paren
r_void
)paren
id|capiminor_del_ack
c_func
(paren
id|mp
comma
id|datahandle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;tty
)paren
(brace
r_if
c_cond
(paren
id|mp-&gt;tty-&gt;ldisc.write_wakeup
)paren
id|mp-&gt;tty-&gt;ldisc
dot
id|write_wakeup
c_func
(paren
id|mp-&gt;tty
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
id|handle_minor_send
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ups, let capi application handle it :-) */
id|skb_queue_tail
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
)brace
multiline_comment|/* -------- file_operations for capidev ----------------------------- */
r_static
id|ssize_t
DECL|function|capi_read
id|capi_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
(paren
r_struct
id|capidev
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|copied
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;ap.applid
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|cdev-&gt;recvwait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
)paren
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|0
)paren
r_return
op_minus
id|ERESTARTNOHAND
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|count
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
comma
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|copied
op_assign
id|skb-&gt;len
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|copied
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|capi_write
id|capi_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
(paren
r_struct
id|capidev
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u16
id|mlen
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;ap.applid
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|count
comma
id|GFP_USER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|buf
comma
id|count
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|mlen
op_assign
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CAPIMSG_CMD
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_DATA_B3_REQ
)paren
(brace
r_if
c_cond
(paren
id|mlen
op_plus
id|CAPIMSG_DATALEN
c_func
(paren
id|skb-&gt;data
)paren
op_ne
id|count
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|mlen
op_ne
id|count
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|CAPIMSG_SETAPPID
c_func
(paren
id|skb-&gt;data
comma
id|cdev-&gt;ap.applid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_DISCONNECT_B3_RESP
)paren
(brace
id|capincci_free
c_func
(paren
id|cdev
comma
id|CAPIMSG_NCCI
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
id|cdev-&gt;errcode
op_assign
id|capi20_put_message
c_func
(paren
op_amp
id|cdev-&gt;ap
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|capi_poll
id|capi_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
(paren
r_struct
id|capidev
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;ap.applid
)paren
r_return
id|POLLERR
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
(paren
id|cdev-&gt;recvwait
)paren
comma
id|wait
)paren
suffix:semicolon
id|mask
op_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|cdev-&gt;recvqueue
)paren
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
r_static
r_int
DECL|function|capi_ioctl
id|capi_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|capi20_appl
op_star
id|ap
op_assign
op_amp
id|cdev-&gt;ap
suffix:semicolon
id|capi_ioctl_struct
id|data
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CAPI_REGISTER
suffix:colon
(brace
r_if
c_cond
(paren
id|ap-&gt;applid
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|cdev-&gt;ap.rparam
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|capi_register_params
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|cdev-&gt;ap
dot
r_private
op_assign
id|cdev
suffix:semicolon
id|cdev-&gt;ap.recv_message
op_assign
id|capi_recv_message
suffix:semicolon
id|cdev-&gt;errcode
op_assign
id|capi20_register
c_func
(paren
id|ap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
(brace
id|ap-&gt;applid
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_return
(paren
r_int
)paren
id|ap-&gt;applid
suffix:semicolon
r_case
id|CAPI_GET_VERSION
suffix:colon
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|data.contr
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|data.contr
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|cdev-&gt;errcode
op_assign
id|capi20_get_version
c_func
(paren
id|data.contr
comma
op_amp
id|data.version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|data.version
comma
r_sizeof
(paren
id|data.version
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_GET_SERIAL
suffix:colon
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|data.contr
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|data.contr
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|cdev-&gt;errcode
op_assign
id|capi20_get_serial
(paren
id|data.contr
comma
id|data.serial
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
id|data.serial
comma
r_sizeof
(paren
id|data.serial
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_GET_PROFILE
suffix:colon
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|data.contr
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|data.contr
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|data.contr
op_eq
l_int|0
)paren
(brace
id|cdev-&gt;errcode
op_assign
id|capi20_get_profile
c_func
(paren
id|data.contr
comma
op_amp
id|data.profile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|retval
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|data.profile.ncontroller
comma
r_sizeof
(paren
id|data.profile.ncontroller
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|cdev-&gt;errcode
op_assign
id|capi20_get_profile
c_func
(paren
id|data.contr
comma
op_amp
id|data.profile
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|retval
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|data.profile
comma
r_sizeof
(paren
id|data.profile
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_GET_MANUFACTURER
suffix:colon
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|data.contr
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|data.contr
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|cdev-&gt;errcode
op_assign
id|capi20_get_manufacturer
c_func
(paren
id|data.contr
comma
id|data.manufacturer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;errcode
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
id|data.manufacturer
comma
r_sizeof
(paren
id|data.manufacturer
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_GET_ERRCODE
suffix:colon
id|data.errcode
op_assign
id|cdev-&gt;errcode
suffix:semicolon
id|cdev-&gt;errcode
op_assign
id|CAPI_NOERROR
suffix:semicolon
r_if
c_cond
(paren
id|arg
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|data.errcode
comma
r_sizeof
(paren
id|data.errcode
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|data.errcode
suffix:semicolon
r_case
id|CAPI_INSTALLED
suffix:colon
r_if
c_cond
(paren
id|capi20_isinstalled
c_func
(paren
)paren
op_eq
id|CAPI_NOERROR
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
r_case
id|CAPI_MANUFACTURER_CMD
suffix:colon
(brace
r_struct
id|capi_manufacturer_cmd
id|mcmd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|mcmd
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|mcmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|capi20_manufacturer
c_func
(paren
id|mcmd.cmd
comma
id|mcmd.data
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_SET_FLAGS
suffix:colon
r_case
id|CAPI_CLR_FLAGS
suffix:colon
(brace
r_int
id|userflags
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|userflags
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|userflags
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|CAPI_SET_FLAGS
)paren
id|cdev-&gt;userflags
op_or_assign
id|userflags
suffix:semicolon
r_else
id|cdev-&gt;userflags
op_and_assign
op_complement
id|userflags
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_GET_FLAGS
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|cdev-&gt;userflags
comma
r_sizeof
(paren
id|cdev-&gt;userflags
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|CAPI_NCCI_OPENCOUNT
suffix:colon
(brace
r_struct
id|capincci
op_star
id|nccip
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
r_int
id|ncci
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ncci
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|ncci
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|nccip
op_assign
id|capincci_find
c_func
(paren
id|cdev
comma
(paren
id|u32
)paren
id|ncci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nccip
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_if
c_cond
(paren
(paren
id|mp
op_assign
id|nccip-&gt;minorp
)paren
op_ne
l_int|0
)paren
(brace
id|count
op_add_assign
id|atomic_read
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
r_return
id|count
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_case
id|CAPI_NCCI_GETUNIT
suffix:colon
(brace
r_struct
id|capincci
op_star
id|nccip
suffix:semicolon
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
r_int
id|ncci
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ncci
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|ncci
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|nccip
op_assign
id|capincci_find
c_func
(paren
id|cdev
comma
(paren
id|u32
)paren
id|ncci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nccip
op_logical_or
(paren
id|mp
op_assign
id|nccip-&gt;minorp
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_return
id|mp-&gt;minor
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_int
DECL|function|capi_open
id|capi_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;private_data
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
(paren
id|file-&gt;private_data
op_assign
id|capidev_alloc
c_func
(paren
)paren
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|capi_release
id|capi_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
op_assign
(paren
r_struct
id|capidev
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|capincci_free
c_func
(paren
id|cdev
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|capidev_free
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|capi_fops
r_static
r_struct
id|file_operations
id|capi_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|read
op_assign
id|capi_read
comma
dot
id|write
op_assign
id|capi_write
comma
dot
id|poll
op_assign
id|capi_poll
comma
dot
id|ioctl
op_assign
id|capi_ioctl
comma
dot
id|open
op_assign
id|capi_open
comma
dot
id|release
op_assign
id|capi_release
comma
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
multiline_comment|/* -------- tty_operations for capincci ----------------------------- */
DECL|function|capinc_tty_open
r_static
r_int
id|capinc_tty_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mp
op_assign
id|capiminor_find
c_func
(paren
id|minor
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
)paren
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;nccip
op_eq
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|tty-&gt;driver_data
op_assign
(paren
r_void
op_star
)paren
id|mp
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capi_tty_open %d&bslash;n&quot;
comma
id|GET_USE_COUNT
c_func
(paren
id|THIS_MODULE
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
op_eq
l_int|0
)paren
id|mp-&gt;tty
op_assign
id|tty
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
suffix:semicolon
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_open ocount=%d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
)paren
suffix:semicolon
macro_line|#endif
id|handle_minor_recv
c_func
(paren
id|mp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capinc_tty_close
r_static
r_void
id|capinc_tty_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
suffix:semicolon
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|mp
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
)paren
(brace
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_close lastclose&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tty-&gt;driver_data
op_assign
(paren
r_void
op_star
)paren
l_int|0
suffix:semicolon
id|mp-&gt;tty
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_close ocount=%d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|mp-&gt;ttyopencount
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp-&gt;nccip
op_eq
l_int|0
)paren
id|capiminor_free
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
macro_line|#ifdef _DEBUG_REFCOUNT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_close&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_write
r_static
r_int
id|capinc_tty_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|retval
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_write(from_user=%d,count=%d)&bslash;n&quot;
comma
id|from_user
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_write: mp or mp-&gt;ncci NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|skb
op_assign
id|mp-&gt;ttyskb
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|mp-&gt;ttyskb
op_assign
l_int|0
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;outbytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|CAPI_DATA_B3_REQ_LEN
op_plus
id|count
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capinc_tty_write: alloc_skb failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|copy_from_user
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|buf
comma
id|count
)paren
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_write: copy_from_user=%d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|buf
comma
id|count
)paren
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;outbytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
(paren
r_void
)paren
id|handle_minor_send
c_func
(paren
id|mp
)paren
suffix:semicolon
(paren
r_void
)paren
id|handle_minor_recv
c_func
(paren
id|mp
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|capinc_tty_put_char
r_static
r_void
id|capinc_tty_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_put_char(%u)&bslash;n&quot;
comma
id|ch
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_put_char: mp or mp-&gt;ncci NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|skb
op_assign
id|mp-&gt;ttyskb
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_if
c_cond
(paren
id|skb_tailroom
c_func
(paren
id|skb
)paren
OG
l_int|0
)paren
(brace
op_star
(paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
)paren
op_assign
id|ch
suffix:semicolon
r_return
suffix:semicolon
)brace
id|mp-&gt;ttyskb
op_assign
l_int|0
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;outbytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
(paren
r_void
)paren
id|handle_minor_send
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|CAPI_DATA_B3_REQ_LEN
op_plus
id|CAPI_MAX_BLKSIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb_reserve
c_func
(paren
id|skb
comma
id|CAPI_DATA_B3_REQ_LEN
)paren
suffix:semicolon
op_star
(paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
)paren
op_assign
id|ch
suffix:semicolon
id|mp-&gt;ttyskb
op_assign
id|skb
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capinc_put_char: char %u lost&bslash;n&quot;
comma
id|ch
)paren
suffix:semicolon
)brace
)brace
DECL|function|capinc_tty_flush_chars
r_static
r_void
id|capinc_tty_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_flush_chars&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_flush_chars: mp or mp-&gt;ncci NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|skb
op_assign
id|mp-&gt;ttyskb
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|mp-&gt;ttyskb
op_assign
l_int|0
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|mp-&gt;outqueue
comma
id|skb
)paren
suffix:semicolon
id|mp-&gt;outbytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
(paren
r_void
)paren
id|handle_minor_send
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
id|handle_minor_recv
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
DECL|function|capinc_tty_write_room
r_static
r_int
id|capinc_tty_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|room
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_write_room: mp or mp-&gt;ncci NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|room
op_assign
id|CAPINC_MAX_SENDQUEUE
op_minus
id|skb_queue_len
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
suffix:semicolon
id|room
op_mul_assign
id|CAPI_MAX_BLKSIZE
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_write_room = %d&bslash;n&quot;
comma
id|room
)paren
suffix:semicolon
macro_line|#endif
r_return
id|room
suffix:semicolon
)brace
DECL|function|capinc_tty_chars_in_buffer
r_int
id|capinc_tty_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp
op_logical_or
op_logical_neg
id|mp-&gt;nccip
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_chars_in_buffer: mp or mp-&gt;ncci NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_chars_in_buffer = %d nack=%d sq=%d rq=%d&bslash;n&quot;
comma
id|mp-&gt;outbytes
comma
id|mp-&gt;nack
comma
id|skb_queue_len
c_func
(paren
op_amp
id|mp-&gt;outqueue
)paren
comma
id|skb_queue_len
c_func
(paren
op_amp
id|mp-&gt;inqueue
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|mp-&gt;outbytes
suffix:semicolon
)brace
DECL|function|capinc_tty_ioctl
r_static
r_int
id|capinc_tty_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_default
suffix:colon
id|error
op_assign
id|n_tty_ioctl
(paren
id|tty
comma
id|file
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
DECL|function|capinc_tty_set_termios
r_static
r_void
id|capinc_tty_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_set_termios&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_throttle
r_static
r_void
id|capinc_tty_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_throttle&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp
)paren
id|mp-&gt;ttyinstop
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|capinc_tty_unthrottle
r_static
r_void
id|capinc_tty_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_unthrottle&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp
)paren
(brace
id|mp-&gt;ttyinstop
op_assign
l_int|0
suffix:semicolon
id|handle_minor_recv
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
)brace
DECL|function|capinc_tty_stop
r_static
r_void
id|capinc_tty_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_stop&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp
)paren
(brace
id|mp-&gt;ttyoutstop
op_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|capinc_tty_start
r_static
r_void
id|capinc_tty_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|capiminor
op_star
id|mp
op_assign
(paren
r_struct
id|capiminor
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_start&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mp
)paren
(brace
id|mp-&gt;ttyoutstop
op_assign
l_int|0
suffix:semicolon
(paren
r_void
)paren
id|handle_minor_send
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
)brace
DECL|function|capinc_tty_hangup
r_static
r_void
id|capinc_tty_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_hangup&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_break_ctl
r_static
r_void
id|capinc_tty_break_ctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|state
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_break_ctl(%d)&bslash;n&quot;
comma
id|state
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_flush_buffer
r_static
r_void
id|capinc_tty_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_flush_buffer&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_set_ldisc
r_static
r_void
id|capinc_tty_set_ldisc
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_set_ldisc&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_send_xchar
r_static
r_void
id|capinc_tty_send_xchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
(brace
macro_line|#ifdef _DEBUG_TTYFUNCS
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;capinc_tty_send_xchar(%d)&bslash;n&quot;
comma
id|ch
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|capinc_tty_read_proc
r_static
r_int
id|capinc_tty_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|CAPINC_NR_PORTS
mdefine_line|#define CAPINC_NR_PORTS 256
DECL|variable|capinc_tty_driver
r_static
r_struct
id|tty_driver
id|capinc_tty_driver
suffix:semicolon
DECL|variable|capinc_tty_refcount
r_static
r_int
id|capinc_tty_refcount
suffix:semicolon
DECL|variable|capinc_tty_table
r_static
r_struct
id|tty_struct
op_star
id|capinc_tty_table
(braket
id|CAPINC_NR_PORTS
)braket
suffix:semicolon
DECL|variable|capinc_tty_termios
r_static
r_struct
id|termios
op_star
id|capinc_tty_termios
(braket
id|CAPINC_NR_PORTS
)braket
suffix:semicolon
DECL|variable|capinc_tty_termios_locked
r_static
r_struct
id|termios
op_star
id|capinc_tty_termios_locked
(braket
id|CAPINC_NR_PORTS
)braket
suffix:semicolon
DECL|function|capinc_tty_init
r_static
r_int
id|capinc_tty_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|tty_driver
op_star
id|drv
op_assign
op_amp
id|capinc_tty_driver
suffix:semicolon
multiline_comment|/* Initialize the tty_driver structure */
id|memset
c_func
(paren
id|drv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|drv-&gt;magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|drv-&gt;driver_name
op_assign
l_string|&quot;capi_nc&quot;
suffix:semicolon
id|drv-&gt;name
op_assign
l_string|&quot;capi/%d&quot;
suffix:semicolon
id|drv-&gt;major
op_assign
id|capi_ttymajor
suffix:semicolon
id|drv-&gt;minor_start
op_assign
l_int|0
suffix:semicolon
id|drv-&gt;num
op_assign
id|CAPINC_NR_PORTS
suffix:semicolon
id|drv-&gt;type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|drv-&gt;subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|drv-&gt;init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|drv-&gt;init_termios.c_iflag
op_assign
id|ICRNL
suffix:semicolon
id|drv-&gt;init_termios.c_oflag
op_assign
id|OPOST
op_or
id|ONLCR
suffix:semicolon
id|drv-&gt;init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|drv-&gt;init_termios.c_lflag
op_assign
l_int|0
suffix:semicolon
id|drv-&gt;flags
op_assign
id|TTY_DRIVER_REAL_RAW
op_or
id|TTY_DRIVER_RESET_TERMIOS
suffix:semicolon
id|drv-&gt;refcount
op_assign
op_amp
id|capinc_tty_refcount
suffix:semicolon
id|drv-&gt;table
op_assign
id|capinc_tty_table
suffix:semicolon
id|drv-&gt;termios
op_assign
id|capinc_tty_termios
suffix:semicolon
id|drv-&gt;termios_locked
op_assign
id|capinc_tty_termios_locked
suffix:semicolon
id|drv-&gt;open
op_assign
id|capinc_tty_open
suffix:semicolon
id|drv-&gt;close
op_assign
id|capinc_tty_close
suffix:semicolon
id|drv-&gt;write
op_assign
id|capinc_tty_write
suffix:semicolon
id|drv-&gt;put_char
op_assign
id|capinc_tty_put_char
suffix:semicolon
id|drv-&gt;flush_chars
op_assign
id|capinc_tty_flush_chars
suffix:semicolon
id|drv-&gt;write_room
op_assign
id|capinc_tty_write_room
suffix:semicolon
id|drv-&gt;chars_in_buffer
op_assign
id|capinc_tty_chars_in_buffer
suffix:semicolon
id|drv-&gt;ioctl
op_assign
id|capinc_tty_ioctl
suffix:semicolon
id|drv-&gt;set_termios
op_assign
id|capinc_tty_set_termios
suffix:semicolon
id|drv-&gt;throttle
op_assign
id|capinc_tty_throttle
suffix:semicolon
id|drv-&gt;unthrottle
op_assign
id|capinc_tty_unthrottle
suffix:semicolon
id|drv-&gt;stop
op_assign
id|capinc_tty_stop
suffix:semicolon
id|drv-&gt;start
op_assign
id|capinc_tty_start
suffix:semicolon
id|drv-&gt;hangup
op_assign
id|capinc_tty_hangup
suffix:semicolon
id|drv-&gt;break_ctl
op_assign
id|capinc_tty_break_ctl
suffix:semicolon
id|drv-&gt;flush_buffer
op_assign
id|capinc_tty_flush_buffer
suffix:semicolon
id|drv-&gt;set_ldisc
op_assign
id|capinc_tty_set_ldisc
suffix:semicolon
id|drv-&gt;send_xchar
op_assign
id|capinc_tty_send_xchar
suffix:semicolon
id|drv-&gt;read_proc
op_assign
id|capinc_tty_read_proc
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
id|drv
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Couldn&squot;t register capi_nc driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capinc_tty_exit
r_static
r_void
id|capinc_tty_exit
c_func
(paren
r_void
)paren
(brace
r_struct
id|tty_driver
op_star
id|drv
op_assign
op_amp
id|capinc_tty_driver
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|tty_unregister_driver
c_func
(paren
id|drv
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi: failed to unregister capi_nc driver (%d)&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
multiline_comment|/* -------- /proc functions ----------------------------------------- */
multiline_comment|/*&n; * /proc/capi/capi20:&n; *  minor applid nrecvctlpkt nrecvdatapkt nsendctlpkt nsenddatapkt&n; */
DECL|function|proc_capidev_read_proc
r_static
r_int
id|proc_capidev_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|capidev_list_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|capidev_list
)paren
(brace
id|cdev
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|capidev
comma
id|list
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;0 %d %lu %lu %lu %lu&bslash;n&quot;
comma
id|cdev-&gt;ap.applid
comma
id|cdev-&gt;ap.nrecvctlpkt
comma
id|cdev-&gt;ap.nrecvdatapkt
comma
id|cdev-&gt;ap.nsentctlpkt
comma
id|cdev-&gt;ap.nsentdatapkt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
)paren
(brace
id|off
op_sub_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
op_minus
id|off
OG
id|count
)paren
r_goto
id|endloop
suffix:semicolon
)brace
)brace
id|endloop
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|capidev_list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * /proc/capi/capi20ncci:&n; *  applid ncci&n; */
DECL|function|proc_capincci_read_proc
r_static
r_int
id|proc_capincci_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capidev
op_star
id|cdev
suffix:semicolon
r_struct
id|capincci
op_star
id|np
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|capidev_list_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|capidev_list
)paren
(brace
id|cdev
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|capidev
comma
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|np
op_assign
id|cdev-&gt;nccis
suffix:semicolon
id|np
suffix:semicolon
id|np
op_assign
id|np-&gt;next
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%d 0x%x&bslash;n&quot;
comma
id|cdev-&gt;ap.applid
comma
id|np-&gt;ncci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
)paren
(brace
id|off
op_sub_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|len
op_minus
id|off
OG
id|count
)paren
r_goto
id|endloop
suffix:semicolon
)brace
)brace
)brace
id|endloop
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|capidev_list_lock
)paren
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|struct|procfsentries
r_static
r_struct
id|procfsentries
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|mode
id|mode_t
id|mode
suffix:semicolon
DECL|member|read_proc
r_int
(paren
op_star
id|read_proc
)paren
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
DECL|member|procent
r_struct
id|proc_dir_entry
op_star
id|procent
suffix:semicolon
DECL|variable|procfsentries
)brace
id|procfsentries
(braket
)braket
op_assign
(brace
multiline_comment|/* { &quot;capi&quot;,&t;&t;  S_IFDIR, 0 }, */
(brace
l_string|&quot;capi/capi20&quot;
comma
l_int|0
comma
id|proc_capidev_read_proc
)brace
comma
(brace
l_string|&quot;capi/capi20ncci&quot;
comma
l_int|0
comma
id|proc_capincci_read_proc
)brace
comma
)brace
suffix:semicolon
DECL|function|proc_init
r_static
r_void
id|__init
id|proc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|nelem
op_assign
r_sizeof
(paren
id|procfsentries
)paren
op_div
r_sizeof
(paren
id|procfsentries
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nelem
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|procfsentries
op_star
id|p
op_assign
id|procfsentries
op_plus
id|i
suffix:semicolon
id|p-&gt;procent
op_assign
id|create_proc_entry
c_func
(paren
id|p-&gt;name
comma
id|p-&gt;mode
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;procent
)paren
id|p-&gt;procent-&gt;read_proc
op_assign
id|p-&gt;read_proc
suffix:semicolon
)brace
)brace
DECL|function|proc_exit
r_static
r_void
id|__exit
id|proc_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|nelem
op_assign
r_sizeof
(paren
id|procfsentries
)paren
op_div
r_sizeof
(paren
id|procfsentries
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|nelem
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_struct
id|procfsentries
op_star
id|p
op_assign
id|procfsentries
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;procent
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|p-&gt;name
comma
l_int|0
)paren
suffix:semicolon
id|p-&gt;procent
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* -------- init function and module interface ---------------------- */
DECL|variable|rev
r_static
r_char
id|rev
(braket
l_int|32
)braket
suffix:semicolon
DECL|function|capi_init
r_static
r_int
id|__init
id|capi_init
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|compileinfo
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
op_ne
l_int|0
op_logical_and
id|p
(braket
l_int|1
)braket
)paren
(brace
id|strncpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|2
comma
r_sizeof
(paren
id|rev
)paren
)paren
suffix:semicolon
id|rev
(braket
r_sizeof
(paren
id|rev
)paren
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
)paren
op_ne
l_int|0
op_logical_and
id|p
OG
id|rev
)paren
op_star
(paren
id|p
op_minus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot;1.0&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|capi_major
comma
l_string|&quot;capi20&quot;
comma
op_amp
id|capi_fops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;capi20: unable to get major %d&bslash;n&quot;
comma
id|capi_major
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|devfs_register
(paren
l_int|NULL
comma
l_string|&quot;isdn/capi20&quot;
comma
id|DEVFS_FL_DEFAULT
comma
id|capi_major
comma
l_int|0
comma
id|S_IFCHR
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
op_amp
id|capi_fops
comma
l_int|NULL
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;capi20: started up with major %d&bslash;n&quot;
comma
id|capi_major
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
r_if
c_cond
(paren
id|capinc_tty_init
c_func
(paren
)paren
OL
l_int|0
)paren
(brace
id|unregister_chrdev
c_func
(paren
id|capi_major
comma
l_string|&quot;capi20&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISDN_CAPI_MIDDLEWARE */
id|proc_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
macro_line|#if defined(CONFIG_ISDN_CAPI_CAPIFS) || defined(CONFIG_ISDN_CAPI_CAPIFS_MODULE)
id|compileinfo
op_assign
l_string|&quot; (middleware+capifs)&quot;
suffix:semicolon
macro_line|#else
id|compileinfo
op_assign
l_string|&quot; (no capifs)&quot;
suffix:semicolon
macro_line|#endif
macro_line|#else
id|compileinfo
op_assign
l_string|&quot; (no middleware)&quot;
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;capi20: Rev %s: started up with major %d%s&bslash;n&quot;
comma
id|rev
comma
id|capi_major
comma
id|compileinfo
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capi_exit
r_static
r_void
id|__exit
id|capi_exit
c_func
(paren
r_void
)paren
(brace
id|proc_exit
c_func
(paren
)paren
suffix:semicolon
id|unregister_chrdev
c_func
(paren
id|capi_major
comma
l_string|&quot;capi20&quot;
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;isdn/capi20&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_CAPI_MIDDLEWARE
id|capinc_tty_exit
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;capi: Rev %s: unloaded&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
)brace
DECL|variable|capi_init
id|module_init
c_func
(paren
id|capi_init
)paren
suffix:semicolon
DECL|variable|capi_exit
id|module_exit
c_func
(paren
id|capi_exit
)paren
suffix:semicolon
eof
