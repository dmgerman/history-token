multiline_comment|/* $Id: kcapi.c,v 1.21.6.8 2001/09/23 22:24:33 kai Exp $&n; * &n; * Kernel CAPI 2.0 Module&n; * &n; * Copyright 1999 by Carsten Paeth &lt;calle@calle.de&gt;&n; * Copyright 2002 by Kai Germaschewski &lt;kai@germaschewski.name&gt;&n; * &n; * This software may be used and distributed according to the terms&n; * of the GNU General Public License, incorporated herein by reference.&n; *&n; */
DECL|macro|CONFIG_AVMB1_COMPAT
mdefine_line|#define CONFIG_AVMB1_COMPAT
macro_line|#include &quot;kcapi.h&quot;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/capi.h&gt;
macro_line|#include &lt;linux/kernelcapi.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/isdn/capicmd.h&gt;
macro_line|#include &lt;linux/isdn/capiutil.h&gt;
macro_line|#ifdef CONFIG_AVMB1_COMPAT
macro_line|#include &lt;linux/b1lli.h&gt;
macro_line|#endif
DECL|variable|revision
r_static
r_char
op_star
id|revision
op_assign
l_string|&quot;$Revision: 1.21.6.8 $&quot;
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
DECL|variable|showcapimsgs
r_static
r_int
id|showcapimsgs
op_assign
l_int|0
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;CAPI4Linux: kernel CAPI layer&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Carsten Paeth&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|showcapimsgs
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
DECL|struct|capi_notifier
r_struct
id|capi_notifier
(brace
DECL|member|next
r_struct
id|capi_notifier
op_star
id|next
suffix:semicolon
DECL|member|cmd
r_int
r_int
id|cmd
suffix:semicolon
DECL|member|controller
id|u32
id|controller
suffix:semicolon
DECL|member|applid
id|u16
id|applid
suffix:semicolon
DECL|member|ncci
id|u32
id|ncci
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
DECL|variable|driver_version
r_static
r_struct
id|capi_version
id|driver_version
op_assign
(brace
l_int|2
comma
l_int|0
comma
l_int|1
comma
l_int|1
op_lshift
l_int|4
)brace
suffix:semicolon
DECL|variable|driver_serial
r_static
r_char
id|driver_serial
(braket
id|CAPI_SERIAL_LEN
)braket
op_assign
l_string|&quot;0004711&quot;
suffix:semicolon
DECL|variable|capi_manufakturer
r_static
r_char
id|capi_manufakturer
(braket
l_int|64
)braket
op_assign
l_string|&quot;AVM Berlin&quot;
suffix:semicolon
DECL|macro|NCCI2CTRL
mdefine_line|#define NCCI2CTRL(ncci)    (((ncci) &gt;&gt; 24) &amp; 0x7f)
DECL|variable|capi_drivers
id|LIST_HEAD
c_func
(paren
id|capi_drivers
)paren
suffix:semicolon
DECL|variable|capi_drivers_lock
id|spinlock_t
id|capi_drivers_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|capi_applications
r_struct
id|capi20_appl
op_star
id|capi_applications
(braket
id|CAPI_MAXAPPL
)braket
suffix:semicolon
DECL|variable|capi_cards
r_struct
id|capi_ctr
op_star
id|capi_cards
(braket
id|CAPI_MAXCONTR
)braket
suffix:semicolon
DECL|variable|ncards
r_static
r_int
id|ncards
suffix:semicolon
DECL|variable|recv_queue
r_static
r_struct
id|sk_buff_head
id|recv_queue
suffix:semicolon
DECL|variable|tq_state_notify
r_static
r_struct
id|tq_struct
id|tq_state_notify
suffix:semicolon
DECL|variable|tq_recv_notify
r_static
r_struct
id|tq_struct
id|tq_recv_notify
suffix:semicolon
multiline_comment|/* -------- ref counting -------------------------------------- */
r_static
r_inline
r_struct
id|capi_ctr
op_star
DECL|function|capi_ctr_get
id|capi_ctr_get
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;owner
)paren
(brace
r_if
c_cond
(paren
id|try_inc_mod_count
c_func
(paren
id|card-&gt;owner
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;MOD_COUNT INC&quot;
)paren
suffix:semicolon
r_return
id|card
suffix:semicolon
)brace
r_else
r_return
l_int|NULL
suffix:semicolon
)brace
id|DBG
c_func
(paren
l_string|&quot;MOD_COUNT INC&quot;
)paren
suffix:semicolon
r_return
id|card
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|capi_ctr_put
id|capi_ctr_put
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;owner
)paren
id|__MOD_DEC_USE_COUNT
c_func
(paren
id|card-&gt;owner
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;MOD_COUNT DEC&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------- */
DECL|function|get_capi_ctr_by_nr
r_static
r_inline
r_struct
id|capi_ctr
op_star
id|get_capi_ctr_by_nr
c_func
(paren
id|u16
id|contr
)paren
(brace
r_if
c_cond
(paren
id|contr
op_minus
l_int|1
op_ge
id|CAPI_MAXCONTR
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|capi_cards
(braket
id|contr
op_minus
l_int|1
)braket
suffix:semicolon
)brace
DECL|function|get_capi_appl_by_nr
r_static
r_inline
r_struct
id|capi20_appl
op_star
id|get_capi_appl_by_nr
c_func
(paren
id|u16
id|applid
)paren
(brace
r_if
c_cond
(paren
id|applid
op_minus
l_int|1
op_ge
id|CAPI_MAXAPPL
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|capi_applications
(braket
id|applid
op_minus
l_int|1
)braket
suffix:semicolon
)brace
multiline_comment|/* -------- util functions ------------------------------------ */
DECL|function|capi_cmd_valid
r_static
r_inline
r_int
id|capi_cmd_valid
c_func
(paren
id|u8
id|cmd
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CAPI_ALERT
suffix:colon
r_case
id|CAPI_CONNECT
suffix:colon
r_case
id|CAPI_CONNECT_ACTIVE
suffix:colon
r_case
id|CAPI_CONNECT_B3_ACTIVE
suffix:colon
r_case
id|CAPI_CONNECT_B3
suffix:colon
r_case
id|CAPI_CONNECT_B3_T90_ACTIVE
suffix:colon
r_case
id|CAPI_DATA_B3
suffix:colon
r_case
id|CAPI_DISCONNECT_B3
suffix:colon
r_case
id|CAPI_DISCONNECT
suffix:colon
r_case
id|CAPI_FACILITY
suffix:colon
r_case
id|CAPI_INFO
suffix:colon
r_case
id|CAPI_LISTEN
suffix:colon
r_case
id|CAPI_MANUFACTURER
suffix:colon
r_case
id|CAPI_RESET_B3
suffix:colon
r_case
id|CAPI_SELECT_B_PROTOCOL
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capi_subcmd_valid
r_static
r_inline
r_int
id|capi_subcmd_valid
c_func
(paren
id|u8
id|subcmd
)paren
(brace
r_switch
c_cond
(paren
id|subcmd
)paren
(brace
r_case
id|CAPI_REQ
suffix:colon
r_case
id|CAPI_CONF
suffix:colon
r_case
id|CAPI_IND
suffix:colon
r_case
id|CAPI_RESP
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------ */
DECL|function|register_appl
r_static
r_void
id|register_appl
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
comma
id|u16
id|applid
comma
id|capi_register_params
op_star
id|rparam
)paren
(brace
id|card
op_assign
id|capi_ctr_get
c_func
(paren
id|card
)paren
suffix:semicolon
id|card
op_member_access_from_pointer
id|register_appl
c_func
(paren
id|card
comma
id|applid
comma
id|rparam
)paren
suffix:semicolon
)brace
DECL|function|release_appl
r_static
r_void
id|release_appl
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
comma
id|u16
id|applid
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;applid %#x&quot;
comma
id|applid
)paren
suffix:semicolon
id|card
op_member_access_from_pointer
id|release_appl
c_func
(paren
id|card
comma
id|applid
)paren
suffix:semicolon
id|capi_ctr_put
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/* -------- Notifier handling --------------------------------- */
DECL|struct|capi_notifier_list
r_static
r_struct
id|capi_notifier_list
(brace
DECL|member|head
r_struct
id|capi_notifier
op_star
id|head
suffix:semicolon
DECL|member|tail
r_struct
id|capi_notifier
op_star
id|tail
suffix:semicolon
DECL|variable|notifier_list
)brace
id|notifier_list
suffix:semicolon
DECL|variable|notifier_lock
r_static
id|spinlock_t
id|notifier_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|notify_enqueue
r_static
r_inline
r_void
id|notify_enqueue
c_func
(paren
r_struct
id|capi_notifier
op_star
id|np
)paren
(brace
r_struct
id|capi_notifier_list
op_star
id|q
op_assign
op_amp
id|notifier_list
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|notifier_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;tail
)paren
(brace
id|q-&gt;tail-&gt;next
op_assign
id|np
suffix:semicolon
id|q-&gt;tail
op_assign
id|np
suffix:semicolon
)brace
r_else
(brace
id|q-&gt;head
op_assign
id|q-&gt;tail
op_assign
id|np
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|notifier_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|notify_dequeue
r_static
r_inline
r_struct
id|capi_notifier
op_star
id|notify_dequeue
c_func
(paren
r_void
)paren
(brace
r_struct
id|capi_notifier_list
op_star
id|q
op_assign
op_amp
id|notifier_list
suffix:semicolon
r_struct
id|capi_notifier
op_star
id|np
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|notifier_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;head
)paren
(brace
id|np
op_assign
id|q-&gt;head
suffix:semicolon
r_if
c_cond
(paren
(paren
id|q-&gt;head
op_assign
id|np-&gt;next
)paren
op_eq
l_int|0
)paren
id|q-&gt;tail
op_assign
l_int|0
suffix:semicolon
id|np-&gt;next
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|notifier_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|np
suffix:semicolon
)brace
DECL|function|notify_push
r_static
r_int
id|notify_push
c_func
(paren
r_int
r_int
id|cmd
comma
id|u32
id|controller
comma
id|u16
id|applid
comma
id|u32
id|ncci
)paren
(brace
r_struct
id|capi_notifier
op_star
id|np
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|np
op_assign
(paren
r_struct
id|capi_notifier
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|capi_notifier
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|np
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|capi_notifier
)paren
)paren
suffix:semicolon
id|np-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|np-&gt;controller
op_assign
id|controller
suffix:semicolon
id|np-&gt;applid
op_assign
id|applid
suffix:semicolon
id|np-&gt;ncci
op_assign
id|ncci
suffix:semicolon
id|notify_enqueue
c_func
(paren
id|np
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The notifier will result in adding/deleteing&n;&t; * of devices. Devices can only removed in&n;&t; * user process, not in bh.&n;&t; */
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|schedule_task
c_func
(paren
op_amp
id|tq_state_notify
)paren
op_eq
l_int|0
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------- KCI_CONTRUP --------------------------------------- */
DECL|function|notify_up
r_static
r_void
id|notify_up
c_func
(paren
id|u32
id|contr
)paren
(brace
r_struct
id|capi_ctr
op_star
id|card
op_assign
id|get_capi_ctr_by_nr
c_func
(paren
id|contr
)paren
suffix:semicolon
r_struct
id|capi20_appl
op_star
id|ap
suffix:semicolon
id|u16
id|applid
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: notify up contr %d&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|applid
op_assign
l_int|1
suffix:semicolon
id|applid
op_le
id|CAPI_MAXAPPL
suffix:semicolon
id|applid
op_increment
)paren
(brace
id|ap
op_assign
id|get_capi_appl_by_nr
c_func
(paren
id|applid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap
op_logical_and
id|ap-&gt;callback
)paren
id|ap
op_member_access_from_pointer
id|callback
c_func
(paren
id|KCI_CONTRUP
comma
id|contr
comma
op_amp
id|card-&gt;profile
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* -------- KCI_CONTRDOWN ------------------------------------- */
DECL|function|notify_down
r_static
r_void
id|notify_down
c_func
(paren
id|u32
id|contr
)paren
(brace
r_struct
id|capi20_appl
op_star
id|ap
suffix:semicolon
id|u16
id|applid
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: notify down contr %d&bslash;n&quot;
comma
id|contr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|applid
op_assign
l_int|1
suffix:semicolon
id|applid
op_le
id|CAPI_MAXAPPL
suffix:semicolon
id|applid
op_increment
)paren
(brace
id|ap
op_assign
id|get_capi_appl_by_nr
c_func
(paren
id|applid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap
op_logical_and
id|ap-&gt;callback
)paren
id|ap
op_member_access_from_pointer
id|callback
c_func
(paren
id|KCI_CONTRDOWN
comma
id|contr
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ------------------------------------------------------------ */
DECL|function|notify_doit
r_static
r_void
r_inline
id|notify_doit
c_func
(paren
r_struct
id|capi_notifier
op_star
id|np
)paren
(brace
r_switch
c_cond
(paren
id|np-&gt;cmd
)paren
(brace
r_case
id|KCI_CONTRUP
suffix:colon
id|notify_up
c_func
(paren
id|np-&gt;controller
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KCI_CONTRDOWN
suffix:colon
id|notify_down
c_func
(paren
id|np-&gt;controller
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|notify_handler
r_static
r_void
id|notify_handler
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
r_struct
id|capi_notifier
op_star
id|np
suffix:semicolon
r_while
c_loop
(paren
(paren
id|np
op_assign
id|notify_dequeue
c_func
(paren
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|notify_doit
c_func
(paren
id|np
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|np
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/* -------- Receiver ------------------------------------------ */
DECL|function|recv_handler
r_static
r_void
id|recv_handler
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|capi20_appl
op_star
id|ap
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|recv_queue
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ap
op_assign
id|get_capi_appl_by_nr
c_func
(paren
id|CAPIMSG_APPID
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ap
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: recv_handler: applid %d ? (%s)&bslash;n&quot;
comma
id|ap-&gt;applid
comma
id|capi_message2str
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_DATA_B3
op_logical_and
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
op_eq
id|CAPI_IND
)paren
(brace
id|ap-&gt;nrecvdatapkt
op_increment
suffix:semicolon
)brace
r_else
(brace
id|ap-&gt;nrecvctlpkt
op_increment
suffix:semicolon
)brace
id|ap
op_member_access_from_pointer
id|recv_message
c_func
(paren
id|ap
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
DECL|function|controllercb_handle_capimsg
r_static
r_void
id|controllercb_handle_capimsg
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
comma
id|u16
id|appl
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|showctl
op_assign
l_int|0
suffix:semicolon
id|u8
id|cmd
comma
id|subcmd
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: controller %d not active, got: %s&quot;
comma
id|card-&gt;cnr
comma
id|capi_message2str
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|cmd
op_assign
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|subcmd
op_assign
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|CAPI_DATA_B3
op_logical_and
id|subcmd
op_eq
id|CAPI_IND
)paren
(brace
id|card-&gt;nrecvdatapkt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;traceflag
OG
l_int|2
)paren
id|showctl
op_or_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;nrecvctlpkt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;traceflag
)paren
id|showctl
op_or_assign
l_int|2
suffix:semicolon
)brace
id|showctl
op_or_assign
(paren
id|card-&gt;traceflag
op_amp
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|showctl
op_amp
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|showctl
op_amp
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: got [0x%lx] id#%d %s len=%u&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|card-&gt;cnr
comma
id|CAPIMSG_APPID
c_func
(paren
id|skb-&gt;data
)paren
comma
id|capi_cmd2str
c_func
(paren
id|cmd
comma
id|subcmd
)paren
comma
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: got [0x%lx] %s&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|card-&gt;cnr
comma
id|capi_message2str
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|recv_queue
comma
id|skb
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|tq_recv_notify
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
r_return
suffix:semicolon
id|error
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|controllercb_ready
r_static
r_void
id|controllercb_ready
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
id|u16
id|appl
suffix:semicolon
r_struct
id|capi20_appl
op_star
id|ap
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_RUNNING
suffix:semicolon
r_for
c_loop
(paren
id|appl
op_assign
l_int|1
suffix:semicolon
id|appl
op_le
id|CAPI_MAXAPPL
suffix:semicolon
id|appl
op_increment
)paren
(brace
id|ap
op_assign
id|get_capi_appl_by_nr
c_func
(paren
id|appl
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ap
)paren
r_continue
suffix:semicolon
id|register_appl
c_func
(paren
id|card
comma
id|appl
comma
op_amp
id|ap-&gt;rparam
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: card %d &bslash;&quot;%s&bslash;&quot; ready.&bslash;n&quot;
comma
id|card-&gt;cnr
comma
id|card-&gt;name
)paren
suffix:semicolon
id|notify_push
c_func
(paren
id|KCI_CONTRUP
comma
id|card-&gt;cnr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|controllercb_reseted
r_static
r_void
id|controllercb_reseted
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
id|u16
id|appl
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_DETECTED
)paren
r_return
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
id|memset
c_func
(paren
id|card-&gt;manu
comma
l_int|0
comma
r_sizeof
(paren
id|card-&gt;manu
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|card-&gt;version
comma
l_int|0
comma
r_sizeof
(paren
id|card-&gt;version
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|card-&gt;profile
comma
l_int|0
comma
r_sizeof
(paren
id|card-&gt;profile
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|card-&gt;serial
comma
l_int|0
comma
r_sizeof
(paren
id|card-&gt;serial
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|appl
op_assign
l_int|1
suffix:semicolon
id|appl
op_le
id|CAPI_MAXAPPL
suffix:semicolon
id|appl
op_increment
)paren
(brace
r_struct
id|capi20_appl
op_star
id|ap
op_assign
id|get_capi_appl_by_nr
c_func
(paren
id|appl
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ap
)paren
r_continue
suffix:semicolon
id|capi_ctr_put
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: card %d down.&bslash;n&quot;
comma
id|card-&gt;cnr
)paren
suffix:semicolon
id|notify_push
c_func
(paren
id|KCI_CONTRDOWN
comma
id|card-&gt;cnr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|controllercb_suspend_output
r_static
r_void
id|controllercb_suspend_output
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;blocked
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: card %d suspend&bslash;n&quot;
comma
id|card-&gt;cnr
)paren
suffix:semicolon
id|card-&gt;blocked
op_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|controllercb_resume_output
r_static
r_void
id|controllercb_resume_output
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;blocked
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: card %d resume&bslash;n&quot;
comma
id|card-&gt;cnr
)paren
suffix:semicolon
id|card-&gt;blocked
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* ------------------------------------------------------------- */
r_int
DECL|function|attach_capi_ctr
id|attach_capi_ctr
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|capi_cards
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|CAPI_MAXCONTR
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: out of controller slots&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|capi_cards
(braket
id|i
)braket
op_assign
id|card
suffix:semicolon
id|card-&gt;nrecvctlpkt
op_assign
l_int|0
suffix:semicolon
id|card-&gt;nrecvdatapkt
op_assign
l_int|0
suffix:semicolon
id|card-&gt;nsentctlpkt
op_assign
l_int|0
suffix:semicolon
id|card-&gt;nsentdatapkt
op_assign
l_int|0
suffix:semicolon
id|card-&gt;cnr
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
id|card-&gt;blocked
op_assign
l_int|0
suffix:semicolon
id|card-&gt;traceflag
op_assign
id|showcapimsgs
suffix:semicolon
id|card-&gt;ready
op_assign
id|controllercb_ready
suffix:semicolon
id|card-&gt;reseted
op_assign
id|controllercb_reseted
suffix:semicolon
id|card-&gt;suspend_output
op_assign
id|controllercb_suspend_output
suffix:semicolon
id|card-&gt;resume_output
op_assign
id|controllercb_resume_output
suffix:semicolon
id|card-&gt;handle_capimsg
op_assign
id|controllercb_handle_capimsg
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|card-&gt;driver_list
comma
op_amp
id|card-&gt;driver-&gt;contr_head
)paren
suffix:semicolon
id|card-&gt;driver-&gt;ncontroller
op_increment
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;procfn
comma
l_string|&quot;capi/controllers/%d&quot;
comma
id|card-&gt;cnr
)paren
suffix:semicolon
id|card-&gt;procent
op_assign
id|create_proc_entry
c_func
(paren
id|card-&gt;procfn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;procent
)paren
(brace
id|card-&gt;procent-&gt;read_proc
op_assign
(paren
r_int
(paren
op_star
)paren
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
comma
r_int
op_star
comma
r_void
op_star
)paren
)paren
id|card-&gt;ctr_read_proc
suffix:semicolon
id|card-&gt;procent-&gt;data
op_assign
id|card
suffix:semicolon
)brace
id|ncards
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: Controller %d: %s attached&bslash;n&quot;
comma
id|card-&gt;cnr
comma
id|card-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|attach_capi_ctr
id|EXPORT_SYMBOL
c_func
(paren
id|attach_capi_ctr
)paren
suffix:semicolon
DECL|function|detach_capi_ctr
r_int
id|detach_capi_ctr
c_func
(paren
r_struct
id|capi_ctr
op_star
id|card
)paren
(brace
r_struct
id|capi_driver
op_star
id|driver
op_assign
id|card-&gt;driver
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_ne
id|CARD_DETECTED
)paren
id|controllercb_reseted
c_func
(paren
id|card
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|card-&gt;driver_list
)paren
suffix:semicolon
id|driver-&gt;ncontroller
op_decrement
suffix:semicolon
id|ncards
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;procent
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|card-&gt;procfn
comma
l_int|0
)paren
suffix:semicolon
id|card-&gt;procent
op_assign
l_int|0
suffix:semicolon
)brace
id|capi_cards
(braket
id|card-&gt;cnr
op_minus
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: Controller %d: %s unregistered&bslash;n&quot;
comma
id|card-&gt;cnr
comma
id|card-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|detach_capi_ctr
id|EXPORT_SYMBOL
c_func
(paren
id|detach_capi_ctr
)paren
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
DECL|function|attach_capi_driver
r_void
id|attach_capi_driver
c_func
(paren
r_struct
id|capi_driver
op_star
id|driver
)paren
(brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|driver-&gt;contr_head
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|capi_drivers_lock
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|driver-&gt;driver_list
comma
op_amp
id|capi_drivers
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|capi_drivers_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: driver %s attached&bslash;n&quot;
comma
id|driver-&gt;name
)paren
suffix:semicolon
)brace
DECL|variable|attach_capi_driver
id|EXPORT_SYMBOL
c_func
(paren
id|attach_capi_driver
)paren
suffix:semicolon
DECL|function|detach_capi_driver
r_void
id|detach_capi_driver
c_func
(paren
r_struct
id|capi_driver
op_star
id|driver
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|capi_drivers_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|driver-&gt;driver_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|capi_drivers_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;kcapi: driver %s detached&bslash;n&quot;
comma
id|driver-&gt;name
)paren
suffix:semicolon
)brace
DECL|variable|detach_capi_driver
id|EXPORT_SYMBOL
c_func
(paren
id|detach_capi_driver
)paren
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
multiline_comment|/* -------- CAPI2.0 Interface ---------------------------------- */
multiline_comment|/* ------------------------------------------------------------- */
DECL|function|capi20_isinstalled
id|u16
id|capi20_isinstalled
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|capi_cards
(braket
id|i
)braket
op_logical_and
id|capi_cards
(braket
id|i
)braket
op_member_access_from_pointer
id|cardstate
op_eq
id|CARD_RUNNING
)paren
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
)brace
DECL|variable|capi20_isinstalled
id|EXPORT_SYMBOL
c_func
(paren
id|capi20_isinstalled
)paren
suffix:semicolon
DECL|function|capi20_register
id|u16
id|capi20_register
c_func
(paren
r_struct
id|capi20_appl
op_star
id|ap
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|applid
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;rparam.datablklen
OL
l_int|128
)paren
r_return
id|CAPI_LOGBLKSIZETOSMALL
suffix:semicolon
r_for
c_loop
(paren
id|applid
op_assign
l_int|1
suffix:semicolon
id|applid
op_le
id|CAPI_MAXAPPL
suffix:semicolon
id|applid
op_increment
)paren
(brace
r_if
c_cond
(paren
id|capi_applications
(braket
id|applid
op_minus
l_int|1
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|applid
OG
id|CAPI_MAXAPPL
)paren
r_return
id|CAPI_TOOMANYAPPLS
suffix:semicolon
id|ap-&gt;applid
op_assign
id|applid
suffix:semicolon
id|capi_applications
(braket
id|applid
op_minus
l_int|1
)braket
op_assign
id|ap
suffix:semicolon
id|ap-&gt;nrecvctlpkt
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;nrecvdatapkt
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;nsentctlpkt
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;nsentdatapkt
op_assign
l_int|0
suffix:semicolon
id|ap-&gt;callback
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|capi_cards
(braket
id|i
)braket
op_logical_or
id|capi_cards
(braket
id|i
)braket
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_continue
suffix:semicolon
id|register_appl
c_func
(paren
id|capi_cards
(braket
id|i
)braket
comma
id|applid
comma
op_amp
id|ap-&gt;rparam
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: appl %d up&bslash;n&quot;
comma
id|applid
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|variable|capi20_register
id|EXPORT_SYMBOL
c_func
(paren
id|capi20_register
)paren
suffix:semicolon
DECL|function|capi20_release
id|u16
id|capi20_release
c_func
(paren
r_struct
id|capi20_appl
op_star
id|ap
)paren
(brace
r_int
id|i
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;applid %#x&quot;
comma
id|ap-&gt;applid
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CAPI_MAXCONTR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|capi_cards
(braket
id|i
)braket
op_logical_or
id|capi_cards
(braket
id|i
)braket
op_member_access_from_pointer
id|cardstate
op_ne
id|CARD_RUNNING
)paren
r_continue
suffix:semicolon
id|release_appl
c_func
(paren
id|capi_cards
(braket
id|i
)braket
comma
id|ap-&gt;applid
)paren
suffix:semicolon
)brace
id|capi_applications
(braket
id|ap-&gt;applid
op_minus
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: appl %d down&bslash;n&quot;
comma
id|ap-&gt;applid
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|variable|capi20_release
id|EXPORT_SYMBOL
c_func
(paren
id|capi20_release
)paren
suffix:semicolon
DECL|function|capi20_put_message
id|u16
id|capi20_put_message
c_func
(paren
r_struct
id|capi20_appl
op_star
id|ap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|capi_ctr
op_star
id|card
suffix:semicolon
r_int
id|showctl
op_assign
l_int|0
suffix:semicolon
id|u8
id|cmd
comma
id|subcmd
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;applid %#x&quot;
comma
id|ap-&gt;applid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ncards
op_eq
l_int|0
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;applid
op_eq
l_int|0
)paren
r_return
id|CAPI_ILLAPPNR
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
l_int|12
op_logical_or
op_logical_neg
id|capi_cmd_valid
c_func
(paren
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
)paren
op_logical_or
op_logical_neg
id|capi_subcmd_valid
c_func
(paren
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
)paren
)paren
r_return
id|CAPI_ILLCMDORSUBCMDORMSGTOSMALL
suffix:semicolon
id|card
op_assign
id|get_capi_ctr_by_nr
c_func
(paren
id|CAPIMSG_CONTROLLER
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
op_logical_or
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
(brace
id|card
op_assign
id|get_capi_ctr_by_nr
c_func
(paren
l_int|1
)paren
suffix:semicolon
singleline_comment|// XXX why?
r_if
c_cond
(paren
op_logical_neg
id|card
op_logical_or
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;blocked
)paren
r_return
id|CAPI_SENDQUEUEFULL
suffix:semicolon
id|cmd
op_assign
id|CAPIMSG_COMMAND
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
id|subcmd
op_assign
id|CAPIMSG_SUBCOMMAND
c_func
(paren
id|skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|CAPI_DATA_B3
op_logical_and
id|subcmd
op_eq
id|CAPI_REQ
)paren
(brace
id|card-&gt;nsentdatapkt
op_increment
suffix:semicolon
id|ap-&gt;nsentdatapkt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;traceflag
OG
l_int|2
)paren
id|showctl
op_or_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;nsentctlpkt
op_increment
suffix:semicolon
id|ap-&gt;nsentctlpkt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;traceflag
)paren
id|showctl
op_or_assign
l_int|2
suffix:semicolon
)brace
id|showctl
op_or_assign
(paren
id|card-&gt;traceflag
op_amp
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|showctl
op_amp
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|showctl
op_amp
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: put [%#x] id#%d %s len=%u&bslash;n&quot;
comma
id|CAPIMSG_CONTROLLER
c_func
(paren
id|skb-&gt;data
)paren
comma
id|CAPIMSG_APPID
c_func
(paren
id|skb-&gt;data
)paren
comma
id|capi_cmd2str
c_func
(paren
id|cmd
comma
id|subcmd
)paren
comma
id|CAPIMSG_LEN
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: put [%#x] %s&bslash;n&quot;
comma
id|CAPIMSG_CONTROLLER
c_func
(paren
id|skb-&gt;data
)paren
comma
id|capi_message2str
c_func
(paren
id|skb-&gt;data
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
id|card
op_member_access_from_pointer
id|send_message
c_func
(paren
id|card
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|variable|capi20_put_message
id|EXPORT_SYMBOL
c_func
(paren
id|capi20_put_message
)paren
suffix:semicolon
DECL|function|capi20_get_manufacturer
id|u16
id|capi20_get_manufacturer
c_func
(paren
id|u32
id|contr
comma
id|u8
id|buf
(braket
id|CAPI_MANUFACTURER_LEN
)braket
)paren
(brace
r_struct
id|capi_ctr
op_star
id|card
suffix:semicolon
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
id|strncpy
c_func
(paren
id|buf
comma
id|capi_manufakturer
comma
id|CAPI_MANUFACTURER_LEN
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
id|card
op_assign
id|get_capi_ctr_by_nr
c_func
(paren
id|contr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
op_logical_or
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
id|strncpy
c_func
(paren
id|buf
comma
id|card-&gt;manu
comma
id|CAPI_MANUFACTURER_LEN
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|variable|capi20_get_manufacturer
id|EXPORT_SYMBOL
c_func
(paren
id|capi20_get_manufacturer
)paren
suffix:semicolon
DECL|function|capi20_get_version
id|u16
id|capi20_get_version
c_func
(paren
id|u32
id|contr
comma
r_struct
id|capi_version
op_star
id|verp
)paren
(brace
r_struct
id|capi_ctr
op_star
id|card
suffix:semicolon
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
op_star
id|verp
op_assign
id|driver_version
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
id|card
op_assign
id|get_capi_ctr_by_nr
c_func
(paren
id|contr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
op_logical_or
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|verp
comma
op_amp
id|card-&gt;version
comma
r_sizeof
(paren
id|capi_version
)paren
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|variable|capi20_get_version
id|EXPORT_SYMBOL
c_func
(paren
id|capi20_get_version
)paren
suffix:semicolon
DECL|function|capi20_get_serial
id|u16
id|capi20_get_serial
c_func
(paren
id|u32
id|contr
comma
id|u8
id|serial
(braket
id|CAPI_SERIAL_LEN
)braket
)paren
(brace
r_struct
id|capi_ctr
op_star
id|card
suffix:semicolon
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
id|strncpy
c_func
(paren
id|serial
comma
id|driver_serial
comma
id|CAPI_SERIAL_LEN
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
id|card
op_assign
id|get_capi_ctr_by_nr
c_func
(paren
id|contr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
op_logical_or
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
id|strncpy
c_func
(paren
(paren
r_void
op_star
)paren
id|serial
comma
id|card-&gt;serial
comma
id|CAPI_SERIAL_LEN
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|variable|capi20_get_serial
id|EXPORT_SYMBOL
c_func
(paren
id|capi20_get_serial
)paren
suffix:semicolon
DECL|function|capi20_get_profile
id|u16
id|capi20_get_profile
c_func
(paren
id|u32
id|contr
comma
r_struct
id|capi_profile
op_star
id|profp
)paren
(brace
r_struct
id|capi_ctr
op_star
id|card
suffix:semicolon
r_if
c_cond
(paren
id|contr
op_eq
l_int|0
)paren
(brace
id|profp-&gt;ncontroller
op_assign
id|ncards
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
id|card
op_assign
id|get_capi_ctr_by_nr
c_func
(paren
id|contr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
op_logical_or
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
r_return
id|CAPI_REGNOTINSTALLED
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|profp
comma
op_amp
id|card-&gt;profile
comma
r_sizeof
(paren
r_struct
id|capi_profile
)paren
)paren
suffix:semicolon
r_return
id|CAPI_NOERROR
suffix:semicolon
)brace
DECL|variable|capi20_get_profile
id|EXPORT_SYMBOL
c_func
(paren
id|capi20_get_profile
)paren
suffix:semicolon
DECL|function|find_driver
r_static
r_struct
id|capi_driver
op_star
id|find_driver
c_func
(paren
r_char
op_star
id|name
)paren
(brace
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_struct
id|capi_driver
op_star
id|dp
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|capi_drivers_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|capi_drivers
)paren
(brace
id|dp
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|capi_driver
comma
id|driver_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|dp-&gt;name
comma
id|name
)paren
op_eq
l_int|0
)paren
r_goto
id|found
suffix:semicolon
)brace
id|dp
op_assign
l_int|NULL
suffix:semicolon
id|found
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|capi_drivers_lock
)paren
suffix:semicolon
r_return
id|dp
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_AVMB1_COMPAT
DECL|function|old_capi_manufacturer
r_static
r_int
id|old_capi_manufacturer
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|data
)paren
(brace
id|avmb1_loadandconfigdef
id|ldef
suffix:semicolon
id|avmb1_resetdef
id|rdef
suffix:semicolon
id|avmb1_getdef
id|gdef
suffix:semicolon
r_struct
id|capi_ctr
op_star
id|card
suffix:semicolon
id|capiloaddata
id|ldata
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|AVMB1_LOAD
suffix:colon
r_case
id|AVMB1_LOAD_AND_CONFIG
suffix:colon
r_if
c_cond
(paren
id|cmd
op_eq
id|AVMB1_LOAD
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ldef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_loaddef
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ldef.t4config.len
op_assign
l_int|0
suffix:semicolon
id|ldef.t4config.data
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|ldef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_loadandconfigdef
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|card
op_assign
id|get_capi_ctr_by_nr
c_func
(paren
id|ldef.contr
)paren
suffix:semicolon
id|card
op_assign
id|capi_ctr_get
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;load_firmware
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: load: driver &bslash;%s&bslash;&quot; has no load function&bslash;n&quot;
comma
id|card-&gt;driver-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ldef.t4file.len
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: load: invalid parameter: length of t4file is %d ?&bslash;n&quot;
comma
id|ldef.t4file.len
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ldef.t4file.data
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;kcapi: load: invalid parameter: dataptr is 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ldata.firmware.user
op_assign
l_int|1
suffix:semicolon
id|ldata.firmware.data
op_assign
id|ldef.t4file.data
suffix:semicolon
id|ldata.firmware.len
op_assign
id|ldef.t4file.len
suffix:semicolon
id|ldata.configuration.user
op_assign
l_int|1
suffix:semicolon
id|ldata.configuration.data
op_assign
id|ldef.t4config.data
suffix:semicolon
id|ldata.configuration.len
op_assign
id|ldef.t4config.len
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_ne
id|CARD_DETECTED
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: load: contr=%d not in detect state&bslash;n&quot;
comma
id|ldef.contr
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|card-&gt;cardstate
op_assign
id|CARD_LOADING
suffix:semicolon
id|retval
op_assign
id|card
op_member_access_from_pointer
id|load_firmware
c_func
(paren
id|card
comma
op_amp
id|ldata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|card-&gt;cardstate
op_assign
id|CARD_DETECTED
suffix:semicolon
id|capi_ctr_put
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_while
c_loop
(paren
id|card-&gt;cardstate
op_ne
id|CARD_RUNNING
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 0.1 sec */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|capi_ctr_put
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
)brace
id|capi_ctr_put
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|AVMB1_RESETCARD
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|rdef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_resetdef
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|card
op_assign
id|get_capi_ctr_by_nr
c_func
(paren
id|rdef.contr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;cardstate
op_eq
id|CARD_DETECTED
)paren
r_return
l_int|0
suffix:semicolon
id|card
op_member_access_from_pointer
id|reset_ctr
c_func
(paren
id|card
)paren
suffix:semicolon
r_while
c_loop
(paren
id|card-&gt;cardstate
OG
id|CARD_DETECTED
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 0.1 sec */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|AVMB1_GET_CARDINFO
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|gdef
comma
id|data
comma
r_sizeof
(paren
id|avmb1_getdef
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|card
op_assign
id|get_capi_ctr_by_nr
c_func
(paren
id|gdef.contr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|gdef.cardstate
op_assign
id|card-&gt;cardstate
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;driver
op_eq
id|find_driver
c_func
(paren
l_string|&quot;t1isa&quot;
)paren
)paren
id|gdef.cardtype
op_assign
id|AVM_CARDTYPE_T1
suffix:semicolon
r_else
id|gdef.cardtype
op_assign
id|AVM_CARDTYPE_B1
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|data
comma
(paren
r_void
op_star
)paren
op_amp
id|gdef
comma
r_sizeof
(paren
id|avmb1_getdef
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
DECL|function|capi20_manufacturer
r_int
id|capi20_manufacturer
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|capi_ctr
op_star
id|card
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
macro_line|#ifdef CONFIG_AVMB1_COMPAT
r_case
id|AVMB1_LOAD
suffix:colon
r_case
id|AVMB1_LOAD_AND_CONFIG
suffix:colon
r_case
id|AVMB1_RESETCARD
suffix:colon
r_case
id|AVMB1_GET_CARDINFO
suffix:colon
r_case
id|AVMB1_REMOVECARD
suffix:colon
r_return
id|old_capi_manufacturer
c_func
(paren
id|cmd
comma
id|data
)paren
suffix:semicolon
macro_line|#endif
r_case
id|KCAPI_CMD_TRACE
suffix:colon
(brace
id|kcapi_flagdef
id|fdef
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|fdef
comma
id|data
comma
r_sizeof
(paren
id|kcapi_flagdef
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|card
op_assign
id|get_capi_ctr_by_nr
c_func
(paren
id|fdef.contr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|card-&gt;traceflag
op_assign
id|fdef.flag
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kcapi: contr %d set trace=%d&bslash;n&quot;
comma
id|card-&gt;cnr
comma
id|card-&gt;traceflag
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kcapi: manufacturer command %d unknown.&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|capi20_manufacturer
id|EXPORT_SYMBOL
c_func
(paren
id|capi20_manufacturer
)paren
suffix:semicolon
multiline_comment|/* temporary hack */
DECL|function|capi20_set_callback
r_void
id|capi20_set_callback
c_func
(paren
r_struct
id|capi20_appl
op_star
id|ap
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_int
r_int
id|cmd
comma
id|__u32
id|contr
comma
r_void
op_star
id|data
)paren
)paren
(brace
id|ap-&gt;callback
op_assign
id|callback
suffix:semicolon
)brace
DECL|variable|capi20_set_callback
id|EXPORT_SYMBOL
c_func
(paren
id|capi20_set_callback
)paren
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------- */
multiline_comment|/* -------- Init &amp; Cleanup ------------------------------------- */
multiline_comment|/* ------------------------------------------------------------- */
multiline_comment|/*&n; * init / exit functions&n; */
DECL|function|kcapi_init
r_static
r_int
id|__init
id|kcapi_init
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_char
id|rev
(braket
l_int|32
)braket
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|recv_queue
)paren
suffix:semicolon
id|tq_state_notify.routine
op_assign
id|notify_handler
suffix:semicolon
id|tq_state_notify.data
op_assign
l_int|0
suffix:semicolon
id|tq_recv_notify.routine
op_assign
id|recv_handler
suffix:semicolon
id|tq_recv_notify.data
op_assign
l_int|0
suffix:semicolon
id|kcapi_proc_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|revision
comma
l_char|&squot;:&squot;
)paren
)paren
op_ne
l_int|0
op_logical_and
id|p
(braket
l_int|1
)braket
)paren
(brace
id|strncpy
c_func
(paren
id|rev
comma
id|p
op_plus
l_int|2
comma
r_sizeof
(paren
id|rev
)paren
)paren
suffix:semicolon
id|rev
(braket
r_sizeof
(paren
id|rev
)paren
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strchr
c_func
(paren
id|rev
comma
l_char|&squot;$&squot;
)paren
)paren
op_ne
l_int|0
op_logical_and
id|p
OG
id|rev
)paren
op_star
(paren
id|p
op_minus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|strcpy
c_func
(paren
id|rev
comma
l_string|&quot;1.0&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;CAPI Subsystem Rev %s&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|kcapi_exit
r_static
r_void
id|__exit
id|kcapi_exit
c_func
(paren
r_void
)paren
(brace
id|kcapi_proc_exit
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|kcapi_init
id|module_init
c_func
(paren
id|kcapi_init
)paren
suffix:semicolon
DECL|variable|kcapi_exit
id|module_exit
c_func
(paren
id|kcapi_exit
)paren
suffix:semicolon
eof
