multiline_comment|/* Linux ISDN subsystem, network interface support code&n; *&n; * Copyright 1994-1998  by Fritz Elfert (fritz@isdn4linux.de)&n; *           1995,96    by Thinking Objects Software GmbH Wuerzburg&n; *           1995,96    by Michael Hipp (Michael.Hipp@student.uni-tuebingen.de)&n; *           1999-2002  by Kai Germaschewski &lt;kai@germaschewski.name&gt;&n; *&n; * This software may be used and distributed according to the terms&n; * of the GNU General Public License, incorporated herein by reference.&n; */
multiline_comment|/*&n; * Data Over Voice (DOV) support added - Guy Ellis 23-Mar-02 &n; *                                       guy@traverse.com.au&n; * Outgoing calls - looks for a &squot;V&squot; in first char of dialed number&n; * Incoming calls - checks first character of eaz as follows:&n; *   Numeric - accept DATA only - original functionality&n; *   &squot;V&squot;     - accept VOICE (DOV) only&n; *   &squot;B&squot;     - accept BOTH DATA and DOV types&n; *&n; */
multiline_comment|/* Locking works as follows: &n; *&n; * The configuration of isdn_net_devs works via ioctl on&n; * /dev/isdnctrl (for legacy reasons).&n; * All configuration accesses are globally serialized by means of&n; * the global semaphore &amp;sem.&n; * &n; * All other uses of isdn_net_dev will only happen when the corresponding&n; * struct net_device has been opened. So in the non-config code we can&n; * rely on the config data not changing under us.&n; *&n; * To achieve this, in the &quot;writing&quot; ioctls, that is those which may change&n; * data, additionally grep the rtnl semaphore and check to make sure&n; * that the net_device has not been openend (&quot;netif_running()&quot;)&n; *&n; * isdn_net_dev&squot;s are added to the global list &quot;isdn_net_devs&quot; in the&n; * configuration ioctls, so accesses to that list are protected by&n; * &amp;sem as well.&n; *&n; * Incoming calls are signalled in IRQ context, so we cannot take &amp;sem&n; * while walking the list of devices. To handle this, we put devices&n; * onto a &quot;running&quot; list, which is protected by a spin lock and can thus&n; * be traversed in IRQ context. If a matching isdn_net_dev is found,&n; * it&squot;s ref count shall be incremented, to make sure no racing&n; * net_device::close() can take it away under us. &n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/capability.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &quot;isdn_common.h&quot;
macro_line|#include &quot;isdn_net_lib.h&quot;
macro_line|#include &quot;isdn_net.h&quot;
macro_line|#include &quot;isdn_ppp.h&quot;
macro_line|#include &quot;isdn_ciscohdlck.h&quot;
DECL|macro|ISDN_NET_TX_TIMEOUT
mdefine_line|#define ISDN_NET_TX_TIMEOUT (20*HZ) 
multiline_comment|/* All of this configuration code is globally serialized */
r_static
id|DECLARE_MUTEX
c_func
(paren
id|sem
)paren
suffix:semicolon
DECL|variable|isdn_net_devs
id|LIST_HEAD
c_func
(paren
id|isdn_net_devs
)paren
suffix:semicolon
multiline_comment|/* Linked list of isdn_net_dev&squot;s */
singleline_comment|// FIXME static
multiline_comment|/* Reference counting for net devices (they work on isdn_net_local *,&n; * but count references to the related isdn_net_dev&squot;s as well.&n; * Basic rule: When state of isdn_net_dev changes from ST_NULL -&gt; sth,&n; * get a reference, when it changes back to ST_NULL, put it&n; */
r_static
r_inline
r_void
DECL|function|lp_get
id|lp_get
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|lp-&gt;refcnt
)paren
OL
l_int|1
)paren
id|isdn_BUG
c_func
(paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lp-&gt;refcnt
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|lp_put
id|lp_put
c_func
(paren
id|isdn_net_local
op_star
id|lp
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|lp-&gt;refcnt
)paren
suffix:semicolon
multiline_comment|/* the last reference, the list should always remain */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|lp-&gt;refcnt
)paren
OL
l_int|1
)paren
id|isdn_BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_int
id|isdn_net_handle_event
c_func
(paren
id|isdn_net_dev
op_star
id|idev
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
suffix:semicolon
r_static
r_void
id|isdn_net_tasklet
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|isdn_net_dial_timer
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_int
id|isdn_init_netif
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
suffix:semicolon
r_static
r_void
id|isdn_net_dev_debug
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
suffix:semicolon
r_static
r_int
id|isdn_net_dial
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
suffix:semicolon
r_static
r_int
id|isdn_net_bsent
c_func
(paren
id|isdn_net_dev
op_star
id|idev
comma
id|isdn_ctrl
op_star
id|c
)paren
suffix:semicolon
DECL|variable|isdn_net_fsm
r_static
r_struct
id|fsm
id|isdn_net_fsm
suffix:semicolon
r_enum
(brace
DECL|enumerator|ST_NULL
id|ST_NULL
comma
DECL|enumerator|ST_OUT_BOUND
id|ST_OUT_BOUND
comma
DECL|enumerator|ST_OUT_WAIT_DCONN
id|ST_OUT_WAIT_DCONN
comma
DECL|enumerator|ST_OUT_WAIT_BCONN
id|ST_OUT_WAIT_BCONN
comma
DECL|enumerator|ST_IN_WAIT_DCONN
id|ST_IN_WAIT_DCONN
comma
DECL|enumerator|ST_IN_WAIT_BCONN
id|ST_IN_WAIT_BCONN
comma
DECL|enumerator|ST_ACTIVE
id|ST_ACTIVE
comma
DECL|enumerator|ST_WAIT_DHUP
id|ST_WAIT_DHUP
comma
DECL|enumerator|ST_WAIT_BEFORE_CB
id|ST_WAIT_BEFORE_CB
comma
DECL|enumerator|ST_OUT_DIAL_WAIT
id|ST_OUT_DIAL_WAIT
comma
)brace
suffix:semicolon
DECL|variable|isdn_net_st_str
r_static
r_char
op_star
id|isdn_net_st_str
(braket
)braket
op_assign
(brace
l_string|&quot;ST_NULL&quot;
comma
l_string|&quot;ST_OUT_BOUND&quot;
comma
l_string|&quot;ST_OUT_WAIT_DCONN&quot;
comma
l_string|&quot;ST_OUT_WAIT_BCONN&quot;
comma
l_string|&quot;ST_IN_WAIT_DCONN&quot;
comma
l_string|&quot;ST_IN_WAIT_BCONN&quot;
comma
l_string|&quot;ST_ACTIVE&quot;
comma
l_string|&quot;ST_WAIT_DHUP&quot;
comma
l_string|&quot;ST_WAIT_BEFORE_CB&quot;
comma
l_string|&quot;ST_OUT_DIAL_WAIT&quot;
comma
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|EV_TIMER_INCOMING
id|EV_TIMER_INCOMING
comma
DECL|enumerator|EV_TIMER_DIAL
id|EV_TIMER_DIAL
comma
DECL|enumerator|EV_TIMER_DIAL_WAIT
id|EV_TIMER_DIAL_WAIT
comma
DECL|enumerator|EV_TIMER_CB_OUT
id|EV_TIMER_CB_OUT
comma
DECL|enumerator|EV_TIMER_CB_IN
id|EV_TIMER_CB_IN
comma
DECL|enumerator|EV_TIMER_HUP
id|EV_TIMER_HUP
comma
DECL|enumerator|EV_STAT_DCONN
id|EV_STAT_DCONN
comma
DECL|enumerator|EV_STAT_BCONN
id|EV_STAT_BCONN
comma
DECL|enumerator|EV_STAT_DHUP
id|EV_STAT_DHUP
comma
DECL|enumerator|EV_STAT_BHUP
id|EV_STAT_BHUP
comma
DECL|enumerator|EV_STAT_CINF
id|EV_STAT_CINF
comma
DECL|enumerator|EV_STAT_BSENT
id|EV_STAT_BSENT
comma
DECL|enumerator|EV_DO_DIAL
id|EV_DO_DIAL
comma
DECL|enumerator|EV_DO_CALLBACK
id|EV_DO_CALLBACK
comma
DECL|enumerator|EV_DO_ACCEPT
id|EV_DO_ACCEPT
comma
)brace
suffix:semicolon
DECL|variable|isdn_net_ev_str
r_static
r_char
op_star
id|isdn_net_ev_str
(braket
)braket
op_assign
(brace
l_string|&quot;EV_NET_TIMER_INCOMING&quot;
comma
l_string|&quot;EV_NET_TIMER_DIAL&quot;
comma
l_string|&quot;EV_NET_TIMER_DIAL_WAIT&quot;
comma
l_string|&quot;EV_NET_TIMER_CB_OUT&quot;
comma
l_string|&quot;EV_NET_TIMER_CB_IN&quot;
comma
l_string|&quot;EV_NET_TIMER_HUP&quot;
comma
l_string|&quot;EV_STAT_DCONN&quot;
comma
l_string|&quot;EV_STAT_BCONN&quot;
comma
l_string|&quot;EV_STAT_DHUP&quot;
comma
l_string|&quot;EV_STAT_BHUP&quot;
comma
l_string|&quot;EV_STAT_CINF&quot;
comma
l_string|&quot;EV_STAT_BSENT&quot;
comma
l_string|&quot;EV_DO_DIAL&quot;
comma
l_string|&quot;EV_DO_CALLBACK&quot;
comma
l_string|&quot;EV_DO_ACCEPT&quot;
comma
)brace
suffix:semicolon
multiline_comment|/* Definitions for hupflags: */
DECL|macro|ISDN_CHARGEHUP
mdefine_line|#define ISDN_CHARGEHUP   4      /* We want to use the charge mechanism      */
DECL|macro|ISDN_INHUP
mdefine_line|#define ISDN_INHUP       8      /* Even if incoming, close after huptimeout */
DECL|macro|ISDN_MANCHARGE
mdefine_line|#define ISDN_MANCHARGE  16      /* Charge Interval manually set             */
r_enum
(brace
DECL|enumerator|ST_CHARGE_NULL
id|ST_CHARGE_NULL
comma
DECL|enumerator|ST_CHARGE_GOT_CINF
id|ST_CHARGE_GOT_CINF
comma
multiline_comment|/* got a first charge info */
DECL|enumerator|ST_CHARGE_HAVE_CINT
id|ST_CHARGE_HAVE_CINT
comma
multiline_comment|/* got a second chare info and thus the timing */
)brace
suffix:semicolon
multiline_comment|/* ====================================================================== */
multiline_comment|/* Registration of ISDN network interface types                           */
multiline_comment|/* ====================================================================== */
DECL|variable|isdn_netif_ops
r_static
r_struct
id|isdn_netif_ops
op_star
id|isdn_netif_ops
(braket
id|ISDN_NET_ENCAP_NR
)braket
suffix:semicolon
r_int
DECL|function|register_isdn_netif
id|register_isdn_netif
c_func
(paren
r_int
id|encap
comma
r_struct
id|isdn_netif_ops
op_star
id|ops
)paren
(brace
r_if
c_cond
(paren
id|encap
OL
l_int|0
op_logical_or
id|encap
op_ge
id|ISDN_NET_ENCAP_NR
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|isdn_netif_ops
(braket
id|encap
)braket
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|isdn_netif_ops
(braket
id|encap
)braket
op_assign
id|ops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ====================================================================== */
multiline_comment|/* Helpers                                                                */
multiline_comment|/* ====================================================================== */
multiline_comment|/* Search list of net-interfaces for an interface with given name. */
r_static
id|isdn_net_dev
op_star
DECL|function|isdn_net_findif
id|isdn_net_findif
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|idev
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|idev
comma
op_amp
id|isdn_net_devs
comma
id|global_list
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|idev-&gt;name
comma
id|name
)paren
)paren
r_return
id|idev
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Set up a certain encapsulation */
r_static
r_int
DECL|function|isdn_net_set_encap
id|isdn_net_set_encap
c_func
(paren
id|isdn_net_local
op_star
id|lp
comma
r_int
id|encap
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;p_encap
op_eq
id|encap
)paren
(brace
multiline_comment|/* nothing to do */
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_running
c_func
(paren
op_amp
id|lp-&gt;dev
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lp-&gt;ops
op_logical_and
id|lp-&gt;ops-&gt;cleanup
)paren
id|lp-&gt;ops
op_member_access_from_pointer
id|cleanup
c_func
(paren
id|lp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|encap
OL
l_int|0
op_logical_or
id|encap
op_ge
id|ISDN_NET_ENCAP_NR
op_logical_or
op_logical_neg
id|isdn_netif_ops
(braket
id|encap
)braket
)paren
(brace
id|lp-&gt;p_encap
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;ops
op_assign
l_int|NULL
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|lp-&gt;p_encap
op_assign
id|encap
suffix:semicolon
id|lp-&gt;ops
op_assign
id|isdn_netif_ops
(braket
id|encap
)braket
suffix:semicolon
id|lp-&gt;dev.hard_start_xmit
op_assign
id|lp-&gt;ops-&gt;hard_start_xmit
suffix:semicolon
id|lp-&gt;dev.hard_header
op_assign
id|lp-&gt;ops-&gt;hard_header
suffix:semicolon
id|lp-&gt;dev.do_ioctl
op_assign
id|lp-&gt;ops-&gt;do_ioctl
suffix:semicolon
id|lp-&gt;dev.flags
op_assign
id|lp-&gt;ops-&gt;flags
suffix:semicolon
id|lp-&gt;dev.type
op_assign
id|lp-&gt;ops-&gt;type
suffix:semicolon
id|lp-&gt;dev.addr_len
op_assign
id|lp-&gt;ops-&gt;addr_len
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;ops-&gt;init
)paren
id|retval
op_assign
id|lp-&gt;ops
op_member_access_from_pointer
id|init
c_func
(paren
id|lp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|lp-&gt;p_encap
op_assign
op_minus
l_int|1
suffix:semicolon
id|lp-&gt;ops
op_assign
l_int|NULL
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_net_bind
id|isdn_net_bind
c_func
(paren
id|isdn_net_dev
op_star
id|idev
comma
id|isdn_net_ioctl_cfg
op_star
id|cfg
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|drvidx
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|chidx
op_assign
op_minus
l_int|1
suffix:semicolon
r_char
id|drvid
(braket
l_int|25
)braket
suffix:semicolon
id|strncpy
c_func
(paren
id|drvid
comma
id|cfg-&gt;drvid
comma
l_int|24
)paren
suffix:semicolon
id|drvid
(braket
l_int|24
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;exclusive
op_logical_and
op_logical_neg
id|strlen
c_func
(paren
id|drvid
)paren
)paren
(brace
multiline_comment|/* If we want to bind exclusively, need to specify drv/chan */
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|drvid
)paren
)paren
(brace
multiline_comment|/* A bind has been requested ... */
r_char
op_star
id|c
op_assign
id|strchr
c_func
(paren
id|drvid
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* The channel-number is appended to the driver-Id with a comma */
op_star
id|c
op_assign
l_int|0
suffix:semicolon
id|chidx
op_assign
id|simple_strtol
c_func
(paren
id|c
op_plus
l_int|1
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|drvidx
op_assign
id|isdn_drv_lookup
c_func
(paren
id|drvid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvidx
op_eq
op_minus
l_int|1
op_logical_or
id|chidx
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Either driver-Id or channel-number invalid */
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cfg-&gt;exclusive
op_eq
(paren
id|idev-&gt;exclusive
op_ge
l_int|0
)paren
op_logical_and
id|drvidx
op_eq
id|idev-&gt;pre_device
op_logical_and
id|chidx
op_eq
id|idev-&gt;pre_channel
)paren
(brace
multiline_comment|/* no change */
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idev-&gt;exclusive
op_ge
l_int|0
)paren
(brace
id|isdn_slot_free
c_func
(paren
id|idev-&gt;exclusive
)paren
suffix:semicolon
id|idev-&gt;exclusive
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg-&gt;exclusive
)paren
(brace
multiline_comment|/* If binding is exclusive, try to grab the channel */
id|idev-&gt;exclusive
op_assign
id|isdn_get_free_slot
c_func
(paren
id|ISDN_USAGE_NET
op_or
id|ISDN_USAGE_EXCLUSIVE
comma
id|mlp-&gt;l2_proto
comma
id|mlp-&gt;l3_proto
comma
id|drvidx
comma
id|chidx
comma
id|cfg-&gt;eaz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;exclusive
OL
l_int|0
)paren
(brace
multiline_comment|/* Grab failed, because desired channel is in use */
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|idev-&gt;pre_device
op_assign
id|drvidx
suffix:semicolon
id|idev-&gt;pre_channel
op_assign
id|chidx
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete all phone-numbers of an interface.&n; */
r_static
r_void
DECL|function|isdn_net_rmallphone
id|isdn_net_rmallphone
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_struct
id|isdn_net_phone
op_star
id|n
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|mlp-&gt;phone
(braket
id|i
)braket
)paren
)paren
(brace
id|n
op_assign
id|list_entry
c_func
(paren
id|mlp-&gt;phone
(braket
id|i
)braket
dot
id|next
comma
r_struct
id|isdn_net_phone
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|n-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|n
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* ====================================================================== */
multiline_comment|/* /dev/isdnctrl net ioctl interface                                      */
multiline_comment|/* ====================================================================== */
multiline_comment|/*&n; * Allocate a new network-interface and initialize its data structures&n; */
r_static
r_int
DECL|function|isdn_net_addif
id|isdn_net_addif
c_func
(paren
r_char
op_star
id|name
comma
id|isdn_net_local
op_star
id|mlp
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|isdn_net_dev
op_star
id|idev
suffix:semicolon
multiline_comment|/* Avoid creating an existing interface */
r_if
c_cond
(paren
id|isdn_net_findif
c_func
(paren
id|name
)paren
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
id|idev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|idev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|idev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|idev
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|idev-&gt;name
comma
id|name
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|idev-&gt;tlet
comma
id|isdn_net_tasklet
comma
(paren
r_int
r_int
)paren
id|idev
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|idev-&gt;super_tx_queue
)paren
suffix:semicolon
id|idev-&gt;isdn_slot
op_assign
op_minus
l_int|1
suffix:semicolon
id|idev-&gt;pre_device
op_assign
op_minus
l_int|1
suffix:semicolon
id|idev-&gt;pre_channel
op_assign
op_minus
l_int|1
suffix:semicolon
id|idev-&gt;exclusive
op_assign
op_minus
l_int|1
suffix:semicolon
id|idev-&gt;pppbind
op_assign
op_minus
l_int|1
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|idev-&gt;dial_timer
)paren
suffix:semicolon
id|idev-&gt;dial_timer.data
op_assign
(paren
r_int
r_int
)paren
id|idev
suffix:semicolon
id|idev-&gt;dial_timer.function
op_assign
id|isdn_net_dial_timer
suffix:semicolon
id|idev-&gt;fi.fsm
op_assign
op_amp
id|isdn_net_fsm
suffix:semicolon
id|idev-&gt;fi.state
op_assign
id|ST_NULL
suffix:semicolon
id|idev-&gt;fi.debug
op_assign
l_int|1
suffix:semicolon
id|idev-&gt;fi.userdata
op_assign
id|idev
suffix:semicolon
id|idev-&gt;fi.printdebug
op_assign
id|isdn_net_dev_debug
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mlp
)paren
(brace
multiline_comment|/* Device shall be a master */
id|mlp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mlp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mlp
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|mlp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mlp
)paren
)paren
suffix:semicolon
id|mlp-&gt;magic
op_assign
id|ISDN_NET_MAGIC
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mlp-&gt;slaves
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mlp-&gt;online
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|mlp-&gt;xmit_lock
)paren
suffix:semicolon
id|mlp-&gt;p_encap
op_assign
op_minus
l_int|1
suffix:semicolon
id|isdn_net_set_encap
c_func
(paren
id|mlp
comma
id|ISDN_NET_ENCAP_RAWIP
)paren
suffix:semicolon
id|mlp-&gt;l2_proto
op_assign
id|ISDN_PROTO_L2_X75I
suffix:semicolon
id|mlp-&gt;l3_proto
op_assign
id|ISDN_PROTO_L3_TRANS
suffix:semicolon
id|mlp-&gt;triggercps
op_assign
l_int|6000
suffix:semicolon
id|mlp-&gt;slavedelay
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|mlp-&gt;hupflags
op_assign
id|ISDN_INHUP
suffix:semicolon
id|mlp-&gt;onhtime
op_assign
l_int|10
suffix:semicolon
id|mlp-&gt;dialmax
op_assign
l_int|1
suffix:semicolon
id|mlp-&gt;flags
op_assign
id|ISDN_NET_CBHUP
op_or
id|ISDN_NET_DM_MANUAL
op_or
id|ISDN_NET_SECURE
suffix:semicolon
id|mlp-&gt;cbdelay
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
multiline_comment|/* Wait 5 secs before call-back  */
id|mlp-&gt;dialtimeout
op_assign
l_int|60
op_star
id|HZ
suffix:semicolon
multiline_comment|/* Wait 1 min for connection     */
id|mlp-&gt;dialwait
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
multiline_comment|/* Wait 5 sec. after failed dial */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mlp-&gt;phone
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|mlp-&gt;phone
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|dev
op_assign
op_amp
id|mlp-&gt;dev
suffix:semicolon
)brace
id|idev-&gt;mlp
op_assign
id|mlp
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|idev-&gt;slaves
comma
op_amp
id|mlp-&gt;slaves
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|strcpy
c_func
(paren
id|dev-&gt;name
comma
id|name
)paren
suffix:semicolon
id|dev-&gt;priv
op_assign
id|mlp
suffix:semicolon
id|dev-&gt;init
op_assign
id|isdn_init_netif
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|retval
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|kfree
c_func
(paren
id|mlp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|idev
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
)brace
id|list_add
c_func
(paren
op_amp
id|idev-&gt;global_list
comma
op_amp
id|isdn_net_devs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Add a new slave interface to an existing one&n; */
r_static
r_int
DECL|function|isdn_net_addslave
id|isdn_net_addslave
c_func
(paren
r_char
op_star
id|parm
)paren
(brace
r_char
op_star
id|p
op_assign
id|strchr
c_func
(paren
id|parm
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
id|isdn_net_dev
op_star
id|idev
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
suffix:semicolon
r_int
id|retval
suffix:semicolon
multiline_comment|/* get slave name */
r_if
c_cond
(paren
op_logical_neg
id|p
op_logical_or
op_logical_neg
id|p
(braket
l_int|1
)braket
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* find master */
id|idev
op_assign
id|isdn_net_findif
c_func
(paren
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
op_amp
id|mlp-&gt;dev
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_addif
c_func
(paren
id|p
comma
id|mlp
)paren
suffix:semicolon
id|out
suffix:colon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete a single network-interface&n; */
r_static
r_int
DECL|function|isdn_net_dev_delete
id|isdn_net_dev_delete
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
op_amp
id|mlp-&gt;dev
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
id|isdn_net_set_encap
c_func
(paren
id|mlp
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|isdn_net_rmallphone
c_func
(paren
id|idev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;exclusive
op_ge
l_int|0
)paren
id|isdn_slot_free
c_func
(paren
id|idev-&gt;exclusive
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|idev-&gt;slaves
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|mlp-&gt;slaves
)paren
)paren
(brace
id|unregister_netdev
c_func
(paren
op_amp
id|mlp-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mlp
)paren
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|idev-&gt;global_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|idev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|unlock
suffix:colon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete a single network-interface&n; */
r_static
r_int
DECL|function|isdn_net_delif
id|isdn_net_delif
c_func
(paren
r_char
op_star
id|name
)paren
(brace
multiline_comment|/* FIXME: For compatibility, if a master isdn_net_dev is rm&squot;ed,&n;&t; * kill all slaves, too */
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|isdn_net_dev_delete
c_func
(paren
id|idev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set interface-parameters.&n; * Always set all parameters, so the user-level application is responsible&n; * for not overwriting existing setups. It has to get the current&n; * setup first, if only selected parameters are to be changed.&n; */
r_static
r_int
DECL|function|isdn_net_setcfg
id|isdn_net_setcfg
c_func
(paren
id|isdn_net_ioctl_cfg
op_star
id|cfg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_net_findif
c_func
(paren
id|cfg-&gt;name
)paren
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
op_amp
id|mlp-&gt;dev
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_set_encap
c_func
(paren
id|mlp
comma
id|cfg-&gt;p_encap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
id|retval
op_assign
id|isdn_net_bind
c_func
(paren
id|idev
comma
id|cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
id|strncpy
c_func
(paren
id|mlp-&gt;msn
comma
id|cfg-&gt;eaz
comma
id|ISDN_MSNLEN
op_minus
l_int|1
)paren
suffix:semicolon
id|mlp-&gt;msn
(braket
id|ISDN_MSNLEN
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|mlp-&gt;onhtime
op_assign
id|cfg-&gt;onhtime
suffix:semicolon
id|idev-&gt;charge
op_assign
id|cfg-&gt;charge
suffix:semicolon
id|mlp-&gt;l2_proto
op_assign
id|cfg-&gt;l2_proto
suffix:semicolon
id|mlp-&gt;l3_proto
op_assign
id|cfg-&gt;l3_proto
suffix:semicolon
id|mlp-&gt;cbdelay
op_assign
id|cfg-&gt;cbdelay
op_star
id|HZ
op_div
l_int|5
suffix:semicolon
id|mlp-&gt;dialmax
op_assign
id|cfg-&gt;dialmax
suffix:semicolon
id|mlp-&gt;triggercps
op_assign
id|cfg-&gt;triggercps
suffix:semicolon
id|mlp-&gt;slavedelay
op_assign
id|cfg-&gt;slavedelay
op_star
id|HZ
suffix:semicolon
id|idev-&gt;pppbind
op_assign
id|cfg-&gt;pppbind
suffix:semicolon
id|mlp-&gt;dialtimeout
op_assign
id|cfg-&gt;dialtimeout
op_ge
l_int|0
ques
c_cond
id|cfg-&gt;dialtimeout
op_star
id|HZ
suffix:colon
op_minus
l_int|1
suffix:semicolon
id|mlp-&gt;dialwait
op_assign
id|cfg-&gt;dialwait
op_star
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;secure
)paren
id|mlp-&gt;flags
op_or_assign
id|ISDN_NET_SECURE
suffix:semicolon
r_else
id|mlp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_SECURE
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;cbhup
)paren
id|mlp-&gt;flags
op_or_assign
id|ISDN_NET_CBHUP
suffix:semicolon
r_else
id|mlp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CBHUP
suffix:semicolon
r_switch
c_cond
(paren
id|cfg-&gt;callback
)paren
(brace
r_case
l_int|0
suffix:colon
id|mlp-&gt;flags
op_and_assign
op_complement
(paren
id|ISDN_NET_CALLBACK
op_or
id|ISDN_NET_CBOUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|mlp-&gt;flags
op_or_assign
id|ISDN_NET_CALLBACK
suffix:semicolon
id|mlp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CBOUT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|mlp-&gt;flags
op_or_assign
id|ISDN_NET_CBOUT
suffix:semicolon
id|mlp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_CALLBACK
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mlp-&gt;flags
op_and_assign
op_complement
id|ISDN_NET_DIALMODE_MASK
suffix:semicolon
multiline_comment|/* first all bits off */
r_if
c_cond
(paren
id|cfg-&gt;dialmode
op_logical_and
op_logical_neg
(paren
id|cfg-&gt;dialmode
op_amp
id|ISDN_NET_DIALMODE_MASK
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|mlp-&gt;flags
op_or_assign
id|cfg-&gt;dialmode
suffix:semicolon
multiline_comment|/* turn on selected bits */
r_if
c_cond
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_DM_OFF
)paren
id|isdn_net_hangup
c_func
(paren
id|idev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;chargehup
)paren
id|mlp-&gt;hupflags
op_or_assign
id|ISDN_CHARGEHUP
suffix:semicolon
r_else
id|mlp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_CHARGEHUP
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;ihup
)paren
id|mlp-&gt;hupflags
op_or_assign
id|ISDN_INHUP
suffix:semicolon
r_else
id|mlp-&gt;hupflags
op_and_assign
op_complement
id|ISDN_INHUP
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;chargeint
OG
l_int|10
)paren
(brace
id|idev-&gt;chargeint
op_assign
id|cfg-&gt;chargeint
op_star
id|HZ
suffix:semicolon
id|idev-&gt;charge_state
op_assign
id|ST_CHARGE_HAVE_CINT
suffix:semicolon
id|mlp-&gt;hupflags
op_or_assign
id|ISDN_MANCHARGE
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Perform get-interface-parameters.ioctl&n; */
r_static
r_int
DECL|function|isdn_net_getcfg
id|isdn_net_getcfg
c_func
(paren
id|isdn_net_ioctl_cfg
op_star
id|cfg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_net_findif
c_func
(paren
id|cfg-&gt;name
)paren
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
id|strcpy
c_func
(paren
id|cfg-&gt;eaz
comma
id|mlp-&gt;msn
)paren
suffix:semicolon
id|cfg-&gt;exclusive
op_assign
id|idev-&gt;exclusive
op_ge
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;pre_device
op_ge
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|cfg-&gt;drvid
comma
l_string|&quot;%s,%d&quot;
comma
id|isdn_drv_drvid
c_func
(paren
id|idev-&gt;pre_device
)paren
comma
id|idev-&gt;pre_channel
)paren
suffix:semicolon
)brace
r_else
(brace
id|cfg-&gt;drvid
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
id|cfg-&gt;onhtime
op_assign
id|mlp-&gt;onhtime
suffix:semicolon
id|cfg-&gt;charge
op_assign
id|idev-&gt;charge
suffix:semicolon
id|cfg-&gt;l2_proto
op_assign
id|mlp-&gt;l2_proto
suffix:semicolon
id|cfg-&gt;l3_proto
op_assign
id|mlp-&gt;l3_proto
suffix:semicolon
id|cfg-&gt;p_encap
op_assign
id|mlp-&gt;p_encap
suffix:semicolon
id|cfg-&gt;secure
op_assign
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_SECURE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;callback
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CALLBACK
)paren
id|cfg-&gt;callback
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CBOUT
)paren
id|cfg-&gt;callback
op_assign
l_int|2
suffix:semicolon
id|cfg-&gt;cbhup
op_assign
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CBHUP
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;dialmode
op_assign
id|mlp-&gt;flags
op_amp
id|ISDN_NET_DIALMODE_MASK
suffix:semicolon
id|cfg-&gt;chargehup
op_assign
(paren
id|mlp-&gt;hupflags
op_amp
id|ISDN_CHARGEHUP
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;ihup
op_assign
(paren
id|mlp-&gt;hupflags
op_amp
id|ISDN_INHUP
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;cbdelay
op_assign
id|mlp-&gt;cbdelay
op_star
l_int|5
op_div
id|HZ
suffix:semicolon
id|cfg-&gt;dialmax
op_assign
id|mlp-&gt;dialmax
suffix:semicolon
id|cfg-&gt;triggercps
op_assign
id|mlp-&gt;triggercps
suffix:semicolon
id|cfg-&gt;slavedelay
op_assign
id|mlp-&gt;slavedelay
op_div
id|HZ
suffix:semicolon
id|cfg-&gt;chargeint
op_assign
(paren
id|mlp-&gt;hupflags
op_amp
id|ISDN_CHARGEHUP
)paren
ques
c_cond
(paren
id|idev-&gt;chargeint
op_div
id|HZ
)paren
suffix:colon
l_int|0
suffix:semicolon
id|cfg-&gt;pppbind
op_assign
id|idev-&gt;pppbind
suffix:semicolon
id|cfg-&gt;dialtimeout
op_assign
id|mlp-&gt;dialtimeout
op_ge
l_int|0
ques
c_cond
id|mlp-&gt;dialtimeout
op_div
id|HZ
suffix:colon
op_minus
l_int|1
suffix:semicolon
id|cfg-&gt;dialwait
op_assign
id|mlp-&gt;dialwait
op_div
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;slaves.next
op_ne
op_amp
id|mlp-&gt;slaves
)paren
id|strcpy
c_func
(paren
id|cfg-&gt;slave
comma
id|list_entry
c_func
(paren
id|idev-&gt;slaves.next
comma
id|isdn_net_dev
comma
id|slaves
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_else
id|cfg-&gt;slave
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|mlp-&gt;dev.name
comma
id|idev-&gt;name
)paren
)paren
id|strcpy
c_func
(paren
id|cfg-&gt;master
comma
id|mlp-&gt;dev.name
)paren
suffix:semicolon
r_else
id|cfg-&gt;master
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Add a phone-number to an interface.&n; */
r_static
r_int
DECL|function|isdn_net_addphone
id|isdn_net_addphone
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_struct
id|isdn_net_phone
op_star
id|n
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
op_amp
id|idev-&gt;mlp-&gt;dev
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|n
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|n
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|n-&gt;num
comma
id|phone-&gt;phone
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|n-&gt;list
comma
op_amp
id|idev-&gt;mlp-&gt;phone
(braket
id|phone-&gt;outgoing
op_amp
l_int|1
)braket
)paren
suffix:semicolon
id|out
suffix:colon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete a phone-number from an interface.&n; */
r_static
r_int
DECL|function|isdn_net_delphone
id|isdn_net_delphone
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_struct
id|isdn_net_phone
op_star
id|n
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
op_amp
id|idev-&gt;mlp-&gt;dev
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|n
comma
op_amp
id|idev-&gt;mlp-&gt;phone
(braket
id|phone-&gt;outgoing
op_amp
l_int|1
)braket
comma
id|list
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|n-&gt;num
comma
id|phone-&gt;phone
)paren
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|n-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|n
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy a string of all phone-numbers of an interface to user space.&n; */
r_static
r_int
DECL|function|isdn_net_getphone
id|isdn_net_getphone
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
comma
r_char
op_star
id|phones
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|buf
op_assign
(paren
r_char
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_struct
id|isdn_net_phone
op_star
id|n
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
(brace
id|count
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|free
suffix:semicolon
)brace
id|list_for_each_entry
c_func
(paren
id|n
comma
op_amp
id|idev-&gt;mlp-&gt;phone
(braket
id|phone-&gt;outgoing
op_amp
l_int|1
)braket
comma
id|list
)paren
(brace
id|strcpy
c_func
(paren
op_amp
id|buf
(braket
id|count
)braket
comma
id|n-&gt;num
)paren
suffix:semicolon
id|count
op_add_assign
id|strlen
c_func
(paren
id|n-&gt;num
)paren
suffix:semicolon
id|buf
(braket
id|count
op_increment
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|PAGE_SIZE
op_minus
id|ISDN_MSNLEN
op_minus
l_int|1
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
multiline_comment|/* list was empty? */
id|count
op_increment
suffix:semicolon
id|buf
(braket
id|count
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|phones
comma
id|buf
comma
id|count
)paren
)paren
id|count
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|free
suffix:colon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|buf
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Force a net-interface to dial out.&n; */
r_static
r_int
DECL|function|isdn_net_dial_out
id|isdn_net_dial_out
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|isdn_net_dial
c_func
(paren
id|idev
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|__isdn_net_dial_slave
id|__isdn_net_dial_slave
c_func
(paren
id|isdn_net_local
op_star
id|mlp
)paren
(brace
id|isdn_net_dev
op_star
id|idev
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|idev
comma
op_amp
id|mlp-&gt;slaves
comma
id|slaves
)paren
(brace
r_if
c_cond
(paren
id|isdn_net_dial
c_func
(paren
id|idev
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_net_dial_slave
id|isdn_net_dial_slave
c_func
(paren
r_char
op_star
id|name
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|__isdn_net_dial_slave
c_func
(paren
id|idev-&gt;mlp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Force a hangup of a network-interface.&n; */
r_static
r_int
DECL|function|isdn_net_force_hangup
id|isdn_net_force_hangup
c_func
(paren
r_char
op_star
id|name
)paren
singleline_comment|// FIXME rename?
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_net_findif
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;isdn_slot
OL
l_int|0
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
id|idev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy a string containing the peer&squot;s phone number of a connected interface&n; * to user space.&n; */
r_static
r_int
DECL|function|isdn_net_getpeer
id|isdn_net_getpeer
c_func
(paren
id|isdn_net_ioctl_phone
op_star
id|phone
comma
id|isdn_net_ioctl_phone
op_star
id|peer
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_net_findif
c_func
(paren
id|phone-&gt;name
)paren
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* FIXME&n;&t; * Theoretical race: while this executes, the remote number might&n;&t; * become invalid (hang up) or change (new connection), resulting&n;         * in (partially) wrong number copied to user. This race&n;&t; * currently ignored.&n;&t; */
id|idx
op_assign
id|idev-&gt;isdn_slot
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
multiline_comment|/* for pre-bound channels, we need this extra check */
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|isdn_slot_num
c_func
(paren
id|idx
)paren
comma
l_string|&quot;???&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
id|strncpy
c_func
(paren
id|phone-&gt;phone
comma
id|isdn_slot_num
c_func
(paren
id|idx
)paren
comma
id|ISDN_MSNLEN
)paren
suffix:semicolon
id|phone-&gt;outgoing
op_assign
id|USG_OUTGOING
c_func
(paren
id|isdn_slot_usage
c_func
(paren
id|idx
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|peer
comma
id|phone
comma
r_sizeof
(paren
op_star
id|peer
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ioctl on /dev/isdnctrl, used to configure ISDN net interfaces &n; */
r_int
DECL|function|isdn_net_ioctl
id|isdn_net_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|ino
comma
r_struct
id|file
op_star
id|file
comma
id|uint
id|cmd
comma
id|ulong
id|arg
)paren
(brace
multiline_comment|/* Save stack space */
r_union
(brace
r_char
id|name
(braket
l_int|10
)braket
suffix:semicolon
r_char
id|bname
(braket
l_int|20
)braket
suffix:semicolon
id|isdn_net_ioctl_phone
id|phone
suffix:semicolon
id|isdn_net_ioctl_cfg
id|cfg
suffix:semicolon
)brace
id|iocpar
suffix:semicolon
r_int
id|retval
suffix:semicolon
DECL|macro|name
mdefine_line|#define name  iocpar.name
DECL|macro|bname
mdefine_line|#define bname iocpar.bname
DECL|macro|phone
mdefine_line|#define phone iocpar.phone
DECL|macro|cfg
mdefine_line|#define cfg   iocpar.cfg
id|name
(braket
r_sizeof
(paren
id|name
)paren
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|bname
(braket
r_sizeof
(paren
id|bname
)paren
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|IIOCNETAIF
suffix:colon
multiline_comment|/* add an interface */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|name
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|name
)paren
op_minus
l_int|1
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_addif
c_func
(paren
id|name
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETASL
suffix:colon
multiline_comment|/* add slave to an interface */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|bname
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|bname
)paren
op_minus
l_int|1
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_addslave
c_func
(paren
id|bname
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETDIF
suffix:colon
multiline_comment|/* delete an interface */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|name
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|name
)paren
op_minus
l_int|1
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_delif
c_func
(paren
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETSCF
suffix:colon
multiline_comment|/* set config */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|cfg
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|cfg
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_setcfg
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETGCF
suffix:colon
multiline_comment|/* get config */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|cfg
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|cfg
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_getcfg
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
(paren
r_char
op_star
)paren
op_amp
id|cfg
comma
r_sizeof
(paren
id|cfg
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETANM
suffix:colon
multiline_comment|/* add a phone number */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|phone
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|phone
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_addphone
c_func
(paren
op_amp
id|phone
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETGNM
suffix:colon
multiline_comment|/* get list of phone numbers */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|phone
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|phone
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_getphone
c_func
(paren
op_amp
id|phone
comma
(paren
r_char
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETDNM
suffix:colon
multiline_comment|/* delete a phone number */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|phone
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|phone
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_delphone
c_func
(paren
op_amp
id|phone
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETDIL
suffix:colon
multiline_comment|/* trigger dial-out */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|name
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|name
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_dial_out
c_func
(paren
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETHUP
suffix:colon
multiline_comment|/* hangup */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|name
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|name
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_force_hangup
c_func
(paren
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETGPN
suffix:colon
multiline_comment|/* Get peer phone number of a connected interface */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|phone
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|phone
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_getpeer
c_func
(paren
op_amp
id|phone
comma
(paren
id|isdn_net_ioctl_phone
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETALN
suffix:colon
multiline_comment|/* Add link */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|name
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|name
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_dial_slave
c_func
(paren
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IIOCNETDLN
suffix:colon
multiline_comment|/* Delete link */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|name
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|name
)paren
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retval
op_assign
id|isdn_net_force_hangup
c_func
(paren
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
id|ENOTTY
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
DECL|macro|name
macro_line|#undef name
DECL|macro|bname
macro_line|#undef bname
DECL|macro|iocts
macro_line|#undef iocts
DECL|macro|phone
macro_line|#undef phone
DECL|macro|cfg
macro_line|#undef cfg
)brace
multiline_comment|/*&n; * Hang up all network-interfaces&n; */
r_void
DECL|function|isdn_net_hangup_all
id|isdn_net_hangup_all
c_func
(paren
r_void
)paren
(brace
id|isdn_net_dev
op_star
id|idev
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|idev
comma
op_amp
id|isdn_net_devs
comma
id|global_list
)paren
id|isdn_net_hangup
c_func
(paren
id|idev
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove all network-interfaces&n; */
r_void
DECL|function|isdn_net_cleanup
id|isdn_net_cleanup
c_func
(paren
r_void
)paren
(brace
id|isdn_net_dev
op_star
id|idev
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|isdn_net_devs
)paren
)paren
(brace
id|idev
op_assign
id|list_entry
c_func
(paren
id|isdn_net_devs.next
comma
id|isdn_net_dev
comma
id|global_list
)paren
suffix:semicolon
id|retval
op_assign
id|isdn_net_dev_delete
c_func
(paren
id|idev
)paren
suffix:semicolon
multiline_comment|/* can only fail if an interface is still running.&n;&t;&t; * In this case, an elevated module use count should&n;&t;&t; * have prevented this function from being called in&n;&t;&t; * the first place */
r_if
c_cond
(paren
id|retval
)paren
id|isdn_BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
)brace
multiline_comment|/* ====================================================================== */
multiline_comment|/* interface to network layer                                             */
multiline_comment|/* ====================================================================== */
DECL|variable|running_devs_lock
r_static
id|spinlock_t
id|running_devs_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|running_devs
)paren
suffix:semicolon
multiline_comment|/* &n; * Open/initialize the board.&n; */
r_static
r_int
DECL|function|isdn_net_open
id|isdn_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp-&gt;ops
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;ops-&gt;open
)paren
id|retval
op_assign
id|lp-&gt;ops
op_member_access_from_pointer
id|open
c_func
(paren
id|lp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|lp-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|running_devs_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|lp-&gt;running_devs
comma
op_amp
id|running_devs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|running_devs_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Shutdown a net-interface.&n; */
r_static
r_int
DECL|function|isdn_net_close
id|isdn_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|isdn_net_dev
op_star
id|sdev
suffix:semicolon
r_struct
id|list_head
op_star
id|l
comma
op_star
id|n
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|lp-&gt;ops-&gt;close
)paren
id|lp-&gt;ops
op_member_access_from_pointer
id|close
c_func
(paren
id|lp
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|l
comma
id|n
comma
op_amp
id|lp-&gt;slaves
)paren
(brace
id|sdev
op_assign
id|list_entry
c_func
(paren
id|l
comma
id|isdn_net_dev
comma
id|slaves
)paren
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
id|sdev
)paren
suffix:semicolon
)brace
multiline_comment|/* The hangup will make the refcnt drop back to&n;&t; * 1 (referenced by list only) soon. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|running_devs_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|lp-&gt;refcnt
)paren
op_ne
l_int|1
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|running_devs_lock
comma
id|flags
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|running_devs_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* We have the only reference and list lock, so&n;&t; * nobody can get another reference. */
id|list_del
c_func
(paren
op_amp
id|lp-&gt;running_devs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|running_devs_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Get statistics&n; */
r_static
r_struct
id|net_device_stats
op_star
DECL|function|isdn_net_get_stats
id|isdn_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|isdn_net_local
op_star
id|lp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|lp-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * Transmit timeout&n; */
r_static
r_void
DECL|function|isdn_net_tx_timeout
id|isdn_net_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;isdn_tx_timeout dev %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Interface-setup. (just after registering a new interface)&n; */
r_static
r_int
DECL|function|isdn_init_netif
id|isdn_init_netif
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
multiline_comment|/* Setup the generic properties */
id|ndev-&gt;mtu
op_assign
l_int|1500
suffix:semicolon
id|ndev-&gt;tx_queue_len
op_assign
l_int|10
suffix:semicolon
id|ndev-&gt;open
op_assign
op_amp
id|isdn_net_open
suffix:semicolon
id|ndev-&gt;hard_header_len
op_assign
id|ETH_HLEN
op_plus
id|isdn_hard_header_len
c_func
(paren
)paren
suffix:semicolon
id|ndev-&gt;stop
op_assign
op_amp
id|isdn_net_close
suffix:semicolon
id|ndev-&gt;get_stats
op_assign
op_amp
id|isdn_net_get_stats
suffix:semicolon
id|ndev-&gt;tx_timeout
op_assign
id|isdn_net_tx_timeout
suffix:semicolon
id|ndev-&gt;watchdog_timeo
op_assign
id|ISDN_NET_TX_TIMEOUT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ====================================================================== */
multiline_comment|/* call control state machine                                             */
multiline_comment|/* ====================================================================== */
singleline_comment|// FIXME
r_static
r_int
DECL|function|isdn_net_is_connected
id|isdn_net_is_connected
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
r_return
id|idev-&gt;fi.state
op_eq
id|ST_ACTIVE
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_dial_timer
id|isdn_net_dial_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|data
suffix:semicolon
id|isdn_net_handle_event
c_func
(paren
id|idev
comma
id|idev-&gt;dial_event
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Unbind a net-interface&n; */
r_static
r_void
DECL|function|isdn_net_unbind_channel
id|isdn_net_unbind_channel
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;isdn_slot
OL
l_int|0
)paren
(brace
id|isdn_BUG
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mlp-&gt;ops-&gt;unbind
)paren
id|mlp-&gt;ops
op_member_access_from_pointer
id|unbind
c_func
(paren
id|idev
)paren
suffix:semicolon
id|isdn_slot_set_priv
c_func
(paren
id|idev-&gt;isdn_slot
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|idev-&gt;super_tx_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;isdn_slot
op_ne
id|idev-&gt;exclusive
)paren
id|isdn_slot_free
c_func
(paren
id|idev-&gt;isdn_slot
)paren
suffix:semicolon
id|idev-&gt;isdn_slot
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;fi.state
op_ne
id|ST_NULL
)paren
(brace
id|lp_put
c_func
(paren
id|mlp
)paren
suffix:semicolon
id|fsm_change_state
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|ST_NULL
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
id|isdn_net_stat_callback
c_func
(paren
r_int
comma
id|isdn_ctrl
op_star
)paren
suffix:semicolon
r_static
r_int
id|isdn_net_rcv_skb
c_func
(paren
r_int
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * Assign an ISDN-channel to a net-interface&n; */
r_static
r_int
DECL|function|isdn_net_bind_channel
id|isdn_net_bind_channel
c_func
(paren
id|isdn_net_dev
op_star
id|idev
comma
r_int
id|slot
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;isdn_slot
op_assign
id|slot
suffix:semicolon
id|isdn_slot_set_priv
c_func
(paren
id|idev-&gt;isdn_slot
comma
id|ISDN_USAGE_NET
comma
id|idev
comma
id|isdn_net_stat_callback
comma
id|isdn_net_rcv_skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mlp-&gt;ops-&gt;bind
)paren
id|retval
op_assign
id|mlp-&gt;ops
op_member_access_from_pointer
id|bind
c_func
(paren
id|idev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
id|isdn_net_unbind_channel
c_func
(paren
id|idev
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_net_dial
id|isdn_net_dial
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
r_int
id|retval
suffix:semicolon
id|lp_get
c_func
(paren
id|idev-&gt;mlp
)paren
suffix:semicolon
id|retval
op_assign
id|fsm_event
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|EV_DO_DIAL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ESRCH
)paren
multiline_comment|/* event not handled in this state */
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|lp_put
c_func
(paren
id|idev-&gt;mlp
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_unreachable
id|isdn_net_unreachable
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|reason
)paren
(brace
id|u_short
id|proto
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;isdn_net: %s: %s, signalling dst_link_failure %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|reason
op_ne
l_int|NULL
)paren
ques
c_cond
id|reason
suffix:colon
l_string|&quot;unknown&quot;
comma
(paren
id|proto
op_ne
id|ETH_P_IP
)paren
ques
c_cond
l_string|&quot;Protocol != ETH_P_IP&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|dst_link_failure
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This is called from certain upper protocol layers (multilink ppp&n; * and x25iface encapsulation module) that want to initiate dialing&n; * themselves.&n; */
r_int
DECL|function|isdn_net_dial_req
id|isdn_net_dial_req
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
multiline_comment|/* is there a better error code? */
r_if
c_cond
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|mlp
)paren
op_ne
id|ISDN_NET_DM_AUTO
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_return
id|isdn_net_dial
c_func
(paren
id|idev
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_log_skb
id|isdn_net_log_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|isdn_net_dev
op_star
id|idev
)paren
(brace
r_int
r_char
op_star
id|p
op_assign
id|skb-&gt;nh.raw
suffix:semicolon
multiline_comment|/* hopefully, this was set correctly */
r_int
r_int
id|proto
op_assign
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
suffix:semicolon
r_int
id|data_ofs
suffix:semicolon
r_struct
id|ip_ports
(brace
r_int
r_int
id|source
suffix:semicolon
r_int
r_int
id|dest
suffix:semicolon
)brace
op_star
id|ipp
suffix:semicolon
r_char
id|addinfo
(braket
l_int|100
)braket
suffix:semicolon
id|data_ofs
op_assign
(paren
(paren
id|p
(braket
l_int|0
)braket
op_amp
l_int|15
)paren
op_star
l_int|4
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|proto
)paren
(brace
r_case
id|ETH_P_IP
suffix:colon
r_switch
c_cond
(paren
id|p
(braket
l_int|9
)braket
)paren
(brace
r_case
id|IPPROTO_ICMP
suffix:colon
id|strcpy
c_func
(paren
id|addinfo
comma
l_string|&quot;ICMP&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_TCP
suffix:colon
r_case
id|IPPROTO_UDP
suffix:colon
id|ipp
op_assign
(paren
r_struct
id|ip_ports
op_star
)paren
(paren
op_amp
id|p
(braket
id|data_ofs
)braket
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|addinfo
comma
l_string|&quot;%s, port: %d -&gt; %d&quot;
comma
id|p
(braket
l_int|9
)braket
op_eq
id|IPPROTO_TCP
ques
c_cond
l_string|&quot;TCP&quot;
suffix:colon
l_string|&quot;UDP&quot;
comma
id|ntohs
c_func
(paren
id|ipp-&gt;source
)paren
comma
id|ntohs
c_func
(paren
id|ipp-&gt;dest
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
c_func
(paren
id|addinfo
comma
l_string|&quot;type %d&quot;
comma
id|p
(braket
l_int|9
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;OPEN: %u.%u.%u.%u -&gt; %u.%u.%u.%u %s&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
(paren
id|p
op_plus
l_int|12
)paren
)paren
comma
id|NIPQUAD
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
(paren
id|p
op_plus
l_int|16
)paren
)paren
comma
id|addinfo
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_ARP
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;OPEN: ARP %d.%d.%d.%d -&gt; *.*.*.* ?%d.%d.%d.%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
(paren
id|p
op_plus
l_int|14
)paren
)paren
comma
id|NIPQUAD
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
(paren
id|p
op_plus
l_int|24
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;OPEN: unknown proto %#x&bslash;n&quot;
comma
id|proto
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|isdn_net_autodial
id|isdn_net_autodial
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|ndev-&gt;priv
suffix:semicolon
id|isdn_net_dev
op_star
id|idev
op_assign
id|list_entry
c_func
(paren
id|mlp-&gt;slaves.next
comma
id|isdn_net_dev
comma
id|slaves
)paren
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|mlp
)paren
op_ne
id|ISDN_NET_DM_AUTO
)paren
r_goto
id|discard
suffix:semicolon
id|retval
op_assign
id|isdn_net_dial
c_func
(paren
id|idev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ESRCH
)paren
r_goto
id|stop_queue
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_goto
id|discard
suffix:semicolon
multiline_comment|/* Log packet, which triggered dialing */
r_if
c_cond
(paren
id|dev-&gt;net_verbose
)paren
id|isdn_net_log_skb
c_func
(paren
id|skb
comma
id|idev
)paren
suffix:semicolon
id|stop_queue
suffix:colon
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
id|discard
suffix:colon
id|isdn_net_unreachable
c_func
(paren
id|ndev
comma
id|skb
comma
l_string|&quot;dial rejected&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|accept_icall
id|accept_icall
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
r_int
id|slot
op_assign
(paren
r_int
)paren
id|arg
suffix:semicolon
id|isdn_net_bind_channel
c_func
(paren
id|idev
comma
id|slot
)paren
suffix:semicolon
id|idev-&gt;outgoing
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;charge_state
op_assign
id|ST_CHARGE_NULL
suffix:semicolon
multiline_comment|/* Got incoming call, setup L2 and L3 protocols,&n;&t; * then wait for D-Channel-connect&n;&t; */
id|cmd.arg
op_assign
id|mlp-&gt;l2_proto
op_lshift
l_int|8
suffix:semicolon
id|isdn_slot_command
c_func
(paren
id|idev-&gt;isdn_slot
comma
id|ISDN_CMD_SETL2
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd.arg
op_assign
id|mlp-&gt;l3_proto
op_lshift
l_int|8
suffix:semicolon
id|isdn_slot_command
c_func
(paren
id|idev-&gt;isdn_slot
comma
id|ISDN_CMD_SETL3
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|isdn_slot_command
c_func
(paren
id|idev-&gt;isdn_slot
comma
id|ISDN_CMD_ACCEPTD
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|idev-&gt;dial_timer.expires
op_assign
id|jiffies
op_plus
id|mlp-&gt;dialtimeout
suffix:semicolon
id|idev-&gt;dial_event
op_assign
id|EV_TIMER_INCOMING
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|idev-&gt;dial_timer
)paren
suffix:semicolon
id|fsm_change_state
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|ST_IN_WAIT_DCONN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|do_callback
id|do_callback
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: start callback&bslash;n&quot;
comma
id|idev-&gt;name
)paren
suffix:semicolon
id|idev-&gt;dial_timer.expires
op_assign
id|jiffies
op_plus
id|mlp-&gt;cbdelay
suffix:semicolon
id|idev-&gt;dial_event
op_assign
id|EV_TIMER_CB_IN
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|idev-&gt;dial_timer
)paren
suffix:semicolon
id|fsm_change_state
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|ST_WAIT_BEFORE_CB
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|isdn_net_dev_icall
id|isdn_net_dev_icall
c_func
(paren
id|isdn_net_dev
op_star
id|idev
comma
r_int
id|di
comma
r_int
id|ch
comma
r_int
id|si1
comma
r_char
op_star
id|eaz
comma
r_char
op_star
id|nr
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_struct
id|isdn_net_phone
op_star
id|ph
suffix:semicolon
r_int
id|slot
op_assign
id|isdn_dc2minor
c_func
(paren
id|di
comma
id|ch
)paren
suffix:semicolon
r_char
op_star
id|my_eaz
suffix:semicolon
multiline_comment|/* check acceptable call types for DOV */
id|dbg_net_icall
c_func
(paren
l_string|&quot;n_fi: if=&squot;%s&squot;, l.msn=%s, l.flags=%#x, l.dstate=%d&bslash;n&quot;
comma
id|idev-&gt;name
comma
id|mlp-&gt;msn
comma
id|mlp-&gt;flags
comma
id|idev-&gt;fi.state
)paren
suffix:semicolon
id|my_eaz
op_assign
id|isdn_slot_map_eaz2msn
c_func
(paren
id|slot
comma
id|mlp-&gt;msn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|si1
op_eq
l_int|1
)paren
(brace
multiline_comment|/* it&squot;s a DOV call, check if we allow it */
r_if
c_cond
(paren
op_star
id|my_eaz
op_eq
l_char|&squot;v&squot;
op_logical_or
op_star
id|my_eaz
op_eq
l_char|&squot;V&squot;
op_logical_or
op_star
id|my_eaz
op_eq
l_char|&squot;b&squot;
op_logical_or
op_star
id|my_eaz
op_eq
l_char|&squot;B&squot;
)paren
id|my_eaz
op_increment
suffix:semicolon
multiline_comment|/* skip to allow a match */
r_else
r_return
l_int|0
suffix:semicolon
multiline_comment|/* no match */
)brace
r_else
(brace
multiline_comment|/* it&squot;s a DATA call, check if we allow it */
r_if
c_cond
(paren
op_star
id|my_eaz
op_eq
l_char|&squot;b&squot;
op_logical_or
op_star
id|my_eaz
op_eq
l_char|&squot;B&squot;
)paren
id|my_eaz
op_increment
suffix:semicolon
multiline_comment|/* skip to allow a match */
)brace
multiline_comment|/* check called number */
r_switch
c_cond
(paren
id|isdn_msncmp
c_func
(paren
id|eaz
comma
id|my_eaz
)paren
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* no match */
r_return
l_int|0
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* matches so far */
r_return
l_int|5
suffix:semicolon
)brace
id|dbg_net_icall
c_func
(paren
l_string|&quot;%s: pdev=%d di=%d pch=%d ch = %d&bslash;n&quot;
comma
id|idev-&gt;name
comma
id|idev-&gt;pre_device
comma
id|di
comma
id|idev-&gt;pre_channel
comma
id|ch
)paren
suffix:semicolon
multiline_comment|/* check if exclusive */
r_if
c_cond
(paren
(paren
id|isdn_slot_usage
c_func
(paren
id|slot
)paren
op_amp
id|ISDN_USAGE_EXCLUSIVE
)paren
op_logical_and
(paren
id|idev-&gt;pre_channel
op_ne
id|ch
op_logical_or
id|idev-&gt;pre_device
op_ne
id|di
)paren
)paren
(brace
id|dbg_net_icall
c_func
(paren
l_string|&quot;%s: excl check failed&bslash;n&quot;
comma
id|idev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* check calling number */
id|dbg_net_icall
c_func
(paren
l_string|&quot;%s: secure&bslash;n&quot;
comma
id|idev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_SECURE
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|ph
comma
op_amp
id|mlp-&gt;phone
(braket
l_int|0
)braket
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|isdn_msncmp
c_func
(paren
id|nr
comma
id|ph-&gt;num
)paren
op_eq
l_int|0
)paren
r_goto
id|found
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|found
suffix:colon
multiline_comment|/* check dial mode */
r_if
c_cond
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|mlp
)paren
op_eq
id|ISDN_NET_DM_OFF
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: incoming call, stopped -&gt; rejected&bslash;n&quot;
comma
id|idev-&gt;name
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
id|lp_get
c_func
(paren
id|mlp
)paren
suffix:semicolon
multiline_comment|/* check callback */
r_if
c_cond
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CALLBACK
)paren
(brace
r_if
c_cond
(paren
id|fsm_event
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|EV_DO_CALLBACK
comma
l_int|NULL
)paren
)paren
(brace
id|lp_put
c_func
(paren
id|mlp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Initiate dialing by returning 2 or 4 */
r_return
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CBHUP
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: call from %s -&gt; %s accepted&bslash;n&quot;
comma
id|idev-&gt;name
comma
id|nr
comma
id|eaz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsm_event
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|EV_DO_ACCEPT
comma
(paren
r_void
op_star
)paren
id|slot
)paren
)paren
(brace
id|lp_put
c_func
(paren
id|mlp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
singleline_comment|// accepted
)brace
multiline_comment|/*&n; * An incoming call-request has arrived.&n; * Search the interface-chain for an appropriate interface.&n; * If found, connect the interface to the ISDN-channel and initiate&n; * D- and B-Channel-setup. If secure-flag is set, accept only&n; * configured phone-numbers. If callback-flag is set, initiate&n; * callback-dialing.&n; *&n; * Return-Value: 0 = No appropriate interface for this call.&n; *               1 = Call accepted&n; *               2 = Reject call, wait cbdelay, then call back&n; *               3 = Reject call&n; *               4 = Wait cbdelay, then call back&n; *               5 = No appropriate interface for this call,&n; *                   would eventually match if CID was longer.&n; */
r_int
DECL|function|isdn_net_find_icall
id|isdn_net_find_icall
c_func
(paren
r_int
id|di
comma
r_int
id|ch
comma
r_int
id|idx
comma
id|setup_parm
op_star
id|setup
)paren
(brace
id|isdn_net_local
op_star
id|lp
suffix:semicolon
id|isdn_net_dev
op_star
id|idev
suffix:semicolon
r_char
op_star
id|nr
comma
op_star
id|eaz
suffix:semicolon
r_int
r_char
id|si1
comma
id|si2
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* fix up calling number */
r_if
c_cond
(paren
op_logical_neg
id|setup-&gt;phone
(braket
l_int|0
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: Incoming call without OAD, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
id|nr
op_assign
l_string|&quot;0&quot;
suffix:semicolon
)brace
r_else
(brace
id|nr
op_assign
id|setup-&gt;phone
suffix:semicolon
)brace
multiline_comment|/* fix up called number */
r_if
c_cond
(paren
op_logical_neg
id|setup-&gt;eazmsn
(braket
l_int|0
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: Incoming call without CPN, assuming &squot;0&squot;&bslash;n&quot;
)paren
suffix:semicolon
id|eaz
op_assign
l_string|&quot;0&quot;
suffix:semicolon
)brace
r_else
(brace
id|eaz
op_assign
id|setup-&gt;eazmsn
suffix:semicolon
)brace
id|si1
op_assign
id|setup-&gt;si1
suffix:semicolon
id|si2
op_assign
id|setup-&gt;si2
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: call from %s,%d,%d -&gt; %s&bslash;n&quot;
comma
id|nr
comma
id|si1
comma
id|si2
comma
id|eaz
)paren
suffix:semicolon
multiline_comment|/* check service indicator */
multiline_comment|/* Accept DATA and VOICE calls at this stage&n;&t;   local eaz is checked later for allowed call types */
r_if
c_cond
(paren
(paren
id|si1
op_ne
l_int|7
)paren
op_logical_and
(paren
id|si1
op_ne
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: &quot;
l_string|&quot;Service-Indicator not 1 or 7, ignored&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dbg_net_icall
c_func
(paren
l_string|&quot;n_fi: di=%d ch=%d idx=%d usg=%d&bslash;n&quot;
comma
id|di
comma
id|ch
comma
id|idx
comma
id|isdn_slot_usage
c_func
(paren
id|idx
)paren
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|running_devs_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|lp
comma
op_amp
id|running_devs
comma
id|running_devs
)paren
(brace
id|lp_get
c_func
(paren
id|lp
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|running_devs_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|idev
comma
op_amp
id|lp-&gt;slaves
comma
id|slaves
)paren
(brace
id|retval
op_assign
id|isdn_net_dev_icall
c_func
(paren
id|idev
comma
id|di
comma
id|ch
comma
id|si1
comma
id|eaz
comma
id|nr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OG
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|running_devs_lock
comma
id|flags
)paren
suffix:semicolon
id|lp_put
c_func
(paren
id|lp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OG
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|running_devs_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;net_verbose
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;isdn_net: call &quot;
l_string|&quot;from %s -&gt; %s ignored&bslash;n&quot;
comma
id|nr
comma
id|eaz
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* callbacks in the state machine                                         */
multiline_comment|/* ---------------------------------------------------------------------- */
multiline_comment|/* Find the idev-&gt;dial&squot;th outgoing number. */
r_static
r_struct
id|isdn_net_phone
op_star
DECL|function|get_outgoing_phone
id|get_outgoing_phone
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_struct
id|isdn_net_phone
op_star
id|phone
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|phone
comma
op_amp
id|mlp-&gt;phone
(braket
l_int|1
)braket
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|i
op_increment
op_eq
id|idev-&gt;dial
)paren
r_return
id|phone
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
id|dialout_next
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
suffix:semicolon
multiline_comment|/* Initiate dialout. */
r_static
r_int
DECL|function|do_dial
id|do_dial
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_int
id|slot
suffix:semicolon
r_if
c_cond
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|mlp
)paren
op_eq
id|ISDN_NET_DM_OFF
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|mlp-&gt;phone
(braket
l_int|1
)braket
)paren
)paren
multiline_comment|/* no number to dial ? */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;exclusive
op_ge
l_int|0
)paren
id|slot
op_assign
id|idev-&gt;exclusive
suffix:semicolon
r_else
id|slot
op_assign
id|isdn_get_free_slot
c_func
(paren
id|ISDN_USAGE_NET
comma
id|mlp-&gt;l2_proto
comma
id|mlp-&gt;l3_proto
comma
id|idev-&gt;pre_device
comma
id|idev-&gt;pre_channel
comma
id|mlp-&gt;msn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
OL
l_int|0
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|isdn_net_bind_channel
c_func
(paren
id|idev
comma
id|slot
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* has freed the slot as well */
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|fsm_change_state
c_func
(paren
id|fi
comma
id|ST_OUT_BOUND
)paren
suffix:semicolon
id|idev-&gt;dial
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;dialretry
op_assign
l_int|0
suffix:semicolon
id|dialout_next
c_func
(paren
id|fi
comma
id|pr
comma
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Try dialing the next number. */
r_static
r_int
DECL|function|dialout_next
id|dialout_next
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_struct
id|dial_info
id|dial
op_assign
(brace
dot
id|l2_proto
op_assign
id|mlp-&gt;l2_proto
comma
dot
id|l3_proto
op_assign
id|mlp-&gt;l3_proto
comma
dot
id|si1
op_assign
l_int|7
comma
dot
id|si2
op_assign
l_int|0
comma
dot
id|msn
op_assign
id|mlp-&gt;msn
comma
dot
id|phone
op_assign
id|get_outgoing_phone
c_func
(paren
id|idev
)paren
op_member_access_from_pointer
id|num
comma
)brace
suffix:semicolon
multiline_comment|/* next time, try next number */
id|idev-&gt;dial
op_increment
suffix:semicolon
id|idev-&gt;outgoing
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;chargeint
)paren
id|idev-&gt;charge_state
op_assign
id|ST_CHARGE_HAVE_CINT
suffix:semicolon
r_else
id|idev-&gt;charge_state
op_assign
id|ST_CHARGE_NULL
suffix:semicolon
multiline_comment|/* For outgoing callback, use cbdelay instead of dialtimeout */
r_if
c_cond
(paren
id|mlp-&gt;cbdelay
op_logical_and
(paren
id|mlp-&gt;flags
op_amp
id|ISDN_NET_CBOUT
)paren
)paren
(brace
id|idev-&gt;dial_timer.expires
op_assign
id|jiffies
op_plus
id|mlp-&gt;cbdelay
suffix:semicolon
id|idev-&gt;dial_event
op_assign
id|EV_TIMER_CB_OUT
suffix:semicolon
)brace
r_else
(brace
id|idev-&gt;dial_timer.expires
op_assign
id|jiffies
op_plus
id|mlp-&gt;dialtimeout
suffix:semicolon
id|idev-&gt;dial_event
op_assign
id|EV_TIMER_DIAL
suffix:semicolon
)brace
id|fsm_change_state
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|ST_OUT_WAIT_DCONN
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|idev-&gt;dial_timer
)paren
suffix:semicolon
multiline_comment|/* Dial */
id|isdn_slot_dial
c_func
(paren
id|idev-&gt;isdn_slot
comma
op_amp
id|dial
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If we didn&squot;t connect within dialtimeout, we give up for now&n; * and wait for dialwait jiffies before trying again.&n; */
r_static
r_int
DECL|function|dial_timeout
id|dial_timeout
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|fsm_change_state
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|ST_OUT_DIAL_WAIT
)paren
suffix:semicolon
id|isdn_slot_command
c_func
(paren
id|idev-&gt;isdn_slot
comma
id|ISDN_CMD_HANGUP
comma
op_amp
id|cmd
)paren
suffix:semicolon
multiline_comment|/* get next phone number */
r_if
c_cond
(paren
op_logical_neg
id|get_outgoing_phone
c_func
(paren
id|idev
)paren
)paren
(brace
multiline_comment|/* otherwise start over at first entry */
id|idev-&gt;dial
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;dialretry
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idev-&gt;dialretry
op_ge
id|mlp-&gt;dialmax
)paren
(brace
id|isdn_net_hangup
c_func
(paren
id|idev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|idev-&gt;dial_event
op_assign
id|EV_TIMER_DIAL_WAIT
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|idev-&gt;dial_timer
comma
id|jiffies
op_plus
id|mlp-&gt;dialwait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|connect_fail
id|connect_fail
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|idev-&gt;dial_timer
)paren
suffix:semicolon
id|isdn_slot_all_eaz
c_func
(paren
id|idev-&gt;isdn_slot
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: connection failed&bslash;n&quot;
comma
id|idev-&gt;name
)paren
suffix:semicolon
id|isdn_net_unbind_channel
c_func
(paren
id|idev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|out_dconn
id|out_dconn
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|fsm_change_state
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|ST_OUT_WAIT_BCONN
)paren
suffix:semicolon
id|isdn_slot_command
c_func
(paren
id|idev-&gt;isdn_slot
comma
id|ISDN_CMD_ACCEPTB
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|in_dconn
id|in_dconn
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_ctrl
id|cmd
suffix:semicolon
id|fsm_change_state
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|ST_IN_WAIT_BCONN
)paren
suffix:semicolon
id|isdn_slot_command
c_func
(paren
id|idev-&gt;isdn_slot
comma
id|ISDN_CMD_ACCEPTB
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|bconn
id|bconn
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
id|fsm_change_state
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|ST_ACTIVE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mlp-&gt;onhtime
)paren
(brace
id|idev-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;dial_event
op_assign
id|EV_TIMER_HUP
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|idev-&gt;dial_timer
comma
id|jiffies
op_plus
id|HZ
)paren
suffix:semicolon
)brace
r_else
(brace
id|del_timer
c_func
(paren
op_amp
id|idev-&gt;dial_timer
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s connected&bslash;n&quot;
comma
id|idev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* If first Chargeinfo comes before B-Channel connect,&n;&t; * we correct the timestamp here.&n;&t; */
id|idev-&gt;chargetime
op_assign
id|jiffies
suffix:semicolon
id|idev-&gt;frame_cnt
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;transcount
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;cps
op_assign
l_int|0
suffix:semicolon
id|idev-&gt;last_jiffies
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|mlp-&gt;ops-&gt;connected
)paren
id|mlp-&gt;ops
op_member_access_from_pointer
id|connected
c_func
(paren
id|idev
)paren
suffix:semicolon
r_else
id|isdn_net_online
c_func
(paren
id|idev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|bhup
id|bhup
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|idev-&gt;dial_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mlp-&gt;ops-&gt;disconnected
)paren
id|mlp-&gt;ops
op_member_access_from_pointer
id|disconnected
c_func
(paren
id|idev
)paren
suffix:semicolon
r_else
id|isdn_net_offline
c_func
(paren
id|idev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: disconnected&bslash;n&quot;
comma
id|idev-&gt;name
)paren
suffix:semicolon
id|fsm_change_state
c_func
(paren
id|fi
comma
id|ST_WAIT_DHUP
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|dhup
id|dhup
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Chargesum is %d&bslash;n&quot;
comma
id|idev-&gt;name
comma
id|idev-&gt;charge
)paren
suffix:semicolon
id|isdn_slot_all_eaz
c_func
(paren
id|idev-&gt;isdn_slot
)paren
suffix:semicolon
id|isdn_net_unbind_channel
c_func
(paren
id|idev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Check if it&squot;s time for idle hang-up */
r_static
r_int
DECL|function|check_hup
id|check_hup
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
id|dbg_net_dial
c_func
(paren
l_string|&quot;%s: huptimer %d onhtime %d chargetime %ld chargeint %d&bslash;n&quot;
comma
id|idev-&gt;name
comma
id|idev-&gt;huptimer
comma
id|mlp-&gt;onhtime
comma
id|idev-&gt;chargetime
comma
id|idev-&gt;chargeint
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;huptimer
op_increment
op_le
id|mlp-&gt;onhtime
)paren
r_goto
id|mod_timer
suffix:semicolon
r_if
c_cond
(paren
id|mlp-&gt;hupflags
op_amp
id|ISDN_CHARGEHUP
op_logical_and
id|idev-&gt;charge_state
op_eq
id|ST_CHARGE_HAVE_CINT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|time_after
c_func
(paren
id|jiffies
comma
id|idev-&gt;chargetime
op_plus
id|idev-&gt;chargeint
op_minus
l_int|2
op_star
id|HZ
)paren
)paren
r_goto
id|mod_timer
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idev-&gt;outgoing
op_logical_or
id|mlp-&gt;hupflags
op_amp
id|ISDN_INHUP
)paren
(brace
id|isdn_net_hangup
c_func
(paren
id|idev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mod_timer
suffix:colon
id|mod_timer
c_func
(paren
op_amp
id|idev-&gt;dial_timer
comma
id|idev-&gt;dial_timer.expires
op_plus
id|HZ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Charge-info from TelCo. */
r_static
r_int
DECL|function|got_cinf
id|got_cinf
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|idev-&gt;charge
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|idev-&gt;charge_state
)paren
(brace
r_case
id|ST_CHARGE_NULL
suffix:colon
id|idev-&gt;charge_state
op_assign
id|ST_CHARGE_GOT_CINF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ST_CHARGE_GOT_CINF
suffix:colon
id|idev-&gt;charge_state
op_assign
id|ST_CHARGE_HAVE_CINT
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|ST_CHARGE_HAVE_CINT
suffix:colon
id|idev-&gt;chargeint
op_assign
id|jiffies
op_minus
id|idev-&gt;chargetime
suffix:semicolon
r_break
suffix:semicolon
)brace
id|idev-&gt;chargetime
op_assign
id|jiffies
suffix:semicolon
id|dbg_net_dial
c_func
(paren
l_string|&quot;%s: got CINF&bslash;n&quot;
comma
id|idev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Perform hangup for a net-interface. */
r_int
DECL|function|isdn_net_hangup
id|isdn_net_hangup
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
id|isdn_ctrl
id|cmd
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|idev-&gt;dial_timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: local hangup&bslash;n&quot;
comma
id|idev-&gt;name
)paren
suffix:semicolon
singleline_comment|// FIXME via state machine
r_if
c_cond
(paren
id|idev-&gt;isdn_slot
op_ge
l_int|0
)paren
id|isdn_slot_command
c_func
(paren
id|idev-&gt;isdn_slot
comma
id|ISDN_CMD_HANGUP
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle status-messages from ISDN-interfacecard.&n; * This function is called from within the main-status-dispatcher&n; * isdn_status_callback, which itself is called from the low-level driver.&n; * Return: 1 = event handled, 0 = not handled&n; */
r_static
r_int
DECL|function|isdn_net_stat_callback
id|isdn_net_stat_callback
c_func
(paren
r_int
id|idx
comma
id|isdn_ctrl
op_star
id|c
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_slot_priv
c_func
(paren
id|idx
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|c-&gt;command
)paren
(brace
r_case
id|ISDN_STAT_DCONN
suffix:colon
r_return
id|fsm_event
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|EV_STAT_DCONN
comma
id|c
)paren
suffix:semicolon
r_case
id|ISDN_STAT_BCONN
suffix:colon
r_return
id|fsm_event
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|EV_STAT_BCONN
comma
id|c
)paren
suffix:semicolon
r_case
id|ISDN_STAT_BHUP
suffix:colon
r_return
id|fsm_event
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|EV_STAT_BHUP
comma
id|c
)paren
suffix:semicolon
r_case
id|ISDN_STAT_DHUP
suffix:colon
r_return
id|fsm_event
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|EV_STAT_DHUP
comma
id|c
)paren
suffix:semicolon
r_case
id|ISDN_STAT_CINF
suffix:colon
r_return
id|fsm_event
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|EV_STAT_CINF
comma
id|c
)paren
suffix:semicolon
r_case
id|ISDN_STAT_BSENT
suffix:colon
r_return
id|fsm_event
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|EV_STAT_BSENT
comma
id|c
)paren
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;unknown stat %d&bslash;n&quot;
comma
id|c-&gt;command
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|isdn_net_handle_event
id|isdn_net_handle_event
c_func
(paren
id|isdn_net_dev
op_star
id|idev
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|fsm_event
c_func
(paren
op_amp
id|idev-&gt;fi
comma
id|pr
comma
id|arg
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|hang_up
id|hang_up
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_net_hangup
c_func
(paren
id|idev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|got_bsent
id|got_bsent
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
id|isdn_ctrl
op_star
id|c
op_assign
id|arg
suffix:semicolon
id|isdn_net_bsent
c_func
(paren
id|idev
comma
id|c
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|isdn_net_fn_tbl
r_static
r_struct
id|fsm_node
id|isdn_net_fn_tbl
(braket
)braket
op_assign
(brace
(brace
id|ST_NULL
comma
id|EV_DO_DIAL
comma
id|do_dial
)brace
comma
(brace
id|ST_NULL
comma
id|EV_DO_ACCEPT
comma
id|accept_icall
)brace
comma
(brace
id|ST_NULL
comma
id|EV_DO_CALLBACK
comma
id|do_callback
)brace
comma
(brace
id|ST_OUT_WAIT_DCONN
comma
id|EV_TIMER_DIAL
comma
id|dial_timeout
)brace
comma
(brace
id|ST_OUT_WAIT_DCONN
comma
id|EV_STAT_DCONN
comma
id|out_dconn
)brace
comma
(brace
id|ST_OUT_WAIT_DCONN
comma
id|EV_STAT_DHUP
comma
id|connect_fail
)brace
comma
(brace
id|ST_OUT_WAIT_DCONN
comma
id|EV_TIMER_CB_OUT
comma
id|hang_up
)brace
comma
(brace
id|ST_OUT_WAIT_BCONN
comma
id|EV_TIMER_DIAL
comma
id|dial_timeout
)brace
comma
(brace
id|ST_OUT_WAIT_BCONN
comma
id|EV_STAT_BCONN
comma
id|bconn
)brace
comma
(brace
id|ST_OUT_WAIT_BCONN
comma
id|EV_STAT_DHUP
comma
id|connect_fail
)brace
comma
(brace
id|ST_IN_WAIT_DCONN
comma
id|EV_TIMER_INCOMING
comma
id|hang_up
)brace
comma
(brace
id|ST_IN_WAIT_DCONN
comma
id|EV_STAT_DCONN
comma
id|in_dconn
)brace
comma
(brace
id|ST_IN_WAIT_DCONN
comma
id|EV_STAT_DHUP
comma
id|connect_fail
)brace
comma
(brace
id|ST_IN_WAIT_BCONN
comma
id|EV_TIMER_INCOMING
comma
id|hang_up
)brace
comma
(brace
id|ST_IN_WAIT_BCONN
comma
id|EV_STAT_BCONN
comma
id|bconn
)brace
comma
(brace
id|ST_IN_WAIT_BCONN
comma
id|EV_STAT_DHUP
comma
id|connect_fail
)brace
comma
(brace
id|ST_ACTIVE
comma
id|EV_TIMER_HUP
comma
id|check_hup
)brace
comma
(brace
id|ST_ACTIVE
comma
id|EV_STAT_BHUP
comma
id|bhup
)brace
comma
(brace
id|ST_ACTIVE
comma
id|EV_STAT_CINF
comma
id|got_cinf
)brace
comma
(brace
id|ST_ACTIVE
comma
id|EV_STAT_BSENT
comma
id|got_bsent
)brace
comma
(brace
id|ST_WAIT_DHUP
comma
id|EV_STAT_DHUP
comma
id|dhup
)brace
comma
(brace
id|ST_WAIT_BEFORE_CB
comma
id|EV_TIMER_CB_IN
comma
id|do_dial
)brace
comma
(brace
id|ST_OUT_DIAL_WAIT
comma
id|EV_TIMER_DIAL_WAIT
comma
id|dialout_next
)brace
comma
)brace
suffix:semicolon
DECL|variable|isdn_net_fsm
r_static
r_struct
id|fsm
id|isdn_net_fsm
op_assign
(brace
dot
id|st_cnt
op_assign
id|ARRAY_SIZE
c_func
(paren
id|isdn_net_st_str
)paren
comma
dot
id|st_str
op_assign
id|isdn_net_st_str
comma
dot
id|ev_cnt
op_assign
id|ARRAY_SIZE
c_func
(paren
id|isdn_net_ev_str
)paren
comma
dot
id|ev_str
op_assign
id|isdn_net_ev_str
comma
dot
id|fn_cnt
op_assign
id|ARRAY_SIZE
c_func
(paren
id|isdn_net_fn_tbl
)paren
comma
dot
id|fn_tbl
op_assign
id|isdn_net_fn_tbl
comma
)brace
suffix:semicolon
DECL|function|isdn_net_dev_debug
r_static
r_void
id|isdn_net_dev_debug
c_func
(paren
r_struct
id|fsm_inst
op_star
id|fi
comma
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
id|isdn_net_dev
op_star
id|idev
op_assign
id|fi-&gt;userdata
suffix:semicolon
r_char
id|buf
(braket
l_int|128
)braket
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%s: &quot;
comma
id|idev-&gt;name
)paren
suffix:semicolon
id|p
op_add_assign
id|vsprintf
c_func
(paren
id|p
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
multiline_comment|/* ====================================================================== */
multiline_comment|/* xmit path                                                              */
multiline_comment|/* ====================================================================== */
DECL|macro|ISDN_NET_MAX_QUEUE_LENGTH
mdefine_line|#define ISDN_NET_MAX_QUEUE_LENGTH 2
multiline_comment|/*&n; * is this particular channel busy?&n; */
r_static
r_inline
r_int
DECL|function|isdn_net_dev_busy
id|isdn_net_dev_busy
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
r_return
id|idev-&gt;frame_cnt
op_ge
id|ISDN_NET_MAX_QUEUE_LENGTH
suffix:semicolon
)brace
multiline_comment|/*&n; * find out if the net_device which this mlp is belongs to is busy.&n; * It&squot;s busy iff all channels are busy.&n; * must hold mlp-&gt;xmit_lock&n; * FIXME: Use a mlp-&gt;frame_cnt instead of loop?&n; */
r_static
r_inline
r_int
DECL|function|isdn_net_local_busy
id|isdn_net_local_busy
c_func
(paren
id|isdn_net_local
op_star
id|mlp
)paren
(brace
id|isdn_net_dev
op_star
id|idev
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|idev
comma
op_amp
id|mlp-&gt;online
comma
id|online
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|isdn_net_dev_busy
c_func
(paren
id|idev
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * For the given net device, this will get a non-busy channel out of the&n; * corresponding bundle.&n; * must hold mlp-&gt;xmit_lock&n; */
id|isdn_net_dev
op_star
DECL|function|isdn_net_get_xmit_dev
id|isdn_net_get_xmit_dev
c_func
(paren
id|isdn_net_local
op_star
id|mlp
)paren
(brace
id|isdn_net_dev
op_star
id|idev
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|idev
comma
op_amp
id|mlp-&gt;online
comma
id|online
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|isdn_net_dev_busy
c_func
(paren
id|idev
)paren
)paren
(brace
multiline_comment|/* point the head to next online channel */
id|list_del
c_func
(paren
op_amp
id|mlp-&gt;online
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|mlp-&gt;online
comma
op_amp
id|idev-&gt;online
)paren
suffix:semicolon
r_return
id|idev
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* mlp-&gt;xmit_lock must be held */
r_static
r_inline
r_void
DECL|function|isdn_net_inc_frame_cnt
id|isdn_net_inc_frame_cnt
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_if
c_cond
(paren
id|isdn_net_dev_busy
c_func
(paren
id|idev
)paren
)paren
id|isdn_BUG
c_func
(paren
)paren
suffix:semicolon
id|idev-&gt;frame_cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|isdn_net_local_busy
c_func
(paren
id|mlp
)paren
)paren
id|netif_stop_queue
c_func
(paren
op_amp
id|mlp-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/* mlp-&gt;xmit_lock must be held */
r_static
r_inline
r_void
DECL|function|isdn_net_dec_frame_cnt
id|isdn_net_dec_frame_cnt
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
id|idev-&gt;frame_cnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|isdn_net_dev_busy
c_func
(paren
id|idev
)paren
)paren
id|isdn_BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|idev-&gt;super_tx_queue
)paren
)paren
id|tasklet_schedule
c_func
(paren
op_amp
id|idev-&gt;tlet
)paren
suffix:semicolon
r_else
id|netif_wake_queue
c_func
(paren
op_amp
id|mlp-&gt;dev
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|isdn_net_tasklet
id|isdn_net_tasklet
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
(paren
id|isdn_net_dev
op_star
)paren
id|data
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mlp-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|isdn_net_dev_busy
c_func
(paren
id|idev
)paren
op_logical_and
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|idev-&gt;super_tx_queue
)paren
)paren
)paren
(brace
id|isdn_net_writebuf_skb
c_func
(paren
id|idev
comma
id|skb
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mlp-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* We&squot;re good to accept (IP/whatever) traffic now */
r_void
DECL|function|isdn_net_online
id|isdn_net_online
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
singleline_comment|// FIXME check we&squot;re connected
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mlp-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|idev-&gt;online
comma
op_amp
id|mlp-&gt;online
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mlp-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
op_amp
id|mlp-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/* No more (IP/whatever) traffic over the net interface */
r_void
DECL|function|isdn_net_offline
id|isdn_net_offline
c_func
(paren
id|isdn_net_dev
op_star
id|idev
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mlp-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|idev-&gt;online
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mlp-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|idev-&gt;super_tx_queue
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * all frames sent from the (net) LL to a HL driver should go via this function&n; * must hold mlp-&gt;xmit_lock&n; */
r_void
DECL|function|isdn_net_writebuf_skb
id|isdn_net_writebuf_skb
c_func
(paren
id|isdn_net_dev
op_star
id|idev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* save len */
multiline_comment|/* before obtaining the lock the caller should have checked that&n;&t;   the lp isn&squot;t busy */
r_if
c_cond
(paren
id|isdn_net_dev_busy
c_func
(paren
id|idev
)paren
)paren
(brace
id|isdn_BUG
c_func
(paren
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|isdn_net_is_connected
c_func
(paren
id|idev
)paren
)paren
(brace
id|isdn_BUG
c_func
(paren
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|ret
op_assign
id|isdn_slot_write
c_func
(paren
id|idev-&gt;isdn_slot
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|len
)paren
(brace
multiline_comment|/* we should never get here */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: HL driver queue full&bslash;n&quot;
comma
id|idev-&gt;name
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|idev-&gt;transcount
op_add_assign
id|len
suffix:semicolon
id|isdn_net_inc_frame_cnt
c_func
(paren
id|idev
)paren
suffix:semicolon
r_return
suffix:semicolon
id|error
suffix:colon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|mlp-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* A packet has successfully been sent out. */
r_static
r_int
DECL|function|isdn_net_bsent
id|isdn_net_bsent
c_func
(paren
id|isdn_net_dev
op_star
id|idev
comma
id|isdn_ctrl
op_star
id|c
)paren
(brace
id|isdn_net_local
op_star
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mlp-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
id|isdn_net_dec_frame_cnt
c_func
(paren
id|idev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mlp-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
id|mlp-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|mlp-&gt;stats.tx_bytes
op_add_assign
id|c-&gt;parm.length
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *  Based on cps-calculation, check if device is overloaded.&n; *  If so, and if a slave exists, trigger dialing for it.&n; *  If any slave is online, deliver packets using a simple round robin&n; *  scheme.&n; *&n; *  Return: 0 on success, !0 on failure.&n; */
r_int
DECL|function|isdn_net_start_xmit
id|isdn_net_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|isdn_net_dev
op_star
id|idev
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
op_assign
id|ndev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|ndev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mlp-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|mlp-&gt;online
)paren
)paren
(brace
id|retval
op_assign
id|isdn_net_autodial
c_func
(paren
id|skb
comma
id|ndev
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|idev
op_assign
id|isdn_net_get_xmit_dev
c_func
(paren
id|mlp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: all channels busy - requeuing!&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|retval
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|isdn_net_writebuf_skb
c_func
(paren
id|idev
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* the following stuff is here for backwards compatibility.&n;&t; * in future, start-up and hangup of slaves (based on current load)&n;&t; * should move to userspace and get based on an overall cps&n;&t; * calculation&n;&t; */
r_if
c_cond
(paren
id|jiffies
op_ne
id|idev-&gt;last_jiffies
)paren
(brace
id|idev-&gt;cps
op_assign
id|idev-&gt;transcount
op_star
id|HZ
op_div
(paren
id|jiffies
op_minus
id|idev-&gt;last_jiffies
)paren
suffix:semicolon
id|idev-&gt;last_jiffies
op_assign
id|jiffies
suffix:semicolon
id|idev-&gt;transcount
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;net_verbose
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %d bogocps&bslash;n&quot;
comma
id|idev-&gt;name
comma
id|idev-&gt;cps
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idev-&gt;cps
OG
id|mlp-&gt;triggercps
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|idev-&gt;sqfull
)paren
(brace
multiline_comment|/* First time overload: set timestamp only */
id|idev-&gt;sqfull
op_assign
l_int|1
suffix:semicolon
id|idev-&gt;sqfull_stamp
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* subsequent overload: if slavedelay exceeded, start dialing */
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|idev-&gt;sqfull_stamp
op_plus
id|mlp-&gt;slavedelay
)paren
)paren
(brace
r_if
c_cond
(paren
id|ISDN_NET_DIALMODE
c_func
(paren
op_star
id|mlp
)paren
op_eq
id|ISDN_NET_DM_AUTO
)paren
id|__isdn_net_dial_slave
c_func
(paren
id|mlp
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|idev-&gt;sqfull
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|idev-&gt;sqfull_stamp
op_plus
id|mlp-&gt;slavedelay
op_plus
l_int|10
op_star
id|HZ
)paren
)paren
(brace
id|idev-&gt;sqfull
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* this is a hack to allow auto-hangup for slaves on moderate loads */
id|list_del
c_func
(paren
op_amp
id|mlp-&gt;online
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|mlp-&gt;online
comma
op_amp
id|idev-&gt;online
)paren
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mlp-&gt;xmit_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * this function is used to send supervisory data, i.e. data which was&n; * not received from the network layer, but e.g. frames from ipppd, CCP&n; * reset frames etc.&n; * must hold mlp-&gt;xmit_lock&n; */
r_void
DECL|function|isdn_net_write_super
id|isdn_net_write_super
c_func
(paren
id|isdn_net_dev
op_star
id|idev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|isdn_net_dev_busy
c_func
(paren
id|idev
)paren
)paren
(brace
id|isdn_net_writebuf_skb
c_func
(paren
id|idev
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|idev-&gt;super_tx_queue
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ====================================================================== */
multiline_comment|/* receive path                                                           */
multiline_comment|/* ====================================================================== */
multiline_comment|/*&n; * A packet arrived via ISDN. Search interface-chain for a corresponding&n; * interface. If found, deliver packet to receiver-function and return 1,&n; * else return 0.&n; */
r_static
r_int
DECL|function|isdn_net_rcv_skb
id|isdn_net_rcv_skb
c_func
(paren
r_int
id|idx
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|isdn_net_dev
op_star
id|idev
op_assign
id|isdn_slot_priv
c_func
(paren
id|idx
)paren
suffix:semicolon
id|isdn_net_local
op_star
id|mlp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idev
)paren
(brace
id|isdn_BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|isdn_net_is_connected
c_func
(paren
id|idev
)paren
)paren
(brace
id|isdn_BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mlp
op_assign
id|idev-&gt;mlp
suffix:semicolon
id|idev-&gt;transcount
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|mlp-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|mlp-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|skb-&gt;dev
op_assign
op_amp
id|mlp-&gt;dev
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|isdn_dumppkt
c_func
(paren
l_string|&quot;R:&quot;
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
l_int|40
)paren
suffix:semicolon
id|mlp-&gt;ops
op_member_access_from_pointer
id|receive
c_func
(paren
id|mlp
comma
id|idev
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * After handling connection-type specific stuff, the receiver function&n; * can use this function to pass the skb on to the network layer.&n; */
r_void
DECL|function|isdn_netif_rx
id|isdn_netif_rx
c_func
(paren
id|isdn_net_dev
op_star
id|idev
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|u16
id|protocol
)paren
(brace
id|idev-&gt;huptimer
op_assign
l_int|0
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|protocol
suffix:semicolon
id|skb-&gt;dev
op_assign
op_amp
id|idev-&gt;mlp-&gt;dev
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* ====================================================================== */
multiline_comment|/* init / exit                                                            */
multiline_comment|/* ====================================================================== */
r_void
DECL|function|isdn_net_lib_init
id|isdn_net_lib_init
c_func
(paren
r_void
)paren
(brace
id|fsm_new
c_func
(paren
op_amp
id|isdn_net_fsm
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISDN_NET_SIMPLE
id|register_isdn_netif
c_func
(paren
id|ISDN_NET_ENCAP_ETHER
comma
op_amp
id|isdn_ether_ops
)paren
suffix:semicolon
id|register_isdn_netif
c_func
(paren
id|ISDN_NET_ENCAP_RAWIP
comma
op_amp
id|isdn_rawip_ops
)paren
suffix:semicolon
id|register_isdn_netif
c_func
(paren
id|ISDN_NET_ENCAP_IPTYP
comma
op_amp
id|isdn_iptyp_ops
)paren
suffix:semicolon
id|register_isdn_netif
c_func
(paren
id|ISDN_NET_ENCAP_UIHDLC
comma
op_amp
id|isdn_uihdlc_ops
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_NET_CISCO
id|register_isdn_netif
c_func
(paren
id|ISDN_NET_ENCAP_CISCOHDLC
comma
op_amp
id|isdn_ciscohdlck_ops
)paren
suffix:semicolon
id|register_isdn_netif
c_func
(paren
id|ISDN_NET_ENCAP_CISCOHDLCK
comma
op_amp
id|isdn_ciscohdlck_ops
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_X25
id|register_isdn_netif
c_func
(paren
id|ISDN_NET_ENCAP_X25IFACE
comma
op_amp
id|isdn_x25_ops
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ISDN_PPP
id|register_isdn_netif
c_func
(paren
id|ISDN_NET_ENCAP_SYNCPPP
comma
op_amp
id|isdn_ppp_ops
)paren
suffix:semicolon
macro_line|#endif
)brace
r_void
DECL|function|isdn_net_lib_exit
id|isdn_net_lib_exit
c_func
(paren
r_void
)paren
(brace
id|fsm_free
c_func
(paren
op_amp
id|isdn_net_fsm
)paren
suffix:semicolon
)brace
eof
