multiline_comment|/*&n; * hfc_usb.c&n; *&n; * modular HiSax ISDN driver for Colognechip HFC-USB chip&n; *&n; * Authors : Peter Sprenger  (sprenger@moving-byters.de)&n; *           Martin Bachem   (info@colognechip.com)&n; *           based on the first hfc_usb driver of Werner Cornelius (werner@isdn-development.de)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n;*/
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;hisax.h&quot;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel_stat.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &quot;hisax_if.h&quot;
DECL|variable|hfcusb_revision
r_static
r_const
r_char
op_star
id|hfcusb_revision
op_assign
l_string|&quot;4.0&quot;
suffix:semicolon
multiline_comment|/*&n;&t;to enable much mire debug messages in this driver, define&n;&t;&t;&t;VERBOSE_USB_DEBUG and VERBOSE_ISDN_DEBUG&n;&t;below&n;*/
DECL|macro|VERBOSE_USB_DEBUG
mdefine_line|#define VERBOSE_USB_DEBUG
DECL|macro|VERBOSE_ISDN_DEBUG
mdefine_line|#define VERBOSE_ISDN_DEBUG
DECL|macro|INCLUDE_INLINE_FUNCS
mdefine_line|#define INCLUDE_INLINE_FUNCS
DECL|macro|TRUE
mdefine_line|#define TRUE  1
DECL|macro|FALSE
mdefine_line|#define FALSE 0
multiline_comment|/***********/
multiline_comment|/* defines */
multiline_comment|/***********/
DECL|macro|HFC_CTRL_TIMEOUT
mdefine_line|#define HFC_CTRL_TIMEOUT&t;20  
singleline_comment|//(HZ * USB_CTRL_GET_TIMEOUT)
multiline_comment|/* 5ms timeout writing/reading regs */
DECL|macro|HFC_TIMER_T3
mdefine_line|#define HFC_TIMER_T3     8000      /* timeout for l1 activation timer */
DECL|macro|HFC_TIMER_T4
mdefine_line|#define HFC_TIMER_T4     500       /* time for state change interval */
DECL|macro|HFCUSB_L1_STATECHANGE
mdefine_line|#define HFCUSB_L1_STATECHANGE   0  /* L1 state changed */
DECL|macro|HFCUSB_L1_DRX
mdefine_line|#define HFCUSB_L1_DRX           1  /* D-frame received */
DECL|macro|HFCUSB_L1_ERX
mdefine_line|#define HFCUSB_L1_ERX           2  /* E-frame received */
DECL|macro|HFCUSB_L1_DTX
mdefine_line|#define HFCUSB_L1_DTX           4  /* D-frames completed */
DECL|macro|MAX_BCH_SIZE
mdefine_line|#define MAX_BCH_SIZE        2048   /* allowed B-channel packet size */
DECL|macro|HFCUSB_RX_THRESHOLD
mdefine_line|#define HFCUSB_RX_THRESHOLD 64     /* threshold for fifo report bit rx */
DECL|macro|HFCUSB_TX_THRESHOLD
mdefine_line|#define HFCUSB_TX_THRESHOLD 64     /* threshold for fifo report bit tx */
DECL|macro|HFCUSB_CHIP_ID
mdefine_line|#define HFCUSB_CHIP_ID    0x16     /* Chip ID register index */
DECL|macro|HFCUSB_CIRM
mdefine_line|#define HFCUSB_CIRM       0x00     /* cirm register index */
DECL|macro|HFCUSB_USB_SIZE
mdefine_line|#define HFCUSB_USB_SIZE   0x07     /* int length register */
DECL|macro|HFCUSB_USB_SIZE_I
mdefine_line|#define HFCUSB_USB_SIZE_I 0x06     /* iso length register */
DECL|macro|HFCUSB_F_CROSS
mdefine_line|#define HFCUSB_F_CROSS    0x0b     /* bit order register */
DECL|macro|HFCUSB_CLKDEL
mdefine_line|#define HFCUSB_CLKDEL     0x37     /* bit delay register */
DECL|macro|HFCUSB_CON_HDLC
mdefine_line|#define HFCUSB_CON_HDLC   0xfa     /* channel connect register */
DECL|macro|HFCUSB_HDLC_PAR
mdefine_line|#define HFCUSB_HDLC_PAR   0xfb
DECL|macro|HFCUSB_SCTRL
mdefine_line|#define HFCUSB_SCTRL      0x31     /* S-bus control register (tx) */
DECL|macro|HFCUSB_SCTRL_E
mdefine_line|#define HFCUSB_SCTRL_E    0x32     /* same for E and special funcs */
DECL|macro|HFCUSB_SCTRL_R
mdefine_line|#define HFCUSB_SCTRL_R    0x33     /* S-bus control register (rx) */
DECL|macro|HFCUSB_F_THRES
mdefine_line|#define HFCUSB_F_THRES    0x0c     /* threshold register */
DECL|macro|HFCUSB_FIFO
mdefine_line|#define HFCUSB_FIFO       0x0f     /* fifo select register */
DECL|macro|HFCUSB_F_USAGE
mdefine_line|#define HFCUSB_F_USAGE    0x1a     /* fifo usage register */
DECL|macro|HFCUSB_MST_MODE0
mdefine_line|#define HFCUSB_MST_MODE0  0x14
DECL|macro|HFCUSB_MST_MODE1
mdefine_line|#define HFCUSB_MST_MODE1  0x15
DECL|macro|HFCUSB_P_DATA
mdefine_line|#define HFCUSB_P_DATA     0x1f
DECL|macro|HFCUSB_INC_RES_F
mdefine_line|#define HFCUSB_INC_RES_F  0x0e
DECL|macro|HFCUSB_STATES
mdefine_line|#define HFCUSB_STATES     0x30
DECL|macro|HFCUSB_CHIPID
mdefine_line|#define HFCUSB_CHIPID 0x40         /* ID value of HFC-USB */
multiline_comment|/******************/
multiline_comment|/* fifo registers */
multiline_comment|/******************/
DECL|macro|HFCUSB_NUM_FIFOS
mdefine_line|#define HFCUSB_NUM_FIFOS   8       /* maximum number of fifos */
DECL|macro|HFCUSB_B1_TX
mdefine_line|#define HFCUSB_B1_TX       0       /* index for B1 transmit bulk/int */
DECL|macro|HFCUSB_B1_RX
mdefine_line|#define HFCUSB_B1_RX       1       /* index for B1 receive bulk/int */
DECL|macro|HFCUSB_B2_TX
mdefine_line|#define HFCUSB_B2_TX       2
DECL|macro|HFCUSB_B2_RX
mdefine_line|#define HFCUSB_B2_RX       3
DECL|macro|HFCUSB_D_TX
mdefine_line|#define HFCUSB_D_TX        4
DECL|macro|HFCUSB_D_RX
mdefine_line|#define HFCUSB_D_RX        5
DECL|macro|HFCUSB_PCM_TX
mdefine_line|#define HFCUSB_PCM_TX      6
DECL|macro|HFCUSB_PCM_RX
mdefine_line|#define HFCUSB_PCM_RX      7
multiline_comment|/*&n;* used to switch snd_transfer_mode for different TA modes e.g. the Billion USB TA just&n;* supports ISO out, while the Cologne Chip EVAL TA just supports BULK out&n;*/
DECL|macro|USB_INT
mdefine_line|#define USB_INT&t;&t;0
DECL|macro|USB_BULK
mdefine_line|#define USB_BULK&t;1
DECL|macro|USB_ISOC
mdefine_line|#define USB_ISOC&t;2
DECL|macro|ISOC_PACKETS_D
mdefine_line|#define ISOC_PACKETS_D&t;8
DECL|macro|ISOC_PACKETS_B
mdefine_line|#define ISOC_PACKETS_B&t;8
DECL|macro|ISO_BUFFER_SIZE
mdefine_line|#define ISO_BUFFER_SIZE&t;128
singleline_comment|// ISO send definitions
DECL|macro|SINK_MAX
mdefine_line|#define SINK_MAX&t;68
DECL|macro|SINK_MIN
mdefine_line|#define SINK_MIN&t;48
DECL|macro|SINK_DMIN
mdefine_line|#define SINK_DMIN&t;12
DECL|macro|SINK_DMAX
mdefine_line|#define SINK_DMAX&t;18
DECL|macro|BITLINE_INF
mdefine_line|#define BITLINE_INF&t;(-64*8)
multiline_comment|/**********/
multiline_comment|/* macros */
multiline_comment|/**********/
DECL|macro|write_usb
mdefine_line|#define write_usb(a,b,c) usb_control_msg((a)-&gt;dev,(a)-&gt;ctrl_out_pipe,0,0x40,(c),(b),NULL,0,HFC_CTRL_TIMEOUT)
DECL|macro|read_usb
mdefine_line|#define read_usb(a,b,c) usb_control_msg((a)-&gt;dev,(a)-&gt;ctrl_in_pipe,1,0xC0,0,(b),(c),1,HFC_CTRL_TIMEOUT)
multiline_comment|/*************************************************/
multiline_comment|/* entry and size of output/input control buffer */
multiline_comment|/*************************************************/
DECL|macro|HFC_CTRL_BUFSIZE
mdefine_line|#define HFC_CTRL_BUFSIZE 32
r_typedef
r_struct
(brace
DECL|member|hfc_reg
id|__u8
id|hfc_reg
suffix:semicolon
multiline_comment|/* register number */
DECL|member|reg_val
id|__u8
id|reg_val
suffix:semicolon
multiline_comment|/* value to be written (or read) */
DECL|member|action
r_int
id|action
suffix:semicolon
multiline_comment|/* data for action handler */
DECL|typedef|ctrl_buft
)brace
id|ctrl_buft
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|vendor
r_int
id|vendor
suffix:semicolon
singleline_comment|// vendor id
DECL|member|prod_id
r_int
id|prod_id
suffix:semicolon
singleline_comment|// product id
DECL|member|vend_name
r_char
op_star
id|vend_name
suffix:semicolon
singleline_comment|// vendor string
DECL|member|led_scheme
id|__u8
id|led_scheme
suffix:semicolon
singleline_comment|// led display scheme
DECL|member|led_invert
id|__u8
id|led_invert
suffix:semicolon
singleline_comment|// invert led aux port settings
DECL|member|led_bits
id|__u8
id|led_bits
(braket
l_int|8
)braket
suffix:semicolon
singleline_comment|// array of 8 possible LED bitmask settings
DECL|typedef|vendor_data
)brace
id|vendor_data
suffix:semicolon
multiline_comment|/***************************************************************/
multiline_comment|/* structure defining input+output fifos (interrupt/bulk mode) */
multiline_comment|/***************************************************************/
r_struct
id|usb_fifo
suffix:semicolon
multiline_comment|/* forward definition */
DECL|struct|iso_urb_struct
r_typedef
r_struct
id|iso_urb_struct
(brace
DECL|member|purb
r_struct
id|urb
op_star
id|purb
suffix:semicolon
DECL|member|buffer
id|__u8
id|buffer
(braket
id|ISO_BUFFER_SIZE
)braket
suffix:semicolon
multiline_comment|/* buffer incoming/outgoing data */
DECL|member|owner_fifo
r_struct
id|usb_fifo
op_star
id|owner_fifo
suffix:semicolon
singleline_comment|// pointer to owner fifo
DECL|typedef|iso_urb_struct
)brace
id|iso_urb_struct
suffix:semicolon
r_struct
id|hfcusb_data
suffix:semicolon
multiline_comment|/* forward definition */
DECL|struct|usb_fifo
r_typedef
r_struct
id|usb_fifo
(brace
DECL|member|fifonum
r_int
id|fifonum
suffix:semicolon
multiline_comment|/* fifo index attached to this structure */
DECL|member|active
r_int
id|active
suffix:semicolon
multiline_comment|/* fifo is currently active */
DECL|member|hfc
r_struct
id|hfcusb_data
op_star
id|hfc
suffix:semicolon
multiline_comment|/* pointer to main structure */
DECL|member|pipe
r_int
id|pipe
suffix:semicolon
multiline_comment|/* address of endpoint */
DECL|member|usb_packet_maxlen
id|__u8
id|usb_packet_maxlen
suffix:semicolon
multiline_comment|/* maximum length for usb transfer */
DECL|member|max_size
r_int
r_int
id|max_size
suffix:semicolon
multiline_comment|/* maximum size of receive/send packet */
DECL|member|intervall
id|__u8
id|intervall
suffix:semicolon
multiline_comment|/* interrupt interval */
DECL|member|skbuff
r_struct
id|sk_buff
op_star
id|skbuff
suffix:semicolon
multiline_comment|/* actual used buffer */
DECL|member|urb
r_struct
id|urb
op_star
id|urb
suffix:semicolon
multiline_comment|/* transfer structure for usb routines */
DECL|member|buffer
id|__u8
id|buffer
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* buffer incoming/outgoing data */
DECL|member|bit_line
r_int
id|bit_line
suffix:semicolon
multiline_comment|/* how much bits are in the fifo? */
DECL|member|usb_transfer_mode
r_volatile
id|__u8
id|usb_transfer_mode
suffix:semicolon
multiline_comment|/* switched between ISO and INT */
DECL|member|iso
id|iso_urb_struct
id|iso
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* need two urbs to have one always for pending */
DECL|member|hif
r_struct
id|hisax_if
op_star
id|hif
suffix:semicolon
multiline_comment|/* hisax interface */
DECL|member|delete_flg
r_int
id|delete_flg
suffix:semicolon
multiline_comment|/* only delete skbuff once */
DECL|member|last_urblen
r_int
id|last_urblen
suffix:semicolon
multiline_comment|/* remember length of last packet */
DECL|typedef|usb_fifo
)brace
id|usb_fifo
suffix:semicolon
multiline_comment|/*********************************************/
multiline_comment|/* structure holding all data for one device */
multiline_comment|/*********************************************/
DECL|struct|hfcusb_data
r_typedef
r_struct
id|hfcusb_data
(brace
singleline_comment|// HiSax Interface for loadable Layer1 drivers
DECL|member|d_if
r_struct
id|hisax_d_if
id|d_if
suffix:semicolon
multiline_comment|/* see hisax_if.h */
DECL|member|b_if
r_struct
id|hisax_b_if
id|b_if
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* see hisax_if.h */
DECL|member|protocol
r_int
id|protocol
suffix:semicolon
DECL|member|dev
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
multiline_comment|/* our device */
DECL|member|if_used
r_int
id|if_used
suffix:semicolon
multiline_comment|/* used interface number */
DECL|member|alt_used
r_int
id|alt_used
suffix:semicolon
multiline_comment|/* used alternate config */
DECL|member|ctrl_paksize
r_int
id|ctrl_paksize
suffix:semicolon
multiline_comment|/* control pipe packet size */
DECL|member|ctrl_in_pipe
DECL|member|ctrl_out_pipe
r_int
id|ctrl_in_pipe
comma
id|ctrl_out_pipe
suffix:semicolon
multiline_comment|/* handles for control pipe */
DECL|member|cfg_used
r_int
id|cfg_used
suffix:semicolon
multiline_comment|/* configuration index used */
DECL|member|vend_idx
r_int
id|vend_idx
suffix:semicolon
singleline_comment|// vendor found
DECL|member|b_mode
r_int
id|b_mode
(braket
l_int|2
)braket
suffix:semicolon
singleline_comment|// B-channel mode
DECL|member|l1_activated
r_int
id|l1_activated
suffix:semicolon
singleline_comment|// layer 1 activated
DECL|member|packet_size
DECL|member|iso_packet_size
r_int
id|packet_size
comma
id|iso_packet_size
suffix:semicolon
multiline_comment|/* control pipe background handling */
DECL|member|ctrl_buff
id|ctrl_buft
id|ctrl_buff
(braket
id|HFC_CTRL_BUFSIZE
)braket
suffix:semicolon
multiline_comment|/* buffer holding queued data */
DECL|member|ctrl_in_idx
DECL|member|ctrl_out_idx
r_volatile
r_int
id|ctrl_in_idx
comma
id|ctrl_out_idx
comma
DECL|member|ctrl_cnt
id|ctrl_cnt
suffix:semicolon
multiline_comment|/* input/output pointer + count */
DECL|member|ctrl_urb
r_struct
id|urb
op_star
id|ctrl_urb
suffix:semicolon
multiline_comment|/* transfer structure for control channel */
DECL|member|ctrl_write
r_struct
id|usb_ctrlrequest
id|ctrl_write
suffix:semicolon
multiline_comment|/* buffer for control write request */
DECL|member|ctrl_read
r_struct
id|usb_ctrlrequest
id|ctrl_read
suffix:semicolon
multiline_comment|/* same for read request */
DECL|member|led_state
DECL|member|led_new_data
DECL|member|led_b_active
id|__u8
id|led_state
comma
id|led_new_data
comma
id|led_b_active
suffix:semicolon
DECL|member|threshold_mask
r_volatile
id|__u8
id|threshold_mask
suffix:semicolon
multiline_comment|/* threshold actually reported */
DECL|member|bch_enables
r_volatile
id|__u8
id|bch_enables
suffix:semicolon
multiline_comment|/* or mask for sctrl_r and sctrl register values */
DECL|member|fifos
id|usb_fifo
id|fifos
(braket
id|HFCUSB_NUM_FIFOS
)braket
suffix:semicolon
multiline_comment|/* structure holding all fifo data */
DECL|member|l1_state
r_volatile
id|__u8
id|l1_state
suffix:semicolon
multiline_comment|/* actual l1 state */
DECL|member|t3_timer
r_struct
id|timer_list
id|t3_timer
suffix:semicolon
multiline_comment|/* timer 3 for activation/deactivation */
DECL|member|t4_timer
r_struct
id|timer_list
id|t4_timer
suffix:semicolon
multiline_comment|/* timer 4 for activation/deactivation */
DECL|member|led_timer
r_struct
id|timer_list
id|led_timer
suffix:semicolon
multiline_comment|/* timer flashing leds */
DECL|typedef|hfcusb_data
)brace
id|hfcusb_data
suffix:semicolon
r_static
r_void
id|collect_rx_frame
c_func
(paren
id|usb_fifo
op_star
id|fifo
comma
id|__u8
op_star
id|data
comma
r_int
id|len
comma
r_int
id|finish
)paren
suffix:semicolon
multiline_comment|/******************************************************/
multiline_comment|/* start next background transfer for control channel */
multiline_comment|/******************************************************/
DECL|function|ctrl_start_transfer
r_static
r_void
id|ctrl_start_transfer
c_func
(paren
id|hfcusb_data
op_star
id|hfc
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|hfc-&gt;ctrl_cnt
)paren
(brace
id|hfc-&gt;ctrl_urb-&gt;pipe
op_assign
id|hfc-&gt;ctrl_out_pipe
suffix:semicolon
id|hfc-&gt;ctrl_urb-&gt;setup_packet
op_assign
(paren
id|u_char
op_star
)paren
op_amp
id|hfc-&gt;ctrl_write
suffix:semicolon
id|hfc-&gt;ctrl_urb-&gt;transfer_buffer
op_assign
l_int|NULL
suffix:semicolon
id|hfc-&gt;ctrl_urb-&gt;transfer_buffer_length
op_assign
l_int|0
suffix:semicolon
id|hfc-&gt;ctrl_write.wIndex
op_assign
id|hfc-&gt;ctrl_buff
(braket
id|hfc-&gt;ctrl_out_idx
)braket
dot
id|hfc_reg
suffix:semicolon
id|hfc-&gt;ctrl_write.wValue
op_assign
id|hfc-&gt;ctrl_buff
(braket
id|hfc-&gt;ctrl_out_idx
)braket
dot
id|reg_val
suffix:semicolon
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|hfc-&gt;ctrl_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
multiline_comment|/* start transfer */
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ctrl_start_transfer: submit %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ctrl_start_transfer */
multiline_comment|/************************************/
multiline_comment|/* queue a control transfer request */
multiline_comment|/* return 0 on success.             */
multiline_comment|/************************************/
DECL|function|queue_control_request
r_static
r_int
id|queue_control_request
c_func
(paren
id|hfcusb_data
op_star
id|hfc
comma
id|__u8
id|reg
comma
id|__u8
id|val
comma
r_int
id|action
)paren
(brace
id|ctrl_buft
op_star
id|buf
suffix:semicolon
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
(paren
l_string|&quot;HFC_USB: queue_control_request reg: %x, val: %x&bslash;n&quot;
comma
id|reg
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|hfc-&gt;ctrl_cnt
op_ge
id|HFC_CTRL_BUFSIZE
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* no space left */
id|buf
op_assign
op_amp
id|hfc-&gt;ctrl_buff
(braket
id|hfc-&gt;ctrl_in_idx
)braket
suffix:semicolon
multiline_comment|/* pointer to new index */
id|buf-&gt;hfc_reg
op_assign
id|reg
suffix:semicolon
id|buf-&gt;reg_val
op_assign
id|val
suffix:semicolon
id|buf-&gt;action
op_assign
id|action
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|hfc-&gt;ctrl_in_idx
op_ge
id|HFC_CTRL_BUFSIZE
)paren
id|hfc-&gt;ctrl_in_idx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* pointer wrap */
r_if
c_cond
(paren
op_increment
id|hfc-&gt;ctrl_cnt
op_eq
l_int|1
)paren
id|ctrl_start_transfer
c_func
(paren
id|hfc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* queue_control_request */
DECL|function|control_action_handler
r_static
r_int
id|control_action_handler
c_func
(paren
id|hfcusb_data
op_star
id|hfc
comma
r_int
id|reg
comma
r_int
id|val
comma
r_int
id|action
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|action
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
singleline_comment|// no action defined
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/***************************************************************/
multiline_comment|/* control completion routine handling background control cmds */
multiline_comment|/***************************************************************/
DECL|function|ctrl_complete
r_static
r_void
id|ctrl_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|hfcusb_data
op_star
id|hfc
op_assign
(paren
id|hfcusb_data
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|ctrl_buft
op_star
id|buf
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ctrl_complete cnt %d&bslash;n&quot;
comma
id|hfc-&gt;ctrl_cnt
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
id|hfc-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|hfc-&gt;ctrl_cnt
)paren
(brace
id|buf
op_assign
op_amp
id|hfc-&gt;ctrl_buff
(braket
id|hfc-&gt;ctrl_out_idx
)braket
suffix:semicolon
id|control_action_handler
c_func
(paren
id|hfc
comma
id|buf-&gt;hfc_reg
comma
id|buf-&gt;reg_val
comma
id|buf-&gt;action
)paren
suffix:semicolon
id|hfc-&gt;ctrl_cnt
op_decrement
suffix:semicolon
multiline_comment|/* decrement actual count */
r_if
c_cond
(paren
op_increment
id|hfc-&gt;ctrl_out_idx
op_ge
id|HFC_CTRL_BUFSIZE
)paren
(brace
id|hfc-&gt;ctrl_out_idx
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* pointer wrap */
id|ctrl_start_transfer
c_func
(paren
id|hfc
)paren
suffix:semicolon
multiline_comment|/* start next transfer */
)brace
)brace
multiline_comment|/* ctrl_complete */
DECL|macro|LED_OFF
mdefine_line|#define LED_OFF      0   
singleline_comment|// no LED support
DECL|macro|LED_SCHEME1
mdefine_line|#define LED_SCHEME1  1&t; 
singleline_comment|// LED standard scheme
DECL|macro|LED_SCHEME2
mdefine_line|#define LED_SCHEME2  2&t; 
singleline_comment|// not used yet...
DECL|macro|LED_POWER_ON
mdefine_line|#define LED_POWER_ON&t;1
DECL|macro|LED_POWER_OFF
mdefine_line|#define LED_POWER_OFF&t;2
DECL|macro|LED_S0_ON
mdefine_line|#define LED_S0_ON&t;&t;3
DECL|macro|LED_S0_OFF
mdefine_line|#define LED_S0_OFF&t;&t;4
DECL|macro|LED_B1_ON
mdefine_line|#define LED_B1_ON&t;&t;5
DECL|macro|LED_B1_OFF
mdefine_line|#define LED_B1_OFF&t;&t;6
DECL|macro|LED_B1_DATA
mdefine_line|#define LED_B1_DATA&t;&t;7
DECL|macro|LED_B2_ON
mdefine_line|#define LED_B2_ON&t;&t;8
DECL|macro|LED_B2_OFF
mdefine_line|#define LED_B2_OFF&t;&t;9
DECL|macro|LED_B2_DATA
mdefine_line|#define LED_B2_DATA&t;   10
DECL|macro|LED_NORMAL
mdefine_line|#define LED_NORMAL   0&t; 
singleline_comment|// LEDs are normal
DECL|macro|LED_INVERTED
mdefine_line|#define LED_INVERTED 1   
singleline_comment|// LEDs are inverted
singleline_comment|// time for LED flashing
DECL|macro|LED_TIME
mdefine_line|#define LED_TIME      250
DECL|variable|vdata
id|vendor_data
id|vdata
(braket
)braket
op_assign
(brace
(brace
l_int|0x959
comma
l_int|0x2bd0
comma
l_string|&quot;ISDN USB TA (Cologne Chip HFC-S USB based)&quot;
comma
id|LED_OFF
comma
id|LED_NORMAL
comma
(brace
l_int|4
comma
l_int|0
comma
l_int|2
comma
l_int|1
)brace
)brace
comma
multiline_comment|/* CologneChip Eval TA */
(brace
l_int|0x7b0
comma
l_int|0x0007
comma
l_string|&quot;Billion tiny USB ISDN TA 128&quot;
comma
id|LED_SCHEME1
comma
id|LED_INVERTED
comma
(brace
l_int|8
comma
l_int|0x40
comma
l_int|0x20
comma
l_int|0x10
)brace
)brace
comma
multiline_comment|/* Billion TA */
(brace
l_int|0x742
comma
l_int|0x2008
comma
l_string|&quot;Stollmann USB TA&quot;
comma
id|LED_SCHEME1
comma
id|LED_NORMAL
comma
(brace
l_int|4
comma
l_int|0
comma
l_int|2
comma
l_int|1
)brace
)brace
comma
multiline_comment|/* Stollmann TA */
(brace
l_int|0x8e3
comma
l_int|0x0301
comma
l_string|&quot;Olitec USB RNIS&quot;
comma
id|LED_SCHEME1
comma
id|LED_NORMAL
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|1
comma
l_int|4
)brace
)brace
comma
multiline_comment|/* Olitec TA  */
(brace
l_int|0x675
comma
l_int|0x1688
comma
l_string|&quot;DrayTec USB ISDN TA&quot;
comma
id|LED_SCHEME1
comma
id|LED_NORMAL
comma
(brace
l_int|4
comma
l_int|0
comma
l_int|2
comma
l_int|1
)brace
)brace
comma
multiline_comment|/* Draytec TA */
(brace
l_int|0x7fa
comma
l_int|0x0846
comma
l_string|&quot;Bewan Modem RNIS USB&quot;
comma
id|LED_SCHEME1
comma
id|LED_INVERTED
comma
(brace
l_int|8
comma
l_int|0x40
comma
l_int|0x20
comma
l_int|0x10
)brace
)brace
comma
multiline_comment|/* Bewan TA   */
(brace
l_int|0
)brace
singleline_comment|// EOL element
)brace
suffix:semicolon
multiline_comment|/***************************************************/
multiline_comment|/* write led data to auxport &amp; invert if necessary */
multiline_comment|/***************************************************/
DECL|function|write_led
r_static
r_void
id|write_led
c_func
(paren
id|hfcusb_data
op_star
id|hfc
comma
id|__u8
id|led_state
)paren
(brace
r_if
c_cond
(paren
id|led_state
op_ne
id|hfc-&gt;led_state
)paren
(brace
id|hfc-&gt;led_state
op_assign
id|led_state
suffix:semicolon
id|queue_control_request
c_func
(paren
id|hfc
comma
id|HFCUSB_P_DATA
comma
(paren
id|vdata
(braket
id|hfc-&gt;vend_idx
)braket
dot
id|led_invert
)paren
ques
c_cond
op_complement
id|led_state
suffix:colon
id|led_state
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************/
multiline_comment|/* invert B-channel LEDs if data is sent  */
multiline_comment|/******************************************/
DECL|function|led_timer
r_static
r_void
id|led_timer
c_func
(paren
id|hfcusb_data
op_star
id|hfc
)paren
(brace
r_static
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|__u8
id|led_state
op_assign
id|hfc-&gt;led_state
suffix:semicolon
r_if
c_cond
(paren
id|cnt
)paren
(brace
r_if
c_cond
(paren
id|hfc-&gt;led_b_active
op_amp
l_int|1
)paren
(brace
id|led_state
op_or_assign
id|vdata
(braket
id|hfc-&gt;vend_idx
)braket
dot
id|led_bits
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hfc-&gt;led_b_active
op_amp
l_int|2
)paren
(brace
id|led_state
op_or_assign
id|vdata
(braket
id|hfc-&gt;vend_idx
)braket
dot
id|led_bits
(braket
l_int|3
)braket
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hfc-&gt;led_b_active
op_amp
l_int|1
)paren
op_logical_or
id|hfc-&gt;led_new_data
op_amp
l_int|1
)paren
(brace
id|led_state
op_and_assign
op_complement
id|vdata
(braket
id|hfc-&gt;vend_idx
)braket
dot
id|led_bits
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hfc-&gt;led_b_active
op_amp
l_int|2
)paren
op_logical_or
id|hfc-&gt;led_new_data
op_amp
l_int|2
)paren
(brace
id|led_state
op_and_assign
op_complement
id|vdata
(braket
id|hfc-&gt;vend_idx
)braket
dot
id|led_bits
(braket
l_int|3
)braket
suffix:semicolon
)brace
)brace
id|write_led
c_func
(paren
id|hfc
comma
id|led_state
)paren
suffix:semicolon
id|hfc-&gt;led_new_data
op_assign
l_int|0
suffix:semicolon
id|cnt
op_assign
op_logical_neg
id|cnt
suffix:semicolon
singleline_comment|// restart 4 hz timer
id|hfc-&gt;led_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|LED_TIME
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|hfc-&gt;led_timer
)paren
)paren
(brace
id|add_timer
c_func
(paren
op_amp
id|hfc-&gt;led_timer
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**************************/
multiline_comment|/* handle LED requests    */
multiline_comment|/**************************/
DECL|function|handle_led
r_static
r_void
id|handle_led
c_func
(paren
id|hfcusb_data
op_star
id|hfc
comma
r_int
id|event
)paren
(brace
id|__u8
id|led_state
op_assign
id|hfc-&gt;led_state
suffix:semicolon
singleline_comment|// if no scheme -&gt; no LED action
r_if
c_cond
(paren
id|vdata
(braket
id|hfc-&gt;vend_idx
)braket
dot
id|led_scheme
op_eq
id|LED_OFF
)paren
(brace
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|LED_POWER_ON
suffix:colon
id|led_state
op_or_assign
id|vdata
(braket
id|hfc-&gt;vend_idx
)braket
dot
id|led_bits
(braket
l_int|0
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LED_POWER_OFF
suffix:colon
singleline_comment|// no Power off handling
r_break
suffix:semicolon
r_case
id|LED_S0_ON
suffix:colon
id|led_state
op_or_assign
id|vdata
(braket
id|hfc-&gt;vend_idx
)braket
dot
id|led_bits
(braket
l_int|1
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LED_S0_OFF
suffix:colon
id|led_state
op_and_assign
op_complement
id|vdata
(braket
id|hfc-&gt;vend_idx
)braket
dot
id|led_bits
(braket
l_int|1
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LED_B1_ON
suffix:colon
id|hfc-&gt;led_b_active
op_or_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LED_B1_OFF
suffix:colon
id|hfc-&gt;led_b_active
op_and_assign
op_complement
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LED_B1_DATA
suffix:colon
id|hfc-&gt;led_new_data
op_or_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LED_B2_ON
suffix:colon
id|hfc-&gt;led_b_active
op_or_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LED_B2_OFF
suffix:colon
id|hfc-&gt;led_b_active
op_and_assign
op_complement
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LED_B2_DATA
suffix:colon
id|hfc-&gt;led_new_data
op_or_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
)brace
id|write_led
c_func
(paren
id|hfc
comma
id|led_state
)paren
suffix:semicolon
)brace
multiline_comment|/********************************/
multiline_comment|/* called when timer t3 expires */
multiline_comment|/********************************/
DECL|function|l1_timer_expire_t3
r_static
r_void
id|l1_timer_expire_t3
c_func
(paren
id|hfcusb_data
op_star
id|hfc
)paren
(brace
singleline_comment|//printk (KERN_INFO &quot;HFC-USB: l1_timer_expire_t3&bslash;n&quot;);
id|hfc-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|hfc-&gt;d_if.ifc
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PH_DEACTIVATE | INDICATION sent&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|hfc-&gt;l1_activated
op_assign
id|FALSE
suffix:semicolon
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_S0_OFF
)paren
suffix:semicolon
)brace
multiline_comment|/********************************/
multiline_comment|/* called when timer t4 expires */
multiline_comment|/********************************/
DECL|function|l1_timer_expire_t4
r_static
r_void
id|l1_timer_expire_t4
c_func
(paren
id|hfcusb_data
op_star
id|hfc
)paren
(brace
singleline_comment|//printk (KERN_INFO &quot;HFC-USB: l1_timer_expire_t4&bslash;n&quot;);
id|hfc-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|hfc-&gt;d_if.ifc
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PH_DEACTIVATE | INDICATION sent&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|hfc-&gt;l1_activated
op_assign
id|FALSE
suffix:semicolon
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_S0_OFF
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************/
multiline_comment|/* handle S0 state changes   */
multiline_comment|/*****************************/
DECL|function|state_handler
r_static
r_void
id|state_handler
c_func
(paren
id|hfcusb_data
op_star
id|hfc
comma
id|__u8
id|state
)paren
(brace
id|__u8
id|old_state
suffix:semicolon
id|old_state
op_assign
id|hfc-&gt;l1_state
suffix:semicolon
singleline_comment|// range check
r_if
c_cond
(paren
id|state
op_eq
id|old_state
op_logical_or
id|state
l_int|8
)paren
(brace
r_return
suffix:semicolon
)brace
macro_line|#ifdef VERBOSE_ISDN_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: new S0 state:%d old_state:%d&bslash;n&quot;
comma
id|state
comma
id|old_state
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|state
OL
l_int|4
op_logical_or
id|state
op_eq
l_int|7
op_logical_or
id|state
op_eq
l_int|8
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|hfc-&gt;t3_timer
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|hfc-&gt;t3_timer
)paren
suffix:semicolon
)brace
singleline_comment|//printk(KERN_INFO &quot;HFC-USB: T3 deactivated&bslash;n&quot;);
)brace
r_if
c_cond
(paren
id|state
op_ge
l_int|7
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|hfc-&gt;t4_timer
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|hfc-&gt;t4_timer
)paren
suffix:semicolon
)brace
singleline_comment|//printk(KERN_INFO &quot;HFC-USB: T4 deactivated&bslash;n&quot;);
)brace
r_if
c_cond
(paren
id|state
op_eq
l_int|7
op_logical_and
op_logical_neg
id|hfc-&gt;l1_activated
)paren
(brace
id|hfc-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|hfc-&gt;d_if.ifc
comma
id|PH_ACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
singleline_comment|//printk(KERN_INFO &quot;HFC-USB: PH_ACTIVATE | INDICATION sent&bslash;n&quot;);
id|hfc-&gt;l1_activated
op_assign
id|TRUE
suffix:semicolon
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_S0_ON
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|state
op_le
l_int|3
multiline_comment|/* &amp;&amp; activated*/
)paren
(brace
r_if
c_cond
(paren
id|old_state
op_eq
l_int|7
op_logical_or
id|old_state
op_eq
l_int|8
)paren
(brace
singleline_comment|//printk(KERN_INFO &quot;HFC-USB: T4 activated&bslash;n&quot;);
id|hfc-&gt;t4_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HFC_TIMER_T4
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|hfc-&gt;t4_timer
)paren
)paren
(brace
id|add_timer
c_func
(paren
op_amp
id|hfc-&gt;t4_timer
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|hfc-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|hfc-&gt;d_if.ifc
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
singleline_comment|//printk(KERN_INFO &quot;HFC-USB: PH_DEACTIVATE | INDICATION sent&bslash;n&quot;);
id|hfc-&gt;l1_activated
op_assign
id|FALSE
suffix:semicolon
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_S0_OFF
)paren
suffix:semicolon
)brace
)brace
id|hfc-&gt;l1_state
op_assign
id|state
suffix:semicolon
)brace
multiline_comment|/* prepare iso urb */
DECL|function|fill_isoc_urb
r_static
r_void
id|fill_isoc_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|pipe
comma
r_void
op_star
id|buf
comma
r_int
id|num_packets
comma
r_int
id|packet_size
comma
r_int
id|interval
comma
id|usb_complete_t
id|complete
comma
r_void
op_star
id|context
)paren
(brace
r_int
id|k
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|urb-&gt;lock
)paren
suffix:semicolon
singleline_comment|// do we really need spin_lock_init ?
id|urb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|urb-&gt;pipe
op_assign
id|pipe
suffix:semicolon
id|urb-&gt;complete
op_assign
id|complete
suffix:semicolon
id|urb-&gt;number_of_packets
op_assign
id|num_packets
suffix:semicolon
id|urb-&gt;transfer_buffer_length
op_assign
id|packet_size
op_star
id|num_packets
suffix:semicolon
id|urb-&gt;context
op_assign
id|context
suffix:semicolon
id|urb-&gt;transfer_buffer
op_assign
id|buf
suffix:semicolon
id|urb-&gt;transfer_flags
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;transfer_flags
op_assign
id|URB_ISO_ASAP
suffix:semicolon
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;interval
op_assign
id|interval
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|num_packets
suffix:semicolon
id|k
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|k
)braket
dot
id|offset
op_assign
id|packet_size
op_star
id|k
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|k
)braket
dot
id|length
op_assign
id|packet_size
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|k
)braket
dot
id|actual_length
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* allocs urbs and start isoc transfer with two pending urbs to avoid gaps in the transfer chain */
DECL|function|start_isoc_chain
r_static
r_int
id|start_isoc_chain
c_func
(paren
id|usb_fifo
op_star
id|fifo
comma
r_int
id|num_packets_per_urb
comma
id|usb_complete_t
id|complete
comma
r_int
id|packet_size
)paren
(brace
r_int
id|i
comma
id|k
comma
id|errcode
suffix:semicolon
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: starting ISO-chain for Fifo %i&bslash;n&quot;
comma
id|fifo-&gt;fifonum
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|// allocate Memory for Iso out Urbs
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|purb
)paren
)paren
(brace
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|purb
op_assign
id|usb_alloc_urb
c_func
(paren
id|num_packets_per_urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|owner_fifo
op_assign
(paren
r_struct
id|usb_fifo
op_star
)paren
id|fifo
suffix:semicolon
singleline_comment|// Init the first iso
r_if
c_cond
(paren
id|ISO_BUFFER_SIZE
op_ge
(paren
id|fifo-&gt;usb_packet_maxlen
op_star
id|num_packets_per_urb
)paren
)paren
(brace
id|fill_isoc_urb
c_func
(paren
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|purb
comma
id|fifo-&gt;hfc-&gt;dev
comma
id|fifo-&gt;pipe
comma
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|buffer
comma
id|num_packets_per_urb
comma
id|fifo-&gt;usb_packet_maxlen
comma
id|fifo-&gt;intervall
comma
id|complete
comma
op_amp
id|fifo-&gt;iso
(braket
id|i
)braket
)paren
suffix:semicolon
id|memset
c_func
(paren
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|buffer
comma
l_int|0
comma
r_sizeof
(paren
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|buffer
)paren
)paren
suffix:semicolon
singleline_comment|// defining packet delimeters in fifo-&gt;buffer
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|num_packets_per_urb
suffix:semicolon
id|k
op_increment
)paren
(brace
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|purb-&gt;iso_frame_desc
(braket
id|k
)braket
dot
id|offset
op_assign
id|k
op_star
id|packet_size
suffix:semicolon
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|purb-&gt;iso_frame_desc
(braket
id|k
)braket
dot
id|length
op_assign
id|packet_size
suffix:semicolon
)brace
)brace
)brace
id|fifo-&gt;bit_line
op_assign
id|BITLINE_INF
suffix:semicolon
id|errcode
op_assign
id|usb_submit_urb
c_func
(paren
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|purb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|fifo-&gt;active
op_assign
(paren
id|errcode
op_ge
l_int|0
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|errcode
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: error submitting ISO URB: %i.%i &bslash;n&quot;
comma
id|errcode
comma
id|i
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
singleline_comment|// errcode = (usb_submit_urb(fifo-&gt;iso[0].purb, GFP_KERNEL));
r_return
id|fifo-&gt;active
suffix:semicolon
)brace
multiline_comment|/* stops running iso chain and frees their pending urbs */
DECL|function|stop_isoc_chain
r_static
r_void
id|stop_isoc_chain
c_func
(paren
id|usb_fifo
op_star
id|fifo
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|purb
)paren
(brace
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: Stopping iso chain for fifo %i.%i&bslash;n&quot;
comma
id|fifo-&gt;fifonum
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
id|usb_unlink_urb
c_func
(paren
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|purb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|purb
)paren
suffix:semicolon
id|fifo-&gt;iso
(braket
id|i
)braket
dot
id|purb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|fifo-&gt;urb
)paren
(brace
id|usb_unlink_urb
c_func
(paren
id|fifo-&gt;urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|fifo-&gt;urb
)paren
suffix:semicolon
id|fifo-&gt;urb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|fifo-&gt;active
op_assign
l_int|0
suffix:semicolon
)brace
singleline_comment|// defines how much ISO packets are handled in one URB
DECL|variable|iso_packets
r_static
r_int
id|iso_packets
(braket
l_int|8
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/*****************************************************/
multiline_comment|/* transmit completion routine for all ISO tx fifos */
multiline_comment|/*****************************************************/
DECL|function|tx_iso_complete
r_static
r_void
id|tx_iso_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|iso_urb_struct
op_star
id|context_iso_urb
op_assign
(paren
id|iso_urb_struct
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|usb_fifo
op_star
id|fifo
op_assign
id|context_iso_urb-&gt;owner_fifo
suffix:semicolon
id|hfcusb_data
op_star
id|hfc
op_assign
id|fifo-&gt;hfc
suffix:semicolon
r_int
id|k
comma
id|tx_offset
comma
id|num_isoc_packets
comma
id|sink
comma
id|len
comma
id|current_len
comma
id|errcode
comma
id|frame_complete
comma
id|transp_mode
comma
id|fifon
suffix:semicolon
id|__u8
id|threshbit
suffix:semicolon
id|__u8
id|threshtable
(braket
l_int|8
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|4
comma
l_int|8
comma
l_int|0x10
comma
l_int|0x20
comma
l_int|0x40
comma
l_int|0x80
)brace
suffix:semicolon
id|fifon
op_assign
id|fifo-&gt;fifonum
suffix:semicolon
id|tx_offset
op_assign
l_int|0
suffix:semicolon
singleline_comment|// very weird error code when using ohci drivers, for now : ignore this error ...  (MB)
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
op_minus
id|EOVERFLOW
)paren
(brace
id|urb-&gt;status
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: ignoring USB DATAOVERRUN  for fifo  %i &bslash;n&quot;
comma
id|fifon
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|fifo-&gt;active
op_logical_and
op_logical_neg
id|urb-&gt;status
)paren
(brace
id|transp_mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fifon
OL
l_int|4
op_logical_and
id|hfc-&gt;b_mode
(braket
id|fifon
op_div
l_int|2
)braket
op_eq
id|L1_MODE_TRANS
)paren
(brace
id|transp_mode
op_assign
id|TRUE
suffix:semicolon
)brace
id|threshbit
op_assign
id|threshtable
(braket
id|fifon
)braket
op_amp
id|hfc-&gt;threshold_mask
suffix:semicolon
singleline_comment|// is threshold set for our channel?
id|num_isoc_packets
op_assign
id|iso_packets
(braket
id|fifon
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fifon
op_ge
id|HFCUSB_D_TX
)paren
(brace
id|sink
op_assign
(paren
id|threshbit
)paren
ques
c_cond
id|SINK_DMIN
suffix:colon
id|SINK_DMAX
suffix:semicolon
singleline_comment|// how much bit go to the sink for D-channel?
)brace
r_else
(brace
id|sink
op_assign
(paren
id|threshbit
)paren
ques
c_cond
id|SINK_MIN
suffix:colon
id|SINK_MAX
suffix:semicolon
singleline_comment|// how much bit go to the sink for B-channel?
)brace
singleline_comment|// prepare ISO Urb
id|fill_isoc_urb
c_func
(paren
id|urb
comma
id|fifo-&gt;hfc-&gt;dev
comma
id|fifo-&gt;pipe
comma
id|context_iso_urb-&gt;buffer
comma
id|num_isoc_packets
comma
id|fifo-&gt;usb_packet_maxlen
comma
id|fifo-&gt;intervall
comma
id|tx_iso_complete
comma
id|urb-&gt;context
)paren
suffix:semicolon
id|memset
c_func
(paren
id|context_iso_urb-&gt;buffer
comma
l_int|0
comma
r_sizeof
(paren
id|context_iso_urb-&gt;buffer
)paren
)paren
suffix:semicolon
id|frame_complete
op_assign
id|FALSE
suffix:semicolon
singleline_comment|// Generate Iso Packets
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|num_isoc_packets
suffix:semicolon
op_increment
id|k
)paren
(brace
r_if
c_cond
(paren
id|fifo-&gt;skbuff
)paren
(brace
id|len
op_assign
id|fifo-&gt;skbuff-&gt;len
suffix:semicolon
singleline_comment|// remaining length
id|fifo-&gt;bit_line
op_sub_assign
id|sink
suffix:semicolon
singleline_comment|// we lower data margin every msec
id|current_len
op_assign
(paren
l_int|0
op_minus
id|fifo-&gt;bit_line
)paren
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|current_len
OG
l_int|14
)paren
(brace
id|current_len
op_assign
l_int|14
suffix:semicolon
)brace
singleline_comment|// maximum 15 byte for every ISO packet makes our life easier
id|current_len
op_assign
(paren
id|len
op_le
id|current_len
)paren
ques
c_cond
id|len
suffix:colon
id|current_len
suffix:semicolon
id|fifo-&gt;bit_line
op_add_assign
id|current_len
op_star
l_int|8
suffix:semicolon
singleline_comment|// how much bit do we put on the line?
id|context_iso_urb-&gt;buffer
(braket
id|tx_offset
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|current_len
op_eq
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|transp_mode
)paren
(brace
id|context_iso_urb-&gt;buffer
(braket
id|tx_offset
)braket
op_assign
l_int|1
suffix:semicolon
singleline_comment|// here frame completion
id|fifo-&gt;bit_line
op_add_assign
l_int|32
suffix:semicolon
singleline_comment|// add 2 byte flags and 16bit CRC at end of ISDN frame
)brace
id|frame_complete
op_assign
id|TRUE
suffix:semicolon
)brace
singleline_comment|// copy bytes from buffer into ISO_URB
id|memcpy
c_func
(paren
id|context_iso_urb-&gt;buffer
op_plus
id|tx_offset
op_plus
l_int|1
comma
id|fifo-&gt;skbuff-&gt;data
comma
id|current_len
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|fifo-&gt;skbuff
comma
id|current_len
)paren
suffix:semicolon
singleline_comment|// define packet delimeters within the URB buffer
id|urb-&gt;iso_frame_desc
(braket
id|k
)braket
dot
id|offset
op_assign
id|tx_offset
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|k
)braket
dot
id|length
op_assign
id|current_len
op_plus
l_int|1
suffix:semicolon
id|tx_offset
op_add_assign
(paren
id|current_len
op_plus
l_int|1
)paren
suffix:semicolon
singleline_comment|// printk(KERN_INFO &quot;HFC-USB: fifonum:%d,%d bytes to send, %d bytes ISO packet,bitline:%d,sink:%d,threshbit:%d,threshmask:%x&bslash;n&quot;,fifon,len,current_len,fifo-&gt;bit_line,sink,threshbit,hfc-&gt;threshold_mask);
r_if
c_cond
(paren
op_logical_neg
id|transp_mode
)paren
(brace
r_if
c_cond
(paren
id|fifon
op_eq
id|HFCUSB_B1_TX
)paren
(brace
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_B1_DATA
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fifon
op_eq
id|HFCUSB_B2_TX
)paren
(brace
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_B2_DATA
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
singleline_comment|// we have no more data - generate 1 byte ISO packets
id|urb-&gt;iso_frame_desc
(braket
id|k
)braket
dot
id|offset
op_assign
id|tx_offset
op_increment
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|k
)braket
dot
id|length
op_assign
l_int|1
suffix:semicolon
id|fifo-&gt;bit_line
op_sub_assign
id|sink
suffix:semicolon
singleline_comment|// we lower data margin every msec
r_if
c_cond
(paren
id|fifo-&gt;bit_line
OL
id|BITLINE_INF
)paren
(brace
id|fifo-&gt;bit_line
op_assign
id|BITLINE_INF
suffix:semicolon
singleline_comment|//printk (KERN_INFO &quot;HFC-USB: BITLINE_INF underrun&bslash;n&quot;);
)brace
)brace
r_if
c_cond
(paren
id|frame_complete
)paren
(brace
singleline_comment|// delete the buffer only once, here or in hfc_usb_l2l1() in a PH_DATA|REQUEST
id|fifo-&gt;delete_flg
op_assign
id|TRUE
suffix:semicolon
id|fifo-&gt;hif
op_member_access_from_pointer
id|l1l2
c_func
(paren
id|fifo-&gt;hif
comma
id|PH_DATA
op_or
id|CONFIRM
comma
(paren
r_void
op_star
)paren
id|fifo-&gt;skbuff-&gt;truesize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fifo-&gt;skbuff
op_logical_and
id|fifo-&gt;delete_flg
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|fifo-&gt;skbuff
)paren
suffix:semicolon
singleline_comment|//printk(KERN_INFO &quot;HFC-USB: skbuff=NULL on fifo:%d&bslash;n&quot;,fifo-&gt;fifonum);
id|fifo-&gt;skbuff
op_assign
l_int|NULL
suffix:semicolon
id|fifo-&gt;delete_flg
op_assign
id|FALSE
suffix:semicolon
)brace
id|frame_complete
op_assign
id|FALSE
suffix:semicolon
)brace
)brace
id|errcode
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: error submitting ISO URB: %i &bslash;n&quot;
comma
id|errcode
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: tx_iso_complete : urb-&gt;status %i, fifonum %i&bslash;n&quot;
comma
id|urb-&gt;status
comma
id|fifon
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* tx_iso_complete */
multiline_comment|/*****************************************************/
multiline_comment|/* receive completion routine for all ISO tx fifos   */
multiline_comment|/*****************************************************/
DECL|function|rx_iso_complete
r_static
r_void
id|rx_iso_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|iso_urb_struct
op_star
id|context_iso_urb
op_assign
(paren
id|iso_urb_struct
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|usb_fifo
op_star
id|fifo
op_assign
id|context_iso_urb-&gt;owner_fifo
suffix:semicolon
id|hfcusb_data
op_star
id|hfc
op_assign
id|fifo-&gt;hfc
suffix:semicolon
r_int
id|k
comma
id|len
comma
id|errcode
comma
id|offset
comma
id|num_isoc_packets
comma
id|fifon
suffix:semicolon
id|__u8
op_star
id|buf
suffix:semicolon
id|fifon
op_assign
id|fifo-&gt;fifonum
suffix:semicolon
singleline_comment|// very weird error code when using ohci drivers, for now : ignore this error ...  (MB)
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
op_minus
id|EOVERFLOW
)paren
(brace
id|urb-&gt;status
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: ignoring USB DATAOVERRUN  for fifo  %i &bslash;n&quot;
comma
id|fifon
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|fifo-&gt;active
op_logical_and
op_logical_neg
id|urb-&gt;status
)paren
(brace
id|num_isoc_packets
op_assign
id|iso_packets
(braket
id|fifon
)braket
suffix:semicolon
singleline_comment|// Generate D-Channel Iso Packets
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|num_isoc_packets
suffix:semicolon
op_increment
id|k
)paren
(brace
id|len
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|k
)braket
dot
id|actual_length
suffix:semicolon
id|offset
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|k
)braket
dot
id|offset
suffix:semicolon
id|buf
op_assign
id|context_iso_urb-&gt;buffer
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|fifo-&gt;last_urblen
op_ne
id|fifo-&gt;usb_packet_maxlen
)paren
(brace
singleline_comment|// the threshold mask is in the 2nd status byte
id|hfc-&gt;threshold_mask
op_assign
id|buf
(braket
l_int|1
)braket
suffix:semicolon
singleline_comment|// the S0 state is in the upper half of the 1st status byte
id|state_handler
c_func
(paren
id|hfc
comma
id|buf
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
suffix:semicolon
singleline_comment|// if we have more than the 2 status bytes -&gt; collect data
r_if
c_cond
(paren
id|len
OG
l_int|2
)paren
(brace
id|collect_rx_frame
c_func
(paren
id|fifo
comma
id|buf
op_plus
l_int|2
comma
id|len
op_minus
l_int|2
comma
id|buf
(braket
l_int|0
)braket
op_amp
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
id|collect_rx_frame
c_func
(paren
id|fifo
comma
id|buf
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
id|fifo-&gt;last_urblen
op_assign
id|len
suffix:semicolon
)brace
singleline_comment|// prepare ISO Urb
id|fill_isoc_urb
c_func
(paren
id|urb
comma
id|fifo-&gt;hfc-&gt;dev
comma
id|fifo-&gt;pipe
comma
id|context_iso_urb-&gt;buffer
comma
id|num_isoc_packets
comma
id|fifo-&gt;usb_packet_maxlen
comma
id|fifo-&gt;intervall
comma
id|rx_iso_complete
comma
id|urb-&gt;context
)paren
suffix:semicolon
id|errcode
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: error submitting ISO URB: %i &bslash;n&quot;
comma
id|errcode
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: rx_iso_complete : urb-&gt;status %i, fifonum %i&bslash;n&quot;
comma
id|urb-&gt;status
comma
id|fifon
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* rx_iso_complete */
multiline_comment|/*****************************************************/
multiline_comment|/* collect data from interrupt or isochron in        */
multiline_comment|/*****************************************************/
DECL|function|collect_rx_frame
r_static
r_void
id|collect_rx_frame
c_func
(paren
id|usb_fifo
op_star
id|fifo
comma
id|__u8
op_star
id|data
comma
r_int
id|len
comma
r_int
id|finish
)paren
(brace
id|hfcusb_data
op_star
id|hfc
op_assign
id|fifo-&gt;hfc
suffix:semicolon
r_int
id|transp_mode
comma
id|fifon
suffix:semicolon
id|fifon
op_assign
id|fifo-&gt;fifonum
suffix:semicolon
id|transp_mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fifon
OL
l_int|4
op_logical_and
id|hfc-&gt;b_mode
(braket
id|fifon
op_div
l_int|2
)braket
op_eq
id|L1_MODE_TRANS
)paren
(brace
id|transp_mode
op_assign
id|TRUE
suffix:semicolon
)brace
singleline_comment|//printk(KERN_INFO &quot;HFC-USB: got %d bytes finish:%d max_size:%d fifo:%d&bslash;n&quot;,len,finish,fifo-&gt;max_size,fifon);
r_if
c_cond
(paren
op_logical_neg
id|fifo-&gt;skbuff
)paren
(brace
singleline_comment|// allocate sk buffer
id|fifo-&gt;skbuff
op_assign
id|dev_alloc_skb
c_func
(paren
id|fifo-&gt;max_size
op_plus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fifo-&gt;skbuff
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: cannot allocate buffer (dev_alloc_skb) fifo:%d&bslash;n&quot;
comma
id|fifon
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|len
op_logical_and
id|fifo-&gt;skbuff-&gt;len
op_plus
id|len
OL
id|fifo-&gt;max_size
)paren
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|fifo-&gt;skbuff
comma
id|len
)paren
comma
id|data
comma
id|len
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HCF-USB: got frame exceeded fifo-&gt;max_size:%d&bslash;n&quot;
comma
id|fifo-&gt;max_size
)paren
suffix:semicolon
singleline_comment|// give transparent data up, when 128 byte are available
r_if
c_cond
(paren
id|transp_mode
op_logical_and
id|fifo-&gt;skbuff-&gt;len
op_ge
l_int|128
)paren
(brace
id|fifo-&gt;hif
op_member_access_from_pointer
id|l1l2
c_func
(paren
id|fifo-&gt;hif
comma
id|PH_DATA
op_or
id|INDICATION
comma
id|fifo-&gt;skbuff
)paren
suffix:semicolon
id|fifo-&gt;skbuff
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// buffer was freed from upper layer
r_return
suffix:semicolon
)brace
singleline_comment|// we have a complete hdlc packet
r_if
c_cond
(paren
id|finish
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fifo-&gt;skbuff-&gt;data
(braket
id|fifo-&gt;skbuff-&gt;len
op_minus
l_int|1
)braket
)paren
(brace
id|skb_trim
c_func
(paren
id|fifo-&gt;skbuff
comma
id|fifo-&gt;skbuff-&gt;len
op_minus
l_int|3
)paren
suffix:semicolon
singleline_comment|// remove CRC &amp; status
singleline_comment|//printk(KERN_INFO &quot;HFC-USB: got frame %d bytes on fifo:%d&bslash;n&quot;,fifo-&gt;skbuff-&gt;len,fifon);
r_if
c_cond
(paren
id|fifon
op_eq
id|HFCUSB_PCM_RX
)paren
(brace
id|fifo-&gt;hif
op_member_access_from_pointer
id|l1l2
c_func
(paren
id|fifo-&gt;hif
comma
id|PH_DATA_E
op_or
id|INDICATION
comma
id|fifo-&gt;skbuff
)paren
suffix:semicolon
)brace
r_else
id|fifo-&gt;hif
op_member_access_from_pointer
id|l1l2
c_func
(paren
id|fifo-&gt;hif
comma
id|PH_DATA
op_or
id|INDICATION
comma
id|fifo-&gt;skbuff
)paren
suffix:semicolon
id|fifo-&gt;skbuff
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// buffer was freed from upper layer
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: got frame %d bytes but CRC ERROR!!!&bslash;n&quot;
comma
id|fifo-&gt;skbuff-&gt;len
)paren
suffix:semicolon
id|skb_trim
c_func
(paren
id|fifo-&gt;skbuff
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// clear whole buffer
)brace
)brace
singleline_comment|// LED flashing only in HDLC mode
r_if
c_cond
(paren
op_logical_neg
id|transp_mode
)paren
(brace
r_if
c_cond
(paren
id|fifon
op_eq
id|HFCUSB_B1_RX
)paren
(brace
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_B1_DATA
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fifon
op_eq
id|HFCUSB_B2_RX
)paren
(brace
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_B2_DATA
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/***********************************************/
multiline_comment|/* receive completion routine for all rx fifos */
multiline_comment|/***********************************************/
DECL|function|rx_complete
r_static
r_void
id|rx_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|len
suffix:semicolon
id|__u8
op_star
id|buf
suffix:semicolon
id|usb_fifo
op_star
id|fifo
op_assign
(paren
id|usb_fifo
op_star
)paren
id|urb-&gt;context
suffix:semicolon
multiline_comment|/* pointer to our fifo */
id|hfcusb_data
op_star
id|hfc
op_assign
id|fifo-&gt;hfc
suffix:semicolon
id|urb-&gt;dev
op_assign
id|hfc-&gt;dev
suffix:semicolon
multiline_comment|/* security init */
r_if
c_cond
(paren
(paren
op_logical_neg
id|fifo-&gt;active
)paren
op_logical_or
(paren
id|urb-&gt;status
)paren
)paren
(brace
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: RX-Fifo %i is going down (%i)&bslash;n&quot;
comma
id|fifo-&gt;fifonum
comma
id|urb-&gt;status
)paren
suffix:semicolon
macro_line|#endif
id|fifo-&gt;urb-&gt;interval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* cancel automatic rescheduling */
r_if
c_cond
(paren
id|fifo-&gt;skbuff
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|fifo-&gt;skbuff
)paren
suffix:semicolon
id|fifo-&gt;skbuff
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|len
op_assign
id|urb-&gt;actual_length
suffix:semicolon
id|buf
op_assign
id|fifo-&gt;buffer
suffix:semicolon
r_if
c_cond
(paren
id|fifo-&gt;last_urblen
op_ne
id|fifo-&gt;usb_packet_maxlen
)paren
(brace
singleline_comment|// the threshold mask is in the 2nd status byte
id|hfc-&gt;threshold_mask
op_assign
id|buf
(braket
l_int|1
)braket
suffix:semicolon
singleline_comment|// the S0 state is in the upper half of the 1st status byte
id|state_handler
c_func
(paren
id|hfc
comma
id|buf
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
suffix:semicolon
singleline_comment|// if we have more than the 2 status bytes -&gt; collect data
r_if
c_cond
(paren
id|len
OG
l_int|2
)paren
(brace
id|collect_rx_frame
c_func
(paren
id|fifo
comma
id|buf
op_plus
l_int|2
comma
id|urb-&gt;actual_length
op_minus
l_int|2
comma
id|buf
(braket
l_int|0
)braket
op_amp
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
id|collect_rx_frame
c_func
(paren
id|fifo
comma
id|buf
comma
id|urb-&gt;actual_length
comma
l_int|0
)paren
suffix:semicolon
id|fifo-&gt;last_urblen
op_assign
id|urb-&gt;actual_length
suffix:semicolon
)brace
multiline_comment|/* rx_complete */
multiline_comment|/***************************************************/
multiline_comment|/* start the interrupt transfer for the given fifo */
multiline_comment|/***************************************************/
DECL|function|start_int_fifo
r_static
r_void
id|start_int_fifo
c_func
(paren
id|usb_fifo
op_star
id|fifo
)paren
(brace
r_int
id|errcode
suffix:semicolon
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: starting intr IN fifo:%d&bslash;n&quot;
comma
id|fifo-&gt;fifonum
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|fifo-&gt;urb
)paren
(brace
id|fifo-&gt;urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fifo-&gt;urb
)paren
r_return
suffix:semicolon
)brace
id|usb_fill_int_urb
c_func
(paren
id|fifo-&gt;urb
comma
id|fifo-&gt;hfc-&gt;dev
comma
id|fifo-&gt;pipe
comma
id|fifo-&gt;buffer
comma
id|fifo-&gt;usb_packet_maxlen
comma
id|rx_complete
comma
id|fifo
comma
id|fifo-&gt;intervall
)paren
suffix:semicolon
id|fifo-&gt;active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* must be marked active */
id|errcode
op_assign
id|usb_submit_urb
c_func
(paren
id|fifo-&gt;urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcode
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: submit URB error(start_int_info): status:%i&bslash;n&quot;
comma
id|errcode
)paren
suffix:semicolon
id|fifo-&gt;active
op_assign
l_int|0
suffix:semicolon
id|fifo-&gt;skbuff
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* start_int_fifo */
multiline_comment|/*****************************/
multiline_comment|/* set the B-channel mode    */
multiline_comment|/*****************************/
DECL|function|set_hfcmode
r_static
r_void
id|set_hfcmode
c_func
(paren
id|hfcusb_data
op_star
id|hfc
comma
r_int
id|channel
comma
r_int
id|mode
)paren
(brace
id|__u8
id|val
comma
id|idx_table
(braket
l_int|2
)braket
op_assign
initialization_block
suffix:semicolon
macro_line|#ifdef VERBOSE_ISDN_DEBUG
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: setting channel %d to mode %d&bslash;n&quot;
comma
id|channel
comma
id|mode
)paren
suffix:semicolon
macro_line|#endif
id|hfc-&gt;b_mode
(braket
id|channel
)braket
op_assign
id|mode
suffix:semicolon
singleline_comment|// setup CON_HDLC
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
id|L1_MODE_NULL
)paren
(brace
id|val
op_assign
l_int|8
suffix:semicolon
)brace
singleline_comment|// enable fifo?
r_if
c_cond
(paren
id|mode
op_eq
id|L1_MODE_TRANS
)paren
(brace
id|val
op_or_assign
l_int|2
suffix:semicolon
)brace
singleline_comment|// set transparent bit
id|queue_control_request
c_func
(paren
id|hfc
comma
id|HFCUSB_FIFO
comma
id|idx_table
(braket
id|channel
)braket
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// set FIFO to transmit register
id|queue_control_request
c_func
(paren
id|hfc
comma
id|HFCUSB_CON_HDLC
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
id|queue_control_request
c_func
(paren
id|hfc
comma
id|HFCUSB_INC_RES_F
comma
l_int|2
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// reset fifo
id|queue_control_request
c_func
(paren
id|hfc
comma
id|HFCUSB_FIFO
comma
id|idx_table
(braket
id|channel
)braket
op_plus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// set FIFO to receive register
id|queue_control_request
c_func
(paren
id|hfc
comma
id|HFCUSB_CON_HDLC
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
id|queue_control_request
c_func
(paren
id|hfc
comma
id|HFCUSB_INC_RES_F
comma
l_int|2
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// reset fifo
id|val
op_assign
l_int|0x40
suffix:semicolon
r_if
c_cond
(paren
id|hfc-&gt;b_mode
(braket
l_int|0
)braket
)paren
(brace
id|val
op_or_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hfc-&gt;b_mode
(braket
l_int|1
)braket
)paren
(brace
id|val
op_or_assign
l_int|2
suffix:semicolon
)brace
id|queue_control_request
c_func
(paren
id|hfc
comma
id|HFCUSB_SCTRL
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hfc-&gt;b_mode
(braket
l_int|0
)braket
)paren
(brace
id|val
op_or_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hfc-&gt;b_mode
(braket
l_int|1
)braket
)paren
(brace
id|val
op_or_assign
l_int|2
suffix:semicolon
)brace
id|queue_control_request
c_func
(paren
id|hfc
comma
id|HFCUSB_SCTRL_R
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|L1_MODE_NULL
)paren
(brace
r_if
c_cond
(paren
id|channel
)paren
(brace
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_B2_OFF
)paren
suffix:semicolon
)brace
r_else
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_B1_OFF
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|channel
)paren
(brace
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_B2_ON
)paren
suffix:semicolon
)brace
r_else
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_B1_ON
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;   --------------------------------------------------------------------------------------&n;   from here : hisax_if callback routines :&n;     - void hfc_usb_d_l2l1(struct hisax_if *hisax_d_if, int pr, void *arg) {&n;&n;   l1 to l2 routines :&n;     - static void hfc_usb_l1l2(hfcusb_data * hfc)&n;&n;*/
DECL|function|hfc_usb_l2l1
r_void
id|hfc_usb_l2l1
c_func
(paren
r_struct
id|hisax_if
op_star
id|my_hisax_if
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
id|usb_fifo
op_star
id|fifo
op_assign
id|my_hisax_if-&gt;priv
suffix:semicolon
id|hfcusb_data
op_star
id|hfc
op_assign
id|fifo-&gt;hfc
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
id|PH_ACTIVATE
op_or
id|REQUEST
suffix:colon
r_if
c_cond
(paren
id|fifo-&gt;fifonum
op_eq
id|HFCUSB_D_TX
)paren
(brace
macro_line|#ifdef VERBOSE_ISDN_DEBUG
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC_USB: hfc_usb_d_l2l1 D-chan: PH_ACTIVATE | REQUEST&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|queue_control_request
c_func
(paren
id|hfc
comma
id|HFCUSB_STATES
comma
l_int|0x60
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* make activation */
id|hfc-&gt;t3_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HFC_TIMER_T3
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|hfc-&gt;t3_timer
)paren
)paren
(brace
id|add_timer
c_func
(paren
op_amp
id|hfc-&gt;t3_timer
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#ifdef VERBOSE_ISDN_DEBUG
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC_USB: hfc_usb_d_l2l1 Bx-chan: PH_ACTIVATE | REQUEST&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|set_hfcmode
c_func
(paren
id|hfc
comma
(paren
id|fifo-&gt;fifonum
op_eq
id|HFCUSB_B1_TX
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
id|fifo-&gt;hif
op_member_access_from_pointer
id|l1l2
c_func
(paren
id|fifo-&gt;hif
comma
id|PH_ACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PH_DEACTIVATE
op_or
id|REQUEST
suffix:colon
r_if
c_cond
(paren
id|fifo-&gt;fifonum
op_eq
id|HFCUSB_D_TX
)paren
(brace
macro_line|#ifdef VERBOSE_ISDN_DEBUG
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC_USB: hfc_usb_d_l2l1 D-chan: PH_DEACTIVATE | REQUEST&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: ISDN TE device should not deativate...&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef VERBOSE_ISDN_DEBUG
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC_USB: hfc_usb_d_l2l1 Bx-chan: PH_DEACTIVATE | REQUEST&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|set_hfcmode
c_func
(paren
id|hfc
comma
(paren
id|fifo-&gt;fifonum
op_eq
id|HFCUSB_B1_TX
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
comma
(paren
r_int
)paren
id|L1_MODE_NULL
)paren
suffix:semicolon
id|fifo-&gt;hif
op_member_access_from_pointer
id|l1l2
c_func
(paren
id|fifo-&gt;hif
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PH_DATA
op_or
id|REQUEST
suffix:colon
r_if
c_cond
(paren
id|fifo-&gt;skbuff
op_logical_and
id|fifo-&gt;delete_flg
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|fifo-&gt;skbuff
)paren
suffix:semicolon
singleline_comment|//printk(KERN_INFO &quot;skbuff=NULL on fifo:%d&bslash;n&quot;,fifo-&gt;fifonum);
id|fifo-&gt;skbuff
op_assign
l_int|NULL
suffix:semicolon
id|fifo-&gt;delete_flg
op_assign
id|FALSE
suffix:semicolon
)brace
id|fifo-&gt;skbuff
op_assign
id|arg
suffix:semicolon
singleline_comment|// we have a new buffer
singleline_comment|//if(fifo-&gt;fifonum==HFCUSB_D_TX) printk (KERN_INFO &quot;HFC_USB: hfc_usb_d_l2l1 D-chan: PH_DATA | REQUEST&bslash;n&quot;);
singleline_comment|//else printk (KERN_INFO &quot;HFC_USB: hfc_usb_d_l2l1 Bx-chan: PH_DATA | REQUEST&bslash;n&quot;);
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC_USB: hfc_usb_d_l2l1: unkown state : %#x&bslash;n&quot;
comma
id|pr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|// valid configurations
DECL|macro|CNF_4INT3ISO
mdefine_line|#define CNF_4INT3ISO  1      
singleline_comment|// 4 INT IN, 3 ISO OUT
DECL|macro|CNF_3INT3ISO
mdefine_line|#define CNF_3INT3ISO  2      
singleline_comment|// 3 INT IN, 3 ISO OUT
DECL|macro|CNF_4ISO3ISO
mdefine_line|#define CNF_4ISO3ISO  3      
singleline_comment|// 4 ISO IN, 3 ISO OUT
DECL|macro|CNF_3ISO3ISO
mdefine_line|#define CNF_3ISO3ISO  4 &t; 
singleline_comment|// 3 ISO IN, 3 ISO OUT
multiline_comment|/*&n;   --------------------------------------------------------------------------------------&n;   From here on USB initialization and deactivation related routines are implemented :&n;&n;   - hfc_usb_init :&n;      is the main Entry Point for the USB Subsystem when the device get plugged&n;      in. This function calls usb_register with usb_driver as parameter.&n;      Here, further entry points for probing (hfc_usb_probe) and disconnecting&n;      the device (hfc_usb_disconnect) are published, as the id_table&n;&n;   - hfc_usb_probe&n;      this function is called by the usb subsystem, and steps through the alternate&n;      settings of the currently plugged in device to detect all Endpoints needed to&n;      run an ISDN TA.&n;      Needed EndPoints are&n;      3 (+1) IntIn EndPoints   (D-in,  E-in, B1-in, B2-in, (E-in)) or&n;      3 (+1) Isochron In Endpoints (D-out, B1-out, B2-out) and 3 IsoOut Endpoints&n;      The currently used transfer mode of on the Out-Endpoints will be stored in&n;      hfc-&gt;usb_transfer_mode and is either USB_INT or USB_ISO&n;      When a valid alternate setting could be found, the usb_init (see blow)&n;      function is called&n;&n;   - usb_init&n;      Here, the HFC_USB Chip itself gets initialized and the USB framework to send/receive&n;      Data to/from the several EndPoints are initialized:&n;       The E- and D-Channel Int-In chain gets started&n;       The IsoChain for the Iso-Out traffic get started&n;&n;   - hfc_usb_disconnect&n;      this function is called by the usb subsystem and has to free all resources&n;      and stop all usb traffic to allow a proper hotplugging disconnect.&n;&n;*/
multiline_comment|/***************************************************************************/
multiline_comment|/* usb_init is called once when a new matching device is detected to setup */
multiline_comment|/* main parameters. It registers the driver at the main hisax module.       */
multiline_comment|/* on success 0 is returned.                                               */
multiline_comment|/***************************************************************************/
DECL|function|usb_init
r_static
r_int
id|usb_init
c_func
(paren
id|hfcusb_data
op_star
id|hfc
)paren
(brace
id|usb_fifo
op_star
id|fifo
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
id|u_char
id|b
suffix:semicolon
r_struct
id|hisax_b_if
op_star
id|p_b_if
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* check the chip id */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFCUSB_CHIP_ID begin&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_CHIP_ID
comma
op_amp
id|b
)paren
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: cannot read chip id&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFCUSB_CHIP_ID %x&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b
op_ne
id|HFCUSB_CHIPID
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: Invalid chip id 0x%02x&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* first set the needed config, interface and alternate */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;usb_init 1&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//&t;usb_set_configuration(hfc-&gt;dev, 1);
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;usb_init 2&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
id|usb_set_interface
c_func
(paren
id|hfc-&gt;dev
comma
id|hfc-&gt;if_used
comma
id|hfc-&gt;alt_used
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;usb_init usb_set_interface return %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
multiline_comment|/* now we initialize the chip */
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_CIRM
comma
l_int|8
)paren
suffix:semicolon
singleline_comment|// do reset
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_CIRM
comma
l_int|0x10
)paren
suffix:semicolon
singleline_comment|// aux = output, reset off
singleline_comment|// set USB_SIZE to match the the wMaxPacketSize for INT or BULK transfers
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_USB_SIZE
comma
(paren
id|hfc-&gt;packet_size
op_div
l_int|8
)paren
op_or
(paren
(paren
id|hfc-&gt;packet_size
op_div
l_int|8
)paren
op_lshift
l_int|4
)paren
)paren
suffix:semicolon
singleline_comment|// set USB_SIZE_I to match the the wMaxPacketSize for ISO transfers
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_USB_SIZE_I
comma
id|hfc-&gt;iso_packet_size
)paren
suffix:semicolon
multiline_comment|/* enable PCM/GCI master mode */
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_MST_MODE1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set default values */
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_MST_MODE0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* enable master mode */
multiline_comment|/* init the fifos */
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_F_THRES
comma
(paren
id|HFCUSB_TX_THRESHOLD
op_div
l_int|8
)paren
op_or
(paren
(paren
id|HFCUSB_RX_THRESHOLD
op_div
l_int|8
)paren
op_lshift
l_int|4
)paren
)paren
suffix:semicolon
id|fifo
op_assign
id|hfc-&gt;fifos
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HFCUSB_NUM_FIFOS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_FIFO
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* select the desired fifo */
id|fifo
(braket
id|i
)braket
dot
id|skbuff
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* init buffer pointer */
id|fifo
(braket
id|i
)braket
dot
id|max_size
op_assign
(paren
id|i
op_le
id|HFCUSB_B2_RX
)paren
ques
c_cond
id|MAX_BCH_SIZE
suffix:colon
id|MAX_DFRAME_LEN
suffix:semicolon
id|fifo
(braket
id|i
)braket
dot
id|last_urblen
op_assign
l_int|0
suffix:semicolon
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_HDLC_PAR
comma
(paren
(paren
id|i
op_le
id|HFCUSB_B2_RX
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
)paren
suffix:semicolon
singleline_comment|// set 2 bit for D- &amp; E-channel
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_CON_HDLC
comma
(paren
(paren
id|i
op_eq
id|HFCUSB_D_TX
)paren
ques
c_cond
l_int|0x09
suffix:colon
l_int|0x08
)paren
)paren
suffix:semicolon
singleline_comment|// rx hdlc, enable IFF for D-channel
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_INC_RES_F
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* reset the fifo */
)brace
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_CLKDEL
comma
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* clock delay value */
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_STATES
comma
l_int|3
op_or
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* set deactivated mode */
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_STATES
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* enable state machine */
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_SCTRL_R
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable both B receivers */
id|write_usb
c_func
(paren
id|hfc
comma
id|HFCUSB_SCTRL
comma
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* disable B transmitters + capacitive mode */
singleline_comment|// set both B-channel to not connected
id|hfc-&gt;b_mode
(braket
l_int|0
)braket
op_assign
id|L1_MODE_NULL
suffix:semicolon
id|hfc-&gt;b_mode
(braket
l_int|1
)braket
op_assign
id|L1_MODE_NULL
suffix:semicolon
id|hfc-&gt;l1_activated
op_assign
id|FALSE
suffix:semicolon
id|hfc-&gt;led_state
op_assign
l_int|0
suffix:semicolon
id|hfc-&gt;led_new_data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* init the t3 timer */
id|init_timer
c_func
(paren
op_amp
id|hfc-&gt;t3_timer
)paren
suffix:semicolon
id|hfc-&gt;t3_timer.data
op_assign
(paren
r_int
)paren
id|hfc
suffix:semicolon
id|hfc-&gt;t3_timer.function
op_assign
(paren
r_void
op_star
)paren
id|l1_timer_expire_t3
suffix:semicolon
multiline_comment|/* init the t4 timer */
id|init_timer
c_func
(paren
op_amp
id|hfc-&gt;t4_timer
)paren
suffix:semicolon
id|hfc-&gt;t4_timer.data
op_assign
(paren
r_int
)paren
id|hfc
suffix:semicolon
id|hfc-&gt;t4_timer.function
op_assign
(paren
r_void
op_star
)paren
id|l1_timer_expire_t4
suffix:semicolon
multiline_comment|/* init the led timer */
id|init_timer
c_func
(paren
op_amp
id|hfc-&gt;led_timer
)paren
suffix:semicolon
id|hfc-&gt;led_timer.data
op_assign
(paren
r_int
)paren
id|hfc
suffix:semicolon
id|hfc-&gt;led_timer.function
op_assign
(paren
r_void
op_star
)paren
id|led_timer
suffix:semicolon
singleline_comment|// trigger 4 hz led timer
id|hfc-&gt;led_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|LED_TIME
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|hfc-&gt;led_timer
)paren
)paren
(brace
id|add_timer
c_func
(paren
op_amp
id|hfc-&gt;led_timer
)paren
suffix:semicolon
)brace
singleline_comment|// init the background machinery for control requests
id|hfc-&gt;ctrl_read.bRequestType
op_assign
l_int|0xc0
suffix:semicolon
id|hfc-&gt;ctrl_read.bRequest
op_assign
l_int|1
suffix:semicolon
id|hfc-&gt;ctrl_read.wLength
op_assign
l_int|1
suffix:semicolon
id|hfc-&gt;ctrl_write.bRequestType
op_assign
l_int|0x40
suffix:semicolon
id|hfc-&gt;ctrl_write.bRequest
op_assign
l_int|0
suffix:semicolon
id|hfc-&gt;ctrl_write.wLength
op_assign
l_int|0
suffix:semicolon
id|usb_fill_control_urb
c_func
(paren
id|hfc-&gt;ctrl_urb
comma
id|hfc-&gt;dev
comma
id|hfc-&gt;ctrl_out_pipe
comma
(paren
id|u_char
op_star
)paren
op_amp
id|hfc-&gt;ctrl_write
comma
l_int|NULL
comma
l_int|0
comma
id|ctrl_complete
comma
id|hfc
)paren
suffix:semicolon
multiline_comment|/* Init All Fifos */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HFCUSB_NUM_FIFOS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hfc-&gt;fifos
(braket
id|i
)braket
dot
id|iso
(braket
l_int|0
)braket
dot
id|purb
op_assign
l_int|NULL
suffix:semicolon
id|hfc-&gt;fifos
(braket
id|i
)braket
dot
id|iso
(braket
l_int|1
)braket
dot
id|purb
op_assign
l_int|NULL
suffix:semicolon
id|hfc-&gt;fifos
(braket
id|i
)braket
dot
id|active
op_assign
l_int|0
suffix:semicolon
)brace
singleline_comment|// register like Germaschewski :
id|hfc-&gt;d_if.owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|hfc-&gt;d_if.ifc.priv
op_assign
op_amp
id|hfc-&gt;fifos
(braket
id|HFCUSB_D_TX
)braket
suffix:semicolon
id|hfc-&gt;d_if.ifc.l2l1
op_assign
id|hfc_usb_l2l1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hfc-&gt;b_if
(braket
id|i
)braket
dot
id|ifc.priv
op_assign
op_amp
id|hfc-&gt;fifos
(braket
id|HFCUSB_B1_TX
op_plus
id|i
op_star
l_int|2
)braket
suffix:semicolon
id|hfc-&gt;b_if
(braket
id|i
)braket
dot
id|ifc.l2l1
op_assign
id|hfc_usb_l2l1
suffix:semicolon
id|p_b_if
(braket
id|i
)braket
op_assign
op_amp
id|hfc-&gt;b_if
(braket
id|i
)braket
suffix:semicolon
)brace
id|hfc-&gt;protocol
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* default EURO ISDN, should be a module_param */
id|hisax_register
c_func
(paren
op_amp
id|hfc-&gt;d_if
comma
id|p_b_if
comma
l_string|&quot;hfc_usb&quot;
comma
id|hfc-&gt;protocol
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|hfc-&gt;fifos
(braket
id|i
)braket
dot
id|hif
op_assign
op_amp
id|p_b_if
(braket
id|i
op_div
l_int|2
)braket
op_member_access_from_pointer
id|ifc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|hfc-&gt;fifos
(braket
id|i
)braket
dot
id|hif
op_assign
op_amp
id|hfc-&gt;d_if.ifc
suffix:semicolon
singleline_comment|// 3 (+1) INT IN + 3 ISO OUT
r_if
c_cond
(paren
id|hfc-&gt;cfg_used
op_eq
id|CNF_3INT3ISO
op_logical_or
id|hfc-&gt;cfg_used
op_eq
id|CNF_4INT3ISO
)paren
(brace
id|start_int_fifo
c_func
(paren
id|hfc-&gt;fifos
op_plus
id|HFCUSB_D_RX
)paren
suffix:semicolon
singleline_comment|// Int IN D-fifo
r_if
c_cond
(paren
id|hfc-&gt;fifos
(braket
id|HFCUSB_PCM_RX
)braket
dot
id|pipe
)paren
(brace
id|start_int_fifo
c_func
(paren
id|hfc-&gt;fifos
op_plus
id|HFCUSB_PCM_RX
)paren
suffix:semicolon
)brace
singleline_comment|// E-fifo
id|start_int_fifo
c_func
(paren
id|hfc-&gt;fifos
op_plus
id|HFCUSB_B1_RX
)paren
suffix:semicolon
singleline_comment|// Int IN B1-fifo
id|start_int_fifo
c_func
(paren
id|hfc-&gt;fifos
op_plus
id|HFCUSB_B2_RX
)paren
suffix:semicolon
singleline_comment|// Int IN B2-fifo
)brace
singleline_comment|// 3 (+1) ISO IN + 3 ISO OUT
r_if
c_cond
(paren
id|hfc-&gt;cfg_used
op_eq
id|CNF_3ISO3ISO
op_logical_or
id|hfc-&gt;cfg_used
op_eq
id|CNF_4ISO3ISO
)paren
(brace
id|start_isoc_chain
c_func
(paren
id|hfc-&gt;fifos
op_plus
id|HFCUSB_D_RX
comma
id|ISOC_PACKETS_D
comma
id|rx_iso_complete
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hfc-&gt;fifos
(braket
id|HFCUSB_PCM_RX
)braket
dot
id|pipe
)paren
(brace
id|start_isoc_chain
c_func
(paren
id|hfc-&gt;fifos
op_plus
id|HFCUSB_PCM_RX
comma
id|ISOC_PACKETS_D
comma
id|rx_iso_complete
comma
l_int|16
)paren
suffix:semicolon
)brace
id|start_isoc_chain
c_func
(paren
id|hfc-&gt;fifos
op_plus
id|HFCUSB_B1_RX
comma
id|ISOC_PACKETS_B
comma
id|rx_iso_complete
comma
l_int|16
)paren
suffix:semicolon
id|start_isoc_chain
c_func
(paren
id|hfc-&gt;fifos
op_plus
id|HFCUSB_B2_RX
comma
id|ISOC_PACKETS_B
comma
id|rx_iso_complete
comma
l_int|16
)paren
suffix:semicolon
)brace
id|start_isoc_chain
c_func
(paren
id|hfc-&gt;fifos
op_plus
id|HFCUSB_D_TX
comma
id|ISOC_PACKETS_D
comma
id|tx_iso_complete
comma
l_int|1
)paren
suffix:semicolon
id|start_isoc_chain
c_func
(paren
id|hfc-&gt;fifos
op_plus
id|HFCUSB_B1_TX
comma
id|ISOC_PACKETS_B
comma
id|tx_iso_complete
comma
l_int|1
)paren
suffix:semicolon
id|start_isoc_chain
c_func
(paren
id|hfc-&gt;fifos
op_plus
id|HFCUSB_B2_TX
comma
id|ISOC_PACKETS_B
comma
id|tx_iso_complete
comma
l_int|1
)paren
suffix:semicolon
id|handle_led
c_func
(paren
id|hfc
comma
id|LED_POWER_ON
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* usb_init */
multiline_comment|/****************************************/
multiline_comment|/* data defining the devices to be used */
multiline_comment|/****************************************/
singleline_comment|// static __devinitdata const struct usb_device_id hfc_usb_idtab[3] = {
DECL|variable|hfc_usb_idtab
r_static
r_struct
id|usb_device_id
id|hfc_usb_idtab
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x7b0
comma
l_int|0x0007
)paren
)brace
comma
multiline_comment|/* Billion USB TA 2 */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x742
comma
l_int|0x2008
)paren
)brace
comma
multiline_comment|/* Stollmann USB TA */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x959
comma
l_int|0x2bd0
)paren
)brace
comma
multiline_comment|/* Colognechip USB eval TA */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x8e3
comma
l_int|0x0301
)paren
)brace
comma
multiline_comment|/* OliTec ISDN USB */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x675
comma
l_int|0x1688
)paren
)brace
comma
multiline_comment|/* DrayTec ISDN USB */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x7fa
comma
l_int|0x0846
)paren
)brace
comma
multiline_comment|/* Bewan ISDN USB TA */
(brace
)brace
multiline_comment|/* end with an all-zeroes entry */
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Peter Sprenger (sprenger@moving-byters.de)/Martin Bachem (info@colognechip.com)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;HFC I4L USB driver&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|usb
comma
id|hfc_usb_idtab
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|EP_NUL
mdefine_line|#define EP_NUL 1    
singleline_comment|// Endpoint at this position not allowed
DECL|macro|EP_NOP
mdefine_line|#define EP_NOP 2&t;
singleline_comment|// all type of endpoints allowed at this position
DECL|macro|EP_ISO
mdefine_line|#define EP_ISO 3&t;
singleline_comment|// Isochron endpoint mandatory at this position
DECL|macro|EP_BLK
mdefine_line|#define EP_BLK 4&t;
singleline_comment|// Bulk endpoint mandatory at this position
DECL|macro|EP_INT
mdefine_line|#define EP_INT 5&t;
singleline_comment|// Interrupt endpoint mandatory at this position
singleline_comment|// this array represents all endpoints possible in the HCF-USB
singleline_comment|// the last 2 entries are the configuration number and the minimum interval for Interrupt endpoints
DECL|variable|validconf
r_int
id|validconf
(braket
)braket
(braket
l_int|18
)braket
op_assign
(brace
singleline_comment|// INT in, ISO out config
(brace
id|EP_NUL
comma
id|EP_INT
comma
id|EP_NUL
comma
id|EP_INT
comma
id|EP_NUL
comma
id|EP_INT
comma
id|EP_NOP
comma
id|EP_INT
comma
id|EP_ISO
comma
id|EP_NUL
comma
id|EP_ISO
comma
id|EP_NUL
comma
id|EP_ISO
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|CNF_4INT3ISO
comma
l_int|2
)brace
comma
(brace
id|EP_NUL
comma
id|EP_INT
comma
id|EP_NUL
comma
id|EP_INT
comma
id|EP_NUL
comma
id|EP_INT
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_ISO
comma
id|EP_NUL
comma
id|EP_ISO
comma
id|EP_NUL
comma
id|EP_ISO
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|CNF_3INT3ISO
comma
l_int|2
)brace
comma
singleline_comment|// ISO in, ISO out config
(brace
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_ISO
comma
id|EP_ISO
comma
id|EP_ISO
comma
id|EP_ISO
comma
id|EP_ISO
comma
id|EP_ISO
comma
id|EP_NOP
comma
id|EP_ISO
comma
id|CNF_4ISO3ISO
comma
l_int|2
)brace
comma
(brace
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|EP_ISO
comma
id|EP_ISO
comma
id|EP_ISO
comma
id|EP_ISO
comma
id|EP_ISO
comma
id|EP_ISO
comma
id|EP_NUL
comma
id|EP_NUL
comma
id|CNF_3ISO3ISO
comma
l_int|2
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
singleline_comment|// EOL element
)brace
suffix:semicolon
singleline_comment|// string description of chosen config
DECL|variable|conf_str
r_char
op_star
id|conf_str
(braket
)braket
op_assign
(brace
l_string|&quot;4 Interrupt IN + 3 Isochron OUT&quot;
comma
l_string|&quot;3 Interrupt IN + 3 Isochron OUT&quot;
comma
l_string|&quot;4 Isochron IN + 3 Isochron OUT&quot;
comma
l_string|&quot;3 Isochron IN + 3 Isochron OUT&quot;
)brace
suffix:semicolon
multiline_comment|/*************************************************/
multiline_comment|/* function called to probe a new plugged device */
multiline_comment|/*************************************************/
DECL|function|hfc_usb_probe
r_static
r_int
id|hfc_usb_probe
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|interface_to_usbdev
c_func
(paren
id|intf
)paren
suffix:semicolon
id|hfcusb_data
op_star
id|context
suffix:semicolon
r_struct
id|usb_host_interface
op_star
id|iface
op_assign
id|intf-&gt;cur_altsetting
suffix:semicolon
r_struct
id|usb_host_interface
op_star
id|iface_used
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|usb_host_endpoint
op_star
id|ep
suffix:semicolon
r_int
id|ifnum
op_assign
id|iface-&gt;desc.bInterfaceNumber
suffix:semicolon
r_int
id|i
comma
id|idx
comma
id|alt_idx
comma
id|probe_alt_setting
comma
id|vend_idx
comma
id|cfg_used
comma
op_star
id|vcf
comma
id|attr
comma
id|cfg_found
comma
id|cidx
comma
id|ep_addr
suffix:semicolon
r_int
id|cmptbl
(braket
l_int|16
)braket
comma
id|small_match
comma
id|iso_packet_size
comma
id|packet_size
comma
id|alt_used
op_assign
l_int|0
suffix:semicolon
singleline_comment|//        usb_show_device(dev);
singleline_comment|//&t;usb_show_device_descriptor(&amp;dev-&gt;descriptor);
singleline_comment|//&t;usb_show_interface_descriptor(&amp;iface-&gt;desc);
id|vend_idx
op_assign
l_int|0xffff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|vdata
(braket
id|i
)braket
dot
id|vendor
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|dev-&gt;descriptor.idVendor
)paren
op_eq
id|vdata
(braket
id|i
)braket
dot
id|vendor
op_logical_and
id|le16_to_cpu
c_func
(paren
id|dev-&gt;descriptor.idProduct
)paren
op_eq
id|vdata
(braket
id|i
)braket
dot
id|prod_id
)paren
id|vend_idx
op_assign
id|i
suffix:semicolon
)brace
macro_line|#ifdef VERBOSE_USB_DEBUG&t;
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: probing interface(%d) actalt(%d) minor(%d)&bslash;n&quot;
comma
id|ifnum
comma
id|iface-&gt;desc.bAlternateSetting
comma
id|intf-&gt;minor
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|vend_idx
op_ne
l_int|0xffff
)paren
(brace
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: found vendor idx:%d  name:%s&bslash;n&quot;
comma
id|vend_idx
comma
id|vdata
(braket
id|vend_idx
)braket
dot
id|vend_name
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* if vendor and product ID is OK, start probing a matching alternate setting ... */
id|alt_idx
op_assign
l_int|0
suffix:semicolon
id|small_match
op_assign
l_int|0xffff
suffix:semicolon
singleline_comment|// default settings
id|iso_packet_size
op_assign
l_int|16
suffix:semicolon
id|packet_size
op_assign
l_int|64
suffix:semicolon
r_while
c_loop
(paren
id|alt_idx
OL
id|intf-&gt;num_altsetting
)paren
(brace
id|iface
op_assign
id|intf-&gt;altsetting
op_plus
id|alt_idx
suffix:semicolon
id|probe_alt_setting
op_assign
id|iface-&gt;desc.bAlternateSetting
suffix:semicolon
id|cfg_used
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: test alt_setting %d&bslash;n&quot;
comma
id|probe_alt_setting
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|// check for config EOL element
r_while
c_loop
(paren
id|validconf
(braket
id|cfg_used
)braket
(braket
l_int|0
)braket
)paren
(brace
id|cfg_found
op_assign
id|TRUE
suffix:semicolon
id|vcf
op_assign
id|validconf
(braket
id|cfg_used
)braket
suffix:semicolon
id|ep
op_assign
id|iface-&gt;endpoint
suffix:semicolon
multiline_comment|/* first endpoint descriptor */
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: (if=%d alt=%d cfg_used=%d)&bslash;n&quot;
comma
id|ifnum
comma
id|probe_alt_setting
comma
id|cfg_used
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|// copy table
id|memcpy
c_func
(paren
id|cmptbl
comma
id|vcf
comma
l_int|16
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
singleline_comment|// check for all endpoints in this alternate setting
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|iface-&gt;desc.bNumEndpoints
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ep_addr
op_assign
id|ep-&gt;desc.bEndpointAddress
suffix:semicolon
id|idx
op_assign
(paren
(paren
id|ep_addr
op_amp
l_int|0x7f
)paren
op_minus
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
multiline_comment|/* get endpoint base */
r_if
c_cond
(paren
id|ep_addr
op_amp
l_int|0x80
)paren
id|idx
op_increment
suffix:semicolon
id|attr
op_assign
id|ep-&gt;desc.bmAttributes
suffix:semicolon
r_if
c_cond
(paren
id|cmptbl
(braket
id|idx
)braket
op_eq
id|EP_NUL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: cfg_found=FALSE in idx:%d  attr:%d  cmptbl[%d]:%d&bslash;n&quot;
comma
id|idx
comma
id|attr
comma
id|idx
comma
id|cmptbl
(braket
id|idx
)braket
)paren
suffix:semicolon
id|cfg_found
op_assign
id|FALSE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|attr
op_eq
id|USB_ENDPOINT_XFER_INT
op_logical_and
id|cmptbl
(braket
id|idx
)braket
op_eq
id|EP_INT
)paren
id|cmptbl
(braket
id|idx
)braket
op_assign
id|EP_NUL
suffix:semicolon
r_if
c_cond
(paren
id|attr
op_eq
id|USB_ENDPOINT_XFER_BULK
op_logical_and
id|cmptbl
(braket
id|idx
)braket
op_eq
id|EP_BLK
)paren
id|cmptbl
(braket
id|idx
)braket
op_assign
id|EP_NUL
suffix:semicolon
r_if
c_cond
(paren
id|attr
op_eq
id|USB_ENDPOINT_XFER_ISOC
op_logical_and
id|cmptbl
(braket
id|idx
)braket
op_eq
id|EP_ISO
)paren
id|cmptbl
(braket
id|idx
)braket
op_assign
id|EP_NUL
suffix:semicolon
singleline_comment|// check if all INT endpoints match minimum interval
r_if
c_cond
(paren
id|attr
op_eq
id|USB_ENDPOINT_XFER_INT
op_logical_and
id|ep-&gt;desc.bInterval
OL
id|vcf
(braket
l_int|17
)braket
)paren
(brace
macro_line|#ifdef VERBOSE_USB_DEBUG
r_if
c_cond
(paren
id|cfg_found
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: Interrupt Endpoint interval &lt; %d found - skipping config&bslash;n&quot;
comma
id|vcf
(braket
l_int|17
)braket
)paren
suffix:semicolon
macro_line|#endif
id|cfg_found
op_assign
id|FALSE
suffix:semicolon
)brace
id|ep
op_increment
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
singleline_comment|// printk(KERN_INFO &quot;HFC-USB: cmptbl[%d]:%d&bslash;n&quot;, i, cmptbl[i]);
singleline_comment|// all entries must be EP_NOP or EP_NUL for a valid config
r_if
c_cond
(paren
id|cmptbl
(braket
id|i
)braket
op_ne
id|EP_NOP
op_logical_and
id|cmptbl
(braket
id|i
)braket
op_ne
id|EP_NUL
)paren
id|cfg_found
op_assign
id|FALSE
suffix:semicolon
)brace
singleline_comment|// we check for smallest match, to provide configuration priority
singleline_comment|// configurations with smaller index have higher priority
r_if
c_cond
(paren
id|cfg_found
)paren
(brace
r_if
c_cond
(paren
id|cfg_used
OL
id|small_match
)paren
(brace
id|small_match
op_assign
id|cfg_used
suffix:semicolon
id|alt_used
op_assign
id|probe_alt_setting
suffix:semicolon
id|iface_used
op_assign
id|iface
suffix:semicolon
)brace
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: small_match=%x %x&bslash;n&quot;
comma
id|small_match
comma
id|alt_used
)paren
suffix:semicolon
macro_line|#endif
)brace
id|cfg_used
op_increment
suffix:semicolon
)brace
id|alt_idx
op_increment
suffix:semicolon
)brace
multiline_comment|/* (alt_idx &lt; intf-&gt;num_altsetting) */
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: final small_match=%x alt_used=%x&bslash;n&quot;
comma
id|small_match
comma
id|alt_used
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|// yiipiee, we found a valid config
r_if
c_cond
(paren
id|small_match
op_ne
l_int|0xffff
)paren
(brace
id|iface
op_assign
id|iface_used
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|context
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|hfcusb_data
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* got no mem */
id|memset
c_func
(paren
id|context
comma
l_int|0
comma
r_sizeof
(paren
id|hfcusb_data
)paren
)paren
suffix:semicolon
multiline_comment|/* clear the structure */
id|ep
op_assign
id|iface-&gt;endpoint
suffix:semicolon
multiline_comment|/* first endpoint descriptor */
id|vcf
op_assign
id|validconf
(braket
id|small_match
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|iface-&gt;desc.bNumEndpoints
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ep_addr
op_assign
id|ep-&gt;desc.bEndpointAddress
suffix:semicolon
id|idx
op_assign
(paren
(paren
id|ep_addr
op_amp
l_int|0x7f
)paren
op_minus
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
multiline_comment|/* get endpoint base */
r_if
c_cond
(paren
id|ep_addr
op_amp
l_int|0x80
)paren
id|idx
op_increment
suffix:semicolon
id|cidx
op_assign
id|idx
op_amp
l_int|7
suffix:semicolon
id|attr
op_assign
id|ep-&gt;desc.bmAttributes
suffix:semicolon
singleline_comment|// only initialize used endpoints
r_if
c_cond
(paren
id|vcf
(braket
id|idx
)braket
op_ne
id|EP_NOP
op_logical_and
id|vcf
(braket
id|idx
)braket
op_ne
id|EP_NUL
)paren
(brace
r_switch
c_cond
(paren
id|attr
)paren
(brace
r_case
id|USB_ENDPOINT_XFER_INT
suffix:colon
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|pipe
op_assign
id|usb_rcvintpipe
c_func
(paren
id|dev
comma
id|ep-&gt;desc.bEndpointAddress
)paren
suffix:semicolon
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|usb_transfer_mode
op_assign
id|USB_INT
suffix:semicolon
id|packet_size
op_assign
id|le16_to_cpu
c_func
(paren
id|ep-&gt;desc.wMaxPacketSize
)paren
suffix:semicolon
singleline_comment|// remember max packet size
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: Interrupt-In Endpoint found %d ms(idx:%d cidx:%d)!&bslash;n&quot;
comma
id|ep-&gt;desc.bInterval
comma
id|idx
comma
id|cidx
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|USB_ENDPOINT_XFER_BULK
suffix:colon
r_if
c_cond
(paren
id|ep_addr
op_amp
l_int|0x80
)paren
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|pipe
op_assign
id|usb_rcvbulkpipe
c_func
(paren
id|dev
comma
id|ep-&gt;desc.bEndpointAddress
)paren
suffix:semicolon
r_else
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|pipe
op_assign
id|usb_sndbulkpipe
c_func
(paren
id|dev
comma
id|ep-&gt;desc.bEndpointAddress
)paren
suffix:semicolon
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|usb_transfer_mode
op_assign
id|USB_BULK
suffix:semicolon
id|packet_size
op_assign
id|le16_to_cpu
c_func
(paren
id|ep-&gt;desc.wMaxPacketSize
)paren
suffix:semicolon
singleline_comment|// remember max packet size
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: Bulk Endpoint found (idx:%d cidx:%d)!&bslash;n&quot;
comma
id|idx
comma
id|cidx
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|USB_ENDPOINT_XFER_ISOC
suffix:colon
r_if
c_cond
(paren
id|ep_addr
op_amp
l_int|0x80
)paren
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|pipe
op_assign
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
id|ep-&gt;desc.bEndpointAddress
)paren
suffix:semicolon
r_else
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|pipe
op_assign
id|usb_sndisocpipe
c_func
(paren
id|dev
comma
id|ep-&gt;desc.bEndpointAddress
)paren
suffix:semicolon
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|usb_transfer_mode
op_assign
id|USB_ISOC
suffix:semicolon
id|iso_packet_size
op_assign
id|le16_to_cpu
c_func
(paren
id|ep-&gt;desc.wMaxPacketSize
)paren
suffix:semicolon
singleline_comment|// remember max packet size
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: ISO Endpoint found (idx:%d cidx:%d)!&bslash;n&quot;
comma
id|idx
comma
id|cidx
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|pipe
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset data */
)brace
multiline_comment|/* switch attribute */
r_if
c_cond
(paren
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|pipe
)paren
(brace
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|fifonum
op_assign
id|cidx
suffix:semicolon
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|hfc
op_assign
id|context
suffix:semicolon
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|usb_packet_maxlen
op_assign
id|le16_to_cpu
c_func
(paren
id|ep-&gt;desc.wMaxPacketSize
)paren
suffix:semicolon
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|intervall
op_assign
id|ep-&gt;desc.bInterval
suffix:semicolon
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|skbuff
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: fifo%d pktlen %d interval %d&bslash;n&quot;
comma
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|fifonum
comma
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|usb_packet_maxlen
comma
id|context-&gt;fifos
(braket
id|cidx
)braket
dot
id|intervall
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
id|ep
op_increment
suffix:semicolon
)brace
singleline_comment|// now share our luck
id|context-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* save device */
id|context-&gt;if_used
op_assign
id|ifnum
suffix:semicolon
multiline_comment|/* save used interface */
id|context-&gt;alt_used
op_assign
id|alt_used
suffix:semicolon
multiline_comment|/* and alternate config */
id|context-&gt;ctrl_paksize
op_assign
id|dev-&gt;descriptor.bMaxPacketSize0
suffix:semicolon
multiline_comment|/* control size */
id|context-&gt;cfg_used
op_assign
id|vcf
(braket
l_int|16
)braket
suffix:semicolon
singleline_comment|// store used config
id|context-&gt;vend_idx
op_assign
id|vend_idx
suffix:semicolon
singleline_comment|// store found vendor
id|context-&gt;packet_size
op_assign
id|packet_size
suffix:semicolon
id|context-&gt;iso_packet_size
op_assign
id|iso_packet_size
suffix:semicolon
multiline_comment|/* create the control pipes needed for register access */
id|context-&gt;ctrl_in_pipe
op_assign
id|usb_rcvctrlpipe
c_func
(paren
id|context-&gt;dev
comma
l_int|0
)paren
suffix:semicolon
id|context-&gt;ctrl_out_pipe
op_assign
id|usb_sndctrlpipe
c_func
(paren
id|context-&gt;dev
comma
l_int|0
)paren
suffix:semicolon
id|context-&gt;ctrl_urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: detected &bslash;&quot;%s&bslash;&quot; configuration: %s (if=%d alt=%d)&bslash;n&quot;
comma
id|vdata
(braket
id|vend_idx
)braket
dot
id|vend_name
comma
id|conf_str
(braket
id|small_match
)braket
comma
id|context-&gt;if_used
comma
id|context-&gt;alt_used
)paren
suffix:semicolon
multiline_comment|/* init the chip and register the driver */
r_if
c_cond
(paren
id|usb_init
c_func
(paren
id|context
)paren
)paren
(brace
r_if
c_cond
(paren
id|context-&gt;ctrl_urb
)paren
(brace
id|usb_unlink_urb
c_func
(paren
id|context-&gt;ctrl_urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|context-&gt;ctrl_urb
)paren
suffix:semicolon
id|context-&gt;ctrl_urb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|context
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|usb_set_intfdata
c_func
(paren
id|intf
comma
id|context
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/****************************************************/
multiline_comment|/* function called when an active device is removed */
multiline_comment|/****************************************************/
DECL|function|hfc_usb_disconnect
r_static
r_void
id|hfc_usb_disconnect
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
(brace
id|hfcusb_data
op_star
id|context
op_assign
id|usb_get_intfdata
c_func
(paren
id|intf
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: device disconnect&bslash;n&quot;
)paren
suffix:semicolon
id|usb_set_intfdata
c_func
(paren
id|intf
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|context
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|context-&gt;t3_timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|context-&gt;t3_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|context-&gt;t4_timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|context-&gt;t4_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|context-&gt;led_timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|context-&gt;led_timer
)paren
suffix:semicolon
id|hisax_unregister
c_func
(paren
op_amp
id|context-&gt;d_if
)paren
suffix:semicolon
multiline_comment|/* tell all fifos to terminate */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HFCUSB_NUM_FIFOS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|context-&gt;fifos
(braket
id|i
)braket
dot
id|usb_transfer_mode
op_eq
id|USB_ISOC
)paren
(brace
r_if
c_cond
(paren
id|context-&gt;fifos
(braket
id|i
)braket
dot
id|active
OG
l_int|0
)paren
(brace
id|stop_isoc_chain
c_func
(paren
op_amp
id|context-&gt;fifos
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: hfc_usb_disconnect: stopping ISOC chain Fifo no %i&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|context-&gt;fifos
(braket
id|i
)braket
dot
id|active
OG
l_int|0
)paren
(brace
id|context-&gt;fifos
(braket
id|i
)braket
dot
id|active
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: hfc_usb_disconnect: unlinking URB for Fifo no %i&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|context-&gt;fifos
(braket
id|i
)braket
dot
id|urb
)paren
(brace
id|usb_unlink_urb
c_func
(paren
id|context-&gt;fifos
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|context-&gt;fifos
(braket
id|i
)braket
dot
id|urb
)paren
suffix:semicolon
id|context-&gt;fifos
(braket
id|i
)braket
dot
id|urb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|context-&gt;fifos
(braket
id|i
)braket
dot
id|active
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|context-&gt;ctrl_urb
)paren
(brace
id|usb_unlink_urb
c_func
(paren
id|context-&gt;ctrl_urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|context-&gt;ctrl_urb
)paren
suffix:semicolon
id|context-&gt;ctrl_urb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|context
)paren
suffix:semicolon
multiline_comment|/* free our structure again */
)brace
multiline_comment|/* hfc_usb_disconnect */
multiline_comment|/************************************/
multiline_comment|/* our driver information structure */
multiline_comment|/************************************/
DECL|variable|hfc_drv
r_static
r_struct
id|usb_driver
id|hfc_drv
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;hfc_usb&quot;
comma
dot
id|id_table
op_assign
id|hfc_usb_idtab
comma
dot
id|probe
op_assign
id|hfc_usb_probe
comma
dot
id|disconnect
op_assign
id|hfc_usb_disconnect
comma
)brace
suffix:semicolon
DECL|function|hfc_usb_exit
r_static
r_void
id|__exit
id|hfc_usb_exit
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef VERBOSE_USB_DEBUG
id|printk
(paren
l_string|&quot;HFC-USB: calling &bslash;&quot;hfc_usb_exit&bslash;&quot; ...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|usb_deregister
c_func
(paren
op_amp
id|hfc_drv
)paren
suffix:semicolon
multiline_comment|/* release our driver */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB module removed&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|hfc_usb_init
r_static
r_int
id|__init
id|hfc_usb_init
c_func
(paren
r_void
)paren
(brace
id|printk
(paren
l_string|&quot;HFC-USB: driver module revision %s loaded&bslash;n&quot;
comma
id|hfcusb_revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_register
c_func
(paren
op_amp
id|hfc_drv
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-USB: Unable to register HFC-USB module at usb stack&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* unable to register */
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hfc_usb_init
id|module_init
c_func
(paren
id|hfc_usb_init
)paren
suffix:semicolon
DECL|variable|hfc_usb_exit
id|module_exit
c_func
(paren
id|hfc_usb_exit
)paren
suffix:semicolon
eof
