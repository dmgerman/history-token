multiline_comment|/*************************************************************************/
multiline_comment|/* $Id: hfc4s8s_l1.c,v 1.8 2004/07/13 14:13:34 martinb1 Exp $            */
multiline_comment|/* HFC-4S/8S low layer interface for Cologne Chip HFC-4S/8S isdn chips   */
multiline_comment|/* The low layer (L1) is implemented as a loadable module for usage with */
multiline_comment|/* the HiSax isdn driver for passive cards.                              */
multiline_comment|/*                                                                       */
multiline_comment|/* Author: Werner Cornelius                                              */
multiline_comment|/* (C) 2003 Cornelius Consult (werner@cornelius-consult.de)              */
multiline_comment|/*                                                                       */
multiline_comment|/* Driver maintained by Cologne Chip                                     */
multiline_comment|/*   - Martin Bachem, support@colognechip.com                            */
multiline_comment|/*                                                                       */
multiline_comment|/* This driver only works with chip revisions &gt;= 1, older revision 0     */
multiline_comment|/* engineering samples (only first manufacturer sample cards) will not   */
multiline_comment|/* work and are rejected by the driver.                                  */
multiline_comment|/*                                                                       */
multiline_comment|/* This file distributed under the GNU GPL.                              */
multiline_comment|/*                                                                       */
multiline_comment|/* See Version History at the end of this file                           */
multiline_comment|/*                                                                       */
multiline_comment|/*************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &quot;hisax_if.h&quot;
macro_line|#include &quot;hfc48scu.h&quot;
DECL|variable|hfc4s8s_rev
r_static
r_const
r_char
id|hfc4s8s_rev
(braket
)braket
op_assign
l_string|&quot;$Revision: 1.8 $&quot;
suffix:semicolon
multiline_comment|/***************************************************************/
multiline_comment|/* adjustable transparent mode fifo threshold                  */
multiline_comment|/* The value defines the used fifo threshold with the equation */
multiline_comment|/*                                                             */
multiline_comment|/* notify number of bytes = 2 * 2 ^ TRANS_FIFO_THRES           */
multiline_comment|/*                                                             */
multiline_comment|/* The default value is 5 which results in a buffer size of 64 */
multiline_comment|/* and an interrupt rate of 8ms.                               */
multiline_comment|/* The maximum value is 7 due to fifo size restrictions.       */
multiline_comment|/* Values below 3-4 are not recommended due to high interrupt  */
multiline_comment|/* load of the processor. For non critical applications the    */
multiline_comment|/* value should be raised to 7 to reduce any interrupt overhead*/
multiline_comment|/***************************************************************/
DECL|macro|TRANS_FIFO_THRES
mdefine_line|#define TRANS_FIFO_THRES 5
multiline_comment|/****************************************/
multiline_comment|/* Enable 32 bit fifo access if defined */
multiline_comment|/* Only usefull on intel pc based arch. */
multiline_comment|/* Default is enabled (PC usage).       */
multiline_comment|/****************************************/
DECL|macro|FIFO_32BIT_ACCESS
mdefine_line|#define FIFO_32BIT_ACCESS
multiline_comment|/*************/
multiline_comment|/* constants */
multiline_comment|/*************/
DECL|macro|MAX_HFC8_CARDS
mdefine_line|#define MAX_HFC8_CARDS 4
DECL|macro|HFC_MAX_ST
mdefine_line|#define HFC_MAX_ST 8
DECL|macro|HFC_MAX_CHANNELS
mdefine_line|#define HFC_MAX_CHANNELS 32
DECL|macro|MAX_D_FRAME_SIZE
mdefine_line|#define MAX_D_FRAME_SIZE 270
DECL|macro|MAX_B_FRAME_SIZE
mdefine_line|#define MAX_B_FRAME_SIZE 1536
DECL|macro|TRANS_TIMER_MODE
mdefine_line|#define TRANS_TIMER_MODE (TRANS_FIFO_THRES &amp; 0xf)
DECL|macro|TRANS_FIFO_BYTES
mdefine_line|#define TRANS_FIFO_BYTES (2 &lt;&lt; TRANS_FIFO_THRES)
DECL|macro|MAX_F_CNT
mdefine_line|#define MAX_F_CNT 0x0f
multiline_comment|/******************/
multiline_comment|/* types and vars */
multiline_comment|/******************/
r_struct
id|hfc8s_hw
suffix:semicolon
multiline_comment|/* table entry in the PCI devices list */
r_typedef
r_struct
(brace
DECL|member|vendor_id
r_int
id|vendor_id
suffix:semicolon
DECL|member|device_id
r_int
id|device_id
suffix:semicolon
DECL|member|chip_id
r_int
id|chip_id
suffix:semicolon
DECL|member|sub_vendor_id
r_int
id|sub_vendor_id
suffix:semicolon
DECL|member|sub_device_id
r_int
id|sub_device_id
suffix:semicolon
DECL|member|vendor_name
r_char
op_star
id|vendor_name
suffix:semicolon
DECL|member|card_name
r_char
op_star
id|card_name
suffix:semicolon
DECL|member|max_channels
r_int
id|max_channels
suffix:semicolon
DECL|member|clock_mode
r_int
id|clock_mode
suffix:semicolon
DECL|typedef|PCI_ENTRY
)brace
id|PCI_ENTRY
suffix:semicolon
multiline_comment|/* static list of available card types */
DECL|variable|id_list
r_static
r_const
id|PCI_ENTRY
id|__devinitdata
id|id_list
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_CCD
comma
id|PCI_DEVICE_ID_4S
comma
id|CHIP_ID_4S
comma
l_int|0x1397
comma
l_int|0x8b4
comma
l_string|&quot;Cologne Chip&quot;
comma
l_string|&quot;HFC-4S Eval&quot;
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_CCD
comma
id|PCI_DEVICE_ID_8S
comma
id|CHIP_ID_8S
comma
l_int|0x1397
comma
l_int|0x16b8
comma
l_string|&quot;Cologne Chip&quot;
comma
l_string|&quot;HFC-8S Eval&quot;
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_CCD
comma
id|PCI_DEVICE_ID_4S
comma
id|CHIP_ID_4S
comma
l_int|0x1397
comma
l_int|0xb520
comma
l_string|&quot;Cologne Chip&quot;
comma
l_string|&quot;IOB4ST&quot;
comma
l_int|4
comma
l_int|1
)brace
comma
(brace
id|PCI_VENDOR_ID_CCD
comma
id|PCI_DEVICE_ID_8S
comma
id|CHIP_ID_8S
comma
l_int|0x1397
comma
l_int|0xb522
comma
l_string|&quot;Cologne Chip&quot;
comma
l_string|&quot;IOB8ST&quot;
comma
l_int|8
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
(paren
r_char
op_star
)paren
l_int|NULL
comma
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
multiline_comment|/***********/
multiline_comment|/* layer 1 */
multiline_comment|/***********/
DECL|struct|hfc8s_btype
r_struct
id|hfc8s_btype
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|b_if
r_struct
id|hisax_b_if
id|b_if
suffix:semicolon
DECL|member|l1p
r_struct
id|hfc8s_l1
op_star
id|l1p
suffix:semicolon
DECL|member|tx_queue
r_struct
id|sk_buff_head
id|tx_queue
suffix:semicolon
DECL|member|tx_skb
r_struct
id|sk_buff
op_star
id|tx_skb
suffix:semicolon
DECL|member|rx_skb
r_struct
id|sk_buff
op_star
id|rx_skb
suffix:semicolon
DECL|member|rx_ptr
id|__u8
op_star
id|rx_ptr
suffix:semicolon
DECL|member|tx_cnt
r_int
id|tx_cnt
suffix:semicolon
DECL|member|bchan
r_int
id|bchan
suffix:semicolon
DECL|member|mode
r_int
id|mode
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|hfc8s_l1
r_struct
id|hfc8s_l1
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|hw
r_struct
id|hfc8s_hw
op_star
id|hw
suffix:semicolon
singleline_comment|// pointer to hardware area
DECL|member|l1_state
r_int
id|l1_state
suffix:semicolon
singleline_comment|// actual l1 state
DECL|member|l1_timer
r_struct
id|timer_list
id|l1_timer
suffix:semicolon
singleline_comment|// layer 1 timer structure
DECL|member|nt_mode
r_int
id|nt_mode
suffix:semicolon
singleline_comment|// set to nt mode
DECL|member|st_num
r_int
id|st_num
suffix:semicolon
singleline_comment|// own index
DECL|member|enabled
r_int
id|enabled
suffix:semicolon
singleline_comment|// interface is enabled
DECL|member|d_tx_queue
r_struct
id|sk_buff_head
id|d_tx_queue
suffix:semicolon
singleline_comment|// send queue
DECL|member|tx_cnt
r_int
id|tx_cnt
suffix:semicolon
singleline_comment|// bytes to send
DECL|member|d_if
r_struct
id|hisax_d_if
id|d_if
suffix:semicolon
singleline_comment|// D-channel interface
DECL|member|b_ch
r_struct
id|hfc8s_btype
id|b_ch
(braket
l_int|2
)braket
suffix:semicolon
singleline_comment|// B-channel data
DECL|member|b_table
r_struct
id|hisax_b_if
op_star
id|b_table
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**********************/
multiline_comment|/* hardware structure */
multiline_comment|/**********************/
DECL|struct|hfc8s_hw
r_struct
id|hfc8s_hw
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|ifnum
r_int
id|ifnum
suffix:semicolon
DECL|member|iobase
r_int
id|iobase
suffix:semicolon
DECL|member|nt_mode
r_int
id|nt_mode
suffix:semicolon
DECL|member|membase
id|u_char
op_star
id|membase
suffix:semicolon
DECL|member|hw_membase
id|u_char
op_star
id|hw_membase
suffix:semicolon
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
DECL|member|max_st_ports
r_int
id|max_st_ports
suffix:semicolon
DECL|member|max_fifo
r_int
id|max_fifo
suffix:semicolon
DECL|member|clock_mode
r_int
id|clock_mode
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|fifo_sched_cnt
r_int
id|fifo_sched_cnt
suffix:semicolon
DECL|member|tqueue
r_struct
id|work_struct
id|tqueue
suffix:semicolon
DECL|member|l1
r_struct
id|hfc8s_l1
id|l1
(braket
id|HFC_MAX_ST
)braket
suffix:semicolon
DECL|member|card_name
r_char
id|card_name
(braket
l_int|60
)braket
suffix:semicolon
r_struct
(brace
DECL|member|r_irq_ctrl
id|u_char
id|r_irq_ctrl
suffix:semicolon
DECL|member|r_ctrl0
id|u_char
id|r_ctrl0
suffix:semicolon
DECL|member|r_irq_statech
r_volatile
id|u_char
id|r_irq_statech
suffix:semicolon
singleline_comment|// active isdn l1 status
DECL|member|r_irqmsk_statchg
id|u_char
id|r_irqmsk_statchg
suffix:semicolon
singleline_comment|// enabled isdn status ints
DECL|member|r_irq_fifo_blx
id|u_char
id|r_irq_fifo_blx
(braket
l_int|8
)braket
suffix:semicolon
singleline_comment|// fifo status registers
DECL|member|fifo_rx_trans_enables
id|u_char
id|fifo_rx_trans_enables
(braket
l_int|8
)braket
suffix:semicolon
singleline_comment|// mask for enabled transparent rx fifos
DECL|member|fifo_slow_timer_service
id|u_char
id|fifo_slow_timer_service
(braket
l_int|8
)braket
suffix:semicolon
singleline_comment|// mask for fifos needing slower timer service
DECL|member|r_irq_oview
r_volatile
id|u_char
id|r_irq_oview
suffix:semicolon
singleline_comment|// contents of overview register
DECL|member|timer_irq
r_volatile
id|u_char
id|timer_irq
suffix:semicolon
DECL|member|timer_usg_cnt
r_int
id|timer_usg_cnt
suffix:semicolon
singleline_comment|// number of channels using timer
DECL|member|mr
)brace
id|mr
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*************/
multiline_comment|/* constants */
multiline_comment|/*************/
DECL|macro|CLKDEL_NT
mdefine_line|#define CLKDEL_NT 0x6c
DECL|macro|CLKDEL_TE
mdefine_line|#define CLKDEL_TE 0xf
DECL|macro|CTRL0_NT
mdefine_line|#define CTRL0_NT  4
DECL|macro|CTRL0_TE
mdefine_line|#define CTRL0_TE  0
DECL|macro|L1_TIMER_T4
mdefine_line|#define L1_TIMER_T4 2 
singleline_comment|// minimum in jiffies
DECL|macro|L1_TIMER_T3
mdefine_line|#define L1_TIMER_T3 (7 * HZ) 
singleline_comment|// activation timeout
DECL|macro|L1_TIMER_T1
mdefine_line|#define L1_TIMER_T1 ((120 * HZ) / 1000) 
singleline_comment|// NT mode deactivation timeout
multiline_comment|/***************************/
multiline_comment|/* inline function defines */
multiline_comment|/***************************/
singleline_comment|// memory write and dummy IO read to avoid PCI byte merge problems
DECL|macro|Write_hfc8
mdefine_line|#define Write_hfc8(a,b,c) {(*((volatile u_char *)(a-&gt;membase+b)) = c); inb(a-&gt;iobase+4);}
singleline_comment|// memory write without dummy IO access for fifo data access
DECL|macro|fWrite_hfc8
mdefine_line|#define fWrite_hfc8(a,b,c) (*((volatile u_char *)(a-&gt;membase+b)) = c)
DECL|macro|Read_hfc8
mdefine_line|#define Read_hfc8(a,b) (*((volatile u_char *)(a-&gt;membase+b)))
DECL|macro|Write_hfc16
mdefine_line|#define Write_hfc16(a,b,c) (*((volatile unsigned short *)(a-&gt;membase+b)) = c)
DECL|macro|Read_hfc16
mdefine_line|#define Read_hfc16(a,b) (*((volatile unsigned short *)(a-&gt;membase+b)))
DECL|macro|Write_hfc32
mdefine_line|#define Write_hfc32(a,b,c) (*((volatile unsigned long *)(a-&gt;membase+b)) = c)
DECL|macro|Read_hfc32
mdefine_line|#define Read_hfc32(a,b) (*((volatile unsigned long *)(a-&gt;membase+b)))
DECL|macro|wait_busy
mdefine_line|#define wait_busy(a) {while ((Read_hfc8(a, R_STATUS) &amp; M_BUSY));}
DECL|macro|PCI_ENA_MEMIO
mdefine_line|#define PCI_ENA_MEMIO    0x03
multiline_comment|/*******************************************************************************************/
multiline_comment|/* function to read critical counter registers that may be udpated by the chip during read */
multiline_comment|/*******************************************************************************************/
DECL|function|Read_hfc8_stable
r_static
r_volatile
id|u_char
id|Read_hfc8_stable
c_func
(paren
r_struct
id|hfc8s_hw
op_star
id|hw
comma
r_int
id|reg
)paren
(brace
id|u_char
id|ref8
suffix:semicolon
id|u_char
id|in8
suffix:semicolon
id|ref8
op_assign
id|Read_hfc8
c_func
(paren
id|hw
comma
id|reg
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|in8
op_assign
id|Read_hfc8
c_func
(paren
id|hw
comma
id|reg
)paren
)paren
op_ne
id|ref8
)paren
)paren
(brace
id|ref8
op_assign
id|in8
suffix:semicolon
)brace
r_return
id|in8
suffix:semicolon
)brace
DECL|function|Read_hfc16_stable
r_static
r_volatile
r_int
id|Read_hfc16_stable
c_func
(paren
r_struct
id|hfc8s_hw
op_star
id|hw
comma
r_int
id|reg
)paren
(brace
r_int
id|ref16
suffix:semicolon
r_int
id|in16
suffix:semicolon
id|ref16
op_assign
id|Read_hfc16
c_func
(paren
id|hw
comma
id|reg
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|in16
op_assign
id|Read_hfc16
c_func
(paren
id|hw
comma
id|reg
)paren
)paren
op_ne
id|ref16
)paren
)paren
(brace
id|ref16
op_assign
id|in16
suffix:semicolon
)brace
r_return
id|in16
suffix:semicolon
)brace
multiline_comment|/*************/
multiline_comment|/* data area */
multiline_comment|/*************/
DECL|variable|hfc8s
r_static
r_struct
id|hfc8s_hw
id|hfc8s
(braket
id|MAX_HFC8_CARDS
)braket
suffix:semicolon
DECL|variable|card_cnt
r_static
r_int
id|card_cnt
suffix:semicolon
multiline_comment|/*****************************/
multiline_comment|/* D-channel call from HiSax */
multiline_comment|/*****************************/
DECL|function|dch_l2l1
r_static
r_void
id|dch_l2l1
c_func
(paren
r_struct
id|hisax_d_if
op_star
id|iface
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|hfc8s_l1
op_star
id|l1
op_assign
id|iface-&gt;ifc.priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|arg
suffix:semicolon
id|u_long
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_DATA
op_or
id|REQUEST
)paren
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|l1-&gt;enabled
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|l1-&gt;d_tx_queue
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|l1-&gt;d_tx_queue
)paren
op_eq
l_int|1
)paren
op_logical_and
(paren
id|l1-&gt;tx_cnt
op_le
l_int|0
)paren
)paren
(brace
id|l1-&gt;hw-&gt;mr.r_irq_fifo_blx
(braket
id|l1-&gt;st_num
)braket
op_or_assign
l_int|0x10
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|l1-&gt;hw-&gt;tqueue
)paren
suffix:semicolon
)brace
r_else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_ACTIVATE
op_or
id|REQUEST
)paren
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|l1-&gt;enabled
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|l1-&gt;nt_mode
)paren
(brace
r_if
c_cond
(paren
id|l1-&gt;l1_state
OL
l_int|6
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_ST_SEL
comma
id|l1-&gt;st_num
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_ST_WR_STA
comma
l_int|0x60
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|l1-&gt;l1_timer
comma
id|jiffies
op_plus
id|L1_TIMER_T3
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|l1-&gt;l1_state
op_eq
l_int|7
)paren
id|l1-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1-&gt;d_if.ifc
comma
id|PH_ACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|l1-&gt;l1_state
op_ne
l_int|3
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_ST_SEL
comma
id|l1-&gt;st_num
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_ST_WR_STA
comma
l_int|0x60
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|l1-&gt;l1_state
op_eq
l_int|3
)paren
id|l1-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1-&gt;d_if.ifc
comma
id|PH_ACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: Unknown D-chan cmd 0x%x received, ignored&bslash;n&quot;
comma
id|pr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|l1-&gt;enabled
)paren
id|l1-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1-&gt;d_if.ifc
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* dch_l2l1 */
multiline_comment|/*****************************/
multiline_comment|/* B-channel call from HiSax */
multiline_comment|/*****************************/
DECL|function|bch_l2l1
r_static
r_void
id|bch_l2l1
c_func
(paren
r_struct
id|hisax_if
op_star
id|ifc
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|hfc8s_btype
op_star
id|bch
op_assign
id|ifc-&gt;priv
suffix:semicolon
r_struct
id|hfc8s_l1
op_star
id|l1
op_assign
id|bch-&gt;l1p
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|arg
suffix:semicolon
r_int
id|mode
op_assign
(paren
r_int
)paren
id|arg
suffix:semicolon
id|u_long
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_DATA
op_or
id|REQUEST
)paren
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|l1-&gt;enabled
op_logical_or
(paren
id|bch-&gt;mode
op_eq
id|L1_MODE_NULL
)paren
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|bch-&gt;tx_queue
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bch-&gt;tx_skb
op_logical_and
(paren
id|bch-&gt;tx_cnt
op_le
l_int|0
)paren
)paren
(brace
id|l1-&gt;hw-&gt;mr.r_irq_fifo_blx
(braket
id|l1-&gt;st_num
)braket
op_or_assign
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|4
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|l1-&gt;hw-&gt;tqueue
)paren
suffix:semicolon
)brace
r_else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_ACTIVATE
op_or
id|REQUEST
)paren
suffix:colon
r_case
(paren
id|PH_DEACTIVATE
op_or
id|REQUEST
)paren
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|l1-&gt;enabled
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|pr
op_eq
(paren
id|PH_DEACTIVATE
op_or
id|REQUEST
)paren
)paren
id|mode
op_assign
id|L1_MODE_NULL
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|L1_MODE_HDLC
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|l1-&gt;hw-&gt;mr.timer_usg_cnt
op_increment
suffix:semicolon
id|l1-&gt;hw-&gt;mr.fifo_slow_timer_service
(braket
id|l1-&gt;st_num
)braket
op_or_assign
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|0x2
suffix:colon
l_int|0x8
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_FIFO
comma
(paren
id|l1-&gt;st_num
op_star
l_int|8
op_plus
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
)paren
)paren
suffix:semicolon
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_CON_HDLC
comma
l_int|0xc
)paren
suffix:semicolon
singleline_comment|// HDLC mode, flag fill, connect ST
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_SUBCH_CFG
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// 8 bits
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_IRQ_MSK
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// enable TX interrupts for hdlc
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// reset fifo
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_FIFO
comma
(paren
id|l1-&gt;st_num
op_star
l_int|8
op_plus
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|3
)paren
)paren
)paren
suffix:semicolon
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_CON_HDLC
comma
l_int|0xc
)paren
suffix:semicolon
singleline_comment|// HDLC mode, flag fill, connect ST
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_SUBCH_CFG
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// 8 bits
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_IRQ_MSK
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// enable RX interrupts for hdlc
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// reset fifo
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_ST_SEL
comma
id|l1-&gt;st_num
)paren
suffix:semicolon
id|l1-&gt;hw-&gt;mr.r_ctrl0
op_or_assign
(paren
id|bch-&gt;bchan
op_amp
l_int|3
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_ST_CTRL0
comma
id|l1-&gt;hw-&gt;mr.r_ctrl0
)paren
suffix:semicolon
id|bch-&gt;mode
op_assign
id|L1_MODE_HDLC
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|bch-&gt;b_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|bch-&gt;b_if.ifc
comma
id|PH_ACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|L1_MODE_TRANS
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|l1-&gt;hw-&gt;mr.fifo_rx_trans_enables
(braket
id|l1-&gt;st_num
)braket
op_or_assign
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|0x2
suffix:colon
l_int|0x8
)paren
suffix:semicolon
id|l1-&gt;hw-&gt;mr.timer_usg_cnt
op_increment
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_FIFO
comma
(paren
id|l1-&gt;st_num
op_star
l_int|8
op_plus
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
)paren
)paren
suffix:semicolon
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_CON_HDLC
comma
l_int|0xf
)paren
suffix:semicolon
singleline_comment|// Transparent mode, 1 fill, connect ST
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_SUBCH_CFG
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// 8 bits
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_IRQ_MSK
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// disable TX interrupts
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// reset fifo
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_FIFO
comma
(paren
id|l1-&gt;st_num
op_star
l_int|8
op_plus
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|3
)paren
)paren
)paren
suffix:semicolon
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_CON_HDLC
comma
l_int|0xf
)paren
suffix:semicolon
singleline_comment|// Transparent mode, 1 fill, connect ST
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_SUBCH_CFG
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// 8 bits
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_IRQ_MSK
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// disable RX interrupts
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// reset fifo
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_ST_SEL
comma
id|l1-&gt;st_num
)paren
suffix:semicolon
id|l1-&gt;hw-&gt;mr.r_ctrl0
op_or_assign
(paren
id|bch-&gt;bchan
op_amp
l_int|3
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_ST_CTRL0
comma
id|l1-&gt;hw-&gt;mr.r_ctrl0
)paren
suffix:semicolon
id|bch-&gt;mode
op_assign
id|L1_MODE_TRANS
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|bch-&gt;b_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|bch-&gt;b_if.ifc
comma
id|PH_ACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|bch-&gt;mode
op_eq
id|L1_MODE_NULL
)paren
r_break
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|l1-&gt;hw-&gt;mr.fifo_slow_timer_service
(braket
id|l1-&gt;st_num
)braket
op_and_assign
op_complement
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|0x3
suffix:colon
l_int|0xc
)paren
suffix:semicolon
id|l1-&gt;hw-&gt;mr.fifo_rx_trans_enables
(braket
id|l1-&gt;st_num
)braket
op_and_assign
op_complement
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|0x3
suffix:colon
l_int|0xc
)paren
suffix:semicolon
id|l1-&gt;hw-&gt;mr.timer_usg_cnt
op_decrement
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_FIFO
comma
(paren
id|l1-&gt;st_num
op_star
l_int|8
op_plus
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
)paren
)paren
suffix:semicolon
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_IRQ_MSK
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// disable TX interrupts
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_FIFO
comma
(paren
id|l1-&gt;st_num
op_star
l_int|8
op_plus
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|3
)paren
)paren
)paren
suffix:semicolon
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_IRQ_MSK
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// disable RX interrupts
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_ST_SEL
comma
id|l1-&gt;st_num
)paren
suffix:semicolon
id|l1-&gt;hw-&gt;mr.r_ctrl0
op_and_assign
op_complement
(paren
id|bch-&gt;bchan
op_amp
l_int|3
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_ST_CTRL0
comma
id|l1-&gt;hw-&gt;mr.r_ctrl0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|bch-&gt;mode
op_assign
id|L1_MODE_NULL
suffix:semicolon
id|bch-&gt;b_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|bch-&gt;b_if.ifc
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bch-&gt;tx_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|bch-&gt;tx_skb
)paren
suffix:semicolon
id|bch-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bch-&gt;rx_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|bch-&gt;rx_skb
)paren
suffix:semicolon
id|bch-&gt;rx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|skb_queue_purge
c_func
(paren
op_amp
id|bch-&gt;tx_queue
)paren
suffix:semicolon
id|bch-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|bch-&gt;rx_ptr
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// timer is only used when at least one b channel is set up to transparent mode
r_if
c_cond
(paren
id|l1-&gt;hw-&gt;mr.timer_usg_cnt
)paren
(brace
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_IRQMSK_MISC
comma
id|M_TI_IRQMSK
)paren
suffix:semicolon
)brace
r_else
(brace
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_IRQMSK_MISC
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: Unknown B-chan cmd 0x%x received, ignored&bslash;n&quot;
comma
id|pr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|l1-&gt;enabled
)paren
id|bch-&gt;b_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|bch-&gt;b_if.ifc
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* bch_l2l1 */
multiline_comment|/**************************/
multiline_comment|/* layer 1 timer function */
multiline_comment|/**************************/
DECL|function|hfc_l1_timer
r_static
r_void
id|hfc_l1_timer
c_func
(paren
r_struct
id|hfc8s_l1
op_star
id|l1
)paren
(brace
id|u_long
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|l1-&gt;enabled
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l1-&gt;nt_mode
)paren
(brace
id|l1-&gt;l1_state
op_assign
l_int|1
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_ST_SEL
comma
id|l1-&gt;st_num
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_ST_WR_STA
comma
l_int|0x11
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|l1-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1-&gt;d_if.ifc
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|l1-&gt;l1_state
op_assign
l_int|1
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_ST_WR_STA
comma
l_int|0x1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* activation timed out */
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_ST_SEL
comma
id|l1-&gt;st_num
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_ST_WR_STA
comma
l_int|0x13
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|l1-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1-&gt;d_if.ifc
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_ST_SEL
comma
id|l1-&gt;st_num
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_ST_WR_STA
comma
l_int|0x3
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|l1-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* hfc_l1_timer */
multiline_comment|/****************************************/
multiline_comment|/* a complete D-frame has been received */
multiline_comment|/****************************************/
DECL|function|rx_d_frame
r_static
r_void
id|rx_d_frame
c_func
(paren
r_struct
id|hfc8s_l1
op_star
id|l1p
comma
r_int
id|ech
)paren
(brace
r_int
id|z1
comma
id|z2
suffix:semicolon
id|u_char
id|f1
comma
id|f2
comma
id|df
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u_char
op_star
id|cp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|l1p-&gt;enabled
)paren
r_return
suffix:semicolon
r_do
(brace
id|Write_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|R_FIFO
comma
(paren
id|l1p-&gt;st_num
op_star
l_int|8
op_plus
(paren
(paren
id|ech
)paren
ques
c_cond
l_int|7
suffix:colon
l_int|5
)paren
)paren
)paren
suffix:semicolon
singleline_comment|// E/D RX fifo
id|wait_busy
c_func
(paren
id|l1p-&gt;hw
)paren
suffix:semicolon
id|f1
op_assign
id|Read_hfc8_stable
c_func
(paren
id|l1p-&gt;hw
comma
id|A_F1
)paren
suffix:semicolon
id|f2
op_assign
id|Read_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|A_F2
)paren
suffix:semicolon
id|df
op_assign
id|f1
op_minus
id|f2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|f1
op_minus
id|f2
)paren
OL
l_int|0
)paren
id|df
op_assign
id|f1
op_minus
id|f2
op_plus
id|MAX_F_CNT
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|df
)paren
(brace
r_return
suffix:semicolon
singleline_comment|// no complete frame in fifo
)brace
id|z1
op_assign
id|Read_hfc16_stable
c_func
(paren
id|l1p-&gt;hw
comma
id|A_Z1
)paren
suffix:semicolon
id|z2
op_assign
id|Read_hfc16
c_func
(paren
id|l1p-&gt;hw
comma
id|A_Z2
)paren
suffix:semicolon
id|z1
op_assign
id|z1
op_minus
id|z2
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|z1
OL
l_int|0
)paren
id|z1
op_add_assign
l_int|384
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|MAX_D_FRAME_SIZE
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: Could not allocate D/E channel receive buffer&quot;
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|2
)paren
suffix:semicolon
id|wait_busy
c_func
(paren
id|l1p-&gt;hw
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|z1
OL
l_int|4
)paren
op_logical_or
(paren
id|z1
OG
id|MAX_D_FRAME_SIZE
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
singleline_comment|// remove errornous D frame
r_if
c_cond
(paren
id|df
op_eq
l_int|1
)paren
(brace
singleline_comment|// reset fifo
id|Write_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// reset fifo
id|wait_busy
c_func
(paren
id|l1p-&gt;hw
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// read errornous D frame
macro_line|#ifdef FIFO_32BIT_ACCESS
r_while
c_loop
(paren
id|z1
op_ge
l_int|4
)paren
(brace
id|Read_hfc32
c_func
(paren
id|l1p-&gt;hw
comma
id|A_FIFO_DATA0
)paren
suffix:semicolon
id|z1
op_sub_assign
l_int|4
suffix:semicolon
)brace
macro_line|#endif
r_while
c_loop
(paren
id|z1
op_decrement
)paren
id|Read_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|A_FIFO_DATA0
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|1
)paren
suffix:semicolon
id|wait_busy
c_func
(paren
id|l1p-&gt;hw
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|cp
op_assign
id|skb-&gt;data
suffix:semicolon
macro_line|#ifdef FIFO_32BIT_ACCESS
r_while
c_loop
(paren
id|z1
op_ge
l_int|4
)paren
(brace
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|cp
)paren
op_assign
id|Read_hfc32
c_func
(paren
id|l1p-&gt;hw
comma
id|A_FIFO_DATA0
)paren
suffix:semicolon
id|cp
op_add_assign
l_int|4
suffix:semicolon
id|z1
op_sub_assign
l_int|4
suffix:semicolon
)brace
macro_line|#endif
r_while
c_loop
(paren
id|z1
op_decrement
)paren
op_star
id|cp
op_increment
op_assign
id|Read_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|A_FIFO_DATA0
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// increment f counter
id|wait_busy
c_func
(paren
id|l1p-&gt;hw
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
op_decrement
id|cp
)paren
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;len
op_assign
(paren
id|cp
op_minus
id|skb-&gt;data
)paren
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|ech
)paren
id|l1p-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1p-&gt;d_if.ifc
comma
id|PH_DATA_E
op_or
id|INDICATION
comma
id|skb
)paren
suffix:semicolon
r_else
id|l1p-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1p-&gt;d_if.ifc
comma
id|PH_DATA
op_or
id|INDICATION
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* rx_d_frame */
multiline_comment|/*************************************************************/
multiline_comment|/* a B-frame has been received (perhaps not fully completed) */
multiline_comment|/*************************************************************/
DECL|function|rx_b_frame
r_static
r_void
id|rx_b_frame
c_func
(paren
r_struct
id|hfc8s_btype
op_star
id|bch
)paren
(brace
r_int
id|z1
comma
id|z2
comma
id|hdlc_complete
suffix:semicolon
id|u_char
id|f1
comma
id|f2
suffix:semicolon
r_struct
id|hfc8s_l1
op_star
id|l1
op_assign
id|bch-&gt;l1p
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|l1-&gt;enabled
op_logical_or
(paren
id|bch-&gt;mode
op_eq
id|L1_MODE_NULL
)paren
)paren
r_return
suffix:semicolon
r_do
(brace
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_FIFO
comma
(paren
id|l1-&gt;st_num
op_star
l_int|8
op_plus
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|3
)paren
)paren
)paren
suffix:semicolon
singleline_comment|// RX fifo
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bch-&gt;mode
op_eq
id|L1_MODE_HDLC
)paren
(brace
id|f1
op_assign
id|Read_hfc8_stable
c_func
(paren
id|l1-&gt;hw
comma
id|A_F1
)paren
suffix:semicolon
id|f2
op_assign
id|Read_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_F2
)paren
suffix:semicolon
id|hdlc_complete
op_assign
(paren
(paren
id|f1
op_xor
id|f2
)paren
op_amp
id|MAX_F_CNT
)paren
suffix:semicolon
)brace
r_else
id|hdlc_complete
op_assign
l_int|0
suffix:semicolon
id|z1
op_assign
id|Read_hfc16_stable
c_func
(paren
id|l1-&gt;hw
comma
id|A_Z1
)paren
suffix:semicolon
id|z2
op_assign
id|Read_hfc16
c_func
(paren
id|l1-&gt;hw
comma
id|A_Z2
)paren
suffix:semicolon
id|z1
op_assign
(paren
id|z1
op_minus
id|z2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdlc_complete
)paren
id|z1
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|z1
OL
l_int|0
)paren
id|z1
op_add_assign
l_int|384
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|z1
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|bch-&gt;rx_skb
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
(paren
id|bch-&gt;mode
op_eq
id|L1_MODE_TRANS
)paren
ques
c_cond
id|z1
suffix:colon
(paren
id|MAX_B_FRAME_SIZE
op_plus
l_int|3
)paren
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HFC-4S/8S: Could not allocate B channel receive buffer&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bch-&gt;rx_ptr
op_assign
id|skb-&gt;data
suffix:semicolon
id|bch-&gt;rx_skb
op_assign
id|skb
suffix:semicolon
)brace
id|skb-&gt;len
op_assign
(paren
id|bch-&gt;rx_ptr
op_minus
id|skb-&gt;data
)paren
op_plus
id|z1
suffix:semicolon
singleline_comment|// HDLC length check
r_if
c_cond
(paren
(paren
id|bch-&gt;mode
op_eq
id|L1_MODE_HDLC
)paren
op_logical_and
(paren
(paren
id|hdlc_complete
op_logical_and
(paren
id|skb-&gt;len
OL
l_int|4
)paren
)paren
op_logical_or
(paren
id|skb-&gt;len
OG
(paren
id|MAX_B_FRAME_SIZE
op_plus
l_int|3
)paren
)paren
)paren
)paren
(brace
id|skb-&gt;len
op_assign
l_int|0
suffix:semicolon
id|bch-&gt;rx_ptr
op_assign
id|skb-&gt;data
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// reset fifo
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef FIFO_32BIT_ACCESS
r_while
c_loop
(paren
id|z1
op_ge
l_int|4
)paren
(brace
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|bch-&gt;rx_ptr
)paren
op_assign
id|Read_hfc32
c_func
(paren
id|l1-&gt;hw
comma
id|A_FIFO_DATA0
)paren
suffix:semicolon
id|bch-&gt;rx_ptr
op_add_assign
l_int|4
suffix:semicolon
id|z1
op_sub_assign
l_int|4
suffix:semicolon
)brace
macro_line|#endif
r_while
c_loop
(paren
id|z1
op_decrement
)paren
op_star
(paren
id|bch-&gt;rx_ptr
op_increment
)paren
op_assign
id|Read_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_FIFO_DATA0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdlc_complete
)paren
(brace
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// increment f counter
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
singleline_comment|// hdlc crc check
id|bch-&gt;rx_ptr
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_star
id|bch-&gt;rx_ptr
)paren
(brace
id|skb-&gt;len
op_assign
l_int|0
suffix:semicolon
id|bch-&gt;rx_ptr
op_assign
id|skb-&gt;data
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb-&gt;len
op_sub_assign
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdlc_complete
op_logical_or
(paren
id|bch-&gt;mode
op_eq
id|L1_MODE_TRANS
)paren
)paren
(brace
id|bch-&gt;rx_skb
op_assign
l_int|NULL
suffix:semicolon
id|bch-&gt;rx_ptr
op_assign
l_int|NULL
suffix:semicolon
id|bch-&gt;b_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|bch-&gt;b_if.ifc
comma
id|PH_DATA
op_or
id|INDICATION
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* rx_b_frame */
multiline_comment|/********************************************/
multiline_comment|/* a D-frame has been/should be transmitted */
multiline_comment|/********************************************/
DECL|function|tx_d_frame
r_static
r_void
id|tx_d_frame
c_func
(paren
r_struct
id|hfc8s_l1
op_star
id|l1p
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u_char
id|f1
comma
id|f2
suffix:semicolon
id|u_char
op_star
id|cp
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_if
c_cond
(paren
id|l1p-&gt;l1_state
op_ne
l_int|7
)paren
r_return
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|R_FIFO
comma
(paren
id|l1p-&gt;st_num
op_star
l_int|8
op_plus
l_int|4
)paren
)paren
suffix:semicolon
singleline_comment|// TX fifo
id|wait_busy
c_func
(paren
id|l1p-&gt;hw
)paren
suffix:semicolon
id|f1
op_assign
id|Read_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|A_F1
)paren
suffix:semicolon
id|f2
op_assign
id|Read_hfc8_stable
c_func
(paren
id|l1p-&gt;hw
comma
id|A_F2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|f1
op_xor
id|f2
)paren
op_amp
id|MAX_F_CNT
)paren
r_return
suffix:semicolon
singleline_comment|// fifo is still filled
r_if
c_cond
(paren
id|l1p-&gt;tx_cnt
OG
l_int|0
)paren
(brace
id|cnt
op_assign
id|l1p-&gt;tx_cnt
suffix:semicolon
id|l1p-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|l1p-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1p-&gt;d_if.ifc
comma
id|PH_DATA
op_or
id|CONFIRM
comma
(paren
r_void
op_star
)paren
id|cnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|l1p-&gt;d_tx_queue
)paren
)paren
)paren
(brace
id|cp
op_assign
id|skb-&gt;data
suffix:semicolon
id|cnt
op_assign
id|skb-&gt;len
suffix:semicolon
macro_line|#ifdef FIFO_32BIT_ACCESS
r_while
c_loop
(paren
id|cnt
op_ge
l_int|4
)paren
(brace
id|Write_hfc32
c_func
(paren
id|l1p-&gt;hw
comma
id|A_FIFO_DATA0
comma
op_star
(paren
r_int
r_int
op_star
)paren
id|cp
)paren
suffix:semicolon
id|cp
op_add_assign
l_int|4
suffix:semicolon
id|cnt
op_sub_assign
l_int|4
suffix:semicolon
)brace
macro_line|#endif
r_while
c_loop
(paren
id|cnt
op_decrement
)paren
id|fWrite_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|A_FIFO_DATA0
comma
op_star
id|cp
op_increment
)paren
suffix:semicolon
id|l1p-&gt;tx_cnt
op_assign
id|skb-&gt;truesize
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// increment f counter
id|wait_busy
c_func
(paren
id|l1p-&gt;hw
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* tx_d_frame */
multiline_comment|/******************************************************/
multiline_comment|/* a B-frame may be transmitted (or is not completed) */
multiline_comment|/******************************************************/
DECL|function|tx_b_frame
r_static
r_void
id|tx_b_frame
c_func
(paren
r_struct
id|hfc8s_btype
op_star
id|bch
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|hfc8s_l1
op_star
id|l1
op_assign
id|bch-&gt;l1p
suffix:semicolon
id|u_char
op_star
id|cp
suffix:semicolon
r_int
id|cnt
comma
id|max
comma
id|hdlc_num
comma
id|ack_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|l1-&gt;enabled
op_logical_or
(paren
id|bch-&gt;mode
op_eq
id|L1_MODE_NULL
)paren
)paren
r_return
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_FIFO
comma
(paren
id|l1-&gt;st_num
op_star
l_int|8
op_plus
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
)paren
)paren
suffix:semicolon
singleline_comment|// TX fifo
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|bch-&gt;mode
op_eq
id|L1_MODE_HDLC
)paren
(brace
id|hdlc_num
op_assign
id|Read_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_F1
)paren
op_amp
id|MAX_F_CNT
suffix:semicolon
id|hdlc_num
op_sub_assign
(paren
id|Read_hfc8_stable
c_func
(paren
id|l1-&gt;hw
comma
id|A_F2
)paren
op_amp
id|MAX_F_CNT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdlc_num
OL
l_int|0
)paren
id|hdlc_num
op_add_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|hdlc_num
op_ge
l_int|15
)paren
r_break
suffix:semicolon
singleline_comment|// fifo still filled up with hdlc frames
)brace
r_else
id|hdlc_num
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|bch-&gt;tx_skb
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|bch-&gt;tx_queue
)paren
)paren
)paren
(brace
id|l1-&gt;hw-&gt;mr.fifo_slow_timer_service
(braket
id|l1-&gt;st_num
)braket
op_and_assign
op_complement
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// list empty
)brace
id|bch-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|bch-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hdlc_num
)paren
id|l1-&gt;hw-&gt;mr.fifo_slow_timer_service
(braket
id|l1-&gt;st_num
)braket
op_or_assign
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|4
)paren
suffix:semicolon
r_else
id|l1-&gt;hw-&gt;mr.fifo_slow_timer_service
(braket
id|l1-&gt;st_num
)braket
op_and_assign
op_complement
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|4
)paren
suffix:semicolon
id|max
op_assign
id|Read_hfc16_stable
c_func
(paren
id|l1-&gt;hw
comma
id|A_Z2
)paren
suffix:semicolon
id|max
op_sub_assign
id|Read_hfc16
c_func
(paren
id|l1-&gt;hw
comma
id|A_Z1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max
op_le
l_int|0
)paren
id|max
op_add_assign
l_int|384
suffix:semicolon
id|max
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|max
OL
l_int|16
)paren
r_break
suffix:semicolon
singleline_comment|// don&squot;t write to small amounts of bytes
id|cnt
op_assign
id|skb-&gt;len
op_minus
id|bch-&gt;tx_cnt
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|max
)paren
id|cnt
op_assign
id|max
suffix:semicolon
id|cp
op_assign
id|skb-&gt;data
op_plus
id|bch-&gt;tx_cnt
suffix:semicolon
id|bch-&gt;tx_cnt
op_add_assign
id|cnt
suffix:semicolon
macro_line|#ifdef FIFO_32BIT_ACCESS
r_while
c_loop
(paren
id|cnt
op_ge
l_int|4
)paren
(brace
id|Write_hfc32
c_func
(paren
id|l1-&gt;hw
comma
id|A_FIFO_DATA0
comma
op_star
(paren
r_int
r_int
op_star
)paren
id|cp
)paren
suffix:semicolon
id|cp
op_add_assign
l_int|4
suffix:semicolon
id|cnt
op_sub_assign
l_int|4
suffix:semicolon
)brace
macro_line|#endif
r_while
c_loop
(paren
id|cnt
op_decrement
)paren
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|A_FIFO_DATA0
comma
op_star
id|cp
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bch-&gt;tx_cnt
op_ge
id|skb-&gt;len
)paren
(brace
r_if
c_cond
(paren
id|bch-&gt;mode
op_eq
id|L1_MODE_HDLC
)paren
(brace
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_INC_RES_FIFO
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// increment f counter
)brace
id|ack_len
op_add_assign
id|skb-&gt;truesize
suffix:semicolon
id|bch-&gt;tx_skb
op_assign
l_int|0
suffix:semicolon
id|bch-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
id|Write_hfc8
c_func
(paren
id|l1-&gt;hw
comma
id|R_FIFO
comma
(paren
id|l1-&gt;st_num
op_star
l_int|8
op_plus
(paren
(paren
id|bch-&gt;bchan
op_eq
l_int|1
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
)paren
)paren
suffix:semicolon
singleline_comment|// Re-Select
id|wait_busy
c_func
(paren
id|l1-&gt;hw
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ack_len
)paren
id|bch-&gt;b_if.ifc
dot
id|l1l2
c_func
(paren
(paren
r_struct
id|hisax_if
op_star
)paren
op_amp
id|bch-&gt;b_if
comma
id|PH_DATA
op_or
id|CONFIRM
comma
(paren
r_void
op_star
)paren
id|ack_len
)paren
suffix:semicolon
)brace
multiline_comment|/* tx_b_frame */
multiline_comment|/*************************************/
multiline_comment|/* bottom half handler for interrupt */
multiline_comment|/*************************************/
DECL|function|hfc8s_bh
r_static
r_void
id|hfc8s_bh
c_func
(paren
r_struct
id|hfc8s_hw
op_star
id|hw
)paren
(brace
id|u_char
id|b
suffix:semicolon
r_struct
id|hfc8s_l1
op_star
id|l1p
suffix:semicolon
r_volatile
id|u_char
op_star
id|fifo_stat
suffix:semicolon
r_int
id|idx
suffix:semicolon
singleline_comment|// handle layer 1 state changes
id|b
op_assign
l_int|1
suffix:semicolon
id|l1p
op_assign
id|hw-&gt;l1
suffix:semicolon
r_while
c_loop
(paren
id|b
)paren
(brace
r_if
c_cond
(paren
(paren
id|b
op_amp
id|hw-&gt;mr.r_irq_statech
)paren
)paren
(brace
id|hw-&gt;mr.r_irq_statech
op_and_assign
op_complement
id|b
suffix:semicolon
singleline_comment|// reset l1 event
r_if
c_cond
(paren
id|l1p-&gt;enabled
)paren
(brace
r_if
c_cond
(paren
id|l1p-&gt;nt_mode
)paren
(brace
id|u_char
id|oldstate
op_assign
id|l1p-&gt;l1_state
suffix:semicolon
singleline_comment|// save old l1 state
id|Write_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|R_ST_SEL
comma
id|l1p-&gt;st_num
)paren
suffix:semicolon
id|l1p-&gt;l1_state
op_assign
id|Read_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|A_ST_RD_STA
)paren
op_amp
l_int|0xf
suffix:semicolon
singleline_comment|// new state
r_if
c_cond
(paren
(paren
id|oldstate
op_eq
l_int|3
)paren
op_logical_and
(paren
id|l1p-&gt;l1_state
op_ne
l_int|3
)paren
)paren
id|l1p-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1p-&gt;d_if.ifc
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l1p-&gt;l1_state
op_ne
l_int|2
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|l1p-&gt;l1_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l1p-&gt;l1_state
op_eq
l_int|3
)paren
(brace
id|l1p-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1p-&gt;d_if.ifc
comma
id|PH_ACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_ST_WR_STA
comma
id|M_SET_G2_G3
)paren
suffix:semicolon
singleline_comment|// allow transition
id|mod_timer
c_func
(paren
op_amp
id|l1p-&gt;l1_timer
comma
id|jiffies
op_plus
id|L1_TIMER_T1
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: NT ch %d l1 state %d -&gt; %d&bslash;n&quot;
comma
id|l1p-&gt;st_num
comma
id|oldstate
comma
id|l1p-&gt;l1_state
)paren
suffix:semicolon
)brace
r_else
(brace
id|u_char
id|oldstate
op_assign
id|l1p-&gt;l1_state
suffix:semicolon
singleline_comment|// save old l1 state
id|Write_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|R_ST_SEL
comma
id|l1p-&gt;st_num
)paren
suffix:semicolon
id|l1p-&gt;l1_state
op_assign
id|Read_hfc8
c_func
(paren
id|l1p-&gt;hw
comma
id|A_ST_RD_STA
)paren
op_amp
l_int|0xf
suffix:semicolon
singleline_comment|// new state
r_if
c_cond
(paren
(paren
(paren
id|l1p-&gt;l1_state
op_eq
l_int|3
)paren
op_logical_and
(paren
(paren
id|oldstate
op_eq
l_int|7
)paren
op_logical_or
(paren
id|oldstate
op_eq
l_int|8
)paren
)paren
)paren
op_logical_or
(paren
(paren
id|timer_pending
c_func
(paren
op_amp
id|l1p-&gt;l1_timer
)paren
)paren
op_logical_and
(paren
id|l1p-&gt;l1_state
op_eq
l_int|8
)paren
)paren
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|l1p-&gt;l1_timer
comma
id|L1_TIMER_T4
op_plus
id|jiffies
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|l1p-&gt;l1_state
op_eq
l_int|7
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|l1p-&gt;l1_timer
)paren
suffix:semicolon
multiline_comment|/* no longer needed */
id|l1p-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1p-&gt;d_if.ifc
comma
id|PH_ACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
id|tx_d_frame
c_func
(paren
id|l1p
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|l1p-&gt;l1_state
op_eq
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|oldstate
op_ne
l_int|3
)paren
id|l1p-&gt;d_if.ifc
dot
id|l1l2
c_func
(paren
op_amp
id|l1p-&gt;d_if.ifc
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: TE %d ch %d l1 state %d -&gt; %d&bslash;n&quot;
comma
id|l1p-&gt;hw
op_minus
id|hfc8s
comma
id|l1p-&gt;st_num
comma
id|oldstate
comma
id|l1p-&gt;l1_state
)paren
suffix:semicolon
)brace
)brace
)brace
id|b
op_lshift_assign
l_int|1
suffix:semicolon
id|l1p
op_increment
suffix:semicolon
)brace
singleline_comment|// now handle the fifos
id|idx
op_assign
l_int|0
suffix:semicolon
id|fifo_stat
op_assign
id|hw-&gt;mr.r_irq_fifo_blx
suffix:semicolon
id|l1p
op_assign
id|hw-&gt;l1
suffix:semicolon
r_while
c_loop
(paren
id|idx
OL
id|hw-&gt;max_st_ports
)paren
(brace
r_if
c_cond
(paren
id|hw-&gt;mr.timer_irq
)paren
(brace
op_star
id|fifo_stat
op_or_assign
id|hw-&gt;mr.fifo_rx_trans_enables
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;fifo_sched_cnt
op_le
l_int|0
)paren
(brace
op_star
id|fifo_stat
op_or_assign
id|hw-&gt;mr.fifo_slow_timer_service
(braket
id|l1p-&gt;st_num
)braket
suffix:semicolon
)brace
)brace
singleline_comment|// ignore fifo 6 (TX E fifo)
op_star
id|fifo_stat
op_and_assign
l_int|0xff
op_minus
l_int|0x40
suffix:semicolon
r_while
c_loop
(paren
op_star
id|fifo_stat
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|l1p-&gt;nt_mode
)paren
(brace
singleline_comment|// RX Fifo has data to read
r_if
c_cond
(paren
(paren
op_star
id|fifo_stat
op_amp
l_int|0x20
)paren
)paren
(brace
op_star
id|fifo_stat
op_and_assign
op_complement
l_int|0x20
suffix:semicolon
id|rx_d_frame
c_func
(paren
id|l1p
comma
l_int|0
)paren
suffix:semicolon
)brace
singleline_comment|// E Fifo has data to read
r_if
c_cond
(paren
(paren
op_star
id|fifo_stat
op_amp
l_int|0x80
)paren
)paren
(brace
op_star
id|fifo_stat
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
id|rx_d_frame
c_func
(paren
id|l1p
comma
l_int|1
)paren
suffix:semicolon
)brace
singleline_comment|// TX Fifo completed send
r_if
c_cond
(paren
(paren
op_star
id|fifo_stat
op_amp
l_int|0x10
)paren
)paren
(brace
op_star
id|fifo_stat
op_and_assign
op_complement
l_int|0x10
suffix:semicolon
id|tx_d_frame
c_func
(paren
id|l1p
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// B1 RX Fifo has data to read
r_if
c_cond
(paren
(paren
op_star
id|fifo_stat
op_amp
l_int|0x2
)paren
)paren
(brace
op_star
id|fifo_stat
op_and_assign
op_complement
l_int|0x2
suffix:semicolon
id|rx_b_frame
c_func
(paren
id|l1p-&gt;b_ch
)paren
suffix:semicolon
)brace
singleline_comment|// B1 TX Fifo has send completed
r_if
c_cond
(paren
(paren
op_star
id|fifo_stat
op_amp
l_int|0x1
)paren
)paren
(brace
op_star
id|fifo_stat
op_and_assign
op_complement
l_int|0x1
suffix:semicolon
id|tx_b_frame
c_func
(paren
id|l1p-&gt;b_ch
)paren
suffix:semicolon
)brace
singleline_comment|// B2 RX Fifo has data to read
r_if
c_cond
(paren
(paren
op_star
id|fifo_stat
op_amp
l_int|0x8
)paren
)paren
(brace
op_star
id|fifo_stat
op_and_assign
op_complement
l_int|0x8
suffix:semicolon
id|rx_b_frame
c_func
(paren
id|l1p-&gt;b_ch
op_plus
l_int|1
)paren
suffix:semicolon
)brace
singleline_comment|// B2 TX Fifo has send completed
r_if
c_cond
(paren
(paren
op_star
id|fifo_stat
op_amp
l_int|0x4
)paren
)paren
(brace
op_star
id|fifo_stat
op_and_assign
op_complement
l_int|0x4
suffix:semicolon
id|tx_b_frame
c_func
(paren
id|l1p-&gt;b_ch
op_plus
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|fifo_stat
op_increment
suffix:semicolon
id|l1p
op_increment
suffix:semicolon
id|idx
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw-&gt;fifo_sched_cnt
op_le
l_int|0
)paren
id|hw-&gt;fifo_sched_cnt
op_add_assign
(paren
l_int|1
op_lshift
(paren
l_int|7
op_minus
id|TRANS_TIMER_MODE
)paren
)paren
suffix:semicolon
id|hw-&gt;mr.timer_irq
op_assign
l_int|0
suffix:semicolon
singleline_comment|// clear requested timer irq
)brace
multiline_comment|/* hfc8s_bh */
multiline_comment|/*********************/
multiline_comment|/* interrupt handler */
multiline_comment|/*********************/
DECL|function|hfc8s_interrupt
r_static
id|irqreturn_t
id|hfc8s_interrupt
c_func
(paren
r_int
id|intno
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|hfc8s_hw
op_star
id|hw
op_assign
id|dev_id
suffix:semicolon
id|u_char
id|b
comma
id|ovr
suffix:semicolon
r_volatile
id|u_char
op_star
id|ovp
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hw
op_logical_or
op_logical_neg
(paren
id|hw-&gt;mr.r_irq_ctrl
op_amp
id|M_GLOB_IRQ_EN
)paren
)paren
r_return
id|IRQ_NONE
suffix:semicolon
suffix:semicolon
multiline_comment|/* Layer 1 State change */
id|hw-&gt;mr.r_irq_statech
op_or_assign
(paren
id|Read_hfc8
c_func
(paren
id|hw
comma
id|R_IRQ_STATECH
)paren
op_amp
id|hw-&gt;mr.r_irqmsk_statchg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|b
op_assign
(paren
id|Read_hfc8
c_func
(paren
id|hw
comma
id|R_STATUS
)paren
op_amp
(paren
id|M_MISC_IRQSTA
op_or
id|M_FR_IRQSTA
)paren
)paren
)paren
op_logical_and
op_logical_neg
id|hw-&gt;mr.r_irq_statech
)paren
r_return
id|IRQ_NONE
suffix:semicolon
multiline_comment|/* timer event */
r_if
c_cond
(paren
id|Read_hfc8
c_func
(paren
id|hw
comma
id|R_IRQ_MISC
)paren
op_amp
id|M_TI_IRQ
)paren
(brace
id|hw-&gt;mr.timer_irq
op_assign
l_int|1
suffix:semicolon
id|hw-&gt;fifo_sched_cnt
op_decrement
suffix:semicolon
)brace
multiline_comment|/* FIFO event */
r_if
c_cond
(paren
(paren
id|ovr
op_assign
id|Read_hfc8
c_func
(paren
id|hw
comma
id|R_IRQ_OVIEW
)paren
)paren
)paren
(brace
id|hw-&gt;mr.r_irq_oview
op_or_assign
id|ovr
suffix:semicolon
id|idx
op_assign
id|R_IRQ_FIFO_BL0
suffix:semicolon
id|ovp
op_assign
id|hw-&gt;mr.r_irq_fifo_blx
suffix:semicolon
r_while
c_loop
(paren
id|ovr
)paren
(brace
r_if
c_cond
(paren
(paren
id|ovr
op_amp
l_int|1
)paren
)paren
(brace
op_star
id|ovp
op_or_assign
id|Read_hfc8
c_func
(paren
id|hw
comma
id|idx
)paren
suffix:semicolon
)brace
id|ovp
op_increment
suffix:semicolon
id|idx
op_increment
suffix:semicolon
id|ovr
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* queue the request to allow other cards to interrupt */
id|schedule_work
c_func
(paren
op_amp
id|hw-&gt;tqueue
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* hfc8s_interrupt */
multiline_comment|/***********************************************************************/
multiline_comment|/* reset the complete chip, don&squot;t release the chips irq but disable it */
multiline_comment|/***********************************************************************/
DECL|function|chipreset
r_static
r_void
id|chipreset
c_func
(paren
r_struct
id|hfc8s_hw
op_star
id|hw
)paren
(brace
id|u_long
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hw-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_CTRL
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// use internal RAM
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_RAM_SZ
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// 32k*8 RAM
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_FIFO_MD
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// fifo mode 386 byte/fifo simple mode
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_CIRM
comma
id|M_SRES
)paren
suffix:semicolon
singleline_comment|// reset chip
id|hw-&gt;mr.r_irq_ctrl
op_assign
l_int|0
suffix:semicolon
singleline_comment|// interrupt is inactive
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hw-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_CIRM
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// disable reset
id|wait_busy
c_func
(paren
id|hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_PCM_MD0
comma
id|M_PCM_MD
)paren
suffix:semicolon
singleline_comment|// master mode
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_RAM_SZ
comma
id|V_FZ_MD
)paren
suffix:semicolon
singleline_comment|// transmit fifo option
r_if
c_cond
(paren
id|hw-&gt;clock_mode
op_eq
l_int|1
)paren
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_BRG_PCM_CFG
comma
id|M_PCM_CLK
)paren
suffix:semicolon
singleline_comment|// PCM clk / 2
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_TI_WD
comma
id|TRANS_TIMER_MODE
)paren
suffix:semicolon
singleline_comment|// timer interval
id|memset
c_func
(paren
op_amp
id|hw-&gt;mr
comma
l_int|0
comma
r_sizeof
(paren
id|hw-&gt;mr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* chipreset */
multiline_comment|/********************************************/
multiline_comment|/* disable/enable hardware in nt or te mode */
multiline_comment|/********************************************/
DECL|function|hfc_hardware_enable
r_void
id|hfc_hardware_enable
c_func
(paren
r_struct
id|hfc8s_hw
op_star
id|hw
comma
r_int
id|enable
comma
r_int
id|nt_mode
)paren
(brace
id|u_long
id|flags
suffix:semicolon
r_char
id|if_name
(braket
l_int|40
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|enable
)paren
(brace
singleline_comment|// save system vars
id|hw-&gt;nt_mode
op_assign
id|nt_mode
suffix:semicolon
singleline_comment|// enable fifo and state irqs, but not global irq enable
id|hw-&gt;mr.r_irq_ctrl
op_assign
id|M_FIFO_IRQ
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_IRQ_CTRL
comma
id|hw-&gt;mr.r_irq_ctrl
)paren
suffix:semicolon
id|hw-&gt;mr.r_irqmsk_statchg
op_assign
l_int|0
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_IRQMSK_STATCHG
comma
id|hw-&gt;mr.r_irqmsk_statchg
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_PWM_MD
comma
l_int|0x80
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_PWM1
comma
l_int|26
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nt_mode
)paren
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_ST_SYNC
comma
id|M_AUTO_SYNC
)paren
suffix:semicolon
singleline_comment|// enable the line interfaces and fifos
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hw-&gt;max_st_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hw-&gt;mr.r_irqmsk_statchg
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_IRQMSK_STATCHG
comma
id|hw-&gt;mr.r_irqmsk_statchg
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_ST_SEL
comma
id|i
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_ST_CLK_DLY
comma
(paren
(paren
id|nt_mode
)paren
ques
c_cond
id|CLKDEL_NT
suffix:colon
id|CLKDEL_TE
)paren
)paren
suffix:semicolon
id|hw-&gt;mr.r_ctrl0
op_assign
(paren
(paren
id|nt_mode
)paren
ques
c_cond
id|CTRL0_NT
suffix:colon
id|CTRL0_TE
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_ST_CTRL0
comma
id|hw-&gt;mr.r_ctrl0
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_ST_CTRL2
comma
l_int|3
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_ST_WR_STA
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// enable state machine
id|hw-&gt;l1
(braket
id|i
)braket
dot
id|enabled
op_assign
l_int|1
suffix:semicolon
id|hw-&gt;l1
(braket
id|i
)braket
dot
id|nt_mode
op_assign
id|nt_mode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nt_mode
)paren
(brace
singleline_comment|// setup E-fifo
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_FIFO
comma
id|i
op_star
l_int|8
op_plus
l_int|7
)paren
suffix:semicolon
singleline_comment|// E fifo
id|wait_busy
c_func
(paren
id|hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_CON_HDLC
comma
l_int|0x11
)paren
suffix:semicolon
singleline_comment|// HDLC mode, 1 fill, connect ST
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_SUBCH_CFG
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// only 2 bits
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_IRQ_MSK
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// enable interrupt
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_INC_RES_FIFO
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// reset fifo
id|wait_busy
c_func
(paren
id|hw
)paren
suffix:semicolon
singleline_comment|// setup D RX-fifo
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_FIFO
comma
id|i
op_star
l_int|8
op_plus
l_int|5
)paren
suffix:semicolon
singleline_comment|// RX fifo
id|wait_busy
c_func
(paren
id|hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_CON_HDLC
comma
l_int|0x11
)paren
suffix:semicolon
singleline_comment|// HDLC mode, 1 fill, connect ST
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_SUBCH_CFG
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// only 2 bits
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_IRQ_MSK
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// enable interrupt
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_INC_RES_FIFO
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// reset fifo
id|wait_busy
c_func
(paren
id|hw
)paren
suffix:semicolon
singleline_comment|// setup D TX-fifo
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_FIFO
comma
id|i
op_star
l_int|8
op_plus
l_int|4
)paren
suffix:semicolon
singleline_comment|// TX fifo
id|wait_busy
c_func
(paren
id|hw
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_CON_HDLC
comma
l_int|0x11
)paren
suffix:semicolon
singleline_comment|// HDLC mode, 1 fill, connect ST
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_SUBCH_CFG
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// only 2 bits
id|Write_hfc8
c_func
(paren
id|hw
comma
id|A_IRQ_MSK
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// enable interrupt
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_INC_RES_FIFO
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// reset fifo
id|wait_busy
c_func
(paren
id|hw
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|if_name
comma
l_string|&quot;hfc4s8s_%d%d_&quot;
comma
id|hw
op_minus
id|hfc8s
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hisax_register
c_func
(paren
op_amp
id|hw-&gt;l1
(braket
id|i
)braket
dot
id|d_if
comma
id|hw-&gt;l1
(braket
id|i
)braket
dot
id|b_table
comma
id|if_name
comma
(paren
(paren
id|nt_mode
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|2
)paren
)paren
)paren
(brace
id|hw-&gt;l1
(braket
id|i
)braket
dot
id|enabled
op_assign
l_int|0
suffix:semicolon
id|hw-&gt;mr.r_irqmsk_statchg
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_IRQMSK_STATCHG
comma
id|hw-&gt;mr.r_irqmsk_statchg
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: Unable to register S/T device %s, break&bslash;n&quot;
comma
id|if_name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hw-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|hw-&gt;mr.r_irq_ctrl
op_or_assign
id|M_GLOB_IRQ_EN
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_IRQ_CTRL
comma
id|hw-&gt;mr.r_irq_ctrl
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hw-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hw-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|hw-&gt;mr.r_irq_ctrl
op_and_assign
op_complement
id|M_GLOB_IRQ_EN
suffix:semicolon
id|Write_hfc8
c_func
(paren
id|hw
comma
id|R_IRQ_CTRL
comma
id|hw-&gt;mr.r_irq_ctrl
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hw-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|hw-&gt;max_st_ports
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|hw-&gt;l1
(braket
id|i
)braket
dot
id|enabled
op_assign
l_int|0
suffix:semicolon
id|hisax_unregister
c_func
(paren
op_amp
id|hw-&gt;l1
(braket
id|i
)braket
dot
id|d_if
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|hw-&gt;l1
(braket
id|i
)braket
dot
id|l1_timer
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|hw-&gt;l1
(braket
id|i
)braket
dot
id|d_tx_queue
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|hw-&gt;l1
(braket
id|i
)braket
dot
id|b_ch
(braket
l_int|0
)braket
dot
id|tx_queue
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|hw-&gt;l1
(braket
id|i
)braket
dot
id|b_ch
(braket
l_int|1
)braket
dot
id|tx_queue
)paren
suffix:semicolon
)brace
id|chipreset
c_func
(paren
id|hw
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* hfc_hardware_enable */
multiline_comment|/*************************************/
multiline_comment|/* initialise the HFC-4s/8s hardware */
multiline_comment|/* return 0 on success.              */
multiline_comment|/*************************************/
DECL|function|hfc8s_init_hw
r_static
r_int
id|__init
id|hfc8s_init_hw
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|tmp_hfc8s
op_assign
l_int|NULL
suffix:semicolon
id|PCI_ENTRY
op_star
id|list
op_assign
(paren
id|PCI_ENTRY
op_star
)paren
id|id_list
suffix:semicolon
r_struct
id|hfc8s_hw
op_star
id|hw
op_assign
id|hfc8s
suffix:semicolon
id|u_long
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Layer 1 driver module for HFC-4S/8S isdn chips, %s&bslash;n&quot;
comma
id|hfc4s8s_rev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;(C) 2003 Cornelius Consult, www.cornelius-consult.de&bslash;n&quot;
)paren
suffix:semicolon
r_do
(brace
id|spin_lock_init
c_func
(paren
op_amp
id|hw-&gt;lock
)paren
suffix:semicolon
id|tmp_hfc8s
op_assign
id|pci_find_device
c_func
(paren
id|list-&gt;vendor_id
comma
id|list-&gt;device_id
comma
id|tmp_hfc8s
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp_hfc8s
)paren
(brace
id|list
op_increment
suffix:semicolon
singleline_comment|// next PCI-ID
r_if
c_cond
(paren
op_logical_neg
id|list-&gt;vendor_id
)paren
r_break
suffix:semicolon
singleline_comment|// end of list
r_continue
suffix:semicolon
singleline_comment|// search PCI base again
)brace
r_if
c_cond
(paren
id|list-&gt;sub_vendor_id
op_logical_and
(paren
id|list-&gt;sub_vendor_id
op_ne
id|tmp_hfc8s-&gt;subsystem_vendor
)paren
)paren
r_continue
suffix:semicolon
singleline_comment|// sub_vendor defined and not matching
r_if
c_cond
(paren
id|list-&gt;sub_device_id
op_logical_and
(paren
id|list-&gt;sub_device_id
op_ne
id|tmp_hfc8s-&gt;subsystem_device
)paren
)paren
r_continue
suffix:semicolon
singleline_comment|// sub_device defined and not matching
singleline_comment|// init Layer 1 structure
r_if
c_cond
(paren
id|tmp_hfc8s-&gt;irq
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: found PCI card without assigned IRQ, card ignored&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|tmp_hfc8s
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: Error enabling PCI card, card ignored&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|hw-&gt;irq
op_assign
id|tmp_hfc8s-&gt;irq
suffix:semicolon
id|hw-&gt;max_st_ports
op_assign
id|list-&gt;max_channels
suffix:semicolon
id|hw-&gt;max_fifo
op_assign
id|list-&gt;max_channels
op_star
l_int|4
suffix:semicolon
id|hw-&gt;clock_mode
op_assign
id|list-&gt;clock_mode
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HFC_MAX_ST
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|hfc8s_l1
op_star
id|l1p
suffix:semicolon
id|l1p
op_assign
id|hw-&gt;l1
op_plus
id|i
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|l1p-&gt;lock
)paren
suffix:semicolon
id|l1p-&gt;hw
op_assign
id|hw
suffix:semicolon
id|l1p-&gt;l1_timer.function
op_assign
(paren
r_void
op_star
)paren
id|hfc_l1_timer
suffix:semicolon
id|l1p-&gt;l1_timer.data
op_assign
(paren
r_int
)paren
(paren
id|l1p
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|l1p-&gt;l1_timer
)paren
suffix:semicolon
id|l1p-&gt;st_num
op_assign
id|i
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|l1p-&gt;d_tx_queue
)paren
suffix:semicolon
id|l1p-&gt;d_if.ifc.priv
op_assign
id|hw-&gt;l1
op_plus
id|i
suffix:semicolon
id|l1p-&gt;d_if.ifc.l2l1
op_assign
(paren
r_void
op_star
)paren
id|dch_l2l1
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|l1p-&gt;b_ch
(braket
l_int|0
)braket
dot
id|lock
)paren
suffix:semicolon
id|l1p-&gt;b_ch
(braket
l_int|0
)braket
dot
id|b_if.ifc.l2l1
op_assign
(paren
r_void
op_star
)paren
id|bch_l2l1
suffix:semicolon
id|l1p-&gt;b_ch
(braket
l_int|0
)braket
dot
id|b_if.ifc.priv
op_assign
(paren
r_void
op_star
)paren
op_amp
id|l1p-&gt;b_ch
(braket
l_int|0
)braket
suffix:semicolon
id|l1p-&gt;b_ch
(braket
l_int|0
)braket
dot
id|l1p
op_assign
id|hw-&gt;l1
op_plus
id|i
suffix:semicolon
id|l1p-&gt;b_ch
(braket
l_int|0
)braket
dot
id|bchan
op_assign
l_int|1
suffix:semicolon
id|l1p-&gt;b_table
(braket
l_int|0
)braket
op_assign
op_amp
id|l1p-&gt;b_ch
(braket
l_int|0
)braket
dot
id|b_if
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|l1p-&gt;b_ch
(braket
l_int|0
)braket
dot
id|tx_queue
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|l1p-&gt;b_ch
(braket
l_int|1
)braket
dot
id|lock
)paren
suffix:semicolon
id|l1p-&gt;b_ch
(braket
l_int|1
)braket
dot
id|b_if.ifc.l2l1
op_assign
(paren
r_void
op_star
)paren
id|bch_l2l1
suffix:semicolon
id|l1p-&gt;b_ch
(braket
l_int|1
)braket
dot
id|b_if.ifc.priv
op_assign
(paren
r_void
op_star
)paren
op_amp
id|l1p-&gt;b_ch
(braket
l_int|1
)braket
suffix:semicolon
id|l1p-&gt;b_ch
(braket
l_int|1
)braket
dot
id|l1p
op_assign
id|hw-&gt;l1
op_plus
id|i
suffix:semicolon
id|l1p-&gt;b_ch
(braket
l_int|1
)braket
dot
id|bchan
op_assign
l_int|2
suffix:semicolon
id|l1p-&gt;b_table
(braket
l_int|1
)braket
op_assign
op_amp
id|l1p-&gt;b_ch
(braket
l_int|1
)braket
dot
id|b_if
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|l1p-&gt;b_ch
(braket
l_int|1
)braket
dot
id|tx_queue
)paren
suffix:semicolon
)brace
id|hw-&gt;iobase
op_assign
id|tmp_hfc8s-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|hw-&gt;hw_membase
op_assign
(paren
id|u_char
op_star
)paren
id|tmp_hfc8s-&gt;resource
(braket
l_int|1
)braket
dot
id|start
suffix:semicolon
id|hw-&gt;membase
op_assign
id|ioremap
c_func
(paren
(paren
id|ulong
)paren
id|hw-&gt;hw_membase
comma
l_int|256
)paren
suffix:semicolon
id|hw-&gt;pci_dev
op_assign
id|tmp_hfc8s
suffix:semicolon
multiline_comment|/* now enable memory mapped ports */
id|pci_write_config_word
c_func
(paren
id|hw-&gt;pci_dev
comma
id|PCI_COMMAND
comma
id|PCI_ENA_MEMIO
)paren
suffix:semicolon
id|chipreset
c_func
(paren
id|hw
)paren
suffix:semicolon
id|i
op_assign
id|Read_hfc8
c_func
(paren
id|hw
comma
id|R_CHIP_ID
)paren
op_rshift
id|CHIP_ID_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|list-&gt;chip_id
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: invalid chip id 0x%x instead of 0x%x, card ignored&bslash;n&quot;
comma
id|i
comma
id|list-&gt;chip_id
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|hw-&gt;pci_dev
comma
id|PCI_COMMAND
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable memory mapped ports */
id|vfree
c_func
(paren
id|hw-&gt;membase
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|i
op_assign
id|Read_hfc8
c_func
(paren
id|hw
comma
id|R_CHIP_RV
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: chip revision 0 not supported, card ignored&bslash;n&quot;
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|hw-&gt;pci_dev
comma
id|PCI_COMMAND
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable memory mapped ports */
id|vfree
c_func
(paren
id|hw-&gt;membase
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|INIT_WORK
c_func
(paren
op_amp
id|hw-&gt;tqueue
comma
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|hfc8s_bh
comma
id|hw
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|hw-&gt;card_name
comma
l_string|&quot;hfc4s8s_%d&quot;
comma
id|hw
op_minus
id|hfc8s
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hw-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|hw-&gt;irq
comma
id|hfc8s_interrupt
comma
id|SA_SHIRQ
comma
id|hw-&gt;card_name
comma
id|hw
)paren
)paren
(brace
id|vfree
c_func
(paren
id|hw-&gt;membase
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hw-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: unable to alloc irq %d, card ignored&bslash;n&quot;
comma
id|hw-&gt;irq
)paren
suffix:semicolon
id|hw-&gt;irq
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hw-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: found PCI card at 0x%p, irq %d&bslash;n&quot;
comma
id|hw-&gt;hw_membase
comma
id|hw-&gt;irq
)paren
suffix:semicolon
id|hfc_hardware_enable
c_func
(paren
id|hw
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|card_cnt
op_increment
suffix:semicolon
id|hw
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|card_cnt
OL
id|MAX_HFC8_CARDS
)paren
op_logical_and
id|list-&gt;vendor_id
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: nominal transparent fifo transfer size is %d bytes&bslash;n&quot;
comma
id|TRANS_FIFO_BYTES
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: module successfully installed, %d cards found&bslash;n&quot;
comma
id|card_cnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* hfc8s_init_hw */
multiline_comment|/*************************************/
multiline_comment|/* release the HFC-4s/8s hardware    */
multiline_comment|/*************************************/
DECL|function|hfc8s_release_hw
r_static
r_void
id|hfc8s_release_hw
c_func
(paren
r_void
)paren
(brace
r_struct
id|hfc8s_hw
op_star
id|hw
op_assign
id|hfc8s
op_plus
id|card_cnt
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|card_cnt
)paren
(brace
id|hfc_hardware_enable
c_func
(paren
id|hw
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;irq
)paren
id|free_irq
c_func
(paren
id|hw-&gt;irq
comma
id|hw
)paren
suffix:semicolon
id|hw-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|hw-&gt;pci_dev
comma
id|PCI_COMMAND
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable memory mapped ports */
id|vfree
c_func
(paren
id|hw-&gt;membase
)paren
suffix:semicolon
id|hw
op_decrement
suffix:semicolon
id|card_cnt
op_decrement
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HFC-4S/8S: module removed successfully&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* hfc8s_release_hw */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Werner Cornelius, werner@cornelius-consult.de&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ISDN layer 1 for Cologne Chip HFC-4S/8S chips&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|hfc8s_init_hw
id|module_init
c_func
(paren
id|hfc8s_init_hw
)paren
suffix:semicolon
DECL|variable|hfc8s_release_hw
id|module_exit
c_func
(paren
id|hfc8s_release_hw
)paren
suffix:semicolon
multiline_comment|/************************************************************************************************************&n;*&n;&n;$Log: hfc4s8s_l1.c,v $&n;Revision 1.8  2004/07/13 14:13:34  martinb1&n;unified chip name&n;&n;Revision 1.7  2004/07/13 09:19:52  martinb1&n;driver ported to 2.6 kernels (info@colognechip.com)&n;&n;Revision 1.6  2004/05/03 09:19:42  joergc1&n;stable counter read function added&n;D receive frame handling changed for unexpected frames&n;changes to source formatting&n;&n;Revision 1.5  2004/04/20 14:43:09  martinb1&n;memory based 8 bit PCI register access Write_hfc8 changed to avoid PCI byte merging problems&n;masking of fifo interupt bits changed&n;&n;Revision 1.4  2004/03/11 16:12:25  martinb1&n;initial version of hfc4s8s_l1.c&n;&n;*/
eof
