multiline_comment|/* gerdes_amd7930.c,v 0.99 2001/10/02&n; *&n; * gerdes_amd7930.c     Amd 79C30A and 79C32A specific routines&n; *                      (based on HiSax driver by Karsten Keil)&n; *&n; * Author               Christoph Ersfeld &lt;info@formula-n.de&gt;&n; *                      Formula-n Europe AG (www.formula-n.com)&n; *                      previously Gerdes AG&n; *&n; *&n; *                      This file is (c) under GNU PUBLIC LICENSE&n; *&n; *&n; * Notes:&n; * Version 0.99 is the first release of this driver and there are&n; * certainly a few bugs.&n; *&n; * Please don&squot;t report any malfunction to me without sending&n; * (compressed) debug-logs.&n; * It would be nearly impossible to retrace it.&n; *&n; * Log D-channel-processing as follows:&n; *&n; * 1. Load hisax with card-specific parameters, this example ist for&n; *    Formula-n enter:now ISDN PCI and compatible&n; *    (f.e. Gerdes Power ISDN PCI)&n; *&n; *    modprobe hisax type=41 protocol=2 id=gerdes&n; *&n; *    if you chose an other value for id, you need to modify the&n; *    code below, too.&n; *&n; * 2. set debug-level&n; *&n; *    hisaxctrl gerdes 1 0x3ff&n; *    hisaxctrl gerdes 11 0x4f&n; *    cat /dev/isdnctrl &gt;&gt; ~/log &amp;&n; *&n; * Please take also a look into /var/log/messages if there is&n; * anything importand concerning HISAX.&n; *&n; *&n; * Credits:&n; * Programming the driver for Formula-n enter:now ISDN PCI and&n; * necessary this driver for the used Amd 7930 D-channel-controller&n; * was spnsored by Formula-n Europe AG.&n; * Thanks to Karsten Keil and Petr Novak, who gave me support in&n; * Hisax-specific questions.&n; * I want so say special thanks to Carl-Friedrich Braun, who had to&n; * answer a lot of questions about generally ISDN and about handling&n; * of the Amd-Chip.&n; *&n; */
macro_line|#include &quot;hisax.h&quot;
macro_line|#include &quot;isdnl1.h&quot;
macro_line|#include &quot;isac.h&quot;
macro_line|#include &quot;amd7930_fn.h&quot;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
r_static
r_void
id|Amd7930_new_ph
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_inline
id|u8
DECL|function|HIBYTE
id|HIBYTE
c_func
(paren
id|u16
id|w
)paren
(brace
r_return
(paren
id|w
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
r_static
r_inline
id|u8
DECL|function|LOBYTE
id|LOBYTE
c_func
(paren
id|u16
id|w
)paren
(brace
r_return
id|w
op_amp
l_int|0xff
suffix:semicolon
)brace
r_static
r_inline
id|u8
DECL|function|rByteAMD
id|rByteAMD
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
id|reg
)paren
(brace
r_return
id|cs-&gt;dc_hw_ops
op_member_access_from_pointer
id|read_reg
c_func
(paren
id|cs
comma
id|reg
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|wByteAMD
id|wByteAMD
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
id|reg
comma
id|u8
id|val
)paren
(brace
id|cs-&gt;dc_hw_ops
op_member_access_from_pointer
id|write_reg
c_func
(paren
id|cs
comma
id|reg
comma
id|val
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|wWordAMD
id|wWordAMD
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
(brace
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x00
comma
id|reg
)paren
suffix:semicolon
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x01
comma
id|LOBYTE
c_func
(paren
id|val
)paren
)paren
suffix:semicolon
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x01
comma
id|HIBYTE
c_func
(paren
id|val
)paren
)paren
suffix:semicolon
)brace
r_static
id|u16
DECL|function|rWordAMD
id|rWordAMD
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
id|reg
)paren
(brace
id|u16
id|res
suffix:semicolon
multiline_comment|/* direct access register */
r_if
c_cond
(paren
id|reg
OL
l_int|8
)paren
(brace
id|res
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
id|reg
)paren
suffix:semicolon
id|res
op_add_assign
l_int|256
op_star
id|rByteAMD
c_func
(paren
id|cs
comma
id|reg
)paren
suffix:semicolon
)brace
multiline_comment|/* indirect access register */
r_else
(brace
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x00
comma
id|reg
)paren
suffix:semicolon
id|res
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x01
)paren
suffix:semicolon
id|res
op_add_assign
l_int|256
op_star
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x01
)paren
suffix:semicolon
)brace
r_return
(paren
id|res
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|AmdIrqOff
id|AmdIrqOff
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|cs-&gt;dc.amd7930
dot
id|setIrqMask
c_func
(paren
id|cs
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|AmdIrqOn
id|AmdIrqOn
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|cs-&gt;dc.amd7930
dot
id|setIrqMask
c_func
(paren
id|cs
comma
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|Amd7930_ph_command
id|Amd7930_ph_command
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
id|command
comma
r_char
op_star
id|s
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;AMD7930: %s: ph_command 0x%02X&quot;
comma
id|s
comma
id|command
)paren
suffix:semicolon
id|cs-&gt;dc.amd7930.lmr1
op_assign
id|command
suffix:semicolon
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0xA3
comma
id|command
)paren
suffix:semicolon
)brace
DECL|variable|i430States
r_static
id|u8
id|i430States
(braket
)braket
op_assign
(brace
singleline_comment|// to   reset  F3    F4    F5    F6    F7    F8    AR     from
l_int|0x01
comma
l_int|0x02
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x07
comma
l_int|0x05
comma
l_int|0x00
comma
singleline_comment|// init
l_int|0x01
comma
l_int|0x02
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x07
comma
l_int|0x05
comma
l_int|0x00
comma
singleline_comment|// reset
l_int|0x01
comma
l_int|0x02
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x09
comma
l_int|0x05
comma
l_int|0x04
comma
singleline_comment|// F3
l_int|0x01
comma
l_int|0x02
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x1B
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|// F4
l_int|0x01
comma
l_int|0x02
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x1B
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|// F5
l_int|0x01
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x06
comma
l_int|0x05
comma
l_int|0x00
comma
singleline_comment|// F6
l_int|0x11
comma
l_int|0x13
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x1B
comma
l_int|0x00
comma
l_int|0x15
comma
l_int|0x00
comma
singleline_comment|// F7
l_int|0x01
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x06
comma
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|// F8
l_int|0x01
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x09
comma
l_int|0x00
comma
l_int|0x0A
)brace
suffix:semicolon
singleline_comment|// AR
multiline_comment|/*                    Row     init    -   reset  F3    F4    F5    F6    F7    F8    AR */
DECL|variable|stateHelper
r_static
id|u8
id|stateHelper
(braket
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x05
comma
l_int|0x06
comma
l_int|0x07
comma
l_int|0x08
)brace
suffix:semicolon
r_static
r_void
DECL|function|Amd7930_get_state
id|Amd7930_get_state
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|u8
id|lsr
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0xA1
)paren
suffix:semicolon
id|cs-&gt;dc.amd7930.ph_state
op_assign
(paren
id|lsr
op_amp
l_int|0x7
)paren
op_plus
l_int|2
suffix:semicolon
id|Amd7930_new_ph
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|Amd7930_new_ph
id|Amd7930_new_ph
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|u8
id|index
op_assign
id|stateHelper
(braket
id|cs-&gt;dc.amd7930.old_state
)braket
op_star
l_int|8
op_plus
id|stateHelper
(braket
id|cs-&gt;dc.amd7930.ph_state
)braket
op_minus
l_int|1
suffix:semicolon
id|u8
id|message
op_assign
id|i430States
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;AMD7930: new_ph %d, old_ph %d, message %d, index %d&quot;
comma
id|cs-&gt;dc.amd7930.ph_state
comma
id|cs-&gt;dc.amd7930.old_state
comma
id|message
op_amp
l_int|0x0f
comma
id|index
)paren
suffix:semicolon
id|cs-&gt;dc.amd7930.old_state
op_assign
id|cs-&gt;dc.amd7930.ph_state
suffix:semicolon
multiline_comment|/* abort transmit if necessary */
r_if
c_cond
(paren
(paren
id|message
op_amp
l_int|0xf0
)paren
op_logical_and
(paren
id|cs-&gt;tx_skb
)paren
)paren
(brace
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x21
comma
l_int|0xC2
)paren
suffix:semicolon
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x21
comma
l_int|0x02
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|message
op_amp
l_int|0x0f
)paren
(brace
r_case
(paren
l_int|1
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_RESET
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
id|Amd7930_get_state
c_func
(paren
id|cs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|2
)paren
suffix:colon
multiline_comment|/* init, Card starts in F3 */
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_DEACTIVATE
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|3
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|4
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_POWERUP
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
id|Amd7930_ph_command
c_func
(paren
id|cs
comma
l_int|0x50
comma
l_string|&quot;HW_ENABLE REQUEST&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|5
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_RSYNC
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|6
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_INFO4_P8
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|7
)paren
suffix:colon
multiline_comment|/* init, Card starts in F7 */
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_RSYNC
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_INFO4_P8
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|8
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_POWERUP
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* fall through */
r_case
(paren
l_int|9
)paren
suffix:colon
id|Amd7930_ph_command
c_func
(paren
id|cs
comma
l_int|0x40
comma
l_string|&quot;HW_ENABLE REQ cleared if set&quot;
)paren
suffix:semicolon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_RSYNC
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_INFO2
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_INFO4_P8
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|10
)paren
suffix:colon
id|Amd7930_ph_command
c_func
(paren
id|cs
comma
l_int|0x40
comma
l_string|&quot;T3 expired, HW_ENABLE REQ cleared&quot;
)paren
suffix:semicolon
id|cs-&gt;dc.amd7930.old_state
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|11
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_INFO2
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|Amd7930_bh
id|Amd7930_bh
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|data
suffix:semicolon
r_struct
id|PStack
op_star
id|stptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_CLEARBUSY
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: bh, D-Channel Busy cleared&quot;
)paren
suffix:semicolon
id|stptr
op_assign
id|cs-&gt;stlist
suffix:semicolon
r_while
c_loop
(paren
id|stptr
op_ne
l_int|NULL
)paren
(brace
id|stptr-&gt;l2
dot
id|l1l2
c_func
(paren
id|stptr
comma
id|PH_PAUSE
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
id|stptr
op_assign
id|stptr-&gt;next
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_L1STATECHANGE
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;AMD7930: bh, D_L1STATECHANGE&quot;
)paren
suffix:semicolon
id|Amd7930_new_ph
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_RCVBUFREADY
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;AMD7930: bh, D_RCVBUFREADY&quot;
)paren
suffix:semicolon
id|DChannel_proc_rcv
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_XMTBUFREADY
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;AMD7930: bh, D_XMTBUFREADY&quot;
)paren
suffix:semicolon
id|DChannel_proc_xmt
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|Amd7930_empty_Dfifo
id|Amd7930_empty_Dfifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|flag
)paren
(brace
id|u8
id|stat
comma
id|der
suffix:semicolon
id|u8
op_star
id|ptr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
op_logical_and
op_logical_neg
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: empty_Dfifo&quot;
)paren
suffix:semicolon
id|ptr
op_assign
id|cs-&gt;rcvbuf
op_plus
id|cs-&gt;rcvidx
suffix:semicolon
multiline_comment|/* AMD interrupts off */
id|AmdIrqOff
c_func
(paren
id|cs
)paren
suffix:semicolon
multiline_comment|/* read D-Channel-Fifo*/
id|stat
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x07
)paren
suffix:semicolon
singleline_comment|// DSR2
multiline_comment|/* while Data in Fifo ... */
r_while
c_loop
(paren
(paren
id|stat
op_amp
l_int|2
)paren
op_logical_and
(paren
(paren
id|ptr
op_minus
id|cs-&gt;rcvbuf
)paren
OL
id|MAX_DFRAME_LEN_L1
)paren
)paren
(brace
op_star
id|ptr
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x04
)paren
suffix:semicolon
singleline_comment|// DCRB
id|ptr
op_increment
suffix:semicolon
id|stat
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x07
)paren
suffix:semicolon
singleline_comment|// DSR2
id|cs-&gt;rcvidx
op_assign
id|ptr
op_minus
id|cs-&gt;rcvbuf
suffix:semicolon
multiline_comment|/* Paket ready? */
r_if
c_cond
(paren
id|stat
op_amp
l_int|1
)paren
(brace
id|der
op_assign
id|rWordAMD
c_func
(paren
id|cs
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* no errors, packet ok */
r_if
c_cond
(paren
op_logical_neg
id|der
op_logical_and
op_logical_neg
id|flag
)paren
(brace
id|rWordAMD
c_func
(paren
id|cs
comma
l_int|0x89
)paren
suffix:semicolon
singleline_comment|// clear DRCR
r_if
c_cond
(paren
(paren
id|cs-&gt;rcvidx
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|cs-&gt;rcvidx
comma
id|GFP_ATOMIC
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: Amd7930: empty_Dfifo, D receive out of memory!&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* Debugging */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
(brace
r_char
op_star
id|t
op_assign
id|cs-&gt;dlog
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;Amd7930: empty_Dfifo cnt: %d |&quot;
comma
id|cs-&gt;rcvidx
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|cs-&gt;rcvbuf
comma
id|cs-&gt;rcvidx
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|cs-&gt;dlog
)paren
suffix:semicolon
)brace
multiline_comment|/* moves received data in sk-buffer */
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|cs-&gt;rcvidx
)paren
comma
id|cs-&gt;rcvbuf
comma
id|cs-&gt;rcvidx
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;rq
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* throw damaged packets away, reset recieve-buffer, indicate RX */
id|ptr
op_assign
id|cs-&gt;rcvbuf
suffix:semicolon
id|cs-&gt;rcvidx
op_assign
l_int|0
suffix:semicolon
id|sched_d_event
c_func
(paren
id|cs
comma
id|D_RCVBUFREADY
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Packet too long, overflow */
r_if
c_cond
(paren
id|cs-&gt;rcvidx
op_ge
id|MAX_DFRAME_LEN_L1
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;AMD7930: empty_Dfifo L2-Framelength overrun&quot;
)paren
suffix:semicolon
id|cs-&gt;rcvidx
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* AMD interrupts on */
id|AmdIrqOn
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|Amd7930_fill_Dfifo
id|Amd7930_fill_Dfifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|u16
id|dtcrr
comma
id|dtcrw
comma
id|len
comma
id|count
suffix:semicolon
id|u8
id|txstat
comma
id|dmr3
suffix:semicolon
id|u8
op_star
id|ptr
comma
op_star
id|deb_ptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
op_logical_and
op_logical_neg
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: fill_Dfifo&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|cs-&gt;tx_skb
)paren
op_logical_or
(paren
id|cs-&gt;tx_skb-&gt;len
op_le
l_int|0
)paren
)paren
r_return
suffix:semicolon
id|dtcrw
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;dc.amd7930.tx_xmtlen
)paren
(brace
multiline_comment|/* new Frame */
id|len
op_assign
id|dtcrw
op_assign
id|cs-&gt;tx_skb-&gt;len
suffix:semicolon
)brace
multiline_comment|/* continue frame */
r_else
id|len
op_assign
id|cs-&gt;dc.amd7930.tx_xmtlen
suffix:semicolon
multiline_comment|/* AMD interrupts off */
id|AmdIrqOff
c_func
(paren
id|cs
)paren
suffix:semicolon
id|deb_ptr
op_assign
id|ptr
op_assign
id|cs-&gt;tx_skb-&gt;data
suffix:semicolon
multiline_comment|/* while free place in tx-fifo available and data in sk-buffer */
id|txstat
op_assign
l_int|0x10
suffix:semicolon
r_while
c_loop
(paren
(paren
id|txstat
op_amp
l_int|0x10
)paren
op_logical_and
(paren
id|cs-&gt;tx_cnt
OL
id|len
)paren
)paren
(brace
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x04
comma
op_star
id|ptr
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
id|cs-&gt;tx_cnt
op_increment
suffix:semicolon
id|txstat
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x07
)paren
suffix:semicolon
)brace
id|count
op_assign
id|ptr
op_minus
id|cs-&gt;tx_skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|cs-&gt;tx_skb
comma
id|count
)paren
suffix:semicolon
id|dtcrr
op_assign
id|rWordAMD
c_func
(paren
id|cs
comma
l_int|0x85
)paren
suffix:semicolon
singleline_comment|// DTCR
id|dmr3
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x8E
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
(brace
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: fill_Dfifo, DMR3: 0x%02X, DTCR read: 0x%04X write: 0x%02X 0x%02X&quot;
comma
id|dmr3
comma
id|dtcrr
comma
id|LOBYTE
c_func
(paren
id|dtcrw
)paren
comma
id|HIBYTE
c_func
(paren
id|dtcrw
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* writeing of dtcrw starts transmit */
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;dc.amd7930.tx_xmtlen
)paren
(brace
id|wWordAMD
c_func
(paren
id|cs
comma
l_int|0x85
comma
id|dtcrw
)paren
suffix:semicolon
id|cs-&gt;dc.amd7930.tx_xmtlen
op_assign
id|dtcrw
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
(brace
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: fill_Dfifo dbusytimer running&quot;
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
id|cs-&gt;dbusytimer.expires
op_assign
id|jiffies
op_plus
(paren
(paren
id|DBUSY_TIMER_VALUE
op_star
id|HZ
)paren
op_div
l_int|1000
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
(brace
r_char
op_star
id|t
op_assign
id|cs-&gt;dlog
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;Amd7930: fill_Dfifo cnt: %d |&quot;
comma
id|count
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|deb_ptr
comma
id|count
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|cs-&gt;dlog
)paren
suffix:semicolon
)brace
multiline_comment|/* AMD interrupts on */
id|AmdIrqOn
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
DECL|function|Amd7930_interrupt
r_void
id|Amd7930_interrupt
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
id|irflags
)paren
(brace
id|u8
id|dsr1
comma
id|dsr2
comma
id|lsr
suffix:semicolon
id|u16
id|der
suffix:semicolon
r_while
c_loop
(paren
id|irflags
)paren
(brace
id|dsr1
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x02
)paren
suffix:semicolon
id|der
op_assign
id|rWordAMD
c_func
(paren
id|cs
comma
l_int|0x03
)paren
suffix:semicolon
id|dsr2
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x07
)paren
suffix:semicolon
id|lsr
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0xA1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: interrupt: flags: 0x%02X, DSR1: 0x%02X, DSR2: 0x%02X, LSR: 0x%02X, DER=0x%04X&quot;
comma
id|irflags
comma
id|dsr1
comma
id|dsr2
comma
id|lsr
comma
id|der
)paren
suffix:semicolon
multiline_comment|/* D error -&gt; read DER and DSR2 bit 2 */
r_if
c_cond
(paren
id|der
op_logical_or
(paren
id|dsr2
op_amp
l_int|4
)paren
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: interrupt: D error DER=0x%04X&quot;
comma
id|der
)paren
suffix:semicolon
multiline_comment|/* RX, TX abort if collision detected */
r_if
c_cond
(paren
id|der
op_amp
l_int|2
)paren
(brace
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x21
comma
l_int|0xC2
)paren
suffix:semicolon
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x21
comma
l_int|0x02
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_L1_DBUSY
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|sched_d_event
c_func
(paren
id|cs
comma
id|D_CLEARBUSY
)paren
suffix:semicolon
multiline_comment|/* restart frame */
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|skb_push
c_func
(paren
id|cs-&gt;tx_skb
comma
id|cs-&gt;tx_cnt
)paren
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;dc.amd7930.tx_xmtlen
op_assign
l_int|0
suffix:semicolon
id|Amd7930_fill_Dfifo
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: Amd7930 D-Collision, no skb&bslash;n&quot;
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: interrupt: D-Collision, no skb&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* remove damaged data from fifo */
id|Amd7930_empty_Dfifo
c_func
(paren
id|cs
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_L1_DBUSY
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|sched_d_event
c_func
(paren
id|cs
comma
id|D_CLEARBUSY
)paren
suffix:semicolon
multiline_comment|/* restart TX-Frame */
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|skb_push
c_func
(paren
id|cs-&gt;tx_skb
comma
id|cs-&gt;tx_cnt
)paren
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;dc.amd7930.tx_xmtlen
op_assign
l_int|0
suffix:semicolon
id|Amd7930_fill_Dfifo
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* D TX FIFO empty -&gt; fill */
r_if
c_cond
(paren
id|irflags
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: interrupt: clear Timer and fill D-TX-FIFO if data&quot;
)paren
suffix:semicolon
multiline_comment|/* AMD interrupts off */
id|AmdIrqOff
c_func
(paren
id|cs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_L1_DBUSY
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|sched_d_event
c_func
(paren
id|cs
comma
id|D_CLEARBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;tx_skb-&gt;len
)paren
id|Amd7930_fill_Dfifo
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
multiline_comment|/* AMD interrupts on */
id|AmdIrqOn
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
multiline_comment|/* D RX FIFO full or tiny packet in Fifo -&gt; empty */
r_if
c_cond
(paren
(paren
id|irflags
op_amp
l_int|2
)paren
op_logical_or
(paren
id|dsr1
op_amp
l_int|2
)paren
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: interrupt: empty D-FIFO&quot;
)paren
suffix:semicolon
id|Amd7930_empty_Dfifo
c_func
(paren
id|cs
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* D-Frame transmit complete */
r_if
c_cond
(paren
id|dsr1
op_amp
l_int|64
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
(brace
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: interrupt: transmit packet ready&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* AMD interrupts off */
id|AmdIrqOff
c_func
(paren
id|cs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_L1_DBUSY
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|sched_d_event
c_func
(paren
id|cs
comma
id|D_CLEARBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: interrupt: TX-Packet ready, freeing skb&quot;
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|cs-&gt;tx_skb
)paren
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;dc.amd7930.tx_xmtlen
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cs-&gt;tx_skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|cs-&gt;sq
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: interrupt: TX-Packet ready, next packet dequeued&quot;
)paren
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;dc.amd7930.tx_xmtlen
op_assign
l_int|0
suffix:semicolon
id|Amd7930_fill_Dfifo
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_else
id|sched_d_event
c_func
(paren
id|cs
comma
id|D_XMTBUFREADY
)paren
suffix:semicolon
multiline_comment|/* AMD interrupts on */
id|AmdIrqOn
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
multiline_comment|/* LIU status interrupt -&gt; read LSR, check statechanges */
r_if
c_cond
(paren
id|lsr
op_amp
l_int|0x38
)paren
(brace
multiline_comment|/* AMD interrupts off */
id|AmdIrqOff
c_func
(paren
id|cs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd: interrupt: LSR=0x%02X, LIU is in state %d&quot;
comma
id|lsr
comma
(paren
(paren
id|lsr
op_amp
l_int|0x7
)paren
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|cs-&gt;dc.amd7930.ph_state
op_assign
(paren
id|lsr
op_amp
l_int|0x7
)paren
op_plus
l_int|2
suffix:semicolon
id|sched_d_event
c_func
(paren
id|cs
comma
id|D_L1STATECHANGE
)paren
suffix:semicolon
multiline_comment|/* AMD interrupts on */
id|AmdIrqOn
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
multiline_comment|/* reads Interrupt-Register again. If there is a new interrupt-flag: restart handler */
id|irflags
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x00
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|Amd7930_l1hw
id|Amd7930_l1hw
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
(paren
r_struct
id|IsdnCardState
op_star
)paren
id|st-&gt;l1.hardware
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: l1hw called, pr: 0x%04X&quot;
comma
id|pr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_DATA
op_or
id|REQUEST
)paren
suffix:colon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|DEB_DLOG_HEX
)paren
id|LogFrame
c_func
(paren
id|cs
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|DEB_DLOG_VERBOSE
)paren
id|dlogframe
c_func
(paren
id|cs
comma
id|skb
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;sq
comma
id|skb
)paren
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;Amd7930: l1hw: PH_DATA Queued&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|cs-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;dc.amd7930.tx_xmtlen
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;Amd7930: l1hw: PH_DATA&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|Amd7930_fill_Dfifo
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL
op_or
id|INDICATION
)paren
suffix:colon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: l1hw: l2l1 tx_skb exist this shouldn&squot;t happen&quot;
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;sq
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|DEB_DLOG_HEX
)paren
id|LogFrame
c_func
(paren
id|cs
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|DEB_DLOG_VERBOSE
)paren
id|dlogframe
c_func
(paren
id|cs
comma
id|skb
comma
l_int|0
)paren
suffix:semicolon
id|cs-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;dc.amd7930.tx_xmtlen
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;Amd7930: l1hw: PH_DATA_PULLED&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|Amd7930_fill_Dfifo
c_func
(paren
id|cs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL
op_or
id|REQUEST
)paren
suffix:colon
macro_line|#ifdef L2FRAME_DEBUG&t;&t;/* psa */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: l1hw: -&gt; PH_REQUEST_PULL, skb: %s&quot;
comma
(paren
id|cs-&gt;tx_skb
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;tx_skb
)paren
(brace
id|test_and_clear_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
id|st-&gt;l2
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_PULL
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
id|test_and_set_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HW_RESET
op_or
id|REQUEST
)paren
suffix:colon
r_if
c_cond
(paren
(paren
id|cs-&gt;dc.amd7930.ph_state
op_eq
l_int|8
)paren
)paren
multiline_comment|/* b-channels off, PH-AR cleared&n;                                 * change to F3 */
id|Amd7930_ph_command
c_func
(paren
id|cs
comma
l_int|0x20
comma
l_string|&quot;HW_RESET REQEST&quot;
)paren
suffix:semicolon
singleline_comment|//LMR1 bit 5
r_else
(brace
id|Amd7930_ph_command
c_func
(paren
id|cs
comma
l_int|0x40
comma
l_string|&quot;HW_RESET REQUEST&quot;
)paren
suffix:semicolon
id|cs-&gt;dc.amd7930.ph_state
op_assign
l_int|2
suffix:semicolon
id|Amd7930_new_ph
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
id|HW_ENABLE
op_or
id|REQUEST
)paren
suffix:colon
id|cs-&gt;dc.amd7930.ph_state
op_assign
l_int|9
suffix:semicolon
id|Amd7930_new_ph
c_func
(paren
id|cs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HW_INFO3
op_or
id|REQUEST
)paren
suffix:colon
singleline_comment|// automatic
r_break
suffix:semicolon
r_case
(paren
id|HW_TESTLOOP
op_or
id|REQUEST
)paren
suffix:colon
multiline_comment|/* not implemented yet */
r_break
suffix:semicolon
r_case
(paren
id|HW_DEACTIVATE
op_or
id|RESPONSE
)paren
suffix:colon
id|skb_queue_purge
c_func
(paren
op_amp
id|cs-&gt;rq
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|cs-&gt;sq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|cs-&gt;tx_skb
)paren
suffix:semicolon
id|cs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_L1_DBUSY
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|sched_d_event
c_func
(paren
id|cs
comma
id|D_CLEARBUSY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: l1hw: unknown %04x&quot;
comma
id|pr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|setstack_Amd7930
id|setstack_Amd7930
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: setstack called&quot;
)paren
suffix:semicolon
id|st-&gt;l1.l1hw
op_assign
id|Amd7930_l1hw
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|dbusy_timer_handler
id|dbusy_timer_handler
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_struct
id|PStack
op_star
id|stptr
suffix:semicolon
id|u16
id|dtcr
comma
id|der
suffix:semicolon
id|u8
id|dsr1
comma
id|dsr2
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: dbusy_timer expired!&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
(brace
multiline_comment|/* D Transmit Byte Count Register:&n;                 * Counts down packet&squot;s number of Bytes, 0 if packet ready */
id|dtcr
op_assign
id|rWordAMD
c_func
(paren
id|cs
comma
l_int|0x85
)paren
suffix:semicolon
id|dsr1
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x02
)paren
suffix:semicolon
id|dsr2
op_assign
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x07
)paren
suffix:semicolon
id|der
op_assign
id|rWordAMD
c_func
(paren
id|cs
comma
l_int|0x03
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: dbusy_timer_handler: DSR1=0x%02X, DSR2=0x%02X, DER=0x%04X, cs-&gt;tx_skb-&gt;len=%u, tx_stat=%u, dtcr=%u, cs-&gt;tx_cnt=%u&quot;
comma
id|dsr1
comma
id|dsr2
comma
id|der
comma
id|cs-&gt;tx_skb-&gt;len
comma
id|cs-&gt;dc.amd7930.tx_xmtlen
comma
id|dtcr
comma
id|cs-&gt;tx_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|cs-&gt;dc.amd7930.tx_xmtlen
op_minus
id|dtcr
)paren
OL
id|cs-&gt;tx_cnt
)paren
(brace
multiline_comment|/* D-Channel Busy */
id|test_and_set_bit
c_func
(paren
id|FLG_L1_DBUSY
comma
op_amp
id|cs-&gt;HW_Flags
)paren
suffix:semicolon
id|stptr
op_assign
id|cs-&gt;stlist
suffix:semicolon
r_while
c_loop
(paren
id|stptr
op_ne
l_int|NULL
)paren
(brace
id|stptr-&gt;l2
dot
id|l1l2
c_func
(paren
id|stptr
comma
id|PH_PAUSE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
id|stptr
op_assign
id|stptr-&gt;next
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* discard frame; reset transceiver */
id|test_and_clear_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|cs-&gt;tx_skb
)paren
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|cs-&gt;dc.amd7930.tx_xmtlen
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: Amd7930: D-Channel Busy no skb&bslash;n&quot;
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: D-Channel Busy no skb&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Transmitter reset, abort transmit */
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x21
comma
l_int|0x82
)paren
suffix:semicolon
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x21
comma
l_int|0x02
)paren
suffix:semicolon
id|cs-&gt;card_ops
op_member_access_from_pointer
id|irq_func
c_func
(paren
id|cs-&gt;irq
comma
id|cs
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* FIXME? */
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: dbusy_timer_handler: Transmitter reset&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|initAMD
r_static
id|u16
id|initAMD
(braket
)braket
op_assign
(brace
l_int|0x0100
comma
l_int|0x00A5
comma
l_int|3
comma
l_int|0x01
comma
l_int|0x40
comma
l_int|0x58
comma
singleline_comment|// LPR, LMR1, LMR2
l_int|0x0086
comma
l_int|1
comma
l_int|0x0B
comma
singleline_comment|// DMR1 (D-Buffer TH-Interrupts on)
l_int|0x0087
comma
l_int|1
comma
l_int|0xFF
comma
singleline_comment|// DMR2
l_int|0x0092
comma
l_int|1
comma
l_int|0x03
comma
singleline_comment|// EFCR (extended mode d-channel-fifo on)
l_int|0x0090
comma
l_int|4
comma
l_int|0xFE
comma
l_int|0xFF
comma
l_int|0x02
comma
l_int|0x0F
comma
singleline_comment|// FRAR4, SRAR4, DMR3, DMR4 (address recognition )
l_int|0x0084
comma
l_int|2
comma
l_int|0x80
comma
l_int|0x00
comma
singleline_comment|// DRLR
l_int|0x00C0
comma
l_int|1
comma
l_int|0x47
comma
singleline_comment|// PPCR1
l_int|0x00C8
comma
l_int|1
comma
l_int|0x01
comma
singleline_comment|// PPCR2
l_int|0x0102
comma
l_int|0x0107
comma
l_int|0x01A1
comma
l_int|1
comma
l_int|0x0121
comma
l_int|1
comma
l_int|0x0189
comma
l_int|2
comma
l_int|0x0045
comma
l_int|4
comma
l_int|0x61
comma
l_int|0x72
comma
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|// MCR1, MCR2, MCR3, MCR4
l_int|0x0063
comma
l_int|2
comma
l_int|0x08
comma
l_int|0x08
comma
singleline_comment|// GX
l_int|0x0064
comma
l_int|2
comma
l_int|0x08
comma
l_int|0x08
comma
singleline_comment|// GR
l_int|0x0065
comma
l_int|2
comma
l_int|0x99
comma
l_int|0x00
comma
singleline_comment|// GER
l_int|0x0066
comma
l_int|2
comma
l_int|0x7C
comma
l_int|0x8B
comma
singleline_comment|// STG
l_int|0x0067
comma
l_int|2
comma
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|// FTGR1, FTGR2
l_int|0x0068
comma
l_int|2
comma
l_int|0x20
comma
l_int|0x20
comma
singleline_comment|// ATGR1, ATGR2
l_int|0x0069
comma
l_int|1
comma
l_int|0x4F
comma
singleline_comment|// MMR1
l_int|0x006A
comma
l_int|1
comma
l_int|0x00
comma
singleline_comment|// MMR2
l_int|0x006C
comma
l_int|1
comma
l_int|0x40
comma
singleline_comment|// MMR3
l_int|0x0021
comma
l_int|1
comma
l_int|0x02
comma
singleline_comment|// INIT
l_int|0x00A3
comma
l_int|1
comma
l_int|0x40
comma
singleline_comment|// LMR1
l_int|0xFFFF
)brace
suffix:semicolon
DECL|variable|amd7930_l1_ops
r_static
r_struct
id|dc_l1_ops
id|amd7930_l1_ops
op_assign
(brace
dot
id|open
op_assign
id|setstack_Amd7930
comma
dot
id|bh_func
op_assign
id|Amd7930_bh
comma
dot
id|dbusy_func
op_assign
id|dbusy_timer_handler
comma
)brace
suffix:semicolon
r_void
id|__devinit
DECL|function|Amd7930_init
id|Amd7930_init
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|u16
op_star
id|ptr
suffix:semicolon
id|u8
id|cmd
comma
id|cnt
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;Amd7930: initamd called&quot;
)paren
suffix:semicolon
id|dc_l1_init
c_func
(paren
id|cs
comma
op_amp
id|amd7930_l1_ops
)paren
suffix:semicolon
id|cs-&gt;dc.amd7930.tx_xmtlen
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;dc.amd7930.old_state
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;dc.amd7930.lmr1
op_assign
l_int|0x40
suffix:semicolon
id|cs-&gt;dc.amd7930.ph_command
op_assign
id|Amd7930_ph_command
suffix:semicolon
multiline_comment|/* AMD Initialisation */
r_for
c_loop
(paren
id|ptr
op_assign
id|initAMD
suffix:semicolon
op_star
id|ptr
op_ne
l_int|0xFFFF
suffix:semicolon
)paren
(brace
id|cmd
op_assign
id|LOBYTE
c_func
(paren
op_star
id|ptr
)paren
suffix:semicolon
multiline_comment|/* read */
r_if
c_cond
(paren
op_star
id|ptr
op_increment
op_ge
l_int|0x100
)paren
(brace
r_if
c_cond
(paren
id|cmd
OL
l_int|8
)paren
multiline_comment|/* setzt Register zur&#xfffd;ck */
id|rByteAMD
c_func
(paren
id|cs
comma
id|cmd
)paren
suffix:semicolon
r_else
(brace
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x00
comma
id|cmd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
op_star
id|ptr
op_increment
suffix:semicolon
id|cnt
OG
l_int|0
suffix:semicolon
id|cnt
op_decrement
)paren
id|rByteAMD
c_func
(paren
id|cs
comma
l_int|0x01
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* write */
r_else
r_if
c_cond
(paren
id|cmd
OL
l_int|8
)paren
id|wByteAMD
c_func
(paren
id|cs
comma
id|cmd
comma
id|LOBYTE
c_func
(paren
op_star
id|ptr
op_increment
)paren
)paren
suffix:semicolon
r_else
(brace
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x00
comma
id|cmd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
op_star
id|ptr
op_increment
suffix:semicolon
id|cnt
OG
l_int|0
suffix:semicolon
id|cnt
op_decrement
)paren
id|wByteAMD
c_func
(paren
id|cs
comma
l_int|0x01
comma
id|LOBYTE
c_func
(paren
op_star
id|ptr
op_increment
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_int
DECL|function|amd7930_setup
id|amd7930_setup
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_struct
id|dc_hw_ops
op_star
id|amd7930_ops
comma
r_void
(paren
op_star
id|set_irq_mask
)paren
(paren
r_struct
id|IsdnCardState
op_star
comma
id|u8
id|val
)paren
)paren
(brace
id|cs-&gt;dc_hw_ops
op_assign
id|amd7930_ops
suffix:semicolon
id|cs-&gt;dc.amd7930.setIrqMask
op_assign
id|set_irq_mask
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
