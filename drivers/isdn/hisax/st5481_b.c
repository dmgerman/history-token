multiline_comment|/*&n; * Driver for ST5481 USB ISDN modem&n; *&n; * Author       Frode Isaksen&n; * Copyright    2001 by Frode Isaksen      &lt;fisaksen@bewan.com&gt;&n; *              2001 by Kai Germaschewski  &lt;kai.germaschewski@gmx.de&gt;&n; * &n; * This software may be used and distributed according to the terms&n; * of the GNU General Public License, incorporated herein by reference.&n; *&n; */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &quot;st5481.h&quot;
DECL|function|B_L1L2
r_static
r_inline
r_void
id|B_L1L2
c_func
(paren
r_struct
id|st5481_bcs
op_star
id|bcs
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|hisax_if
op_star
id|ifc
op_assign
(paren
r_struct
id|hisax_if
op_star
)paren
op_amp
id|bcs-&gt;b_if
suffix:semicolon
id|ifc
op_member_access_from_pointer
id|l1l2
c_func
(paren
id|ifc
comma
id|pr
comma
id|arg
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Encode and transmit next frame.&n; */
DECL|function|usb_b_out
r_static
r_void
id|usb_b_out
c_func
(paren
r_struct
id|st5481_bcs
op_star
id|bcs
comma
r_int
id|buf_nr
)paren
(brace
r_struct
id|st5481_b_out
op_star
id|b_out
op_assign
op_amp
id|bcs-&gt;b_out
suffix:semicolon
r_struct
id|st5481_adapter
op_star
id|adapter
op_assign
id|bcs-&gt;adapter
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
r_int
id|packet_size
comma
id|offset
suffix:semicolon
r_int
id|len
comma
id|buf_size
comma
id|bytes_sent
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|buf_nr
comma
op_amp
id|b_out-&gt;busy
)paren
)paren
(brace
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;ep %d urb %d busy&quot;
comma
(paren
id|bcs-&gt;channel
op_plus
l_int|1
)paren
op_star
l_int|2
comma
id|buf_nr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|urb
op_assign
id|b_out-&gt;urb
(braket
id|buf_nr
)braket
suffix:semicolon
singleline_comment|// Adjust isoc buffer size according to flow state
r_if
c_cond
(paren
id|b_out-&gt;flow_event
op_amp
(paren
id|OUT_DOWN
op_or
id|OUT_UNDERRUN
)paren
)paren
(brace
id|buf_size
op_assign
id|NUM_ISO_PACKETS_B
op_star
id|SIZE_ISO_PACKETS_B_OUT
op_plus
id|B_FLOW_ADJUST
suffix:semicolon
id|packet_size
op_assign
id|SIZE_ISO_PACKETS_B_OUT
op_plus
id|B_FLOW_ADJUST
suffix:semicolon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;B%d,adjust flow,add %d bytes&quot;
comma
id|bcs-&gt;channel
op_plus
l_int|1
comma
id|B_FLOW_ADJUST
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|b_out-&gt;flow_event
op_amp
id|OUT_UP
)paren
(brace
id|buf_size
op_assign
id|NUM_ISO_PACKETS_B
op_star
id|SIZE_ISO_PACKETS_B_OUT
op_minus
id|B_FLOW_ADJUST
suffix:semicolon
id|packet_size
op_assign
id|SIZE_ISO_PACKETS_B_OUT
op_minus
id|B_FLOW_ADJUST
suffix:semicolon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;B%d,adjust flow,remove %d bytes&quot;
comma
id|bcs-&gt;channel
op_plus
l_int|1
comma
id|B_FLOW_ADJUST
)paren
suffix:semicolon
)brace
r_else
(brace
id|buf_size
op_assign
id|NUM_ISO_PACKETS_B
op_star
id|SIZE_ISO_PACKETS_B_OUT
suffix:semicolon
id|packet_size
op_assign
l_int|8
suffix:semicolon
)brace
id|b_out-&gt;flow_event
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len
OL
id|buf_size
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|b_out-&gt;tx_skb
)paren
)paren
(brace
id|DBG_SKB
c_func
(paren
l_int|0x100
comma
id|skb
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;B%d,len=%d&quot;
comma
id|bcs-&gt;channel
op_plus
l_int|1
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcs-&gt;mode
op_eq
id|L1_MODE_TRANS
)paren
(brace
id|bytes_sent
op_assign
id|buf_size
op_minus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
id|bytes_sent
)paren
id|bytes_sent
op_assign
id|skb-&gt;len
suffix:semicolon
id|memcpy
c_func
(paren
id|urb-&gt;transfer_buffer
op_plus
id|len
comma
id|skb-&gt;data
comma
id|bytes_sent
)paren
suffix:semicolon
id|len
op_add_assign
id|bytes_sent
suffix:semicolon
)brace
r_else
(brace
id|len
op_add_assign
id|hdlc_encode
c_func
(paren
op_amp
id|b_out-&gt;hdlc_state
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
op_amp
id|bytes_sent
comma
id|urb-&gt;transfer_buffer
op_plus
id|len
comma
id|buf_size
op_minus
id|len
)paren
suffix:semicolon
)brace
id|skb_pull
c_func
(paren
id|skb
comma
id|bytes_sent
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;len
)paren
(brace
singleline_comment|// Frame sent
id|b_out-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|B_L1L2
c_func
(paren
id|bcs
comma
id|PH_DATA
op_or
id|CONFIRM
comma
(paren
r_void
op_star
)paren
id|skb-&gt;truesize
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* &t;&t;&t;&t;if (!(bcs-&gt;tx_skb = skb_dequeue(&amp;bcs-&gt;sq))) { */
multiline_comment|/* &t;&t;&t;&t;&t;st5481B_sched_event(bcs, B_XMTBUFREADY); */
multiline_comment|/* &t;&t;&t;&t;} */
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|bcs-&gt;mode
op_eq
id|L1_MODE_TRANS
)paren
(brace
id|memset
c_func
(paren
id|urb-&gt;transfer_buffer
op_plus
id|len
comma
l_int|0xff
comma
id|buf_size
op_minus
id|len
)paren
suffix:semicolon
id|len
op_assign
id|buf_size
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Send flags
id|len
op_add_assign
id|hdlc_encode
c_func
(paren
op_amp
id|b_out-&gt;hdlc_state
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|bytes_sent
comma
id|urb-&gt;transfer_buffer
op_plus
id|len
comma
id|buf_size
op_minus
id|len
)paren
suffix:semicolon
)brace
)brace
)brace
singleline_comment|// Prepare the URB
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|offset
op_assign
l_int|0
suffix:semicolon
id|offset
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|offset
op_assign
id|offset
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|length
op_assign
id|packet_size
suffix:semicolon
id|offset
op_add_assign
id|packet_size
suffix:semicolon
id|packet_size
op_assign
id|SIZE_ISO_PACKETS_B_OUT
suffix:semicolon
)brace
id|urb-&gt;transfer_buffer_length
op_assign
id|len
suffix:semicolon
id|urb-&gt;number_of_packets
op_assign
id|i
suffix:semicolon
id|urb-&gt;dev
op_assign
id|adapter-&gt;usb_dev
suffix:semicolon
id|DBG_ISO_PACKET
c_func
(paren
l_int|0x200
comma
id|urb
)paren
suffix:semicolon
id|SUBMIT_URB
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Start transfering (flags or data) on the B channel, since&n; * FIFO counters has been set to a non-zero value.&n; */
DECL|function|st5481B_start_xfer
r_static
r_void
id|st5481B_start_xfer
c_func
(paren
r_void
op_star
id|context
)paren
(brace
r_struct
id|st5481_bcs
op_star
id|bcs
op_assign
id|context
suffix:semicolon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;B%d&quot;
comma
id|bcs-&gt;channel
op_plus
l_int|1
)paren
suffix:semicolon
singleline_comment|// Start transmitting (flags or data) on B channel
id|usb_b_out
c_func
(paren
id|bcs
comma
l_int|0
)paren
suffix:semicolon
id|usb_b_out
c_func
(paren
id|bcs
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * If the adapter has only 2 LEDs, the green&n; * LED will blink with a rate depending&n; * on the number of channels opened.&n; */
DECL|function|led_blink
r_static
r_void
id|led_blink
c_func
(paren
r_struct
id|st5481_adapter
op_star
id|adapter
)paren
(brace
id|u_char
id|leds
op_assign
id|adapter-&gt;leds
suffix:semicolon
singleline_comment|// 50 frames/sec for each channel
r_if
c_cond
(paren
op_increment
id|adapter-&gt;led_counter
op_mod
l_int|50
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adapter-&gt;led_counter
op_mod
l_int|100
)paren
(brace
id|leds
op_or_assign
id|GREEN_LED
suffix:semicolon
)brace
r_else
(brace
id|leds
op_and_assign
op_complement
id|GREEN_LED
suffix:semicolon
)brace
id|st5481_usb_device_ctrl_msg
c_func
(paren
id|adapter
comma
id|GPIO_OUT
comma
id|leds
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|usb_b_out_complete
r_static
r_void
id|usb_b_out_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|st5481_bcs
op_star
id|bcs
op_assign
id|urb-&gt;context
suffix:semicolon
r_struct
id|st5481_b_out
op_star
id|b_out
op_assign
op_amp
id|bcs-&gt;b_out
suffix:semicolon
r_struct
id|st5481_adapter
op_star
id|adapter
op_assign
id|bcs-&gt;adapter
suffix:semicolon
r_int
id|buf_nr
suffix:semicolon
id|buf_nr
op_assign
id|get_buf_nr
c_func
(paren
id|b_out-&gt;urb
comma
id|urb
)paren
suffix:semicolon
id|test_and_clear_bit
c_func
(paren
id|buf_nr
comma
op_amp
id|b_out-&gt;busy
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|urb-&gt;status
op_ne
id|USB_ST_URB_KILLED
)paren
(brace
id|WARN
c_func
(paren
l_string|&quot;urb status %d&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b_out-&gt;busy
op_eq
l_int|0
)paren
(brace
id|st5481_usb_pipe_reset
c_func
(paren
id|adapter
comma
(paren
id|bcs-&gt;channel
op_plus
l_int|1
)paren
op_star
l_int|2
op_or
id|USB_DIR_OUT
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|DBG
c_func
(paren
l_int|1
comma
l_string|&quot;urb killed&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
singleline_comment|// Give up
)brace
)brace
id|usb_b_out
c_func
(paren
id|bcs
comma
id|buf_nr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;number_of_leds
op_eq
l_int|2
)paren
id|led_blink
c_func
(paren
id|adapter
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Start or stop the transfer on the B channel.&n; */
DECL|function|st5481B_mode
r_static
r_void
id|st5481B_mode
c_func
(paren
r_struct
id|st5481_bcs
op_star
id|bcs
comma
r_int
id|mode
)paren
(brace
r_struct
id|st5481_b_out
op_star
id|b_out
op_assign
op_amp
id|bcs-&gt;b_out
suffix:semicolon
r_struct
id|st5481_adapter
op_star
id|adapter
op_assign
id|bcs-&gt;adapter
suffix:semicolon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;B%d,mode=%d&quot;
comma
id|bcs-&gt;channel
op_plus
l_int|1
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcs-&gt;mode
op_eq
id|mode
)paren
r_return
suffix:semicolon
id|bcs-&gt;mode
op_assign
id|mode
suffix:semicolon
singleline_comment|// Cancel all USB transfers on this B channel
id|usb_unlink_urb
c_func
(paren
id|b_out-&gt;urb
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|b_out-&gt;urb
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|b_out-&gt;busy
op_assign
l_int|0
suffix:semicolon
id|st5481_in_mode
c_func
(paren
op_amp
id|bcs-&gt;b_in
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcs-&gt;mode
op_ne
id|L1_MODE_NULL
)paren
(brace
singleline_comment|// Open the B channel
r_if
c_cond
(paren
id|bcs-&gt;mode
op_ne
id|L1_MODE_TRANS
)paren
(brace
id|hdlc_out_init
c_func
(paren
op_amp
id|b_out-&gt;hdlc_state
comma
l_int|0
comma
id|bcs-&gt;mode
op_eq
id|L1_MODE_HDLC_56K
)paren
suffix:semicolon
)brace
id|st5481_usb_pipe_reset
c_func
(paren
id|adapter
comma
(paren
id|bcs-&gt;channel
op_plus
l_int|1
)paren
op_star
l_int|2
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
singleline_comment|// Enable B channel interrupts
id|st5481_usb_device_ctrl_msg
c_func
(paren
id|adapter
comma
id|FFMSK_B1
op_plus
(paren
id|bcs-&gt;channel
op_star
l_int|2
)paren
comma
id|OUT_UP
op_plus
id|OUT_DOWN
op_plus
id|OUT_UNDERRUN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
singleline_comment|// Enable B channel FIFOs
id|st5481_usb_device_ctrl_msg
c_func
(paren
id|adapter
comma
id|OUT_B1_COUNTER
op_plus
(paren
id|bcs-&gt;channel
op_star
l_int|2
)paren
comma
l_int|32
comma
id|st5481B_start_xfer
comma
id|bcs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;number_of_leds
op_eq
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|bcs-&gt;channel
op_eq
l_int|0
)paren
(brace
id|adapter-&gt;leds
op_or_assign
id|B1_LED
suffix:semicolon
)brace
r_else
(brace
id|adapter-&gt;leds
op_or_assign
id|B2_LED
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
singleline_comment|// Disble B channel interrupts
id|st5481_usb_device_ctrl_msg
c_func
(paren
id|adapter
comma
id|FFMSK_B1
op_plus
(paren
id|bcs-&gt;channel
op_star
l_int|2
)paren
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
singleline_comment|// Disable B channel FIFOs
id|st5481_usb_device_ctrl_msg
c_func
(paren
id|adapter
comma
id|OUT_B1_COUNTER
op_plus
(paren
id|bcs-&gt;channel
op_star
l_int|2
)paren
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;number_of_leds
op_eq
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|bcs-&gt;channel
op_eq
l_int|0
)paren
(brace
id|adapter-&gt;leds
op_and_assign
op_complement
id|B1_LED
suffix:semicolon
)brace
r_else
(brace
id|adapter-&gt;leds
op_and_assign
op_complement
id|B2_LED
suffix:semicolon
)brace
)brace
r_else
(brace
id|st5481_usb_device_ctrl_msg
c_func
(paren
id|adapter
comma
id|GPIO_OUT
comma
id|adapter-&gt;leds
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|b_out-&gt;tx_skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|b_out-&gt;tx_skb
)paren
suffix:semicolon
id|b_out-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
DECL|function|st5481_setup_b_out
r_static
r_int
id|__devinit
id|st5481_setup_b_out
c_func
(paren
r_struct
id|st5481_bcs
op_star
id|bcs
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|bcs-&gt;adapter-&gt;usb_dev
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|altsetting
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|endpoint
suffix:semicolon
r_struct
id|st5481_b_out
op_star
id|b_out
op_assign
op_amp
id|bcs-&gt;b_out
suffix:semicolon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
id|altsetting
op_assign
op_amp
(paren
id|dev-&gt;config-&gt;interface
(braket
l_int|0
)braket
dot
id|altsetting
(braket
l_int|3
)braket
)paren
suffix:semicolon
singleline_comment|// Allocate URBs and buffers for the B channel out
id|endpoint
op_assign
op_amp
id|altsetting-&gt;endpoint
(braket
id|EP_B1_OUT
op_minus
l_int|1
op_plus
id|bcs-&gt;channel
op_star
l_int|2
)braket
suffix:semicolon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;endpoint address=%02x,packet size=%d&quot;
comma
id|endpoint-&gt;bEndpointAddress
comma
id|endpoint-&gt;wMaxPacketSize
)paren
suffix:semicolon
singleline_comment|// Allocate memory for 8000bytes/sec + extra bytes if underrun
r_return
id|st5481_setup_isocpipes
c_func
(paren
id|b_out-&gt;urb
comma
id|dev
comma
id|usb_sndisocpipe
c_func
(paren
id|dev
comma
id|endpoint-&gt;bEndpointAddress
)paren
comma
id|NUM_ISO_PACKETS_B
comma
id|SIZE_ISO_PACKETS_B_OUT
comma
id|NUM_ISO_PACKETS_B
op_star
id|SIZE_ISO_PACKETS_B_OUT
op_plus
id|B_FLOW_ADJUST
comma
id|usb_b_out_complete
comma
id|bcs
)paren
suffix:semicolon
)brace
DECL|function|st5481_release_b_out
r_static
r_void
id|__devexit
id|st5481_release_b_out
c_func
(paren
r_struct
id|st5481_bcs
op_star
id|bcs
)paren
(brace
r_struct
id|st5481_b_out
op_star
id|b_out
op_assign
op_amp
id|bcs-&gt;b_out
suffix:semicolon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
id|st5481_release_isocpipes
c_func
(paren
id|b_out-&gt;urb
)paren
suffix:semicolon
)brace
DECL|function|st5481_setup_b
r_int
id|__devinit
id|st5481_setup_b
c_func
(paren
r_struct
id|st5481_bcs
op_star
id|bcs
)paren
(brace
r_int
id|retval
suffix:semicolon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|st5481_setup_b_out
c_func
(paren
id|bcs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|err
suffix:semicolon
id|bcs-&gt;b_in.bufsize
op_assign
id|HSCX_BUFMAX
suffix:semicolon
id|bcs-&gt;b_in.num_packets
op_assign
id|NUM_ISO_PACKETS_B
suffix:semicolon
id|bcs-&gt;b_in.packet_size
op_assign
id|SIZE_ISO_PACKETS_B_IN
suffix:semicolon
id|bcs-&gt;b_in.ep
op_assign
(paren
id|bcs-&gt;channel
ques
c_cond
id|EP_B2_IN
suffix:colon
id|EP_B1_IN
)paren
op_or
id|USB_DIR_IN
suffix:semicolon
id|bcs-&gt;b_in.counter
op_assign
id|bcs-&gt;channel
ques
c_cond
id|IN_B2_COUNTER
suffix:colon
id|IN_B1_COUNTER
suffix:semicolon
id|bcs-&gt;b_in.adapter
op_assign
id|bcs-&gt;adapter
suffix:semicolon
id|bcs-&gt;b_in.hisax_if
op_assign
op_amp
id|bcs-&gt;b_if.ifc
suffix:semicolon
id|retval
op_assign
id|st5481_setup_in
c_func
(paren
op_amp
id|bcs-&gt;b_in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|err_b_out
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_b_out
suffix:colon
id|st5481_release_b_out
c_func
(paren
id|bcs
)paren
suffix:semicolon
id|err
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Release buffers and URBs for the B channels&n; */
DECL|function|st5481_release_b
r_void
id|__devexit
id|st5481_release_b
c_func
(paren
r_struct
id|st5481_bcs
op_star
id|bcs
)paren
(brace
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
id|st5481_release_in
c_func
(paren
op_amp
id|bcs-&gt;b_in
)paren
suffix:semicolon
id|st5481_release_b_out
c_func
(paren
id|bcs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * st5481_b_l2l1 is the entry point for upper layer routines that want to&n; * transmit on the B channel.  PH_DATA | REQUEST is a normal packet that&n; * we either start transmitting (if idle) or queue (if busy).&n; * PH_PULL | REQUEST can be called to request a callback message&n; * (PH_PULL | CONFIRM)&n; * once the link is idle.  After a &quot;pull&quot; callback, the upper layer&n; * routines can use PH_PULL | INDICATION to send data.&n; */
DECL|function|st5481_b_l2l1
r_void
id|st5481_b_l2l1
c_func
(paren
r_struct
id|hisax_if
op_star
id|ifc
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|st5481_bcs
op_star
id|bcs
op_assign
id|ifc-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
r_int
id|mode
suffix:semicolon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
id|PH_DATA
op_or
id|REQUEST
suffix:colon
r_if
c_cond
(paren
id|bcs-&gt;b_out.tx_skb
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|bcs-&gt;b_out.tx_skb
op_assign
id|skb
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PH_ACTIVATE
op_or
id|REQUEST
suffix:colon
id|mode
op_assign
(paren
r_int
)paren
id|arg
suffix:semicolon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;B%d,PH_ACTIVATE_REQUEST %d&quot;
comma
id|bcs-&gt;channel
op_plus
l_int|1
comma
id|mode
)paren
suffix:semicolon
id|st5481B_mode
c_func
(paren
id|bcs
comma
id|mode
)paren
suffix:semicolon
id|B_L1L2
c_func
(paren
id|bcs
comma
id|PH_ACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PH_DEACTIVATE
op_or
id|REQUEST
suffix:colon
id|DBG
c_func
(paren
l_int|4
comma
l_string|&quot;B%d,PH_DEACTIVATE_REQUEST&quot;
comma
id|bcs-&gt;channel
op_plus
l_int|1
)paren
suffix:semicolon
id|st5481B_mode
c_func
(paren
id|bcs
comma
id|L1_MODE_NULL
)paren
suffix:semicolon
id|B_L1L2
c_func
(paren
id|bcs
comma
id|PH_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|WARN
c_func
(paren
l_string|&quot;pr %#x&bslash;n&quot;
comma
id|pr
)paren
suffix:semicolon
)brace
)brace
eof
