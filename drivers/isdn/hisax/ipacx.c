multiline_comment|/* &n; *&n; * IPACX specific routines&n; *&n; * Author       Joerg Petersohn&n; * Derived from hisax_isac.c, isac.c, hscx.c and others&n; * &n; * This software may be used and distributed according to the terms&n; * of the GNU General Public License, incorporated herein by reference.&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &quot;hisax_if.h&quot;
macro_line|#include &quot;hisax.h&quot;
macro_line|#include &quot;isdnl1.h&quot;
macro_line|#include &quot;ipacx.h&quot;
DECL|macro|DBUSY_TIMER_VALUE
mdefine_line|#define DBUSY_TIMER_VALUE 80
DECL|macro|TIMER3_VALUE
mdefine_line|#define TIMER3_VALUE      7000
DECL|macro|MAX_DFRAME_LEN_L1
mdefine_line|#define MAX_DFRAME_LEN_L1 300
DECL|macro|B_FIFO_SIZE
mdefine_line|#define B_FIFO_SIZE       64
DECL|macro|D_FIFO_SIZE
mdefine_line|#define D_FIFO_SIZE       32
singleline_comment|// ipacx interrupt mask values    
DECL|macro|_MASK_IMASK
mdefine_line|#define _MASK_IMASK     0x2E  
singleline_comment|// global mask
DECL|macro|_MASKB_IMASK
mdefine_line|#define _MASKB_IMASK    0x0B
DECL|macro|_MASKD_IMASK
mdefine_line|#define _MASKD_IMASK    0x03  
singleline_comment|// all on
singleline_comment|//----------------------------------------------------------
singleline_comment|// local function declarations
singleline_comment|//----------------------------------------------------------
r_static
r_void
id|ph_command
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
r_int
id|command
)paren
suffix:semicolon
r_static
r_inline
r_void
id|cic_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_void
id|dch_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
suffix:semicolon
r_static
r_void
id|dbusy_timer_handler
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_void
id|ipacx_new_ph
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_void
id|dch_bh
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|dch_empty_fifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|dch_fill_fifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_inline
r_void
id|dch_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_void
id|bch_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
suffix:semicolon
r_static
r_void
id|ipacx_bc_empty_fifo
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|bch_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
id|hscx
)paren
suffix:semicolon
r_static
r_void
id|bch_mode
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|mode
comma
r_int
id|bc
)paren
suffix:semicolon
r_static
r_void
id|bch_close_state
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
suffix:semicolon
r_static
r_int
id|bch_open_state
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_struct
id|BCState
op_star
id|bcs
)paren
suffix:semicolon
r_static
r_int
id|bch_setstack
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|BCState
op_star
id|bcs
)paren
suffix:semicolon
r_static
r_void
id|__devinit
id|bch_init
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|hscx
)paren
suffix:semicolon
r_static
r_void
id|__init
id|clear_pending_ints
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_inline
id|u8
DECL|function|ipacx_bc_read_reg
id|ipacx_bc_read_reg
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
id|u8
id|addr
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_return
id|cs-&gt;bc_hw_ops
op_member_access_from_pointer
id|read_reg
c_func
(paren
id|cs
comma
id|bcs-&gt;unit
comma
id|addr
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ipacx_bc_write_reg
id|ipacx_bc_write_reg
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
id|u8
id|addr
comma
id|u8
id|val
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
id|cs-&gt;bc_hw_ops
op_member_access_from_pointer
id|write_reg
c_func
(paren
id|cs
comma
id|bcs-&gt;unit
comma
id|addr
comma
id|val
)paren
suffix:semicolon
)brace
r_static
r_inline
id|u8
DECL|function|ipacx_read_reg
id|ipacx_read_reg
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
id|addr
)paren
(brace
r_return
id|cs-&gt;dc_hw_ops
op_member_access_from_pointer
id|read_reg
c_func
(paren
id|cs
comma
id|addr
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ipacx_write_reg
id|ipacx_write_reg
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
id|addr
comma
id|u8
id|val
)paren
(brace
id|cs-&gt;dc_hw_ops
op_member_access_from_pointer
id|write_reg
c_func
(paren
id|cs
comma
id|addr
comma
id|val
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ipacx_read_fifo
id|ipacx_read_fifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
op_star
id|p
comma
r_int
id|len
)paren
(brace
r_return
id|cs-&gt;dc_hw_ops
op_member_access_from_pointer
id|read_fifo
c_func
(paren
id|cs
comma
id|p
comma
id|len
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ipacx_write_fifo
id|ipacx_write_fifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
op_star
id|p
comma
r_int
id|len
)paren
(brace
r_return
id|cs-&gt;dc_hw_ops
op_member_access_from_pointer
id|write_fifo
c_func
(paren
id|cs
comma
id|p
comma
id|len
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Issue Layer 1 command to chip
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|ph_command
id|ph_command
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
r_int
id|command
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;ph_command (%#x) in (%#x)&quot;
comma
id|command
comma
id|cs-&gt;dc.isac.ph_state
)paren
suffix:semicolon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CIX0
comma
(paren
id|command
op_lshift
l_int|4
)paren
op_or
l_int|0x0E
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Transceiver interrupt handler
singleline_comment|//----------------------------------------------------------
r_static
r_inline
r_void
DECL|function|cic_int
id|cic_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|u8
id|event
suffix:semicolon
id|event
op_assign
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_CIR0
)paren
op_rshift
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;cic_int(event=%#x)&quot;
comma
id|event
)paren
suffix:semicolon
id|cs-&gt;dc.isac.ph_state
op_assign
id|event
suffix:semicolon
id|sched_d_event
c_func
(paren
id|cs
comma
id|D_L1STATECHANGE
)paren
suffix:semicolon
)brace
singleline_comment|//==========================================================
singleline_comment|// D channel functions
singleline_comment|//==========================================================
singleline_comment|//----------------------------------------------------------
singleline_comment|// Command entry point
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|dch_l2l1
id|dch_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
(paren
r_struct
id|IsdnCardState
op_star
)paren
id|st-&gt;l1.hardware
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
id|u8
id|cda1_cr
comma
id|cda2_cr
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_DATA
op_or
id|REQUEST
)paren
suffix:colon
id|xmit_data_req_d
c_func
(paren
id|cs
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL
op_or
id|INDICATION
)paren
suffix:colon
id|xmit_pull_ind_d
c_func
(paren
id|cs
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL
op_or
id|REQUEST
)paren
suffix:colon
id|xmit_pull_req_d
c_func
(paren
id|st
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HW_RESET
op_or
id|REQUEST
)paren
suffix:colon
r_case
(paren
id|HW_ENABLE
op_or
id|REQUEST
)paren
suffix:colon
id|ph_command
c_func
(paren
id|cs
comma
id|IPACX_CMD_TIM
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HW_INFO3
op_or
id|REQUEST
)paren
suffix:colon
id|ph_command
c_func
(paren
id|cs
comma
id|IPACX_CMD_AR8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HW_TESTLOOP
op_or
id|REQUEST
)paren
suffix:colon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CDA_TSDP10
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// Timeslot 0 is B1
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CDA_TSDP11
comma
l_int|0x81
)paren
suffix:semicolon
singleline_comment|// Timeslot 0 is B1
id|cda1_cr
op_assign
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_CDA1_CR
)paren
suffix:semicolon
id|cda2_cr
op_assign
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_CDA2_CR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|arg
op_amp
l_int|1
)paren
(brace
singleline_comment|// loop B1
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CDA1_CR
comma
id|cda1_cr
op_or
l_int|0x0a
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// B1 off
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CDA1_CR
comma
id|cda1_cr
op_amp
op_complement
l_int|0x0a
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|arg
op_amp
l_int|2
)paren
(brace
singleline_comment|// loop B2
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CDA1_CR
comma
id|cda1_cr
op_or
l_int|0x14
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// B2 off
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CDA1_CR
comma
id|cda1_cr
op_amp
op_complement
l_int|0x14
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
id|HW_DEACTIVATE
op_or
id|RESPONSE
)paren
suffix:colon
id|skb_queue_purge
c_func
(paren
op_amp
id|cs-&gt;rq
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|cs-&gt;sq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|cs-&gt;tx_skb
)paren
suffix:semicolon
id|cs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_l2l1 unknown %04x&quot;
comma
id|pr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|dbusy_timer_handler
id|dbusy_timer_handler
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_struct
id|PStack
op_star
id|st
suffix:semicolon
r_int
id|rbchd
comma
id|stard
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
(brace
id|rbchd
op_assign
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_RBCHD
)paren
suffix:semicolon
id|stard
op_assign
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_STARD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;D-Channel Busy RBCHD %02x STARD %02x&quot;
comma
id|rbchd
comma
id|stard
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|stard
op_amp
l_int|0x40
)paren
)paren
(brace
singleline_comment|// D-Channel Busy
id|set_bit
c_func
(paren
id|FLG_L1_DBUSY
comma
op_amp
id|cs-&gt;HW_Flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|st
op_assign
id|cs-&gt;stlist
suffix:semicolon
id|st
suffix:semicolon
id|st
op_assign
id|st-&gt;next
)paren
(brace
id|st-&gt;l2
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_PAUSE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
singleline_comment|// flow control on
)brace
)brace
r_else
(brace
singleline_comment|// seems we lost an interrupt; reset transceiver */
id|clear_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|cs-&gt;tx_skb
)paren
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: ISAC D-Channel Busy no skb&bslash;n&quot;
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;D-Channel Busy no skb&quot;
)paren
suffix:semicolon
)brace
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
l_int|0x01
)paren
suffix:semicolon
singleline_comment|// Tx reset, generates XPR
)brace
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// L1 state machine intermediate layer to isdnl1 module
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|ipacx_new_ph
id|ipacx_new_ph
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_switch
c_cond
(paren
id|cs-&gt;dc.isac.ph_state
)paren
(brace
r_case
(paren
id|IPACX_IND_RES
)paren
suffix:colon
id|ph_command
c_func
(paren
id|cs
comma
id|IPACX_CMD_DI
)paren
suffix:semicolon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_RESET
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_DC
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_DEACTIVATE
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_DR
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_PU
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_POWERUP
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_RSY
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_RSYNC
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_AR
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_INFO2
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_AI8
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_INFO4_P8
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_AI10
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_INFO4_P10
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// bottom half handler for D channel
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|dch_bh
id|dch_bh
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|data
suffix:semicolon
r_struct
id|PStack
op_star
id|st
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_CLEARBUSY
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;D-Channel Busy cleared&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|st
op_assign
id|cs-&gt;stlist
suffix:semicolon
id|st
suffix:semicolon
id|st
op_assign
id|st-&gt;next
)paren
(brace
id|st-&gt;l2
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_PAUSE
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_RCVBUFREADY
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
id|DChannel_proc_rcv
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_XMTBUFREADY
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
id|DChannel_proc_xmt
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_L1STATECHANGE
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
id|ipacx_new_ph
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Fill buffer from receive FIFO
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|dch_empty_fifo
id|dch_empty_fifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|count
)paren
(brace
id|recv_empty_fifo_d
c_func
(paren
id|cs
comma
id|count
)paren
suffix:semicolon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// RMC
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Fill transmit FIFO
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|dch_fill_fifo
id|dch_fill_fifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_int
id|count
comma
id|more
suffix:semicolon
r_int
r_char
id|cmd
comma
op_star
id|p
suffix:semicolon
id|p
op_assign
id|xmit_fill_fifo_d
c_func
(paren
id|cs
comma
l_int|32
comma
op_amp
id|count
comma
op_amp
id|more
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|more
)paren
(brace
id|cmd
op_assign
l_int|0x08
suffix:semicolon
singleline_comment|// XTF
)brace
r_else
(brace
id|cmd
op_assign
l_int|0x0A
suffix:semicolon
singleline_comment|// XTF | XME
)brace
id|ipacx_write_fifo
c_func
(paren
id|cs
comma
id|p
comma
id|count
)paren
suffix:semicolon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
id|cmd
)paren
suffix:semicolon
singleline_comment|// set timeout for transmission contol
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
(brace
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_fill_fifo dbusytimer running&quot;
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
id|cs-&gt;dbusytimer.expires
op_assign
id|jiffies
op_plus
(paren
(paren
id|DBUSY_TIMER_VALUE
op_star
id|HZ
)paren
op_div
l_int|1000
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// D channel interrupt handler
singleline_comment|//----------------------------------------------------------
r_static
r_inline
r_void
DECL|function|dch_int
id|dch_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|u8
id|istad
comma
id|rstad
suffix:semicolon
r_int
id|count
suffix:semicolon
id|istad
op_assign
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_ISTAD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|istad
op_amp
l_int|0x80
)paren
(brace
singleline_comment|// RME
id|rstad
op_assign
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_RSTAD
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rstad
op_amp
l_int|0xf0
)paren
op_ne
l_int|0xa0
)paren
(brace
singleline_comment|// !(VFR &amp;&amp; !RDO &amp;&amp; CRC &amp;&amp; !RAB)
r_if
c_cond
(paren
op_logical_neg
(paren
id|rstad
op_amp
l_int|0x80
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_int(): invalid frame&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rstad
op_amp
l_int|0x40
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_int(): RDO&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rstad
op_amp
l_int|0x20
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_int(): CRC error&quot;
)paren
suffix:semicolon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// RMC
id|cs-&gt;rcvidx
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// received frame ok
id|count
op_assign
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_RBCLD
)paren
suffix:semicolon
singleline_comment|// FIXME this looks flaky
r_if
c_cond
(paren
id|count
)paren
id|count
op_decrement
suffix:semicolon
singleline_comment|// RSTAB is last byte
id|count
op_and_assign
id|D_FIFO_SIZE
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
id|count
op_assign
id|D_FIFO_SIZE
suffix:semicolon
id|dch_empty_fifo
c_func
(paren
id|cs
comma
id|count
)paren
suffix:semicolon
id|recv_rme_d
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|istad
op_amp
l_int|0x40
)paren
(brace
singleline_comment|// RPF
id|dch_empty_fifo
c_func
(paren
id|cs
comma
id|D_FIFO_SIZE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istad
op_amp
l_int|0x20
)paren
(brace
singleline_comment|// RFO
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_int(): RFO&quot;
)paren
suffix:semicolon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
l_int|0x40
)paren
suffix:semicolon
singleline_comment|//RRES
)brace
r_if
c_cond
(paren
id|istad
op_amp
l_int|0x10
)paren
(brace
singleline_comment|// XPR
id|xmit_xpr_d
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istad
op_amp
l_int|0x0C
)paren
(brace
singleline_comment|// XDU or XMR
id|xmit_xdu_d
c_func
(paren
id|cs
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_int
DECL|function|dch_setstack
id|dch_setstack
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|st-&gt;l1.l1hw
op_assign
id|dch_l2l1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ipacx_dc_l1_ops
r_static
r_struct
id|dc_l1_ops
id|ipacx_dc_l1_ops
op_assign
(brace
dot
id|fill_fifo
op_assign
id|dch_fill_fifo
comma
dot
id|open
op_assign
id|dch_setstack
comma
dot
id|bh_func
op_assign
id|dch_bh
comma
dot
id|dbusy_func
op_assign
id|dbusy_timer_handler
comma
)brace
suffix:semicolon
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_void
id|__devinit
DECL|function|dch_init
id|dch_init
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HiSax: IPACX ISDN driver v0.1.0&bslash;n&quot;
)paren
suffix:semicolon
id|dc_l1_init
c_func
(paren
id|cs
comma
op_amp
id|ipacx_dc_l1_ops
)paren
suffix:semicolon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_TR_CONF0
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// clear LDD
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_TR_CONF2
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// enable transmitter
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_MODED
comma
l_int|0xC9
)paren
suffix:semicolon
singleline_comment|// transparent mode 0, RAC, stop/go
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_MON_CR
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// disable monitor channel
)brace
singleline_comment|//==========================================================
singleline_comment|// B channel functions
singleline_comment|//==========================================================
singleline_comment|//----------------------------------------------------------
singleline_comment|// Entry point for commands
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|bch_l2l1
id|bch_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_DATA
op_or
id|REQUEST
)paren
suffix:colon
id|xmit_data_req_b
c_func
(paren
id|st-&gt;l1.bcs
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL
op_or
id|INDICATION
)paren
suffix:colon
id|xmit_pull_ind_b
c_func
(paren
id|st-&gt;l1.bcs
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL
op_or
id|REQUEST
)paren
suffix:colon
id|xmit_pull_req_b
c_func
(paren
id|st
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_ACTIVATE
op_or
id|REQUEST
)paren
suffix:colon
id|set_bit
c_func
(paren
id|BC_FLG_ACTIV
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|bch_mode
c_func
(paren
id|st-&gt;l1.bcs
comma
id|st-&gt;l1.mode
comma
id|st-&gt;l1.bc
)paren
suffix:semicolon
id|l1_msg_b
c_func
(paren
id|st
comma
id|pr
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_DEACTIVATE
op_or
id|REQUEST
)paren
suffix:colon
id|l1_msg_b
c_func
(paren
id|st
comma
id|pr
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_DEACTIVATE
op_or
id|CONFIRM
)paren
suffix:colon
id|clear_bit
c_func
(paren
id|BC_FLG_ACTIV
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|bch_mode
c_func
(paren
id|st-&gt;l1.bcs
comma
l_int|0
comma
id|st-&gt;l1.bc
)paren
suffix:semicolon
id|st-&gt;l2
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_DEACTIVATE
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Read B channel fifo to receive buffer
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|ipacx_bc_empty_fifo
id|ipacx_bc_empty_fifo
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|count
)paren
(brace
id|recv_empty_fifo_b
c_func
(paren
id|bcs
comma
id|count
)paren
suffix:semicolon
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_CMDRB
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// RMC
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Fill buffer to transmit FIFO
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|ipacx_bc_fill_fifo
id|ipacx_bc_fill_fifo
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_int
id|more
comma
id|count
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
id|p
op_assign
id|xmit_fill_fifo_b
c_func
(paren
id|bcs
comma
id|B_FIFO_SIZE
comma
op_amp
id|count
comma
op_amp
id|more
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_XFIFOB
comma
op_star
id|p
op_increment
)paren
suffix:semicolon
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_CMDRB
comma
(paren
id|more
ques
c_cond
l_int|0x08
suffix:colon
l_int|0x0a
)paren
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// B channel interrupt handler
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|reset_xmit
id|reset_xmit
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_CMDRB
comma
l_int|0x01
)paren
suffix:semicolon
singleline_comment|// XRES
)brace
r_static
r_void
DECL|function|bch_int
id|bch_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u8
id|hscx
)paren
(brace
id|u8
id|istab
suffix:semicolon
r_struct
id|BCState
op_star
id|bcs
suffix:semicolon
r_int
id|count
suffix:semicolon
id|u8
id|rstab
suffix:semicolon
id|bcs
op_assign
id|cs-&gt;bcs
op_plus
id|hscx
suffix:semicolon
id|istab
op_assign
id|ipacx_bc_read_reg
c_func
(paren
id|bcs
comma
id|IPACX_ISTAB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|istab
op_amp
l_int|0x80
)paren
(brace
singleline_comment|// RME
id|rstab
op_assign
id|ipacx_bc_read_reg
c_func
(paren
id|bcs
comma
id|IPACX_RSTAB
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rstab
op_amp
l_int|0xf0
)paren
op_ne
l_int|0xa0
)paren
(brace
singleline_comment|// !(VFR &amp;&amp; !RDO &amp;&amp; CRC &amp;&amp; !RAB)
r_if
c_cond
(paren
op_logical_neg
(paren
id|rstab
op_amp
l_int|0x80
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_int() B-%d: invalid frame&quot;
comma
id|hscx
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rstab
op_amp
l_int|0x40
)paren
op_logical_and
(paren
id|bcs-&gt;mode
op_ne
id|L1_MODE_NULL
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_int() B-%d: RDO mode=%d&quot;
comma
id|hscx
comma
id|bcs-&gt;mode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rstab
op_amp
l_int|0x20
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_int() B-%d: CRC error&quot;
comma
id|hscx
)paren
suffix:semicolon
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_CMDRB
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// RMC
id|bcs-&gt;rcvidx
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// received frame ok
id|count
op_assign
id|ipacx_bc_read_reg
c_func
(paren
id|bcs
comma
id|IPACX_RBCLB
)paren
op_amp
(paren
id|B_FIFO_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
id|count
op_assign
id|B_FIFO_SIZE
suffix:semicolon
id|ipacx_bc_empty_fifo
c_func
(paren
id|bcs
comma
id|count
)paren
suffix:semicolon
id|recv_rme_b
c_func
(paren
id|bcs
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|istab
op_amp
l_int|0x40
)paren
(brace
singleline_comment|// RPF
id|ipacx_bc_empty_fifo
c_func
(paren
id|bcs
comma
id|B_FIFO_SIZE
)paren
suffix:semicolon
id|recv_rpf_b
c_func
(paren
id|bcs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istab
op_amp
l_int|0x20
)paren
(brace
singleline_comment|// RFO
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_int() B-%d: RFO error&quot;
comma
id|hscx
)paren
suffix:semicolon
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_CMDRB
comma
l_int|0x40
)paren
suffix:semicolon
singleline_comment|// RRES
)brace
r_if
c_cond
(paren
id|istab
op_amp
l_int|0x10
)paren
(brace
singleline_comment|// XPR
id|xmit_xpr_b
c_func
(paren
id|bcs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istab
op_amp
l_int|0x04
)paren
(brace
singleline_comment|// XDU
id|xmit_xdu_b
c_func
(paren
id|bcs
comma
id|reset_xmit
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|bch_mode
id|bch_mode
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|mode
comma
r_int
id|bc
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_int
id|hscx
op_assign
id|bcs-&gt;unit
suffix:semicolon
id|bc
op_assign
id|bc
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
singleline_comment|// in case bc is greater than 1
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;mode_bch() switch B-% mode %d chan %d&quot;
comma
id|hscx
comma
id|mode
comma
id|bc
)paren
suffix:semicolon
id|bcs-&gt;mode
op_assign
id|mode
suffix:semicolon
id|bcs-&gt;channel
op_assign
id|bc
suffix:semicolon
singleline_comment|// map controller to according timeslot
r_if
c_cond
(paren
op_logical_neg
id|hscx
)paren
(brace
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_BCHA_TSDP_BC1
comma
l_int|0x80
op_or
id|bc
)paren
suffix:semicolon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_BCHA_CR
comma
l_int|0x88
)paren
suffix:semicolon
)brace
r_else
(brace
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_BCHB_TSDP_BC1
comma
l_int|0x80
op_or
id|bc
)paren
suffix:semicolon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_BCHB_CR
comma
l_int|0x88
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
(paren
id|L1_MODE_NULL
)paren
suffix:colon
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_MODEB
comma
l_int|0xC0
)paren
suffix:semicolon
singleline_comment|// rec off
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_EXMB
comma
l_int|0x30
)paren
suffix:semicolon
singleline_comment|// std adj.
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_MASKB
comma
l_int|0xFF
)paren
suffix:semicolon
singleline_comment|// ints off
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_CMDRB
comma
l_int|0x41
)paren
suffix:semicolon
singleline_comment|// validate adjustments
r_break
suffix:semicolon
r_case
(paren
id|L1_MODE_TRANS
)paren
suffix:colon
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_MODEB
comma
l_int|0x88
)paren
suffix:semicolon
singleline_comment|// ext transp mode
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_EXMB
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// xxx00000
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_CMDRB
comma
l_int|0x41
)paren
suffix:semicolon
singleline_comment|// validate adjustments
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_MASKB
comma
id|_MASKB_IMASK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|L1_MODE_HDLC
)paren
suffix:colon
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_MODEB
comma
l_int|0xC8
)paren
suffix:semicolon
singleline_comment|// transp mode 0
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_EXMB
comma
l_int|0x01
)paren
suffix:semicolon
singleline_comment|// idle=hdlc flags crc enabled
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_CMDRB
comma
l_int|0x41
)paren
suffix:semicolon
singleline_comment|// validate adjustments
id|ipacx_bc_write_reg
c_func
(paren
id|bcs
comma
id|IPACX_MASKB
comma
id|_MASKB_IMASK
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|bch_close_state
id|bch_close_state
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
id|bch_mode
c_func
(paren
id|bcs
comma
l_int|0
comma
id|bcs-&gt;channel
)paren
suffix:semicolon
id|bc_close
c_func
(paren
id|bcs
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_int
DECL|function|bch_open_state
id|bch_open_state
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_return
id|bc_open
c_func
(paren
id|bcs
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_int
DECL|function|bch_setstack
id|bch_setstack
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
id|bcs-&gt;channel
op_assign
id|st-&gt;l1.bc
suffix:semicolon
r_if
c_cond
(paren
id|bch_open_state
c_func
(paren
id|st-&gt;l1.hardware
comma
id|bcs
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|st-&gt;l1.bcs
op_assign
id|bcs
suffix:semicolon
id|st-&gt;l1.l2l1
op_assign
id|bch_l2l1
suffix:semicolon
id|setstack_manager
c_func
(paren
id|st
)paren
suffix:semicolon
id|bcs-&gt;st
op_assign
id|st
suffix:semicolon
id|setstack_l1_B
c_func
(paren
id|st
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_void
id|__devinit
DECL|function|bch_init
id|bch_init
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|hscx
)paren
(brace
id|cs-&gt;bcs
(braket
id|hscx
)braket
dot
id|unit
op_assign
id|hscx
suffix:semicolon
id|cs-&gt;bcs
(braket
id|hscx
)braket
dot
id|cs
op_assign
id|cs
suffix:semicolon
id|bch_mode
c_func
(paren
id|cs-&gt;bcs
op_plus
id|hscx
comma
l_int|0
comma
id|hscx
)paren
suffix:semicolon
)brace
singleline_comment|//==========================================================
singleline_comment|// Shared functions
singleline_comment|//==========================================================
singleline_comment|//----------------------------------------------------------
singleline_comment|// Main interrupt handler
singleline_comment|//----------------------------------------------------------
r_void
DECL|function|interrupt_ipacx
id|interrupt_ipacx
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|u8
id|ista
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|cs-&gt;lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ista
op_assign
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_ISTA
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x80
)paren
id|bch_int
c_func
(paren
id|cs
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// B channel interrupts
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x40
)paren
id|bch_int
c_func
(paren
id|cs
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x01
)paren
id|dch_int
c_func
(paren
id|cs
)paren
suffix:semicolon
singleline_comment|// D channel
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x10
)paren
id|cic_int
c_func
(paren
id|cs
)paren
suffix:semicolon
singleline_comment|// Layer 1 state
)brace
id|spin_unlock
c_func
(paren
op_amp
id|cs-&gt;lock
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Clears chip interrupt status
singleline_comment|//----------------------------------------------------------
r_static
r_void
id|__init
DECL|function|clear_pending_ints
id|clear_pending_ints
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_int
id|ista
suffix:semicolon
singleline_comment|// all interrupts off
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_MASK
comma
l_int|0xff
)paren
suffix:semicolon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_MASKD
comma
l_int|0xff
)paren
suffix:semicolon
id|cs-&gt;bc_hw_ops
op_member_access_from_pointer
id|write_reg
c_func
(paren
id|cs
comma
l_int|0
comma
id|IPACX_MASKB
comma
l_int|0xff
)paren
suffix:semicolon
id|cs-&gt;bc_hw_ops
op_member_access_from_pointer
id|write_reg
c_func
(paren
id|cs
comma
l_int|1
comma
id|IPACX_MASKB
comma
l_int|0xff
)paren
suffix:semicolon
id|ista
op_assign
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_ISTA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x80
)paren
id|cs-&gt;bc_hw_ops
op_member_access_from_pointer
id|read_reg
c_func
(paren
id|cs
comma
l_int|0
comma
id|IPACX_ISTAB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x40
)paren
id|cs-&gt;bc_hw_ops
op_member_access_from_pointer
id|read_reg
c_func
(paren
id|cs
comma
l_int|1
comma
id|IPACX_ISTAB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x10
)paren
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_CIR0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x01
)paren
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_ISTAD
)paren
suffix:semicolon
)brace
DECL|variable|ipacx_bc_l1_ops
r_static
r_struct
id|bc_l1_ops
id|ipacx_bc_l1_ops
op_assign
(brace
dot
id|fill_fifo
op_assign
id|ipacx_bc_fill_fifo
comma
dot
id|open
op_assign
id|bch_setstack
comma
dot
id|close
op_assign
id|bch_close_state
comma
)brace
suffix:semicolon
singleline_comment|//----------------------------------------------------------
singleline_comment|// Does chip configuration work
singleline_comment|// Work to do depends on bit mask in part
singleline_comment|//----------------------------------------------------------
r_void
id|__init
DECL|function|init_ipacx
id|init_ipacx
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|part
)paren
(brace
r_if
c_cond
(paren
id|part
op_amp
l_int|1
)paren
(brace
singleline_comment|// initialise chip
id|cs-&gt;bc_l1_ops
op_assign
op_amp
id|ipacx_bc_l1_ops
suffix:semicolon
id|clear_pending_ints
c_func
(paren
id|cs
)paren
suffix:semicolon
id|bch_init
c_func
(paren
id|cs
comma
l_int|0
)paren
suffix:semicolon
id|bch_init
c_func
(paren
id|cs
comma
l_int|1
)paren
suffix:semicolon
id|dch_init
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|part
op_amp
l_int|2
)paren
(brace
singleline_comment|// reenable all interrupts and start chip
id|cs-&gt;bc_hw_ops
op_member_access_from_pointer
id|write_reg
c_func
(paren
id|cs
comma
l_int|0
comma
id|IPACX_MASKB
comma
id|_MASKB_IMASK
)paren
suffix:semicolon
id|cs-&gt;bc_hw_ops
op_member_access_from_pointer
id|write_reg
c_func
(paren
id|cs
comma
l_int|1
comma
id|IPACX_MASKB
comma
id|_MASKB_IMASK
)paren
suffix:semicolon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_MASKD
comma
id|_MASKD_IMASK
)paren
suffix:semicolon
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_MASK
comma
id|_MASK_IMASK
)paren
suffix:semicolon
singleline_comment|// global mask register
singleline_comment|// reset HDLC Transmitters/receivers
id|ipacx_write_reg
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
l_int|0x41
)paren
suffix:semicolon
id|cs-&gt;bc_hw_ops
op_member_access_from_pointer
id|write_reg
c_func
(paren
id|cs
comma
l_int|0
comma
id|IPACX_CMDRB
comma
l_int|0x41
)paren
suffix:semicolon
id|cs-&gt;bc_hw_ops
op_member_access_from_pointer
id|write_reg
c_func
(paren
id|cs
comma
l_int|1
comma
id|IPACX_CMDRB
comma
l_int|0x41
)paren
suffix:semicolon
id|ph_command
c_func
(paren
id|cs
comma
id|IPACX_CMD_RES
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|ipacx_setup
id|ipacx_setup
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_struct
id|dc_hw_ops
op_star
id|ipacx_dc_ops
comma
r_struct
id|bc_hw_ops
op_star
id|ipacx_bc_ops
)paren
(brace
id|u8
id|val
suffix:semicolon
id|cs-&gt;dc_hw_ops
op_assign
id|ipacx_dc_ops
suffix:semicolon
id|cs-&gt;bc_hw_ops
op_assign
id|ipacx_bc_ops
suffix:semicolon
id|val
op_assign
id|ipacx_read_reg
c_func
(paren
id|cs
comma
id|IPACX_ID
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HiSax: IPACX Design Id: %#x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
