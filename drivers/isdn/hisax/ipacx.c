multiline_comment|/* &n; *&n; * IPACX specific routines&n; *&n; * Author       Joerg Petersohn&n; * Derived from hisax_isac.c, isac.c, hscx.c and others&n; * &n; * This software may be used and distributed according to the terms&n; * of the GNU General Public License, incorporated herein by reference.&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;hisax_if.h&quot;
macro_line|#include &quot;hisax.h&quot;
macro_line|#include &quot;isdnl1.h&quot;
macro_line|#include &quot;ipacx.h&quot;
DECL|macro|DBUSY_TIMER_VALUE
mdefine_line|#define DBUSY_TIMER_VALUE 80
DECL|macro|TIMER3_VALUE
mdefine_line|#define TIMER3_VALUE      7000
DECL|macro|MAX_DFRAME_LEN_L1
mdefine_line|#define MAX_DFRAME_LEN_L1 300
DECL|macro|B_FIFO_SIZE
mdefine_line|#define B_FIFO_SIZE       64
DECL|macro|D_FIFO_SIZE
mdefine_line|#define D_FIFO_SIZE       32
singleline_comment|// ipacx interrupt mask values    
DECL|macro|_MASK_IMASK
mdefine_line|#define _MASK_IMASK     0x2E  
singleline_comment|// global mask
DECL|macro|_MASKB_IMASK
mdefine_line|#define _MASKB_IMASK    0x0B
DECL|macro|_MASKD_IMASK
mdefine_line|#define _MASKD_IMASK    0x03  
singleline_comment|// all on
singleline_comment|//----------------------------------------------------------
singleline_comment|// local function declarations
singleline_comment|//----------------------------------------------------------
r_static
r_void
id|ph_command
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
r_int
id|command
)paren
suffix:semicolon
r_static
r_inline
r_void
id|cic_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_void
id|dch_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
suffix:semicolon
r_static
r_void
id|dbusy_timer_handler
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_void
id|ipacx_new_ph
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_void
id|dch_bh
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_void
id|dch_sched_event
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|event
)paren
suffix:semicolon
r_static
r_void
id|dch_empty_fifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|dch_fill_fifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_inline
r_void
id|dch_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_void
id|__devinit
id|dch_setstack
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_void
id|__devinit
id|dch_init
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
r_static
r_void
id|bch_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
suffix:semicolon
r_static
r_void
id|bch_sched_event
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|event
)paren
suffix:semicolon
r_static
r_void
id|bch_empty_fifo
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|bch_fill_fifo
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
suffix:semicolon
r_static
r_void
id|bch_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u_char
id|hscx
)paren
suffix:semicolon
r_static
r_void
id|bch_mode
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|mode
comma
r_int
id|bc
)paren
suffix:semicolon
r_static
r_void
id|bch_close_state
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
suffix:semicolon
r_static
r_int
id|bch_open_state
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_struct
id|BCState
op_star
id|bcs
)paren
suffix:semicolon
r_static
r_int
id|bch_setstack
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|BCState
op_star
id|bcs
)paren
suffix:semicolon
r_static
r_void
id|__devinit
id|bch_init
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|hscx
)paren
suffix:semicolon
r_static
r_void
id|__init
id|clear_pending_ints
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
suffix:semicolon
singleline_comment|//----------------------------------------------------------
singleline_comment|// Issue Layer 1 command to chip
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|ph_command
id|ph_command
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
r_int
id|command
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;ph_command (%#x) in (%#x)&quot;
comma
id|command
comma
id|cs-&gt;dc.isac.ph_state
)paren
suffix:semicolon
singleline_comment|//###################################  
singleline_comment|//&t;printk(KERN_INFO &quot;ph_command (%#x)&bslash;n&quot;, command);
singleline_comment|//###################################  
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CIX0
comma
(paren
id|command
op_lshift
l_int|4
)paren
op_or
l_int|0x0E
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Transceiver interrupt handler
singleline_comment|//----------------------------------------------------------
r_static
r_inline
r_void
DECL|function|cic_int
id|cic_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|u_char
id|event
suffix:semicolon
id|event
op_assign
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_CIR0
)paren
op_rshift
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;cic_int(event=%#x)&quot;
comma
id|event
)paren
suffix:semicolon
singleline_comment|//#########################################  
singleline_comment|//&t;printk(KERN_INFO &quot;cic_int(%x)&bslash;n&quot;, event);
singleline_comment|//#########################################  
id|cs-&gt;dc.isac.ph_state
op_assign
id|event
suffix:semicolon
id|dch_sched_event
c_func
(paren
id|cs
comma
id|D_L1STATECHANGE
)paren
suffix:semicolon
)brace
singleline_comment|//==========================================================
singleline_comment|// D channel functions
singleline_comment|//==========================================================
singleline_comment|//----------------------------------------------------------
singleline_comment|// Command entry point
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|dch_l2l1
id|dch_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
(paren
r_struct
id|IsdnCardState
op_star
)paren
id|st-&gt;l1.hardware
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
id|u_char
id|cda1_cr
comma
id|cda2_cr
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_DATA
op_or
id|REQUEST
)paren
suffix:colon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|DEB_DLOG_HEX
)paren
id|LogFrame
c_func
(paren
id|cs
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|DEB_DLOG_VERBOSE
)paren
id|dlogframe
c_func
(paren
id|cs
comma
id|skb
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;sq
comma
id|skb
)paren
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;PH_DATA Queued&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|cs-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;PH_DATA&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|dch_fill_fifo
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL
op_or
id|INDICATION
)paren
suffix:colon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot; l2l1 tx_skb exist this shouldn&squot;t happen&quot;
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;sq
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|DEB_DLOG_HEX
)paren
id|LogFrame
c_func
(paren
id|cs
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|DEB_DLOG_VERBOSE
)paren
id|dlogframe
c_func
(paren
id|cs
comma
id|skb
comma
l_int|0
)paren
suffix:semicolon
id|cs-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef L2FRAME_DEBUG
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|Logl2Frame
c_func
(paren
id|cs
comma
id|skb
comma
l_string|&quot;PH_DATA_PULLED&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|dch_fill_fifo
c_func
(paren
id|cs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL
op_or
id|REQUEST
)paren
suffix:colon
macro_line|#ifdef L2FRAME_DEBUG
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_LAPD
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;-&gt; PH_REQUEST_PULL&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;tx_skb
)paren
(brace
id|clear_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
id|st-&gt;l2
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_PULL
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
id|set_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HW_RESET
op_or
id|REQUEST
)paren
suffix:colon
r_case
(paren
id|HW_ENABLE
op_or
id|REQUEST
)paren
suffix:colon
id|ph_command
c_func
(paren
id|cs
comma
id|IPACX_CMD_TIM
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HW_INFO3
op_or
id|REQUEST
)paren
suffix:colon
id|ph_command
c_func
(paren
id|cs
comma
id|IPACX_CMD_AR8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HW_TESTLOOP
op_or
id|REQUEST
)paren
suffix:colon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CDA_TSDP10
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// Timeslot 0 is B1
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CDA_TSDP11
comma
l_int|0x81
)paren
suffix:semicolon
singleline_comment|// Timeslot 0 is B1
id|cda1_cr
op_assign
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_CDA1_CR
)paren
suffix:semicolon
id|cda2_cr
op_assign
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_CDA2_CR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|arg
op_amp
l_int|1
)paren
(brace
singleline_comment|// loop B1
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CDA1_CR
comma
id|cda1_cr
op_or
l_int|0x0a
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// B1 off
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CDA1_CR
comma
id|cda1_cr
op_amp
op_complement
l_int|0x0a
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|arg
op_amp
l_int|2
)paren
(brace
singleline_comment|// loop B2
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CDA1_CR
comma
id|cda1_cr
op_or
l_int|0x14
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// B2 off
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CDA1_CR
comma
id|cda1_cr
op_amp
op_complement
l_int|0x14
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
id|HW_DEACTIVATE
op_or
id|RESPONSE
)paren
suffix:colon
id|skb_queue_purge
c_func
(paren
op_amp
id|cs-&gt;rq
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|cs-&gt;sq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|cs-&gt;tx_skb
)paren
suffix:semicolon
id|cs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_l2l1 unknown %04x&quot;
comma
id|pr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|dbusy_timer_handler
id|dbusy_timer_handler
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_struct
id|PStack
op_star
id|st
suffix:semicolon
r_int
id|rbchd
comma
id|stard
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
(brace
id|rbchd
op_assign
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_RBCHD
)paren
suffix:semicolon
id|stard
op_assign
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_STARD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;D-Channel Busy RBCHD %02x STARD %02x&quot;
comma
id|rbchd
comma
id|stard
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|stard
op_amp
l_int|0x40
)paren
)paren
(brace
singleline_comment|// D-Channel Busy
id|set_bit
c_func
(paren
id|FLG_L1_DBUSY
comma
op_amp
id|cs-&gt;HW_Flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|st
op_assign
id|cs-&gt;stlist
suffix:semicolon
id|st
suffix:semicolon
id|st
op_assign
id|st-&gt;next
)paren
(brace
id|st-&gt;l2
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_PAUSE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
singleline_comment|// flow control on
)brace
)brace
r_else
(brace
singleline_comment|// seems we lost an interrupt; reset transceiver */
id|clear_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|cs-&gt;tx_skb
)paren
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: ISAC D-Channel Busy no skb&bslash;n&quot;
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;D-Channel Busy no skb&quot;
)paren
suffix:semicolon
)brace
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
l_int|0x01
)paren
suffix:semicolon
singleline_comment|// Tx reset, generates XPR
)brace
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// L1 state machine intermediate layer to isdnl1 module
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|ipacx_new_ph
id|ipacx_new_ph
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_switch
c_cond
(paren
id|cs-&gt;dc.isac.ph_state
)paren
(brace
r_case
(paren
id|IPACX_IND_RES
)paren
suffix:colon
id|ph_command
c_func
(paren
id|cs
comma
id|IPACX_CMD_DI
)paren
suffix:semicolon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_RESET
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_DC
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_DEACTIVATE
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_DR
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_DEACTIVATE
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_PU
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_POWERUP
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_RSY
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_RSYNC
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_AR
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_INFO2
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_AI8
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_INFO4_P8
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|IPACX_IND_AI10
)paren
suffix:colon
id|l1_msg
c_func
(paren
id|cs
comma
id|HW_INFO4_P10
op_or
id|INDICATION
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// bottom half handler for D channel
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|dch_bh
id|dch_bh
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_struct
id|PStack
op_star
id|st
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_CLEARBUSY
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;D-Channel Busy cleared&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|st
op_assign
id|cs-&gt;stlist
suffix:semicolon
id|st
suffix:semicolon
id|st
op_assign
id|st-&gt;next
)paren
(brace
id|st-&gt;l2
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_PAUSE
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_RCVBUFREADY
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
id|DChannel_proc_rcv
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_XMTBUFREADY
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
id|DChannel_proc_xmt
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|D_L1STATECHANGE
comma
op_amp
id|cs-&gt;event
)paren
)paren
(brace
id|ipacx_new_ph
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// proceed with bottom half handler dch_bh()
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|dch_sched_event
id|dch_sched_event
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|event
)paren
(brace
id|set_bit
c_func
(paren
id|event
comma
op_amp
id|cs-&gt;event
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|cs-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Fill buffer from receive FIFO
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|dch_empty_fifo
id|dch_empty_fifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|count
)paren
(brace
r_int
id|flags
suffix:semicolon
id|u_char
op_star
id|ptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
op_logical_and
op_logical_neg
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_empty_fifo()&quot;
)paren
suffix:semicolon
singleline_comment|// message too large, remove
r_if
c_cond
(paren
(paren
id|cs-&gt;rcvidx
op_plus
id|count
)paren
op_ge
id|MAX_DFRAME_LEN_L1
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_empty_fifo() incoming message too large&quot;
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// RMC
id|cs-&gt;rcvidx
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ptr
op_assign
id|cs-&gt;rcvbuf
op_plus
id|cs-&gt;rcvidx
suffix:semicolon
id|cs-&gt;rcvidx
op_add_assign
id|count
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|readisacfifo
c_func
(paren
id|cs
comma
id|ptr
comma
id|count
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// RMC
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
(brace
r_char
op_star
id|t
op_assign
id|cs-&gt;dlog
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;dch_empty_fifo() cnt %d&quot;
comma
id|count
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|ptr
comma
id|count
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|cs-&gt;dlog
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Fill transmit FIFO
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|dch_fill_fifo
id|dch_fill_fifo
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_int
id|flags
suffix:semicolon
r_int
id|count
suffix:semicolon
id|u_char
id|cmd
comma
op_star
id|ptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
op_logical_and
op_logical_neg
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_fill_fifo()&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;tx_skb
)paren
r_return
suffix:semicolon
id|count
op_assign
id|cs-&gt;tx_skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|D_FIFO_SIZE
)paren
(brace
id|count
op_assign
id|D_FIFO_SIZE
suffix:semicolon
id|cmd
op_assign
l_int|0x08
suffix:semicolon
singleline_comment|// XTF
)brace
r_else
(brace
id|cmd
op_assign
l_int|0x0A
suffix:semicolon
singleline_comment|// XTF | XME
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ptr
op_assign
id|cs-&gt;tx_skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|cs-&gt;tx_skb
comma
id|count
)paren
suffix:semicolon
id|cs-&gt;tx_cnt
op_add_assign
id|count
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisacfifo
c_func
(paren
id|cs
comma
id|ptr
comma
id|count
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
id|cmd
)paren
suffix:semicolon
singleline_comment|// set timeout for transmission contol
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
(brace
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_fill_fifo dbusytimer running&quot;
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
id|cs-&gt;dbusytimer.expires
op_assign
id|jiffies
op_plus
(paren
(paren
id|DBUSY_TIMER_VALUE
op_star
id|HZ
)paren
op_div
l_int|1000
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC_FIFO
)paren
(brace
r_char
op_star
id|t
op_assign
id|cs-&gt;dlog
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;dch_fill_fifo() cnt %d&quot;
comma
id|count
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|ptr
comma
id|count
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|cs-&gt;dlog
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// D channel interrupt handler
singleline_comment|//----------------------------------------------------------
r_static
r_inline
r_void
DECL|function|dch_int
id|dch_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u_char
id|istad
comma
id|rstad
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|count
suffix:semicolon
id|istad
op_assign
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_ISTAD
)paren
suffix:semicolon
singleline_comment|//##############################################  
singleline_comment|//&t;printk(KERN_WARNING &quot;dch_int(istad=%02x)&bslash;n&quot;, istad);
singleline_comment|//##############################################  
r_if
c_cond
(paren
id|istad
op_amp
l_int|0x80
)paren
(brace
singleline_comment|// RME
id|rstad
op_assign
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_RSTAD
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rstad
op_amp
l_int|0xf0
)paren
op_ne
l_int|0xa0
)paren
(brace
singleline_comment|// !(VFR &amp;&amp; !RDO &amp;&amp; CRC &amp;&amp; !RAB)
r_if
c_cond
(paren
op_logical_neg
(paren
id|rstad
op_amp
l_int|0x80
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_int(): invalid frame&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rstad
op_amp
l_int|0x40
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_int(): RDO&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rstad
op_amp
l_int|0x20
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_int(): CRC error&quot;
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// RMC
)brace
r_else
(brace
singleline_comment|// received frame ok
id|count
op_assign
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_RBCLD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
)paren
id|count
op_decrement
suffix:semicolon
singleline_comment|// RSTAB is last byte
id|count
op_and_assign
id|D_FIFO_SIZE
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
id|count
op_assign
id|D_FIFO_SIZE
suffix:semicolon
id|dch_empty_fifo
c_func
(paren
id|cs
comma
id|count
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_assign
id|cs-&gt;rcvidx
)paren
OG
l_int|0
)paren
(brace
id|cs-&gt;rcvidx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|count
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax dch_int(): receive out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|cs-&gt;rcvbuf
comma
id|count
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|cs-&gt;rq
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|cs-&gt;rcvidx
op_assign
l_int|0
suffix:semicolon
id|dch_sched_event
c_func
(paren
id|cs
comma
id|D_RCVBUFREADY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istad
op_amp
l_int|0x40
)paren
(brace
singleline_comment|// RPF
id|dch_empty_fifo
c_func
(paren
id|cs
comma
id|D_FIFO_SIZE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istad
op_amp
l_int|0x20
)paren
(brace
singleline_comment|// RFO
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_int(): RFO&quot;
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
l_int|0x40
)paren
suffix:semicolon
singleline_comment|//RRES
)brace
r_if
c_cond
(paren
id|istad
op_amp
l_int|0x10
)paren
(brace
singleline_comment|// XPR
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_DBUSY_TIMER
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|FLG_L1_DBUSY
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
id|dch_sched_event
c_func
(paren
id|cs
comma
id|D_CLEARBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;tx_skb-&gt;len
)paren
(brace
id|dch_fill_fifo
c_func
(paren
id|cs
)paren
suffix:semicolon
r_goto
id|afterXPR
suffix:semicolon
)brace
r_else
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|cs-&gt;tx_skb
)paren
suffix:semicolon
id|cs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|cs-&gt;tx_skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|cs-&gt;sq
)paren
)paren
)paren
(brace
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|dch_fill_fifo
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_else
(brace
id|dch_sched_event
c_func
(paren
id|cs
comma
id|D_XMTBUFREADY
)paren
suffix:semicolon
)brace
)brace
id|afterXPR
suffix:colon
r_if
c_cond
(paren
id|istad
op_amp
l_int|0x0C
)paren
(brace
singleline_comment|// XDU or XMR
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;dch_int(): XDU&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;tx_skb
)paren
(brace
id|skb_push
c_func
(paren
id|cs-&gt;tx_skb
comma
id|cs-&gt;tx_cnt
)paren
suffix:semicolon
singleline_comment|// retransmit
id|cs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
id|dch_fill_fifo
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: ISAC XDU no skb&bslash;n&quot;
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;ISAC XDU no skb&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_void
id|__devinit
DECL|function|dch_setstack
id|dch_setstack
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|st-&gt;l1.l1hw
op_assign
id|dch_l2l1
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_void
id|__devinit
DECL|function|dch_init
id|dch_init
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HiSax: IPACX ISDN driver v0.1.0&bslash;n&quot;
)paren
suffix:semicolon
id|cs-&gt;tqueue.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|dch_bh
suffix:semicolon
id|cs-&gt;setstack_d
op_assign
id|dch_setstack
suffix:semicolon
id|cs-&gt;dbusytimer.function
op_assign
(paren
r_void
op_star
)paren
id|dbusy_timer_handler
suffix:semicolon
id|cs-&gt;dbusytimer.data
op_assign
(paren
r_int
)paren
id|cs
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|cs-&gt;dbusytimer
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_TR_CONF0
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// clear LDD
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_TR_CONF2
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// enable transmitter
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_MODED
comma
l_int|0xC9
)paren
suffix:semicolon
singleline_comment|// transparent mode 0, RAC, stop/go
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_MON_CR
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// disable monitor channel
)brace
singleline_comment|//==========================================================
singleline_comment|// B channel functions
singleline_comment|//==========================================================
singleline_comment|//----------------------------------------------------------
singleline_comment|// Entry point for commands
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|bch_l2l1
id|bch_l2l1
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_int
id|pr
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|arg
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|pr
)paren
(brace
r_case
(paren
id|PH_DATA
op_or
id|REQUEST
)paren
suffix:colon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st-&gt;l1.bcs-&gt;tx_skb
)paren
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|st-&gt;l1.bcs-&gt;squeue
comma
id|skb
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|st-&gt;l1.bcs-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|set_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|st-&gt;l1.bcs-&gt;hw.hscx.count
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|bch_fill_fifo
c_func
(paren
id|st-&gt;l1.bcs
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL
op_or
id|INDICATION
)paren
suffix:colon
r_if
c_cond
(paren
id|st-&gt;l1.bcs-&gt;tx_skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax bch_l2l1(): this shouldn&squot;t happen&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|st-&gt;l1.bcs-&gt;tx_skb
op_assign
id|skb
suffix:semicolon
id|st-&gt;l1.bcs-&gt;hw.hscx.count
op_assign
l_int|0
suffix:semicolon
id|bch_fill_fifo
c_func
(paren
id|st-&gt;l1.bcs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_PULL
op_or
id|REQUEST
)paren
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|st-&gt;l1.bcs-&gt;tx_skb
)paren
(brace
id|clear_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
id|st-&gt;l2
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_PULL
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
id|set_bit
c_func
(paren
id|FLG_L1_PULL_REQ
comma
op_amp
id|st-&gt;l1.Flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_ACTIVATE
op_or
id|REQUEST
)paren
suffix:colon
id|set_bit
c_func
(paren
id|BC_FLG_ACTIV
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|bch_mode
c_func
(paren
id|st-&gt;l1.bcs
comma
id|st-&gt;l1.mode
comma
id|st-&gt;l1.bc
)paren
suffix:semicolon
id|l1_msg_b
c_func
(paren
id|st
comma
id|pr
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_DEACTIVATE
op_or
id|REQUEST
)paren
suffix:colon
id|l1_msg_b
c_func
(paren
id|st
comma
id|pr
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|PH_DEACTIVATE
op_or
id|CONFIRM
)paren
suffix:colon
id|clear_bit
c_func
(paren
id|BC_FLG_ACTIV
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|st-&gt;l1.bcs-&gt;Flag
)paren
suffix:semicolon
id|bch_mode
c_func
(paren
id|st-&gt;l1.bcs
comma
l_int|0
comma
id|st-&gt;l1.bc
)paren
suffix:semicolon
id|st-&gt;l2
dot
id|l1l2
c_func
(paren
id|st
comma
id|PH_DEACTIVATE
op_or
id|CONFIRM
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// proceed with bottom half handler BChannel_bh()
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|bch_sched_event
id|bch_sched_event
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|event
)paren
(brace
id|bcs-&gt;event
op_or_assign
l_int|1
op_lshift
id|event
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|bcs-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Read B channel fifo to receive buffer
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|bch_empty_fifo
id|bch_empty_fifo
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|count
)paren
(brace
id|u_char
op_star
id|ptr
comma
id|hscx
suffix:semicolon
r_struct
id|IsdnCardState
op_star
id|cs
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
id|hscx
op_assign
id|bcs-&gt;hw.hscx.hscx
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX
)paren
op_logical_and
op_logical_neg
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX_FIFO
)paren
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_empty_fifo()&quot;
)paren
suffix:semicolon
singleline_comment|// message too large, remove
r_if
c_cond
(paren
id|bcs-&gt;hw.hscx.rcvidx
op_plus
id|count
OG
id|HSCX_BUFMAX
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_empty_fifo() incoming packet too large&quot;
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_CMDRB
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// RMC
id|bcs-&gt;hw.hscx.rcvidx
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// Read data uninterruptible
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ptr
op_assign
id|bcs-&gt;hw.hscx.rcvbuf
op_plus
id|bcs-&gt;hw.hscx.rcvidx
suffix:semicolon
id|cnt
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_decrement
)paren
op_star
id|ptr
op_increment
op_assign
id|cs
op_member_access_from_pointer
id|BC_Read_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_RFIFOB
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_CMDRB
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// RMC
id|ptr
op_assign
id|bcs-&gt;hw.hscx.rcvbuf
op_plus
id|bcs-&gt;hw.hscx.rcvidx
suffix:semicolon
id|bcs-&gt;hw.hscx.rcvidx
op_add_assign
id|count
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX_FIFO
)paren
(brace
r_char
op_star
id|t
op_assign
id|bcs-&gt;blog
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;bch_empty_fifo() B-%d cnt %d&quot;
comma
id|hscx
comma
id|count
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|ptr
comma
id|count
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|bcs-&gt;blog
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Fill buffer to transmit FIFO
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|bch_fill_fifo
id|bch_fill_fifo
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
suffix:semicolon
r_int
id|more
comma
id|count
comma
id|cnt
suffix:semicolon
id|u_char
op_star
id|ptr
comma
op_star
id|p
comma
id|hscx
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX
)paren
op_logical_and
op_logical_neg
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX_FIFO
)paren
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_fill_fifo()&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bcs-&gt;tx_skb
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|bcs-&gt;tx_skb-&gt;len
op_le
l_int|0
)paren
r_return
suffix:semicolon
id|hscx
op_assign
id|bcs-&gt;hw.hscx.hscx
suffix:semicolon
id|more
op_assign
(paren
id|bcs-&gt;mode
op_eq
id|L1_MODE_TRANS
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|bcs-&gt;tx_skb-&gt;len
OG
id|B_FIFO_SIZE
)paren
(brace
id|more
op_assign
l_int|1
suffix:semicolon
id|count
op_assign
id|B_FIFO_SIZE
suffix:semicolon
)brace
r_else
(brace
id|count
op_assign
id|bcs-&gt;tx_skb-&gt;len
suffix:semicolon
)brace
id|cnt
op_assign
id|count
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|p
op_assign
id|ptr
op_assign
id|bcs-&gt;tx_skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|bcs-&gt;tx_skb
comma
id|count
)paren
suffix:semicolon
id|bcs-&gt;tx_cnt
op_sub_assign
id|count
suffix:semicolon
id|bcs-&gt;hw.hscx.count
op_add_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_decrement
)paren
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_XFIFOB
comma
op_star
id|p
op_increment
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_CMDRB
comma
(paren
id|more
ques
c_cond
l_int|0x08
suffix:colon
l_int|0x0a
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX_FIFO
)paren
(brace
r_char
op_star
id|t
op_assign
id|bcs-&gt;blog
suffix:semicolon
id|t
op_add_assign
id|sprintf
c_func
(paren
id|t
comma
l_string|&quot;chb_fill_fifo() B-%d cnt %d&quot;
comma
id|hscx
comma
id|count
)paren
suffix:semicolon
id|QuickHex
c_func
(paren
id|t
comma
id|ptr
comma
id|count
)paren
suffix:semicolon
id|debugl1
c_func
(paren
id|cs
comma
id|bcs-&gt;blog
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// B channel interrupt handler
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|bch_int
id|bch_int
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
id|u_char
id|hscx
)paren
(brace
id|u_char
id|istab
suffix:semicolon
r_struct
id|BCState
op_star
id|bcs
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|count
suffix:semicolon
id|u_char
id|rstab
suffix:semicolon
id|bcs
op_assign
id|cs-&gt;bcs
op_plus
id|hscx
suffix:semicolon
id|istab
op_assign
id|cs
op_member_access_from_pointer
id|BC_Read_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_ISTAB
)paren
suffix:semicolon
singleline_comment|//##############################################  
singleline_comment|//&t;printk(KERN_WARNING &quot;bch_int(istab=%02x)&bslash;n&quot;, istab);
singleline_comment|//##############################################  
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|istab
op_amp
l_int|0x80
)paren
(brace
singleline_comment|// RME
id|rstab
op_assign
id|cs
op_member_access_from_pointer
id|BC_Read_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_RSTAB
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rstab
op_amp
l_int|0xf0
)paren
op_ne
l_int|0xa0
)paren
(brace
singleline_comment|// !(VFR &amp;&amp; !RDO &amp;&amp; CRC &amp;&amp; !RAB)
r_if
c_cond
(paren
op_logical_neg
(paren
id|rstab
op_amp
l_int|0x80
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_int() B-%d: invalid frame&quot;
comma
id|hscx
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rstab
op_amp
l_int|0x40
)paren
op_logical_and
(paren
id|bcs-&gt;mode
op_ne
id|L1_MODE_NULL
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_int() B-%d: RDO mode=%d&quot;
comma
id|hscx
comma
id|bcs-&gt;mode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rstab
op_amp
l_int|0x20
)paren
)paren
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_int() B-%d: CRC error&quot;
comma
id|hscx
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_CMDRB
comma
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// RMC
)brace
r_else
(brace
singleline_comment|// received frame ok
id|count
op_assign
id|cs
op_member_access_from_pointer
id|BC_Read_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_RBCLB
)paren
op_amp
(paren
id|B_FIFO_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
id|count
op_assign
id|B_FIFO_SIZE
suffix:semicolon
id|bch_empty_fifo
c_func
(paren
id|bcs
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_assign
id|bcs-&gt;hw.hscx.rcvidx
op_minus
l_int|1
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX_FIFO
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_int Frame %d&quot;
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|count
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax bch_int(): receive frame out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|bcs-&gt;hw.hscx.rcvbuf
comma
id|count
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|bcs-&gt;rqueue
comma
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
id|bcs-&gt;hw.hscx.rcvidx
op_assign
l_int|0
suffix:semicolon
id|bch_sched_event
c_func
(paren
id|bcs
comma
id|B_RCVBUFREADY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|istab
op_amp
l_int|0x40
)paren
(brace
singleline_comment|// RPF
id|bch_empty_fifo
c_func
(paren
id|bcs
comma
id|B_FIFO_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcs-&gt;mode
op_eq
id|L1_MODE_TRANS
)paren
(brace
singleline_comment|// queue every chunk
singleline_comment|// receive transparent audio data
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|B_FIFO_SIZE
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax bch_int(): receive transparent out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|B_FIFO_SIZE
)paren
comma
id|bcs-&gt;hw.hscx.rcvbuf
comma
id|B_FIFO_SIZE
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|bcs-&gt;rqueue
comma
id|skb
)paren
suffix:semicolon
)brace
id|bcs-&gt;hw.hscx.rcvidx
op_assign
l_int|0
suffix:semicolon
id|bch_sched_event
c_func
(paren
id|bcs
comma
id|B_RCVBUFREADY
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|istab
op_amp
l_int|0x20
)paren
(brace
singleline_comment|// RFO
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_int() B-%d: RFO error&quot;
comma
id|hscx
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_CMDRB
comma
l_int|0x40
)paren
suffix:semicolon
singleline_comment|// RRES
)brace
r_if
c_cond
(paren
id|istab
op_amp
l_int|0x10
)paren
(brace
singleline_comment|// XPR
r_if
c_cond
(paren
id|bcs-&gt;tx_skb
)paren
(brace
r_if
c_cond
(paren
id|bcs-&gt;tx_skb-&gt;len
)paren
(brace
id|bch_fill_fifo
c_func
(paren
id|bcs
)paren
suffix:semicolon
r_goto
id|afterXPR
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|bcs-&gt;st-&gt;lli.l1writewakeup
op_logical_and
(paren
id|PACKET_NOACK
op_ne
id|bcs-&gt;tx_skb-&gt;pkt_type
)paren
)paren
(brace
id|bcs-&gt;st-&gt;lli
dot
id|l1writewakeup
c_func
(paren
id|bcs-&gt;st
comma
id|bcs-&gt;hw.hscx.count
)paren
suffix:semicolon
)brace
id|dev_kfree_skb_irq
c_func
(paren
id|bcs-&gt;tx_skb
)paren
suffix:semicolon
id|bcs-&gt;hw.hscx.count
op_assign
l_int|0
suffix:semicolon
id|bcs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|bcs-&gt;tx_skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|bcs-&gt;squeue
)paren
)paren
)paren
(brace
id|bcs-&gt;hw.hscx.count
op_assign
l_int|0
suffix:semicolon
id|set_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
id|bch_fill_fifo
c_func
(paren
id|bcs
)paren
suffix:semicolon
)brace
r_else
(brace
id|clear_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
id|bch_sched_event
c_func
(paren
id|bcs
comma
id|B_XMTBUFREADY
)paren
suffix:semicolon
)brace
)brace
id|afterXPR
suffix:colon
r_if
c_cond
(paren
id|istab
op_amp
l_int|0x04
)paren
(brace
singleline_comment|// XDU
r_if
c_cond
(paren
id|bcs-&gt;mode
op_eq
id|L1_MODE_TRANS
)paren
(brace
id|bch_fill_fifo
c_func
(paren
id|bcs
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|bcs-&gt;tx_skb
)paren
(brace
singleline_comment|// restart transmitting the whole frame
id|skb_push
c_func
(paren
id|bcs-&gt;tx_skb
comma
id|bcs-&gt;hw.hscx.count
)paren
suffix:semicolon
id|bcs-&gt;tx_cnt
op_add_assign
id|bcs-&gt;hw.hscx.count
suffix:semicolon
id|bcs-&gt;hw.hscx.count
op_assign
l_int|0
suffix:semicolon
)brace
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_CMDRB
comma
l_int|0x01
)paren
suffix:semicolon
singleline_comment|// XRES
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_WARN
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;bch_int() B-%d XDU error&quot;
comma
id|hscx
)paren
suffix:semicolon
)brace
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|bch_mode
id|bch_mode
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
comma
r_int
id|mode
comma
r_int
id|bc
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|bcs-&gt;cs
suffix:semicolon
r_int
id|hscx
op_assign
id|bcs-&gt;hw.hscx.hscx
suffix:semicolon
id|bc
op_assign
id|bc
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
singleline_comment|// in case bc is greater than 1
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_HSCX
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;mode_bch() switch B-% mode %d chan %d&quot;
comma
id|hscx
comma
id|mode
comma
id|bc
)paren
suffix:semicolon
id|bcs-&gt;mode
op_assign
id|mode
suffix:semicolon
id|bcs-&gt;channel
op_assign
id|bc
suffix:semicolon
singleline_comment|// map controller to according timeslot
r_if
c_cond
(paren
op_logical_neg
id|hscx
)paren
(brace
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_BCHA_TSDP_BC1
comma
l_int|0x80
op_or
id|bc
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_BCHA_CR
comma
l_int|0x88
)paren
suffix:semicolon
)brace
r_else
(brace
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_BCHB_TSDP_BC1
comma
l_int|0x80
op_or
id|bc
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_BCHB_CR
comma
l_int|0x88
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
(paren
id|L1_MODE_NULL
)paren
suffix:colon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_MODEB
comma
l_int|0xC0
)paren
suffix:semicolon
singleline_comment|// rec off
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_EXMB
comma
l_int|0x30
)paren
suffix:semicolon
singleline_comment|// std adj.
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_MASKB
comma
l_int|0xFF
)paren
suffix:semicolon
singleline_comment|// ints off
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_CMDRB
comma
l_int|0x41
)paren
suffix:semicolon
singleline_comment|// validate adjustments
r_break
suffix:semicolon
r_case
(paren
id|L1_MODE_TRANS
)paren
suffix:colon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_MODEB
comma
l_int|0x88
)paren
suffix:semicolon
singleline_comment|// ext transp mode
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_EXMB
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// xxx00000
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_CMDRB
comma
l_int|0x41
)paren
suffix:semicolon
singleline_comment|// validate adjustments
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_MASKB
comma
id|_MASKB_IMASK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|L1_MODE_HDLC
)paren
suffix:colon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_MODEB
comma
l_int|0xC8
)paren
suffix:semicolon
singleline_comment|// transp mode 0
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_EXMB
comma
l_int|0x01
)paren
suffix:semicolon
singleline_comment|// idle=hdlc flags crc enabled
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_CMDRB
comma
l_int|0x41
)paren
suffix:semicolon
singleline_comment|// validate adjustments
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
id|hscx
comma
id|IPACX_MASKB
comma
id|_MASKB_IMASK
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_void
DECL|function|bch_close_state
id|bch_close_state
c_func
(paren
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
id|bch_mode
c_func
(paren
id|bcs
comma
l_int|0
comma
id|bcs-&gt;channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
)paren
(brace
r_if
c_cond
(paren
id|bcs-&gt;hw.hscx.rcvbuf
)paren
(brace
id|kfree
c_func
(paren
id|bcs-&gt;hw.hscx.rcvbuf
)paren
suffix:semicolon
id|bcs-&gt;hw.hscx.rcvbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bcs-&gt;blog
)paren
(brace
id|kfree
c_func
(paren
id|bcs-&gt;blog
)paren
suffix:semicolon
id|bcs-&gt;blog
op_assign
l_int|NULL
suffix:semicolon
)brace
id|skb_queue_purge
c_func
(paren
op_amp
id|bcs-&gt;rqueue
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|bcs-&gt;squeue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcs-&gt;tx_skb
)paren
(brace
id|dev_kfree_skb_any
c_func
(paren
id|bcs-&gt;tx_skb
)paren
suffix:semicolon
id|bcs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|clear_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
)brace
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_int
DECL|function|bch_open_state
id|bch_open_state
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bcs-&gt;hw.hscx.rcvbuf
op_assign
id|kmalloc
c_func
(paren
id|HSCX_BUFMAX
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax open_bchstate(): No memory for hscx.rcvbuf&bslash;n&quot;
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bcs-&gt;blog
op_assign
id|kmalloc
c_func
(paren
id|MAX_BLOG_SPACE
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax open_bchstate: No memory for bcs-&gt;blog&bslash;n&quot;
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|BC_FLG_INIT
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bcs-&gt;hw.hscx.rcvbuf
)paren
suffix:semicolon
id|bcs-&gt;hw.hscx.rcvbuf
op_assign
l_int|NULL
suffix:semicolon
r_return
(paren
l_int|2
)paren
suffix:semicolon
)brace
id|skb_queue_head_init
c_func
(paren
op_amp
id|bcs-&gt;rqueue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|bcs-&gt;squeue
)paren
suffix:semicolon
)brace
id|bcs-&gt;tx_skb
op_assign
l_int|NULL
suffix:semicolon
id|clear_bit
c_func
(paren
id|BC_FLG_BUSY
comma
op_amp
id|bcs-&gt;Flag
)paren
suffix:semicolon
id|bcs-&gt;event
op_assign
l_int|0
suffix:semicolon
id|bcs-&gt;hw.hscx.rcvidx
op_assign
l_int|0
suffix:semicolon
id|bcs-&gt;tx_cnt
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_int
DECL|function|bch_setstack
id|bch_setstack
c_func
(paren
r_struct
id|PStack
op_star
id|st
comma
r_struct
id|BCState
op_star
id|bcs
)paren
(brace
id|bcs-&gt;channel
op_assign
id|st-&gt;l1.bc
suffix:semicolon
r_if
c_cond
(paren
id|bch_open_state
c_func
(paren
id|st-&gt;l1.hardware
comma
id|bcs
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|st-&gt;l1.bcs
op_assign
id|bcs
suffix:semicolon
id|st-&gt;l1.l2l1
op_assign
id|bch_l2l1
suffix:semicolon
id|setstack_manager
c_func
(paren
id|st
)paren
suffix:semicolon
id|bcs-&gt;st
op_assign
id|st
suffix:semicolon
id|setstack_l1_B
c_func
(paren
id|st
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|//----------------------------------------------------------
r_static
r_void
id|__devinit
DECL|function|bch_init
id|bch_init
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|hscx
)paren
(brace
id|cs-&gt;bcs
(braket
id|hscx
)braket
dot
id|BC_SetStack
op_assign
id|bch_setstack
suffix:semicolon
id|cs-&gt;bcs
(braket
id|hscx
)braket
dot
id|BC_Close
op_assign
id|bch_close_state
suffix:semicolon
id|cs-&gt;bcs
(braket
id|hscx
)braket
dot
id|hw.hscx.hscx
op_assign
id|hscx
suffix:semicolon
id|cs-&gt;bcs
(braket
id|hscx
)braket
dot
id|cs
op_assign
id|cs
suffix:semicolon
id|bch_mode
c_func
(paren
id|cs-&gt;bcs
op_plus
id|hscx
comma
l_int|0
comma
id|hscx
)paren
suffix:semicolon
)brace
singleline_comment|//==========================================================
singleline_comment|// Shared functions
singleline_comment|//==========================================================
singleline_comment|//----------------------------------------------------------
singleline_comment|// Main interrupt handler
singleline_comment|//----------------------------------------------------------
r_void
DECL|function|interrupt_ipacx
id|interrupt_ipacx
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|u_char
id|ista
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ista
op_assign
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_ISTA
)paren
)paren
)paren
(brace
singleline_comment|//#################################################  
singleline_comment|//&t;&t;printk(KERN_WARNING &quot;interrupt_ipacx(ista=%02x)&bslash;n&quot;, ista);
singleline_comment|//#################################################  
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x80
)paren
id|bch_int
c_func
(paren
id|cs
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// B channel interrupts
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x40
)paren
id|bch_int
c_func
(paren
id|cs
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x01
)paren
id|dch_int
c_func
(paren
id|cs
)paren
suffix:semicolon
singleline_comment|// D channel
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x10
)paren
id|cic_int
c_func
(paren
id|cs
)paren
suffix:semicolon
singleline_comment|// Layer 1 state
)brace
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Clears chip interrupt status
singleline_comment|//----------------------------------------------------------
r_static
r_void
id|__init
DECL|function|clear_pending_ints
id|clear_pending_ints
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
r_int
id|ista
suffix:semicolon
singleline_comment|// all interrupts off
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_MASK
comma
l_int|0xff
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_MASKD
comma
l_int|0xff
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
l_int|0
comma
id|IPACX_MASKB
comma
l_int|0xff
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
l_int|1
comma
id|IPACX_MASKB
comma
l_int|0xff
)paren
suffix:semicolon
id|ista
op_assign
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_ISTA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x80
)paren
id|cs
op_member_access_from_pointer
id|BC_Read_Reg
c_func
(paren
id|cs
comma
l_int|0
comma
id|IPACX_ISTAB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x40
)paren
id|cs
op_member_access_from_pointer
id|BC_Read_Reg
c_func
(paren
id|cs
comma
l_int|1
comma
id|IPACX_ISTAB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x10
)paren
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_CIR0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ista
op_amp
l_int|0x01
)paren
id|cs
op_member_access_from_pointer
id|readisac
c_func
(paren
id|cs
comma
id|IPACX_ISTAD
)paren
suffix:semicolon
)brace
singleline_comment|//----------------------------------------------------------
singleline_comment|// Does chip configuration work
singleline_comment|// Work to do depends on bit mask in part
singleline_comment|//----------------------------------------------------------
r_void
id|__init
DECL|function|init_ipacx
id|init_ipacx
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|part
)paren
(brace
r_if
c_cond
(paren
id|part
op_amp
l_int|1
)paren
(brace
singleline_comment|// initialise chip
singleline_comment|//##################################################  
singleline_comment|//&t;printk(KERN_INFO &quot;init_ipacx(%x)&bslash;n&quot;, part);
singleline_comment|//##################################################  
id|clear_pending_ints
c_func
(paren
id|cs
)paren
suffix:semicolon
id|bch_init
c_func
(paren
id|cs
comma
l_int|0
)paren
suffix:semicolon
id|bch_init
c_func
(paren
id|cs
comma
l_int|1
)paren
suffix:semicolon
id|dch_init
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|part
op_amp
l_int|2
)paren
(brace
singleline_comment|// reenable all interrupts and start chip
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
l_int|0
comma
id|IPACX_MASKB
comma
id|_MASKB_IMASK
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
l_int|1
comma
id|IPACX_MASKB
comma
id|_MASKB_IMASK
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_MASKD
comma
id|_MASKD_IMASK
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_MASK
comma
id|_MASK_IMASK
)paren
suffix:semicolon
singleline_comment|// global mask register
singleline_comment|// reset HDLC Transmitters/receivers
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|IPACX_CMDRD
comma
l_int|0x41
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
l_int|0
comma
id|IPACX_CMDRB
comma
l_int|0x41
)paren
suffix:semicolon
id|cs
op_member_access_from_pointer
id|BC_Write_Reg
c_func
(paren
id|cs
comma
l_int|1
comma
id|IPACX_CMDRB
comma
l_int|0x41
)paren
suffix:semicolon
id|ph_command
c_func
(paren
id|cs
comma
id|IPACX_CMD_RES
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//----------------- end of file -----------------------
eof
