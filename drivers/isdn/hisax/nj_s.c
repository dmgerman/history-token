multiline_comment|/* $Id: nj_s.c,v 2.13.2.4 2004/01/16 01:53:48 keil Exp $&n; *&n; * This software may be used and distributed according to the terms&n; * of the GNU General Public License, incorporated herein by reference.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;hisax.h&quot;
macro_line|#include &quot;isac.h&quot;
macro_line|#include &quot;isdnl1.h&quot;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ppp_defs.h&gt;
macro_line|#include &quot;netjet.h&quot;
DECL|variable|NETjet_S_revision
r_const
r_char
op_star
id|NETjet_S_revision
op_assign
l_string|&quot;$Revision: 2.13.2.4 $&quot;
suffix:semicolon
DECL|function|dummyrr
r_static
id|u_char
id|dummyrr
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|chan
comma
id|u_char
id|off
)paren
(brace
r_return
l_int|5
suffix:semicolon
)brace
DECL|function|dummywr
r_static
r_void
id|dummywr
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|chan
comma
id|u_char
id|off
comma
id|u_char
id|value
)paren
(brace
)brace
r_static
id|irqreturn_t
DECL|function|netjet_s_interrupt
id|netjet_s_interrupt
c_func
(paren
r_int
id|intno
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|dev_id
suffix:semicolon
id|u_char
id|val
comma
id|s1val
comma
id|s0val
suffix:semicolon
id|u_long
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cs-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|s1val
op_assign
id|bytein
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_IRQSTAT1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s1val
op_amp
id|NETJET_ISACIRQ
)paren
)paren
(brace
id|val
op_assign
id|NETjet_ReadIC
c_func
(paren
id|cs
comma
id|ISAC_ISTA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_ISAC
)paren
id|debugl1
c_func
(paren
id|cs
comma
l_string|&quot;tiger: i1 %x %x&quot;
comma
id|s1val
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
id|isac_interrupt
c_func
(paren
id|cs
comma
id|val
)paren
suffix:semicolon
id|NETjet_WriteIC
c_func
(paren
id|cs
comma
id|ISAC_MASK
comma
l_int|0xFF
)paren
suffix:semicolon
id|NETjet_WriteIC
c_func
(paren
id|cs
comma
id|ISAC_MASK
comma
l_int|0x0
)paren
suffix:semicolon
)brace
id|s1val
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|s1val
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &n;&t; * read/write stat0 is better, because lower IRQ rate&n;&t; * Note the IRQ is on for 125 us if a condition match&n;&t; * thats long on modern CPU and so the IRQ is reentered&n;&t; * all the time.&n;&t; */
id|s0val
op_assign
id|bytein
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_IRQSTAT0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s0val
op_or
id|s1val
)paren
op_eq
l_int|0
)paren
(brace
singleline_comment|// shared IRQ
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cs-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s0val
)paren
id|byteout
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_IRQSTAT0
comma
id|s0val
)paren
suffix:semicolon
multiline_comment|/* start new code 13/07/00 GE */
multiline_comment|/* set bits in sval to indicate which page is free */
r_if
c_cond
(paren
id|inl
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_DMA_WRITE_ADR
)paren
OL
id|inl
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_DMA_WRITE_IRQ
)paren
)paren
multiline_comment|/* the 2nd write page is free */
id|s0val
op_assign
l_int|0x08
suffix:semicolon
r_else
multiline_comment|/* the 1st write page is free */
id|s0val
op_assign
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
id|inl
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_DMA_READ_ADR
)paren
OL
id|inl
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_DMA_READ_IRQ
)paren
)paren
multiline_comment|/* the 2nd read page is free */
id|s0val
op_or_assign
l_int|0x02
suffix:semicolon
r_else
multiline_comment|/* the 1st read page is free */
id|s0val
op_or_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|s0val
op_ne
id|cs-&gt;hw.njet.last_is0
)paren
multiline_comment|/* we have a DMA interrupt */
(brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|FLG_LOCK_ATOMIC
comma
op_amp
id|cs-&gt;HW_Flags
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;nj LOCK_ATOMIC s0val %x-&gt;%x&bslash;n&quot;
comma
id|cs-&gt;hw.njet.last_is0
comma
id|s0val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cs-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|cs-&gt;hw.njet.irqstat0
op_assign
id|s0val
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cs-&gt;hw.njet.irqstat0
op_amp
id|NETJET_IRQM0_READ
)paren
op_ne
(paren
id|cs-&gt;hw.njet.last_is0
op_amp
id|NETJET_IRQM0_READ
)paren
)paren
multiline_comment|/* we have a read dma int */
id|read_tiger
c_func
(paren
id|cs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cs-&gt;hw.njet.irqstat0
op_amp
id|NETJET_IRQM0_WRITE
)paren
op_ne
(paren
id|cs-&gt;hw.njet.last_is0
op_amp
id|NETJET_IRQM0_WRITE
)paren
)paren
multiline_comment|/* we have a write dma int */
id|write_tiger
c_func
(paren
id|cs
)paren
suffix:semicolon
multiline_comment|/* end new code 13/07/00 GE */
id|test_and_clear_bit
c_func
(paren
id|FLG_LOCK_ATOMIC
comma
op_amp
id|cs-&gt;HW_Flags
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cs-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_static
r_void
DECL|function|reset_netjet_s
id|reset_netjet_s
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
)paren
(brace
id|cs-&gt;hw.njet.ctrl_reg
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* Reset On */
id|byteout
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_CTRL
comma
id|cs-&gt;hw.njet.ctrl_reg
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* now edge triggered for TJ320 GE 13/07/00 */
multiline_comment|/* see comment in IRQ function */
r_if
c_cond
(paren
id|cs-&gt;subtyp
)paren
multiline_comment|/* TJ320 */
id|cs-&gt;hw.njet.ctrl_reg
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* Reset Off and status read clear */
r_else
id|cs-&gt;hw.njet.ctrl_reg
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Reset Off and status read clear */
id|byteout
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_CTRL
comma
id|cs-&gt;hw.njet.ctrl_reg
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|cs-&gt;hw.njet.auxd
op_assign
l_int|0
suffix:semicolon
id|cs-&gt;hw.njet.dmactrl
op_assign
l_int|0
suffix:semicolon
id|byteout
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_AUXCTRL
comma
op_complement
id|NETJET_ISACIRQ
)paren
suffix:semicolon
id|byteout
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_IRQMASK1
comma
id|NETJET_ISACIRQ
)paren
suffix:semicolon
id|byteout
c_func
(paren
id|cs-&gt;hw.njet.auxa
comma
id|cs-&gt;hw.njet.auxd
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|NETjet_S_card_msg
id|NETjet_S_card_msg
c_func
(paren
r_struct
id|IsdnCardState
op_star
id|cs
comma
r_int
id|mt
comma
r_void
op_star
id|arg
)paren
(brace
id|u_long
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|mt
)paren
(brace
r_case
id|CARD_RESET
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cs-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|reset_netjet_s
c_func
(paren
id|cs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cs-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|CARD_RELEASE
suffix:colon
id|release_io_netjet
c_func
(paren
id|cs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|CARD_INIT
suffix:colon
id|reset_netjet_s
c_func
(paren
id|cs
)paren
suffix:semicolon
id|inittiger
c_func
(paren
id|cs
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cs-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|clear_pending_isac_ints
c_func
(paren
id|cs
)paren
suffix:semicolon
id|initisac
c_func
(paren
id|cs
)paren
suffix:semicolon
multiline_comment|/* Reenable all IRQ */
id|cs
op_member_access_from_pointer
id|writeisac
c_func
(paren
id|cs
comma
id|ISAC_MASK
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cs-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|CARD_TEST
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|__initdata
r_static
r_struct
id|pci_dev
op_star
id|dev_netjet
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
r_int
id|__init
DECL|function|setup_netjet_s
id|setup_netjet_s
c_func
(paren
r_struct
id|IsdnCard
op_star
id|card
)paren
(brace
r_int
id|bytecnt
comma
id|cfg
suffix:semicolon
r_struct
id|IsdnCardState
op_star
id|cs
op_assign
id|card-&gt;cs
suffix:semicolon
r_char
id|tmp
(braket
l_int|64
)braket
suffix:semicolon
macro_line|#ifdef __BIG_ENDIAN
macro_line|#error &quot;not running on big endian machines now&quot;
macro_line|#endif
id|strcpy
c_func
(paren
id|tmp
comma
id|NETjet_S_revision
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HiSax: Traverse Tech. NETjet-S driver Rev. %s&bslash;n&quot;
comma
id|HiSax_getrev
c_func
(paren
id|tmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;typ
op_ne
id|ISDN_CTYPE_NETJET_S
)paren
r_return
l_int|0
suffix:semicolon
id|test_and_clear_bit
c_func
(paren
id|FLG_LOCK_ATOMIC
comma
op_amp
id|cs-&gt;HW_Flags
)paren
suffix:semicolon
macro_line|#if CONFIG_PCI
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
(paren
id|dev_netjet
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_TIGERJET
comma
id|PCI_DEVICE_ID_TIGERJET_300
comma
id|dev_netjet
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev_netjet
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|pci_set_master
c_func
(paren
id|dev_netjet
)paren
suffix:semicolon
id|cs-&gt;irq
op_assign
id|dev_netjet-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;NETjet-S: No IRQ for PCI card found&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cs-&gt;hw.njet.base
op_assign
id|pci_resource_start
c_func
(paren
id|dev_netjet
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs-&gt;hw.njet.base
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;NETjet-S: No IO-Adr for PCI card found&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* the TJ300 and TJ320 must be detected, the IRQ handling is different&n;&t;&t;&t; * unfortunatly the chips use the same device ID, but the TJ320 has&n;&t;&t;&t; * the bit20 in status PCI cfg register set&n;&t;&t;&t; */
id|pci_read_config_dword
c_func
(paren
id|dev_netjet
comma
l_int|0x04
comma
op_amp
id|cfg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cfg
op_amp
l_int|0x00100000
)paren
id|cs-&gt;subtyp
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* TJ320 */
r_else
id|cs-&gt;subtyp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* TJ300 */
multiline_comment|/* 2001/10/04 Christoph Ersfeld, Formula-n Europe AG www.formula-n.com */
r_if
c_cond
(paren
(paren
id|dev_netjet-&gt;subsystem_vendor
op_eq
l_int|0x55
)paren
op_logical_and
(paren
id|dev_netjet-&gt;subsystem_device
op_eq
l_int|0x02
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Netjet: You tried to load this driver with an incompatible TigerJet-card&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Use type=41 for Formula-n enter:now ISDN PCI and compatible&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end new code */
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;NETjet-S: No PCI card found&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cs-&gt;hw.njet.auxa
op_assign
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_AUXDATA
suffix:semicolon
id|cs-&gt;hw.njet.isac
op_assign
id|cs-&gt;hw.njet.base
op_or
id|NETJET_ISAC_OFF
suffix:semicolon
id|cs-&gt;hw.njet.ctrl_reg
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* Reset On */
id|byteout
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_CTRL
comma
id|cs-&gt;hw.njet.ctrl_reg
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|cs-&gt;hw.njet.ctrl_reg
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Reset Off and status read clear */
id|byteout
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_CTRL
comma
id|cs-&gt;hw.njet.ctrl_reg
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|cs-&gt;hw.njet.auxd
op_assign
l_int|0xC0
suffix:semicolon
id|cs-&gt;hw.njet.dmactrl
op_assign
l_int|0
suffix:semicolon
id|byteout
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_AUXCTRL
comma
op_complement
id|NETJET_ISACIRQ
)paren
suffix:semicolon
id|byteout
c_func
(paren
id|cs-&gt;hw.njet.base
op_plus
id|NETJET_IRQMASK1
comma
id|NETJET_ISACIRQ
)paren
suffix:semicolon
id|byteout
c_func
(paren
id|cs-&gt;hw.njet.auxa
comma
id|cs-&gt;hw.njet.auxd
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
(paren
id|NETjet_ReadIC
c_func
(paren
id|cs
comma
id|ISAC_RBCH
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|3
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;NETjet-S: NETspider-U PCI card found&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;NETjet-S: No PCI card found&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
macro_line|#else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;NETjet-S: NO_PCI_BIOS&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;NETjet-S: unable to config NETJET-S PCI&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PCI */
id|bytecnt
op_assign
l_int|256
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;NETjet-S: %s card configured at %#lx IRQ %d&bslash;n&quot;
comma
id|cs-&gt;subtyp
ques
c_cond
l_string|&quot;TJ320&quot;
suffix:colon
l_string|&quot;TJ300&quot;
comma
id|cs-&gt;hw.njet.base
comma
id|cs-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|cs-&gt;hw.njet.base
comma
id|bytecnt
comma
l_string|&quot;netjet-s isdn&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HiSax: %s config port %#lx-%#lx already in use&bslash;n&quot;
comma
id|CardType
(braket
id|card-&gt;typ
)braket
comma
id|cs-&gt;hw.njet.base
comma
id|cs-&gt;hw.njet.base
op_plus
id|bytecnt
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|cs-&gt;readisac
op_assign
op_amp
id|NETjet_ReadIC
suffix:semicolon
id|cs-&gt;writeisac
op_assign
op_amp
id|NETjet_WriteIC
suffix:semicolon
id|cs-&gt;readisacfifo
op_assign
op_amp
id|NETjet_ReadICfifo
suffix:semicolon
id|cs-&gt;writeisacfifo
op_assign
op_amp
id|NETjet_WriteICfifo
suffix:semicolon
id|cs-&gt;BC_Read_Reg
op_assign
op_amp
id|dummyrr
suffix:semicolon
id|cs-&gt;BC_Write_Reg
op_assign
op_amp
id|dummywr
suffix:semicolon
id|cs-&gt;BC_Send_Data
op_assign
op_amp
id|netjet_fill_dma
suffix:semicolon
id|setup_isac
c_func
(paren
id|cs
)paren
suffix:semicolon
id|cs-&gt;cardmsg
op_assign
op_amp
id|NETjet_S_card_msg
suffix:semicolon
id|cs-&gt;irq_func
op_assign
op_amp
id|netjet_s_interrupt
suffix:semicolon
id|cs-&gt;irq_flags
op_or_assign
id|SA_SHIRQ
suffix:semicolon
id|ISACVersion
c_func
(paren
id|cs
comma
l_string|&quot;NETjet-S:&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
eof
