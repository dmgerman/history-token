multiline_comment|/* $Id: shmem.c,v 1.2.10.1 2001/09/23 22:24:59 kai Exp $&n; *&n; * Copyright (C) 1996  SpellCaster Telecommunications Inc.&n; *&n; * Card functions implementing ISDN4Linux functionality&n; *&n; * This software may be used and distributed according to the terms&n; * of the GNU General Public License, incorporated herein by reference.&n; *&n; * For more information, please contact gpl-info@spellcast.com or write:&n; *&n; *     SpellCaster Telecommunications Inc.&n; *     5621 Finch Avenue East, Unit #3&n; *     Scarborough, Ontario  Canada&n; *     M1B 2T9&n; *     +1 (416) 297-8565&n; *     +1 (416) 297-6433 Facsimile&n; */
macro_line|#include &quot;includes.h&quot;&t;&t;/* This must be first */
macro_line|#include &quot;hardware.h&quot;
macro_line|#include &quot;card.h&quot;
multiline_comment|/*&n; * Main adapter array&n; */
r_extern
id|board
op_star
id|sc_adapter
(braket
)braket
suffix:semicolon
r_extern
r_int
id|cinst
suffix:semicolon
multiline_comment|/*&n; *&n; */
DECL|function|memcpy_toshmem
r_void
id|memcpy_toshmem
c_func
(paren
r_int
id|card
comma
r_void
op_star
id|dest
comma
r_const
r_void
op_star
id|src
comma
r_int
id|n
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|ch
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_VALID_CARD
c_func
(paren
id|card
)paren
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;Invalid param: %d is not a valid card id&bslash;n&quot;
comma
id|card
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
OG
id|SRAM_PAGESIZE
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * determine the page to load from the address&n;&t; */
id|ch
op_assign
(paren
r_int
r_int
)paren
id|dest
op_div
id|SRAM_PAGESIZE
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: loaded page %d&bslash;n&quot;
comma
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|devicename
comma
id|ch
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Block interrupts and load the page&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|lock
comma
id|flags
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|shmem_magic
op_plus
id|ch
op_star
id|SRAM_PAGESIZE
)paren
op_rshift
l_int|14
)paren
op_or
l_int|0x80
comma
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|ioport
(braket
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|shmem_pgport
)braket
)paren
suffix:semicolon
id|memcpy_toio
c_func
(paren
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|rambase
op_plus
(paren
(paren
r_int
r_int
)paren
id|dest
op_mod
l_int|0x4000
)paren
comma
id|src
comma
id|n
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|lock
comma
id|flags
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: set page to %#x&bslash;n&quot;
comma
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|devicename
comma
(paren
(paren
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|shmem_magic
op_plus
id|ch
op_star
id|SRAM_PAGESIZE
)paren
op_rshift
l_int|14
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: copying %d bytes from %#x to %#x&bslash;n&quot;
comma
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|devicename
comma
id|n
comma
(paren
r_int
r_int
)paren
id|src
comma
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|rambase
op_plus
(paren
(paren
r_int
r_int
)paren
id|dest
op_mod
l_int|0x4000
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Reverse of above&n; */
DECL|function|memcpy_fromshmem
r_void
id|memcpy_fromshmem
c_func
(paren
r_int
id|card
comma
r_void
op_star
id|dest
comma
r_const
r_void
op_star
id|src
comma
r_int
id|n
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|ch
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_VALID_CARD
c_func
(paren
id|card
)paren
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;Invalid param: %d is not a valid card id&bslash;n&quot;
comma
id|card
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
OG
id|SRAM_PAGESIZE
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * determine the page to load from the address&n;&t; */
id|ch
op_assign
(paren
r_int
r_int
)paren
id|src
op_div
id|SRAM_PAGESIZE
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: loaded page %d&bslash;n&quot;
comma
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|devicename
comma
id|ch
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Block interrupts and load the page&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|lock
comma
id|flags
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|shmem_magic
op_plus
id|ch
op_star
id|SRAM_PAGESIZE
)paren
op_rshift
l_int|14
)paren
op_or
l_int|0x80
comma
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|ioport
(braket
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|shmem_pgport
)braket
)paren
suffix:semicolon
id|memcpy_fromio
c_func
(paren
id|dest
comma
(paren
r_void
op_star
)paren
(paren
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|rambase
op_plus
(paren
(paren
r_int
r_int
)paren
id|src
op_mod
l_int|0x4000
)paren
)paren
comma
id|n
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|lock
comma
id|flags
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: set page to %#x&bslash;n&quot;
comma
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|devicename
comma
(paren
(paren
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|shmem_magic
op_plus
id|ch
op_star
id|SRAM_PAGESIZE
)paren
op_rshift
l_int|14
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/*&t;pr_debug(&quot;%s: copying %d bytes from %#x to %#x&bslash;n&quot;,&n;&t;&t;sc_adapter[card]-&gt;devicename, n,&n;&t;&t;sc_adapter[card]-&gt;rambase + ((unsigned long) src %0x4000), (unsigned long) dest); */
)brace
DECL|function|memset_shmem
r_void
id|memset_shmem
c_func
(paren
r_int
id|card
comma
r_void
op_star
id|dest
comma
r_int
id|c
comma
r_int
id|n
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|ch
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_VALID_CARD
c_func
(paren
id|card
)paren
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;Invalid param: %d is not a valid card id&bslash;n&quot;
comma
id|card
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
OG
id|SRAM_PAGESIZE
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * determine the page to load from the address&n;&t; */
id|ch
op_assign
(paren
r_int
r_int
)paren
id|dest
op_div
id|SRAM_PAGESIZE
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: loaded page %d&bslash;n&quot;
comma
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|devicename
comma
id|ch
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Block interrupts and load the page&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|lock
comma
id|flags
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|shmem_magic
op_plus
id|ch
op_star
id|SRAM_PAGESIZE
)paren
op_rshift
l_int|14
)paren
op_or
l_int|0x80
comma
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|ioport
(braket
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|shmem_pgport
)braket
)paren
suffix:semicolon
id|memset_io
c_func
(paren
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|rambase
op_plus
(paren
(paren
r_int
r_int
)paren
id|dest
op_mod
l_int|0x4000
)paren
comma
id|c
comma
id|n
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: set page to %#x&bslash;n&quot;
comma
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|devicename
comma
(paren
(paren
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|shmem_magic
op_plus
id|ch
op_star
id|SRAM_PAGESIZE
)paren
op_rshift
l_int|14
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sc_adapter
(braket
id|card
)braket
op_member_access_from_pointer
id|lock
comma
id|flags
)paren
suffix:semicolon
)brace
eof
