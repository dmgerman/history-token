multiline_comment|/*&n; *&n;  Copyright (c) Eicon Networks, 2002.&n; *&n;  This source file is supplied for the use with&n;  Eicon Networks range of DIVA Server Adapters.&n; *&n;  Eicon File Revision :    2.1&n; *&n;  This program is free software; you can redistribute it and/or modify&n;  it under the terms of the GNU General Public License as published by&n;  the Free Software Foundation; either version 2, or (at your option)&n;  any later version.&n; *&n;  This program is distributed in the hope that it will be useful,&n;  but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY&n;  implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n;  See the GNU General Public License for more details.&n; *&n;  You should have received a copy of the GNU General Public License&n;  along with this program; if not, write to the Free Software&n;  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;di_defs.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;di.h&quot;
macro_line|#include &quot;mi_pc.h&quot;
macro_line|#include &quot;pc_maint.h&quot;
macro_line|#include &quot;divasync.h&quot;
macro_line|#include &quot;io.h&quot;
macro_line|#include &quot;helpers.h&quot;
macro_line|#include &quot;dsrv_pri.h&quot;
macro_line|#include &quot;dsp_defs.h&quot;
multiline_comment|/*****************************************************************************/
DECL|macro|MAX_XLOG_SIZE
mdefine_line|#define MAX_XLOG_SIZE  (64 * 1024)
multiline_comment|/* -------------------------------------------------------------------------&n;  Does return offset between ADAPTER-&gt;ram and real begin of memory&n;  ------------------------------------------------------------------------- */
DECL|function|pri_ram_offset
r_static
id|dword
id|pri_ram_offset
(paren
id|ADAPTER
op_star
id|a
)paren
(brace
r_return
(paren
(paren
id|dword
)paren
id|MP_SHARED_RAM_OFFSET
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Recovery XLOG buffer from the card&n;  ------------------------------------------------------------------------- */
DECL|function|pri_cpu_trapped
r_static
r_void
id|pri_cpu_trapped
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
id|__iomem
op_star
id|base
suffix:semicolon
id|word
op_star
id|Xlog
suffix:semicolon
id|dword
id|regs
(braket
l_int|4
)braket
comma
id|TrapID
comma
id|size
suffix:semicolon
id|Xdesc
id|xlogDesc
suffix:semicolon
multiline_comment|/*&n; * check for trapped MIPS 46xx CPU, dump exception frame&n; */
id|base
op_assign
id|DIVA_OS_MEM_ATTACH_ADDRESS
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|TrapID
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
l_int|0x80
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|TrapID
op_eq
l_int|0x99999999
)paren
op_logical_or
(paren
id|TrapID
op_eq
l_int|0x99999901
)paren
)paren
(brace
id|dump_trap_frame
(paren
id|IoAdapter
comma
op_amp
id|base
(braket
l_int|0x90
)braket
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|1
suffix:semicolon
)brace
id|regs
(braket
l_int|0
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
id|MP_PROTOCOL_OFFSET
op_plus
l_int|0x70
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|1
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
id|MP_PROTOCOL_OFFSET
op_plus
l_int|0x74
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|2
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
id|MP_PROTOCOL_OFFSET
op_plus
l_int|0x78
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|3
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
id|MP_PROTOCOL_OFFSET
op_plus
l_int|0x7c
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|0
)braket
op_and_assign
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|regs
(braket
l_int|0
)braket
OL
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|Xlog
op_assign
(paren
id|word
op_star
)paren
id|diva_os_malloc
(paren
l_int|0
comma
id|MAX_XLOG_SIZE
)paren
)paren
)paren
(brace
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|base
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|size
op_assign
id|IoAdapter-&gt;MemorySize
op_minus
id|regs
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|MAX_XLOG_SIZE
)paren
id|size
op_assign
id|MAX_XLOG_SIZE
suffix:semicolon
id|memcpy_fromio
c_func
(paren
id|Xlog
comma
op_amp
id|base
(braket
id|regs
(braket
l_int|0
)braket
)braket
comma
id|size
)paren
suffix:semicolon
id|xlogDesc.buf
op_assign
id|Xlog
suffix:semicolon
id|xlogDesc.cnt
op_assign
id|READ_WORD
c_func
(paren
op_amp
id|base
(braket
id|regs
(braket
l_int|1
)braket
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)braket
)paren
suffix:semicolon
id|xlogDesc.out
op_assign
id|READ_WORD
c_func
(paren
op_amp
id|base
(braket
id|regs
(braket
l_int|2
)braket
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)braket
)paren
suffix:semicolon
id|dump_xlog_buffer
(paren
id|IoAdapter
comma
op_amp
id|xlogDesc
)paren
suffix:semicolon
id|diva_os_free
(paren
l_int|0
comma
id|Xlog
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|2
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|base
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Hardware reset of PRI card&n;  ------------------------------------------------------------------------- */
DECL|function|reset_pri_hardware
r_static
r_void
id|reset_pri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
id|__iomem
op_star
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_BYTE
c_func
(paren
id|p
comma
id|_MP_RISC_RESET
op_or
id|_MP_LED1
op_or
id|_MP_LED2
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|50
)paren
suffix:semicolon
id|WRITE_BYTE
c_func
(paren
id|p
comma
l_int|0x00
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|50
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Stop Card Hardware&n;  ------------------------------------------------------------------------- */
DECL|function|stop_pri_hardware
r_static
r_void
id|stop_pri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
id|i
suffix:semicolon
id|byte
id|__iomem
op_star
id|p
suffix:semicolon
id|dword
r_volatile
id|__iomem
op_star
id|cfgReg
op_assign
(paren
r_void
id|__iomem
op_star
)paren
id|DIVA_OS_MEM_ATTACH_CFG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
op_amp
id|cfgReg
(braket
l_int|3
)braket
comma
l_int|0
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
op_amp
id|cfgReg
(braket
l_int|1
)braket
comma
l_int|0
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CFG
c_func
(paren
id|IoAdapter
comma
id|cfgReg
)paren
suffix:semicolon
id|IoAdapter-&gt;a.ram_out
(paren
op_amp
id|IoAdapter-&gt;a
comma
op_amp
id|RAM-&gt;SWReg
comma
id|SWREG_HALT_CPU
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|i
OL
l_int|100
)paren
op_logical_and
(paren
id|IoAdapter-&gt;a.ram_in
(paren
op_amp
id|IoAdapter-&gt;a
comma
op_amp
id|RAM-&gt;SWReg
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;%s: PRI stopped (%d)&quot;
comma
id|IoAdapter-&gt;Name
comma
id|i
)paren
)paren
id|cfgReg
op_assign
(paren
r_void
id|__iomem
op_star
)paren
id|DIVA_OS_MEM_ATTACH_CFG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
op_amp
id|cfgReg
(braket
l_int|0
)braket
comma
(paren
(paren
id|dword
)paren
(paren
op_complement
l_int|0x03E00000
)paren
)paren
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CFG
c_func
(paren
id|IoAdapter
comma
id|cfgReg
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_BYTE
c_func
(paren
id|p
comma
id|_MP_RISC_RESET
op_or
id|_MP_LED1
op_or
id|_MP_LED2
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
)brace
DECL|function|load_pri_hardware
r_static
r_int
id|load_pri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;  PRI Adapter interrupt Service Routine&n;   -------------------------------------------------------------------------- */
DECL|function|pri_ISR
r_static
r_int
id|pri_ISR
(paren
r_struct
id|_ISDN_ADAPTER
op_star
id|IoAdapter
)paren
(brace
id|byte
id|__iomem
op_star
id|cfg
op_assign
id|DIVA_OS_MEM_ATTACH_CFG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|READ_DWORD
c_func
(paren
id|cfg
)paren
op_amp
l_int|0x80000000
)paren
)paren
(brace
id|DIVA_OS_MEM_DETACH_CFG
c_func
(paren
id|IoAdapter
comma
id|cfg
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  clear interrupt line&n;  */
id|WRITE_DWORD
c_func
(paren
id|cfg
comma
(paren
id|dword
)paren
op_complement
l_int|0x03E00000
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CFG
c_func
(paren
id|IoAdapter
comma
id|cfg
)paren
suffix:semicolon
id|IoAdapter-&gt;IrqCount
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;Initialized
)paren
(brace
id|diva_os_schedule_soft_isr
(paren
op_amp
id|IoAdapter-&gt;isr_soft_isr
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Disable interrupt in the card hardware&n;  ------------------------------------------------------------------------- */
DECL|function|disable_pri_interrupt
r_static
r_void
id|disable_pri_interrupt
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
r_volatile
id|__iomem
op_star
id|cfgReg
op_assign
(paren
id|dword
r_volatile
id|__iomem
op_star
)paren
id|DIVA_OS_MEM_ATTACH_CFG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
op_amp
id|cfgReg
(braket
l_int|3
)braket
comma
l_int|0
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
op_amp
id|cfgReg
(braket
l_int|1
)braket
comma
l_int|0
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
op_amp
id|cfgReg
(braket
l_int|0
)braket
comma
(paren
id|dword
)paren
(paren
op_complement
l_int|0x03E00000
)paren
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CFG
c_func
(paren
id|IoAdapter
comma
id|cfgReg
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Install entry points for PRI Adapter&n;  ------------------------------------------------------------------------- */
DECL|function|prepare_common_pri_functions
r_static
r_void
id|prepare_common_pri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|ADAPTER
op_star
id|a
op_assign
op_amp
id|IoAdapter-&gt;a
suffix:semicolon
id|a-&gt;ram_in
op_assign
id|mem_in
suffix:semicolon
id|a-&gt;ram_inw
op_assign
id|mem_inw
suffix:semicolon
id|a-&gt;ram_in_buffer
op_assign
id|mem_in_buffer
suffix:semicolon
id|a-&gt;ram_look_ahead
op_assign
id|mem_look_ahead
suffix:semicolon
id|a-&gt;ram_out
op_assign
id|mem_out
suffix:semicolon
id|a-&gt;ram_outw
op_assign
id|mem_outw
suffix:semicolon
id|a-&gt;ram_out_buffer
op_assign
id|mem_out_buffer
suffix:semicolon
id|a-&gt;ram_inc
op_assign
id|mem_inc
suffix:semicolon
id|a-&gt;ram_offset
op_assign
id|pri_ram_offset
suffix:semicolon
id|a-&gt;ram_out_dw
op_assign
id|mem_out_dw
suffix:semicolon
id|a-&gt;ram_in_dw
op_assign
id|mem_in_dw
suffix:semicolon
id|a-&gt;istream_wakeup
op_assign
id|pr_stream
suffix:semicolon
id|IoAdapter-&gt;out
op_assign
id|pr_out
suffix:semicolon
id|IoAdapter-&gt;dpc
op_assign
id|pr_dpc
suffix:semicolon
id|IoAdapter-&gt;tst_irq
op_assign
id|scom_test_int
suffix:semicolon
id|IoAdapter-&gt;clr_irq
op_assign
id|scom_clear_int
suffix:semicolon
id|IoAdapter-&gt;pcm
op_assign
(paren
r_struct
id|pc_maint
op_star
)paren
(paren
id|MIPS_MAINT_OFFS
op_minus
id|MP_SHARED_RAM_OFFSET
)paren
suffix:semicolon
id|IoAdapter-&gt;load
op_assign
id|load_pri_hardware
suffix:semicolon
id|IoAdapter-&gt;disIrq
op_assign
id|disable_pri_interrupt
suffix:semicolon
id|IoAdapter-&gt;rstFnc
op_assign
id|reset_pri_hardware
suffix:semicolon
id|IoAdapter-&gt;stop
op_assign
id|stop_pri_hardware
suffix:semicolon
id|IoAdapter-&gt;trapFnc
op_assign
id|pri_cpu_trapped
suffix:semicolon
id|IoAdapter-&gt;diva_isr_handler
op_assign
id|pri_ISR
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Install entry points for PRI Adapter&n;  ------------------------------------------------------------------------- */
DECL|function|prepare_pri_functions
r_void
id|prepare_pri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|IoAdapter-&gt;MemorySize
op_assign
id|MP_MEMORY_SIZE
suffix:semicolon
id|prepare_common_pri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
id|diva_os_prepare_pri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Install entry points for PRI Rev.2 Adapter&n;  ------------------------------------------------------------------------- */
DECL|function|prepare_pri2_functions
r_void
id|prepare_pri2_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|IoAdapter-&gt;MemorySize
op_assign
id|MP2_MEMORY_SIZE
suffix:semicolon
id|prepare_common_pri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
id|diva_os_prepare_pri2_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------- */
eof
