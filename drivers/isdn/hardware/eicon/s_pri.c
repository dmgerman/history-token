multiline_comment|/*&n; *&n;  Copyright (c) Eicon Networks, 2002.&n; *&n;  This source file is supplied for the use with&n;  Eicon Networks range of DIVA Server Adapters.&n; *&n;  Eicon File Revision :    2.1&n; *&n;  This program is free software; you can redistribute it and/or modify&n;  it under the terms of the GNU General Public License as published by&n;  the Free Software Foundation; either version 2, or (at your option)&n;  any later version.&n; *&n;  This program is distributed in the hope that it will be useful,&n;  but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY&n;  implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n;  See the GNU General Public License for more details.&n; *&n;  You should have received a copy of the GNU General Public License&n;  along with this program; if not, write to the Free Software&n;  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;di_defs.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;di.h&quot;
macro_line|#include &quot;mi_pc.h&quot;
macro_line|#include &quot;pc_maint.h&quot;
macro_line|#include &quot;divasync.h&quot;
macro_line|#include &quot;io.h&quot;
macro_line|#include &quot;helpers.h&quot;
macro_line|#include &quot;dsrv_pri.h&quot;
macro_line|#include &quot;dsp_defs.h&quot;
multiline_comment|/*****************************************************************************/
DECL|macro|MAX_XLOG_SIZE
mdefine_line|#define MAX_XLOG_SIZE  (64 * 1024)
multiline_comment|/* -------------------------------------------------------------------------&n;  Does return offset between ADAPTER-&gt;ram and real begin of memory&n;  ------------------------------------------------------------------------- */
DECL|function|pri_ram_offset
r_static
id|dword
id|pri_ram_offset
(paren
id|ADAPTER
op_star
id|a
)paren
(brace
r_return
(paren
(paren
id|dword
)paren
id|MP_SHARED_RAM_OFFSET
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Recovery XLOG buffer from the card&n;  ------------------------------------------------------------------------- */
DECL|function|pri_cpu_trapped
r_static
r_void
id|pri_cpu_trapped
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
op_star
id|base
suffix:semicolon
id|word
op_star
id|Xlog
suffix:semicolon
id|dword
id|regs
(braket
l_int|4
)braket
comma
id|TrapID
comma
id|size
suffix:semicolon
id|Xdesc
id|xlogDesc
suffix:semicolon
multiline_comment|/*&n; * check for trapped MIPS 46xx CPU, dump exception frame&n; */
id|base
op_assign
id|IoAdapter-&gt;ram
op_minus
id|MP_SHARED_RAM_OFFSET
suffix:semicolon
id|TrapID
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
l_int|0x80
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|TrapID
op_eq
l_int|0x99999999
)paren
op_logical_or
(paren
id|TrapID
op_eq
l_int|0x99999901
)paren
)paren
(brace
id|dump_trap_frame
(paren
id|IoAdapter
comma
op_amp
id|base
(braket
l_int|0x90
)braket
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|1
suffix:semicolon
)brace
id|regs
(braket
l_int|0
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
id|MP_PROTOCOL_OFFSET
op_plus
l_int|0x70
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|1
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
id|MP_PROTOCOL_OFFSET
op_plus
l_int|0x74
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|2
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
id|MP_PROTOCOL_OFFSET
op_plus
l_int|0x78
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|3
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
id|MP_PROTOCOL_OFFSET
op_plus
l_int|0x7c
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|0
)braket
op_and_assign
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|regs
(braket
l_int|0
)braket
OL
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|Xlog
op_assign
(paren
id|word
op_star
)paren
id|diva_os_malloc
(paren
l_int|0
comma
id|MAX_XLOG_SIZE
)paren
)paren
)paren
r_return
suffix:semicolon
id|size
op_assign
id|IoAdapter-&gt;MemorySize
op_minus
id|regs
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|MAX_XLOG_SIZE
)paren
id|size
op_assign
id|MAX_XLOG_SIZE
suffix:semicolon
id|memcpy
(paren
id|Xlog
comma
op_amp
id|base
(braket
id|regs
(braket
l_int|0
)braket
)braket
comma
id|size
)paren
suffix:semicolon
id|xlogDesc.buf
op_assign
id|Xlog
suffix:semicolon
id|xlogDesc.cnt
op_assign
id|READ_WORD
c_func
(paren
op_amp
id|base
(braket
id|regs
(braket
l_int|1
)braket
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)braket
)paren
suffix:semicolon
id|xlogDesc.out
op_assign
id|READ_WORD
c_func
(paren
op_amp
id|base
(braket
id|regs
(braket
l_int|2
)braket
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)braket
)paren
suffix:semicolon
id|dump_xlog_buffer
(paren
id|IoAdapter
comma
op_amp
id|xlogDesc
)paren
suffix:semicolon
id|diva_os_free
(paren
l_int|0
comma
id|Xlog
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|2
suffix:semicolon
)brace
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Hardware reset of PRI card&n;  ------------------------------------------------------------------------- */
DECL|function|reset_pri_hardware
r_static
r_void
id|reset_pri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
op_star
id|IoAdapter-&gt;reset
op_assign
id|_MP_RISC_RESET
op_or
id|_MP_LED1
op_or
id|_MP_LED2
suffix:semicolon
id|diva_os_wait
(paren
l_int|50
)paren
suffix:semicolon
op_star
id|IoAdapter-&gt;reset
op_assign
l_int|0x00
suffix:semicolon
id|diva_os_wait
(paren
l_int|50
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Stop Card Hardware&n;  ------------------------------------------------------------------------- */
DECL|function|stop_pri_hardware
r_static
r_void
id|stop_pri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
id|i
suffix:semicolon
id|dword
r_volatile
op_star
id|cfgReg
op_assign
(paren
id|dword
r_volatile
op_star
)paren
id|IoAdapter-&gt;cfg
suffix:semicolon
id|cfgReg
(braket
l_int|3
)braket
op_assign
l_int|0x00000000
suffix:semicolon
id|cfgReg
(braket
l_int|1
)braket
op_assign
l_int|0x00000000
suffix:semicolon
id|IoAdapter-&gt;a.ram_out
(paren
op_amp
id|IoAdapter-&gt;a
comma
op_amp
id|RAM-&gt;SWReg
comma
id|SWREG_HALT_CPU
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|i
OL
l_int|100
)paren
op_logical_and
(paren
id|IoAdapter-&gt;a.ram_in
(paren
op_amp
id|IoAdapter-&gt;a
comma
op_amp
id|RAM-&gt;SWReg
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;%s: PRI stopped (%d)&quot;
comma
id|IoAdapter-&gt;Name
comma
id|i
)paren
)paren
id|WRITE_DWORD
c_func
(paren
op_amp
id|cfgReg
(braket
l_int|0
)braket
comma
(paren
(paren
id|dword
)paren
(paren
op_complement
l_int|0x03E00000
)paren
)paren
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
op_star
id|IoAdapter-&gt;reset
op_assign
id|_MP_RISC_RESET
op_or
id|_MP_LED1
op_or
id|_MP_LED2
suffix:semicolon
)brace
macro_line|#if !defined(DIVA_USER_MODE_CARD_CONFIG) /* { */
multiline_comment|/* -------------------------------------------------------------------------&n;  Load protocol code to the PRI Card&n;  ------------------------------------------------------------------------- */
DECL|macro|DOWNLOAD_ADDR
mdefine_line|#define DOWNLOAD_ADDR(IoAdapter) &bslash;&n; (&amp;IoAdapter-&gt;ram[IoAdapter-&gt;downloadAddr &amp; (IoAdapter-&gt;MemorySize - 1)])
DECL|function|pri_protocol_load
r_static
r_int
id|pri_protocol_load
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
id|FileLength
suffix:semicolon
id|dword
op_star
id|File
suffix:semicolon
id|dword
op_star
id|sharedRam
suffix:semicolon
id|dword
id|Addr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|File
op_assign
(paren
id|dword
op_star
)paren
id|xdiLoadArchive
(paren
id|IoAdapter
comma
op_amp
id|FileLength
comma
l_int|0
)paren
)paren
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|IoAdapter-&gt;features
op_assign
id|diva_get_protocol_file_features
(paren
(paren
id|byte
op_star
)paren
id|File
comma
id|OFFS_PROTOCOL_ID_STRING
comma
id|IoAdapter-&gt;ProtocolIdString
comma
r_sizeof
(paren
id|IoAdapter-&gt;ProtocolIdString
)paren
)paren
suffix:semicolon
id|IoAdapter-&gt;a.protocol_capabilities
op_assign
id|IoAdapter-&gt;features
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;Loading %s&quot;
comma
id|IoAdapter-&gt;ProtocolIdString
)paren
)paren
id|Addr
op_assign
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
)braket
)paren
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
op_plus
l_int|1
)braket
)paren
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
op_plus
l_int|2
)braket
)paren
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
op_plus
l_int|3
)braket
)paren
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Addr
op_ne
l_int|0
)paren
(brace
id|IoAdapter-&gt;DspCodeBaseAddr
op_assign
(paren
id|Addr
op_plus
l_int|3
)paren
op_amp
(paren
op_complement
l_int|3
)paren
suffix:semicolon
id|IoAdapter-&gt;MaxDspCodeSize
op_assign
(paren
id|MP_UNCACHED_ADDR
(paren
id|IoAdapter-&gt;MemorySize
)paren
op_minus
id|IoAdapter-&gt;DspCodeBaseAddr
)paren
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
suffix:semicolon
id|Addr
op_assign
id|IoAdapter-&gt;DspCodeBaseAddr
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
)braket
op_assign
(paren
id|byte
)paren
id|Addr
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
op_plus
l_int|1
)braket
op_assign
(paren
id|byte
)paren
(paren
id|Addr
op_rshift
l_int|8
)paren
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
op_plus
l_int|2
)braket
op_assign
(paren
id|byte
)paren
(paren
id|Addr
op_rshift
l_int|16
)paren
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
op_plus
l_int|3
)braket
op_assign
(paren
id|byte
)paren
(paren
id|Addr
op_rshift
l_int|24
)paren
suffix:semicolon
id|IoAdapter-&gt;InitialDspInfo
op_assign
l_int|0x80
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|IoAdapter-&gt;features
op_amp
id|PROTCAP_VOIP
)paren
id|IoAdapter-&gt;MaxDspCodeSize
op_assign
id|MP_VOIP_MAX_DSP_CODE_SIZE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|IoAdapter-&gt;features
op_amp
id|PROTCAP_V90D
)paren
id|IoAdapter-&gt;MaxDspCodeSize
op_assign
id|MP_V90D_MAX_DSP_CODE_SIZE
suffix:semicolon
r_else
id|IoAdapter-&gt;MaxDspCodeSize
op_assign
id|MP_ORG_MAX_DSP_CODE_SIZE
suffix:semicolon
id|IoAdapter-&gt;DspCodeBaseAddr
op_assign
id|MP_CACHED_ADDR
(paren
id|IoAdapter-&gt;MemorySize
op_minus
id|IoAdapter-&gt;MaxDspCodeSize
)paren
suffix:semicolon
id|IoAdapter-&gt;InitialDspInfo
op_assign
(paren
id|IoAdapter-&gt;MaxDspCodeSize
op_minus
id|MP_ORG_MAX_DSP_CODE_SIZE
)paren
op_rshift
l_int|14
suffix:semicolon
)brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;DSP code base 0x%08lx, max size 0x%08lx (%08lx,%02x)&quot;
comma
id|IoAdapter-&gt;DspCodeBaseAddr
comma
id|IoAdapter-&gt;MaxDspCodeSize
comma
id|Addr
comma
id|IoAdapter-&gt;InitialDspInfo
)paren
)paren
r_if
c_cond
(paren
id|FileLength
OG
(paren
(paren
id|IoAdapter-&gt;DspCodeBaseAddr
op_minus
id|MP_CACHED_ADDR
(paren
id|MP_PROTOCOL_OFFSET
)paren
)paren
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;Protocol code &squot;%s&squot; too long (%ld)&quot;
comma
op_amp
id|IoAdapter-&gt;Protocol
(braket
l_int|0
)braket
comma
id|FileLength
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|IoAdapter-&gt;downloadAddr
op_assign
id|MP_UNCACHED_ADDR
(paren
id|MP_PROTOCOL_OFFSET
)paren
suffix:semicolon
id|sharedRam
op_assign
(paren
id|dword
op_star
)paren
id|DOWNLOAD_ADDR
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|memcpy
(paren
id|sharedRam
comma
id|File
comma
id|FileLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
(paren
id|sharedRam
comma
id|File
comma
id|FileLength
)paren
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: Memory test failed!&quot;
comma
id|IoAdapter-&gt;Properties.Name
)paren
)paren
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/*------------------------------------------------------------------&n;  Dsp related definitions&n;  ------------------------------------------------------------------ */
DECL|macro|DSP_SIGNATURE_PROBE_WORD
mdefine_line|#define DSP_SIGNATURE_PROBE_WORD 0x5a5a
multiline_comment|/*&n;**  Checks presence of DSP on board&n;*/
r_static
r_int
DECL|function|dsp_check_presence
id|dsp_check_presence
(paren
r_volatile
id|byte
op_star
id|addr
comma
r_volatile
id|byte
op_star
id|data
comma
r_int
id|dsp
)paren
(brace
id|word
id|pattern
suffix:semicolon
op_star
(paren
r_volatile
id|word
op_star
)paren
id|addr
op_assign
l_int|0x4000
suffix:semicolon
op_star
(paren
r_volatile
id|word
op_star
)paren
id|data
op_assign
id|DSP_SIGNATURE_PROBE_WORD
suffix:semicolon
op_star
(paren
r_volatile
id|word
op_star
)paren
id|addr
op_assign
l_int|0x4000
suffix:semicolon
id|pattern
op_assign
op_star
(paren
r_volatile
id|word
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|pattern
op_ne
id|DSP_SIGNATURE_PROBE_WORD
)paren
(brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;W: DSP[%d] %04x(is) != %04x(should)&quot;
comma
id|dsp
comma
id|pattern
comma
id|DSP_SIGNATURE_PROBE_WORD
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
op_star
(paren
r_volatile
id|word
op_star
)paren
id|addr
op_assign
l_int|0x4000
suffix:semicolon
op_star
(paren
r_volatile
id|word
op_star
)paren
id|data
op_assign
op_complement
id|DSP_SIGNATURE_PROBE_WORD
suffix:semicolon
op_star
(paren
r_volatile
id|word
op_star
)paren
id|addr
op_assign
l_int|0x4000
suffix:semicolon
id|pattern
op_assign
op_star
(paren
r_volatile
id|word
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|pattern
op_ne
(paren
id|word
)paren
op_complement
id|DSP_SIGNATURE_PROBE_WORD
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: DSP[%d] %04x(is) != %04x(should)&quot;
comma
id|dsp
comma
id|pattern
comma
(paren
id|word
)paren
op_complement
id|DSP_SIGNATURE_PROBE_WORD
)paren
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
id|DBG_TRC
(paren
(paren
l_string|&quot;DSP[%d] present&quot;
comma
id|dsp
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  Check if DSP&squot;s are present and operating&n;**  Information about detected DSP&squot;s is returned as bit mask&n;**  Bit 0  - DSP1&n;**  ...&n;**  ...&n;**  ...&n;**  Bit 29 - DSP30&n;*/
r_static
id|dword
DECL|function|diva_pri_detect_dsps
id|diva_pri_detect_dsps
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
multiline_comment|/* byte* base = a-&gt;resources.pci.addr[2]; */
id|byte
op_star
id|base
op_assign
id|IoAdapter-&gt;reset
op_minus
id|MP_RESET
suffix:semicolon
id|dword
id|ret
op_assign
l_int|0
comma
id|DspCount
op_assign
l_int|0
suffix:semicolon
id|dword
id|row_offset
(braket
)braket
op_assign
(brace
l_int|0x00000000
comma
l_int|0x00000800
comma
multiline_comment|/* 1 - ROW 1 */
l_int|0x00000840
comma
multiline_comment|/* 2 - ROW 2 */
l_int|0x00001000
comma
multiline_comment|/* 3 - ROW 3 */
l_int|0x00001040
comma
multiline_comment|/* 4 - ROW 4 */
l_int|0x00000000
multiline_comment|/* 5 - ROW 0 */
)brace
suffix:semicolon
id|byte
op_star
id|dsp_addr_port
comma
op_star
id|dsp_data_port
comma
id|row_state
suffix:semicolon
r_int
id|dsp_row
op_assign
l_int|0
comma
id|dsp_index
comma
id|dsp_num
suffix:semicolon
id|IoAdapter-&gt;InitialDspInfo
op_and_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* if (!base || !a-&gt;xdi_adapter.reset) */
r_if
c_cond
(paren
op_logical_neg
id|base
op_logical_or
op_logical_neg
id|IoAdapter-&gt;reset
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* *(volatile byte*)(a-&gt;xdi_adapter.reset) = _MP_RISC_RESET | _MP_DSP_RESET; */
op_star
(paren
r_volatile
id|byte
op_star
)paren
(paren
id|IoAdapter-&gt;reset
)paren
op_assign
id|_MP_RISC_RESET
op_or
id|_MP_DSP_RESET
suffix:semicolon
id|diva_os_wait
(paren
l_int|5
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dsp_num
op_assign
l_int|0
suffix:semicolon
id|dsp_num
OL
l_int|30
suffix:semicolon
id|dsp_num
op_increment
)paren
(brace
id|dsp_row
op_assign
id|dsp_num
op_div
l_int|7
op_plus
l_int|1
suffix:semicolon
id|dsp_index
op_assign
id|dsp_num
op_mod
l_int|7
suffix:semicolon
id|dsp_data_port
op_assign
id|base
suffix:semicolon
id|dsp_addr_port
op_assign
id|base
suffix:semicolon
id|dsp_data_port
op_add_assign
id|row_offset
(braket
id|dsp_row
)braket
suffix:semicolon
id|dsp_addr_port
op_add_assign
id|row_offset
(braket
id|dsp_row
)braket
suffix:semicolon
id|dsp_data_port
op_add_assign
(paren
id|dsp_index
op_star
l_int|8
)paren
suffix:semicolon
id|dsp_addr_port
op_add_assign
(paren
id|dsp_index
op_star
l_int|8
)paren
op_plus
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dsp_check_presence
(paren
id|dsp_addr_port
comma
id|dsp_data_port
comma
id|dsp_num
op_plus
l_int|1
)paren
)paren
(brace
id|ret
op_or_assign
(paren
l_int|1
op_lshift
id|dsp_num
)paren
suffix:semicolon
id|DspCount
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* *(volatile byte*)(a-&gt;xdi_adapter.reset) = _MP_RISC_RESET | _MP_LED1 | _MP_LED2; */
op_star
(paren
r_volatile
id|byte
op_star
)paren
(paren
id|IoAdapter-&gt;reset
)paren
op_assign
id|_MP_RISC_RESET
op_or
id|_MP_LED1
op_or
id|_MP_LED2
suffix:semicolon
id|diva_os_wait
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/*&n;    Verify modules&n;  */
r_for
c_loop
(paren
id|dsp_row
op_assign
l_int|0
suffix:semicolon
id|dsp_row
OL
l_int|4
suffix:semicolon
id|dsp_row
op_increment
)paren
(brace
id|row_state
op_assign
(paren
id|byte
)paren
(paren
(paren
id|ret
op_rshift
(paren
id|dsp_row
op_star
l_int|7
)paren
)paren
op_amp
l_int|0x7F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|row_state
op_logical_and
(paren
id|row_state
op_ne
l_int|0x7F
)paren
)paren
(brace
r_for
c_loop
(paren
id|dsp_index
op_assign
l_int|0
suffix:semicolon
id|dsp_index
OL
l_int|7
suffix:semicolon
id|dsp_index
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|row_state
op_amp
(paren
l_int|1
op_lshift
id|dsp_index
)paren
)paren
)paren
(brace
id|DBG_ERR
(paren
(paren
l_string|&quot;A: MODULE[%d]-DSP[%d] failed&quot;
comma
id|dsp_row
op_plus
l_int|1
comma
id|dsp_index
op_plus
l_int|1
)paren
)paren
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_amp
l_int|0x10000000
)paren
)paren
(brace
id|DBG_ERR
(paren
(paren
l_string|&quot;A: ON BOARD-DSP[1] failed&quot;
)paren
)paren
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_amp
l_int|0x20000000
)paren
)paren
(brace
id|DBG_ERR
(paren
(paren
l_string|&quot;A: ON BOARD-DSP[2] failed&quot;
)paren
)paren
)brace
multiline_comment|/*&n;    Print module population now&n;  */
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;+-----------------------+&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;| DSP MODULE POPULATION |&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;+-----------------------+&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;|  1  |  2  |  3  |  4  |&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;+-----------------------+&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;|  %s  |  %s  |  %s  |  %s  |&quot;
comma
(paren
(paren
id|ret
op_rshift
(paren
l_int|0
op_star
l_int|7
)paren
)paren
op_amp
l_int|0x7F
)paren
ques
c_cond
l_string|&quot;Y&quot;
suffix:colon
l_string|&quot;N&quot;
comma
(paren
(paren
id|ret
op_rshift
(paren
l_int|1
op_star
l_int|7
)paren
)paren
op_amp
l_int|0x7F
)paren
ques
c_cond
l_string|&quot;Y&quot;
suffix:colon
l_string|&quot;N&quot;
comma
(paren
(paren
id|ret
op_rshift
(paren
l_int|2
op_star
l_int|7
)paren
)paren
op_amp
l_int|0x7F
)paren
ques
c_cond
l_string|&quot;Y&quot;
suffix:colon
l_string|&quot;N&quot;
comma
(paren
(paren
id|ret
op_rshift
(paren
l_int|3
op_star
l_int|7
)paren
)paren
op_amp
l_int|0x7F
)paren
ques
c_cond
l_string|&quot;Y&quot;
suffix:colon
l_string|&quot;N&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;+-----------------------+&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;DSP&squot;s(present-absent):%08x-%08x&quot;
comma
id|ret
comma
op_complement
id|ret
op_amp
l_int|0x3fffffff
)paren
)paren
op_star
(paren
r_volatile
id|byte
op_star
)paren
(paren
id|IoAdapter-&gt;reset
)paren
op_assign
l_int|0
suffix:semicolon
id|diva_os_wait
(paren
l_int|50
)paren
suffix:semicolon
id|IoAdapter-&gt;InitialDspInfo
op_or_assign
id|DspCount
op_lshift
l_int|16
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  helper used to download dsp code toi PRI Card&n;  ------------------------------------------------------------------------- */
DECL|function|pri_download_buffer
r_static
r_int
id|pri_download_buffer
(paren
id|OsFileHandle
op_star
id|fp
comma
r_int
id|length
comma
r_void
op_star
op_star
id|addr
)paren
(brace
id|PISDN_ADAPTER
id|IoAdapter
op_assign
(paren
id|PISDN_ADAPTER
)paren
id|fp-&gt;sysLoadDesc
suffix:semicolon
id|dword
op_star
id|sharedRam
suffix:semicolon
op_star
id|addr
op_assign
(paren
r_void
op_star
)paren
id|IoAdapter-&gt;downloadAddr
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|dword
)paren
id|length
)paren
OG
id|IoAdapter-&gt;DspCodeBaseAddr
op_plus
id|IoAdapter-&gt;MaxDspCodeSize
op_minus
id|IoAdapter-&gt;downloadAddr
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: out of card memory during DSP download (0x%X)&quot;
comma
id|IoAdapter-&gt;Properties.Name
comma
id|IoAdapter-&gt;downloadAddr
op_plus
id|length
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|sharedRam
op_assign
(paren
id|dword
op_star
)paren
id|DOWNLOAD_ADDR
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;sysFileRead
(paren
id|fp
comma
id|sharedRam
comma
id|length
)paren
op_ne
id|length
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|IoAdapter-&gt;downloadAddr
op_add_assign
id|length
suffix:semicolon
id|IoAdapter-&gt;downloadAddr
op_assign
(paren
id|IoAdapter-&gt;downloadAddr
op_plus
l_int|3
)paren
op_amp
(paren
op_complement
l_int|3
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Download DSP code to PRI Card&n;  ------------------------------------------------------------------------- */
DECL|function|pri_telindus_load
r_static
id|dword
id|pri_telindus_load
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_char
op_star
id|error
suffix:semicolon
id|OsFileHandle
op_star
id|fp
suffix:semicolon
id|t_dsp_portable_desc
id|download_table
(braket
id|DSP_MAX_DOWNLOAD_COUNT
)braket
suffix:semicolon
id|word
id|download_count
suffix:semicolon
id|dword
op_star
id|sharedRam
suffix:semicolon
id|dword
id|FileLength
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|fp
op_assign
id|OsOpenFile
(paren
id|DSP_TELINDUS_FILE
)paren
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|IoAdapter-&gt;downloadAddr
op_assign
(paren
id|IoAdapter-&gt;DspCodeBaseAddr
op_plus
r_sizeof
(paren
id|dword
)paren
op_plus
r_sizeof
(paren
id|download_table
)paren
op_plus
l_int|3
)paren
op_amp
(paren
op_complement
l_int|3
)paren
suffix:semicolon
id|FileLength
op_assign
id|fp-&gt;sysFileSize
suffix:semicolon
id|fp-&gt;sysLoadDesc
op_assign
(paren
r_void
op_star
)paren
id|IoAdapter
suffix:semicolon
id|fp-&gt;sysCardLoad
op_assign
id|pri_download_buffer
suffix:semicolon
id|download_count
op_assign
id|DSP_MAX_DOWNLOAD_COUNT
suffix:semicolon
id|memset
(paren
op_amp
id|download_table
(braket
l_int|0
)braket
comma
l_char|&squot;&bslash;0&squot;
comma
r_sizeof
(paren
id|download_table
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * set start address for download (use autoincrement mode !)&n; */
id|error
op_assign
id|dsp_read_file
(paren
id|fp
comma
(paren
id|word
)paren
(paren
id|IoAdapter-&gt;cardType
)paren
comma
op_amp
id|download_count
comma
l_int|NULL
comma
op_amp
id|download_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;download file error: %s&quot;
comma
id|error
)paren
)paren
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
multiline_comment|/*&n; * store # of separate download files extracted from archive&n; */
id|IoAdapter-&gt;downloadAddr
op_assign
id|IoAdapter-&gt;DspCodeBaseAddr
suffix:semicolon
id|sharedRam
op_assign
(paren
id|dword
op_star
)paren
id|DOWNLOAD_ADDR
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
op_amp
(paren
id|sharedRam
(braket
l_int|0
)braket
)paren
comma
(paren
id|dword
)paren
id|download_count
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|sharedRam
(braket
l_int|1
)braket
comma
op_amp
id|download_table
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|download_table
)paren
)paren
suffix:semicolon
r_return
(paren
id|FileLength
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Download PRI Card&n;  ------------------------------------------------------------------------- */
DECL|macro|MIN_DSPS
mdefine_line|#define MIN_DSPS 0x30000000
DECL|function|load_pri_hardware
r_static
r_int
id|load_pri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
id|i
suffix:semicolon
r_struct
id|mp_load
op_star
id|boot
op_assign
(paren
r_struct
id|mp_load
op_star
)paren
id|IoAdapter-&gt;ram
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;Properties.Card
op_ne
id|CARD_MAEP
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|boot-&gt;err
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|IoAdapter-&gt;rstFnc
(paren
id|IoAdapter
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|MIN_DSPS
op_ne
(paren
id|MIN_DSPS
op_amp
id|diva_pri_detect_dsps
c_func
(paren
id|IoAdapter
)paren
)paren
)paren
(brace
multiline_comment|/* makes reset */
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: DSP error!&quot;
comma
id|IoAdapter-&gt;Properties.Name
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * check if CPU is alive&n; */
id|diva_os_wait
(paren
l_int|10
)paren
suffix:semicolon
id|i
op_assign
id|boot-&gt;live
suffix:semicolon
id|diva_os_wait
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|boot-&gt;live
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: CPU is not alive!&quot;
comma
id|IoAdapter-&gt;Properties.Name
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|boot-&gt;err
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: Board Selftest failed!&quot;
comma
id|IoAdapter-&gt;Properties.Name
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * download protocol and dsp files&n; */
r_if
c_cond
(paren
op_logical_neg
id|xdiSetProtocol
(paren
id|IoAdapter
comma
id|IoAdapter-&gt;ProtocolSuffix
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pri_protocol_load
(paren
id|IoAdapter
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pri_telindus_load
(paren
id|IoAdapter
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n; * copy configuration parameters&n; */
id|IoAdapter-&gt;ram
op_add_assign
id|MP_SHARED_RAM_OFFSET
suffix:semicolon
id|memset
(paren
id|IoAdapter-&gt;ram
comma
l_char|&squot;&bslash;0&squot;
comma
l_int|256
)paren
suffix:semicolon
id|diva_configure_protocol
(paren
id|IoAdapter
)paren
suffix:semicolon
multiline_comment|/*&n; * start adapter&n; */
id|boot-&gt;addr
op_assign
id|MP_UNCACHED_ADDR
(paren
id|MP_PROTOCOL_OFFSET
)paren
suffix:semicolon
id|boot-&gt;cmd
op_assign
l_int|3
suffix:semicolon
multiline_comment|/*&n; * wait for signature in shared memory (max. 3 seconds)&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|300
suffix:semicolon
op_increment
id|i
)paren
(brace
id|diva_os_wait
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|boot-&gt;signature
op_rshift
l_int|16
)paren
op_eq
l_int|0x4447
)paren
(brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Protocol startup time %d.%02d seconds&quot;
comma
(paren
id|i
op_div
l_int|100
)paren
comma
(paren
id|i
op_mod
l_int|100
)paren
)paren
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: Adapter selftest failed (0x%04X)!&quot;
comma
id|IoAdapter-&gt;Properties.Name
comma
id|boot-&gt;signature
op_rshift
l_int|16
)paren
)paren
id|pri_cpu_trapped
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#else /* } { */
DECL|function|load_pri_hardware
r_static
r_int
id|load_pri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif /* } */
multiline_comment|/* --------------------------------------------------------------------------&n;  PRI Adapter interrupt Service Routine&n;   -------------------------------------------------------------------------- */
DECL|function|pri_ISR
r_static
r_int
id|pri_ISR
(paren
r_struct
id|_ISDN_ADAPTER
op_star
id|IoAdapter
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|READ_DWORD
c_func
(paren
(paren
id|dword
op_star
)paren
id|IoAdapter-&gt;cfg
)paren
)paren
op_amp
l_int|0x80000000
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;  clear interrupt line&n;  */
id|WRITE_DWORD
c_func
(paren
(paren
(paren
id|dword
op_star
)paren
id|IoAdapter-&gt;cfg
)paren
comma
(paren
id|dword
)paren
op_complement
l_int|0x03E00000
)paren
suffix:semicolon
id|IoAdapter-&gt;IrqCount
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;Initialized
)paren
(brace
id|diva_os_schedule_soft_isr
(paren
op_amp
id|IoAdapter-&gt;isr_soft_isr
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Disable interrupt in the card hardware&n;  ------------------------------------------------------------------------- */
DECL|function|disable_pri_interrupt
r_static
r_void
id|disable_pri_interrupt
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
r_volatile
op_star
id|cfgReg
op_assign
(paren
id|dword
r_volatile
op_star
)paren
id|IoAdapter-&gt;cfg
suffix:semicolon
id|cfgReg
(braket
l_int|3
)braket
op_assign
l_int|0x00000000
suffix:semicolon
id|cfgReg
(braket
l_int|1
)braket
op_assign
l_int|0x00000000
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
op_amp
id|cfgReg
(braket
l_int|0
)braket
comma
(paren
id|dword
)paren
(paren
op_complement
l_int|0x03E00000
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Install entry points for PRI Adapter&n;  ------------------------------------------------------------------------- */
DECL|function|prepare_common_pri_functions
r_static
r_void
id|prepare_common_pri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|ADAPTER
op_star
id|a
op_assign
op_amp
id|IoAdapter-&gt;a
suffix:semicolon
id|a-&gt;ram_in
op_assign
id|mem_in
suffix:semicolon
id|a-&gt;ram_inw
op_assign
id|mem_inw
suffix:semicolon
id|a-&gt;ram_in_buffer
op_assign
id|mem_in_buffer
suffix:semicolon
id|a-&gt;ram_look_ahead
op_assign
id|mem_look_ahead
suffix:semicolon
id|a-&gt;ram_out
op_assign
id|mem_out
suffix:semicolon
id|a-&gt;ram_outw
op_assign
id|mem_outw
suffix:semicolon
id|a-&gt;ram_out_buffer
op_assign
id|mem_out_buffer
suffix:semicolon
id|a-&gt;ram_inc
op_assign
id|mem_inc
suffix:semicolon
id|a-&gt;ram_offset
op_assign
id|pri_ram_offset
suffix:semicolon
id|a-&gt;ram_out_dw
op_assign
id|mem_out_dw
suffix:semicolon
id|a-&gt;ram_in_dw
op_assign
id|mem_in_dw
suffix:semicolon
id|a-&gt;istream_wakeup
op_assign
id|pr_stream
suffix:semicolon
id|IoAdapter-&gt;out
op_assign
id|pr_out
suffix:semicolon
id|IoAdapter-&gt;dpc
op_assign
id|pr_dpc
suffix:semicolon
id|IoAdapter-&gt;tst_irq
op_assign
id|scom_test_int
suffix:semicolon
id|IoAdapter-&gt;clr_irq
op_assign
id|scom_clear_int
suffix:semicolon
id|IoAdapter-&gt;pcm
op_assign
(paren
r_struct
id|pc_maint
op_star
)paren
(paren
id|MIPS_MAINT_OFFS
op_minus
id|MP_SHARED_RAM_OFFSET
)paren
suffix:semicolon
id|IoAdapter-&gt;load
op_assign
id|load_pri_hardware
suffix:semicolon
id|IoAdapter-&gt;disIrq
op_assign
id|disable_pri_interrupt
suffix:semicolon
id|IoAdapter-&gt;rstFnc
op_assign
id|reset_pri_hardware
suffix:semicolon
id|IoAdapter-&gt;stop
op_assign
id|stop_pri_hardware
suffix:semicolon
id|IoAdapter-&gt;trapFnc
op_assign
id|pri_cpu_trapped
suffix:semicolon
id|IoAdapter-&gt;diva_isr_handler
op_assign
id|pri_ISR
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Install entry points for PRI Adapter&n;  ------------------------------------------------------------------------- */
DECL|function|prepare_pri_functions
r_void
id|prepare_pri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|IoAdapter-&gt;MemorySize
op_assign
id|MP_MEMORY_SIZE
suffix:semicolon
id|prepare_common_pri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
id|diva_os_prepare_pri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Install entry points for PRI Rev.2 Adapter&n;  ------------------------------------------------------------------------- */
DECL|function|prepare_pri2_functions
r_void
id|prepare_pri2_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|IoAdapter-&gt;MemorySize
op_assign
id|MP2_MEMORY_SIZE
suffix:semicolon
id|prepare_common_pri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
id|diva_os_prepare_pri2_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------- */
eof
