multiline_comment|/* $Id: um_idi.c,v 1.14 2004/03/21 17:54:37 armin Exp $ */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;di_defs.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;dqueue.h&quot;
macro_line|#include &quot;adapter.h&quot;
macro_line|#include &quot;entity.h&quot;
macro_line|#include &quot;um_xdi.h&quot;
macro_line|#include &quot;um_idi.h&quot;
macro_line|#include &quot;debuglib.h&quot;
macro_line|#include &quot;divasync.h&quot;
DECL|macro|DIVAS_MAX_XDI_ADAPTERS
mdefine_line|#define DIVAS_MAX_XDI_ADAPTERS&t;64
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;IMPORTS&n;   -------------------------------------------------------------------------- */
r_extern
r_void
id|diva_os_wakeup_read
c_func
(paren
r_void
op_star
id|os_context
)paren
suffix:semicolon
r_extern
r_void
id|diva_os_wakeup_close
c_func
(paren
r_void
op_star
id|os_context
)paren
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;LOCALS&n;   -------------------------------------------------------------------------- */
r_static
id|LIST_HEAD
c_func
(paren
id|adapter_q
)paren
suffix:semicolon
DECL|variable|adapter_lock
r_static
id|diva_os_spin_lock_t
id|adapter_lock
suffix:semicolon
r_static
id|diva_um_idi_adapter_t
op_star
id|diva_um_idi_find_adapter
c_func
(paren
id|dword
id|nr
)paren
suffix:semicolon
r_static
r_void
id|cleanup_adapter
c_func
(paren
id|diva_um_idi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_static
r_void
id|cleanup_entity
c_func
(paren
id|divas_um_idi_entity_t
op_star
id|e
)paren
suffix:semicolon
r_static
r_int
id|diva_user_mode_idi_adapter_features
c_func
(paren
id|diva_um_idi_adapter_t
op_star
id|a
comma
id|diva_um_idi_adapter_features_t
op_star
id|features
)paren
suffix:semicolon
r_static
r_int
id|process_idi_request
c_func
(paren
id|divas_um_idi_entity_t
op_star
id|e
comma
r_const
id|diva_um_idi_req_hdr_t
op_star
id|req
)paren
suffix:semicolon
r_static
r_int
id|process_idi_rc
c_func
(paren
id|divas_um_idi_entity_t
op_star
id|e
comma
id|byte
id|rc
)paren
suffix:semicolon
r_static
r_int
id|process_idi_ind
c_func
(paren
id|divas_um_idi_entity_t
op_star
id|e
comma
id|byte
id|ind
)paren
suffix:semicolon
r_static
r_int
id|write_return_code
c_func
(paren
id|divas_um_idi_entity_t
op_star
id|e
comma
id|byte
id|rc
)paren
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;MAIN&n;   -------------------------------------------------------------------------- */
DECL|function|diva_user_mode_idi_init
r_int
id|diva_user_mode_idi_init
c_func
(paren
r_void
)paren
(brace
id|diva_os_initialize_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
l_string|&quot;adapter&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Copy adapter features to user supplied buffer&n;   -------------------------------------------------------------------------- */
r_static
r_int
DECL|function|diva_user_mode_idi_adapter_features
id|diva_user_mode_idi_adapter_features
c_func
(paren
id|diva_um_idi_adapter_t
op_star
id|a
comma
id|diva_um_idi_adapter_features_t
op_star
id|features
)paren
(brace
id|IDI_SYNC_REQ
id|sync_req
suffix:semicolon
r_if
c_cond
(paren
(paren
id|a
)paren
op_logical_and
(paren
id|a-&gt;d.request
)paren
)paren
(brace
id|features-&gt;type
op_assign
id|a-&gt;d.type
suffix:semicolon
id|features-&gt;features
op_assign
id|a-&gt;d.features
suffix:semicolon
id|features-&gt;channels
op_assign
id|a-&gt;d.channels
suffix:semicolon
id|memset
c_func
(paren
id|features-&gt;name
comma
l_int|0
comma
r_sizeof
(paren
id|features-&gt;name
)paren
)paren
suffix:semicolon
id|sync_req.GetName.Req
op_assign
l_int|0
suffix:semicolon
id|sync_req.GetName.Rc
op_assign
id|IDI_SYNC_REQ_GET_NAME
suffix:semicolon
(paren
op_star
(paren
id|a-&gt;d.request
)paren
)paren
(paren
(paren
id|ENTITY
op_star
)paren
op_amp
id|sync_req
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|features-&gt;name
comma
id|sync_req.GetName.name
comma
r_sizeof
(paren
id|features-&gt;name
)paren
)paren
suffix:semicolon
id|sync_req.GetSerial.Req
op_assign
l_int|0
suffix:semicolon
id|sync_req.GetSerial.Rc
op_assign
id|IDI_SYNC_REQ_GET_SERIAL
suffix:semicolon
id|sync_req.GetSerial.serial
op_assign
l_int|0
suffix:semicolon
(paren
op_star
(paren
id|a-&gt;d.request
)paren
)paren
(paren
(paren
id|ENTITY
op_star
)paren
op_amp
id|sync_req
)paren
suffix:semicolon
id|features-&gt;serial_number
op_assign
id|sync_req.GetSerial.serial
suffix:semicolon
)brace
r_return
(paren
(paren
id|a
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;REMOVE ADAPTER&n;   -------------------------------------------------------------------------- */
DECL|function|diva_user_mode_idi_remove_adapter
r_void
id|diva_user_mode_idi_remove_adapter
c_func
(paren
r_int
id|adapter_nr
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
id|diva_um_idi_adapter_t
op_star
id|a
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|adapter_q
)paren
(brace
id|a
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
id|diva_um_idi_adapter_t
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;adapter_nr
op_eq
id|adapter_nr
)paren
(brace
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;DIDD: del adapter(%d)&quot;
comma
id|a-&gt;adapter_nr
)paren
)paren
suffix:semicolon
id|diva_os_free
c_func
(paren
l_int|0
comma
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;CALLED ON DRIVER EXIT (UNLOAD)&n;   -------------------------------------------------------------------------- */
DECL|function|diva_user_mode_idi_finit
r_void
id|diva_user_mode_idi_finit
c_func
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|safe
suffix:semicolon
id|diva_um_idi_adapter_t
op_star
id|a
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|safe
comma
op_amp
id|adapter_q
)paren
(brace
id|a
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
id|diva_um_idi_adapter_t
comma
id|link
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;DIDD: del adapter(%d)&quot;
comma
id|a-&gt;adapter_nr
)paren
)paren
suffix:semicolon
id|diva_os_free
c_func
(paren
l_int|0
comma
id|a
)paren
suffix:semicolon
)brace
id|diva_os_destroy_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
l_string|&quot;adapter&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;&t;&t;CREATE AND INIT IDI ADAPTER&n;&t; ------------------------------------------------------------------------- */
DECL|function|diva_user_mode_idi_create_adapter
r_int
id|diva_user_mode_idi_create_adapter
c_func
(paren
r_const
id|DESCRIPTOR
op_star
id|d
comma
r_int
id|adapter_nr
)paren
(brace
id|diva_os_spin_lock_magic_t
id|old_irql
suffix:semicolon
id|diva_um_idi_adapter_t
op_star
id|a
op_assign
(paren
id|diva_um_idi_adapter_t
op_star
)paren
id|diva_os_malloc
c_func
(paren
l_int|0
comma
r_sizeof
(paren
id|diva_um_idi_adapter_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|a
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|a
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|a-&gt;entity_q
)paren
suffix:semicolon
id|a-&gt;d
op_assign
op_star
id|d
suffix:semicolon
id|a-&gt;adapter_nr
op_assign
id|adapter_nr
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;DIDD_ADD A(%d), type:%02x, features:%04x, channels:%d&quot;
comma
id|adapter_nr
comma
id|a-&gt;d.type
comma
id|a-&gt;d.features
comma
id|a-&gt;d.channels
)paren
)paren
suffix:semicolon
id|diva_os_enter_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;create_adapter&quot;
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|a-&gt;link
comma
op_amp
id|adapter_q
)paren
suffix:semicolon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;create_adapter&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------&n;&t;&t;&t;Find adapter by Adapter number&n;   ------------------------------------------------------------------------ */
DECL|function|diva_um_idi_find_adapter
r_static
id|diva_um_idi_adapter_t
op_star
id|diva_um_idi_find_adapter
c_func
(paren
id|dword
id|nr
)paren
(brace
id|diva_um_idi_adapter_t
op_star
id|a
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|adapter_q
)paren
(brace
id|a
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
id|diva_um_idi_adapter_t
comma
id|link
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;find_adapter: (%d)-(%d)&quot;
comma
id|nr
comma
id|a-&gt;adapter_nr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;adapter_nr
op_eq
(paren
r_int
)paren
id|nr
)paren
r_break
suffix:semicolon
id|a
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|a
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------&n;&t;&t;Cleanup this adapter and cleanup/delete all entities assigned&n;&t;&t;to this adapter&n;   ------------------------------------------------------------------------ */
DECL|function|cleanup_adapter
r_static
r_void
id|cleanup_adapter
c_func
(paren
id|diva_um_idi_adapter_t
op_star
id|a
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|safe
suffix:semicolon
id|divas_um_idi_entity_t
op_star
id|e
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|safe
comma
op_amp
id|a-&gt;entity_q
)paren
(brace
id|e
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
id|divas_um_idi_entity_t
comma
id|link
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|cleanup_entity
c_func
(paren
id|e
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;os_context
)paren
(brace
id|diva_os_wakeup_read
c_func
(paren
id|e-&gt;os_context
)paren
suffix:semicolon
id|diva_os_wakeup_close
c_func
(paren
id|e-&gt;os_context
)paren
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
op_amp
id|a-&gt;d
comma
l_int|0x00
comma
r_sizeof
(paren
id|DESCRIPTOR
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------&n;&t;&t;Cleanup, but NOT delete this entity&n;   ------------------------------------------------------------------------ */
DECL|function|cleanup_entity
r_static
r_void
id|cleanup_entity
c_func
(paren
id|divas_um_idi_entity_t
op_star
id|e
)paren
(brace
id|e-&gt;os_ref
op_assign
l_int|0
suffix:semicolon
id|e-&gt;status
op_assign
l_int|0
suffix:semicolon
id|e-&gt;adapter
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.Id
op_assign
l_int|0
suffix:semicolon
id|e-&gt;rc_count
op_assign
l_int|0
suffix:semicolon
id|e-&gt;status
op_or_assign
id|DIVA_UM_IDI_REMOVED
suffix:semicolon
id|e-&gt;status
op_or_assign
id|DIVA_UM_IDI_REMOVE_PENDING
suffix:semicolon
id|diva_data_q_finit
c_func
(paren
op_amp
id|e-&gt;data
)paren
suffix:semicolon
id|diva_data_q_finit
c_func
(paren
op_amp
id|e-&gt;rc
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------&n;&t;&t;Create ENTITY, link it to the adapter and remove pointer to entity&n;   ------------------------------------------------------------------------ */
DECL|function|divas_um_idi_create_entity
r_void
op_star
id|divas_um_idi_create_entity
c_func
(paren
id|dword
id|adapter_nr
comma
r_void
op_star
id|file
)paren
(brace
id|divas_um_idi_entity_t
op_star
id|e
suffix:semicolon
id|diva_um_idi_adapter_t
op_star
id|a
suffix:semicolon
id|diva_os_spin_lock_magic_t
id|old_irql
suffix:semicolon
r_if
c_cond
(paren
(paren
id|e
op_assign
(paren
id|divas_um_idi_entity_t
op_star
)paren
id|diva_os_malloc
c_func
(paren
l_int|0
comma
r_sizeof
(paren
op_star
id|e
)paren
)paren
)paren
)paren
(brace
id|memset
c_func
(paren
id|e
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|e
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|e-&gt;os_context
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|diva_os_get_context_size
c_func
(paren
)paren
)paren
)paren
)paren
(brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;E(%08x) no memory for os context&quot;
comma
id|e
)paren
)paren
suffix:semicolon
id|diva_os_free
c_func
(paren
l_int|0
comma
id|e
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|e-&gt;os_context
comma
l_int|0x00
comma
id|diva_os_get_context_size
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|diva_data_q_init
c_func
(paren
op_amp
id|e-&gt;data
comma
l_int|2048
op_plus
l_int|512
comma
l_int|16
)paren
)paren
)paren
(brace
id|diva_os_free
c_func
(paren
l_int|0
comma
id|e-&gt;os_context
)paren
suffix:semicolon
id|diva_os_free
c_func
(paren
l_int|0
comma
id|e
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|diva_data_q_init
c_func
(paren
op_amp
id|e-&gt;rc
comma
r_sizeof
(paren
id|diva_um_idi_ind_hdr_t
)paren
comma
l_int|2
)paren
)paren
)paren
(brace
id|diva_data_q_finit
c_func
(paren
op_amp
id|e-&gt;data
)paren
suffix:semicolon
id|diva_os_free
c_func
(paren
l_int|0
comma
id|e-&gt;os_context
)paren
suffix:semicolon
id|diva_os_free
c_func
(paren
l_int|0
comma
id|e
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|diva_os_enter_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;create_entity&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;   Look for Adapter requested&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|a
op_assign
id|diva_um_idi_find_adapter
c_func
(paren
id|adapter_nr
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;   No adapter was found, or this adapter was removed&n;&t;&t;&t; */
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;create_entity&quot;
)paren
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;A: no adapter(%ld)&quot;
comma
id|adapter_nr
)paren
)paren
suffix:semicolon
id|cleanup_entity
c_func
(paren
id|e
)paren
suffix:semicolon
id|diva_os_free
c_func
(paren
l_int|0
comma
id|e-&gt;os_context
)paren
suffix:semicolon
id|diva_os_free
c_func
(paren
l_int|0
comma
id|e
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|e-&gt;os_ref
op_assign
id|file
suffix:semicolon
multiline_comment|/* link to os handle */
id|e-&gt;adapter
op_assign
id|a
suffix:semicolon
multiline_comment|/* link to adapter   */
id|list_add_tail
c_func
(paren
op_amp
id|e-&gt;link
comma
op_amp
id|a-&gt;entity_q
)paren
suffix:semicolon
multiline_comment|/* link from adapter */
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;create_entity&quot;
)paren
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;A(%ld), create E(%08x)&quot;
comma
id|adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|e
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------&n;&t;&t;Unlink entity and free memory &n;   ------------------------------------------------------------------------ */
DECL|function|divas_um_idi_delete_entity
r_int
id|divas_um_idi_delete_entity
c_func
(paren
r_int
id|adapter_nr
comma
r_void
op_star
id|entity
)paren
(brace
id|divas_um_idi_entity_t
op_star
id|e
suffix:semicolon
id|diva_um_idi_adapter_t
op_star
id|a
suffix:semicolon
id|diva_os_spin_lock_magic_t
id|old_irql
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|e
op_assign
(paren
id|divas_um_idi_entity_t
op_star
)paren
id|entity
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|diva_os_enter_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;delete_entity&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|a
op_assign
id|e-&gt;adapter
)paren
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|e-&gt;link
)paren
suffix:semicolon
)brace
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;delete_entity&quot;
)paren
suffix:semicolon
id|diva_um_idi_stop_wdog
c_func
(paren
id|entity
)paren
suffix:semicolon
id|cleanup_entity
c_func
(paren
id|e
)paren
suffix:semicolon
id|diva_os_free
c_func
(paren
l_int|0
comma
id|e-&gt;os_context
)paren
suffix:semicolon
id|memset
c_func
(paren
id|e
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|e
)paren
)paren
suffix:semicolon
id|diva_os_free
c_func
(paren
l_int|0
comma
id|e
)paren
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;A(%d) remove E:%08x&quot;
comma
id|adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Called by application to read data from IDI&n;&t; -------------------------------------------------------------------------- */
DECL|function|diva_um_idi_read
r_int
id|diva_um_idi_read
c_func
(paren
r_void
op_star
id|entity
comma
r_void
op_star
id|os_handle
comma
r_void
op_star
id|dst
comma
r_int
id|max_length
comma
id|divas_um_idi_copy_to_user_fn_t
id|cp_fn
)paren
(brace
id|divas_um_idi_entity_t
op_star
id|e
suffix:semicolon
id|diva_um_idi_adapter_t
op_star
id|a
suffix:semicolon
r_const
r_void
op_star
id|data
suffix:semicolon
r_int
id|length
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|diva_um_idi_data_queue_t
op_star
id|q
suffix:semicolon
id|diva_os_spin_lock_magic_t
id|old_irql
suffix:semicolon
id|diva_os_enter_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;read&quot;
)paren
suffix:semicolon
id|e
op_assign
(paren
id|divas_um_idi_entity_t
op_star
)paren
id|entity
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e
op_logical_or
(paren
op_logical_neg
(paren
id|a
op_assign
id|e-&gt;adapter
)paren
)paren
op_logical_or
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_REMOVE_PENDING
)paren
op_logical_or
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_REMOVED
)paren
op_logical_or
(paren
id|a-&gt;status
op_amp
id|DIVA_UM_IDI_ADAPTER_REMOVED
)paren
)paren
(brace
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;read&quot;
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;E(%08x) read failed - adapter removed&quot;
comma
id|e
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) read(%d)&quot;
comma
id|a-&gt;adapter_nr
comma
id|e
comma
id|max_length
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Try to read return code first&n;&t; */
id|data
op_assign
id|diva_data_q_get_segment4read
c_func
(paren
op_amp
id|e-&gt;rc
)paren
suffix:semicolon
id|q
op_assign
op_amp
id|e-&gt;rc
suffix:semicolon
multiline_comment|/*&n;&t;   No return codes available, read indications now&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_RC_PENDING
)paren
)paren
(brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) read data&quot;
comma
id|a-&gt;adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
id|data
op_assign
id|diva_data_q_get_segment4read
c_func
(paren
op_amp
id|e-&gt;data
)paren
suffix:semicolon
id|q
op_assign
op_amp
id|e-&gt;data
suffix:semicolon
)brace
)brace
r_else
(brace
id|e-&gt;status
op_and_assign
op_complement
id|DIVA_UM_IDI_RC_PENDING
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) read rc&quot;
comma
id|a-&gt;adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data
)paren
(brace
r_if
c_cond
(paren
(paren
id|length
op_assign
id|diva_data_q_get_segment_length
c_func
(paren
id|q
)paren
)paren
OG
id|max_length
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;   Not enough space to read message&n;&t;&t;&t; */
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) E(%08x) read small buffer&quot;
comma
id|a-&gt;adapter_nr
comma
id|e
comma
id|ret
)paren
)paren
suffix:semicolon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;read&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;   Copy it to user, this function does access ONLY locked an verified&n;&t;&t;   memory, also we can access it witch spin lock held&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_assign
(paren
op_star
id|cp_fn
)paren
(paren
id|os_handle
comma
id|dst
comma
id|data
comma
id|length
)paren
)paren
op_ge
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;   Acknowledge only if read was successfull&n;&t;&t;&t; */
id|diva_data_q_ack_segment4read
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
)brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) read=%d&quot;
comma
id|a-&gt;adapter_nr
comma
id|e
comma
id|ret
)paren
)paren
suffix:semicolon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;read&quot;
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|function|diva_um_idi_write
r_int
id|diva_um_idi_write
c_func
(paren
r_void
op_star
id|entity
comma
r_void
op_star
id|os_handle
comma
r_const
r_void
op_star
id|src
comma
r_int
id|length
comma
id|divas_um_idi_copy_from_user_fn_t
id|cp_fn
)paren
(brace
id|divas_um_idi_entity_t
op_star
id|e
suffix:semicolon
id|diva_um_idi_adapter_t
op_star
id|a
suffix:semicolon
id|diva_um_idi_req_hdr_t
op_star
id|req
suffix:semicolon
r_void
op_star
id|data
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|diva_os_spin_lock_magic_t
id|old_irql
suffix:semicolon
id|diva_os_enter_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;write&quot;
)paren
suffix:semicolon
id|e
op_assign
(paren
id|divas_um_idi_entity_t
op_star
)paren
id|entity
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e
op_logical_or
(paren
op_logical_neg
(paren
id|a
op_assign
id|e-&gt;adapter
)paren
)paren
op_logical_or
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_REMOVE_PENDING
)paren
op_logical_or
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_REMOVED
)paren
op_logical_or
(paren
id|a-&gt;status
op_amp
id|DIVA_UM_IDI_ADAPTER_REMOVED
)paren
)paren
(brace
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;write&quot;
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;E(%08x) write failed - adapter removed&quot;
comma
id|e
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) write(%d)&quot;
comma
id|a-&gt;adapter_nr
comma
id|e
comma
id|length
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|length
OL
r_sizeof
(paren
op_star
id|req
)paren
)paren
op_logical_or
(paren
id|length
OG
r_sizeof
(paren
id|e-&gt;buffer
)paren
)paren
)paren
(brace
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;write&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_RC_PENDING
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) E(%08x) rc pending&quot;
comma
id|a-&gt;adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;write&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* should wait for RC code first */
)brace
multiline_comment|/*&n;&t;   Copy function does access only locked verified memory,&n;&t;   also it can be called with spin lock held&n;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_assign
(paren
op_star
id|cp_fn
)paren
(paren
id|os_handle
comma
id|e-&gt;buffer
comma
id|src
comma
id|length
)paren
)paren
OL
l_int|0
)paren
(brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A: A(%d) E(%08x) write error=%d&quot;
comma
id|a-&gt;adapter_nr
comma
id|e
comma
id|ret
)paren
)paren
suffix:semicolon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;write&quot;
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
id|req
op_assign
(paren
id|diva_um_idi_req_hdr_t
op_star
)paren
op_amp
id|e-&gt;buffer
(braket
l_int|0
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|req-&gt;type
)paren
(brace
r_case
id|DIVA_UM_IDI_GET_FEATURES
suffix:colon
(brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;A(%d) get_features&quot;
comma
id|a-&gt;adapter_nr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|data
op_assign
id|diva_data_q_get_segment4write
c_func
(paren
op_amp
id|e-&gt;data
)paren
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A(%d) get_features, no free buffer&quot;
comma
id|a-&gt;adapter_nr
)paren
)paren
suffix:semicolon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;write&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|diva_user_mode_idi_adapter_features
c_func
(paren
id|a
comma
op_amp
(paren
(paren
(paren
id|diva_um_idi_ind_hdr_t
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|hdr.features
)paren
)paren
suffix:semicolon
(paren
(paren
id|diva_um_idi_ind_hdr_t
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|type
op_assign
id|DIVA_UM_IDI_IND_FEATURES
suffix:semicolon
(paren
(paren
id|diva_um_idi_ind_hdr_t
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|data_length
op_assign
l_int|0
suffix:semicolon
id|diva_data_q_ack_segment4write
c_func
(paren
op_amp
id|e-&gt;data
comma
r_sizeof
(paren
id|diva_um_idi_ind_hdr_t
)paren
)paren
suffix:semicolon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;write&quot;
)paren
suffix:semicolon
id|diva_os_wakeup_read
c_func
(paren
id|e-&gt;os_context
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_UM_IDI_REQ
suffix:colon
r_case
id|DIVA_UM_IDI_REQ_MAN
suffix:colon
r_case
id|DIVA_UM_IDI_REQ_SIG
suffix:colon
r_case
id|DIVA_UM_IDI_REQ_NET
suffix:colon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) REQ(%02d)-(%02d)-(%08x)&quot;
comma
id|a-&gt;adapter_nr
comma
id|req-&gt;Req
comma
id|req-&gt;ReqCh
comma
id|req-&gt;type
op_amp
id|DIVA_UM_IDI_REQ_TYPE_MASK
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|process_idi_request
c_func
(paren
id|e
comma
id|req
)paren
)paren
(brace
r_case
op_minus
l_int|1
suffix:colon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;write&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_case
op_minus
l_int|2
suffix:colon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;write&quot;
)paren
suffix:semicolon
id|diva_os_wakeup_read
c_func
(paren
id|e-&gt;os_context
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;write&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;write&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) write=%d&quot;
comma
id|a-&gt;adapter_nr
comma
id|e
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;&t;CALLBACK FROM XDI&n;&t; -------------------------------------------------------------------------- */
DECL|function|diva_um_idi_xdi_callback
r_static
r_void
id|diva_um_idi_xdi_callback
c_func
(paren
id|ENTITY
op_star
id|entity
)paren
(brace
id|divas_um_idi_entity_t
op_star
id|e
op_assign
id|DIVAS_CONTAINING_RECORD
c_func
(paren
id|entity
comma
id|divas_um_idi_entity_t
comma
id|e
)paren
suffix:semicolon
id|diva_os_spin_lock_magic_t
id|old_irql
suffix:semicolon
r_int
id|call_wakeup
op_assign
l_int|0
suffix:semicolon
id|diva_os_enter_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;xdi_callback&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;e.complete
op_eq
l_int|255
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_REMOVE_PENDING
)paren
)paren
(brace
id|diva_um_idi_stop_wdog
c_func
(paren
id|e
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|call_wakeup
op_assign
id|process_idi_rc
c_func
(paren
id|e
comma
id|e-&gt;e.Rc
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|e-&gt;rc_count
)paren
(brace
id|e-&gt;rc_count
op_decrement
suffix:semicolon
)brace
)brace
id|e-&gt;e.Rc
op_assign
l_int|0
suffix:semicolon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;xdi_callback&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call_wakeup
)paren
(brace
id|diva_os_wakeup_read
c_func
(paren
id|e-&gt;os_context
)paren
suffix:semicolon
id|diva_os_wakeup_close
c_func
(paren
id|e-&gt;os_context
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_REMOVE_PENDING
)paren
(brace
id|e-&gt;e.RNum
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.RNR
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|call_wakeup
op_assign
id|process_idi_ind
c_func
(paren
id|e
comma
id|e-&gt;e.Ind
)paren
suffix:semicolon
)brace
id|e-&gt;e.Ind
op_assign
l_int|0
suffix:semicolon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;xdi_callback&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call_wakeup
)paren
(brace
id|diva_os_wakeup_read
c_func
(paren
id|e-&gt;os_context
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|process_idi_request
r_static
r_int
id|process_idi_request
c_func
(paren
id|divas_um_idi_entity_t
op_star
id|e
comma
r_const
id|diva_um_idi_req_hdr_t
op_star
id|req
)paren
(brace
r_int
id|assign
op_assign
l_int|0
suffix:semicolon
id|byte
id|Req
op_assign
(paren
id|byte
)paren
id|req-&gt;Req
suffix:semicolon
id|dword
id|type
op_assign
id|req-&gt;type
op_amp
id|DIVA_UM_IDI_REQ_TYPE_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e-&gt;e.Id
op_logical_or
op_logical_neg
id|e-&gt;e.callback
)paren
(brace
multiline_comment|/* not assigned */
r_if
c_cond
(paren
id|Req
op_ne
id|ASSIGN
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) E(%08x) not assigned&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* NOT ASSIGNED */
)brace
r_else
(brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|DIVA_UM_IDI_REQ_TYPE_MAN
suffix:colon
id|e-&gt;e.Id
op_assign
id|MAN_ID
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) assign MAN&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_UM_IDI_REQ_TYPE_SIG
suffix:colon
id|e-&gt;e.Id
op_assign
id|DSIG_ID
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) assign SIG&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_UM_IDI_REQ_TYPE_NET
suffix:colon
id|e-&gt;e.Id
op_assign
id|NL_ID
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) assign NET&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) E(%08x) unknown type=%08x&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
comma
id|type
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|e-&gt;e.XNum
op_assign
l_int|1
suffix:semicolon
id|e-&gt;e.RNum
op_assign
l_int|1
suffix:semicolon
id|e-&gt;e.callback
op_assign
id|diva_um_idi_xdi_callback
suffix:semicolon
id|e-&gt;e.X
op_assign
op_amp
id|e-&gt;XData
suffix:semicolon
id|e-&gt;e.R
op_assign
op_amp
id|e-&gt;RData
suffix:semicolon
id|assign
op_assign
l_int|1
suffix:semicolon
)brace
id|e-&gt;status
op_or_assign
id|DIVA_UM_IDI_RC_PENDING
suffix:semicolon
id|e-&gt;e.Req
op_assign
id|Req
suffix:semicolon
id|e-&gt;e.ReqCh
op_assign
(paren
id|byte
)paren
id|req-&gt;ReqCh
suffix:semicolon
id|e-&gt;e.X-&gt;PLength
op_assign
(paren
id|word
)paren
id|req-&gt;data_length
suffix:semicolon
id|e-&gt;e.X-&gt;P
op_assign
(paren
id|byte
op_star
)paren
op_amp
id|req
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Our buffer is safe */
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) request(%02x-%02x-%02x (%d))&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
comma
id|e-&gt;e.Id
comma
id|e-&gt;e.Req
comma
id|e-&gt;e.ReqCh
comma
id|e-&gt;e.X-&gt;PLength
)paren
)paren
suffix:semicolon
id|e-&gt;rc_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;adapter
op_logical_and
id|e-&gt;adapter-&gt;d.request
)paren
(brace
id|diva_um_idi_start_wdog
c_func
(paren
id|e
)paren
suffix:semicolon
(paren
op_star
(paren
id|e-&gt;adapter-&gt;d.request
)paren
)paren
(paren
op_amp
id|e-&gt;e
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|assign
)paren
(brace
r_if
c_cond
(paren
id|e-&gt;e.Rc
op_eq
id|OUT_OF_RESOURCES
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;   XDI has no entities more, call was not forwarded to the card,&n;&t;&t;&t;   no callback will be scheduled&n;&t;&t;&t; */
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) E(%08x) XDI out of entities&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
id|e-&gt;e.Id
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.ReqCh
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.RcCh
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.Ind
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.IndCh
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.XNum
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.RNum
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.callback
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.X
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.R
op_assign
l_int|0
suffix:semicolon
id|write_return_code
c_func
(paren
id|e
comma
id|ASSIGN_RC
op_or
id|OUT_OF_RESOURCES
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|e-&gt;status
op_or_assign
id|DIVA_UM_IDI_ASSIGN_PENDING
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|process_idi_rc
r_static
r_int
id|process_idi_rc
c_func
(paren
id|divas_um_idi_entity_t
op_star
id|e
comma
id|byte
id|rc
)paren
(brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) rc(%02x-%02x-%02x)&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
comma
id|e-&gt;e.Id
comma
id|rc
comma
id|e-&gt;e.RcCh
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_ASSIGN_PENDING
)paren
(brace
id|e-&gt;status
op_and_assign
op_complement
id|DIVA_UM_IDI_ASSIGN_PENDING
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|ASSIGN_OK
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) E(%08x) ASSIGN failed&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
id|e-&gt;e.callback
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.Id
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.Req
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.ReqCh
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.Rc
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.RcCh
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.Ind
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.IndCh
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.X
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.R
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.XNum
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.RNum
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|e-&gt;e.Req
op_eq
id|REMOVE
)paren
op_logical_and
id|e-&gt;e.Id
op_logical_and
(paren
id|rc
op_eq
l_int|0xff
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) E(%08x)  discard OK in REMOVE&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* let us do it in the driver */
)brace
r_if
c_cond
(paren
(paren
id|e-&gt;e.Req
op_eq
id|REMOVE
)paren
op_logical_and
(paren
op_logical_neg
id|e-&gt;e.Id
)paren
)paren
(brace
multiline_comment|/* REMOVE COMPLETE */
id|e-&gt;e.callback
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.Id
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.Req
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.ReqCh
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.Rc
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.RcCh
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.Ind
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.IndCh
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.X
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.R
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.XNum
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.RNum
op_assign
l_int|0
suffix:semicolon
id|e-&gt;rc_count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|e-&gt;e.Req
op_eq
id|REMOVE
)paren
op_logical_and
(paren
id|rc
op_ne
l_int|0xff
)paren
)paren
(brace
multiline_comment|/* REMOVE FAILED */
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) E(%08x)  REMOVE FAILED&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
)paren
)paren
suffix:semicolon
)brace
id|write_return_code
c_func
(paren
id|e
comma
id|rc
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|process_idi_ind
r_static
r_int
id|process_idi_ind
c_func
(paren
id|divas_um_idi_entity_t
op_star
id|e
comma
id|byte
id|ind
)paren
(brace
r_int
id|do_wakeup
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;e.complete
op_ne
l_int|0x02
)paren
(brace
id|diva_um_idi_ind_hdr_t
op_star
id|pind
op_assign
(paren
id|diva_um_idi_ind_hdr_t
op_star
)paren
id|diva_data_q_get_segment4write
c_func
(paren
op_amp
id|e-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pind
)paren
(brace
id|e-&gt;e.RNum
op_assign
l_int|1
suffix:semicolon
id|e-&gt;e.R-&gt;P
op_assign
(paren
id|byte
op_star
)paren
op_amp
id|pind
(braket
l_int|1
)braket
suffix:semicolon
id|e-&gt;e.R-&gt;PLength
op_assign
(paren
id|word
)paren
(paren
id|diva_data_q_get_max_length
c_func
(paren
op_amp
id|e-&gt;data
)paren
op_minus
r_sizeof
(paren
op_star
id|pind
)paren
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) ind_1(%02x-%02x-%02x)-[%d-%d]&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
comma
id|e-&gt;e.Id
comma
id|ind
comma
id|e-&gt;e.IndCh
comma
id|e-&gt;e.RLength
comma
id|e-&gt;e.R-&gt;PLength
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) ind(%02x-%02x-%02x)-RNR&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
comma
id|e-&gt;e.Id
comma
id|ind
comma
id|e-&gt;e.IndCh
)paren
)paren
suffix:semicolon
id|e-&gt;e.RNum
op_assign
l_int|0
suffix:semicolon
id|e-&gt;e.RNR
op_assign
l_int|1
suffix:semicolon
id|do_wakeup
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|diva_um_idi_ind_hdr_t
op_star
id|pind
op_assign
(paren
id|diva_um_idi_ind_hdr_t
op_star
)paren
(paren
id|e-&gt;e.R-&gt;P
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) ind(%02x-%02x-%02x)-[%d]&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
comma
id|e-&gt;e.Id
comma
id|ind
comma
id|e-&gt;e.IndCh
comma
id|e-&gt;e.R-&gt;PLength
)paren
)paren
suffix:semicolon
id|pind
op_decrement
suffix:semicolon
id|pind-&gt;type
op_assign
id|DIVA_UM_IDI_IND
suffix:semicolon
id|pind-&gt;hdr.ind.Ind
op_assign
id|ind
suffix:semicolon
id|pind-&gt;hdr.ind.IndCh
op_assign
id|e-&gt;e.IndCh
suffix:semicolon
id|pind-&gt;data_length
op_assign
id|e-&gt;e.R-&gt;PLength
suffix:semicolon
id|diva_data_q_ack_segment4write
c_func
(paren
op_amp
id|e-&gt;data
comma
(paren
r_int
)paren
(paren
r_sizeof
(paren
op_star
id|pind
)paren
op_plus
id|e-&gt;e.R-&gt;PLength
)paren
)paren
suffix:semicolon
id|do_wakeup
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_RC_PENDING
)paren
op_logical_and
op_logical_neg
id|e-&gt;rc.count
)paren
(brace
id|do_wakeup
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
id|do_wakeup
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Write return code to the return code queue of entity&n;&t; -------------------------------------------------------------------------- */
DECL|function|write_return_code
r_static
r_int
id|write_return_code
c_func
(paren
id|divas_um_idi_entity_t
op_star
id|e
comma
id|byte
id|rc
)paren
(brace
id|diva_um_idi_ind_hdr_t
op_star
id|prc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|prc
op_assign
(paren
id|diva_um_idi_ind_hdr_t
op_star
)paren
id|diva_data_q_get_segment4write
c_func
(paren
op_amp
id|e-&gt;rc
)paren
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) E(%08x) rc(%02x) lost&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
comma
id|rc
)paren
)paren
suffix:semicolon
id|e-&gt;status
op_and_assign
op_complement
id|DIVA_UM_IDI_RC_PENDING
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|prc-&gt;type
op_assign
id|DIVA_UM_IDI_IND_RC
suffix:semicolon
id|prc-&gt;hdr.rc.Rc
op_assign
id|rc
suffix:semicolon
id|prc-&gt;hdr.rc.RcCh
op_assign
id|e-&gt;e.RcCh
suffix:semicolon
id|prc-&gt;data_length
op_assign
l_int|0
suffix:semicolon
id|diva_data_q_ack_segment4write
c_func
(paren
op_amp
id|e-&gt;rc
comma
r_sizeof
(paren
op_star
id|prc
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Return amount of entries that can be bead from this entity or&n;&t;&t;-1 if adapter was removed&n;&t; -------------------------------------------------------------------------- */
DECL|function|diva_user_mode_idi_ind_ready
r_int
id|diva_user_mode_idi_ind_ready
c_func
(paren
r_void
op_star
id|entity
comma
r_void
op_star
id|os_handle
)paren
(brace
id|divas_um_idi_entity_t
op_star
id|e
suffix:semicolon
id|diva_um_idi_adapter_t
op_star
id|a
suffix:semicolon
id|diva_os_spin_lock_magic_t
id|old_irql
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entity
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|diva_os_enter_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;ind_ready&quot;
)paren
suffix:semicolon
id|e
op_assign
(paren
id|divas_um_idi_entity_t
op_star
)paren
id|entity
suffix:semicolon
id|a
op_assign
id|e-&gt;adapter
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|a
)paren
op_logical_or
(paren
id|a-&gt;status
op_amp
id|DIVA_UM_IDI_ADAPTER_REMOVED
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;   Adapter was unloaded&n;&t;&t; */
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;ind_ready&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* adapter was removed */
)brace
r_if
c_cond
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_REMOVED
)paren
(brace
multiline_comment|/*&n;&t;&t;   entity was removed as result of adapter removal&n;&t;&t;   user should assign this entity again&n;&t;&t; */
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;ind_ready&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|e-&gt;rc.count
op_plus
id|e-&gt;data.count
suffix:semicolon
r_if
c_cond
(paren
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_RC_PENDING
)paren
op_logical_and
op_logical_neg
id|e-&gt;rc.count
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;ind_ready&quot;
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|function|diva_um_id_get_os_context
r_void
op_star
id|diva_um_id_get_os_context
c_func
(paren
r_void
op_star
id|entity
)paren
(brace
r_return
(paren
(paren
(paren
id|divas_um_idi_entity_t
op_star
)paren
id|entity
)paren
op_member_access_from_pointer
id|os_context
)paren
suffix:semicolon
)brace
DECL|function|divas_um_idi_entity_assigned
r_int
id|divas_um_idi_entity_assigned
c_func
(paren
r_void
op_star
id|entity
)paren
(brace
id|divas_um_idi_entity_t
op_star
id|e
suffix:semicolon
id|diva_um_idi_adapter_t
op_star
id|a
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|diva_os_spin_lock_magic_t
id|old_irql
suffix:semicolon
id|diva_os_enter_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;assigned?&quot;
)paren
suffix:semicolon
id|e
op_assign
(paren
id|divas_um_idi_entity_t
op_star
)paren
id|entity
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e
op_logical_or
(paren
op_logical_neg
(paren
id|a
op_assign
id|e-&gt;adapter
)paren
)paren
op_logical_or
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_REMOVED
)paren
op_logical_or
(paren
id|a-&gt;status
op_amp
id|DIVA_UM_IDI_ADAPTER_REMOVED
)paren
)paren
(brace
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;assigned?&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|e-&gt;status
op_or_assign
id|DIVA_UM_IDI_REMOVE_PENDING
suffix:semicolon
id|ret
op_assign
(paren
id|e-&gt;e.Id
op_logical_or
id|e-&gt;rc_count
op_logical_or
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_ASSIGN_PENDING
)paren
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Id:%02x, rc_count:%d, status:%08x&quot;
comma
id|e-&gt;e.Id
comma
id|e-&gt;rc_count
comma
id|e-&gt;status
)paren
)paren
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;assigned?&quot;
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|function|divas_um_idi_entity_start_remove
r_int
id|divas_um_idi_entity_start_remove
c_func
(paren
r_void
op_star
id|entity
)paren
(brace
id|divas_um_idi_entity_t
op_star
id|e
suffix:semicolon
id|diva_um_idi_adapter_t
op_star
id|a
suffix:semicolon
id|diva_os_spin_lock_magic_t
id|old_irql
suffix:semicolon
id|diva_os_enter_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;start_remove&quot;
)paren
suffix:semicolon
id|e
op_assign
(paren
id|divas_um_idi_entity_t
op_star
)paren
id|entity
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e
op_logical_or
(paren
op_logical_neg
(paren
id|a
op_assign
id|e-&gt;adapter
)paren
)paren
op_logical_or
(paren
id|e-&gt;status
op_amp
id|DIVA_UM_IDI_REMOVED
)paren
op_logical_or
(paren
id|a-&gt;status
op_amp
id|DIVA_UM_IDI_ADAPTER_REMOVED
)paren
)paren
(brace
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;start_remove&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|e-&gt;rc_count
)paren
(brace
multiline_comment|/*&n;&t;&t;   Entity BUSY&n;&t;&t; */
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;start_remove&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|e-&gt;e.Id
)paren
(brace
multiline_comment|/*&n;&t;&t;   Remove request was already pending, and arrived now&n;&t;&t; */
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;start_remove&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* REMOVE was pending */
)brace
multiline_comment|/*&n;&t;   Now send remove request&n;&t; */
id|e-&gt;e.Req
op_assign
id|REMOVE
suffix:semicolon
id|e-&gt;e.ReqCh
op_assign
l_int|0
suffix:semicolon
id|e-&gt;rc_count
op_increment
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;A(%d) E(%08x) request(%02x-%02x-%02x (%d))&quot;
comma
id|e-&gt;adapter-&gt;adapter_nr
comma
id|e
comma
id|e-&gt;e.Id
comma
id|e-&gt;e.Req
comma
id|e-&gt;e.ReqCh
comma
id|e-&gt;e.X-&gt;PLength
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;d.request
)paren
(paren
op_star
(paren
id|a-&gt;d.request
)paren
)paren
(paren
op_amp
id|e-&gt;e
)paren
suffix:semicolon
id|diva_os_leave_spin_lock
c_func
(paren
op_amp
id|adapter_lock
comma
op_amp
id|old_irql
comma
l_string|&quot;start_remove&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
eof
