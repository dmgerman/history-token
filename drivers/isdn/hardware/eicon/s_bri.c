multiline_comment|/*&n; *&n;  Copyright (c) Eicon Networks, 2002.&n; *&n;  This source file is supplied for the use with&n;  Eicon Networks range of DIVA Server Adapters.&n; *&n;  Eicon File Revision :    2.1&n; *&n;  This program is free software; you can redistribute it and/or modify&n;  it under the terms of the GNU General Public License as published by&n;  the Free Software Foundation; either version 2, or (at your option)&n;  any later version.&n; *&n;  This program is distributed in the hope that it will be useful,&n;  but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY&n;  implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n;  See the GNU General Public License for more details.&n; *&n;  You should have received a copy of the GNU General Public License&n;  along with this program; if not, write to the Free Software&n;  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;di_defs.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;di.h&quot;
macro_line|#include &quot;mi_pc.h&quot;
macro_line|#include &quot;pc_maint.h&quot;
macro_line|#include &quot;divasync.h&quot;
macro_line|#include &quot;io.h&quot;
macro_line|#include &quot;helpers.h&quot;
macro_line|#include &quot;dsrv_bri.h&quot;
macro_line|#include &quot;dsp_defs.h&quot;
multiline_comment|/*****************************************************************************/
DECL|macro|MAX_XLOG_SIZE
mdefine_line|#define MAX_XLOG_SIZE (64 * 1024)
multiline_comment|/* --------------------------------------------------------------------------&n;  Investigate card state, recovery trace buffer&n;  -------------------------------------------------------------------------- */
DECL|function|bri_cpu_trapped
r_static
r_void
id|bri_cpu_trapped
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
op_star
id|addrHi
comma
op_star
id|addrLo
comma
op_star
id|ioaddr
suffix:semicolon
id|word
op_star
id|Xlog
suffix:semicolon
id|dword
id|regs
(braket
l_int|4
)braket
comma
id|i
comma
id|size
suffix:semicolon
id|Xdesc
id|xlogDesc
suffix:semicolon
multiline_comment|/*&n; * first read pointers and trap frame&n; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|Xlog
op_assign
(paren
id|word
op_star
)paren
id|diva_os_malloc
(paren
l_int|0
comma
id|MAX_XLOG_SIZE
)paren
)paren
)paren
r_return
suffix:semicolon
id|addrHi
op_assign
id|IoAdapter-&gt;port
op_plus
(paren
(paren
id|IoAdapter-&gt;Properties.Bus
op_eq
id|BUS_PCI
)paren
ques
c_cond
id|M_PCI_ADDRH
suffix:colon
id|ADDRH
)paren
suffix:semicolon
id|addrLo
op_assign
id|IoAdapter-&gt;port
op_plus
id|ADDR
suffix:semicolon
id|ioaddr
op_assign
id|IoAdapter-&gt;port
op_plus
id|DATA
suffix:semicolon
id|outpp
(paren
id|addrHi
comma
l_int|0
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x100
suffix:semicolon
id|Xlog
(braket
id|i
op_increment
)braket
op_assign
id|inppw
c_func
(paren
id|ioaddr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * check for trapped MIPS 3xxx CPU, dump only exception frame&n; */
r_if
c_cond
(paren
id|READ_WORD
c_func
(paren
op_amp
id|Xlog
(braket
l_int|0x80
op_div
r_sizeof
(paren
id|Xlog
(braket
l_int|0
)braket
)paren
)braket
)paren
op_eq
l_int|0x99999999
)paren
(brace
id|dump_trap_frame
(paren
id|IoAdapter
comma
op_amp
(paren
(paren
id|byte
op_star
)paren
id|Xlog
)paren
(braket
l_int|0x90
)braket
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|1
suffix:semicolon
)brace
id|regs
(braket
l_int|0
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
(paren
(paren
id|byte
op_star
)paren
id|Xlog
)paren
(braket
l_int|0x70
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|1
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
(paren
(paren
id|byte
op_star
)paren
id|Xlog
)paren
(braket
l_int|0x74
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|2
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
(paren
(paren
id|byte
op_star
)paren
id|Xlog
)paren
(braket
l_int|0x78
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|3
)braket
op_assign
id|READ_DWORD
c_func
(paren
op_amp
(paren
(paren
id|byte
op_star
)paren
id|Xlog
)paren
(braket
l_int|0x7c
)braket
)paren
suffix:semicolon
id|outpp
(paren
id|addrHi
comma
(paren
id|regs
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x7F
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
id|regs
(braket
l_int|1
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|xlogDesc.cnt
op_assign
id|inppw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|outpp
(paren
id|addrHi
comma
(paren
id|regs
(braket
l_int|2
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x7F
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
id|regs
(braket
l_int|2
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|xlogDesc.out
op_assign
id|inppw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|xlogDesc.buf
op_assign
id|Xlog
suffix:semicolon
id|regs
(braket
l_int|0
)braket
op_and_assign
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|regs
(braket
l_int|0
)braket
OL
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)paren
(brace
id|size
op_assign
id|IoAdapter-&gt;MemorySize
op_minus
id|regs
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|MAX_XLOG_SIZE
)paren
id|size
op_assign
id|MAX_XLOG_SIZE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|size
op_div
r_sizeof
(paren
op_star
id|Xlog
)paren
)paren
suffix:semicolon
id|regs
(braket
l_int|0
)braket
op_add_assign
l_int|2
)paren
(brace
id|outpp
(paren
id|addrHi
comma
(paren
id|regs
(braket
l_int|0
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x7F
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
id|regs
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|Xlog
(braket
id|i
op_increment
)braket
op_assign
id|inppw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
)brace
id|dump_xlog_buffer
(paren
id|IoAdapter
comma
op_amp
id|xlogDesc
)paren
suffix:semicolon
id|diva_os_free
(paren
l_int|0
comma
id|Xlog
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|2
suffix:semicolon
)brace
id|outpp
(paren
id|addrHi
comma
(paren
id|byte
)paren
(paren
(paren
id|BRI_UNCACHED_ADDR
(paren
id|IoAdapter-&gt;MemoryBase
op_plus
id|IoAdapter-&gt;MemorySize
op_minus
id|BRI_SHARED_RAM_SIZE
)paren
)paren
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
l_int|0x00
)paren
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------&n;   Reset hardware&n;  --------------------------------------------------------------------- */
DECL|function|reset_bri_hardware
r_static
r_void
id|reset_bri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|outpp
(paren
id|IoAdapter-&gt;ctlReg
comma
l_int|0x00
)paren
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------&n;   Halt system&n;  --------------------------------------------------------------------- */
DECL|function|stop_bri_hardware
r_static
r_void
id|stop_bri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_if
c_cond
(paren
id|IoAdapter-&gt;reset
)paren
(brace
id|outpp
(paren
id|IoAdapter-&gt;reset
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* disable interrupts ! */
)brace
id|outpp
(paren
id|IoAdapter-&gt;ctlReg
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* clear int, halt cpu */
)brace
macro_line|#if !defined(DIVA_USER_MODE_CARD_CONFIG) /* { */
multiline_comment|/* ---------------------------------------------------------------------&n;  Load protocol on the card&n;  --------------------------------------------------------------------- */
DECL|function|bri_protocol_load
r_static
id|dword
id|bri_protocol_load
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
id|FileLength
suffix:semicolon
id|word
id|test
comma
op_star
id|File
op_assign
l_int|NULL
suffix:semicolon
id|byte
op_star
id|addrHi
comma
op_star
id|addrLo
comma
op_star
id|ioaddr
suffix:semicolon
r_char
op_star
id|FileName
op_assign
op_amp
id|IoAdapter-&gt;Protocol
(braket
l_int|0
)braket
suffix:semicolon
id|dword
id|Addr
comma
id|i
suffix:semicolon
multiline_comment|/* -------------------------------------------------------------------&n;   Try to load protocol code. &squot;File&squot; points to memory location&n;   that does contain entire protocol code&n;   ------------------------------------------------------------------- */
r_if
c_cond
(paren
op_logical_neg
(paren
id|File
op_assign
(paren
id|word
op_star
)paren
id|xdiLoadArchive
(paren
id|IoAdapter
comma
op_amp
id|FileLength
comma
l_int|0
)paren
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* -------------------------------------------------------------------&n;   Get protocol features and calculate load addresses&n;   ------------------------------------------------------------------- */
id|IoAdapter-&gt;features
op_assign
id|diva_get_protocol_file_features
(paren
(paren
id|byte
op_star
)paren
id|File
comma
id|OFFS_PROTOCOL_ID_STRING
comma
id|IoAdapter-&gt;ProtocolIdString
comma
r_sizeof
(paren
id|IoAdapter-&gt;ProtocolIdString
)paren
)paren
suffix:semicolon
id|IoAdapter-&gt;a.protocol_capabilities
op_assign
id|IoAdapter-&gt;features
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;Loading %s&quot;
comma
id|IoAdapter-&gt;ProtocolIdString
)paren
)paren
id|Addr
op_assign
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
)braket
)paren
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
op_plus
l_int|1
)braket
)paren
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
op_plus
l_int|2
)braket
)paren
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
op_plus
l_int|3
)braket
)paren
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Addr
op_ne
l_int|0
)paren
(brace
id|IoAdapter-&gt;DspCodeBaseAddr
op_assign
(paren
id|Addr
op_plus
l_int|3
)paren
op_amp
(paren
op_complement
l_int|3
)paren
suffix:semicolon
id|IoAdapter-&gt;MaxDspCodeSize
op_assign
(paren
id|BRI_UNCACHED_ADDR
(paren
id|IoAdapter-&gt;MemoryBase
op_plus
id|IoAdapter-&gt;MemorySize
op_minus
id|BRI_SHARED_RAM_SIZE
)paren
op_minus
id|IoAdapter-&gt;DspCodeBaseAddr
)paren
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
suffix:semicolon
id|Addr
op_assign
id|IoAdapter-&gt;DspCodeBaseAddr
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
)braket
op_assign
(paren
id|byte
)paren
id|Addr
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
op_plus
l_int|1
)braket
op_assign
(paren
id|byte
)paren
(paren
id|Addr
op_rshift
l_int|8
)paren
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
op_plus
l_int|2
)braket
op_assign
(paren
id|byte
)paren
(paren
id|Addr
op_rshift
l_int|16
)paren
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
op_plus
l_int|3
)braket
op_assign
(paren
id|byte
)paren
(paren
id|Addr
op_rshift
l_int|24
)paren
suffix:semicolon
id|IoAdapter-&gt;InitialDspInfo
op_assign
l_int|0x80
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|IoAdapter-&gt;features
op_amp
id|PROTCAP_V90D
)paren
id|IoAdapter-&gt;MaxDspCodeSize
op_assign
id|BRI_V90D_MAX_DSP_CODE_SIZE
suffix:semicolon
r_else
id|IoAdapter-&gt;MaxDspCodeSize
op_assign
id|BRI_ORG_MAX_DSP_CODE_SIZE
suffix:semicolon
id|IoAdapter-&gt;DspCodeBaseAddr
op_assign
id|BRI_CACHED_ADDR
(paren
id|IoAdapter-&gt;MemoryBase
op_plus
id|IoAdapter-&gt;MemorySize
op_minus
id|BRI_SHARED_RAM_SIZE
op_minus
id|IoAdapter-&gt;MaxDspCodeSize
)paren
suffix:semicolon
id|IoAdapter-&gt;InitialDspInfo
op_assign
(paren
id|IoAdapter-&gt;MaxDspCodeSize
op_minus
id|BRI_ORG_MAX_DSP_CODE_SIZE
)paren
op_rshift
l_int|14
suffix:semicolon
)brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;DSP code base 0x%08lx, max size 0x%08lx (%08lx,%02x)&quot;
comma
id|IoAdapter-&gt;DspCodeBaseAddr
comma
id|IoAdapter-&gt;MaxDspCodeSize
comma
id|Addr
comma
id|IoAdapter-&gt;InitialDspInfo
)paren
)paren
r_if
c_cond
(paren
id|FileLength
OG
(paren
(paren
id|IoAdapter-&gt;DspCodeBaseAddr
op_minus
id|BRI_CACHED_ADDR
(paren
id|IoAdapter-&gt;MemoryBase
)paren
)paren
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;Protocol code &squot;%s&squot; too big (%ld)&quot;
comma
id|FileName
comma
id|FileLength
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|addrHi
op_assign
id|IoAdapter-&gt;port
op_plus
(paren
(paren
id|IoAdapter-&gt;Properties.Bus
op_eq
id|BUS_PCI
)paren
ques
c_cond
id|M_PCI_ADDRH
suffix:colon
id|ADDRH
)paren
suffix:semicolon
id|addrLo
op_assign
id|IoAdapter-&gt;port
op_plus
id|ADDR
suffix:semicolon
id|ioaddr
op_assign
id|IoAdapter-&gt;port
op_plus
id|DATA
suffix:semicolon
multiline_comment|/*&n; * set start address for download (use autoincrement mode !)&n; */
id|outpp
(paren
id|addrHi
comma
l_int|0
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FileLength
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|0x0000FFFF
)paren
op_eq
l_int|0
)paren
(brace
id|outpp
(paren
id|addrHi
comma
(paren
id|byte
)paren
(paren
id|i
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
id|outppw
(paren
id|ioaddr
comma
id|File
(braket
id|i
op_div
l_int|2
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * memory test without second load of file&n; */
id|outpp
(paren
id|addrHi
comma
l_int|0
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FileLength
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|0x0000FFFF
)paren
op_eq
l_int|0
)paren
(brace
id|outpp
(paren
id|addrHi
comma
(paren
id|byte
)paren
(paren
id|i
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
id|test
op_assign
id|inppw
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test
op_ne
id|File
(braket
id|i
op_div
l_int|2
)braket
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: Memory test failed! (%d - 0x%04X/0x%04X)&quot;
comma
id|IoAdapter-&gt;Properties.Name
comma
id|i
comma
id|test
comma
id|File
(braket
id|i
op_div
l_int|2
)braket
)paren
)paren
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
id|FileLength
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
r_typedef
r_struct
(brace
DECL|member|IoAdapter
id|PISDN_ADAPTER
id|IoAdapter
suffix:semicolon
DECL|member|AddrLo
id|byte
op_star
id|AddrLo
suffix:semicolon
DECL|member|AddrHi
id|byte
op_star
id|AddrHi
suffix:semicolon
DECL|member|Data
id|word
op_star
id|Data
suffix:semicolon
DECL|member|DownloadPos
id|dword
id|DownloadPos
suffix:semicolon
DECL|typedef|bri_download_info
)brace
id|bri_download_info
suffix:semicolon
DECL|function|bri_download_buffer
r_static
r_int
id|bri_download_buffer
(paren
id|OsFileHandle
op_star
id|fp
comma
r_int
id|length
comma
r_void
op_star
op_star
id|addr
)paren
(brace
r_int
id|buffer_size
op_assign
l_int|2048
op_star
r_sizeof
(paren
id|word
)paren
suffix:semicolon
id|word
op_star
id|buffer
op_assign
(paren
id|word
op_star
)paren
id|diva_os_malloc
(paren
l_int|0
comma
id|buffer_size
)paren
suffix:semicolon
id|bri_download_info
op_star
id|info
suffix:semicolon
id|word
id|test
suffix:semicolon
r_int
id|i
comma
id|len
comma
id|page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: out of memory, s_bri at %d&quot;
comma
id|__LINE__
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|info
op_assign
(paren
id|bri_download_info
op_star
)paren
id|fp-&gt;sysLoadDesc
suffix:semicolon
op_star
id|addr
op_assign
(paren
r_void
op_star
)paren
id|info-&gt;DownloadPos
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|dword
)paren
id|length
)paren
OG
id|info-&gt;IoAdapter-&gt;DspCodeBaseAddr
op_plus
id|info-&gt;IoAdapter-&gt;MaxDspCodeSize
op_minus
id|info-&gt;DownloadPos
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: out of card memory during DSP download (0x%X)&quot;
comma
id|info-&gt;IoAdapter-&gt;Properties.Name
comma
id|info-&gt;DownloadPos
op_plus
id|length
)paren
)paren
id|diva_os_free
(paren
l_int|0
comma
id|buffer
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|len
op_assign
l_int|0
suffix:semicolon
id|length
OG
l_int|0
suffix:semicolon
id|length
op_sub_assign
id|len
)paren
(brace
id|len
op_assign
(paren
id|length
OG
id|buffer_size
ques
c_cond
id|buffer_size
suffix:colon
id|length
)paren
suffix:semicolon
id|page
op_assign
(paren
(paren
r_int
)paren
(paren
id|info-&gt;DownloadPos
)paren
op_plus
id|len
)paren
op_amp
l_int|0xFFFF0000
suffix:semicolon
r_if
c_cond
(paren
id|page
op_ne
(paren
r_int
)paren
(paren
id|info-&gt;DownloadPos
op_amp
l_int|0xFFFF0000
)paren
)paren
(brace
id|len
op_assign
l_int|0x00010000
op_minus
(paren
(paren
(paren
r_int
)paren
id|info-&gt;DownloadPos
)paren
op_amp
l_int|0x0000FFFF
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fp-&gt;sysFileRead
(paren
id|fp
comma
op_amp
id|buffer
(braket
l_int|0
)braket
comma
id|len
)paren
op_ne
id|len
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|buffer
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|outpp
(paren
id|info-&gt;AddrHi
comma
(paren
id|byte
)paren
(paren
id|info-&gt;DownloadPos
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
(paren
id|info-&gt;AddrLo
comma
(paren
id|word
)paren
id|info-&gt;DownloadPos
)paren
suffix:semicolon
id|outppw_buffer
(paren
id|info-&gt;Data
comma
op_amp
id|buffer
(braket
l_int|0
)braket
comma
(paren
id|len
op_plus
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * memory test without second load of file&n; */
id|outpp
(paren
id|info-&gt;AddrHi
comma
(paren
id|byte
)paren
(paren
id|info-&gt;DownloadPos
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
(paren
id|info-&gt;AddrLo
comma
(paren
id|word
)paren
id|info-&gt;DownloadPos
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|test
op_assign
id|inppw
(paren
id|info-&gt;Data
)paren
)paren
op_ne
id|buffer
(braket
id|i
op_div
l_int|2
)braket
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: Memory test failed! (0x%lX - 0x%04X/0x%04X)&quot;
comma
id|info-&gt;IoAdapter-&gt;Properties.Name
comma
id|info-&gt;DownloadPos
op_plus
id|i
comma
id|test
comma
id|buffer
(braket
id|i
op_div
l_int|2
)braket
)paren
)paren
id|diva_os_free
(paren
l_int|0
comma
id|buffer
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
)brace
id|info-&gt;DownloadPos
op_add_assign
id|len
suffix:semicolon
)brace
id|info-&gt;DownloadPos
op_assign
(paren
id|info-&gt;DownloadPos
op_plus
l_int|3
)paren
op_amp
(paren
op_complement
l_int|3
)paren
suffix:semicolon
id|diva_os_free
(paren
l_int|0
comma
id|buffer
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
DECL|function|bri_telindus_load
r_static
id|dword
id|bri_telindus_load
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
r_char
op_star
id|DspTelindusFile
)paren
(brace
id|bri_download_info
op_star
id|pinfo
op_assign
"&bslash;"
(paren
id|bri_download_info
op_star
)paren
id|diva_os_malloc
c_func
(paren
l_int|0
comma
r_sizeof
(paren
op_star
id|pinfo
)paren
)paren
suffix:semicolon
r_char
op_star
id|error
suffix:semicolon
id|OsFileHandle
op_star
id|fp
suffix:semicolon
id|t_dsp_portable_desc
id|download_table
(braket
id|DSP_MAX_DOWNLOAD_COUNT
)braket
suffix:semicolon
id|word
id|download_count
suffix:semicolon
id|dword
id|FileLength
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pinfo
)paren
(brace
id|DBG_ERR
(paren
(paren
l_string|&quot;A: out of memory s_bri at %d&quot;
comma
id|__LINE__
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|fp
op_assign
id|OsOpenFile
(paren
id|DspTelindusFile
)paren
)paren
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|pinfo
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|FileLength
op_assign
id|fp-&gt;sysFileSize
suffix:semicolon
id|pinfo-&gt;IoAdapter
op_assign
id|IoAdapter
suffix:semicolon
id|pinfo-&gt;AddrLo
op_assign
id|IoAdapter-&gt;port
op_plus
id|ADDR
suffix:semicolon
id|pinfo-&gt;AddrHi
op_assign
id|IoAdapter-&gt;port
op_plus
"&bslash;"
(paren
id|IoAdapter-&gt;Properties.Bus
op_eq
id|BUS_PCI
ques
c_cond
id|M_PCI_ADDRH
suffix:colon
id|ADDRH
)paren
suffix:semicolon
id|pinfo-&gt;Data
op_assign
(paren
id|word
op_star
)paren
(paren
id|IoAdapter-&gt;port
op_plus
id|DATA
)paren
suffix:semicolon
id|pinfo-&gt;DownloadPos
op_assign
(paren
id|IoAdapter-&gt;DspCodeBaseAddr
op_plus
"&bslash;"
r_sizeof
(paren
id|dword
)paren
op_plus
r_sizeof
(paren
id|download_table
)paren
op_plus
l_int|3
)paren
op_amp
(paren
op_complement
l_int|3
)paren
suffix:semicolon
id|fp-&gt;sysLoadDesc
op_assign
(paren
r_void
op_star
)paren
id|pinfo
suffix:semicolon
id|fp-&gt;sysCardLoad
op_assign
id|bri_download_buffer
suffix:semicolon
id|download_count
op_assign
id|DSP_MAX_DOWNLOAD_COUNT
suffix:semicolon
id|memset
(paren
op_amp
id|download_table
(braket
l_int|0
)braket
comma
l_char|&squot;&bslash;0&squot;
comma
r_sizeof
(paren
id|download_table
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * set start address for download (use autoincrement mode !)&n; */
id|error
op_assign
id|dsp_read_file
(paren
id|fp
comma
(paren
id|word
)paren
(paren
id|IoAdapter-&gt;cardType
)paren
comma
op_amp
id|download_count
comma
l_int|NULL
comma
op_amp
id|download_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;download file error: %s&quot;
comma
id|error
)paren
)paren
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
id|diva_os_free
(paren
l_int|0
comma
id|pinfo
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
multiline_comment|/*&n; * store # of separate download files extracted from archive&n; */
id|pinfo-&gt;DownloadPos
op_assign
id|IoAdapter-&gt;DspCodeBaseAddr
suffix:semicolon
id|outpp
(paren
id|pinfo-&gt;AddrHi
comma
(paren
id|byte
)paren
(paren
id|pinfo-&gt;DownloadPos
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
(paren
id|pinfo-&gt;AddrLo
comma
(paren
id|word
)paren
id|pinfo-&gt;DownloadPos
)paren
suffix:semicolon
id|outppw
(paren
id|pinfo-&gt;Data
comma
(paren
id|word
)paren
id|download_count
)paren
suffix:semicolon
id|outppw
(paren
id|pinfo-&gt;Data
comma
(paren
id|word
)paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n; * copy download table to board&n; */
id|outppw_buffer
(paren
id|pinfo-&gt;Data
comma
op_amp
id|download_table
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|download_table
)paren
)paren
suffix:semicolon
id|diva_os_free
(paren
l_int|0
comma
id|pinfo
)paren
suffix:semicolon
r_return
(paren
id|FileLength
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
DECL|function|load_bri_hardware
r_static
r_int
id|load_bri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
id|i
suffix:semicolon
id|byte
op_star
id|addrHi
comma
op_star
id|addrLo
comma
op_star
id|ioaddr
suffix:semicolon
id|dword
id|test
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;Properties.Card
op_ne
id|CARD_MAE
)paren
(brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
id|addrHi
op_assign
id|IoAdapter-&gt;port
"&bslash;"
op_plus
(paren
(paren
id|IoAdapter-&gt;Properties.Bus
op_eq
id|BUS_PCI
)paren
ques
c_cond
id|M_PCI_ADDRH
suffix:colon
id|ADDRH
)paren
suffix:semicolon
id|addrLo
op_assign
id|IoAdapter-&gt;port
op_plus
id|ADDR
suffix:semicolon
id|ioaddr
op_assign
id|IoAdapter-&gt;port
op_plus
id|DATA
suffix:semicolon
id|reset_bri_hardware
(paren
id|IoAdapter
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/*&n; * recover&n; */
id|outpp
(paren
id|addrHi
comma
(paren
id|byte
)paren
l_int|0
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
(paren
id|word
)paren
l_int|0
)paren
suffix:semicolon
id|outppw
(paren
id|ioaddr
comma
(paren
id|word
)paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n; * clear shared memory&n; */
id|outpp
(paren
id|addrHi
comma
(paren
id|byte
)paren
(paren
(paren
id|BRI_UNCACHED_ADDR
(paren
id|IoAdapter-&gt;MemoryBase
op_plus
"&bslash;"
id|IoAdapter-&gt;MemorySize
op_minus
id|BRI_SHARED_RAM_SIZE
)paren
)paren
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x8000
suffix:semicolon
id|outppw
(paren
id|ioaddr
comma
l_int|0
)paren
comma
op_increment
id|i
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/*&n; * download protocol and dsp files&n; */
r_switch
c_cond
(paren
id|IoAdapter-&gt;protocol_id
)paren
(brace
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|xdiSetProtocol
(paren
id|IoAdapter
comma
id|IoAdapter-&gt;ProtocolSuffix
)paren
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bri_protocol_load
(paren
id|IoAdapter
)paren
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bri_telindus_load
(paren
id|IoAdapter
comma
id|DSP_TELINDUS_FILE
)paren
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PROTTYPE_QSIG
suffix:colon
r_case
id|PROTTYPE_CORNETN
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|xdiSetProtocol
(paren
id|IoAdapter
comma
id|IoAdapter-&gt;ProtocolSuffix
)paren
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;ProtocolSuffix
op_logical_and
op_star
id|IoAdapter-&gt;ProtocolSuffix
)paren
(brace
id|sprintf
(paren
op_amp
id|IoAdapter-&gt;Protocol
(braket
l_int|0
)braket
comma
l_string|&quot;TE_QSIG.%s&quot;
comma
id|IoAdapter-&gt;ProtocolSuffix
)paren
suffix:semicolon
)brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;xdiSetProtocol: %s firmware &squot;%s&squot; archive &squot;%s&squot;&quot;
comma
id|IoAdapter-&gt;Properties.Name
comma
op_amp
id|IoAdapter-&gt;Protocol
(braket
l_int|0
)braket
comma
op_amp
id|IoAdapter-&gt;Archive
(braket
l_int|0
)braket
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|bri_protocol_load
(paren
id|IoAdapter
)paren
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bri_telindus_load
(paren
id|IoAdapter
comma
id|DSP_QSIG_TELINDUS_FILE
)paren
)paren
r_return
(paren
id|FALSE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n; * clear signature&n; */
id|outpp
(paren
id|addrHi
comma
(paren
id|byte
)paren
(paren
(paren
id|BRI_UNCACHED_ADDR
(paren
id|IoAdapter-&gt;MemoryBase
op_plus
"&bslash;"
id|IoAdapter-&gt;MemorySize
op_minus
id|BRI_SHARED_RAM_SIZE
)paren
)paren
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
l_int|0x1e
)paren
suffix:semicolon
id|outpp
(paren
id|ioaddr
comma
l_int|0
)paren
suffix:semicolon
id|outpp
(paren
id|ioaddr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n; * copy parameters&n; */
id|diva_configure_protocol
(paren
id|IoAdapter
)paren
suffix:semicolon
multiline_comment|/*&n; * start the protocol code&n; */
id|outpp
(paren
id|IoAdapter-&gt;ctlReg
comma
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/*&n; * wait for signature (max. 3 seconds)&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|300
suffix:semicolon
op_increment
id|i
)paren
(brace
id|diva_os_wait
(paren
l_int|10
)paren
suffix:semicolon
id|outpp
(paren
id|addrHi
comma
(paren
id|byte
)paren
(paren
(paren
id|BRI_UNCACHED_ADDR
(paren
id|IoAdapter-&gt;MemoryBase
op_plus
"&bslash;"
id|IoAdapter-&gt;MemorySize
op_minus
id|BRI_SHARED_RAM_SIZE
)paren
)paren
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
l_int|0x1e
)paren
suffix:semicolon
id|test
op_assign
(paren
id|dword
)paren
id|inppw
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test
op_eq
l_int|0x4447
)paren
(brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Protocol startup time %d.%02d seconds&quot;
comma
(paren
id|i
op_div
l_int|100
)paren
comma
(paren
id|i
op_mod
l_int|100
)paren
)paren
)paren
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
)brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: Adapter selftest failed (0x%04X)!&quot;
comma
id|IoAdapter-&gt;Properties.Name
comma
id|test
)paren
)paren
id|bri_cpu_trapped
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
macro_line|#else /* } { */
DECL|function|load_bri_hardware
r_static
r_int
id|load_bri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif /* } */
multiline_comment|/******************************************************************************/
DECL|function|bri_ISR
r_static
r_int
id|bri_ISR
(paren
r_struct
id|_ISDN_ADAPTER
op_star
id|IoAdapter
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inpp
(paren
id|IoAdapter-&gt;ctlReg
)paren
op_amp
l_int|0x01
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;  clear interrupt line&n;  */
id|outpp
(paren
id|IoAdapter-&gt;ctlReg
comma
l_int|0x08
)paren
suffix:semicolon
id|IoAdapter-&gt;IrqCount
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;Initialized
)paren
(brace
id|diva_os_schedule_soft_isr
(paren
op_amp
id|IoAdapter-&gt;isr_soft_isr
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;  Disable IRQ in the card hardware&n;  -------------------------------------------------------------------------- */
DECL|function|disable_bri_interrupt
r_static
r_void
id|disable_bri_interrupt
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_if
c_cond
(paren
id|IoAdapter-&gt;reset
)paren
(brace
id|outpp
(paren
id|IoAdapter-&gt;reset
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// disable interrupts !
)brace
id|outpp
(paren
id|IoAdapter-&gt;ctlReg
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// clear int, halt cpu
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Fill card entry points&n;  ------------------------------------------------------------------------- */
DECL|function|prepare_maestra_functions
r_void
id|prepare_maestra_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|ADAPTER
op_star
id|a
op_assign
op_amp
id|IoAdapter-&gt;a
suffix:semicolon
id|a-&gt;ram_in
op_assign
id|io_in
suffix:semicolon
id|a-&gt;ram_inw
op_assign
id|io_inw
suffix:semicolon
id|a-&gt;ram_in_buffer
op_assign
id|io_in_buffer
suffix:semicolon
id|a-&gt;ram_look_ahead
op_assign
id|io_look_ahead
suffix:semicolon
id|a-&gt;ram_out
op_assign
id|io_out
suffix:semicolon
id|a-&gt;ram_outw
op_assign
id|io_outw
suffix:semicolon
id|a-&gt;ram_out_buffer
op_assign
id|io_out_buffer
suffix:semicolon
id|a-&gt;ram_inc
op_assign
id|io_inc
suffix:semicolon
id|IoAdapter-&gt;MemoryBase
op_assign
id|BRI_MEMORY_BASE
suffix:semicolon
id|IoAdapter-&gt;MemorySize
op_assign
id|BRI_MEMORY_SIZE
suffix:semicolon
id|IoAdapter-&gt;out
op_assign
id|pr_out
suffix:semicolon
id|IoAdapter-&gt;dpc
op_assign
id|pr_dpc
suffix:semicolon
id|IoAdapter-&gt;tst_irq
op_assign
id|scom_test_int
suffix:semicolon
id|IoAdapter-&gt;clr_irq
op_assign
id|scom_clear_int
suffix:semicolon
id|IoAdapter-&gt;pcm
op_assign
(paren
r_struct
id|pc_maint
op_star
)paren
id|MIPS_MAINT_OFFS
suffix:semicolon
id|IoAdapter-&gt;load
op_assign
id|load_bri_hardware
suffix:semicolon
id|IoAdapter-&gt;disIrq
op_assign
id|disable_bri_interrupt
suffix:semicolon
id|IoAdapter-&gt;rstFnc
op_assign
id|reset_bri_hardware
suffix:semicolon
id|IoAdapter-&gt;stop
op_assign
id|stop_bri_hardware
suffix:semicolon
id|IoAdapter-&gt;trapFnc
op_assign
id|bri_cpu_trapped
suffix:semicolon
id|IoAdapter-&gt;diva_isr_handler
op_assign
id|bri_ISR
suffix:semicolon
multiline_comment|/*&n;  Prepare OS dependent functions&n;  */
id|diva_os_prepare_maestra_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------- */
eof
