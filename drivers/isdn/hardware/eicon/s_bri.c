multiline_comment|/*&n; *&n;  Copyright (c) Eicon Networks, 2002.&n; *&n;  This source file is supplied for the use with&n;  Eicon Networks range of DIVA Server Adapters.&n; *&n;  Eicon File Revision :    2.1&n; *&n;  This program is free software; you can redistribute it and/or modify&n;  it under the terms of the GNU General Public License as published by&n;  the Free Software Foundation; either version 2, or (at your option)&n;  any later version.&n; *&n;  This program is distributed in the hope that it will be useful,&n;  but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY&n;  implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n;  See the GNU General Public License for more details.&n; *&n;  You should have received a copy of the GNU General Public License&n;  along with this program; if not, write to the Free Software&n;  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;di_defs.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;di.h&quot;
macro_line|#include &quot;mi_pc.h&quot;
macro_line|#include &quot;pc_maint.h&quot;
macro_line|#include &quot;divasync.h&quot;
macro_line|#include &quot;io.h&quot;
macro_line|#include &quot;helpers.h&quot;
macro_line|#include &quot;dsrv_bri.h&quot;
macro_line|#include &quot;dsp_defs.h&quot;
multiline_comment|/*****************************************************************************/
DECL|macro|MAX_XLOG_SIZE
mdefine_line|#define MAX_XLOG_SIZE (64 * 1024)
multiline_comment|/* --------------------------------------------------------------------------&n;  Investigate card state, recovery trace buffer&n;  -------------------------------------------------------------------------- */
DECL|function|bri_cpu_trapped
r_static
r_void
id|bri_cpu_trapped
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
id|__iomem
op_star
id|addrHi
comma
op_star
id|addrLo
comma
op_star
id|ioaddr
suffix:semicolon
id|word
op_star
id|Xlog
suffix:semicolon
id|dword
id|regs
(braket
l_int|4
)braket
comma
id|i
comma
id|size
suffix:semicolon
id|Xdesc
id|xlogDesc
suffix:semicolon
id|byte
id|__iomem
op_star
id|Port
suffix:semicolon
multiline_comment|/*&n; * first read pointers and trap frame&n; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|Xlog
op_assign
(paren
id|word
op_star
)paren
id|diva_os_malloc
(paren
l_int|0
comma
id|MAX_XLOG_SIZE
)paren
)paren
)paren
r_return
suffix:semicolon
id|Port
op_assign
id|DIVA_OS_MEM_ATTACH_PORT
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|addrHi
op_assign
id|Port
op_plus
(paren
(paren
id|IoAdapter-&gt;Properties.Bus
op_eq
id|BUS_PCI
)paren
ques
c_cond
id|M_PCI_ADDRH
suffix:colon
id|ADDRH
)paren
suffix:semicolon
id|addrLo
op_assign
id|Port
op_plus
id|ADDR
suffix:semicolon
id|ioaddr
op_assign
id|Port
op_plus
id|DATA
suffix:semicolon
id|outpp
(paren
id|addrHi
comma
l_int|0
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x100
suffix:semicolon
id|Xlog
(braket
id|i
op_increment
)braket
op_assign
id|inppw
c_func
(paren
id|ioaddr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * check for trapped MIPS 3xxx CPU, dump only exception frame&n; */
r_if
c_cond
(paren
id|GET_DWORD
c_func
(paren
op_amp
id|Xlog
(braket
l_int|0x80
op_div
r_sizeof
(paren
id|Xlog
(braket
l_int|0
)braket
)paren
)braket
)paren
op_eq
l_int|0x99999999
)paren
(brace
id|dump_trap_frame
(paren
id|IoAdapter
comma
op_amp
(paren
(paren
id|byte
op_star
)paren
id|Xlog
)paren
(braket
l_int|0x90
)braket
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|1
suffix:semicolon
)brace
id|regs
(braket
l_int|0
)braket
op_assign
id|GET_DWORD
c_func
(paren
op_amp
(paren
(paren
id|byte
op_star
)paren
id|Xlog
)paren
(braket
l_int|0x70
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|1
)braket
op_assign
id|GET_DWORD
c_func
(paren
op_amp
(paren
(paren
id|byte
op_star
)paren
id|Xlog
)paren
(braket
l_int|0x74
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|2
)braket
op_assign
id|GET_DWORD
c_func
(paren
op_amp
(paren
(paren
id|byte
op_star
)paren
id|Xlog
)paren
(braket
l_int|0x78
)braket
)paren
suffix:semicolon
id|regs
(braket
l_int|3
)braket
op_assign
id|GET_DWORD
c_func
(paren
op_amp
(paren
(paren
id|byte
op_star
)paren
id|Xlog
)paren
(braket
l_int|0x7c
)braket
)paren
suffix:semicolon
id|outpp
(paren
id|addrHi
comma
(paren
id|regs
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x7F
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
id|regs
(braket
l_int|1
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|xlogDesc.cnt
op_assign
id|inppw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|outpp
(paren
id|addrHi
comma
(paren
id|regs
(braket
l_int|2
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x7F
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
id|regs
(braket
l_int|2
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|xlogDesc.out
op_assign
id|inppw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|xlogDesc.buf
op_assign
id|Xlog
suffix:semicolon
id|regs
(braket
l_int|0
)braket
op_and_assign
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|regs
(braket
l_int|0
)braket
OL
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)paren
(brace
id|size
op_assign
id|IoAdapter-&gt;MemorySize
op_minus
id|regs
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|MAX_XLOG_SIZE
)paren
id|size
op_assign
id|MAX_XLOG_SIZE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|size
op_div
r_sizeof
(paren
op_star
id|Xlog
)paren
)paren
suffix:semicolon
id|regs
(braket
l_int|0
)braket
op_add_assign
l_int|2
)paren
(brace
id|outpp
(paren
id|addrHi
comma
(paren
id|regs
(braket
l_int|0
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x7F
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
id|regs
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|Xlog
(braket
id|i
op_increment
)braket
op_assign
id|inppw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
)brace
id|dump_xlog_buffer
(paren
id|IoAdapter
comma
op_amp
id|xlogDesc
)paren
suffix:semicolon
id|diva_os_free
(paren
l_int|0
comma
id|Xlog
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|2
suffix:semicolon
)brace
id|outpp
(paren
id|addrHi
comma
(paren
id|byte
)paren
(paren
(paren
id|BRI_UNCACHED_ADDR
(paren
id|IoAdapter-&gt;MemoryBase
op_plus
id|IoAdapter-&gt;MemorySize
op_minus
id|BRI_SHARED_RAM_SIZE
)paren
)paren
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
(paren
id|addrLo
comma
l_int|0x00
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_PORT
c_func
(paren
id|IoAdapter
comma
id|Port
)paren
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------&n;   Reset hardware&n;  --------------------------------------------------------------------- */
DECL|function|reset_bri_hardware
r_static
r_void
id|reset_bri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
id|__iomem
op_star
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|outpp
(paren
id|p
comma
l_int|0x00
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------&n;   Halt system&n;  --------------------------------------------------------------------- */
DECL|function|stop_bri_hardware
r_static
r_void
id|stop_bri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
id|__iomem
op_star
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|outpp
(paren
id|p
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* disable interrupts ! */
)brace
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|outpp
(paren
id|p
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* clear int, halt cpu */
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
)brace
DECL|function|load_bri_hardware
r_static
r_int
id|load_bri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
DECL|function|bri_ISR
r_static
r_int
id|bri_ISR
(paren
r_struct
id|_ISDN_ADAPTER
op_star
id|IoAdapter
)paren
(brace
id|byte
id|__iomem
op_star
id|p
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inpp
(paren
id|p
)paren
op_amp
l_int|0x01
)paren
)paren
(brace
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  clear interrupt line&n;  */
id|outpp
(paren
id|p
comma
l_int|0x08
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|IoAdapter-&gt;IrqCount
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;Initialized
)paren
(brace
id|diva_os_schedule_soft_isr
(paren
op_amp
id|IoAdapter-&gt;isr_soft_isr
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;  Disable IRQ in the card hardware&n;  -------------------------------------------------------------------------- */
DECL|function|disable_bri_interrupt
r_static
r_void
id|disable_bri_interrupt
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
id|__iomem
op_star
id|p
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|outpp
(paren
id|p
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* disable interrupts ! */
)brace
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|outpp
(paren
id|p
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* clear int, halt cpu */
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n;  Fill card entry points&n;  ------------------------------------------------------------------------- */
DECL|function|prepare_maestra_functions
r_void
id|prepare_maestra_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|ADAPTER
op_star
id|a
op_assign
op_amp
id|IoAdapter-&gt;a
suffix:semicolon
id|a-&gt;ram_in
op_assign
id|io_in
suffix:semicolon
id|a-&gt;ram_inw
op_assign
id|io_inw
suffix:semicolon
id|a-&gt;ram_in_buffer
op_assign
id|io_in_buffer
suffix:semicolon
id|a-&gt;ram_look_ahead
op_assign
id|io_look_ahead
suffix:semicolon
id|a-&gt;ram_out
op_assign
id|io_out
suffix:semicolon
id|a-&gt;ram_outw
op_assign
id|io_outw
suffix:semicolon
id|a-&gt;ram_out_buffer
op_assign
id|io_out_buffer
suffix:semicolon
id|a-&gt;ram_inc
op_assign
id|io_inc
suffix:semicolon
id|IoAdapter-&gt;MemoryBase
op_assign
id|BRI_MEMORY_BASE
suffix:semicolon
id|IoAdapter-&gt;MemorySize
op_assign
id|BRI_MEMORY_SIZE
suffix:semicolon
id|IoAdapter-&gt;out
op_assign
id|pr_out
suffix:semicolon
id|IoAdapter-&gt;dpc
op_assign
id|pr_dpc
suffix:semicolon
id|IoAdapter-&gt;tst_irq
op_assign
id|scom_test_int
suffix:semicolon
id|IoAdapter-&gt;clr_irq
op_assign
id|scom_clear_int
suffix:semicolon
id|IoAdapter-&gt;pcm
op_assign
(paren
r_struct
id|pc_maint
op_star
)paren
id|MIPS_MAINT_OFFS
suffix:semicolon
id|IoAdapter-&gt;load
op_assign
id|load_bri_hardware
suffix:semicolon
id|IoAdapter-&gt;disIrq
op_assign
id|disable_bri_interrupt
suffix:semicolon
id|IoAdapter-&gt;rstFnc
op_assign
id|reset_bri_hardware
suffix:semicolon
id|IoAdapter-&gt;stop
op_assign
id|stop_bri_hardware
suffix:semicolon
id|IoAdapter-&gt;trapFnc
op_assign
id|bri_cpu_trapped
suffix:semicolon
id|IoAdapter-&gt;diva_isr_handler
op_assign
id|bri_ISR
suffix:semicolon
multiline_comment|/*&n;  Prepare OS dependent functions&n;  */
id|diva_os_prepare_maestra_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------- */
eof
