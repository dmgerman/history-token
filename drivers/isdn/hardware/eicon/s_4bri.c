multiline_comment|/*&n; *&n;  Copyright (c) Eicon Networks, 2002.&n; *&n;  This source file is supplied for the use with&n;  Eicon Networks range of DIVA Server Adapters.&n; *&n;  Eicon File Revision :    2.1&n; *&n;  This program is free software; you can redistribute it and/or modify&n;  it under the terms of the GNU General Public License as published by&n;  the Free Software Foundation; either version 2, or (at your option)&n;  any later version.&n; *&n;  This program is distributed in the hope that it will be useful,&n;  but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY&n;  implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n;  See the GNU General Public License for more details.&n; *&n;  You should have received a copy of the GNU General Public License&n;  along with this program; if not, write to the Free Software&n;  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;di_defs.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;di.h&quot;
macro_line|#include &quot;mi_pc.h&quot;
macro_line|#include &quot;pc_maint.h&quot;
macro_line|#include &quot;divasync.h&quot;
macro_line|#include &quot;pc_init.h&quot;
macro_line|#include &quot;io.h&quot;
macro_line|#include &quot;helpers.h&quot;
macro_line|#include &quot;dsrv4bri.h&quot;
macro_line|#include &quot;dsp_defs.h&quot;
macro_line|#include &quot;sdp_hdr.h&quot;
multiline_comment|/*****************************************************************************/
DECL|macro|MAX_XLOG_SIZE
mdefine_line|#define&t;MAX_XLOG_SIZE&t;(64 * 1024)
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Recovery XLOG from QBRI Card&n;&t; -------------------------------------------------------------------------- */
DECL|function|qBri_cpu_trapped
r_static
r_void
id|qBri_cpu_trapped
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
id|__iomem
op_star
id|base
suffix:semicolon
id|word
op_star
id|Xlog
suffix:semicolon
id|dword
id|regs
(braket
l_int|4
)braket
comma
id|TrapID
comma
id|offset
comma
id|size
suffix:semicolon
id|Xdesc
id|xlogDesc
suffix:semicolon
r_int
id|factor
op_assign
(paren
id|IoAdapter-&gt;tasks
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/*&n; *&t;check for trapped MIPS 46xx CPU, dump exception frame&n; */
id|base
op_assign
id|DIVA_OS_MEM_ATTACH_CONTROL
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|offset
op_assign
id|IoAdapter-&gt;ControllerNumber
op_star
(paren
id|IoAdapter-&gt;MemorySize
op_rshift
id|factor
)paren
suffix:semicolon
id|TrapID
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
l_int|0x80
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|TrapID
op_eq
l_int|0x99999999
)paren
op_logical_or
(paren
id|TrapID
op_eq
l_int|0x99999901
)paren
)paren
(brace
id|dump_trap_frame
(paren
id|IoAdapter
comma
op_amp
id|base
(braket
l_int|0x90
)braket
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|1
suffix:semicolon
)brace
id|regs
(braket
l_int|0
)braket
op_assign
id|READ_DWORD
c_func
(paren
(paren
op_amp
id|base
op_plus
id|offset
)paren
op_plus
l_int|0x70
)paren
suffix:semicolon
id|regs
(braket
l_int|1
)braket
op_assign
id|READ_DWORD
c_func
(paren
(paren
op_amp
id|base
op_plus
id|offset
)paren
op_plus
l_int|0x74
)paren
suffix:semicolon
id|regs
(braket
l_int|2
)braket
op_assign
id|READ_DWORD
c_func
(paren
(paren
op_amp
id|base
op_plus
id|offset
)paren
op_plus
l_int|0x78
)paren
suffix:semicolon
id|regs
(braket
l_int|3
)braket
op_assign
id|READ_DWORD
c_func
(paren
(paren
op_amp
id|base
op_plus
id|offset
)paren
op_plus
l_int|0x7c
)paren
suffix:semicolon
id|regs
(braket
l_int|0
)braket
op_and_assign
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|regs
(braket
l_int|0
)braket
op_ge
id|offset
)paren
op_logical_and
(paren
id|regs
(braket
l_int|0
)braket
OL
id|offset
op_plus
(paren
id|IoAdapter-&gt;MemorySize
op_rshift
id|factor
)paren
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|Xlog
op_assign
(paren
id|word
op_star
)paren
id|diva_os_malloc
(paren
l_int|0
comma
id|MAX_XLOG_SIZE
)paren
)paren
)paren
(brace
id|DIVA_OS_MEM_DETACH_CONTROL
c_func
(paren
id|IoAdapter
comma
id|base
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|size
op_assign
id|offset
op_plus
(paren
id|IoAdapter-&gt;MemorySize
op_rshift
id|factor
)paren
op_minus
id|regs
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|MAX_XLOG_SIZE
)paren
id|size
op_assign
id|MAX_XLOG_SIZE
suffix:semicolon
id|memcpy
(paren
id|Xlog
comma
op_amp
id|base
(braket
id|regs
(braket
l_int|0
)braket
)braket
comma
id|size
)paren
suffix:semicolon
id|xlogDesc.buf
op_assign
id|Xlog
suffix:semicolon
id|xlogDesc.cnt
op_assign
id|READ_WORD
c_func
(paren
op_amp
id|base
(braket
id|regs
(braket
l_int|1
)braket
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)braket
)paren
suffix:semicolon
id|xlogDesc.out
op_assign
id|READ_WORD
c_func
(paren
op_amp
id|base
(braket
id|regs
(braket
l_int|2
)braket
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)braket
)paren
suffix:semicolon
id|dump_xlog_buffer
(paren
id|IoAdapter
comma
op_amp
id|xlogDesc
)paren
suffix:semicolon
id|diva_os_free
(paren
l_int|0
comma
id|Xlog
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|2
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_CONTROL
c_func
(paren
id|IoAdapter
comma
id|base
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Reset QBRI Hardware&n;&t; -------------------------------------------------------------------------- */
DECL|function|reset_qBri_hardware
r_static
r_void
id|reset_qBri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|word
r_volatile
id|__iomem
op_star
id|qBriReset
suffix:semicolon
id|byte
r_volatile
id|__iomem
op_star
id|qBriCntrl
suffix:semicolon
id|byte
r_volatile
id|__iomem
op_star
id|p
suffix:semicolon
id|qBriReset
op_assign
(paren
id|word
r_volatile
id|__iomem
op_star
)paren
id|DIVA_OS_MEM_ATTACH_PROM
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|qBriReset
comma
id|READ_WORD
c_func
(paren
id|qBriReset
)paren
op_or
id|PLX9054_SOFT_RESET
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|qBriReset
comma
id|READ_WORD
c_func
(paren
id|qBriReset
)paren
op_amp
op_complement
id|PLX9054_SOFT_RESET
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|qBriReset
comma
id|READ_WORD
c_func
(paren
id|qBriReset
)paren
op_or
id|PLX9054_RELOAD_EEPROM
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|qBriReset
comma
id|READ_WORD
c_func
(paren
id|qBriReset
)paren
op_amp
op_complement
id|PLX9054_RELOAD_EEPROM
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_PROM
c_func
(paren
id|IoAdapter
comma
id|qBriReset
)paren
suffix:semicolon
id|qBriCntrl
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|qBriCntrl
(braket
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
ques
c_cond
(paren
id|MQ2_BREG_RISC
)paren
suffix:colon
(paren
id|MQ_BREG_RISC
)paren
)braket
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|qBriCntrl
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;resetted board @ reset addr 0x%08lx&quot;
comma
id|qBriReset
)paren
)paren
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;resetted board @ cntrl addr 0x%08lx&quot;
comma
id|p
)paren
)paren
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Start Card CPU&n;&t; -------------------------------------------------------------------------- */
DECL|function|start_qBri_hardware
r_void
id|start_qBri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
r_volatile
id|__iomem
op_star
id|qBriReset
suffix:semicolon
id|byte
r_volatile
id|__iomem
op_star
id|p
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|qBriReset
op_assign
op_amp
id|p
(braket
(paren
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
)paren
ques
c_cond
(paren
id|MQ2_BREG_RISC
)paren
suffix:colon
(paren
id|MQ_BREG_RISC
)paren
)braket
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriReset
comma
id|MQ_RISC_COLD_RESET_MASK
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|2
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriReset
comma
id|MQ_RISC_WARM_RESET_MASK
op_or
id|MQ_RISC_COLD_RESET_MASK
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|10
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;started processor @ addr 0x%08lx&quot;
comma
id|qBriReset
)paren
)paren
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Stop Card CPU&n;&t; -------------------------------------------------------------------------- */
DECL|function|stop_qBri_hardware
r_static
r_void
id|stop_qBri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
r_volatile
id|__iomem
op_star
id|p
suffix:semicolon
id|dword
r_volatile
id|__iomem
op_star
id|qBriReset
suffix:semicolon
id|dword
r_volatile
id|__iomem
op_star
id|qBriIrq
suffix:semicolon
id|dword
r_volatile
id|__iomem
op_star
id|qBriIsacDspReset
suffix:semicolon
r_int
id|rev2
op_assign
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_int
id|reset_offset
op_assign
id|rev2
ques
c_cond
(paren
id|MQ2_BREG_RISC
)paren
suffix:colon
(paren
id|MQ_BREG_RISC
)paren
suffix:semicolon
r_int
id|irq_offset
op_assign
id|rev2
ques
c_cond
(paren
id|MQ2_BREG_IRQ_TEST
)paren
suffix:colon
(paren
id|MQ_BREG_IRQ_TEST
)paren
suffix:semicolon
r_int
id|hw_offset
op_assign
id|rev2
ques
c_cond
(paren
id|MQ2_ISAC_DSP_RESET
)paren
suffix:colon
(paren
id|MQ_ISAC_DSP_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;ControllerNumber
OG
l_int|0
)paren
r_return
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|qBriReset
op_assign
(paren
id|dword
r_volatile
id|__iomem
op_star
)paren
op_amp
id|p
(braket
id|reset_offset
)braket
suffix:semicolon
id|qBriIsacDspReset
op_assign
(paren
id|dword
r_volatile
id|__iomem
op_star
)paren
op_amp
id|p
(braket
id|hw_offset
)braket
suffix:semicolon
multiline_comment|/*&n; *&t;clear interrupt line (reset Local Interrupt Test Register)&n; */
id|WRITE_DWORD
c_func
(paren
id|qBriReset
comma
l_int|0
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriIsacDspReset
comma
l_int|0
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|p
(braket
id|PLX9054_INTCSR
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* disable PCI interrupts */
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|qBriIrq
op_assign
(paren
id|dword
r_volatile
id|__iomem
op_star
)paren
op_amp
id|p
(braket
id|irq_offset
)braket
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriIrq
comma
id|MQ_IRQ_REQ_OFF
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;stopped processor @ addr 0x%08lx&quot;
comma
id|qBriReset
)paren
)paren
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;FPGA download&n;&t; -------------------------------------------------------------------------- */
DECL|macro|FPGA_NAME_OFFSET
mdefine_line|#define FPGA_NAME_OFFSET         0x10
DECL|function|qBri_check_FPGAsrc
r_static
id|byte
op_star
id|qBri_check_FPGAsrc
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
r_char
op_star
id|FileName
comma
id|dword
op_star
id|Length
comma
id|dword
op_star
id|code
)paren
(brace
id|byte
op_star
id|File
suffix:semicolon
r_char
op_star
id|fpgaFile
comma
op_star
id|fpgaType
comma
op_star
id|fpgaDate
comma
op_star
id|fpgaTime
suffix:semicolon
id|dword
id|fpgaFlen
comma
id|fpgaTlen
comma
id|fpgaDlen
comma
id|cnt
comma
id|year
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|File
op_assign
(paren
id|byte
op_star
)paren
id|xdiLoadFile
(paren
id|FileName
comma
id|Length
comma
l_int|0
)paren
)paren
)paren
(brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t; scan file until FF and put id string into buffer&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|File
(braket
id|i
)braket
op_ne
l_int|0xff
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_increment
id|i
op_ge
op_star
id|Length
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;FPGA download: start of data header not found&quot;
)paren
)paren
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
op_star
id|code
op_assign
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|File
(braket
id|i
)braket
op_amp
l_int|0xF0
)paren
op_ne
l_int|0x20
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;FPGA download: data header corrupted&quot;
)paren
)paren
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|fpgaFlen
op_assign
(paren
id|dword
)paren
id|File
(braket
id|FPGA_NAME_OFFSET
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fpgaFlen
op_eq
l_int|0
)paren
id|fpgaFlen
op_assign
l_int|12
suffix:semicolon
id|fpgaFile
op_assign
(paren
r_char
op_star
)paren
op_amp
id|File
(braket
id|FPGA_NAME_OFFSET
)braket
suffix:semicolon
id|fpgaTlen
op_assign
(paren
id|dword
)paren
id|fpgaFile
(braket
id|fpgaFlen
op_plus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fpgaTlen
op_eq
l_int|0
)paren
id|fpgaTlen
op_assign
l_int|10
suffix:semicolon
id|fpgaType
op_assign
(paren
r_char
op_star
)paren
op_amp
id|fpgaFile
(braket
id|fpgaFlen
op_plus
l_int|3
)braket
suffix:semicolon
id|fpgaDlen
op_assign
(paren
id|dword
)paren
id|fpgaType
(braket
id|fpgaTlen
op_plus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fpgaDlen
op_eq
l_int|0
)paren
id|fpgaDlen
op_assign
l_int|11
suffix:semicolon
id|fpgaDate
op_assign
(paren
r_char
op_star
)paren
op_amp
id|fpgaType
(braket
id|fpgaTlen
op_plus
l_int|3
)braket
suffix:semicolon
id|fpgaTime
op_assign
(paren
r_char
op_star
)paren
op_amp
id|fpgaDate
(braket
id|fpgaDlen
op_plus
l_int|3
)braket
suffix:semicolon
id|cnt
op_assign
(paren
id|dword
)paren
(paren
(paren
(paren
id|File
(braket
id|i
)braket
op_amp
l_int|0x0F
)paren
op_lshift
l_int|20
)paren
op_plus
(paren
id|File
(braket
id|i
op_plus
l_int|1
)braket
op_lshift
l_int|12
)paren
op_plus
(paren
id|File
(braket
id|i
op_plus
l_int|2
)braket
op_lshift
l_int|4
)paren
op_plus
(paren
id|File
(braket
id|i
op_plus
l_int|3
)braket
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dword
)paren
(paren
id|i
op_plus
(paren
id|cnt
op_div
l_int|8
)paren
)paren
OG
op_star
id|Length
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;FPGA download: &squot;%s&squot; file too small (%ld &lt; %ld)&quot;
comma
id|FileName
comma
op_star
id|Length
comma
id|code
op_plus
(paren
(paren
id|cnt
op_plus
l_int|7
)paren
op_div
l_int|8
)paren
)paren
)paren
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_while
c_loop
(paren
(paren
id|fpgaDate
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_logical_and
(paren
(paren
id|fpgaDate
(braket
id|i
)braket
OL
l_char|&squot;0&squot;
)paren
op_logical_or
(paren
id|fpgaDate
(braket
id|i
)braket
OG
l_char|&squot;9&squot;
)paren
)paren
)paren
(brace
id|i
op_increment
suffix:semicolon
)brace
id|year
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|fpgaDate
(braket
id|i
)braket
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
id|fpgaDate
(braket
id|i
)braket
op_le
l_char|&squot;9&squot;
)paren
)paren
id|year
op_assign
id|year
op_star
l_int|10
op_plus
(paren
id|fpgaDate
(braket
id|i
op_increment
)braket
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|year
OL
l_int|2000
)paren
op_logical_and
(paren
id|fpgaDate
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|IoAdapter-&gt;cardType
)paren
(brace
r_case
id|CARDTYPE_DIVASRV_B_2F_PCI
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|year
op_ge
l_int|2001
)paren
(brace
id|IoAdapter-&gt;fpga_features
op_or_assign
id|PCINIT_FPGA_PLX_ACCESS_SUPPORTED
suffix:semicolon
)brace
)brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;FPGA[%s] file %s (%s %s) len %d&quot;
comma
id|fpgaType
comma
id|fpgaFile
comma
id|fpgaDate
comma
id|fpgaTime
comma
id|cnt
)paren
)paren
r_return
(paren
id|File
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
DECL|macro|FPGA_PROG
mdefine_line|#define FPGA_PROG   0x0001&t;&t;/* PROG enable low */
DECL|macro|FPGA_BUSY
mdefine_line|#define FPGA_BUSY   0x0002&t;&t;/* BUSY high, DONE low */
DECL|macro|FPGA_CS
mdefine_line|#define&t;FPGA_CS     0x000C&t;&t;/* Enable I/O pins */
DECL|macro|FPGA_CCLK
mdefine_line|#define FPGA_CCLK   0x0100
DECL|macro|FPGA_DOUT
mdefine_line|#define FPGA_DOUT   0x0400
DECL|macro|FPGA_DIN
mdefine_line|#define FPGA_DIN    FPGA_DOUT   /* bidirectional I/O */
DECL|function|qBri_FPGA_download
r_int
id|qBri_FPGA_download
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_int
id|bit
suffix:semicolon
id|byte
op_star
id|File
suffix:semicolon
id|dword
id|code
comma
id|FileLength
suffix:semicolon
id|word
r_volatile
id|__iomem
op_star
id|addr
op_assign
(paren
id|word
r_volatile
id|__iomem
op_star
)paren
id|DIVA_OS_MEM_ATTACH_PROM
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|word
id|val
comma
id|baseval
op_assign
id|FPGA_CS
op_or
id|FPGA_PROG
suffix:semicolon
r_if
c_cond
(paren
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
)paren
(brace
r_char
op_star
id|name
suffix:semicolon
r_switch
c_cond
(paren
id|IoAdapter-&gt;cardType
)paren
(brace
r_case
id|CARDTYPE_DIVASRV_B_2F_PCI
suffix:colon
id|name
op_assign
l_string|&quot;dsbri2f.bit&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CARDTYPE_DIVASRV_B_2M_V2_PCI
suffix:colon
r_case
id|CARDTYPE_DIVASRV_VOICE_B_2M_V2_PCI
suffix:colon
id|name
op_assign
l_string|&quot;dsbri2m.bit&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|name
op_assign
l_string|&quot;ds4bri2.bit&quot;
suffix:semicolon
)brace
id|File
op_assign
id|qBri_check_FPGAsrc
(paren
id|IoAdapter
comma
id|name
comma
op_amp
id|FileLength
comma
op_amp
id|code
)paren
suffix:semicolon
)brace
r_else
(brace
id|File
op_assign
id|qBri_check_FPGAsrc
(paren
id|IoAdapter
comma
l_string|&quot;ds4bri.bit&quot;
comma
op_amp
id|FileLength
comma
op_amp
id|code
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|File
)paren
(brace
id|DIVA_OS_MEM_DETACH_PROM
c_func
(paren
id|IoAdapter
comma
id|addr
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;prepare download, pulse PROGRAM pin down.&n; */
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
op_amp
op_complement
id|FPGA_PROG
)paren
suffix:semicolon
multiline_comment|/* PROGRAM low pulse */
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
)paren
suffix:semicolon
multiline_comment|/* release */
id|diva_os_wait
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* wait until FPGA finished internal memory clear */
multiline_comment|/*&n; *&t;check done pin, must be low&n; */
r_if
c_cond
(paren
id|READ_WORD
c_func
(paren
id|addr
)paren
op_amp
id|FPGA_BUSY
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;FPGA download: acknowledge for FPGA memory clear missing&quot;
)paren
)paren
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_PROM
c_func
(paren
id|IoAdapter
comma
id|addr
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;put data onto the FPGA&n; */
r_while
c_loop
(paren
id|code
OL
id|FileLength
)paren
(brace
id|val
op_assign
(paren
(paren
id|word
)paren
id|File
(braket
id|code
op_increment
)braket
)paren
op_lshift
l_int|3
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|8
suffix:semicolon
id|bit
op_decrement
OG
l_int|0
suffix:semicolon
id|val
op_lshift_assign
l_int|1
)paren
multiline_comment|/* put byte onto FPGA */
(brace
id|baseval
op_and_assign
op_complement
id|FPGA_DOUT
suffix:semicolon
multiline_comment|/* clr  data bit */
id|baseval
op_or_assign
(paren
id|val
op_amp
id|FPGA_DOUT
)paren
suffix:semicolon
multiline_comment|/* copy data bit */
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
op_or
id|FPGA_CCLK
)paren
suffix:semicolon
multiline_comment|/* set CCLK hi */
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
op_or
id|FPGA_CCLK
)paren
suffix:semicolon
multiline_comment|/* set CCLK hi */
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
)paren
suffix:semicolon
multiline_comment|/* set CCLK lo */
)brace
)brace
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|100
)paren
suffix:semicolon
id|val
op_assign
id|READ_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_PROM
c_func
(paren
id|IoAdapter
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|FPGA_BUSY
)paren
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;FPGA download: chip remains in busy state (0x%04x)&quot;
comma
id|val
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if !defined(DIVA_USER_MODE_CARD_CONFIG) /* { */
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Download protocol code to the adapter&n;&t; -------------------------------------------------------------------------- */
DECL|function|qBri_protocol_load
r_static
r_int
id|qBri_protocol_load
(paren
id|PISDN_ADAPTER
id|BaseIoAdapter
comma
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|PISDN_ADAPTER
id|HighIoAdapter
suffix:semicolon
id|byte
op_star
id|p
suffix:semicolon
id|dword
id|FileLength
suffix:semicolon
id|dword
op_star
id|sharedRam
comma
op_star
id|File
suffix:semicolon
id|dword
id|Addr
comma
id|ProtOffset
comma
id|SharedRamOffset
comma
id|i
suffix:semicolon
id|dword
id|tasks
op_assign
id|BaseIoAdapter-&gt;tasks
suffix:semicolon
r_int
id|factor
op_assign
(paren
id|tasks
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|File
op_assign
(paren
id|dword
op_star
)paren
id|xdiLoadArchive
(paren
id|IoAdapter
comma
op_amp
id|FileLength
comma
l_int|0
)paren
)paren
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|IoAdapter-&gt;features
op_assign
id|diva_get_protocol_file_features
(paren
(paren
id|byte
op_star
)paren
id|File
comma
id|OFFS_PROTOCOL_ID_STRING
comma
id|IoAdapter-&gt;ProtocolIdString
comma
r_sizeof
(paren
id|IoAdapter-&gt;ProtocolIdString
)paren
)paren
suffix:semicolon
id|IoAdapter-&gt;a.protocol_capabilities
op_assign
id|IoAdapter-&gt;features
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;Loading %s&quot;
comma
id|IoAdapter-&gt;ProtocolIdString
)paren
)paren
id|ProtOffset
op_assign
id|IoAdapter-&gt;ControllerNumber
op_star
(paren
id|IoAdapter-&gt;MemorySize
op_rshift
id|factor
)paren
suffix:semicolon
id|SharedRamOffset
op_assign
(paren
id|IoAdapter-&gt;MemorySize
op_rshift
id|factor
)paren
op_minus
id|MQ_SHARED_RAM_SIZE
suffix:semicolon
id|Addr
op_assign
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
)braket
)paren
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
op_plus
l_int|1
)braket
)paren
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
op_plus
l_int|2
)braket
)paren
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
(paren
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_PROTOCOL_END_ADDR
op_plus
l_int|3
)braket
)paren
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Addr
op_ne
l_int|0
)paren
(brace
id|IoAdapter-&gt;DspCodeBaseAddr
op_assign
(paren
id|Addr
op_plus
l_int|3
)paren
op_amp
(paren
op_complement
l_int|3
)paren
suffix:semicolon
id|IoAdapter-&gt;MaxDspCodeSize
op_assign
(paren
id|MQ_UNCACHED_ADDR
(paren
id|ProtOffset
op_plus
id|SharedRamOffset
)paren
op_minus
id|IoAdapter-&gt;DspCodeBaseAddr
)paren
op_amp
(paren
(paren
id|IoAdapter-&gt;MemorySize
op_rshift
id|factor
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|BaseIoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|ControllerNumber
op_ne
id|tasks
op_minus
l_int|1
)paren
id|i
op_increment
suffix:semicolon
id|HighIoAdapter
op_assign
id|BaseIoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
suffix:semicolon
id|Addr
op_assign
id|HighIoAdapter-&gt;DspCodeBaseAddr
suffix:semicolon
r_if
c_cond
(paren
id|tasks
op_eq
l_int|1
)paren
(brace
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DIVA_INIT_TASK_COUNT
)braket
op_assign
(paren
id|byte
)paren
l_int|1
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DIVA_INIT_TASK_COUNT
op_plus
l_int|1
)braket
op_assign
(paren
id|byte
)paren
id|BaseIoAdapter-&gt;cardType
suffix:semicolon
)brace
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
)braket
op_assign
(paren
id|byte
)paren
id|Addr
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
op_plus
l_int|1
)braket
op_assign
(paren
id|byte
)paren
(paren
id|Addr
op_rshift
l_int|8
)paren
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
op_plus
l_int|2
)braket
op_assign
(paren
id|byte
)paren
(paren
id|Addr
op_rshift
l_int|16
)paren
suffix:semicolon
(paren
(paren
id|byte
op_star
)paren
id|File
)paren
(braket
id|OFFS_DSP_CODE_BASE_ADDR
op_plus
l_int|3
)braket
op_assign
(paren
id|byte
)paren
(paren
id|Addr
op_rshift
l_int|24
)paren
suffix:semicolon
id|IoAdapter-&gt;InitialDspInfo
op_assign
l_int|0x80
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|IoAdapter-&gt;features
op_amp
id|PROTCAP_VOIP
)paren
(brace
id|IoAdapter-&gt;DspCodeBaseAddr
op_assign
id|MQ_CACHED_ADDR
(paren
id|ProtOffset
op_plus
id|SharedRamOffset
op_minus
id|MQ_VOIP_MAX_DSP_CODE_SIZE
)paren
suffix:semicolon
id|IoAdapter-&gt;MaxDspCodeSize
op_assign
id|MQ_VOIP_MAX_DSP_CODE_SIZE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|IoAdapter-&gt;features
op_amp
id|PROTCAP_V90D
)paren
(brace
id|IoAdapter-&gt;DspCodeBaseAddr
op_assign
id|MQ_CACHED_ADDR
(paren
id|ProtOffset
op_plus
id|SharedRamOffset
op_minus
id|MQ_V90D_MAX_DSP_CODE_SIZE
)paren
suffix:semicolon
id|IoAdapter-&gt;MaxDspCodeSize
op_assign
(paren
id|IoAdapter-&gt;ControllerNumber
op_eq
id|tasks
op_minus
l_int|1
)paren
ques
c_cond
id|MQ_V90D_MAX_DSP_CODE_SIZE
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|IoAdapter-&gt;DspCodeBaseAddr
op_assign
id|MQ_CACHED_ADDR
(paren
id|ProtOffset
op_plus
id|SharedRamOffset
op_minus
id|MQ_ORG_MAX_DSP_CODE_SIZE
)paren
suffix:semicolon
id|IoAdapter-&gt;MaxDspCodeSize
op_assign
(paren
id|IoAdapter-&gt;ControllerNumber
op_eq
id|tasks
op_minus
l_int|1
)paren
ques
c_cond
id|MQ_ORG_MAX_DSP_CODE_SIZE
suffix:colon
l_int|0
suffix:semicolon
)brace
id|IoAdapter-&gt;InitialDspInfo
op_assign
(paren
id|MQ_CACHED_ADDR
(paren
id|ProtOffset
op_plus
id|SharedRamOffset
op_minus
id|MQ_ORG_MAX_DSP_CODE_SIZE
)paren
op_minus
id|IoAdapter-&gt;DspCodeBaseAddr
)paren
op_rshift
l_int|14
suffix:semicolon
)brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;%d: DSP code base 0x%08lx, max size 0x%08lx (%08lx,%02x)&quot;
comma
id|IoAdapter-&gt;ControllerNumber
comma
id|IoAdapter-&gt;DspCodeBaseAddr
comma
id|IoAdapter-&gt;MaxDspCodeSize
comma
id|Addr
comma
id|IoAdapter-&gt;InitialDspInfo
)paren
)paren
r_if
c_cond
(paren
id|FileLength
OG
(paren
(paren
id|IoAdapter-&gt;DspCodeBaseAddr
op_minus
id|MQ_CACHED_ADDR
(paren
id|ProtOffset
)paren
)paren
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;Protocol code &squot;%s&squot; too long (%ld)&quot;
comma
op_amp
id|IoAdapter-&gt;Protocol
(braket
l_int|0
)braket
comma
id|FileLength
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|IoAdapter-&gt;downloadAddr
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RAM
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|sharedRam
op_assign
(paren
id|dword
op_star
)paren
op_amp
id|p
(braket
id|IoAdapter-&gt;downloadAddr
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)braket
suffix:semicolon
id|memcpy
(paren
id|sharedRam
comma
id|File
comma
id|FileLength
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Download addr 0x%08x len %ld - virtual 0x%08x&quot;
comma
id|IoAdapter-&gt;downloadAddr
comma
id|FileLength
comma
id|sharedRam
)paren
)paren
r_if
c_cond
(paren
id|memcmp
(paren
id|sharedRam
comma
id|File
comma
id|FileLength
)paren
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: Memory test failed!&quot;
comma
id|IoAdapter-&gt;Properties.Name
)paren
)paren
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;File=0x%x, sharedRam=0x%x&quot;
comma
id|File
comma
id|sharedRam
)paren
)paren
id|DBG_BLK
c_func
(paren
(paren
(paren
r_char
op_star
)paren
id|File
comma
l_int|256
)paren
)paren
id|DBG_BLK
c_func
(paren
(paren
(paren
r_char
op_star
)paren
id|sharedRam
comma
l_int|256
)paren
)paren
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;DSP Code download&n;&t; -------------------------------------------------------------------------- */
DECL|function|qBri_download_buffer
r_static
r_int
id|qBri_download_buffer
(paren
id|OsFileHandle
op_star
id|fp
comma
r_int
id|length
comma
r_void
op_star
op_star
id|addr
)paren
(brace
id|PISDN_ADAPTER
id|BaseIoAdapter
op_assign
(paren
id|PISDN_ADAPTER
)paren
id|fp-&gt;sysLoadDesc
suffix:semicolon
id|PISDN_ADAPTER
id|IoAdapter
suffix:semicolon
id|word
id|i
suffix:semicolon
id|dword
op_star
id|sharedRam
suffix:semicolon
id|byte
op_star
id|p
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|IoAdapter
op_assign
id|BaseIoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
op_increment
)braket
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|i
OL
id|BaseIoAdapter-&gt;tasks
)paren
op_logical_and
(paren
(paren
(paren
id|dword
)paren
id|length
)paren
OG
id|IoAdapter-&gt;DspCodeBaseAddr
op_plus
id|IoAdapter-&gt;MaxDspCodeSize
op_minus
id|IoAdapter-&gt;downloadAddr
)paren
)paren
suffix:semicolon
op_star
id|addr
op_assign
(paren
r_void
op_star
)paren
id|IoAdapter-&gt;downloadAddr
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|dword
)paren
id|length
)paren
OG
id|IoAdapter-&gt;DspCodeBaseAddr
op_plus
id|IoAdapter-&gt;MaxDspCodeSize
op_minus
id|IoAdapter-&gt;downloadAddr
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: out of card memory during DSP download (0x%X)&quot;
comma
id|IoAdapter-&gt;Properties.Name
comma
id|IoAdapter-&gt;downloadAddr
op_plus
id|length
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RAM
c_func
(paren
id|BaseIoAdapter
)paren
suffix:semicolon
id|sharedRam
op_assign
(paren
id|dword
op_star
)paren
op_amp
id|p
(braket
id|IoAdapter-&gt;downloadAddr
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;sysFileRead
(paren
id|fp
comma
id|sharedRam
comma
id|length
)paren
op_ne
id|length
)paren
(brace
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
id|BaseIoAdapter
comma
id|p
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
id|BaseIoAdapter
comma
id|p
)paren
suffix:semicolon
id|IoAdapter-&gt;downloadAddr
op_add_assign
id|length
suffix:semicolon
id|IoAdapter-&gt;downloadAddr
op_assign
(paren
id|IoAdapter-&gt;downloadAddr
op_plus
l_int|3
)paren
op_amp
(paren
op_complement
l_int|3
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
DECL|function|qBri_telindus_load
r_static
id|dword
id|qBri_telindus_load
(paren
id|PISDN_ADAPTER
id|BaseIoAdapter
)paren
(brace
id|PISDN_ADAPTER
id|IoAdapter
op_assign
l_int|0
suffix:semicolon
id|PISDN_ADAPTER
id|HighIoAdapter
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|error
suffix:semicolon
id|OsFileHandle
op_star
id|fp
suffix:semicolon
id|t_dsp_portable_desc
id|download_table
(braket
id|DSP_MAX_DOWNLOAD_COUNT
)braket
suffix:semicolon
id|word
id|download_count
comma
id|i
suffix:semicolon
id|dword
op_star
id|sharedRam
suffix:semicolon
id|dword
id|FileLength
suffix:semicolon
id|byte
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|fp
op_assign
id|OsOpenFile
(paren
id|DSP_TELINDUS_FILE
)paren
)paren
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;qBri_telindus_load: %s not found!&quot;
comma
id|DSP_TELINDUS_FILE
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BaseIoAdapter-&gt;tasks
suffix:semicolon
op_increment
id|i
)paren
(brace
id|IoAdapter
op_assign
id|BaseIoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
suffix:semicolon
id|IoAdapter-&gt;downloadAddr
op_assign
id|IoAdapter-&gt;DspCodeBaseAddr
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;ControllerNumber
op_eq
id|BaseIoAdapter-&gt;tasks
op_minus
l_int|1
)paren
(brace
id|HighIoAdapter
op_assign
id|IoAdapter
suffix:semicolon
id|HighIoAdapter-&gt;downloadAddr
op_assign
(paren
id|HighIoAdapter-&gt;downloadAddr
op_plus
r_sizeof
(paren
id|dword
)paren
op_plus
r_sizeof
(paren
id|download_table
)paren
op_plus
l_int|3
)paren
op_amp
(paren
op_complement
l_int|3
)paren
suffix:semicolon
)brace
)brace
id|FileLength
op_assign
id|fp-&gt;sysFileSize
suffix:semicolon
id|fp-&gt;sysLoadDesc
op_assign
(paren
r_void
op_star
)paren
id|BaseIoAdapter
suffix:semicolon
id|fp-&gt;sysCardLoad
op_assign
id|qBri_download_buffer
suffix:semicolon
id|download_count
op_assign
id|DSP_MAX_DOWNLOAD_COUNT
suffix:semicolon
id|memset
(paren
op_amp
id|download_table
(braket
l_int|0
)braket
comma
l_char|&squot;&bslash;0&squot;
comma
r_sizeof
(paren
id|download_table
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;set start address for download&n; */
id|error
op_assign
id|dsp_read_file
(paren
id|fp
comma
(paren
id|word
)paren
(paren
id|IoAdapter-&gt;cardType
)paren
comma
op_amp
id|download_count
comma
l_int|NULL
comma
op_amp
id|download_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;download file error: %s&quot;
comma
id|error
)paren
)paren
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;store # of download files extracted from the archive and download table&n;&t; */
id|HighIoAdapter-&gt;downloadAddr
op_assign
id|HighIoAdapter-&gt;DspCodeBaseAddr
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RAM
c_func
(paren
id|BaseIoAdapter
)paren
suffix:semicolon
id|sharedRam
op_assign
(paren
id|dword
op_star
)paren
op_amp
id|p
(braket
id|HighIoAdapter-&gt;downloadAddr
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)braket
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
op_amp
(paren
id|sharedRam
(braket
l_int|0
)braket
)paren
comma
(paren
id|dword
)paren
id|download_count
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|sharedRam
(braket
l_int|1
)braket
comma
op_amp
id|download_table
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|download_table
)paren
)paren
suffix:semicolon
multiline_comment|/* memory check */
r_if
c_cond
(paren
id|memcmp
(paren
op_amp
id|sharedRam
(braket
l_int|1
)braket
comma
op_amp
id|download_table
comma
id|download_count
)paren
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: Dsp Memory test failed!&quot;
comma
id|IoAdapter-&gt;Properties.Name
)paren
)paren
)brace
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
id|BaseIoAdapter
comma
id|p
)paren
suffix:semicolon
r_return
(paren
id|FileLength
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;Load SDP tasks to the card&n;&t;Return start address of image on succesful load&n;&t;Return zero in case of problem&n;&n;&t;INPUT:&n;&t;&t;task&t;&t;&t;-&gt;&t;name of the image containing this task&n;&t;&t;link_addr&t;-&gt;&t;pointer to start of previous task&n;&t;*/
DECL|function|qBri_sdp_load
r_static
id|byte
op_star
id|qBri_sdp_load
(paren
id|PISDN_ADAPTER
id|BaseIoAdapter
comma
r_char
op_star
id|task
comma
id|byte
op_star
id|link_addr
)paren
(brace
id|OsFileHandle
op_star
id|fp
suffix:semicolon
id|dword
id|FileLength
suffix:semicolon
id|byte
id|tmp
(braket
r_sizeof
(paren
id|dword
)paren
)braket
suffix:semicolon
id|dword
id|gp_addr
suffix:semicolon
id|dword
id|entry_addr
suffix:semicolon
id|dword
id|start_addr
op_assign
l_int|0
suffix:semicolon
id|dword
id|phys_start_addr
suffix:semicolon
id|dword
id|end_addr
suffix:semicolon
id|byte
op_star
id|sharedRam
op_assign
l_int|0
suffix:semicolon
id|byte
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|task
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|fp
op_assign
id|OsOpenFile
(paren
id|task
)paren
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;Can&squot;t open [%s] image&quot;
comma
id|task
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|FileLength
op_assign
id|fp-&gt;sysFileSize
)paren
OL
id|DIVA_MIPS_TASK_IMAGE_ID_STRING_OFFS
)paren
(brace
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;Image [%s] too short&quot;
comma
id|task
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|fp-&gt;sysFileSeek
(paren
id|fp
comma
id|DIVA_MIPS_TASK_IMAGE_GP_OFFS
comma
id|OS_SEEK_SET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;sysFileRead
(paren
id|fp
comma
id|tmp
comma
r_sizeof
(paren
id|dword
)paren
)paren
op_ne
r_sizeof
(paren
id|dword
)paren
)paren
(brace
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;Can&squot;t read image [%s]&quot;
comma
id|task
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|gp_addr
op_assign
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|0
)braket
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|1
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|2
)braket
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|3
)braket
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Image [%s] GP = %08lx&quot;
comma
id|task
comma
id|gp_addr
)paren
)paren
id|fp-&gt;sysFileSeek
(paren
id|fp
comma
id|DIVA_MIPS_TASK_IMAGE_ENTRY_OFFS
comma
id|OS_SEEK_SET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;sysFileRead
(paren
id|fp
comma
id|tmp
comma
r_sizeof
(paren
id|dword
)paren
)paren
op_ne
r_sizeof
(paren
id|dword
)paren
)paren
(brace
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;Can&squot;t read image [%s]&quot;
comma
id|task
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|entry_addr
op_assign
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|0
)braket
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|1
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|2
)braket
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|3
)braket
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Image [%s] entry = %08lx&quot;
comma
id|task
comma
id|entry_addr
)paren
)paren
id|fp-&gt;sysFileSeek
(paren
id|fp
comma
id|DIVA_MIPS_TASK_IMAGE_LOAD_ADDR_OFFS
comma
id|OS_SEEK_SET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;sysFileRead
(paren
id|fp
comma
id|tmp
comma
r_sizeof
(paren
id|dword
)paren
)paren
op_ne
r_sizeof
(paren
id|dword
)paren
)paren
(brace
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;Can&squot;t read image [%s]&quot;
comma
id|task
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|start_addr
op_assign
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|0
)braket
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|1
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|2
)braket
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|3
)braket
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Image [%s] start = %08lx&quot;
comma
id|task
comma
id|start_addr
)paren
)paren
id|fp-&gt;sysFileSeek
(paren
id|fp
comma
id|DIVA_MIPS_TASK_IMAGE_END_ADDR_OFFS
comma
id|OS_SEEK_SET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;sysFileRead
(paren
id|fp
comma
id|tmp
comma
r_sizeof
(paren
id|dword
)paren
)paren
op_ne
r_sizeof
(paren
id|dword
)paren
)paren
(brace
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;Can&squot;t read image [%s]&quot;
comma
id|task
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|end_addr
op_assign
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|0
)braket
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|1
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|2
)braket
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
(paren
id|dword
)paren
id|tmp
(braket
l_int|3
)braket
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Image [%s] end = %08lx&quot;
comma
id|task
comma
id|end_addr
)paren
)paren
id|phys_start_addr
op_assign
id|start_addr
op_amp
l_int|0x1fffffff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|phys_start_addr
op_plus
id|FileLength
)paren
op_ge
id|BaseIoAdapter-&gt;MemorySize
)paren
(brace
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;Image [%s] too long&quot;
comma
id|task
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|fp-&gt;sysFileSeek
(paren
id|fp
comma
l_int|0
comma
id|OS_SEEK_SET
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RAM
c_func
(paren
id|BaseIoAdapter
)paren
suffix:semicolon
id|sharedRam
op_assign
op_amp
id|p
(braket
id|phys_start_addr
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dword
)paren
id|fp-&gt;sysFileRead
(paren
id|fp
comma
id|sharedRam
comma
id|FileLength
)paren
op_ne
id|FileLength
)paren
(brace
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
id|BaseIoAdapter
comma
id|p
)paren
suffix:semicolon
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;Can&squot;t read image [%s]&quot;
comma
id|task
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
id|BaseIoAdapter
comma
id|p
)paren
suffix:semicolon
id|OsCloseFile
(paren
id|fp
)paren
suffix:semicolon
)brace
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RAM
c_func
(paren
id|BaseIoAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link_addr
)paren
(brace
id|link_addr
op_assign
op_amp
id|p
(braket
id|OFFS_DSP_CODE_BASE_ADDR
)braket
suffix:semicolon
)brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Write task [%s] link %08lx at %08lx&quot;
comma
id|task
ques
c_cond
id|task
suffix:colon
l_string|&quot;none&quot;
comma
id|start_addr
comma
id|link_addr
op_minus
(paren
id|byte
op_star
)paren
op_amp
id|BaseIoAdapter-&gt;ram
(braket
l_int|0
)braket
)paren
)paren
id|link_addr
(braket
l_int|0
)braket
op_assign
(paren
id|byte
)paren
(paren
id|start_addr
op_amp
l_int|0xff
)paren
suffix:semicolon
id|link_addr
(braket
l_int|1
)braket
op_assign
(paren
id|byte
)paren
(paren
(paren
id|start_addr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|link_addr
(braket
l_int|2
)braket
op_assign
(paren
id|byte
)paren
(paren
(paren
id|start_addr
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|link_addr
(braket
l_int|3
)braket
op_assign
(paren
id|byte
)paren
(paren
(paren
id|start_addr
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
id|BaseIoAdapter
comma
id|p
)paren
suffix:semicolon
r_return
(paren
id|task
ques
c_cond
op_amp
id|sharedRam
(braket
id|DIVA_MIPS_TASK_IMAGE_LINK_OFFS
)braket
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Load Card&n;&t; -------------------------------------------------------------------------- */
DECL|function|load_qBri_hardware
r_static
r_int
id|load_qBri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
id|i
comma
id|offset
comma
id|controller
suffix:semicolon
id|word
op_star
id|signature
suffix:semicolon
r_int
id|factor
op_assign
(paren
id|IoAdapter-&gt;tasks
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
id|byte
op_star
id|p
suffix:semicolon
id|PISDN_ADAPTER
id|Slave
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;QuadroList
op_logical_or
(paren
(paren
id|IoAdapter-&gt;cardType
op_ne
id|CARDTYPE_DIVASRV_Q_8M_PCI
)paren
op_logical_and
(paren
id|IoAdapter-&gt;cardType
op_ne
id|CARDTYPE_DIVASRV_VOICE_Q_8M_PCI
)paren
op_logical_and
(paren
id|IoAdapter-&gt;cardType
op_ne
id|CARDTYPE_DIVASRV_Q_8M_V2_PCI
)paren
op_logical_and
(paren
id|IoAdapter-&gt;cardType
op_ne
id|CARDTYPE_DIVASRV_VOICE_Q_8M_V2_PCI
)paren
op_logical_and
(paren
id|IoAdapter-&gt;cardType
op_ne
id|CARDTYPE_DIVASRV_B_2M_V2_PCI
)paren
op_logical_and
(paren
id|IoAdapter-&gt;cardType
op_ne
id|CARDTYPE_DIVASRV_VOICE_B_2M_V2_PCI
)paren
op_logical_and
(paren
id|IoAdapter-&gt;cardType
op_ne
id|CARDTYPE_DIVASRV_B_2F_PCI
)paren
)paren
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Check for first instance&n; */
r_if
c_cond
(paren
id|IoAdapter-&gt;ControllerNumber
OG
l_int|0
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;first initialize the onboard FPGA&n; */
r_if
c_cond
(paren
op_logical_neg
id|qBri_FPGA_download
(paren
id|IoAdapter
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IoAdapter-&gt;tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Slave
op_assign
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
suffix:semicolon
id|Slave-&gt;fpga_features
op_assign
id|IoAdapter-&gt;fpga_features
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;download protocol code for all instances&n; */
id|controller
op_assign
id|IoAdapter-&gt;tasks
suffix:semicolon
r_do
(brace
id|controller
op_decrement
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|ControllerNumber
op_ne
id|controller
)paren
id|i
op_increment
suffix:semicolon
multiline_comment|/*&n; *&t;calculate base address for instance&n; */
id|Slave
op_assign
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
suffix:semicolon
id|offset
op_assign
id|Slave-&gt;ControllerNumber
op_star
(paren
id|IoAdapter-&gt;MemorySize
op_rshift
id|factor
)paren
suffix:semicolon
id|Slave-&gt;Address
op_assign
op_amp
id|IoAdapter-&gt;Address
(braket
id|offset
)braket
suffix:semicolon
id|Slave-&gt;ram
op_assign
op_amp
id|IoAdapter-&gt;ram
(braket
id|offset
)braket
suffix:semicolon
id|Slave-&gt;reset
op_assign
id|IoAdapter-&gt;reset
suffix:semicolon
id|Slave-&gt;ctlReg
op_assign
id|IoAdapter-&gt;ctlReg
suffix:semicolon
id|Slave-&gt;prom
op_assign
id|IoAdapter-&gt;prom
suffix:semicolon
id|Slave-&gt;Config
op_assign
id|IoAdapter-&gt;Config
suffix:semicolon
id|Slave-&gt;Control
op_assign
id|IoAdapter-&gt;Control
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qBri_protocol_load
(paren
id|IoAdapter
comma
id|Slave
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|controller
op_ne
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;download only one copy of the DSP code&n; */
r_if
c_cond
(paren
id|IoAdapter-&gt;cardType
op_ne
id|CARDTYPE_DIVASRV_B_2F_PCI
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|qBri_telindus_load
(paren
id|IoAdapter
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|byte
op_star
id|link_addr
op_assign
l_int|0
suffix:semicolon
id|link_addr
op_assign
id|qBri_sdp_load
(paren
id|IoAdapter
comma
id|DIVA_BRI2F_SDP_1_NAME
comma
id|link_addr
)paren
suffix:semicolon
id|link_addr
op_assign
id|qBri_sdp_load
(paren
id|IoAdapter
comma
id|DIVA_BRI2F_SDP_2_NAME
comma
id|link_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link_addr
)paren
(brace
id|qBri_sdp_load
(paren
id|IoAdapter
comma
l_int|0
comma
id|link_addr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;copy configuration parameters&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IoAdapter-&gt;tasks
suffix:semicolon
op_increment
id|i
)paren
(brace
id|Slave
op_assign
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
suffix:semicolon
id|Slave-&gt;ram
op_add_assign
(paren
id|IoAdapter-&gt;MemorySize
op_rshift
id|factor
)paren
op_minus
id|MQ_SHARED_RAM_SIZE
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RAM
c_func
(paren
id|Slave
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Configure instance %d shared memory @ 0x%08lx&quot;
comma
id|Slave-&gt;ControllerNumber
comma
id|p
)paren
)paren
id|memset
(paren
id|p
comma
l_char|&squot;&bslash;0&squot;
comma
l_int|256
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
id|Slave
comma
id|p
)paren
suffix:semicolon
id|diva_configure_protocol
(paren
id|Slave
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;start adapter&n; */
id|start_qBri_hardware
(paren
id|IoAdapter
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RAM
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|signature
op_assign
(paren
id|word
op_star
)paren
(paren
op_amp
id|p
(braket
l_int|0x1E
)braket
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;wait for signature in shared memory (max. 3 seconds)&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|300
suffix:semicolon
op_increment
id|i
)paren
(brace
id|diva_os_wait
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signature
(braket
l_int|0
)braket
op_eq
l_int|0x4447
)paren
(brace
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Protocol startup time %d.%02d seconds&quot;
comma
(paren
id|i
op_div
l_int|100
)paren
comma
(paren
id|i
op_mod
l_int|100
)paren
)paren
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: Adapter selftest failed (0x%04X)!&quot;
comma
id|IoAdapter-&gt;Properties.Name
comma
id|signature
(braket
l_int|0
)braket
op_rshift
l_int|16
)paren
)paren
id|qBri_cpu_trapped
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
macro_line|#else /* } { */
DECL|function|load_qBri_hardware
r_static
r_int
id|load_qBri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif /* } */
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Card ISR&n;&t; -------------------------------------------------------------------------- */
DECL|function|qBri_ISR
r_static
r_int
id|qBri_ISR
(paren
r_struct
id|_ISDN_ADAPTER
op_star
id|IoAdapter
)paren
(brace
id|dword
r_volatile
id|__iomem
op_star
id|qBriIrq
suffix:semicolon
id|PADAPTER_LIST_ENTRY
id|QuadroList
op_assign
id|IoAdapter-&gt;QuadroList
suffix:semicolon
id|word
id|i
suffix:semicolon
r_int
id|serviced
op_assign
l_int|0
suffix:semicolon
id|byte
id|__iomem
op_star
id|p
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
(braket
id|PLX9054_INTCSR
)braket
op_amp
l_int|0x80
)paren
)paren
(brace
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;clear interrupt line (reset Local Interrupt Test Register)&n; */
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|qBriIrq
op_assign
(paren
id|dword
r_volatile
id|__iomem
op_star
)paren
(paren
op_amp
id|p
(braket
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
ques
c_cond
(paren
id|MQ2_BREG_IRQ_TEST
)paren
suffix:colon
(paren
id|MQ_BREG_IRQ_TEST
)paren
)braket
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriIrq
comma
id|MQ_IRQ_REQ_OFF
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IoAdapter-&gt;tasks
suffix:semicolon
op_increment
id|i
)paren
(brace
id|IoAdapter
op_assign
id|QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter
op_logical_and
id|IoAdapter-&gt;Initialized
op_logical_and
id|IoAdapter-&gt;tst_irq
(paren
op_amp
id|IoAdapter-&gt;a
)paren
)paren
(brace
id|IoAdapter-&gt;IrqCount
op_increment
suffix:semicolon
id|serviced
op_assign
l_int|1
suffix:semicolon
id|diva_os_schedule_soft_isr
(paren
op_amp
id|IoAdapter-&gt;isr_soft_isr
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|serviced
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Does disable the interrupt on the card&n;&t; -------------------------------------------------------------------------- */
DECL|function|disable_qBri_interrupt
r_static
r_void
id|disable_qBri_interrupt
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
r_volatile
id|__iomem
op_star
id|qBriIrq
suffix:semicolon
id|byte
id|__iomem
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;ControllerNumber
OG
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/*&n; *&t;clear interrupt line (reset Local Interrupt Test Register)&n; */
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|p
(braket
id|PLX9054_INTCSR
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* disable PCI interrupts */
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|qBriIrq
op_assign
(paren
id|dword
r_volatile
id|__iomem
op_star
)paren
(paren
op_amp
id|p
(braket
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
ques
c_cond
(paren
id|MQ2_BREG_IRQ_TEST
)paren
suffix:colon
(paren
id|MQ_BREG_IRQ_TEST
)paren
)braket
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriIrq
comma
id|MQ_IRQ_REQ_OFF
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Install Adapter Entry Points&n;&t; -------------------------------------------------------------------------- */
DECL|function|set_common_qBri_functions
r_static
r_void
id|set_common_qBri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|ADAPTER
op_star
id|a
suffix:semicolon
id|a
op_assign
op_amp
id|IoAdapter-&gt;a
suffix:semicolon
id|a-&gt;ram_in
op_assign
id|mem_in
suffix:semicolon
id|a-&gt;ram_inw
op_assign
id|mem_inw
suffix:semicolon
id|a-&gt;ram_in_buffer
op_assign
id|mem_in_buffer
suffix:semicolon
id|a-&gt;ram_look_ahead
op_assign
id|mem_look_ahead
suffix:semicolon
id|a-&gt;ram_out
op_assign
id|mem_out
suffix:semicolon
id|a-&gt;ram_outw
op_assign
id|mem_outw
suffix:semicolon
id|a-&gt;ram_out_buffer
op_assign
id|mem_out_buffer
suffix:semicolon
id|a-&gt;ram_inc
op_assign
id|mem_inc
suffix:semicolon
id|IoAdapter-&gt;out
op_assign
id|pr_out
suffix:semicolon
id|IoAdapter-&gt;dpc
op_assign
id|pr_dpc
suffix:semicolon
id|IoAdapter-&gt;tst_irq
op_assign
id|scom_test_int
suffix:semicolon
id|IoAdapter-&gt;clr_irq
op_assign
id|scom_clear_int
suffix:semicolon
id|IoAdapter-&gt;pcm
op_assign
(paren
r_struct
id|pc_maint
op_star
)paren
id|MIPS_MAINT_OFFS
suffix:semicolon
id|IoAdapter-&gt;load
op_assign
id|load_qBri_hardware
suffix:semicolon
id|IoAdapter-&gt;disIrq
op_assign
id|disable_qBri_interrupt
suffix:semicolon
id|IoAdapter-&gt;rstFnc
op_assign
id|reset_qBri_hardware
suffix:semicolon
id|IoAdapter-&gt;stop
op_assign
id|stop_qBri_hardware
suffix:semicolon
id|IoAdapter-&gt;trapFnc
op_assign
id|qBri_cpu_trapped
suffix:semicolon
id|IoAdapter-&gt;diva_isr_handler
op_assign
id|qBri_ISR
suffix:semicolon
id|IoAdapter-&gt;a.io
op_assign
(paren
r_void
op_star
)paren
id|IoAdapter
suffix:semicolon
)brace
DECL|function|set_qBri_functions
r_static
r_void
id|set_qBri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;tasks
)paren
(brace
id|IoAdapter-&gt;tasks
op_assign
id|MQ_INSTANCE_COUNT
suffix:semicolon
)brace
id|IoAdapter-&gt;MemorySize
op_assign
id|MQ_MEMORY_SIZE
suffix:semicolon
id|set_common_qBri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
id|diva_os_set_qBri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
)brace
DECL|function|set_qBri2_functions
r_static
r_void
id|set_qBri2_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;tasks
)paren
(brace
id|IoAdapter-&gt;tasks
op_assign
id|MQ_INSTANCE_COUNT
suffix:semicolon
)brace
id|IoAdapter-&gt;MemorySize
op_assign
(paren
id|IoAdapter-&gt;tasks
op_eq
l_int|1
)paren
ques
c_cond
id|BRI2_MEMORY_SIZE
suffix:colon
id|MQ2_MEMORY_SIZE
suffix:semicolon
id|set_common_qBri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
id|diva_os_set_qBri2_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
DECL|function|prepare_qBri_functions
r_void
id|prepare_qBri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|set_qBri_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|set_qBri_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|set_qBri_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|set_qBri_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
DECL|function|prepare_qBri2_functions
r_void
id|prepare_qBri2_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;tasks
)paren
(brace
id|IoAdapter-&gt;tasks
op_assign
id|MQ_INSTANCE_COUNT
suffix:semicolon
)brace
id|set_qBri2_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;tasks
OG
l_int|1
)paren
(brace
id|set_qBri2_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|set_qBri2_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|set_qBri2_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* -------------------------------------------------------------------------- */
eof
