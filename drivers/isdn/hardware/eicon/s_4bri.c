multiline_comment|/*&n; *&n;  Copyright (c) Eicon Networks, 2002.&n; *&n;  This source file is supplied for the use with&n;  Eicon Networks range of DIVA Server Adapters.&n; *&n;  Eicon File Revision :    2.1&n; *&n;  This program is free software; you can redistribute it and/or modify&n;  it under the terms of the GNU General Public License as published by&n;  the Free Software Foundation; either version 2, or (at your option)&n;  any later version.&n; *&n;  This program is distributed in the hope that it will be useful,&n;  but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY&n;  implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n;  See the GNU General Public License for more details.&n; *&n;  You should have received a copy of the GNU General Public License&n;  along with this program; if not, write to the Free Software&n;  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;di_defs.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;di.h&quot;
macro_line|#include &quot;mi_pc.h&quot;
macro_line|#include &quot;pc_maint.h&quot;
macro_line|#include &quot;divasync.h&quot;
macro_line|#include &quot;pc_init.h&quot;
macro_line|#include &quot;io.h&quot;
macro_line|#include &quot;helpers.h&quot;
macro_line|#include &quot;dsrv4bri.h&quot;
macro_line|#include &quot;dsp_defs.h&quot;
macro_line|#include &quot;sdp_hdr.h&quot;
multiline_comment|/*****************************************************************************/
DECL|macro|MAX_XLOG_SIZE
mdefine_line|#define&t;MAX_XLOG_SIZE&t;(64 * 1024)
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Recovery XLOG from QBRI Card&n;&t; -------------------------------------------------------------------------- */
DECL|function|qBri_cpu_trapped
r_static
r_void
id|qBri_cpu_trapped
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
id|__iomem
op_star
id|base
suffix:semicolon
id|word
op_star
id|Xlog
suffix:semicolon
id|dword
id|regs
(braket
l_int|4
)braket
comma
id|TrapID
comma
id|offset
comma
id|size
suffix:semicolon
id|Xdesc
id|xlogDesc
suffix:semicolon
r_int
id|factor
op_assign
(paren
id|IoAdapter-&gt;tasks
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/*&n; *&t;check for trapped MIPS 46xx CPU, dump exception frame&n; */
id|base
op_assign
id|DIVA_OS_MEM_ATTACH_CONTROL
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|offset
op_assign
id|IoAdapter-&gt;ControllerNumber
op_star
(paren
id|IoAdapter-&gt;MemorySize
op_rshift
id|factor
)paren
suffix:semicolon
id|TrapID
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|base
(braket
l_int|0x80
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|TrapID
op_eq
l_int|0x99999999
)paren
op_logical_or
(paren
id|TrapID
op_eq
l_int|0x99999901
)paren
)paren
(brace
id|dump_trap_frame
(paren
id|IoAdapter
comma
op_amp
id|base
(braket
l_int|0x90
)braket
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|1
suffix:semicolon
)brace
id|regs
(braket
l_int|0
)braket
op_assign
id|READ_DWORD
c_func
(paren
(paren
id|base
op_plus
id|offset
)paren
op_plus
l_int|0x70
)paren
suffix:semicolon
id|regs
(braket
l_int|1
)braket
op_assign
id|READ_DWORD
c_func
(paren
(paren
id|base
op_plus
id|offset
)paren
op_plus
l_int|0x74
)paren
suffix:semicolon
id|regs
(braket
l_int|2
)braket
op_assign
id|READ_DWORD
c_func
(paren
(paren
id|base
op_plus
id|offset
)paren
op_plus
l_int|0x78
)paren
suffix:semicolon
id|regs
(braket
l_int|3
)braket
op_assign
id|READ_DWORD
c_func
(paren
(paren
id|base
op_plus
id|offset
)paren
op_plus
l_int|0x7c
)paren
suffix:semicolon
id|regs
(braket
l_int|0
)braket
op_and_assign
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|regs
(braket
l_int|0
)braket
op_ge
id|offset
)paren
op_logical_and
(paren
id|regs
(braket
l_int|0
)braket
OL
id|offset
op_plus
(paren
id|IoAdapter-&gt;MemorySize
op_rshift
id|factor
)paren
op_minus
l_int|1
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|Xlog
op_assign
(paren
id|word
op_star
)paren
id|diva_os_malloc
(paren
l_int|0
comma
id|MAX_XLOG_SIZE
)paren
)paren
)paren
(brace
id|DIVA_OS_MEM_DETACH_CONTROL
c_func
(paren
id|IoAdapter
comma
id|base
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|size
op_assign
id|offset
op_plus
(paren
id|IoAdapter-&gt;MemorySize
op_rshift
id|factor
)paren
op_minus
id|regs
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|MAX_XLOG_SIZE
)paren
id|size
op_assign
id|MAX_XLOG_SIZE
suffix:semicolon
id|memcpy_fromio
(paren
id|Xlog
comma
op_amp
id|base
(braket
id|regs
(braket
l_int|0
)braket
)braket
comma
id|size
)paren
suffix:semicolon
id|xlogDesc.buf
op_assign
id|Xlog
suffix:semicolon
id|xlogDesc.cnt
op_assign
id|READ_WORD
c_func
(paren
op_amp
id|base
(braket
id|regs
(braket
l_int|1
)braket
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)braket
)paren
suffix:semicolon
id|xlogDesc.out
op_assign
id|READ_WORD
c_func
(paren
op_amp
id|base
(braket
id|regs
(braket
l_int|2
)braket
op_amp
(paren
id|IoAdapter-&gt;MemorySize
op_minus
l_int|1
)paren
)braket
)paren
suffix:semicolon
id|dump_xlog_buffer
(paren
id|IoAdapter
comma
op_amp
id|xlogDesc
)paren
suffix:semicolon
id|diva_os_free
(paren
l_int|0
comma
id|Xlog
)paren
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|2
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_CONTROL
c_func
(paren
id|IoAdapter
comma
id|base
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Reset QBRI Hardware&n;&t; -------------------------------------------------------------------------- */
DECL|function|reset_qBri_hardware
r_static
r_void
id|reset_qBri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|word
r_volatile
id|__iomem
op_star
id|qBriReset
suffix:semicolon
id|byte
r_volatile
id|__iomem
op_star
id|qBriCntrl
suffix:semicolon
id|byte
r_volatile
id|__iomem
op_star
id|p
suffix:semicolon
id|qBriReset
op_assign
(paren
id|word
r_volatile
id|__iomem
op_star
)paren
id|DIVA_OS_MEM_ATTACH_PROM
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|qBriReset
comma
id|READ_WORD
c_func
(paren
id|qBriReset
)paren
op_or
id|PLX9054_SOFT_RESET
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|qBriReset
comma
id|READ_WORD
c_func
(paren
id|qBriReset
)paren
op_amp
op_complement
id|PLX9054_SOFT_RESET
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|qBriReset
comma
id|READ_WORD
c_func
(paren
id|qBriReset
)paren
op_or
id|PLX9054_RELOAD_EEPROM
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|qBriReset
comma
id|READ_WORD
c_func
(paren
id|qBriReset
)paren
op_amp
op_complement
id|PLX9054_RELOAD_EEPROM
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_PROM
c_func
(paren
id|IoAdapter
comma
id|qBriReset
)paren
suffix:semicolon
id|qBriCntrl
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|qBriCntrl
(braket
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
ques
c_cond
(paren
id|MQ2_BREG_RISC
)paren
suffix:colon
(paren
id|MQ_BREG_RISC
)paren
)braket
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|qBriCntrl
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;resetted board @ reset addr 0x%08lx&quot;
comma
id|qBriReset
)paren
)paren
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;resetted board @ cntrl addr 0x%08lx&quot;
comma
id|p
)paren
)paren
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Start Card CPU&n;&t; -------------------------------------------------------------------------- */
DECL|function|start_qBri_hardware
r_void
id|start_qBri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
r_volatile
id|__iomem
op_star
id|qBriReset
suffix:semicolon
id|byte
r_volatile
id|__iomem
op_star
id|p
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|qBriReset
op_assign
op_amp
id|p
(braket
(paren
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
)paren
ques
c_cond
(paren
id|MQ2_BREG_RISC
)paren
suffix:colon
(paren
id|MQ_BREG_RISC
)paren
)braket
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriReset
comma
id|MQ_RISC_COLD_RESET_MASK
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|2
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriReset
comma
id|MQ_RISC_WARM_RESET_MASK
op_or
id|MQ_RISC_COLD_RESET_MASK
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|10
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;started processor @ addr 0x%08lx&quot;
comma
id|qBriReset
)paren
)paren
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Stop Card CPU&n;&t; -------------------------------------------------------------------------- */
DECL|function|stop_qBri_hardware
r_static
r_void
id|stop_qBri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
r_volatile
id|__iomem
op_star
id|p
suffix:semicolon
id|dword
r_volatile
id|__iomem
op_star
id|qBriReset
suffix:semicolon
id|dword
r_volatile
id|__iomem
op_star
id|qBriIrq
suffix:semicolon
id|dword
r_volatile
id|__iomem
op_star
id|qBriIsacDspReset
suffix:semicolon
r_int
id|rev2
op_assign
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_int
id|reset_offset
op_assign
id|rev2
ques
c_cond
(paren
id|MQ2_BREG_RISC
)paren
suffix:colon
(paren
id|MQ_BREG_RISC
)paren
suffix:semicolon
r_int
id|irq_offset
op_assign
id|rev2
ques
c_cond
(paren
id|MQ2_BREG_IRQ_TEST
)paren
suffix:colon
(paren
id|MQ_BREG_IRQ_TEST
)paren
suffix:semicolon
r_int
id|hw_offset
op_assign
id|rev2
ques
c_cond
(paren
id|MQ2_ISAC_DSP_RESET
)paren
suffix:colon
(paren
id|MQ_ISAC_DSP_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;ControllerNumber
OG
l_int|0
)paren
r_return
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|qBriReset
op_assign
(paren
id|dword
r_volatile
id|__iomem
op_star
)paren
op_amp
id|p
(braket
id|reset_offset
)braket
suffix:semicolon
id|qBriIsacDspReset
op_assign
(paren
id|dword
r_volatile
id|__iomem
op_star
)paren
op_amp
id|p
(braket
id|hw_offset
)braket
suffix:semicolon
multiline_comment|/*&n; *&t;clear interrupt line (reset Local Interrupt Test Register)&n; */
id|WRITE_DWORD
c_func
(paren
id|qBriReset
comma
l_int|0
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriIsacDspReset
comma
l_int|0
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_BYTE
c_func
(paren
op_amp
id|p
(braket
id|PLX9054_INTCSR
)braket
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* disable PCI interrupts */
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|qBriIrq
op_assign
(paren
id|dword
r_volatile
id|__iomem
op_star
)paren
op_amp
id|p
(braket
id|irq_offset
)braket
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriIrq
comma
id|MQ_IRQ_REQ_OFF
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;stopped processor @ addr 0x%08lx&quot;
comma
id|qBriReset
)paren
)paren
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;FPGA download&n;&t; -------------------------------------------------------------------------- */
DECL|macro|FPGA_NAME_OFFSET
mdefine_line|#define FPGA_NAME_OFFSET         0x10
DECL|function|qBri_check_FPGAsrc
r_static
id|byte
op_star
id|qBri_check_FPGAsrc
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
r_char
op_star
id|FileName
comma
id|dword
op_star
id|Length
comma
id|dword
op_star
id|code
)paren
(brace
id|byte
op_star
id|File
suffix:semicolon
r_char
op_star
id|fpgaFile
comma
op_star
id|fpgaType
comma
op_star
id|fpgaDate
comma
op_star
id|fpgaTime
suffix:semicolon
id|dword
id|fpgaFlen
comma
id|fpgaTlen
comma
id|fpgaDlen
comma
id|cnt
comma
id|year
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|File
op_assign
(paren
id|byte
op_star
)paren
id|xdiLoadFile
(paren
id|FileName
comma
id|Length
comma
l_int|0
)paren
)paren
)paren
(brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t; scan file until FF and put id string into buffer&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|File
(braket
id|i
)braket
op_ne
l_int|0xff
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_increment
id|i
op_ge
op_star
id|Length
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;FPGA download: start of data header not found&quot;
)paren
)paren
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
op_star
id|code
op_assign
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|File
(braket
id|i
)braket
op_amp
l_int|0xF0
)paren
op_ne
l_int|0x20
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;FPGA download: data header corrupted&quot;
)paren
)paren
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|fpgaFlen
op_assign
(paren
id|dword
)paren
id|File
(braket
id|FPGA_NAME_OFFSET
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fpgaFlen
op_eq
l_int|0
)paren
id|fpgaFlen
op_assign
l_int|12
suffix:semicolon
id|fpgaFile
op_assign
(paren
r_char
op_star
)paren
op_amp
id|File
(braket
id|FPGA_NAME_OFFSET
)braket
suffix:semicolon
id|fpgaTlen
op_assign
(paren
id|dword
)paren
id|fpgaFile
(braket
id|fpgaFlen
op_plus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fpgaTlen
op_eq
l_int|0
)paren
id|fpgaTlen
op_assign
l_int|10
suffix:semicolon
id|fpgaType
op_assign
(paren
r_char
op_star
)paren
op_amp
id|fpgaFile
(braket
id|fpgaFlen
op_plus
l_int|3
)braket
suffix:semicolon
id|fpgaDlen
op_assign
(paren
id|dword
)paren
id|fpgaType
(braket
id|fpgaTlen
op_plus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fpgaDlen
op_eq
l_int|0
)paren
id|fpgaDlen
op_assign
l_int|11
suffix:semicolon
id|fpgaDate
op_assign
(paren
r_char
op_star
)paren
op_amp
id|fpgaType
(braket
id|fpgaTlen
op_plus
l_int|3
)braket
suffix:semicolon
id|fpgaTime
op_assign
(paren
r_char
op_star
)paren
op_amp
id|fpgaDate
(braket
id|fpgaDlen
op_plus
l_int|3
)braket
suffix:semicolon
id|cnt
op_assign
(paren
id|dword
)paren
(paren
(paren
(paren
id|File
(braket
id|i
)braket
op_amp
l_int|0x0F
)paren
op_lshift
l_int|20
)paren
op_plus
(paren
id|File
(braket
id|i
op_plus
l_int|1
)braket
op_lshift
l_int|12
)paren
op_plus
(paren
id|File
(braket
id|i
op_plus
l_int|2
)braket
op_lshift
l_int|4
)paren
op_plus
(paren
id|File
(braket
id|i
op_plus
l_int|3
)braket
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dword
)paren
(paren
id|i
op_plus
(paren
id|cnt
op_div
l_int|8
)paren
)paren
OG
op_star
id|Length
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;FPGA download: &squot;%s&squot; file too small (%ld &lt; %ld)&quot;
comma
id|FileName
comma
op_star
id|Length
comma
id|code
op_plus
(paren
(paren
id|cnt
op_plus
l_int|7
)paren
op_div
l_int|8
)paren
)paren
)paren
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
id|i
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_while
c_loop
(paren
(paren
id|fpgaDate
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_logical_and
(paren
(paren
id|fpgaDate
(braket
id|i
)braket
OL
l_char|&squot;0&squot;
)paren
op_logical_or
(paren
id|fpgaDate
(braket
id|i
)braket
OG
l_char|&squot;9&squot;
)paren
)paren
)paren
(brace
id|i
op_increment
suffix:semicolon
)brace
id|year
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|fpgaDate
(braket
id|i
)braket
op_ge
l_char|&squot;0&squot;
)paren
op_logical_and
(paren
id|fpgaDate
(braket
id|i
)braket
op_le
l_char|&squot;9&squot;
)paren
)paren
id|year
op_assign
id|year
op_star
l_int|10
op_plus
(paren
id|fpgaDate
(braket
id|i
op_increment
)braket
op_minus
l_char|&squot;0&squot;
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|year
OL
l_int|2000
)paren
op_logical_and
(paren
id|fpgaDate
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|IoAdapter-&gt;cardType
)paren
(brace
r_case
id|CARDTYPE_DIVASRV_B_2F_PCI
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|year
op_ge
l_int|2001
)paren
(brace
id|IoAdapter-&gt;fpga_features
op_or_assign
id|PCINIT_FPGA_PLX_ACCESS_SUPPORTED
suffix:semicolon
)brace
)brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;FPGA[%s] file %s (%s %s) len %d&quot;
comma
id|fpgaType
comma
id|fpgaFile
comma
id|fpgaDate
comma
id|fpgaTime
comma
id|cnt
)paren
)paren
r_return
(paren
id|File
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
DECL|macro|FPGA_PROG
mdefine_line|#define FPGA_PROG   0x0001&t;&t;/* PROG enable low */
DECL|macro|FPGA_BUSY
mdefine_line|#define FPGA_BUSY   0x0002&t;&t;/* BUSY high, DONE low */
DECL|macro|FPGA_CS
mdefine_line|#define&t;FPGA_CS     0x000C&t;&t;/* Enable I/O pins */
DECL|macro|FPGA_CCLK
mdefine_line|#define FPGA_CCLK   0x0100
DECL|macro|FPGA_DOUT
mdefine_line|#define FPGA_DOUT   0x0400
DECL|macro|FPGA_DIN
mdefine_line|#define FPGA_DIN    FPGA_DOUT   /* bidirectional I/O */
DECL|function|qBri_FPGA_download
r_int
id|qBri_FPGA_download
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_int
id|bit
suffix:semicolon
id|byte
op_star
id|File
suffix:semicolon
id|dword
id|code
comma
id|FileLength
suffix:semicolon
id|word
r_volatile
id|__iomem
op_star
id|addr
op_assign
(paren
id|word
r_volatile
id|__iomem
op_star
)paren
id|DIVA_OS_MEM_ATTACH_PROM
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|word
id|val
comma
id|baseval
op_assign
id|FPGA_CS
op_or
id|FPGA_PROG
suffix:semicolon
r_if
c_cond
(paren
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
)paren
(brace
r_char
op_star
id|name
suffix:semicolon
r_switch
c_cond
(paren
id|IoAdapter-&gt;cardType
)paren
(brace
r_case
id|CARDTYPE_DIVASRV_B_2F_PCI
suffix:colon
id|name
op_assign
l_string|&quot;dsbri2f.bit&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CARDTYPE_DIVASRV_B_2M_V2_PCI
suffix:colon
r_case
id|CARDTYPE_DIVASRV_VOICE_B_2M_V2_PCI
suffix:colon
id|name
op_assign
l_string|&quot;dsbri2m.bit&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|name
op_assign
l_string|&quot;ds4bri2.bit&quot;
suffix:semicolon
)brace
id|File
op_assign
id|qBri_check_FPGAsrc
(paren
id|IoAdapter
comma
id|name
comma
op_amp
id|FileLength
comma
op_amp
id|code
)paren
suffix:semicolon
)brace
r_else
(brace
id|File
op_assign
id|qBri_check_FPGAsrc
(paren
id|IoAdapter
comma
l_string|&quot;ds4bri.bit&quot;
comma
op_amp
id|FileLength
comma
op_amp
id|code
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|File
)paren
(brace
id|DIVA_OS_MEM_DETACH_PROM
c_func
(paren
id|IoAdapter
comma
id|addr
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;prepare download, pulse PROGRAM pin down.&n; */
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
op_amp
op_complement
id|FPGA_PROG
)paren
suffix:semicolon
multiline_comment|/* PROGRAM low pulse */
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
)paren
suffix:semicolon
multiline_comment|/* release */
id|diva_os_wait
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* wait until FPGA finished internal memory clear */
multiline_comment|/*&n; *&t;check done pin, must be low&n; */
r_if
c_cond
(paren
id|READ_WORD
c_func
(paren
id|addr
)paren
op_amp
id|FPGA_BUSY
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;FPGA download: acknowledge for FPGA memory clear missing&quot;
)paren
)paren
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_PROM
c_func
(paren
id|IoAdapter
comma
id|addr
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;put data onto the FPGA&n; */
r_while
c_loop
(paren
id|code
OL
id|FileLength
)paren
(brace
id|val
op_assign
(paren
(paren
id|word
)paren
id|File
(braket
id|code
op_increment
)braket
)paren
op_lshift
l_int|3
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|8
suffix:semicolon
id|bit
op_decrement
OG
l_int|0
suffix:semicolon
id|val
op_lshift_assign
l_int|1
)paren
multiline_comment|/* put byte onto FPGA */
(brace
id|baseval
op_and_assign
op_complement
id|FPGA_DOUT
suffix:semicolon
multiline_comment|/* clr  data bit */
id|baseval
op_or_assign
(paren
id|val
op_amp
id|FPGA_DOUT
)paren
suffix:semicolon
multiline_comment|/* copy data bit */
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
op_or
id|FPGA_CCLK
)paren
suffix:semicolon
multiline_comment|/* set CCLK hi */
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
op_or
id|FPGA_CCLK
)paren
suffix:semicolon
multiline_comment|/* set CCLK hi */
id|WRITE_WORD
c_func
(paren
id|addr
comma
id|baseval
)paren
suffix:semicolon
multiline_comment|/* set CCLK lo */
)brace
)brace
id|xdiFreeFile
(paren
id|File
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|100
)paren
suffix:semicolon
id|val
op_assign
id|READ_WORD
c_func
(paren
id|addr
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_PROM
c_func
(paren
id|IoAdapter
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|FPGA_BUSY
)paren
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;FPGA download: chip remains in busy state (0x%04x)&quot;
comma
id|val
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|load_qBri_hardware
r_static
r_int
id|load_qBri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Card ISR&n;&t; -------------------------------------------------------------------------- */
DECL|function|qBri_ISR
r_static
r_int
id|qBri_ISR
(paren
r_struct
id|_ISDN_ADAPTER
op_star
id|IoAdapter
)paren
(brace
id|dword
r_volatile
id|__iomem
op_star
id|qBriIrq
suffix:semicolon
id|PADAPTER_LIST_ENTRY
id|QuadroList
op_assign
id|IoAdapter-&gt;QuadroList
suffix:semicolon
id|word
id|i
suffix:semicolon
r_int
id|serviced
op_assign
l_int|0
suffix:semicolon
id|byte
id|__iomem
op_star
id|p
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|READ_BYTE
c_func
(paren
op_amp
id|p
(braket
id|PLX9054_INTCSR
)braket
)paren
op_amp
l_int|0x80
)paren
)paren
(brace
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;clear interrupt line (reset Local Interrupt Test Register)&n; */
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|qBriIrq
op_assign
(paren
id|dword
r_volatile
id|__iomem
op_star
)paren
(paren
op_amp
id|p
(braket
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
ques
c_cond
(paren
id|MQ2_BREG_IRQ_TEST
)paren
suffix:colon
(paren
id|MQ_BREG_IRQ_TEST
)paren
)braket
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriIrq
comma
id|MQ_IRQ_REQ_OFF
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IoAdapter-&gt;tasks
suffix:semicolon
op_increment
id|i
)paren
(brace
id|IoAdapter
op_assign
id|QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter
op_logical_and
id|IoAdapter-&gt;Initialized
op_logical_and
id|IoAdapter-&gt;tst_irq
(paren
op_amp
id|IoAdapter-&gt;a
)paren
)paren
(brace
id|IoAdapter-&gt;IrqCount
op_increment
suffix:semicolon
id|serviced
op_assign
l_int|1
suffix:semicolon
id|diva_os_schedule_soft_isr
(paren
op_amp
id|IoAdapter-&gt;isr_soft_isr
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|serviced
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Does disable the interrupt on the card&n;&t; -------------------------------------------------------------------------- */
DECL|function|disable_qBri_interrupt
r_static
r_void
id|disable_qBri_interrupt
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
r_volatile
id|__iomem
op_star
id|qBriIrq
suffix:semicolon
id|byte
id|__iomem
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;ControllerNumber
OG
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/*&n; *&t;clear interrupt line (reset Local Interrupt Test Register)&n; */
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_BYTE
c_func
(paren
op_amp
id|p
(braket
id|PLX9054_INTCSR
)braket
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* disable PCI interrupts */
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|qBriIrq
op_assign
(paren
id|dword
r_volatile
id|__iomem
op_star
)paren
(paren
op_amp
id|p
(braket
id|DIVA_4BRI_REVISION
c_func
(paren
id|IoAdapter
)paren
ques
c_cond
(paren
id|MQ2_BREG_IRQ_TEST
)paren
suffix:colon
(paren
id|MQ_BREG_IRQ_TEST
)paren
)braket
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriIrq
comma
id|MQ_IRQ_REQ_OFF
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;&t;&t;Install Adapter Entry Points&n;&t; -------------------------------------------------------------------------- */
DECL|function|set_common_qBri_functions
r_static
r_void
id|set_common_qBri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|ADAPTER
op_star
id|a
suffix:semicolon
id|a
op_assign
op_amp
id|IoAdapter-&gt;a
suffix:semicolon
id|a-&gt;ram_in
op_assign
id|mem_in
suffix:semicolon
id|a-&gt;ram_inw
op_assign
id|mem_inw
suffix:semicolon
id|a-&gt;ram_in_buffer
op_assign
id|mem_in_buffer
suffix:semicolon
id|a-&gt;ram_look_ahead
op_assign
id|mem_look_ahead
suffix:semicolon
id|a-&gt;ram_out
op_assign
id|mem_out
suffix:semicolon
id|a-&gt;ram_outw
op_assign
id|mem_outw
suffix:semicolon
id|a-&gt;ram_out_buffer
op_assign
id|mem_out_buffer
suffix:semicolon
id|a-&gt;ram_inc
op_assign
id|mem_inc
suffix:semicolon
id|IoAdapter-&gt;out
op_assign
id|pr_out
suffix:semicolon
id|IoAdapter-&gt;dpc
op_assign
id|pr_dpc
suffix:semicolon
id|IoAdapter-&gt;tst_irq
op_assign
id|scom_test_int
suffix:semicolon
id|IoAdapter-&gt;clr_irq
op_assign
id|scom_clear_int
suffix:semicolon
id|IoAdapter-&gt;pcm
op_assign
(paren
r_struct
id|pc_maint
op_star
)paren
id|MIPS_MAINT_OFFS
suffix:semicolon
id|IoAdapter-&gt;load
op_assign
id|load_qBri_hardware
suffix:semicolon
id|IoAdapter-&gt;disIrq
op_assign
id|disable_qBri_interrupt
suffix:semicolon
id|IoAdapter-&gt;rstFnc
op_assign
id|reset_qBri_hardware
suffix:semicolon
id|IoAdapter-&gt;stop
op_assign
id|stop_qBri_hardware
suffix:semicolon
id|IoAdapter-&gt;trapFnc
op_assign
id|qBri_cpu_trapped
suffix:semicolon
id|IoAdapter-&gt;diva_isr_handler
op_assign
id|qBri_ISR
suffix:semicolon
id|IoAdapter-&gt;a.io
op_assign
(paren
r_void
op_star
)paren
id|IoAdapter
suffix:semicolon
)brace
DECL|function|set_qBri_functions
r_static
r_void
id|set_qBri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;tasks
)paren
(brace
id|IoAdapter-&gt;tasks
op_assign
id|MQ_INSTANCE_COUNT
suffix:semicolon
)brace
id|IoAdapter-&gt;MemorySize
op_assign
id|MQ_MEMORY_SIZE
suffix:semicolon
id|set_common_qBri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
id|diva_os_set_qBri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
)brace
DECL|function|set_qBri2_functions
r_static
r_void
id|set_qBri2_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;tasks
)paren
(brace
id|IoAdapter-&gt;tasks
op_assign
id|MQ_INSTANCE_COUNT
suffix:semicolon
)brace
id|IoAdapter-&gt;MemorySize
op_assign
(paren
id|IoAdapter-&gt;tasks
op_eq
l_int|1
)paren
ques
c_cond
id|BRI2_MEMORY_SIZE
suffix:colon
id|MQ2_MEMORY_SIZE
suffix:semicolon
id|set_common_qBri_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
id|diva_os_set_qBri2_functions
(paren
id|IoAdapter
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
DECL|function|prepare_qBri_functions
r_void
id|prepare_qBri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|set_qBri_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|set_qBri_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|set_qBri_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|set_qBri_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
DECL|function|prepare_qBri2_functions
r_void
id|prepare_qBri2_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;tasks
)paren
(brace
id|IoAdapter-&gt;tasks
op_assign
id|MQ_INSTANCE_COUNT
suffix:semicolon
)brace
id|set_qBri2_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;tasks
OG
l_int|1
)paren
(brace
id|set_qBri2_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|set_qBri2_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|set_qBri2_functions
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* -------------------------------------------------------------------------- */
eof
