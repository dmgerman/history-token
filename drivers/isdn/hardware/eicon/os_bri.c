multiline_comment|/* $Id: os_bri.c,v 1.21 2004/03/21 17:26:01 armin Exp $ */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;debuglib.h&quot;
macro_line|#include &quot;cardtype.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;di_defs.h&quot;
macro_line|#include &quot;dsp_defs.h&quot;
macro_line|#include &quot;di.h&quot;
macro_line|#include &quot;io.h&quot;
macro_line|#include &quot;xdi_msg.h&quot;
macro_line|#include &quot;xdi_adapter.h&quot;
macro_line|#include &quot;os_bri.h&quot;
macro_line|#include &quot;diva_pci.h&quot;
macro_line|#include &quot;mi_pc.h&quot;
macro_line|#include &quot;pc_maint.h&quot;
multiline_comment|/*&n;**  IMPORTS&n;*/
r_extern
r_void
id|prepare_maestra_functions
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
suffix:semicolon
r_extern
r_void
id|diva_xdi_display_adapter_features
c_func
(paren
r_int
id|card
)paren
suffix:semicolon
r_extern
r_int
id|diva_card_read_xlog
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
multiline_comment|/*&n;**  LOCALS&n;*/
DECL|variable|bri_bar_length
r_static
r_int
id|bri_bar_length
(braket
l_int|3
)braket
op_assign
(brace
l_int|0x80
comma
l_int|0x80
comma
l_int|0x20
)brace
suffix:semicolon
r_static
r_int
id|diva_bri_cleanup_adapter
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_static
id|dword
id|diva_bri_get_serial_number
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_static
r_int
id|diva_bri_cmd_card_proc
c_func
(paren
r_struct
id|_diva_os_xdi_adapter
op_star
id|a
comma
id|diva_xdi_um_cfg_cmd_t
op_star
id|cmd
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_int
id|diva_bri_reregister_io
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_static
r_int
id|diva_bri_reset_adapter
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
suffix:semicolon
r_static
r_int
id|diva_bri_write_sdram_block
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
id|dword
id|address
comma
r_const
id|byte
op_star
id|data
comma
id|dword
id|length
)paren
suffix:semicolon
r_static
r_int
id|diva_bri_start_adapter
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
id|dword
id|start_address
comma
id|dword
id|features
)paren
suffix:semicolon
r_static
r_int
id|diva_bri_stop_adapter
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
DECL|function|diva_bri_set_addresses
r_static
r_void
id|diva_bri_set_addresses
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_RAM
)braket
op_assign
l_int|0
suffix:semicolon
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_CFG
)braket
op_assign
l_int|1
suffix:semicolon
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_ADDRESS
)braket
op_assign
l_int|2
suffix:semicolon
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_RESET
)braket
op_assign
l_int|1
suffix:semicolon
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_PORT
)braket
op_assign
l_int|2
suffix:semicolon
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_CTLREG
)braket
op_assign
l_int|2
suffix:semicolon
id|a-&gt;xdi_adapter.ram
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|0
)braket
suffix:semicolon
id|a-&gt;xdi_adapter.cfg
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|1
)braket
suffix:semicolon
id|a-&gt;xdi_adapter.Address
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|2
)braket
suffix:semicolon
id|a-&gt;xdi_adapter.reset
op_assign
id|a-&gt;xdi_adapter.cfg
suffix:semicolon
id|a-&gt;xdi_adapter.port
op_assign
id|a-&gt;xdi_adapter.Address
suffix:semicolon
id|a-&gt;xdi_adapter.ctlReg
op_assign
id|a-&gt;xdi_adapter.port
op_plus
id|M_PCI_RESET
suffix:semicolon
id|a-&gt;xdi_adapter.reset
op_add_assign
l_int|0x4C
suffix:semicolon
multiline_comment|/* PLX 9050 !! */
)brace
multiline_comment|/*&n;**  BAR0 - MEM Addr  - 0x80  - NOT USED&n;**  BAR1 - I/O Addr  - 0x80&n;**  BAR2 - I/O Addr  - 0x20&n;*/
DECL|function|diva_bri_init_card
r_int
id|diva_bri_init_card
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
r_int
id|bar
suffix:semicolon
id|dword
id|bar2
op_assign
l_int|0
comma
id|bar2_length
op_assign
l_int|0xffffffff
suffix:semicolon
id|word
id|cmd
op_assign
l_int|0
comma
id|cmd_org
suffix:semicolon
id|byte
id|Bus
comma
id|Slot
suffix:semicolon
r_void
op_star
id|hdev
suffix:semicolon
id|byte
id|__iomem
op_star
id|p
suffix:semicolon
multiline_comment|/*&n;&t;   Set properties&n;&t; */
id|a-&gt;xdi_adapter.Properties
op_assign
id|CardProperties
(braket
id|a-&gt;CardOrdinal
)braket
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;Load %s&quot;
comma
id|a-&gt;xdi_adapter.Properties.Name
)paren
)paren
multiline_comment|/*&n;&t;       Get resources&n;&t;     */
r_for
c_loop
(paren
id|bar
op_assign
l_int|0
suffix:semicolon
id|bar
OL
l_int|3
suffix:semicolon
id|bar
op_increment
)paren
(brace
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
op_assign
id|divasa_get_pci_bar
c_func
(paren
id|a-&gt;resources.pci.bus
comma
id|a-&gt;resources.pci.func
comma
id|bar
comma
id|a-&gt;resources.pci.hdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: can&squot;t get BAR[%d]&quot;
comma
id|bar
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|a-&gt;resources.pci.irq
op_assign
(paren
id|byte
)paren
id|divasa_get_pci_irq
c_func
(paren
id|a-&gt;resources.pci.bus
comma
id|a-&gt;resources.pci.func
comma
id|a-&gt;resources.pci.hdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;resources.pci.irq
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: invalid irq&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   Get length of I/O bar 2 - it is different by older&n;&t;   EEPROM version&n;&t; */
id|Bus
op_assign
id|a-&gt;resources.pci.bus
suffix:semicolon
id|Slot
op_assign
id|a-&gt;resources.pci.func
suffix:semicolon
id|hdev
op_assign
id|a-&gt;resources.pci.hdev
suffix:semicolon
multiline_comment|/*&n;&t;   Get plain original values of the BAR2 CDM registers&n;&t; */
id|PCIread
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x18
comma
op_amp
id|bar2
comma
r_sizeof
(paren
id|bar2
)paren
comma
id|hdev
)paren
suffix:semicolon
id|PCIread
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x04
comma
op_amp
id|cmd_org
comma
r_sizeof
(paren
id|cmd_org
)paren
comma
id|hdev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Disable device and get BAR2 length&n;&t; */
id|PCIwrite
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x04
comma
op_amp
id|cmd
comma
r_sizeof
(paren
id|cmd
)paren
comma
id|hdev
)paren
suffix:semicolon
id|PCIwrite
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x18
comma
op_amp
id|bar2_length
comma
r_sizeof
(paren
id|bar2_length
)paren
comma
id|hdev
)paren
suffix:semicolon
id|PCIread
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x18
comma
op_amp
id|bar2_length
comma
r_sizeof
(paren
id|bar2_length
)paren
comma
id|hdev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Restore BAR2 and CMD registers&n;&t; */
id|PCIwrite
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x18
comma
op_amp
id|bar2
comma
r_sizeof
(paren
id|bar2
)paren
comma
id|hdev
)paren
suffix:semicolon
id|PCIwrite
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x04
comma
op_amp
id|cmd_org
comma
r_sizeof
(paren
id|cmd_org
)paren
comma
id|hdev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Calculate BAR2 length&n;&t; */
id|bar2_length
op_assign
(paren
op_complement
(paren
id|bar2_length
op_amp
op_complement
l_int|7
)paren
)paren
op_plus
l_int|1
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;BAR[2] length=%lx&quot;
comma
id|bar2_length
)paren
)paren
multiline_comment|/*&n;&t;       Map and register resources&n;&t;     */
r_if
c_cond
(paren
op_logical_neg
(paren
id|a-&gt;resources.pci.addr
(braket
l_int|0
)braket
op_assign
id|divasa_remap_pci_bar
c_func
(paren
id|a
comma
l_int|0
comma
id|a-&gt;resources.pci.bar
(braket
l_int|0
)braket
comma
id|bri_bar_length
(braket
l_int|0
)braket
)paren
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: BRI, can&squot;t map BAR[0]&quot;
)paren
)paren
id|diva_bri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
op_amp
id|a-&gt;port_name
(braket
l_int|0
)braket
comma
l_string|&quot;BRI %02x:%02x&quot;
comma
id|a-&gt;resources.pci.bus
comma
id|a-&gt;resources.pci.func
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diva_os_register_io_port
c_func
(paren
id|a
comma
l_int|1
comma
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
comma
id|bri_bar_length
(braket
l_int|1
)braket
comma
op_amp
id|a-&gt;port_name
(braket
l_int|0
)braket
comma
l_int|1
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: BRI, can&squot;t register BAR[1]&quot;
)paren
)paren
id|diva_bri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|a-&gt;resources.pci.addr
(braket
l_int|1
)braket
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
suffix:semicolon
id|a-&gt;resources.pci.length
(braket
l_int|1
)braket
op_assign
id|bri_bar_length
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|diva_os_register_io_port
c_func
(paren
id|a
comma
l_int|1
comma
id|a-&gt;resources.pci.bar
(braket
l_int|2
)braket
comma
id|bar2_length
comma
op_amp
id|a-&gt;port_name
(braket
l_int|0
)braket
comma
l_int|2
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: BRI, can&squot;t register BAR[2]&quot;
)paren
)paren
id|diva_bri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|a-&gt;resources.pci.addr
(braket
l_int|2
)braket
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|a-&gt;resources.pci.bar
(braket
l_int|2
)braket
suffix:semicolon
id|a-&gt;resources.pci.length
(braket
l_int|2
)braket
op_assign
id|bar2_length
suffix:semicolon
multiline_comment|/*&n;&t;   Set all memory areas&n;&t; */
id|diva_bri_set_addresses
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Get Serial Number&n;&t; */
id|a-&gt;xdi_adapter.serialNo
op_assign
id|diva_bri_get_serial_number
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Register I/O ports with correct name now&n;&t; */
r_if
c_cond
(paren
id|diva_bri_reregister_io
c_func
(paren
id|a
)paren
)paren
(brace
id|diva_bri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   Initialize OS dependent objects&n;&t; */
r_if
c_cond
(paren
id|diva_os_initialize_spin_lock
(paren
op_amp
id|a-&gt;xdi_adapter.isr_spin_lock
comma
l_string|&quot;isr&quot;
)paren
)paren
(brace
id|diva_bri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|diva_os_initialize_spin_lock
(paren
op_amp
id|a-&gt;xdi_adapter.data_spin_lock
comma
l_string|&quot;data&quot;
)paren
)paren
(brace
id|diva_bri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|a-&gt;xdi_adapter.req_soft_isr.dpc_thread_name
comma
l_string|&quot;kdivasbrid&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diva_os_initialize_soft_isr
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.req_soft_isr
comma
id|DIDpcRoutine
comma
op_amp
id|a-&gt;xdi_adapter
)paren
)paren
(brace
id|diva_bri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   Do not initialize second DPC - only one thread will be created&n;&t; */
id|a-&gt;xdi_adapter.isr_soft_isr.object
op_assign
id|a-&gt;xdi_adapter.req_soft_isr.object
suffix:semicolon
multiline_comment|/*&n;&t;   Create entity table&n;&t; */
id|a-&gt;xdi_adapter.Channels
op_assign
id|CardProperties
(braket
id|a-&gt;CardOrdinal
)braket
dot
id|Channels
suffix:semicolon
id|a-&gt;xdi_adapter.e_max
op_assign
id|CardProperties
(braket
id|a-&gt;CardOrdinal
)braket
dot
id|E_info
suffix:semicolon
id|a-&gt;xdi_adapter.e_tbl
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_adapter.e_max
op_star
r_sizeof
(paren
id|E_INFO
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.e_tbl
)paren
(brace
id|diva_bri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|a-&gt;xdi_adapter.e_tbl
comma
l_int|0x00
comma
id|a-&gt;xdi_adapter.e_max
op_star
r_sizeof
(paren
id|E_INFO
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Set up interface&n;&t; */
id|a-&gt;xdi_adapter.a.io
op_assign
op_amp
id|a-&gt;xdi_adapter
suffix:semicolon
id|a-&gt;xdi_adapter.DIRequest
op_assign
id|request
suffix:semicolon
id|a-&gt;interface.cleanup_adapter_proc
op_assign
id|diva_bri_cleanup_adapter
suffix:semicolon
id|a-&gt;interface.cmd_proc
op_assign
id|diva_bri_cmd_card_proc
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
id|outpp
c_func
(paren
id|p
comma
l_int|0x41
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|p
)paren
suffix:semicolon
id|prepare_maestra_functions
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
id|a-&gt;dsp_mask
op_assign
l_int|0x00000003
suffix:semicolon
multiline_comment|/*&n;&t;   Set IRQ handler&n;&t; */
id|a-&gt;xdi_adapter.irq_info.irq_nr
op_assign
id|a-&gt;resources.pci.irq
suffix:semicolon
id|sprintf
c_func
(paren
id|a-&gt;xdi_adapter.irq_info.irq_name
comma
l_string|&quot;DIVA BRI %ld&quot;
comma
(paren
r_int
)paren
id|a-&gt;xdi_adapter.serialNo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diva_os_register_irq
c_func
(paren
id|a
comma
id|a-&gt;xdi_adapter.irq_info.irq_nr
comma
id|a-&gt;xdi_adapter.irq_info.irq_name
)paren
)paren
(brace
id|diva_bri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|a-&gt;xdi_adapter.irq_info.registered
op_assign
l_int|1
suffix:semicolon
id|diva_log_info
c_func
(paren
l_string|&quot;%s IRQ:%d SerNo:%d&quot;
comma
id|a-&gt;xdi_adapter.Properties.Name
comma
id|a-&gt;resources.pci.irq
comma
id|a-&gt;xdi_adapter.serialNo
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|diva_bri_cleanup_adapter
r_static
r_int
id|diva_bri_cleanup_adapter
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.Initialized
)paren
(brace
id|diva_bri_stop_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   Remove ISR Handler&n;&t; */
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.irq_info.registered
)paren
(brace
id|diva_os_remove_irq
c_func
(paren
id|a
comma
id|a-&gt;xdi_adapter.irq_info.irq_nr
)paren
suffix:semicolon
)brace
id|a-&gt;xdi_adapter.irq_info.registered
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;resources.pci.addr
(braket
l_int|0
)braket
op_logical_and
id|a-&gt;resources.pci.bar
(braket
l_int|0
)braket
)paren
(brace
id|divasa_unmap_pci_bar
c_func
(paren
id|a-&gt;resources.pci.addr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|a-&gt;resources.pci.addr
(braket
l_int|0
)braket
op_assign
l_int|NULL
suffix:semicolon
id|a-&gt;resources.pci.bar
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|a-&gt;resources.pci.addr
(braket
id|i
)braket
op_logical_and
id|a-&gt;resources.pci.bar
(braket
id|i
)braket
)paren
(brace
id|diva_os_register_io_port
c_func
(paren
id|a
comma
l_int|0
comma
id|a-&gt;resources.pci.bar
(braket
id|i
)braket
comma
id|a-&gt;resources.pci
dot
id|length
(braket
id|i
)braket
comma
op_amp
id|a-&gt;port_name
(braket
l_int|0
)braket
comma
id|i
)paren
suffix:semicolon
id|a-&gt;resources.pci.addr
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|a-&gt;resources.pci.bar
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;   Free OS objects&n;&t; */
id|diva_os_cancel_soft_isr
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.req_soft_isr
)paren
suffix:semicolon
id|diva_os_cancel_soft_isr
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.isr_soft_isr
)paren
suffix:semicolon
id|diva_os_remove_soft_isr
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.req_soft_isr
)paren
suffix:semicolon
id|a-&gt;xdi_adapter.isr_soft_isr.object
op_assign
l_int|NULL
suffix:semicolon
id|diva_os_destroy_spin_lock
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.isr_spin_lock
comma
l_string|&quot;rm&quot;
)paren
suffix:semicolon
id|diva_os_destroy_spin_lock
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.data_spin_lock
comma
l_string|&quot;rm&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Free memory&n;&t; */
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.e_tbl
)paren
(brace
id|diva_os_free
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_adapter.e_tbl
)paren
suffix:semicolon
id|a-&gt;xdi_adapter.e_tbl
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|diva_os_prepare_maestra_functions
r_void
id|diva_os_prepare_maestra_functions
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
)brace
multiline_comment|/*&n;**  Get serial number&n;*/
DECL|function|diva_bri_get_serial_number
r_static
id|dword
id|diva_bri_get_serial_number
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|dword
id|serNo
op_assign
l_int|0
suffix:semicolon
id|byte
id|__iomem
op_star
id|confIO
suffix:semicolon
id|word
id|serHi
comma
id|serLo
suffix:semicolon
id|word
id|__iomem
op_star
id|confMem
suffix:semicolon
id|confIO
op_assign
id|DIVA_OS_MEM_ATTACH_CFG
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
id|serHi
op_assign
(paren
id|word
)paren
(paren
id|inppw
c_func
(paren
op_amp
id|confIO
(braket
l_int|0x22
)braket
)paren
op_amp
l_int|0x0FFF
)paren
suffix:semicolon
id|serLo
op_assign
(paren
id|word
)paren
(paren
id|inppw
c_func
(paren
op_amp
id|confIO
(braket
l_int|0x26
)braket
)paren
op_amp
l_int|0x0FFF
)paren
suffix:semicolon
id|serNo
op_assign
(paren
(paren
id|dword
)paren
id|serHi
op_lshift
l_int|16
)paren
op_or
(paren
id|dword
)paren
id|serLo
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CFG
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|confIO
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|serNo
op_eq
l_int|0
)paren
op_logical_or
(paren
id|serNo
op_eq
l_int|0xFFFFFFFF
)paren
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;W: BRI use BAR[0] to get card serial number&quot;
)paren
)paren
id|confMem
op_assign
(paren
id|word
id|__iomem
op_star
)paren
id|DIVA_OS_MEM_ATTACH_RAM
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
id|serHi
op_assign
(paren
id|word
)paren
(paren
id|READ_WORD
c_func
(paren
op_amp
id|confMem
(braket
l_int|0x11
)braket
)paren
op_amp
l_int|0x0FFF
)paren
suffix:semicolon
id|serLo
op_assign
(paren
id|word
)paren
(paren
id|READ_WORD
c_func
(paren
op_amp
id|confMem
(braket
l_int|0x13
)braket
)paren
op_amp
l_int|0x0FFF
)paren
suffix:semicolon
id|serNo
op_assign
(paren
(paren
(paren
id|dword
)paren
id|serHi
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|dword
)paren
id|serLo
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_RAM
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|confMem
)paren
suffix:semicolon
)brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;Serial Number=%ld&quot;
comma
id|serNo
)paren
)paren
r_return
(paren
id|serNo
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  Unregister I/O and register it with new name,&n;**  based on Serial Number&n;*/
DECL|function|diva_bri_reregister_io
r_static
r_int
id|diva_bri_reregister_io
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diva_os_register_io_port
c_func
(paren
id|a
comma
l_int|0
comma
id|a-&gt;resources.pci.bar
(braket
id|i
)braket
comma
id|a-&gt;resources.pci.length
(braket
id|i
)braket
comma
op_amp
id|a-&gt;port_name
(braket
l_int|0
)braket
comma
id|i
)paren
suffix:semicolon
id|a-&gt;resources.pci.addr
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|a-&gt;port_name
comma
l_string|&quot;DIVA BRI %ld&quot;
comma
(paren
r_int
)paren
id|a-&gt;xdi_adapter.serialNo
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|diva_os_register_io_port
c_func
(paren
id|a
comma
l_int|1
comma
id|a-&gt;resources.pci.bar
(braket
id|i
)braket
comma
id|a-&gt;resources.pci.length
(braket
id|i
)braket
comma
op_amp
id|a-&gt;port_name
(braket
l_int|0
)braket
comma
id|i
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: failed to reregister BAR[%d]&quot;
comma
id|i
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|a-&gt;resources.pci.addr
(braket
id|i
)braket
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|a-&gt;resources.pci.bar
(braket
id|i
)braket
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  Process command from user mode&n;*/
r_static
r_int
DECL|function|diva_bri_cmd_card_proc
id|diva_bri_cmd_card_proc
c_func
(paren
r_struct
id|_diva_os_xdi_adapter
op_star
id|a
comma
id|diva_xdi_um_cfg_cmd_t
op_star
id|cmd
comma
r_int
id|length
)paren
(brace
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;adapter
op_ne
id|a-&gt;controller
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: pri_cmd, invalid controller=%d != %d&quot;
comma
id|cmd-&gt;adapter
comma
id|a-&gt;controller
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd-&gt;command
)paren
(brace
r_case
id|DIVA_XDI_UM_CMD_GET_CARD_ORDINAL
suffix:colon
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
op_star
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
op_assign
(paren
id|dword
)paren
id|a-&gt;CardOrdinal
suffix:semicolon
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_GET_SERIAL_NR
suffix:colon
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
op_star
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
op_assign
(paren
id|dword
)paren
id|a-&gt;xdi_adapter.serialNo
suffix:semicolon
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_GET_PCI_HW_CONFIG
suffix:colon
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
op_star
l_int|9
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
r_int
id|i
suffix:semicolon
id|dword
op_star
id|data
op_assign
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|data
op_increment
op_assign
id|a-&gt;resources.pci.bar
(braket
id|i
)braket
suffix:semicolon
)brace
op_star
id|data
op_increment
op_assign
(paren
id|dword
)paren
id|a-&gt;resources.pci.irq
suffix:semicolon
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_GET_CARD_STATE
suffix:colon
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
id|dword
op_star
id|data
op_assign
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.port
)paren
(brace
op_star
id|data
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.trapped
)paren
(brace
op_star
id|data
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.Initialized
)paren
(brace
op_star
id|data
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
op_star
id|data
op_assign
l_int|0
suffix:semicolon
)brace
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_RESET_ADAPTER
suffix:colon
id|ret
op_assign
id|diva_bri_reset_adapter
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_WRITE_SDRAM_BLOCK
suffix:colon
id|ret
op_assign
id|diva_bri_write_sdram_block
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|cmd-&gt;command_data
dot
id|write_sdram.offset
comma
(paren
id|byte
op_star
)paren
op_amp
id|cmd
(braket
l_int|1
)braket
comma
id|cmd-&gt;command_data
dot
id|write_sdram.length
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_START_ADAPTER
suffix:colon
id|ret
op_assign
id|diva_bri_start_adapter
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|cmd-&gt;command_data.start
dot
id|offset
comma
id|cmd-&gt;command_data.start
dot
id|features
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_SET_PROTOCOL_FEATURES
suffix:colon
id|a-&gt;xdi_adapter.features
op_assign
id|cmd-&gt;command_data.features.features
suffix:semicolon
id|a-&gt;xdi_adapter.a.protocol_capabilities
op_assign
id|a-&gt;xdi_adapter.features
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Set raw protocol features (%08x)&quot;
comma
id|a-&gt;xdi_adapter.features
)paren
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_STOP_ADAPTER
suffix:colon
id|ret
op_assign
id|diva_bri_stop_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_READ_XLOG_ENTRY
suffix:colon
id|ret
op_assign
id|diva_card_read_xlog
c_func
(paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) invalid cmd=%d&quot;
comma
id|a-&gt;controller
comma
id|cmd-&gt;command
)paren
)paren
)brace
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|function|diva_bri_reset_adapter
r_static
r_int
id|diva_bri_reset_adapter
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|byte
id|__iomem
op_star
id|addrHi
comma
op_star
id|addrLo
comma
op_star
id|ioaddr
suffix:semicolon
id|dword
id|i
suffix:semicolon
id|byte
id|__iomem
op_star
id|Port
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;port
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IoAdapter-&gt;Initialized
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) can&squot;t reset BRI adapter - please stop first&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
(paren
op_star
(paren
id|IoAdapter-&gt;rstFnc
)paren
)paren
(paren
id|IoAdapter
)paren
suffix:semicolon
id|diva_os_wait
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|Port
op_assign
id|DIVA_OS_MEM_ATTACH_PORT
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|addrHi
op_assign
id|Port
op_plus
(paren
(paren
id|IoAdapter-&gt;Properties.Bus
op_eq
id|BUS_PCI
)paren
ques
c_cond
id|M_PCI_ADDRH
suffix:colon
id|ADDRH
)paren
suffix:semicolon
id|addrLo
op_assign
id|Port
op_plus
id|ADDR
suffix:semicolon
id|ioaddr
op_assign
id|Port
op_plus
id|DATA
suffix:semicolon
multiline_comment|/*&n;&t;   recover&n;&t; */
id|outpp
c_func
(paren
id|addrHi
comma
(paren
id|byte
)paren
l_int|0
)paren
suffix:semicolon
id|outppw
c_func
(paren
id|addrLo
comma
(paren
id|word
)paren
l_int|0
)paren
suffix:semicolon
id|outppw
c_func
(paren
id|ioaddr
comma
(paren
id|word
)paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   clear shared memory&n;&t; */
id|outpp
c_func
(paren
id|addrHi
comma
(paren
id|byte
)paren
(paren
(paren
id|IoAdapter-&gt;MemoryBase
op_plus
id|IoAdapter-&gt;MemorySize
op_minus
id|BRI_SHARED_RAM_SIZE
)paren
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
c_func
(paren
id|addrLo
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x8000
suffix:semicolon
id|outppw
c_func
(paren
id|ioaddr
comma
l_int|0
)paren
comma
op_increment
id|i
)paren
suffix:semicolon
id|diva_os_wait
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   clear signature&n;&t; */
id|outpp
c_func
(paren
id|addrHi
comma
(paren
id|byte
)paren
(paren
(paren
id|IoAdapter-&gt;MemoryBase
op_plus
id|IoAdapter-&gt;MemorySize
op_minus
id|BRI_SHARED_RAM_SIZE
)paren
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
c_func
(paren
id|addrLo
comma
l_int|0x1e
)paren
suffix:semicolon
id|outpp
c_func
(paren
id|ioaddr
comma
l_int|0
)paren
suffix:semicolon
id|outpp
c_func
(paren
id|ioaddr
comma
l_int|0
)paren
suffix:semicolon
id|outpp
c_func
(paren
id|addrHi
comma
(paren
id|byte
)paren
l_int|0
)paren
suffix:semicolon
id|outppw
c_func
(paren
id|addrLo
comma
(paren
id|word
)paren
l_int|0
)paren
suffix:semicolon
id|outppw
c_func
(paren
id|ioaddr
comma
(paren
id|word
)paren
l_int|0
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_PORT
c_func
(paren
id|IoAdapter
comma
id|Port
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Forget all outstanding entities&n;&t; */
id|IoAdapter-&gt;e_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;e_tbl
)paren
(brace
id|memset
c_func
(paren
id|IoAdapter-&gt;e_tbl
comma
l_int|0x00
comma
id|IoAdapter-&gt;e_max
op_star
r_sizeof
(paren
id|E_INFO
)paren
)paren
suffix:semicolon
)brace
id|IoAdapter-&gt;head
op_assign
l_int|0
suffix:semicolon
id|IoAdapter-&gt;tail
op_assign
l_int|0
suffix:semicolon
id|IoAdapter-&gt;assign
op_assign
l_int|0
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.IdTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.IdTable
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.IdTypeTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.IdTypeTable
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.FlowControlIdTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.FlowControlIdTable
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.FlowControlSkipTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.FlowControlSkipTable
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.misc_flags_table
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.misc_flags_table
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.rx_stream
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.rx_stream
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.tx_stream
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.tx_stream
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.tx_pos
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.tx_pos
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.rx_pos
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.rx_pos
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|diva_bri_write_sdram_block
id|diva_bri_write_sdram_block
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
id|dword
id|address
comma
r_const
id|byte
op_star
id|data
comma
id|dword
id|length
)paren
(brace
id|byte
id|__iomem
op_star
id|addrHi
comma
op_star
id|addrLo
comma
op_star
id|ioaddr
suffix:semicolon
id|byte
id|__iomem
op_star
id|Port
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;port
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|Port
op_assign
id|DIVA_OS_MEM_ATTACH_PORT
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|addrHi
op_assign
id|Port
op_plus
(paren
(paren
id|IoAdapter-&gt;Properties.Bus
op_eq
id|BUS_PCI
)paren
ques
c_cond
id|M_PCI_ADDRH
suffix:colon
id|ADDRH
)paren
suffix:semicolon
id|addrLo
op_assign
id|Port
op_plus
id|ADDR
suffix:semicolon
id|ioaddr
op_assign
id|Port
op_plus
id|DATA
suffix:semicolon
r_while
c_loop
(paren
id|length
op_decrement
)paren
(brace
id|outpp
c_func
(paren
id|addrHi
comma
(paren
id|word
)paren
(paren
id|address
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
c_func
(paren
id|addrLo
comma
(paren
id|word
)paren
(paren
id|address
op_amp
l_int|0x0000ffff
)paren
)paren
suffix:semicolon
id|outpp
c_func
(paren
id|ioaddr
comma
op_star
id|data
op_increment
)paren
suffix:semicolon
id|address
op_increment
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_PORT
c_func
(paren
id|IoAdapter
comma
id|Port
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|diva_bri_start_adapter
id|diva_bri_start_adapter
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
id|dword
id|start_address
comma
id|dword
id|features
)paren
(brace
id|byte
id|__iomem
op_star
id|Port
suffix:semicolon
id|dword
id|i
comma
id|test
suffix:semicolon
id|byte
id|__iomem
op_star
id|addrHi
comma
op_star
id|addrLo
comma
op_star
id|ioaddr
suffix:semicolon
r_int
id|started
op_assign
l_int|0
suffix:semicolon
id|ADAPTER
op_star
id|a
op_assign
op_amp
id|IoAdapter-&gt;a
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;Initialized
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) bri_start_adapter, adapter already running&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;port
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) bri_start_adapter, adapter not mapped&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|IoAdapter-&gt;Name
comma
l_string|&quot;A(%d)&quot;
comma
(paren
r_int
)paren
id|IoAdapter-&gt;ANum
)paren
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;A(%d) start BRI&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
id|Port
op_assign
id|DIVA_OS_MEM_ATTACH_PORT
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|addrHi
op_assign
id|Port
op_plus
(paren
(paren
id|IoAdapter-&gt;Properties.Bus
op_eq
id|BUS_PCI
)paren
ques
c_cond
id|M_PCI_ADDRH
suffix:colon
id|ADDRH
)paren
suffix:semicolon
id|addrLo
op_assign
id|Port
op_plus
id|ADDR
suffix:semicolon
id|ioaddr
op_assign
id|Port
op_plus
id|DATA
suffix:semicolon
id|outpp
c_func
(paren
id|addrHi
comma
(paren
id|byte
)paren
(paren
(paren
id|IoAdapter-&gt;MemoryBase
op_plus
id|IoAdapter-&gt;MemorySize
op_minus
id|BRI_SHARED_RAM_SIZE
)paren
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
c_func
(paren
id|addrLo
comma
l_int|0x1e
)paren
suffix:semicolon
id|outppw
c_func
(paren
id|ioaddr
comma
l_int|0x00
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_PORT
c_func
(paren
id|IoAdapter
comma
id|Port
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   start the protocol code&n;&t; */
id|Port
op_assign
id|DIVA_OS_MEM_ATTACH_CTLREG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|outpp
c_func
(paren
id|Port
comma
l_int|0x08
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CTLREG
c_func
(paren
id|IoAdapter
comma
id|Port
)paren
suffix:semicolon
id|Port
op_assign
id|DIVA_OS_MEM_ATTACH_PORT
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|addrHi
op_assign
id|Port
op_plus
(paren
(paren
id|IoAdapter-&gt;Properties.Bus
op_eq
id|BUS_PCI
)paren
ques
c_cond
id|M_PCI_ADDRH
suffix:colon
id|ADDRH
)paren
suffix:semicolon
id|addrLo
op_assign
id|Port
op_plus
id|ADDR
suffix:semicolon
id|ioaddr
op_assign
id|Port
op_plus
id|DATA
suffix:semicolon
multiline_comment|/*&n;&t;   wait for signature (max. 3 seconds)&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|300
suffix:semicolon
op_increment
id|i
)paren
(brace
id|diva_os_wait
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|outpp
c_func
(paren
id|addrHi
comma
(paren
id|byte
)paren
(paren
(paren
id|IoAdapter-&gt;MemoryBase
op_plus
id|IoAdapter-&gt;MemorySize
op_minus
id|BRI_SHARED_RAM_SIZE
)paren
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|outppw
c_func
(paren
id|addrLo
comma
l_int|0x1e
)paren
suffix:semicolon
id|test
op_assign
(paren
id|dword
)paren
id|inppw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test
op_eq
l_int|0x4447
)paren
(brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;Protocol startup time %d.%02d seconds&quot;
comma
(paren
id|i
op_div
l_int|100
)paren
comma
(paren
id|i
op_mod
l_int|100
)paren
)paren
)paren
id|started
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|DIVA_OS_MEM_DETACH_PORT
c_func
(paren
id|IoAdapter
comma
id|Port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|started
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;A: A(%d) %s: Adapter selftest failed 0x%04X&quot;
comma
id|IoAdapter-&gt;ANum
comma
id|IoAdapter-&gt;Properties.Name
comma
id|test
)paren
)paren
(paren
op_star
(paren
id|IoAdapter-&gt;trapFnc
)paren
)paren
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|IoAdapter-&gt;Initialized
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;   Check Interrupt&n;&t; */
id|IoAdapter-&gt;IrqCount
op_assign
l_int|0
suffix:semicolon
id|a-&gt;ReadyInt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;reset
)paren
(brace
id|Port
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|outpp
c_func
(paren
id|Port
comma
l_int|0x41
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
id|IoAdapter
comma
id|Port
)paren
suffix:semicolon
)brace
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;ReadyInt
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
op_logical_neg
id|IoAdapter-&gt;IrqCount
)paren
op_logical_and
(paren
id|i
OL
l_int|100
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diva_os_wait
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;IrqCount
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) interrupt test failed&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
id|IoAdapter-&gt;Initialized
op_assign
l_int|0
suffix:semicolon
id|IoAdapter
op_member_access_from_pointer
id|stop
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|IoAdapter-&gt;Properties.Features
op_assign
(paren
id|word
)paren
id|features
suffix:semicolon
id|diva_xdi_display_adapter_features
c_func
(paren
id|IoAdapter-&gt;ANum
)paren
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;A(%d) BRI adapter successfull started&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
multiline_comment|/*&n;&t;       Register with DIDD&n;&t;     */
id|diva_xdi_didd_register_adapter
c_func
(paren
id|IoAdapter-&gt;ANum
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|diva_bri_clear_interrupts
r_static
r_void
id|diva_bri_clear_interrupts
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|PISDN_ADAPTER
id|IoAdapter
op_assign
op_amp
id|a-&gt;xdi_adapter
suffix:semicolon
multiline_comment|/*&n;&t;   clear any pending interrupt&n;&t; */
id|IoAdapter
op_member_access_from_pointer
id|disIrq
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|IoAdapter
op_member_access_from_pointer
id|tst_irq
c_func
(paren
op_amp
id|IoAdapter-&gt;a
)paren
suffix:semicolon
id|IoAdapter
op_member_access_from_pointer
id|clr_irq
c_func
(paren
op_amp
id|IoAdapter-&gt;a
)paren
suffix:semicolon
id|IoAdapter
op_member_access_from_pointer
id|tst_irq
c_func
(paren
op_amp
id|IoAdapter-&gt;a
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   kill pending dpcs&n;&t; */
id|diva_os_cancel_soft_isr
c_func
(paren
op_amp
id|IoAdapter-&gt;req_soft_isr
)paren
suffix:semicolon
id|diva_os_cancel_soft_isr
c_func
(paren
op_amp
id|IoAdapter-&gt;isr_soft_isr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  Stop card&n;*/
DECL|function|diva_bri_stop_adapter
r_static
r_int
id|diva_bri_stop_adapter
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|PISDN_ADAPTER
id|IoAdapter
op_assign
op_amp
id|a-&gt;xdi_adapter
suffix:semicolon
r_int
id|i
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;port
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;Initialized
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) can&squot;t stop BRI adapter - not running&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* nothing to stop */
)brace
id|IoAdapter-&gt;Initialized
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;   Disconnect Adapter from DIDD&n;&t; */
id|diva_xdi_didd_remove_adapter
c_func
(paren
id|IoAdapter-&gt;ANum
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Stop interrupts&n;&t; */
id|a-&gt;clear_interrupts_proc
op_assign
id|diva_bri_clear_interrupts
suffix:semicolon
id|IoAdapter-&gt;a.ReadyInt
op_assign
l_int|1
suffix:semicolon
id|IoAdapter-&gt;a
dot
id|ram_inc
c_func
(paren
op_amp
id|IoAdapter-&gt;a
comma
op_amp
id|PR_RAM-&gt;ReadyInt
)paren
suffix:semicolon
r_do
(brace
id|diva_os_sleep
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_decrement
op_logical_and
id|a-&gt;clear_interrupts_proc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;clear_interrupts_proc
)paren
(brace
id|diva_bri_clear_interrupts
c_func
(paren
id|a
)paren
suffix:semicolon
id|a-&gt;clear_interrupts_proc
op_assign
l_int|NULL
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) no final interrupt from BRI adapter&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
)brace
id|IoAdapter-&gt;a.ReadyInt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;   Stop and reset adapter&n;&t; */
id|IoAdapter
op_member_access_from_pointer
id|stop
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
eof
