multiline_comment|/* $Id: os_pri.c,v 1.32 2004/03/21 17:26:01 armin Exp $ */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;debuglib.h&quot;
macro_line|#include &quot;cardtype.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;di_defs.h&quot;
macro_line|#include &quot;dsp_defs.h&quot;
macro_line|#include &quot;di.h&quot;
macro_line|#include &quot;io.h&quot;
macro_line|#include &quot;xdi_msg.h&quot;
macro_line|#include &quot;xdi_adapter.h&quot;
macro_line|#include &quot;os_pri.h&quot;
macro_line|#include &quot;diva_pci.h&quot;
macro_line|#include &quot;mi_pc.h&quot;
macro_line|#include &quot;pc_maint.h&quot;
macro_line|#include &quot;dsp_tst.h&quot;
macro_line|#include &quot;diva_dma.h&quot;
multiline_comment|/* --------------------------------------------------------------------------&n;   OS Dependent part of XDI driver for DIVA PRI Adapter&n;&n;   DSP detection/validation by Anthony Booth (Eicon Networks, www.eicon.com)&n;-------------------------------------------------------------------------- */
DECL|macro|DIVA_PRI_NO_PCI_BIOS_WORKAROUND
mdefine_line|#define DIVA_PRI_NO_PCI_BIOS_WORKAROUND 1
r_extern
r_int
id|diva_card_read_xlog
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
multiline_comment|/*&n;**  IMPORTS&n;*/
r_extern
r_void
id|prepare_pri_functions
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
suffix:semicolon
r_extern
r_void
id|prepare_pri2_functions
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
suffix:semicolon
r_extern
r_void
id|diva_xdi_display_adapter_features
c_func
(paren
r_int
id|card
)paren
suffix:semicolon
r_static
r_int
id|diva_pri_cleanup_adapter
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_static
r_int
id|diva_pri_cmd_card_proc
c_func
(paren
r_struct
id|_diva_os_xdi_adapter
op_star
id|a
comma
id|diva_xdi_um_cfg_cmd_t
op_star
id|cmd
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_int
id|pri_get_serial_number
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_static
r_int
id|diva_pri_stop_adapter
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_static
id|dword
id|diva_pri_detect_dsps
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
multiline_comment|/*&n;**  Check card revision&n;*/
DECL|function|pri_is_rev_2_card
r_static
r_int
id|pri_is_rev_2_card
c_func
(paren
r_int
id|card_ordinal
)paren
(brace
r_switch
c_cond
(paren
id|card_ordinal
)paren
(brace
r_case
id|CARDTYPE_DIVASRV_P_30M_V2_PCI
suffix:colon
r_case
id|CARDTYPE_DIVASRV_VOICE_P_30M_V2_PCI
suffix:colon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|diva_pri_set_addresses
r_static
r_void
id|diva_pri_set_addresses
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_ADDRESS
)braket
op_assign
l_int|0
suffix:semicolon
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_CONTROL
)braket
op_assign
l_int|2
suffix:semicolon
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_CONFIG
)braket
op_assign
l_int|4
suffix:semicolon
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_RAM
)braket
op_assign
l_int|0
suffix:semicolon
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_RESET
)braket
op_assign
l_int|2
suffix:semicolon
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_CFG
)braket
op_assign
l_int|4
suffix:semicolon
id|a-&gt;resources.pci.mem_type_id
(braket
id|MEM_TYPE_PROM
)braket
op_assign
l_int|3
suffix:semicolon
id|a-&gt;xdi_adapter.Address
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|0
)braket
suffix:semicolon
id|a-&gt;xdi_adapter.Control
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|2
)braket
suffix:semicolon
id|a-&gt;xdi_adapter.Config
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|4
)braket
suffix:semicolon
id|a-&gt;xdi_adapter.ram
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|0
)braket
suffix:semicolon
id|a-&gt;xdi_adapter.ram
op_add_assign
id|MP_SHARED_RAM_OFFSET
suffix:semicolon
id|a-&gt;xdi_adapter.reset
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|2
)braket
suffix:semicolon
id|a-&gt;xdi_adapter.reset
op_add_assign
id|MP_RESET
suffix:semicolon
id|a-&gt;xdi_adapter.cfg
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|4
)braket
suffix:semicolon
id|a-&gt;xdi_adapter.cfg
op_add_assign
id|MP_IRQ_RESET
suffix:semicolon
id|a-&gt;xdi_adapter.sdram_bar
op_assign
id|a-&gt;resources.pci.bar
(braket
l_int|0
)braket
suffix:semicolon
id|a-&gt;xdi_adapter.prom
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|3
)braket
suffix:semicolon
)brace
multiline_comment|/*&n;**  BAR0 - SDRAM, MP_MEMORY_SIZE, MP2_MEMORY_SIZE by Rev.2&n;**  BAR1 - DEVICES,&t;&t;&t;&t;0x1000&n;**  BAR2 - CONTROL (REG), 0x2000&n;**  BAR3 - FLASH (REG),&t;&t;0x8000&n;**  BAR4 - CONFIG (CFG),&t;0x1000&n;*/
DECL|function|diva_pri_init_card
r_int
id|diva_pri_init_card
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
r_int
id|bar
op_assign
l_int|0
suffix:semicolon
r_int
id|pri_rev_2
suffix:semicolon
r_int
r_int
id|bar_length
(braket
l_int|5
)braket
op_assign
(brace
id|MP_MEMORY_SIZE
comma
l_int|0x1000
comma
l_int|0x2000
comma
l_int|0x8000
comma
l_int|0x1000
)brace
suffix:semicolon
id|pri_rev_2
op_assign
id|pri_is_rev_2_card
c_func
(paren
id|a-&gt;CardOrdinal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pri_rev_2
)paren
(brace
id|bar_length
(braket
l_int|0
)braket
op_assign
id|MP2_MEMORY_SIZE
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   Set properties&n;&t; */
id|a-&gt;xdi_adapter.Properties
op_assign
id|CardProperties
(braket
id|a-&gt;CardOrdinal
)braket
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;Load %s&quot;
comma
id|a-&gt;xdi_adapter.Properties.Name
)paren
)paren
multiline_comment|/*&n;&t;   First initialization step: get and check hardware resoures.&n;&t;   Do not map resources and do not acecess card at this step&n;&t; */
r_for
c_loop
(paren
id|bar
op_assign
l_int|0
suffix:semicolon
id|bar
OL
l_int|5
suffix:semicolon
id|bar
op_increment
)paren
(brace
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
op_assign
id|divasa_get_pci_bar
c_func
(paren
id|a-&gt;resources.pci.bus
comma
id|a-&gt;resources.pci.func
comma
id|bar
comma
id|a-&gt;resources.pci.hdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
op_logical_or
(paren
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
op_eq
l_int|0xFFFFFFF0
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: invalid bar[%d]=%08x&quot;
comma
id|bar
comma
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|a-&gt;resources.pci.irq
op_assign
(paren
id|byte
)paren
id|divasa_get_pci_irq
c_func
(paren
id|a-&gt;resources.pci.bus
comma
id|a-&gt;resources.pci.func
comma
id|a-&gt;resources.pci.hdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;resources.pci.irq
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: invalid irq&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   Map all BAR&squot;s&n;&t; */
r_for
c_loop
(paren
id|bar
op_assign
l_int|0
suffix:semicolon
id|bar
OL
l_int|5
suffix:semicolon
id|bar
op_increment
)paren
(brace
id|a-&gt;resources.pci.addr
(braket
id|bar
)braket
op_assign
id|divasa_remap_pci_bar
c_func
(paren
id|a
comma
id|bar
comma
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
comma
id|bar_length
(braket
id|bar
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;resources.pci.addr
(braket
id|bar
)braket
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d), can&squot;t map bar[%d]&quot;
comma
id|a-&gt;controller
comma
id|bar
)paren
)paren
id|diva_pri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;   Set all memory areas&n;&t; */
id|diva_pri_set_addresses
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Get Serial Number of this adapter&n;&t; */
r_if
c_cond
(paren
id|pri_get_serial_number
c_func
(paren
id|a
)paren
)paren
(brace
id|dword
id|serNo
suffix:semicolon
id|serNo
op_assign
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
op_amp
l_int|0xffff0000
suffix:semicolon
id|serNo
op_or_assign
(paren
(paren
id|dword
)paren
id|a-&gt;resources.pci.bus
)paren
op_lshift
l_int|8
suffix:semicolon
id|serNo
op_add_assign
(paren
id|a-&gt;resources.pci.func
op_plus
id|a-&gt;controller
op_plus
l_int|1
)paren
suffix:semicolon
id|a-&gt;xdi_adapter.serialNo
op_assign
id|serNo
op_amp
op_complement
l_int|0xFF000000
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) can&squot;t get Serial Number, generated serNo=%ld&quot;
comma
id|a-&gt;controller
comma
id|a-&gt;xdi_adapter.serialNo
)paren
)paren
)brace
multiline_comment|/*&n;&t;   Initialize os objects&n;&t; */
r_if
c_cond
(paren
id|diva_os_initialize_spin_lock
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.isr_spin_lock
comma
l_string|&quot;isr&quot;
)paren
)paren
(brace
id|diva_pri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|diva_os_initialize_spin_lock
(paren
op_amp
id|a-&gt;xdi_adapter.data_spin_lock
comma
l_string|&quot;data&quot;
)paren
)paren
(brace
id|diva_pri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|a-&gt;xdi_adapter.req_soft_isr.dpc_thread_name
comma
l_string|&quot;kdivasprid&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diva_os_initialize_soft_isr
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.req_soft_isr
comma
id|DIDpcRoutine
comma
op_amp
id|a-&gt;xdi_adapter
)paren
)paren
(brace
id|diva_pri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   Do not initialize second DPC - only one thread will be created&n;&t; */
id|a-&gt;xdi_adapter.isr_soft_isr.object
op_assign
id|a-&gt;xdi_adapter.req_soft_isr.object
suffix:semicolon
multiline_comment|/*&n;&t;   Next step of card initialization:&n;&t;   set up all interface pointers&n;&t; */
id|a-&gt;xdi_adapter.Channels
op_assign
id|CardProperties
(braket
id|a-&gt;CardOrdinal
)braket
dot
id|Channels
suffix:semicolon
id|a-&gt;xdi_adapter.e_max
op_assign
id|CardProperties
(braket
id|a-&gt;CardOrdinal
)braket
dot
id|E_info
suffix:semicolon
id|a-&gt;xdi_adapter.e_tbl
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_adapter.e_max
op_star
r_sizeof
(paren
id|E_INFO
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.e_tbl
)paren
(brace
id|diva_pri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|a-&gt;xdi_adapter.e_tbl
comma
l_int|0x00
comma
id|a-&gt;xdi_adapter.e_max
op_star
r_sizeof
(paren
id|E_INFO
)paren
)paren
suffix:semicolon
id|a-&gt;xdi_adapter.a.io
op_assign
op_amp
id|a-&gt;xdi_adapter
suffix:semicolon
id|a-&gt;xdi_adapter.DIRequest
op_assign
id|request
suffix:semicolon
id|a-&gt;interface.cleanup_adapter_proc
op_assign
id|diva_pri_cleanup_adapter
suffix:semicolon
id|a-&gt;interface.cmd_proc
op_assign
id|diva_pri_cmd_card_proc
suffix:semicolon
r_if
c_cond
(paren
id|pri_rev_2
)paren
(brace
id|prepare_pri2_functions
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
)brace
r_else
(brace
id|prepare_pri_functions
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
)brace
id|a-&gt;dsp_mask
op_assign
id|diva_pri_detect_dsps
c_func
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Allocate DMA map&n;&t; */
r_if
c_cond
(paren
id|pri_rev_2
)paren
(brace
id|diva_init_dma_map
c_func
(paren
id|a-&gt;resources.pci.hdev
comma
(paren
r_struct
id|_diva_dma_map_entry
op_star
op_star
)paren
op_amp
id|a-&gt;xdi_adapter.dma_map
comma
l_int|32
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   Set IRQ handler&n;&t; */
id|a-&gt;xdi_adapter.irq_info.irq_nr
op_assign
id|a-&gt;resources.pci.irq
suffix:semicolon
id|sprintf
c_func
(paren
id|a-&gt;xdi_adapter.irq_info.irq_name
comma
l_string|&quot;DIVA PRI %ld&quot;
comma
(paren
r_int
)paren
id|a-&gt;xdi_adapter.serialNo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diva_os_register_irq
c_func
(paren
id|a
comma
id|a-&gt;xdi_adapter.irq_info.irq_nr
comma
id|a-&gt;xdi_adapter.irq_info.irq_name
)paren
)paren
(brace
id|diva_pri_cleanup_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|a-&gt;xdi_adapter.irq_info.registered
op_assign
l_int|1
suffix:semicolon
id|diva_log_info
c_func
(paren
l_string|&quot;%s IRQ:%d SerNo:%d&quot;
comma
id|a-&gt;xdi_adapter.Properties.Name
comma
id|a-&gt;resources.pci.irq
comma
id|a-&gt;xdi_adapter.serialNo
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|diva_pri_cleanup_adapter
r_static
r_int
id|diva_pri_cleanup_adapter
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
r_int
id|bar
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;   Stop Adapter if adapter is running&n;&t; */
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.Initialized
)paren
(brace
id|diva_pri_stop_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   Remove ISR Handler&n;&t; */
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.irq_info.registered
)paren
(brace
id|diva_os_remove_irq
c_func
(paren
id|a
comma
id|a-&gt;xdi_adapter.irq_info.irq_nr
)paren
suffix:semicolon
)brace
id|a-&gt;xdi_adapter.irq_info.registered
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;   Step 1: unmap all BAR&squot;s, if any was mapped&n;&t; */
r_for
c_loop
(paren
id|bar
op_assign
l_int|0
suffix:semicolon
id|bar
OL
l_int|5
suffix:semicolon
id|bar
op_increment
)paren
(brace
r_if
c_cond
(paren
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
op_logical_and
id|a-&gt;resources.pci.addr
(braket
id|bar
)braket
)paren
(brace
id|divasa_unmap_pci_bar
c_func
(paren
id|a-&gt;resources.pci.addr
(braket
id|bar
)braket
)paren
suffix:semicolon
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
op_assign
l_int|0
suffix:semicolon
id|a-&gt;resources.pci.addr
(braket
id|bar
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;   Free OS objects&n;&t; */
id|diva_os_cancel_soft_isr
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.isr_soft_isr
)paren
suffix:semicolon
id|diva_os_cancel_soft_isr
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.req_soft_isr
)paren
suffix:semicolon
id|diva_os_remove_soft_isr
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.req_soft_isr
)paren
suffix:semicolon
id|a-&gt;xdi_adapter.isr_soft_isr.object
op_assign
l_int|NULL
suffix:semicolon
id|diva_os_destroy_spin_lock
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.isr_spin_lock
comma
l_string|&quot;rm&quot;
)paren
suffix:semicolon
id|diva_os_destroy_spin_lock
c_func
(paren
op_amp
id|a-&gt;xdi_adapter.data_spin_lock
comma
l_string|&quot;rm&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Free memory accupied by XDI adapter&n;&t; */
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.e_tbl
)paren
(brace
id|diva_os_free
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_adapter.e_tbl
)paren
suffix:semicolon
id|a-&gt;xdi_adapter.e_tbl
op_assign
l_int|NULL
suffix:semicolon
)brace
id|a-&gt;xdi_adapter.Channels
op_assign
l_int|0
suffix:semicolon
id|a-&gt;xdi_adapter.e_max
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;   Free adapter DMA map&n;&t; */
id|diva_free_dma_map
c_func
(paren
id|a-&gt;resources.pci.hdev
comma
(paren
r_struct
id|_diva_dma_map_entry
op_star
)paren
id|a-&gt;xdi_adapter
dot
id|dma_map
)paren
suffix:semicolon
id|a-&gt;xdi_adapter.dma_map
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t;   Detach this adapter from debug driver&n;&t; */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  Activate On Board Boot Loader&n;*/
DECL|function|diva_pri_reset_adapter
r_static
r_int
id|diva_pri_reset_adapter
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|dword
id|i
suffix:semicolon
r_struct
id|mp_load
id|__iomem
op_star
id|boot
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;Address
op_logical_or
op_logical_neg
id|IoAdapter-&gt;reset
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IoAdapter-&gt;Initialized
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) can&squot;t reset PRI adapter - please stop first&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|boot
op_assign
(paren
r_struct
id|mp_load
id|__iomem
op_star
)paren
id|DIVA_OS_MEM_ATTACH_ADDRESS
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
op_amp
id|boot-&gt;err
comma
l_int|0
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|boot
)paren
suffix:semicolon
id|IoAdapter
op_member_access_from_pointer
id|rstFnc
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|diva_os_wait
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|boot
op_assign
(paren
r_struct
id|mp_load
id|__iomem
op_star
)paren
id|DIVA_OS_MEM_ATTACH_ADDRESS
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|i
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|boot-&gt;live
)paren
suffix:semicolon
id|diva_os_wait
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|READ_DWORD
c_func
(paren
op_amp
id|boot-&gt;live
)paren
)paren
(brace
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|boot
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) CPU on PRI %ld is not alive!&quot;
comma
id|IoAdapter-&gt;ANum
comma
id|IoAdapter-&gt;serialNo
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|READ_DWORD
c_func
(paren
op_amp
id|boot-&gt;err
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) PRI %ld Board Selftest failed, error=%08lx&quot;
comma
id|IoAdapter-&gt;ANum
comma
id|IoAdapter-&gt;serialNo
comma
id|READ_DWORD
c_func
(paren
op_amp
id|boot-&gt;err
)paren
)paren
)paren
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|boot
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|boot
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Forget all outstanding entities&n;&t; */
id|IoAdapter-&gt;e_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;e_tbl
)paren
(brace
id|memset
c_func
(paren
id|IoAdapter-&gt;e_tbl
comma
l_int|0x00
comma
id|IoAdapter-&gt;e_max
op_star
r_sizeof
(paren
id|E_INFO
)paren
)paren
suffix:semicolon
)brace
id|IoAdapter-&gt;head
op_assign
l_int|0
suffix:semicolon
id|IoAdapter-&gt;tail
op_assign
l_int|0
suffix:semicolon
id|IoAdapter-&gt;assign
op_assign
l_int|0
suffix:semicolon
id|IoAdapter-&gt;trapped
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.IdTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.IdTable
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.IdTypeTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.IdTypeTable
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.FlowControlIdTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.FlowControlIdTable
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.FlowControlSkipTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.FlowControlSkipTable
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.misc_flags_table
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.misc_flags_table
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.rx_stream
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.rx_stream
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.tx_stream
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.tx_stream
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.tx_pos
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.tx_pos
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|IoAdapter-&gt;a.rx_pos
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|IoAdapter-&gt;a.rx_pos
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|diva_pri_write_sdram_block
id|diva_pri_write_sdram_block
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
id|dword
id|address
comma
r_const
id|byte
op_star
id|data
comma
id|dword
id|length
comma
id|dword
id|limit
)paren
(brace
id|byte
id|__iomem
op_star
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_ADDRESS
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|byte
id|__iomem
op_star
id|mem
op_assign
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|address
op_plus
id|length
)paren
op_ge
id|limit
)paren
op_logical_or
op_logical_neg
id|mem
)paren
(brace
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) write PRI address=0x%08lx&quot;
comma
id|IoAdapter-&gt;ANum
comma
id|address
op_plus
id|length
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|mem
op_add_assign
id|address
suffix:semicolon
multiline_comment|/* memcpy_toio(), maybe? */
r_while
c_loop
(paren
id|length
op_decrement
)paren
(brace
id|WRITE_BYTE
c_func
(paren
id|mem
op_increment
comma
op_star
id|data
op_increment
)paren
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|diva_pri_start_adapter
id|diva_pri_start_adapter
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
id|dword
id|start_address
comma
id|dword
id|features
)paren
(brace
id|dword
id|i
suffix:semicolon
r_int
id|started
op_assign
l_int|0
suffix:semicolon
id|byte
id|__iomem
op_star
id|p
suffix:semicolon
r_struct
id|mp_load
id|__iomem
op_star
id|boot
op_assign
(paren
r_struct
id|mp_load
id|__iomem
op_star
)paren
id|DIVA_OS_MEM_ATTACH_ADDRESS
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|ADAPTER
op_star
id|a
op_assign
op_amp
id|IoAdapter-&gt;a
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;Initialized
)paren
(brace
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|boot
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) pri_start_adapter, adapter already running&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|boot
)paren
(brace
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|boot
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: PRI %ld can&squot;t start, adapter not mapped&quot;
comma
id|IoAdapter-&gt;serialNo
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|IoAdapter-&gt;Name
comma
l_string|&quot;A(%d)&quot;
comma
(paren
r_int
)paren
id|IoAdapter-&gt;ANum
)paren
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;A(%d) start PRI at 0x%08lx&quot;
comma
id|IoAdapter-&gt;ANum
comma
id|start_address
)paren
)paren
id|WRITE_DWORD
c_func
(paren
op_amp
id|boot-&gt;addr
comma
id|start_address
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
op_amp
id|boot-&gt;cmd
comma
l_int|3
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|300
suffix:semicolon
op_increment
id|i
)paren
(brace
id|diva_os_wait
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|READ_DWORD
c_func
(paren
op_amp
id|boot-&gt;signature
)paren
op_rshift
l_int|16
)paren
op_eq
l_int|0x4447
)paren
(brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;A(%d) Protocol startup time %d.%02d seconds&quot;
comma
id|IoAdapter-&gt;ANum
comma
(paren
id|i
op_div
l_int|100
)paren
comma
(paren
id|i
op_mod
l_int|100
)paren
)paren
)paren
id|started
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|started
)paren
(brace
id|byte
id|__iomem
op_star
id|p
op_assign
(paren
id|byte
id|__iomem
op_star
)paren
id|boot
suffix:semicolon
id|dword
id|TrapId
suffix:semicolon
id|dword
id|debug
suffix:semicolon
id|TrapId
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|p
(braket
l_int|0x80
)braket
)paren
suffix:semicolon
id|debug
op_assign
id|READ_DWORD
c_func
(paren
op_amp
id|p
(braket
l_int|0x1c
)braket
)paren
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A(%d) Adapter start failed 0x%08lx, TrapId=%08lx, debug=%08lx&quot;
comma
id|IoAdapter-&gt;ANum
comma
id|READ_DWORD
c_func
(paren
op_amp
id|boot-&gt;signature
)paren
comma
id|TrapId
comma
id|debug
)paren
)paren
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|boot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;trapFnc
)paren
(brace
(paren
op_star
(paren
id|IoAdapter-&gt;trapFnc
)paren
)paren
(paren
id|IoAdapter
)paren
suffix:semicolon
)brace
id|IoAdapter
op_member_access_from_pointer
id|stop
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
id|IoAdapter
comma
id|boot
)paren
suffix:semicolon
id|IoAdapter-&gt;Initialized
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/*&n;&t;   Check Interrupt&n;&t; */
id|IoAdapter-&gt;IrqCount
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_CFG
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|p
comma
(paren
id|dword
)paren
op_complement
l_int|0x03E00000
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CFG
c_func
(paren
id|IoAdapter
comma
id|p
)paren
suffix:semicolon
id|a-&gt;ReadyInt
op_assign
l_int|1
suffix:semicolon
id|a
op_member_access_from_pointer
id|ram_out
c_func
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;ReadyInt
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|100
suffix:semicolon
op_logical_neg
id|IoAdapter-&gt;IrqCount
op_logical_and
(paren
id|i
op_decrement
OG
l_int|0
)paren
suffix:semicolon
id|diva_os_wait
c_func
(paren
l_int|10
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;IrqCount
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) interrupt test failed&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
id|IoAdapter-&gt;Initialized
op_assign
id|FALSE
suffix:semicolon
id|IoAdapter
op_member_access_from_pointer
id|stop
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|IoAdapter-&gt;Properties.Features
op_assign
(paren
id|word
)paren
id|features
suffix:semicolon
id|diva_xdi_display_adapter_features
c_func
(paren
id|IoAdapter-&gt;ANum
)paren
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;A(%d) PRI adapter successfull started&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
multiline_comment|/*&n;&t;   Register with DIDD&n;&t; */
id|diva_xdi_didd_register_adapter
c_func
(paren
id|IoAdapter-&gt;ANum
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|diva_pri_clear_interrupts
r_static
r_void
id|diva_pri_clear_interrupts
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|PISDN_ADAPTER
id|IoAdapter
op_assign
op_amp
id|a-&gt;xdi_adapter
suffix:semicolon
multiline_comment|/*&n;&t;   clear any pending interrupt&n;&t; */
id|IoAdapter
op_member_access_from_pointer
id|disIrq
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
id|IoAdapter
op_member_access_from_pointer
id|tst_irq
c_func
(paren
op_amp
id|IoAdapter-&gt;a
)paren
suffix:semicolon
id|IoAdapter
op_member_access_from_pointer
id|clr_irq
c_func
(paren
op_amp
id|IoAdapter-&gt;a
)paren
suffix:semicolon
id|IoAdapter
op_member_access_from_pointer
id|tst_irq
c_func
(paren
op_amp
id|IoAdapter-&gt;a
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   kill pending dpcs&n;&t; */
id|diva_os_cancel_soft_isr
c_func
(paren
op_amp
id|IoAdapter-&gt;req_soft_isr
)paren
suffix:semicolon
id|diva_os_cancel_soft_isr
c_func
(paren
op_amp
id|IoAdapter-&gt;isr_soft_isr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  Stop Adapter, but do not unmap/unregister - adapter&n;**  will be restarted later&n;*/
DECL|function|diva_pri_stop_adapter
r_static
r_int
id|diva_pri_stop_adapter
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|PISDN_ADAPTER
id|IoAdapter
op_assign
op_amp
id|a-&gt;xdi_adapter
suffix:semicolon
r_int
id|i
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;ram
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;Initialized
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) can&squot;t stop PRI adapter - not running&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* nothing to stop */
)brace
id|IoAdapter-&gt;Initialized
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;   Disconnect Adapter from DIDD&n;&t; */
id|diva_xdi_didd_remove_adapter
c_func
(paren
id|IoAdapter-&gt;ANum
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Stop interrupts&n;&t; */
id|a-&gt;clear_interrupts_proc
op_assign
id|diva_pri_clear_interrupts
suffix:semicolon
id|IoAdapter-&gt;a.ReadyInt
op_assign
l_int|1
suffix:semicolon
id|IoAdapter-&gt;a
dot
id|ram_inc
c_func
(paren
op_amp
id|IoAdapter-&gt;a
comma
op_amp
id|PR_RAM-&gt;ReadyInt
)paren
suffix:semicolon
r_do
(brace
id|diva_os_sleep
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_decrement
op_logical_and
id|a-&gt;clear_interrupts_proc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;clear_interrupts_proc
)paren
(brace
id|diva_pri_clear_interrupts
c_func
(paren
id|a
)paren
suffix:semicolon
id|a-&gt;clear_interrupts_proc
op_assign
l_int|NULL
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) no final interrupt from PRI adapter&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
)brace
id|IoAdapter-&gt;a.ReadyInt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;   Stop and reset adapter&n;&t; */
id|IoAdapter
op_member_access_from_pointer
id|stop
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  Process commands form configuration/download framework and from&n;**  user mode&n;**&n;**  return 0 on success&n;*/
r_static
r_int
DECL|function|diva_pri_cmd_card_proc
id|diva_pri_cmd_card_proc
c_func
(paren
r_struct
id|_diva_os_xdi_adapter
op_star
id|a
comma
id|diva_xdi_um_cfg_cmd_t
op_star
id|cmd
comma
r_int
id|length
)paren
(brace
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;adapter
op_ne
id|a-&gt;controller
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: pri_cmd, invalid controller=%d != %d&quot;
comma
id|cmd-&gt;adapter
comma
id|a-&gt;controller
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd-&gt;command
)paren
(brace
r_case
id|DIVA_XDI_UM_CMD_GET_CARD_ORDINAL
suffix:colon
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
op_star
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
op_assign
(paren
id|dword
)paren
id|a-&gt;CardOrdinal
suffix:semicolon
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_GET_SERIAL_NR
suffix:colon
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
op_star
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
op_assign
(paren
id|dword
)paren
id|a-&gt;xdi_adapter.serialNo
suffix:semicolon
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_GET_PCI_HW_CONFIG
suffix:colon
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
op_star
l_int|9
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
r_int
id|i
suffix:semicolon
id|dword
op_star
id|data
op_assign
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|data
op_increment
op_assign
id|a-&gt;resources.pci.bar
(braket
id|i
)braket
suffix:semicolon
)brace
op_star
id|data
op_increment
op_assign
(paren
id|dword
)paren
id|a-&gt;resources.pci.irq
suffix:semicolon
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_RESET_ADAPTER
suffix:colon
id|ret
op_assign
id|diva_pri_reset_adapter
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_WRITE_SDRAM_BLOCK
suffix:colon
id|ret
op_assign
id|diva_pri_write_sdram_block
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|cmd-&gt;command_data
dot
id|write_sdram.offset
comma
(paren
id|byte
op_star
)paren
op_amp
id|cmd
(braket
l_int|1
)braket
comma
id|cmd-&gt;command_data
dot
id|write_sdram.length
comma
id|pri_is_rev_2_card
c_func
(paren
id|a
op_member_access_from_pointer
id|CardOrdinal
)paren
ques
c_cond
id|MP2_MEMORY_SIZE
suffix:colon
id|MP_MEMORY_SIZE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_STOP_ADAPTER
suffix:colon
id|ret
op_assign
id|diva_pri_stop_adapter
c_func
(paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_START_ADAPTER
suffix:colon
id|ret
op_assign
id|diva_pri_start_adapter
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|cmd-&gt;command_data.start
dot
id|offset
comma
id|cmd-&gt;command_data.start
dot
id|features
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_SET_PROTOCOL_FEATURES
suffix:colon
id|a-&gt;xdi_adapter.features
op_assign
id|cmd-&gt;command_data.features.features
suffix:semicolon
id|a-&gt;xdi_adapter.a.protocol_capabilities
op_assign
id|a-&gt;xdi_adapter.features
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Set raw protocol features (%08x)&quot;
comma
id|a-&gt;xdi_adapter.features
)paren
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_GET_CARD_STATE
suffix:colon
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
id|dword
op_star
id|data
op_assign
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.ram
op_logical_or
op_logical_neg
id|a-&gt;xdi_adapter.reset
op_logical_or
op_logical_neg
id|a-&gt;xdi_adapter.cfg
)paren
(brace
op_star
id|data
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.trapped
)paren
(brace
op_star
id|data
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.Initialized
)paren
(brace
op_star
id|data
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
op_star
id|data
op_assign
l_int|0
suffix:semicolon
)brace
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_READ_XLOG_ENTRY
suffix:colon
id|ret
op_assign
id|diva_card_read_xlog
c_func
(paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_READ_SDRAM
suffix:colon
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.Address
)paren
(brace
r_if
c_cond
(paren
(paren
id|a-&gt;xdi_mbox.data_length
op_assign
id|cmd-&gt;command_data.read_sdram.length
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|a-&gt;xdi_mbox.data_length
op_plus
id|cmd-&gt;command_data.read_sdram.offset
)paren
OL
id|a-&gt;xdi_adapter.MemorySize
)paren
(brace
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
id|a-&gt;xdi_mbox
dot
id|data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
id|byte
id|__iomem
op_star
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_ADDRESS
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
id|byte
id|__iomem
op_star
id|src
op_assign
id|p
suffix:semicolon
id|byte
op_star
id|dst
op_assign
id|a-&gt;xdi_mbox.data
suffix:semicolon
id|dword
id|len
op_assign
id|a-&gt;xdi_mbox.data_length
suffix:semicolon
id|src
op_add_assign
id|cmd-&gt;command_data.read_sdram.offset
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
op_star
id|dst
op_increment
op_assign
id|READ_BYTE
c_func
(paren
id|src
op_increment
)paren
suffix:semicolon
)brace
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|DIVA_OS_MEM_DETACH_ADDRESS
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|p
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) invalid cmd=%d&quot;
comma
id|a-&gt;controller
comma
id|cmd-&gt;command
)paren
)paren
)brace
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  Get Serial Number&n;*/
DECL|function|pri_get_serial_number
r_static
r_int
id|pri_get_serial_number
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|byte
id|data
(braket
l_int|64
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dword
id|len
op_assign
r_sizeof
(paren
id|data
)paren
suffix:semicolon
r_volatile
id|byte
id|__iomem
op_star
id|config
suffix:semicolon
r_volatile
id|byte
id|__iomem
op_star
id|flash
suffix:semicolon
id|byte
id|c
suffix:semicolon
multiline_comment|/*&n; *  First set some GT6401x config registers before accessing the BOOT-ROM&n; */
id|config
op_assign
id|DIVA_OS_MEM_ATTACH_CONFIG
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
id|c
op_assign
id|READ_BYTE
c_func
(paren
op_amp
id|config
(braket
l_int|0xc3c
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|c
op_amp
l_int|0x08
)paren
)paren
(brace
id|WRITE_BYTE
c_func
(paren
op_amp
id|config
(braket
l_int|0xc3c
)braket
comma
id|c
)paren
suffix:semicolon
multiline_comment|/* Base Address enable register */
)brace
id|WRITE_BYTE
c_func
(paren
op_amp
id|config
(braket
id|LOW_BOOTCS_DREG
)braket
comma
l_int|0x00
)paren
suffix:semicolon
id|WRITE_BYTE
c_func
(paren
op_amp
id|config
(braket
id|HI_BOOTCS_DREG
)braket
comma
l_int|0xFF
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CONFIG
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|config
)paren
suffix:semicolon
multiline_comment|/*&n; *  Read only the last 64 bytes of manufacturing data&n; */
id|memset
c_func
(paren
id|data
comma
l_char|&squot;&bslash;0&squot;
comma
id|len
)paren
suffix:semicolon
id|flash
op_assign
id|DIVA_OS_MEM_ATTACH_PROM
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
(braket
id|i
)braket
op_assign
id|READ_BYTE
c_func
(paren
op_amp
id|flash
(braket
l_int|0x8000
op_minus
id|len
op_plus
id|i
)braket
)paren
suffix:semicolon
)brace
id|DIVA_OS_MEM_DETACH_PROM
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|flash
)paren
suffix:semicolon
id|config
op_assign
id|DIVA_OS_MEM_ATTACH_CONFIG
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
id|WRITE_BYTE
c_func
(paren
op_amp
id|config
(braket
id|LOW_BOOTCS_DREG
)braket
comma
l_int|0xFC
)paren
suffix:semicolon
multiline_comment|/* Disable FLASH EPROM access */
id|WRITE_BYTE
c_func
(paren
op_amp
id|config
(braket
id|HI_BOOTCS_DREG
)braket
comma
l_int|0xFF
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CONFIG
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|data
(braket
l_int|48
)braket
comma
l_string|&quot;DIVAserverPR&quot;
comma
l_int|12
)paren
)paren
(brace
macro_line|#if !defined(DIVA_PRI_NO_PCI_BIOS_WORKAROUND)&t;/* { */
id|word
id|cmd
op_assign
l_int|0
comma
id|cmd_org
suffix:semicolon
r_void
op_star
id|addr
suffix:semicolon
id|dword
id|addr1
comma
id|addr3
comma
id|addr4
suffix:semicolon
id|byte
id|Bus
comma
id|Slot
suffix:semicolon
r_void
op_star
id|hdev
suffix:semicolon
id|addr4
op_assign
id|a-&gt;resources.pci.bar
(braket
l_int|4
)braket
suffix:semicolon
id|addr3
op_assign
id|a-&gt;resources.pci.bar
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* flash  */
id|addr1
op_assign
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* unused */
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: apply Compaq BIOS workaround&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x&quot;
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
comma
id|data
(braket
l_int|2
)braket
comma
id|data
(braket
l_int|3
)braket
comma
id|data
(braket
l_int|4
)braket
comma
id|data
(braket
l_int|5
)braket
comma
id|data
(braket
l_int|6
)braket
comma
id|data
(braket
l_int|7
)braket
)paren
)paren
id|Bus
op_assign
id|a-&gt;resources.pci.bus
suffix:semicolon
id|Slot
op_assign
id|a-&gt;resources.pci.func
suffix:semicolon
id|hdev
op_assign
id|a-&gt;resources.pci.hdev
suffix:semicolon
id|PCIread
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x04
comma
op_amp
id|cmd_org
comma
r_sizeof
(paren
id|cmd_org
)paren
comma
id|hdev
)paren
suffix:semicolon
id|PCIwrite
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x04
comma
op_amp
id|cmd
comma
r_sizeof
(paren
id|cmd
)paren
comma
id|hdev
)paren
suffix:semicolon
id|PCIwrite
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x14
comma
op_amp
id|addr4
comma
r_sizeof
(paren
id|addr4
)paren
comma
id|hdev
)paren
suffix:semicolon
id|PCIwrite
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x20
comma
op_amp
id|addr1
comma
r_sizeof
(paren
id|addr1
)paren
comma
id|hdev
)paren
suffix:semicolon
id|PCIwrite
c_func
(paren
id|Bus
comma
id|Slot
comma
l_int|0x04
comma
op_amp
id|cmd_org
comma
r_sizeof
(paren
id|cmd_org
)paren
comma
id|hdev
)paren
suffix:semicolon
id|addr
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|1
)braket
suffix:semicolon
id|a-&gt;resources.pci.addr
(braket
l_int|1
)braket
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|4
)braket
suffix:semicolon
id|a-&gt;resources.pci.addr
(braket
l_int|4
)braket
op_assign
id|addr
suffix:semicolon
id|addr1
op_assign
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
suffix:semicolon
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
op_assign
id|a-&gt;resources.pci.bar
(braket
l_int|4
)braket
suffix:semicolon
id|a-&gt;resources.pci.bar
(braket
l_int|4
)braket
op_assign
id|addr1
suffix:semicolon
multiline_comment|/*&n;&t;&t;   Try to read Flash again&n;&t;&t; */
id|len
op_assign
r_sizeof
(paren
id|data
)paren
suffix:semicolon
id|config
op_assign
id|DIVA_OS_MEM_ATTACH_CONFIG
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|config
(braket
l_int|0xc3c
)braket
op_amp
l_int|0x08
)paren
)paren
(brace
id|config
(braket
l_int|0xc3c
)braket
op_or_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* Base Address enable register */
)brace
id|config
(braket
id|LOW_BOOTCS_DREG
)braket
op_assign
l_int|0x00
suffix:semicolon
id|config
(braket
id|HI_BOOTCS_DREG
)braket
op_assign
l_int|0xFF
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CONFIG
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|config
)paren
suffix:semicolon
id|memset
c_func
(paren
id|data
comma
l_char|&squot;&bslash;0&squot;
comma
id|len
)paren
suffix:semicolon
id|flash
op_assign
id|DIVA_OS_MEM_ATTACH_PROM
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
(braket
id|i
)braket
op_assign
id|flash
(braket
l_int|0x8000
op_minus
id|len
op_plus
id|i
)braket
suffix:semicolon
)brace
id|DIVA_OS_MEM_ATTACH_PROM
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|flash
)paren
suffix:semicolon
id|config
op_assign
id|DIVA_OS_MEM_ATTACH_CONFIG
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
id|config
(braket
id|LOW_BOOTCS_DREG
)braket
op_assign
l_int|0xFC
suffix:semicolon
id|config
(braket
id|HI_BOOTCS_DREG
)braket
op_assign
l_int|0xFF
suffix:semicolon
id|DIVA_OS_MEM_DETACH_CONFIG
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|data
(braket
l_int|48
)braket
comma
l_string|&quot;DIVAserverPR&quot;
comma
l_int|12
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: failed to read serial number&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x&quot;
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
comma
id|data
(braket
l_int|2
)braket
comma
id|data
(braket
l_int|3
)braket
comma
id|data
(braket
l_int|4
)braket
comma
id|data
(braket
l_int|5
)braket
comma
id|data
(braket
l_int|6
)braket
comma
id|data
(braket
l_int|7
)braket
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#else&t;&t;&t;&t;/* } { */
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: failed to read DIVA signature word&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;%02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x&quot;
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
comma
id|data
(braket
l_int|2
)braket
comma
id|data
(braket
l_int|3
)braket
comma
id|data
(braket
l_int|4
)braket
comma
id|data
(braket
l_int|5
)braket
comma
id|data
(braket
l_int|6
)braket
comma
id|data
(braket
l_int|7
)braket
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;%02x:%02x:%02x:%02x&quot;
comma
id|data
(braket
l_int|47
)braket
comma
id|data
(braket
l_int|46
)braket
comma
id|data
(braket
l_int|45
)braket
comma
id|data
(braket
l_int|44
)braket
)paren
)paren
macro_line|#endif&t;&t;&t;&t;/* } */
)brace
id|a-&gt;xdi_adapter.serialNo
op_assign
(paren
id|data
(braket
l_int|47
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|data
(braket
l_int|46
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|data
(braket
l_int|45
)braket
op_lshift
l_int|8
)paren
op_or
id|data
(braket
l_int|44
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.serialNo
op_logical_or
(paren
id|a-&gt;xdi_adapter.serialNo
op_eq
l_int|0xffffffff
)paren
)paren
(brace
id|a-&gt;xdi_adapter.serialNo
op_assign
l_int|0
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: failed to read serial number&quot;
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;Serial No.          : %ld&quot;
comma
id|a-&gt;xdi_adapter.serialNo
)paren
)paren
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Board Revision      : %d.%02d&quot;
comma
(paren
r_int
)paren
id|data
(braket
l_int|41
)braket
comma
(paren
r_int
)paren
id|data
(braket
l_int|40
)braket
)paren
)paren
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;PLD revision        : %d.%02d&quot;
comma
(paren
r_int
)paren
id|data
(braket
l_int|33
)braket
comma
(paren
r_int
)paren
id|data
(braket
l_int|32
)braket
)paren
)paren
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Boot loader version : %d.%02d&quot;
comma
(paren
r_int
)paren
id|data
(braket
l_int|37
)braket
comma
(paren
r_int
)paren
id|data
(braket
l_int|36
)braket
)paren
)paren
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Manufacturing Date  : %d/%02d/%02d  (yyyy/mm/dd)&quot;
comma
(paren
r_int
)paren
(paren
(paren
id|data
(braket
l_int|28
)braket
OG
l_int|90
)paren
ques
c_cond
l_int|1900
suffix:colon
l_int|2000
)paren
op_plus
(paren
r_int
)paren
id|data
(braket
l_int|28
)braket
comma
(paren
r_int
)paren
id|data
(braket
l_int|29
)braket
comma
(paren
r_int
)paren
id|data
(braket
l_int|30
)braket
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|diva_os_prepare_pri2_functions
r_void
id|diva_os_prepare_pri2_functions
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
)brace
DECL|function|diva_os_prepare_pri_functions
r_void
id|diva_os_prepare_pri_functions
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
)brace
multiline_comment|/*&n;**  Checks presence of DSP on board&n;*/
r_static
r_int
DECL|function|dsp_check_presence
id|dsp_check_presence
c_func
(paren
r_volatile
id|byte
id|__iomem
op_star
id|addr
comma
r_volatile
id|byte
id|__iomem
op_star
id|data
comma
r_int
id|dsp
)paren
(brace
id|word
id|pattern
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|addr
comma
l_int|0x4000
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|data
comma
id|DSP_SIGNATURE_PROBE_WORD
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|addr
comma
l_int|0x4000
)paren
suffix:semicolon
id|pattern
op_assign
id|READ_WORD
c_func
(paren
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pattern
op_ne
id|DSP_SIGNATURE_PROBE_WORD
)paren
(brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;W: DSP[%d] %04x(is) != %04x(should)&quot;
comma
id|dsp
comma
id|pattern
comma
id|DSP_SIGNATURE_PROBE_WORD
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|WRITE_WORD
c_func
(paren
id|addr
comma
l_int|0x4000
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|data
comma
op_complement
id|DSP_SIGNATURE_PROBE_WORD
)paren
suffix:semicolon
id|WRITE_WORD
c_func
(paren
id|addr
comma
l_int|0x4000
)paren
suffix:semicolon
id|pattern
op_assign
id|READ_WORD
c_func
(paren
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pattern
op_ne
(paren
id|word
)paren
op_complement
id|DSP_SIGNATURE_PROBE_WORD
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: DSP[%d] %04x(is) != %04x(should)&quot;
comma
id|dsp
comma
id|pattern
comma
(paren
id|word
)paren
op_complement
id|DSP_SIGNATURE_PROBE_WORD
)paren
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;DSP[%d] present&quot;
comma
id|dsp
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  Check if DSP&squot;s are present and operating&n;**  Information about detected DSP&squot;s is returned as bit mask&n;**  Bit 0  - DSP1&n;**  ...&n;**  ...&n;**  ...&n;**  Bit 29 - DSP30&n;*/
DECL|function|diva_pri_detect_dsps
r_static
id|dword
id|diva_pri_detect_dsps
c_func
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|byte
id|__iomem
op_star
id|base
suffix:semicolon
id|byte
id|__iomem
op_star
id|p
suffix:semicolon
id|dword
id|ret
op_assign
l_int|0
suffix:semicolon
id|dword
id|row_offset
(braket
l_int|7
)braket
op_assign
(brace
l_int|0x00000000
comma
l_int|0x00000800
comma
multiline_comment|/* 1 - ROW 1 */
l_int|0x00000840
comma
multiline_comment|/* 2 - ROW 2 */
l_int|0x00001000
comma
multiline_comment|/* 3 - ROW 3 */
l_int|0x00001040
comma
multiline_comment|/* 4 - ROW 4 */
l_int|0x00000000
multiline_comment|/* 5 - ROW 0 */
)brace
suffix:semicolon
id|byte
id|__iomem
op_star
id|dsp_addr_port
suffix:semicolon
id|byte
id|__iomem
op_star
id|dsp_data_port
suffix:semicolon
id|byte
id|row_state
suffix:semicolon
r_int
id|dsp_row
op_assign
l_int|0
comma
id|dsp_index
comma
id|dsp_num
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.Control
op_logical_or
op_logical_neg
id|a-&gt;xdi_adapter.reset
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
id|WRITE_BYTE
c_func
(paren
id|p
comma
id|_MP_RISC_RESET
op_or
id|_MP_DSP_RESET
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|p
)paren
suffix:semicolon
id|diva_os_wait
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|base
op_assign
id|DIVA_OS_MEM_ATTACH_CONTROL
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dsp_num
op_assign
l_int|0
suffix:semicolon
id|dsp_num
OL
l_int|30
suffix:semicolon
id|dsp_num
op_increment
)paren
(brace
id|dsp_row
op_assign
id|dsp_num
op_div
l_int|7
op_plus
l_int|1
suffix:semicolon
id|dsp_index
op_assign
id|dsp_num
op_mod
l_int|7
suffix:semicolon
id|dsp_data_port
op_assign
id|base
suffix:semicolon
id|dsp_addr_port
op_assign
id|base
suffix:semicolon
id|dsp_data_port
op_add_assign
id|row_offset
(braket
id|dsp_row
)braket
suffix:semicolon
id|dsp_addr_port
op_add_assign
id|row_offset
(braket
id|dsp_row
)braket
suffix:semicolon
id|dsp_data_port
op_add_assign
(paren
id|dsp_index
op_star
l_int|8
)paren
suffix:semicolon
id|dsp_addr_port
op_add_assign
(paren
id|dsp_index
op_star
l_int|8
)paren
op_plus
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dsp_check_presence
(paren
id|dsp_addr_port
comma
id|dsp_data_port
comma
id|dsp_num
op_plus
l_int|1
)paren
)paren
(brace
id|ret
op_or_assign
(paren
l_int|1
op_lshift
id|dsp_num
)paren
suffix:semicolon
)brace
)brace
id|DIVA_OS_MEM_DETACH_CONTROL
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|base
)paren
suffix:semicolon
id|p
op_assign
id|DIVA_OS_MEM_ATTACH_RESET
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
id|WRITE_BYTE
c_func
(paren
id|p
comma
id|_MP_RISC_RESET
op_or
id|_MP_LED1
op_or
id|_MP_LED2
)paren
suffix:semicolon
id|DIVA_OS_MEM_DETACH_RESET
c_func
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|p
)paren
suffix:semicolon
id|diva_os_wait
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   Verify modules&n;&t; */
r_for
c_loop
(paren
id|dsp_row
op_assign
l_int|0
suffix:semicolon
id|dsp_row
OL
l_int|4
suffix:semicolon
id|dsp_row
op_increment
)paren
(brace
id|row_state
op_assign
(paren
(paren
id|ret
op_rshift
(paren
id|dsp_row
op_star
l_int|7
)paren
)paren
op_amp
l_int|0x7F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|row_state
op_logical_and
(paren
id|row_state
op_ne
l_int|0x7F
)paren
)paren
(brace
r_for
c_loop
(paren
id|dsp_index
op_assign
l_int|0
suffix:semicolon
id|dsp_index
OL
l_int|7
suffix:semicolon
id|dsp_index
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|row_state
op_amp
(paren
l_int|1
op_lshift
id|dsp_index
)paren
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: MODULE[%d]-DSP[%d] failed&quot;
comma
id|dsp_row
op_plus
l_int|1
comma
id|dsp_index
op_plus
l_int|1
)paren
)paren
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_amp
l_int|0x10000000
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: ON BOARD-DSP[1] failed&quot;
)paren
)paren
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_amp
l_int|0x20000000
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: ON BOARD-DSP[2] failed&quot;
)paren
)paren
)brace
multiline_comment|/*&n;&t;   Print module population now&n;&t; */
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;+-----------------------+&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;| DSP MODULE POPULATION |&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;+-----------------------+&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;|  1  |  2  |  3  |  4  |&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;+-----------------------+&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;|  %s  |  %s  |  %s  |  %s  |&quot;
comma
(paren
(paren
id|ret
op_rshift
(paren
l_int|0
op_star
l_int|7
)paren
)paren
op_amp
l_int|0x7F
)paren
ques
c_cond
l_string|&quot;Y&quot;
suffix:colon
l_string|&quot;N&quot;
comma
(paren
(paren
id|ret
op_rshift
(paren
l_int|1
op_star
l_int|7
)paren
)paren
op_amp
l_int|0x7F
)paren
ques
c_cond
l_string|&quot;Y&quot;
suffix:colon
l_string|&quot;N&quot;
comma
(paren
(paren
id|ret
op_rshift
(paren
l_int|2
op_star
l_int|7
)paren
)paren
op_amp
l_int|0x7F
)paren
ques
c_cond
l_string|&quot;Y&quot;
suffix:colon
l_string|&quot;N&quot;
comma
(paren
(paren
id|ret
op_rshift
(paren
l_int|3
op_star
l_int|7
)paren
)paren
op_amp
l_int|0x7F
)paren
ques
c_cond
l_string|&quot;Y&quot;
suffix:colon
l_string|&quot;N&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;+-----------------------+&quot;
)paren
)paren
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;DSP&squot;s(present-absent):%08x-%08x&quot;
comma
id|ret
comma
op_complement
id|ret
op_amp
l_int|0x3fffffff
)paren
)paren
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
eof
