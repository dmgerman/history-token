multiline_comment|/*&n; *&n;  Copyright (c) Eicon Networks, 2002.&n; *&n;  This source file is supplied for the use with&n;  Eicon Networks range of DIVA Server Adapters.&n; *&n;  Eicon File Revision :    2.1&n; *&n;  This program is free software; you can redistribute it and/or modify&n;  it under the terms of the GNU General Public License as published by&n;  the Free Software Foundation; either version 2, or (at your option)&n;  any later version.&n; *&n;  This program is distributed in the hope that it will be useful,&n;  but WITHOUT ANY WARRANTY OF ANY KIND WHATSOEVER INCLUDING ANY&n;  implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n;  See the GNU General Public License for more details.&n; *&n;  You should have received a copy of the GNU General Public License&n;  along with this program; if not, write to the Free Software&n;  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;diva_dma.h&quot;
multiline_comment|/*&n;  Every entry has length of PAGE_SIZE&n;  and represents one single physical page&n;  */
DECL|struct|_diva_dma_map_entry
r_struct
id|_diva_dma_map_entry
(brace
DECL|member|busy
r_int
id|busy
suffix:semicolon
DECL|member|phys_bus_addr
id|dword
id|phys_bus_addr
suffix:semicolon
multiline_comment|/* 32bit address as seen by the card */
DECL|member|local_ram_addr
r_void
op_star
id|local_ram_addr
suffix:semicolon
multiline_comment|/* local address as seen by the host */
DECL|member|addr_handle
r_void
op_star
id|addr_handle
suffix:semicolon
multiline_comment|/* handle uset to free allocated memory */
)brace
suffix:semicolon
multiline_comment|/*&n;  Create local mapping structure and init it to default state&n;  */
DECL|function|diva_alloc_dma_map
r_struct
id|_diva_dma_map_entry
op_star
id|diva_alloc_dma_map
(paren
r_void
op_star
id|os_context
comma
r_int
id|nentries
)paren
(brace
id|diva_dma_map_entry_t
op_star
id|pmap
op_assign
id|diva_os_malloc
c_func
(paren
l_int|0
comma
r_sizeof
(paren
op_star
id|pmap
)paren
op_star
(paren
id|nentries
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmap
)paren
id|memset
(paren
id|pmap
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|pmap
)paren
op_star
(paren
id|nentries
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_return
id|pmap
suffix:semicolon
)brace
multiline_comment|/*&n;  Free local map (context should be freed before) if any&n;  */
DECL|function|diva_free_dma_mapping
r_void
id|diva_free_dma_mapping
(paren
r_struct
id|_diva_dma_map_entry
op_star
id|pmap
)paren
(brace
r_if
c_cond
(paren
id|pmap
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|pmap
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;  Set information saved on the map entry&n;  */
DECL|function|diva_init_dma_map_entry
r_void
id|diva_init_dma_map_entry
(paren
r_struct
id|_diva_dma_map_entry
op_star
id|pmap
comma
r_int
id|nr
comma
r_void
op_star
id|virt
comma
id|dword
id|phys
comma
r_void
op_star
id|addr_handle
)paren
(brace
id|pmap
(braket
id|nr
)braket
dot
id|phys_bus_addr
op_assign
id|phys
suffix:semicolon
id|pmap
(braket
id|nr
)braket
dot
id|local_ram_addr
op_assign
id|virt
suffix:semicolon
id|pmap
(braket
id|nr
)braket
dot
id|addr_handle
op_assign
id|addr_handle
suffix:semicolon
)brace
multiline_comment|/*&n;  Allocate one single entry in the map&n;  */
DECL|function|diva_alloc_dma_map_entry
r_int
id|diva_alloc_dma_map_entry
(paren
r_struct
id|_diva_dma_map_entry
op_star
id|pmap
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|pmap
op_logical_and
id|pmap
(braket
id|i
)braket
dot
id|local_ram_addr
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pmap
(braket
id|i
)braket
dot
id|busy
)paren
(brace
id|pmap
(braket
id|i
)braket
dot
id|busy
op_assign
l_int|1
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;  Free one single entry in the map&n;  */
DECL|function|diva_free_dma_map_entry
r_void
id|diva_free_dma_map_entry
(paren
r_struct
id|_diva_dma_map_entry
op_star
id|pmap
comma
r_int
id|nr
)paren
(brace
id|pmap
(braket
id|nr
)braket
dot
id|busy
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;  Get information saved on the map entry&n;  */
DECL|function|diva_get_dma_map_entry
r_void
id|diva_get_dma_map_entry
(paren
r_struct
id|_diva_dma_map_entry
op_star
id|pmap
comma
r_int
id|nr
comma
r_void
op_star
op_star
id|pvirt
comma
id|dword
op_star
id|pphys
)paren
(brace
op_star
id|pphys
op_assign
id|pmap
(braket
id|nr
)braket
dot
id|phys_bus_addr
suffix:semicolon
op_star
id|pvirt
op_assign
id|pmap
(braket
id|nr
)braket
dot
id|local_ram_addr
suffix:semicolon
)brace
DECL|function|diva_get_entry_handle
r_void
op_star
id|diva_get_entry_handle
(paren
r_struct
id|_diva_dma_map_entry
op_star
id|pmap
comma
r_int
id|nr
)paren
(brace
r_return
(paren
id|pmap
(braket
id|nr
)braket
dot
id|addr_handle
)paren
suffix:semicolon
)brace
eof
