multiline_comment|/* $Id: divasfunc.c,v 1.23.4.2 2004/08/28 20:03:53 armin Exp $&n; *&n; * Low level driver for Eicon DIVA Server ISDN cards.&n; *&n; * Copyright 2000-2003 by Armin Schindler (mac@melware.de)&n; * Copyright 2000-2003 Cytronics &amp; Melware (info@melware.de)&n; *&n; * This software may be used and distributed according to the terms&n; * of the GNU General Public License, incorporated herein by reference.&n; */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;di_defs.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;di.h&quot;
macro_line|#include &quot;io.h&quot;
macro_line|#include &quot;divasync.h&quot;
macro_line|#include &quot;diva.h&quot;
macro_line|#include &quot;xdi_vers.h&quot;
DECL|macro|DBG_MINIMUM
mdefine_line|#define DBG_MINIMUM  (DL_LOG + DL_FTL + DL_ERR)
DECL|macro|DBG_DEFAULT
mdefine_line|#define DBG_DEFAULT  (DBG_MINIMUM + DL_XLOG + DL_REG)
DECL|variable|debugmask
r_static
r_int
id|debugmask
suffix:semicolon
r_extern
r_void
id|DIVA_DIDD_Read
c_func
(paren
r_void
op_star
comma
r_int
)paren
suffix:semicolon
r_extern
id|PISDN_ADAPTER
id|IoAdapters
(braket
id|MAX_ADAPTER
)braket
suffix:semicolon
r_extern
r_char
op_star
id|DRIVERRELEASE_DIVAS
suffix:semicolon
DECL|variable|notify_handle
r_static
id|dword
id|notify_handle
suffix:semicolon
DECL|variable|DAdapter
r_static
id|DESCRIPTOR
id|DAdapter
suffix:semicolon
DECL|variable|MAdapter
r_static
id|DESCRIPTOR
id|MAdapter
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------------&n;    MAINT driver connector section&n;   -------------------------------------------------------------------------- */
DECL|function|no_printf
r_static
r_void
id|no_printf
c_func
(paren
r_int
r_char
op_star
id|x
comma
dot
dot
dot
)paren
(brace
multiline_comment|/* dummy debug function */
)brace
macro_line|#include &quot;debuglib.c&quot;
multiline_comment|/*&n; * get the adapters serial number&n; */
DECL|function|diva_get_vserial_number
r_void
id|diva_get_vserial_number
c_func
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
r_char
op_star
id|buf
)paren
(brace
r_int
id|contr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|contr
op_assign
(paren
(paren
id|IoAdapter-&gt;serialNo
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
)paren
)paren
)paren
(brace
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d-%d&quot;
comma
id|IoAdapter-&gt;serialNo
op_amp
l_int|0x00ffffff
comma
id|contr
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&quot;
comma
id|IoAdapter-&gt;serialNo
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * register a new adapter&n; */
DECL|function|diva_xdi_didd_register_adapter
r_void
id|diva_xdi_didd_register_adapter
c_func
(paren
r_int
id|card
)paren
(brace
id|DESCRIPTOR
id|d
suffix:semicolon
id|IDI_SYNC_REQ
id|req
suffix:semicolon
r_if
c_cond
(paren
id|card
op_logical_and
(paren
(paren
id|card
op_minus
l_int|1
)paren
OL
id|MAX_ADAPTER
)paren
op_logical_and
id|IoAdapters
(braket
id|card
op_minus
l_int|1
)braket
op_logical_and
id|Requests
(braket
id|card
op_minus
l_int|1
)braket
)paren
(brace
id|d.type
op_assign
id|IoAdapters
(braket
id|card
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|Properties.DescType
suffix:semicolon
id|d.request
op_assign
id|Requests
(braket
id|card
op_minus
l_int|1
)braket
suffix:semicolon
id|d.channels
op_assign
id|IoAdapters
(braket
id|card
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|Properties.Channels
suffix:semicolon
id|d.features
op_assign
id|IoAdapters
(braket
id|card
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|Properties.Features
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;DIDD register A(%d) channels=%d&quot;
comma
id|card
comma
id|d.channels
)paren
)paren
multiline_comment|/* workaround for different Name in structure */
id|strlcpy
c_func
(paren
id|IoAdapters
(braket
id|card
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|Name
comma
id|IoAdapters
(braket
id|card
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|Properties.Name
comma
r_sizeof
(paren
id|IoAdapters
(braket
id|card
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|Name
)paren
)paren
suffix:semicolon
id|req.didd_remove_adapter.e.Req
op_assign
l_int|0
suffix:semicolon
id|req.didd_add_adapter.e.Rc
op_assign
id|IDI_SYNC_REQ_DIDD_ADD_ADAPTER
suffix:semicolon
id|req.didd_add_adapter.info.descriptor
op_assign
(paren
r_void
op_star
)paren
op_amp
id|d
suffix:semicolon
id|DAdapter
dot
id|request
c_func
(paren
(paren
id|ENTITY
op_star
)paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.didd_add_adapter.e.Rc
op_ne
l_int|0xff
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;DIDD register A(%d) failed !&quot;
comma
id|card
)paren
)paren
)brace
id|IoAdapters
(braket
id|card
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|os_trap_nfy_Fnc
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * remove an adapter&n; */
DECL|function|diva_xdi_didd_remove_adapter
r_void
id|diva_xdi_didd_remove_adapter
c_func
(paren
r_int
id|card
)paren
(brace
id|IDI_SYNC_REQ
id|req
suffix:semicolon
id|ADAPTER
op_star
id|a
op_assign
op_amp
id|IoAdapters
(braket
id|card
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|a
suffix:semicolon
id|IoAdapters
(braket
id|card
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|os_trap_nfy_Fnc
op_assign
l_int|NULL
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;DIDD de-register A(%d)&quot;
comma
id|card
)paren
)paren
id|req.didd_remove_adapter.e.Req
op_assign
l_int|0
suffix:semicolon
id|req.didd_remove_adapter.e.Rc
op_assign
id|IDI_SYNC_REQ_DIDD_REMOVE_ADAPTER
suffix:semicolon
id|req.didd_remove_adapter.info.p_request
op_assign
(paren
id|IDI_CALL
)paren
id|Requests
(braket
id|card
op_minus
l_int|1
)braket
suffix:semicolon
id|DAdapter
dot
id|request
c_func
(paren
(paren
id|ENTITY
op_star
)paren
op_amp
id|req
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
(paren
id|a-&gt;IdTable
)paren
comma
l_int|0x00
comma
l_int|256
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * start debug&n; */
DECL|function|start_dbg
r_static
r_void
id|start_dbg
c_func
(paren
r_void
)paren
(brace
id|DbgRegister
c_func
(paren
l_string|&quot;DIVAS&quot;
comma
id|DRIVERRELEASE_DIVAS
comma
(paren
id|debugmask
)paren
ques
c_cond
id|debugmask
suffix:colon
id|DBG_DEFAULT
)paren
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;DIVA ISDNXDI BUILD (%s[%s]-%s-%s)&quot;
comma
id|DIVA_BUILD
comma
id|diva_xdi_common_code_build
comma
id|__DATE__
comma
id|__TIME__
)paren
)paren
)brace
multiline_comment|/*&n; * stop debug&n; */
DECL|function|stop_dbg
r_static
r_void
id|stop_dbg
c_func
(paren
r_void
)paren
(brace
id|DbgDeregister
c_func
(paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|MAdapter
comma
l_int|0
comma
r_sizeof
(paren
id|MAdapter
)paren
)paren
suffix:semicolon
id|dprintf
op_assign
id|no_printf
suffix:semicolon
)brace
multiline_comment|/*&n; * didd callback function&n; */
DECL|function|didd_callback
r_static
r_void
op_star
id|didd_callback
c_func
(paren
r_void
op_star
id|context
comma
id|DESCRIPTOR
op_star
id|adapter
comma
r_int
id|removal
)paren
(brace
r_if
c_cond
(paren
id|adapter-&gt;type
op_eq
id|IDI_DADAPTER
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;Notification about IDI_DADAPTER change ! Oops.&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adapter-&gt;type
op_eq
id|IDI_DIMAINT
)paren
(brace
r_if
c_cond
(paren
id|removal
)paren
(brace
id|stop_dbg
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
op_amp
id|MAdapter
comma
id|adapter
comma
r_sizeof
(paren
id|MAdapter
)paren
)paren
suffix:semicolon
id|dprintf
op_assign
(paren
id|DIVA_DI_PRINTF
)paren
id|MAdapter.request
suffix:semicolon
id|start_dbg
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * connect to didd&n; */
DECL|function|connect_didd
r_static
r_int
id|DIVA_INIT_FUNCTION
id|connect_didd
c_func
(paren
r_void
)paren
(brace
r_int
id|x
op_assign
l_int|0
suffix:semicolon
r_int
id|dadapter
op_assign
l_int|0
suffix:semicolon
id|IDI_SYNC_REQ
id|req
suffix:semicolon
id|DESCRIPTOR
id|DIDD_Table
(braket
id|MAX_DESCRIPTORS
)braket
suffix:semicolon
id|DIVA_DIDD_Read
c_func
(paren
id|DIDD_Table
comma
r_sizeof
(paren
id|DIDD_Table
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|MAX_DESCRIPTORS
suffix:semicolon
id|x
op_increment
)paren
(brace
r_if
c_cond
(paren
id|DIDD_Table
(braket
id|x
)braket
dot
id|type
op_eq
id|IDI_DADAPTER
)paren
(brace
multiline_comment|/* DADAPTER found */
id|dadapter
op_assign
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|DAdapter
comma
op_amp
id|DIDD_Table
(braket
id|x
)braket
comma
r_sizeof
(paren
id|DAdapter
)paren
)paren
suffix:semicolon
id|req.didd_notify.e.Req
op_assign
l_int|0
suffix:semicolon
id|req.didd_notify.e.Rc
op_assign
id|IDI_SYNC_REQ_DIDD_REGISTER_ADAPTER_NOTIFY
suffix:semicolon
id|req.didd_notify.info.callback
op_assign
(paren
r_void
op_star
)paren
id|didd_callback
suffix:semicolon
id|req.didd_notify.info.context
op_assign
l_int|NULL
suffix:semicolon
id|DAdapter
dot
id|request
c_func
(paren
(paren
id|ENTITY
op_star
)paren
op_amp
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.didd_notify.e.Rc
op_ne
l_int|0xff
)paren
(brace
id|stop_dbg
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|notify_handle
op_assign
id|req.didd_notify.info.handle
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|DIDD_Table
(braket
id|x
)braket
dot
id|type
op_eq
id|IDI_DIMAINT
)paren
(brace
multiline_comment|/* MAINT found */
id|memcpy
c_func
(paren
op_amp
id|MAdapter
comma
op_amp
id|DIDD_Table
(braket
id|x
)braket
comma
r_sizeof
(paren
id|DAdapter
)paren
)paren
suffix:semicolon
id|dprintf
op_assign
(paren
id|DIVA_DI_PRINTF
)paren
id|MAdapter.request
suffix:semicolon
id|start_dbg
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|dadapter
)paren
(brace
id|stop_dbg
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|dadapter
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * disconnect from didd&n; */
DECL|function|disconnect_didd
r_static
r_void
id|DIVA_EXIT_FUNCTION
id|disconnect_didd
c_func
(paren
r_void
)paren
(brace
id|IDI_SYNC_REQ
id|req
suffix:semicolon
id|stop_dbg
c_func
(paren
)paren
suffix:semicolon
id|req.didd_notify.e.Req
op_assign
l_int|0
suffix:semicolon
id|req.didd_notify.e.Rc
op_assign
id|IDI_SYNC_REQ_DIDD_REMOVE_ADAPTER_NOTIFY
suffix:semicolon
id|req.didd_notify.info.handle
op_assign
id|notify_handle
suffix:semicolon
id|DAdapter
dot
id|request
c_func
(paren
(paren
id|ENTITY
op_star
)paren
op_amp
id|req
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * init&n; */
DECL|function|divasfunc_init
r_int
id|DIVA_INIT_FUNCTION
id|divasfunc_init
c_func
(paren
r_int
id|dbgmask
)paren
(brace
r_char
op_star
id|version
suffix:semicolon
id|debugmask
op_assign
id|dbgmask
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|connect_didd
c_func
(paren
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;divasfunc: failed to connect to DIDD.&quot;
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|version
op_assign
id|diva_xdi_common_code_build
suffix:semicolon
id|divasa_xdi_driver_entry
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * exit&n; */
DECL|function|divasfunc_exit
r_void
id|DIVA_EXIT_FUNCTION
id|divasfunc_exit
c_func
(paren
r_void
)paren
(brace
id|divasa_xdi_driver_unload
c_func
(paren
)paren
suffix:semicolon
id|disconnect_didd
c_func
(paren
)paren
suffix:semicolon
)brace
eof
