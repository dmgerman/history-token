multiline_comment|/* $Id: os_4bri.c,v 1.1.2.2 2002/10/02 14:38:37 armin Exp $ */
macro_line|#include &quot;platform.h&quot;
macro_line|#include &quot;debuglib.h&quot;
macro_line|#include &quot;cardtype.h&quot;
macro_line|#include &quot;dlist.h&quot;
macro_line|#include &quot;pc.h&quot;
macro_line|#include &quot;pr_pc.h&quot;
macro_line|#include &quot;di_defs.h&quot;
macro_line|#include &quot;dsp_defs.h&quot;
macro_line|#include &quot;di.h&quot; 
macro_line|#include &quot;io.h&quot;
macro_line|#include &quot;xdi_msg.h&quot;
macro_line|#include &quot;xdi_adapter.h&quot;
macro_line|#include &quot;os_4bri.h&quot;
macro_line|#include &quot;diva_pci.h&quot;
macro_line|#include &quot;mi_pc.h&quot;
macro_line|#include &quot;dsrv4bri.h&quot;
DECL|variable|diva_xdiLoadFileFile
r_void
op_star
id|diva_xdiLoadFileFile
op_assign
l_int|0
suffix:semicolon
DECL|variable|diva_xdiLoadFileLength
id|dword
id|diva_xdiLoadFileLength
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;**  IMPORTS&n;*/
r_extern
r_void
id|prepare_qBri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
suffix:semicolon
r_extern
r_void
id|prepare_qBri2_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
suffix:semicolon
r_extern
r_void
id|diva_xdi_display_adapter_features
(paren
r_int
id|card
)paren
suffix:semicolon
r_extern
r_void
id|diva_add_slave_adapter
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_extern
r_int
id|qBri_FPGA_download
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
suffix:semicolon
r_extern
r_void
id|start_qBri_hardware
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
suffix:semicolon
r_extern
r_int
id|diva_card_read_xlog
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
multiline_comment|/*&n;**  LOCALS&n;*/
DECL|variable|_4bri_bar_length
r_static
r_int
r_int
id|_4bri_bar_length
(braket
l_int|4
)braket
op_assign
(brace
l_int|0x100
comma
l_int|0x100
comma
multiline_comment|/* I/O */
id|MQ_MEMORY_SIZE
comma
l_int|0x2000
)brace
suffix:semicolon
DECL|variable|_4bri_v2_bar_length
r_static
r_int
r_int
id|_4bri_v2_bar_length
(braket
l_int|4
)braket
op_assign
(brace
l_int|0x100
comma
l_int|0x100
comma
multiline_comment|/* I/O */
id|MQ2_MEMORY_SIZE
comma
l_int|0x10000
)brace
suffix:semicolon
DECL|variable|_4bri_v2_bri_bar_length
r_static
r_int
r_int
id|_4bri_v2_bri_bar_length
(braket
l_int|4
)braket
op_assign
(brace
l_int|0x100
comma
l_int|0x100
comma
multiline_comment|/* I/O */
id|BRI2_MEMORY_SIZE
comma
l_int|0x10000
)brace
suffix:semicolon
r_static
r_int
id|diva_4bri_cleanup_adapter
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_static
r_int
id|_4bri_get_serial_number
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_static
r_int
id|diva_4bri_cmd_card_proc
(paren
r_struct
id|_diva_os_xdi_adapter
op_star
id|a
comma
id|diva_xdi_um_cfg_cmd_t
op_star
id|cmd
comma
r_int
id|length
)paren
suffix:semicolon
r_static
r_int
id|diva_4bri_cleanup_slave_adapters
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_static
r_int
id|diva_4bri_write_fpga_image
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
comma
id|byte
op_star
id|data
comma
id|dword
id|length
)paren
suffix:semicolon
r_static
r_int
id|diva_4bri_reset_adapter
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
suffix:semicolon
r_static
r_int
id|diva_4bri_write_sdram_block
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
id|dword
id|address
comma
r_const
id|byte
op_star
id|data
comma
id|dword
id|length
comma
id|dword
id|limit
)paren
suffix:semicolon
r_static
r_int
id|diva_4bri_start_adapter
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
id|dword
id|start_address
comma
id|dword
id|features
)paren
suffix:semicolon
r_static
r_int
id|check_qBri_interrupt
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
suffix:semicolon
r_static
r_int
id|diva_4bri_stop_adapter
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
suffix:semicolon
r_static
r_int
DECL|function|_4bri_is_rev_2_card
id|_4bri_is_rev_2_card
(paren
r_int
id|card_ordinal
)paren
(brace
r_switch
c_cond
(paren
id|card_ordinal
)paren
(brace
r_case
id|CARDTYPE_DIVASRV_Q_8M_V2_PCI
suffix:colon
r_case
id|CARDTYPE_DIVASRV_VOICE_Q_8M_V2_PCI
suffix:colon
r_case
id|CARDTYPE_DIVASRV_B_2M_V2_PCI
suffix:colon
r_case
id|CARDTYPE_DIVASRV_B_2F_PCI
suffix:colon
r_case
id|CARDTYPE_DIVASRV_VOICE_B_2M_V2_PCI
suffix:colon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|_4bri_is_rev_2_bri_card
id|_4bri_is_rev_2_bri_card
(paren
r_int
id|card_ordinal
)paren
(brace
r_switch
c_cond
(paren
id|card_ordinal
)paren
(brace
r_case
id|CARDTYPE_DIVASRV_B_2M_V2_PCI
suffix:colon
r_case
id|CARDTYPE_DIVASRV_B_2F_PCI
suffix:colon
r_case
id|CARDTYPE_DIVASRV_VOICE_B_2M_V2_PCI
suffix:colon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  BAR0 - MEM - 0x100    - CONFIG MEM&n;**  BAR1 - I/O - 0x100    - UNUSED&n;**  BAR2 - MEM - MQ_MEMORY_SIZE (MQ2_MEMORY_SIZE on Rev.2) - SDRAM&n;**  BAR3 - MEM - 0x2000 (0x10000 on Rev.2)   - CNTRL&n;**&n;**  Called by master adapter, that will initialize and add slave adapters&n;*/
r_int
DECL|function|diva_4bri_init_card
id|diva_4bri_init_card
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
r_int
id|bar
comma
id|i
suffix:semicolon
id|PADAPTER_LIST_ENTRY
id|quadro_list
suffix:semicolon
id|diva_os_xdi_adapter_t
op_star
id|diva_current
suffix:semicolon
id|diva_os_xdi_adapter_t
op_star
id|adapter_list
(braket
l_int|4
)braket
suffix:semicolon
id|PISDN_ADAPTER
id|Slave
suffix:semicolon
id|dword
id|offset
suffix:semicolon
r_int
r_int
id|bar_length
(braket
r_sizeof
(paren
id|_4bri_bar_length
)paren
op_div
r_sizeof
(paren
id|_4bri_bar_length
(braket
l_int|0
)braket
)paren
)braket
suffix:semicolon
r_int
id|v2
op_assign
id|_4bri_is_rev_2_card
(paren
id|a-&gt;CardOrdinal
)paren
suffix:semicolon
r_int
id|tasks
op_assign
id|_4bri_is_rev_2_bri_card
(paren
id|a-&gt;CardOrdinal
)paren
ques
c_cond
l_int|1
suffix:colon
id|MQ_INSTANCE_COUNT
suffix:semicolon
r_int
id|factor
op_assign
(paren
id|tasks
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|v2
)paren
(brace
r_if
c_cond
(paren
id|_4bri_is_rev_2_bri_card
(paren
id|a-&gt;CardOrdinal
)paren
)paren
(brace
id|memcpy
(paren
id|bar_length
comma
id|_4bri_v2_bri_bar_length
comma
r_sizeof
(paren
id|bar_length
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
(paren
id|bar_length
comma
id|_4bri_v2_bar_length
comma
r_sizeof
(paren
id|bar_length
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|memcpy
(paren
id|bar_length
comma
id|_4bri_bar_length
comma
r_sizeof
(paren
id|bar_length
)paren
)paren
suffix:semicolon
)brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;SDRAM_LENGTH=%08x, tasks=%d, factor=%d&quot;
comma
id|bar_length
(braket
l_int|2
)braket
comma
id|tasks
comma
id|factor
)paren
)paren
multiline_comment|/*&n;    Get Serial Number&n;    The serial number of 4BRI is accessible in accordance with PCI spec&n;    via command register located in configuration space, also we do not&n;    have to map any BAR before we can access it&n;  */
r_if
c_cond
(paren
op_logical_neg
id|_4bri_get_serial_number
(paren
id|a
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: 4BRI can&squot;t ger Serial Number&quot;
)paren
)paren
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    Set properties&n;  */
id|a-&gt;xdi_adapter.Properties
op_assign
id|CardProperties
(braket
id|a-&gt;CardOrdinal
)braket
suffix:semicolon
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;Load %s, SN:%ld, bus:%02x, func:%02x&quot;
comma
id|a-&gt;xdi_adapter.Properties.Name
comma
id|a-&gt;xdi_adapter.serialNo
comma
id|a-&gt;resources.pci.bus
comma
id|a-&gt;resources.pci.func
)paren
)paren
multiline_comment|/*&n;    First initialization step: get and check hardware resoures.&n;    Do not map resources and do not access card at this step&n;  */
r_for
c_loop
(paren
id|bar
op_assign
l_int|0
suffix:semicolon
id|bar
OL
l_int|4
suffix:semicolon
id|bar
op_increment
)paren
(brace
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
op_assign
id|divasa_get_pci_bar
(paren
id|a-&gt;resources.pci.bus
comma
id|a-&gt;resources.pci.func
comma
id|bar
comma
id|a-&gt;resources.pci.hdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
op_logical_or
(paren
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
op_eq
l_int|0xFFFFFFF0
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: invalid bar[%d]=%08x&quot;
comma
id|bar
comma
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|a-&gt;resources.pci.irq
op_assign
(paren
id|byte
)paren
id|divasa_get_pci_irq
(paren
id|a-&gt;resources.pci.bus
comma
id|a-&gt;resources.pci.func
comma
id|a-&gt;resources.pci.hdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;resources.pci.irq
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: invalid irq&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|a-&gt;xdi_adapter.sdram_bar
op_assign
id|a-&gt;resources.pci.bar
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/*&n;    Map all MEMORY BAR&squot;s&n;  */
r_for
c_loop
(paren
id|bar
op_assign
l_int|0
suffix:semicolon
id|bar
OL
l_int|4
suffix:semicolon
id|bar
op_increment
)paren
(brace
r_if
c_cond
(paren
id|bar
op_ne
l_int|1
)paren
(brace
multiline_comment|/* ignore I/O */
id|a-&gt;resources.pci.addr
(braket
id|bar
)braket
op_assign
id|divasa_remap_pci_bar
(paren
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
comma
id|bar_length
(braket
id|bar
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;resources.pci.addr
(braket
id|bar
)braket
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: 4BRI: can&squot;t map bar[%d]&quot;
comma
id|bar
)paren
)paren
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;    Register I/O port&n;  */
id|sprintf
(paren
op_amp
id|a-&gt;port_name
(braket
l_int|0
)braket
comma
l_string|&quot;DIVA 4BRI %ld&quot;
comma
(paren
r_int
)paren
id|a-&gt;xdi_adapter.serialNo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diva_os_register_io_port
(paren
l_int|1
comma
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
comma
id|bar_length
(braket
l_int|1
)braket
comma
op_amp
id|a-&gt;port_name
(braket
l_int|0
)braket
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: 4BRI: can&squot;t register bar[1]&quot;
)paren
)paren
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|a-&gt;resources.pci.addr
(braket
l_int|1
)braket
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/*&n;    Set cleanup pointer for base adapter only, so slave adapter&n;    will be unable to get cleanup&n;  */
id|a-&gt;interface.cleanup_adapter_proc
op_assign
id|diva_4bri_cleanup_adapter
suffix:semicolon
multiline_comment|/*&n;    Create slave adapters&n;  */
r_if
c_cond
(paren
id|tasks
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|a-&gt;slave_adapters
(braket
l_int|0
)braket
op_assign
(paren
id|diva_os_xdi_adapter_t
op_star
)paren
id|diva_os_malloc
(paren
l_int|0
comma
r_sizeof
(paren
op_star
id|a
)paren
)paren
)paren
)paren
(brace
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|a-&gt;slave_adapters
(braket
l_int|1
)braket
op_assign
(paren
id|diva_os_xdi_adapter_t
op_star
)paren
id|diva_os_malloc
(paren
l_int|0
comma
r_sizeof
(paren
op_star
id|a
)paren
)paren
)paren
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|a-&gt;slave_adapters
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|a-&gt;slave_adapters
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|a-&gt;slave_adapters
(braket
l_int|2
)braket
op_assign
(paren
id|diva_os_xdi_adapter_t
op_star
)paren
id|diva_os_malloc
(paren
l_int|0
comma
r_sizeof
(paren
op_star
id|a
)paren
)paren
)paren
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|a-&gt;slave_adapters
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|diva_os_free
(paren
l_int|0
comma
id|a-&gt;slave_adapters
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|a-&gt;slave_adapters
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|a-&gt;slave_adapters
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|memset
(paren
id|a-&gt;slave_adapters
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|a
)paren
)paren
suffix:semicolon
id|memset
(paren
id|a-&gt;slave_adapters
(braket
l_int|1
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|a
)paren
)paren
suffix:semicolon
id|memset
(paren
id|a-&gt;slave_adapters
(braket
l_int|2
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|a
)paren
)paren
suffix:semicolon
)brace
id|adapter_list
(braket
l_int|0
)braket
op_assign
id|a
suffix:semicolon
id|adapter_list
(braket
l_int|1
)braket
op_assign
id|a-&gt;slave_adapters
(braket
l_int|0
)braket
suffix:semicolon
id|adapter_list
(braket
l_int|2
)braket
op_assign
id|a-&gt;slave_adapters
(braket
l_int|1
)braket
suffix:semicolon
id|adapter_list
(braket
l_int|3
)braket
op_assign
id|a-&gt;slave_adapters
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/*&n;    Allocate slave list&n;  */
id|quadro_list
op_assign
(paren
id|PADAPTER_LIST_ENTRY
)paren
id|diva_os_malloc
(paren
l_int|0
comma
r_sizeof
(paren
op_star
id|quadro_list
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|a-&gt;slave_list
op_assign
id|quadro_list
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|tasks
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|a-&gt;slave_adapters
(braket
id|bar
)braket
)paren
suffix:semicolon
id|a-&gt;slave_adapters
(braket
id|bar
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|memset
(paren
id|quadro_list
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|quadro_list
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;    Set interfaces&n;  */
id|a-&gt;xdi_adapter.QuadroList
op_assign
id|quadro_list
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|adapter_list
(braket
id|i
)braket
op_member_access_from_pointer
id|xdi_adapter.ControllerNumber
op_assign
id|i
suffix:semicolon
id|adapter_list
(braket
id|i
)braket
op_member_access_from_pointer
id|xdi_adapter.tasks
op_assign
id|tasks
suffix:semicolon
id|quadro_list-&gt;QuadroAdapter
(braket
id|i
)braket
op_assign
op_amp
id|adapter_list
(braket
id|i
)braket
op_member_access_from_pointer
id|xdi_adapter
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diva_current
op_assign
id|adapter_list
(braket
id|i
)braket
suffix:semicolon
id|diva_current-&gt;dsp_mask
op_assign
l_int|0x00000003
suffix:semicolon
id|diva_current-&gt;xdi_adapter.a.io
op_assign
op_amp
id|diva_current-&gt;xdi_adapter
suffix:semicolon
id|diva_current-&gt;xdi_adapter.DIRequest
op_assign
id|request
suffix:semicolon
id|diva_current-&gt;interface.cmd_proc
op_assign
id|diva_4bri_cmd_card_proc
suffix:semicolon
id|diva_current-&gt;xdi_adapter.Properties
op_assign
id|CardProperties
(braket
id|a-&gt;CardOrdinal
)braket
suffix:semicolon
id|diva_current-&gt;CardOrdinal
op_assign
id|a-&gt;CardOrdinal
suffix:semicolon
id|diva_current-&gt;xdi_adapter.Channels
op_assign
id|CardProperties
(braket
id|a-&gt;CardOrdinal
)braket
dot
id|Channels
suffix:semicolon
id|diva_current-&gt;xdi_adapter.e_max
op_assign
id|CardProperties
(braket
id|a-&gt;CardOrdinal
)braket
dot
id|E_info
suffix:semicolon
id|diva_current-&gt;xdi_adapter.e_tbl
op_assign
id|diva_os_malloc
(paren
l_int|0
comma
id|diva_current-&gt;xdi_adapter.e_max
op_star
r_sizeof
(paren
id|E_INFO
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|diva_current-&gt;xdi_adapter.e_tbl
)paren
(brace
id|diva_4bri_cleanup_slave_adapters
(paren
id|a
)paren
suffix:semicolon
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
(paren
id|tasks
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|adapter_list
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|memset
(paren
id|diva_current-&gt;xdi_adapter.e_tbl
comma
l_int|0x00
comma
id|diva_current-&gt;xdi_adapter.e_max
op_star
r_sizeof
(paren
id|E_INFO
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diva_os_initialize_spin_lock
(paren
op_amp
id|diva_current-&gt;xdi_adapter.isr_spin_lock
comma
l_string|&quot;isr&quot;
)paren
)paren
(brace
id|diva_4bri_cleanup_slave_adapters
(paren
id|a
)paren
suffix:semicolon
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
(paren
id|tasks
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|adapter_list
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|diva_os_initialize_spin_lock
(paren
op_amp
id|diva_current-&gt;xdi_adapter.data_spin_lock
comma
l_string|&quot;data&quot;
)paren
)paren
(brace
id|diva_4bri_cleanup_slave_adapters
(paren
id|a
)paren
suffix:semicolon
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
(paren
id|tasks
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|adapter_list
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|strcpy
(paren
id|diva_current-&gt;xdi_adapter.req_soft_isr.dpc_thread_name
comma
l_string|&quot;kdivas4brid&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diva_os_initialize_soft_isr
(paren
op_amp
id|diva_current-&gt;xdi_adapter.req_soft_isr
comma
id|DIDpcRoutine
comma
op_amp
id|diva_current-&gt;xdi_adapter
)paren
)paren
(brace
id|diva_4bri_cleanup_slave_adapters
(paren
id|a
)paren
suffix:semicolon
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
(paren
id|tasks
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|adapter_list
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     Do not initialize second DPC - only one thread will be created&n;    */
id|diva_current-&gt;xdi_adapter.isr_soft_isr.object
op_assign
id|diva_current-&gt;xdi_adapter.req_soft_isr.object
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v2
)paren
(brace
id|prepare_qBri2_functions
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
)brace
r_else
(brace
id|prepare_qBri_functions
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    Set up hardware related pointers&n;  */
id|a-&gt;xdi_adapter.cfg
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|a-&gt;resources.pci.bar
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* BAR0 CONFIG */
id|a-&gt;xdi_adapter.port
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* BAR1        */
id|a-&gt;xdi_adapter.Address
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* BAR2 SDRAM  */
id|a-&gt;xdi_adapter.ctlReg
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|a-&gt;resources.pci.bar
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* BAR3 CNTRL  */
id|a-&gt;xdi_adapter.reset
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* BAR0 CONFIG */
id|a-&gt;xdi_adapter.ram
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* BAR2 SDRAM  */
multiline_comment|/*&n;    ctlReg contains the register address for the MIPS CPU reset control&n;  */
id|a-&gt;xdi_adapter.ctlReg
op_assign
id|a-&gt;resources.pci.addr
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* BAR3 CNTRL  */
multiline_comment|/*&n;    prom contains the register address for FPGA and EEPROM programming&n;  */
id|a-&gt;xdi_adapter.prom
op_assign
op_amp
id|a-&gt;xdi_adapter.reset
(braket
l_int|0x6E
)braket
suffix:semicolon
multiline_comment|/*&n;    reset contains the base address for the PLX 9054 register set&n;  */
id|a-&gt;xdi_adapter.reset
(braket
id|PLX9054_INTCSR
)braket
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* disable PCI interrupts */
multiline_comment|/*&n;    Replicate addresses to all instances, set shared memory&n;    address for all instances&n;  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Slave
op_assign
id|a-&gt;xdi_adapter.QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
suffix:semicolon
id|offset
op_assign
id|Slave-&gt;ControllerNumber
op_star
(paren
id|a-&gt;xdi_adapter.MemorySize
op_rshift
id|factor
)paren
suffix:semicolon
id|Slave-&gt;Address
op_assign
op_amp
id|a-&gt;xdi_adapter.Address
(braket
id|offset
)braket
suffix:semicolon
id|Slave-&gt;ram
op_assign
op_amp
id|a-&gt;xdi_adapter.ram
(braket
id|offset
)braket
suffix:semicolon
id|Slave-&gt;reset
op_assign
id|a-&gt;xdi_adapter.reset
suffix:semicolon
id|Slave-&gt;ctlReg
op_assign
id|a-&gt;xdi_adapter.ctlReg
suffix:semicolon
id|Slave-&gt;prom
op_assign
id|a-&gt;xdi_adapter.prom
suffix:semicolon
id|Slave-&gt;reset
op_assign
id|a-&gt;xdi_adapter.reset
suffix:semicolon
id|Slave-&gt;sdram_bar
op_assign
id|a-&gt;xdi_adapter.sdram_bar
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Slave
op_assign
id|a-&gt;xdi_adapter.QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
suffix:semicolon
id|Slave-&gt;ram
op_add_assign
(paren
(paren
id|a-&gt;xdi_adapter.MemorySize
op_rshift
id|factor
)paren
op_minus
id|MQ_SHARED_RAM_SIZE
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Slave
op_assign
id|a-&gt;xdi_adapter.QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
suffix:semicolon
id|Slave-&gt;serialNo
op_assign
(paren
(paren
id|dword
)paren
(paren
id|Slave-&gt;ControllerNumber
op_lshift
l_int|24
)paren
)paren
op_or
id|a-&gt;xdi_adapter.serialNo
suffix:semicolon
id|Slave-&gt;cardType
op_assign
id|a-&gt;xdi_adapter.cardType
suffix:semicolon
)brace
multiline_comment|/*&n;    Set IRQ handler&n;  */
id|a-&gt;xdi_adapter.irq_info.irq_nr
op_assign
id|a-&gt;resources.pci.irq
suffix:semicolon
id|sprintf
(paren
id|a-&gt;xdi_adapter.irq_info.irq_name
comma
l_string|&quot;DIVA 4BRI %ld&quot;
comma
(paren
r_int
)paren
id|a-&gt;xdi_adapter.serialNo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diva_os_register_irq
(paren
id|a
comma
id|a-&gt;xdi_adapter.irq_info.irq_nr
comma
id|a-&gt;xdi_adapter.irq_info.irq_name
)paren
)paren
(brace
id|diva_4bri_cleanup_slave_adapters
(paren
id|a
)paren
suffix:semicolon
id|diva_4bri_cleanup_adapter
(paren
id|a
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
(paren
id|tasks
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|adapter_list
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|a-&gt;xdi_adapter.irq_info.registered
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;    Add three slave adapters&n;  */
r_if
c_cond
(paren
id|tasks
OG
l_int|1
)paren
(brace
id|diva_add_slave_adapter
(paren
id|adapter_list
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|diva_add_slave_adapter
(paren
id|adapter_list
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|diva_add_slave_adapter
(paren
id|adapter_list
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
id|diva_log_info
c_func
(paren
l_string|&quot;%s IRQ:%d SerNo:%d&quot;
comma
id|a-&gt;xdi_adapter.Properties.Name
comma
id|a-&gt;resources.pci.irq
comma
id|a-&gt;xdi_adapter.serialNo
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  Cleanup function will be called for master adapter only&n;**  this is garanteed by design: cleanup callback is set&n;**  by master adapter only&n;*/
r_static
r_int
DECL|function|diva_4bri_cleanup_adapter
id|diva_4bri_cleanup_adapter
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
r_int
id|bar
suffix:semicolon
multiline_comment|/*&n;    Stop adapter if running&n;  */
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.Initialized
)paren
(brace
id|diva_4bri_stop_adapter
(paren
id|a
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    Remove IRQ handler&n;  */
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.irq_info.registered
)paren
(brace
id|diva_os_remove_irq
(paren
id|a
comma
id|a-&gt;xdi_adapter.irq_info.irq_nr
)paren
suffix:semicolon
)brace
id|a-&gt;xdi_adapter.irq_info.registered
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    Free DPC&squot;s and spin locks on all adapters&n;  */
id|diva_4bri_cleanup_slave_adapters
(paren
id|a
)paren
suffix:semicolon
multiline_comment|/*&n;    Unmap all BARS&n;  */
r_for
c_loop
(paren
id|bar
op_assign
l_int|0
suffix:semicolon
id|bar
OL
l_int|4
suffix:semicolon
id|bar
op_increment
)paren
(brace
r_if
c_cond
(paren
id|bar
op_ne
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
op_logical_and
id|a-&gt;resources.pci.addr
(braket
id|bar
)braket
)paren
(brace
id|divasa_unmap_pci_bar
(paren
id|a-&gt;resources.pci.addr
(braket
id|bar
)braket
)paren
suffix:semicolon
id|a-&gt;resources.pci.bar
(braket
id|bar
)braket
op_assign
l_int|0
suffix:semicolon
id|a-&gt;resources.pci.addr
(braket
id|bar
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;    Unregister I/O&n;  */
r_if
c_cond
(paren
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
op_logical_and
id|a-&gt;resources.pci.addr
(braket
l_int|1
)braket
)paren
(brace
id|diva_os_register_io_port
(paren
l_int|0
comma
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
comma
id|_4bri_is_rev_2_card
(paren
id|a-&gt;CardOrdinal
)paren
ques
c_cond
id|_4bri_v2_bar_length
(braket
l_int|1
)braket
suffix:colon
id|_4bri_bar_length
(braket
l_int|1
)braket
comma
op_amp
id|a-&gt;port_name
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|a-&gt;resources.pci.addr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|a-&gt;slave_list
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|a-&gt;slave_list
)paren
suffix:semicolon
id|a-&gt;slave_list
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|_4bri_get_serial_number
id|_4bri_get_serial_number
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|dword
id|data
(braket
l_int|64
)braket
suffix:semicolon
id|dword
id|serNo
suffix:semicolon
id|word
id|addr
comma
id|status
comma
id|i
comma
id|j
suffix:semicolon
id|byte
id|Bus
comma
id|Slot
suffix:semicolon
r_void
op_star
id|hdev
suffix:semicolon
id|Bus
op_assign
id|a-&gt;resources.pci.bus
suffix:semicolon
id|Slot
op_assign
id|a-&gt;resources.pci.func
suffix:semicolon
id|hdev
op_assign
id|a-&gt;resources.pci.hdev
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
op_increment
id|i
)paren
(brace
id|addr
op_assign
id|i
op_star
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|5
suffix:semicolon
op_increment
id|j
)paren
(brace
id|PCIwrite
(paren
id|Bus
comma
id|Slot
comma
l_int|0x4E
comma
op_amp
id|addr
comma
r_sizeof
(paren
id|addr
)paren
comma
id|hdev
)paren
suffix:semicolon
id|diva_os_wait
(paren
l_int|1
)paren
suffix:semicolon
id|PCIread
(paren
id|Bus
comma
id|Slot
comma
l_int|0x4E
comma
op_amp
id|status
comma
r_sizeof
(paren
id|status
)paren
comma
id|hdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x8000
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_ge
l_int|5
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;EEPROM[%d] read failed (0x%x)&quot;
comma
id|i
op_star
l_int|4
comma
id|addr
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|PCIread
(paren
id|Bus
comma
id|Slot
comma
l_int|0x50
comma
op_amp
id|data
(braket
id|i
)braket
comma
r_sizeof
(paren
id|data
(braket
id|i
)braket
)paren
comma
id|hdev
)paren
suffix:semicolon
)brace
id|DBG_BLK
c_func
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|data
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|data
)paren
)paren
)paren
id|serNo
op_assign
id|data
(braket
l_int|32
)braket
suffix:semicolon
r_if
c_cond
(paren
id|serNo
op_eq
l_int|0
op_logical_or
id|serNo
op_eq
l_int|0xffffffff
)paren
id|serNo
op_assign
id|data
(braket
l_int|63
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serNo
)paren
(brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;W: Serial Number == 0, create one serial number&quot;
)paren
)paren
suffix:semicolon
id|serNo
op_assign
id|a-&gt;resources.pci.bar
(braket
l_int|1
)braket
op_amp
l_int|0xffff0000
suffix:semicolon
id|serNo
op_or_assign
id|a-&gt;resources.pci.bus
op_lshift
l_int|8
suffix:semicolon
id|serNo
op_or_assign
id|a-&gt;resources.pci.func
suffix:semicolon
)brace
id|a-&gt;xdi_adapter.serialNo
op_assign
id|serNo
suffix:semicolon
id|DBG_REG
c_func
(paren
(paren
l_string|&quot;Serial No.          : %ld&quot;
comma
id|a-&gt;xdi_adapter.serialNo
)paren
)paren
r_return
(paren
id|serNo
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;**  Release resources of slave adapters&n;*/
r_static
r_int
DECL|function|diva_4bri_cleanup_slave_adapters
id|diva_4bri_cleanup_slave_adapters
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|diva_os_xdi_adapter_t
op_star
id|adapter_list
(braket
l_int|4
)braket
suffix:semicolon
id|diva_os_xdi_adapter_t
op_star
id|diva_current
suffix:semicolon
r_int
id|i
suffix:semicolon
id|adapter_list
(braket
l_int|0
)braket
op_assign
id|a
suffix:semicolon
id|adapter_list
(braket
l_int|1
)braket
op_assign
id|a-&gt;slave_adapters
(braket
l_int|0
)braket
suffix:semicolon
id|adapter_list
(braket
l_int|2
)braket
op_assign
id|a-&gt;slave_adapters
(braket
l_int|1
)braket
suffix:semicolon
id|adapter_list
(braket
l_int|3
)braket
op_assign
id|a-&gt;slave_adapters
(braket
l_int|2
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|a-&gt;xdi_adapter.tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diva_current
op_assign
id|adapter_list
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|diva_current
)paren
(brace
id|diva_os_destroy_spin_lock
(paren
op_amp
id|diva_current-&gt;xdi_adapter.isr_spin_lock
comma
l_string|&quot;unload&quot;
)paren
suffix:semicolon
id|diva_os_destroy_spin_lock
(paren
op_amp
id|diva_current-&gt;xdi_adapter.data_spin_lock
comma
l_string|&quot;unload&quot;
)paren
suffix:semicolon
id|diva_os_cancel_soft_isr
(paren
op_amp
id|diva_current-&gt;xdi_adapter.req_soft_isr
)paren
suffix:semicolon
id|diva_os_cancel_soft_isr
(paren
op_amp
id|diva_current-&gt;xdi_adapter.isr_soft_isr
)paren
suffix:semicolon
id|diva_os_remove_soft_isr
(paren
op_amp
id|diva_current-&gt;xdi_adapter.req_soft_isr
)paren
suffix:semicolon
id|diva_current-&gt;xdi_adapter.isr_soft_isr.object
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|diva_current-&gt;xdi_adapter.e_tbl
)paren
(brace
id|diva_os_free
(paren
l_int|0
comma
id|diva_current-&gt;xdi_adapter.e_tbl
)paren
suffix:semicolon
)brace
id|diva_current-&gt;xdi_adapter.e_tbl
op_assign
l_int|0
suffix:semicolon
id|diva_current-&gt;xdi_adapter.e_max
op_assign
l_int|0
suffix:semicolon
id|diva_current-&gt;xdi_adapter.e_count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|diva_4bri_cmd_card_proc
id|diva_4bri_cmd_card_proc
(paren
r_struct
id|_diva_os_xdi_adapter
op_star
id|a
comma
id|diva_xdi_um_cfg_cmd_t
op_star
id|cmd
comma
r_int
id|length
)paren
(brace
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;adapter
op_ne
id|a-&gt;controller
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: 4bri_cmd, invalid controller=%d != %d&quot;
comma
id|cmd-&gt;adapter
comma
id|a-&gt;controller
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd-&gt;command
)paren
(brace
r_case
id|DIVA_XDI_UM_CMD_GET_CARD_ORDINAL
suffix:colon
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
op_star
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
op_assign
(paren
id|dword
)paren
id|a-&gt;CardOrdinal
suffix:semicolon
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_GET_SERIAL_NR
suffix:colon
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
op_star
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
op_assign
(paren
id|dword
)paren
id|a-&gt;xdi_adapter.serialNo
suffix:semicolon
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_GET_PCI_HW_CONFIG
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.ControllerNumber
)paren
(brace
multiline_comment|/*&n;          Only master adapter can access hardware config&n;        */
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
op_star
l_int|9
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
r_int
id|i
suffix:semicolon
id|dword
op_star
id|data
op_assign
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|data
op_increment
op_assign
id|a-&gt;resources.pci.bar
(braket
id|i
)braket
suffix:semicolon
)brace
op_star
id|data
op_increment
op_assign
(paren
id|dword
)paren
id|a-&gt;resources.pci.irq
suffix:semicolon
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_GET_CARD_STATE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.ControllerNumber
)paren
(brace
id|a-&gt;xdi_mbox.data_length
op_assign
r_sizeof
(paren
id|dword
)paren
suffix:semicolon
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
id|dword
op_star
id|data
op_assign
(paren
id|dword
op_star
)paren
id|a-&gt;xdi_mbox.data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.ram
op_logical_or
op_logical_neg
id|a-&gt;xdi_adapter.reset
op_logical_or
op_logical_neg
id|a-&gt;xdi_adapter.cfg
)paren
(brace
op_star
id|data
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.trapped
)paren
(brace
op_star
id|data
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|a-&gt;xdi_adapter.Initialized
)paren
(brace
op_star
id|data
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
op_star
id|data
op_assign
l_int|0
suffix:semicolon
)brace
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_WRITE_FPGA
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.ControllerNumber
)paren
(brace
id|ret
op_assign
id|diva_4bri_write_fpga_image
(paren
id|a
comma
(paren
id|byte
op_star
)paren
op_amp
id|cmd
(braket
l_int|1
)braket
comma
id|cmd-&gt;command_data.write_fpga.image_length
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_RESET_ADAPTER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.ControllerNumber
)paren
(brace
id|ret
op_assign
id|diva_4bri_reset_adapter
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_WRITE_SDRAM_BLOCK
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.ControllerNumber
)paren
(brace
id|ret
op_assign
id|diva_4bri_write_sdram_block
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|cmd-&gt;command_data.write_sdram.offset
comma
(paren
id|byte
op_star
)paren
op_amp
id|cmd
(braket
l_int|1
)braket
comma
id|cmd-&gt;command_data.write_sdram.length
comma
id|a-&gt;xdi_adapter.MemorySize
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_START_ADAPTER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.ControllerNumber
)paren
(brace
id|ret
op_assign
id|diva_4bri_start_adapter
(paren
op_amp
id|a-&gt;xdi_adapter
comma
id|cmd-&gt;command_data.start.offset
comma
id|cmd-&gt;command_data.start.features
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_SET_PROTOCOL_FEATURES
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.ControllerNumber
)paren
(brace
id|a-&gt;xdi_adapter.features
op_assign
id|cmd-&gt;command_data.features.features
suffix:semicolon
id|a-&gt;xdi_adapter.a.protocol_capabilities
op_assign
id|a-&gt;xdi_adapter.features
suffix:semicolon
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Set raw protocol features (%08x)&quot;
comma
id|a-&gt;xdi_adapter.features
)paren
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_STOP_ADAPTER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.ControllerNumber
)paren
(brace
id|ret
op_assign
id|diva_4bri_stop_adapter
(paren
id|a
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_READ_XLOG_ENTRY
suffix:colon
id|ret
op_assign
id|diva_card_read_xlog
(paren
id|a
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIVA_XDI_UM_CMD_READ_SDRAM
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|a-&gt;xdi_adapter.ControllerNumber
op_logical_and
id|a-&gt;xdi_adapter.Address
)paren
(brace
r_if
c_cond
(paren
(paren
id|a-&gt;xdi_mbox.data_length
op_assign
id|cmd-&gt;command_data.read_sdram.length
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|a-&gt;xdi_mbox.data_length
op_plus
id|cmd-&gt;command_data.read_sdram.offset
)paren
OL
id|a-&gt;xdi_adapter.MemorySize
)paren
(brace
id|a-&gt;xdi_mbox.data
op_assign
id|diva_os_malloc
(paren
l_int|0
comma
id|a-&gt;xdi_mbox.data_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;xdi_mbox.data
)paren
(brace
id|byte
op_star
id|src
op_assign
id|a-&gt;xdi_adapter.Address
suffix:semicolon
id|byte
op_star
id|dst
op_assign
id|a-&gt;xdi_mbox.data
suffix:semicolon
id|dword
id|len
op_assign
id|a-&gt;xdi_mbox.data_length
suffix:semicolon
id|src
op_add_assign
id|cmd-&gt;command_data.read_sdram.offset
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
op_star
id|dst
op_increment
op_assign
op_star
id|src
op_increment
suffix:semicolon
)brace
id|a-&gt;xdi_mbox.status
op_assign
id|DIVA_XDI_MBOX_BUSY
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) invalid cmd=%d&quot;
comma
id|a-&gt;controller
comma
id|cmd-&gt;command
)paren
)paren
)brace
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
r_void
op_star
DECL|function|xdiLoadFile
id|xdiLoadFile
(paren
r_char
op_star
id|FileName
comma
r_int
r_int
op_star
id|FileLength
comma
r_int
r_int
id|lim
)paren
(brace
r_void
op_star
id|ret
op_assign
id|diva_xdiLoadFileFile
suffix:semicolon
r_if
c_cond
(paren
id|FileLength
)paren
(brace
op_star
id|FileLength
op_assign
id|diva_xdiLoadFileLength
suffix:semicolon
)brace
id|diva_xdiLoadFileFile
op_assign
l_int|0
suffix:semicolon
id|diva_xdiLoadFileLength
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
r_void
DECL|function|diva_os_set_qBri_functions
id|diva_os_set_qBri_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
)brace
r_void
DECL|function|diva_os_set_qBri2_functions
id|diva_os_set_qBri2_functions
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
)brace
r_static
r_int
DECL|function|diva_4bri_write_fpga_image
id|diva_4bri_write_fpga_image
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
comma
id|byte
op_star
id|data
comma
id|dword
id|length
)paren
(brace
r_int
id|ret
suffix:semicolon
id|diva_xdiLoadFileFile
op_assign
id|data
suffix:semicolon
id|diva_xdiLoadFileLength
op_assign
id|length
suffix:semicolon
id|ret
op_assign
id|qBri_FPGA_download
(paren
op_amp
id|a-&gt;xdi_adapter
)paren
suffix:semicolon
id|diva_xdiLoadFileFile
op_assign
l_int|0
suffix:semicolon
id|diva_xdiLoadFileLength
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|ret
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|diva_4bri_reset_adapter
id|diva_4bri_reset_adapter
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
id|PISDN_ADAPTER
id|Slave
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;Address
op_logical_or
op_logical_neg
id|IoAdapter-&gt;reset
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IoAdapter-&gt;Initialized
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) can&squot;t reset 4BRI adapter - please stop first&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;    Forget all entities on all adapters&n;  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|i
OL
id|IoAdapter-&gt;tasks
)paren
op_logical_and
id|IoAdapter-&gt;QuadroList
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|Slave
op_assign
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
suffix:semicolon
id|Slave-&gt;e_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|Slave-&gt;e_tbl
)paren
(brace
id|memset
(paren
id|Slave-&gt;e_tbl
comma
l_int|0x00
comma
id|Slave-&gt;e_max
op_star
r_sizeof
(paren
id|E_INFO
)paren
)paren
suffix:semicolon
)brace
id|Slave-&gt;head
op_assign
l_int|0
suffix:semicolon
id|Slave-&gt;tail
op_assign
l_int|0
suffix:semicolon
id|Slave-&gt;assign
op_assign
l_int|0
suffix:semicolon
id|Slave-&gt;trapped
op_assign
l_int|0
suffix:semicolon
id|memset
(paren
op_amp
id|Slave-&gt;a.IdTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|Slave-&gt;a.IdTable
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|Slave-&gt;a.IdTypeTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|Slave-&gt;a.IdTypeTable
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|Slave-&gt;a.FlowControlIdTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|Slave-&gt;a.FlowControlIdTable
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|Slave-&gt;a.FlowControlSkipTable
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|Slave-&gt;a.FlowControlSkipTable
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|Slave-&gt;a.misc_flags_table
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|Slave-&gt;a.misc_flags_table
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|Slave-&gt;a.rx_stream
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|Slave-&gt;a.rx_stream
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|Slave-&gt;a.tx_stream
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|Slave-&gt;a.tx_stream
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|Slave-&gt;a.tx_pos
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|Slave-&gt;a.tx_pos
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|Slave-&gt;a.rx_pos
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|Slave-&gt;a.rx_pos
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|diva_4bri_write_sdram_block
id|diva_4bri_write_sdram_block
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
id|dword
id|address
comma
r_const
id|byte
op_star
id|data
comma
id|dword
id|length
comma
id|dword
id|limit
)paren
(brace
id|byte
op_star
id|mem
op_assign
id|IoAdapter-&gt;Address
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|address
op_plus
id|length
)paren
op_ge
id|limit
)paren
op_logical_or
op_logical_neg
id|mem
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) write PRI address=0x%08lx&quot;
comma
id|IoAdapter-&gt;ANum
comma
id|address
op_plus
id|length
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|mem
op_add_assign
id|address
suffix:semicolon
r_while
c_loop
(paren
id|length
op_decrement
)paren
(brace
op_star
id|mem
op_increment
op_assign
op_star
id|data
op_increment
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|diva_4bri_start_adapter
id|diva_4bri_start_adapter
(paren
id|PISDN_ADAPTER
id|IoAdapter
comma
id|dword
id|start_address
comma
id|dword
id|features
)paren
(brace
r_volatile
id|word
op_star
id|signature
suffix:semicolon
r_int
id|started
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;    start adapter&n;  */
id|start_qBri_hardware
(paren
id|IoAdapter
)paren
suffix:semicolon
multiline_comment|/*&n;    wait for signature in shared memory (max. 3 seconds)&n;  */
id|signature
op_assign
(paren
r_volatile
id|word
op_star
)paren
(paren
op_amp
id|IoAdapter-&gt;ram
(braket
l_int|0x1E
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|300
suffix:semicolon
op_increment
id|i
)paren
(brace
id|diva_os_wait
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|READ_WORD
c_func
(paren
op_amp
id|signature
(braket
l_int|0
)braket
)paren
op_eq
l_int|0x4447
)paren
(brace
id|DBG_TRC
c_func
(paren
(paren
l_string|&quot;Protocol startup time %d.%02d seconds&quot;
comma
(paren
id|i
op_div
l_int|100
)paren
comma
(paren
id|i
op_mod
l_int|100
)paren
)paren
)paren
id|started
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|IoAdapter-&gt;tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|features
op_assign
id|IoAdapter-&gt;features
suffix:semicolon
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|a.protocol_capabilities
op_assign
id|IoAdapter-&gt;features
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|started
)paren
(brace
id|DBG_FTL
c_func
(paren
(paren
l_string|&quot;%s: Adapter selftest failed, signature=%04x&quot;
comma
id|IoAdapter-&gt;Properties.Name
comma
id|READ_WORD
c_func
(paren
op_amp
id|signature
(braket
l_int|0
)braket
)paren
)paren
)paren
(paren
op_star
(paren
id|IoAdapter-&gt;trapFnc
)paren
)paren
(paren
id|IoAdapter
)paren
suffix:semicolon
id|IoAdapter
op_member_access_from_pointer
id|stop
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IoAdapter-&gt;tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|Initialized
op_assign
l_int|1
suffix:semicolon
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|IrqCount
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_qBri_interrupt
(paren
id|IoAdapter
)paren
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) interrupt test failed&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IoAdapter-&gt;tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|Initialized
op_assign
l_int|0
suffix:semicolon
)brace
id|IoAdapter
op_member_access_from_pointer
id|stop
c_func
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|IoAdapter-&gt;Properties.Features
op_assign
(paren
id|word
)paren
id|features
suffix:semicolon
id|diva_xdi_display_adapter_features
(paren
id|IoAdapter-&gt;ANum
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IoAdapter-&gt;tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DBG_LOG
c_func
(paren
(paren
l_string|&quot;A(%d) %s adapter successfull started&quot;
comma
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|ANum
comma
(paren
id|IoAdapter-&gt;tasks
op_eq
l_int|1
)paren
ques
c_cond
l_string|&quot;BRI 2.0&quot;
suffix:colon
l_string|&quot;4BRI&quot;
)paren
)paren
id|diva_xdi_didd_register_adapter
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|ANum
)paren
suffix:semicolon
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|Properties.Features
op_assign
(paren
id|word
)paren
id|features
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|check_qBri_interrupt
id|check_qBri_interrupt
(paren
id|PISDN_ADAPTER
id|IoAdapter
)paren
(brace
macro_line|#ifdef&t;SUPPORT_INTERRUPT_TEST_ON_4BRI
r_int
id|i
suffix:semicolon
id|ADAPTER
op_star
id|a
op_assign
op_amp
id|IoAdapter-&gt;a
suffix:semicolon
id|IoAdapter-&gt;IrqCount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|IoAdapter-&gt;ControllerNumber
OG
l_int|0
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|IoAdapter-&gt;reset
(braket
id|PLX9054_INTCSR
)braket
op_assign
id|PLX9054_INT_ENABLE
suffix:semicolon
multiline_comment|/*&n;    interrupt test&n;  */
id|a-&gt;ReadyInt
op_assign
l_int|1
suffix:semicolon
id|a-&gt;ram_out
(paren
id|a
comma
op_amp
id|PR_RAM-&gt;ReadyInt
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|100
suffix:semicolon
op_logical_neg
id|IoAdapter-&gt;IrqCount
op_logical_and
(paren
id|i
op_decrement
OG
l_int|0
)paren
suffix:semicolon
id|diva_os_wait
c_func
(paren
l_int|10
)paren
)paren
suffix:semicolon
r_return
(paren
(paren
id|IoAdapter-&gt;IrqCount
OG
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#else
id|dword
r_volatile
op_star
id|qBriIrq
suffix:semicolon
multiline_comment|/*&n;    Reset on-board interrupt register&n;  */
id|IoAdapter-&gt;IrqCount
op_assign
l_int|0
suffix:semicolon
id|qBriIrq
op_assign
(paren
id|dword
r_volatile
op_star
)paren
(paren
op_amp
id|IoAdapter-&gt;ctlReg
(braket
id|_4bri_is_rev_2_card
(paren
id|IoAdapter-&gt;cardType
)paren
ques
c_cond
(paren
id|MQ2_BREG_IRQ_TEST
)paren
suffix:colon
(paren
id|MQ_BREG_IRQ_TEST
)paren
)braket
)paren
suffix:semicolon
id|WRITE_DWORD
c_func
(paren
id|qBriIrq
comma
id|MQ_IRQ_REQ_OFF
)paren
suffix:semicolon
id|IoAdapter-&gt;reset
(braket
id|PLX9054_INTCSR
)braket
op_assign
id|PLX9054_INT_ENABLE
suffix:semicolon
id|diva_os_wait
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif&t;/* SUPPORT_INTERRUPT_TEST_ON_4BRI */
)brace
r_static
r_void
DECL|function|diva_4bri_clear_interrupts
id|diva_4bri_clear_interrupts
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|PISDN_ADAPTER
id|IoAdapter
op_assign
op_amp
id|a-&gt;xdi_adapter
suffix:semicolon
multiline_comment|/*&n;    clear any pending interrupt&n;  */
id|IoAdapter-&gt;disIrq
(paren
id|IoAdapter
)paren
suffix:semicolon
id|IoAdapter-&gt;tst_irq
(paren
op_amp
id|IoAdapter-&gt;a
)paren
suffix:semicolon
id|IoAdapter-&gt;clr_irq
(paren
op_amp
id|IoAdapter-&gt;a
)paren
suffix:semicolon
id|IoAdapter-&gt;tst_irq
(paren
op_amp
id|IoAdapter-&gt;a
)paren
suffix:semicolon
multiline_comment|/*&n;    kill pending dpcs&n;  */
id|diva_os_cancel_soft_isr
(paren
op_amp
id|IoAdapter-&gt;req_soft_isr
)paren
suffix:semicolon
id|diva_os_cancel_soft_isr
(paren
op_amp
id|IoAdapter-&gt;isr_soft_isr
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|diva_4bri_stop_adapter
id|diva_4bri_stop_adapter
(paren
id|diva_os_xdi_adapter_t
op_star
id|a
)paren
(brace
id|PISDN_ADAPTER
id|IoAdapter
op_assign
op_amp
id|a-&gt;xdi_adapter
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;ram
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|IoAdapter-&gt;Initialized
)paren
(brace
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) can&squot;t stop PRI adapter - not running&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* nothing to stop */
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IoAdapter-&gt;tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|Initialized
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;    Disconnect Adapters from DIDD&n;  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IoAdapter-&gt;tasks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|diva_xdi_didd_remove_adapter
c_func
(paren
id|IoAdapter-&gt;QuadroList-&gt;QuadroAdapter
(braket
id|i
)braket
op_member_access_from_pointer
id|ANum
)paren
suffix:semicolon
)brace
id|i
op_assign
l_int|100
suffix:semicolon
multiline_comment|/*&n;    Stop interrupts&n;  */
id|a-&gt;clear_interrupts_proc
op_assign
id|diva_4bri_clear_interrupts
suffix:semicolon
id|IoAdapter-&gt;a.ReadyInt
op_assign
l_int|1
suffix:semicolon
id|IoAdapter-&gt;a.ram_inc
(paren
op_amp
id|IoAdapter-&gt;a
comma
op_amp
id|PR_RAM-&gt;ReadyInt
)paren
suffix:semicolon
r_do
(brace
id|diva_os_sleep
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_decrement
op_logical_and
id|a-&gt;clear_interrupts_proc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a-&gt;clear_interrupts_proc
)paren
(brace
id|diva_4bri_clear_interrupts
(paren
id|a
)paren
suffix:semicolon
id|a-&gt;clear_interrupts_proc
op_assign
l_int|0
suffix:semicolon
id|DBG_ERR
c_func
(paren
(paren
l_string|&quot;A: A(%d) no final interrupt from 4BRI adapter&quot;
comma
id|IoAdapter-&gt;ANum
)paren
)paren
)brace
id|IoAdapter-&gt;a.ReadyInt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;    Stop and reset adapter&n;  */
id|IoAdapter-&gt;stop
(paren
id|IoAdapter
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
eof
