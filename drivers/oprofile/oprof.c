multiline_comment|/**&n; * @file oprof.c&n; *&n; * @remark Copyright 2002 OProfile authors&n; * @remark Read the file COPYING&n; *&n; * @author John Levon &lt;levon@movementarian.org&gt;&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/oprofile.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &quot;oprof.h&quot;
macro_line|#include &quot;event_buffer.h&quot;
macro_line|#include &quot;cpu_buffer.h&quot;
macro_line|#include &quot;buffer_sync.h&quot;
macro_line|#include &quot;oprofile_stats.h&quot;
DECL|variable|oprofile_ops
r_struct
id|oprofile_operations
op_star
id|oprofile_ops
suffix:semicolon
DECL|variable|oprofile_started
r_int
r_int
id|oprofile_started
suffix:semicolon
DECL|variable|is_setup
r_static
r_int
r_int
id|is_setup
suffix:semicolon
r_static
id|DECLARE_MUTEX
c_func
(paren
id|start_sem
)paren
suffix:semicolon
DECL|function|oprofile_setup
r_int
id|oprofile_setup
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|alloc_cpu_buffers
c_func
(paren
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|alloc_event_buffer
c_func
(paren
)paren
)paren
)paren
r_goto
id|out1
suffix:semicolon
r_if
c_cond
(paren
id|oprofile_ops-&gt;setup
op_logical_and
(paren
id|err
op_assign
id|oprofile_ops
op_member_access_from_pointer
id|setup
c_func
(paren
)paren
)paren
)paren
r_goto
id|out2
suffix:semicolon
multiline_comment|/* Note even though this starts part of the&n;&t; * profiling overhead, it&squot;s necessary to prevent&n;&t; * us missing task deaths and eventually oopsing&n;&t; * when trying to process the event buffer.&n;&t; */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|sync_start
c_func
(paren
)paren
)paren
)paren
r_goto
id|out3
suffix:semicolon
id|down
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
id|is_setup
op_assign
l_int|1
suffix:semicolon
id|up
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out3
suffix:colon
r_if
c_cond
(paren
id|oprofile_ops-&gt;shutdown
)paren
id|oprofile_ops
op_member_access_from_pointer
id|shutdown
c_func
(paren
)paren
suffix:semicolon
id|out2
suffix:colon
id|free_event_buffer
c_func
(paren
)paren
suffix:semicolon
id|out1
suffix:colon
id|free_cpu_buffers
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Actually start profiling (echo 1&gt;/dev/oprofile/enable) */
DECL|function|oprofile_start
r_int
id|oprofile_start
c_func
(paren
r_void
)paren
(brace
r_int
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_setup
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|oprofile_started
)paren
r_goto
id|out
suffix:semicolon
id|oprofile_reset_stats
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|oprofile_ops
op_member_access_from_pointer
id|start
c_func
(paren
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|oprofile_started
op_assign
l_int|1
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* echo 0&gt;/dev/oprofile/enable */
DECL|function|oprofile_stop
r_void
id|oprofile_stop
c_func
(paren
r_void
)paren
(brace
id|down
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|oprofile_started
)paren
r_goto
id|out
suffix:semicolon
id|oprofile_ops
op_member_access_from_pointer
id|stop
c_func
(paren
)paren
suffix:semicolon
id|oprofile_started
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* wake up the daemon to read what remains */
id|wake_up_buffer_waiter
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
)brace
DECL|function|oprofile_shutdown
r_void
id|oprofile_shutdown
c_func
(paren
r_void
)paren
(brace
id|sync_stop
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oprofile_ops-&gt;shutdown
)paren
id|oprofile_ops
op_member_access_from_pointer
id|shutdown
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* down() is also necessary to synchronise all pending events&n;&t; * before freeing */
id|down
c_func
(paren
op_amp
id|buffer_sem
)paren
suffix:semicolon
id|is_setup
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|buffer_sem
)paren
suffix:semicolon
id|free_event_buffer
c_func
(paren
)paren
suffix:semicolon
id|free_cpu_buffers
c_func
(paren
)paren
suffix:semicolon
)brace
r_extern
r_void
id|timer_init
c_func
(paren
r_struct
id|oprofile_operations
op_star
op_star
id|ops
)paren
suffix:semicolon
DECL|function|oprofile_init
r_static
r_int
id|__init
id|oprofile_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
multiline_comment|/* Architecture must fill in the interrupt ops and the&n;&t; * logical CPU type, or we can fall back to the timer&n;&t; * interrupt profiler.&n;&t; */
id|err
op_assign
id|oprofile_arch_init
c_func
(paren
op_amp
id|oprofile_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|ENODEV
)paren
(brace
id|timer_init
c_func
(paren
op_amp
id|oprofile_ops
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|oprofile_ops-&gt;cpu_type
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;oprofile: cpu_type not set !&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|oprofilefs_register
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|oprofile_exit
r_static
r_void
id|__exit
id|oprofile_exit
c_func
(paren
r_void
)paren
(brace
id|oprofilefs_unregister
c_func
(paren
)paren
suffix:semicolon
id|oprofile_arch_exit
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|oprofile_init
id|module_init
c_func
(paren
id|oprofile_init
)paren
suffix:semicolon
DECL|variable|oprofile_exit
id|module_exit
c_func
(paren
id|oprofile_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;John Levon &lt;levon@movementarian.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;OProfile system profiler&quot;
)paren
suffix:semicolon
eof
