multiline_comment|/**&n; * @file oprof.c&n; *&n; * @remark Copyright 2002 OProfile authors&n; * @remark Read the file COPYING&n; *&n; * @author John Levon &lt;levon@movementarian.org&gt;&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/oprofile.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &quot;oprof.h&quot;
macro_line|#include &quot;event_buffer.h&quot;
macro_line|#include &quot;cpu_buffer.h&quot;
macro_line|#include &quot;buffer_sync.h&quot;
macro_line|#include &quot;oprofile_stats.h&quot;
DECL|variable|oprofile_ops
r_struct
id|oprofile_operations
id|oprofile_ops
suffix:semicolon
DECL|variable|oprofile_started
r_int
r_int
id|oprofile_started
suffix:semicolon
DECL|variable|backtrace_depth
r_int
r_int
id|backtrace_depth
suffix:semicolon
DECL|variable|is_setup
r_static
r_int
r_int
id|is_setup
suffix:semicolon
r_static
id|DECLARE_MUTEX
c_func
(paren
id|start_sem
)paren
suffix:semicolon
multiline_comment|/* timer&n;   0 - use performance monitoring hardware if available&n;   1 - use the timer int mechanism regardless&n; */
DECL|variable|timer
r_static
r_int
id|timer
op_assign
l_int|0
suffix:semicolon
DECL|function|oprofile_setup
r_int
id|oprofile_setup
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
id|down
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|alloc_cpu_buffers
c_func
(paren
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|alloc_event_buffer
c_func
(paren
)paren
)paren
)paren
r_goto
id|out1
suffix:semicolon
r_if
c_cond
(paren
id|oprofile_ops.setup
op_logical_and
(paren
id|err
op_assign
id|oprofile_ops
dot
id|setup
c_func
(paren
)paren
)paren
)paren
r_goto
id|out2
suffix:semicolon
multiline_comment|/* Note even though this starts part of the&n;&t; * profiling overhead, it&squot;s necessary to prevent&n;&t; * us missing task deaths and eventually oopsing&n;&t; * when trying to process the event buffer.&n;&t; */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|sync_start
c_func
(paren
)paren
)paren
)paren
r_goto
id|out3
suffix:semicolon
id|is_setup
op_assign
l_int|1
suffix:semicolon
id|up
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out3
suffix:colon
r_if
c_cond
(paren
id|oprofile_ops.shutdown
)paren
id|oprofile_ops
dot
id|shutdown
c_func
(paren
)paren
suffix:semicolon
id|out2
suffix:colon
id|free_event_buffer
c_func
(paren
)paren
suffix:semicolon
id|out1
suffix:colon
id|free_cpu_buffers
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Actually start profiling (echo 1&gt;/dev/oprofile/enable) */
DECL|function|oprofile_start
r_int
id|oprofile_start
c_func
(paren
r_void
)paren
(brace
r_int
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_setup
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|oprofile_started
)paren
r_goto
id|out
suffix:semicolon
id|oprofile_reset_stats
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|oprofile_ops
dot
id|start
c_func
(paren
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|oprofile_started
op_assign
l_int|1
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* echo 0&gt;/dev/oprofile/enable */
DECL|function|oprofile_stop
r_void
id|oprofile_stop
c_func
(paren
r_void
)paren
(brace
id|down
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|oprofile_started
)paren
r_goto
id|out
suffix:semicolon
id|oprofile_ops
dot
id|stop
c_func
(paren
)paren
suffix:semicolon
id|oprofile_started
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* wake up the daemon to read what remains */
id|wake_up_buffer_waiter
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
)brace
DECL|function|oprofile_shutdown
r_void
id|oprofile_shutdown
c_func
(paren
r_void
)paren
(brace
id|down
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
id|sync_stop
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oprofile_ops.shutdown
)paren
id|oprofile_ops
dot
id|shutdown
c_func
(paren
)paren
suffix:semicolon
id|is_setup
op_assign
l_int|0
suffix:semicolon
id|free_event_buffer
c_func
(paren
)paren
suffix:semicolon
id|free_cpu_buffers
c_func
(paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
)brace
DECL|function|oprofile_set_backtrace
r_int
id|oprofile_set_backtrace
c_func
(paren
r_int
r_int
id|val
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oprofile_started
)paren
(brace
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|oprofile_ops.backtrace
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|backtrace_depth
op_assign
id|val
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|start_sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|oprofile_init
r_static
r_int
id|__init
id|oprofile_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|oprofile_arch_init
c_func
(paren
op_amp
id|oprofile_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
op_logical_or
id|timer
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;oprofile: using timer interrupt.&bslash;n&quot;
)paren
suffix:semicolon
id|oprofile_timer_init
c_func
(paren
op_amp
id|oprofile_ops
)paren
suffix:semicolon
)brace
id|err
op_assign
id|oprofilefs_register
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|oprofile_arch_exit
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|oprofile_exit
r_static
r_void
id|__exit
id|oprofile_exit
c_func
(paren
r_void
)paren
(brace
id|oprofilefs_unregister
c_func
(paren
)paren
suffix:semicolon
id|oprofile_arch_exit
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|oprofile_init
id|module_init
c_func
(paren
id|oprofile_init
)paren
suffix:semicolon
DECL|variable|oprofile_exit
id|module_exit
c_func
(paren
id|oprofile_exit
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|timer
comma
id|timer
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|timer
comma
l_string|&quot;force use of timer interrupt&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;John Levon &lt;levon@movementarian.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;OProfile system profiler&quot;
)paren
suffix:semicolon
eof
