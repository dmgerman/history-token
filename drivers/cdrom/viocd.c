multiline_comment|/* -*- linux-c -*-&n; *  drivers/cdrom/viocd.c&n; *&n; *  iSeries Virtual CD Rom&n; *&n; *  Authors: Dave Boutcher &lt;boutcher@us.ibm.com&gt;&n; *           Ryan Arnold &lt;ryanarn@us.ibm.com&gt;&n; *           Colin Devilbiss &lt;devilbis@us.ibm.com&gt;&n; *           Stephen Rothwell &lt;sfr@au1.ibm.com&gt;&n; *&n; * (C) Copyright 2000-2004 IBM Corporation&n; *&n; * This program is free software;  you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License as&n; * published by the Free Software Foundation; either version 2 of the&n; * License, or (at your option) anyu later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; *&n; * This routine provides access to CD ROM drives owned and managed by an&n; * OS/400 partition running on the same box as this Linux partition.&n; *&n; * All operations are performed by sending messages back and forth to&n; * the OS/400 partition.&n; */
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/cdrom.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;asm/bug.h&gt;
macro_line|#include &lt;asm/vio.h&gt;
macro_line|#include &lt;asm/scatterlist.h&gt;
macro_line|#include &lt;asm/iSeries/HvTypes.h&gt;
macro_line|#include &lt;asm/iSeries/HvLpEvent.h&gt;
macro_line|#include &lt;asm/iSeries/vio.h&gt;
DECL|macro|VIOCD_DEVICE
mdefine_line|#define VIOCD_DEVICE&t;&t;&t;&quot;iseries/vcd&quot;
DECL|macro|VIOCD_DEVICE_DEVFS
mdefine_line|#define VIOCD_DEVICE_DEVFS&t;&t;&quot;iseries/vcd&quot;
DECL|macro|VIOCD_VERS
mdefine_line|#define VIOCD_VERS &quot;1.06&quot;
DECL|macro|VIOCD_KERN_WARNING
mdefine_line|#define VIOCD_KERN_WARNING&t;&t;KERN_WARNING &quot;viocd: &quot;
DECL|macro|VIOCD_KERN_INFO
mdefine_line|#define VIOCD_KERN_INFO&t;&t;&t;KERN_INFO &quot;viocd: &quot;
DECL|struct|viocdlpevent
r_struct
id|viocdlpevent
(brace
DECL|member|event
r_struct
id|HvLpEvent
id|event
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
suffix:semicolon
DECL|member|version
id|u16
id|version
suffix:semicolon
DECL|member|sub_result
id|u16
id|sub_result
suffix:semicolon
DECL|member|disk
id|u16
id|disk
suffix:semicolon
DECL|member|flags
id|u16
id|flags
suffix:semicolon
DECL|member|token
id|u32
id|token
suffix:semicolon
DECL|member|offset
id|u64
id|offset
suffix:semicolon
multiline_comment|/* On open, max number of disks */
DECL|member|len
id|u64
id|len
suffix:semicolon
multiline_comment|/* On open, size of the disk */
DECL|member|block_size
id|u32
id|block_size
suffix:semicolon
multiline_comment|/* Only set on open */
DECL|member|media_size
id|u32
id|media_size
suffix:semicolon
multiline_comment|/* Only set on open */
)brace
suffix:semicolon
DECL|enum|viocdsubtype
r_enum
id|viocdsubtype
(brace
DECL|enumerator|viocdopen
id|viocdopen
op_assign
l_int|0x0001
comma
DECL|enumerator|viocdclose
id|viocdclose
op_assign
l_int|0x0002
comma
DECL|enumerator|viocdread
id|viocdread
op_assign
l_int|0x0003
comma
DECL|enumerator|viocdwrite
id|viocdwrite
op_assign
l_int|0x0004
comma
DECL|enumerator|viocdlockdoor
id|viocdlockdoor
op_assign
l_int|0x0005
comma
DECL|enumerator|viocdgetinfo
id|viocdgetinfo
op_assign
l_int|0x0006
comma
DECL|enumerator|viocdcheck
id|viocdcheck
op_assign
l_int|0x0007
)brace
suffix:semicolon
multiline_comment|/*&n; * Should probably make this a module parameter....sigh&n; */
DECL|macro|VIOCD_MAX_CD
mdefine_line|#define VIOCD_MAX_CD&t;HVMAXARCHITECTEDVIRTUALCDROMS
DECL|variable|viocd_err_table
r_static
r_const
r_struct
id|vio_error_entry
id|viocd_err_table
(braket
)braket
op_assign
(brace
(brace
l_int|0x0201
comma
id|EINVAL
comma
l_string|&quot;Invalid Range&quot;
)brace
comma
(brace
l_int|0x0202
comma
id|EINVAL
comma
l_string|&quot;Invalid Token&quot;
)brace
comma
(brace
l_int|0x0203
comma
id|EIO
comma
l_string|&quot;DMA Error&quot;
)brace
comma
(brace
l_int|0x0204
comma
id|EIO
comma
l_string|&quot;Use Error&quot;
)brace
comma
(brace
l_int|0x0205
comma
id|EIO
comma
l_string|&quot;Release Error&quot;
)brace
comma
(brace
l_int|0x0206
comma
id|EINVAL
comma
l_string|&quot;Invalid CD&quot;
)brace
comma
(brace
l_int|0x020C
comma
id|EROFS
comma
l_string|&quot;Read Only Device&quot;
)brace
comma
(brace
l_int|0x020D
comma
id|ENOMEDIUM
comma
l_string|&quot;Changed or Missing Volume (or Varied Off?)&quot;
)brace
comma
(brace
l_int|0x020E
comma
id|EIO
comma
l_string|&quot;Optical System Error (Varied Off?)&quot;
)brace
comma
(brace
l_int|0x02FF
comma
id|EIO
comma
l_string|&quot;Internal Error&quot;
)brace
comma
(brace
l_int|0x3010
comma
id|EIO
comma
l_string|&quot;Changed Volume&quot;
)brace
comma
(brace
l_int|0xC100
comma
id|EIO
comma
l_string|&quot;Optical System Error&quot;
)brace
comma
(brace
l_int|0x0000
comma
l_int|0
comma
l_int|NULL
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * This is the structure we use to exchange info between driver and interrupt&n; * handler&n; */
DECL|struct|viocd_waitevent
r_struct
id|viocd_waitevent
(brace
DECL|member|com
r_struct
id|completion
id|com
suffix:semicolon
DECL|member|rc
r_int
id|rc
suffix:semicolon
DECL|member|sub_result
id|u16
id|sub_result
suffix:semicolon
DECL|member|changed
r_int
id|changed
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* this is a lookup table for the true capabilities of a device */
DECL|struct|capability_entry
r_struct
id|capability_entry
(brace
DECL|member|type
r_char
op_star
id|type
suffix:semicolon
DECL|member|capability
r_int
id|capability
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|capability_entry
id|capability_table
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_string|&quot;6330&quot;
comma
id|CDC_LOCK
op_or
id|CDC_DVD_RAM
op_or
id|CDC_RAM
)brace
comma
(brace
l_string|&quot;6331&quot;
comma
id|CDC_LOCK
op_or
id|CDC_DVD_RAM
op_or
id|CDC_RAM
)brace
comma
(brace
l_string|&quot;6333&quot;
comma
id|CDC_LOCK
op_or
id|CDC_DVD_RAM
op_or
id|CDC_RAM
)brace
comma
(brace
l_string|&quot;632A&quot;
comma
id|CDC_LOCK
op_or
id|CDC_DVD_RAM
op_or
id|CDC_RAM
)brace
comma
(brace
l_string|&quot;6321&quot;
comma
id|CDC_LOCK
)brace
comma
(brace
l_string|&quot;632B&quot;
comma
l_int|0
)brace
comma
(brace
l_int|NULL
comma
id|CDC_LOCK
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* These are our internal structures for keeping track of devices */
DECL|variable|viocd_numdev
r_static
r_int
id|viocd_numdev
suffix:semicolon
DECL|struct|cdrom_info
r_struct
id|cdrom_info
(brace
DECL|member|rsrcname
r_char
id|rsrcname
(braket
l_int|10
)braket
suffix:semicolon
DECL|member|type
r_char
id|type
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|model
r_char
id|model
(braket
l_int|3
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * This needs to be allocated since it is passed to the&n; * Hypervisor and we may be a module.&n; */
DECL|variable|viocd_unitinfo
r_static
r_struct
id|cdrom_info
op_star
id|viocd_unitinfo
suffix:semicolon
DECL|variable|unitinfo_dmaaddr
r_static
id|dma_addr_t
id|unitinfo_dmaaddr
suffix:semicolon
DECL|struct|disk_info
r_struct
id|disk_info
(brace
DECL|member|viocd_disk
r_struct
id|gendisk
op_star
id|viocd_disk
suffix:semicolon
DECL|member|viocd_info
r_struct
id|cdrom_device_info
id|viocd_info
suffix:semicolon
DECL|member|dev
r_struct
id|device
op_star
id|dev
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|viocd_diskinfo
r_static
r_struct
id|disk_info
id|viocd_diskinfo
(braket
id|VIOCD_MAX_CD
)braket
suffix:semicolon
DECL|macro|DEVICE_NR
mdefine_line|#define DEVICE_NR(di)&t;((di) - &amp;viocd_diskinfo[0])
DECL|variable|viocd_reqlock
r_static
id|spinlock_t
id|viocd_reqlock
suffix:semicolon
DECL|macro|MAX_CD_REQ
mdefine_line|#define MAX_CD_REQ&t;1
multiline_comment|/* procfs support */
DECL|function|proc_viocd_show
r_static
r_int
id|proc_viocd_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|viocd_numdev
suffix:semicolon
id|i
op_increment
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;viocd device %d is iSeries resource %10.10s&quot;
l_string|&quot;type %4.4s, model %3.3s&bslash;n&quot;
comma
id|i
comma
id|viocd_unitinfo
(braket
id|i
)braket
dot
id|rsrcname
comma
id|viocd_unitinfo
(braket
id|i
)braket
dot
id|type
comma
id|viocd_unitinfo
(braket
id|i
)braket
dot
id|model
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|proc_viocd_open
r_static
r_int
id|proc_viocd_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|proc_viocd_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|proc_viocd_operations
r_static
r_struct
id|file_operations
id|proc_viocd_operations
op_assign
(brace
dot
id|open
op_assign
id|proc_viocd_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|function|viocd_blk_open
r_static
r_int
id|viocd_blk_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|disk_info
op_star
id|di
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_return
id|cdrom_open
c_func
(paren
op_amp
id|di-&gt;viocd_info
comma
id|inode
comma
id|file
)paren
suffix:semicolon
)brace
DECL|function|viocd_blk_release
r_static
r_int
id|viocd_blk_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|disk_info
op_star
id|di
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_return
id|cdrom_release
c_func
(paren
op_amp
id|di-&gt;viocd_info
comma
id|file
)paren
suffix:semicolon
)brace
DECL|function|viocd_blk_ioctl
r_static
r_int
id|viocd_blk_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|disk_info
op_star
id|di
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_return
id|cdrom_ioctl
c_func
(paren
id|file
comma
op_amp
id|di-&gt;viocd_info
comma
id|inode
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|function|viocd_blk_media_changed
r_static
r_int
id|viocd_blk_media_changed
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
r_struct
id|disk_info
op_star
id|di
op_assign
id|disk-&gt;private_data
suffix:semicolon
r_return
id|cdrom_media_changed
c_func
(paren
op_amp
id|di-&gt;viocd_info
)paren
suffix:semicolon
)brace
DECL|variable|viocd_fops
r_struct
id|block_device_operations
id|viocd_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|viocd_blk_open
comma
dot
id|release
op_assign
id|viocd_blk_release
comma
dot
id|ioctl
op_assign
id|viocd_blk_ioctl
comma
dot
id|media_changed
op_assign
id|viocd_blk_media_changed
comma
)brace
suffix:semicolon
multiline_comment|/* Get info on CD devices from OS/400 */
DECL|function|get_viocd_info
r_static
r_void
id|__init
id|get_viocd_info
c_func
(paren
r_void
)paren
(brace
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|viocd_waitevent
id|we
suffix:semicolon
id|viocd_unitinfo
op_assign
id|dma_alloc_coherent
c_func
(paren
id|iSeries_vio_dev
comma
r_sizeof
(paren
op_star
id|viocd_unitinfo
)paren
op_star
id|VIOCD_MAX_CD
comma
op_amp
id|unitinfo_dmaaddr
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|viocd_unitinfo
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;error allocating unitinfo&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|viocd_unitinfo
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|viocd_unitinfo
)paren
op_star
id|VIOCD_MAX_CD
)paren
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|we.com
)paren
suffix:semicolon
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_cdio
op_or
id|viocdgetinfo
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
op_amp
id|we
comma
id|VIOVERSION
op_lshift
l_int|16
comma
id|unitinfo_dmaaddr
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|viocd_unitinfo
)paren
op_star
id|VIOCD_MAX_CD
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
id|HvLpEvent_Rc_Good
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;cdrom error sending event. rc %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
r_goto
id|error_ret
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|we.com
)paren
suffix:semicolon
r_if
c_cond
(paren
id|we.rc
)paren
(brace
r_const
r_struct
id|vio_error_entry
op_star
id|err
op_assign
id|vio_lookup_rc
c_func
(paren
id|viocd_err_table
comma
id|we.sub_result
)paren
suffix:semicolon
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;bad rc %d:0x%04X on getinfo: %s&bslash;n&quot;
comma
id|we.rc
comma
id|we.sub_result
comma
id|err-&gt;msg
)paren
suffix:semicolon
r_goto
id|error_ret
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|VIOCD_MAX_CD
)paren
op_logical_and
id|viocd_unitinfo
(braket
id|i
)braket
dot
id|rsrcname
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_increment
)paren
id|viocd_numdev
op_increment
suffix:semicolon
id|error_ret
suffix:colon
r_if
c_cond
(paren
id|viocd_numdev
op_eq
l_int|0
)paren
(brace
id|dma_free_coherent
c_func
(paren
id|iSeries_vio_dev
comma
r_sizeof
(paren
op_star
id|viocd_unitinfo
)paren
op_star
id|VIOCD_MAX_CD
comma
id|viocd_unitinfo
comma
id|unitinfo_dmaaddr
)paren
suffix:semicolon
id|viocd_unitinfo
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|viocd_open
r_static
r_int
id|viocd_open
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|purpose
)paren
(brace
r_struct
id|disk_info
op_star
id|diskinfo
op_assign
id|cdi-&gt;handle
suffix:semicolon
r_int
id|device_no
op_assign
id|DEVICE_NR
c_func
(paren
id|diskinfo
)paren
suffix:semicolon
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
r_struct
id|viocd_waitevent
id|we
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|we.com
)paren
suffix:semicolon
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_cdio
op_or
id|viocdopen
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
op_amp
id|we
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
(paren
id|u64
)paren
id|device_no
op_lshift
l_int|48
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;bad rc on HvCallEvent_signalLpEventFast %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|we.com
)paren
suffix:semicolon
r_if
c_cond
(paren
id|we.rc
)paren
(brace
r_const
r_struct
id|vio_error_entry
op_star
id|err
op_assign
id|vio_lookup_rc
c_func
(paren
id|viocd_err_table
comma
id|we.sub_result
)paren
suffix:semicolon
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;bad rc %d:0x%04X on open: %s&bslash;n&quot;
comma
id|we.rc
comma
id|we.sub_result
comma
id|err-&gt;msg
)paren
suffix:semicolon
r_return
op_minus
id|err-&gt;errno
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|viocd_release
r_static
r_void
id|viocd_release
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
)paren
(brace
r_int
id|device_no
op_assign
id|DEVICE_NR
c_func
(paren
(paren
r_struct
id|disk_info
op_star
)paren
id|cdi-&gt;handle
)paren
suffix:semicolon
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_cdio
op_or
id|viocdclose
comma
id|HvLpEvent_AckInd_NoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
l_int|0
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
(paren
id|u64
)paren
id|device_no
op_lshift
l_int|48
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;bad rc on HvCallEvent_signalLpEventFast %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
)brace
multiline_comment|/* Send a read or write request to OS/400 */
DECL|function|send_request
r_static
r_int
id|send_request
c_func
(paren
r_struct
id|request
op_star
id|req
)paren
(brace
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
r_struct
id|disk_info
op_star
id|diskinfo
op_assign
id|req-&gt;rq_disk-&gt;private_data
suffix:semicolon
id|u64
id|len
suffix:semicolon
id|dma_addr_t
id|dmaaddr
suffix:semicolon
r_int
id|direction
suffix:semicolon
id|u16
id|cmd
suffix:semicolon
r_struct
id|scatterlist
id|sg
suffix:semicolon
id|BUG_ON
c_func
(paren
id|req-&gt;nr_phys_segments
OG
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|READ
)paren
(brace
id|direction
op_assign
id|DMA_FROM_DEVICE
suffix:semicolon
id|cmd
op_assign
id|viomajorsubtype_cdio
op_or
id|viocdread
suffix:semicolon
)brace
r_else
(brace
id|direction
op_assign
id|DMA_TO_DEVICE
suffix:semicolon
id|cmd
op_assign
id|viomajorsubtype_cdio
op_or
id|viocdwrite
suffix:semicolon
)brace
r_if
c_cond
(paren
id|blk_rq_map_sg
c_func
(paren
id|req-&gt;q
comma
id|req
comma
op_amp
id|sg
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;error setting up scatter/gather list&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_map_sg
c_func
(paren
id|diskinfo-&gt;dev
comma
op_amp
id|sg
comma
l_int|1
comma
id|direction
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;error allocating sg tce&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dmaaddr
op_assign
id|sg_dma_address
c_func
(paren
op_amp
id|sg
)paren
suffix:semicolon
id|len
op_assign
id|sg_dma_len
c_func
(paren
op_amp
id|sg
)paren
suffix:semicolon
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|cmd
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
id|req
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
(paren
id|u64
)paren
id|DEVICE_NR
c_func
(paren
id|diskinfo
)paren
op_lshift
l_int|48
)paren
op_or
id|dmaaddr
comma
(paren
id|u64
)paren
id|req-&gt;sector
op_star
l_int|512
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
id|HvLpEvent_Rc_Good
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;hv error on op %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|rwreq
r_static
r_int
id|rwreq
suffix:semicolon
DECL|function|do_viocd_request
r_static
r_void
id|do_viocd_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_struct
id|request
op_star
id|req
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rwreq
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|req
op_assign
id|elv_next_request
c_func
(paren
id|q
)paren
)paren
op_ne
l_int|NULL
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|blk_fs_request
c_func
(paren
id|req
)paren
)paren
id|end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|send_request
c_func
(paren
id|req
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;unable to send message to OS/400!&quot;
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
id|rwreq
op_increment
suffix:semicolon
)brace
)brace
DECL|function|viocd_media_changed
r_static
r_int
id|viocd_media_changed
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|disc_nr
)paren
(brace
r_struct
id|viocd_waitevent
id|we
suffix:semicolon
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
r_int
id|device_no
op_assign
id|DEVICE_NR
c_func
(paren
(paren
r_struct
id|disk_info
op_star
)paren
id|cdi-&gt;handle
)paren
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|we.com
)paren
suffix:semicolon
multiline_comment|/* Send the open event to OS/400 */
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_cdio
op_or
id|viocdcheck
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
op_amp
id|we
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
(paren
id|u64
)paren
id|device_no
op_lshift
l_int|48
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;bad rc on HvCallEvent_signalLpEventFast %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|we.com
)paren
suffix:semicolon
multiline_comment|/* Check the return code.  If bad, assume no change */
r_if
c_cond
(paren
id|we.rc
)paren
(brace
r_const
r_struct
id|vio_error_entry
op_star
id|err
op_assign
id|vio_lookup_rc
c_func
(paren
id|viocd_err_table
comma
id|we.sub_result
)paren
suffix:semicolon
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;bad rc %d:0x%04X on check_change: %s; Assuming no change&bslash;n&quot;
comma
id|we.rc
comma
id|we.sub_result
comma
id|err-&gt;msg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|we.changed
suffix:semicolon
)brace
DECL|function|viocd_lock_door
r_static
r_int
id|viocd_lock_door
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|locking
)paren
(brace
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
id|u64
id|device_no
op_assign
id|DEVICE_NR
c_func
(paren
(paren
r_struct
id|disk_info
op_star
)paren
id|cdi-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* NOTE: flags is 1 or 0 so it won&squot;t overwrite the device_no */
id|u64
id|flags
op_assign
op_logical_neg
op_logical_neg
id|locking
suffix:semicolon
r_struct
id|viocd_waitevent
id|we
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|we.com
)paren
suffix:semicolon
multiline_comment|/* Send the lockdoor event to OS/400 */
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_cdio
op_or
id|viocdlockdoor
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
op_amp
id|we
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
id|device_no
op_lshift
l_int|48
)paren
op_or
(paren
id|flags
op_lshift
l_int|32
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;bad rc on HvCallEvent_signalLpEventFast %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|we.com
)paren
suffix:semicolon
r_if
c_cond
(paren
id|we.rc
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|viocd_packet
r_static
r_int
id|viocd_packet
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_struct
id|packet_command
op_star
id|cgc
)paren
(brace
r_int
r_int
id|buflen
op_assign
id|cgc-&gt;buflen
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|cgc-&gt;cmd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|GPCMD_READ_DISC_INFO
suffix:colon
(brace
id|disc_information
op_star
id|di
op_assign
(paren
id|disc_information
op_star
)paren
id|cgc-&gt;buffer
suffix:semicolon
r_if
c_cond
(paren
id|buflen
op_ge
l_int|2
)paren
(brace
id|di-&gt;disc_information_length
op_assign
id|cpu_to_be16
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buflen
op_ge
l_int|3
)paren
id|di-&gt;erasable
op_assign
(paren
id|cdi-&gt;ops-&gt;capability
op_amp
op_complement
id|cdi-&gt;mask
op_amp
(paren
id|CDC_DVD_RAM
op_or
id|CDC_RAM
)paren
)paren
op_ne
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|cgc-&gt;sense
)paren
(brace
multiline_comment|/* indicate Unknown code */
id|cgc-&gt;sense-&gt;sense_key
op_assign
l_int|0x05
suffix:semicolon
id|cgc-&gt;sense-&gt;asc
op_assign
l_int|0x20
suffix:semicolon
id|cgc-&gt;sense-&gt;ascq
op_assign
l_int|0x00
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|cgc-&gt;stat
op_assign
id|ret
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|restart_all_queues
r_static
r_void
id|restart_all_queues
c_func
(paren
r_int
id|first_index
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|first_index
op_plus
l_int|1
suffix:semicolon
id|i
OL
id|viocd_numdev
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|viocd_diskinfo
(braket
id|i
)braket
dot
id|viocd_disk
)paren
id|blk_run_queue
c_func
(paren
id|viocd_diskinfo
(braket
id|i
)braket
dot
id|viocd_disk-&gt;queue
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|first_index
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|viocd_diskinfo
(braket
id|i
)braket
dot
id|viocd_disk
)paren
id|blk_run_queue
c_func
(paren
id|viocd_diskinfo
(braket
id|i
)braket
dot
id|viocd_disk-&gt;queue
)paren
suffix:semicolon
)brace
multiline_comment|/* This routine handles incoming CD LP events */
DECL|function|vio_handle_cd_event
r_static
r_void
id|vio_handle_cd_event
c_func
(paren
r_struct
id|HvLpEvent
op_star
id|event
)paren
(brace
r_struct
id|viocdlpevent
op_star
id|bevent
suffix:semicolon
r_struct
id|viocd_waitevent
op_star
id|pwe
suffix:semicolon
r_struct
id|disk_info
op_star
id|di
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|request
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
l_int|NULL
)paren
multiline_comment|/* Notification that a partition went away! */
r_return
suffix:semicolon
multiline_comment|/* First, we should NEVER get an int here...only acks */
r_if
c_cond
(paren
id|event-&gt;xFlags.xFunction
op_eq
id|HvLpEvent_Function_Int
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;Yikes! got an int in viocd event handler!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event-&gt;xFlags.xAckInd
op_eq
id|HvLpEvent_AckInd_DoAck
)paren
(brace
id|event-&gt;xRc
op_assign
id|HvLpEvent_Rc_InvalidSubtype
suffix:semicolon
id|HvCallEvent_ackLpEvent
c_func
(paren
id|event
)paren
suffix:semicolon
)brace
)brace
id|bevent
op_assign
(paren
r_struct
id|viocdlpevent
op_star
)paren
id|event
suffix:semicolon
r_switch
c_cond
(paren
id|event-&gt;xSubtype
op_amp
id|VIOMINOR_SUBTYPE_MASK
)paren
(brace
r_case
id|viocdopen
suffix:colon
r_if
c_cond
(paren
id|event-&gt;xRc
op_eq
l_int|0
)paren
(brace
id|di
op_assign
op_amp
id|viocd_diskinfo
(braket
id|bevent-&gt;disk
)braket
suffix:semicolon
id|blk_queue_hardsect_size
c_func
(paren
id|di-&gt;viocd_disk-&gt;queue
comma
id|bevent-&gt;block_size
)paren
suffix:semicolon
id|set_capacity
c_func
(paren
id|di-&gt;viocd_disk
comma
id|bevent-&gt;media_size
op_star
id|bevent-&gt;block_size
op_div
l_int|512
)paren
suffix:semicolon
)brace
multiline_comment|/* FALLTHROUGH !! */
r_case
id|viocdgetinfo
suffix:colon
r_case
id|viocdlockdoor
suffix:colon
id|pwe
op_assign
(paren
r_struct
id|viocd_waitevent
op_star
)paren
id|event-&gt;xCorrelationToken
suffix:semicolon
id|return_complete
suffix:colon
id|pwe-&gt;rc
op_assign
id|event-&gt;xRc
suffix:semicolon
id|pwe-&gt;sub_result
op_assign
id|bevent-&gt;sub_result
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|pwe-&gt;com
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|viocdcheck
suffix:colon
id|pwe
op_assign
(paren
r_struct
id|viocd_waitevent
op_star
)paren
id|event-&gt;xCorrelationToken
suffix:semicolon
id|pwe-&gt;changed
op_assign
id|bevent-&gt;flags
suffix:semicolon
r_goto
id|return_complete
suffix:semicolon
r_case
id|viocdclose
suffix:colon
r_break
suffix:semicolon
r_case
id|viocdwrite
suffix:colon
r_case
id|viocdread
suffix:colon
multiline_comment|/*&n;&t;&t; * Since this is running in interrupt mode, we need to&n;&t;&t; * make sure we&squot;re not stepping on any global I/O operations&n;&t;&t; */
id|di
op_assign
op_amp
id|viocd_diskinfo
(braket
id|bevent-&gt;disk
)braket
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|viocd_reqlock
comma
id|flags
)paren
suffix:semicolon
id|dma_unmap_single
c_func
(paren
id|di-&gt;dev
comma
id|bevent-&gt;token
comma
id|bevent-&gt;len
comma
(paren
(paren
id|event-&gt;xSubtype
op_amp
id|VIOMINOR_SUBTYPE_MASK
)paren
op_eq
id|viocdread
)paren
ques
c_cond
id|DMA_FROM_DEVICE
suffix:colon
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|req
op_assign
(paren
r_struct
id|request
op_star
)paren
id|bevent-&gt;event.xCorrelationToken
suffix:semicolon
id|rwreq
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|event-&gt;xRc
op_ne
id|HvLpEvent_Rc_Good
)paren
(brace
r_const
r_struct
id|vio_error_entry
op_star
id|err
op_assign
id|vio_lookup_rc
c_func
(paren
id|viocd_err_table
comma
id|bevent-&gt;sub_result
)paren
suffix:semicolon
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;request %p failed &quot;
l_string|&quot;with rc %d:0x%04X: %s&bslash;n&quot;
comma
id|req
comma
id|event-&gt;xRc
comma
id|bevent-&gt;sub_result
comma
id|err-&gt;msg
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
id|end_request
c_func
(paren
id|req
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* restart handling of incoming requests */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|viocd_reqlock
comma
id|flags
)paren
suffix:semicolon
id|restart_all_queues
c_func
(paren
id|bevent-&gt;disk
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;message with invalid subtype %0x04X!&bslash;n&quot;
comma
id|event-&gt;xSubtype
op_amp
id|VIOMINOR_SUBTYPE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event-&gt;xFlags.xAckInd
op_eq
id|HvLpEvent_AckInd_DoAck
)paren
(brace
id|event-&gt;xRc
op_assign
id|HvLpEvent_Rc_InvalidSubtype
suffix:semicolon
id|HvCallEvent_ackLpEvent
c_func
(paren
id|event
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|viocd_dops
r_static
r_struct
id|cdrom_device_ops
id|viocd_dops
op_assign
(brace
dot
id|open
op_assign
id|viocd_open
comma
dot
id|release
op_assign
id|viocd_release
comma
dot
id|media_changed
op_assign
id|viocd_media_changed
comma
dot
id|lock_door
op_assign
id|viocd_lock_door
comma
dot
id|generic_packet
op_assign
id|viocd_packet
comma
dot
id|capability
op_assign
id|CDC_CLOSE_TRAY
op_or
id|CDC_OPEN_TRAY
op_or
id|CDC_LOCK
op_or
id|CDC_SELECT_SPEED
op_or
id|CDC_SELECT_DISC
op_or
id|CDC_MULTI_SESSION
op_or
id|CDC_MCN
op_or
id|CDC_MEDIA_CHANGED
op_or
id|CDC_PLAY_AUDIO
op_or
id|CDC_RESET
op_or
id|CDC_IOCTLS
op_or
id|CDC_DRIVE_STATUS
op_or
id|CDC_GENERIC_PACKET
op_or
id|CDC_CD_R
op_or
id|CDC_CD_RW
op_or
id|CDC_DVD
op_or
id|CDC_DVD_R
op_or
id|CDC_DVD_RAM
op_or
id|CDC_RAM
)brace
suffix:semicolon
DECL|function|find_capability
r_static
r_int
id|__init
id|find_capability
c_func
(paren
r_const
r_char
op_star
id|type
)paren
(brace
r_struct
id|capability_entry
op_star
id|entry
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
id|capability_table
suffix:semicolon
id|entry-&gt;type
suffix:semicolon
op_increment
id|entry
)paren
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|entry-&gt;type
comma
id|type
comma
l_int|4
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_return
id|entry-&gt;capability
suffix:semicolon
)brace
DECL|function|viocd_probe
r_static
r_int
id|viocd_probe
c_func
(paren
r_struct
id|vio_dev
op_star
id|vdev
comma
r_const
r_struct
id|vio_device_id
op_star
id|id
)paren
(brace
r_struct
id|gendisk
op_star
id|gendisk
suffix:semicolon
r_int
id|deviceno
suffix:semicolon
r_struct
id|disk_info
op_star
id|d
suffix:semicolon
r_struct
id|cdrom_device_info
op_star
id|c
suffix:semicolon
r_struct
id|cdrom_info
op_star
id|ci
suffix:semicolon
r_struct
id|request_queue
op_star
id|q
suffix:semicolon
id|deviceno
op_assign
id|vdev-&gt;unit_address
suffix:semicolon
r_if
c_cond
(paren
id|deviceno
op_ge
id|viocd_numdev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|d
op_assign
op_amp
id|viocd_diskinfo
(braket
id|deviceno
)braket
suffix:semicolon
id|c
op_assign
op_amp
id|d-&gt;viocd_info
suffix:semicolon
id|ci
op_assign
op_amp
id|viocd_unitinfo
(braket
id|deviceno
)braket
suffix:semicolon
id|c-&gt;ops
op_assign
op_amp
id|viocd_dops
suffix:semicolon
id|c-&gt;speed
op_assign
l_int|4
suffix:semicolon
id|c-&gt;capacity
op_assign
l_int|1
suffix:semicolon
id|c-&gt;handle
op_assign
id|d
suffix:semicolon
id|c-&gt;mask
op_assign
op_complement
id|find_capability
c_func
(paren
id|ci-&gt;type
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|c-&gt;name
comma
id|VIOCD_DEVICE
l_string|&quot;%c&quot;
comma
l_char|&squot;a&squot;
op_plus
id|deviceno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_cdrom
c_func
(paren
id|c
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;Cannot register viocd CD-ROM %s!&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|printk
c_func
(paren
id|VIOCD_KERN_INFO
l_string|&quot;cd %s is iSeries resource %10.10s &quot;
l_string|&quot;type %4.4s, model %3.3s&bslash;n&quot;
comma
id|c-&gt;name
comma
id|ci-&gt;rsrcname
comma
id|ci-&gt;type
comma
id|ci-&gt;model
)paren
suffix:semicolon
id|q
op_assign
id|blk_init_queue
c_func
(paren
id|do_viocd_request
comma
op_amp
id|viocd_reqlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;Cannot allocate queue for %s!&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_goto
id|out_unregister_cdrom
suffix:semicolon
)brace
id|gendisk
op_assign
id|alloc_disk
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gendisk
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;Cannot create gendisk for %s!&bslash;n&quot;
comma
id|c-&gt;name
)paren
suffix:semicolon
r_goto
id|out_cleanup_queue
suffix:semicolon
)brace
id|gendisk-&gt;major
op_assign
id|VIOCD_MAJOR
suffix:semicolon
id|gendisk-&gt;first_minor
op_assign
id|deviceno
suffix:semicolon
id|strncpy
c_func
(paren
id|gendisk-&gt;disk_name
comma
id|c-&gt;name
comma
r_sizeof
(paren
id|gendisk-&gt;disk_name
)paren
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|gendisk-&gt;devfs_name
comma
r_sizeof
(paren
id|gendisk-&gt;devfs_name
)paren
comma
id|VIOCD_DEVICE_DEVFS
l_string|&quot;%d&quot;
comma
id|deviceno
)paren
suffix:semicolon
id|blk_queue_max_hw_segments
c_func
(paren
id|q
comma
l_int|1
)paren
suffix:semicolon
id|blk_queue_max_phys_segments
c_func
(paren
id|q
comma
l_int|1
)paren
suffix:semicolon
id|blk_queue_max_sectors
c_func
(paren
id|q
comma
l_int|4096
op_div
l_int|512
)paren
suffix:semicolon
id|gendisk-&gt;queue
op_assign
id|q
suffix:semicolon
id|gendisk-&gt;fops
op_assign
op_amp
id|viocd_fops
suffix:semicolon
id|gendisk-&gt;flags
op_assign
id|GENHD_FL_CD
op_or
id|GENHD_FL_REMOVABLE
suffix:semicolon
id|set_capacity
c_func
(paren
id|gendisk
comma
l_int|0
)paren
suffix:semicolon
id|gendisk-&gt;private_data
op_assign
id|d
suffix:semicolon
id|d-&gt;viocd_disk
op_assign
id|gendisk
suffix:semicolon
id|d-&gt;dev
op_assign
op_amp
id|vdev-&gt;dev
suffix:semicolon
id|gendisk-&gt;driverfs_dev
op_assign
id|d-&gt;dev
suffix:semicolon
id|add_disk
c_func
(paren
id|gendisk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_cleanup_queue
suffix:colon
id|blk_cleanup_queue
c_func
(paren
id|q
)paren
suffix:semicolon
id|out_unregister_cdrom
suffix:colon
id|unregister_cdrom
c_func
(paren
id|c
)paren
suffix:semicolon
id|out
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|viocd_remove
r_static
r_int
id|viocd_remove
c_func
(paren
r_struct
id|vio_dev
op_star
id|vdev
)paren
(brace
r_struct
id|disk_info
op_star
id|d
op_assign
op_amp
id|viocd_diskinfo
(braket
id|vdev-&gt;unit_address
)braket
suffix:semicolon
r_if
c_cond
(paren
id|unregister_cdrom
c_func
(paren
op_amp
id|d-&gt;viocd_info
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;Cannot unregister viocd CD-ROM %s!&bslash;n&quot;
comma
id|d-&gt;viocd_info.name
)paren
suffix:semicolon
id|del_gendisk
c_func
(paren
id|d-&gt;viocd_disk
)paren
suffix:semicolon
id|blk_cleanup_queue
c_func
(paren
id|d-&gt;viocd_disk-&gt;queue
)paren
suffix:semicolon
id|put_disk
c_func
(paren
id|d-&gt;viocd_disk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * viocd_device_table: Used by vio.c to match devices that we&n; * support.&n; */
DECL|variable|__devinitdata
r_static
r_struct
id|vio_device_id
id|viocd_device_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_string|&quot;viocd&quot;
comma
l_string|&quot;&quot;
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|vio
comma
id|viocd_device_table
)paren
suffix:semicolon
DECL|variable|viocd_driver
r_static
r_struct
id|vio_driver
id|viocd_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;viocd&quot;
comma
dot
id|id_table
op_assign
id|viocd_device_table
comma
dot
id|probe
op_assign
id|viocd_probe
comma
dot
id|remove
op_assign
id|viocd_remove
)brace
suffix:semicolon
DECL|function|viocd_init
r_static
r_int
id|__init
id|viocd_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|e
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|viopath_hostLp
op_eq
id|HvLpIndexInvalid
)paren
(brace
id|vio_set_hostlp
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* If we don&squot;t have a host, bail out */
r_if
c_cond
(paren
id|viopath_hostLp
op_eq
id|HvLpIndexInvalid
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
id|VIOCD_KERN_INFO
l_string|&quot;vers &quot;
id|VIOCD_VERS
l_string|&quot;, hosting partition %d&bslash;n&quot;
comma
id|viopath_hostLp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|VIOCD_MAJOR
comma
id|VIOCD_DEVICE
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;Unable to get major %d for %s&bslash;n&quot;
comma
id|VIOCD_MAJOR
comma
id|VIOCD_DEVICE
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|ret
op_assign
id|viopath_open
c_func
(paren
id|viopath_hostLp
comma
id|viomajorsubtype_cdio
comma
id|MAX_CD_REQ
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|VIOCD_KERN_WARNING
l_string|&quot;error opening path to host partition %d&bslash;n&quot;
comma
id|viopath_hostLp
)paren
suffix:semicolon
r_goto
id|out_unregister
suffix:semicolon
)brace
multiline_comment|/* Initialize our request handler */
id|vio_setHandler
c_func
(paren
id|viomajorsubtype_cdio
comma
id|vio_handle_cd_event
)paren
suffix:semicolon
id|get_viocd_info
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|viocd_reqlock
)paren
suffix:semicolon
id|ret
op_assign
id|vio_register_driver
c_func
(paren
op_amp
id|viocd_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out_free_info
suffix:semicolon
id|e
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;iSeries/viocd&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
)paren
(brace
id|e-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|e-&gt;proc_fops
op_assign
op_amp
id|proc_viocd_operations
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_free_info
suffix:colon
id|dma_free_coherent
c_func
(paren
id|iSeries_vio_dev
comma
r_sizeof
(paren
op_star
id|viocd_unitinfo
)paren
op_star
id|VIOCD_MAX_CD
comma
id|viocd_unitinfo
comma
id|unitinfo_dmaaddr
)paren
suffix:semicolon
id|vio_clearHandler
c_func
(paren
id|viomajorsubtype_cdio
)paren
suffix:semicolon
id|viopath_close
c_func
(paren
id|viopath_hostLp
comma
id|viomajorsubtype_cdio
comma
id|MAX_CD_REQ
op_plus
l_int|2
)paren
suffix:semicolon
id|out_unregister
suffix:colon
id|unregister_blkdev
c_func
(paren
id|VIOCD_MAJOR
comma
id|VIOCD_DEVICE
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|viocd_exit
r_static
r_void
id|__exit
id|viocd_exit
c_func
(paren
r_void
)paren
(brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;iSeries/viocd&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|vio_unregister_driver
c_func
(paren
op_amp
id|viocd_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|viocd_unitinfo
op_ne
l_int|NULL
)paren
id|dma_free_coherent
c_func
(paren
id|iSeries_vio_dev
comma
r_sizeof
(paren
op_star
id|viocd_unitinfo
)paren
op_star
id|VIOCD_MAX_CD
comma
id|viocd_unitinfo
comma
id|unitinfo_dmaaddr
)paren
suffix:semicolon
id|viopath_close
c_func
(paren
id|viopath_hostLp
comma
id|viomajorsubtype_cdio
comma
id|MAX_CD_REQ
op_plus
l_int|2
)paren
suffix:semicolon
id|vio_clearHandler
c_func
(paren
id|viomajorsubtype_cdio
)paren
suffix:semicolon
id|unregister_blkdev
c_func
(paren
id|VIOCD_MAJOR
comma
id|VIOCD_DEVICE
)paren
suffix:semicolon
)brace
DECL|variable|viocd_init
id|module_init
c_func
(paren
id|viocd_init
)paren
suffix:semicolon
DECL|variable|viocd_exit
id|module_exit
c_func
(paren
id|viocd_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
