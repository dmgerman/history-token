multiline_comment|/*******************************************************************************&n;&n;  &n;  Copyright(c) 1999 - 2002 Intel Corporation. All rights reserved.&n;  &n;  This program is free software; you can redistribute it and/or modify it &n;  under the terms of the GNU General Public License as published by the Free &n;  Software Foundation; either version 2 of the License, or (at your option) &n;  any later version.&n;  &n;  This program is distributed in the hope that it will be useful, but WITHOUT &n;  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or &n;  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for &n;  more details.&n;  &n;  You should have received a copy of the GNU General Public License along with&n;  this program; if not, write to the Free Software Foundation, Inc., 59 &n;  Temple Place - Suite 330, Boston, MA  02111-1307, USA.&n;  &n;  The full GNU General Public License is included in this distribution in the&n;  file called LICENSE.&n;  &n;  Contact Information:&n;  Linux NICS &lt;linux.nics@intel.com&gt;&n;  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497&n;*******************************************************************************/
multiline_comment|/**********************************************************************&n;*                                                                       *&n;* INTEL CORPORATION                                                     *&n;*                                                                       *&n;* This software is supplied under the terms of the license included     *&n;* above.  All use of this driver must be in accordance with the terms   *&n;* of that license.                                                      *&n;*                                                                       *&n;* Module Name:  e100_proc.c                                             *&n;*                                                                       *&n;* Abstract:     Functions to handle the proc file system.               *&n;*               Create the proc directories and files and run read and  *&n;*               write requests from the user                            *&n;*                                                                       *&n;* Environment:  This file is intended to be specific to the Linux       *&n;*               operating system.                                       *&n;*                                                                       *&n;**********************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#include &quot;e100.h&quot;
multiline_comment|/* MDI sleep time is at least 50 ms, in jiffies */
DECL|macro|MDI_SLEEP_TIME
mdefine_line|#define MDI_SLEEP_TIME ((HZ / 20) + 1)
multiline_comment|/***************************************************************************/
multiline_comment|/*       /proc File System Interaface Support Functions                    */
multiline_comment|/***************************************************************************/
DECL|variable|adapters_proc_dir
r_static
r_struct
id|proc_dir_entry
op_star
id|adapters_proc_dir
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* externs from e100_main.c */
r_extern
r_char
id|e100_short_driver_name
(braket
)braket
suffix:semicolon
r_extern
r_char
id|e100_driver_version
(braket
)braket
suffix:semicolon
r_extern
r_struct
id|net_device_stats
op_star
id|e100_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_extern
r_char
op_star
id|e100_get_brand_msg
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
suffix:semicolon
r_extern
r_int
id|e100_mdi_write
c_func
(paren
r_struct
id|e100_private
op_star
comma
id|u32
comma
id|u32
comma
id|u16
)paren
suffix:semicolon
r_static
r_void
id|e100_proc_cleanup
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
r_char
id|e100_init_proc_dir
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|macro|ADAPTERS_PROC_DIR
mdefine_line|#define ADAPTERS_PROC_DIR &quot;PRO_LAN_Adapters&quot;
DECL|macro|WRITE_BUF_MAX_LEN
mdefine_line|#define WRITE_BUF_MAX_LEN 20&t;
DECL|macro|READ_BUF_MAX_LEN
mdefine_line|#define READ_BUF_MAX_LEN  256
DECL|macro|E100_PE_LEN
mdefine_line|#define E100_PE_LEN       25
DECL|macro|bdp_drv_off
mdefine_line|#define bdp_drv_off(off) (unsigned long)(offsetof(struct e100_private, drv_stats.off))
DECL|macro|bdp_prm_off
mdefine_line|#define bdp_prm_off(off) (unsigned long)(offsetof(struct e100_private, params.off))
DECL|struct|_e100_proc_entry
r_typedef
r_struct
id|_e100_proc_entry
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|read_proc
id|read_proc_t
op_star
id|read_proc
suffix:semicolon
DECL|member|write_proc
id|write_proc_t
op_star
id|write_proc
suffix:semicolon
DECL|member|offset
r_int
r_int
id|offset
suffix:semicolon
multiline_comment|/* offset into bdp. ~0 means no value, pass NULL. */
DECL|typedef|e100_proc_entry
)brace
id|e100_proc_entry
suffix:semicolon
r_static
r_int
DECL|function|generic_read
id|generic_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_ulong
id|read_ulong
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_int
r_int
id|l
)paren
(brace
r_int
id|len
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;%lu&bslash;n&quot;
comma
id|l
)paren
suffix:semicolon
r_return
id|generic_read
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_gen_ulong
id|read_gen_ulong
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|data
)paren
id|val
op_assign
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|data
)paren
suffix:semicolon
r_return
id|read_ulong
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|val
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_hwaddr
id|read_hwaddr
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_int
r_char
op_star
id|hwaddr
)paren
(brace
r_int
id|len
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;%02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|hwaddr
(braket
l_int|0
)braket
comma
id|hwaddr
(braket
l_int|1
)braket
comma
id|hwaddr
(braket
l_int|2
)braket
comma
id|hwaddr
(braket
l_int|3
)braket
comma
id|hwaddr
(braket
l_int|4
)braket
comma
id|hwaddr
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_return
id|generic_read
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_descr
id|read_descr
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|data
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|bdp-&gt;id_string
)paren
suffix:semicolon
r_return
id|generic_read
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_permanent_hwaddr
id|read_permanent_hwaddr
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|data
suffix:semicolon
r_int
r_char
op_star
id|hwaddr
op_assign
id|bdp-&gt;perm_node_address
suffix:semicolon
r_return
id|read_hwaddr
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|hwaddr
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_part_number
id|read_part_number
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|data
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;%06lx-%03x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
(paren
id|bdp-&gt;pwa_no
op_rshift
l_int|8
)paren
comma
(paren
r_int
r_int
)paren
(paren
id|bdp-&gt;pwa_no
op_amp
l_int|0xFF
)paren
)paren
suffix:semicolon
r_return
id|generic_read
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|set_led
id|set_led
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
comma
id|u16
id|led_mdi_op
)paren
(brace
id|e100_mdi_write
c_func
(paren
id|bdp
comma
id|PHY_82555_LED_SWITCH_CONTROL
comma
id|bdp-&gt;phy_addr
comma
id|led_mdi_op
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|MDI_SLEEP_TIME
)paren
suffix:semicolon
multiline_comment|/* turn led ownership to the chip */
id|e100_mdi_write
c_func
(paren
id|bdp
comma
id|PHY_82555_LED_SWITCH_CONTROL
comma
id|bdp-&gt;phy_addr
comma
id|PHY_82555_LED_NORMAL_CONTROL
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|write_blink_led_timer
id|write_blink_led_timer
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|data
suffix:semicolon
r_char
id|s_blink_op
(braket
id|WRITE_BUF_MAX_LEN
op_plus
l_int|1
)braket
suffix:semicolon
r_char
op_star
id|res
suffix:semicolon
r_int
r_int
id|i_blink_op
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|WRITE_BUF_MAX_LEN
)paren
(brace
id|count
op_assign
id|WRITE_BUF_MAX_LEN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|s_blink_op
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|s_blink_op
(braket
id|count
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|i_blink_op
op_assign
id|simple_strtoul
c_func
(paren
id|s_blink_op
comma
op_amp
id|res
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_eq
id|s_blink_op
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|i_blink_op
)paren
(brace
r_case
id|LED_OFF
suffix:colon
id|set_led
c_func
(paren
id|bdp
comma
id|PHY_82555_LED_OFF
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LED_ON
suffix:colon
r_if
c_cond
(paren
id|bdp-&gt;rev_id
op_ge
id|D101MA_REV_ID
)paren
id|set_led
c_func
(paren
id|bdp
comma
id|PHY_82555_LED_ON_559
)paren
suffix:semicolon
r_else
id|set_led
c_func
(paren
id|bdp
comma
id|PHY_82555_LED_ON_PRE_559
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|variable|e100_proc_list
r_static
id|e100_proc_entry
id|e100_proc_list
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;Description&quot;
comma
id|read_descr
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_string|&quot;Permanent_HWaddr&quot;
comma
id|read_permanent_hwaddr
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_string|&quot;Part_Number&quot;
comma
id|read_part_number
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_string|&quot;&bslash;n&quot;
comma
)brace
comma
(brace
l_string|&quot;Rx_TCP_Checksum_Good&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
op_complement
l_int|0
)brace
comma
(brace
l_string|&quot;Rx_TCP_Checksum_Bad&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
op_complement
l_int|0
)brace
comma
(brace
l_string|&quot;Tx_TCP_Checksum_Good&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
op_complement
l_int|0
)brace
comma
(brace
l_string|&quot;Tx_TCP_Checksum_Bad&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
op_complement
l_int|0
)brace
comma
(brace
l_string|&quot;&bslash;n&quot;
comma
)brace
comma
(brace
l_string|&quot;Tx_Abort_Late_Coll&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
id|bdp_drv_off
c_func
(paren
id|tx_late_col
)paren
)brace
comma
(brace
l_string|&quot;Tx_Deferred_Ok&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
id|bdp_drv_off
c_func
(paren
id|tx_ok_defrd
)paren
)brace
comma
(brace
l_string|&quot;Tx_Single_Coll_Ok&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
id|bdp_drv_off
c_func
(paren
id|tx_one_retry
)paren
)brace
comma
(brace
l_string|&quot;Tx_Multi_Coll_Ok&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
id|bdp_drv_off
c_func
(paren
id|tx_mt_one_retry
)paren
)brace
comma
(brace
l_string|&quot;Rx_Long_Length_Errors&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
op_complement
l_int|0
)brace
comma
(brace
l_string|&quot;&bslash;n&quot;
comma
)brace
comma
(brace
l_string|&quot;Tx_Flow_Control_Pause&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
id|bdp_drv_off
c_func
(paren
id|xmt_fc_pkts
)paren
)brace
comma
(brace
l_string|&quot;Rx_Flow_Control_Pause&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
id|bdp_drv_off
c_func
(paren
id|rcv_fc_pkts
)paren
)brace
comma
(brace
l_string|&quot;Rx_Flow_Control_Unsup&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
id|bdp_drv_off
c_func
(paren
id|rcv_fc_unsupported
)paren
)brace
comma
(brace
l_string|&quot;&bslash;n&quot;
comma
)brace
comma
(brace
l_string|&quot;Tx_TCO_Packets&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
id|bdp_drv_off
c_func
(paren
id|xmt_tco_pkts
)paren
)brace
comma
(brace
l_string|&quot;Rx_TCO_Packets&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
id|bdp_drv_off
c_func
(paren
id|rcv_tco_pkts
)paren
)brace
comma
(brace
l_string|&quot;&bslash;n&quot;
comma
)brace
comma
(brace
l_string|&quot;Rx_Interrupt_Packets&quot;
comma
id|read_gen_ulong
comma
l_int|0
comma
id|bdp_drv_off
c_func
(paren
id|rx_intr_pkts
)paren
)brace
comma
(brace
l_string|&quot;Identify_Adapter&quot;
comma
l_int|0
comma
id|write_blink_led_timer
comma
l_int|0
)brace
comma
(brace
l_string|&quot;&quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
r_static
r_int
DECL|function|read_info
id|read_info
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|data
suffix:semicolon
id|e100_proc_entry
op_star
id|pe
suffix:semicolon
r_int
id|tmp
suffix:semicolon
r_void
op_star
id|val
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|pe
op_assign
id|e100_proc_list
suffix:semicolon
id|pe-&gt;name
(braket
l_int|0
)braket
suffix:semicolon
id|pe
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pe-&gt;name
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pe-&gt;read_proc
)paren
(brace
r_if
c_cond
(paren
(paren
id|len
op_plus
id|READ_BUF_MAX_LEN
op_plus
id|E100_PE_LEN
op_plus
l_int|1
)paren
op_ge
id|PAGE_SIZE
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|pe-&gt;offset
op_ne
op_complement
l_int|0
)paren
id|val
op_assign
(paren
(paren
r_char
op_star
)paren
id|bdp
)paren
op_plus
id|pe-&gt;offset
suffix:semicolon
r_else
id|val
op_assign
l_int|NULL
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%-&quot;
id|__MODULE_STRING
c_func
(paren
id|E100_PE_LEN
)paren
l_string|&quot;s &quot;
comma
id|pe-&gt;name
)paren
suffix:semicolon
id|len
op_add_assign
id|pe
op_member_access_from_pointer
id|read_proc
c_func
(paren
id|page
op_plus
id|len
comma
id|start
comma
l_int|0
comma
id|READ_BUF_MAX_LEN
op_plus
l_int|1
comma
op_amp
id|tmp
comma
id|val
)paren
suffix:semicolon
)brace
)brace
r_return
id|generic_read
c_func
(paren
id|page
comma
id|start
comma
id|off
comma
id|count
comma
id|eof
comma
id|len
)paren
suffix:semicolon
)brace
r_static
r_struct
id|proc_dir_entry
op_star
DECL|function|create_proc_rw
id|create_proc_rw
c_func
(paren
r_char
op_star
id|name
comma
r_void
op_star
id|data
comma
r_struct
id|proc_dir_entry
op_star
id|parent
comma
id|read_proc_t
op_star
id|read_proc
comma
id|write_proc_t
op_star
id|write_proc
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|pdep
suffix:semicolon
id|mode_t
id|mode
op_assign
id|S_IFREG
suffix:semicolon
r_if
c_cond
(paren
id|write_proc
)paren
(brace
id|mode
op_or_assign
id|S_IWUSR
suffix:semicolon
r_if
c_cond
(paren
id|read_proc
)paren
(brace
id|mode
op_or_assign
id|S_IRUSR
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|read_proc
)paren
(brace
id|mode
op_or_assign
id|S_IRUGO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pdep
op_assign
id|create_proc_entry
c_func
(paren
id|name
comma
id|mode
comma
id|parent
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|pdep-&gt;read_proc
op_assign
id|read_proc
suffix:semicolon
id|pdep-&gt;write_proc
op_assign
id|write_proc
suffix:semicolon
id|pdep-&gt;data
op_assign
id|data
suffix:semicolon
r_return
id|pdep
suffix:semicolon
)brace
r_void
DECL|function|e100_remove_proc_subdir
id|e100_remove_proc_subdir
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
comma
r_char
op_star
id|name
)paren
(brace
id|e100_proc_entry
op_star
id|pe
suffix:semicolon
r_char
id|info
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/* If our root /proc dir was not created, there is nothing to remove */
r_if
c_cond
(paren
id|adapters_proc_dir
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|len
op_assign
id|strlen
c_func
(paren
id|bdp-&gt;ifname
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info
comma
id|bdp-&gt;ifname
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|strncat
c_func
(paren
id|info
op_plus
id|len
comma
l_string|&quot;.info&quot;
comma
r_sizeof
(paren
id|info
)paren
op_minus
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bdp-&gt;proc_parent
)paren
(brace
r_for
c_loop
(paren
id|pe
op_assign
id|e100_proc_list
suffix:semicolon
id|pe-&gt;name
(braket
l_int|0
)braket
suffix:semicolon
id|pe
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pe-&gt;name
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
r_continue
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|pe-&gt;name
comma
id|bdp-&gt;proc_parent
)paren
suffix:semicolon
)brace
id|remove_proc_entry
c_func
(paren
id|bdp-&gt;ifname
comma
id|adapters_proc_dir
)paren
suffix:semicolon
id|bdp-&gt;proc_parent
op_assign
l_int|NULL
suffix:semicolon
)brace
id|remove_proc_entry
c_func
(paren
id|info
comma
id|adapters_proc_dir
)paren
suffix:semicolon
multiline_comment|/* try to remove the main /proc dir, if it&squot;s empty */
id|e100_proc_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|e100_create_proc_subdir
id|e100_create_proc_subdir
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|dev_dir
suffix:semicolon
id|e100_proc_entry
op_star
id|pe
suffix:semicolon
r_char
id|info
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
r_void
op_star
id|data
suffix:semicolon
multiline_comment|/* create the main /proc dir if needed */
r_if
c_cond
(paren
op_logical_neg
id|adapters_proc_dir
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|e100_init_proc_dir
c_func
(paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|strncpy
c_func
(paren
id|info
comma
id|bdp-&gt;ifname
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|info
)paren
suffix:semicolon
id|strncat
c_func
(paren
id|info
op_plus
id|len
comma
l_string|&quot;.info&quot;
comma
r_sizeof
(paren
id|info
)paren
op_minus
id|len
)paren
suffix:semicolon
multiline_comment|/* info */
r_if
c_cond
(paren
op_logical_neg
(paren
id|create_proc_rw
c_func
(paren
id|info
comma
id|bdp
comma
id|adapters_proc_dir
comma
id|read_info
comma
l_int|0
)paren
)paren
)paren
(brace
id|e100_proc_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev_dir
op_assign
id|create_proc_entry
c_func
(paren
id|bdp-&gt;ifname
comma
id|S_IFDIR
comma
id|adapters_proc_dir
)paren
suffix:semicolon
id|bdp-&gt;proc_parent
op_assign
id|dev_dir
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_dir
)paren
(brace
id|e100_remove_proc_subdir
c_func
(paren
id|bdp
comma
id|bdp-&gt;ifname
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_for
c_loop
(paren
id|pe
op_assign
id|e100_proc_list
suffix:semicolon
id|pe-&gt;name
(braket
l_int|0
)braket
suffix:semicolon
id|pe
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pe-&gt;name
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pe-&gt;offset
op_ne
op_complement
l_int|0
)paren
id|data
op_assign
(paren
(paren
r_char
op_star
)paren
id|bdp
)paren
op_plus
id|pe-&gt;offset
suffix:semicolon
r_else
id|data
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|create_proc_rw
c_func
(paren
id|pe-&gt;name
comma
id|data
comma
id|dev_dir
comma
id|pe-&gt;read_proc
comma
id|pe-&gt;write_proc
)paren
)paren
)paren
(brace
id|e100_remove_proc_subdir
c_func
(paren
id|bdp
comma
id|bdp-&gt;ifname
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * Name:          e100_init_proc_dir&n; *&n; * Description:   This routine creates the top-level /proc directory for the&n; *                driver in /proc/net&n; *&n; * Arguments:     none&n; *&n; * Returns:       true on success, false on fail&n; *&n; ***************************************************************************/
r_static
r_int
r_char
DECL|function|e100_init_proc_dir
id|e100_init_proc_dir
c_func
(paren
r_void
)paren
(brace
r_int
id|len
suffix:semicolon
multiline_comment|/* first check if adapters_proc_dir already exists */
id|len
op_assign
id|strlen
c_func
(paren
id|ADAPTERS_PROC_DIR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|adapters_proc_dir
op_assign
id|proc_net-&gt;subdir
suffix:semicolon
id|adapters_proc_dir
suffix:semicolon
id|adapters_proc_dir
op_assign
id|adapters_proc_dir-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|adapters_proc_dir-&gt;namelen
op_eq
id|len
)paren
op_logical_and
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|adapters_proc_dir-&gt;name
comma
id|ADAPTERS_PROC_DIR
comma
id|len
)paren
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|adapters_proc_dir
)paren
id|adapters_proc_dir
op_assign
id|create_proc_entry
c_func
(paren
id|ADAPTERS_PROC_DIR
comma
id|S_IFDIR
comma
id|proc_net
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapters_proc_dir
)paren
r_return
l_bool|false
suffix:semicolon
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; * Name:          e100_proc_cleanup&n; *&n; * Description:   This routine clears the top-level /proc directory, if empty.&n; *&n; * Arguments:     none&n; *&n; * Returns:       none&n; *&n; ***************************************************************************/
r_static
r_void
DECL|function|e100_proc_cleanup
id|e100_proc_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|de
suffix:semicolon
r_if
c_cond
(paren
id|adapters_proc_dir
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* check if subdir list is empty before removing adapters_proc_dir */
r_for
c_loop
(paren
id|de
op_assign
id|adapters_proc_dir-&gt;subdir
suffix:semicolon
id|de
suffix:semicolon
id|de
op_assign
id|de-&gt;next
)paren
(brace
multiline_comment|/* ignore . and .. */
r_if
c_cond
(paren
op_star
(paren
id|de-&gt;name
)paren
op_ne
l_char|&squot;.&squot;
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|de
)paren
r_return
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|ADAPTERS_PROC_DIR
comma
id|proc_net
)paren
suffix:semicolon
id|adapters_proc_dir
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PROC_FS */
eof
