multiline_comment|/*******************************************************************************&n;&n;This software program is available to you under a choice of one of two &n;licenses. You may choose to be licensed under either the GNU General Public &n;License 2.0, June 1991, available at http://www.fsf.org/copyleft/gpl.html, &n;or the Intel BSD + Patent License, the text of which follows:&n;&n;Recipient has requested a license and Intel Corporation (&quot;Intel&quot;) is willing&n;to grant a license for the software entitled Linux Base Driver for the &n;Intel(R) PRO/100 Family of Adapters (e100) (the &quot;Software&quot;) being provided &n;by Intel Corporation. The following definitions apply to this license:&n;&n;&quot;Licensed Patents&quot; means patent claims licensable by Intel Corporation which &n;are necessarily infringed by the use of sale of the Software alone or when &n;combined with the operating system referred to below.&n;&n;&quot;Recipient&quot; means the party to whom Intel delivers this Software.&n;&n;&quot;Licensee&quot; means Recipient and those third parties that receive a license to &n;any operating system available under the GNU General Public License 2.0 or &n;later.&n;&n;Copyright (c) 1999 - 2002 Intel Corporation.&n;All rights reserved.&n;&n;The license is provided to Recipient and Recipient&squot;s Licensees under the &n;following terms.&n;&n;Redistribution and use in source and binary forms of the Software, with or &n;without modification, are permitted provided that the following conditions &n;are met:&n;&n;Redistributions of source code of the Software may retain the above &n;copyright notice, this list of conditions and the following disclaimer.&n;&n;Redistributions in binary form of the Software may reproduce the above &n;copyright notice, this list of conditions and the following disclaimer in &n;the documentation and/or materials provided with the distribution.&n;&n;Neither the name of Intel Corporation nor the names of its contributors &n;shall be used to endorse or promote products derived from this Software &n;without specific prior written permission.&n;&n;Intel hereby grants Recipient and Licensees a non-exclusive, worldwide, &n;royalty-free patent license under Licensed Patents to make, use, sell, offer &n;to sell, import and otherwise transfer the Software, if any, in source code &n;and object code form. This license shall include changes to the Software &n;that are error corrections or other minor changes to the Software that do &n;not add functionality or features when the Software is incorporated in any &n;version of an operating system that has been distributed under the GNU &n;General Public License 2.0 or later. This patent license shall apply to the &n;combination of the Software and any operating system licensed under the GNU &n;General Public License 2.0 or later if, at the time Intel provides the &n;Software to Recipient, such addition of the Software to the then publicly &n;available versions of such operating systems available under the GNU General &n;Public License 2.0 or later (whether in gold, beta or alpha form) causes &n;such combination to be covered by the Licensed Patents. The patent license &n;shall not apply to any other combinations which include the Software. NO &n;hardware per se is licensed hereunder.&n;&n;THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; &n;AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE &n;IMPLIED WARRANTIES OF MECHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE &n;ARE DISCLAIMED. IN NO EVENT SHALL INTEL OR IT CONTRIBUTORS BE LIABLE FOR ANY &n;DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES &n;(INCLUDING, BUT NOT LIMITED, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; &n;ANY LOSS OF USE; DATA, OR PROFITS; OR BUSINESS INTERUPTION) HOWEVER CAUSED &n;AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY OR &n;TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE &n;OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n;*******************************************************************************/
macro_line|#include &quot;e100.h&quot;
macro_line|#include &quot;e100_config.h&quot;
macro_line|#ifdef ETHTOOL_TEST
r_extern
id|u16
id|e100_eeprom_read
c_func
(paren
r_struct
id|e100_private
op_star
comma
id|u16
)paren
suffix:semicolon
r_extern
r_int
id|e100_wait_exec_cmplx
c_func
(paren
r_struct
id|e100_private
op_star
comma
id|u32
comma
id|u8
)paren
suffix:semicolon
r_extern
r_void
id|e100_phy_reset
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_selftest
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_eeprom
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_loopback
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_one_loopback
(paren
r_struct
id|net_device
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_rcv_loopback_pkt
c_func
(paren
r_struct
id|e100_private
op_star
)paren
suffix:semicolon
r_static
r_void
id|e100_diag_config_loopback
c_func
(paren
r_struct
id|e100_private
op_star
comma
id|u8
comma
id|u8
comma
id|u8
op_star
comma
id|u8
op_star
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_loopback_alloc
c_func
(paren
r_struct
id|e100_private
op_star
)paren
suffix:semicolon
r_static
r_void
id|e100_diag_loopback_cu_ru_exec
c_func
(paren
r_struct
id|e100_private
op_star
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_check_pkt
c_func
(paren
id|u8
op_star
)paren
suffix:semicolon
r_static
r_void
id|e100_diag_loopback_free
c_func
(paren
r_struct
id|e100_private
op_star
)paren
suffix:semicolon
DECL|macro|LB_PACKET_SIZE
mdefine_line|#define LB_PACKET_SIZE 1500
multiline_comment|/**&n; * e100_run_diag - main test execution handler - checks mask of requests and calls the diag routines  &n; * @dev: atapter&squot;s net device data struct&n; * @test_info: array with test request mask also used to store test results&n; *&n; * RETURNS: updated flags field of struct ethtool_test&n; */
id|u32
DECL|function|e100_run_diag
id|e100_run_diag
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u64
op_star
id|test_info
comma
id|u32
id|flags
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u8
id|test_result
op_assign
l_bool|true
suffix:semicolon
id|e100_isolate_driver
c_func
(paren
id|bdp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|ETH_TEST_FL_OFFLINE
)paren
(brace
id|u8
id|fail_mask
suffix:semicolon
id|fail_mask
op_assign
id|e100_diag_selftest
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fail_mask
)paren
(brace
id|test_result
op_assign
l_bool|false
suffix:semicolon
r_if
c_cond
(paren
id|fail_mask
op_amp
id|REGISTER_TEST_FAIL
)paren
id|test_info
(braket
id|E100_REG_TEST_FAIL
)braket
op_assign
l_bool|true
suffix:semicolon
r_if
c_cond
(paren
id|fail_mask
op_amp
id|ROM_TEST_FAIL
)paren
id|test_info
(braket
id|E100_ROM_TEST_FAIL
)braket
op_assign
l_bool|true
suffix:semicolon
r_if
c_cond
(paren
id|fail_mask
op_amp
id|SELF_TEST_FAIL
)paren
id|test_info
(braket
id|E100_MAC_TEST_FAIL
)braket
op_assign
l_bool|true
suffix:semicolon
r_if
c_cond
(paren
id|fail_mask
op_amp
id|TEST_TIMEOUT
)paren
id|test_info
(braket
id|E100_CHIP_TIMEOUT
)braket
op_assign
l_bool|true
suffix:semicolon
)brace
id|fail_mask
op_assign
id|e100_diag_loopback
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fail_mask
)paren
(brace
id|test_result
op_assign
l_bool|false
suffix:semicolon
r_if
c_cond
(paren
id|fail_mask
op_amp
id|PHY_LOOPBACK
)paren
id|test_info
(braket
id|E100_LPBK_PHY_FAIL
)braket
op_assign
l_bool|true
suffix:semicolon
r_if
c_cond
(paren
id|fail_mask
op_amp
id|MAC_LOOPBACK
)paren
id|test_info
(braket
id|E100_LPBK_MAC_FAIL
)braket
op_assign
l_bool|true
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|e100_diag_eeprom
c_func
(paren
id|dev
)paren
)paren
(brace
id|test_result
op_assign
l_bool|false
suffix:semicolon
id|test_info
(braket
id|E100_EEPROM_TEST_FAIL
)braket
op_assign
l_bool|true
suffix:semicolon
)brace
multiline_comment|/* fully recover only if the device is open*/
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|e100_deisolate_driver
c_func
(paren
id|bdp
comma
l_bool|true
comma
l_bool|false
)paren
suffix:semicolon
)brace
r_else
(brace
id|e100_deisolate_driver
c_func
(paren
id|bdp
comma
l_bool|false
comma
l_bool|false
)paren
suffix:semicolon
)brace
multiline_comment|/*Let card recover from the test*/
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_star
l_int|2
)paren
suffix:semicolon
r_return
id|flags
op_or
(paren
id|test_result
ques
c_cond
l_int|0
suffix:colon
id|ETH_TEST_FL_FAILED
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_selftest - run hardware selftest &n; * @dev: atapter&squot;s net device data struct&n; */
r_static
id|u8
DECL|function|e100_diag_selftest
id|e100_diag_selftest
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|st_timeout
comma
id|st_result
suffix:semicolon
id|u8
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e100_selftest
c_func
(paren
id|bdp
comma
op_amp
id|st_timeout
comma
op_amp
id|st_result
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|st_timeout
)paren
(brace
r_if
c_cond
(paren
id|st_result
op_amp
id|CB_SELFTEST_REGISTER_BIT
)paren
id|retval
op_or_assign
id|REGISTER_TEST_FAIL
suffix:semicolon
r_if
c_cond
(paren
id|st_result
op_amp
id|CB_SELFTEST_DIAG_BIT
)paren
id|retval
op_or_assign
id|SELF_TEST_FAIL
suffix:semicolon
r_if
c_cond
(paren
id|st_result
op_amp
id|CB_SELFTEST_ROM_BIT
)paren
id|retval
op_or_assign
id|ROM_TEST_FAIL
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
id|TEST_TIMEOUT
suffix:semicolon
)brace
)brace
id|e100_hw_reset_recover
c_func
(paren
id|bdp
comma
id|PORT_SOFTWARE_RESET
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_eeprom - validate eeprom checksum correctness&n; * @dev: atapter&squot;s net device data struct&n; *&n; */
r_static
id|u8
DECL|function|e100_diag_eeprom
id|e100_diag_eeprom
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u16
id|i
comma
id|eeprom_sum
comma
id|eeprom_actual_csm
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|eeprom_sum
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|bdp-&gt;eeprom_size
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|eeprom_sum
op_add_assign
id|e100_eeprom_read
c_func
(paren
id|bdp
comma
id|i
)paren
suffix:semicolon
)brace
id|eeprom_actual_csm
op_assign
id|e100_eeprom_read
c_func
(paren
id|bdp
comma
id|bdp-&gt;eeprom_size
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eeprom_actual_csm
op_eq
(paren
id|u16
)paren
(paren
id|EEPROM_SUM
op_minus
id|eeprom_sum
)paren
)paren
(brace
r_return
l_bool|true
suffix:semicolon
)brace
r_return
l_bool|false
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_loopback - performs loopback test  &n; * @dev: atapter&squot;s net device data struct&n; */
r_static
id|u8
DECL|function|e100_diag_loopback
id|e100_diag_loopback
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|u8
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e100_diag_one_loopback
c_func
(paren
id|dev
comma
id|PHY_LOOPBACK
)paren
)paren
(brace
id|rc
op_or_assign
id|PHY_LOOPBACK
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|e100_diag_one_loopback
c_func
(paren
id|dev
comma
id|MAC_LOOPBACK
)paren
)paren
(brace
id|rc
op_or_assign
id|MAC_LOOPBACK
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_loopback - performs loopback test  &n; * @dev: atapter&squot;s net device data struct&n; * @mode: lopback test type&n; */
r_static
id|u8
DECL|function|e100_diag_one_loopback
id|e100_diag_one_loopback
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
id|mode
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u8
id|res
op_assign
l_bool|false
suffix:semicolon
id|u8
id|saved_dynamic_tbd
op_assign
l_bool|false
suffix:semicolon
id|u8
id|saved_extended_tcb
op_assign
l_bool|false
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e100_diag_loopback_alloc
c_func
(paren
id|bdp
)paren
)paren
r_return
l_bool|false
suffix:semicolon
multiline_comment|/* change the config block to standard tcb and the correct loopback */
id|e100_diag_config_loopback
c_func
(paren
id|bdp
comma
l_bool|true
comma
id|mode
comma
op_amp
id|saved_extended_tcb
comma
op_amp
id|saved_dynamic_tbd
)paren
suffix:semicolon
id|e100_diag_loopback_cu_ru_exec
c_func
(paren
id|bdp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e100_diag_rcv_loopback_pkt
c_func
(paren
id|bdp
)paren
)paren
(brace
id|res
op_assign
l_bool|true
suffix:semicolon
)brace
id|e100_diag_loopback_free
c_func
(paren
id|bdp
)paren
suffix:semicolon
multiline_comment|/* change the config block to previous tcb mode and the no loopback */
id|e100_diag_config_loopback
c_func
(paren
id|bdp
comma
l_bool|false
comma
id|mode
comma
op_amp
id|saved_extended_tcb
comma
op_amp
id|saved_dynamic_tbd
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_config_loopback - setup/clear loopback before/after lpbk test&n; * @bdp: atapter&squot;s private data struct&n; * @set_loopback: true if the function is called to set lb&n; * @loopback_mode: the loopback mode(MAC or PHY)&n; * @tcb_extended: true if need to set extended tcb mode after clean loopback&n; * @dynamic_tbd: true if needed to set dynamic tbd mode after clean loopback&n; *&n; */
r_void
DECL|function|e100_diag_config_loopback
id|e100_diag_config_loopback
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
comma
id|u8
id|set_loopback
comma
id|u8
id|loopback_mode
comma
id|u8
op_star
id|tcb_extended
comma
id|u8
op_star
id|dynamic_tbd
)paren
(brace
multiline_comment|/* if set_loopback == true - we want to clear tcb_extended/dynamic_tbd.&n;&t; * the previous values are saved in the params tcb_extended/dynamic_tbd&n;&t; * if set_loopback == false - we want to restore previous value.&n;&t; */
r_if
c_cond
(paren
id|set_loopback
op_logical_or
(paren
op_star
id|tcb_extended
)paren
)paren
op_star
id|tcb_extended
op_assign
id|e100_config_tcb_ext_enable
c_func
(paren
id|bdp
comma
op_star
id|tcb_extended
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set_loopback
op_logical_or
(paren
op_star
id|dynamic_tbd
)paren
)paren
op_star
id|dynamic_tbd
op_assign
id|e100_config_dynamic_tbd
c_func
(paren
id|bdp
comma
op_star
id|dynamic_tbd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set_loopback
)paren
(brace
id|e100_config_loopback_mode
c_func
(paren
id|bdp
comma
id|loopback_mode
)paren
suffix:semicolon
)brace
r_else
(brace
id|e100_config_loopback_mode
c_func
(paren
id|bdp
comma
id|NO_LOOPBACK
)paren
suffix:semicolon
)brace
id|e100_config
c_func
(paren
id|bdp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loopback_mode
op_eq
id|PHY_LOOPBACK
)paren
(brace
r_int
r_int
id|expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|set_loopback
)paren
id|e100_phy_reset
c_func
(paren
id|bdp
)paren
suffix:semicolon
multiline_comment|/* wait up to 5 secs for PHY loopback ON/OFF to take effect */
r_while
c_loop
(paren
(paren
id|e100_get_link_state
c_func
(paren
id|bdp
)paren
op_ne
id|set_loopback
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|expires
)paren
)paren
(brace
id|yield
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* For MAC loopback wait 500 msec to take effect */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * e100_diag_loopback_alloc - alloc &amp; initate tcb and rfd for the loopback&n; * @bdp: atapter&squot;s private data struct&n; *&n; */
r_static
id|u8
DECL|function|e100_diag_loopback_alloc
id|e100_diag_loopback_alloc
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
(brace
id|dma_addr_t
id|dma_handle
suffix:semicolon
id|tcb_t
op_star
id|tcb
suffix:semicolon
id|rfd_t
op_star
id|rfd
suffix:semicolon
id|tbd_t
op_star
id|tbd
suffix:semicolon
id|tcb
op_assign
id|pci_alloc_consistent
c_func
(paren
id|bdp-&gt;pdev
comma
(paren
r_sizeof
(paren
id|tcb_t
)paren
op_plus
r_sizeof
(paren
id|tbd_t
)paren
op_plus
id|LB_PACKET_SIZE
)paren
comma
op_amp
id|dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcb
op_eq
l_int|NULL
)paren
r_return
l_bool|false
suffix:semicolon
id|memset
c_func
(paren
id|tcb
comma
l_int|0x00
comma
r_sizeof
(paren
id|tcb_t
)paren
op_plus
id|LB_PACKET_SIZE
)paren
suffix:semicolon
id|tcb-&gt;tcb_phys
op_assign
id|dma_handle
suffix:semicolon
id|tcb-&gt;tcb_hdr.cb_status
op_assign
l_int|0
suffix:semicolon
id|tcb-&gt;tcb_hdr.cb_cmd
op_assign
id|cpu_to_le16
c_func
(paren
id|CB_EL_BIT
op_or
id|CB_TRANSMIT
op_or
id|CB_TX_SF_BIT
)paren
suffix:semicolon
id|tcb-&gt;tcb_hdr.cb_lnk_ptr
op_assign
id|cpu_to_le32
c_func
(paren
id|tcb-&gt;tcb_phys
)paren
suffix:semicolon
id|tcb-&gt;tcb_tbd_ptr
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
id|tcb-&gt;tcb_cnt
op_assign
l_int|0
suffix:semicolon
id|tcb-&gt;tcb_thrshld
op_assign
id|bdp-&gt;tx_thld
suffix:semicolon
id|tcb-&gt;tcb_tbd_num
op_assign
l_int|1
suffix:semicolon
id|tcb-&gt;tcb_tbd_ptr
op_assign
id|cpu_to_le32
c_func
(paren
id|tcb-&gt;tcb_phys
op_plus
r_sizeof
(paren
id|tcb_t
)paren
)paren
suffix:semicolon
id|tbd
op_assign
(paren
id|tbd_t
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|tcb
op_plus
r_sizeof
(paren
id|tcb_t
)paren
)paren
suffix:semicolon
id|tbd-&gt;tbd_buf_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|tcb-&gt;tcb_tbd_ptr
)paren
op_plus
r_sizeof
(paren
id|tbd_t
)paren
)paren
suffix:semicolon
id|tbd-&gt;tbd_buf_cnt
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|1024
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|tbd
op_plus
r_sizeof
(paren
id|tbd_t
)paren
)paren
comma
l_int|0xFF
comma
l_int|1024
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|tbd
op_plus
r_sizeof
(paren
id|tbd_t
)paren
op_plus
l_int|512
)paren
comma
l_int|0xBA
comma
l_int|512
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|rfd
op_assign
id|pci_alloc_consistent
c_func
(paren
id|bdp-&gt;pdev
comma
r_sizeof
(paren
id|rfd_t
)paren
comma
op_amp
id|dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rfd
op_eq
l_int|NULL
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|bdp-&gt;pdev
comma
r_sizeof
(paren
id|tcb_t
)paren
op_plus
r_sizeof
(paren
id|tbd_t
)paren
op_plus
id|LB_PACKET_SIZE
comma
id|tcb
comma
id|tcb-&gt;tcb_phys
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
id|memset
c_func
(paren
id|rfd
comma
l_int|0x00
comma
r_sizeof
(paren
id|rfd_t
)paren
)paren
suffix:semicolon
multiline_comment|/* init all fields in rfd */
id|rfd-&gt;rfd_header.cb_status
op_assign
l_int|0
suffix:semicolon
id|rfd-&gt;rfd_header.cb_cmd
op_assign
id|cpu_to_le16
c_func
(paren
id|RFD_EL_BIT
)paren
suffix:semicolon
id|rfd-&gt;rfd_act_cnt
op_assign
l_int|0
suffix:semicolon
id|rfd-&gt;rfd_sz
op_assign
id|cpu_to_le16
c_func
(paren
id|ETH_FRAME_LEN
op_plus
id|CHKSUM_SIZE
)paren
suffix:semicolon
id|bdp-&gt;loopback.dma_handle
op_assign
id|dma_handle
suffix:semicolon
id|bdp-&gt;loopback.tcb
op_assign
id|tcb
suffix:semicolon
id|bdp-&gt;loopback.rfd
op_assign
id|rfd
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_loopback_cu_ru_exec - activates cu and ru to send &amp; receive the pkt&n; * @bdp: atapter&squot;s private data struct&n; *&n; */
r_static
r_void
DECL|function|e100_diag_loopback_cu_ru_exec
id|e100_diag_loopback_cu_ru_exec
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
(brace
multiline_comment|/*load CU &amp; RU base */
r_if
c_cond
(paren
op_logical_neg
id|e100_wait_exec_cmplx
c_func
(paren
id|bdp
comma
l_int|0
comma
id|SCB_CUC_LOAD_BASE
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;@@@ SCB_CUC_LOAD_BASE failed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e100_wait_exec_cmplx
c_func
(paren
id|bdp
comma
l_int|0
comma
id|SCB_RUC_LOAD_BASE
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;@@@ SCB_RUC_LOAD_BASE failed!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|e100_wait_exec_cmplx
c_func
(paren
id|bdp
comma
id|bdp-&gt;loopback.dma_handle
comma
id|SCB_RUC_START
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;@@@ SCB_RUC_START failed!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|bdp-&gt;next_cu_cmd
op_assign
id|START_WAIT
suffix:semicolon
id|e100_start_cu
c_func
(paren
id|bdp
comma
id|bdp-&gt;loopback.tcb
)paren
suffix:semicolon
id|bdp-&gt;last_tcb
op_assign
l_int|NULL
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_check_pkt - checks if a given packet is a loopback packet&n; * @bdp: atapter&squot;s private data struct&n; *&n; * Returns true if OK false otherwise.&n; */
r_static
id|u8
DECL|function|e100_diag_check_pkt
id|e100_diag_check_pkt
c_func
(paren
id|u8
op_star
id|datap
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|datap
)paren
op_eq
l_int|0xFF
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
id|datap
op_plus
l_int|600
)paren
op_eq
l_int|0xBA
)paren
(brace
r_return
l_bool|true
suffix:semicolon
)brace
)brace
r_return
l_bool|false
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_rcv_loopback_pkt - waits for receive and checks lpbk packet&n; * @bdp: atapter&squot;s private data struct&n; *&n; * Returns true if OK false otherwise.&n; */
r_static
id|u8
DECL|function|e100_diag_rcv_loopback_pkt
id|e100_diag_rcv_loopback_pkt
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
(brace
id|rfd_t
op_star
id|rfdp
suffix:semicolon
id|u16
id|rfd_status
suffix:semicolon
r_int
r_int
id|expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|2
suffix:semicolon
id|rfdp
op_assign
id|bdp-&gt;loopback.rfd
suffix:semicolon
id|rfd_status
op_assign
id|le16_to_cpu
c_func
(paren
id|rfdp-&gt;rfd_header.cb_status
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|rfd_status
op_amp
id|RFD_STATUS_COMPLETE
)paren
)paren
(brace
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|expires
)paren
)paren
(brace
id|yield
c_func
(paren
)paren
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|rfd_status
op_assign
id|le16_to_cpu
c_func
(paren
id|rfdp-&gt;rfd_header.cb_status
)paren
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rfd_status
op_amp
id|RFD_STATUS_COMPLETE
)paren
r_return
id|e100_diag_check_pkt
c_func
(paren
(paren
(paren
id|u8
op_star
)paren
id|rfdp
op_plus
id|bdp-&gt;rfd_size
)paren
)paren
suffix:semicolon
r_else
r_return
l_bool|false
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_loopback_free - free data allocated for loopback pkt send/receive&n; * @bdp: atapter&squot;s private data struct&n; *&n; */
r_static
r_void
DECL|function|e100_diag_loopback_free
id|e100_diag_loopback_free
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|bdp-&gt;pdev
comma
r_sizeof
(paren
id|tcb_t
)paren
op_plus
r_sizeof
(paren
id|tbd_t
)paren
op_plus
id|LB_PACKET_SIZE
comma
id|bdp-&gt;loopback.tcb
comma
id|bdp-&gt;loopback.tcb-&gt;tcb_phys
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|bdp-&gt;pdev
comma
r_sizeof
(paren
id|rfd_t
)paren
comma
id|bdp-&gt;loopback.rfd
comma
id|bdp-&gt;loopback.dma_handle
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
