multiline_comment|/*******************************************************************************&n;&n;  &n;  Copyright(c) 1999 - 2003 Intel Corporation. All rights reserved.&n;  &n;  This program is free software; you can redistribute it and/or modify it &n;  under the terms of the GNU General Public License as published by the Free &n;  Software Foundation; either version 2 of the License, or (at your option) &n;  any later version.&n;  &n;  This program is distributed in the hope that it will be useful, but WITHOUT &n;  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or &n;  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for &n;  more details.&n;  &n;  You should have received a copy of the GNU General Public License along with&n;  this program; if not, write to the Free Software Foundation, Inc., 59 &n;  Temple Place - Suite 330, Boston, MA  02111-1307, USA.&n;  &n;  The full GNU General Public License is included in this distribution in the&n;  file called LICENSE.&n;  &n;  Contact Information:&n;  Linux NICS &lt;linux.nics@intel.com&gt;&n;  Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497&n;*******************************************************************************/
macro_line|#include &quot;e100_phy.h&quot;
macro_line|#include &quot;e100_config.h&quot;
r_extern
id|u16
id|e100_eeprom_read
c_func
(paren
r_struct
id|e100_private
op_star
comma
id|u16
)paren
suffix:semicolon
r_extern
r_int
id|e100_wait_exec_cmplx
c_func
(paren
r_struct
id|e100_private
op_star
comma
id|u32
comma
id|u8
comma
id|u8
)paren
suffix:semicolon
r_extern
r_void
id|e100_phy_reset
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
suffix:semicolon
r_extern
r_void
id|e100_phy_autoneg
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
suffix:semicolon
r_extern
r_void
id|e100_phy_set_loopback
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
suffix:semicolon
r_extern
r_void
id|e100_force_speed_duplex
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_selftest
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_eeprom
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_loopback
c_func
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_one_loopback
(paren
r_struct
id|net_device
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_rcv_loopback_pkt
c_func
(paren
r_struct
id|e100_private
op_star
)paren
suffix:semicolon
r_static
r_void
id|e100_diag_config_loopback
c_func
(paren
r_struct
id|e100_private
op_star
comma
id|u8
comma
id|u8
comma
id|u8
op_star
comma
id|u8
op_star
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_loopback_alloc
c_func
(paren
r_struct
id|e100_private
op_star
)paren
suffix:semicolon
r_static
r_void
id|e100_diag_loopback_cu_ru_exec
c_func
(paren
r_struct
id|e100_private
op_star
)paren
suffix:semicolon
r_static
id|u8
id|e100_diag_check_pkt
c_func
(paren
id|u8
op_star
)paren
suffix:semicolon
r_static
r_void
id|e100_diag_loopback_free
c_func
(paren
r_struct
id|e100_private
op_star
)paren
suffix:semicolon
r_static
r_int
id|e100_cable_diag
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
suffix:semicolon
DECL|macro|LB_PACKET_SIZE
mdefine_line|#define LB_PACKET_SIZE 1500
multiline_comment|/**&n; * e100_run_diag - main test execution handler - checks mask of requests and calls the diag routines  &n; * @dev: atapter&squot;s net device data struct&n; * @test_info: array with test request mask also used to store test results&n; *&n; * RETURNS: updated flags field of struct ethtool_test&n; */
id|u32
DECL|function|e100_run_diag
id|e100_run_diag
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u64
op_star
id|test_info
comma
id|u32
id|flags
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u8
id|test_result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e100_get_link_state
c_func
(paren
id|bdp
)paren
)paren
(brace
id|test_result
op_assign
id|ETH_TEST_FL_FAILED
suffix:semicolon
id|test_info
(braket
id|test_link
)braket
op_assign
l_bool|true
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|e100_diag_eeprom
c_func
(paren
id|dev
)paren
)paren
(brace
id|test_result
op_assign
id|ETH_TEST_FL_FAILED
suffix:semicolon
id|test_info
(braket
id|test_eeprom
)braket
op_assign
l_bool|true
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|ETH_TEST_FL_OFFLINE
)paren
(brace
id|u8
id|fail_mask
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|spin_lock_bh
c_func
(paren
op_amp
id|dev-&gt;xmit_lock
)paren
suffix:semicolon
id|e100_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|dev-&gt;xmit_lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|e100_diag_selftest
c_func
(paren
id|dev
)paren
)paren
(brace
id|test_result
op_assign
id|ETH_TEST_FL_FAILED
suffix:semicolon
id|test_info
(braket
id|test_self_test
)braket
op_assign
l_bool|true
suffix:semicolon
)brace
id|fail_mask
op_assign
id|e100_diag_loopback
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fail_mask
)paren
(brace
id|test_result
op_assign
id|ETH_TEST_FL_FAILED
suffix:semicolon
r_if
c_cond
(paren
id|fail_mask
op_amp
id|PHY_LOOPBACK
)paren
id|test_info
(braket
id|test_loopback_phy
)braket
op_assign
l_bool|true
suffix:semicolon
r_if
c_cond
(paren
id|fail_mask
op_amp
id|MAC_LOOPBACK
)paren
id|test_info
(braket
id|test_loopback_mac
)braket
op_assign
l_bool|true
suffix:semicolon
)brace
id|test_info
(braket
id|cable_diag
)braket
op_assign
id|e100_cable_diag
c_func
(paren
id|bdp
)paren
suffix:semicolon
multiline_comment|/* Need hw init regardless of netif_running */
id|e100_hw_init
c_func
(paren
id|bdp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|e100_open
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|test_info
(braket
id|test_self_test
)braket
op_assign
l_bool|false
suffix:semicolon
id|test_info
(braket
id|test_loopback_phy
)braket
op_assign
l_bool|false
suffix:semicolon
id|test_info
(braket
id|test_loopback_mac
)braket
op_assign
l_bool|false
suffix:semicolon
id|test_info
(braket
id|cable_diag
)braket
op_assign
l_bool|false
suffix:semicolon
)brace
r_return
id|flags
op_or
id|test_result
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_selftest - run hardware selftest &n; * @dev: atapter&squot;s net device data struct&n; */
r_static
id|u8
DECL|function|e100_diag_selftest
id|e100_diag_selftest
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|st_timeout
comma
id|st_result
suffix:semicolon
id|u8
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e100_selftest
c_func
(paren
id|bdp
comma
op_amp
id|st_timeout
comma
op_amp
id|st_result
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|st_timeout
)paren
(brace
r_if
c_cond
(paren
id|st_result
op_amp
id|CB_SELFTEST_REGISTER_BIT
)paren
id|retval
op_or_assign
id|REGISTER_TEST_FAIL
suffix:semicolon
r_if
c_cond
(paren
id|st_result
op_amp
id|CB_SELFTEST_DIAG_BIT
)paren
id|retval
op_or_assign
id|SELF_TEST_FAIL
suffix:semicolon
r_if
c_cond
(paren
id|st_result
op_amp
id|CB_SELFTEST_ROM_BIT
)paren
id|retval
op_or_assign
id|ROM_TEST_FAIL
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
id|TEST_TIMEOUT
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_eeprom - validate eeprom checksum correctness&n; * @dev: atapter&squot;s net device data struct&n; *&n; */
r_static
id|u8
DECL|function|e100_diag_eeprom
id|e100_diag_eeprom
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u16
id|i
comma
id|eeprom_sum
comma
id|eeprom_actual_csm
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|eeprom_sum
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|bdp-&gt;eeprom_size
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|eeprom_sum
op_add_assign
id|e100_eeprom_read
c_func
(paren
id|bdp
comma
id|i
)paren
suffix:semicolon
)brace
id|eeprom_actual_csm
op_assign
id|e100_eeprom_read
c_func
(paren
id|bdp
comma
id|bdp-&gt;eeprom_size
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eeprom_actual_csm
op_eq
(paren
id|u16
)paren
(paren
id|EEPROM_SUM
op_minus
id|eeprom_sum
)paren
)paren
(brace
r_return
l_bool|true
suffix:semicolon
)brace
r_return
l_bool|false
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_loopback - performs loopback test  &n; * @dev: atapter&squot;s net device data struct&n; */
r_static
id|u8
DECL|function|e100_diag_loopback
id|e100_diag_loopback
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|u8
id|rc
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: PHY loopback test starts&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|e100_hw_init
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e100_diag_one_loopback
c_func
(paren
id|dev
comma
id|PHY_LOOPBACK
)paren
)paren
(brace
id|rc
op_or_assign
id|PHY_LOOPBACK
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: PHY loopback test ends&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: MAC loopback test starts&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|e100_hw_init
c_func
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e100_diag_one_loopback
c_func
(paren
id|dev
comma
id|MAC_LOOPBACK
)paren
)paren
(brace
id|rc
op_or_assign
id|MAC_LOOPBACK
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: MAC loopback test ends&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_loopback - performs loopback test  &n; * @dev: atapter&squot;s net device data struct&n; * @mode: lopback test type&n; */
r_static
id|u8
DECL|function|e100_diag_one_loopback
id|e100_diag_one_loopback
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
id|mode
)paren
(brace
r_struct
id|e100_private
op_star
id|bdp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u8
id|res
op_assign
l_bool|false
suffix:semicolon
id|u8
id|saved_dynamic_tbd
op_assign
l_bool|false
suffix:semicolon
id|u8
id|saved_extended_tcb
op_assign
l_bool|false
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e100_diag_loopback_alloc
c_func
(paren
id|bdp
)paren
)paren
r_return
l_bool|false
suffix:semicolon
multiline_comment|/* change the config block to standard tcb and the correct loopback */
id|e100_diag_config_loopback
c_func
(paren
id|bdp
comma
l_bool|true
comma
id|mode
comma
op_amp
id|saved_extended_tcb
comma
op_amp
id|saved_dynamic_tbd
)paren
suffix:semicolon
id|e100_diag_loopback_cu_ru_exec
c_func
(paren
id|bdp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e100_diag_rcv_loopback_pkt
c_func
(paren
id|bdp
)paren
)paren
(brace
id|res
op_assign
l_bool|true
suffix:semicolon
)brace
id|e100_diag_loopback_free
c_func
(paren
id|bdp
)paren
suffix:semicolon
multiline_comment|/* change the config block to previous tcb mode and the no loopback */
id|e100_diag_config_loopback
c_func
(paren
id|bdp
comma
l_bool|false
comma
id|mode
comma
op_amp
id|saved_extended_tcb
comma
op_amp
id|saved_dynamic_tbd
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_config_loopback - setup/clear loopback before/after lpbk test&n; * @bdp: atapter&squot;s private data struct&n; * @set_loopback: true if the function is called to set lb&n; * @loopback_mode: the loopback mode(MAC or PHY)&n; * @tcb_extended: true if need to set extended tcb mode after clean loopback&n; * @dynamic_tbd: true if needed to set dynamic tbd mode after clean loopback&n; *&n; */
r_void
DECL|function|e100_diag_config_loopback
id|e100_diag_config_loopback
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
comma
id|u8
id|set_loopback
comma
id|u8
id|loopback_mode
comma
id|u8
op_star
id|tcb_extended
comma
id|u8
op_star
id|dynamic_tbd
)paren
(brace
multiline_comment|/* if set_loopback == true - we want to clear tcb_extended/dynamic_tbd.&n;&t; * the previous values are saved in the params tcb_extended/dynamic_tbd&n;&t; * if set_loopback == false - we want to restore previous value.&n;&t; */
r_if
c_cond
(paren
id|set_loopback
op_logical_or
(paren
op_star
id|tcb_extended
)paren
)paren
op_star
id|tcb_extended
op_assign
id|e100_config_tcb_ext_enable
c_func
(paren
id|bdp
comma
op_star
id|tcb_extended
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set_loopback
op_logical_or
(paren
op_star
id|dynamic_tbd
)paren
)paren
op_star
id|dynamic_tbd
op_assign
id|e100_config_dynamic_tbd
c_func
(paren
id|bdp
comma
op_star
id|dynamic_tbd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set_loopback
)paren
(brace
multiline_comment|/* ICH PHY loopback is broken */
r_if
c_cond
(paren
id|bdp-&gt;flags
op_amp
id|IS_ICH
op_logical_and
id|loopback_mode
op_eq
id|PHY_LOOPBACK
)paren
id|loopback_mode
op_assign
id|MAC_LOOPBACK
suffix:semicolon
multiline_comment|/* Configure loopback on MAC */
id|e100_config_loopback_mode
c_func
(paren
id|bdp
comma
id|loopback_mode
)paren
suffix:semicolon
)brace
r_else
(brace
id|e100_config_loopback_mode
c_func
(paren
id|bdp
comma
id|NO_LOOPBACK
)paren
suffix:semicolon
)brace
id|e100_config
c_func
(paren
id|bdp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loopback_mode
op_eq
id|PHY_LOOPBACK
)paren
(brace
r_if
c_cond
(paren
id|set_loopback
)paren
multiline_comment|/* Set PHY loopback mode */
id|e100_phy_set_loopback
c_func
(paren
id|bdp
)paren
suffix:semicolon
r_else
multiline_comment|/* Reset PHY loopback mode */
id|e100_phy_reset
c_func
(paren
id|bdp
)paren
suffix:semicolon
multiline_comment|/* Wait for PHY state change */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* For MAC loopback wait 500 msec to take effect */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * e100_diag_loopback_alloc - alloc &amp; initate tcb and rfd for the loopback&n; * @bdp: atapter&squot;s private data struct&n; *&n; */
r_static
id|u8
DECL|function|e100_diag_loopback_alloc
id|e100_diag_loopback_alloc
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
(brace
id|dma_addr_t
id|dma_handle
suffix:semicolon
id|tcb_t
op_star
id|tcb
suffix:semicolon
id|rfd_t
op_star
id|rfd
suffix:semicolon
id|tbd_t
op_star
id|tbd
suffix:semicolon
multiline_comment|/* tcb, tbd and transmit buffer are allocated */
id|tcb
op_assign
id|pci_alloc_consistent
c_func
(paren
id|bdp-&gt;pdev
comma
(paren
r_sizeof
(paren
id|tcb_t
)paren
op_plus
r_sizeof
(paren
id|tbd_t
)paren
op_plus
id|LB_PACKET_SIZE
)paren
comma
op_amp
id|dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcb
op_eq
l_int|NULL
)paren
r_return
l_bool|false
suffix:semicolon
id|memset
c_func
(paren
id|tcb
comma
l_int|0x00
comma
r_sizeof
(paren
id|tcb_t
)paren
op_plus
r_sizeof
(paren
id|tbd_t
)paren
op_plus
id|LB_PACKET_SIZE
)paren
suffix:semicolon
id|tcb-&gt;tcb_phys
op_assign
id|dma_handle
suffix:semicolon
id|tcb-&gt;tcb_hdr.cb_status
op_assign
l_int|0
suffix:semicolon
id|tcb-&gt;tcb_hdr.cb_cmd
op_assign
id|cpu_to_le16
c_func
(paren
id|CB_EL_BIT
op_or
id|CB_TRANSMIT
op_or
id|CB_TX_SF_BIT
)paren
suffix:semicolon
multiline_comment|/* Next command is null */
id|tcb-&gt;tcb_hdr.cb_lnk_ptr
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
id|tcb-&gt;tcb_cnt
op_assign
l_int|0
suffix:semicolon
id|tcb-&gt;tcb_thrshld
op_assign
id|bdp-&gt;tx_thld
suffix:semicolon
id|tcb-&gt;tcb_tbd_num
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Set up tcb tbd pointer */
id|tcb-&gt;tcb_tbd_ptr
op_assign
id|cpu_to_le32
c_func
(paren
id|tcb-&gt;tcb_phys
op_plus
r_sizeof
(paren
id|tcb_t
)paren
)paren
suffix:semicolon
id|tbd
op_assign
(paren
id|tbd_t
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|tcb
op_plus
r_sizeof
(paren
id|tcb_t
)paren
)paren
suffix:semicolon
multiline_comment|/* Set up tbd transmit buffer */
id|tbd-&gt;tbd_buf_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|tcb-&gt;tcb_tbd_ptr
)paren
op_plus
r_sizeof
(paren
id|tbd_t
)paren
)paren
suffix:semicolon
id|tbd-&gt;tbd_buf_cnt
op_assign
id|__constant_cpu_to_le16
c_func
(paren
l_int|1024
)paren
suffix:semicolon
multiline_comment|/* The value of first 512 bytes is FF */
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|tbd
op_plus
r_sizeof
(paren
id|tbd_t
)paren
)paren
comma
l_int|0xFF
comma
l_int|512
)paren
suffix:semicolon
multiline_comment|/* The value of second 512 bytes is BA */
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|tbd
op_plus
r_sizeof
(paren
id|tbd_t
)paren
op_plus
l_int|512
)paren
comma
l_int|0xBA
comma
l_int|512
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|rfd
op_assign
id|pci_alloc_consistent
c_func
(paren
id|bdp-&gt;pdev
comma
r_sizeof
(paren
id|rfd_t
)paren
comma
op_amp
id|dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rfd
op_eq
l_int|NULL
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|bdp-&gt;pdev
comma
r_sizeof
(paren
id|tcb_t
)paren
op_plus
r_sizeof
(paren
id|tbd_t
)paren
op_plus
id|LB_PACKET_SIZE
comma
id|tcb
comma
id|tcb-&gt;tcb_phys
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
id|memset
c_func
(paren
id|rfd
comma
l_int|0x00
comma
r_sizeof
(paren
id|rfd_t
)paren
)paren
suffix:semicolon
multiline_comment|/* init all fields in rfd */
id|rfd-&gt;rfd_header.cb_cmd
op_assign
id|cpu_to_le16
c_func
(paren
id|RFD_EL_BIT
)paren
suffix:semicolon
id|rfd-&gt;rfd_sz
op_assign
id|cpu_to_le16
c_func
(paren
id|ETH_FRAME_LEN
op_plus
id|CHKSUM_SIZE
)paren
suffix:semicolon
multiline_comment|/* dma_handle is physical address of rfd */
id|bdp-&gt;loopback.dma_handle
op_assign
id|dma_handle
suffix:semicolon
id|bdp-&gt;loopback.tcb
op_assign
id|tcb
suffix:semicolon
id|bdp-&gt;loopback.rfd
op_assign
id|rfd
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_loopback_cu_ru_exec - activates cu and ru to send &amp; receive the pkt&n; * @bdp: atapter&squot;s private data struct&n; *&n; */
r_static
r_void
DECL|function|e100_diag_loopback_cu_ru_exec
id|e100_diag_loopback_cu_ru_exec
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
(brace
multiline_comment|/*load CU &amp; RU base */
r_if
c_cond
(paren
op_logical_neg
id|e100_wait_exec_cmplx
c_func
(paren
id|bdp
comma
id|bdp-&gt;loopback.dma_handle
comma
id|SCB_RUC_START
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;e100: SCB_RUC_START failed!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|bdp-&gt;next_cu_cmd
op_assign
id|START_WAIT
suffix:semicolon
id|e100_start_cu
c_func
(paren
id|bdp
comma
id|bdp-&gt;loopback.tcb
)paren
suffix:semicolon
id|bdp-&gt;last_tcb
op_assign
l_int|NULL
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_check_pkt - checks if a given packet is a loopback packet&n; * @bdp: atapter&squot;s private data struct&n; *&n; * Returns true if OK false otherwise.&n; */
r_static
id|u8
DECL|function|e100_diag_check_pkt
id|e100_diag_check_pkt
c_func
(paren
id|u8
op_star
id|datap
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|512
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
op_star
id|datap
)paren
op_eq
l_int|0xFF
op_logical_and
(paren
op_star
(paren
id|datap
op_plus
l_int|512
)paren
op_eq
l_int|0xBA
)paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;e100: check loopback packet failed at: %x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
)brace
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;e100: Check received loopback packet OK&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_bool|true
suffix:semicolon
)brace
multiline_comment|/**&n; * e100_diag_rcv_loopback_pkt - waits for receive and checks lpbk packet&n; * @bdp: atapter&squot;s private data struct&n; *&n; * Returns true if OK false otherwise.&n; */
r_static
id|u8
DECL|function|e100_diag_rcv_loopback_pkt
id|e100_diag_rcv_loopback_pkt
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
(brace
id|rfd_t
op_star
id|rfdp
suffix:semicolon
id|u16
id|rfd_status
suffix:semicolon
r_int
r_int
id|expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|2
suffix:semicolon
id|rfdp
op_assign
id|bdp-&gt;loopback.rfd
suffix:semicolon
id|rfd_status
op_assign
id|le16_to_cpu
c_func
(paren
id|rfdp-&gt;rfd_header.cb_status
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|rfd_status
op_amp
id|RFD_STATUS_COMPLETE
)paren
)paren
(brace
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|expires
)paren
)paren
(brace
id|yield
c_func
(paren
)paren
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
id|rfd_status
op_assign
id|le16_to_cpu
c_func
(paren
id|rfdp-&gt;rfd_header.cb_status
)paren
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rfd_status
op_amp
id|RFD_STATUS_COMPLETE
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;e100: Loopback packet received&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|e100_diag_check_pkt
c_func
(paren
(paren
(paren
id|u8
op_star
)paren
id|rfdp
op_plus
id|bdp-&gt;rfd_size
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;e100: Loopback packet not received&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_bool|false
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * e100_diag_loopback_free - free data allocated for loopback pkt send/receive&n; * @bdp: atapter&squot;s private data struct&n; *&n; */
r_static
r_void
DECL|function|e100_diag_loopback_free
id|e100_diag_loopback_free
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|bdp-&gt;pdev
comma
r_sizeof
(paren
id|tcb_t
)paren
op_plus
r_sizeof
(paren
id|tbd_t
)paren
op_plus
id|LB_PACKET_SIZE
comma
id|bdp-&gt;loopback.tcb
comma
id|bdp-&gt;loopback.tcb-&gt;tcb_phys
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|bdp-&gt;pdev
comma
r_sizeof
(paren
id|rfd_t
)paren
comma
id|bdp-&gt;loopback.rfd
comma
id|bdp-&gt;loopback.dma_handle
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|e100_cable_diag
id|e100_cable_diag
c_func
(paren
r_struct
id|e100_private
op_star
id|bdp
)paren
(brace
r_int
id|saved_open_circut
op_assign
l_int|0xffff
suffix:semicolon
r_int
id|saved_short_circut
op_assign
l_int|0xffff
suffix:semicolon
r_int
id|saved_distance
op_assign
l_int|0xffff
suffix:semicolon
r_int
id|saved_same
op_assign
l_int|0
suffix:semicolon
r_int
id|cable_status
op_assign
id|E100_CABLE_UNKNOWN
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* If we have link, */
r_if
c_cond
(paren
id|e100_get_link_state
c_func
(paren
id|bdp
)paren
)paren
r_return
id|E100_CABLE_OK
suffix:semicolon
r_if
c_cond
(paren
id|bdp-&gt;rev_id
OL
id|D102_REV_ID
)paren
r_return
id|E100_CABLE_UNKNOWN
suffix:semicolon
multiline_comment|/* Disable MDI/MDI-X auto switching */
id|e100_mdi_write
c_func
(paren
id|bdp
comma
id|MII_NCONFIG
comma
id|bdp-&gt;phy_addr
comma
id|MDI_MDIX_RESET_ALL_MASK
)paren
suffix:semicolon
multiline_comment|/* Set to 100 Full as required by cable test */
id|e100_mdi_write
c_func
(paren
id|bdp
comma
id|MII_BMCR
comma
id|bdp-&gt;phy_addr
comma
id|BMCR_SPEED100
op_or
id|BMCR_FULLDPLX
)paren
suffix:semicolon
multiline_comment|/* Test up to 100 times */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u16
id|ctrl_reg
suffix:semicolon
r_int
id|distance
comma
id|open_circut
comma
id|short_circut
comma
id|near_end
suffix:semicolon
multiline_comment|/* Enable and execute cable test */
id|e100_mdi_write
c_func
(paren
id|bdp
comma
id|HWI_CONTROL_REG
comma
id|bdp-&gt;phy_addr
comma
(paren
id|HWI_TEST_ENABLE
op_or
id|HWI_TEST_EXECUTE
)paren
)paren
suffix:semicolon
multiline_comment|/* Wait for cable test finished */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|100
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Read results */
id|e100_mdi_read
c_func
(paren
id|bdp
comma
id|HWI_CONTROL_REG
comma
id|bdp-&gt;phy_addr
comma
op_amp
id|ctrl_reg
)paren
suffix:semicolon
id|distance
op_assign
id|ctrl_reg
op_amp
id|HWI_TEST_DISTANCE
suffix:semicolon
id|open_circut
op_assign
id|ctrl_reg
op_amp
id|HWI_TEST_HIGHZ_PROBLEM
suffix:semicolon
id|short_circut
op_assign
id|ctrl_reg
op_amp
id|HWI_TEST_LOWZ_PROBLEM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|distance
op_eq
id|saved_distance
)paren
op_logical_and
(paren
id|open_circut
op_eq
id|saved_open_circut
)paren
op_logical_and
(paren
id|short_circut
op_eq
id|saved_short_circut
)paren
)paren
id|saved_same
op_increment
suffix:semicolon
r_else
(brace
id|saved_same
op_assign
l_int|0
suffix:semicolon
id|saved_distance
op_assign
id|distance
suffix:semicolon
id|saved_open_circut
op_assign
id|open_circut
suffix:semicolon
id|saved_short_circut
op_assign
id|short_circut
suffix:semicolon
)brace
multiline_comment|/* If results are the same 3 times */
r_if
c_cond
(paren
id|saved_same
op_eq
l_int|3
)paren
(brace
id|near_end
op_assign
(paren
(paren
id|distance
op_star
id|HWI_REGISTER_GRANULARITY
)paren
OL
id|HWI_NEAR_END_BOUNDARY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|open_circut
)paren
id|cable_status
op_assign
(paren
id|near_end
)paren
ques
c_cond
id|E100_CABLE_OPEN_NEAR
suffix:colon
id|E100_CABLE_OPEN_FAR
suffix:semicolon
r_if
c_cond
(paren
id|short_circut
)paren
id|cable_status
op_assign
(paren
id|near_end
)paren
ques
c_cond
id|E100_CABLE_SHORT_NEAR
suffix:colon
id|E100_CABLE_SHORT_FAR
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Reset cable test */
id|e100_mdi_write
c_func
(paren
id|bdp
comma
id|HWI_CONTROL_REG
comma
id|bdp-&gt;phy_addr
comma
id|HWI_RESET_ALL_MASK
)paren
suffix:semicolon
r_return
id|cable_status
suffix:semicolon
)brace
eof
