multiline_comment|/* ibmtr.c:  A shared-memory IBM Token Ring 16/4 driver for linux&n; *&n; *&t;Written 1993 by Mark Swanson and Peter De Schrijver.&n; *&t;This software may be used and distributed according to the terms&n; *&t;of the GNU General Public License, incorporated herein by reference.&n; *&n; *&t;This device driver should work with Any IBM Token Ring Card that does&n; *&t;not use DMA.&n; *&n; *&t;I used Donald Becker&squot;s (becker@cesdis.gsfc.nasa.gov) device driver work&n; *&t;as a base for most of my initial work.&n; *&n; *&t;Changes by Peter De Schrijver&n; *&t;&t;(Peter.Deschrijver@linux.cc.kuleuven.ac.be) :&n; *&n; *&t;+ changed name to ibmtr.c in anticipation of other tr boards.&n; *&t;+ changed reset code and adapter open code.&n; *&t;+ added SAP open code.&n; *&t;+ a first attempt to write interrupt, transmit and receive routines.&n; *&n; *&t;Changes by David W. Morris (dwm@shell.portal.com) :&n; *&t;941003 dwm: - Restructure tok_probe for multiple adapters, devices.&n; *&t;+ Add comments, misc reorg for clarity.&n; *&t;+ Flatten interrupt handler levels.&n; *&n; *&t;Changes by Farzad Farid (farzy@zen.via.ecp.fr)&n; *&t;and Pascal Andre (andre@chimay.via.ecp.fr) (March 9 1995) :&n; *&t;+ multi ring support clean up.&n; *&t;+ RFC1042 compliance enhanced.&n; *&n; *&t;Changes by Pascal Andre (andre@chimay.via.ecp.fr) (September 7 1995) :&n; *&t;+ bug correction in tr_tx&n; *&t;+ removed redundant information display&n; *&t;+ some code reworking&n; *&n; *&t;Changes by Michel Lespinasse (walken@via.ecp.fr),&n; *&t;Yann Doussot (doussot@via.ecp.fr) and Pascal Andre (andre@via.ecp.fr)&n; *&t;(February 18, 1996) :&n; *&t;+ modified shared memory and mmio access port the driver to&n; *&t;  alpha platform (structure access -&gt; readb/writeb)&n; *&n; *&t;Changes by Steve Kipisz (bungy@ibm.net or kipisz@vnet.ibm.com)&n; *&t;(January 18 1996):&n; *&t;+ swapped WWOR and WWCR in ibmtr.h&n; *&t;+ moved some init code from tok_probe into trdev_init.  The&n; *&t;  PCMCIA code can call trdev_init to complete initializing&n; *&t;  the driver.&n; *&t;+ added -DPCMCIA to support PCMCIA&n; *&t;+ detecting PCMCIA Card Removal in interrupt handler.  If&n; *&t;  ISRP is FF, then a PCMCIA card has been removed&n; *        10/2000 Burt needed a new method to avoid crashing the OS&n; *&n; *&t;Changes by Paul Norton (pnorton@cts.com) :&n; *&t;+ restructured the READ.LOG logic to prevent the transmit SRB&n; *&t;  from being rudely overwritten before the transmit cycle is&n; *&t;  complete. (August 15 1996)&n; *&t;+ completed multiple adapter support. (November 20 1996)&n; *&t;+ implemented csum_partial_copy in tr_rx and increased receive &n; *        buffer size and count. Minor fixes. (March 15, 1997)&n; *&n; *&t;Changes by Christopher Turcksin &lt;wabbit@rtfc.demon.co.uk&gt;&n; *&t;+ Now compiles ok as a module again.&n; *&n; *&t;Changes by Paul Norton (pnorton@ieee.org) :&n; *      + moved the header manipulation code in tr_tx and tr_rx to&n; *        net/802/tr.c. (July 12 1997)&n; *      + add retry and timeout on open if cable disconnected. (May 5 1998)&n; *      + lifted 2000 byte mtu limit. now depends on shared-RAM size.&n; *        May 25 1998)&n; *      + can&squot;t allocate 2k recv buff at 8k shared-RAM. (20 October 1998)&n; *&n; *      Changes by Joel Sloan (jjs@c-me.com) :&n; *      + disable verbose debug messages by default - to enable verbose&n; *&t;  debugging, edit the IBMTR_DEBUG_MESSAGES define below &n; *&t;&n; *&t;Changes by Mike Phillips &lt;phillim@amtrak.com&gt; :&n; *&t;+ Added extra #ifdef&squot;s to work with new PCMCIA Token Ring Code.&n; *&t;  The PCMCIA code now just sets up the card so it can be recognized&n; *        by ibmtr_probe. Also checks allocated memory vs. on-board memory&n; *&t;  for correct figure to use.&n; *&n; *&t;Changes by Tim Hockin (thockin@isunix.it.ilstu.edu) :&n; *&t;+ added spinlocks for SMP sanity (10 March 1999)&n; *&n; *      Changes by Jochen Friedrich to enable RFC1469 Option 2 multicasting&n; *      i.e. using functional address C0 00 00 04 00 00 to transmit and &n; *      receive multicast packets.&n; *&n; *      Changes by Mike Sullivan (based on original sram patch by Dave Grothe&n; *      to support windowing into on adapter shared ram.&n; *      i.e. Use LANAID to setup a PnP configuration with 16K RAM. Paging&n; *      will shift this 16K window over the entire available shared RAM.&n; *&n; *      Changes by Peter De Schrijver (p2@mind.be) :&n; *      + fixed a problem with PCMCIA card removal&n; *&n; *      Change by Mike Sullivan et al.:&n; *      + added turbo card support. No need to use lanaid to configure&n; *      the adapter into isa compatiblity mode.&n; *&n; *      Changes by Burt Silverman to allow the computer to behave nicely when&n; *&t;a cable is pulled or not in place, or a PCMCIA card is removed hot.&n; */
multiline_comment|/* change the define of IBMTR_DEBUG_MESSAGES to a nonzero value &n;in the event that chatty debug messages are desired - jjs 12/30/98 */
DECL|macro|IBMTR_DEBUG_MESSAGES
mdefine_line|#define IBMTR_DEBUG_MESSAGES 0
macro_line|#include &lt;linux/module.h&gt;
macro_line|#ifdef PCMCIA
DECL|macro|MODULE
macro_line|#undef MODULE
DECL|macro|ENABLE_PAGING
macro_line|#undef ENABLE_PAGING
macro_line|#else
DECL|macro|ENABLE_PAGING
mdefine_line|#define ENABLE_PAGING 1&t;&t;
macro_line|#endif
DECL|macro|FALSE
mdefine_line|#define FALSE 0
DECL|macro|TRUE
mdefine_line|#define TRUE (!FALSE)
multiline_comment|/* changes the output format of driver initialization */
DECL|macro|TR_VERBOSE
mdefine_line|#define TR_VERBOSE&t;0
multiline_comment|/* some 95 OS send many non UI frame; this allow removing the warning */
DECL|macro|TR_FILTERNONUI
mdefine_line|#define TR_FILTERNONUI&t;1
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/trdevice.h&gt;
macro_line|#include &lt;linux/ibmtr.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(format, args...) printk(&quot;%s: &quot; format, dev-&gt;name , ## args)
DECL|macro|DPRINTD
mdefine_line|#define DPRINTD(format, args...) DummyCall(&quot;%s: &quot; format, dev-&gt;name , ## args)
DECL|macro|MIN
mdefine_line|#define MIN(X, Y) ((X) &lt; (Y) ? (X) : (Y))
DECL|macro|MAX
mdefine_line|#define MAX(X, Y) ((X) &gt; (Y) ? (X) : (Y))
multiline_comment|/* version and credits */
macro_line|#ifndef PCMCIA
DECL|variable|__initdata
r_static
r_char
id|version
(braket
)braket
id|__initdata
op_assign
l_string|&quot;&bslash;nibmtr.c: v1.3.57   8/ 7/94 Peter De Schrijver and Mark Swanson&bslash;n&quot;
l_string|&quot;         v2.1.125 10/20/98 Paul Norton    &lt;pnorton@ieee.org&gt;&bslash;n&quot;
l_string|&quot;         v2.2.0   12/30/98 Joel Sloan     &lt;jjs@c-me.com&gt;&bslash;n&quot;
l_string|&quot;         v2.2.1   02/08/00 Mike Sullivan  &lt;sullivam@us.ibm.com&gt;&bslash;n&quot;
l_string|&quot;         v2.2.2   07/27/00 Burt Silverman &lt;burts@us.ibm.com&gt;&bslash;n&quot;
l_string|&quot;         v2.4.0   03/01/01 Mike Sullivan &lt;sullivan@us.ibm.com&gt;&bslash;n&quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/* this allows displaying full adapter information */
DECL|variable|__initdata
r_char
op_star
id|channel_def
(braket
)braket
id|__initdata
op_assign
(brace
l_string|&quot;ISA&quot;
comma
l_string|&quot;MCA&quot;
comma
l_string|&quot;ISA P&amp;P&quot;
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_char
id|pcchannelid
(braket
)braket
id|__devinitdata
op_assign
(brace
l_int|0x05
comma
l_int|0x00
comma
l_int|0x04
comma
l_int|0x09
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x0f
comma
l_int|0x03
comma
l_int|0x06
comma
l_int|0x03
comma
l_int|0x01
comma
l_int|0x03
comma
l_int|0x01
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x09
comma
l_int|0x03
comma
l_int|0x09
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|0x02
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_char
id|mcchannelid
(braket
)braket
id|__devinitdata
op_assign
(brace
l_int|0x04
comma
l_int|0x0d
comma
l_int|0x04
comma
l_int|0x01
comma
l_int|0x05
comma
l_int|0x02
comma
l_int|0x05
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x06
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x05
comma
l_int|0x08
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x05
comma
l_int|0x03
comma
l_int|0x01
comma
l_int|0x03
comma
l_int|0x08
comma
l_int|0x02
comma
l_int|0x00
)brace
suffix:semicolon
DECL|function|adapter_def
r_char
id|__devinit
op_star
id|adapter_def
c_func
(paren
r_char
id|type
)paren
(brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
l_int|0xF
suffix:colon
r_return
l_string|&quot;PC Adapter | PC Adapter II | Adapter/A&quot;
suffix:semicolon
r_case
l_int|0xE
suffix:colon
r_return
l_string|&quot;16/4 Adapter | 16/4 Adapter/A (long)&quot;
suffix:semicolon
r_case
l_int|0xD
suffix:colon
r_return
l_string|&quot;16/4 Adapter/A (short) | 16/4 ISA-16 Adapter&quot;
suffix:semicolon
r_case
l_int|0xC
suffix:colon
r_return
l_string|&quot;Auto 16/4 Adapter&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;adapter (unknown type)&quot;
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|TRC_INIT
mdefine_line|#define TRC_INIT 0x01&t;&t;/*  Trace initialization &amp; PROBEs */
DECL|macro|TRC_INITV
mdefine_line|#define TRC_INITV 0x02&t;&t;/*  verbose init trace points     */
DECL|variable|ibmtr_debug_trace
r_int
r_char
id|ibmtr_debug_trace
op_assign
l_int|0
suffix:semicolon
r_int
id|ibmtr_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ibmtr_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ioaddr
)paren
suffix:semicolon
r_static
r_int
r_char
id|get_sram_size
c_func
(paren
r_struct
id|tok_info
op_star
id|adapt_info
)paren
suffix:semicolon
r_static
r_int
id|trdev_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tok_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tok_init_card
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|tok_open_adapter
c_func
(paren
r_int
r_int
id|dev_addr
)paren
suffix:semicolon
r_static
r_void
id|open_sap
c_func
(paren
r_int
r_char
id|type
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tok_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tok_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|tok_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|tok_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|initial_tok_int
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tr_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tr_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_void
id|ibmtr_reset_timer
c_func
(paren
r_struct
id|timer_list
op_star
id|tmr
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|tok_rerun
c_func
(paren
r_int
r_int
id|dev_addr
)paren
suffix:semicolon
r_void
id|ibmtr_readlog
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|tok_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_int
id|ibmtr_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|mtu
)paren
suffix:semicolon
r_static
r_void
id|find_turbo_adapters
c_func
(paren
r_int
op_star
id|iolist
)paren
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_int
id|ibmtr_portlist
(braket
id|IBMTR_MAX_ADAPTERS
op_plus
l_int|1
)braket
id|__devinitdata
op_assign
(brace
l_int|0xa20
comma
l_int|0xa24
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|turbo_io
r_static
r_int
id|__devinitdata
id|turbo_io
(braket
id|IBMTR_MAX_ADAPTERS
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|turbo_irq
r_static
r_int
id|__devinitdata
id|turbo_irq
(braket
id|IBMTR_MAX_ADAPTERS
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|turbo_searched
r_static
r_int
id|__devinitdata
id|turbo_searched
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef PCMCIA
DECL|variable|__initdata
r_static
id|__u32
id|ibmtr_mem_base
id|__initdata
op_assign
l_int|0xd0000
suffix:semicolon
macro_line|#endif
DECL|function|PrtChanID
r_static
r_void
id|__devinit
id|PrtChanID
c_func
(paren
r_char
op_star
id|pcid
comma
r_int
id|stride
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|24
suffix:semicolon
id|i
op_increment
comma
id|j
op_add_assign
id|stride
)paren
id|printk
c_func
(paren
l_string|&quot;%1x&quot;
comma
(paren
(paren
r_int
)paren
id|pcid
(braket
id|j
)braket
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|HWPrtChanID
r_static
r_void
id|__devinit
id|HWPrtChanID
c_func
(paren
id|__u32
id|pcid
comma
r_int
id|stride
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|24
suffix:semicolon
id|i
op_increment
comma
id|j
op_add_assign
id|stride
)paren
id|printk
c_func
(paren
l_string|&quot;%1x&quot;
comma
(paren
(paren
r_int
)paren
id|readb
c_func
(paren
id|pcid
op_plus
id|j
)paren
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|find_turbo_adapters
r_static
r_void
id|__devinit
id|find_turbo_adapters
c_func
(paren
r_int
op_star
id|iolist
)paren
(brace
r_int
id|ram_addr
suffix:semicolon
r_int
id|index
op_assign
l_int|0
suffix:semicolon
id|__u32
id|chanid
suffix:semicolon
r_int
id|found_turbo
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|tchanid
comma
id|ctemp
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
id|turbo_searched
op_eq
l_int|1
)paren
r_return
suffix:semicolon
id|turbo_searched
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|ram_addr
op_assign
l_int|0xC0000
suffix:semicolon
id|ram_addr
OL
l_int|0xE0000
suffix:semicolon
id|ram_addr
op_add_assign
l_int|0x2000
)paren
(brace
id|__u32
id|intf_tbl
op_assign
l_int|0
suffix:semicolon
id|found_turbo
op_assign
l_int|1
suffix:semicolon
id|chanid
op_assign
(paren
id|CHANNEL_ID
op_plus
id|ram_addr
)paren
suffix:semicolon
id|tchanid
op_assign
id|pcchannelid
suffix:semicolon
id|ctemp
op_assign
id|isa_readb
c_func
(paren
id|chanid
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|ctemp
op_ne
op_star
id|tchanid
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
comma
id|j
op_assign
l_int|1
suffix:semicolon
id|i
op_le
l_int|46
suffix:semicolon
id|i
op_assign
id|i
op_plus
l_int|2
comma
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|isa_readb
c_func
(paren
id|chanid
op_plus
id|i
)paren
op_amp
l_int|0x0f
)paren
op_ne
id|tchanid
(braket
id|j
)braket
)paren
(brace
id|found_turbo
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found_turbo
)paren
r_continue
suffix:semicolon
id|isa_writeb
c_func
(paren
l_int|0x90
comma
id|ram_addr
op_plus
l_int|0x1E01
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
l_int|0x0f
suffix:semicolon
id|i
op_increment
)paren
(brace
id|isa_writeb
c_func
(paren
l_int|0x00
comma
id|ram_addr
op_plus
l_int|0x1E01
op_plus
id|i
)paren
suffix:semicolon
)brace
id|isa_writeb
c_func
(paren
l_int|0x00
comma
id|ram_addr
op_plus
l_int|0x1E01
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|jiffies
op_plus
id|TR_BUSY_INTERVAL
suffix:semicolon
id|time_before_eq
c_func
(paren
id|jiffies
comma
id|i
)paren
suffix:semicolon
)paren
(brace
suffix:semicolon
)brace
id|intf_tbl
op_assign
id|ntohs
c_func
(paren
id|isa_readw
c_func
(paren
id|ram_addr
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|WRBR_EVEN
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intf_tbl
)paren
(brace
macro_line|#if IBMTR_DEBUG_MESSAGES
id|printk
c_func
(paren
l_string|&quot;ibmtr::find_turbo_adapters, Turbo found at &quot;
l_string|&quot;ram_addr %x&bslash;n&quot;
comma
id|ram_addr
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ibmtr::find_turbo_adapters, interface_table &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%x:&quot;
comma
id|isa_readb
c_func
(paren
id|ram_addr
op_plus
id|intf_tbl
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|turbo_io
(braket
id|index
)braket
op_assign
id|ntohs
c_func
(paren
id|isa_readw
c_func
(paren
id|ram_addr
op_plus
id|intf_tbl
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|turbo_irq
(braket
id|index
)braket
op_assign
id|isa_readb
c_func
(paren
id|ram_addr
op_plus
id|intf_tbl
op_plus
l_int|3
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|turbo_io
(braket
id|index
)braket
op_plus
id|ADAPTRESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|jiffies
op_plus
id|TR_RST_TIME
suffix:semicolon
id|time_before_eq
c_func
(paren
id|jiffies
comma
id|i
)paren
suffix:semicolon
)paren
(brace
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0
comma
id|turbo_io
(braket
id|index
)braket
op_plus
id|ADAPTRESETREL
)paren
suffix:semicolon
id|index
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#if IBMTR_DEBUG_MESSAGES 
id|printk
c_func
(paren
l_string|&quot;ibmtr::find_turbo_adapters, ibmtr card found at&quot;
l_string|&quot; %x but not a Turbo model&bslash;n&quot;
comma
id|ram_addr
)paren
suffix:semicolon
macro_line|#endif
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IBMTR_MAX_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|turbo_io
(braket
id|i
)braket
)paren
(brace
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|IBMTR_MAX_ADAPTERS
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|iolist
(braket
id|j
)braket
op_logical_and
id|iolist
(braket
id|j
)braket
op_ne
id|turbo_io
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
id|iolist
(braket
id|j
)braket
op_assign
id|turbo_io
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/****************************************************************************&n; *&t;ibmtr_probe():  Routine specified in the network device structure&n; *&t;to probe for an IBM Token Ring Adapter.  Routine outline:&n; *&t;I.    Interrogate hardware to determine if an adapter exists&n; *&t;      and what the speeds and feeds are&n; *&t;II.   Setup data structures to control execution based upon&n; *&t;      adapter characteristics.&n; *&n; *&t;We expect ibmtr_probe to be called once for each device entry&n; *&t;which references it.&n; ****************************************************************************/
DECL|function|ibmtr_probe
r_int
id|__devinit
id|ibmtr_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|base_addr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|base_addr
op_logical_and
id|base_addr
op_le
l_int|0x1ff
)paren
multiline_comment|/* Don&squot;t probe at all. */
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|base_addr
OG
l_int|0x1ff
)paren
(brace
multiline_comment|/* Check a single specified location.  */
r_if
c_cond
(paren
op_logical_neg
id|ibmtr_probe1
c_func
(paren
id|dev
comma
id|base_addr
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|find_turbo_adapters
c_func
(paren
id|ibmtr_portlist
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|ibmtr_portlist
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|ioaddr
op_assign
id|ibmtr_portlist
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|ioaddr
comma
id|IBMTR_IO_EXTENT
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ibmtr_probe1
c_func
(paren
id|dev
comma
id|ioaddr
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|ibmtr_probe1
r_static
r_int
id|__devinit
id|ibmtr_probe1
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|PIOaddr
)paren
(brace
r_int
r_char
id|segment
comma
id|intr
op_assign
l_int|0
comma
id|irq
op_assign
l_int|0
comma
id|i
comma
id|j
comma
id|cardpresent
op_assign
id|NOTOK
comma
id|temp
op_assign
l_int|0
suffix:semicolon
id|__u32
id|t_mmio
op_assign
l_int|0
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
op_assign
l_int|0
suffix:semicolon
id|__u32
id|cd_chanid
suffix:semicolon
r_int
r_char
op_star
id|tchanid
comma
id|ctemp
suffix:semicolon
macro_line|#ifndef PCMCIA
r_int
r_char
id|t_irq
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_static
r_int
id|version_printed
suffix:semicolon
macro_line|#endif
macro_line|#ifndef MODULE
macro_line|#ifndef PCMCIA
id|dev
op_assign
id|init_trdev
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
multiline_comment|/*    Query the adapter PIO base port which will return&n;&t; *    indication of where MMIO was placed. We also have a&n;&t; *    coded interrupt number.&n;&t; */
id|segment
op_assign
id|inb
c_func
(paren
id|PIOaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|segment
template_param
l_int|0xe0
)paren
(brace
multiline_comment|/* Out of range values so we&squot;ll assume non-existent IO device&n;&t;&t; * but this is not necessarily a problem, esp if a turbo&n;&t;&t; * adapter is being used.  */
macro_line|#if IBMTR_DEBUG_MESSAGES
id|DPRINTK
c_func
(paren
l_string|&quot;ibmtr_probe1(): unhappy that inb(0x%X) == 0x%X, &quot;
l_string|&quot;Hardware Problem?&bslash;n&quot;
comma
id|PIOaddr
comma
id|segment
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *    Compute the linear base address of the MMIO area&n;&t; *    as LINUX doesn&squot;t care about segments&n;&t; */
id|t_mmio
op_assign
(paren
id|u32
)paren
id|ioremap
c_func
(paren
(paren
(paren
id|__u32
)paren
(paren
id|segment
op_amp
l_int|0xfc
)paren
op_lshift
l_int|11
)paren
op_plus
l_int|0x80000
comma
l_int|2048
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|t_mmio
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Cannot remap mmiobase memory area&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|intr
op_assign
id|segment
op_amp
l_int|0x03
suffix:semicolon
multiline_comment|/* low bits is coded interrupt # */
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;PIOaddr: %4hx seg/intr: %2x mmio base: %08X intr: %d&bslash;n&quot;
comma
id|PIOaddr
comma
(paren
r_int
)paren
id|segment
comma
id|t_mmio
comma
(paren
r_int
)paren
id|intr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *    Now we will compare expected &squot;channelid&squot; strings with&n;&t; *    what we is there to learn of ISA/MCA or not TR card&n;&t; */
macro_line|#ifdef PCMCIA
id|ti
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/*BMS moved up here */
id|t_mmio
op_assign
id|ti-&gt;mmio
suffix:semicolon
multiline_comment|/*BMS to get virtual address */
id|irq
op_assign
id|ti-&gt;irq
suffix:semicolon
multiline_comment|/*BMS to display the irq!   */
macro_line|#endif
id|cd_chanid
op_assign
(paren
id|CHANNEL_ID
op_plus
id|t_mmio
)paren
suffix:semicolon
multiline_comment|/* for efficiency */
id|tchanid
op_assign
id|pcchannelid
suffix:semicolon
id|cardpresent
op_assign
id|TR_ISA
suffix:semicolon
multiline_comment|/* try ISA */
multiline_comment|/*    Suboptimize knowing first byte different */
id|ctemp
op_assign
id|readb
c_func
(paren
id|cd_chanid
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|ctemp
op_ne
op_star
id|tchanid
)paren
(brace
multiline_comment|/* NOT ISA card, try MCA */
id|tchanid
op_assign
id|mcchannelid
suffix:semicolon
id|cardpresent
op_assign
id|TR_MCA
suffix:semicolon
r_if
c_cond
(paren
id|ctemp
op_ne
op_star
id|tchanid
)paren
multiline_comment|/* Neither ISA nor MCA */
id|cardpresent
op_assign
id|NOTOK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cardpresent
op_ne
id|NOTOK
)paren
(brace
multiline_comment|/*       Know presumed type, try rest of ID */
r_for
c_loop
(paren
id|i
op_assign
l_int|2
comma
id|j
op_assign
l_int|1
suffix:semicolon
id|i
op_le
l_int|46
suffix:semicolon
id|i
op_assign
id|i
op_plus
l_int|2
comma
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|readb
c_func
(paren
id|cd_chanid
op_plus
id|i
)paren
op_amp
l_int|0x0f
)paren
op_eq
id|tchanid
(braket
id|j
)braket
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* match failed, not TR card */
id|cardpresent
op_assign
id|NOTOK
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* &n;&t; *    If we have an ISA board check for the ISA P&amp;P version,&n;&t; *    as it has different IRQ settings &n;&t; */
r_if
c_cond
(paren
id|cardpresent
op_eq
id|TR_ISA
op_logical_and
(paren
id|readb
c_func
(paren
id|AIPFID
op_plus
id|t_mmio
)paren
op_eq
l_int|0x0e
)paren
)paren
id|cardpresent
op_assign
id|TR_ISAPNP
suffix:semicolon
r_if
c_cond
(paren
id|cardpresent
op_eq
id|NOTOK
)paren
(brace
multiline_comment|/* &quot;channel_id&quot; did not match, report */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Channel ID string not found for PIOaddr: %4hx&bslash;n&quot;
comma
id|PIOaddr
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Expected for ISA: &quot;
)paren
suffix:semicolon
id|PrtChanID
c_func
(paren
id|pcchannelid
comma
l_int|1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;           found: &quot;
)paren
suffix:semicolon
multiline_comment|/* BMS Note that this can be misleading, when hardware is flaky, because you&n;   are reading it a second time here. So with my flaky hardware, I&squot;ll see my-&n;   self in this block, with the HW ID matching the ISA ID exactly! */
id|HWPrtChanID
c_func
(paren
id|cd_chanid
comma
l_int|2
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Expected for MCA: &quot;
)paren
suffix:semicolon
id|PrtChanID
c_func
(paren
id|mcchannelid
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Now, allocate some of the pl0 buffers for this driver.. */
multiline_comment|/* If called from PCMCIA, it is already set up, so no need to &n;&t;   waste the memory, just use the existing structure */
macro_line|#ifndef PCMCIA
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|tok_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|ti
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tok_info
)paren
)paren
suffix:semicolon
id|ti-&gt;mmio
op_assign
id|t_mmio
suffix:semicolon
id|dev-&gt;priv
op_assign
id|ti
suffix:semicolon
multiline_comment|/* this seems like the logical use of the&n;&t;&t;&t;&t;   field ... let&squot;s try some empirical tests&n;&t;&t;&t;&t;   using the token-info structure -- that&n;&t;&t;&t;&t;   should fit with out future hope of multiple&n;&t;&t;&t;&t;   adapter support as well /dwm   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IBMTR_MAX_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|turbo_io
(braket
id|i
)braket
op_ne
id|PIOaddr
)paren
r_continue
suffix:semicolon
macro_line|#if IBMTR_DEBUG_MESSAGES 
id|printk
c_func
(paren
l_string|&quot;ibmtr::tr_probe1, setting PIOaddr %x to Turbo&bslash;n&quot;
comma
id|PIOaddr
)paren
suffix:semicolon
macro_line|#endif
id|ti-&gt;turbo
op_assign
l_int|1
suffix:semicolon
id|t_irq
op_assign
id|turbo_irq
(braket
id|i
)braket
suffix:semicolon
)brace
macro_line|#endif
id|ti-&gt;readlog_pending
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
)paren
suffix:semicolon
multiline_comment|/* if PCMCIA, the card can be recognized as either TR_ISA or TR_ISAPNP&n;&t; * depending which card is inserted.&t;*/
macro_line|#ifndef PCMCIA
r_switch
c_cond
(paren
id|cardpresent
)paren
(brace
r_case
id|TR_ISA
suffix:colon
r_if
c_cond
(paren
id|intr
op_eq
l_int|0
)paren
id|irq
op_assign
l_int|9
suffix:semicolon
multiline_comment|/* irq2 really is irq9 */
r_if
c_cond
(paren
id|intr
op_eq
l_int|1
)paren
id|irq
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|2
)paren
id|irq
op_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|3
)paren
id|irq
op_assign
l_int|7
suffix:semicolon
id|ti-&gt;adapter_int_enable
op_assign
id|PIOaddr
op_plus
id|ADAPTINTREL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TR_MCA
suffix:colon
r_if
c_cond
(paren
id|intr
op_eq
l_int|0
)paren
id|irq
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|1
)paren
id|irq
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|2
)paren
id|irq
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|3
)paren
id|irq
op_assign
l_int|11
suffix:semicolon
id|ti-&gt;global_int_enable
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;adapter_int_enable
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;sram_virt
op_assign
(paren
id|__u32
)paren
(paren
id|inb
c_func
(paren
id|PIOaddr
op_plus
id|ADAPTRESETREL
)paren
op_amp
l_int|0xfe
)paren
op_lshift
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TR_ISAPNP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|t_irq
)paren
(brace
r_if
c_cond
(paren
id|intr
op_eq
l_int|0
)paren
id|irq
op_assign
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|1
)paren
id|irq
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|2
)paren
id|irq
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_eq
l_int|3
)paren
id|irq
op_assign
l_int|11
suffix:semicolon
)brace
r_else
id|irq
op_assign
id|t_irq
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|TR_SPIN_INTERVAL
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_EVEN
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
r_continue
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Hardware timeout during initialization.&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ti-&gt;sram_virt
op_assign
(paren
(paren
id|__u32
)paren
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_EVEN
)paren
op_lshift
l_int|12
)paren
suffix:semicolon
id|ti-&gt;adapter_int_enable
op_assign
id|PIOaddr
op_plus
id|ADAPTINTREL
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*end switch (cardpresent) */
macro_line|#endif&t;/*not PCMCIA */
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
(brace
multiline_comment|/* just report int */
id|DPRINTK
c_func
(paren
l_string|&quot;irq=%d&quot;
comma
id|irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, sram_virt=0x%x&quot;
comma
id|ti-&gt;sram_virt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INITV
)paren
(brace
multiline_comment|/* full chat in verbose only */
id|DPRINTK
c_func
(paren
l_string|&quot;, ti-&gt;mmio=%08X&quot;
comma
id|ti-&gt;mmio
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, segment=%02X&quot;
comma
id|segment
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Get hw address of token ring card */
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x18
suffix:semicolon
id|i
op_assign
id|i
op_plus
l_int|2
)paren
(brace
multiline_comment|/* technical reference states to do this */
id|temp
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIP
op_plus
id|i
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|ti-&gt;hw_address
(braket
id|j
)braket
op_assign
id|temp
suffix:semicolon
r_if
c_cond
(paren
id|j
op_amp
l_int|1
)paren
id|dev-&gt;dev_addr
(braket
(paren
id|j
op_div
l_int|2
)paren
)braket
op_assign
id|ti-&gt;hw_address
(braket
id|j
)braket
op_plus
(paren
id|ti-&gt;hw_address
(braket
id|j
op_minus
l_int|1
)braket
op_lshift
l_int|4
)paren
suffix:semicolon
op_increment
id|j
suffix:semicolon
)brace
multiline_comment|/* get Adapter type:  &squot;F&squot; = Adapter/A, &squot;E&squot; = 16/4 Adapter II,... */
id|ti-&gt;adapter_type
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIPADAPTYPE
)paren
suffix:semicolon
multiline_comment|/* get Data Rate:  F=4Mb, E=16Mb, D=4Mb &amp; 16Mb ?? */
id|ti-&gt;data_rate
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIPDATARATE
)paren
suffix:semicolon
multiline_comment|/* Get Early Token Release support?: F=no, E=4Mb, D=16Mb, C=4&amp;16Mb */
id|ti-&gt;token_release
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIPEARLYTOKEN
)paren
suffix:semicolon
multiline_comment|/* How much shared RAM is on adapter ? */
r_if
c_cond
(paren
id|ti-&gt;turbo
)paren
(brace
id|ti-&gt;avail_shared_ram
op_assign
l_int|127
suffix:semicolon
)brace
r_else
(brace
id|ti-&gt;avail_shared_ram
op_assign
id|get_sram_size
c_func
(paren
id|ti
)paren
suffix:semicolon
multiline_comment|/*in 512 byte units */
)brace
multiline_comment|/* We need to set or do a bunch of work here based on previous results*/
multiline_comment|/* Support paging?  What sizes?:  F=no, E=16k, D=32k, C=16 &amp; 32k */
id|ti-&gt;shared_ram_paging
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIPSHRAMPAGE
)paren
suffix:semicolon
multiline_comment|/* Available DHB  4Mb size:   F=2048, E=4096, D=4464 */
r_switch
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIP4MBDHB
)paren
)paren
(brace
r_case
l_int|0xe
suffix:colon
id|ti-&gt;dhb_size4mb
op_assign
l_int|4096
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xd
suffix:colon
id|ti-&gt;dhb_size4mb
op_assign
l_int|4464
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ti-&gt;dhb_size4mb
op_assign
l_int|2048
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Available DHB 16Mb size:  F=2048, E=4096, D=8192, C=16384, B=17960 */
r_switch
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|AIP16MBDHB
)paren
)paren
(brace
r_case
l_int|0xe
suffix:colon
id|ti-&gt;dhb_size16mb
op_assign
l_int|4096
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xd
suffix:colon
id|ti-&gt;dhb_size16mb
op_assign
l_int|8192
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xc
suffix:colon
id|ti-&gt;dhb_size16mb
op_assign
l_int|16384
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xb
suffix:colon
id|ti-&gt;dhb_size16mb
op_assign
l_int|17960
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ti-&gt;dhb_size16mb
op_assign
l_int|2048
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*    We must figure out how much shared memory space this adapter&n;&t; *    will occupy so that if there are two adapters we can fit both&n;&t; *    in.  Given a choice, we will limit this adapter to 32K.  The&n;&t; *    maximum space will will use for two adapters is 64K so if the&n;&t; *    adapter we are working on demands 64K (it also doesn&squot;t support&n;&t; *    paging), then only one adapter can be supported.  &n;&t; */
multiline_comment|/*&n;&t; *    determine how much of total RAM is mapped into PC space &n;&t; */
id|ti-&gt;mapped_ram_size
op_assign
multiline_comment|/*sixteen to onehundredtwentyeight 512byte blocks*/
l_int|1
op_lshift
(paren
(paren
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_ODD
)paren
op_rshift
l_int|2
op_amp
l_int|0x03
)paren
op_plus
l_int|4
)paren
suffix:semicolon
id|ti-&gt;page_mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;turbo
)paren
id|ti-&gt;page_mask
op_assign
l_int|0xf0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ti-&gt;shared_ram_paging
op_eq
l_int|0xf
)paren
suffix:semicolon
multiline_comment|/* No paging in adapter */
r_else
(brace
macro_line|#ifdef ENABLE_PAGING
r_int
r_char
id|pg_size
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* BMS:   page size: PCMCIA, use configuration register;&n;&t;&t;   ISAPNP, use LANAIDC config tool from www.ibm.com  */
r_switch
c_cond
(paren
id|ti-&gt;shared_ram_paging
)paren
(brace
r_case
l_int|0xf
suffix:colon
r_break
suffix:semicolon
r_case
l_int|0xe
suffix:colon
id|ti-&gt;page_mask
op_assign
(paren
id|ti-&gt;mapped_ram_size
op_eq
l_int|32
)paren
ques
c_cond
l_int|0xc0
suffix:colon
l_int|0
suffix:semicolon
id|pg_size
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* 16KB page size */
r_break
suffix:semicolon
r_case
l_int|0xd
suffix:colon
id|ti-&gt;page_mask
op_assign
(paren
id|ti-&gt;mapped_ram_size
op_eq
l_int|64
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0
suffix:semicolon
id|pg_size
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* 32KB page size */
r_break
suffix:semicolon
r_case
l_int|0xc
suffix:colon
r_switch
c_cond
(paren
id|ti-&gt;mapped_ram_size
)paren
(brace
r_case
l_int|32
suffix:colon
id|ti-&gt;page_mask
op_assign
l_int|0xc0
suffix:semicolon
id|pg_size
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|64
suffix:colon
id|ti-&gt;page_mask
op_assign
l_int|0x80
suffix:semicolon
id|pg_size
op_assign
l_int|64
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown shared ram paging info %01X&bslash;n&quot;
comma
id|ti-&gt;shared_ram_paging
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*end switch shared_ram_paging */
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;Shared RAM paging code: %02X, &quot;
l_string|&quot;mapped RAM size: %dK, shared RAM size: %dK, &quot;
l_string|&quot;page mask: %02X&bslash;n:&quot;
comma
id|ti-&gt;shared_ram_paging
comma
id|ti-&gt;mapped_ram_size
op_div
l_int|2
comma
id|ti-&gt;avail_shared_ram
op_div
l_int|2
comma
id|ti-&gt;page_mask
)paren
suffix:semicolon
macro_line|#endif&t;/*ENABLE_PAGING */
)brace
macro_line|#ifndef PCMCIA
multiline_comment|/* finish figuring the shared RAM address */
r_if
c_cond
(paren
id|cardpresent
op_eq
id|TR_ISA
)paren
(brace
r_static
id|__u32
id|ram_bndry_mask
(braket
)braket
op_assign
(brace
l_int|0xffffe000
comma
l_int|0xffffc000
comma
l_int|0xffff8000
comma
l_int|0xffff0000
)brace
suffix:semicolon
id|__u32
id|new_base
comma
id|rrr_32
comma
id|chk_base
comma
id|rbm
suffix:semicolon
id|rrr_32
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_ODD
)paren
op_rshift
l_int|2
op_amp
l_int|0x03
suffix:semicolon
id|rbm
op_assign
id|ram_bndry_mask
(braket
id|rrr_32
)braket
suffix:semicolon
id|new_base
op_assign
(paren
id|ibmtr_mem_base
op_plus
(paren
op_complement
id|rbm
)paren
)paren
op_amp
id|rbm
suffix:semicolon
multiline_comment|/* up to boundary */
id|chk_base
op_assign
id|new_base
op_plus
(paren
id|ti-&gt;mapped_ram_size
op_lshift
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chk_base
OG
(paren
id|ibmtr_mem_base
op_plus
id|IBMTR_SHARED_RAM_SIZE
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Shared RAM for this adapter (%05x) exceeds &quot;
l_string|&quot;driver limit (%05x), adapter not started.&bslash;n&quot;
comma
id|chk_base
comma
id|ibmtr_mem_base
op_plus
id|IBMTR_SHARED_RAM_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* seems cool, record what we have figured out */
id|ti-&gt;sram_base
op_assign
id|new_base
op_rshift
l_int|12
suffix:semicolon
id|ibmtr_mem_base
op_assign
id|chk_base
suffix:semicolon
)brace
)brace
r_else
id|ti-&gt;sram_base
op_assign
id|ti-&gt;sram_virt
op_rshift
l_int|12
suffix:semicolon
multiline_comment|/* The PCMCIA has already got the interrupt line and the io port, &n;&t;   so no chance of anybody else getting it - MLP */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
op_assign
id|irq
comma
op_amp
id|tok_interrupt
comma
l_int|0
comma
l_string|&quot;ibmtr&quot;
comma
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Could not grab irq %d.  Halting Token Ring driver.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*?? Now, allocate some of the PIO PORTs for this driver.. */
multiline_comment|/* record PIOaddr range as busy */
id|request_region
c_func
(paren
id|PIOaddr
comma
id|IBMTR_IO_EXTENT
comma
l_string|&quot;ibmtr&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|version_printed
op_increment
)paren
(brace
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
)brace
macro_line|#endif
id|DPRINTK
c_func
(paren
l_string|&quot;%s %s found&bslash;n&quot;
comma
id|channel_def
(braket
id|cardpresent
op_minus
l_int|1
)braket
comma
id|adapter_def
c_func
(paren
id|ti-&gt;adapter_type
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;using irq %d, PIOaddr %hx, %dK shared RAM.&bslash;n&quot;
comma
id|irq
comma
id|PIOaddr
comma
id|ti-&gt;mapped_ram_size
op_div
l_int|2
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Hardware address : %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;Shared RAM paging enabled. &quot;
l_string|&quot;Page size: %uK Shared Ram size %dK&bslash;n&quot;
comma
(paren
(paren
id|ti-&gt;page_mask
op_xor
l_int|0xff
)paren
op_plus
l_int|1
)paren
op_rshift
l_int|2
comma
id|ti-&gt;avail_shared_ram
op_div
l_int|2
)paren
suffix:semicolon
r_else
id|DPRINTK
c_func
(paren
l_string|&quot;Shared RAM paging disabled. ti-&gt;page_mask %x&bslash;n&quot;
comma
id|ti-&gt;page_mask
)paren
suffix:semicolon
multiline_comment|/* Calculate the maximum DHB we can use */
multiline_comment|/* two cases where avail_shared_ram doesn&squot;t equal mapped_ram_size:&n;&t;    1. avail_shared_ram is 127 but mapped_ram_size is 128 (typical)&n;&t;    2. user has configured adapter for less than avail_shared_ram&n;&t;       but is not using paging (she should use paging, I believe)&n;&t;*/
r_if
c_cond
(paren
op_logical_neg
id|ti-&gt;page_mask
)paren
(brace
id|ti-&gt;avail_shared_ram
op_assign
id|MIN
c_func
(paren
id|ti-&gt;mapped_ram_size
comma
id|ti-&gt;avail_shared_ram
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ti-&gt;avail_shared_ram
)paren
(brace
r_case
l_int|16
suffix:colon
multiline_comment|/* 8KB shared RAM */
id|ti-&gt;dhb_size4mb
op_assign
id|MIN
c_func
(paren
id|ti-&gt;dhb_size4mb
comma
l_int|2048
)paren
suffix:semicolon
id|ti-&gt;rbuf_len4
op_assign
l_int|1032
suffix:semicolon
id|ti-&gt;rbuf_cnt4
op_assign
l_int|2
suffix:semicolon
id|ti-&gt;dhb_size16mb
op_assign
id|MIN
c_func
(paren
id|ti-&gt;dhb_size16mb
comma
l_int|2048
)paren
suffix:semicolon
id|ti-&gt;rbuf_len16
op_assign
l_int|1032
suffix:semicolon
id|ti-&gt;rbuf_cnt16
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
multiline_comment|/* 16KB shared RAM */
id|ti-&gt;dhb_size4mb
op_assign
id|MIN
c_func
(paren
id|ti-&gt;dhb_size4mb
comma
l_int|4464
)paren
suffix:semicolon
id|ti-&gt;rbuf_len4
op_assign
l_int|1032
suffix:semicolon
id|ti-&gt;rbuf_cnt4
op_assign
l_int|4
suffix:semicolon
id|ti-&gt;dhb_size16mb
op_assign
id|MIN
c_func
(paren
id|ti-&gt;dhb_size16mb
comma
l_int|4096
)paren
suffix:semicolon
id|ti-&gt;rbuf_len16
op_assign
l_int|1032
suffix:semicolon
multiline_comment|/*1024 usable */
id|ti-&gt;rbuf_cnt16
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|64
suffix:colon
multiline_comment|/* 32KB shared RAM */
id|ti-&gt;dhb_size4mb
op_assign
id|MIN
c_func
(paren
id|ti-&gt;dhb_size4mb
comma
l_int|4464
)paren
suffix:semicolon
id|ti-&gt;rbuf_len4
op_assign
l_int|1032
suffix:semicolon
id|ti-&gt;rbuf_cnt4
op_assign
l_int|6
suffix:semicolon
id|ti-&gt;dhb_size16mb
op_assign
id|MIN
c_func
(paren
id|ti-&gt;dhb_size16mb
comma
l_int|10240
)paren
suffix:semicolon
id|ti-&gt;rbuf_len16
op_assign
l_int|1032
suffix:semicolon
id|ti-&gt;rbuf_cnt16
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|127
suffix:colon
multiline_comment|/* 63.5KB shared RAM */
id|ti-&gt;dhb_size4mb
op_assign
id|MIN
c_func
(paren
id|ti-&gt;dhb_size4mb
comma
l_int|4464
)paren
suffix:semicolon
id|ti-&gt;rbuf_len4
op_assign
l_int|1032
suffix:semicolon
id|ti-&gt;rbuf_cnt4
op_assign
l_int|6
suffix:semicolon
id|ti-&gt;dhb_size16mb
op_assign
id|MIN
c_func
(paren
id|ti-&gt;dhb_size16mb
comma
l_int|16384
)paren
suffix:semicolon
id|ti-&gt;rbuf_len16
op_assign
l_int|1032
suffix:semicolon
id|ti-&gt;rbuf_cnt16
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|128
suffix:colon
multiline_comment|/* 64KB   shared RAM */
id|ti-&gt;dhb_size4mb
op_assign
id|MIN
c_func
(paren
id|ti-&gt;dhb_size4mb
comma
l_int|4464
)paren
suffix:semicolon
id|ti-&gt;rbuf_len4
op_assign
l_int|1032
suffix:semicolon
id|ti-&gt;rbuf_cnt4
op_assign
l_int|6
suffix:semicolon
id|ti-&gt;dhb_size16mb
op_assign
id|MIN
c_func
(paren
id|ti-&gt;dhb_size16mb
comma
l_int|17960
)paren
suffix:semicolon
id|ti-&gt;rbuf_len16
op_assign
l_int|1032
suffix:semicolon
id|ti-&gt;rbuf_cnt16
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ti-&gt;dhb_size4mb
op_assign
l_int|2048
suffix:semicolon
id|ti-&gt;rbuf_len4
op_assign
l_int|1032
suffix:semicolon
id|ti-&gt;rbuf_cnt4
op_assign
l_int|2
suffix:semicolon
id|ti-&gt;dhb_size16mb
op_assign
l_int|2048
suffix:semicolon
id|ti-&gt;rbuf_len16
op_assign
l_int|1032
suffix:semicolon
id|ti-&gt;rbuf_cnt16
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* this formula is not smart enough for the paging case&n;&t;ti-&gt;rbuf_cnt&lt;x&gt; = (ti-&gt;avail_shared_ram * BLOCKSZ - ADAPT_PRIVATE -&n;&t;&t;&t;ARBLENGTH - SSBLENGTH - DLC_MAX_SAP * SAPLENGTH -&n;&t;&t;&t;DLC_MAX_STA * STALENGTH - ti-&gt;dhb_size&lt;x&gt;mb * NUM_DHB -&n;&t;&t;&t;SRBLENGTH - ASBLENGTH) / ti-&gt;rbuf_len&lt;x&gt;;&n;&t;*/
id|ti-&gt;maxmtu16
op_assign
(paren
id|ti-&gt;rbuf_len16
op_minus
l_int|8
)paren
op_star
id|ti-&gt;rbuf_cnt16
op_minus
id|TR_HLEN
suffix:semicolon
id|ti-&gt;maxmtu4
op_assign
(paren
id|ti-&gt;rbuf_len4
op_minus
l_int|8
)paren
op_star
id|ti-&gt;rbuf_cnt4
op_minus
id|TR_HLEN
suffix:semicolon
multiline_comment|/*BMS assuming 18 bytes of Routing Information (usually works) */
id|DPRINTK
c_func
(paren
l_string|&quot;Maximum Receive Internet Protocol MTU 16Mbps: %d, 4Mbps: %d&bslash;n&quot;
comma
id|ti-&gt;maxmtu16
comma
id|ti-&gt;maxmtu4
)paren
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|PIOaddr
suffix:semicolon
multiline_comment|/* set the value for device */
id|dev-&gt;mem_start
op_assign
id|ti-&gt;sram_base
op_lshift
l_int|12
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|dev-&gt;mem_start
op_plus
(paren
id|ti-&gt;mapped_ram_size
op_lshift
l_int|9
)paren
op_minus
l_int|1
suffix:semicolon
id|trdev_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Return 0 to indicate we have found a Token Ring card. */
)brace
multiline_comment|/*ibmtr_probe1() */
multiline_comment|/*****************************************************************************/
multiline_comment|/* query the adapter for the size of shared RAM  */
multiline_comment|/* the function returns the RAM size in units of 512 bytes */
DECL|function|get_sram_size
r_static
r_int
r_char
id|__devinit
id|get_sram_size
c_func
(paren
r_struct
id|tok_info
op_star
id|adapt_info
)paren
(brace
r_int
r_char
id|avail_sram_code
suffix:semicolon
r_static
r_int
r_char
id|size_code
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|16
comma
l_int|32
comma
l_int|64
comma
l_int|127
comma
l_int|128
)brace
suffix:semicolon
multiline_comment|/* Adapter gives&n;&t;   &squot;F&squot; -- use RRR bits 3,2&n;&t;   &squot;E&squot; -- 8kb   &squot;D&squot; -- 16kb&n;&t;   &squot;C&squot; -- 32kb  &squot;A&squot; -- 64KB&n;&t;   &squot;B&squot; - 64KB less 512 bytes at top&n;&t;   (WARNING ... must zero top bytes in INIT */
id|avail_sram_code
op_assign
l_int|0xf
op_minus
id|readb
c_func
(paren
id|adapt_info-&gt;mmio
op_plus
id|AIPAVAILSHRAM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|avail_sram_code
)paren
r_return
id|size_code
(braket
id|avail_sram_code
)braket
suffix:semicolon
r_else
multiline_comment|/* for code &squot;F&squot;, must compute size from RRR(3,2) bits */
r_return
l_int|1
op_lshift
(paren
(paren
id|readb
c_func
(paren
id|adapt_info-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_ODD
)paren
op_rshift
l_int|2
op_amp
l_int|3
)paren
op_plus
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|trdev_init
r_static
r_int
id|__devinit
id|trdev_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;srb_page
)paren
suffix:semicolon
id|ti-&gt;open_failure
op_assign
id|NO
suffix:semicolon
id|dev-&gt;open
op_assign
id|tok_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|tok_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|tok_send_packet
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|tok_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|tok_set_multicast_list
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|ibmtr_change_mtu
suffix:semicolon
macro_line|#ifndef MODULE
macro_line|#ifndef PCMCIA
id|tr_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|tok_init_card
r_static
r_int
id|tok_init_card
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
r_int
id|PIOaddr
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
id|PIOaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Special processing for first interrupt after reset */
id|ti-&gt;do_tok_int
op_assign
id|FIRST_INT
suffix:semicolon
multiline_comment|/* Reset adapter */
id|writeb
c_func
(paren
op_complement
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|PIOaddr
op_plus
id|ADAPTRESET
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|TR_RST_TIME
)paren
suffix:semicolon
multiline_comment|/* wait 50ms */
id|outb
c_func
(paren
l_int|0
comma
id|PIOaddr
op_plus
id|ADAPTRESETREL
)paren
suffix:semicolon
macro_line|#ifdef ENABLE_PAGING
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
id|writeb
c_func
(paren
id|SRPR_ENABLE_PAGING
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|SRPR_EVEN
)paren
suffix:semicolon
macro_line|#endif
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
id|i
op_assign
id|sleep_on_timeout
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
comma
l_int|4
op_star
id|HZ
)paren
suffix:semicolon
r_return
id|i
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|tok_open
r_static
r_int
id|tok_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*the case we were left in a failure state during a previous open */
r_if
c_cond
(paren
id|ti-&gt;open_failure
op_eq
id|YES
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Last time you were disconnected, how about now?&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;You can&squot;t insert with an ICS connector half-cocked.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ti-&gt;open_status
op_assign
id|CLOSED
suffix:semicolon
multiline_comment|/* CLOSED or OPEN      */
id|ti-&gt;sap_status
op_assign
id|CLOSED
suffix:semicolon
multiline_comment|/* CLOSED or OPEN      */
id|ti-&gt;open_failure
op_assign
id|NO
suffix:semicolon
multiline_comment|/* NO     or YES       */
id|ti-&gt;open_mode
op_assign
id|MANUAL
suffix:semicolon
multiline_comment|/* MANUAL or AUTOMATIC */
multiline_comment|/* 12/2000 not typical Linux, but we can use RUNNING to let us know when&n;&t;the network has crapped out or cables are disconnected. Useful because&n;&t;the IFF_UP flag stays up the whole time, until ifconfig tr0 down.&n;&t;*/
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_RUNNING
suffix:semicolon
id|ti-&gt;sram_virt
op_and_assign
op_complement
l_int|1
suffix:semicolon
multiline_comment|/* to reverse what we do in tok_close */
multiline_comment|/* init the spinlock */
id|ti-&gt;lock
op_assign
(paren
id|spinlock_t
)paren
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|i
op_assign
id|tok_init_card
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|tok_open_adapter
c_func
(paren
(paren
r_int
r_int
)paren
id|dev
)paren
suffix:semicolon
id|i
op_assign
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
comma
l_int|25
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* sig catch: estimate opening adapter takes more than .5 sec*/
r_if
c_cond
(paren
id|i
OG
(paren
l_int|245
op_star
id|HZ
)paren
op_div
l_int|10
)paren
r_break
suffix:semicolon
multiline_comment|/* fancier than if (i==25*HZ) */
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;open_status
op_eq
id|OPEN
op_logical_and
id|ti-&gt;sap_status
op_eq
id|OPEN
)paren
(brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Adapter is up and running&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|i
op_assign
id|schedule_timeout
c_func
(paren
id|TR_RETRY_INTERVAL
)paren
suffix:semicolon
multiline_comment|/* wait 30 seconds */
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/*prob. a signal, like the i&gt;24*HZ case above */
)brace
id|outb
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|ADAPTRESET
)paren
suffix:semicolon
multiline_comment|/* kill pending interrupts*/
id|DPRINTK
c_func
(paren
l_string|&quot;TERMINATED via signal&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*BMS useful */
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|macro|COMMAND_OFST
mdefine_line|#define COMMAND_OFST             0
DECL|macro|OPEN_OPTIONS_OFST
mdefine_line|#define OPEN_OPTIONS_OFST        8
DECL|macro|NUM_RCV_BUF_OFST
mdefine_line|#define NUM_RCV_BUF_OFST        24
DECL|macro|RCV_BUF_LEN_OFST
mdefine_line|#define RCV_BUF_LEN_OFST        26
DECL|macro|DHB_LENGTH_OFST
mdefine_line|#define DHB_LENGTH_OFST         28
DECL|macro|NUM_DHB_OFST
mdefine_line|#define NUM_DHB_OFST            30
DECL|macro|DLC_MAX_SAP_OFST
mdefine_line|#define DLC_MAX_SAP_OFST        32
DECL|macro|DLC_MAX_STA_OFST
mdefine_line|#define DLC_MAX_STA_OFST        33
DECL|function|tok_open_adapter
r_void
id|tok_open_adapter
c_func
(paren
r_int
r_int
id|dev_addr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_addr
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;init_srb_page
)paren
suffix:semicolon
id|writeb
c_func
(paren
op_complement
id|SRB_RESP_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
r_struct
id|dir_open_adapter
)paren
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
l_int|0
comma
id|ti-&gt;init_srb
op_plus
id|i
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|DIR_OPEN_ADAPTER
comma
id|ti-&gt;init_srb
op_plus
id|COMMAND_OFST
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|OPEN_PASS_BCON_MAC
)paren
comma
id|ti-&gt;init_srb
op_plus
id|OPEN_OPTIONS_OFST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;ring_speed
op_eq
l_int|16
)paren
(brace
id|writew
c_func
(paren
id|htons
c_func
(paren
id|ti-&gt;dhb_size16mb
)paren
comma
id|ti-&gt;init_srb
op_plus
id|DHB_LENGTH_OFST
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|ti-&gt;rbuf_cnt16
)paren
comma
id|ti-&gt;init_srb
op_plus
id|NUM_RCV_BUF_OFST
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|ti-&gt;rbuf_len16
)paren
comma
id|ti-&gt;init_srb
op_plus
id|RCV_BUF_LEN_OFST
)paren
suffix:semicolon
)brace
r_else
(brace
id|writew
c_func
(paren
id|htons
c_func
(paren
id|ti-&gt;dhb_size4mb
)paren
comma
id|ti-&gt;init_srb
op_plus
id|DHB_LENGTH_OFST
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|ti-&gt;rbuf_cnt4
)paren
comma
id|ti-&gt;init_srb
op_plus
id|NUM_RCV_BUF_OFST
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|ti-&gt;rbuf_len4
)paren
comma
id|ti-&gt;init_srb
op_plus
id|RCV_BUF_LEN_OFST
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|NUM_DHB
comma
multiline_comment|/* always 2 */
id|ti-&gt;init_srb
op_plus
id|NUM_DHB_OFST
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|DLC_MAX_SAP
comma
id|ti-&gt;init_srb
op_plus
id|DLC_MAX_SAP_OFST
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|DLC_MAX_STA
comma
id|ti-&gt;init_srb
op_plus
id|DLC_MAX_STA_OFST
)paren
suffix:semicolon
id|ti-&gt;srb
op_assign
id|ti-&gt;init_srb
suffix:semicolon
multiline_comment|/* We use this one in the interrupt handler */
id|ti-&gt;srb_page
op_assign
id|ti-&gt;init_srb_page
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Opening adapter: Xmit bfrs: %d X %d, Rcv bfrs: %d X %d&bslash;n&quot;
comma
id|readb
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|NUM_DHB_OFST
)paren
comma
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|DHB_LENGTH_OFST
)paren
)paren
comma
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|NUM_RCV_BUF_OFST
)paren
)paren
comma
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|RCV_BUF_LEN_OFST
)paren
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CMD_IN_SRB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|open_sap
r_static
r_void
id|open_sap
c_func
(paren
r_int
r_char
id|type
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;srb_page
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
r_struct
id|dlc_open_sap
)paren
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
l_int|0
comma
id|ti-&gt;srb
op_plus
id|i
)paren
suffix:semicolon
DECL|macro|MAX_I_FIELD_OFST
mdefine_line|#define MAX_I_FIELD_OFST        14
DECL|macro|SAP_VALUE_OFST
mdefine_line|#define SAP_VALUE_OFST          16
DECL|macro|SAP_OPTIONS_OFST
mdefine_line|#define SAP_OPTIONS_OFST        17
DECL|macro|STATION_COUNT_OFST
mdefine_line|#define STATION_COUNT_OFST      18
id|writeb
c_func
(paren
id|DLC_OPEN_SAP
comma
id|ti-&gt;srb
op_plus
id|COMMAND_OFST
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|MAX_I_FIELD
)paren
comma
id|ti-&gt;srb
op_plus
id|MAX_I_FIELD_OFST
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|SAP_OPEN_IND_SAP
op_or
id|SAP_OPEN_PRIORITY
comma
id|ti-&gt;srb
op_plus
id|SAP_OPTIONS_OFST
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|SAP_OPEN_STATION_CNT
comma
id|ti-&gt;srb
op_plus
id|STATION_COUNT_OFST
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|type
comma
id|ti-&gt;srb
op_plus
id|SAP_VALUE_OFST
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CMD_IN_SRB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|tok_set_multicast_list
r_static
r_void
id|tok_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
r_int
r_char
id|address
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*BMS the next line is CRUCIAL or you may be sad when you */
multiline_comment|/*BMS ifconfig tr down or hot unplug a PCMCIA card ??hownowbrowncow*/
r_if
c_cond
(paren
multiline_comment|/*BMSHELPdev-&gt;start == 0 ||*/
id|ti-&gt;open_status
op_ne
id|OPEN
)paren
r_return
suffix:semicolon
id|address
(braket
l_int|0
)braket
op_assign
id|address
(braket
l_int|1
)braket
op_assign
id|address
(braket
l_int|2
)braket
op_assign
id|address
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|address
(braket
l_int|0
)braket
op_or_assign
id|mclist-&gt;dmi_addr
(braket
l_int|2
)braket
suffix:semicolon
id|address
(braket
l_int|1
)braket
op_or_assign
id|mclist-&gt;dmi_addr
(braket
l_int|3
)braket
suffix:semicolon
id|address
(braket
l_int|2
)braket
op_or_assign
id|mclist-&gt;dmi_addr
(braket
l_int|4
)braket
suffix:semicolon
id|address
(braket
l_int|3
)braket
op_or_assign
id|mclist-&gt;dmi_addr
(braket
l_int|5
)braket
suffix:semicolon
id|mclist
op_assign
id|mclist-&gt;next
suffix:semicolon
)brace
id|SET_PAGE
c_func
(paren
id|ti-&gt;srb_page
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
r_struct
id|srb_set_funct_addr
)paren
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
l_int|0
comma
id|ti-&gt;srb
op_plus
id|i
)paren
suffix:semicolon
DECL|macro|FUNCT_ADDRESS_OFST
mdefine_line|#define FUNCT_ADDRESS_OFST 6
id|writeb
c_func
(paren
id|DIR_SET_FUNC_ADDR
comma
id|ti-&gt;srb
op_plus
id|COMMAND_OFST
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
id|address
(braket
id|i
)braket
comma
id|ti-&gt;srb
op_plus
id|FUNCT_ADDRESS_OFST
op_plus
id|i
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CMD_IN_SRB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
macro_line|#if TR_VERBOSE
id|DPRINTK
c_func
(paren
l_string|&quot;Setting functional address: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
id|address
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*****************************************************************************/
DECL|macro|STATION_ID_OFST
mdefine_line|#define STATION_ID_OFST 4
DECL|function|tok_send_packet
r_static
r_int
id|tok_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* lock against other CPUs */
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|ti-&gt;lock
)paren
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Save skb; we&squot;ll need it when the adapter asks for the data */
id|ti-&gt;current_skb
op_assign
id|skb
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;srb_page
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|XMIT_UI_FRAME
comma
id|ti-&gt;srb
op_plus
id|COMMAND_OFST
)paren
suffix:semicolon
id|writew
c_func
(paren
id|ti-&gt;exsap_station_id
comma
id|ti-&gt;srb
op_plus
id|STATION_ID_OFST
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CMD_IN_SRB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|ti-&gt;lock
)paren
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|tok_close
r_static
r_int
id|tok_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Important for PCMCIA hot unplug, otherwise, we&squot;ll pull the card, */
multiline_comment|/* unloading the module from memory, and then if a timer pops, ouch */
id|del_timer
c_func
(paren
op_amp
id|ti-&gt;tr_timer
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|ADAPTRESET
)paren
suffix:semicolon
id|ti-&gt;sram_virt
op_or_assign
l_int|1
suffix:semicolon
id|ti-&gt;open_status
op_assign
id|CLOSED
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Adapter is closed.&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|macro|RETCODE_OFST
mdefine_line|#define RETCODE_OFST&t;&t;2
DECL|macro|OPEN_ERROR_CODE_OFST
mdefine_line|#define OPEN_ERROR_CODE_OFST&t;6
DECL|macro|ASB_ADDRESS_OFST
mdefine_line|#define ASB_ADDRESS_OFST        8
DECL|macro|SRB_ADDRESS_OFST
mdefine_line|#define SRB_ADDRESS_OFST        10
DECL|macro|ARB_ADDRESS_OFST
mdefine_line|#define ARB_ADDRESS_OFST        12
DECL|macro|SSB_ADDRESS_OFST
mdefine_line|#define SSB_ADDRESS_OFST        14
DECL|variable|printphase
r_static
r_char
op_star
id|printphase
(braket
)braket
op_assign
(brace
l_string|&quot;Lobe media test&quot;
comma
l_string|&quot;Physical insertion&quot;
comma
l_string|&quot;Address verification&quot;
comma
l_string|&quot;Roll call poll&quot;
comma
l_string|&quot;Request Parameters&quot;
)brace
suffix:semicolon
DECL|variable|printerror
r_static
r_char
op_star
id|printerror
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|function|dir_open_adapter
r_void
id|dir_open_adapter
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
id|ret_code
suffix:semicolon
id|__u16
id|err
suffix:semicolon
id|ti-&gt;srb
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|SRB_ADDRESS_OFST
)paren
)paren
suffix:semicolon
id|ti-&gt;ssb
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|SSB_ADDRESS_OFST
)paren
)paren
suffix:semicolon
id|ti-&gt;arb
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|ARB_ADDRESS_OFST
)paren
)paren
suffix:semicolon
id|ti-&gt;asb
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|ASB_ADDRESS_OFST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
(brace
id|ti-&gt;srb_page
op_assign
(paren
id|ti-&gt;srb
op_rshift
l_int|8
)paren
op_amp
id|ti-&gt;page_mask
suffix:semicolon
id|ti-&gt;srb
op_and_assign
op_complement
(paren
id|ti-&gt;page_mask
op_lshift
l_int|8
)paren
suffix:semicolon
id|ti-&gt;ssb_page
op_assign
(paren
id|ti-&gt;ssb
op_rshift
l_int|8
)paren
op_amp
id|ti-&gt;page_mask
suffix:semicolon
id|ti-&gt;ssb
op_and_assign
op_complement
(paren
id|ti-&gt;page_mask
op_lshift
l_int|8
)paren
suffix:semicolon
id|ti-&gt;arb_page
op_assign
(paren
id|ti-&gt;arb
op_rshift
l_int|8
)paren
op_amp
id|ti-&gt;page_mask
suffix:semicolon
id|ti-&gt;arb
op_and_assign
op_complement
(paren
id|ti-&gt;page_mask
op_lshift
l_int|8
)paren
suffix:semicolon
id|ti-&gt;asb_page
op_assign
(paren
id|ti-&gt;asb
op_rshift
l_int|8
)paren
op_amp
id|ti-&gt;page_mask
suffix:semicolon
id|ti-&gt;asb
op_and_assign
op_complement
(paren
id|ti-&gt;page_mask
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|ti-&gt;srb
op_add_assign
id|ti-&gt;sram_virt
suffix:semicolon
id|ti-&gt;ssb
op_add_assign
id|ti-&gt;sram_virt
suffix:semicolon
id|ti-&gt;arb
op_add_assign
id|ti-&gt;sram_virt
suffix:semicolon
id|ti-&gt;asb
op_add_assign
id|ti-&gt;sram_virt
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
id|ret_code
op_assign
id|readb
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|RETCODE_OFST
)paren
suffix:semicolon
id|err
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|OPEN_ERROR_CODE_OFST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret_code
)paren
(brace
id|ti-&gt;open_status
op_assign
id|OPEN
suffix:semicolon
multiline_comment|/* TR adapter is now available */
r_if
c_cond
(paren
id|ti-&gt;open_mode
op_eq
id|AUTOMATIC
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Adapter reopened.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
op_complement
id|SRB_RESP_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
id|open_sap
c_func
(paren
id|EXTENDED_SAP
comma
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ti-&gt;open_failure
op_assign
id|YES
suffix:semicolon
r_if
c_cond
(paren
id|ret_code
op_eq
l_int|7
)paren
(brace
r_if
c_cond
(paren
id|err
op_eq
l_int|0x24
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ti-&gt;auto_speedsave
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Open failed: Adapter speed must match &quot;
l_string|&quot;ring speed if Automatic Ring Speed Save is &quot;
l_string|&quot;disabled.&bslash;n&quot;
)paren
suffix:semicolon
id|ti-&gt;open_action
op_assign
id|FAIL
suffix:semicolon
)brace
r_else
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Retrying open to adjust to &quot;
l_string|&quot;ring speed, &quot;
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|err
op_eq
l_int|0x2d
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Physical Insertion: No Monitor Detected, &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;retrying after %ds delay...&bslash;n&quot;
comma
id|TR_RETRY_INTERVAL
op_div
id|HZ
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|err
op_eq
l_int|0x11
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Lobe Media Function Failure (0x11), &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; retrying after %ds delay...&bslash;n&quot;
comma
id|TR_RETRY_INTERVAL
op_div
id|HZ
)paren
suffix:semicolon
)brace
r_else
(brace
r_char
op_star
op_star
id|prphase
op_assign
id|printphase
suffix:semicolon
r_char
op_star
op_star
id|prerror
op_assign
id|printerror
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;TR Adapter misc open failure, error code = &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;0x%x, Phase: %s, Error: %s&bslash;n&quot;
comma
id|err
comma
id|prphase
(braket
id|err
op_div
l_int|16
op_minus
l_int|1
)braket
comma
id|prerror
(braket
id|err
op_mod
l_int|16
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; retrying after %ds delay...&bslash;n&quot;
comma
id|TR_RETRY_INTERVAL
op_div
id|HZ
)paren
suffix:semicolon
)brace
)brace
r_else
id|DPRINTK
c_func
(paren
l_string|&quot;open failed: ret_code = %02X..., &quot;
comma
id|ret_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;open_action
op_ne
id|FAIL
)paren
(brace
r_if
c_cond
(paren
id|ti-&gt;open_mode
op_eq
id|AUTOMATIC
)paren
(brace
id|ti-&gt;open_action
op_assign
id|REOPEN
suffix:semicolon
id|ibmtr_reset_timer
c_func
(paren
op_amp
(paren
id|ti-&gt;tr_timer
)paren
comma
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|wake_up
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;FAILURE, CAPUT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
DECL|function|tok_interrupt
r_void
id|tok_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
multiline_comment|/*  unsigned char status_even ; */
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
macro_line|#ifdef ENABLE_PAGING
r_int
r_char
id|save_srpr
suffix:semicolon
macro_line|#endif
id|dev
op_assign
id|dev_id
suffix:semicolon
macro_line|#if TR_VERBOSE
id|DPRINTK
c_func
(paren
l_string|&quot;Int from tok_driver, dev : %p irq%d regs=%p&bslash;n&quot;
comma
id|dev
comma
id|irq
comma
id|regs
)paren
suffix:semicolon
macro_line|#endif
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;sram_virt
op_amp
l_int|1
)paren
r_return
suffix:semicolon
multiline_comment|/* PCMCIA card extraction flag */
id|spin_lock
c_func
(paren
op_amp
(paren
id|ti-&gt;lock
)paren
)paren
suffix:semicolon
macro_line|#ifdef ENABLE_PAGING
id|save_srpr
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|SRPR_EVEN
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Disable interrupts till processing is finished */
id|writeb
c_func
(paren
(paren
op_complement
id|INT_ENABLE
)paren
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
multiline_comment|/* Reset interrupt for ISA boards */
r_if
c_cond
(paren
id|ti-&gt;adapter_int_enable
)paren
id|outb
c_func
(paren
l_int|0
comma
id|ti-&gt;adapter_int_enable
)paren
suffix:semicolon
r_else
multiline_comment|/* used for PCMCIA cards */
id|outb
c_func
(paren
l_int|0
comma
id|ti-&gt;global_int_enable
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;do_tok_int
op_eq
id|FIRST_INT
)paren
(brace
id|initial_tok_int
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef ENABLE_PAGING
id|writeb
c_func
(paren
id|save_srpr
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|SRPR_EVEN
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock
c_func
(paren
op_amp
(paren
id|ti-&gt;lock
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*  Begin interrupt handler HERE inline to avoid the extra&n;&t;    levels of logic and call depth for the original solution. */
id|status
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
multiline_comment|/*BMSstatus_even = readb (ti-&gt;mmio + ACA_OFFSET + ACA_RW + ISRP_EVEN) */
multiline_comment|/*BMSdebugprintk(&quot;tok_interrupt: ISRP_ODD = 0x%x ISRP_EVEN = 0x%x&bslash;n&quot;, */
multiline_comment|/*BMS                                       status,status_even);      */
r_if
c_cond
(paren
id|status
op_amp
id|ADAP_CHK_INT
)paren
(brace
r_int
id|i
suffix:semicolon
id|__u32
id|check_reason
suffix:semicolon
id|__u8
id|check_reason_page
op_assign
l_int|0
suffix:semicolon
id|check_reason
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|WWCR_EVEN
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
(brace
id|check_reason_page
op_assign
(paren
id|check_reason
op_rshift
l_int|8
)paren
op_amp
id|ti-&gt;page_mask
suffix:semicolon
id|check_reason
op_and_assign
op_complement
(paren
id|ti-&gt;page_mask
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|check_reason
op_add_assign
id|ti-&gt;sram_virt
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|check_reason_page
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Adapter check interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;8 reason bytes follow: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|check_reason
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|check_reason
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|writeb
c_func
(paren
op_complement
id|ADAP_CHK_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
id|status
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRA_EVEN
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ISRA_EVEN == 0x02%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|ti-&gt;open_status
op_assign
id|CLOSED
suffix:semicolon
id|ti-&gt;sap_status
op_assign
id|CLOSED
suffix:semicolon
id|ti-&gt;open_mode
op_assign
id|AUTOMATIC
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_RUNNING
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ti-&gt;open_action
op_assign
id|RESTART
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|ADAPTRESET
)paren
suffix:semicolon
id|ibmtr_reset_timer
c_func
(paren
op_amp
(paren
id|ti-&gt;tr_timer
)paren
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/*BMS try to reopen*/
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRP_EVEN
)paren
op_amp
(paren
id|TCR_INT
op_or
id|ERR_INT
op_or
id|ACCESS_INT
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;adapter error: ISRP_EVEN : %02x&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRP_EVEN
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
op_complement
(paren
id|TCR_INT
op_or
id|ERR_INT
op_or
id|ACCESS_INT
)paren
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
id|status
op_assign
id|readb
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|ISRA_EVEN
)paren
suffix:semicolon
multiline_comment|/*BMS*/
id|DPRINTK
c_func
(paren
l_string|&quot;ISRA_EVEN == 0x02%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/*BMS*/
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
macro_line|#ifdef ENABLE_PAGING
id|writeb
c_func
(paren
id|save_srpr
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|SRPR_EVEN
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock
c_func
(paren
op_amp
(paren
id|ti-&gt;lock
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SRB_RESP_INT
)paren
(brace
multiline_comment|/* SRB response */
id|SET_PAGE
c_func
(paren
id|ti-&gt;srb_page
)paren
suffix:semicolon
macro_line|#if TR_VERBOSE
id|DPRINTK
c_func
(paren
l_string|&quot;SRB resp: cmd=%02X rsp=%02X&bslash;n&quot;
comma
id|readb
c_func
(paren
id|ti-&gt;srb
)paren
comma
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|RETCODE_OFST
)paren
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;srb
)paren
)paren
(brace
multiline_comment|/* SRB command check */
r_case
id|XMIT_DIR_FRAME
suffix:colon
(brace
r_int
r_char
id|xmit_ret_code
suffix:semicolon
id|xmit_ret_code
op_assign
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|RETCODE_OFST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xmit_ret_code
op_eq
l_int|0xff
)paren
r_break
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;error on xmit_dir_frame request: %02X&bslash;n&quot;
comma
id|xmit_ret_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;current_skb
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|ti-&gt;current_skb
)paren
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*dev-&gt;tbusy = 0;*/
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;readlog_pending
)paren
id|ibmtr_readlog
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|XMIT_UI_FRAME
suffix:colon
(brace
r_int
r_char
id|xmit_ret_code
suffix:semicolon
id|xmit_ret_code
op_assign
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|RETCODE_OFST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xmit_ret_code
op_eq
l_int|0xff
)paren
r_break
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;error on xmit_ui_frame request: %02X&bslash;n&quot;
comma
id|xmit_ret_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;current_skb
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|ti-&gt;current_skb
)paren
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;readlog_pending
)paren
id|ibmtr_readlog
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|DIR_OPEN_ADAPTER
suffix:colon
id|dir_open_adapter
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DLC_OPEN_SAP
suffix:colon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|RETCODE_OFST
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;open_sap failed: ret_code = %02X, &quot;
l_string|&quot;retrying&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|RETCODE_OFST
)paren
)paren
suffix:semicolon
id|ti-&gt;open_action
op_assign
id|REOPEN
suffix:semicolon
id|ibmtr_reset_timer
c_func
(paren
op_amp
(paren
id|ti-&gt;tr_timer
)paren
comma
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ti-&gt;exsap_station_id
op_assign
id|readw
c_func
(paren
id|ti-&gt;srb
op_plus
id|STATION_ID_OFST
)paren
suffix:semicolon
id|ti-&gt;sap_status
op_assign
id|OPEN
suffix:semicolon
multiline_comment|/* TR adapter is now available */
r_if
c_cond
(paren
id|ti-&gt;open_mode
op_eq
id|MANUAL
)paren
(brace
id|wake_up
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;flags
op_or_assign
id|IFF_RUNNING
suffix:semicolon
multiline_comment|/*BMS 12/2000*/
r_break
suffix:semicolon
r_case
id|DIR_INTERRUPT
suffix:colon
r_case
id|DIR_MOD_OPEN_PARAMS
suffix:colon
r_case
id|DIR_SET_GRP_ADDR
suffix:colon
r_case
id|DIR_SET_FUNC_ADDR
suffix:colon
r_case
id|DLC_CLOSE_SAP
suffix:colon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|RETCODE_OFST
)paren
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;error on %02X: %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|COMMAND_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|RETCODE_OFST
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DIR_READ_LOG
suffix:colon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|RETCODE_OFST
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;error on dir_read_log: %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|RETCODE_OFST
)paren
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if IBMTR_DEBUG_MESSAGES
DECL|macro|LINE_ERRORS_OFST
mdefine_line|#define LINE_ERRORS_OFST                 0
DECL|macro|INTERNAL_ERRORS_OFST
mdefine_line|#define INTERNAL_ERRORS_OFST             1
DECL|macro|BURST_ERRORS_OFST
mdefine_line|#define BURST_ERRORS_OFST                2
DECL|macro|AC_ERRORS_OFST
mdefine_line|#define AC_ERRORS_OFST                   3
DECL|macro|ABORT_DELIMITERS_OFST
mdefine_line|#define ABORT_DELIMITERS_OFST            4
DECL|macro|LOST_FRAMES_OFST
mdefine_line|#define LOST_FRAMES_OFST                 6
DECL|macro|RECV_CONGEST_COUNT_OFST
mdefine_line|#define RECV_CONGEST_COUNT_OFST          7
DECL|macro|FRAME_COPIED_ERRORS_OFST
mdefine_line|#define FRAME_COPIED_ERRORS_OFST         8
DECL|macro|FREQUENCY_ERRORS_OFST
mdefine_line|#define FREQUENCY_ERRORS_OFST            9
DECL|macro|TOKEN_ERRORS_OFST
mdefine_line|#define TOKEN_ERRORS_OFST               10
id|DPRINTK
c_func
(paren
l_string|&quot;Line errors %02X, Internal errors %02X, &quot;
l_string|&quot;Burst errors %02X&bslash;n&quot;
l_string|&quot;A/C errors %02X, &quot;
l_string|&quot;Abort delimiters %02X, Lost frames %02X&bslash;n&quot;
l_string|&quot;Receive congestion count %02X, &quot;
l_string|&quot;Frame copied errors %02X&bslash;nFrequency errors %02X, &quot;
l_string|&quot;Token errors %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|LINE_ERRORS_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|INTERNAL_ERRORS_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|BURST_ERRORS_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|AC_ERRORS_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|ABORT_DELIMITERS_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|LOST_FRAMES_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|RECV_CONGEST_COUNT_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|FRAME_COPIED_ERRORS_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|FREQUENCY_ERRORS_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
op_plus
id|TOKEN_ERRORS_OFST
)paren
)paren
suffix:semicolon
macro_line|#endif
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown command %02X encountered&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;srb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* end switch SRB command check */
id|writeb
c_func
(paren
op_complement
id|SRB_RESP_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
)brace
multiline_comment|/* if SRB response */
r_if
c_cond
(paren
id|status
op_amp
id|ASB_FREE_INT
)paren
(brace
multiline_comment|/* ASB response */
id|SET_PAGE
c_func
(paren
id|ti-&gt;asb_page
)paren
suffix:semicolon
macro_line|#if TR_VERBOSE
id|DPRINTK
c_func
(paren
l_string|&quot;ASB resp: cmd=%02X&bslash;n&quot;
comma
id|readb
c_func
(paren
id|ti-&gt;asb
)paren
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;asb
)paren
)paren
(brace
multiline_comment|/* ASB command check */
r_case
id|REC_DATA
suffix:colon
r_case
id|XMIT_UI_FRAME
suffix:colon
r_case
id|XMIT_DIR_FRAME
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;unknown command in asb %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;asb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* switch ASB command check */
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;asb
op_plus
l_int|2
)paren
op_ne
l_int|0xff
)paren
multiline_comment|/* checks ret_code */
id|DPRINTK
c_func
(paren
l_string|&quot;ASB error %02X in cmd %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;asb
op_plus
l_int|2
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;asb
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
op_complement
id|ASB_FREE_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
)brace
multiline_comment|/* if ASB response */
DECL|macro|STATUS_OFST
mdefine_line|#define STATUS_OFST             6
DECL|macro|NETW_STATUS_OFST
mdefine_line|#define NETW_STATUS_OFST        6
r_if
c_cond
(paren
id|status
op_amp
id|ARB_CMD_INT
)paren
(brace
multiline_comment|/* ARB response */
id|SET_PAGE
c_func
(paren
id|ti-&gt;arb_page
)paren
suffix:semicolon
macro_line|#if TR_VERBOSE
id|DPRINTK
c_func
(paren
l_string|&quot;ARB resp: cmd=%02X&bslash;n&quot;
comma
id|readb
c_func
(paren
id|ti-&gt;arb
)paren
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;arb
)paren
)paren
(brace
multiline_comment|/* ARB command check */
r_case
id|DLC_STATUS
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;DLC_STATUS new status: %02X on station %02X&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
id|STATUS_OFST
)paren
)paren
comma
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
id|STATION_ID_OFST
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REC_DATA
suffix:colon
id|tr_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RING_STAT_CHANGE
suffix:colon
(brace
r_int
r_int
id|ring_status
suffix:semicolon
id|ring_status
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
id|NETW_STATUS_OFST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INIT
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;Ring Status Change...(0x%x)&bslash;n&quot;
comma
id|ring_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ring_status
op_amp
(paren
id|REMOVE_RECV
op_or
id|AUTO_REMOVAL
op_or
id|LOBE_FAULT
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_RUNNING
suffix:semicolon
multiline_comment|/*not typical Linux*/
id|DPRINTK
c_func
(paren
l_string|&quot;Remove received, or Auto-removal error&quot;
l_string|&quot;, or Lobe fault&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;We&squot;ll try to reopen the closed adapter&quot;
l_string|&quot; after a %d second delay.&bslash;n&quot;
comma
id|TR_RETRY_INTERVAL
op_div
id|HZ
)paren
suffix:semicolon
multiline_comment|/*I was confused: I saw the TR reopening but */
multiline_comment|/*forgot:with an RJ45 in an RJ45/ICS adapter */
multiline_comment|/*but adapter not in the ring, the TR will   */
multiline_comment|/* open, and then soon close and come here.  */
id|ti-&gt;open_mode
op_assign
id|AUTOMATIC
suffix:semicolon
id|ti-&gt;open_status
op_assign
id|CLOSED
suffix:semicolon
multiline_comment|/*12/2000 BMS*/
id|ti-&gt;open_action
op_assign
id|REOPEN
suffix:semicolon
id|ibmtr_reset_timer
c_func
(paren
op_amp
(paren
id|ti-&gt;tr_timer
)paren
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ring_status
op_amp
id|LOG_OVERFLOW
)paren
(brace
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
id|ti-&gt;readlog_pending
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|ibmtr_readlog
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|XMIT_DATA_REQ
suffix:colon
id|tr_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown command %02X in arb&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;arb
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch ARB command check */
id|writeb
c_func
(paren
op_complement
id|ARB_CMD_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|ARB_FREE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
)brace
multiline_comment|/* if ARB response */
r_if
c_cond
(paren
id|status
op_amp
id|SSB_RESP_INT
)paren
(brace
multiline_comment|/* SSB response */
r_int
r_char
id|retcode
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;ssb_page
)paren
suffix:semicolon
macro_line|#if TR_VERBOSE
id|DPRINTK
c_func
(paren
l_string|&quot;SSB resp: cmd=%02X rsp=%02X&bslash;n&quot;
comma
id|readb
c_func
(paren
id|ti-&gt;ssb
)paren
comma
id|readb
c_func
(paren
id|ti-&gt;ssb
op_plus
l_int|2
)paren
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;ssb
)paren
)paren
(brace
multiline_comment|/* SSB command check */
r_case
id|XMIT_DIR_FRAME
suffix:colon
r_case
id|XMIT_UI_FRAME
suffix:colon
id|retcode
op_assign
id|readb
c_func
(paren
id|ti-&gt;ssb
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retcode
op_logical_and
(paren
id|retcode
op_ne
l_int|0x22
)paren
)paren
multiline_comment|/* checks ret_code */
id|DPRINTK
c_func
(paren
l_string|&quot;xmit ret_code: %02X xmit error code: &quot;
l_string|&quot;%02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|retcode
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;ssb
op_plus
l_int|6
)paren
)paren
suffix:semicolon
r_else
id|ti-&gt;tr_stats.tx_packets
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XMIT_XID_CMD
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;xmit xid ret_code: %02X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;ssb
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Unknown command %02X in ssb&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;ssb
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* SSB command check */
id|writeb
c_func
(paren
op_complement
id|SSB_RESP_INT
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RESET
op_plus
id|ISRP_ODD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|SSB_FREE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
)brace
multiline_comment|/* if SSB response */
macro_line|#ifdef ENABLE_PAGING
id|writeb
c_func
(paren
id|save_srpr
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|SRPR_EVEN
)paren
suffix:semicolon
macro_line|#endif
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
(paren
id|ti-&gt;lock
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*tok_interrupt */
multiline_comment|/*****************************************************************************/
DECL|macro|INIT_STATUS_OFST
mdefine_line|#define INIT_STATUS_OFST        1
DECL|macro|INIT_STATUS_2_OFST
mdefine_line|#define INIT_STATUS_2_OFST      2
DECL|macro|ENCODED_ADDRESS_OFST
mdefine_line|#define ENCODED_ADDRESS_OFST    8
DECL|function|initial_tok_int
r_static
r_void
id|initial_tok_int
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|__u32
id|encoded_addr
comma
id|hw_encoded_addr
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
r_int
r_char
id|init_status
suffix:semicolon
multiline_comment|/*BMS 12/2000*/
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ti-&gt;do_tok_int
op_assign
id|NOT_FIRST
suffix:semicolon
multiline_comment|/* we assign the shared-ram address for ISA devices */
id|writeb
c_func
(paren
id|ti-&gt;sram_base
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|RRR_EVEN
)paren
suffix:semicolon
macro_line|#ifndef PCMCIA
id|ti-&gt;sram_virt
op_assign
(paren
id|u32
)paren
id|ioremap
c_func
(paren
(paren
(paren
id|__u32
)paren
id|ti-&gt;sram_base
op_lshift
l_int|12
)paren
comma
id|ti-&gt;avail_shared_ram
)paren
suffix:semicolon
macro_line|#endif
id|ti-&gt;init_srb
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|WRBR_EVEN
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
(brace
id|ti-&gt;init_srb_page
op_assign
(paren
id|ti-&gt;init_srb
op_rshift
l_int|8
)paren
op_amp
id|ti-&gt;page_mask
suffix:semicolon
id|ti-&gt;init_srb
op_and_assign
op_complement
(paren
id|ti-&gt;page_mask
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|ti-&gt;init_srb
op_add_assign
id|ti-&gt;sram_virt
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;page_mask
op_logical_and
id|ti-&gt;avail_shared_ram
op_eq
l_int|127
)paren
(brace
r_int
id|last_512
op_assign
l_int|0xfe00
comma
id|i
suffix:semicolon
r_int
id|last_512_page
op_assign
l_int|0
suffix:semicolon
id|last_512_page
op_assign
(paren
id|last_512
op_rshift
l_int|8
)paren
op_amp
id|ti-&gt;page_mask
suffix:semicolon
id|last_512
op_and_assign
op_complement
(paren
id|ti-&gt;page_mask
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* initialize high section of ram (if necessary) */
id|SET_PAGE
c_func
(paren
id|last_512_page
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|512
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
l_int|0
comma
id|ti-&gt;sram_virt
op_plus
id|last_512
op_plus
id|i
)paren
suffix:semicolon
)brace
id|SET_PAGE
c_func
(paren
id|ti-&gt;init_srb_page
)paren
suffix:semicolon
macro_line|#if TR_VERBOSE
(brace
r_int
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ti-&gt;init_srb_page=0x%x&bslash;n&quot;
comma
id|ti-&gt;init_srb_page
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;init_srb(%x):&quot;
comma
(paren
id|ti-&gt;init_srb
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|20
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|i
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|hw_encoded_addr
op_assign
id|readw
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|ENCODED_ADDRESS_OFST
)paren
suffix:semicolon
id|encoded_addr
op_assign
id|ntohs
c_func
(paren
id|hw_encoded_addr
)paren
suffix:semicolon
id|init_status
op_assign
multiline_comment|/*BMS 12/2000 check for shallow mode possibility (Turbo)*/
id|readb
c_func
(paren
id|ti-&gt;init_srb
op_plus
m_offsetof
(paren
r_struct
id|srb_init_response
comma
id|init_status
)paren
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;Initial interrupt: init_status= 0x%02x&bslash;n&quot;,init_status);*/
id|ti-&gt;ring_speed
op_assign
id|init_status
op_amp
l_int|0x01
ques
c_cond
l_int|16
suffix:colon
l_int|4
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Initial interrupt : %d Mbps, shared RAM base %08x.&bslash;n&quot;
comma
id|ti-&gt;ring_speed
comma
(paren
r_int
r_int
)paren
id|dev-&gt;mem_start
)paren
suffix:semicolon
id|ti-&gt;auto_speedsave
op_assign
id|readb
c_func
(paren
id|ti-&gt;init_srb
op_plus
id|INIT_STATUS_2_OFST
)paren
op_amp
l_int|4
ques
c_cond
id|TRUE
suffix:colon
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;open_mode
op_eq
id|MANUAL
)paren
id|wake_up
c_func
(paren
op_amp
id|ti-&gt;wait_for_reset
)paren
suffix:semicolon
r_else
id|tok_open_adapter
c_func
(paren
(paren
r_int
r_int
)paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*initial_tok_int() */
multiline_comment|/*****************************************************************************/
DECL|macro|CMD_CORRELATE_OFST
mdefine_line|#define CMD_CORRELATE_OFST      1
DECL|macro|DHB_ADDRESS_OFST
mdefine_line|#define DHB_ADDRESS_OFST        6
DECL|macro|FRAME_LENGTH_OFST
mdefine_line|#define FRAME_LENGTH_OFST       6
DECL|macro|HEADER_LENGTH_OFST
mdefine_line|#define HEADER_LENGTH_OFST      8
DECL|macro|RSAP_VALUE_OFST
mdefine_line|#define RSAP_VALUE_OFST         9
DECL|function|tr_tx
r_static
r_void
id|tr_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|trh_hdr
op_star
id|trhdr
op_assign
(paren
r_struct
id|trh_hdr
op_star
)paren
id|ti-&gt;current_skb-&gt;data
suffix:semicolon
r_int
r_int
id|hdr_len
suffix:semicolon
id|__u32
id|dhb
op_assign
l_int|0
comma
id|dhb_base
suffix:semicolon
r_int
r_char
id|xmit_command
suffix:semicolon
r_int
id|i
comma
id|dhb_len
op_assign
l_int|0x4000
comma
id|src_len
comma
id|src_offset
suffix:semicolon
r_struct
id|trllc
op_star
id|llc
suffix:semicolon
r_struct
id|srb_xmit
id|xsrb
suffix:semicolon
id|__u8
id|dhb_page
op_assign
l_int|0
suffix:semicolon
id|__u8
id|llc_ssap
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;asb_page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;asb
op_plus
id|RETCODE_OFST
)paren
op_ne
l_int|0xFF
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;ASB not free !!!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* in providing the transmit interrupts, is telling us it is ready for&n;&t;   data and providing a shared memory address for us to stuff with data.&n;&t;   Here we compute the effective address where we will place data.&n;&t;*/
id|SET_PAGE
c_func
(paren
id|ti-&gt;arb_page
)paren
suffix:semicolon
id|dhb
op_assign
id|dhb_base
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|ti-&gt;arb
op_plus
id|DHB_ADDRESS_OFST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
(brace
id|dhb_page
op_assign
(paren
id|dhb_base
op_rshift
l_int|8
)paren
op_amp
id|ti-&gt;page_mask
suffix:semicolon
id|dhb
op_assign
id|dhb_base
op_amp
op_complement
(paren
id|ti-&gt;page_mask
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|dhb
op_add_assign
id|ti-&gt;sram_virt
suffix:semicolon
multiline_comment|/* Figure out the size of the 802.5 header */
r_if
c_cond
(paren
op_logical_neg
(paren
id|trhdr-&gt;saddr
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
)paren
multiline_comment|/* RIF present? */
id|hdr_len
op_assign
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_minus
id|TR_MAXRIFLEN
suffix:semicolon
r_else
id|hdr_len
op_assign
(paren
(paren
id|ntohs
c_func
(paren
id|trhdr-&gt;rcf
)paren
op_amp
id|TR_RCF_LEN_MASK
)paren
op_rshift
l_int|8
)paren
op_plus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_minus
id|TR_MAXRIFLEN
suffix:semicolon
id|llc
op_assign
(paren
r_struct
id|trllc
op_star
)paren
(paren
id|ti-&gt;current_skb-&gt;data
op_plus
id|hdr_len
)paren
suffix:semicolon
id|llc_ssap
op_assign
id|llc-&gt;ssap
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;srb_page
)paren
suffix:semicolon
id|memcpy_fromio
c_func
(paren
op_amp
id|xsrb
comma
id|ti-&gt;srb
comma
r_sizeof
(paren
id|xsrb
)paren
)paren
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;asb_page
)paren
suffix:semicolon
id|xmit_command
op_assign
id|xsrb.command
suffix:semicolon
id|writeb
c_func
(paren
id|xmit_command
comma
id|ti-&gt;asb
op_plus
id|COMMAND_OFST
)paren
suffix:semicolon
id|writew
c_func
(paren
id|xsrb.station_id
comma
id|ti-&gt;asb
op_plus
id|STATION_ID_OFST
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|llc_ssap
comma
id|ti-&gt;asb
op_plus
id|RSAP_VALUE_OFST
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|xsrb.cmd_corr
comma
id|ti-&gt;asb
op_plus
id|CMD_CORRELATE_OFST
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|ti-&gt;asb
op_plus
id|RETCODE_OFST
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|xmit_command
op_eq
id|XMIT_XID_CMD
)paren
op_logical_or
(paren
id|xmit_command
op_eq
id|XMIT_TEST_CMD
)paren
)paren
(brace
id|writew
c_func
(paren
id|htons
c_func
(paren
l_int|0x11
)paren
comma
id|ti-&gt;asb
op_plus
id|FRAME_LENGTH_OFST
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x0e
comma
id|ti-&gt;asb
op_plus
id|HEADER_LENGTH_OFST
)paren
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|dhb_page
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|AC
comma
id|dhb
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|LLC_FRAME
comma
id|dhb
op_plus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TR_ALEN
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
(paren
r_int
)paren
l_int|0x0FF
comma
id|dhb
op_plus
id|i
op_plus
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TR_ALEN
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
l_int|0
comma
id|dhb
op_plus
id|i
op_plus
id|TR_ALEN
op_plus
l_int|2
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|RESP_IN_ASB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *    the token ring packet is copied from sk_buff to the adapter&n;&t; *    buffer identified in the command data received with the interrupt.&n;&t; */
id|writeb
c_func
(paren
id|hdr_len
comma
id|ti-&gt;asb
op_plus
id|HEADER_LENGTH_OFST
)paren
suffix:semicolon
id|writew
c_func
(paren
id|htons
c_func
(paren
id|ti-&gt;current_skb-&gt;len
)paren
comma
id|ti-&gt;asb
op_plus
id|FRAME_LENGTH_OFST
)paren
suffix:semicolon
id|src_len
op_assign
id|ti-&gt;current_skb-&gt;len
suffix:semicolon
id|src_offset
op_assign
l_int|0
suffix:semicolon
id|dhb
op_assign
id|dhb_base
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
(brace
id|dhb_page
op_assign
(paren
id|dhb
op_rshift
l_int|8
)paren
op_amp
id|ti-&gt;page_mask
suffix:semicolon
id|dhb
op_assign
id|dhb
op_amp
op_complement
(paren
id|ti-&gt;page_mask
op_lshift
l_int|8
)paren
suffix:semicolon
id|dhb_len
op_assign
l_int|0x4000
op_minus
id|dhb
suffix:semicolon
multiline_comment|/* remaining size of this page */
)brace
id|dhb
op_add_assign
id|ti-&gt;sram_virt
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|dhb_page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|src_len
OG
id|dhb_len
)paren
(brace
id|memcpy_toio
c_func
(paren
id|dhb
comma
op_amp
id|ti-&gt;current_skb-&gt;data
(braket
id|src_offset
)braket
comma
id|dhb_len
)paren
suffix:semicolon
id|src_len
op_sub_assign
id|dhb_len
suffix:semicolon
id|src_offset
op_add_assign
id|dhb_len
suffix:semicolon
id|dhb_base
op_add_assign
id|dhb_len
suffix:semicolon
id|dhb
op_assign
id|dhb_base
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memcpy_toio
c_func
(paren
id|dhb
comma
op_amp
id|ti-&gt;current_skb-&gt;data
(braket
id|src_offset
)braket
comma
id|src_len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|RESP_IN_ASB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
id|ti-&gt;tr_stats.tx_bytes
op_add_assign
id|ti-&gt;current_skb-&gt;len
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|ti-&gt;current_skb
)paren
suffix:semicolon
id|ti-&gt;current_skb
op_assign
l_int|NULL
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;readlog_pending
)paren
id|ibmtr_readlog
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*tr_tx */
multiline_comment|/*****************************************************************************/
DECL|macro|RECEIVE_BUFFER_OFST
mdefine_line|#define RECEIVE_BUFFER_OFST     6
DECL|macro|LAN_HDR_LENGTH_OFST
mdefine_line|#define LAN_HDR_LENGTH_OFST     8
DECL|macro|DLC_HDR_LENGTH_OFST
mdefine_line|#define DLC_HDR_LENGTH_OFST     9
DECL|macro|DSAP_OFST
mdefine_line|#define DSAP_OFST               0
DECL|macro|SSAP_OFST
mdefine_line|#define SSAP_OFST               1
DECL|macro|LLC_OFST
mdefine_line|#define LLC_OFST                2
DECL|macro|PROTID_OFST
mdefine_line|#define PROTID_OFST             3
DECL|macro|ETHERTYPE_OFST
mdefine_line|#define ETHERTYPE_OFST          6
DECL|function|tr_rx
r_static
r_void
id|tr_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|__u32
id|rbuffer
comma
id|rbufdata
suffix:semicolon
id|__u8
id|rbuffer_page
op_assign
l_int|0
suffix:semicolon
id|__u32
id|llc
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
r_int
r_int
id|rbuffer_len
comma
id|lan_hdr_len
comma
id|hdr_len
comma
id|ip_len
comma
id|length
suffix:semicolon
r_int
r_char
id|dlc_hdr_len
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|skb_size
op_assign
l_int|0
suffix:semicolon
r_int
id|IPv4_p
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|chksum
op_assign
l_int|0
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|arb_rec_req
id|rarb
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;arb_page
)paren
suffix:semicolon
id|memcpy_fromio
c_func
(paren
op_amp
id|rarb
comma
id|ti-&gt;arb
comma
r_sizeof
(paren
id|rarb
)paren
)paren
suffix:semicolon
id|rbuffer
op_assign
id|ntohs
c_func
(paren
id|rarb.rec_buf_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
(brace
id|rbuffer_page
op_assign
(paren
id|rbuffer
op_rshift
l_int|8
)paren
op_amp
id|ti-&gt;page_mask
suffix:semicolon
id|rbuffer
op_and_assign
op_complement
(paren
id|ti-&gt;page_mask
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|rbuffer
op_add_assign
id|ti-&gt;sram_virt
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;asb_page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ti-&gt;asb
op_plus
id|RETCODE_OFST
)paren
op_ne
l_int|0xFF
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;ASB not free !!!&bslash;n&quot;
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|REC_DATA
comma
id|ti-&gt;asb
op_plus
id|COMMAND_OFST
)paren
suffix:semicolon
id|writew
c_func
(paren
id|rarb.station_id
comma
id|ti-&gt;asb
op_plus
id|STATION_ID_OFST
)paren
suffix:semicolon
id|writew
c_func
(paren
id|rarb.rec_buf_addr
comma
id|ti-&gt;asb
op_plus
id|RECEIVE_BUFFER_OFST
)paren
suffix:semicolon
id|lan_hdr_len
op_assign
id|rarb.lan_hdr_len
suffix:semicolon
r_if
c_cond
(paren
id|lan_hdr_len
OG
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Linux cannot handle greater than 18 bytes RIF&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*BMS I added this above just to be very safe */
id|dlc_hdr_len
op_assign
id|readb
c_func
(paren
id|ti-&gt;arb
op_plus
id|DLC_HDR_LENGTH_OFST
)paren
suffix:semicolon
id|hdr_len
op_assign
id|lan_hdr_len
op_plus
r_sizeof
(paren
r_struct
id|trllc
)paren
op_plus
r_sizeof
(paren
r_struct
id|iphdr
)paren
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|rbuffer_page
)paren
suffix:semicolon
id|llc
op_assign
(paren
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
op_plus
id|lan_hdr_len
)paren
suffix:semicolon
macro_line|#if TR_VERBOSE
id|DPRINTK
c_func
(paren
l_string|&quot;offsetof data: %02X lan_hdr_len: %02X&bslash;n&quot;
comma
(paren
id|__u32
)paren
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
comma
(paren
r_int
r_int
)paren
id|lan_hdr_len
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;llc: %08X rec_buf_addr: %04X dev-&gt;mem_start: %lX&bslash;n&quot;
comma
id|llc
comma
id|ntohs
c_func
(paren
id|rarb.rec_buf_addr
)paren
comma
id|dev-&gt;mem_start
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;dsap: %02X, ssap: %02X, llc: %02X, protid: %02X%02X%02X, &quot;
l_string|&quot;ethertype: %04X&bslash;n&quot;
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
id|DSAP_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
id|SSAP_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
id|LLC_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
id|PROTID_OFST
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
id|PROTID_OFST
op_plus
l_int|1
)paren
comma
(paren
r_int
)paren
id|readb
c_func
(paren
id|llc
op_plus
id|PROTID_OFST
op_plus
l_int|2
)paren
comma
(paren
r_int
)paren
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|llc
op_plus
id|ETHERTYPE_OFST
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|readb
c_func
(paren
id|llc
op_plus
m_offsetof
(paren
r_struct
id|trllc
comma
id|llc
)paren
)paren
op_ne
id|UI_CMD
)paren
(brace
id|SET_PAGE
c_func
(paren
id|ti-&gt;asb_page
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|DATA_LOST
comma
id|ti-&gt;asb
op_plus
id|RETCODE_OFST
)paren
suffix:semicolon
id|ti-&gt;tr_stats.rx_dropped
op_increment
suffix:semicolon
id|writeb
c_func
(paren
id|RESP_IN_ASB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|length
op_assign
id|ntohs
c_func
(paren
id|rarb.frame_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|llc
op_plus
id|DSAP_OFST
)paren
op_eq
id|EXTENDED_SAP
op_logical_and
id|readb
c_func
(paren
id|llc
op_plus
id|SSAP_OFST
)paren
op_eq
id|EXTENDED_SAP
op_logical_and
id|length
op_ge
id|hdr_len
)paren
id|IPv4_p
op_assign
l_int|1
suffix:semicolon
macro_line|#if TR_VERBOSE
DECL|macro|SADDR_OFST
mdefine_line|#define SADDR_OFST&t;8
DECL|macro|DADDR_OFST
mdefine_line|#define DADDR_OFST&t;2
r_if
c_cond
(paren
op_logical_neg
id|IPv4_p
)paren
(brace
id|__u32
id|trhhdr
suffix:semicolon
id|trhhdr
op_assign
(paren
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Probably non-IP frame received.&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ssap: %02X dsap: %02X &quot;
l_string|&quot;saddr: %02X:%02X:%02X:%02X:%02X:%02X &quot;
l_string|&quot;daddr: %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|readb
c_func
(paren
id|llc
op_plus
id|SSAP_OFST
)paren
comma
id|readb
c_func
(paren
id|llc
op_plus
id|DSAP_OFST
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|SADDR_OFST
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|SADDR_OFST
op_plus
l_int|1
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|SADDR_OFST
op_plus
l_int|2
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|SADDR_OFST
op_plus
l_int|3
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|SADDR_OFST
op_plus
l_int|4
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|SADDR_OFST
op_plus
l_int|5
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|DADDR_OFST
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|DADDR_OFST
op_plus
l_int|1
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|DADDR_OFST
op_plus
l_int|2
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|DADDR_OFST
op_plus
l_int|3
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|DADDR_OFST
op_plus
l_int|4
)paren
comma
id|readb
c_func
(paren
id|trhhdr
op_plus
id|DADDR_OFST
op_plus
l_int|5
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*BMS handle the case she comes in with few hops but leaves with many */
id|skb_size
op_assign
id|length
op_minus
id|lan_hdr_len
op_plus
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|trllc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|skb_size
)paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;out of memory. frame dropped.&bslash;n&quot;
)paren
suffix:semicolon
id|ti-&gt;tr_stats.rx_dropped
op_increment
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;asb_page
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|DATA_LOST
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_rec
comma
id|ret_code
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|RESP_IN_ASB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*BMS again, if she comes in with few but leaves with many */
id|skb_reserve
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|trh_hdr
)paren
op_minus
id|lan_hdr_len
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|data
op_assign
id|skb-&gt;data
suffix:semicolon
id|rbuffer_len
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|buf_len
)paren
)paren
)paren
suffix:semicolon
id|rbufdata
op_assign
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IPv4_p
)paren
(brace
multiline_comment|/* Copy the headers without checksumming */
id|memcpy_fromio
c_func
(paren
id|data
comma
id|rbufdata
comma
id|hdr_len
)paren
suffix:semicolon
multiline_comment|/* Watch for padded packets and bogons */
id|iph
op_assign
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|data
op_plus
id|lan_hdr_len
op_plus
r_sizeof
(paren
r_struct
id|trllc
)paren
)paren
suffix:semicolon
id|ip_len
op_assign
id|ntohs
c_func
(paren
id|iph-&gt;tot_len
)paren
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
suffix:semicolon
id|length
op_sub_assign
id|hdr_len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ip_len
op_le
id|length
)paren
op_logical_and
(paren
id|ip_len
OG
l_int|7
)paren
)paren
id|length
op_assign
id|ip_len
suffix:semicolon
id|data
op_add_assign
id|hdr_len
suffix:semicolon
id|rbuffer_len
op_sub_assign
id|hdr_len
suffix:semicolon
id|rbufdata
op_add_assign
id|hdr_len
suffix:semicolon
)brace
multiline_comment|/* Copy the payload... */
DECL|macro|BUFFER_POINTER_OFST
mdefine_line|#define BUFFER_POINTER_OFST&t;2
DECL|macro|BUFFER_LENGTH_OFST
mdefine_line|#define BUFFER_LENGTH_OFST      6
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|ibmtr_debug_trace
op_amp
id|TRC_INITV
op_logical_and
id|length
OL
id|rbuffer_len
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;CURIOUS, length=%d &lt; rbuffer_len=%d&bslash;n&quot;
comma
id|length
comma
id|rbuffer_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IPv4_p
)paren
id|chksum
op_assign
id|csum_partial_copy_nocheck
c_func
(paren
(paren
r_void
op_star
)paren
id|rbufdata
comma
id|data
comma
id|length
OL
id|rbuffer_len
ques
c_cond
id|length
suffix:colon
id|rbuffer_len
comma
id|chksum
)paren
suffix:semicolon
r_else
id|memcpy_fromio
c_func
(paren
id|data
comma
id|rbufdata
comma
id|rbuffer_len
)paren
suffix:semicolon
id|rbuffer
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|rbuffer
op_plus
id|BUFFER_POINTER_OFST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rbuffer
)paren
r_break
suffix:semicolon
id|rbuffer
op_sub_assign
l_int|2
suffix:semicolon
id|length
op_sub_assign
id|rbuffer_len
suffix:semicolon
id|data
op_add_assign
id|rbuffer_len
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
(brace
id|rbuffer_page
op_assign
(paren
id|rbuffer
op_rshift
l_int|8
)paren
op_amp
id|ti-&gt;page_mask
suffix:semicolon
id|rbuffer
op_and_assign
op_complement
(paren
id|ti-&gt;page_mask
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|rbuffer
op_add_assign
id|ti-&gt;sram_virt
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|rbuffer_page
)paren
suffix:semicolon
id|rbuffer_len
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|rbuffer
op_plus
id|BUFFER_LENGTH_OFST
)paren
)paren
suffix:semicolon
id|rbufdata
op_assign
id|rbuffer
op_plus
m_offsetof
(paren
r_struct
id|rec_buf
comma
id|data
)paren
suffix:semicolon
)brace
id|SET_PAGE
c_func
(paren
id|ti-&gt;asb_page
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|ti-&gt;asb
op_plus
m_offsetof
(paren
r_struct
id|asb_rec
comma
id|ret_code
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|RESP_IN_ASB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
id|ti-&gt;tr_stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|ti-&gt;tr_stats.rx_packets
op_increment
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|tr_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IPv4_p
)paren
(brace
id|skb-&gt;csum
op_assign
id|chksum
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
l_int|1
suffix:semicolon
)brace
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/*tr_rx */
multiline_comment|/*****************************************************************************/
DECL|function|ibmtr_reset_timer
r_void
id|ibmtr_reset_timer
c_func
(paren
r_struct
id|timer_list
op_star
id|tmr
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|tmr-&gt;expires
op_assign
id|jiffies
op_plus
id|TR_RETRY_INTERVAL
suffix:semicolon
id|tmr-&gt;data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|tmr-&gt;function
op_assign
id|tok_rerun
suffix:semicolon
id|init_timer
c_func
(paren
id|tmr
)paren
suffix:semicolon
id|add_timer
c_func
(paren
id|tmr
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|tok_rerun
r_void
(def_block
id|tok_rerun
c_func
(paren
r_int
r_int
id|dev_addr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_addr
suffix:semicolon
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;open_action
op_eq
id|RESTART
)paren
(brace
id|ti-&gt;do_tok_int
op_assign
id|FIRST_INT
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|ADAPTRESETREL
)paren
suffix:semicolon
macro_line|#ifdef ENABLE_PAGING
r_if
c_cond
(paren
id|ti-&gt;page_mask
)paren
id|writeb
c_func
(paren
id|SRPR_ENABLE_PAGING
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_RW
op_plus
id|SRPR_EVEN
)paren
suffix:semicolon
macro_line|#endif
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
)brace
r_else
id|tok_open_adapter
c_func
(paren
id|dev_addr
)paren
suffix:semicolon
)brace
)def_block
multiline_comment|/*****************************************************************************/
DECL|function|ibmtr_readlog
r_void
id|ibmtr_readlog
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
suffix:semicolon
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|ti-&gt;readlog_pending
op_assign
l_int|0
suffix:semicolon
id|SET_PAGE
c_func
(paren
id|ti-&gt;srb_page
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|DIR_READ_LOG
comma
id|ti-&gt;srb
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|INT_ENABLE
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRP_EVEN
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CMD_IN_SRB
comma
id|ti-&gt;mmio
op_plus
id|ACA_OFFSET
op_plus
id|ACA_SET
op_plus
id|ISRA_ODD
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/* tok_get_stats():  Basically a scaffold routine which will return&n;   the address of the tr_statistics structure associated with&n;   this device -- the tr.... structure is an ethnet look-alike&n;   so at least for this iteration may suffice.   */
DECL|function|tok_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|tok_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|tok_info
op_star
id|toki
suffix:semicolon
id|toki
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
(paren
r_struct
id|net_device_stats
op_star
)paren
op_amp
id|toki-&gt;tr_stats
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
DECL|function|ibmtr_change_mtu
r_int
id|ibmtr_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|mtu
)paren
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;ring_speed
op_eq
l_int|16
op_logical_and
id|mtu
OG
id|ti-&gt;maxmtu16
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;ring_speed
op_eq
l_int|4
op_logical_and
id|mtu
OG
id|ti-&gt;maxmtu4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
macro_line|#ifdef MODULE
multiline_comment|/* 3COM 3C619C supports 8 interrupts, 32 I/O ports */
DECL|variable|dev_ibmtr
r_static
r_struct
id|net_device
op_star
id|dev_ibmtr
(braket
id|IBMTR_MAX_ADAPTERS
)braket
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
(braket
id|IBMTR_MAX_ADAPTERS
)braket
op_assign
(brace
l_int|0xa20
comma
l_int|0xa24
)brace
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
(braket
id|IBMTR_MAX_ADAPTERS
)braket
suffix:semicolon
DECL|variable|mem
r_static
r_int
id|mem
(braket
id|IBMTR_MAX_ADAPTERS
)braket
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|IBMTR_MAX_ADAPTERS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|IBMTR_MAX_ADAPTERS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mem
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|IBMTR_MAX_ADAPTERS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|find_turbo_adapters
c_func
(paren
id|io
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|io
(braket
id|i
)braket
op_logical_and
(paren
id|i
OL
id|IBMTR_MAX_ADAPTERS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|irq
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|mem
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_assign
id|init_trdev
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_ibmtr
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
op_assign
id|io
(braket
id|i
)braket
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|irq
op_assign
id|irq
(braket
id|i
)braket
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|mem_start
op_assign
id|mem
(braket
id|i
)braket
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|init
op_assign
op_amp
id|ibmtr_probe
suffix:semicolon
r_if
c_cond
(paren
id|register_trdev
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
)paren
op_ne
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
)paren
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ibmtr: register_trdev() returned non-zero.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*init_module */
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IBMTR_MAX_ADAPTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev_ibmtr
(braket
id|i
)braket
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
op_plus
id|ADAPTRESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|jiffies
op_plus
id|TR_RST_TIME
suffix:semicolon
id|time_before_eq
c_func
(paren
id|jiffies
comma
id|j
)paren
suffix:semicolon
)paren
(brace
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0
comma
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
op_plus
id|ADAPTRESETREL
)paren
suffix:semicolon
)brace
id|unregister_trdev
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|irq
comma
id|dev_ibmtr
(braket
id|i
)braket
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|base_addr
comma
id|IBMTR_IO_EXTENT
)paren
suffix:semicolon
macro_line|#ifndef PCMCIA
(brace
r_struct
id|tok_info
op_star
id|ti
op_assign
(paren
r_struct
id|tok_info
op_star
)paren
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
suffix:semicolon
id|iounmap
c_func
(paren
(paren
id|u32
op_star
)paren
id|ti-&gt;mmio
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
id|u32
op_star
)paren
id|ti-&gt;sram_virt
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;
id|kfree
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
op_member_access_from_pointer
id|priv
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev_ibmtr
(braket
id|i
)braket
)paren
suffix:semicolon
id|dev_ibmtr
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* MODULE */
eof
