multiline_comment|/*&n; *   3c359.c (c) 2000 Mike Phillips (mikep@linuxtr.net) All Rights Reserved&n; *&n; *  Linux driver for 3Com 3c359 Tokenlink Velocity XL PCI NIC&n; *&n; *  Base Driver Olympic:&n; *&t;Written 1999 Peter De Schrijver &amp; Mike Phillips&n; *&n; *  This software may be used and distributed according to the terms&n; *  of the GNU General Public License, incorporated herein by reference.&n; * &n; *  7/17/00 - Clean up, version number 0.9.0. Ready to release to the world.&n; *&n; *  2/16/01 - Port up to kernel 2.4.2 ready for submission into the kernel.&n; *  3/05/01 - Last clean up stuff before submission.&n; *  2/15/01 - Finally, update to new pci api. &n; *&n; *  To Do:&n; */
multiline_comment|/* &n; *&t;Technical Card Details&n; *&n; *  All access to data is done with 16/8 bit transfers.  The transfer&n; *  method really sucks. You can only read or write one location at a time.&n; *&n; *  Also, the microcode for the card must be uploaded if the card does not have&n; *  the flashrom on board.  This is a 28K bloat in the driver when compiled&n; *  as a module.&n; *&n; *  Rx is very simple, status into a ring of descriptors, dma data transfer,&n; *  interrupts to tell us when a packet is received.&n; *&n; *  Tx is a little more interesting. Similar scenario, descriptor and dma data&n; *  transfers, but we don&squot;t have to interrupt the card to tell it another packet&n; *  is ready for transmission, we are just doing simple memory writes, not io or mmio&n; *  writes.  The card can be set up to simply poll on the next&n; *  descriptor pointer and when this value is non-zero will automatically download&n; *  the next packet.  The card then interrupts us when the packet is done.&n; *&n; */
DECL|macro|XL_DEBUG
mdefine_line|#define XL_DEBUG 0
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/trdevice.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &quot;3c359.h&quot;
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;3c359.c v1.2.0 2/17/01 - Mike Phillips (mikep@linuxtr.net)&quot;
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Mike Phillips &lt;mikep@linuxtr.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;3Com 3C359 Velocity XL Token Ring Adapter Driver &bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Module paramters */
multiline_comment|/* Ring Speed 0,4,16 &n; * 0 = Autosense   &n; * 4,16 = Selected speed only, no autosense&n; * This allows the card to be the first on the ring&n; * and become the active monitor.&n; *&n; * WARNING: Some hubs will allow you to insert&n; * at the wrong speed.&n; * &n; * The adapter will _not_ fail to open if there are no&n; * active monitors on the ring, it will simply open up in &n; * its last known ringspeed if no ringspeed is specified.&n; */
DECL|variable|ringspeed
r_static
r_int
id|ringspeed
(braket
id|XL_MAX_ADAPTERS
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ringspeed
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|XL_MAX_ADAPTERS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ringspeed
comma
l_string|&quot;3c359: Ringspeed selection - 4,16 or 0&quot;
)paren
suffix:semicolon
multiline_comment|/* Packet buffer size */
DECL|variable|pkt_buf_sz
r_static
r_int
id|pkt_buf_sz
(braket
id|XL_MAX_ADAPTERS
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pkt_buf_sz
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|XL_MAX_ADAPTERS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pkt_buf_sz
comma
l_string|&quot;3c359: Initial buffer size&quot;
)paren
suffix:semicolon
multiline_comment|/* Message Level */
DECL|variable|message_level
r_static
r_int
id|message_level
(braket
id|XL_MAX_ADAPTERS
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|message_level
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|XL_MAX_ADAPTERS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|message_level
comma
l_string|&quot;3c359: Level of reported messages &bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* &n; *&t;This is a real nasty way of doing this, but otherwise you&n; *&t;will be stuck with 1555 lines of hex #&squot;s in the code.&n; */
macro_line|#include &quot;3c359_microcode.h&quot; 
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|xl_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_3COM
comma
id|PCI_DEVICE_ID_3COM_3C359
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
)brace
multiline_comment|/* terminate list */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|xl_pci_tbl
)paren
suffix:semicolon
r_static
r_int
id|xl_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|xl_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|xl_open_hw
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|xl_hw_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|xl_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|xl_dn_comp
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|xl_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|xl_set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|xl_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|xl_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|xl_set_mac_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
suffix:semicolon
r_static
r_void
id|xl_arb_cmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|xl_asb_cmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|xl_srb_cmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|srb_cmd
)paren
suffix:semicolon
r_static
r_void
id|xl_wait_misr_flags
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|xl_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|mtu
)paren
suffix:semicolon
r_static
r_void
id|xl_srb_bh
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|xl_asb_bh
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|xl_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|xl_freemem
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* EEProm Access Functions */
r_static
id|u16
id|xl_ee_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ee_addr
)paren
suffix:semicolon
r_static
r_void
id|xl_ee_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ee_addr
comma
id|u16
id|ee_value
)paren
suffix:semicolon
multiline_comment|/* Debugging functions */
macro_line|#if XL_DEBUG
r_static
r_void
id|print_tx_state
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|print_rx_state
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|function|print_tx_state
r_static
r_void
id|print_tx_state
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|xl_tx_desc
op_star
id|txd
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tx_ring_head: %d, tx_ring_tail: %d, free_ent: %d &bslash;n&quot;
comma
id|xl_priv-&gt;tx_ring_head
comma
id|xl_priv-&gt;tx_ring_tail
comma
id|xl_priv-&gt;free_ring_entries
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Ring    , Address ,   FSH  , DnNextPtr, Buffer, Buffer_Len &bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|txd
op_assign
op_amp
(paren
id|xl_priv-&gt;xl_tx_ring
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d, %08lx, %08x, %08x, %08x, %08x &bslash;n&quot;
comma
id|i
comma
id|virt_to_bus
c_func
(paren
id|txd
)paren
comma
id|txd-&gt;framestartheader
comma
id|txd-&gt;dnnextptr
comma
id|txd-&gt;buffer
comma
id|txd-&gt;buffer_length
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;DNLISTPTR = %04x &bslash;n&quot;
comma
id|readl
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_DNLISTPTR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DmaCtl = %04x &bslash;n&quot;
comma
id|readl
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_DMA_CTRL
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Queue status = %0x &bslash;n&quot;
comma
id|netif_running
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
DECL|function|print_rx_state
r_static
r_void
id|print_rx_state
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|xl_rx_desc
op_star
id|rxd
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rx_ring_tail: %d &bslash;n&quot;
comma
id|xl_priv-&gt;rx_ring_tail
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Ring    , Address ,   FrameState  , UPNextPtr, FragAddr, Frag_Len &bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* rxd = (struct xl_rx_desc *)xl_priv-&gt;rx_ring_dma_addr + (i * sizeof(struct xl_rx_desc)) ; */
id|rxd
op_assign
op_amp
(paren
id|xl_priv-&gt;xl_rx_ring
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d, %08lx, %08x, %08x, %08x, %08x &bslash;n&quot;
comma
id|i
comma
id|virt_to_bus
c_func
(paren
id|rxd
)paren
comma
id|rxd-&gt;framestatus
comma
id|rxd-&gt;upnextptr
comma
id|rxd-&gt;upfragaddr
comma
id|rxd-&gt;upfraglen
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;UPLISTPTR = %04x &bslash;n&quot;
comma
id|readl
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_UPLISTPTR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;DmaCtl = %04x &bslash;n&quot;
comma
id|readl
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_DMA_CTRL
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Queue status = %0x &bslash;n&quot;
comma
id|netif_running
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *&t;Read values from the on-board EEProm.  This looks very strange&n; *&t;but you have to wait for the EEProm to get/set the value before &n; *&t;passing/getting the next value from the nic. As with all requests&n; *&t;on this nic it has to be done in two stages, a) tell the nic which&n; *&t;memory address you want to access and b) pass/get the value from the nic.&n; *&t;With the EEProm, you have to wait before and inbetween access a) and b).&n; *&t;As this is only read at initialization time and the wait period is very &n; *&t;small we shouldn&squot;t have to worry about scheduling issues.&n; */
DECL|function|xl_ee_read
r_static
id|u16
id|xl_ee_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ee_addr
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
multiline_comment|/* Wait for EEProm to not be busy */
id|writel
c_func
(paren
id|IO_WORD_READ
op_or
id|EECONTROL
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_amp
id|EEBUSY
)paren
suffix:semicolon
multiline_comment|/* Tell EEProm what we want to do and where */
id|writel
c_func
(paren
id|IO_WORD_WRITE
op_or
id|EECONTROL
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
id|EEREAD
op_plus
id|ee_addr
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* Wait for EEProm to not be busy */
id|writel
c_func
(paren
id|IO_WORD_READ
op_or
id|EECONTROL
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_amp
id|EEBUSY
)paren
suffix:semicolon
multiline_comment|/* Tell EEProm what we want to do and where */
id|writel
c_func
(paren
id|IO_WORD_WRITE
op_or
id|EECONTROL
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
id|EEREAD
op_plus
id|ee_addr
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* Finally read the value from the EEProm */
id|writel
c_func
(paren
id|IO_WORD_READ
op_or
id|EEDATA
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_return
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; *&t;Write values to the onboard eeprom. As with eeprom read you need to &n; *&t;set which location to write, wait, value to write, wait, with the &n; *&t;added twist of having to enable eeprom writes as well.&n; */
DECL|function|xl_ee_write
r_static
r_void
id|xl_ee_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|ee_addr
comma
id|u16
id|ee_value
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
multiline_comment|/* Wait for EEProm to not be busy */
id|writel
c_func
(paren
id|IO_WORD_READ
op_or
id|EECONTROL
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_amp
id|EEBUSY
)paren
suffix:semicolon
multiline_comment|/* Enable write/erase */
id|writel
c_func
(paren
id|IO_WORD_WRITE
op_or
id|EECONTROL
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
id|EE_ENABLE_WRITE
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* Wait for EEProm to not be busy */
id|writel
c_func
(paren
id|IO_WORD_READ
op_or
id|EECONTROL
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_amp
id|EEBUSY
)paren
suffix:semicolon
multiline_comment|/* Put the value we want to write into EEDATA */
id|writel
c_func
(paren
id|IO_WORD_WRITE
op_or
id|EEDATA
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
id|ee_value
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* Tell EEProm to write eevalue into ee_addr */
id|writel
c_func
(paren
id|IO_WORD_WRITE
op_or
id|EECONTROL
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
id|EEWRITE
op_plus
id|ee_addr
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* Wait for EEProm to not be busy, to ensure write gets done */
id|writel
c_func
(paren
id|IO_WORD_READ
op_or
id|EECONTROL
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_amp
id|EEBUSY
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|xl_probe
r_int
id|__devinit
id|xl_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|xl_private
op_star
id|xl_priv
suffix:semicolon
r_static
r_int
id|card_no
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|i
suffix:semicolon
id|card_no
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
l_string|&quot;3c359&quot;
)paren
)paren
)paren
(brace
r_return
id|i
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* &n;&t; * Allowing init_trdev to allocate the dev-&gt;priv structure will align xl_private&n;   &t; * on a 32 bytes boundary which we need for the rx/tx descriptors&n;&t; */
id|dev
op_assign
id|alloc_trdev
c_func
(paren
r_sizeof
(paren
r_struct
id|xl_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|xl_priv
op_assign
id|dev-&gt;priv
suffix:semicolon
macro_line|#if XL_DEBUG  
id|printk
c_func
(paren
l_string|&quot;pci_device: %p, dev:%p, dev-&gt;priv: %p, ba[0]: %10x, ba[1]:%10x&bslash;n&quot;
comma
id|pdev
comma
id|dev
comma
id|dev-&gt;priv
comma
(paren
r_int
r_int
)paren
id|pdev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
(paren
r_int
r_int
)paren
id|pdev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
)paren
suffix:semicolon
macro_line|#endif 
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Must be null with new api, otherwise get called twice */
id|xl_priv-&gt;xl_card_name
op_assign
(paren
r_char
op_star
)paren
id|pdev-&gt;name
suffix:semicolon
id|xl_priv-&gt;xl_mmio
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
comma
id|XL_IO_SPACE
)paren
suffix:semicolon
id|xl_priv-&gt;pdev
op_assign
id|pdev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pkt_buf_sz
(braket
id|card_no
)braket
OL
l_int|100
)paren
op_logical_or
(paren
id|pkt_buf_sz
(braket
id|card_no
)braket
OG
l_int|18000
)paren
)paren
id|xl_priv-&gt;pkt_buf_sz
op_assign
id|PKT_BUF_SZ
suffix:semicolon
r_else
id|xl_priv-&gt;pkt_buf_sz
op_assign
id|pkt_buf_sz
(braket
id|card_no
)braket
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|xl_priv-&gt;pkt_buf_sz
op_minus
id|TR_HLEN
suffix:semicolon
id|xl_priv-&gt;xl_ring_speed
op_assign
id|ringspeed
(braket
id|card_no
)braket
suffix:semicolon
id|xl_priv-&gt;xl_message_level
op_assign
id|message_level
(braket
id|card_no
)braket
suffix:semicolon
id|xl_priv-&gt;xl_functional_addr
(braket
l_int|0
)braket
op_assign
id|xl_priv-&gt;xl_functional_addr
(braket
l_int|1
)braket
op_assign
id|xl_priv-&gt;xl_functional_addr
(braket
l_int|2
)braket
op_assign
id|xl_priv-&gt;xl_functional_addr
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|xl_priv-&gt;xl_copy_all_options
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|xl_init
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|iounmap
c_func
(paren
id|xl_priv-&gt;xl_mmio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
id|dev-&gt;open
op_assign
op_amp
id|xl_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|xl_xmit
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
op_amp
id|xl_change_mtu
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|xl_close
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|xl_set_rx_mode
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|xl_get_stats
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
op_amp
id|xl_set_mac_address
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;3C359, register netdev failed&bslash;n&quot;
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|xl_priv-&gt;xl_mmio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;3C359: %s registered as: %s&bslash;n&quot;
comma
id|xl_priv-&gt;xl_card_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|xl_init
r_static
r_int
id|__init
id|xl_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s &bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: I/O at %hx, MMIO at %p, using irq %d&bslash;n&quot;
comma
id|xl_priv-&gt;xl_card_name
comma
(paren
r_int
r_int
)paren
id|dev-&gt;base_addr
comma
id|xl_priv-&gt;xl_mmio
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|xl_priv-&gt;xl_lock
)paren
suffix:semicolon
r_return
id|xl_hw_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; *&t;Hardware reset.  This needs to be a separate entity as we need to reset the card&n; *&t;when we change the EEProm settings.&n; */
DECL|function|xl_hw_reset
r_static
r_int
id|xl_hw_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
r_int
r_int
id|t
suffix:semicolon
id|u16
id|i
suffix:semicolon
id|u16
id|result_16
suffix:semicolon
id|u8
id|result_8
suffix:semicolon
id|u16
id|start
suffix:semicolon
r_int
id|j
suffix:semicolon
multiline_comment|/*&n;&t; *  Reset the card.  If the card has got the microcode on board, we have &n;         *  missed the initialization interrupt, so we must always do this.&n;&t; */
id|writew
c_func
(paren
id|GLOBAL_RESET
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Must wait for cmdInProgress bit (12) to clear before continuing with&n;&t; * card configuration.&n;&t; */
id|t
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS
)paren
op_amp
id|INTSTAT_CMD_IN_PROGRESS
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t
OG
l_int|40
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: 3COM 3C359 Velocity XL  card not responding to global reset.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *  Enable pmbar by setting bit in CPAttention&n;&t; */
id|writel
c_func
(paren
(paren
id|IO_BYTE_READ
op_or
id|CPATTENTION
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|result_8
op_assign
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|result_8
op_assign
id|result_8
op_or
id|CPA_PMBARVIS
suffix:semicolon
id|writel
c_func
(paren
(paren
id|IO_BYTE_WRITE
op_or
id|CPATTENTION
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|result_8
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Read cpHold bit in pmbar, if cleared we have got Flashrom on board.&n; &t; * If not, we need to upload the microcode to the card&n;&t; */
id|writel
c_func
(paren
(paren
id|IO_WORD_READ
op_or
id|PMBAR
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
macro_line|#if XL_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Read from PMBAR = %04x &bslash;n&quot;
comma
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|readw
c_func
(paren
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
)paren
op_amp
id|PMB_CPHOLD
)paren
(brace
multiline_comment|/* Set PmBar, privateMemoryBase bits (8:2) to 0 */
id|writel
c_func
(paren
(paren
id|IO_WORD_READ
op_or
id|PMBAR
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|result_16
op_assign
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|result_16
op_assign
id|result_16
op_amp
op_complement
(paren
(paren
l_int|0x7F
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|IO_WORD_WRITE
op_or
id|PMBAR
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
id|result_16
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* Set CPAttention, memWrEn bit */
id|writel
c_func
(paren
(paren
id|IO_BYTE_READ
op_or
id|CPATTENTION
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|result_8
op_assign
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|result_8
op_assign
id|result_8
op_or
id|CPA_MEMWREN
suffix:semicolon
id|writel
c_func
(paren
(paren
id|IO_BYTE_WRITE
op_or
id|CPATTENTION
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|result_8
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Now to write the microcode into the shared ram &n;&t; &t; * The microcode must finish at position 0xFFFF, so we must subtract&n;&t;&t; * to get the start position for the code&n;&t;&t; */
id|start
op_assign
(paren
l_int|0xFFFF
op_minus
(paren
id|mc_size
)paren
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Looks strange but ensures compiler only uses 16 bit unsigned int for this */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;3C359: Uploading Microcode: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|start
comma
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
id|mc_size
op_logical_and
id|i
op_le
l_int|0xffff
)paren
suffix:semicolon
id|i
op_increment
comma
id|j
op_increment
)paren
(brace
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0XD0000
op_or
id|i
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|microcode
(braket
id|j
)braket
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_mod
l_int|1024
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xDFFF0
)paren
op_plus
id|i
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|microcode
(braket
id|mc_size
op_minus
l_int|16
op_plus
id|i
)braket
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Have to write the start address of the upload to FFF4, but&n;                 * the address must be &gt;&gt; 4. You do not want to know how long&n;                 * it took me to discover this.&n;&t;&t; */
id|writel
c_func
(paren
id|MEM_WORD_WRITE
op_or
l_int|0xDFFF4
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
id|start
op_rshift
l_int|4
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* Clear the CPAttention, memWrEn Bit */
id|writel
c_func
(paren
(paren
id|IO_BYTE_READ
op_or
id|CPATTENTION
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|result_8
op_assign
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|result_8
op_assign
id|result_8
op_amp
op_complement
id|CPA_MEMWREN
suffix:semicolon
id|writel
c_func
(paren
(paren
id|IO_BYTE_WRITE
op_or
id|CPATTENTION
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|result_8
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* Clear the cpHold bit in pmbar */
id|writel
c_func
(paren
(paren
id|IO_WORD_READ
op_or
id|PMBAR
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|result_16
op_assign
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|result_16
op_assign
id|result_16
op_amp
op_complement
id|PMB_CPHOLD
suffix:semicolon
id|writel
c_func
(paren
(paren
id|IO_WORD_WRITE
op_or
id|PMBAR
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
id|result_16
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
)brace
multiline_comment|/* If microcode upload required */
multiline_comment|/* &n;&t; * The card should now go though a self test procedure and get itself ready&n;         * to be opened, we must wait for an srb response with the initialization&n;         * information. &n;&t; */
macro_line|#if XL_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Microcode uploaded, must wait for the self test to complete&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|writew
c_func
(paren
id|SETINDENABLE
op_or
l_int|0xFFF
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|t
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS_AUTO
)paren
op_amp
id|INTSTAT_SRB
)paren
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t
OG
l_int|15
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;3COM 3C359 Velocity XL  card not responding.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Write the RxBufArea with D000, RxEarlyThresh, TxStartThresh, &n; &t; * DnPriReqThresh, read the tech docs if you want to know what&n;&t; * values they need to be.&n;&t; */
id|writel
c_func
(paren
id|MMIO_WORD_WRITE
op_or
id|RXBUFAREA
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0xD000
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MMIO_WORD_WRITE
op_or
id|RXEARLYTHRESH
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0X0020
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writew
c_func
(paren
id|SETTXSTARTTHRESH
op_or
l_int|0x40
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x04
comma
id|xl_mmio
op_plus
id|MMIO_DNBURSTTHRESH
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x04
comma
id|xl_mmio
op_plus
id|DNPRIREQTHRESH
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Read WRBR to provide the location of the srb block, have to use byte reads not word reads. &n;&t; * Tech docs have this wrong !!!!&n;&t; */
id|writel
c_func
(paren
id|MMIO_BYTE_READ
op_or
id|WRBR
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|xl_priv-&gt;srb
op_assign
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_lshift
l_int|8
suffix:semicolon
id|writel
c_func
(paren
(paren
id|MMIO_BYTE_READ
op_or
id|WRBR
)paren
op_plus
l_int|1
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|xl_priv-&gt;srb
op_assign
id|xl_priv-&gt;srb
op_or
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
macro_line|#if XL_DEBUG
id|writel
c_func
(paren
id|IO_WORD_READ
op_or
id|SWITCHSETTINGS
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_amp
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Default ring speed 4 mbps &bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Default ring speed 16 mbps &bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: xl_priv-&gt;srb = %04x&bslash;n&quot;
comma
id|xl_priv-&gt;xl_card_name
comma
id|xl_priv-&gt;srb
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|xl_open
r_static
r_int
id|xl_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
id|u8
id|i
suffix:semicolon
id|u16
id|hwaddr
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Should be u8[6] but we get word return values */
r_int
id|open_err
suffix:semicolon
id|u16
id|switchsettings
comma
id|switchsettings_eeprom
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|xl_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;3c359&quot;
comma
id|dev
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * Read the information from the EEPROM that we need. I know we&n; &t; * should use ntohs, but the word gets stored reversed in the 16&n;&t; * bit field anyway and it all works its self out when we memcpy&n;&t; * it into dev-&gt;dev_addr. &n;&t; */
id|hwaddr
(braket
l_int|0
)braket
op_assign
id|xl_ee_read
c_func
(paren
id|dev
comma
l_int|0x10
)paren
suffix:semicolon
id|hwaddr
(braket
l_int|1
)braket
op_assign
id|xl_ee_read
c_func
(paren
id|dev
comma
l_int|0x11
)paren
suffix:semicolon
id|hwaddr
(braket
l_int|2
)braket
op_assign
id|xl_ee_read
c_func
(paren
id|dev
comma
l_int|0x12
)paren
suffix:semicolon
multiline_comment|/* Ring speed */
id|switchsettings_eeprom
op_assign
id|xl_ee_read
c_func
(paren
id|dev
comma
l_int|0x08
)paren
suffix:semicolon
id|switchsettings
op_assign
id|switchsettings_eeprom
suffix:semicolon
r_if
c_cond
(paren
id|xl_priv-&gt;xl_ring_speed
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|xl_priv-&gt;xl_ring_speed
op_eq
l_int|4
)paren
id|switchsettings
op_assign
id|switchsettings
op_or
l_int|0x02
suffix:semicolon
r_else
id|switchsettings
op_assign
id|switchsettings
op_amp
op_complement
l_int|0x02
suffix:semicolon
)brace
multiline_comment|/* Only write EEProm if there has been a change */
r_if
c_cond
(paren
id|switchsettings
op_ne
id|switchsettings_eeprom
)paren
(brace
id|xl_ee_write
c_func
(paren
id|dev
comma
l_int|0x08
comma
id|switchsettings
)paren
suffix:semicolon
multiline_comment|/* Hardware reset after changing EEProm */
id|xl_hw_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|hwaddr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
id|open_err
op_assign
id|xl_open_hw
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * This really needs to be cleaned up with better error reporting.&n;&t; */
r_if
c_cond
(paren
id|open_err
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Something went wrong with the open command */
r_if
c_cond
(paren
id|open_err
op_amp
l_int|0x07
)paren
(brace
multiline_comment|/* Wrong speed, retry at different speed */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Open Error, retrying at different ringspeed &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|switchsettings
op_assign
id|switchsettings
op_xor
l_int|2
suffix:semicolon
id|xl_ee_write
c_func
(paren
id|dev
comma
l_int|0x08
comma
id|switchsettings
)paren
suffix:semicolon
id|xl_hw_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|open_err
op_assign
id|xl_open_hw
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|open_err
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Open error returned a second time, we&squot;re bombing out now&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Open Error = %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|open_err
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Now to set up the Rx and Tx buffer structures&n;&t; */
multiline_comment|/* These MUST be on 8 byte boundaries */
id|xl_priv-&gt;xl_tx_ring
op_assign
id|kmalloc
c_func
(paren
(paren
r_sizeof
(paren
r_struct
id|xl_tx_desc
)paren
op_star
id|XL_TX_RING_SIZE
)paren
op_plus
l_int|7
comma
id|GFP_DMA
op_or
id|GFP_KERNEL
)paren
suffix:semicolon
id|xl_priv-&gt;xl_rx_ring
op_assign
id|kmalloc
c_func
(paren
(paren
r_sizeof
(paren
r_struct
id|xl_rx_desc
)paren
op_star
id|XL_RX_RING_SIZE
)paren
op_plus
l_int|7
comma
id|GFP_DMA
op_or
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|xl_priv-&gt;xl_tx_ring
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|xl_tx_desc
)paren
op_star
id|XL_TX_RING_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|xl_priv-&gt;xl_rx_ring
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|xl_rx_desc
)paren
op_star
id|XL_RX_RING_SIZE
)paren
suffix:semicolon
multiline_comment|/* Setup Rx Ring */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|XL_RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|xl_priv-&gt;pkt_buf_sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|xl_priv-&gt;xl_rx_ring
(braket
id|i
)braket
dot
id|upfragaddr
op_assign
id|pci_map_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|skb-&gt;data
comma
id|xl_priv-&gt;pkt_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|xl_priv-&gt;xl_rx_ring
(braket
id|i
)braket
dot
id|upfraglen
op_assign
id|xl_priv-&gt;pkt_buf_sz
op_or
id|RXUPLASTFRAG
suffix:semicolon
id|xl_priv-&gt;rx_ring_skb
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Not enough memory to allocate rx buffers. Adapter disabled &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|xl_priv-&gt;rx_ring_no
op_assign
id|i
suffix:semicolon
id|xl_priv-&gt;rx_ring_tail
op_assign
l_int|0
suffix:semicolon
id|xl_priv-&gt;rx_ring_dma_addr
op_assign
id|pci_map_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|xl_priv-&gt;xl_rx_ring
comma
r_sizeof
(paren
r_struct
id|xl_rx_desc
)paren
op_star
id|XL_RX_RING_SIZE
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|xl_priv-&gt;rx_ring_no
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|xl_priv-&gt;xl_rx_ring
(braket
id|i
)braket
dot
id|upnextptr
op_assign
id|xl_priv-&gt;rx_ring_dma_addr
op_plus
(paren
r_sizeof
(paren
r_struct
id|xl_rx_desc
)paren
op_star
(paren
id|i
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
id|xl_priv-&gt;xl_rx_ring
(braket
id|i
)braket
dot
id|upnextptr
op_assign
l_int|0
suffix:semicolon
id|writel
c_func
(paren
id|xl_priv-&gt;rx_ring_dma_addr
comma
id|xl_mmio
op_plus
id|MMIO_UPLISTPTR
)paren
suffix:semicolon
multiline_comment|/* Setup Tx Ring */
id|xl_priv-&gt;tx_ring_dma_addr
op_assign
id|pci_map_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|xl_priv-&gt;xl_tx_ring
comma
r_sizeof
(paren
r_struct
id|xl_tx_desc
)paren
op_star
id|XL_TX_RING_SIZE
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|xl_priv-&gt;tx_ring_head
op_assign
l_int|1
suffix:semicolon
id|xl_priv-&gt;tx_ring_tail
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* Special marker for first packet */
id|xl_priv-&gt;free_ring_entries
op_assign
id|XL_TX_RING_SIZE
suffix:semicolon
multiline_comment|/*&n; &t; * Setup the first dummy DPD entry for polling to start working.&n;&t; */
id|xl_priv-&gt;xl_tx_ring
(braket
l_int|0
)braket
dot
id|framestartheader
op_assign
id|TXDPDEMPTY
suffix:semicolon
id|xl_priv-&gt;xl_tx_ring
(braket
l_int|0
)braket
dot
id|buffer
op_assign
l_int|0
suffix:semicolon
id|xl_priv-&gt;xl_tx_ring
(braket
l_int|0
)braket
dot
id|buffer_length
op_assign
l_int|0
suffix:semicolon
id|xl_priv-&gt;xl_tx_ring
(braket
l_int|0
)braket
dot
id|dnnextptr
op_assign
l_int|0
suffix:semicolon
id|writel
c_func
(paren
id|xl_priv-&gt;tx_ring_dma_addr
comma
id|xl_mmio
op_plus
id|MMIO_DNLISTPTR
)paren
suffix:semicolon
id|writel
c_func
(paren
id|DNUNSTALL
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|writel
c_func
(paren
id|UPUNSTALL
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|writel
c_func
(paren
id|DNENABLE
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x40
comma
id|xl_mmio
op_plus
id|MMIO_DNPOLL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Enable interrupts on the card&n;&t; */
id|writel
c_func
(paren
id|SETINTENABLE
op_or
id|INT_MASK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|writel
c_func
(paren
id|SETINDENABLE
op_or
id|INT_MASK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|xl_open_hw
r_static
r_int
id|xl_open_hw
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
id|u16
id|vsoff
suffix:semicolon
r_char
id|ver_str
(braket
l_int|33
)braket
suffix:semicolon
r_int
id|open_err
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|t
suffix:semicolon
multiline_comment|/*&n;&t; * Okay, let&squot;s build up the Open.NIC srb command&n;&t; *&n;&t; */
id|writel
c_func
(paren
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|OPEN_NIC
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Use this as a test byte, if it comes back with the same value, the command didn&squot;t work&n;&t; */
id|writel
c_func
(paren
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
l_int|2
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xff
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* Open options */
id|writel
c_func
(paren
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
l_int|8
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
l_int|9
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Node address, be careful here, the docs say you can just put zeros here and it will use&n;&t; * the hardware address, it doesn&squot;t, you must include the node address in the open command.&n;&t; */
r_if
c_cond
(paren
id|xl_priv-&gt;xl_laa
(braket
l_int|0
)braket
)paren
(brace
multiline_comment|/* If using a LAA address */
r_for
c_loop
(paren
id|i
op_assign
l_int|10
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
id|i
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|xl_priv-&gt;xl_laa
(braket
id|i
)braket
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|xl_priv-&gt;xl_laa
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Regular hardware address */
r_for
c_loop
(paren
id|i
op_assign
l_int|10
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
id|i
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
op_minus
l_int|10
)braket
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Default everything else to 0 */
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OL
l_int|34
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
id|i
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Set the csrb bit in the MISR register&n;&t; */
id|xl_wait_misr_flags
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
id|MF_CSRB
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xFF
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MMIO_BYTE_WRITE
op_or
id|MISR_SET
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MISR_CSRB
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now wait for the command to run&n;&t; */
id|t
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS
)paren
op_amp
id|INTSTAT_SRB
)paren
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t
OG
l_int|40
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;3COM 3C359 Velocity XL  card not responding.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Let&squot;s interpret the open response&n;&t; */
id|writel
c_func
(paren
(paren
id|MEM_BYTE_READ
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
l_int|2
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_ne
l_int|0
)paren
(brace
id|open_err
op_assign
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_lshift
l_int|8
suffix:semicolon
id|writel
c_func
(paren
(paren
id|MEM_BYTE_READ
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
l_int|7
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|open_err
op_or_assign
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
r_return
id|open_err
suffix:semicolon
)brace
r_else
(brace
id|writel
c_func
(paren
(paren
id|MEM_WORD_READ
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
l_int|8
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|xl_priv-&gt;asb
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Adapter Opened Details: &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ASB: %04x&quot;
comma
id|xl_priv-&gt;asb
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|MEM_WORD_READ
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
l_int|10
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, SRB: %04x&quot;
comma
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|MEM_WORD_READ
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
l_int|12
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|xl_priv-&gt;arb
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, ARB: %04x &bslash;n&quot;
comma
id|xl_priv-&gt;arb
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|MEM_WORD_READ
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
l_int|14
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|vsoff
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Interesting, sending the individual characters directly to printk was causing klogd to use&n;&t;&t; * use 100% of processor time, so we build up the string and print that instead.&n;&t;   &t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x20
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
(paren
id|MEM_BYTE_READ
op_or
l_int|0xD0000
op_or
id|vsoff
)paren
op_plus
id|i
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|ver_str
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
)brace
id|ver_str
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Microcode version String: %s &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ver_str
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Issue the AckInterrupt&n;&t; */
id|writew
c_func
(paren
id|ACK_INTERRUPT
op_or
id|SRBRACK
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;There are two ways of implementing rx on the 359 NIC, either&n; * &t;interrupt driven or polling.  We are going to uses interrupts,&n; *&t;it is the easier way of doing things.&n; *&t;&n; *&t;The Rx works with a ring of Rx descriptors.  At initialise time the ring&n; *&t;entries point to the next entry except for the last entry in the ring &n; *&t;which points to 0.  The card is programmed with the location of the first&n; *&t;available descriptor and keeps reading the next_ptr until next_ptr is set&n; *&t;to 0.  Hopefully with a ring size of 16 the card will never get to read a next_ptr&n; *&t;of 0.  As the Rx interrupt is received we copy the frame up to the protocol layers&n; *&t;and then point the end of the ring to our current position and point our current&n; *&t;position to 0, therefore making the current position the last position on the ring.&n; *&t;The last position on the ring therefore loops continually loops around the rx ring.&n; *&t;&n; *&t;rx_ring_tail is the position on the ring to process next. (Think of a snake, the head &n; *&t;expands as the card adds new packets and we go around eating the tail processing the&n; *&t;packets.)&n; *&n; *&t;Undoubtably it could be streamlined and improved upon, but at the moment it works &n; *&t;and the fast path through the routine is fine. &n; *&t;&n; *&t;adv_rx_ring could be inlined to increase performance, but its called a *lot* of times&n; *&t;in xl_rx so would increase the size of the function significantly. &n; */
DECL|function|adv_rx_ring
r_static
r_void
id|adv_rx_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
multiline_comment|/* Advance rx_ring, cut down on bloat in xl_rx */
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|prev_ring_loc
suffix:semicolon
id|prev_ring_loc
op_assign
(paren
id|xl_priv-&gt;rx_ring_tail
op_plus
id|XL_RX_RING_SIZE
op_minus
l_int|1
)paren
op_amp
(paren
id|XL_RX_RING_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|xl_priv-&gt;xl_rx_ring
(braket
id|prev_ring_loc
)braket
dot
id|upnextptr
op_assign
id|xl_priv-&gt;rx_ring_dma_addr
op_plus
(paren
r_sizeof
(paren
r_struct
id|xl_rx_desc
)paren
op_star
id|xl_priv-&gt;rx_ring_tail
)paren
suffix:semicolon
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|framestatus
op_assign
l_int|0
suffix:semicolon
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|upnextptr
op_assign
l_int|0
suffix:semicolon
id|xl_priv-&gt;rx_ring_tail
op_increment
suffix:semicolon
id|xl_priv-&gt;rx_ring_tail
op_and_assign
(paren
id|XL_RX_RING_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|xl_rx
r_static
r_void
id|xl_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|skb2
suffix:semicolon
r_int
id|frame_length
op_assign
l_int|0
comma
id|copy_len
op_assign
l_int|0
suffix:semicolon
r_int
id|temp_ring_loc
suffix:semicolon
multiline_comment|/*&n;&t; * Receive the next frame, loop around the ring until all frames&n;  &t; * have been received.&n;&t; */
r_while
c_loop
(paren
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|framestatus
op_amp
(paren
id|RXUPDCOMPLETE
op_or
id|RXUPDFULL
)paren
)paren
(brace
multiline_comment|/* Descriptor to process */
r_if
c_cond
(paren
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|framestatus
op_amp
id|RXUPDFULL
)paren
(brace
multiline_comment|/* UpdFull, Multiple Descriptors used for the frame */
multiline_comment|/* &n;&t;&t;&t; * This is a pain, you need to go through all the descriptors until the last one &n;&t;&t;&t; * for this frame to find the framelength&n;&t;&t;&t; */
id|temp_ring_loc
op_assign
id|xl_priv-&gt;rx_ring_tail
suffix:semicolon
r_while
c_loop
(paren
id|xl_priv-&gt;xl_rx_ring
(braket
id|temp_ring_loc
)braket
dot
id|framestatus
op_amp
id|RXUPDFULL
)paren
(brace
id|temp_ring_loc
op_increment
suffix:semicolon
id|temp_ring_loc
op_and_assign
(paren
id|XL_RX_RING_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|frame_length
op_assign
id|xl_priv-&gt;xl_rx_ring
(braket
id|temp_ring_loc
)braket
dot
id|framestatus
op_amp
l_int|0x7FFF
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|frame_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* No memory for frame, still need to roll forward the rx ring */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: dev_alloc_skb failed - multi buffer !&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_while
c_loop
(paren
id|xl_priv-&gt;rx_ring_tail
op_ne
id|temp_ring_loc
)paren
id|adv_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|adv_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* One more time just for luck :) */
id|xl_priv-&gt;xl_stats.rx_dropped
op_increment
suffix:semicolon
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|UPCOMPACK
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
r_while
c_loop
(paren
id|xl_priv-&gt;rx_ring_tail
op_ne
id|temp_ring_loc
)paren
(brace
id|copy_len
op_assign
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|upfraglen
op_amp
l_int|0x7FFF
suffix:semicolon
id|frame_length
op_sub_assign
id|copy_len
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|upfragaddr
comma
id|xl_priv-&gt;pkt_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|copy_len
)paren
comma
id|xl_priv-&gt;rx_ring_skb
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
op_member_access_from_pointer
id|data
comma
id|copy_len
)paren
suffix:semicolon
id|adv_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Now we have found the last fragment */
id|pci_dma_sync_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|upfragaddr
comma
id|xl_priv-&gt;pkt_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|copy_len
)paren
comma
id|xl_priv-&gt;rx_ring_skb
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
op_member_access_from_pointer
id|data
comma
id|frame_length
)paren
suffix:semicolon
multiline_comment|/*&t;&t;&t;memcpy(skb_put(skb,frame_length), bus_to_virt(xl_priv-&gt;xl_rx_ring[xl_priv-&gt;rx_ring_tail].upfragaddr), frame_length) ; */
id|adv_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|tr_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Single Descriptor Used, simply swap buffers over, fast path  */
id|frame_length
op_assign
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|framestatus
op_amp
l_int|0x7FFF
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|xl_priv-&gt;pkt_buf_sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Still need to fix the rx ring */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: dev_alloc_skb failed in rx, single buffer &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|adv_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|xl_priv-&gt;xl_stats.rx_dropped
op_increment
suffix:semicolon
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|UPCOMPACK
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb2
op_assign
id|xl_priv-&gt;rx_ring_skb
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|upfragaddr
comma
id|xl_priv-&gt;pkt_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb2
comma
id|frame_length
)paren
suffix:semicolon
id|skb2-&gt;protocol
op_assign
id|tr_type_trans
c_func
(paren
id|skb2
comma
id|dev
)paren
suffix:semicolon
id|xl_priv-&gt;rx_ring_skb
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
op_assign
id|skb
suffix:semicolon
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|upfragaddr
op_assign
id|pci_map_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|skb-&gt;data
comma
id|xl_priv-&gt;pkt_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|upfraglen
op_assign
id|xl_priv-&gt;pkt_buf_sz
op_or
id|RXUPLASTFRAG
suffix:semicolon
id|adv_rx_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
id|xl_priv-&gt;xl_stats.rx_packets
op_increment
suffix:semicolon
id|xl_priv-&gt;xl_stats.rx_bytes
op_add_assign
id|frame_length
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb2
)paren
suffix:semicolon
)brace
multiline_comment|/* if multiple buffers */
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/* while packet to do */
multiline_comment|/* Clear the updComplete interrupt */
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|UPCOMPACK
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * This is ruthless, it doesn&squot;t care what state the card is in it will &n; * completely reset the adapter.&n; */
DECL|function|xl_reset
r_static
r_void
id|xl_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
r_int
r_int
id|t
suffix:semicolon
id|writew
c_func
(paren
id|GLOBAL_RESET
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Must wait for cmdInProgress bit (12) to clear before continuing with&n;&t; * card configuration.&n;&t; */
id|t
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS
)paren
op_amp
id|INTSTAT_CMD_IN_PROGRESS
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_minus
id|t
OG
l_int|40
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;3COM 3C359 Velocity XL  card not responding.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|function|xl_freemem
r_static
r_void
id|xl_freemem
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|XL_RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev_kfree_skb_irq
c_func
(paren
id|xl_priv-&gt;rx_ring_skb
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|xl_priv-&gt;xl_rx_ring
(braket
id|xl_priv-&gt;rx_ring_tail
)braket
dot
id|upfragaddr
comma
id|xl_priv-&gt;pkt_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|xl_priv-&gt;rx_ring_tail
op_increment
suffix:semicolon
id|xl_priv-&gt;rx_ring_tail
op_and_assign
id|XL_RX_RING_SIZE
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* unmap ring */
id|pci_unmap_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|xl_priv-&gt;rx_ring_dma_addr
comma
r_sizeof
(paren
r_struct
id|xl_rx_desc
)paren
op_star
id|XL_RX_RING_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|xl_priv-&gt;tx_ring_dma_addr
comma
r_sizeof
(paren
r_struct
id|xl_tx_desc
)paren
op_star
id|XL_TX_RING_SIZE
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|xl_priv-&gt;xl_rx_ring
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|xl_priv-&gt;xl_tx_ring
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|xl_interrupt
r_static
r_void
id|xl_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
id|u16
id|intstatus
comma
id|macstatus
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Device structure dead, aaahhhh !&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|intstatus
op_assign
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|intstatus
op_amp
l_int|1
)paren
)paren
multiline_comment|/* We didn&squot;t generate the interrupt */
r_return
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|xl_priv-&gt;xl_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Process the interrupt&n;&t; */
multiline_comment|/*&n;&t; * Something fishy going on here, we shouldn&squot;t get 0001 ints, not fatal though.&n;&t; */
r_if
c_cond
(paren
id|intstatus
op_eq
l_int|0x0001
)paren
(brace
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: 00001 int received &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|intstatus
op_amp
(paren
id|HOSTERRINT
op_or
id|SRBRINT
op_or
id|ARBCINT
op_or
id|UPCOMPINT
op_or
id|DNCOMPINT
op_or
id|HARDERRINT
op_or
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
id|TXUNDERRUN
op_or
id|ASBFINT
)paren
)paren
(brace
multiline_comment|/* &n;&t;&t;&t; * Host Error.&n;&t;&t;&t; * It may be possible to recover from this, but usually it means something&n;&t;&t;&t; * is seriously fubar, so we just close the adapter.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|intstatus
op_amp
id|HOSTERRINT
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Host Error, performing global reset, intstatus = %04x &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intstatus
)paren
suffix:semicolon
id|writew
c_func
(paren
id|GLOBAL_RESET
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Resetting hardware: &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|xl_freemem
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|xl_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|xl_priv-&gt;xl_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Host Error */
r_if
c_cond
(paren
id|intstatus
op_amp
id|SRBRINT
)paren
(brace
multiline_comment|/* Srbc interrupt */
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|SRBRACK
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xl_priv-&gt;srb_queued
)paren
id|xl_srb_bh
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* SRBR Interrupt */
r_if
c_cond
(paren
id|intstatus
op_amp
id|TXUNDERRUN
)paren
(brace
multiline_comment|/* Issue DnReset command */
id|writel
c_func
(paren
id|DNRESET
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS
)paren
op_amp
id|INTSTAT_CMD_IN_PROGRESS
)paren
(brace
multiline_comment|/* Wait for command to run */
multiline_comment|/* !!! FIX-ME !!!! &n;&t;&t;&t;&t;&t;Must put a timeout check here ! */
multiline_comment|/* Empty Loop */
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: TX Underrun received &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
)brace
multiline_comment|/* TxUnderRun */
r_if
c_cond
(paren
id|intstatus
op_amp
id|ARBCINT
)paren
(brace
multiline_comment|/* Arbc interrupt */
id|xl_arb_cmd
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Arbc */
r_if
c_cond
(paren
id|intstatus
op_amp
id|ASBFINT
)paren
(brace
r_if
c_cond
(paren
id|xl_priv-&gt;asb_queued
op_eq
l_int|1
)paren
(brace
id|xl_asb_cmd
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|xl_priv-&gt;asb_queued
op_eq
l_int|2
)paren
(brace
id|xl_asb_bh
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|LATCH_ACK
op_or
id|ASBFACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Asbf */
r_if
c_cond
(paren
id|intstatus
op_amp
id|UPCOMPINT
)paren
multiline_comment|/* UpComplete */
id|xl_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intstatus
op_amp
id|DNCOMPINT
)paren
multiline_comment|/* DnComplete */
id|xl_dn_comp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intstatus
op_amp
id|HARDERRINT
)paren
(brace
multiline_comment|/* Hardware error */
id|writel
c_func
(paren
id|MMIO_WORD_READ
op_or
id|MACSTATUS
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|macstatus
op_assign
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: MacStatusError, details: &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|macstatus
op_amp
(paren
l_int|1
op_lshift
l_int|14
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;tchk error: Unrecoverable error &bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|macstatus
op_amp
(paren
l_int|1
op_lshift
l_int|3
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;eint error: Internal watchdog timer expired &bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|macstatus
op_amp
(paren
l_int|1
op_lshift
l_int|2
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;aint error: Host tried to perform illegal operation &bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Instatus = %02x, macstatus = %02x&bslash;n&quot;
comma
id|intstatus
comma
id|macstatus
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Resetting hardware: &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|xl_freemem
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|unregister_trdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|xl_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|xl_priv-&gt;xl_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Received Unknown interrupt : %04x &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intstatus
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Turn interrupts back on */
id|writel
c_func
(paren
id|SETINDENABLE
op_or
id|INT_MASK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|writel
c_func
(paren
id|SETINTENABLE
op_or
id|INT_MASK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|xl_priv-&gt;xl_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Tx - Polling configuration&n; */
DECL|function|xl_xmit
r_static
r_int
id|xl_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|xl_tx_desc
op_star
id|txd
suffix:semicolon
r_int
id|tx_head
comma
id|tx_tail
comma
id|tx_prev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|xl_priv-&gt;xl_lock
comma
id|flags
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xl_priv-&gt;free_ring_entries
OG
l_int|1
)paren
(brace
multiline_comment|/*&n;&t;&t; * Set up the descriptor for the packet &n;&t;&t; */
id|tx_head
op_assign
id|xl_priv-&gt;tx_ring_head
suffix:semicolon
id|tx_tail
op_assign
id|xl_priv-&gt;tx_ring_tail
suffix:semicolon
id|txd
op_assign
op_amp
(paren
id|xl_priv-&gt;xl_tx_ring
(braket
id|tx_head
)braket
)paren
suffix:semicolon
id|txd-&gt;dnnextptr
op_assign
l_int|0
suffix:semicolon
id|txd-&gt;framestartheader
op_assign
id|skb-&gt;len
op_or
id|TXDNINDICATE
suffix:semicolon
id|txd-&gt;buffer
op_assign
id|pci_map_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|txd-&gt;buffer_length
op_assign
id|skb-&gt;len
op_or
id|TXDNFRAGLAST
suffix:semicolon
id|xl_priv-&gt;tx_ring_skb
(braket
id|tx_head
)braket
op_assign
id|skb
suffix:semicolon
id|xl_priv-&gt;xl_stats.tx_packets
op_increment
suffix:semicolon
id|xl_priv-&gt;xl_stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Set the nextptr of the previous descriptor equal to this descriptor, add XL_TX_RING_SIZE -1 &n;&t;&t; * to ensure no negative numbers in unsigned locations.&n;&t;&t; */
id|tx_prev
op_assign
(paren
id|xl_priv-&gt;tx_ring_head
op_plus
id|XL_TX_RING_SIZE
op_minus
l_int|1
)paren
op_amp
(paren
id|XL_TX_RING_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|xl_priv-&gt;tx_ring_head
op_increment
suffix:semicolon
id|xl_priv-&gt;tx_ring_head
op_and_assign
(paren
id|XL_TX_RING_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|xl_priv-&gt;free_ring_entries
op_decrement
suffix:semicolon
id|xl_priv-&gt;xl_tx_ring
(braket
id|tx_prev
)braket
dot
id|dnnextptr
op_assign
id|xl_priv-&gt;tx_ring_dma_addr
op_plus
(paren
r_sizeof
(paren
r_struct
id|xl_tx_desc
)paren
op_star
id|tx_head
)paren
suffix:semicolon
multiline_comment|/* Sneaky, by doing a read on DnListPtr we can force the card to poll on the DnNextPtr */
multiline_comment|/* readl(xl_mmio + MMIO_DNLISTPTR) ; */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|xl_priv-&gt;xl_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|xl_priv-&gt;xl_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; * The NIC has told us that a packet has been downloaded onto the card, we must&n; * find out which packet it has done, clear the skb and information for the packet&n; * then advance around the ring for all tranmitted packets&n; */
DECL|function|xl_dn_comp
r_static
r_void
id|xl_dn_comp
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
r_struct
id|xl_tx_desc
op_star
id|txd
suffix:semicolon
r_if
c_cond
(paren
id|xl_priv-&gt;tx_ring_tail
op_eq
l_int|255
)paren
(brace
multiline_comment|/* First time */
id|xl_priv-&gt;xl_tx_ring
(braket
l_int|0
)braket
dot
id|framestartheader
op_assign
l_int|0
suffix:semicolon
id|xl_priv-&gt;xl_tx_ring
(braket
l_int|0
)braket
dot
id|dnnextptr
op_assign
l_int|0
suffix:semicolon
id|xl_priv-&gt;tx_ring_tail
op_assign
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|xl_priv-&gt;xl_tx_ring
(braket
id|xl_priv-&gt;tx_ring_tail
)braket
dot
id|framestartheader
op_amp
id|TXDNCOMPLETE
)paren
(brace
id|txd
op_assign
op_amp
(paren
id|xl_priv-&gt;xl_tx_ring
(braket
id|xl_priv-&gt;tx_ring_tail
)braket
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|xl_priv-&gt;pdev
comma
id|txd-&gt;buffer
comma
id|xl_priv-&gt;tx_ring_skb
(braket
id|xl_priv-&gt;tx_ring_tail
)braket
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|txd-&gt;framestartheader
op_assign
l_int|0
suffix:semicolon
id|txd-&gt;buffer
op_assign
l_int|0xdeadbeef
suffix:semicolon
id|txd-&gt;buffer_length
op_assign
l_int|0
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|xl_priv-&gt;tx_ring_skb
(braket
id|xl_priv-&gt;tx_ring_tail
)braket
)paren
suffix:semicolon
id|xl_priv-&gt;tx_ring_tail
op_increment
suffix:semicolon
id|xl_priv-&gt;tx_ring_tail
op_and_assign
(paren
id|XL_TX_RING_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|xl_priv-&gt;free_ring_entries
op_increment
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|DNCOMPACK
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Close the adapter properly.&n; * This srb reply cannot be handled from interrupt context as we have&n; * to free the interrupt from the driver. &n; */
DECL|function|xl_close
r_static
r_int
id|xl_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
r_int
r_int
id|t
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Close the adapter, need to stall the rx and tx queues.&n;&t; */
id|writew
c_func
(paren
id|DNSTALL
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|t
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS
)paren
op_amp
id|INTSTAT_CMD_IN_PROGRESS
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t
OG
l_int|10
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: 3COM 3C359 Velocity XL-DNSTALL not responding.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|writew
c_func
(paren
id|DNDISABLE
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|t
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS
)paren
op_amp
id|INTSTAT_CMD_IN_PROGRESS
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t
OG
l_int|10
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: 3COM 3C359 Velocity XL-DNDISABLE not responding.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|writew
c_func
(paren
id|UPSTALL
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|t
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS
)paren
op_amp
id|INTSTAT_CMD_IN_PROGRESS
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t
OG
l_int|10
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: 3COM 3C359 Velocity XL-UPSTALL not responding.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Turn off interrupts, we will still get the indication though&n; &t; * so we can trap it&n;&t; */
id|writel
c_func
(paren
id|SETINTENABLE
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|xl_srb_cmd
c_func
(paren
id|dev
comma
id|CLOSE_NIC
)paren
suffix:semicolon
id|t
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS
)paren
op_amp
id|INTSTAT_SRB
)paren
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t
OG
l_int|10
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: 3COM 3C359 Velocity XL-CLOSENIC not responding.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Read the srb response from the adapter */
id|writel
c_func
(paren
id|MEM_BYTE_READ
op_or
l_int|0xd0000
op_or
id|xl_priv-&gt;srb
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_ne
id|CLOSE_NIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CLOSE_NIC did not get a CLOSE_NIC response &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|writel
c_func
(paren
(paren
id|MEM_BYTE_READ
op_or
l_int|0xd0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
l_int|2
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Adapter has been closed &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|writew
c_func
(paren
id|ACK_INTERRUPT
op_or
id|SRBRACK
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|xl_freemem
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Close nic command returned error code %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Reset the upload and download logic */
id|writew
c_func
(paren
id|UPRESET
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|t
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS
)paren
op_amp
id|INTSTAT_CMD_IN_PROGRESS
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t
OG
l_int|10
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: 3COM 3C359 Velocity XL-UPRESET not responding.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|writew
c_func
(paren
id|DNRESET
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|t
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_INTSTATUS
)paren
op_amp
id|INTSTAT_CMD_IN_PROGRESS
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|t
OG
l_int|10
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: 3COM 3C359 Velocity XL-DNRESET not responding.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|xl_hw_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|xl_set_rx_mode
r_static
r_void
id|xl_set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
suffix:semicolon
r_int
r_char
id|dev_mc_address
(braket
l_int|4
)braket
suffix:semicolon
id|u16
id|options
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
id|options
op_assign
l_int|0x0004
suffix:semicolon
r_else
id|options
op_assign
l_int|0x0000
suffix:semicolon
r_if
c_cond
(paren
id|options
op_xor
id|xl_priv-&gt;xl_copy_all_options
)paren
(brace
multiline_comment|/* Changed, must send command */
id|xl_priv-&gt;xl_copy_all_options
op_assign
id|options
suffix:semicolon
id|xl_srb_cmd
c_func
(paren
id|dev
comma
id|SET_RECEIVE_MODE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev_mc_address
(braket
l_int|0
)braket
op_assign
id|dev_mc_address
(braket
l_int|1
)braket
op_assign
id|dev_mc_address
(braket
l_int|2
)braket
op_assign
id|dev_mc_address
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|dmi
op_assign
id|dmi-&gt;next
)paren
(brace
id|dev_mc_address
(braket
l_int|0
)braket
op_or_assign
id|dmi-&gt;dmi_addr
(braket
l_int|2
)braket
suffix:semicolon
id|dev_mc_address
(braket
l_int|1
)braket
op_or_assign
id|dmi-&gt;dmi_addr
(braket
l_int|3
)braket
suffix:semicolon
id|dev_mc_address
(braket
l_int|2
)braket
op_or_assign
id|dmi-&gt;dmi_addr
(braket
l_int|4
)braket
suffix:semicolon
id|dev_mc_address
(braket
l_int|3
)braket
op_or_assign
id|dmi-&gt;dmi_addr
(braket
l_int|5
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|xl_priv-&gt;xl_functional_addr
comma
id|dev_mc_address
comma
l_int|4
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Options have changed, run the command */
id|memcpy
c_func
(paren
id|xl_priv-&gt;xl_functional_addr
comma
id|dev_mc_address
comma
l_int|4
)paren
suffix:semicolon
id|xl_srb_cmd
c_func
(paren
id|dev
comma
id|SET_FUNC_ADDRESS
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;We issued an srb command and now we must read&n; *&t;the response from the completed command.&n; */
DECL|function|xl_srb_bh
r_static
r_void
id|xl_srb_bh
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
id|u8
id|srb_cmd
comma
id|ret_code
suffix:semicolon
r_int
id|i
suffix:semicolon
id|writel
c_func
(paren
id|MEM_BYTE_READ
op_or
l_int|0xd0000
op_or
id|xl_priv-&gt;srb
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|srb_cmd
op_assign
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|MEM_BYTE_READ
op_or
l_int|0xd0000
op_or
id|xl_priv-&gt;srb
)paren
op_plus
l_int|2
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|ret_code
op_assign
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* Ret_code is standard across all commands */
r_switch
c_cond
(paren
id|ret_code
)paren
(brace
r_case
l_int|1
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Command: %d - Invalid Command code&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|srb_cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Command: %d - Adapter is closed, must be open for this command &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|srb_cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Command: %d - Options Invalid for command &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|srb_cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
multiline_comment|/* Successful command execution */
r_switch
c_cond
(paren
id|srb_cmd
)paren
(brace
r_case
id|READ_LOG
suffix:colon
multiline_comment|/* Returns 14 bytes of data from the NIC */
r_if
c_cond
(paren
id|xl_priv-&gt;xl_message_level
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: READ.LOG 14 bytes of data &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t;&t; * We still have to read the log even if message_level = 0 and we don&squot;t want&n;&t;&t;&t; * to see it&n;&t;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|14
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
id|MEM_BYTE_READ
op_or
l_int|0xd0000
op_or
id|xl_priv-&gt;srb
op_or
id|i
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xl_priv-&gt;xl_message_level
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x:&quot;
comma
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_FUNC_ADDRESS
suffix:colon
r_if
c_cond
(paren
id|xl_priv-&gt;xl_message_level
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Functional Address Set &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CLOSE_NIC
suffix:colon
r_if
c_cond
(paren
id|xl_priv-&gt;xl_message_level
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received CLOSE_NIC interrupt in interrupt handler &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SET_MULTICAST_MODE
suffix:colon
r_if
c_cond
(paren
id|xl_priv-&gt;xl_message_level
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Multicast options successfully changed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SET_RECEIVE_MODE
suffix:colon
r_if
c_cond
(paren
id|xl_priv-&gt;xl_message_level
)paren
(brace
r_if
c_cond
(paren
id|xl_priv-&gt;xl_copy_all_options
op_eq
l_int|0x0004
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Entering promiscuous mode &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Entering normal receive mode &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* switch */
r_break
suffix:semicolon
)brace
multiline_comment|/* switch */
r_return
suffix:semicolon
)brace
DECL|function|xl_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|xl_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
(paren
r_struct
id|net_device_stats
op_star
)paren
op_amp
id|xl_priv-&gt;xl_stats
suffix:semicolon
)brace
DECL|function|xl_set_mac_address
r_static
r_int
id|xl_set_mac_address
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_struct
id|sockaddr
op_star
id|saddr
op_assign
id|addr
suffix:semicolon
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Cannot set mac/laa address while card is open&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|xl_priv-&gt;xl_laa
comma
id|saddr-&gt;sa_data
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xl_priv-&gt;xl_message_level
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MAC/LAA Set to  = %x.%x.%x.%x.%x.%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|xl_priv-&gt;xl_laa
(braket
l_int|0
)braket
comma
id|xl_priv-&gt;xl_laa
(braket
l_int|1
)braket
comma
id|xl_priv-&gt;xl_laa
(braket
l_int|2
)braket
comma
id|xl_priv-&gt;xl_laa
(braket
l_int|3
)braket
comma
id|xl_priv-&gt;xl_laa
(braket
l_int|4
)braket
comma
id|xl_priv-&gt;xl_laa
(braket
l_int|5
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|xl_arb_cmd
r_static
r_void
id|xl_arb_cmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
id|u8
id|arb_cmd
suffix:semicolon
id|u16
id|lan_status
comma
id|lan_status_diff
suffix:semicolon
id|writel
c_func
(paren
(paren
id|MEM_BYTE_READ
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;arb
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|arb_cmd
op_assign
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arb_cmd
op_eq
id|RING_STATUS_CHANGE
)paren
(brace
multiline_comment|/* Ring.Status.Change */
id|writel
c_func
(paren
(paren
(paren
id|MEM_WORD_READ
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;arb
)paren
op_plus
l_int|6
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Ring Status Change: New Status = %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
)paren
)paren
suffix:semicolon
id|lan_status
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
)paren
suffix:semicolon
multiline_comment|/* Acknowledge interrupt, this tells nic we are done with the arb */
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|ARBCACK
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|lan_status_diff
op_assign
id|xl_priv-&gt;xl_lan_status
op_xor
id|lan_status
suffix:semicolon
r_if
c_cond
(paren
id|lan_status_diff
op_amp
(paren
id|LSC_LWF
op_or
id|LSC_ARW
op_or
id|LSC_FPE
op_or
id|LSC_RR
)paren
)paren
(brace
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_LWF
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Short circuit detected on the lobe&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_ARW
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Auto removal error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_FPE
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: FDX Protocol Error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_RR
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Force remove MAC frame received&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Adapter has been closed by the hardware */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|xl_freemem
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Adapter has been closed &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* If serious error */
r_if
c_cond
(paren
id|xl_priv-&gt;xl_message_level
)paren
(brace
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_SIG_LOSS
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: No receive signal detected &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_HARD_ERR
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Beaconing &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_SOFT_ERR
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Adapter transmitted Soft Error Report Mac Frame &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_TRAN_BCN
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: We are tranmitting the beacon, aaah&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_SS
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Single Station on the ring &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_RING_REC
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Ring recovery ongoing&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_FDX_MODE
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Operating in FDX mode&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_CO
)paren
(brace
r_if
c_cond
(paren
id|xl_priv-&gt;xl_message_level
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Counter Overflow &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Issue READ.LOG command */
id|xl_srb_cmd
c_func
(paren
id|dev
comma
id|READ_LOG
)paren
suffix:semicolon
)brace
multiline_comment|/* There is no command in the tech docs to issue the read_sr_counters */
r_if
c_cond
(paren
id|lan_status_diff
op_amp
id|LSC_SR_CO
)paren
(brace
r_if
c_cond
(paren
id|xl_priv-&gt;xl_message_level
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Source routing counters overflow&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|xl_priv-&gt;xl_lan_status
op_assign
id|lan_status
suffix:semicolon
)brace
multiline_comment|/* Lan.change.status */
r_else
r_if
c_cond
(paren
id|arb_cmd
op_eq
id|RECEIVE_DATA
)paren
(brace
multiline_comment|/* Received.Data */
macro_line|#if XL_DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Received.Data &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif &t;&t;
id|writel
c_func
(paren
(paren
(paren
id|MEM_WORD_READ
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;arb
)paren
op_plus
l_int|6
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|xl_priv-&gt;mac_buffer
op_assign
id|ntohs
c_func
(paren
id|readw
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
)paren
suffix:semicolon
multiline_comment|/* Now we are going to be really basic here and not do anything&n;&t;&t; * with the data at all. The tech docs do not give me enough&n;&t;&t; * information to calculate the buffers properly so we&squot;re&n;&t;&t; * just going to tell the nic that we&squot;ve dealt with the frame&n;&t;&t; * anyway.&n;&t;&t; */
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Acknowledge interrupt, this tells nic we are done with the arb */
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|ARBCACK
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
multiline_comment|/* Is the ASB free ? */
id|xl_priv-&gt;asb_queued
op_assign
l_int|0
suffix:semicolon
id|writel
c_func
(paren
(paren
(paren
id|MEM_BYTE_READ
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;asb
)paren
op_plus
l_int|2
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_ne
l_int|0xff
)paren
(brace
id|xl_priv-&gt;asb_queued
op_assign
l_int|1
suffix:semicolon
id|xl_wait_misr_flags
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
id|MF_ASBFR
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xff
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MMIO_BYTE_WRITE
op_or
id|MISR_SET
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MISR_ASBFR
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Drop out and wait for the bottom half to be run */
)brace
id|xl_asb_cmd
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Received unknown arb (xl_priv) command: %02x &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|arb_cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* Acknowledge the arb interrupt */
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|ARBCACK
op_or
id|LATCH_ACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;There is only one asb command, but we can get called from different&n; *&t;places.&n; */
DECL|function|xl_asb_cmd
r_static
r_void
id|xl_asb_cmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
r_if
c_cond
(paren
id|xl_priv-&gt;asb_queued
op_eq
l_int|1
)paren
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|LATCH_ACK
op_or
id|ASBFACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xd0000
op_or
id|xl_priv-&gt;asb
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x81
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MEM_WORD_WRITE
op_or
l_int|0xd0000
op_or
id|xl_priv-&gt;asb
op_or
l_int|6
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
id|ntohs
c_func
(paren
id|xl_priv-&gt;mac_buffer
)paren
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|xl_wait_misr_flags
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
id|MF_RASB
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xff
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MMIO_BYTE_WRITE
op_or
id|MISR_SET
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MISR_RASB
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|xl_priv-&gt;asb_queued
op_assign
l_int|2
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;This will only get called if there was an error&n; *&t;from the asb cmd.&n; */
DECL|function|xl_asb_bh
r_static
r_void
id|xl_asb_bh
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
id|u8
id|ret_code
suffix:semicolon
id|writel
c_func
(paren
id|MMIO_BYTE_READ
op_or
l_int|0xd0000
op_or
id|xl_priv-&gt;asb
op_or
l_int|2
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|ret_code
op_assign
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret_code
)paren
(brace
r_case
l_int|0x01
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ASB Command, unrecognized command code &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x26
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ASB Command, unexpected receive buffer &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x40
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ASB Command, Invalid Station ID &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|xl_priv-&gt;asb_queued
op_assign
l_int|0
suffix:semicolon
id|writel
c_func
(paren
id|ACK_INTERRUPT
op_or
id|LATCH_ACK
op_or
id|ASBFACK
comma
id|xl_mmio
op_plus
id|MMIO_COMMAND
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* &t;&n; *&t;Issue srb commands to the nic &n; */
DECL|function|xl_srb_cmd
r_static
r_void
id|xl_srb_cmd
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|srb_cmd
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
r_switch
c_cond
(paren
id|srb_cmd
)paren
(brace
r_case
id|READ_LOG
suffix:colon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|READ_LOG
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLOSE_NIC
suffix:colon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|CLOSE_NIC
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_RECEIVE_MODE
suffix:colon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|SET_RECEIVE_MODE
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MEM_WORD_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
op_or
l_int|4
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writew
c_func
(paren
id|xl_priv-&gt;xl_copy_all_options
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_FUNC_ADDRESS
suffix:colon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|SET_FUNC_ADDRESS
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
op_or
l_int|6
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|xl_priv-&gt;xl_functional_addr
(braket
l_int|0
)braket
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
op_or
l_int|7
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|xl_priv-&gt;xl_functional_addr
(braket
l_int|1
)braket
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
op_or
l_int|8
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|xl_priv-&gt;xl_functional_addr
(braket
l_int|2
)braket
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
l_int|0xD0000
op_or
id|xl_priv-&gt;srb
op_or
l_int|9
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|xl_priv-&gt;xl_functional_addr
(braket
l_int|3
)braket
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch */
id|xl_wait_misr_flags
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Write 0xff to the CSRB flag */
id|writel
c_func
(paren
id|MEM_BYTE_WRITE
op_or
id|MF_CSRB
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0xFF
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
multiline_comment|/* Set csrb bit in MISR register to process command */
id|writel
c_func
(paren
id|MMIO_BYTE_WRITE
op_or
id|MISR_SET
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MISR_CSRB
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
id|xl_priv-&gt;srb_queued
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * This is nasty, to use the MISR command you have to wait for 6 memory locations&n; * to be zero. This is the way the driver does on other OS&squot;es so we should be ok with &n; * the empty loop.&n; */
DECL|function|xl_wait_misr_flags
r_static
r_void
id|xl_wait_misr_flags
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u8
op_star
id|xl_mmio
op_assign
id|xl_priv-&gt;xl_mmio
suffix:semicolon
r_int
id|i
suffix:semicolon
id|writel
c_func
(paren
id|MMIO_BYTE_READ
op_or
id|MISR_RW
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Misr not clear */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
id|MEM_BYTE_READ
op_or
l_int|0xDFFE0
op_or
id|i
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readb
c_func
(paren
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
op_ne
l_int|0
)paren
(brace
)brace
suffix:semicolon
multiline_comment|/* Empty Loop */
)brace
)brace
id|writel
c_func
(paren
id|MMIO_BYTE_WRITE
op_or
id|MISR_AND
comma
id|xl_mmio
op_plus
id|MMIO_MAC_ACCESS_CMD
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x80
comma
id|xl_mmio
op_plus
id|MMIO_MACDATA
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Change mtu size, this should work the same as olympic&n; */
DECL|function|xl_change_mtu
r_static
r_int
id|xl_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|mtu
)paren
(brace
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|u16
id|max_mtu
suffix:semicolon
r_if
c_cond
(paren
id|xl_priv-&gt;xl_ring_speed
op_eq
l_int|4
)paren
id|max_mtu
op_assign
l_int|4500
suffix:semicolon
r_else
id|max_mtu
op_assign
l_int|18000
suffix:semicolon
r_if
c_cond
(paren
id|mtu
OG
id|max_mtu
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|mtu
OL
l_int|100
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|mtu
suffix:semicolon
id|xl_priv-&gt;pkt_buf_sz
op_assign
id|mtu
op_plus
id|TR_HLEN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|xl_remove_one
r_static
r_void
id|__devexit
id|xl_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pdev-&gt;driver_data
suffix:semicolon
r_struct
id|xl_private
op_star
id|xl_priv
op_assign
(paren
r_struct
id|xl_private
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|unregister_trdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|xl_priv-&gt;xl_mmio
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|xl_3c359_driver
r_static
r_struct
id|pci_driver
id|xl_3c359_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;3c359&quot;
comma
id|id_table
suffix:colon
id|xl_pci_tbl
comma
id|probe
suffix:colon
id|xl_probe
comma
id|remove
suffix:colon
id|__devexit_p
c_func
(paren
id|xl_remove_one
)paren
comma
)brace
suffix:semicolon
DECL|function|xl_pci_init
r_static
r_int
id|__init
id|xl_pci_init
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
(paren
op_amp
id|xl_3c359_driver
)paren
suffix:semicolon
)brace
DECL|function|xl_pci_cleanup
r_static
r_void
id|__exit
id|xl_pci_cleanup
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|xl_3c359_driver
)paren
suffix:semicolon
)brace
DECL|variable|xl_pci_init
id|module_init
c_func
(paren
id|xl_pci_init
)paren
suffix:semicolon
DECL|variable|xl_pci_cleanup
id|module_exit
c_func
(paren
id|xl_pci_cleanup
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
