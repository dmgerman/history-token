multiline_comment|/* via-rhine.c: A Linux Ethernet device driver for VIA Rhine family chips. */
multiline_comment|/*&n;&t;Written 1998-2001 by Donald Becker.&n;&n;&t;Current Maintainer: Roger Luethi &lt;rl@hellgate.ch&gt;&n;&n;&t;This software may be used and distributed according to the terms of&n;&t;the GNU General Public License (GPL), incorporated herein by reference.&n;&t;Drivers based on or derived from this code fall under the GPL and must&n;&t;retain the authorship, copyright and license notice.  This file is not&n;&t;a complete program and may only be used when the entire operating&n;&t;system is licensed under the GPL.&n;&n;&t;This driver is designed for the VIA VT86C100A Rhine-I.&n;&t;It also works with the Rhine-II (6102) and Rhine-III (6105/6105L/6105LOM&n;&t;and management NIC 6105M).&n;&n;&t;The author may be reached as becker@scyld.com, or C/O&n;&t;Scyld Computing Corporation&n;&t;410 Severn Ave., Suite 210&n;&t;Annapolis MD 21403&n;&n;&n;&t;This driver contains some changes from the original Donald Becker&n;&t;version. He may or may not be interested in bug reports on this&n;&t;code. You can find his versions at:&n;&t;http://www.scyld.com/network/via-rhine.html&n;&n;&n;&t;Linux kernel version history:&n;&n;&t;LK1.1.0:&n;&t;- Jeff Garzik: softnet &squot;n stuff&n;&n;&t;LK1.1.1:&n;&t;- Justin Guyett: softnet and locking fixes&n;&t;- Jeff Garzik: use PCI interface&n;&n;&t;LK1.1.2:&n;&t;- Urban Widmark: minor cleanups, merges from Becker 1.03a/1.04 versions&n;&n;&t;LK1.1.3:&n;&t;- Urban Widmark: use PCI DMA interface (with thanks to the eepro100.c&n;&t;&t;&t; code) update &quot;Theory of Operation&quot; with&n;&t;&t;&t; softnet/locking changes&n;&t;- Dave Miller: PCI DMA and endian fixups&n;&t;- Jeff Garzik: MOD_xxx race fixes, updated PCI resource allocation&n;&n;&t;LK1.1.4:&n;&t;- Urban Widmark: fix gcc 2.95.2 problem and&n;&t;                 remove writel&squot;s to fixed address 0x7c&n;&n;&t;LK1.1.5:&n;&t;- Urban Widmark: mdio locking, bounce buffer changes&n;&t;                 merges from Beckers 1.05 version&n;&t;                 added netif_running_on/off support&n;&n;&t;LK1.1.6:&n;&t;- Urban Widmark: merges from Beckers 1.08b version (VT6102 + mdio)&n;&t;                 set netif_running_on/off on startup, del_timer_sync&n;&n;&t;LK1.1.7:&n;&t;- Manfred Spraul: added reset into tx_timeout&n;&n;&t;LK1.1.9:&n;&t;- Urban Widmark: merges from Beckers 1.10 version&n;&t;                 (media selection + eeprom reload)&n;&t;- David Vrabel:  merges from D-Link &quot;1.11&quot; version&n;&t;                 (disable WOL and PME on startup)&n;&n;&t;LK1.1.10:&n;&t;- Manfred Spraul: use &quot;singlecopy&quot; for unaligned buffers&n;&t;                  don&squot;t allocate bounce buffers for !ReqTxAlign cards&n;&n;&t;LK1.1.11:&n;&t;- David Woodhouse: Set dev-&gt;base_addr before the first time we call&n;&t;&t;&t;   wait_for_reset(). It&squot;s a lot happier that way.&n;&t;&t;&t;   Free np-&gt;tx_bufs only if we actually allocated it.&n;&n;&t;LK1.1.12:&n;&t;- Martin Eriksson: Allow Memory-Mapped IO to be enabled.&n;&n;&t;LK1.1.13 (jgarzik):&n;&t;- Add ethtool support&n;&t;- Replace some MII-related magic numbers with constants&n;&n;&t;LK1.1.14 (Ivan G.):&n;&t;- fixes comments for Rhine-III&n;&t;- removes W_MAX_TIMEOUT (unused)&n;&t;- adds HasDavicomPhy for Rhine-I (basis: linuxfet driver; my card&n;&t;  is R-I and has Davicom chip, flag is referenced in kernel driver)&n;&t;- sends chip_id as a parameter to wait_for_reset since np is not&n;&t;  initialized on first call&n;&t;- changes mmio &quot;else if (chip_id==VT6102)&quot; to &quot;else&quot; so it will work&n;&t;  for Rhine-III&squot;s (documentation says same bit is correct)&n;&t;- transmit frame queue message is off by one - fixed&n;&t;- adds IntrNormalSummary to &quot;Something Wicked&quot; exclusion list&n;&t;  so normal interrupts will not trigger the message (src: Donald Becker)&n;&t;(Roger Luethi)&n;&t;- show confused chip where to continue after Tx error&n;&t;- location of collision counter is chip specific&n;&t;- allow selecting backoff algorithm (module parameter)&n;&n;&t;LK1.1.15 (jgarzik):&n;&t;- Use new MII lib helper generic_mii_ioctl&n;&n;&t;LK1.1.16 (Roger Luethi)&n;&t;- Etherleak fix&n;&t;- Handle Tx buffer underrun&n;&t;- Fix bugs in full duplex handling&n;&t;- New reset code uses &quot;force reset&quot; cmd on Rhine-II&n;&t;- Various clean ups&n;&n;&t;LK1.1.17 (Roger Luethi)&n;&t;- Fix race in via_rhine_start_tx()&n;&t;- On errors, wait for Tx engine to turn off before scavenging&n;&t;- Handle Tx descriptor write-back race on Rhine-II&n;&t;- Force flushing for PCI posted writes&n;&t;- More reset code changes&n;&n;&t;LK1.1.18 (Roger Luethi)&n;&t;- No filtering multicast in promisc mode (Edward Peng)&n;&t;- Fix for Rhine-I Tx timeouts&n;&n;&t;LK1.1.19 (Roger Luethi)&n;&t;- Increase Tx threshold for unspecified errors&n;&n;&t;LK1.2.0-2.6 (Roger Luethi)&n;&t;- Massive clean-up&n;&t;- Rewrite PHY, media handling (remove options, full_duplex, backoff)&n;&t;- Fix Tx engine race for good&n;&n;*/
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME&t;&quot;via-rhine&quot;
DECL|macro|DRV_VERSION
mdefine_line|#define DRV_VERSION&t;&quot;1.2.0-2.6&quot;
DECL|macro|DRV_RELDATE
mdefine_line|#define DRV_RELDATE&t;&quot;June-10-2004&quot;
multiline_comment|/* A few user-configurable values.&n;   These may be modified when a driver module is loaded. */
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 normal messages, 0 quiet .. 7 verbose. */
DECL|variable|max_interrupt_work
r_static
r_int
id|max_interrupt_work
op_assign
l_int|20
suffix:semicolon
multiline_comment|/* Set the copy breakpoint for the copy-only-tiny-frames scheme.&n;   Setting to &gt; 1518 effectively disables this feature. */
DECL|variable|rx_copybreak
r_static
r_int
id|rx_copybreak
suffix:semicolon
multiline_comment|/*&n; * In case you are looking for &squot;options[]&squot; or &squot;full_duplex[]&squot;, they&n; * are gone. Use ethtool(8) instead.&n; */
multiline_comment|/* Maximum number of multicast addresses to filter (vs. rx-all-multicast).&n;   The Rhine has a 64 element 8390-like hash table. */
DECL|variable|multicast_filter_limit
r_static
r_const
r_int
id|multicast_filter_limit
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Operational parameters that are set at compile time. */
multiline_comment|/* Keep the ring sizes a power of two for compile efficiency.&n;   The compiler will convert &lt;unsigned&gt;&squot;%&squot;&lt;2^N&gt; into a bit mask.&n;   Making the Tx ring too large decreases the effectiveness of channel&n;   bonding and packet priority.&n;   There are no ill effects from too-large receive rings. */
DECL|macro|TX_RING_SIZE
mdefine_line|#define TX_RING_SIZE&t;16
DECL|macro|TX_QUEUE_LEN
mdefine_line|#define TX_QUEUE_LEN&t;10&t;/* Limit ring entries actually used. */
DECL|macro|RX_RING_SIZE
mdefine_line|#define RX_RING_SIZE&t;16
multiline_comment|/* Operational parameters that usually are not changed. */
multiline_comment|/* Time in jiffies before concluding the transmitter is hung. */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;(2*HZ)
DECL|macro|PKT_BUF_SZ
mdefine_line|#define PKT_BUF_SZ&t;1536&t;/* Size of each temporary Rx buffer.*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;asm/processor.h&gt;&t;/* Processor type for cache alignment. */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
multiline_comment|/* These identify the driver base version and may not be removed. */
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
id|KERN_INFO
id|DRV_NAME
l_string|&quot;.c:v1.10-LK&quot;
id|DRV_VERSION
l_string|&quot; &quot;
id|DRV_RELDATE
l_string|&quot; Written by Donald Becker&bslash;n&quot;
suffix:semicolon
multiline_comment|/* This driver was written to use PCI memory space. Some early versions&n;   of the Rhine may only work correctly with I/O space accesses. */
macro_line|#ifdef CONFIG_VIA_RHINE_MMIO
DECL|macro|USE_MMIO
mdefine_line|#define USE_MMIO
macro_line|#else
DECL|macro|readb
macro_line|#undef readb
DECL|macro|readw
macro_line|#undef readw
DECL|macro|readl
macro_line|#undef readl
DECL|macro|writeb
macro_line|#undef writeb
DECL|macro|writew
macro_line|#undef writew
DECL|macro|writel
macro_line|#undef writel
DECL|macro|readb
mdefine_line|#define readb inb
DECL|macro|readw
mdefine_line|#define readw inw
DECL|macro|readl
mdefine_line|#define readl inl
DECL|macro|writeb
mdefine_line|#define writeb outb
DECL|macro|writew
mdefine_line|#define writew outw
DECL|macro|writel
mdefine_line|#define writel outl
macro_line|#endif
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Donald Becker &lt;becker@scyld.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;VIA Rhine PCI Fast Ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|max_interrupt_work
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|debug
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|rx_copybreak
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_interrupt_work
comma
l_string|&quot;VIA Rhine maximum events handled per interrupt&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;VIA Rhine debug level (0-7)&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|rx_copybreak
comma
l_string|&quot;VIA Rhine copy breakpoint for copy-only-tiny-frames&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;Theory of Operation&n;&n;I. Board Compatibility&n;&n;This driver is designed for the VIA 86c100A Rhine-II PCI Fast Ethernet&n;controller.&n;&n;II. Board-specific settings&n;&n;Boards with this chip are functional only in a bus-master PCI slot.&n;&n;Many operational settings are loaded from the EEPROM to the Config word at&n;offset 0x78. For most of these settings, this driver assumes that they are&n;correct.&n;If this driver is compiled to use PCI memory space operations the EEPROM&n;must be configured to enable memory ops.&n;&n;III. Driver operation&n;&n;IIIa. Ring buffers&n;&n;This driver uses two statically allocated fixed-size descriptor lists&n;formed into rings by a branch from the final descriptor to the beginning of&n;the list. The ring sizes are set at compile time by RX/TX_RING_SIZE.&n;&n;IIIb/c. Transmit/Receive Structure&n;&n;This driver attempts to use a zero-copy receive and transmit scheme.&n;&n;Alas, all data buffers are required to start on a 32 bit boundary, so&n;the driver must often copy transmit packets into bounce buffers.&n;&n;The driver allocates full frame size skbuffs for the Rx ring buffers at&n;open() time and passes the skb-&gt;data field to the chip as receive data&n;buffers. When an incoming frame is less than RX_COPYBREAK bytes long,&n;a fresh skbuff is allocated and the frame is copied to the new skbuff.&n;When the incoming frame is larger, the skbuff is passed directly up the&n;protocol stack. Buffers consumed this way are replaced by newly allocated&n;skbuffs in the last phase of rhine_rx().&n;&n;The RX_COPYBREAK value is chosen to trade-off the memory wasted by&n;using a full-sized skbuff for small frames vs. the copying costs of larger&n;frames. New boards are typically used in generously configured machines&n;and the underfilled buffers have negligible impact compared to the benefit of&n;a single allocation size, so the default value of zero results in never&n;copying packets. When copying is done, the cost is usually mitigated by using&n;a combined copy/checksum routine. Copying also preloads the cache, which is&n;most useful with small frames.&n;&n;Since the VIA chips are only able to transfer data to buffers on 32 bit&n;boundaries, the IP header at offset 14 in an ethernet frame isn&squot;t&n;longword aligned for further processing. Copying these unaligned buffers&n;has the beneficial effect of 16-byte aligning the IP header.&n;&n;IIId. Synchronization&n;&n;The driver runs as two independent, single-threaded flows of control. One&n;is the send-packet routine, which enforces single-threaded use by the&n;dev-&gt;priv-&gt;lock spinlock. The other thread is the interrupt handler, which&n;is single threaded by the hardware and interrupt handling software.&n;&n;The send packet thread has partial control over the Tx ring. It locks the&n;dev-&gt;priv-&gt;lock whenever it&squot;s queuing a Tx packet. If the next slot in the ring&n;is not available it stops the transmit queue by calling netif_stop_queue.&n;&n;The interrupt handler has exclusive control over the Rx ring and records stats&n;from the Tx ring. After reaping the stats, it marks the Tx queue entry as&n;empty by incrementing the dirty_tx mark. If at least half of the entries in&n;the Rx ring are available the transmit queue is woken up if it was stopped.&n;&n;IV. Notes&n;&n;IVb. References&n;&n;Preliminary VT86C100A manual from http://www.via.com.tw/&n;http://www.scyld.com/expert/100mbps.html&n;http://www.scyld.com/expert/NWay.html&n;ftp://ftp.via.com.tw/public/lan/Products/NIC/VT86C100A/Datasheet/VT86C100A03.pdf&n;ftp://ftp.via.com.tw/public/lan/Products/NIC/VT6102/Datasheet/VT6102_021.PDF&n;&n;&n;IVc. Errata&n;&n;The VT86C100A manual is not reliable information.&n;The 3043 chip does not handle unaligned transmit or receive buffers, resulting&n;in significant performance degradation for bounce buffer copies on transmit&n;and unaligned IP headers on receive.&n;The chip does not pad to minimum transmit length.&n;&n;*/
multiline_comment|/* This table drives the PCI probe routines. It&squot;s mostly boilerplate in all&n;   of the drivers, and will likely be provided by some future kernel.&n;   Note the matching code -- the first table entry matchs all 56** cards but&n;   second only the 1234 card.&n;*/
DECL|enum|rhine_revs
r_enum
id|rhine_revs
(brace
DECL|enumerator|VT86C100A
id|VT86C100A
op_assign
l_int|0x00
comma
DECL|enumerator|VTunknown0
id|VTunknown0
op_assign
l_int|0x20
comma
DECL|enumerator|VT6102
id|VT6102
op_assign
l_int|0x40
comma
DECL|enumerator|VT8231
id|VT8231
op_assign
l_int|0x50
comma
multiline_comment|/* Integrated MAC */
DECL|enumerator|VT8233
id|VT8233
op_assign
l_int|0x60
comma
multiline_comment|/* Integrated MAC */
DECL|enumerator|VT8235
id|VT8235
op_assign
l_int|0x74
comma
multiline_comment|/* Integrated MAC */
DECL|enumerator|VT8237
id|VT8237
op_assign
l_int|0x78
comma
multiline_comment|/* Integrated MAC */
DECL|enumerator|VTunknown1
id|VTunknown1
op_assign
l_int|0x7C
comma
DECL|enumerator|VT6105
id|VT6105
op_assign
l_int|0x80
comma
DECL|enumerator|VT6105_B0
id|VT6105_B0
op_assign
l_int|0x83
comma
DECL|enumerator|VT6105L
id|VT6105L
op_assign
l_int|0x8A
comma
DECL|enumerator|VT6107
id|VT6107
op_assign
l_int|0x8C
comma
DECL|enumerator|VTunknown2
id|VTunknown2
op_assign
l_int|0x8E
comma
DECL|enumerator|VT6105M
id|VT6105M
op_assign
l_int|0x90
comma
multiline_comment|/* Management adapter */
)brace
suffix:semicolon
DECL|enum|rhine_quirks
r_enum
id|rhine_quirks
(brace
DECL|enumerator|rqWOL
id|rqWOL
op_assign
l_int|0x0001
comma
multiline_comment|/* Wake-On-LAN support */
DECL|enumerator|rqForceReset
id|rqForceReset
op_assign
l_int|0x0002
comma
DECL|enumerator|rq6patterns
id|rq6patterns
op_assign
l_int|0x0040
comma
multiline_comment|/* 6 instead of 4 patterns for WOL */
DECL|enumerator|rqStatusWBRace
id|rqStatusWBRace
op_assign
l_int|0x0080
comma
multiline_comment|/* Tx Status Writeback Error possible */
DECL|enumerator|rqRhineI
id|rqRhineI
op_assign
l_int|0x0100
comma
multiline_comment|/* See comment below */
)brace
suffix:semicolon
multiline_comment|/*&n; * rqRhineI: VT86C100A (aka Rhine-I) uses different bits to enable&n; * MMIO as well as for the collision counter and the Tx FIFO underflow&n; * indicator. In addition, Tx and Rx buffers need to 4 byte aligned.&n; */
multiline_comment|/* Beware of PCI posted writes */
DECL|macro|IOSYNC
mdefine_line|#define IOSYNC&t;do { readb(dev-&gt;base_addr + StationAddr); } while (0)
DECL|variable|rhine_pci_tbl
r_static
r_struct
id|pci_device_id
id|rhine_pci_tbl
(braket
)braket
op_assign
(brace
(brace
l_int|0x1106
comma
l_int|0x3043
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
)brace
comma
multiline_comment|/* VT86C100A */
(brace
l_int|0x1106
comma
l_int|0x3065
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
)brace
comma
multiline_comment|/* VT6102 */
(brace
l_int|0x1106
comma
l_int|0x3106
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
)brace
comma
multiline_comment|/* 6105{,L,LOM} */
(brace
l_int|0x1106
comma
l_int|0x3053
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
)brace
comma
multiline_comment|/* VT6105M */
(brace
)brace
multiline_comment|/* terminate list */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|rhine_pci_tbl
)paren
suffix:semicolon
multiline_comment|/* Offsets to the device registers. */
DECL|enum|register_offsets
r_enum
id|register_offsets
(brace
DECL|enumerator|StationAddr
DECL|enumerator|RxConfig
DECL|enumerator|TxConfig
DECL|enumerator|ChipCmd
id|StationAddr
op_assign
l_int|0x00
comma
id|RxConfig
op_assign
l_int|0x06
comma
id|TxConfig
op_assign
l_int|0x07
comma
id|ChipCmd
op_assign
l_int|0x08
comma
DECL|enumerator|ChipCmd1
id|ChipCmd1
op_assign
l_int|0x09
comma
DECL|enumerator|IntrStatus
DECL|enumerator|IntrEnable
id|IntrStatus
op_assign
l_int|0x0C
comma
id|IntrEnable
op_assign
l_int|0x0E
comma
DECL|enumerator|MulticastFilter0
DECL|enumerator|MulticastFilter1
id|MulticastFilter0
op_assign
l_int|0x10
comma
id|MulticastFilter1
op_assign
l_int|0x14
comma
DECL|enumerator|RxRingPtr
DECL|enumerator|TxRingPtr
DECL|enumerator|GFIFOTest
id|RxRingPtr
op_assign
l_int|0x18
comma
id|TxRingPtr
op_assign
l_int|0x1C
comma
id|GFIFOTest
op_assign
l_int|0x54
comma
DECL|enumerator|MIIPhyAddr
DECL|enumerator|MIIStatus
DECL|enumerator|PCIBusConfig
id|MIIPhyAddr
op_assign
l_int|0x6C
comma
id|MIIStatus
op_assign
l_int|0x6D
comma
id|PCIBusConfig
op_assign
l_int|0x6E
comma
DECL|enumerator|MIICmd
DECL|enumerator|MIIRegAddr
DECL|enumerator|MIIData
DECL|enumerator|MACRegEEcsr
id|MIICmd
op_assign
l_int|0x70
comma
id|MIIRegAddr
op_assign
l_int|0x71
comma
id|MIIData
op_assign
l_int|0x72
comma
id|MACRegEEcsr
op_assign
l_int|0x74
comma
DECL|enumerator|ConfigA
DECL|enumerator|ConfigB
DECL|enumerator|ConfigC
DECL|enumerator|ConfigD
id|ConfigA
op_assign
l_int|0x78
comma
id|ConfigB
op_assign
l_int|0x79
comma
id|ConfigC
op_assign
l_int|0x7A
comma
id|ConfigD
op_assign
l_int|0x7B
comma
DECL|enumerator|RxMissed
DECL|enumerator|RxCRCErrs
DECL|enumerator|MiscCmd
id|RxMissed
op_assign
l_int|0x7C
comma
id|RxCRCErrs
op_assign
l_int|0x7E
comma
id|MiscCmd
op_assign
l_int|0x81
comma
DECL|enumerator|StickyHW
DECL|enumerator|IntrStatus2
id|StickyHW
op_assign
l_int|0x83
comma
id|IntrStatus2
op_assign
l_int|0x84
comma
DECL|enumerator|WOLcrSet
DECL|enumerator|PwcfgSet
DECL|enumerator|WOLcgSet
DECL|enumerator|WOLcrClr
id|WOLcrSet
op_assign
l_int|0xA0
comma
id|PwcfgSet
op_assign
l_int|0xA1
comma
id|WOLcgSet
op_assign
l_int|0xA3
comma
id|WOLcrClr
op_assign
l_int|0xA4
comma
DECL|enumerator|WOLcrClr1
DECL|enumerator|WOLcgClr
id|WOLcrClr1
op_assign
l_int|0xA6
comma
id|WOLcgClr
op_assign
l_int|0xA7
comma
DECL|enumerator|PwrcsrSet
DECL|enumerator|PwrcsrSet1
DECL|enumerator|PwrcsrClr
DECL|enumerator|PwrcsrClr1
id|PwrcsrSet
op_assign
l_int|0xA8
comma
id|PwrcsrSet1
op_assign
l_int|0xA9
comma
id|PwrcsrClr
op_assign
l_int|0xAC
comma
id|PwrcsrClr1
op_assign
l_int|0xAD
comma
)brace
suffix:semicolon
multiline_comment|/* Bits in ConfigD */
DECL|enum|backoff_bits
r_enum
id|backoff_bits
(brace
DECL|enumerator|BackOptional
DECL|enumerator|BackModify
id|BackOptional
op_assign
l_int|0x01
comma
id|BackModify
op_assign
l_int|0x02
comma
DECL|enumerator|BackCaptureEffect
DECL|enumerator|BackRandom
id|BackCaptureEffect
op_assign
l_int|0x04
comma
id|BackRandom
op_assign
l_int|0x08
)brace
suffix:semicolon
macro_line|#ifdef USE_MMIO
multiline_comment|/* Registers we check that mmio and reg are the same. */
DECL|variable|mmio_verify_registers
r_int
id|mmio_verify_registers
(braket
)braket
op_assign
(brace
id|RxConfig
comma
id|TxConfig
comma
id|IntrEnable
comma
id|ConfigA
comma
id|ConfigB
comma
id|ConfigC
comma
id|ConfigD
comma
l_int|0
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* Bits in the interrupt status/mask registers. */
DECL|enum|intr_status_bits
r_enum
id|intr_status_bits
(brace
DECL|enumerator|IntrRxDone
DECL|enumerator|IntrRxErr
DECL|enumerator|IntrRxEmpty
id|IntrRxDone
op_assign
l_int|0x0001
comma
id|IntrRxErr
op_assign
l_int|0x0004
comma
id|IntrRxEmpty
op_assign
l_int|0x0020
comma
DECL|enumerator|IntrTxDone
DECL|enumerator|IntrTxError
DECL|enumerator|IntrTxUnderrun
id|IntrTxDone
op_assign
l_int|0x0002
comma
id|IntrTxError
op_assign
l_int|0x0008
comma
id|IntrTxUnderrun
op_assign
l_int|0x0210
comma
DECL|enumerator|IntrPCIErr
id|IntrPCIErr
op_assign
l_int|0x0040
comma
DECL|enumerator|IntrStatsMax
DECL|enumerator|IntrRxEarly
id|IntrStatsMax
op_assign
l_int|0x0080
comma
id|IntrRxEarly
op_assign
l_int|0x0100
comma
DECL|enumerator|IntrRxOverflow
DECL|enumerator|IntrRxDropped
DECL|enumerator|IntrRxNoBuf
id|IntrRxOverflow
op_assign
l_int|0x0400
comma
id|IntrRxDropped
op_assign
l_int|0x0800
comma
id|IntrRxNoBuf
op_assign
l_int|0x1000
comma
DECL|enumerator|IntrTxAborted
DECL|enumerator|IntrLinkChange
id|IntrTxAborted
op_assign
l_int|0x2000
comma
id|IntrLinkChange
op_assign
l_int|0x4000
comma
DECL|enumerator|IntrRxWakeUp
id|IntrRxWakeUp
op_assign
l_int|0x8000
comma
DECL|enumerator|IntrNormalSummary
DECL|enumerator|IntrAbnormalSummary
id|IntrNormalSummary
op_assign
l_int|0x0003
comma
id|IntrAbnormalSummary
op_assign
l_int|0xC260
comma
DECL|enumerator|IntrTxDescRace
id|IntrTxDescRace
op_assign
l_int|0x080000
comma
multiline_comment|/* mapped from IntrStatus2 */
DECL|enumerator|IntrTxErrSummary
id|IntrTxErrSummary
op_assign
l_int|0x082218
comma
)brace
suffix:semicolon
multiline_comment|/* Bits in WOLcrSet/WOLcrClr and PwrcsrSet/PwrcsrClr */
DECL|enum|wol_bits
r_enum
id|wol_bits
(brace
DECL|enumerator|WOLucast
id|WOLucast
op_assign
l_int|0x10
comma
DECL|enumerator|WOLmagic
id|WOLmagic
op_assign
l_int|0x20
comma
DECL|enumerator|WOLbmcast
id|WOLbmcast
op_assign
l_int|0x30
comma
DECL|enumerator|WOLlnkon
id|WOLlnkon
op_assign
l_int|0x40
comma
DECL|enumerator|WOLlnkoff
id|WOLlnkoff
op_assign
l_int|0x80
comma
)brace
suffix:semicolon
multiline_comment|/* The Rx and Tx buffer descriptors. */
DECL|struct|rx_desc
r_struct
id|rx_desc
(brace
DECL|member|rx_status
id|s32
id|rx_status
suffix:semicolon
DECL|member|desc_length
id|u32
id|desc_length
suffix:semicolon
multiline_comment|/* Chain flag, Buffer/frame length */
DECL|member|addr
id|u32
id|addr
suffix:semicolon
DECL|member|next_desc
id|u32
id|next_desc
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tx_desc
r_struct
id|tx_desc
(brace
DECL|member|tx_status
id|s32
id|tx_status
suffix:semicolon
DECL|member|desc_length
id|u32
id|desc_length
suffix:semicolon
multiline_comment|/* Chain flag, Tx Config, Frame length */
DECL|member|addr
id|u32
id|addr
suffix:semicolon
DECL|member|next_desc
id|u32
id|next_desc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Initial value for tx_desc.desc_length, Buffer size goes to bits 0-10 */
DECL|macro|TXDESC
mdefine_line|#define TXDESC&t;&t;0x00e08000
DECL|enum|rx_status_bits
r_enum
id|rx_status_bits
(brace
DECL|enumerator|RxOK
DECL|enumerator|RxWholePkt
DECL|enumerator|RxErr
id|RxOK
op_assign
l_int|0x8000
comma
id|RxWholePkt
op_assign
l_int|0x0300
comma
id|RxErr
op_assign
l_int|0x008F
)brace
suffix:semicolon
multiline_comment|/* Bits in *_desc.*_status */
DECL|enum|desc_status_bits
r_enum
id|desc_status_bits
(brace
DECL|enumerator|DescOwn
id|DescOwn
op_assign
l_int|0x80000000
)brace
suffix:semicolon
multiline_comment|/* Bits in ChipCmd. */
DECL|enum|chip_cmd_bits
r_enum
id|chip_cmd_bits
(brace
DECL|enumerator|CmdInit
DECL|enumerator|CmdStart
DECL|enumerator|CmdStop
DECL|enumerator|CmdRxOn
id|CmdInit
op_assign
l_int|0x01
comma
id|CmdStart
op_assign
l_int|0x02
comma
id|CmdStop
op_assign
l_int|0x04
comma
id|CmdRxOn
op_assign
l_int|0x08
comma
DECL|enumerator|CmdTxOn
DECL|enumerator|Cmd1TxDemand
DECL|enumerator|CmdRxDemand
id|CmdTxOn
op_assign
l_int|0x10
comma
id|Cmd1TxDemand
op_assign
l_int|0x20
comma
id|CmdRxDemand
op_assign
l_int|0x40
comma
DECL|enumerator|Cmd1EarlyRx
DECL|enumerator|Cmd1EarlyTx
DECL|enumerator|Cmd1FDuplex
id|Cmd1EarlyRx
op_assign
l_int|0x01
comma
id|Cmd1EarlyTx
op_assign
l_int|0x02
comma
id|Cmd1FDuplex
op_assign
l_int|0x04
comma
DECL|enumerator|Cmd1NoTxPoll
DECL|enumerator|Cmd1Reset
id|Cmd1NoTxPoll
op_assign
l_int|0x08
comma
id|Cmd1Reset
op_assign
l_int|0x80
comma
)brace
suffix:semicolon
DECL|struct|rhine_private
r_struct
id|rhine_private
(brace
multiline_comment|/* Descriptor rings */
DECL|member|rx_ring
r_struct
id|rx_desc
op_star
id|rx_ring
suffix:semicolon
DECL|member|tx_ring
r_struct
id|tx_desc
op_star
id|tx_ring
suffix:semicolon
DECL|member|rx_ring_dma
id|dma_addr_t
id|rx_ring_dma
suffix:semicolon
DECL|member|tx_ring_dma
id|dma_addr_t
id|tx_ring_dma
suffix:semicolon
multiline_comment|/* The addresses of receive-in-place skbuffs. */
DECL|member|rx_skbuff
r_struct
id|sk_buff
op_star
id|rx_skbuff
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
DECL|member|rx_skbuff_dma
id|dma_addr_t
id|rx_skbuff_dma
(braket
id|RX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* The saved address of a sent-in-place packet/buffer, for later free(). */
DECL|member|tx_skbuff
r_struct
id|sk_buff
op_star
id|tx_skbuff
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_skbuff_dma
id|dma_addr_t
id|tx_skbuff_dma
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
multiline_comment|/* Tx bounce buffers */
DECL|member|tx_buf
r_int
r_char
op_star
id|tx_buf
(braket
id|TX_RING_SIZE
)braket
suffix:semicolon
DECL|member|tx_bufs
r_int
r_char
op_star
id|tx_bufs
suffix:semicolon
DECL|member|tx_bufs_dma
id|dma_addr_t
id|tx_bufs_dma
suffix:semicolon
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
DECL|member|pioaddr
r_int
id|pioaddr
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* Frequently used values: keep some adjacent for cache effect. */
DECL|member|quirks
id|u32
id|quirks
suffix:semicolon
DECL|member|rx_head_desc
r_struct
id|rx_desc
op_star
id|rx_head_desc
suffix:semicolon
DECL|member|cur_rx
DECL|member|dirty_rx
r_int
r_int
id|cur_rx
comma
id|dirty_rx
suffix:semicolon
multiline_comment|/* Producer/consumer ring indices */
DECL|member|cur_tx
DECL|member|dirty_tx
r_int
r_int
id|cur_tx
comma
id|dirty_tx
suffix:semicolon
DECL|member|rx_buf_sz
r_int
r_int
id|rx_buf_sz
suffix:semicolon
multiline_comment|/* Based on MTU+slack. */
DECL|member|wolopts
id|u8
id|wolopts
suffix:semicolon
DECL|member|tx_thresh
DECL|member|rx_thresh
id|u8
id|tx_thresh
comma
id|rx_thresh
suffix:semicolon
DECL|member|mii_if
r_struct
id|mii_if_info
id|mii_if
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
suffix:semicolon
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
suffix:semicolon
r_static
r_int
id|rhine_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|rhine_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|rhine_start_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|rhine_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|rhine_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|rhine_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|rhine_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|intr_status
)paren
suffix:semicolon
r_static
r_void
id|rhine_set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|rhine_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|netdev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
suffix:semicolon
DECL|variable|netdev_ethtool_ops
r_static
r_struct
id|ethtool_ops
id|netdev_ethtool_ops
suffix:semicolon
r_static
r_int
id|rhine_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|rhine_shutdown
(paren
r_struct
id|device
op_star
id|gdev
)paren
suffix:semicolon
DECL|macro|RHINE_WAIT_FOR
mdefine_line|#define RHINE_WAIT_FOR(condition) do {&t;&t;&t;&t;&t;&bslash;&n;&t;int i=1024;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;while (!(condition) &amp;&amp; --i)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;if (debug &gt; 1 &amp;&amp; i &lt; 512)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;printk(KERN_INFO &quot;%s: %4d cycles used @ %s:%d&bslash;n&quot;,&t;&bslash;&n;&t;&t;&t;&t;DRV_NAME, 1024-i, __func__, __LINE__);&t;&bslash;&n;} while(0)
DECL|function|get_intr_status
r_static
r_inline
id|u32
id|get_intr_status
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|u32
id|intr_status
suffix:semicolon
id|intr_status
op_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
multiline_comment|/* On Rhine-II, Bit 3 indicates Tx descriptor write-back race. */
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rqStatusWBRace
)paren
id|intr_status
op_or_assign
id|readb
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus2
)paren
op_lshift
l_int|16
suffix:semicolon
r_return
id|intr_status
suffix:semicolon
)brace
multiline_comment|/*&n; * Get power related registers into sane state.&n; * Notify user about past WOL event.&n; */
DECL|function|rhine_power_init
r_static
r_void
id|rhine_power_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|u16
id|wolstat
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rqWOL
)paren
(brace
multiline_comment|/* Make sure chip is in power state D0 */
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|StickyHW
)paren
op_amp
l_int|0xFC
comma
id|ioaddr
op_plus
id|StickyHW
)paren
suffix:semicolon
multiline_comment|/* Disable &quot;force PME-enable&quot; */
id|writeb
c_func
(paren
l_int|0x80
comma
id|ioaddr
op_plus
id|WOLcgClr
)paren
suffix:semicolon
multiline_comment|/* Clear power-event config bits (WOL) */
id|writeb
c_func
(paren
l_int|0xFF
comma
id|ioaddr
op_plus
id|WOLcrClr
)paren
suffix:semicolon
multiline_comment|/* More recent cards can manage two additional patterns */
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rq6patterns
)paren
id|writeb
c_func
(paren
l_int|0x03
comma
id|ioaddr
op_plus
id|WOLcrClr1
)paren
suffix:semicolon
multiline_comment|/* Save power-event status bits */
id|wolstat
op_assign
id|readb
c_func
(paren
id|ioaddr
op_plus
id|PwrcsrSet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rq6patterns
)paren
id|wolstat
op_or_assign
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|PwrcsrSet1
)paren
op_amp
l_int|0x03
)paren
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* Clear power-event status bits */
id|writeb
c_func
(paren
l_int|0xFF
comma
id|ioaddr
op_plus
id|PwrcsrClr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rq6patterns
)paren
id|writeb
c_func
(paren
l_int|0x03
comma
id|ioaddr
op_plus
id|PwrcsrClr1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wolstat
)paren
(brace
r_char
op_star
id|reason
suffix:semicolon
r_switch
c_cond
(paren
id|wolstat
)paren
(brace
r_case
id|WOLmagic
suffix:colon
id|reason
op_assign
l_string|&quot;Magic packet&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WOLlnkon
suffix:colon
id|reason
op_assign
l_string|&quot;Link went up&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WOLlnkoff
suffix:colon
id|reason
op_assign
l_string|&quot;Link went down&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WOLucast
suffix:colon
id|reason
op_assign
l_string|&quot;Unicast packet&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WOLbmcast
suffix:colon
id|reason
op_assign
l_string|&quot;Multicast/broadcast packet&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|reason
op_assign
l_string|&quot;Unknown&quot;
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Woke system up. Reason: %s.&bslash;n&quot;
comma
id|DRV_NAME
comma
id|reason
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|rhine_chip_reset
r_static
r_void
id|rhine_chip_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|Cmd1Reset
comma
id|ioaddr
op_plus
id|ChipCmd1
)paren
suffix:semicolon
id|IOSYNC
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd1
)paren
op_amp
id|Cmd1Reset
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Reset not complete yet. &quot;
l_string|&quot;Trying harder.&bslash;n&quot;
comma
id|DRV_NAME
)paren
suffix:semicolon
multiline_comment|/* Force reset */
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rqForceReset
)paren
id|writeb
c_func
(paren
l_int|0x40
comma
id|ioaddr
op_plus
id|MiscCmd
)paren
suffix:semicolon
multiline_comment|/* Reset can take somewhat longer (rare) */
id|RHINE_WAIT_FOR
c_func
(paren
op_logical_neg
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd1
)paren
op_amp
id|Cmd1Reset
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Reset %s.&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd1
)paren
op_amp
id|Cmd1Reset
)paren
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeeded&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef USE_MMIO
DECL|function|enable_mmio
r_static
r_void
id|__devinit
id|enable_mmio
c_func
(paren
r_int
id|pioaddr
comma
id|u32
id|quirks
)paren
(brace
r_int
id|n
suffix:semicolon
r_if
c_cond
(paren
id|quirks
op_amp
id|rqRhineI
)paren
(brace
multiline_comment|/* More recent docs say that this bit is reserved ... */
id|n
op_assign
id|inb
c_func
(paren
id|pioaddr
op_plus
id|ConfigA
)paren
op_or
l_int|0x20
suffix:semicolon
id|outb
c_func
(paren
id|n
comma
id|pioaddr
op_plus
id|ConfigA
)paren
suffix:semicolon
)brace
r_else
(brace
id|n
op_assign
id|inb
c_func
(paren
id|pioaddr
op_plus
id|ConfigD
)paren
op_or
l_int|0x80
suffix:semicolon
id|outb
c_func
(paren
id|n
comma
id|pioaddr
op_plus
id|ConfigD
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; * Loads bytes 0x00-0x05, 0x6E-0x6F, 0x78-0x7B from EEPROM&n; * (plus 0x6C for Rhine-I/II)&n; */
DECL|function|rhine_reload_eeprom
r_static
r_void
id|__devinit
id|rhine_reload_eeprom
c_func
(paren
r_int
id|pioaddr
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x20
comma
id|pioaddr
op_plus
id|MACRegEEcsr
)paren
suffix:semicolon
id|RHINE_WAIT_FOR
c_func
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|pioaddr
op_plus
id|MACRegEEcsr
)paren
op_amp
l_int|0x20
)paren
)paren
suffix:semicolon
macro_line|#ifdef USE_MMIO
multiline_comment|/*&n;&t; * Reloading from EEPROM overwrites ConfigA-D, so we must re-enable&n;&t; * MMIO. If reloading EEPROM was done first this could be avoided, but&n;&t; * it is not known if that still works with the &quot;win98-reboot&quot; problem.&n;&t; */
id|enable_mmio
c_func
(paren
id|pioaddr
comma
id|rp-&gt;quirks
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Turn off EEPROM-controlled wake-up (magic packet) */
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rqWOL
)paren
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|ConfigA
)paren
op_amp
l_int|0xFE
comma
id|ioaddr
op_plus
id|ConfigA
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NET_POLL_CONTROLLER
DECL|function|rhine_poll
r_static
r_void
id|rhine_poll
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|disable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
id|rhine_interrupt
c_func
(paren
id|dev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|rhine_hw_init
r_static
r_void
id|rhine_hw_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|pioaddr
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Reset the chip to erase previous misconfiguration. */
id|rhine_chip_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Rhine-I needs extra time to recuperate before EEPROM reload */
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rqRhineI
)paren
id|msleep
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Reload EEPROM controlled bytes cleared by soft reset */
id|rhine_reload_eeprom
c_func
(paren
id|pioaddr
comma
id|dev
)paren
suffix:semicolon
)brace
DECL|function|rhine_init_one
r_static
r_int
id|__devinit
id|rhine_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|rhine_private
op_star
id|rp
suffix:semicolon
r_int
id|i
comma
id|rc
suffix:semicolon
id|u8
id|pci_rev
suffix:semicolon
id|u32
id|quirks
suffix:semicolon
r_int
id|pioaddr
suffix:semicolon
r_int
id|memaddr
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_int
id|io_size
comma
id|phy_id
suffix:semicolon
r_const
r_char
op_star
id|name
suffix:semicolon
multiline_comment|/* when built into the kernel, we only print version if device is found */
macro_line|#ifndef MODULE
r_static
r_int
id|printed_version
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|printed_version
op_increment
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
macro_line|#endif
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_REVISION_ID
comma
op_amp
id|pci_rev
)paren
suffix:semicolon
id|io_size
op_assign
l_int|256
suffix:semicolon
id|phy_id
op_assign
l_int|0
suffix:semicolon
id|quirks
op_assign
l_int|0
suffix:semicolon
id|name
op_assign
l_string|&quot;Rhine&quot;
suffix:semicolon
r_if
c_cond
(paren
id|pci_rev
OL
id|VTunknown0
)paren
(brace
id|quirks
op_assign
id|rqRhineI
suffix:semicolon
id|io_size
op_assign
l_int|128
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pci_rev
op_ge
id|VT6102
)paren
(brace
id|quirks
op_assign
id|rqWOL
op_or
id|rqForceReset
suffix:semicolon
r_if
c_cond
(paren
id|pci_rev
OL
id|VT6105
)paren
(brace
id|name
op_assign
l_string|&quot;Rhine II&quot;
suffix:semicolon
id|quirks
op_or_assign
id|rqStatusWBRace
suffix:semicolon
multiline_comment|/* Rhine-II exclusive */
)brace
r_else
(brace
id|phy_id
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Integrated PHY, phy_id fixed to 1 */
r_if
c_cond
(paren
id|pci_rev
op_ge
id|VT6105_B0
)paren
id|quirks
op_or_assign
id|rq6patterns
suffix:semicolon
r_if
c_cond
(paren
id|pci_rev
OL
id|VT6105M
)paren
id|name
op_assign
l_string|&quot;Rhine III&quot;
suffix:semicolon
r_else
id|name
op_assign
l_string|&quot;Rhine III (Management Adapter)&quot;
suffix:semicolon
)brace
)brace
id|rc
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out
suffix:semicolon
multiline_comment|/* this should always be supported */
id|rc
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;32-bit PCI DMA addresses not supported by &quot;
l_string|&quot;the card!?&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
multiline_comment|/* sanity check */
r_if
c_cond
(paren
(paren
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
OL
id|io_size
)paren
op_logical_or
(paren
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|1
)paren
OL
id|io_size
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Insufficient PCI resources, aborting&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|pioaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|memaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|rhine_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;alloc_etherdev failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|dev
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rp-&gt;quirks
op_assign
id|quirks
suffix:semicolon
id|rp-&gt;pioaddr
op_assign
id|pioaddr
suffix:semicolon
id|rp-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|rc
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|DRV_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out_free_netdev
suffix:semicolon
macro_line|#ifdef USE_MMIO
id|enable_mmio
c_func
(paren
id|pioaddr
comma
id|quirks
)paren
suffix:semicolon
id|ioaddr
op_assign
(paren
r_int
)paren
id|ioremap
c_func
(paren
id|memaddr
comma
id|io_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioaddr
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ioremap failed for device %s, region 0x%X &quot;
l_string|&quot;@ 0x%lX&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
comma
id|io_size
comma
id|memaddr
)paren
suffix:semicolon
r_goto
id|err_out_free_res
suffix:semicolon
)brace
multiline_comment|/* Check that selected MMIO registers match the PIO ones */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|mmio_verify_registers
(braket
id|i
)braket
)paren
(brace
r_int
id|reg
op_assign
id|mmio_verify_registers
(braket
id|i
op_increment
)braket
suffix:semicolon
r_int
r_char
id|a
op_assign
id|inb
c_func
(paren
id|pioaddr
op_plus
id|reg
)paren
suffix:semicolon
r_int
r_char
id|b
op_assign
id|readb
c_func
(paren
id|ioaddr
op_plus
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|a
op_ne
id|b
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MMIO do not match PIO [%02x] &quot;
l_string|&quot;(%02x != %02x)&bslash;n&quot;
comma
id|reg
comma
id|a
comma
id|b
)paren
suffix:semicolon
r_goto
id|err_out_unmap
suffix:semicolon
)brace
)brace
macro_line|#else
id|ioaddr
op_assign
id|pioaddr
suffix:semicolon
macro_line|#endif /* USE_MMIO */
id|dev-&gt;base_addr
op_assign
id|ioaddr
suffix:semicolon
multiline_comment|/* Get chip registers into a sane state */
id|rhine_power_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rhine_hw_init
c_func
(paren
id|dev
comma
id|pioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
id|ioaddr
op_plus
id|StationAddr
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_valid_ether_addr
c_func
(paren
id|dev-&gt;dev_addr
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Invalid MAC address&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_unmap
suffix:semicolon
)brace
multiline_comment|/* For Rhine-I/II, phy_id is loaded from EEPROM */
r_if
c_cond
(paren
op_logical_neg
id|phy_id
)paren
id|phy_id
op_assign
id|readb
c_func
(paren
id|ioaddr
op_plus
l_int|0x6C
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
id|rp-&gt;mii_if.dev
op_assign
id|dev
suffix:semicolon
id|rp-&gt;mii_if.mdio_read
op_assign
id|mdio_read
suffix:semicolon
id|rp-&gt;mii_if.mdio_write
op_assign
id|mdio_write
suffix:semicolon
id|rp-&gt;mii_if.phy_id_mask
op_assign
l_int|0x1f
suffix:semicolon
id|rp-&gt;mii_if.reg_num_mask
op_assign
l_int|0x1f
suffix:semicolon
multiline_comment|/* The chip-specific entries in the device structure. */
id|dev-&gt;open
op_assign
id|rhine_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|rhine_start_tx
suffix:semicolon
id|dev-&gt;stop
op_assign
id|rhine_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|rhine_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|rhine_set_rx_mode
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|netdev_ioctl
suffix:semicolon
id|dev-&gt;ethtool_ops
op_assign
op_amp
id|netdev_ethtool_ops
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|rhine_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
macro_line|#ifdef CONFIG_NET_POLL_CONTROLLER
id|dev-&gt;poll_controller
op_assign
id|rhine_poll
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rqRhineI
)paren
id|dev-&gt;features
op_or_assign
id|NETIF_F_SG
op_or
id|NETIF_F_HW_CSUM
suffix:semicolon
multiline_comment|/* dev-&gt;name not defined before register_netdev()! */
id|rc
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out_unmap
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: VIA %s at 0x%lx, &quot;
comma
id|dev-&gt;name
comma
id|name
comma
macro_line|#ifdef USE_MMIO
id|memaddr
macro_line|#else
id|ioaddr
macro_line|#endif
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x:&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%2.2x, IRQ %d.&bslash;n&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
(brace
id|u16
id|mii_cmd
suffix:semicolon
r_int
id|mii_status
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_id
comma
l_int|1
)paren
suffix:semicolon
id|mii_cmd
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_id
comma
id|MII_BMCR
)paren
op_amp
op_complement
id|BMCR_ISOLATE
suffix:semicolon
id|mdio_write
c_func
(paren
id|dev
comma
id|phy_id
comma
id|MII_BMCR
comma
id|mii_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mii_status
op_ne
l_int|0xffff
op_logical_and
id|mii_status
op_ne
l_int|0x0000
)paren
(brace
id|rp-&gt;mii_if.advertising
op_assign
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_id
comma
l_int|4
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MII PHY found at address &quot;
l_string|&quot;%d, status 0x%4.4x advertising %4.4x &quot;
l_string|&quot;Link %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy_id
comma
id|mii_status
comma
id|rp-&gt;mii_if.advertising
comma
id|mdio_read
c_func
(paren
id|dev
comma
id|phy_id
comma
l_int|5
)paren
)paren
suffix:semicolon
multiline_comment|/* set IFF_RUNNING */
r_if
c_cond
(paren
id|mii_status
op_amp
id|BMSR_LSTATUS
)paren
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|rp-&gt;mii_if.phy_id
op_assign
id|phy_id
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_unmap
suffix:colon
macro_line|#ifdef USE_MMIO
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|ioaddr
)paren
suffix:semicolon
id|err_out_free_res
suffix:colon
macro_line|#endif
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out_free_netdev
suffix:colon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|alloc_ring
r_static
r_int
id|alloc_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_void
op_star
id|ring
suffix:semicolon
id|dma_addr_t
id|ring_dma
suffix:semicolon
id|ring
op_assign
id|pci_alloc_consistent
c_func
(paren
id|rp-&gt;pdev
comma
id|RX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
op_plus
id|TX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|tx_desc
)paren
comma
op_amp
id|ring_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ring
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not allocate DMA memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rqRhineI
)paren
(brace
id|rp-&gt;tx_bufs
op_assign
id|pci_alloc_consistent
c_func
(paren
id|rp-&gt;pdev
comma
id|PKT_BUF_SZ
op_star
id|TX_RING_SIZE
comma
op_amp
id|rp-&gt;tx_bufs_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;tx_bufs
op_eq
l_int|NULL
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|rp-&gt;pdev
comma
id|RX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
op_plus
id|TX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|tx_desc
)paren
comma
id|ring
comma
id|ring_dma
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|rp-&gt;rx_ring
op_assign
id|ring
suffix:semicolon
id|rp-&gt;tx_ring
op_assign
id|ring
op_plus
id|RX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
suffix:semicolon
id|rp-&gt;rx_ring_dma
op_assign
id|ring_dma
suffix:semicolon
id|rp-&gt;tx_ring_dma
op_assign
id|ring_dma
op_plus
id|RX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_ring
r_static
r_void
id|free_ring
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|rp-&gt;pdev
comma
id|RX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|rx_desc
)paren
op_plus
id|TX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|tx_desc
)paren
comma
id|rp-&gt;rx_ring
comma
id|rp-&gt;rx_ring_dma
)paren
suffix:semicolon
id|rp-&gt;tx_ring
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;tx_bufs
)paren
id|pci_free_consistent
c_func
(paren
id|rp-&gt;pdev
comma
id|PKT_BUF_SZ
op_star
id|TX_RING_SIZE
comma
id|rp-&gt;tx_bufs
comma
id|rp-&gt;tx_bufs_dma
)paren
suffix:semicolon
id|rp-&gt;tx_bufs
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|alloc_rbufs
r_static
r_void
id|alloc_rbufs
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dma_addr_t
id|next
suffix:semicolon
r_int
id|i
suffix:semicolon
id|rp-&gt;dirty_rx
op_assign
id|rp-&gt;cur_rx
op_assign
l_int|0
suffix:semicolon
id|rp-&gt;rx_buf_sz
op_assign
(paren
id|dev-&gt;mtu
op_le
l_int|1500
ques
c_cond
id|PKT_BUF_SZ
suffix:colon
id|dev-&gt;mtu
op_plus
l_int|32
)paren
suffix:semicolon
id|rp-&gt;rx_head_desc
op_assign
op_amp
id|rp-&gt;rx_ring
(braket
l_int|0
)braket
suffix:semicolon
id|next
op_assign
id|rp-&gt;rx_ring_dma
suffix:semicolon
multiline_comment|/* Init the ring entries */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rp-&gt;rx_ring
(braket
id|i
)braket
dot
id|rx_status
op_assign
l_int|0
suffix:semicolon
id|rp-&gt;rx_ring
(braket
id|i
)braket
dot
id|desc_length
op_assign
id|cpu_to_le32
c_func
(paren
id|rp-&gt;rx_buf_sz
)paren
suffix:semicolon
id|next
op_add_assign
r_sizeof
(paren
r_struct
id|rx_desc
)paren
suffix:semicolon
id|rp-&gt;rx_ring
(braket
id|i
)braket
dot
id|next_desc
op_assign
id|cpu_to_le32
c_func
(paren
id|next
)paren
suffix:semicolon
id|rp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Mark the last entry as wrapping the ring. */
id|rp-&gt;rx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|next_desc
op_assign
id|cpu_to_le32
c_func
(paren
id|rp-&gt;rx_ring_dma
)paren
suffix:semicolon
multiline_comment|/* Fill in the Rx buffers.  Handle allocation failure gracefully. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|rp-&gt;rx_buf_sz
)paren
suffix:semicolon
id|rp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|rp-&gt;rx_skbuff_dma
(braket
id|i
)braket
op_assign
id|pci_map_single
c_func
(paren
id|rp-&gt;pdev
comma
id|skb-&gt;tail
comma
id|rp-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|rp-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|rp-&gt;rx_skbuff_dma
(braket
id|i
)braket
)paren
suffix:semicolon
id|rp-&gt;rx_ring
(braket
id|i
)braket
dot
id|rx_status
op_assign
id|cpu_to_le32
c_func
(paren
id|DescOwn
)paren
suffix:semicolon
)brace
id|rp-&gt;dirty_rx
op_assign
(paren
r_int
r_int
)paren
(paren
id|i
op_minus
id|RX_RING_SIZE
)paren
suffix:semicolon
)brace
DECL|function|free_rbufs
r_static
r_void
id|free_rbufs
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Free all the skbuffs in the Rx queue. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rp-&gt;rx_ring
(braket
id|i
)braket
dot
id|rx_status
op_assign
l_int|0
suffix:semicolon
id|rp-&gt;rx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0xBADF00D0
)paren
suffix:semicolon
multiline_comment|/* An invalid address. */
r_if
c_cond
(paren
id|rp-&gt;rx_skbuff
(braket
id|i
)braket
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|rp-&gt;pdev
comma
id|rp-&gt;rx_skbuff_dma
(braket
id|i
)braket
comma
id|rp-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|rp-&gt;rx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|rp-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|alloc_tbufs
r_static
r_void
id|alloc_tbufs
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dma_addr_t
id|next
suffix:semicolon
r_int
id|i
suffix:semicolon
id|rp-&gt;dirty_tx
op_assign
id|rp-&gt;cur_tx
op_assign
l_int|0
suffix:semicolon
id|next
op_assign
id|rp-&gt;tx_ring_dma
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|rp-&gt;tx_ring
(braket
id|i
)braket
dot
id|tx_status
op_assign
l_int|0
suffix:semicolon
id|rp-&gt;tx_ring
(braket
id|i
)braket
dot
id|desc_length
op_assign
id|cpu_to_le32
c_func
(paren
id|TXDESC
)paren
suffix:semicolon
id|next
op_add_assign
r_sizeof
(paren
r_struct
id|tx_desc
)paren
suffix:semicolon
id|rp-&gt;tx_ring
(braket
id|i
)braket
dot
id|next_desc
op_assign
id|cpu_to_le32
c_func
(paren
id|next
)paren
suffix:semicolon
id|rp-&gt;tx_buf
(braket
id|i
)braket
op_assign
op_amp
id|rp-&gt;tx_bufs
(braket
id|i
op_star
id|PKT_BUF_SZ
)braket
suffix:semicolon
)brace
id|rp-&gt;tx_ring
(braket
id|i
op_minus
l_int|1
)braket
dot
id|next_desc
op_assign
id|cpu_to_le32
c_func
(paren
id|rp-&gt;tx_ring_dma
)paren
suffix:semicolon
)brace
DECL|function|free_tbufs
r_static
r_void
id|free_tbufs
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rp-&gt;tx_ring
(braket
id|i
)braket
dot
id|tx_status
op_assign
l_int|0
suffix:semicolon
id|rp-&gt;tx_ring
(braket
id|i
)braket
dot
id|desc_length
op_assign
id|cpu_to_le32
c_func
(paren
id|TXDESC
)paren
suffix:semicolon
id|rp-&gt;tx_ring
(braket
id|i
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0xBADF00D0
)paren
suffix:semicolon
multiline_comment|/* An invalid address. */
r_if
c_cond
(paren
id|rp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|rp-&gt;tx_skbuff_dma
(braket
id|i
)braket
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|rp-&gt;pdev
comma
id|rp-&gt;tx_skbuff_dma
(braket
id|i
)braket
comma
id|rp-&gt;tx_skbuff
(braket
id|i
)braket
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|rp-&gt;tx_skbuff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|rp-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|rp-&gt;tx_buf
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|rhine_check_media
r_static
r_void
id|rhine_check_media
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|init_media
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|mii_check_media
c_func
(paren
op_amp
id|rp-&gt;mii_if
comma
id|debug
comma
id|init_media
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;mii_if.full_duplex
)paren
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd1
)paren
op_or
id|Cmd1FDuplex
comma
id|ioaddr
op_plus
id|ChipCmd1
)paren
suffix:semicolon
r_else
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd1
)paren
op_amp
op_complement
id|Cmd1FDuplex
comma
id|ioaddr
op_plus
id|ChipCmd1
)paren
suffix:semicolon
)brace
DECL|function|init_registers
r_static
r_void
id|init_registers
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|ioaddr
op_plus
id|StationAddr
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* Initialize other registers. */
id|writew
c_func
(paren
l_int|0x0006
comma
id|ioaddr
op_plus
id|PCIBusConfig
)paren
suffix:semicolon
multiline_comment|/* Tune configuration??? */
multiline_comment|/* Configure initial FIFO thresholds. */
id|writeb
c_func
(paren
l_int|0x20
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
id|rp-&gt;tx_thresh
op_assign
l_int|0x20
suffix:semicolon
id|rp-&gt;rx_thresh
op_assign
l_int|0x60
suffix:semicolon
multiline_comment|/* Written in rhine_set_rx_mode(). */
id|writel
c_func
(paren
id|rp-&gt;rx_ring_dma
comma
id|ioaddr
op_plus
id|RxRingPtr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|rp-&gt;tx_ring_dma
comma
id|ioaddr
op_plus
id|TxRingPtr
)paren
suffix:semicolon
id|rhine_set_rx_mode
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts by setting the interrupt mask. */
id|writew
c_func
(paren
id|IntrRxDone
op_or
id|IntrRxErr
op_or
id|IntrRxEmpty
op_or
id|IntrRxOverflow
op_or
id|IntrRxDropped
op_or
id|IntrRxNoBuf
op_or
id|IntrTxAborted
op_or
id|IntrTxDone
op_or
id|IntrTxError
op_or
id|IntrTxUnderrun
op_or
id|IntrPCIErr
op_or
id|IntrStatsMax
op_or
id|IntrLinkChange
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
id|writew
c_func
(paren
id|CmdStart
op_or
id|CmdTxOn
op_or
id|CmdRxOn
op_or
(paren
id|Cmd1NoTxPoll
op_lshift
l_int|8
)paren
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
id|rhine_check_media
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable MII link status auto-polling (required for IntrLinkChange) */
DECL|function|rhine_enable_linkmon
r_static
r_void
id|rhine_enable_linkmon
c_func
(paren
r_int
id|ioaddr
)paren
(brace
id|writeb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|MIICmd
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MII_BMSR
comma
id|ioaddr
op_plus
id|MIIRegAddr
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x80
comma
id|ioaddr
op_plus
id|MIICmd
)paren
suffix:semicolon
id|RHINE_WAIT_FOR
c_func
(paren
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|MIIRegAddr
)paren
op_amp
l_int|0x20
)paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|MII_BMSR
op_or
l_int|0x40
comma
id|ioaddr
op_plus
id|MIIRegAddr
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable MII link status auto-polling (required for MDIO access) */
DECL|function|rhine_disable_linkmon
r_static
r_void
id|rhine_disable_linkmon
c_func
(paren
r_int
id|ioaddr
comma
id|u32
id|quirks
)paren
(brace
id|writeb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|MIICmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|quirks
op_amp
id|rqRhineI
)paren
(brace
id|writeb
c_func
(paren
l_int|0x01
comma
id|ioaddr
op_plus
id|MIIRegAddr
)paren
suffix:semicolon
singleline_comment|// MII_BMSR
multiline_comment|/* Can be called from ISR. Evil. */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 0x80 must be set immediately before turning it off */
id|writeb
c_func
(paren
l_int|0x80
comma
id|ioaddr
op_plus
id|MIICmd
)paren
suffix:semicolon
id|RHINE_WAIT_FOR
c_func
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|MIIRegAddr
)paren
op_amp
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* Heh. Now clear 0x80 again. */
id|writeb
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|MIICmd
)paren
suffix:semicolon
)brace
r_else
id|RHINE_WAIT_FOR
c_func
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|MIIRegAddr
)paren
op_amp
l_int|0x80
)paren
suffix:semicolon
)brace
multiline_comment|/* Read and write over the MII Management Data I/O (MDIO) interface. */
DECL|function|mdio_read
r_static
r_int
id|mdio_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|regnum
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
id|rhine_disable_linkmon
c_func
(paren
id|ioaddr
comma
id|rp-&gt;quirks
)paren
suffix:semicolon
multiline_comment|/* rhine_disable_linkmon already cleared MIICmd */
id|writeb
c_func
(paren
id|phy_id
comma
id|ioaddr
op_plus
id|MIIPhyAddr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|regnum
comma
id|ioaddr
op_plus
id|MIIRegAddr
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x40
comma
id|ioaddr
op_plus
id|MIICmd
)paren
suffix:semicolon
multiline_comment|/* Trigger read */
id|RHINE_WAIT_FOR
c_func
(paren
op_logical_neg
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|MIICmd
)paren
op_amp
l_int|0x40
)paren
)paren
suffix:semicolon
id|result
op_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|MIIData
)paren
suffix:semicolon
id|rhine_enable_linkmon
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|mdio_write
r_static
r_void
id|mdio_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|regnum
comma
r_int
id|value
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|rhine_disable_linkmon
c_func
(paren
id|ioaddr
comma
id|rp-&gt;quirks
)paren
suffix:semicolon
multiline_comment|/* rhine_disable_linkmon already cleared MIICmd */
id|writeb
c_func
(paren
id|phy_id
comma
id|ioaddr
op_plus
id|MIIPhyAddr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|regnum
comma
id|ioaddr
op_plus
id|MIIRegAddr
)paren
suffix:semicolon
id|writew
c_func
(paren
id|value
comma
id|ioaddr
op_plus
id|MIIData
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x20
comma
id|ioaddr
op_plus
id|MIICmd
)paren
suffix:semicolon
multiline_comment|/* Trigger write */
id|RHINE_WAIT_FOR
c_func
(paren
op_logical_neg
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|MIICmd
)paren
op_amp
l_int|0x20
)paren
)paren
suffix:semicolon
id|rhine_enable_linkmon
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
)brace
DECL|function|rhine_open
r_static
r_int
id|rhine_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|request_irq
c_func
(paren
id|rp-&gt;pdev-&gt;irq
comma
op_amp
id|rhine_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: rhine_open() irq %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rp-&gt;pdev-&gt;irq
)paren
suffix:semicolon
id|rc
op_assign
id|alloc_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|alloc_rbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|alloc_tbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rhine_chip_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Done rhine_open(), status %4.4x &quot;
l_string|&quot;MII status: %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
comma
id|mdio_read
c_func
(paren
id|dev
comma
id|rp-&gt;mii_if.phy_id
comma
id|MII_BMSR
)paren
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rhine_tx_timeout
r_static
r_void
id|rhine_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Transmit timed out, status %4.4x, PHY status &quot;
l_string|&quot;%4.4x, resetting...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
comma
id|mdio_read
c_func
(paren
id|dev
comma
id|rp-&gt;mii_if.phy_id
comma
id|MII_BMSR
)paren
)paren
suffix:semicolon
multiline_comment|/* protect against concurrent rx interrupts */
id|disable_irq
c_func
(paren
id|rp-&gt;pdev-&gt;irq
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* clear all descriptors */
id|free_tbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_rbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|alloc_tbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|alloc_rbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Reinitialize the hardware. */
id|rhine_chip_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|rp-&gt;pdev-&gt;irq
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|rp-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|rhine_start_tx
r_static
r_int
id|rhine_start_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|entry
suffix:semicolon
multiline_comment|/* Caution: the write order is important here, set the field&n;&t;   with the &quot;ownership&quot; bits last. */
multiline_comment|/* Calculate the next Tx descriptor entry. */
id|entry
op_assign
id|rp-&gt;cur_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
id|ETH_ZLEN
)paren
(brace
id|skb
op_assign
id|skb_padto
c_func
(paren
id|skb
comma
id|ETH_ZLEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|rp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rp-&gt;quirks
op_amp
id|rqRhineI
)paren
op_logical_and
(paren
(paren
(paren
r_int
)paren
id|skb-&gt;data
op_amp
l_int|3
)paren
op_logical_or
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
op_ne
l_int|0
op_logical_or
id|skb-&gt;ip_summed
op_eq
id|CHECKSUM_HW
)paren
)paren
(brace
multiline_comment|/* Must use alignment buffer. */
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|PKT_BUF_SZ
)paren
(brace
multiline_comment|/* packet too long, drop it */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|rp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|rp-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|skb_copy_and_csum_dev
c_func
(paren
id|skb
comma
id|rp-&gt;tx_buf
(braket
id|entry
)braket
)paren
suffix:semicolon
id|rp-&gt;tx_skbuff_dma
(braket
id|entry
)braket
op_assign
l_int|0
suffix:semicolon
id|rp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|rp-&gt;tx_bufs_dma
op_plus
(paren
id|rp-&gt;tx_buf
(braket
id|entry
)braket
op_minus
id|rp-&gt;tx_bufs
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|rp-&gt;tx_skbuff_dma
(braket
id|entry
)braket
op_assign
id|pci_map_single
c_func
(paren
id|rp-&gt;pdev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|rp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|rp-&gt;tx_skbuff_dma
(braket
id|entry
)braket
)paren
suffix:semicolon
)brace
id|rp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|desc_length
op_assign
id|cpu_to_le32
c_func
(paren
id|TXDESC
op_or
(paren
id|skb-&gt;len
op_ge
id|ETH_ZLEN
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
)paren
)paren
suffix:semicolon
multiline_comment|/* lock eth irq */
id|spin_lock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|rp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_status
op_assign
id|cpu_to_le32
c_func
(paren
id|DescOwn
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|rp-&gt;cur_tx
op_increment
suffix:semicolon
multiline_comment|/* Non-x86 Todo: explicitly flush cache lines here. */
multiline_comment|/* Wake the potentially-idle transmit channel */
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd1
)paren
op_or
id|Cmd1TxDemand
comma
id|ioaddr
op_plus
id|ChipCmd1
)paren
suffix:semicolon
id|IOSYNC
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;cur_tx
op_eq
id|rp-&gt;dirty_tx
op_plus
id|TX_QUEUE_LEN
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transmit frame #%d queued in slot %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rp-&gt;cur_tx
op_minus
l_int|1
comma
id|entry
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The interrupt handler does all of the Rx thread work and cleans up&n;   after the Tx thread. */
DECL|function|rhine_interrupt
r_static
id|irqreturn_t
id|rhine_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_instance
comma
r_struct
id|pt_regs
op_star
id|rgs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_instance
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
id|u32
id|intr_status
suffix:semicolon
r_int
id|boguscnt
op_assign
id|max_interrupt_work
suffix:semicolon
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_while
c_loop
(paren
(paren
id|intr_status
op_assign
id|get_intr_status
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|handled
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Acknowledge all of the current interrupt sources ASAP. */
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrTxDescRace
)paren
id|writeb
c_func
(paren
l_int|0x08
comma
id|ioaddr
op_plus
id|IntrStatus2
)paren
suffix:semicolon
id|writew
c_func
(paren
id|intr_status
op_amp
l_int|0xffff
comma
id|ioaddr
op_plus
id|IntrStatus
)paren
suffix:semicolon
id|IOSYNC
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Interrupt, status %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrRxDone
op_or
id|IntrRxErr
op_or
id|IntrRxDropped
op_or
id|IntrRxWakeUp
op_or
id|IntrRxEmpty
op_or
id|IntrRxNoBuf
)paren
)paren
id|rhine_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrTxErrSummary
op_or
id|IntrTxDone
)paren
)paren
(brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrTxErrSummary
)paren
(brace
multiline_comment|/* Avoid scavenging before Tx engine turned off */
id|RHINE_WAIT_FOR
c_func
(paren
op_logical_neg
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
op_amp
id|CmdTxOn
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|2
op_logical_and
id|readb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
op_amp
id|CmdTxOn
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: &quot;
l_string|&quot;rhine_interrupt() Tx engine&quot;
l_string|&quot;still on.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|rhine_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Abnormal error summary/uncommon events handlers. */
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrPCIErr
op_or
id|IntrLinkChange
op_or
id|IntrStatsMax
op_or
id|IntrTxError
op_or
id|IntrTxAborted
op_or
id|IntrTxUnderrun
op_or
id|IntrTxDescRace
)paren
)paren
id|rhine_error
c_func
(paren
id|dev
comma
id|intr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Too much work at interrupt, &quot;
l_string|&quot;status=%#8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|debug
OG
l_int|3
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: exiting interrupt, status=%8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|IntrStatus
)paren
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
multiline_comment|/* This routine is logically part of the interrupt handler, but isolated&n;   for clarity. */
DECL|function|rhine_tx
r_static
r_void
id|rhine_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|txstatus
op_assign
l_int|0
comma
id|entry
op_assign
id|rp-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* find and cleanup dirty tx descriptors */
r_while
c_loop
(paren
id|rp-&gt;dirty_tx
op_ne
id|rp-&gt;cur_tx
)paren
(brace
id|txstatus
op_assign
id|le32_to_cpu
c_func
(paren
id|rp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|6
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Tx scavenge %d status %8.8x.&bslash;n&quot;
comma
id|entry
comma
id|txstatus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
id|DescOwn
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x8000
)paren
(brace
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transmit error, &quot;
l_string|&quot;Tx status %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|txstatus
)paren
suffix:semicolon
id|rp-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x0400
)paren
id|rp-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x0200
)paren
id|rp-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x0100
)paren
id|rp-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|txstatus
op_amp
l_int|0x0080
)paren
id|rp-&gt;stats.tx_heartbeat_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|rp-&gt;quirks
op_amp
id|rqRhineI
)paren
op_logical_and
id|txstatus
op_amp
l_int|0x0002
)paren
op_logical_or
(paren
id|txstatus
op_amp
l_int|0x0800
)paren
op_logical_or
(paren
id|txstatus
op_amp
l_int|0x1000
)paren
)paren
(brace
id|rp-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
id|rp-&gt;tx_ring
(braket
id|entry
)braket
dot
id|tx_status
op_assign
id|cpu_to_le32
c_func
(paren
id|DescOwn
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Keep the skb - we try again */
)brace
multiline_comment|/* Transmitter restarted in &squot;abnormal&squot; handler. */
)brace
r_else
(brace
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rqRhineI
)paren
id|rp-&gt;stats.collisions
op_add_assign
(paren
id|txstatus
op_rshift
l_int|3
)paren
op_amp
l_int|0x0F
suffix:semicolon
r_else
id|rp-&gt;stats.collisions
op_add_assign
id|txstatus
op_amp
l_int|0x0F
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|6
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;collisions: %1.1x:%1.1x&bslash;n&quot;
comma
(paren
id|txstatus
op_rshift
l_int|3
)paren
op_amp
l_int|0xF
comma
id|txstatus
op_amp
l_int|0xF
)paren
suffix:semicolon
id|rp-&gt;stats.tx_bytes
op_add_assign
id|rp-&gt;tx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|len
suffix:semicolon
id|rp-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* Free the original skb. */
r_if
c_cond
(paren
id|rp-&gt;tx_skbuff_dma
(braket
id|entry
)braket
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|rp-&gt;pdev
comma
id|rp-&gt;tx_skbuff_dma
(braket
id|entry
)braket
comma
id|rp-&gt;tx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
id|dev_kfree_skb_irq
c_func
(paren
id|rp-&gt;tx_skbuff
(braket
id|entry
)braket
)paren
suffix:semicolon
id|rp-&gt;tx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|entry
op_assign
(paren
op_increment
id|rp-&gt;dirty_tx
)paren
op_mod
id|TX_RING_SIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rp-&gt;cur_tx
op_minus
id|rp-&gt;dirty_tx
)paren
OL
id|TX_QUEUE_LEN
op_minus
l_int|4
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* This routine is logically part of the interrupt handler, but isolated&n;   for clarity and better register allocation. */
DECL|function|rhine_rx
r_static
r_void
id|rhine_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|entry
op_assign
id|rp-&gt;cur_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_int
id|boguscnt
op_assign
id|rp-&gt;dirty_rx
op_plus
id|RX_RING_SIZE
op_minus
id|rp-&gt;cur_rx
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: rhine_rx(), entry %d status %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|entry
comma
id|le32_to_cpu
c_func
(paren
id|rp-&gt;rx_head_desc-&gt;rx_status
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* If EOP is set on the next entry, it&squot;s a new packet. Send it up. */
r_while
c_loop
(paren
op_logical_neg
(paren
id|rp-&gt;rx_head_desc-&gt;rx_status
op_amp
id|cpu_to_le32
c_func
(paren
id|DescOwn
)paren
)paren
)paren
(brace
r_struct
id|rx_desc
op_star
id|desc
op_assign
id|rp-&gt;rx_head_desc
suffix:semicolon
id|u32
id|desc_status
op_assign
id|le32_to_cpu
c_func
(paren
id|desc-&gt;rx_status
)paren
suffix:semicolon
r_int
id|data_size
op_assign
id|desc_status
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; rhine_rx() status is %8.8x.&bslash;n&quot;
comma
id|desc_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|boguscnt
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|desc_status
op_amp
(paren
id|RxWholePkt
op_or
id|RxErr
)paren
)paren
op_ne
id|RxWholePkt
)paren
(brace
r_if
c_cond
(paren
(paren
id|desc_status
op_amp
id|RxWholePkt
)paren
op_ne
id|RxWholePkt
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Oversized Ethernet &quot;
l_string|&quot;frame spanned multiple buffers, entry &quot;
l_string|&quot;%#x length %d status %8.8x!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|entry
comma
id|data_size
comma
id|desc_status
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Oversized Ethernet &quot;
l_string|&quot;frame %p vs %p.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rp-&gt;rx_head_desc
comma
op_amp
id|rp-&gt;rx_ring
(braket
id|entry
)braket
)paren
suffix:semicolon
id|rp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|desc_status
op_amp
id|RxErr
)paren
(brace
multiline_comment|/* There was a error. */
r_if
c_cond
(paren
id|debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; rhine_rx() Rx &quot;
l_string|&quot;error was %8.8x.&bslash;n&quot;
comma
id|desc_status
)paren
suffix:semicolon
id|rp-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
l_int|0x0030
)paren
id|rp-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
l_int|0x0048
)paren
id|rp-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
l_int|0x0004
)paren
id|rp-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|desc_status
op_amp
l_int|0x0002
)paren
(brace
multiline_comment|/* this can also be updated outside the interrupt handler */
id|spin_lock
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
id|rp-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* Length should omit the CRC */
r_int
id|pkt_len
op_assign
id|data_size
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* Check if the packet is long enough to accept without&n;&t;&t;&t;   copying to a minimally-sized skbuff. */
r_if
c_cond
(paren
id|pkt_len
OL
id|rx_copybreak
op_logical_and
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16 byte align the IP header */
id|pci_dma_sync_single_for_cpu
c_func
(paren
id|rp-&gt;pdev
comma
id|rp-&gt;rx_skbuff_dma
(braket
id|entry
)braket
comma
id|rp-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|eth_copy_and_sum
c_func
(paren
id|skb
comma
id|rp-&gt;rx_skbuff
(braket
id|entry
)braket
op_member_access_from_pointer
id|tail
comma
id|pkt_len
comma
l_int|0
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
id|pci_dma_sync_single_for_device
c_func
(paren
id|rp-&gt;pdev
comma
id|rp-&gt;rx_skbuff_dma
(braket
id|entry
)braket
comma
id|rp-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
id|rp-&gt;rx_skbuff
(braket
id|entry
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Inconsistent Rx &quot;
l_string|&quot;descriptor chain.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|rp-&gt;pdev
comma
id|rp-&gt;rx_skbuff_dma
(braket
id|entry
)braket
comma
id|rp-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|rp-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
id|rp-&gt;stats.rx_packets
op_increment
suffix:semicolon
)brace
id|entry
op_assign
(paren
op_increment
id|rp-&gt;cur_rx
)paren
op_mod
id|RX_RING_SIZE
suffix:semicolon
id|rp-&gt;rx_head_desc
op_assign
op_amp
id|rp-&gt;rx_ring
(braket
id|entry
)braket
suffix:semicolon
)brace
multiline_comment|/* Refill the Rx ring buffers. */
r_for
c_loop
(paren
suffix:semicolon
id|rp-&gt;cur_rx
op_minus
id|rp-&gt;dirty_rx
OG
l_int|0
suffix:semicolon
id|rp-&gt;dirty_rx
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|entry
op_assign
id|rp-&gt;dirty_rx
op_mod
id|RX_RING_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;rx_skbuff
(braket
id|entry
)braket
op_eq
l_int|NULL
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|rp-&gt;rx_buf_sz
)paren
suffix:semicolon
id|rp-&gt;rx_skbuff
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* Better luck next round. */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Mark as being used by this device. */
id|rp-&gt;rx_skbuff_dma
(braket
id|entry
)braket
op_assign
id|pci_map_single
c_func
(paren
id|rp-&gt;pdev
comma
id|skb-&gt;tail
comma
id|rp-&gt;rx_buf_sz
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|rp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|addr
op_assign
id|cpu_to_le32
c_func
(paren
id|rp-&gt;rx_skbuff_dma
(braket
id|entry
)braket
)paren
suffix:semicolon
)brace
id|rp-&gt;rx_ring
(braket
id|entry
)braket
dot
id|rx_status
op_assign
id|cpu_to_le32
c_func
(paren
id|DescOwn
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Clears the &quot;tally counters&quot; for CRC errors and missed frames(?).&n; * It has been reported that some chips need a write of 0 to clear&n; * these, for others the counters are set to 1 when written to and&n; * instead cleared when read. So we clear them both ways ...&n; */
DECL|function|clear_tally_counters
r_static
r_inline
r_void
id|clear_tally_counters
c_func
(paren
r_const
r_int
id|ioaddr
)paren
(brace
id|writel
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxCRCErrs
)paren
suffix:semicolon
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
)brace
DECL|function|rhine_restart_tx
r_static
r_void
id|rhine_restart_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|entry
op_assign
id|rp-&gt;dirty_tx
op_mod
id|TX_RING_SIZE
suffix:semicolon
id|u32
id|intr_status
suffix:semicolon
multiline_comment|/*&n;&t; * If new errors occured, we need to sort them out before doing Tx.&n;&t; * In that case the ISR will be back here RSN anyway.&n;&t; */
id|intr_status
op_assign
id|get_intr_status
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|intr_status
op_amp
id|IntrTxErrSummary
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* We know better than the chip where it should continue. */
id|writel
c_func
(paren
id|rp-&gt;tx_ring_dma
op_plus
id|entry
op_star
r_sizeof
(paren
r_struct
id|tx_desc
)paren
comma
id|ioaddr
op_plus
id|TxRingPtr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
op_or
id|CmdTxOn
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd1
)paren
op_or
id|Cmd1TxDemand
comma
id|ioaddr
op_plus
id|ChipCmd1
)paren
suffix:semicolon
id|IOSYNC
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* This should never happen */
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: rhine_restart_tx() &quot;
l_string|&quot;Another error occured %8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
)brace
)brace
DECL|function|rhine_error
r_static
r_void
id|rhine_error
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|intr_status
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrLinkChange
)paren
id|rhine_check_media
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrStatsMax
)paren
(brace
id|rp-&gt;stats.rx_crc_errors
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxCRCErrs
)paren
suffix:semicolon
id|rp-&gt;stats.rx_missed_errors
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
id|clear_tally_counters
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrTxAborted
)paren
(brace
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Abort %8.8x, frame dropped.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrTxUnderrun
)paren
(brace
r_if
c_cond
(paren
id|rp-&gt;tx_thresh
OL
l_int|0xE0
)paren
id|writeb
c_func
(paren
id|rp-&gt;tx_thresh
op_add_assign
l_int|0x20
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Transmitter underrun, Tx &quot;
l_string|&quot;threshold now %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rp-&gt;tx_thresh
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
id|IntrTxDescRace
)paren
(brace
r_if
c_cond
(paren
id|debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Tx descriptor write-back race.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|intr_status
op_amp
id|IntrTxError
)paren
op_logical_and
(paren
id|intr_status
op_amp
(paren
id|IntrTxAborted
op_or
id|IntrTxUnderrun
op_or
id|IntrTxDescRace
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rp-&gt;tx_thresh
OL
l_int|0xE0
)paren
(brace
id|writeb
c_func
(paren
id|rp-&gt;tx_thresh
op_add_assign
l_int|0x20
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unspecified error. Tx &quot;
l_string|&quot;threshold now %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rp-&gt;tx_thresh
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_status
op_amp
(paren
id|IntrTxAborted
op_or
id|IntrTxUnderrun
op_or
id|IntrTxDescRace
op_or
id|IntrTxError
)paren
)paren
id|rhine_restart_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_status
op_amp
op_complement
(paren
id|IntrLinkChange
op_or
id|IntrStatsMax
op_or
id|IntrTxUnderrun
op_or
id|IntrTxError
op_or
id|IntrTxAborted
op_or
id|IntrNormalSummary
op_or
id|IntrTxDescRace
)paren
)paren
(brace
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Something Wicked happened! &quot;
l_string|&quot;%8.8x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|intr_status
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|rhine_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|rhine_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|rp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rp-&gt;stats.rx_crc_errors
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxCRCErrs
)paren
suffix:semicolon
id|rp-&gt;stats.rx_missed_errors
op_add_assign
id|readw
c_func
(paren
id|ioaddr
op_plus
id|RxMissed
)paren
suffix:semicolon
id|clear_tally_counters
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|rp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_amp
id|rp-&gt;stats
suffix:semicolon
)brace
DECL|function|rhine_set_rx_mode
r_static
r_void
id|rhine_set_rx_mode
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u32
id|mc_filter
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Multicast hash filter */
id|u8
id|rx_mode
suffix:semicolon
multiline_comment|/* Note: 0x02=accept runt, 0x01=accept errs */
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
multiline_comment|/* Set promiscuous. */
multiline_comment|/* Unconditionally log net taps. */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|rx_mode
op_assign
l_int|0x1C
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffffffff
comma
id|ioaddr
op_plus
id|MulticastFilter0
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffffffff
comma
id|ioaddr
op_plus
id|MulticastFilter1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|dev-&gt;mc_count
OG
id|multicast_filter_limit
)paren
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
(brace
multiline_comment|/* Too many to match, or accept all multicasts. */
id|writel
c_func
(paren
l_int|0xffffffff
comma
id|ioaddr
op_plus
id|MulticastFilter0
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffffffff
comma
id|ioaddr
op_plus
id|MulticastFilter1
)paren
suffix:semicolon
id|rx_mode
op_assign
l_int|0x0C
suffix:semicolon
)brace
r_else
(brace
r_struct
id|dev_mc_list
op_star
id|mclist
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
id|mc_filter
comma
l_int|0
comma
r_sizeof
(paren
id|mc_filter
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mclist
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|mclist
op_logical_and
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
comma
id|mclist
op_assign
id|mclist-&gt;next
)paren
(brace
r_int
id|bit_nr
op_assign
id|ether_crc
c_func
(paren
id|ETH_ALEN
comma
id|mclist-&gt;dmi_addr
)paren
op_rshift
l_int|26
suffix:semicolon
id|mc_filter
(braket
id|bit_nr
op_rshift
l_int|5
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|bit_nr
op_amp
l_int|31
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|mc_filter
(braket
l_int|0
)braket
comma
id|ioaddr
op_plus
id|MulticastFilter0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|mc_filter
(braket
l_int|1
)braket
comma
id|ioaddr
op_plus
id|MulticastFilter1
)paren
suffix:semicolon
id|rx_mode
op_assign
l_int|0x0C
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|rp-&gt;rx_thresh
op_or
id|rx_mode
comma
id|ioaddr
op_plus
id|RxConfig
)paren
suffix:semicolon
)brace
DECL|function|netdev_get_drvinfo
r_static
r_void
id|netdev_get_drvinfo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_drvinfo
op_star
id|info
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;driver
comma
id|DRV_NAME
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;version
comma
id|DRV_VERSION
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;bus_info
comma
id|pci_name
c_func
(paren
id|rp-&gt;pdev
)paren
)paren
suffix:semicolon
)brace
DECL|function|netdev_get_settings
r_static
r_int
id|netdev_get_settings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
id|rc
op_assign
id|mii_ethtool_gset
c_func
(paren
op_amp
id|rp-&gt;mii_if
comma
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|netdev_set_settings
r_static
r_int
id|netdev_set_settings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
id|rc
op_assign
id|mii_ethtool_sset
c_func
(paren
op_amp
id|rp-&gt;mii_if
comma
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|netdev_nway_reset
r_static
r_int
id|netdev_nway_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|mii_nway_restart
c_func
(paren
op_amp
id|rp-&gt;mii_if
)paren
suffix:semicolon
)brace
DECL|function|netdev_get_link
r_static
id|u32
id|netdev_get_link
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|mii_link_ok
c_func
(paren
op_amp
id|rp-&gt;mii_if
)paren
suffix:semicolon
)brace
DECL|function|netdev_get_msglevel
r_static
id|u32
id|netdev_get_msglevel
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
id|debug
suffix:semicolon
)brace
DECL|function|netdev_set_msglevel
r_static
r_void
id|netdev_set_msglevel
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u32
id|value
)paren
(brace
id|debug
op_assign
id|value
suffix:semicolon
)brace
DECL|function|rhine_get_wol
r_static
r_void
id|rhine_get_wol
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_wolinfo
op_star
id|wol
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rp-&gt;quirks
op_amp
id|rqWOL
)paren
)paren
r_return
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
id|wol-&gt;supported
op_assign
id|WAKE_PHY
op_or
id|WAKE_MAGIC
op_or
id|WAKE_UCAST
op_or
id|WAKE_MCAST
op_or
id|WAKE_BCAST
suffix:semicolon
multiline_comment|/* Untested */
id|wol-&gt;wolopts
op_assign
id|rp-&gt;wolopts
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|rhine_set_wol
r_static
r_int
id|rhine_set_wol
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_wolinfo
op_star
id|wol
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|u32
id|support
op_assign
id|WAKE_PHY
op_or
id|WAKE_MAGIC
op_or
id|WAKE_UCAST
op_or
id|WAKE_MCAST
op_or
id|WAKE_BCAST
suffix:semicolon
multiline_comment|/* Untested */
r_if
c_cond
(paren
op_logical_neg
(paren
id|rp-&gt;quirks
op_amp
id|rqWOL
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|wol-&gt;wolopts
op_amp
op_complement
id|support
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
id|rp-&gt;wolopts
op_assign
id|wol-&gt;wolopts
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|netdev_ethtool_ops
r_static
r_struct
id|ethtool_ops
id|netdev_ethtool_ops
op_assign
(brace
dot
id|get_drvinfo
op_assign
id|netdev_get_drvinfo
comma
dot
id|get_settings
op_assign
id|netdev_get_settings
comma
dot
id|set_settings
op_assign
id|netdev_set_settings
comma
dot
id|nway_reset
op_assign
id|netdev_nway_reset
comma
dot
id|get_link
op_assign
id|netdev_get_link
comma
dot
id|get_msglevel
op_assign
id|netdev_get_msglevel
comma
dot
id|set_msglevel
op_assign
id|netdev_set_msglevel
comma
dot
id|get_wol
op_assign
id|rhine_get_wol
comma
dot
id|set_wol
op_assign
id|rhine_set_wol
comma
dot
id|get_sg
op_assign
id|ethtool_op_get_sg
comma
dot
id|get_tx_csum
op_assign
id|ethtool_op_get_tx_csum
comma
)brace
suffix:semicolon
DECL|function|netdev_ioctl
r_static
r_int
id|netdev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
id|rc
op_assign
id|generic_mii_ioctl
c_func
(paren
op_amp
id|rp-&gt;mii_if
comma
id|if_mii
c_func
(paren
id|rq
)paren
comma
id|cmd
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|rhine_close
r_static
r_int
id|rhine_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down ethercard, &quot;
l_string|&quot;status was %4.4x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readw
c_func
(paren
id|ioaddr
op_plus
id|ChipCmd
)paren
)paren
suffix:semicolon
multiline_comment|/* Switch to loopback mode to avoid hardware races. */
id|writeb
c_func
(paren
id|rp-&gt;tx_thresh
op_or
l_int|0x02
comma
id|ioaddr
op_plus
id|TxConfig
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts by clearing the interrupt mask. */
id|writew
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
id|IntrEnable
)paren
suffix:semicolon
multiline_comment|/* Stop the chip&squot;s Tx and Rx processes. */
id|writew
c_func
(paren
id|CmdStop
comma
id|ioaddr
op_plus
id|ChipCmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|rp-&gt;lock
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|rp-&gt;pdev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|free_rbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_tbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_ring
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rhine_remove_one
r_static
r_void
id|__devexit
id|rhine_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
macro_line|#ifdef USE_MMIO
id|iounmap
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|dev-&gt;base_addr
)paren
)paren
suffix:semicolon
macro_line|#endif
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|rhine_shutdown
r_static
r_void
id|rhine_shutdown
(paren
r_struct
id|device
op_star
id|gendev
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|to_pci_dev
c_func
(paren
id|gendev
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|rhine_power_init
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Make sure we use pattern 0, 1 and not 4, 5 */
r_if
c_cond
(paren
id|rp-&gt;quirks
op_amp
id|rq6patterns
)paren
id|writeb
c_func
(paren
l_int|0x04
comma
id|ioaddr
op_plus
l_int|0xA7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;wolopts
op_amp
id|WAKE_MAGIC
)paren
id|writeb
c_func
(paren
id|WOLmagic
comma
id|ioaddr
op_plus
id|WOLcrSet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;wolopts
op_amp
(paren
id|WAKE_BCAST
op_or
id|WAKE_MCAST
)paren
)paren
id|writeb
c_func
(paren
id|WOLbmcast
comma
id|ioaddr
op_plus
id|WOLcgSet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;wolopts
op_amp
id|WAKE_PHY
)paren
id|writeb
c_func
(paren
id|WOLlnkon
op_or
id|WOLlnkoff
comma
id|ioaddr
op_plus
id|WOLcrSet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;wolopts
op_amp
id|WAKE_UCAST
)paren
id|writeb
c_func
(paren
id|WOLucast
comma
id|ioaddr
op_plus
id|WOLcrSet
)paren
suffix:semicolon
multiline_comment|/* Enable legacy WOL (for old motherboards) */
id|writeb
c_func
(paren
l_int|0x01
comma
id|ioaddr
op_plus
id|PwcfgSet
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|StickyHW
)paren
op_or
l_int|0x04
comma
id|ioaddr
op_plus
id|StickyHW
)paren
suffix:semicolon
multiline_comment|/* Hit power state D3 (sleep) */
id|writeb
c_func
(paren
id|readb
c_func
(paren
id|ioaddr
op_plus
id|StickyHW
)paren
op_or
l_int|0x03
comma
id|ioaddr
op_plus
id|StickyHW
)paren
suffix:semicolon
multiline_comment|/* TODO: Check use of pci_enable_wake() */
)brace
macro_line|#ifdef CONFIG_PM
DECL|function|rhine_suspend
r_static
r_int
id|rhine_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_save_state
c_func
(paren
id|pdev
comma
id|pdev-&gt;saved_config_space
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|rp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rhine_shutdown
c_func
(paren
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|rp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rhine_resume
r_static
r_int
id|rhine_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|rhine_private
op_star
id|rp
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
id|pci_set_power_state
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Entering power state D0 %s (%d).&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ret
ques
c_cond
l_string|&quot;failed&quot;
suffix:colon
l_string|&quot;succeeded&quot;
comma
id|ret
)paren
suffix:semicolon
id|pci_restore_state
c_func
(paren
id|pdev
comma
id|pdev-&gt;saved_config_space
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|rp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef USE_MMIO
id|enable_mmio
c_func
(paren
id|rp-&gt;pioaddr
comma
id|rp-&gt;quirks
)paren
suffix:semicolon
macro_line|#endif
id|rhine_power_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_tbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_rbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|alloc_tbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|alloc_rbufs
c_func
(paren
id|dev
)paren
suffix:semicolon
id|init_registers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|rp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PM */
DECL|variable|rhine_driver
r_static
r_struct
id|pci_driver
id|rhine_driver
op_assign
(brace
dot
id|name
op_assign
id|DRV_NAME
comma
dot
id|id_table
op_assign
id|rhine_pci_tbl
comma
dot
id|probe
op_assign
id|rhine_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|rhine_remove_one
)paren
comma
macro_line|#ifdef CONFIG_PM
dot
id|suspend
op_assign
id|rhine_suspend
comma
dot
id|resume
op_assign
id|rhine_resume
comma
macro_line|#endif /* CONFIG_PM */
dot
id|driver
op_assign
(brace
dot
id|shutdown
op_assign
id|rhine_shutdown
comma
)brace
)brace
suffix:semicolon
DECL|function|rhine_init
r_static
r_int
id|__init
id|rhine_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* when a module, this is printed whether or not devices are found in probe */
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
macro_line|#endif
r_return
id|pci_module_init
c_func
(paren
op_amp
id|rhine_driver
)paren
suffix:semicolon
)brace
DECL|function|rhine_cleanup
r_static
r_void
id|__exit
id|rhine_cleanup
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|rhine_driver
)paren
suffix:semicolon
)brace
DECL|variable|rhine_init
id|module_init
c_func
(paren
id|rhine_init
)paren
suffix:semicolon
DECL|variable|rhine_cleanup
id|module_exit
c_func
(paren
id|rhine_cleanup
)paren
suffix:semicolon
eof
