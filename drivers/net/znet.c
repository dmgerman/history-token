multiline_comment|/* znet.c: An Zenith Z-Note ethernet driver for linux. */
multiline_comment|/*&n;&t;Written by Donald Becker.&n;&n;&t;The author may be reached as becker@scyld.com.&n;&t;This driver is based on the Linux skeleton driver.  The copyright of the&n;&t;skeleton driver is held by the United States Government, as represented&n;&t;by DIRNSA, and it is released under the GPL.&n;&n;&t;Thanks to Mike Hollick for alpha testing and suggestions.&n;&n;  References:&n;&t;   The Crynwr packet driver.&n;&n;&t;  &quot;82593 CSMA/CD Core LAN Controller&quot; Intel datasheet, 1992&n;&t;  Intel Microcommunications Databook, Vol. 1, 1990.&n;    As usual with Intel, the documentation is incomplete and inaccurate.&n;&t;I had to read the Crynwr packet driver to figure out how to actually&n;&t;use the i82593, and guess at what register bits matched the loosely&n;&t;related i82586.&n;&n;&t;&t;&t;&t;&t;Theory of Operation&n;&n;&t;The i82593 used in the Zenith Z-Note series operates using two(!) slave&n;&t;DMA&t;channels, one interrupt, and one 8-bit I/O port.&n;&n;&t;While there&t;several ways to configure &squot;593 DMA system, I chose the one&n;&t;that seemed commensurate with the highest system performance in the face&n;&t;of moderate interrupt latency: Both DMA channels are configured as&n;&t;recirculating ring buffers, with one channel (#0) dedicated to Rx and&n;&t;the other channel (#1) to Tx and configuration.  (Note that this is&n;&t;different than the Crynwr driver, where the Tx DMA channel is initialized&n;&t;before each operation.  That approach simplifies operation and Tx error&n;&t;recovery, but requires additional I/O in normal operation and precludes&n;&t;transmit buffer&t;chaining.)&n;&n;&t;Both rings are set to 8192 bytes using {TX,RX}_RING_SIZE.  This provides&n;&t;a reasonable ring size for Rx, while simplifying DMA buffer allocation --&n;&t;DMA buffers must not cross a 128K boundary.  (In truth the size selection&n;&t;was influenced by my lack of &squot;593 documentation.  I thus was constrained&n;&t;to use the Crynwr &squot;593 initialization table, which sets the Rx ring size&n;&t;to 8K.)&n;&n;&t;Despite my usual low opinion about Intel-designed parts, I must admit&n;&t;that the bulk data handling of the i82593 is a good design for&n;&t;an integrated system, like a laptop, where using two slave DMA channels&n;&t;doesn&squot;t pose a problem.  I still take issue with using only a single I/O&n;&t;port.  In the same controlled environment there are essentially no&n;&t;limitations on I/O space, and using multiple locations would eliminate&n;&t;the&t;need for multiple operations when looking at status registers,&n;&t;setting the Rx ring boundary, or switching to promiscuous mode.&n;&n;&t;I also question Zenith&squot;s selection of the &squot;593: one of the advertised&n;&t;advantages of earlier Intel parts was that if you figured out the magic&n;&t;initialization incantation you could use the same part on many different&n;&t;network types.  Zenith&squot;s use of the &quot;FriendlyNet&quot; (sic) connector rather&n;&t;than an&t;on-board transceiver leads me to believe that they were planning&n;&t;to take advantage of this.  But, uhmmm, the &squot;593 omits all but ethernet&n;&t;functionality from the serial subsystem.&n; */
multiline_comment|/* 10/2002&n;&n;   o Resurected for Linux 2.5+ by Marc Zyngier &lt;maz@wild-wind.fr.eu.org&gt; :&n;&n;   - Removed strange DMA snooping in znet_sent_packet, which lead to&n;     TX buffer corruption on my laptop.&n;   - Use init_etherdev stuff.&n;   - Use kmalloc-ed DMA buffers.&n;   - Use as few global variables as possible.&n;   - Use proper resources management.&n;   - Use wireless/i82593.h as much as possible (structure, constants)&n;   - Compiles as module or build-in.&n;   - Now survives unplugging/replugging cable.&n;&n;   Some code was taken from wavelan_cs.&n;   &n;   Tested on a vintage Zenith Z-Note 433Lnp+. Probably broken on&n;   anything else. Testers (and detailed bug reports) are welcome :-).&n;&n;   o TODO :&n;&n;   - Properly handle multicast&n;   - Understand why some traffic patterns add a 1s latency...&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
multiline_comment|/* This include could be elsewhere, since it is not wireless specific */
macro_line|#include &quot;wireless/i82593.h&quot;
DECL|variable|__initdata
r_static
r_char
id|version
(braket
)braket
id|__initdata
op_assign
l_string|&quot;znet.c:v1.02 9/23/94 becker@scyld.com&bslash;n&quot;
suffix:semicolon
macro_line|#ifndef ZNET_DEBUG
DECL|macro|ZNET_DEBUG
mdefine_line|#define ZNET_DEBUG 1
macro_line|#endif
DECL|variable|znet_debug
r_static
r_int
r_int
id|znet_debug
op_assign
id|ZNET_DEBUG
suffix:semicolon
id|MODULE_PARM
(paren
id|znet_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
(paren
id|znet_debug
comma
l_string|&quot;ZNet debug level&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* The DMA modes we need aren&squot;t in &lt;dma.h&gt;. */
DECL|macro|DMA_RX_MODE
mdefine_line|#define DMA_RX_MODE&t;&t;0x14&t;/* Auto init, I/O to mem, ++, demand. */
DECL|macro|DMA_TX_MODE
mdefine_line|#define DMA_TX_MODE&t;&t;0x18&t;/* Auto init, Mem to I/O, ++, demand. */
DECL|macro|dma_page_eq
mdefine_line|#define dma_page_eq(ptr1, ptr2) ((long)(ptr1)&gt;&gt;17 == (long)(ptr2)&gt;&gt;17)
DECL|macro|RX_BUF_SIZE
mdefine_line|#define RX_BUF_SIZE 8192
DECL|macro|TX_BUF_SIZE
mdefine_line|#define TX_BUF_SIZE 8192
DECL|macro|DMA_BUF_SIZE
mdefine_line|#define DMA_BUF_SIZE (RX_BUF_SIZE + 16)&t;/* 8k + 16 bytes for trailers */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT&t;10
DECL|struct|znet_private
r_struct
id|znet_private
(brace
DECL|member|rx_dma
DECL|member|tx_dma
r_int
id|rx_dma
comma
id|tx_dma
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|sia_base
DECL|member|sia_size
DECL|member|io_size
r_int
id|sia_base
comma
id|sia_size
comma
id|io_size
suffix:semicolon
DECL|member|i593_init
r_struct
id|i82593_conf_block
id|i593_init
suffix:semicolon
multiline_comment|/* The starting, current, and end pointers for the packet buffers. */
DECL|member|rx_start
DECL|member|rx_cur
DECL|member|rx_end
id|ushort
op_star
id|rx_start
comma
op_star
id|rx_cur
comma
op_star
id|rx_end
suffix:semicolon
DECL|member|tx_start
DECL|member|tx_cur
DECL|member|tx_end
id|ushort
op_star
id|tx_start
comma
op_star
id|tx_cur
comma
op_star
id|tx_end
suffix:semicolon
DECL|member|tx_buf_len
id|ushort
id|tx_buf_len
suffix:semicolon
multiline_comment|/* Tx buffer length, in words. */
)brace
suffix:semicolon
multiline_comment|/* Only one can be built-in;-&gt; */
DECL|variable|znet_dev
r_static
r_struct
id|net_device
op_star
id|znet_dev
suffix:semicolon
DECL|struct|netidblk
r_struct
id|netidblk
(brace
DECL|member|magic
r_char
id|magic
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* The magic number (string) &quot;NETIDBLK&quot; */
DECL|member|netid
r_int
r_char
id|netid
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* The physical station address */
DECL|member|nettype
DECL|member|globalopt
r_char
id|nettype
comma
id|globalopt
suffix:semicolon
DECL|member|vendor
r_char
id|vendor
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* The machine vendor and product name. */
DECL|member|product
r_char
id|product
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|irq1
DECL|member|irq2
r_char
id|irq1
comma
id|irq2
suffix:semicolon
multiline_comment|/* Interrupts, only one is currently used.&t;*/
DECL|member|dma1
DECL|member|dma2
r_char
id|dma1
comma
id|dma2
suffix:semicolon
DECL|member|dma_mem_misc
r_int
id|dma_mem_misc
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* DMA buffer locations (unused in Linux). */
DECL|member|iobase1
DECL|member|iosize1
r_int
id|iobase1
comma
id|iosize1
suffix:semicolon
DECL|member|iobase2
DECL|member|iosize2
r_int
id|iobase2
comma
id|iosize2
suffix:semicolon
multiline_comment|/* Second iobase unused. */
DECL|member|driver_options
r_char
id|driver_options
suffix:semicolon
multiline_comment|/* Misc. bits */
DECL|member|pad
r_char
id|pad
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|znet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|znet_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|znet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|znet_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|znet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|hardware_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|update_stop_hit
c_func
(paren
r_int
id|ioaddr
comma
r_int
r_int
id|rx_stop_offset
)paren
suffix:semicolon
r_static
r_void
id|znet_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Request needed resources */
DECL|function|znet_request_resources
r_static
r_int
id|znet_request_resources
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|znet_private
op_star
id|znet
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
(paren
id|dev-&gt;irq
comma
op_amp
id|znet_interrupt
comma
l_int|0
comma
l_string|&quot;ZNet&quot;
comma
id|dev
)paren
)paren
r_goto
id|failed
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
(paren
id|znet-&gt;rx_dma
comma
l_string|&quot;ZNet rx&quot;
)paren
)paren
r_goto
id|free_irq
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
(paren
id|znet-&gt;tx_dma
comma
l_string|&quot;ZNet tx&quot;
)paren
)paren
r_goto
id|free_rx_dma
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
(paren
id|znet-&gt;sia_base
comma
id|znet-&gt;sia_size
comma
l_string|&quot;ZNet SIA&quot;
)paren
)paren
r_goto
id|free_tx_dma
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
(paren
id|dev-&gt;base_addr
comma
id|znet-&gt;io_size
comma
l_string|&quot;ZNet I/O&quot;
)paren
)paren
r_goto
id|free_sia
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Happy ! */
id|free_sia
suffix:colon
id|release_region
(paren
id|znet-&gt;sia_base
comma
id|znet-&gt;sia_size
)paren
suffix:semicolon
id|free_tx_dma
suffix:colon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|free_dma
(paren
id|znet-&gt;tx_dma
)paren
suffix:semicolon
id|release_dma_lock
(paren
id|flags
)paren
suffix:semicolon
id|free_rx_dma
suffix:colon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|free_dma
(paren
id|znet-&gt;rx_dma
)paren
suffix:semicolon
id|release_dma_lock
(paren
id|flags
)paren
suffix:semicolon
id|free_irq
suffix:colon
id|free_irq
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|failed
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|znet_release_resources
r_static
r_void
id|znet_release_resources
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|znet_private
op_star
id|znet
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|release_region
(paren
id|znet-&gt;sia_base
comma
id|znet-&gt;sia_size
)paren
suffix:semicolon
id|release_region
(paren
id|dev-&gt;base_addr
comma
id|znet-&gt;io_size
)paren
suffix:semicolon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|free_dma
(paren
id|znet-&gt;tx_dma
)paren
suffix:semicolon
id|free_dma
(paren
id|znet-&gt;rx_dma
)paren
suffix:semicolon
id|release_dma_lock
(paren
id|flags
)paren
suffix:semicolon
id|free_irq
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Keep the magical SIA stuff in a single function... */
DECL|function|znet_transceiver_power
r_static
r_void
id|znet_transceiver_power
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|on
)paren
(brace
r_struct
id|znet_private
op_star
id|znet
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_char
id|v
suffix:semicolon
multiline_comment|/* Turn on/off the 82501 SIA, using zenith-specific magic. */
multiline_comment|/* Select LAN control register */
id|outb
c_func
(paren
l_int|0x10
comma
id|znet-&gt;sia_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|v
op_assign
id|inb
c_func
(paren
id|znet-&gt;sia_base
op_plus
l_int|1
)paren
op_or
l_int|0x84
suffix:semicolon
r_else
id|v
op_assign
id|inb
c_func
(paren
id|znet-&gt;sia_base
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|0x84
suffix:semicolon
id|outb
c_func
(paren
id|v
comma
id|znet-&gt;sia_base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Turn on/off LAN power (bit 2). */
)brace
multiline_comment|/* Init the i82593, with current promisc/mcast configuration.&n;   Also used from hardware_init. */
DECL|function|znet_set_multicast_list
r_static
r_void
id|znet_set_multicast_list
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|znet_private
op_star
id|znet
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|i82593_conf_block
op_star
id|cfblk
op_assign
op_amp
id|znet-&gt;i593_init
suffix:semicolon
id|memset
c_func
(paren
id|cfblk
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|i82593_conf_block
)paren
)paren
suffix:semicolon
multiline_comment|/* The configuration block.  What an undocumented nightmare.&n;&t;   The first set of values are those suggested (without explanation)&n;&t;   for ethernet in the Intel 82586 databook.  The rest appear to be&n;&t;   completely undocumented, except for cryptic notes in the Crynwr&n;&t;   packet driver.  This driver uses the Crynwr values verbatim. */
multiline_comment|/* maz : Rewritten to take advantage of the wanvelan includes.&n;&t;   At least we have names, not just blind values */
multiline_comment|/* Byte 0 */
id|cfblk-&gt;fifo_limit
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* = 16 B rx and 80 B tx fifo thresholds */
id|cfblk-&gt;forgnesi
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0=82C501, 1=AMD7992B compatibility */
id|cfblk-&gt;fifo_32
op_assign
l_int|1
suffix:semicolon
id|cfblk-&gt;d6mod
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Run in i82593 advanced mode */
id|cfblk-&gt;throttle_enb
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Byte 1 */
id|cfblk-&gt;throttle
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* Continuous w/interrupts, 128-clock DMA. */
id|cfblk-&gt;cntrxint
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* enable continuous mode receive interrupts */
id|cfblk-&gt;contin
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* enable continuous mode */
multiline_comment|/* Byte 2 */
id|cfblk-&gt;addr_len
op_assign
id|ETH_ALEN
suffix:semicolon
id|cfblk-&gt;acloc
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Disable source addr insertion by i82593 */
id|cfblk-&gt;preamb_len
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* 8 bytes preamble */
id|cfblk-&gt;loopback
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Loopback off */
multiline_comment|/* Byte 3 */
id|cfblk-&gt;lin_prio
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Default priorities &amp; backoff methods. */
id|cfblk-&gt;tbofstop
op_assign
l_int|0
suffix:semicolon
id|cfblk-&gt;exp_prio
op_assign
l_int|0
suffix:semicolon
id|cfblk-&gt;bof_met
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Byte 4 */
id|cfblk-&gt;ifrm_spc
op_assign
l_int|6
suffix:semicolon
multiline_comment|/* 96 bit times interframe spacing */
multiline_comment|/* Byte 5 */
id|cfblk-&gt;slottim_low
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 512 bit times slot time (low) */
multiline_comment|/* Byte 6 */
id|cfblk-&gt;slottim_hi
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* 512 bit times slot time (high) */
id|cfblk-&gt;max_retr
op_assign
l_int|15
suffix:semicolon
multiline_comment|/* 15 collisions retries */
multiline_comment|/* Byte 7 */
id|cfblk-&gt;prmisc
op_assign
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Promiscuous mode */
id|cfblk-&gt;bc_dis
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Enable broadcast reception */
id|cfblk-&gt;crs_1
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Don&squot;t transmit without carrier sense */
id|cfblk-&gt;nocrc_ins
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* i82593 generates CRC */
id|cfblk-&gt;crc_1632
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 32-bit Autodin-II CRC */
id|cfblk-&gt;crs_cdt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CD not to be interpreted as CS */
multiline_comment|/* Byte 8 */
id|cfblk-&gt;cs_filter
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CS is recognized immediately */
id|cfblk-&gt;crs_src
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* External carrier sense */
id|cfblk-&gt;cd_filter
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CD is recognized immediately */
multiline_comment|/* Byte 9 */
id|cfblk-&gt;min_fr_len
op_assign
id|ETH_ZLEN
op_rshift
l_int|2
suffix:semicolon
multiline_comment|/* Minimum frame length */
multiline_comment|/* Byte A */
id|cfblk-&gt;lng_typ
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Type/length checks OFF */
id|cfblk-&gt;lng_fld
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Disable 802.3 length field check */
id|cfblk-&gt;rxcrc_xf
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t transfer CRC to memory */
id|cfblk-&gt;artx
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Disable automatic retransmission */
id|cfblk-&gt;sarec
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Disable source addr trig of CD */
id|cfblk-&gt;tx_jabber
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Disable jabber jam sequence */
id|cfblk-&gt;hash_1
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Use bits 0-5 in mc address hash */
id|cfblk-&gt;lbpkpol
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Loopback pin active high */
multiline_comment|/* Byte B */
id|cfblk-&gt;fdx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Disable full duplex operation */
multiline_comment|/* Byte C */
id|cfblk-&gt;dummy_6
op_assign
l_int|0x3f
suffix:semicolon
multiline_comment|/* all ones, Default multicast addresses &amp; backoff. */
id|cfblk-&gt;mult_ia
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No multiple individual addresses */
id|cfblk-&gt;dis_bof
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Disable the backoff algorithm ?! */
multiline_comment|/* Byte D */
id|cfblk-&gt;dummy_1
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* set to 1 */
id|cfblk-&gt;tx_ifs_retrig
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Hmm... Disabled */
id|cfblk-&gt;mc_all
op_assign
(paren
id|dev-&gt;mc_list
op_logical_or
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
)paren
suffix:semicolon
multiline_comment|/* multicast all mode */
id|cfblk-&gt;rcv_mon
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Monitor mode disabled */
id|cfblk-&gt;frag_acpt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Do not accept fragments */
id|cfblk-&gt;tstrttrs
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No start transmission threshold */
multiline_comment|/* Byte E */
id|cfblk-&gt;fretx
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* FIFO automatic retransmission */
id|cfblk-&gt;runt_eop
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* drop &quot;runt&quot; packets */
id|cfblk-&gt;hw_sw_pin
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ?? */
id|cfblk-&gt;big_endn
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Big Endian ? no... */
id|cfblk-&gt;syncrqs
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Synchronous DRQ deassertion... */
id|cfblk-&gt;sttlen
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 6 byte status registers */
id|cfblk-&gt;rx_eop
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Signal EOP on packet reception */
id|cfblk-&gt;tx_eop
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Signal EOP on packet transmission */
multiline_comment|/* Byte F */
id|cfblk-&gt;rbuf_size
op_assign
id|RX_BUF_SIZE
op_rshift
l_int|12
suffix:semicolon
multiline_comment|/* Set receive buffer size */
id|cfblk-&gt;rcvstop
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Enable Receive Stop Register */
r_if
c_cond
(paren
id|znet_debug
OG
l_int|2
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|c
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|c
op_assign
(paren
r_char
op_star
)paren
id|cfblk
suffix:semicolon
id|i
OL
r_sizeof
(paren
op_star
id|cfblk
)paren
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
l_string|&quot;%02X &quot;
comma
id|c
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
op_star
id|znet-&gt;tx_cur
op_increment
op_assign
r_sizeof
(paren
r_struct
id|i82593_conf_block
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|znet-&gt;tx_cur
comma
id|cfblk
comma
r_sizeof
(paren
r_struct
id|i82593_conf_block
)paren
)paren
suffix:semicolon
id|znet-&gt;tx_cur
op_add_assign
r_sizeof
(paren
r_struct
id|i82593_conf_block
)paren
op_div
l_int|2
suffix:semicolon
id|outb
c_func
(paren
id|OP0_CONFIGURE
op_or
id|CR0_CHNL
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* XXX FIXME maz : Add multicast addresses here, so having a&n;&t; * multicast address configured isn&squot;t equal to IFF_ALLMULTI */
)brace
"&f;"
multiline_comment|/* The Z-Note probe is pretty easy.  The NETIDBLK exists in the safe-to-probe&n;   BIOS area.  We just scan for the signature, and pull the vital parameters&n;   out of the structure. */
DECL|function|znet_probe
r_static
r_int
id|__init
id|znet_probe
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|netidblk
op_star
id|netinfo
suffix:semicolon
r_struct
id|znet_private
op_star
id|znet
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* This code scans the region 0xf0000 to 0xfffff for a &quot;NETIDBLK&quot;. */
r_for
c_loop
(paren
id|p
op_assign
(paren
r_char
op_star
)paren
id|phys_to_virt
c_func
(paren
l_int|0xf0000
)paren
suffix:semicolon
id|p
OL
(paren
r_char
op_star
)paren
id|phys_to_virt
c_func
(paren
l_int|0x100000
)paren
suffix:semicolon
id|p
op_increment
)paren
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;N&squot;
op_logical_and
id|strncmp
c_func
(paren
id|p
comma
l_string|&quot;NETIDBLK&quot;
comma
l_int|8
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ge
(paren
r_char
op_star
)paren
id|phys_to_virt
c_func
(paren
l_int|0x100000
)paren
)paren
(brace
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;No Z-Note ethernet adaptor found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|znet_private
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|SET_MODULE_OWNER
(paren
id|dev
)paren
suffix:semicolon
id|znet
op_assign
id|dev-&gt;priv
suffix:semicolon
id|netinfo
op_assign
(paren
r_struct
id|netidblk
op_star
)paren
id|p
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|netinfo-&gt;iobase1
suffix:semicolon
id|dev-&gt;irq
op_assign
id|netinfo-&gt;irq1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ZNET at %#3lx,&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
multiline_comment|/* The station address is in the &quot;netidblk&quot; at 0x0f0000. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %2.2x&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|netinfo-&gt;netid
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, using IRQ %d DMA %d and %d.&bslash;n&quot;
comma
id|dev-&gt;irq
comma
id|netinfo-&gt;dma1
comma
id|netinfo-&gt;dma2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: vendor &squot;%16.16s&squot; IRQ1 %d IRQ2 %d DMA1 %d DMA2 %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|netinfo-&gt;vendor
comma
id|netinfo-&gt;irq1
comma
id|netinfo-&gt;irq2
comma
id|netinfo-&gt;dma1
comma
id|netinfo-&gt;dma2
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: iobase1 %#x size %d iobase2 %#x size %d net type %2.2x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|netinfo-&gt;iobase1
comma
id|netinfo-&gt;iosize1
comma
id|netinfo-&gt;iobase2
comma
id|netinfo-&gt;iosize2
comma
id|netinfo-&gt;nettype
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|znet_debug
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|znet-&gt;rx_dma
op_assign
id|netinfo-&gt;dma1
suffix:semicolon
id|znet-&gt;tx_dma
op_assign
id|netinfo-&gt;dma2
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|znet-&gt;lock
)paren
suffix:semicolon
id|znet-&gt;sia_base
op_assign
l_int|0xe6
suffix:semicolon
multiline_comment|/* Magic address for the 82501 SIA */
id|znet-&gt;sia_size
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* maz: Despite the &squot;593 being advertised above as using a&n;&t; * single 8bits I/O port, this driver does many 16bits&n;&t; * access. So set io_size accordingly */
id|znet-&gt;io_size
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|znet-&gt;rx_start
op_assign
id|kmalloc
(paren
id|DMA_BUF_SIZE
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
r_goto
id|free_dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|znet-&gt;tx_start
op_assign
id|kmalloc
(paren
id|DMA_BUF_SIZE
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
r_goto
id|free_rx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma_page_eq
(paren
id|znet-&gt;rx_start
comma
id|znet-&gt;rx_start
op_plus
(paren
id|RX_BUF_SIZE
op_div
l_int|2
op_minus
l_int|1
)paren
)paren
op_logical_or
op_logical_neg
id|dma_page_eq
(paren
id|znet-&gt;tx_start
comma
id|znet-&gt;tx_start
op_plus
(paren
id|TX_BUF_SIZE
op_div
l_int|2
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;tx/rx crossing DMA frontiers, giving up&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|free_tx
suffix:semicolon
)brace
id|znet-&gt;rx_end
op_assign
id|znet-&gt;rx_start
op_plus
id|RX_BUF_SIZE
op_div
l_int|2
suffix:semicolon
id|znet-&gt;tx_buf_len
op_assign
id|TX_BUF_SIZE
op_div
l_int|2
suffix:semicolon
id|znet-&gt;tx_end
op_assign
id|znet-&gt;tx_start
op_plus
id|znet-&gt;tx_buf_len
suffix:semicolon
multiline_comment|/* The ZNET-specific entries in the device structure. */
id|dev-&gt;open
op_assign
op_amp
id|znet_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|znet_send_packet
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|znet_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|net_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|znet_set_multicast_list
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|znet_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|err
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|free_tx
suffix:semicolon
id|znet_dev
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|free_tx
suffix:colon
id|kfree
c_func
(paren
id|znet-&gt;tx_start
)paren
suffix:semicolon
id|free_rx
suffix:colon
id|kfree
c_func
(paren
id|znet-&gt;rx_start
)paren
suffix:semicolon
id|free_dev
suffix:colon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
"&f;"
DECL|function|znet_open
r_static
r_int
id|znet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: znet_open() called.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* These should never fail.  You can&squot;t add devices to a sealed box! */
r_if
c_cond
(paren
id|znet_request_resources
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Not opened -- resource busy?!?&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|znet_transceiver_power
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* According to the Crynwr driver we should wait 50 msec. for the&n;&t;   LAN clock to stabilize.  My experiments indicates that the &squot;593 can&n;&t;   be initialized immediately.  The delay is probably needed for the&n;&t;   DC-to-DC converter to come up to full voltage, and for the oscillator&n;&t;   to be spot-on at 20Mhz before transmitting.&n;&t;   Until this proves to be a problem we rely on the higher layers for the&n;&t;   delay and save allocating a timer entry. */
multiline_comment|/* maz : Well, I&squot;m getting every time the following message&n;&t; * without the delay on a 486@33. This machine is much too&n;&t; * fast... :-) So maybe the Crynwr driver wasn&squot;t wrong after&n;&t; * all, even if the message is completly harmless on my&n;&t; * setup. */
id|mdelay
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* This follows the packet driver&squot;s lead, and checks for success. */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
)paren
op_ne
l_int|0x10
op_logical_and
id|inb
c_func
(paren
id|ioaddr
)paren
op_ne
l_int|0x00
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Problem turning on the transceiver power.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hardware_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|znet_tx_timeout
r_static
r_void
id|znet_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|ushort
id|event
comma
id|tx_status
comma
id|rx_offset
comma
id|state
suffix:semicolon
id|outb
(paren
id|CR0_STATUS_0
comma
id|ioaddr
)paren
suffix:semicolon
id|event
op_assign
id|inb
(paren
id|ioaddr
)paren
suffix:semicolon
id|outb
(paren
id|CR0_STATUS_1
comma
id|ioaddr
)paren
suffix:semicolon
id|tx_status
op_assign
id|inw
(paren
id|ioaddr
)paren
suffix:semicolon
id|outb
(paren
id|CR0_STATUS_2
comma
id|ioaddr
)paren
suffix:semicolon
id|rx_offset
op_assign
id|inw
(paren
id|ioaddr
)paren
suffix:semicolon
id|outb
(paren
id|CR0_STATUS_3
comma
id|ioaddr
)paren
suffix:semicolon
id|state
op_assign
id|inb
(paren
id|ioaddr
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: transmit timed out, status %02x %04x %04x %02x,&quot;
l_string|&quot; resetting.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|event
comma
id|tx_status
comma
id|rx_offset
comma
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_eq
id|TX_LOST_CRS
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: Tx carrier error, check transceiver cable.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|outb
(paren
id|OP0_RESET
comma
id|ioaddr
)paren
suffix:semicolon
id|hardware_init
(paren
id|dev
)paren
suffix:semicolon
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|znet_send_packet
r_static
r_int
id|znet_send_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|znet_private
op_star
id|znet
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|length
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: ZNet_send_packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
id|ETH_ZLEN
)paren
(brace
id|skb
op_assign
id|skb_padto
c_func
(paren
id|skb
comma
id|ETH_ZLEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|length
op_assign
id|ETH_ZLEN
suffix:semicolon
)brace
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check that the part hasn&squot;t reset itself, probably from suspend. */
id|outb
c_func
(paren
id|CR0_STATUS_0
comma
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inw
c_func
(paren
id|ioaddr
)paren
op_eq
l_int|0x0010
op_logical_and
id|inw
c_func
(paren
id|ioaddr
)paren
op_eq
l_int|0x0000
op_logical_and
id|inw
c_func
(paren
id|ioaddr
)paren
op_eq
l_int|0x0010
)paren
(brace
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s : waking up&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|hardware_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|znet_transceiver_power
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|1
)paren
(brace
r_int
r_char
op_star
id|buf
op_assign
(paren
r_void
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|ushort
op_star
id|tx_link
op_assign
id|znet-&gt;tx_cur
op_minus
l_int|1
suffix:semicolon
id|ushort
id|rnd_len
op_assign
(paren
id|length
op_plus
l_int|1
)paren
op_rshift
l_int|1
suffix:semicolon
id|znet-&gt;stats.tx_bytes
op_add_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|znet-&gt;tx_cur
op_ge
id|znet-&gt;tx_end
)paren
id|znet-&gt;tx_cur
op_assign
id|znet-&gt;tx_start
suffix:semicolon
op_star
id|znet-&gt;tx_cur
op_increment
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|znet-&gt;tx_cur
op_plus
id|rnd_len
op_plus
l_int|1
OG
id|znet-&gt;tx_end
)paren
(brace
r_int
id|semi_cnt
op_assign
(paren
id|znet-&gt;tx_end
op_minus
id|znet-&gt;tx_cur
)paren
op_lshift
l_int|1
suffix:semicolon
multiline_comment|/* Cvrt to byte cnt. */
id|memcpy
c_func
(paren
id|znet-&gt;tx_cur
comma
id|buf
comma
id|semi_cnt
)paren
suffix:semicolon
id|rnd_len
op_sub_assign
id|semi_cnt
op_rshift
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|znet-&gt;tx_start
comma
id|buf
op_plus
id|semi_cnt
comma
id|length
op_minus
id|semi_cnt
)paren
suffix:semicolon
id|znet-&gt;tx_cur
op_assign
id|znet-&gt;tx_start
op_plus
id|rnd_len
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|znet-&gt;tx_cur
comma
id|buf
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|znet-&gt;tx_cur
op_add_assign
id|rnd_len
suffix:semicolon
)brace
op_star
id|znet-&gt;tx_cur
op_increment
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|znet-&gt;lock
comma
id|flags
)paren
suffix:semicolon
(brace
op_star
id|tx_link
op_assign
id|OP0_TRANSMIT
op_or
id|CR0_CHNL
suffix:semicolon
multiline_comment|/* Is this always safe to do? */
id|outb
c_func
(paren
id|OP0_TRANSMIT
op_or
id|CR0_CHNL
comma
id|ioaddr
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|znet-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|4
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Transmitter queued, length %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|length
)paren
suffix:semicolon
)brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The ZNET interrupt handler. */
DECL|function|znet_interrupt
r_static
id|irqreturn_t
id|znet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|znet_private
op_star
id|znet
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
suffix:semicolon
r_int
id|boguscnt
op_assign
l_int|20
suffix:semicolon
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;znet_interrupt(): IRQ %d for unknown device.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|spin_lock
(paren
op_amp
id|znet-&gt;lock
)paren
suffix:semicolon
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|outb
c_func
(paren
id|CR0_STATUS_0
comma
id|ioaddr
)paren
suffix:semicolon
r_do
(brace
id|ushort
id|status
op_assign
id|inb
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|5
)paren
(brace
id|ushort
id|result
comma
id|rx_ptr
comma
id|running
suffix:semicolon
id|outb
c_func
(paren
id|CR0_STATUS_1
comma
id|ioaddr
)paren
suffix:semicolon
id|result
op_assign
id|inw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CR0_STATUS_2
comma
id|ioaddr
)paren
suffix:semicolon
id|rx_ptr
op_assign
id|inw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CR0_STATUS_3
comma
id|ioaddr
)paren
suffix:semicolon
id|running
op_assign
id|inb
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: interrupt, status %02x, %04x %04x %02x serial %d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
comma
id|result
comma
id|rx_ptr
comma
id|running
comma
id|boguscnt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
id|SR0_INTERRUPT
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|SR0_EVENT_MASK
)paren
op_eq
id|SR0_TRANSMIT_DONE
op_logical_or
(paren
id|status
op_amp
id|SR0_EVENT_MASK
)paren
op_eq
id|SR0_RETRANSMIT_DONE
op_logical_or
(paren
id|status
op_amp
id|SR0_EVENT_MASK
)paren
op_eq
id|SR0_TRANSMIT_NO_CRC_DONE
)paren
(brace
r_int
id|tx_status
suffix:semicolon
id|outb
c_func
(paren
id|CR0_STATUS_1
comma
id|ioaddr
)paren
suffix:semicolon
id|tx_status
op_assign
id|inw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* It&squot;s undocumented, but tx_status seems to match the i82586. */
r_if
c_cond
(paren
id|tx_status
op_amp
id|TX_OK
)paren
(brace
id|znet-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|znet-&gt;stats.collisions
op_add_assign
id|tx_status
op_amp
id|TX_NCOL_MASK
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tx_status
op_amp
(paren
id|TX_LOST_CTS
op_or
id|TX_LOST_CRS
)paren
)paren
id|znet-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|TX_UND_RUN
)paren
id|znet-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tx_status
op_amp
id|TX_HRT_BEAT
)paren
)paren
id|znet-&gt;stats.tx_heartbeat_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tx_status
op_amp
id|TX_MAX_COL
)paren
id|znet-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
multiline_comment|/* ...and the catch-all. */
r_if
c_cond
(paren
(paren
id|tx_status
op_or
(paren
id|TX_LOST_CRS
op_or
id|TX_LOST_CTS
op_or
id|TX_UND_RUN
op_or
id|TX_HRT_BEAT
op_or
id|TX_MAX_COL
)paren
)paren
op_ne
(paren
id|TX_LOST_CRS
op_or
id|TX_LOST_CTS
op_or
id|TX_UND_RUN
op_or
id|TX_HRT_BEAT
op_or
id|TX_MAX_COL
)paren
)paren
id|znet-&gt;stats.tx_errors
op_increment
suffix:semicolon
multiline_comment|/* Transceiver may be stuck if cable&n;&t;&t;&t;&t; * was removed while emiting a&n;&t;&t;&t;&t; * packet. Flip it off, then on to&n;&t;&t;&t;&t; * reset it. This is very empirical,&n;&t;&t;&t;&t; * but it seems to work. */
id|znet_transceiver_power
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|znet_transceiver_power
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_amp
id|SR0_RECEPTION
)paren
op_logical_or
(paren
id|status
op_amp
id|SR0_EVENT_MASK
)paren
op_eq
id|SR0_STOP_REG_HIT
)paren
(brace
id|znet_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear the interrupts we&squot;ve handled. */
id|outb
c_func
(paren
id|CR0_INT_ACK
comma
id|ioaddr
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|boguscnt
op_decrement
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|znet-&gt;lock
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
DECL|function|znet_rx
r_static
r_void
id|znet_rx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|znet_private
op_star
id|znet
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
id|boguscount
op_assign
l_int|1
suffix:semicolon
r_int
id|next_frame_end_offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Offset of next frame start. */
r_int
op_star
id|cur_frame_end
suffix:semicolon
r_int
id|cur_frame_end_offset
suffix:semicolon
id|outb
c_func
(paren
id|CR0_STATUS_2
comma
id|ioaddr
)paren
suffix:semicolon
id|cur_frame_end_offset
op_assign
id|inw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cur_frame_end_offset
op_eq
id|znet-&gt;rx_cur
op_minus
id|znet-&gt;rx_start
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Interrupted, but nothing to receive, offset %03x.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|cur_frame_end_offset
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Use same method as the Crynwr driver: construct a forward list in&n;&t;   the same area of the backwards links we now have.  This allows us to&n;&t;   pass packets to the upper layers in the order they were received --&n;&t;   important for fast-path sequential operations. */
r_while
c_loop
(paren
id|znet-&gt;rx_start
op_plus
id|cur_frame_end_offset
op_ne
id|znet-&gt;rx_cur
op_logical_and
op_increment
id|boguscount
OL
l_int|5
)paren
(brace
r_int
r_int
id|hi_cnt
comma
id|lo_cnt
comma
id|hi_status
comma
id|lo_status
suffix:semicolon
r_int
id|count
comma
id|status
suffix:semicolon
r_if
c_cond
(paren
id|cur_frame_end_offset
OL
l_int|4
)paren
(brace
multiline_comment|/* Oh no, we have a special case: the frame trailer wraps around&n;&t;&t;&t;   the end of the ring buffer.  We&squot;ve saved space at the end of&n;&t;&t;&t;   the ring buffer for just this problem. */
id|memcpy
c_func
(paren
id|znet-&gt;rx_end
comma
id|znet-&gt;rx_start
comma
l_int|8
)paren
suffix:semicolon
id|cur_frame_end_offset
op_add_assign
(paren
id|RX_BUF_SIZE
op_div
l_int|2
)paren
suffix:semicolon
)brace
id|cur_frame_end
op_assign
id|znet-&gt;rx_start
op_plus
id|cur_frame_end_offset
op_minus
l_int|4
suffix:semicolon
id|lo_status
op_assign
op_star
id|cur_frame_end
op_increment
suffix:semicolon
id|hi_status
op_assign
op_star
id|cur_frame_end
op_increment
suffix:semicolon
id|status
op_assign
(paren
(paren
id|hi_status
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|lo_status
op_amp
l_int|0xff
)paren
suffix:semicolon
id|lo_cnt
op_assign
op_star
id|cur_frame_end
op_increment
suffix:semicolon
id|hi_cnt
op_assign
op_star
id|cur_frame_end
op_increment
suffix:semicolon
id|count
op_assign
(paren
(paren
id|hi_cnt
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
id|lo_cnt
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Constructing trailer at location %03x, %04x %04x %04x %04x&quot;
l_string|&quot; count %#x status %04x.&bslash;n&quot;
comma
id|cur_frame_end_offset
op_lshift
l_int|1
comma
id|lo_status
comma
id|hi_status
comma
id|lo_cnt
comma
id|hi_cnt
comma
id|count
comma
id|status
)paren
suffix:semicolon
id|cur_frame_end
(braket
op_minus
l_int|4
)braket
op_assign
id|status
suffix:semicolon
id|cur_frame_end
(braket
op_minus
l_int|3
)braket
op_assign
id|next_frame_end_offset
suffix:semicolon
id|cur_frame_end
(braket
op_minus
l_int|2
)braket
op_assign
id|count
suffix:semicolon
id|next_frame_end_offset
op_assign
id|cur_frame_end_offset
suffix:semicolon
id|cur_frame_end_offset
op_sub_assign
(paren
(paren
id|count
op_plus
l_int|1
)paren
op_rshift
l_int|1
)paren
op_plus
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|cur_frame_end_offset
OL
l_int|0
)paren
id|cur_frame_end_offset
op_add_assign
id|RX_BUF_SIZE
op_div
l_int|2
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Now step  forward through the list. */
r_do
(brace
id|ushort
op_star
id|this_rfp_ptr
op_assign
id|znet-&gt;rx_start
op_plus
id|next_frame_end_offset
suffix:semicolon
r_int
id|status
op_assign
id|this_rfp_ptr
(braket
op_minus
l_int|4
)braket
suffix:semicolon
r_int
id|pkt_len
op_assign
id|this_rfp_ptr
(braket
op_minus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Looking at trailer ending at %04x status %04x length %03x&quot;
l_string|&quot; next %04x.&bslash;n&quot;
comma
id|next_frame_end_offset
op_lshift
l_int|1
comma
id|status
comma
id|pkt_len
comma
id|this_rfp_ptr
(braket
op_minus
l_int|3
)braket
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Once again we must assume that the i82586 docs apply. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|RX_RCV_OK
)paren
)paren
(brace
multiline_comment|/* There was an error. */
id|znet-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_CRC_ERR
)paren
id|znet-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RX_ALG_ERR
)paren
id|znet-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0200
)paren
id|znet-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
multiline_comment|/* Wrong. */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x0100
)paren
id|znet-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
macro_line|#else
multiline_comment|/* maz : Wild guess... */
r_if
c_cond
(paren
id|status
op_amp
id|RX_OVRRUN
)paren
id|znet-&gt;stats.rx_over_errors
op_increment
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
op_amp
id|RX_SRT_FRM
)paren
id|znet-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pkt_len
OG
l_int|1536
)paren
(brace
id|znet-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Malloc up new buffer. */
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|znet_debug
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|znet-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_amp
id|znet-&gt;rx_cur
(braket
(paren
id|pkt_len
op_plus
l_int|1
)paren
op_rshift
l_int|1
)braket
OG
id|znet-&gt;rx_end
)paren
(brace
r_int
id|semi_cnt
op_assign
(paren
id|znet-&gt;rx_end
op_minus
id|znet-&gt;rx_cur
)paren
op_lshift
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|semi_cnt
)paren
comma
id|znet-&gt;rx_cur
comma
id|semi_cnt
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
op_minus
id|semi_cnt
)paren
comma
id|znet-&gt;rx_start
comma
id|pkt_len
op_minus
id|semi_cnt
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
comma
id|znet-&gt;rx_cur
comma
id|pkt_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|6
)paren
(brace
r_int
r_int
op_star
id|packet
op_assign
(paren
r_int
r_int
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Packet data is %08x %08x %08x %08x.&bslash;n&quot;
comma
id|packet
(braket
l_int|0
)braket
comma
id|packet
(braket
l_int|1
)braket
comma
id|packet
(braket
l_int|2
)braket
comma
id|packet
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|znet-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|znet-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
)brace
id|znet-&gt;rx_cur
op_assign
id|this_rfp_ptr
suffix:semicolon
r_if
c_cond
(paren
id|znet-&gt;rx_cur
op_ge
id|znet-&gt;rx_end
)paren
id|znet-&gt;rx_cur
op_sub_assign
id|RX_BUF_SIZE
op_div
l_int|2
suffix:semicolon
id|update_stop_hit
c_func
(paren
id|ioaddr
comma
(paren
id|znet-&gt;rx_cur
op_minus
id|znet-&gt;rx_start
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|next_frame_end_offset
op_assign
id|this_rfp_ptr
(braket
op_minus
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|next_frame_end_offset
op_eq
l_int|0
)paren
multiline_comment|/* Read all the frames? */
r_break
suffix:semicolon
multiline_comment|/* Done for now */
id|this_rfp_ptr
op_assign
id|znet-&gt;rx_start
op_plus
id|next_frame_end_offset
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|boguscount
)paren
suffix:semicolon
multiline_comment|/* If any worth-while packets have been received, dev_rint()&n;&t;   has done a mark_bh(INET_BH) for us and will work on them&n;&t;   when we get to the bottom-half routine. */
r_return
suffix:semicolon
)brace
multiline_comment|/* The inverse routine to znet_open(). */
DECL|function|znet_close
r_static
r_int
id|znet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
id|OP0_RESET
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* CMD0_RESET */
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Shutting down ethercard.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Turn off transceiver power. */
id|znet_transceiver_power
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|znet_release_resources
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Get the current statistics.&t;This may be called with the card open or&n;   closed. */
DECL|function|net_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|znet_private
op_star
id|znet
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|znet-&gt;stats
suffix:semicolon
)brace
DECL|function|show_dma
r_static
r_void
id|show_dma
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_char
id|stat
op_assign
id|inb
(paren
id|ioaddr
)paren
suffix:semicolon
r_struct
id|znet_private
op_star
id|znet
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|dma_port
op_assign
(paren
(paren
id|znet-&gt;tx_dma
op_amp
l_int|3
)paren
op_lshift
l_int|2
)paren
op_plus
id|IO_DMA2_BASE
suffix:semicolon
r_int
id|addr
op_assign
id|inb
c_func
(paren
id|dma_port
)paren
suffix:semicolon
r_int
id|residue
suffix:semicolon
id|addr
op_or_assign
id|inb
c_func
(paren
id|dma_port
)paren
op_lshift
l_int|8
suffix:semicolon
id|residue
op_assign
id|get_dma_residue
c_func
(paren
id|znet-&gt;tx_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
(brace
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Stat:%02x Addr: %04x cnt:%3x&bslash;n&quot;
comma
id|stat
comma
id|addr
op_lshift
l_int|1
comma
id|residue
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Initialize the hardware.  We have to do this when the board is open()ed&n;   or when we come out of suspend mode. */
DECL|function|hardware_init
r_static
r_void
id|hardware_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_struct
id|znet_private
op_star
id|znet
op_assign
id|dev-&gt;priv
suffix:semicolon
id|znet-&gt;rx_cur
op_assign
id|znet-&gt;rx_start
suffix:semicolon
id|znet-&gt;tx_cur
op_assign
id|znet-&gt;tx_start
suffix:semicolon
multiline_comment|/* Reset the chip, and start it up. */
id|outb
c_func
(paren
id|OP0_RESET
comma
id|ioaddr
)paren
suffix:semicolon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|znet-&gt;rx_dma
)paren
suffix:semicolon
multiline_comment|/* reset by an interrupting task. */
id|clear_dma_ff
c_func
(paren
id|znet-&gt;rx_dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|znet-&gt;rx_dma
comma
id|DMA_RX_MODE
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|znet-&gt;rx_dma
comma
(paren
r_int
r_int
)paren
id|znet-&gt;rx_start
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|znet-&gt;rx_dma
comma
id|RX_BUF_SIZE
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|znet-&gt;rx_dma
)paren
suffix:semicolon
multiline_comment|/* Now set up the Tx channel. */
id|disable_dma
c_func
(paren
id|znet-&gt;tx_dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|znet-&gt;tx_dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|znet-&gt;tx_dma
comma
id|DMA_TX_MODE
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|znet-&gt;tx_dma
comma
(paren
r_int
r_int
)paren
id|znet-&gt;tx_start
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|znet-&gt;tx_dma
comma
id|znet-&gt;tx_buf_len
op_lshift
l_int|1
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|znet-&gt;tx_dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Initializing the i82593, rx buf %p tx buf %p&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|znet-&gt;rx_start
comma
id|znet-&gt;tx_start
)paren
suffix:semicolon
multiline_comment|/* Do an empty configure command, just like the Crynwr driver.  This&n;&t;   resets to chip to its default values. */
op_star
id|znet-&gt;tx_cur
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|znet-&gt;tx_cur
op_increment
op_assign
l_int|0
suffix:semicolon
id|show_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
id|OP0_CONFIGURE
op_or
id|CR0_CHNL
comma
id|ioaddr
)paren
suffix:semicolon
id|znet_set_multicast_list
(paren
id|dev
)paren
suffix:semicolon
op_star
id|znet-&gt;tx_cur
op_increment
op_assign
l_int|6
suffix:semicolon
id|memcpy
c_func
(paren
id|znet-&gt;tx_cur
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
id|znet-&gt;tx_cur
op_add_assign
l_int|3
suffix:semicolon
id|show_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
id|outb
c_func
(paren
id|OP0_IA_SETUP
op_or
id|CR0_CHNL
comma
id|ioaddr
)paren
suffix:semicolon
id|show_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
id|update_stop_hit
c_func
(paren
id|ioaddr
comma
l_int|8192
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;enabling Rx.&bslash;n&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
id|OP0_RCV_ENABLE
comma
id|ioaddr
)paren
suffix:semicolon
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|update_stop_hit
r_static
r_void
id|update_stop_hit
c_func
(paren
r_int
id|ioaddr
comma
r_int
r_int
id|rx_stop_offset
)paren
(brace
id|outb
c_func
(paren
id|OP0_SWIT_TO_PORT_1
op_or
id|CR0_CHNL
comma
id|ioaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|znet_debug
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Updating stop hit with value %02x.&bslash;n&quot;
comma
(paren
id|rx_stop_offset
op_rshift
l_int|6
)paren
op_or
id|CR1_STOP_REG_UPDATE
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|rx_stop_offset
op_rshift
l_int|6
)paren
op_or
id|CR1_STOP_REG_UPDATE
comma
id|ioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|OP1_SWIT_TO_PORT_0
comma
id|ioaddr
)paren
suffix:semicolon
)brace
DECL|function|znet_cleanup
r_static
id|__exit
r_void
id|znet_cleanup
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|znet_dev
)paren
(brace
r_struct
id|znet_private
op_star
id|znet
op_assign
id|znet_dev-&gt;priv
suffix:semicolon
id|unregister_netdev
(paren
id|znet_dev
)paren
suffix:semicolon
id|kfree
(paren
id|znet-&gt;rx_start
)paren
suffix:semicolon
id|kfree
(paren
id|znet-&gt;tx_start
)paren
suffix:semicolon
id|free_netdev
(paren
id|znet_dev
)paren
suffix:semicolon
)brace
)brace
DECL|variable|znet_probe
id|module_init
(paren
id|znet_probe
)paren
suffix:semicolon
DECL|variable|znet_cleanup
id|module_exit
(paren
id|znet_cleanup
)paren
suffix:semicolon
eof
