multiline_comment|/*&n;    A Davicom DM9102/DM9102A/DM9102A+DM9801/DM9102A+DM9802 NIC fast&n;    ethernet driver for Linux.&n;    Copyright (C) 1997  Sten Wang&n;&n;    This program is free software; you can redistribute it and/or&n;    modify it under the terms of the GNU General Public License&n;    as published by the Free Software Foundation; either version 2&n;    of the License, or (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    DAVICOM Web-Site: www.davicom.com.tw&n;&n;    Author: Sten Wang, 886-3-5798797-8517, E-mail: sten_wang@davicom.com.tw&n;    Maintainer: Tobias Ringstrom &lt;tori@unhappy.mine.nu&gt;&n;&n;    (C)Copyright 1997-1998 DAVICOM Semiconductor,Inc. All Rights Reserved.&n;&n;    Marcelo Tosatti &lt;marcelo@conectiva.com.br&gt; :&n;    Made it compile in 2.3 (device to net_device)&n;&n;    Alan Cox &lt;alan@redhat.com&gt; :&n;    Cleaned up for kernel merge.&n;    Removed the back compatibility support&n;    Reformatted, fixing spelling etc as I went&n;    Removed IRQ 0-15 assumption&n;&n;    Jeff Garzik &lt;jgarzik@pobox.com&gt; :&n;    Updated to use new PCI driver API.&n;    Resource usage cleanups.&n;    Report driver version to user.&n;&n;    Tobias Ringstrom &lt;tori@unhappy.mine.nu&gt; :&n;    Cleaned up and added SMP safety.  Thanks go to Jeff Garzik,&n;    Andrew Morton and Frank Davis for the SMP safety fixes.&n;&n;    Vojtech Pavlik &lt;vojtech@suse.cz&gt; :&n;    Cleaned up pointer arithmetics.&n;    Fixed a lot of 64bit issues.&n;    Cleaned up printk()s a bit.&n;    Fixed some obvious big endian problems.&n;&n;    Tobias Ringstrom &lt;tori@unhappy.mine.nu&gt; :&n;    Use time_after for jiffies calculation.  Added ethtool&n;    support.  Updated PCI resource allocation.  Do not&n;    forget to unmap PCI mapped skbs.&n;&n;    Alan Cox &lt;alan@redhat.com&gt;&n;    Added new PCI identifiers provided by Clear Zhang at ALi &n;    for their 1563 ethernet device.&n;&n;    TODO&n;&n;    Implement pci_driver::suspend() and pci_driver::resume()&n;    power management methods.&n;&n;    Check on 64 bit boxes.&n;    Check and fix on big endian boxes.&n;&n;    Test and make sure PCI latency is now correct for all cases.&n;*/
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME&t;&quot;dmfe&quot;
DECL|macro|DRV_VERSION
mdefine_line|#define DRV_VERSION&t;&quot;1.36.4&quot;
DECL|macro|DRV_RELDATE
mdefine_line|#define DRV_RELDATE&t;&quot;2002-01-17&quot;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
multiline_comment|/* Board/System/Debug information/definition ---------------- */
DECL|macro|PCI_DM9132_ID
mdefine_line|#define PCI_DM9132_ID   0x91321282      /* Davicom DM9132 ID */
DECL|macro|PCI_DM9102_ID
mdefine_line|#define PCI_DM9102_ID   0x91021282      /* Davicom DM9102 ID */
DECL|macro|PCI_DM9100_ID
mdefine_line|#define PCI_DM9100_ID   0x91001282      /* Davicom DM9100 ID */
DECL|macro|PCI_DM9009_ID
mdefine_line|#define PCI_DM9009_ID   0x90091282      /* Davicom DM9009 ID */
DECL|macro|DM9102_IO_SIZE
mdefine_line|#define DM9102_IO_SIZE  0x80
DECL|macro|DM9102A_IO_SIZE
mdefine_line|#define DM9102A_IO_SIZE 0x100
DECL|macro|TX_MAX_SEND_CNT
mdefine_line|#define TX_MAX_SEND_CNT 0x1             /* Maximum tx packet per time */
DECL|macro|TX_DESC_CNT
mdefine_line|#define TX_DESC_CNT     0x10            /* Allocated Tx descriptors */
DECL|macro|RX_DESC_CNT
mdefine_line|#define RX_DESC_CNT     0x20            /* Allocated Rx descriptors */
DECL|macro|TX_FREE_DESC_CNT
mdefine_line|#define TX_FREE_DESC_CNT (TX_DESC_CNT - 2)&t;/* Max TX packet count */
DECL|macro|TX_WAKE_DESC_CNT
mdefine_line|#define TX_WAKE_DESC_CNT (TX_DESC_CNT - 3)&t;/* TX wakeup count */
DECL|macro|DESC_ALL_CNT
mdefine_line|#define DESC_ALL_CNT    (TX_DESC_CNT + RX_DESC_CNT)
DECL|macro|TX_BUF_ALLOC
mdefine_line|#define TX_BUF_ALLOC    0x600
DECL|macro|RX_ALLOC_SIZE
mdefine_line|#define RX_ALLOC_SIZE   0x620
DECL|macro|DM910X_RESET
mdefine_line|#define DM910X_RESET    1
DECL|macro|CR0_DEFAULT
mdefine_line|#define CR0_DEFAULT     0x00E00000      /* TX &amp; RX burst mode */
DECL|macro|CR6_DEFAULT
mdefine_line|#define CR6_DEFAULT     0x00080000      /* HD */
DECL|macro|CR7_DEFAULT
mdefine_line|#define CR7_DEFAULT     0x180c1
DECL|macro|CR15_DEFAULT
mdefine_line|#define CR15_DEFAULT    0x06            /* TxJabber RxWatchdog */
DECL|macro|TDES0_ERR_MASK
mdefine_line|#define TDES0_ERR_MASK  0x4302          /* TXJT, LC, EC, FUE */
DECL|macro|MAX_PACKET_SIZE
mdefine_line|#define MAX_PACKET_SIZE 1514
DECL|macro|DMFE_MAX_MULTICAST
mdefine_line|#define DMFE_MAX_MULTICAST 14
DECL|macro|RX_COPY_SIZE
mdefine_line|#define RX_COPY_SIZE&t;100
DECL|macro|MAX_CHECK_PACKET
mdefine_line|#define MAX_CHECK_PACKET 0x8000
DECL|macro|DM9801_NOISE_FLOOR
mdefine_line|#define DM9801_NOISE_FLOOR 8
DECL|macro|DM9802_NOISE_FLOOR
mdefine_line|#define DM9802_NOISE_FLOOR 5
DECL|macro|DMFE_10MHF
mdefine_line|#define DMFE_10MHF      0
DECL|macro|DMFE_100MHF
mdefine_line|#define DMFE_100MHF     1
DECL|macro|DMFE_10MFD
mdefine_line|#define DMFE_10MFD      4
DECL|macro|DMFE_100MFD
mdefine_line|#define DMFE_100MFD     5
DECL|macro|DMFE_AUTO
mdefine_line|#define DMFE_AUTO       8
DECL|macro|DMFE_1M_HPNA
mdefine_line|#define DMFE_1M_HPNA    0x10
DECL|macro|DMFE_TXTH_72
mdefine_line|#define DMFE_TXTH_72&t;0x400000&t;/* TX TH 72 byte */
DECL|macro|DMFE_TXTH_96
mdefine_line|#define DMFE_TXTH_96&t;0x404000&t;/* TX TH 96 byte */
DECL|macro|DMFE_TXTH_128
mdefine_line|#define DMFE_TXTH_128&t;0x0000&t;&t;/* TX TH 128 byte */
DECL|macro|DMFE_TXTH_256
mdefine_line|#define DMFE_TXTH_256&t;0x4000&t;&t;/* TX TH 256 byte */
DECL|macro|DMFE_TXTH_512
mdefine_line|#define DMFE_TXTH_512&t;0x8000&t;&t;/* TX TH 512 byte */
DECL|macro|DMFE_TXTH_1K
mdefine_line|#define DMFE_TXTH_1K&t;0xC000&t;&t;/* TX TH 1K  byte */
DECL|macro|DMFE_TIMER_WUT
mdefine_line|#define DMFE_TIMER_WUT  (jiffies + HZ * 1)/* timer wakeup time : 1 second */
DECL|macro|DMFE_TX_TIMEOUT
mdefine_line|#define DMFE_TX_TIMEOUT ((3*HZ)/2)&t;/* tx packet time-out time 1.5 s&quot; */
DECL|macro|DMFE_TX_KICK
mdefine_line|#define DMFE_TX_KICK &t;(HZ/2)&t;/* tx packet Kick-out time 0.5 s&quot; */
DECL|macro|DMFE_DBUG
mdefine_line|#define DMFE_DBUG(dbug_now, msg, value) if (dmfe_debug || (dbug_now)) printk(KERN_ERR DRV_NAME &quot;: %s %lx&bslash;n&quot;, (msg), (long) (value))
DECL|macro|SHOW_MEDIA_TYPE
mdefine_line|#define SHOW_MEDIA_TYPE(mode) printk(KERN_ERR DRV_NAME &quot;: Change Speed to %sMhz %s duplex&bslash;n&quot;,mode &amp; 1 ?&quot;100&quot;:&quot;10&quot;, mode &amp; 4 ? &quot;full&quot;:&quot;half&quot;);
multiline_comment|/* CR9 definition: SROM/MII */
DECL|macro|CR9_SROM_READ
mdefine_line|#define CR9_SROM_READ   0x4800
DECL|macro|CR9_SRCS
mdefine_line|#define CR9_SRCS        0x1
DECL|macro|CR9_SRCLK
mdefine_line|#define CR9_SRCLK       0x2
DECL|macro|CR9_CRDOUT
mdefine_line|#define CR9_CRDOUT      0x8
DECL|macro|SROM_DATA_0
mdefine_line|#define SROM_DATA_0     0x0
DECL|macro|SROM_DATA_1
mdefine_line|#define SROM_DATA_1     0x4
DECL|macro|PHY_DATA_1
mdefine_line|#define PHY_DATA_1      0x20000
DECL|macro|PHY_DATA_0
mdefine_line|#define PHY_DATA_0      0x00000
DECL|macro|MDCLKH
mdefine_line|#define MDCLKH          0x10000
DECL|macro|PHY_POWER_DOWN
mdefine_line|#define PHY_POWER_DOWN&t;0x800
DECL|macro|SROM_V41_CODE
mdefine_line|#define SROM_V41_CODE   0x14
DECL|macro|SROM_CLK_WRITE
mdefine_line|#define SROM_CLK_WRITE(data, ioaddr) outl(data|CR9_SROM_READ|CR9_SRCS,ioaddr);udelay(5);outl(data|CR9_SROM_READ|CR9_SRCS|CR9_SRCLK,ioaddr);udelay(5);outl(data|CR9_SROM_READ|CR9_SRCS,ioaddr);udelay(5);
DECL|macro|__CHK_IO_SIZE
mdefine_line|#define __CHK_IO_SIZE(pci_id, dev_rev) ( ((pci_id)==PCI_DM9132_ID) || ((dev_rev) &gt;= 0x02000030) ) ? DM9102A_IO_SIZE: DM9102_IO_SIZE
DECL|macro|CHK_IO_SIZE
mdefine_line|#define CHK_IO_SIZE(pci_dev, dev_rev) __CHK_IO_SIZE(((pci_dev)-&gt;device &lt;&lt; 16) | (pci_dev)-&gt;vendor, dev_rev)
multiline_comment|/* Sten Check */
DECL|macro|DEVICE
mdefine_line|#define DEVICE net_device
multiline_comment|/* Structure/enum declaration ------------------------------- */
DECL|struct|tx_desc
r_struct
id|tx_desc
(brace
DECL|member|tdes0
DECL|member|tdes1
DECL|member|tdes2
DECL|member|tdes3
id|u32
id|tdes0
comma
id|tdes1
comma
id|tdes2
comma
id|tdes3
suffix:semicolon
multiline_comment|/* Data for the card */
DECL|member|tx_buf_ptr
r_char
op_star
id|tx_buf_ptr
suffix:semicolon
multiline_comment|/* Data for us */
DECL|member|next_tx_desc
r_struct
id|tx_desc
op_star
id|next_tx_desc
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|aligned
c_func
(paren
l_int|32
)paren
)paren
)paren
suffix:semicolon
DECL|struct|rx_desc
r_struct
id|rx_desc
(brace
DECL|member|rdes0
DECL|member|rdes1
DECL|member|rdes2
DECL|member|rdes3
id|u32
id|rdes0
comma
id|rdes1
comma
id|rdes2
comma
id|rdes3
suffix:semicolon
multiline_comment|/* Data for the card */
DECL|member|rx_skb_ptr
r_struct
id|sk_buff
op_star
id|rx_skb_ptr
suffix:semicolon
multiline_comment|/* Data for us */
DECL|member|next_rx_desc
r_struct
id|rx_desc
op_star
id|next_rx_desc
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|aligned
c_func
(paren
l_int|32
)paren
)paren
)paren
suffix:semicolon
DECL|struct|dmfe_board_info
r_struct
id|dmfe_board_info
(brace
DECL|member|chip_id
id|u32
id|chip_id
suffix:semicolon
multiline_comment|/* Chip vendor/Device ID */
DECL|member|chip_revision
id|u32
id|chip_revision
suffix:semicolon
multiline_comment|/* Chip revision */
DECL|member|next_dev
r_struct
id|DEVICE
op_star
id|next_dev
suffix:semicolon
multiline_comment|/* next device */
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
multiline_comment|/* PCI device */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|ioaddr
r_int
id|ioaddr
suffix:semicolon
multiline_comment|/* I/O base address */
DECL|member|cr0_data
id|u32
id|cr0_data
suffix:semicolon
DECL|member|cr5_data
id|u32
id|cr5_data
suffix:semicolon
DECL|member|cr6_data
id|u32
id|cr6_data
suffix:semicolon
DECL|member|cr7_data
id|u32
id|cr7_data
suffix:semicolon
DECL|member|cr15_data
id|u32
id|cr15_data
suffix:semicolon
multiline_comment|/* pointer for memory physical address */
DECL|member|buf_pool_dma_ptr
id|dma_addr_t
id|buf_pool_dma_ptr
suffix:semicolon
multiline_comment|/* Tx buffer pool memory */
DECL|member|buf_pool_dma_start
id|dma_addr_t
id|buf_pool_dma_start
suffix:semicolon
multiline_comment|/* Tx buffer pool align dword */
DECL|member|desc_pool_dma_ptr
id|dma_addr_t
id|desc_pool_dma_ptr
suffix:semicolon
multiline_comment|/* descriptor pool memory */
DECL|member|first_tx_desc_dma
id|dma_addr_t
id|first_tx_desc_dma
suffix:semicolon
DECL|member|first_rx_desc_dma
id|dma_addr_t
id|first_rx_desc_dma
suffix:semicolon
multiline_comment|/* descriptor pointer */
DECL|member|buf_pool_ptr
r_int
r_char
op_star
id|buf_pool_ptr
suffix:semicolon
multiline_comment|/* Tx buffer pool memory */
DECL|member|buf_pool_start
r_int
r_char
op_star
id|buf_pool_start
suffix:semicolon
multiline_comment|/* Tx buffer pool align dword */
DECL|member|desc_pool_ptr
r_int
r_char
op_star
id|desc_pool_ptr
suffix:semicolon
multiline_comment|/* descriptor pool memory */
DECL|member|first_tx_desc
r_struct
id|tx_desc
op_star
id|first_tx_desc
suffix:semicolon
DECL|member|tx_insert_ptr
r_struct
id|tx_desc
op_star
id|tx_insert_ptr
suffix:semicolon
DECL|member|tx_remove_ptr
r_struct
id|tx_desc
op_star
id|tx_remove_ptr
suffix:semicolon
DECL|member|first_rx_desc
r_struct
id|rx_desc
op_star
id|first_rx_desc
suffix:semicolon
DECL|member|rx_insert_ptr
r_struct
id|rx_desc
op_star
id|rx_insert_ptr
suffix:semicolon
DECL|member|rx_ready_ptr
r_struct
id|rx_desc
op_star
id|rx_ready_ptr
suffix:semicolon
multiline_comment|/* packet come pointer */
DECL|member|tx_packet_cnt
r_int
r_int
id|tx_packet_cnt
suffix:semicolon
multiline_comment|/* transmitted packet count */
DECL|member|tx_queue_cnt
r_int
r_int
id|tx_queue_cnt
suffix:semicolon
multiline_comment|/* wait to send packet count */
DECL|member|rx_avail_cnt
r_int
r_int
id|rx_avail_cnt
suffix:semicolon
multiline_comment|/* available rx descriptor count */
DECL|member|interval_rx_cnt
r_int
r_int
id|interval_rx_cnt
suffix:semicolon
multiline_comment|/* rx packet count a callback time */
DECL|member|HPNA_command
id|u16
id|HPNA_command
suffix:semicolon
multiline_comment|/* For HPNA register 16 */
DECL|member|HPNA_timer
id|u16
id|HPNA_timer
suffix:semicolon
multiline_comment|/* For HPNA remote device check */
DECL|member|dbug_cnt
id|u16
id|dbug_cnt
suffix:semicolon
DECL|member|NIC_capability
id|u16
id|NIC_capability
suffix:semicolon
multiline_comment|/* NIC media capability */
DECL|member|PHY_reg4
id|u16
id|PHY_reg4
suffix:semicolon
multiline_comment|/* Saved Phyxcer register 4 value */
DECL|member|HPNA_present
id|u8
id|HPNA_present
suffix:semicolon
multiline_comment|/* 0:none, 1:DM9801, 2:DM9802 */
DECL|member|chip_type
id|u8
id|chip_type
suffix:semicolon
multiline_comment|/* Keep DM9102A chip type */
DECL|member|media_mode
id|u8
id|media_mode
suffix:semicolon
multiline_comment|/* user specify media mode */
DECL|member|op_mode
id|u8
id|op_mode
suffix:semicolon
multiline_comment|/* real work media mode */
DECL|member|phy_addr
id|u8
id|phy_addr
suffix:semicolon
DECL|member|link_failed
id|u8
id|link_failed
suffix:semicolon
multiline_comment|/* Ever link failed */
DECL|member|wait_reset
id|u8
id|wait_reset
suffix:semicolon
multiline_comment|/* Hardware failed, need to reset */
DECL|member|dm910x_chk_mode
id|u8
id|dm910x_chk_mode
suffix:semicolon
multiline_comment|/* Operating mode check */
DECL|member|first_in_callback
id|u8
id|first_in_callback
suffix:semicolon
multiline_comment|/* Flag to record state */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* System defined statistic counter */
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
multiline_comment|/* Driver defined statistic counter */
DECL|member|tx_fifo_underrun
r_int
r_int
id|tx_fifo_underrun
suffix:semicolon
DECL|member|tx_loss_carrier
r_int
r_int
id|tx_loss_carrier
suffix:semicolon
DECL|member|tx_no_carrier
r_int
r_int
id|tx_no_carrier
suffix:semicolon
DECL|member|tx_late_collision
r_int
r_int
id|tx_late_collision
suffix:semicolon
DECL|member|tx_excessive_collision
r_int
r_int
id|tx_excessive_collision
suffix:semicolon
DECL|member|tx_jabber_timeout
r_int
r_int
id|tx_jabber_timeout
suffix:semicolon
DECL|member|reset_count
r_int
r_int
id|reset_count
suffix:semicolon
DECL|member|reset_cr8
r_int
r_int
id|reset_cr8
suffix:semicolon
DECL|member|reset_fatal
r_int
r_int
id|reset_fatal
suffix:semicolon
DECL|member|reset_TXtimeout
r_int
r_int
id|reset_TXtimeout
suffix:semicolon
multiline_comment|/* NIC SROM data */
DECL|member|srom
r_int
r_char
id|srom
(braket
l_int|128
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|dmfe_offsets
r_enum
id|dmfe_offsets
(brace
DECL|enumerator|DCR0
DECL|enumerator|DCR1
DECL|enumerator|DCR2
DECL|enumerator|DCR3
DECL|enumerator|DCR4
id|DCR0
op_assign
l_int|0x00
comma
id|DCR1
op_assign
l_int|0x08
comma
id|DCR2
op_assign
l_int|0x10
comma
id|DCR3
op_assign
l_int|0x18
comma
id|DCR4
op_assign
l_int|0x20
comma
DECL|enumerator|DCR5
DECL|enumerator|DCR6
DECL|enumerator|DCR7
DECL|enumerator|DCR8
DECL|enumerator|DCR9
id|DCR5
op_assign
l_int|0x28
comma
id|DCR6
op_assign
l_int|0x30
comma
id|DCR7
op_assign
l_int|0x38
comma
id|DCR8
op_assign
l_int|0x40
comma
id|DCR9
op_assign
l_int|0x48
comma
DECL|enumerator|DCR10
DECL|enumerator|DCR11
DECL|enumerator|DCR12
DECL|enumerator|DCR13
DECL|enumerator|DCR14
id|DCR10
op_assign
l_int|0x50
comma
id|DCR11
op_assign
l_int|0x58
comma
id|DCR12
op_assign
l_int|0x60
comma
id|DCR13
op_assign
l_int|0x68
comma
id|DCR14
op_assign
l_int|0x70
comma
DECL|enumerator|DCR15
id|DCR15
op_assign
l_int|0x78
)brace
suffix:semicolon
DECL|enum|dmfe_CR6_bits
r_enum
id|dmfe_CR6_bits
(brace
DECL|enumerator|CR6_RXSC
DECL|enumerator|CR6_PBF
DECL|enumerator|CR6_PM
DECL|enumerator|CR6_PAM
id|CR6_RXSC
op_assign
l_int|0x2
comma
id|CR6_PBF
op_assign
l_int|0x8
comma
id|CR6_PM
op_assign
l_int|0x40
comma
id|CR6_PAM
op_assign
l_int|0x80
comma
DECL|enumerator|CR6_FDM
DECL|enumerator|CR6_TXSC
DECL|enumerator|CR6_STI
id|CR6_FDM
op_assign
l_int|0x200
comma
id|CR6_TXSC
op_assign
l_int|0x2000
comma
id|CR6_STI
op_assign
l_int|0x100000
comma
DECL|enumerator|CR6_SFT
DECL|enumerator|CR6_RXA
DECL|enumerator|CR6_NO_PURGE
id|CR6_SFT
op_assign
l_int|0x200000
comma
id|CR6_RXA
op_assign
l_int|0x40000000
comma
id|CR6_NO_PURGE
op_assign
l_int|0x20000000
)brace
suffix:semicolon
multiline_comment|/* Global variable declaration ----------------------------- */
DECL|variable|printed_version
r_static
r_int
id|__devinitdata
id|printed_version
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
id|KERN_INFO
id|DRV_NAME
l_string|&quot;: Davicom DM9xxx net driver, version &quot;
id|DRV_VERSION
l_string|&quot; (&quot;
id|DRV_RELDATE
l_string|&quot;)&bslash;n&quot;
suffix:semicolon
DECL|variable|dmfe_debug
r_static
r_int
id|dmfe_debug
suffix:semicolon
DECL|variable|dmfe_media_mode
r_static
r_int
r_char
id|dmfe_media_mode
op_assign
id|DMFE_AUTO
suffix:semicolon
DECL|variable|dmfe_cr6_user_set
r_static
id|u32
id|dmfe_cr6_user_set
suffix:semicolon
multiline_comment|/* For module input parameter */
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
DECL|variable|cr6set
r_static
id|u32
id|cr6set
suffix:semicolon
DECL|variable|mode
r_static
r_int
r_char
id|mode
op_assign
l_int|8
suffix:semicolon
DECL|variable|chkmode
r_static
id|u8
id|chkmode
op_assign
l_int|1
suffix:semicolon
DECL|variable|HPNA_mode
r_static
id|u8
id|HPNA_mode
suffix:semicolon
multiline_comment|/* Default: Low Power/High Speed */
DECL|variable|HPNA_rx_cmd
r_static
id|u8
id|HPNA_rx_cmd
suffix:semicolon
multiline_comment|/* Default: Disable Rx remote command */
DECL|variable|HPNA_tx_cmd
r_static
id|u8
id|HPNA_tx_cmd
suffix:semicolon
multiline_comment|/* Default: Don&squot;t issue remote command */
DECL|variable|HPNA_NoiseFloor
r_static
id|u8
id|HPNA_NoiseFloor
suffix:semicolon
multiline_comment|/* Default: HPNA NoiseFloor */
DECL|variable|SF_mode
r_static
id|u8
id|SF_mode
suffix:semicolon
multiline_comment|/* Special Function: 1:VLAN, 2:RX Flow Control&n;&t;&t;&t;&t;   4: TX pause packet */
multiline_comment|/* function declaration ------------------------------------- */
r_static
r_int
id|dmfe_open
c_func
(paren
r_struct
id|DEVICE
op_star
)paren
suffix:semicolon
r_static
r_int
id|dmfe_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|DEVICE
op_star
)paren
suffix:semicolon
r_static
r_int
id|dmfe_stop
c_func
(paren
r_struct
id|DEVICE
op_star
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|dmfe_get_stats
c_func
(paren
r_struct
id|DEVICE
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_set_filter_mode
c_func
(paren
r_struct
id|DEVICE
op_star
)paren
suffix:semicolon
r_static
r_int
id|dmfe_do_ioctl
c_func
(paren
r_struct
id|DEVICE
op_star
comma
r_struct
id|ifreq
op_star
comma
r_int
)paren
suffix:semicolon
r_static
id|u16
id|read_srom_word
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|dmfe_interrupt
c_func
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_descriptor_init
c_func
(paren
r_struct
id|dmfe_board_info
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|allocate_rx_buffer
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|update_cr6
c_func
(paren
id|u32
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|send_filter_frame
c_func
(paren
r_struct
id|DEVICE
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|dm9132_id_table
c_func
(paren
r_struct
id|DEVICE
op_star
comma
r_int
)paren
suffix:semicolon
r_static
id|u16
id|phy_read
c_func
(paren
r_int
r_int
comma
id|u8
comma
id|u8
comma
id|u32
)paren
suffix:semicolon
r_static
r_void
id|phy_write
c_func
(paren
r_int
r_int
comma
id|u8
comma
id|u8
comma
id|u16
comma
id|u32
)paren
suffix:semicolon
r_static
r_void
id|phy_write_1bit
c_func
(paren
r_int
r_int
comma
id|u32
)paren
suffix:semicolon
r_static
id|u16
id|phy_read_1bit
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
id|u8
id|dmfe_sense_speed
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_process_mode
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_timer
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|dmfe_rx_packet
c_func
(paren
r_struct
id|DEVICE
op_star
comma
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_free_tx_pkt
c_func
(paren
r_struct
id|DEVICE
op_star
comma
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_reuse_skb
c_func
(paren
r_struct
id|dmfe_board_info
op_star
comma
r_struct
id|sk_buff
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_dynamic_reset
c_func
(paren
r_struct
id|DEVICE
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_free_rxbuffer
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_init_dm910x
c_func
(paren
r_struct
id|DEVICE
op_star
)paren
suffix:semicolon
r_static
r_inline
id|u32
id|cal_CRC
c_func
(paren
r_int
r_char
op_star
comma
r_int
r_int
comma
id|u8
)paren
suffix:semicolon
r_static
r_void
id|dmfe_parse_srom
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_program_DM9801
c_func
(paren
r_struct
id|dmfe_board_info
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|dmfe_program_DM9802
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_HPNA_remote_cmd_chk
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|dmfe_set_phyxcer
c_func
(paren
r_struct
id|dmfe_board_info
op_star
)paren
suffix:semicolon
multiline_comment|/* DM910X network baord routine ---------------------------- */
multiline_comment|/*&n; *&t;Search DM910X board ,allocate space and register it&n; */
DECL|function|dmfe_init_one
r_static
r_int
id|__devinit
id|dmfe_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
suffix:semicolon
multiline_comment|/* board information structure */
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|u32
id|dev_rev
comma
id|pci_pmr
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_init_one()&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|printed_version
op_increment
)paren
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
multiline_comment|/* Init network device */
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
op_star
id|db
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|dev
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffff
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;: 32-bit PCI DMA not available.&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out_free
suffix:semicolon
)brace
multiline_comment|/* Enable Master/IO access, Disable memory access */
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_out_free
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;: I/O base is zero&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out_disable
suffix:semicolon
)brace
multiline_comment|/* Read Chip revision */
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|PCI_REVISION_ID
comma
op_amp
id|dev_rev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
OL
(paren
id|CHK_IO_SIZE
c_func
(paren
id|pdev
comma
id|dev_rev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;: Allocated I/O size too small&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out_disable
suffix:semicolon
)brace
macro_line|#if 0&t;/* pci_{enable_device,set_master} sets minimum latency for us now */
multiline_comment|/* Set Latency Timer 80h */
multiline_comment|/* FIXME: setting values &gt; 32 breaks some SiS 559x stuff.&n;&t;   Need a PCI quirk.. */
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_LATENCY_TIMER
comma
l_int|0x80
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|DRV_NAME
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;: Failed to request PCI regions&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out_disable
suffix:semicolon
)brace
multiline_comment|/* Init system &amp; device */
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Allocate Tx/Rx descriptor memory */
id|db-&gt;desc_pool_ptr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
r_sizeof
(paren
r_struct
id|tx_desc
)paren
op_star
id|DESC_ALL_CNT
op_plus
l_int|0x20
comma
op_amp
id|db-&gt;desc_pool_dma_ptr
)paren
suffix:semicolon
id|db-&gt;buf_pool_ptr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
id|TX_BUF_ALLOC
op_star
id|TX_DESC_CNT
op_plus
l_int|4
comma
op_amp
id|db-&gt;buf_pool_dma_ptr
)paren
suffix:semicolon
id|db-&gt;first_tx_desc
op_assign
(paren
r_struct
id|tx_desc
op_star
)paren
id|db-&gt;desc_pool_ptr
suffix:semicolon
id|db-&gt;first_tx_desc_dma
op_assign
id|db-&gt;desc_pool_dma_ptr
suffix:semicolon
id|db-&gt;buf_pool_start
op_assign
id|db-&gt;buf_pool_ptr
suffix:semicolon
id|db-&gt;buf_pool_dma_start
op_assign
id|db-&gt;buf_pool_dma_ptr
suffix:semicolon
id|db-&gt;chip_id
op_assign
id|ent-&gt;driver_data
suffix:semicolon
id|db-&gt;ioaddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|db-&gt;chip_revision
op_assign
id|dev_rev
suffix:semicolon
id|db-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|dev-&gt;base_addr
op_assign
id|db-&gt;ioaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|dmfe_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|dmfe_start_xmit
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|dmfe_stop
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|dmfe_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
op_amp
id|dmfe_set_filter_mode
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|dmfe_do_ioctl
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|db-&gt;lock
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
l_int|0x50
comma
op_amp
id|pci_pmr
)paren
suffix:semicolon
id|pci_pmr
op_and_assign
l_int|0x70000
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pci_pmr
op_eq
l_int|0x10000
)paren
op_logical_and
(paren
id|dev_rev
op_eq
l_int|0x02000031
)paren
)paren
id|db-&gt;chip_type
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* DM9102A E3 */
r_else
id|db-&gt;chip_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* read 64 word srom data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(paren
(paren
id|u16
op_star
)paren
id|db-&gt;srom
)paren
(braket
id|i
)braket
op_assign
id|cpu_to_le16
c_func
(paren
id|read_srom_word
c_func
(paren
id|db-&gt;ioaddr
comma
id|i
)paren
)paren
suffix:semicolon
multiline_comment|/* Set Node address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|db-&gt;srom
(braket
l_int|20
op_plus
id|i
)braket
suffix:semicolon
id|err
op_assign
id|register_netdev
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|err_out_res
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Davicom DM%04lx at pci%s,&quot;
comma
id|dev-&gt;name
comma
id|ent-&gt;driver_data
op_rshift
l_int|16
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%c%02x&quot;
comma
id|i
ques
c_cond
l_char|&squot;:&squot;
suffix:colon
l_char|&squot; &squot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, irq %d.&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_res
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out_disable
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out_free
suffix:colon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|dmfe_remove_one
r_static
r_void
id|__devexit
id|dmfe_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_remove_one()&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|db-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|tx_desc
)paren
op_star
id|DESC_ALL_CNT
op_plus
l_int|0x20
comma
id|db-&gt;desc_pool_ptr
comma
id|db-&gt;desc_pool_dma_ptr
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|db-&gt;pdev
comma
id|TX_BUF_ALLOC
op_star
id|TX_DESC_CNT
op_plus
l_int|4
comma
id|db-&gt;buf_pool_ptr
comma
id|db-&gt;buf_pool_dma_ptr
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* free board information */
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_remove_one() exit&quot;
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Open the interface.&n; *&t;The interface is opened whenever &quot;ifconfig&quot; actives it.&n; */
DECL|function|dmfe_open
r_static
r_int
id|dmfe_open
c_func
(paren
r_struct
id|DEVICE
op_star
id|dev
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_open&quot;
comma
l_int|0
)paren
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
op_amp
id|dmfe_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* system variable init */
id|db-&gt;cr6_data
op_assign
id|CR6_DEFAULT
op_or
id|dmfe_cr6_user_set
suffix:semicolon
id|db-&gt;tx_packet_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;tx_queue_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;link_failed
op_assign
l_int|1
suffix:semicolon
id|db-&gt;wait_reset
op_assign
l_int|0
suffix:semicolon
id|db-&gt;first_in_callback
op_assign
l_int|0
suffix:semicolon
id|db-&gt;NIC_capability
op_assign
l_int|0xf
suffix:semicolon
multiline_comment|/* All capability*/
id|db-&gt;PHY_reg4
op_assign
l_int|0x1e0
suffix:semicolon
multiline_comment|/* CR6 operation mode decision */
r_if
c_cond
(paren
op_logical_neg
id|chkmode
op_logical_or
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
op_logical_or
(paren
id|db-&gt;chip_revision
op_ge
l_int|0x02000030
)paren
)paren
(brace
id|db-&gt;cr6_data
op_or_assign
id|DMFE_TXTH_256
suffix:semicolon
id|db-&gt;cr0_data
op_assign
id|CR0_DEFAULT
suffix:semicolon
id|db-&gt;dm910x_chk_mode
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* Enter the normal mode */
)brace
r_else
(brace
id|db-&gt;cr6_data
op_or_assign
id|CR6_SFT
suffix:semicolon
multiline_comment|/* Store &amp; Forward mode */
id|db-&gt;cr0_data
op_assign
l_int|0
suffix:semicolon
id|db-&gt;dm910x_chk_mode
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Enter the check mode */
)brace
multiline_comment|/* Initilize DM910X board */
id|dmfe_init_dm910x
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Active System Interface */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* set and active a timer process */
id|init_timer
c_func
(paren
op_amp
id|db-&gt;timer
)paren
suffix:semicolon
id|db-&gt;timer.expires
op_assign
id|DMFE_TIMER_WUT
op_plus
id|HZ
op_star
l_int|2
suffix:semicolon
id|db-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|db-&gt;timer.function
op_assign
op_amp
id|dmfe_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|db-&gt;timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&t;Initilize DM910X board&n; *&t;Reset DM910X board&n; *&t;Initilize TX/Rx descriptor chain structure&n; *&t;Send the set-up frame&n; *&t;Enable Tx/Rx machine&n; */
DECL|function|dmfe_init_dm910x
r_static
r_void
id|dmfe_init_dm910x
c_func
(paren
r_struct
id|DEVICE
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|db-&gt;ioaddr
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_init_dm910x()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset DM910x MAC controller */
id|outl
c_func
(paren
id|DM910X_RESET
comma
id|ioaddr
op_plus
id|DCR0
)paren
suffix:semicolon
multiline_comment|/* RESET MAC */
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;cr0_data
comma
id|ioaddr
op_plus
id|DCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Phy addr : DM910(A)2/DM9132/9801, phy address = 1 */
id|db-&gt;phy_addr
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Parser SROM and media mode */
id|dmfe_parse_srom
c_func
(paren
id|db
)paren
suffix:semicolon
id|db-&gt;media_mode
op_assign
id|dmfe_media_mode
suffix:semicolon
multiline_comment|/* RESET Phyxcer Chip by GPR port bit 7 */
id|outl
c_func
(paren
l_int|0x180
comma
id|ioaddr
op_plus
id|DCR12
)paren
suffix:semicolon
multiline_comment|/* Let bit 7 output port */
r_if
c_cond
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9009_ID
)paren
(brace
id|outl
c_func
(paren
l_int|0x80
comma
id|ioaddr
op_plus
id|DCR12
)paren
suffix:semicolon
multiline_comment|/* Issue RESET signal */
id|mdelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
multiline_comment|/* Delay 300 ms */
)brace
id|outl
c_func
(paren
l_int|0x0
comma
id|ioaddr
op_plus
id|DCR12
)paren
suffix:semicolon
multiline_comment|/* Clear RESET signal */
multiline_comment|/* Process Phyxcer Media Mode */
r_if
c_cond
(paren
op_logical_neg
(paren
id|db-&gt;media_mode
op_amp
l_int|0x10
)paren
)paren
multiline_comment|/* Force 1M mode */
id|dmfe_set_phyxcer
c_func
(paren
id|db
)paren
suffix:semicolon
multiline_comment|/* Media Mode Process */
r_if
c_cond
(paren
op_logical_neg
(paren
id|db-&gt;media_mode
op_amp
id|DMFE_AUTO
)paren
)paren
id|db-&gt;op_mode
op_assign
id|db-&gt;media_mode
suffix:semicolon
multiline_comment|/* Force Mode */
multiline_comment|/* Initiliaze Transmit/Receive decriptor and CR3/4 */
id|dmfe_descriptor_init
c_func
(paren
id|db
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Init CR6 to program DM910x operation */
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Send setup frame */
r_if
c_cond
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
id|dm9132_id_table
c_func
(paren
id|dev
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
multiline_comment|/* DM9132 */
r_else
id|send_filter_frame
c_func
(paren
id|dev
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
multiline_comment|/* DM9102/DM9102A */
multiline_comment|/* Init CR7, interrupt active bit */
id|db-&gt;cr7_data
op_assign
id|CR7_DEFAULT
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;cr7_data
comma
id|ioaddr
op_plus
id|DCR7
)paren
suffix:semicolon
multiline_comment|/* Init CR15, Tx jabber and Rx watchdog timer */
id|outl
c_func
(paren
id|db-&gt;cr15_data
comma
id|ioaddr
op_plus
id|DCR15
)paren
suffix:semicolon
multiline_comment|/* Enable DM910X Tx/Rx function */
id|db-&gt;cr6_data
op_or_assign
id|CR6_RXSC
op_or
id|CR6_TXSC
op_or
l_int|0x40000
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|ioaddr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Hardware start transmission.&n; *&t;Send a packet to media from the upper layer.&n; */
DECL|function|dmfe_start_xmit
r_static
r_int
id|dmfe_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|DEVICE
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|tx_desc
op_star
id|txptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_start_xmit&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Resource flag check */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Too large packet check */
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|MAX_PACKET_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;: big packet = %d&bslash;n&quot;
comma
(paren
id|u16
)paren
id|skb-&gt;len
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* No Tx resource check, it never happen nromally */
r_if
c_cond
(paren
id|db-&gt;tx_queue_cnt
op_ge
id|TX_FREE_DESC_CNT
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;: No Tx resource %ld&bslash;n&quot;
comma
id|db-&gt;tx_queue_cnt
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Disable NIC interrupt */
id|outl
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|DCR7
)paren
suffix:semicolon
multiline_comment|/* transmit this packet */
id|txptr
op_assign
id|db-&gt;tx_insert_ptr
suffix:semicolon
id|memcpy
c_func
(paren
id|txptr-&gt;tx_buf_ptr
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|txptr-&gt;tdes1
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0xe1000000
op_or
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/* Point to next transmit free descriptor */
id|db-&gt;tx_insert_ptr
op_assign
id|txptr-&gt;next_tx_desc
suffix:semicolon
multiline_comment|/* Transmit Packet Process */
r_if
c_cond
(paren
(paren
op_logical_neg
id|db-&gt;tx_queue_cnt
)paren
op_logical_and
(paren
id|db-&gt;tx_packet_cnt
OL
id|TX_MAX_SEND_CNT
)paren
)paren
(brace
id|txptr-&gt;tdes0
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x80000000
)paren
suffix:semicolon
multiline_comment|/* Set owner bit */
id|db-&gt;tx_packet_cnt
op_increment
suffix:semicolon
multiline_comment|/* Ready to send */
id|outl
c_func
(paren
l_int|0x1
comma
id|dev-&gt;base_addr
op_plus
id|DCR1
)paren
suffix:semicolon
multiline_comment|/* Issue Tx polling */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* saved time stamp */
)brace
r_else
(brace
id|db-&gt;tx_queue_cnt
op_increment
suffix:semicolon
multiline_comment|/* queue TX packet */
id|outl
c_func
(paren
l_int|0x1
comma
id|dev-&gt;base_addr
op_plus
id|DCR1
)paren
suffix:semicolon
multiline_comment|/* Issue Tx polling */
)brace
multiline_comment|/* Tx resource check */
r_if
c_cond
(paren
id|db-&gt;tx_queue_cnt
OL
id|TX_FREE_DESC_CNT
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Restore CR7 to enable interrupt */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;cr7_data
comma
id|dev-&gt;base_addr
op_plus
id|DCR7
)paren
suffix:semicolon
multiline_comment|/* free this SKB */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Stop the interface.&n; *&t;The interface is stopped when it is brought.&n; */
DECL|function|dmfe_stop
r_static
r_int
id|dmfe_stop
c_func
(paren
r_struct
id|DEVICE
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_stop&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable system */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* deleted timer */
id|del_timer_sync
c_func
(paren
op_amp
id|db-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* Reset &amp; stop DM910X board */
id|outl
c_func
(paren
id|DM910X_RESET
comma
id|ioaddr
op_plus
id|DCR0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|0
comma
l_int|0x8000
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
multiline_comment|/* free interrupt */
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* free allocated rx buffer */
id|dmfe_free_rxbuffer
c_func
(paren
id|db
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* show statistic counter */
id|printk
c_func
(paren
id|DRV_NAME
l_string|&quot;: FU:%lx EC:%lx LC:%lx NC:%lx LOC:%lx TXJT:%lx RESET:%lx RCR8:%lx FAL:%lx TT:%lx&bslash;n&quot;
comma
id|db-&gt;tx_fifo_underrun
comma
id|db-&gt;tx_excessive_collision
comma
id|db-&gt;tx_late_collision
comma
id|db-&gt;tx_no_carrier
comma
id|db-&gt;tx_loss_carrier
comma
id|db-&gt;tx_jabber_timeout
comma
id|db-&gt;reset_count
comma
id|db-&gt;reset_cr8
comma
id|db-&gt;reset_fatal
comma
id|db-&gt;reset_TXtimeout
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;DM9102 insterrupt handler&n; *&t;receive the packet to upper layer, free the transmitted packet&n; */
DECL|function|dmfe_interrupt
r_static
id|irqreturn_t
id|dmfe_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|DEVICE
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
(paren
r_struct
id|dmfe_board_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_interrupt()&quot;
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|1
comma
l_string|&quot;dmfe_interrupt() without DEVICE arg&quot;
comma
l_int|0
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Got DM910X status */
id|db-&gt;cr5_data
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
id|DCR5
)paren
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;cr5_data
comma
id|ioaddr
op_plus
id|DCR5
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|db-&gt;cr5_data
op_amp
l_int|0xc1
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* Disable all interrupt in CR7 to solve the interrupt edge problem */
id|outl
c_func
(paren
l_int|0
comma
id|ioaddr
op_plus
id|DCR7
)paren
suffix:semicolon
multiline_comment|/* Check system status */
r_if
c_cond
(paren
id|db-&gt;cr5_data
op_amp
l_int|0x2000
)paren
(brace
multiline_comment|/* system bus error happen */
id|DMFE_DBUG
c_func
(paren
l_int|1
comma
l_string|&quot;System bus error happen. CR5=&quot;
comma
id|db-&gt;cr5_data
)paren
suffix:semicolon
id|db-&gt;reset_fatal
op_increment
suffix:semicolon
id|db-&gt;wait_reset
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Need to RESET */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* Received the coming packet */
r_if
c_cond
(paren
(paren
id|db-&gt;cr5_data
op_amp
l_int|0x40
)paren
op_logical_and
id|db-&gt;rx_avail_cnt
)paren
id|dmfe_rx_packet
c_func
(paren
id|dev
comma
id|db
)paren
suffix:semicolon
multiline_comment|/* reallocate rx descriptor buffer */
r_if
c_cond
(paren
id|db-&gt;rx_avail_cnt
OL
id|RX_DESC_CNT
)paren
id|allocate_rx_buffer
c_func
(paren
id|db
)paren
suffix:semicolon
multiline_comment|/* Free the transmitted descriptor */
r_if
c_cond
(paren
id|db-&gt;cr5_data
op_amp
l_int|0x01
)paren
id|dmfe_free_tx_pkt
c_func
(paren
id|dev
comma
id|db
)paren
suffix:semicolon
multiline_comment|/* Mode Check */
r_if
c_cond
(paren
id|db-&gt;dm910x_chk_mode
op_amp
l_int|0x2
)paren
(brace
id|db-&gt;dm910x_chk_mode
op_assign
l_int|0x4
suffix:semicolon
id|db-&gt;cr6_data
op_or_assign
l_int|0x100
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
)brace
multiline_comment|/* Restore CR7 to enable interrupt mask */
id|outl
c_func
(paren
id|db-&gt;cr7_data
comma
id|ioaddr
op_plus
id|DCR7
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Free TX resource after TX complete&n; */
DECL|function|dmfe_free_tx_pkt
r_static
r_void
id|dmfe_free_tx_pkt
c_func
(paren
r_struct
id|DEVICE
op_star
id|dev
comma
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
r_struct
id|tx_desc
op_star
id|txptr
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|u32
id|tdes0
suffix:semicolon
id|txptr
op_assign
id|db-&gt;tx_remove_ptr
suffix:semicolon
r_while
c_loop
(paren
id|db-&gt;tx_packet_cnt
)paren
(brace
id|tdes0
op_assign
id|le32_to_cpu
c_func
(paren
id|txptr-&gt;tdes0
)paren
suffix:semicolon
multiline_comment|/* printk(DRV_NAME &quot;: tdes0=%x&bslash;n&quot;, tdes0); */
r_if
c_cond
(paren
id|tdes0
op_amp
l_int|0x80000000
)paren
r_break
suffix:semicolon
multiline_comment|/* A packet sent completed */
id|db-&gt;tx_packet_cnt
op_decrement
suffix:semicolon
id|db-&gt;stats.tx_packets
op_increment
suffix:semicolon
multiline_comment|/* Transmit statistic counter */
r_if
c_cond
(paren
id|tdes0
op_ne
l_int|0x7fffffff
)paren
(brace
multiline_comment|/* printk(DRV_NAME &quot;: tdes0=%x&bslash;n&quot;, tdes0); */
id|db-&gt;stats.collisions
op_add_assign
(paren
id|tdes0
op_rshift
l_int|3
)paren
op_amp
l_int|0xf
suffix:semicolon
id|db-&gt;stats.tx_bytes
op_add_assign
id|le32_to_cpu
c_func
(paren
id|txptr-&gt;tdes1
)paren
op_amp
l_int|0x7ff
suffix:semicolon
r_if
c_cond
(paren
id|tdes0
op_amp
id|TDES0_ERR_MASK
)paren
(brace
id|db-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tdes0
op_amp
l_int|0x0002
)paren
(brace
multiline_comment|/* UnderRun */
id|db-&gt;tx_fifo_underrun
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|db-&gt;cr6_data
op_amp
id|CR6_SFT
)paren
)paren
(brace
id|db-&gt;cr6_data
op_assign
id|db-&gt;cr6_data
op_or
id|CR6_SFT
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tdes0
op_amp
l_int|0x0100
)paren
id|db-&gt;tx_excessive_collision
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tdes0
op_amp
l_int|0x0200
)paren
id|db-&gt;tx_late_collision
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tdes0
op_amp
l_int|0x0400
)paren
id|db-&gt;tx_no_carrier
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tdes0
op_amp
l_int|0x0800
)paren
id|db-&gt;tx_loss_carrier
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tdes0
op_amp
l_int|0x4000
)paren
id|db-&gt;tx_jabber_timeout
op_increment
suffix:semicolon
)brace
)brace
id|txptr
op_assign
id|txptr-&gt;next_tx_desc
suffix:semicolon
)brace
multiline_comment|/* End of while */
multiline_comment|/* Update TX remove pointer to next */
id|db-&gt;tx_remove_ptr
op_assign
id|txptr
suffix:semicolon
multiline_comment|/* Send the Tx packet in queue */
r_if
c_cond
(paren
(paren
id|db-&gt;tx_packet_cnt
OL
id|TX_MAX_SEND_CNT
)paren
op_logical_and
id|db-&gt;tx_queue_cnt
)paren
(brace
id|txptr-&gt;tdes0
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x80000000
)paren
suffix:semicolon
multiline_comment|/* Set owner bit */
id|db-&gt;tx_packet_cnt
op_increment
suffix:semicolon
multiline_comment|/* Ready to send */
id|db-&gt;tx_queue_cnt
op_decrement
suffix:semicolon
id|outl
c_func
(paren
l_int|0x1
comma
id|ioaddr
op_plus
id|DCR1
)paren
suffix:semicolon
multiline_comment|/* Issue Tx polling */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* saved time stamp */
)brace
multiline_comment|/* Resource available check */
r_if
c_cond
(paren
id|db-&gt;tx_queue_cnt
OL
id|TX_WAKE_DESC_CNT
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Active upper layer, send again */
)brace
multiline_comment|/*&n; *&t;Receive the come packet and pass to upper layer&n; */
DECL|function|dmfe_rx_packet
r_static
r_void
id|dmfe_rx_packet
c_func
(paren
r_struct
id|DEVICE
op_star
id|dev
comma
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
r_struct
id|rx_desc
op_star
id|rxptr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|rxlen
suffix:semicolon
id|u32
id|rdes0
suffix:semicolon
id|rxptr
op_assign
id|db-&gt;rx_ready_ptr
suffix:semicolon
r_while
c_loop
(paren
id|db-&gt;rx_avail_cnt
)paren
(brace
id|rdes0
op_assign
id|le32_to_cpu
c_func
(paren
id|rxptr-&gt;rdes0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rdes0
op_amp
l_int|0x80000000
)paren
multiline_comment|/* packet owner check */
r_break
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_decrement
suffix:semicolon
id|db-&gt;interval_rx_cnt
op_increment
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|db-&gt;pdev
comma
id|le32_to_cpu
c_func
(paren
id|rxptr-&gt;rdes2
)paren
comma
id|RX_ALLOC_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rdes0
op_amp
l_int|0x300
)paren
op_ne
l_int|0x300
)paren
(brace
multiline_comment|/* A packet without First/Last flag */
multiline_comment|/* reuse this SKB */
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Reuse SK buffer, rdes0&quot;
comma
id|rdes0
)paren
suffix:semicolon
id|dmfe_reuse_skb
c_func
(paren
id|db
comma
id|rxptr-&gt;rx_skb_ptr
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* A packet with First/Last flag */
id|rxlen
op_assign
(paren
(paren
id|rdes0
op_rshift
l_int|16
)paren
op_amp
l_int|0x3fff
)paren
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* error summary bit check */
r_if
c_cond
(paren
id|rdes0
op_amp
l_int|0x8000
)paren
(brace
multiline_comment|/* This is a error packet */
singleline_comment|//printk(DRV_NAME &quot;: rdes0: %lx&bslash;n&quot;, rdes0);
id|db-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rdes0
op_amp
l_int|1
)paren
id|db-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rdes0
op_amp
l_int|2
)paren
id|db-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rdes0
op_amp
l_int|0x80
)paren
id|db-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|rdes0
op_amp
l_int|0x8000
)paren
op_logical_or
(paren
(paren
id|db-&gt;cr6_data
op_amp
id|CR6_PM
)paren
op_logical_and
(paren
id|rxlen
OG
l_int|6
)paren
)paren
)paren
(brace
id|skb
op_assign
id|rxptr-&gt;rx_skb_ptr
suffix:semicolon
multiline_comment|/* Received Packet CRC check need or not */
r_if
c_cond
(paren
(paren
id|db-&gt;dm910x_chk_mode
op_amp
l_int|1
)paren
op_logical_and
(paren
id|cal_CRC
c_func
(paren
id|skb-&gt;tail
comma
id|rxlen
comma
l_int|1
)paren
op_ne
(paren
op_star
(paren
id|u32
op_star
)paren
(paren
id|skb-&gt;tail
op_plus
id|rxlen
)paren
)paren
)paren
)paren
(brace
multiline_comment|/* FIXME (?) */
multiline_comment|/* Found a error received packet */
id|dmfe_reuse_skb
c_func
(paren
id|db
comma
id|rxptr-&gt;rx_skb_ptr
)paren
suffix:semicolon
id|db-&gt;dm910x_chk_mode
op_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Good packet, send to upper layer */
multiline_comment|/* Shorst packet used new SKB */
r_if
c_cond
(paren
(paren
id|rxlen
OL
id|RX_COPY_SIZE
)paren
op_logical_and
(paren
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|rxlen
op_plus
l_int|2
)paren
)paren
op_ne
l_int|NULL
)paren
)paren
(brace
multiline_comment|/* size less than COPY_SIZE, allocate a rxlen SKB */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* 16byte align */
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|rxlen
)paren
comma
id|rxptr-&gt;rx_skb_ptr-&gt;tail
comma
id|rxlen
)paren
suffix:semicolon
id|dmfe_reuse_skb
c_func
(paren
id|db
comma
id|rxptr-&gt;rx_skb_ptr
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|rxlen
)paren
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|db-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|db-&gt;stats.rx_bytes
op_add_assign
id|rxlen
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Reuse SKB buffer when the packet is error */
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Reuse SK buffer, rdes0&quot;
comma
id|rdes0
)paren
suffix:semicolon
id|dmfe_reuse_skb
c_func
(paren
id|db
comma
id|rxptr-&gt;rx_skb_ptr
)paren
suffix:semicolon
)brace
)brace
id|rxptr
op_assign
id|rxptr-&gt;next_rx_desc
suffix:semicolon
)brace
id|db-&gt;rx_ready_ptr
op_assign
id|rxptr
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Get statistics from driver.&n; */
DECL|function|dmfe_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|dmfe_get_stats
c_func
(paren
r_struct
id|DEVICE
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
(paren
r_struct
id|dmfe_board_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_get_stats&quot;
comma
l_int|0
)paren
suffix:semicolon
r_return
op_amp
id|db-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*&n; * Set DM910X multicast address&n; */
DECL|function|dmfe_set_filter_mode
r_static
r_void
id|dmfe_set_filter_mode
c_func
(paren
r_struct
id|DEVICE
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_set_filter_mode()&quot;
comma
l_int|0
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Enable PROM Mode&quot;
comma
l_int|0
)paren
suffix:semicolon
id|db-&gt;cr6_data
op_or_assign
id|CR6_PM
op_or
id|CR6_PBF
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
op_logical_or
id|dev-&gt;mc_count
OG
id|DMFE_MAX_MULTICAST
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Pass all multicast address&quot;
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
id|db-&gt;cr6_data
op_and_assign
op_complement
(paren
id|CR6_PM
op_or
id|CR6_PBF
)paren
suffix:semicolon
id|db-&gt;cr6_data
op_or_assign
id|CR6_PAM
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Set multicast address&quot;
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
id|dm9132_id_table
c_func
(paren
id|dev
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
multiline_comment|/* DM9132 */
r_else
id|send_filter_frame
c_func
(paren
id|dev
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
multiline_comment|/* DM9102/DM9102A */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Process the ethtool ioctl command&n; */
DECL|function|dmfe_ethtool_ioctl
r_static
r_int
id|dmfe_ethtool_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|useraddr
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ethtool_drvinfo
id|info
op_assign
(brace
id|ETHTOOL_GDRVINFO
)brace
suffix:semicolon
id|u32
id|ethcmd
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ethcmd
comma
id|useraddr
comma
r_sizeof
(paren
id|ethcmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|ethcmd
)paren
(brace
r_case
id|ETHTOOL_GDRVINFO
suffix:colon
id|strcpy
c_func
(paren
id|info.driver
comma
id|DRV_NAME
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info.version
comma
id|DRV_VERSION
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;pdev
)paren
id|strcpy
c_func
(paren
id|info.bus_info
comma
id|pci_name
c_func
(paren
id|db-&gt;pdev
)paren
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|info.bus_info
comma
l_string|&quot;EISA 0x%lx %d&quot;
comma
id|dev-&gt;base_addr
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Process the upper socket ioctl command&n; */
DECL|function|dmfe_do_ioctl
r_static
r_int
id|dmfe_do_ioctl
c_func
(paren
r_struct
id|DEVICE
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_do_ioctl()&quot;
comma
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCETHTOOL
suffix:colon
r_return
id|dmfe_ethtool_ioctl
c_func
(paren
id|dev
comma
(paren
r_void
op_star
)paren
id|ifr-&gt;ifr_data
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;A periodic timer routine&n; *&t;Dynamic media sense, allocate Rx buffer...&n; */
DECL|function|dmfe_timer
r_static
r_void
id|dmfe_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|u32
id|tmp_cr8
suffix:semicolon
r_int
r_char
id|tmp_cr12
suffix:semicolon
r_struct
id|DEVICE
op_star
id|dev
op_assign
(paren
r_struct
id|DEVICE
op_star
)paren
id|data
suffix:semicolon
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
(paren
r_struct
id|dmfe_board_info
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_timer()&quot;
comma
l_int|0
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Media mode process when Link OK before enter this route */
r_if
c_cond
(paren
id|db-&gt;first_in_callback
op_eq
l_int|0
)paren
(brace
id|db-&gt;first_in_callback
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;chip_type
op_logical_and
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9102_ID
)paren
)paren
(brace
id|db-&gt;cr6_data
op_and_assign
op_complement
l_int|0x40000
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|0
comma
l_int|0x1000
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|db-&gt;cr6_data
op_or_assign
l_int|0x40000
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
id|db-&gt;timer.expires
op_assign
id|DMFE_TIMER_WUT
op_plus
id|HZ
op_star
l_int|2
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|db-&gt;timer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Operating Mode Check */
r_if
c_cond
(paren
(paren
id|db-&gt;dm910x_chk_mode
op_amp
l_int|0x1
)paren
op_logical_and
(paren
id|db-&gt;stats.rx_packets
OG
id|MAX_CHECK_PACKET
)paren
)paren
id|db-&gt;dm910x_chk_mode
op_assign
l_int|0x4
suffix:semicolon
multiline_comment|/* Dynamic reset DM910X : system error or transmit time-out */
id|tmp_cr8
op_assign
id|inl
c_func
(paren
id|db-&gt;ioaddr
op_plus
id|DCR8
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|db-&gt;interval_rx_cnt
op_eq
l_int|0
)paren
op_logical_and
(paren
id|tmp_cr8
)paren
)paren
(brace
id|db-&gt;reset_cr8
op_increment
suffix:semicolon
id|db-&gt;wait_reset
op_assign
l_int|1
suffix:semicolon
)brace
id|db-&gt;interval_rx_cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* TX polling kick monitor */
r_if
c_cond
(paren
id|db-&gt;tx_packet_cnt
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|dev-&gt;trans_start
op_plus
id|DMFE_TX_KICK
)paren
)paren
(brace
id|outl
c_func
(paren
l_int|0x1
comma
id|dev-&gt;base_addr
op_plus
id|DCR1
)paren
suffix:semicolon
multiline_comment|/* Tx polling again */
multiline_comment|/* TX Timeout */
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|dev-&gt;trans_start
op_plus
id|DMFE_TX_TIMEOUT
)paren
)paren
(brace
id|db-&gt;reset_TXtimeout
op_increment
suffix:semicolon
id|db-&gt;wait_reset
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Tx timeout - resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|db-&gt;wait_reset
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Dynamic Reset device&quot;
comma
id|db-&gt;tx_packet_cnt
)paren
suffix:semicolon
id|db-&gt;reset_count
op_increment
suffix:semicolon
id|dmfe_dynamic_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
id|db-&gt;first_in_callback
op_assign
l_int|0
suffix:semicolon
id|db-&gt;timer.expires
op_assign
id|DMFE_TIMER_WUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|db-&gt;timer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Link status check, Dynamic media type change */
r_if
c_cond
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
id|tmp_cr12
op_assign
id|inb
c_func
(paren
id|db-&gt;ioaddr
op_plus
id|DCR9
op_plus
l_int|3
)paren
suffix:semicolon
multiline_comment|/* DM9132 */
r_else
id|tmp_cr12
op_assign
id|inb
c_func
(paren
id|db-&gt;ioaddr
op_plus
id|DCR12
)paren
suffix:semicolon
multiline_comment|/* DM9102/DM9102A */
r_if
c_cond
(paren
(paren
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9102_ID
)paren
op_logical_and
(paren
id|db-&gt;chip_revision
op_eq
l_int|0x02000030
)paren
)paren
op_logical_or
(paren
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
op_logical_and
(paren
id|db-&gt;chip_revision
op_eq
l_int|0x02000010
)paren
)paren
)paren
(brace
multiline_comment|/* DM9102A Chip */
r_if
c_cond
(paren
id|tmp_cr12
op_amp
l_int|2
)paren
id|tmp_cr12
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* Link failed */
r_else
id|tmp_cr12
op_assign
l_int|0x3
suffix:semicolon
multiline_comment|/* Link OK */
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|tmp_cr12
op_amp
l_int|0x3
)paren
op_logical_and
op_logical_neg
id|db-&gt;link_failed
)paren
(brace
multiline_comment|/* Link Failed */
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Link Failed&quot;
comma
id|tmp_cr12
)paren
suffix:semicolon
id|db-&gt;link_failed
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* For Force 10/100M Half/Full mode: Enable Auto-Nego mode */
multiline_comment|/* AUTO or force 1M Homerun/Longrun don&squot;t need */
r_if
c_cond
(paren
op_logical_neg
(paren
id|db-&gt;media_mode
op_amp
l_int|0x38
)paren
)paren
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|0
comma
l_int|0x1000
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
multiline_comment|/* AUTO mode, if INT phyxcer link failed, select EXT device */
r_if
c_cond
(paren
id|db-&gt;media_mode
op_amp
id|DMFE_AUTO
)paren
(brace
multiline_comment|/* 10/100M link failed, used 1M Home-Net */
id|db-&gt;cr6_data
op_or_assign
l_int|0x00040000
suffix:semicolon
multiline_comment|/* bit18=1, MII */
id|db-&gt;cr6_data
op_and_assign
op_complement
l_int|0x00000200
suffix:semicolon
multiline_comment|/* bit9=0, HD mode */
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|tmp_cr12
op_amp
l_int|0x3
)paren
op_logical_and
id|db-&gt;link_failed
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Link link OK&quot;
comma
id|tmp_cr12
)paren
suffix:semicolon
id|db-&gt;link_failed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Auto Sense Speed */
r_if
c_cond
(paren
(paren
id|db-&gt;media_mode
op_amp
id|DMFE_AUTO
)paren
op_logical_and
id|dmfe_sense_speed
c_func
(paren
id|db
)paren
)paren
id|db-&gt;link_failed
op_assign
l_int|1
suffix:semicolon
id|dmfe_process_mode
c_func
(paren
id|db
)paren
suffix:semicolon
multiline_comment|/* SHOW_MEDIA_TYPE(db-&gt;op_mode); */
)brace
multiline_comment|/* HPNA remote command check */
r_if
c_cond
(paren
id|db-&gt;HPNA_command
op_amp
l_int|0xf00
)paren
(brace
id|db-&gt;HPNA_timer
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|db-&gt;HPNA_timer
)paren
id|dmfe_HPNA_remote_cmd_chk
c_func
(paren
id|db
)paren
suffix:semicolon
)brace
multiline_comment|/* Timer active again */
id|db-&gt;timer.expires
op_assign
id|DMFE_TIMER_WUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|db-&gt;timer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|db-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Dynamic reset the DM910X board&n; *&t;Stop DM910X board&n; *&t;Free Tx/Rx allocated memory&n; *&t;Reset DM910X board&n; *&t;Re-initilize DM910X board&n; */
DECL|function|dmfe_dynamic_reset
r_static
r_void
id|dmfe_dynamic_reset
c_func
(paren
r_struct
id|DEVICE
op_star
id|dev
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_dynamic_reset()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Sopt MAC controller */
id|db-&gt;cr6_data
op_and_assign
op_complement
(paren
id|CR6_RXSC
op_or
id|CR6_TXSC
)paren
suffix:semicolon
multiline_comment|/* Disable Tx/Rx */
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|dev-&gt;base_addr
op_plus
id|DCR7
)paren
suffix:semicolon
multiline_comment|/* Disable Interrupt */
id|outl
c_func
(paren
id|inl
c_func
(paren
id|dev-&gt;base_addr
op_plus
id|DCR5
)paren
comma
id|dev-&gt;base_addr
op_plus
id|DCR5
)paren
suffix:semicolon
multiline_comment|/* Disable upper layer interface */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Free Rx Allocate buffer */
id|dmfe_free_rxbuffer
c_func
(paren
id|db
)paren
suffix:semicolon
multiline_comment|/* system variable init */
id|db-&gt;tx_packet_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;tx_queue_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_assign
l_int|0
suffix:semicolon
id|db-&gt;link_failed
op_assign
l_int|1
suffix:semicolon
id|db-&gt;wait_reset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Re-initilize DM910X board */
id|dmfe_init_dm910x
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Restart upper layer interface */
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;free all allocated rx buffer&n; */
DECL|function|dmfe_free_rxbuffer
r_static
r_void
id|dmfe_free_rxbuffer
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_free_rxbuffer()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* free allocated rx buffer */
r_while
c_loop
(paren
id|db-&gt;rx_avail_cnt
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|db-&gt;rx_ready_ptr-&gt;rx_skb_ptr
)paren
suffix:semicolon
id|db-&gt;rx_ready_ptr
op_assign
id|db-&gt;rx_ready_ptr-&gt;next_rx_desc
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Reuse the SK buffer&n; */
DECL|function|dmfe_reuse_skb
r_static
r_void
id|dmfe_reuse_skb
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|rx_desc
op_star
id|rxptr
op_assign
id|db-&gt;rx_insert_ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rxptr-&gt;rdes0
op_amp
id|cpu_to_le32
c_func
(paren
l_int|0x80000000
)paren
)paren
)paren
(brace
id|rxptr-&gt;rx_skb_ptr
op_assign
id|skb
suffix:semicolon
id|rxptr-&gt;rdes2
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|db-&gt;pdev
comma
id|skb-&gt;tail
comma
id|RX_ALLOC_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|rxptr-&gt;rdes0
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x80000000
)paren
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_increment
suffix:semicolon
id|db-&gt;rx_insert_ptr
op_assign
id|rxptr-&gt;next_rx_desc
suffix:semicolon
)brace
r_else
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;SK Buffer reuse method error&quot;
comma
id|db-&gt;rx_avail_cnt
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Initialize transmit/Receive descriptor&n; *&t;Using Chain structure, and allocate Tx/Rx buffer&n; */
DECL|function|dmfe_descriptor_init
r_static
r_void
id|dmfe_descriptor_init
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
comma
r_int
r_int
id|ioaddr
)paren
(brace
r_struct
id|tx_desc
op_star
id|tmp_tx
suffix:semicolon
r_struct
id|rx_desc
op_star
id|tmp_rx
suffix:semicolon
r_int
r_char
op_star
id|tmp_buf
suffix:semicolon
id|dma_addr_t
id|tmp_tx_dma
comma
id|tmp_rx_dma
suffix:semicolon
id|dma_addr_t
id|tmp_buf_dma
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_descriptor_init()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* tx descriptor start pointer */
id|db-&gt;tx_insert_ptr
op_assign
id|db-&gt;first_tx_desc
suffix:semicolon
id|db-&gt;tx_remove_ptr
op_assign
id|db-&gt;first_tx_desc
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;first_tx_desc_dma
comma
id|ioaddr
op_plus
id|DCR4
)paren
suffix:semicolon
multiline_comment|/* TX DESC address */
multiline_comment|/* rx descriptor start pointer */
id|db-&gt;first_rx_desc
op_assign
(paren
r_void
op_star
)paren
id|db-&gt;first_tx_desc
op_plus
r_sizeof
(paren
r_struct
id|tx_desc
)paren
op_star
id|TX_DESC_CNT
suffix:semicolon
id|db-&gt;first_rx_desc_dma
op_assign
id|db-&gt;first_tx_desc_dma
op_plus
r_sizeof
(paren
r_struct
id|tx_desc
)paren
op_star
id|TX_DESC_CNT
suffix:semicolon
id|db-&gt;rx_insert_ptr
op_assign
id|db-&gt;first_rx_desc
suffix:semicolon
id|db-&gt;rx_ready_ptr
op_assign
id|db-&gt;first_rx_desc
suffix:semicolon
id|outl
c_func
(paren
id|db-&gt;first_rx_desc_dma
comma
id|ioaddr
op_plus
id|DCR3
)paren
suffix:semicolon
multiline_comment|/* RX DESC address */
multiline_comment|/* Init Transmit chain */
id|tmp_buf
op_assign
id|db-&gt;buf_pool_start
suffix:semicolon
id|tmp_buf_dma
op_assign
id|db-&gt;buf_pool_dma_start
suffix:semicolon
id|tmp_tx_dma
op_assign
id|db-&gt;first_tx_desc_dma
suffix:semicolon
r_for
c_loop
(paren
id|tmp_tx
op_assign
id|db-&gt;first_tx_desc
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_DESC_CNT
suffix:semicolon
id|i
op_increment
comma
id|tmp_tx
op_increment
)paren
(brace
id|tmp_tx-&gt;tx_buf_ptr
op_assign
id|tmp_buf
suffix:semicolon
id|tmp_tx-&gt;tdes0
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|tmp_tx-&gt;tdes1
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x81000000
)paren
suffix:semicolon
multiline_comment|/* IC, chain */
id|tmp_tx-&gt;tdes2
op_assign
id|cpu_to_le32
c_func
(paren
id|tmp_buf_dma
)paren
suffix:semicolon
id|tmp_tx_dma
op_add_assign
r_sizeof
(paren
r_struct
id|tx_desc
)paren
suffix:semicolon
id|tmp_tx-&gt;tdes3
op_assign
id|cpu_to_le32
c_func
(paren
id|tmp_tx_dma
)paren
suffix:semicolon
id|tmp_tx-&gt;next_tx_desc
op_assign
id|tmp_tx
op_plus
l_int|1
suffix:semicolon
id|tmp_buf
op_assign
id|tmp_buf
op_plus
id|TX_BUF_ALLOC
suffix:semicolon
id|tmp_buf_dma
op_assign
id|tmp_buf_dma
op_plus
id|TX_BUF_ALLOC
suffix:semicolon
)brace
(paren
op_decrement
id|tmp_tx
)paren
op_member_access_from_pointer
id|tdes3
op_assign
id|cpu_to_le32
c_func
(paren
id|db-&gt;first_tx_desc_dma
)paren
suffix:semicolon
id|tmp_tx-&gt;next_tx_desc
op_assign
id|db-&gt;first_tx_desc
suffix:semicolon
multiline_comment|/* Init Receive descriptor chain */
id|tmp_rx_dma
op_assign
id|db-&gt;first_rx_desc_dma
suffix:semicolon
r_for
c_loop
(paren
id|tmp_rx
op_assign
id|db-&gt;first_rx_desc
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_DESC_CNT
suffix:semicolon
id|i
op_increment
comma
id|tmp_rx
op_increment
)paren
(brace
id|tmp_rx-&gt;rdes0
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|tmp_rx-&gt;rdes1
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x01000600
)paren
suffix:semicolon
id|tmp_rx_dma
op_add_assign
r_sizeof
(paren
r_struct
id|rx_desc
)paren
suffix:semicolon
id|tmp_rx-&gt;rdes3
op_assign
id|cpu_to_le32
c_func
(paren
id|tmp_rx_dma
)paren
suffix:semicolon
id|tmp_rx-&gt;next_rx_desc
op_assign
id|tmp_rx
op_plus
l_int|1
suffix:semicolon
)brace
(paren
op_decrement
id|tmp_rx
)paren
op_member_access_from_pointer
id|rdes3
op_assign
id|cpu_to_le32
c_func
(paren
id|db-&gt;first_rx_desc_dma
)paren
suffix:semicolon
id|tmp_rx-&gt;next_rx_desc
op_assign
id|db-&gt;first_rx_desc
suffix:semicolon
multiline_comment|/* pre-allocate Rx buffer */
id|allocate_rx_buffer
c_func
(paren
id|db
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Update CR6 value&n; *&t;Firstly stop DM910X , then written value and start&n; */
DECL|function|update_cr6
r_static
r_void
id|update_cr6
c_func
(paren
id|u32
id|cr6_data
comma
r_int
r_int
id|ioaddr
)paren
(brace
id|u32
id|cr6_tmp
suffix:semicolon
id|cr6_tmp
op_assign
id|cr6_data
op_amp
op_complement
l_int|0x2002
suffix:semicolon
multiline_comment|/* stop Tx/Rx */
id|outl
c_func
(paren
id|cr6_tmp
comma
id|ioaddr
op_plus
id|DCR6
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|outl
c_func
(paren
id|cr6_data
comma
id|ioaddr
op_plus
id|DCR6
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Send a setup frame for DM9132&n; *&t;This setup frame initilize DM910X address filter mode&n;*/
DECL|function|dm9132_id_table
r_static
r_void
id|dm9132_id_table
c_func
(paren
r_struct
id|DEVICE
op_star
id|dev
comma
r_int
id|mc_cnt
)paren
(brace
r_struct
id|dev_mc_list
op_star
id|mcptr
suffix:semicolon
id|u16
op_star
id|addrptr
suffix:semicolon
r_int
r_int
id|ioaddr
op_assign
id|dev-&gt;base_addr
op_plus
l_int|0xc0
suffix:semicolon
multiline_comment|/* ID Table */
id|u32
id|hash_val
suffix:semicolon
id|u16
id|i
comma
id|hash_table
(braket
l_int|4
)braket
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dm9132_id_table()&quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Node address */
id|addrptr
op_assign
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
id|outw
c_func
(paren
id|addrptr
(braket
l_int|0
)braket
comma
id|ioaddr
)paren
suffix:semicolon
id|ioaddr
op_add_assign
l_int|4
suffix:semicolon
id|outw
c_func
(paren
id|addrptr
(braket
l_int|1
)braket
comma
id|ioaddr
)paren
suffix:semicolon
id|ioaddr
op_add_assign
l_int|4
suffix:semicolon
id|outw
c_func
(paren
id|addrptr
(braket
l_int|2
)braket
comma
id|ioaddr
)paren
suffix:semicolon
id|ioaddr
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* Clear Hash Table */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* broadcast address */
id|hash_table
(braket
l_int|3
)braket
op_assign
l_int|0x8000
suffix:semicolon
multiline_comment|/* the multicast address in Hash Table : 64 bits */
r_for
c_loop
(paren
id|mcptr
op_assign
id|dev-&gt;mc_list
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mc_cnt
suffix:semicolon
id|i
op_increment
comma
id|mcptr
op_assign
id|mcptr-&gt;next
)paren
(brace
id|hash_val
op_assign
id|cal_CRC
c_func
(paren
(paren
r_char
op_star
)paren
id|mcptr-&gt;dmi_addr
comma
l_int|6
comma
l_int|0
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|hash_table
(braket
id|hash_val
op_div
l_int|16
)braket
op_or_assign
(paren
id|u16
)paren
l_int|1
op_lshift
(paren
id|hash_val
op_mod
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/* Write the hash table to MAC MD table */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
comma
id|ioaddr
op_add_assign
l_int|4
)paren
id|outw
c_func
(paren
id|hash_table
(braket
id|i
)braket
comma
id|ioaddr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Send a setup frame for DM9102/DM9102A&n; *&t;This setup frame initilize DM910X address filter mode&n; */
DECL|function|send_filter_frame
r_static
r_void
id|send_filter_frame
c_func
(paren
r_struct
id|DEVICE
op_star
id|dev
comma
r_int
id|mc_cnt
)paren
(brace
r_struct
id|dmfe_board_info
op_star
id|db
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|mcptr
suffix:semicolon
r_struct
id|tx_desc
op_star
id|txptr
suffix:semicolon
id|u16
op_star
id|addrptr
suffix:semicolon
id|u32
op_star
id|suptr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;send_filter_frame()&quot;
comma
l_int|0
)paren
suffix:semicolon
id|txptr
op_assign
id|db-&gt;tx_insert_ptr
suffix:semicolon
id|suptr
op_assign
(paren
id|u32
op_star
)paren
id|txptr-&gt;tx_buf_ptr
suffix:semicolon
multiline_comment|/* Node address */
id|addrptr
op_assign
(paren
id|u16
op_star
)paren
id|dev-&gt;dev_addr
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* broadcast address */
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* fit the multicast address */
r_for
c_loop
(paren
id|mcptr
op_assign
id|dev-&gt;mc_list
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mc_cnt
suffix:semicolon
id|i
op_increment
comma
id|mcptr
op_assign
id|mcptr-&gt;next
)paren
(brace
id|addrptr
op_assign
(paren
id|u16
op_star
)paren
id|mcptr-&gt;dmi_addr
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|1
)braket
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
id|addrptr
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|14
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
op_star
id|suptr
op_increment
op_assign
l_int|0xffff
suffix:semicolon
)brace
multiline_comment|/* prepare the setup frame */
id|db-&gt;tx_insert_ptr
op_assign
id|txptr-&gt;next_tx_desc
suffix:semicolon
id|txptr-&gt;tdes1
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x890000c0
)paren
suffix:semicolon
multiline_comment|/* Resource Check and Send the setup packet */
r_if
c_cond
(paren
op_logical_neg
id|db-&gt;tx_packet_cnt
)paren
(brace
multiline_comment|/* Resource Empty */
id|db-&gt;tx_packet_cnt
op_increment
suffix:semicolon
id|txptr-&gt;tdes0
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x80000000
)paren
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
op_or
l_int|0x2000
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x1
comma
id|dev-&gt;base_addr
op_plus
id|DCR1
)paren
suffix:semicolon
multiline_comment|/* Issue Tx polling */
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
id|db-&gt;tx_queue_cnt
op_increment
suffix:semicolon
multiline_comment|/* Put in TX queue */
)brace
multiline_comment|/*&n; *&t;Allocate rx buffer,&n; *&t;As possible as allocate maxiumn Rx buffer&n; */
DECL|function|allocate_rx_buffer
r_static
r_void
id|allocate_rx_buffer
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
r_struct
id|rx_desc
op_star
id|rxptr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|rxptr
op_assign
id|db-&gt;rx_insert_ptr
suffix:semicolon
r_while
c_loop
(paren
id|db-&gt;rx_avail_cnt
OL
id|RX_DESC_CNT
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|RX_ALLOC_SIZE
)paren
)paren
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|rxptr-&gt;rx_skb_ptr
op_assign
id|skb
suffix:semicolon
multiline_comment|/* FIXME (?) */
id|rxptr-&gt;rdes2
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|db-&gt;pdev
comma
id|skb-&gt;tail
comma
id|RX_ALLOC_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|rxptr-&gt;rdes0
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x80000000
)paren
suffix:semicolon
id|rxptr
op_assign
id|rxptr-&gt;next_rx_desc
suffix:semicolon
id|db-&gt;rx_avail_cnt
op_increment
suffix:semicolon
)brace
id|db-&gt;rx_insert_ptr
op_assign
id|rxptr
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Read one word data from the serial ROM&n; */
DECL|function|read_srom_word
r_static
id|u16
id|read_srom_word
c_func
(paren
r_int
id|ioaddr
comma
r_int
id|offset
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|srom_data
op_assign
l_int|0
suffix:semicolon
r_int
id|cr9_ioaddr
op_assign
id|ioaddr
op_plus
id|DCR9
suffix:semicolon
id|outl
c_func
(paren
id|CR9_SROM_READ
comma
id|cr9_ioaddr
)paren
suffix:semicolon
id|outl
c_func
(paren
id|CR9_SROM_READ
op_or
id|CR9_SRCS
comma
id|cr9_ioaddr
)paren
suffix:semicolon
multiline_comment|/* Send the Read Command 110b */
id|SROM_CLK_WRITE
c_func
(paren
id|SROM_DATA_1
comma
id|cr9_ioaddr
)paren
suffix:semicolon
id|SROM_CLK_WRITE
c_func
(paren
id|SROM_DATA_1
comma
id|cr9_ioaddr
)paren
suffix:semicolon
id|SROM_CLK_WRITE
c_func
(paren
id|SROM_DATA_0
comma
id|cr9_ioaddr
)paren
suffix:semicolon
multiline_comment|/* Send the offset */
r_for
c_loop
(paren
id|i
op_assign
l_int|5
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|srom_data
op_assign
(paren
id|offset
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|SROM_DATA_1
suffix:colon
id|SROM_DATA_0
suffix:semicolon
id|SROM_CLK_WRITE
c_func
(paren
id|srom_data
comma
id|cr9_ioaddr
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|CR9_SROM_READ
op_or
id|CR9_SRCS
comma
id|cr9_ioaddr
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|outl
c_func
(paren
id|CR9_SROM_READ
op_or
id|CR9_SRCS
op_or
id|CR9_SRCLK
comma
id|cr9_ioaddr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|srom_data
op_assign
(paren
id|srom_data
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|inl
c_func
(paren
id|cr9_ioaddr
)paren
op_amp
id|CR9_CRDOUT
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|outl
c_func
(paren
id|CR9_SROM_READ
op_or
id|CR9_SRCS
comma
id|cr9_ioaddr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|CR9_SROM_READ
comma
id|cr9_ioaddr
)paren
suffix:semicolon
r_return
id|srom_data
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Auto sense the media mode&n; */
DECL|function|dmfe_sense_speed
r_static
id|u8
id|dmfe_sense_speed
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
id|u8
id|ErrFlag
op_assign
l_int|0
suffix:semicolon
id|u16
id|phy_mode
suffix:semicolon
multiline_comment|/* CR6 bit18=0, select 10/100M */
id|update_cr6
c_func
(paren
(paren
id|db-&gt;cr6_data
op_amp
op_complement
l_int|0x40000
)paren
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
id|phy_mode
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|1
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|phy_mode
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|1
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|phy_mode
op_amp
l_int|0x24
)paren
op_eq
l_int|0x24
)paren
(brace
r_if
c_cond
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9132_ID
)paren
multiline_comment|/* DM9132 */
id|phy_mode
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|7
comma
id|db-&gt;chip_id
)paren
op_amp
l_int|0xf000
suffix:semicolon
r_else
multiline_comment|/* DM9102/DM9102A */
id|phy_mode
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|17
comma
id|db-&gt;chip_id
)paren
op_amp
l_int|0xf000
suffix:semicolon
multiline_comment|/* printk(DRV_NAME &quot;: Phy_mode %x &quot;,phy_mode); */
r_switch
c_cond
(paren
id|phy_mode
)paren
(brace
r_case
l_int|0x1000
suffix:colon
id|db-&gt;op_mode
op_assign
id|DMFE_10MHF
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2000
suffix:colon
id|db-&gt;op_mode
op_assign
id|DMFE_10MFD
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x4000
suffix:colon
id|db-&gt;op_mode
op_assign
id|DMFE_100MHF
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8000
suffix:colon
id|db-&gt;op_mode
op_assign
id|DMFE_100MFD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|db-&gt;op_mode
op_assign
id|DMFE_10MHF
suffix:semicolon
id|ErrFlag
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|db-&gt;op_mode
op_assign
id|DMFE_10MHF
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;Link Failed :&quot;
comma
id|phy_mode
)paren
suffix:semicolon
id|ErrFlag
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|ErrFlag
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set 10/100 phyxcer capability&n; *&t;AUTO mode : phyxcer register4 is NIC capability&n; *&t;Force mode: phyxcer register4 is the force media&n; */
DECL|function|dmfe_set_phyxcer
r_static
r_void
id|dmfe_set_phyxcer
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
id|u16
id|phy_reg
suffix:semicolon
multiline_comment|/* Select 10/100M phyxcer */
id|db-&gt;cr6_data
op_and_assign
op_complement
l_int|0x40000
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
multiline_comment|/* DM9009 Chip: Phyxcer reg18 bit12=0 */
r_if
c_cond
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9009_ID
)paren
(brace
id|phy_reg
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|18
comma
id|db-&gt;chip_id
)paren
op_amp
op_complement
l_int|0x1000
suffix:semicolon
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|18
comma
id|phy_reg
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
)brace
multiline_comment|/* Phyxcer capability setting */
id|phy_reg
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|4
comma
id|db-&gt;chip_id
)paren
op_amp
op_complement
l_int|0x01e0
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;media_mode
op_amp
id|DMFE_AUTO
)paren
(brace
multiline_comment|/* AUTO Mode */
id|phy_reg
op_or_assign
id|db-&gt;PHY_reg4
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Force Mode */
r_switch
c_cond
(paren
id|db-&gt;media_mode
)paren
(brace
r_case
id|DMFE_10MHF
suffix:colon
id|phy_reg
op_or_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_10MFD
suffix:colon
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_100MHF
suffix:colon
id|phy_reg
op_or_assign
l_int|0x80
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_100MFD
suffix:colon
id|phy_reg
op_or_assign
l_int|0x100
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9009_ID
)paren
id|phy_reg
op_and_assign
l_int|0x61
suffix:semicolon
)brace
multiline_comment|/* Write new capability to Phyxcer Reg4 */
r_if
c_cond
(paren
op_logical_neg
(paren
id|phy_reg
op_amp
l_int|0x01e0
)paren
)paren
(brace
id|phy_reg
op_or_assign
id|db-&gt;PHY_reg4
suffix:semicolon
id|db-&gt;media_mode
op_or_assign
id|DMFE_AUTO
suffix:semicolon
)brace
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|4
comma
id|phy_reg
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
multiline_comment|/* Restart Auto-Negotiation */
r_if
c_cond
(paren
id|db-&gt;chip_type
op_logical_and
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9102_ID
)paren
)paren
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|0
comma
l_int|0x1800
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|db-&gt;chip_type
)paren
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|0
comma
l_int|0x1200
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Process op-mode&n; *&t;AUTO mode : PHY controller in Auto-negotiation Mode&n; *&t;Force mode: PHY controller in force mode with HUB&n; *&t;&t;&t;N-way force capability with SWITCH&n; */
DECL|function|dmfe_process_mode
r_static
r_void
id|dmfe_process_mode
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
id|u16
id|phy_reg
suffix:semicolon
multiline_comment|/* Full Duplex Mode Check */
r_if
c_cond
(paren
id|db-&gt;op_mode
op_amp
l_int|0x4
)paren
id|db-&gt;cr6_data
op_or_assign
id|CR6_FDM
suffix:semicolon
multiline_comment|/* Set Full Duplex Bit */
r_else
id|db-&gt;cr6_data
op_and_assign
op_complement
id|CR6_FDM
suffix:semicolon
multiline_comment|/* Clear Full Duplex Bit */
multiline_comment|/* Transciver Selection */
r_if
c_cond
(paren
id|db-&gt;op_mode
op_amp
l_int|0x10
)paren
multiline_comment|/* 1M HomePNA */
id|db-&gt;cr6_data
op_or_assign
l_int|0x40000
suffix:semicolon
multiline_comment|/* External MII select */
r_else
id|db-&gt;cr6_data
op_and_assign
op_complement
l_int|0x40000
suffix:semicolon
multiline_comment|/* Internal 10/100 transciver */
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
multiline_comment|/* 10/100M phyxcer force mode need */
r_if
c_cond
(paren
op_logical_neg
(paren
id|db-&gt;media_mode
op_amp
l_int|0x18
)paren
)paren
(brace
multiline_comment|/* Forece Mode */
id|phy_reg
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|6
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|phy_reg
op_amp
l_int|0x1
)paren
)paren
(brace
multiline_comment|/* parter without N-Way capability */
id|phy_reg
op_assign
l_int|0x0
suffix:semicolon
r_switch
c_cond
(paren
id|db-&gt;op_mode
)paren
(brace
r_case
id|DMFE_10MHF
suffix:colon
id|phy_reg
op_assign
l_int|0x0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_10MFD
suffix:colon
id|phy_reg
op_assign
l_int|0x100
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_100MHF
suffix:colon
id|phy_reg
op_assign
l_int|0x2000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMFE_100MFD
suffix:colon
id|phy_reg
op_assign
l_int|0x2100
suffix:semicolon
r_break
suffix:semicolon
)brace
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|0
comma
id|phy_reg
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;chip_type
op_logical_and
(paren
id|db-&gt;chip_id
op_eq
id|PCI_DM9102_ID
)paren
)paren
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|0
comma
id|phy_reg
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;Write a word to Phy register&n; */
DECL|function|phy_write
r_static
r_void
id|phy_write
c_func
(paren
r_int
r_int
id|iobase
comma
id|u8
id|phy_addr
comma
id|u8
id|offset
comma
id|u16
id|phy_data
comma
id|u32
id|chip_id
)paren
(brace
id|u16
id|i
suffix:semicolon
r_int
r_int
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|chip_id
op_eq
id|PCI_DM9132_ID
)paren
(brace
id|ioaddr
op_assign
id|iobase
op_plus
l_int|0x80
op_plus
id|offset
op_star
l_int|4
suffix:semicolon
id|outw
c_func
(paren
id|phy_data
comma
id|ioaddr
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DM9102/DM9102A Chip */
id|ioaddr
op_assign
id|iobase
op_plus
id|DCR9
suffix:semicolon
multiline_comment|/* Send 33 synchronization clock to Phy controller */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|35
suffix:semicolon
id|i
op_increment
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
multiline_comment|/* Send start command(01) to Phy */
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_0
)paren
suffix:semicolon
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
multiline_comment|/* Send write command(01) to Phy */
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_0
)paren
suffix:semicolon
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
multiline_comment|/* Send Phy address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0x10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_assign
id|i
op_rshift
l_int|1
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|phy_addr
op_amp
id|i
ques
c_cond
id|PHY_DATA_1
suffix:colon
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* Send register address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0x10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_assign
id|i
op_rshift
l_int|1
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|offset
op_amp
id|i
ques
c_cond
id|PHY_DATA_1
suffix:colon
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* written trasnition */
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* Write a word data to PHY controller */
r_for
c_loop
(paren
id|i
op_assign
l_int|0x8000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_rshift_assign
l_int|1
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|phy_data
op_amp
id|i
ques
c_cond
id|PHY_DATA_1
suffix:colon
id|PHY_DATA_0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Read a word data from phy register&n; */
DECL|function|phy_read
r_static
id|u16
id|phy_read
c_func
(paren
r_int
r_int
id|iobase
comma
id|u8
id|phy_addr
comma
id|u8
id|offset
comma
id|u32
id|chip_id
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|phy_data
suffix:semicolon
r_int
r_int
id|ioaddr
suffix:semicolon
r_if
c_cond
(paren
id|chip_id
op_eq
id|PCI_DM9132_ID
)paren
(brace
multiline_comment|/* DM9132 Chip */
id|ioaddr
op_assign
id|iobase
op_plus
l_int|0x80
op_plus
id|offset
op_star
l_int|4
suffix:semicolon
id|phy_data
op_assign
id|inw
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DM9102/DM9102A Chip */
id|ioaddr
op_assign
id|iobase
op_plus
id|DCR9
suffix:semicolon
multiline_comment|/* Send 33 synchronization clock to Phy controller */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|35
suffix:semicolon
id|i
op_increment
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
multiline_comment|/* Send start command(01) to Phy */
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_0
)paren
suffix:semicolon
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
multiline_comment|/* Send read command(10) to Phy */
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_1
)paren
suffix:semicolon
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* Send Phy address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0x10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_assign
id|i
op_rshift
l_int|1
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|phy_addr
op_amp
id|i
ques
c_cond
id|PHY_DATA_1
suffix:colon
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* Send register address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0x10
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_assign
id|i
op_rshift
l_int|1
)paren
id|phy_write_1bit
c_func
(paren
id|ioaddr
comma
id|offset
op_amp
id|i
ques
c_cond
id|PHY_DATA_1
suffix:colon
id|PHY_DATA_0
)paren
suffix:semicolon
multiline_comment|/* Skip transition state */
id|phy_read_1bit
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* read 16bit data */
r_for
c_loop
(paren
id|phy_data
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|phy_data
op_lshift_assign
l_int|1
suffix:semicolon
id|phy_data
op_or_assign
id|phy_read_1bit
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
)brace
)brace
r_return
id|phy_data
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Write one bit data to Phy Controller&n; */
DECL|function|phy_write_1bit
r_static
r_void
id|phy_write_1bit
c_func
(paren
r_int
r_int
id|ioaddr
comma
id|u32
id|phy_data
)paren
(brace
id|outl
c_func
(paren
id|phy_data
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* MII Clock Low */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outl
c_func
(paren
id|phy_data
op_or
id|MDCLKH
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* MII Clock High */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outl
c_func
(paren
id|phy_data
comma
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* MII Clock Low */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Read one bit phy data from PHY controller&n; */
DECL|function|phy_read_1bit
r_static
id|u16
id|phy_read_1bit
c_func
(paren
r_int
r_int
id|ioaddr
)paren
(brace
id|u16
id|phy_data
suffix:semicolon
id|outl
c_func
(paren
l_int|0x50000
comma
id|ioaddr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|phy_data
op_assign
(paren
id|inl
c_func
(paren
id|ioaddr
)paren
op_rshift
l_int|19
)paren
op_amp
l_int|0x1
suffix:semicolon
id|outl
c_func
(paren
l_int|0x40000
comma
id|ioaddr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
id|phy_data
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Calculate the CRC valude of the Rx packet&n; *&t;flag = &t;1 : return the reverse CRC (for the received packet CRC)&n; *&t;&t;0 : return the normal CRC (for Hash Table index)&n; */
DECL|function|cal_CRC
r_static
r_inline
id|u32
id|cal_CRC
c_func
(paren
r_int
r_char
op_star
id|Data
comma
r_int
r_int
id|Len
comma
id|u8
id|flag
)paren
(brace
id|u32
id|crc
op_assign
id|crc32
c_func
(paren
op_complement
l_int|0
comma
id|Data
comma
id|Len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
)paren
id|crc
op_assign
op_complement
id|crc
suffix:semicolon
r_return
id|crc
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Parser SROM and media mode&n; */
DECL|function|dmfe_parse_srom
r_static
r_void
id|dmfe_parse_srom
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
r_char
op_star
id|srom
op_assign
id|db-&gt;srom
suffix:semicolon
r_int
id|dmfe_mode
comma
id|tmp_reg
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_parse_srom() &quot;
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Init CR15 */
id|db-&gt;cr15_data
op_assign
id|CR15_DEFAULT
suffix:semicolon
multiline_comment|/* Check SROM Version */
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|srom
(braket
l_int|18
)braket
op_amp
l_int|0xff
)paren
op_eq
id|SROM_V41_CODE
)paren
(brace
multiline_comment|/* SROM V4.01 */
multiline_comment|/* Get NIC support media mode */
id|db-&gt;NIC_capability
op_assign
id|le16_to_cpup
c_func
(paren
id|srom
op_plus
l_int|34
)paren
suffix:semicolon
id|db-&gt;PHY_reg4
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|tmp_reg
op_assign
l_int|1
suffix:semicolon
id|tmp_reg
OL
l_int|0x10
suffix:semicolon
id|tmp_reg
op_lshift_assign
l_int|1
)paren
(brace
r_switch
c_cond
(paren
id|db-&gt;NIC_capability
op_amp
id|tmp_reg
)paren
(brace
r_case
l_int|0x1
suffix:colon
id|db-&gt;PHY_reg4
op_or_assign
l_int|0x0020
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2
suffix:colon
id|db-&gt;PHY_reg4
op_or_assign
l_int|0x0040
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x4
suffix:colon
id|db-&gt;PHY_reg4
op_or_assign
l_int|0x0080
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8
suffix:colon
id|db-&gt;PHY_reg4
op_or_assign
l_int|0x0100
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Media Mode Force or not check */
id|dmfe_mode
op_assign
id|le32_to_cpup
c_func
(paren
id|srom
op_plus
l_int|34
)paren
op_amp
id|le32_to_cpup
c_func
(paren
id|srom
op_plus
l_int|36
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dmfe_mode
)paren
(brace
r_case
l_int|0x4
suffix:colon
id|dmfe_media_mode
op_assign
id|DMFE_100MHF
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 100MHF */
r_case
l_int|0x2
suffix:colon
id|dmfe_media_mode
op_assign
id|DMFE_10MFD
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 10MFD */
r_case
l_int|0x8
suffix:colon
id|dmfe_media_mode
op_assign
id|DMFE_100MFD
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 100MFD */
r_case
l_int|0x100
suffix:colon
r_case
l_int|0x200
suffix:colon
id|dmfe_media_mode
op_assign
id|DMFE_1M_HPNA
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* HomePNA */
)brace
multiline_comment|/* Special Function setting */
multiline_comment|/* VLAN function */
r_if
c_cond
(paren
(paren
id|SF_mode
op_amp
l_int|0x1
)paren
op_logical_or
(paren
id|srom
(braket
l_int|43
)braket
op_amp
l_int|0x80
)paren
)paren
id|db-&gt;cr15_data
op_or_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* Flow Control */
r_if
c_cond
(paren
(paren
id|SF_mode
op_amp
l_int|0x2
)paren
op_logical_or
(paren
id|srom
(braket
l_int|40
)braket
op_amp
l_int|0x1
)paren
)paren
id|db-&gt;cr15_data
op_or_assign
l_int|0x400
suffix:semicolon
multiline_comment|/* TX pause packet */
r_if
c_cond
(paren
(paren
id|SF_mode
op_amp
l_int|0x4
)paren
op_logical_or
(paren
id|srom
(braket
l_int|40
)braket
op_amp
l_int|0xe
)paren
)paren
id|db-&gt;cr15_data
op_or_assign
l_int|0x9800
suffix:semicolon
)brace
multiline_comment|/* Parse HPNA parameter */
id|db-&gt;HPNA_command
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Accept remote command or not */
r_if
c_cond
(paren
id|HPNA_rx_cmd
op_eq
l_int|0
)paren
id|db-&gt;HPNA_command
op_or_assign
l_int|0x8000
suffix:semicolon
multiline_comment|/* Issue remote command &amp; operation mode */
r_if
c_cond
(paren
id|HPNA_tx_cmd
op_eq
l_int|1
)paren
r_switch
c_cond
(paren
id|HPNA_mode
)paren
(brace
multiline_comment|/* Issue Remote Command */
r_case
l_int|0
suffix:colon
id|db-&gt;HPNA_command
op_or_assign
l_int|0x0904
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|db-&gt;HPNA_command
op_or_assign
l_int|0x0a00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|db-&gt;HPNA_command
op_or_assign
l_int|0x0506
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|db-&gt;HPNA_command
op_or_assign
l_int|0x0602
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|HPNA_mode
)paren
(brace
multiline_comment|/* Don&squot;t Issue */
r_case
l_int|0
suffix:colon
id|db-&gt;HPNA_command
op_or_assign
l_int|0x0004
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|db-&gt;HPNA_command
op_or_assign
l_int|0x0000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|db-&gt;HPNA_command
op_or_assign
l_int|0x0006
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|db-&gt;HPNA_command
op_or_assign
l_int|0x0002
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Check DM9801 or DM9802 present or not */
id|db-&gt;HPNA_present
op_assign
l_int|0
suffix:semicolon
id|update_cr6
c_func
(paren
id|db-&gt;cr6_data
op_or
l_int|0x40000
comma
id|db-&gt;ioaddr
)paren
suffix:semicolon
id|tmp_reg
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|3
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp_reg
op_amp
l_int|0xfff0
)paren
op_eq
l_int|0xb900
)paren
(brace
multiline_comment|/* DM9801 or DM9802 present */
id|db-&gt;HPNA_timer
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|31
comma
id|db-&gt;chip_id
)paren
op_eq
l_int|0x4404
)paren
(brace
multiline_comment|/* DM9801 HomeRun */
id|db-&gt;HPNA_present
op_assign
l_int|1
suffix:semicolon
id|dmfe_program_DM9801
c_func
(paren
id|db
comma
id|tmp_reg
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DM9802 LongRun */
id|db-&gt;HPNA_present
op_assign
l_int|2
suffix:semicolon
id|dmfe_program_DM9802
c_func
(paren
id|db
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;Init HomeRun DM9801&n; */
DECL|function|dmfe_program_DM9801
r_static
r_void
id|dmfe_program_DM9801
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
comma
r_int
id|HPNA_rev
)paren
(brace
id|uint
id|reg17
comma
id|reg25
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HPNA_NoiseFloor
)paren
id|HPNA_NoiseFloor
op_assign
id|DM9801_NOISE_FLOOR
suffix:semicolon
r_switch
c_cond
(paren
id|HPNA_rev
)paren
(brace
r_case
l_int|0xb900
suffix:colon
multiline_comment|/* DM9801 E3 */
id|db-&gt;HPNA_command
op_or_assign
l_int|0x1000
suffix:semicolon
id|reg25
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|24
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|reg25
op_assign
(paren
(paren
id|reg25
op_plus
id|HPNA_NoiseFloor
)paren
op_amp
l_int|0xff
)paren
op_or
l_int|0xf000
suffix:semicolon
id|reg17
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|17
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xb901
suffix:colon
multiline_comment|/* DM9801 E4 */
id|reg25
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|25
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|reg25
op_assign
(paren
id|reg25
op_amp
l_int|0xff00
)paren
op_plus
id|HPNA_NoiseFloor
suffix:semicolon
id|reg17
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|17
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|reg17
op_assign
(paren
id|reg17
op_amp
l_int|0xfff0
)paren
op_plus
id|HPNA_NoiseFloor
op_plus
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xb902
suffix:colon
multiline_comment|/* DM9801 E5 */
r_case
l_int|0xb903
suffix:colon
multiline_comment|/* DM9801 E6 */
r_default
suffix:colon
id|db-&gt;HPNA_command
op_or_assign
l_int|0x1000
suffix:semicolon
id|reg25
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|25
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|reg25
op_assign
(paren
id|reg25
op_amp
l_int|0xff00
)paren
op_plus
id|HPNA_NoiseFloor
op_minus
l_int|5
suffix:semicolon
id|reg17
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|17
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|reg17
op_assign
(paren
id|reg17
op_amp
l_int|0xfff0
)paren
op_plus
id|HPNA_NoiseFloor
suffix:semicolon
r_break
suffix:semicolon
)brace
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|16
comma
id|db-&gt;HPNA_command
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|17
comma
id|reg17
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|25
comma
id|reg25
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Init HomeRun DM9802&n; */
DECL|function|dmfe_program_DM9802
r_static
r_void
id|dmfe_program_DM9802
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
id|uint
id|phy_reg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HPNA_NoiseFloor
)paren
id|HPNA_NoiseFloor
op_assign
id|DM9802_NOISE_FLOOR
suffix:semicolon
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|16
comma
id|db-&gt;HPNA_command
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|phy_reg
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|25
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|phy_reg
op_assign
(paren
id|phy_reg
op_amp
l_int|0xff00
)paren
op_plus
id|HPNA_NoiseFloor
suffix:semicolon
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|25
comma
id|phy_reg
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Check remote HPNA power and speed status. If not correct,&n; *&t;issue command again.&n;*/
DECL|function|dmfe_HPNA_remote_cmd_chk
r_static
r_void
id|dmfe_HPNA_remote_cmd_chk
c_func
(paren
r_struct
id|dmfe_board_info
op_star
id|db
)paren
(brace
id|uint
id|phy_reg
suffix:semicolon
multiline_comment|/* Got remote device status */
id|phy_reg
op_assign
id|phy_read
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|17
comma
id|db-&gt;chip_id
)paren
op_amp
l_int|0x60
suffix:semicolon
r_switch
c_cond
(paren
id|phy_reg
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|phy_reg
op_assign
l_int|0x0a00
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* LP/LS */
r_case
l_int|0x20
suffix:colon
id|phy_reg
op_assign
l_int|0x0900
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* LP/HS */
r_case
l_int|0x40
suffix:colon
id|phy_reg
op_assign
l_int|0x0600
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* HP/LS */
r_case
l_int|0x60
suffix:colon
id|phy_reg
op_assign
l_int|0x0500
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* HP/HS */
)brace
multiline_comment|/* Check remote device status match our setting ot not */
r_if
c_cond
(paren
id|phy_reg
op_ne
(paren
id|db-&gt;HPNA_command
op_amp
l_int|0x0f00
)paren
)paren
(brace
id|phy_write
c_func
(paren
id|db-&gt;ioaddr
comma
id|db-&gt;phy_addr
comma
l_int|16
comma
id|db-&gt;HPNA_command
comma
id|db-&gt;chip_id
)paren
suffix:semicolon
id|db-&gt;HPNA_timer
op_assign
l_int|8
suffix:semicolon
)brace
r_else
id|db-&gt;HPNA_timer
op_assign
l_int|600
suffix:semicolon
multiline_comment|/* Match, every 10 minutes, check */
)brace
DECL|variable|dmfe_pci_tbl
r_static
r_struct
id|pci_device_id
id|dmfe_pci_tbl
(braket
)braket
op_assign
(brace
(brace
l_int|0x1282
comma
l_int|0x9132
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|PCI_DM9132_ID
)brace
comma
(brace
l_int|0x1282
comma
l_int|0x9102
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|PCI_DM9102_ID
)brace
comma
(brace
l_int|0x1282
comma
l_int|0x9100
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|PCI_DM9100_ID
)brace
comma
(brace
l_int|0x1282
comma
l_int|0x9009
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|PCI_DM9009_ID
)brace
comma
(brace
l_int|0x10B9
comma
l_int|0x5261
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|PCI_DM9102_ID
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|dmfe_pci_tbl
)paren
suffix:semicolon
DECL|variable|dmfe_driver
r_static
r_struct
id|pci_driver
id|dmfe_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;dmfe&quot;
comma
dot
id|id_table
op_assign
id|dmfe_pci_tbl
comma
dot
id|probe
op_assign
id|dmfe_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|dmfe_remove_one
)paren
comma
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Sten Wang, sten_wang@davicom.com.tw&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Davicom DM910X fast ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mode
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cr6set
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|chkmode
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|HPNA_mode
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|HPNA_rx_cmd
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|HPNA_tx_cmd
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|HPNA_NoiseFloor
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|SF_mode
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Davicom DM9xxx enable debugging (0-1)&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mode
comma
l_string|&quot;Davicom DM9xxx: Bit 0: 10/100Mbps, bit 2: duplex, bit 8: HomePNA&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|SF_mode
comma
l_string|&quot;Davicom DM9xxx special function (bit 0: VLAN, bit 1 Flow Control, bit 2: TX pause packet)&quot;
)paren
suffix:semicolon
multiline_comment|/*&t;Description:&n; *&t;when user used insmod to add module, system invoked init_module()&n; *&t;to initilize and register.&n; */
DECL|function|dmfe_init_module
r_static
r_int
id|__init
id|dmfe_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|printk
c_func
(paren
id|version
)paren
suffix:semicolon
id|printed_version
op_assign
l_int|1
suffix:semicolon
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;init_module() &quot;
comma
id|debug
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|dmfe_debug
op_assign
id|debug
suffix:semicolon
multiline_comment|/* set debug flag */
r_if
c_cond
(paren
id|cr6set
)paren
id|dmfe_cr6_user_set
op_assign
id|cr6set
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|DMFE_10MHF
suffix:colon
r_case
id|DMFE_100MHF
suffix:colon
r_case
id|DMFE_10MFD
suffix:colon
r_case
id|DMFE_100MFD
suffix:colon
r_case
id|DMFE_1M_HPNA
suffix:colon
id|dmfe_media_mode
op_assign
id|mode
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dmfe_media_mode
op_assign
id|DMFE_AUTO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HPNA_mode
OG
l_int|4
)paren
id|HPNA_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Default: LP/HS */
r_if
c_cond
(paren
id|HPNA_rx_cmd
OG
l_int|1
)paren
id|HPNA_rx_cmd
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Default: Ignored remote cmd */
r_if
c_cond
(paren
id|HPNA_tx_cmd
OG
l_int|1
)paren
id|HPNA_tx_cmd
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Default: Don&squot;t issue remote cmd */
r_if
c_cond
(paren
id|HPNA_NoiseFloor
OG
l_int|15
)paren
id|HPNA_NoiseFloor
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|dmfe_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Description:&n; *&t;when user used rmmod to delete module, system invoked clean_module()&n; *&t;to un-register all registered services.&n; */
DECL|function|dmfe_cleanup_module
r_static
r_void
id|__exit
id|dmfe_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|DMFE_DBUG
c_func
(paren
l_int|0
comma
l_string|&quot;dmfe_clean_module() &quot;
comma
id|debug
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|dmfe_driver
)paren
suffix:semicolon
)brace
DECL|variable|dmfe_init_module
id|module_init
c_func
(paren
id|dmfe_init_module
)paren
suffix:semicolon
DECL|variable|dmfe_cleanup_module
id|module_exit
c_func
(paren
id|dmfe_cleanup_module
)paren
suffix:semicolon
eof
