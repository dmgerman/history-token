multiline_comment|/* &n;**&n;**  RCpci45.c  &n;**&n;**&n;**&n;**  ---------------------------------------------------------------------&n;**  ---     Copyright (c) 1998, 1999, RedCreek Communications Inc.    ---&n;**  ---                   All rights reserved.                        ---&n;**  ---------------------------------------------------------------------&n;**&n;** Written by Pete Popov and Brian Moyle.&n;**&n;** Known Problems&n;** &n;** None known at this time.&n;**&n;**  This program is free software; you can redistribute it and/or modify&n;**  it under the terms of the GNU General Public License as published by&n;**  the Free Software Foundation; either version 2 of the License, or&n;**  (at your option) any later version.&n;&n;**  This program is distributed in the hope that it will be useful,&n;**  but WITHOUT ANY WARRANTY; without even the implied warranty of&n;**  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;**  GNU General Public License for more details.&n;&n;**  You should have received a copy of the GNU General Public License&n;**  along with this program; if not, write to the Free Software&n;**  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;**&n;**  Francois Romieu, Apr 2003: Converted to pci DMA mapping API.&n;**&n;**  Pete Popov, Oct 2001: Fixed a few bugs to make the driver functional&n;**  again. Note that this card is not supported or manufactured by &n;**  RedCreek anymore.&n;**   &n;**  Rasmus Andersen, December 2000: Converted to new PCI API and general&n;**  cleanup.&n;**&n;**  Pete Popov, January 11,99: Fixed a couple of 2.1.x problems &n;**  (virt_to_bus() not called), tested it under 2.2pre5 (as a module), and &n;**  added a #define(s) to enable the use of the same file for both, the 2.0.x &n;**  kernels as well as the 2.1.x.&n;**&n;**  Ported to 2.1.x by Alan Cox 1998/12/9. &n;**&n;**  Sometime in mid 1998, written by Pete Popov and Brian Moyle.&n;**&n;***************************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/irq.h&gt;&t;&t;/* For NR_IRQS only. */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|variable|__initdata
r_static
r_char
id|version
(braket
)braket
id|__initdata
op_assign
l_string|&quot;RedCreek Communications PCI linux driver version 2.21&bslash;n&quot;
suffix:semicolon
DECL|macro|RC_LINUX_MODULE
mdefine_line|#define RC_LINUX_MODULE
macro_line|#include &quot;rclanmtl.h&quot;
macro_line|#include &quot;rcif.h&quot;
DECL|macro|RUN_AT
mdefine_line|#define RUN_AT(x) (jiffies + (x))
DECL|macro|NEW_MULTICAST
mdefine_line|#define NEW_MULTICAST
DECL|macro|MAX_ETHER_SIZE
mdefine_line|#define MAX_ETHER_SIZE        1520
DECL|macro|MAX_NMBR_RCV_BUFFERS
mdefine_line|#define MAX_NMBR_RCV_BUFFERS    96
DECL|macro|RC_POSTED_BUFFERS_LOW_MARK
mdefine_line|#define RC_POSTED_BUFFERS_LOW_MARK MAX_NMBR_RCV_BUFFERS-16
DECL|macro|BD_SIZE
mdefine_line|#define BD_SIZE 3&t;&t;/* Bucket Descriptor size */
DECL|macro|BD_LEN_OFFSET
mdefine_line|#define BD_LEN_OFFSET 2&t;&t;/* Bucket Descriptor offset to length field */
multiline_comment|/* RedCreek LAN device Target ID */
DECL|macro|RC_LAN_TARGET_ID
mdefine_line|#define RC_LAN_TARGET_ID  0x10
multiline_comment|/* RedCreek&squot;s OSM default LAN receive Initiator */
DECL|macro|DEFAULT_RECV_INIT_CONTEXT
mdefine_line|#define DEFAULT_RECV_INIT_CONTEXT  0xA17
multiline_comment|/* minimum msg buffer size needed by the card &n; * Note that the size of this buffer is hard code in the&n; * ipsec card&squot;s firmware. Thus, the size MUST be a minimum&n; * of 16K. Otherwise the card will end up using memory&n; * that does not belong to it.&n; */
DECL|macro|MSG_BUF_SIZE
mdefine_line|#define MSG_BUF_SIZE  16384
multiline_comment|/* 2003/04/20: I don&squot;t know about the hardware ability but the driver won&squot;t&n; * play safe with 64 bit addressing and DAC without NETIF_F_HIGHDMA doesn&squot;t&n; * really make sense anyway. Let&squot;s play safe - romieu.&n; */
DECL|macro|RCPCI45_DMA_MASK
mdefine_line|#define RCPCI45_DMA_MASK&t;((u64) 0xffffffff)
DECL|variable|DriverControlWord
r_static
id|U32
id|DriverControlWord
suffix:semicolon
r_static
r_void
id|rc_timer
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|RCopen
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|RC_xmit_packet
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|RCinterrupt
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
r_static
r_int
id|RCclose
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|RCget_stats
(paren
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|RCioctl
(paren
r_struct
id|net_device
op_star
comma
r_struct
id|ifreq
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|RCconfig
(paren
r_struct
id|net_device
op_star
comma
r_struct
id|ifmap
op_star
)paren
suffix:semicolon
r_static
r_void
id|RCxmit_callback
(paren
id|U32
comma
id|U16
comma
id|PU32
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|RCrecv_callback
(paren
id|U32
comma
id|U8
comma
id|U32
comma
id|PU32
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|RCreset_callback
(paren
id|U32
comma
id|U32
comma
id|U32
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|RCreboot_callback
(paren
id|U32
comma
id|U32
comma
id|U32
comma
r_struct
id|net_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|RC_allocate_and_post_buffers
(paren
r_struct
id|net_device
op_star
comma
r_int
)paren
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|rcpci45_pci_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_REDCREEK
comma
id|PCI_DEVICE_ID_RC45
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|rcpci45_pci_table
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
r_static
r_void
id|__devexit
DECL|function|rcpci45_remove_one
id|rcpci45_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
(paren
id|pdev
)paren
suffix:semicolon
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: remove non-existent device&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|RCResetIOP
(paren
id|dev
)paren
suffix:semicolon
id|unregister_netdev
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|iounmap
(paren
(paren
r_void
op_star
)paren
id|dev-&gt;base_addr
)paren
suffix:semicolon
id|pci_release_regions
(paren
id|pdev
)paren
suffix:semicolon
id|pci_free_consistent
(paren
id|pdev
comma
id|MSG_BUF_SIZE
comma
id|pDpa-&gt;msgbuf
comma
id|pDpa-&gt;msgbuf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDpa-&gt;pPab
)paren
id|kfree
(paren
id|pDpa-&gt;pPab
)paren
suffix:semicolon
id|kfree
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_drvdata
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|rcpci45_init_one
id|rcpci45_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_int
r_int
op_star
id|vaddr
suffix:semicolon
id|PDPA
id|pDpa
suffix:semicolon
r_int
id|error
suffix:semicolon
r_static
r_int
id|card_idx
op_assign
op_minus
l_int|1
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
r_int
id|pci_start
comma
id|pci_len
suffix:semicolon
id|card_idx
op_increment
suffix:semicolon
multiline_comment|/* &n;&t; * Allocate and fill new device structure. &n;&t; * We need enough for struct net_device plus DPA plus the LAN &n;&t; * API private area, which requires a minimum of 16KB.  The top &n;&t; * of the allocated area will be assigned to struct net_device; &n;&t; * the next chunk will be assigned to DPA; and finally, the rest &n;&t; * will be assigned to the LAN API layer.&n;&t; */
id|dev
op_assign
id|init_etherdev
(paren
l_int|NULL
comma
r_sizeof
(paren
op_star
id|pDpa
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;(rcpci45 driver:) init_etherdev alloc failed&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|dev
comma
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
id|error
op_assign
id|pci_enable_device
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;(rcpci45 driver:) %d: pci enable device error&bslash;n&quot;
comma
id|card_idx
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|pci_start
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|pci_len
op_assign
id|pci_resource_len
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;pci_start %lx pci_len %lx&bslash;n&quot;
comma
id|pci_start
comma
id|pci_len
)paren
suffix:semicolon
id|pci_set_drvdata
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
id|pDpa-&gt;id
op_assign
id|card_idx
suffix:semicolon
id|pDpa-&gt;pci_dev
op_assign
id|pdev
suffix:semicolon
id|pDpa-&gt;pci_addr
op_assign
id|pci_start
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_start
op_logical_or
op_logical_neg
(paren
id|pci_resource_flags
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|IORESOURCE_MEM
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;(rcpci45 driver:) No PCI mem resources! Aborting&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err_out_free_dev
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * pDpa-&gt;msgbuf is where the card will dma the I2O &n;&t; * messages. Thus, we need contiguous physical pages of memory.&n;&t; * 2003/04/20:  pci_alloc_consistent() provides well over the needed&n;&t; * alignment on a 256 bytes boundary for the LAN API private area.&n;&t; * Thus it isn&squot;t needed anymore to align it by hand.&n;         */
id|pDpa-&gt;msgbuf
op_assign
id|pci_alloc_consistent
(paren
id|pdev
comma
id|MSG_BUF_SIZE
comma
op_amp
id|pDpa-&gt;msgbuf_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDpa-&gt;msgbuf
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;(rcpci45 driver:) &bslash;&n;&t;&t;&t;Could not allocate %d byte memory for the &bslash;&n;&t;&t;&t;&t;private msgbuf!&bslash;n&quot;
comma
id|MSG_BUF_SIZE
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_free_dev
suffix:semicolon
)brace
multiline_comment|/* The adapter is accessible through memory-access read/write, not&n;&t; * I/O read/write.  Thus, we need to map it to some virtual address&n;&t; * area in order to access the registers as normal memory.&n;&t; */
id|error
op_assign
id|pci_request_regions
(paren
id|pdev
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|err_out_free_msgbuf
suffix:semicolon
id|error
op_assign
id|pci_set_dma_mask
(paren
id|pdev
comma
id|RCPCI45_DMA_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;(rcpci45 driver:) pci_set_dma_mask failed!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_free_region
suffix:semicolon
)brace
id|vaddr
op_assign
(paren
id|ulong
op_star
)paren
id|ioremap
(paren
id|pci_start
comma
id|pci_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vaddr
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;(rcpci45 driver:) &bslash;&n;&t;&t;&t;Unable to remap address range from %lu to %lu&bslash;n&quot;
comma
id|pci_start
comma
id|pci_start
op_plus
id|pci_len
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_out_free_region
suffix:semicolon
)brace
id|dev-&gt;base_addr
op_assign
(paren
r_int
r_int
)paren
id|vaddr
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dev-&gt;open
op_assign
op_amp
id|RCopen
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
op_amp
id|RC_xmit_packet
suffix:semicolon
id|dev-&gt;stop
op_assign
op_amp
id|RCclose
suffix:semicolon
id|dev-&gt;get_stats
op_assign
op_amp
id|RCget_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
op_amp
id|RCioctl
suffix:semicolon
id|dev-&gt;set_config
op_assign
op_amp
id|RCconfig
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* success */
id|err_out_free_region
suffix:colon
id|pci_release_regions
(paren
id|pdev
)paren
suffix:semicolon
id|err_out_free_msgbuf
suffix:colon
id|pci_free_consistent
(paren
id|pdev
comma
id|MSG_BUF_SIZE
comma
id|pDpa-&gt;msgbuf
comma
id|pDpa-&gt;msgbuf_dma
)paren
suffix:semicolon
id|err_out_free_dev
suffix:colon
id|unregister_netdev
(paren
id|dev
)paren
suffix:semicolon
id|kfree
(paren
id|dev
)paren
suffix:semicolon
id|err_out
suffix:colon
id|card_idx
op_decrement
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|variable|rcpci45_driver
r_static
r_struct
id|pci_driver
id|rcpci45_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;rcpci45&quot;
comma
dot
id|id_table
op_assign
id|rcpci45_pci_table
comma
dot
id|probe
op_assign
id|rcpci45_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|rcpci45_remove_one
)paren
comma
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|rcpci_init_module
id|rcpci_init_module
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
id|pci_module_init
(paren
op_amp
id|rcpci45_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|RCopen
id|RCopen
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|post_buffers
op_assign
id|MAX_NMBR_RCV_BUFFERS
suffix:semicolon
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|requested
op_assign
l_int|0
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|pDpa-&gt;nexus
)paren
(brace
multiline_comment|/* This is not the first time RCopen is called.  Thus,&n;&t;&t; * the interface was previously opened and later closed&n;&t;&t; * by RCclose().  RCclose() does a Shutdown; to wake up&n;&t;&t; * the adapter, a reset is mandatory before we can post&n;&t;&t; * receive buffers.  However, if the adapter initiated &n;&t;&t; * a reboot while the interface was closed -- and interrupts&n;&t;&t; * were turned off -- we need will need to reinitialize&n;&t;&t; * the adapter, rather than simply waking it up.  &n;&t;&t; */
id|printk
(paren
id|KERN_INFO
l_string|&quot;Waking up adapter...&bslash;n&quot;
)paren
suffix:semicolon
id|RCResetLANCard
(paren
id|dev
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|pDpa-&gt;nexus
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* &n;&t;&t; * RCInitI2OMsgLayer is done only once, unless the&n;&t;&t; * adapter was sent a warm reboot&n;&t;&t; */
id|error
op_assign
id|RCInitI2OMsgLayer
(paren
id|dev
comma
(paren
id|PFNTXCALLBACK
)paren
id|RCxmit_callback
comma
(paren
id|PFNRXCALLBACK
)paren
id|RCrecv_callback
comma
(paren
id|PFNCALLBACK
)paren
id|RCreboot_callback
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to init msg layer (%x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|error
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|RCGetMAC
(paren
id|dev
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: Unable to get adapter MAC&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
)brace
multiline_comment|/* Request a shared interrupt line. */
id|error
op_assign
id|request_irq
(paren
id|dev-&gt;irq
comma
id|RCinterrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: unable to get IRQ %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|DriverControlWord
op_or_assign
id|WARM_REBOOT_CAPABLE
suffix:semicolon
id|RCReportDriverCapability
(paren
id|dev
comma
id|DriverControlWord
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: RedCreek Communications IPSEC VPN adapter&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|RCEnableI2OInterrupts
(paren
id|dev
)paren
suffix:semicolon
r_while
c_loop
(paren
id|post_buffers
)paren
(brace
r_if
c_cond
(paren
id|post_buffers
OG
id|MAX_NMBR_POST_BUFFERS_PER_MSG
)paren
id|requested
op_assign
id|MAX_NMBR_POST_BUFFERS_PER_MSG
suffix:semicolon
r_else
id|requested
op_assign
id|post_buffers
suffix:semicolon
id|count
op_assign
id|RC_allocate_and_post_buffers
(paren
id|dev
comma
id|requested
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|requested
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Check to see if we were able to post &n;&t;&t;&t; * any buffers at all.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|post_buffers
op_eq
id|MAX_NMBR_RCV_BUFFERS
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: &bslash;&n;&t;&t;&t;&t;&t;unable to allocate any buffers&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|err_out_free_irq
suffix:semicolon
)brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: &bslash;&n;&t;&t;&t;unable to allocate all requested buffers&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* we&squot;ll try to post more buffers later */
)brace
r_else
id|post_buffers
op_sub_assign
id|count
suffix:semicolon
)brace
id|pDpa-&gt;numOutRcvBuffers
op_assign
id|MAX_NMBR_RCV_BUFFERS
op_minus
id|post_buffers
suffix:semicolon
id|pDpa-&gt;shutdown
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* just in case */
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_free_irq
suffix:colon
id|free_irq
(paren
id|dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|RC_xmit_packet
id|RC_xmit_packet
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
id|singleTCB
id|tcb
suffix:semicolon
id|psingleTCB
id|ptcb
op_assign
op_amp
id|tcb
suffix:semicolon
id|RC_RETURN
id|status
op_assign
l_int|0
suffix:semicolon
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDpa-&gt;shutdown
op_logical_or
id|pDpa-&gt;reboot
)paren
(brace
id|printk
(paren
l_string|&quot;RC_xmit_packet: tbusy!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The user is free to reuse the TCB after RCI2OSendPacket() &n;&t; * returns, since the function copies the necessary info into its &n;&t; * own private space.  Thus, our TCB can be a local structure.  &n;&t; * The skb, on the other hand, will be freed up in our interrupt &n;&t; * handler.&n;&t; */
id|ptcb-&gt;bcount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* &n;&t; * we&squot;ll get the context when the adapter interrupts us to tell us that&n;&t; * the transmission is done. At that time, we can free skb.&n;&t; */
id|ptcb-&gt;b.context
op_assign
(paren
id|U32
)paren
id|skb
suffix:semicolon
id|ptcb-&gt;b.scount
op_assign
l_int|1
suffix:semicolon
id|ptcb-&gt;b.size
op_assign
id|skb-&gt;len
suffix:semicolon
id|ptcb-&gt;b.addr
op_assign
id|pci_map_single
c_func
(paren
id|pDpa-&gt;pci_dev
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|RCI2OSendPacket
(paren
id|dev
comma
(paren
id|U32
)paren
l_int|NULL
comma
(paren
id|PRCTCB
)paren
id|ptcb
)paren
)paren
op_ne
id|RC_RTN_NO_ERROR
)paren
(brace
id|printk
(paren
l_string|&quot;%s: send error 0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|uint
)paren
id|status
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * That&squot;s it!&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * RCxmit_callback()&n; *&n; * The transmit callback routine. It&squot;s called by RCProcI2OMsgQ()&n; * because the adapter is done with one or more transmit buffers and&n; * it&squot;s returning them to us, or we asked the adapter to return the&n; * outstanding transmit buffers by calling RCResetLANCard() with &n; * RC_RESOURCE_RETURN_PEND_TX_BUFFERS flag. &n; * All we need to do is free the buffers.&n; */
r_static
r_void
DECL|function|RCxmit_callback
id|RCxmit_callback
(paren
id|U32
id|Status
comma
id|U16
id|PcktCount
comma
id|PU32
id|BufferContext
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDpa
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: Fatal Error in xmit callback, !pDpa&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Status
op_ne
id|I2O_REPLY_STATUS_SUCCESS
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: xmit_callback: Status = 0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|uint
)paren
id|Status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDpa-&gt;shutdown
op_logical_or
id|pDpa-&gt;reboot
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: xmit callback: shutdown||reboot&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_while
c_loop
(paren
id|PcktCount
op_decrement
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
(paren
id|BufferContext
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|BufferContext
op_increment
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|pDpa-&gt;pci_dev
comma
id|BufferContext
(braket
l_int|1
)braket
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
(paren
id|skb
)paren
suffix:semicolon
)brace
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|RCreset_callback
id|RCreset_callback
(paren
id|U32
id|Status
comma
id|U32
id|p1
comma
id|U32
id|p2
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
(paren
l_string|&quot;RCreset_callback Status 0x%x&bslash;n&quot;
comma
(paren
id|uint
)paren
id|Status
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check to see why we were called.&n;&t; */
r_if
c_cond
(paren
id|pDpa-&gt;shutdown
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: shutting down interface&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|pDpa-&gt;shutdown
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;reboot
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pDpa-&gt;reboot
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: reboot, shutdown adapter&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We don&squot;t set any of the flags in RCShutdownLANCard()&n;&t;&t; * and we don&squot;t pass a callback routine to it.&n;&t;&t; * The adapter will have already initiated the reboot by&n;&t;&t; * the time the function returns.&n;&t;&t; */
id|RCDisableI2OInterrupts
(paren
id|dev
)paren
suffix:semicolon
id|RCShutdownLANCard
(paren
id|dev
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: scheduling timer...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|init_timer
(paren
op_amp
id|pDpa-&gt;timer
)paren
suffix:semicolon
id|pDpa-&gt;timer.expires
op_assign
id|RUN_AT
(paren
(paren
l_int|40
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 4 sec. */
id|pDpa-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|pDpa-&gt;timer.function
op_assign
op_amp
id|rc_timer
suffix:semicolon
multiline_comment|/* timer handler */
id|add_timer
(paren
op_amp
id|pDpa-&gt;timer
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|RCreboot_callback
id|RCreboot_callback
(paren
id|U32
id|Status
comma
id|U32
id|p1
comma
id|U32
id|p2
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: reboot: rcv buffers outstanding = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|uint
)paren
id|pDpa-&gt;numOutRcvBuffers
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDpa-&gt;shutdown
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: skip reboot, shutdown initiated&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pDpa-&gt;reboot
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * OK, we reset the adapter and ask it to return all&n;&t; * outstanding transmit buffers as well as the posted&n;&t; * receive buffers.  When the adapter is done returning&n;&t; * those buffers, it will call our RCreset_callback() &n;&t; * routine.  In that routine, we&squot;ll call RCShutdownLANCard()&n;&t; * to tell the adapter that it&squot;s OK to start the reboot and&n;&t; * schedule a timer callback routine to execute 3 seconds &n;&t; * later; this routine will reinitialize the adapter at that time.&n;&t; */
id|RCResetLANCard
(paren
id|dev
comma
id|RC_RESOURCE_RETURN_POSTED_RX_BUCKETS
op_or
id|RC_RESOURCE_RETURN_PEND_TX_BUFFERS
comma
l_int|0
comma
(paren
id|PFNCALLBACK
)paren
id|RCreset_callback
)paren
suffix:semicolon
)brace
r_int
DECL|function|broadcast_packet
id|broadcast_packet
(paren
r_int
r_char
op_star
id|address
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|address
(braket
id|i
)braket
op_ne
l_int|0xff
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * RCrecv_callback()&n; * &n; * The receive packet callback routine.  This is called by&n; * RCProcI2OMsgQ() after the adapter posts buffers which have been&n; * filled (one ethernet packet per buffer).&n; */
r_static
r_void
DECL|function|RCrecv_callback
id|RCrecv_callback
(paren
id|U32
id|Status
comma
id|U8
id|PktCount
comma
id|U32
id|BucketsRemain
comma
id|PU32
id|PacketDescBlock
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|U32
id|len
comma
id|count
suffix:semicolon
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|singleTCB
id|tcb
suffix:semicolon
id|psingleTCB
id|ptcb
op_assign
op_amp
id|tcb
suffix:semicolon
id|ptcb-&gt;bcount
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pDpa-&gt;shutdown
op_logical_or
id|pDpa-&gt;reboot
)paren
op_logical_and
op_logical_neg
id|Status
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: shutdown||reboot &amp;&amp; !Status (%d)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|PktCount
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Status
op_ne
id|I2O_REPLY_STATUS_SUCCESS
)paren
op_logical_or
id|pDpa-&gt;shutdown
)paren
(brace
multiline_comment|/*&n;&t;&t; * Free whatever buffers the adapter returned, but don&squot;t&n;&t;&t; * pass them to the kernel.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|pDpa-&gt;shutdown
op_logical_and
op_logical_neg
id|pDpa-&gt;reboot
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: recv error status = 0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|uint
)paren
id|Status
)paren
suffix:semicolon
r_else
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: Returning %d buffs stat 0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|PktCount
comma
(paren
id|uint
)paren
id|Status
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * TO DO: check the nature of the failure and put the &n;&t;&t; * adapter in failed mode if it&squot;s a hard failure.  &n;&t;&t; * Send a reset to the adapter and free all outstanding memory.&n;&t;&t; */
r_if
c_cond
(paren
id|PacketDescBlock
)paren
(brace
r_while
c_loop
(paren
id|PktCount
op_decrement
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|PacketDescBlock
(braket
l_int|0
)braket
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
id|pDpa-&gt;numOutRcvBuffers
op_decrement
suffix:semicolon
multiline_comment|/* point to next context field */
id|PacketDescBlock
op_add_assign
id|BD_SIZE
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|PktCount
op_decrement
)paren
(brace
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|PacketDescBlock
(braket
l_int|0
)braket
suffix:semicolon
id|len
op_assign
id|PacketDescBlock
(braket
l_int|2
)braket
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* adjust length and tail */
id|skb-&gt;protocol
op_assign
id|eth_type_trans
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|netif_rx
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* send the packet to the kernel */
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|pDpa-&gt;numOutRcvBuffers
op_decrement
suffix:semicolon
multiline_comment|/* point to next context field */
id|PacketDescBlock
op_add_assign
id|BD_SIZE
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Replenish the posted receive buffers. &n;&t; * DO NOT replenish buffers if the driver has already&n;&t; * initiated a reboot or shutdown!&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|pDpa-&gt;shutdown
op_logical_and
op_logical_neg
id|pDpa-&gt;reboot
)paren
(brace
id|count
op_assign
id|RC_allocate_and_post_buffers
(paren
id|dev
comma
id|MAX_NMBR_RCV_BUFFERS
op_minus
id|pDpa-&gt;numOutRcvBuffers
)paren
suffix:semicolon
id|pDpa-&gt;numOutRcvBuffers
op_add_assign
id|count
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * RCinterrupt()&n; * &n; * Interrupt handler. &n; * This routine sets up a couple of pointers and calls&n; * RCProcI2OMsgQ(), which in turn process the message and&n; * calls one of our callback functions.&n; */
r_static
id|irqreturn_t
DECL|function|RCinterrupt
id|RCinterrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|PDPA
id|pDpa
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|pDpa-&gt;shutdown
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: shutdown, service irq&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
id|RCProcI2OMsgQ
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|macro|REBOOT_REINIT_RETRY_LIMIT
mdefine_line|#define REBOOT_REINIT_RETRY_LIMIT 4
r_static
r_void
DECL|function|rc_timer
id|rc_timer
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|init_status
suffix:semicolon
r_static
r_int
id|retry
suffix:semicolon
r_int
id|post_buffers
op_assign
id|MAX_NMBR_RCV_BUFFERS
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|requested
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pDpa-&gt;reboot
)paren
(brace
id|init_status
op_assign
id|RCInitI2OMsgLayer
(paren
id|dev
comma
(paren
id|PFNTXCALLBACK
)paren
id|RCxmit_callback
comma
(paren
id|PFNRXCALLBACK
)paren
id|RCrecv_callback
comma
(paren
id|PFNCALLBACK
)paren
id|RCreboot_callback
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|init_status
)paren
(brace
r_case
id|RC_RTN_NO_ERROR
suffix:colon
id|pDpa-&gt;reboot
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;shutdown
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* just in case */
id|RCReportDriverCapability
(paren
id|dev
comma
id|DriverControlWord
)paren
suffix:semicolon
id|RCEnableI2OInterrupts
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
id|retry
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|post_buffers
)paren
(brace
r_if
c_cond
(paren
id|post_buffers
OG
id|MAX_NMBR_POST_BUFFERS_PER_MSG
)paren
id|requested
op_assign
id|MAX_NMBR_POST_BUFFERS_PER_MSG
suffix:semicolon
r_else
id|requested
op_assign
id|post_buffers
suffix:semicolon
id|count
op_assign
id|RC_allocate_and_post_buffers
(paren
id|dev
comma
id|requested
)paren
suffix:semicolon
id|post_buffers
op_sub_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|requested
)paren
r_break
suffix:semicolon
)brace
id|pDpa-&gt;numOutRcvBuffers
op_assign
id|MAX_NMBR_RCV_BUFFERS
op_minus
id|post_buffers
suffix:semicolon
id|printk
(paren
l_string|&quot;Initialization done.&bslash;n&quot;
)paren
suffix:semicolon
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
id|retry
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
r_case
id|RC_RTN_FREE_Q_EMPTY
suffix:colon
id|retry
op_increment
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s inbound free q empty&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retry
op_increment
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s bad stat after reboot: %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|init_status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retry
OG
id|REBOOT_REINIT_RETRY_LIMIT
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s unable to reinitialize adapter after reboot&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s decrementing driver and closing interface&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|RCDisableI2OInterrupts
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_UP
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
multiline_comment|/* FIXME: kill MOD_DEC_USE_COUNT, use dev_put */
)brace
r_else
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s: rescheduling timer...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|init_timer
(paren
op_amp
id|pDpa-&gt;timer
)paren
suffix:semicolon
id|pDpa-&gt;timer.expires
op_assign
id|RUN_AT
(paren
(paren
l_int|40
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
id|pDpa-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|pDpa-&gt;timer.function
op_assign
op_amp
id|rc_timer
suffix:semicolon
id|add_timer
(paren
op_amp
id|pDpa-&gt;timer
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: unexpected timer irq&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|RCclose
id|RCclose
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RCclose&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pDpa-&gt;reboot
)paren
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;%s skipping reset -- adapter already in reboot mode&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_UP
suffix:semicolon
id|pDpa-&gt;shutdown
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pDpa-&gt;shutdown
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * We can&squot;t allow the driver to be unloaded until the adapter returns&n;&t; * all posted receive buffers.  It doesn&squot;t hurt to tell the adapter&n;&t; * to return all posted receive buffers and outstanding xmit buffers,&n;&t; * even if there are none.&n;&t; */
id|RCShutdownLANCard
(paren
id|dev
comma
id|RC_RESOURCE_RETURN_POSTED_RX_BUCKETS
op_or
id|RC_RESOURCE_RETURN_PEND_TX_BUFFERS
comma
l_int|0
comma
(paren
id|PFNCALLBACK
)paren
id|RCreset_callback
)paren
suffix:semicolon
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_UP
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|net_device_stats
op_star
DECL|function|RCget_stats
id|RCget_stats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|RCLINKSTATS
id|RCstats
suffix:semicolon
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pDpa
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|memset
(paren
op_amp
id|RCstats
comma
l_int|0
comma
r_sizeof
(paren
id|RCLINKSTATS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|RCGetLinkStatistics
(paren
id|dev
comma
op_amp
id|RCstats
comma
(paren
r_void
op_star
)paren
l_int|0
)paren
)paren
op_eq
id|RC_RTN_NO_ERROR
)paren
(brace
multiline_comment|/* total packets received    */
id|pDpa-&gt;stats.rx_packets
op_assign
id|RCstats.Rcv_good
multiline_comment|/* total packets transmitted    */
suffix:semicolon
id|pDpa-&gt;stats.tx_packets
op_assign
id|RCstats.TX_good
suffix:semicolon
id|pDpa-&gt;stats.rx_errors
op_assign
id|RCstats.Rcv_CRCerr
op_plus
id|RCstats.Rcv_alignerr
op_plus
id|RCstats.Rcv_reserr
op_plus
id|RCstats.Rcv_orun
op_plus
id|RCstats.Rcv_cdt
op_plus
id|RCstats.Rcv_runt
suffix:semicolon
id|pDpa-&gt;stats.tx_errors
op_assign
id|RCstats.TX_urun
op_plus
id|RCstats.TX_crs
op_plus
id|RCstats.TX_def
op_plus
id|RCstats.TX_totcol
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This needs improvement.&n;&t;&t; */
id|pDpa-&gt;stats.rx_dropped
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no space in linux buffers   */
id|pDpa-&gt;stats.tx_dropped
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no space available in linux */
id|pDpa-&gt;stats.multicast
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* multicast packets received  */
id|pDpa-&gt;stats.collisions
op_assign
id|RCstats.TX_totcol
suffix:semicolon
multiline_comment|/* detailed rx_errors: */
id|pDpa-&gt;stats.rx_length_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.rx_over_errors
op_assign
id|RCstats.Rcv_orun
suffix:semicolon
id|pDpa-&gt;stats.rx_crc_errors
op_assign
id|RCstats.Rcv_CRCerr
suffix:semicolon
id|pDpa-&gt;stats.rx_frame_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.rx_fifo_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.rx_missed_errors
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* detailed tx_errors */
id|pDpa-&gt;stats.tx_aborted_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.tx_carrier_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.tx_fifo_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.tx_heartbeat_errors
op_assign
l_int|0
suffix:semicolon
id|pDpa-&gt;stats.tx_window_errors
op_assign
l_int|0
suffix:semicolon
r_return
(paren
(paren
r_struct
id|net_device_stats
op_star
)paren
op_amp
(paren
id|pDpa-&gt;stats
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|RCioctl
id|RCioctl
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
id|RCuser_struct
id|RCuser
suffix:semicolon
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RCU_PROTOCOL_REV
suffix:colon
multiline_comment|/*&n;&t;&t; * Assign user protocol revision, to tell user-level&n;&t;&t; * controller program whether or not it&squot;s in sync.&n;&t;&t; */
id|rq-&gt;ifr_ifru.ifru_data
op_assign
(paren
id|caddr_t
)paren
id|USER_PROTOCOL_REV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCU_COMMAND
suffix:colon
(brace
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|RCuser
comma
id|rq-&gt;ifr_data
comma
r_sizeof
(paren
id|RCuser
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|dprintk
(paren
l_string|&quot;RCioctl: RCuser_cmd = 0x%x&bslash;n&quot;
comma
id|RCuser.cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|RCuser.cmd
)paren
(brace
r_case
id|RCUC_GETFWVER
suffix:colon
id|RCUD_GETFWVER
op_assign
op_amp
id|RCuser.RCUS_GETFWVER
suffix:semicolon
id|RCGetFirmwareVer
(paren
id|dev
comma
(paren
id|PU8
)paren
op_amp
id|RCUD_GETFWVER
op_member_access_from_pointer
id|FirmString
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETINFO
suffix:colon
id|RCUD_GETINFO
op_assign
op_amp
id|RCuser.RCUS_GETINFO
suffix:semicolon
id|RCUD_GETINFO-&gt;mem_start
op_assign
id|dev-&gt;base_addr
suffix:semicolon
id|RCUD_GETINFO-&gt;mem_end
op_assign
id|dev-&gt;base_addr
op_plus
id|pDpa-&gt;pci_addr_len
suffix:semicolon
id|RCUD_GETINFO-&gt;base_addr
op_assign
id|pDpa-&gt;pci_addr
suffix:semicolon
id|RCUD_GETINFO-&gt;irq
op_assign
id|dev-&gt;irq
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETIPANDMASK
suffix:colon
id|RCUD_GETIPANDMASK
op_assign
op_amp
id|RCuser.RCUS_GETIPANDMASK
suffix:semicolon
id|RCGetRavlinIPandMask
(paren
id|dev
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETIPANDMASK-&gt;IpAddr
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETIPANDMASK
op_member_access_from_pointer
id|NetMask
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETLINKSTATISTICS
suffix:colon
id|RCUD_GETLINKSTATISTICS
op_assign
op_amp
id|RCuser.RCUS_GETLINKSTATISTICS
suffix:semicolon
id|RCGetLinkStatistics
(paren
id|dev
comma
(paren
id|P_RCLINKSTATS
)paren
op_amp
id|RCUD_GETLINKSTATISTICS
op_member_access_from_pointer
id|StatsReturn
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETLINKSTATUS
suffix:colon
id|RCUD_GETLINKSTATUS
op_assign
op_amp
id|RCuser.RCUS_GETLINKSTATUS
suffix:semicolon
id|RCGetLinkStatus
(paren
id|dev
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETLINKSTATUS
op_member_access_from_pointer
id|ReturnStatus
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETMAC
suffix:colon
id|RCUD_GETMAC
op_assign
op_amp
id|RCuser.RCUS_GETMAC
suffix:semicolon
id|RCGetMAC
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|RCUD_GETMAC
comma
id|dev-&gt;dev_addr
comma
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETPROM
suffix:colon
id|RCUD_GETPROM
op_assign
op_amp
id|RCuser.RCUS_GETPROM
suffix:semicolon
id|RCGetPromiscuousMode
(paren
id|dev
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETPROM
op_member_access_from_pointer
id|PromMode
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETBROADCAST
suffix:colon
id|RCUD_GETBROADCAST
op_assign
op_amp
id|RCuser.RCUS_GETBROADCAST
suffix:semicolon
id|RCGetBroadcastMode
(paren
id|dev
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETBROADCAST
op_member_access_from_pointer
id|BroadcastMode
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_GETSPEED
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
(brace
r_return
op_minus
id|ENODATA
suffix:semicolon
)brace
id|RCUD_GETSPEED
op_assign
op_amp
id|RCuser.RCUS_GETSPEED
suffix:semicolon
id|RCGetLinkSpeed
(paren
id|dev
comma
(paren
id|PU32
)paren
op_amp
id|RCUD_GETSPEED
op_member_access_from_pointer
id|LinkSpeedCode
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_SETIPANDMASK
suffix:colon
id|RCUD_SETIPANDMASK
op_assign
op_amp
id|RCuser.RCUS_SETIPANDMASK
suffix:semicolon
id|RCSetRavlinIPandMask
(paren
id|dev
comma
(paren
id|U32
)paren
id|RCUD_SETIPANDMASK
op_member_access_from_pointer
id|IpAddr
comma
(paren
id|U32
)paren
id|RCUD_SETIPANDMASK
op_member_access_from_pointer
id|NetMask
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_SETMAC
suffix:colon
id|RCSetMAC
(paren
id|dev
comma
(paren
id|PU8
)paren
op_amp
id|RCUD_SETMAC-&gt;mac
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_SETSPEED
suffix:colon
id|RCUD_SETSPEED
op_assign
op_amp
id|RCuser.RCUS_SETSPEED
suffix:semicolon
id|RCSetLinkSpeed
(paren
id|dev
comma
(paren
id|U16
)paren
id|RCUD_SETSPEED
op_member_access_from_pointer
id|LinkSpeedCode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_SETPROM
suffix:colon
id|RCUD_SETPROM
op_assign
op_amp
id|RCuser.RCUS_SETPROM
suffix:semicolon
id|RCSetPromiscuousMode
(paren
id|dev
comma
(paren
id|U16
)paren
id|RCUD_SETPROM
op_member_access_from_pointer
id|PromMode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RCUC_SETBROADCAST
suffix:colon
id|RCUD_SETBROADCAST
op_assign
op_amp
id|RCuser.RCUS_SETBROADCAST
suffix:semicolon
id|RCSetBroadcastMode
(paren
id|dev
comma
(paren
id|U16
)paren
id|RCUD_SETBROADCAST
op_member_access_from_pointer
id|BroadcastMode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|RCUD_DEFAULT
op_assign
op_amp
id|RCuser.RCUS_DEFAULT
suffix:semicolon
id|RCUD_DEFAULT-&gt;rc
op_assign
l_int|0x11223344
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
(paren
id|rq-&gt;ifr_data
comma
op_amp
id|RCuser
comma
r_sizeof
(paren
id|RCuser
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* RCU_COMMAND */
r_default
suffix:colon
id|rq-&gt;ifr_ifru.ifru_data
op_assign
(paren
id|caddr_t
)paren
l_int|0x12345678
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|RCconfig
id|RCconfig
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifmap
op_star
id|map
)paren
(brace
multiline_comment|/*&n;&t; * To be completed ...&n;&t; */
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
multiline_comment|/* can&squot;t act on a running interface */
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Don&squot;t allow changing the I/O address */
r_if
c_cond
(paren
id|map-&gt;base_addr
op_ne
id|dev-&gt;base_addr
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s Change I/O address not implemented&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|rcpci_cleanup_module
id|rcpci_cleanup_module
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|rcpci45_driver
)paren
suffix:semicolon
)brace
DECL|variable|rcpci_init_module
id|module_init
(paren
id|rcpci_init_module
)paren
suffix:semicolon
DECL|variable|rcpci_cleanup_module
id|module_exit
(paren
id|rcpci_cleanup_module
)paren
suffix:semicolon
r_static
r_int
DECL|function|RC_allocate_and_post_buffers
id|RC_allocate_and_post_buffers
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|numBuffers
)paren
(brace
r_int
id|i
suffix:semicolon
id|PU32
id|p
suffix:semicolon
id|psingleB
id|pB
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|PDPA
id|pDpa
op_assign
id|dev-&gt;priv
suffix:semicolon
id|RC_RETURN
id|status
suffix:semicolon
id|U32
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|numBuffers
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|numBuffers
OG
id|MAX_NMBR_POST_BUFFERS_PER_MSG
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;%s: Too many buffers requested!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|numBuffers
op_assign
l_int|32
suffix:semicolon
)brace
id|p
op_assign
(paren
id|PU32
)paren
id|kmalloc
(paren
r_sizeof
(paren
id|U32
)paren
op_plus
id|numBuffers
op_star
r_sizeof
(paren
id|singleB
)paren
comma
id|GFP_DMA
op_or
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s unable to allocate TCB&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|p
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Buffer Count */
id|pB
op_assign
(paren
id|psingleB
)paren
(paren
(paren
id|U32
)paren
id|p
op_plus
r_sizeof
(paren
id|U32
)paren
)paren
suffix:semicolon
multiline_comment|/* point to the first buffer */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numBuffers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
(paren
id|MAX_ETHER_SIZE
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: unable to allocate enough skbs!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|err_out_unmap
suffix:semicolon
)brace
id|skb_reserve
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Align IP on 16 byte boundaries */
id|pB-&gt;context
op_assign
(paren
id|U32
)paren
id|skb
suffix:semicolon
id|pB-&gt;scount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* segment count */
id|pB-&gt;size
op_assign
id|MAX_ETHER_SIZE
suffix:semicolon
id|pB-&gt;addr
op_assign
id|pci_map_single
c_func
(paren
id|pDpa-&gt;pci_dev
comma
id|skb-&gt;data
comma
id|MAX_ETHER_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|p
(braket
l_int|0
)braket
op_increment
suffix:semicolon
id|pB
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_assign
id|RCPostRecvBuffers
(paren
id|dev
comma
(paren
id|PRCTCB
)paren
id|p
)paren
)paren
op_ne
id|RC_RTN_NO_ERROR
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: Post buffer failed, error 0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|status
)paren
suffix:semicolon
r_goto
id|err_out_unmap
suffix:semicolon
)brace
id|out_free
suffix:colon
id|res
op_assign
id|p
(braket
l_int|0
)braket
suffix:semicolon
id|kfree
(paren
id|p
)paren
suffix:semicolon
id|out
suffix:colon
r_return
(paren
id|res
)paren
suffix:semicolon
multiline_comment|/* return the number of posted buffers */
id|err_out_unmap
suffix:colon
r_for
c_loop
(paren
suffix:semicolon
id|p
(braket
l_int|0
)braket
OG
l_int|0
suffix:semicolon
id|p
(braket
l_int|0
)braket
op_decrement
)paren
(brace
op_decrement
id|pB
suffix:semicolon
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|pB-&gt;context
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|pDpa-&gt;pci_dev
comma
id|pB-&gt;addr
comma
id|MAX_ETHER_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
)brace
r_goto
id|out_free
suffix:semicolon
)brace
eof
