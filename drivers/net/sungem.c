multiline_comment|/* $Id: sungem.c,v 1.49 2002/01/23 15:40:45 davem Exp $&n; * sungem.c: Sun GEM ethernet driver.&n; *&n; * Copyright (C) 2000, 2001, 2002 David S. Miller (davem@redhat.com)&n; * &n; * Support for Apple GMAC and assorted PHYs by&n; * Benjamin Herrenscmidt (benh@kernel.crashing.org)&n; * &n; * TODO: &n; *  - Get rid of all those nasty mdelay&squot;s and replace them&n; * with schedule_timeout.&n; *  - Implement WOL&n; *  - Currently, forced Gb mode is only supported on bcm54xx&n; *    PHY for which I use the SPD2 bit of the control register.&n; *    On m1011 PHY, I can&squot;t force as I don&squot;t have the specs, but&n; *    I can at least detect gigabit with autoneg.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#ifdef __sparc__
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_ALL_PPC
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#endif
macro_line|#include &quot;sungem.h&quot;
DECL|macro|DEFAULT_MSG
mdefine_line|#define DEFAULT_MSG&t;(NETIF_MSG_DRV&t;&t;| &bslash;&n;&t;&t;&t; NETIF_MSG_PROBE&t;| &bslash;&n;&t;&t;&t; NETIF_MSG_LINK)
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME&t;&quot;sungem&quot;
DECL|macro|DRV_VERSION
mdefine_line|#define DRV_VERSION&t;&quot;0.97&quot;
DECL|macro|DRV_RELDATE
mdefine_line|#define DRV_RELDATE&t;&quot;3/20/02&quot;
DECL|macro|DRV_AUTHOR
mdefine_line|#define DRV_AUTHOR&t;&quot;David S. Miller (davem@redhat.com)&quot;
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
id|DRV_NAME
l_string|&quot;.c:v&quot;
id|DRV_VERSION
l_string|&quot; &quot;
id|DRV_RELDATE
l_string|&quot; &quot;
id|DRV_AUTHOR
l_string|&quot;&bslash;n&quot;
suffix:semicolon
DECL|variable|DRV_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRV_AUTHOR
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Sun GEM Gbit ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|gem_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|gem_debug
comma
l_string|&quot;bitmapped message enable number&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|link_mode
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|link_mode
comma
l_string|&quot;default link mode&quot;
)paren
suffix:semicolon
DECL|variable|gem_debug
r_int
id|gem_debug
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|link_mode
r_static
r_int
id|link_mode
suffix:semicolon
DECL|variable|__devinitdata
r_static
id|u16
id|link_modes
(braket
)braket
id|__devinitdata
op_assign
(brace
id|BMCR_ANENABLE
comma
multiline_comment|/* 0 : autoneg */
l_int|0
comma
multiline_comment|/* 1 : 10bt half duplex */
id|BMCR_SPEED100
comma
multiline_comment|/* 2 : 100bt half duplex */
id|BMCR_SPD2
comma
multiline_comment|/* bcm54xx only */
multiline_comment|/* 3 : 1000bt half duplex */
id|BMCR_FULLDPLX
comma
multiline_comment|/* 4 : 10bt full duplex */
id|BMCR_SPEED100
op_or
id|BMCR_FULLDPLX
comma
multiline_comment|/* 5 : 100bt full duplex */
id|BMCR_SPD2
op_or
id|BMCR_FULLDPLX
multiline_comment|/* 6 : 1000bt full duplex */
)brace
suffix:semicolon
DECL|macro|GEM_MODULE_NAME
mdefine_line|#define GEM_MODULE_NAME&t;&quot;gem&quot;
DECL|macro|PFX
mdefine_line|#define PFX GEM_MODULE_NAME &quot;: &quot;
multiline_comment|/* Until this gets merged from 2.4.x... */
macro_line|#ifndef PCI_DEVICE_ID_APPLE_UNI_N_GMACP
DECL|macro|PCI_DEVICE_ID_APPLE_UNI_N_GMACP
mdefine_line|#define PCI_DEVICE_ID_APPLE_UNI_N_GMACP 0x0024
macro_line|#endif
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|gem_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_SUN
comma
id|PCI_DEVICE_ID_SUN_GEM
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0UL
)brace
comma
multiline_comment|/* These models only differ from the original GEM in&n;&t; * that their tx/rx fifos are of a different size and&n;&t; * they only support 10/100 speeds. -DaveM&n;&t; * &n;&t; * Apple&squot;s GMAC does support gigabit on machines with&n;&t; * the BCM54xx PHYs. -BenH&n;&t; */
(brace
id|PCI_VENDOR_ID_SUN
comma
id|PCI_DEVICE_ID_SUN_RIO_GEM
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0UL
)brace
comma
(brace
id|PCI_VENDOR_ID_APPLE
comma
id|PCI_DEVICE_ID_APPLE_UNI_N_GMAC
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0UL
)brace
comma
(brace
id|PCI_VENDOR_ID_APPLE
comma
id|PCI_DEVICE_ID_APPLE_UNI_N_GMACP
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0UL
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|gem_pci_tbl
)paren
suffix:semicolon
DECL|function|__phy_read
r_static
id|u16
id|__phy_read
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
id|reg
comma
r_int
id|phy_addr
)paren
(brace
id|u32
id|cmd
suffix:semicolon
r_int
id|limit
op_assign
l_int|10000
suffix:semicolon
id|cmd
op_assign
(paren
l_int|1
op_lshift
l_int|30
)paren
suffix:semicolon
id|cmd
op_or_assign
(paren
l_int|2
op_lshift
l_int|28
)paren
suffix:semicolon
id|cmd
op_or_assign
(paren
id|phy_addr
op_lshift
l_int|23
)paren
op_amp
id|MIF_FRAME_PHYAD
suffix:semicolon
id|cmd
op_or_assign
(paren
id|reg
op_lshift
l_int|18
)paren
op_amp
id|MIF_FRAME_REGAD
suffix:semicolon
id|cmd
op_or_assign
(paren
id|MIF_FRAME_TAMSB
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cmd
comma
id|gp-&gt;regs
op_plus
id|MIF_FRAME
)paren
suffix:semicolon
r_while
c_loop
(paren
id|limit
op_decrement
)paren
(brace
id|cmd
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MIF_FRAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_amp
id|MIF_FRAME_TALSB
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|limit
)paren
id|cmd
op_assign
l_int|0xffff
suffix:semicolon
r_return
id|cmd
op_amp
id|MIF_FRAME_DATA
suffix:semicolon
)brace
DECL|function|phy_read
r_static
r_inline
id|u16
id|phy_read
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
id|reg
)paren
(brace
r_return
id|__phy_read
c_func
(paren
id|gp
comma
id|reg
comma
id|gp-&gt;mii_phy_addr
)paren
suffix:semicolon
)brace
DECL|function|__phy_write
r_static
r_void
id|__phy_write
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
id|reg
comma
id|u16
id|val
comma
r_int
id|phy_addr
)paren
(brace
id|u32
id|cmd
suffix:semicolon
r_int
id|limit
op_assign
l_int|10000
suffix:semicolon
id|cmd
op_assign
(paren
l_int|1
op_lshift
l_int|30
)paren
suffix:semicolon
id|cmd
op_or_assign
(paren
l_int|1
op_lshift
l_int|28
)paren
suffix:semicolon
id|cmd
op_or_assign
(paren
id|phy_addr
op_lshift
l_int|23
)paren
op_amp
id|MIF_FRAME_PHYAD
suffix:semicolon
id|cmd
op_or_assign
(paren
id|reg
op_lshift
l_int|18
)paren
op_amp
id|MIF_FRAME_REGAD
suffix:semicolon
id|cmd
op_or_assign
(paren
id|MIF_FRAME_TAMSB
)paren
suffix:semicolon
id|cmd
op_or_assign
(paren
id|val
op_amp
id|MIF_FRAME_DATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cmd
comma
id|gp-&gt;regs
op_plus
id|MIF_FRAME
)paren
suffix:semicolon
r_while
c_loop
(paren
id|limit
op_decrement
)paren
(brace
id|cmd
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MIF_FRAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_amp
id|MIF_FRAME_TALSB
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
DECL|function|phy_write
r_static
r_inline
r_void
id|phy_write
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
id|reg
comma
id|u16
id|val
)paren
(brace
id|__phy_write
c_func
(paren
id|gp
comma
id|reg
comma
id|val
comma
id|gp-&gt;mii_phy_addr
)paren
suffix:semicolon
)brace
DECL|function|gem_handle_mif_event
r_static
r_void
id|gem_handle_mif_event
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|reg_val
comma
id|u32
id|changed_bits
)paren
(brace
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: mif interrupt&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
DECL|function|gem_pcs_interrupt
r_static
r_int
id|gem_pcs_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|pcs_istat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_ISTAT
)paren
suffix:semicolon
id|u32
id|pcs_miistat
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: pcs interrupt, pcs_istat: 0x%x&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
comma
id|pcs_istat
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pcs_istat
op_amp
id|PCS_ISTAT_LSC
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCS irq but no link status change???&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The link status bit latches on zero, so you must&n;&t; * read it twice in such a case to see a transition&n;&t; * to the link being up.&n;&t; */
id|pcs_miistat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIISTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pcs_miistat
op_amp
id|PCS_MIISTAT_LS
)paren
)paren
id|pcs_miistat
op_or_assign
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIISTAT
)paren
op_amp
id|PCS_MIISTAT_LS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcs_miistat
op_amp
id|PCS_MIISTAT_ANC
)paren
(brace
multiline_comment|/* The remote-fault indication is only valid&n;&t;&t; * when autoneg has completed.&n;&t;&t; */
r_if
c_cond
(paren
id|pcs_miistat
op_amp
id|PCS_MIISTAT_RF
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PCS AutoNEG complete, &quot;
l_string|&quot;RemoteFault&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PCS AutoNEG complete.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcs_miistat
op_amp
id|PCS_MIISTAT_LS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PCS link is now up.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PCS link is now down.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* If this happens and the link timer is not running,&n;&t;&t; * reset so we re-negotiate.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|gp-&gt;link_timer
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_txmac_interrupt
r_static
r_int
id|gem_txmac_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|txmac_stat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXSTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: txmac interrupt, txmac_stat: 0x%x&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
comma
id|txmac_stat
)paren
suffix:semicolon
multiline_comment|/* Defer timer expiration is quite normal,&n;&t; * don&squot;t even log the event.&n;&t; */
r_if
c_cond
(paren
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_DTE
)paren
op_logical_and
op_logical_neg
(paren
id|txmac_stat
op_amp
op_complement
id|MAC_TXSTAT_DTE
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_URUN
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: TX MAC xmit underrun.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|gp-&gt;net_stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_MPE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: TX MAC max packet size error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|gp-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* The rest are all cases of one of the 16-bit TX&n;&t; * counters expiring.&n;&t; */
r_if
c_cond
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_NCE
)paren
id|gp-&gt;net_stats.collisions
op_add_assign
l_int|0x10000
suffix:semicolon
r_if
c_cond
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_ECE
)paren
(brace
id|gp-&gt;net_stats.tx_aborted_errors
op_add_assign
l_int|0x10000
suffix:semicolon
id|gp-&gt;net_stats.collisions
op_add_assign
l_int|0x10000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_LCE
)paren
(brace
id|gp-&gt;net_stats.tx_aborted_errors
op_add_assign
l_int|0x10000
suffix:semicolon
id|gp-&gt;net_stats.collisions
op_add_assign
l_int|0x10000
suffix:semicolon
)brace
multiline_comment|/* We do not keep track of MAC_TXSTAT_FCE and&n;&t; * MAC_TXSTAT_PCE events.&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* When we get a RX fifo overflow, the RX unit in GEM is probably hung&n; * so we do the following.&n; *&n; * If any part of the reset goes wrong, we return 1 and that causes the&n; * whole chip to be reset.&n; */
DECL|function|gem_rxmac_reset
r_static
r_int
id|gem_rxmac_reset
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|gp-&gt;dev
suffix:semicolon
r_int
id|limit
comma
id|i
suffix:semicolon
id|u64
id|desc_dma
suffix:semicolon
id|u32
id|val
suffix:semicolon
multiline_comment|/* First, reset MAC RX. */
id|writel
c_func
(paren
id|gp-&gt;mac_rx_cfg
op_amp
op_complement
id|MAC_RXCFG_ENAB
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|limit
op_assign
l_int|0
suffix:semicolon
id|limit
OL
l_int|5000
suffix:semicolon
id|limit
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
op_amp
id|MAC_RXCFG_ENAB
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|limit
op_eq
l_int|5000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX MAC will not disable, resetting whole &quot;
l_string|&quot;chip.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Second, disable RX DMA. */
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|limit
op_assign
l_int|0
suffix:semicolon
id|limit
OL
l_int|5000
suffix:semicolon
id|limit
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
op_amp
id|RXDMA_CFG_ENABLE
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|limit
op_eq
l_int|5000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX DMA will not disable, resetting whole &quot;
l_string|&quot;chip.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|5000
)paren
suffix:semicolon
multiline_comment|/* Execute RX reset command. */
id|writel
c_func
(paren
id|gp-&gt;swrst_base
op_or
id|GREG_SWRST_RXRST
comma
id|gp-&gt;regs
op_plus
id|GREG_SWRST
)paren
suffix:semicolon
r_for
c_loop
(paren
id|limit
op_assign
l_int|0
suffix:semicolon
id|limit
OL
l_int|5000
suffix:semicolon
id|limit
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|GREG_SWRST
)paren
op_amp
id|GREG_SWRST_RXRST
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|limit
op_eq
l_int|5000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX reset command will not execute, resetting &quot;
l_string|&quot;whole chip.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Refresh the RX ring. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|gem_rxd
op_star
id|rxd
op_assign
op_amp
id|gp-&gt;init_block-&gt;rxd
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;rx_skbs
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Parts of RX ring empty, resetting &quot;
l_string|&quot;whole chip.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|rxd-&gt;status_word
op_assign
id|cpu_to_le64
c_func
(paren
id|RXDCTRL_FRESH
c_func
(paren
id|gp
)paren
)paren
suffix:semicolon
)brace
id|gp-&gt;rx_new
op_assign
id|gp-&gt;rx_old
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Now we must reprogram the rest of RX unit. */
id|desc_dma
op_assign
(paren
id|u64
)paren
id|gp-&gt;gblock_dvma
suffix:semicolon
id|desc_dma
op_add_assign
(paren
id|INIT_BLOCK_TX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|gem_txd
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|desc_dma
op_rshift
l_int|32
comma
id|gp-&gt;regs
op_plus
id|RXDMA_DBHI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|desc_dma
op_amp
l_int|0xffffffff
comma
id|gp-&gt;regs
op_plus
id|RXDMA_DBLOW
)paren
suffix:semicolon
id|writel
c_func
(paren
id|RX_RING_SIZE
op_minus
l_int|4
comma
id|gp-&gt;regs
op_plus
id|RXDMA_KICK
)paren
suffix:semicolon
id|val
op_assign
(paren
id|RXDMA_CFG_BASE
op_or
(paren
id|RX_OFFSET
op_lshift
l_int|10
)paren
op_or
(paren
(paren
l_int|14
op_div
l_int|2
)paren
op_lshift
l_int|13
)paren
op_or
id|RXDMA_CFG_FTHRESH_128
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|GREG_BIFCFG
)paren
op_amp
id|GREG_BIFCFG_M66EN
)paren
id|writel
c_func
(paren
(paren
(paren
l_int|5
op_amp
id|RXDMA_BLANK_IPKTS
)paren
op_or
(paren
(paren
l_int|8
op_lshift
l_int|12
)paren
op_amp
id|RXDMA_BLANK_ITIME
)paren
)paren
comma
id|gp-&gt;regs
op_plus
id|RXDMA_BLANK
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
(paren
(paren
l_int|5
op_amp
id|RXDMA_BLANK_IPKTS
)paren
op_or
(paren
(paren
l_int|4
op_lshift
l_int|12
)paren
op_amp
id|RXDMA_BLANK_ITIME
)paren
)paren
comma
id|gp-&gt;regs
op_plus
id|RXDMA_BLANK
)paren
suffix:semicolon
id|val
op_assign
(paren
(paren
(paren
id|gp-&gt;rx_pause_off
op_div
l_int|64
)paren
op_lshift
l_int|0
)paren
op_amp
id|RXDMA_PTHRESH_OFF
)paren
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
id|gp-&gt;rx_pause_on
op_div
l_int|64
)paren
op_lshift
l_int|12
)paren
op_amp
id|RXDMA_PTHRESH_ON
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|RXDMA_PTHRESH
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|RXDMA_CFG_ENABLE
comma
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MAC_RXSTAT_RCV
comma
id|gp-&gt;regs
op_plus
id|MAC_RXMASK
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|MAC_RXCFG_ENAB
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_rxmac_interrupt
r_static
r_int
id|gem_rxmac_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|rxmac_stat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXSTAT
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: rxmac interrupt, rxmac_stat: 0x%x&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
comma
id|rxmac_stat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rxmac_stat
op_amp
id|MAC_RXSTAT_OFLW
)paren
(brace
id|gp-&gt;net_stats.rx_over_errors
op_increment
suffix:semicolon
id|gp-&gt;net_stats.rx_fifo_errors
op_increment
suffix:semicolon
id|ret
op_assign
id|gem_rxmac_reset
c_func
(paren
id|gp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rxmac_stat
op_amp
id|MAC_RXSTAT_ACE
)paren
id|gp-&gt;net_stats.rx_frame_errors
op_add_assign
l_int|0x10000
suffix:semicolon
r_if
c_cond
(paren
id|rxmac_stat
op_amp
id|MAC_RXSTAT_CCE
)paren
id|gp-&gt;net_stats.rx_crc_errors
op_add_assign
l_int|0x10000
suffix:semicolon
r_if
c_cond
(paren
id|rxmac_stat
op_amp
id|MAC_RXSTAT_LCE
)paren
id|gp-&gt;net_stats.rx_length_errors
op_add_assign
l_int|0x10000
suffix:semicolon
multiline_comment|/* We do not track MAC_RXSTAT_FCE and MAC_RXSTAT_VCE&n;&t; * events.&n;&t; */
r_return
id|ret
suffix:semicolon
)brace
DECL|function|gem_mac_interrupt
r_static
r_int
id|gem_mac_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|mac_cstat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_CSTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: mac interrupt, mac_cstat: 0x%x&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
comma
id|mac_cstat
)paren
suffix:semicolon
multiline_comment|/* This interrupt is just for pause frame and pause&n;&t; * tracking.  It is useful for diagnostics and debug&n;&t; * but probably by default we will mask these events.&n;&t; */
r_if
c_cond
(paren
id|mac_cstat
op_amp
id|MAC_CSTAT_PS
)paren
id|gp-&gt;pause_entered
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mac_cstat
op_amp
id|MAC_CSTAT_PRCV
)paren
id|gp-&gt;pause_last_time_recvd
op_assign
(paren
id|mac_cstat
op_rshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_mif_interrupt
r_static
r_int
id|gem_mif_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|mif_status
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MIF_STATUS
)paren
suffix:semicolon
id|u32
id|reg_val
comma
id|changed_bits
suffix:semicolon
id|reg_val
op_assign
(paren
id|mif_status
op_amp
id|MIF_STATUS_DATA
)paren
op_rshift
l_int|16
suffix:semicolon
id|changed_bits
op_assign
(paren
id|mif_status
op_amp
id|MIF_STATUS_STAT
)paren
suffix:semicolon
id|gem_handle_mif_event
c_func
(paren
id|gp
comma
id|reg_val
comma
id|changed_bits
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_pci_interrupt
r_static
r_int
id|gem_pci_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|pci_estat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|GREG_PCIESTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_SUN
op_logical_and
id|gp-&gt;pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_GEM
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI error [%04x] &quot;
comma
id|dev-&gt;name
comma
id|pci_estat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_estat
op_amp
id|GREG_PCIESTAT_BADACK
)paren
id|printk
c_func
(paren
l_string|&quot;&lt;No ACK64# during ABS64 cycle&gt; &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_estat
op_amp
id|GREG_PCIESTAT_DTRTO
)paren
id|printk
c_func
(paren
l_string|&quot;&lt;Delayed transaction timeout&gt; &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_estat
op_amp
id|GREG_PCIESTAT_OTHER
)paren
id|printk
c_func
(paren
l_string|&quot;&lt;other&gt;&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|pci_estat
op_or_assign
id|GREG_PCIESTAT_OTHER
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_estat
op_amp
id|GREG_PCIESTAT_OTHER
)paren
(brace
id|u16
id|pci_cfg_stat
suffix:semicolon
multiline_comment|/* Interrogate PCI config space for the&n;&t;&t; * true cause.&n;&t;&t; */
id|pci_read_config_word
c_func
(paren
id|gp-&gt;pdev
comma
id|PCI_STATUS
comma
op_amp
id|pci_cfg_stat
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Read PCI cfg space status [%04x]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pci_cfg_stat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_PARITY
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI parity error detected.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_SIG_TARGET_ABORT
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI target abort.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_REC_TARGET_ABORT
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI master acks target abort.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_REC_MASTER_ABORT
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI master abort.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_SIG_SYSTEM_ERROR
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI system error SERR#.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_DETECTED_PARITY
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI parity error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Write the error bits back to clear them. */
id|pci_cfg_stat
op_and_assign
(paren
id|PCI_STATUS_PARITY
op_or
id|PCI_STATUS_SIG_TARGET_ABORT
op_or
id|PCI_STATUS_REC_TARGET_ABORT
op_or
id|PCI_STATUS_REC_MASTER_ABORT
op_or
id|PCI_STATUS_SIG_SYSTEM_ERROR
op_or
id|PCI_STATUS_DETECTED_PARITY
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|gp-&gt;pdev
comma
id|PCI_STATUS
comma
id|pci_cfg_stat
)paren
suffix:semicolon
)brace
multiline_comment|/* For all PCI errors, we should reset the chip. */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* All non-normal interrupt conditions get serviced here.&n; * Returns non-zero if we should just exit the interrupt&n; * handler right now (ie. if we reset the card which invalidates&n; * all of the other original irq status bits).&n; */
DECL|function|gem_abnormal_irq
r_static
r_int
id|gem_abnormal_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_RXNOBUF
)paren
(brace
multiline_comment|/* Frame arrived, no free RX buffers available. */
r_if
c_cond
(paren
id|netif_msg_rx_err
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: no buffer for rx frame&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|gp-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_RXTAGERR
)paren
(brace
multiline_comment|/* corrupt RX tag framing */
r_if
c_cond
(paren
id|netif_msg_rx_err
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: corrupt rx tag framing&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|gp-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_PCS
)paren
(brace
r_if
c_cond
(paren
id|gem_pcs_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_TXMAC
)paren
(brace
r_if
c_cond
(paren
id|gem_txmac_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_RXMAC
)paren
(brace
r_if
c_cond
(paren
id|gem_rxmac_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_MAC
)paren
(brace
r_if
c_cond
(paren
id|gem_mac_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_MIF
)paren
(brace
r_if
c_cond
(paren
id|gem_mif_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_PCIERR
)paren
(brace
r_if
c_cond
(paren
id|gem_pci_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|do_reset
suffix:colon
id|gp-&gt;reset_task_pending
op_assign
l_int|2
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|gp-&gt;reset_task
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|gem_tx
r_static
id|__inline__
r_void
id|gem_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
r_int
id|entry
comma
id|limit
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: tx interrupt, gem_status: 0x%x&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
comma
id|gem_status
)paren
suffix:semicolon
id|entry
op_assign
id|gp-&gt;tx_old
suffix:semicolon
id|limit
op_assign
(paren
(paren
id|gem_status
op_amp
id|GREG_STAT_TXNR
)paren
op_rshift
id|GREG_STAT_TXNR_SHIFT
)paren
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
id|limit
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|gem_txd
op_star
id|txd
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|u32
id|dma_len
suffix:semicolon
r_int
id|frag
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_tx_done
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: tx done, slot %d&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
comma
id|entry
)paren
suffix:semicolon
id|skb
op_assign
id|gp-&gt;tx_skbs
(braket
id|entry
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
)paren
(brace
r_int
id|last
op_assign
id|entry
op_plus
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
r_int
id|walk
op_assign
id|entry
suffix:semicolon
r_int
id|incomplete
op_assign
l_int|0
suffix:semicolon
id|last
op_and_assign
(paren
id|TX_RING_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|walk
op_assign
id|NEXT_TX
c_func
(paren
id|walk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|walk
op_eq
id|limit
)paren
id|incomplete
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|walk
op_eq
id|last
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|incomplete
)paren
r_break
suffix:semicolon
)brace
id|gp-&gt;tx_skbs
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|gp-&gt;net_stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_for
c_loop
(paren
id|frag
op_assign
l_int|0
suffix:semicolon
id|frag
op_le
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
id|frag
op_increment
)paren
(brace
id|txd
op_assign
op_amp
id|gp-&gt;init_block-&gt;txd
(braket
id|entry
)braket
suffix:semicolon
id|dma_addr
op_assign
id|le64_to_cpu
c_func
(paren
id|txd-&gt;buffer
)paren
suffix:semicolon
id|dma_len
op_assign
id|le64_to_cpu
c_func
(paren
id|txd-&gt;control_word
)paren
op_amp
id|TXDCTRL_BUFSZ
suffix:semicolon
id|pci_unmap_page
c_func
(paren
id|gp-&gt;pdev
comma
id|dma_addr
comma
id|dma_len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|entry
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
id|gp-&gt;net_stats.tx_packets
op_increment
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|gp-&gt;tx_old
op_assign
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
id|TX_BUFFS_AVAIL
c_func
(paren
id|gp
)paren
OG
(paren
id|MAX_SKB_FRAGS
op_plus
l_int|1
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|gem_post_rxds
r_static
id|__inline__
r_void
id|gem_post_rxds
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
id|limit
)paren
(brace
r_int
id|cluster_start
comma
id|curr
comma
id|count
comma
id|kick
suffix:semicolon
id|cluster_start
op_assign
id|curr
op_assign
(paren
id|gp-&gt;rx_new
op_amp
op_complement
(paren
l_int|4
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
id|kick
op_assign
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|curr
op_ne
id|limit
)paren
(brace
id|curr
op_assign
id|NEXT_RX
c_func
(paren
id|curr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|count
op_eq
l_int|4
)paren
(brace
r_struct
id|gem_rxd
op_star
id|rxd
op_assign
op_amp
id|gp-&gt;init_block-&gt;rxd
(braket
id|cluster_start
)braket
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|rxd-&gt;status_word
op_assign
id|cpu_to_le64
c_func
(paren
id|RXDCTRL_FRESH
c_func
(paren
id|gp
)paren
)paren
suffix:semicolon
id|rxd
op_increment
suffix:semicolon
id|cluster_start
op_assign
id|NEXT_RX
c_func
(paren
id|cluster_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cluster_start
op_eq
id|curr
)paren
r_break
suffix:semicolon
)brace
id|kick
op_assign
id|curr
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|kick
op_ge
l_int|0
)paren
id|writel
c_func
(paren
id|kick
comma
id|gp-&gt;regs
op_plus
id|RXDMA_KICK
)paren
suffix:semicolon
)brace
DECL|function|gem_rx
r_static
r_void
id|gem_rx
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_int
id|entry
comma
id|drops
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_intr
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: rx interrupt, done: %d, rx_new: %d&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|RXDMA_DONE
)paren
comma
id|gp-&gt;rx_new
)paren
suffix:semicolon
id|entry
op_assign
id|gp-&gt;rx_new
suffix:semicolon
id|drops
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_struct
id|gem_rxd
op_star
id|rxd
op_assign
op_amp
id|gp-&gt;init_block-&gt;rxd
(braket
id|entry
)braket
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u64
id|status
op_assign
id|cpu_to_le64
c_func
(paren
id|rxd-&gt;status_word
)paren
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|RXDCTRL_OWN
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|skb
op_assign
id|gp-&gt;rx_skbs
(braket
id|entry
)braket
suffix:semicolon
id|len
op_assign
(paren
id|status
op_amp
id|RXDCTRL_BUFSZ
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
OL
id|ETH_ZLEN
)paren
op_logical_or
(paren
id|status
op_amp
id|RXDCTRL_BAD
)paren
)paren
(brace
id|gp-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|ETH_ZLEN
)paren
id|gp-&gt;net_stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|len
op_amp
id|RXDCTRL_BAD
)paren
id|gp-&gt;net_stats.rx_crc_errors
op_increment
suffix:semicolon
multiline_comment|/* We&squot;ll just return it to GEM. */
id|drop_it
suffix:colon
id|gp-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
r_goto
id|next
suffix:semicolon
)brace
id|dma_addr
op_assign
id|cpu_to_le64
c_func
(paren
id|rxd-&gt;buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|RX_COPY_THRESHOLD
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
id|new_skb
op_assign
id|gem_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_skb
op_eq
l_int|NULL
)paren
(brace
id|drops
op_increment
suffix:semicolon
r_goto
id|drop_it
suffix:semicolon
)brace
id|pci_unmap_page
c_func
(paren
id|gp-&gt;pdev
comma
id|dma_addr
comma
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|gp-&gt;rx_skbs
(braket
id|entry
)braket
op_assign
id|new_skb
suffix:semicolon
id|new_skb-&gt;dev
op_assign
id|gp-&gt;dev
suffix:semicolon
id|skb_put
c_func
(paren
id|new_skb
comma
(paren
id|ETH_FRAME_LEN
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|rxd-&gt;buffer
op_assign
id|cpu_to_le64
c_func
(paren
id|pci_map_page
c_func
(paren
id|gp-&gt;pdev
comma
id|virt_to_page
c_func
(paren
id|new_skb-&gt;data
)paren
comma
(paren
(paren
r_int
r_int
)paren
id|new_skb-&gt;data
op_amp
op_complement
id|PAGE_MASK
)paren
comma
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
multiline_comment|/* Trim the original skb for the netif. */
id|skb_trim
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|copy_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_skb
op_eq
l_int|NULL
)paren
(brace
id|drops
op_increment
suffix:semicolon
r_goto
id|drop_it
suffix:semicolon
)brace
id|copy_skb-&gt;dev
op_assign
id|gp-&gt;dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|copy_skb
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|copy_skb
comma
id|len
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|gp-&gt;pdev
comma
id|dma_addr
comma
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|copy_skb-&gt;data
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* We&squot;ll reuse the original ring buffer. */
id|skb
op_assign
id|copy_skb
suffix:semicolon
)brace
id|skb-&gt;csum
op_assign
id|ntohs
c_func
(paren
(paren
id|status
op_amp
id|RXDCTRL_TCPCSUM
)paren
op_xor
l_int|0xffff
)paren
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_HW
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|gp-&gt;dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|gp-&gt;net_stats.rx_packets
op_increment
suffix:semicolon
id|gp-&gt;net_stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|gp-&gt;dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|next
suffix:colon
id|entry
op_assign
id|NEXT_RX
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
id|gem_post_rxds
c_func
(paren
id|gp
comma
id|entry
)paren
suffix:semicolon
id|gp-&gt;rx_new
op_assign
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|drops
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
DECL|function|gem_interrupt
r_static
r_void
id|gem_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|gem_status
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|GREG_STAT
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_ABNORMAL
)paren
(brace
r_if
c_cond
(paren
id|gem_abnormal_irq
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
(paren
id|GREG_STAT_TXALL
op_or
id|GREG_STAT_TXINTME
)paren
)paren
id|gem_tx
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_RXDONE
)paren
id|gem_rx
c_func
(paren
id|gp
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|gem_tx_timeout
r_static
r_void
id|gem_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;hw_running
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: hrm.. hw not running !&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: TX_STATE[%08x:%08x:%08x]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|TXDMA_CFG
)paren
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXSTAT
)paren
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX_STATE[%08x:%08x:%08x]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXSTAT
)paren
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gp-&gt;reset_task_pending
op_assign
l_int|2
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|gp-&gt;reset_task
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|gem_intme
r_static
id|__inline__
r_int
id|gem_intme
c_func
(paren
r_int
id|entry
)paren
(brace
multiline_comment|/* Algorithm: IRQ every 1/2 of descriptors. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|entry
op_amp
(paren
(paren
id|TX_RING_SIZE
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_start_xmit
r_static
r_int
id|gem_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|entry
suffix:semicolon
id|u64
id|ctrl
suffix:semicolon
id|ctrl
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;ip_summed
op_eq
id|CHECKSUM_HW
)paren
(brace
id|u64
id|csum_start_off
comma
id|csum_stuff_off
suffix:semicolon
id|csum_start_off
op_assign
(paren
id|u64
)paren
(paren
id|skb-&gt;h.raw
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
id|csum_stuff_off
op_assign
(paren
id|u64
)paren
(paren
(paren
id|skb-&gt;h.raw
op_plus
id|skb-&gt;csum
)paren
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
id|ctrl
op_assign
(paren
id|TXDCTRL_CENAB
op_or
(paren
id|csum_start_off
op_lshift
l_int|15
)paren
op_or
(paren
id|csum_stuff_off
op_lshift
l_int|21
)paren
)paren
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* This is a hard error, log it. */
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|gp
)paren
op_le
(paren
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
op_plus
l_int|1
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;%s: BUG! Tx Ring full when queue awake!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|entry
op_assign
id|gp-&gt;tx_new
suffix:semicolon
id|gp-&gt;tx_skbs
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
op_eq
l_int|0
)paren
(brace
r_struct
id|gem_txd
op_star
id|txd
op_assign
op_amp
id|gp-&gt;init_block-&gt;txd
(braket
id|entry
)braket
suffix:semicolon
id|dma_addr_t
id|mapping
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|mapping
op_assign
id|pci_map_page
c_func
(paren
id|gp-&gt;pdev
comma
id|virt_to_page
c_func
(paren
id|skb-&gt;data
)paren
comma
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
op_amp
op_complement
id|PAGE_MASK
)paren
comma
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|ctrl
op_or_assign
id|TXDCTRL_SOF
op_or
id|TXDCTRL_EOF
op_or
id|len
suffix:semicolon
r_if
c_cond
(paren
id|gem_intme
c_func
(paren
id|entry
)paren
)paren
id|ctrl
op_or_assign
id|TXDCTRL_INTME
suffix:semicolon
id|txd-&gt;buffer
op_assign
id|cpu_to_le64
c_func
(paren
id|mapping
)paren
suffix:semicolon
id|txd-&gt;control_word
op_assign
id|cpu_to_le64
c_func
(paren
id|ctrl
)paren
suffix:semicolon
id|entry
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|gem_txd
op_star
id|txd
suffix:semicolon
id|u32
id|first_len
suffix:semicolon
id|u64
id|intme
suffix:semicolon
id|dma_addr_t
id|first_mapping
suffix:semicolon
r_int
id|frag
comma
id|first_entry
op_assign
id|entry
suffix:semicolon
id|intme
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|gem_intme
c_func
(paren
id|entry
)paren
)paren
id|intme
op_or_assign
id|TXDCTRL_INTME
suffix:semicolon
multiline_comment|/* We must give this initial chunk to the device last.&n;&t;&t; * Otherwise we could race with the device.&n;&t;&t; */
id|first_len
op_assign
id|skb-&gt;len
op_minus
id|skb-&gt;data_len
suffix:semicolon
id|first_mapping
op_assign
id|pci_map_page
c_func
(paren
id|gp-&gt;pdev
comma
id|virt_to_page
c_func
(paren
id|skb-&gt;data
)paren
comma
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
op_amp
op_complement
id|PAGE_MASK
)paren
comma
id|first_len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|entry
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
r_for
c_loop
(paren
id|frag
op_assign
l_int|0
suffix:semicolon
id|frag
OL
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
id|frag
op_increment
)paren
(brace
id|skb_frag_t
op_star
id|this_frag
op_assign
op_amp
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|frag
)braket
suffix:semicolon
id|u32
id|len
suffix:semicolon
id|dma_addr_t
id|mapping
suffix:semicolon
id|u64
id|this_ctrl
suffix:semicolon
id|len
op_assign
id|this_frag-&gt;size
suffix:semicolon
id|mapping
op_assign
id|pci_map_page
c_func
(paren
id|gp-&gt;pdev
comma
id|this_frag-&gt;page
comma
id|this_frag-&gt;page_offset
comma
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|this_ctrl
op_assign
id|ctrl
suffix:semicolon
r_if
c_cond
(paren
id|frag
op_eq
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
op_minus
l_int|1
)paren
id|this_ctrl
op_or_assign
id|TXDCTRL_EOF
suffix:semicolon
id|txd
op_assign
op_amp
id|gp-&gt;init_block-&gt;txd
(braket
id|entry
)braket
suffix:semicolon
id|txd-&gt;buffer
op_assign
id|cpu_to_le64
c_func
(paren
id|mapping
)paren
suffix:semicolon
id|txd-&gt;control_word
op_assign
id|cpu_to_le64
c_func
(paren
id|this_ctrl
op_or
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gem_intme
c_func
(paren
id|entry
)paren
)paren
id|intme
op_or_assign
id|TXDCTRL_INTME
suffix:semicolon
id|entry
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
id|txd
op_assign
op_amp
id|gp-&gt;init_block-&gt;txd
(braket
id|first_entry
)braket
suffix:semicolon
id|txd-&gt;buffer
op_assign
id|cpu_to_le64
c_func
(paren
id|first_mapping
)paren
suffix:semicolon
id|txd-&gt;control_word
op_assign
id|cpu_to_le64
c_func
(paren
id|ctrl
op_or
id|TXDCTRL_SOF
op_or
id|intme
op_or
id|first_len
)paren
suffix:semicolon
)brace
id|gp-&gt;tx_new
op_assign
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|TX_BUFFS_AVAIL
c_func
(paren
id|gp
)paren
op_le
(paren
id|MAX_SKB_FRAGS
op_plus
l_int|1
)paren
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_tx_queued
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: tx queued, slot %d, skblen %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|entry
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|writel
c_func
(paren
id|gp-&gt;tx_new
comma
id|gp-&gt;regs
op_plus
id|TXDMA_KICK
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Jumbo-grams don&squot;t seem to work :-( */
DECL|macro|GEM_MIN_MTU
mdefine_line|#define GEM_MIN_MTU&t;68
macro_line|#if 1
DECL|macro|GEM_MAX_MTU
mdefine_line|#define GEM_MAX_MTU&t;1500
macro_line|#else
DECL|macro|GEM_MAX_MTU
mdefine_line|#define GEM_MAX_MTU&t;9000
macro_line|#endif
DECL|function|gem_change_mtu
r_static
r_int
id|gem_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|new_mtu
template_param
id|GEM_MAX_MTU
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
op_logical_or
op_logical_neg
id|netif_device_present
c_func
(paren
id|dev
)paren
)paren
(brace
multiline_comment|/* We&squot;ll just catch it later when the&n;&t;&t; * device is up&squot;d or resumed.&n;&t;&t; */
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
id|gp-&gt;reset_task_pending
op_assign
l_int|1
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|gp-&gt;reset_task
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|flush_scheduled_tasks
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|STOP_TRIES
mdefine_line|#define STOP_TRIES 32
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_stop
r_static
r_void
id|gem_stop
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_int
id|limit
suffix:semicolon
id|u32
id|val
suffix:semicolon
multiline_comment|/* Make sure we won&squot;t get any more interrupts */
id|writel
c_func
(paren
l_int|0xffffffff
comma
id|gp-&gt;regs
op_plus
id|GREG_IMASK
)paren
suffix:semicolon
multiline_comment|/* Reset the chip */
id|writel
c_func
(paren
id|gp-&gt;swrst_base
op_or
id|GREG_SWRST_TXRST
op_or
id|GREG_SWRST_RXRST
comma
id|gp-&gt;regs
op_plus
id|GREG_SWRST
)paren
suffix:semicolon
id|limit
op_assign
id|STOP_TRIES
suffix:semicolon
r_do
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|GREG_SWRST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|limit
op_decrement
op_le
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|val
op_amp
(paren
id|GREG_SWRST_TXRST
op_or
id|GREG_SWRST_RXRST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|limit
op_le
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gem: SW reset is ghetto.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_start_dma
r_static
r_void
id|gem_start_dma
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
multiline_comment|/* We are ready to rock, turn everything on. */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|TXDMA_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|TXDMA_CFG_ENABLE
comma
id|gp-&gt;regs
op_plus
id|TXDMA_CFG
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|RXDMA_CFG_ENABLE
comma
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|MAC_TXCFG_ENAB
comma
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|MAC_RXCFG_ENAB
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
(paren
r_void
)paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|writel
c_func
(paren
id|GREG_STAT_TXDONE
comma
id|gp-&gt;regs
op_plus
id|GREG_IMASK
)paren
suffix:semicolon
id|writel
c_func
(paren
id|RX_RING_SIZE
op_minus
l_int|4
comma
id|gp-&gt;regs
op_plus
id|RXDMA_KICK
)paren
suffix:semicolon
)brace
multiline_comment|/* Link modes of the BCM5400 PHY */
DECL|variable|phy_BCM5400_link_table
r_static
r_int
id|phy_BCM5400_link_table
(braket
l_int|8
)braket
(braket
l_int|3
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* No link */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 10BT Half Duplex */
(brace
l_int|1
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 10BT Full Duplex */
(brace
l_int|0
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* 100BT Half Duplex */
(brace
l_int|0
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* 100BT Half Duplex */
(brace
l_int|1
comma
l_int|1
comma
l_int|0
)brace
comma
multiline_comment|/* 100BT Full Duplex*/
(brace
l_int|1
comma
l_int|0
comma
l_int|1
)brace
comma
multiline_comment|/* 1000BT */
(brace
l_int|1
comma
l_int|0
comma
l_int|1
)brace
comma
multiline_comment|/* 1000BT */
)brace
suffix:semicolon
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_begin_auto_negotiation
r_static
r_void
id|gem_begin_auto_negotiation
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_struct
id|ethtool_cmd
op_star
id|ep
)paren
(brace
id|u16
id|ctl
suffix:semicolon
multiline_comment|/* Setup link parameters */
r_if
c_cond
(paren
op_logical_neg
id|ep
)paren
r_goto
id|start_aneg
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;autoneg
op_eq
id|AUTONEG_ENABLE
)paren
(brace
multiline_comment|/* TODO: parse ep-&gt;advertising */
id|gp-&gt;link_advertise
op_or_assign
(paren
id|ADVERTISE_10HALF
op_or
id|ADVERTISE_10FULL
)paren
suffix:semicolon
id|gp-&gt;link_advertise
op_or_assign
(paren
id|ADVERTISE_100HALF
op_or
id|ADVERTISE_100FULL
)paren
suffix:semicolon
multiline_comment|/* Can I advertise gigabit here ? I&squot;d need BCM PHY docs... */
id|gp-&gt;link_cntl
op_assign
id|BMCR_ANENABLE
suffix:semicolon
)brace
r_else
(brace
id|gp-&gt;link_cntl
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;speed
op_eq
id|SPEED_100
)paren
id|gp-&gt;link_cntl
op_or_assign
id|BMCR_SPEED100
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ep-&gt;speed
op_eq
id|SPEED_1000
op_logical_and
id|gp-&gt;gigabit_capable
)paren
multiline_comment|/* Hrm... check if this is right... */
id|gp-&gt;link_cntl
op_or_assign
id|BMCR_SPD2
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;duplex
op_eq
id|DUPLEX_FULL
)paren
id|gp-&gt;link_cntl
op_or_assign
id|BMCR_FULLDPLX
suffix:semicolon
)brace
id|start_aneg
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;hw_running
)paren
r_return
suffix:semicolon
multiline_comment|/* Configure PHY &amp; start aneg */
id|ctl
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
)paren
suffix:semicolon
id|ctl
op_and_assign
op_complement
(paren
id|BMCR_FULLDPLX
op_or
id|BMCR_SPEED100
op_or
id|BMCR_ANENABLE
)paren
suffix:semicolon
id|ctl
op_or_assign
id|gp-&gt;link_cntl
suffix:semicolon
r_if
c_cond
(paren
id|ctl
op_amp
id|BMCR_ANENABLE
)paren
(brace
id|ctl
op_or_assign
id|BMCR_ANRESTART
suffix:semicolon
id|gp-&gt;lstate
op_assign
id|link_aneg
suffix:semicolon
)brace
r_else
(brace
id|gp-&gt;lstate
op_assign
id|link_force_ok
suffix:semicolon
)brace
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|ctl
)paren
suffix:semicolon
id|gp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|gp-&gt;link_timer
comma
id|jiffies
op_plus
(paren
(paren
l_int|12
op_star
id|HZ
)paren
op_div
l_int|10
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_read_mii_link_mode
r_static
r_void
id|gem_read_mii_link_mode
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
op_star
id|fd
comma
r_int
op_star
id|spd
comma
r_int
op_star
id|pause
)paren
(brace
id|u32
id|val
suffix:semicolon
op_star
id|fd
op_assign
l_int|0
suffix:semicolon
op_star
id|spd
op_assign
l_int|10
suffix:semicolon
op_star
id|pause
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;phy_mod
op_eq
id|phymod_bcm5400
op_logical_or
id|gp-&gt;phy_mod
op_eq
id|phymod_bcm5401
op_logical_or
id|gp-&gt;phy_mod
op_eq
id|phymod_bcm5411
)paren
(brace
r_int
id|link_mode
suffix:semicolon
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BCM5400_AUXSTATUS
)paren
suffix:semicolon
id|link_mode
op_assign
(paren
(paren
id|val
op_amp
id|MII_BCM5400_AUXSTATUS_LINKMODE_MASK
)paren
op_rshift
id|MII_BCM5400_AUXSTATUS_LINKMODE_SHIFT
)paren
suffix:semicolon
op_star
id|fd
op_assign
id|phy_BCM5400_link_table
(braket
id|link_mode
)braket
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|spd
op_assign
id|phy_BCM5400_link_table
(braket
id|link_mode
)braket
(braket
l_int|2
)braket
ques
c_cond
l_int|1000
suffix:colon
(paren
id|phy_BCM5400_link_table
(braket
id|link_mode
)braket
(braket
l_int|1
)braket
ques
c_cond
l_int|100
suffix:colon
l_int|10
)paren
suffix:semicolon
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_LPA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|LPA_PAUSE
)paren
op_star
id|pause
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_LPA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
(paren
id|LPA_10FULL
op_or
id|LPA_100FULL
)paren
)paren
op_star
id|fd
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
(paren
id|LPA_100FULL
op_or
id|LPA_100HALF
)paren
)paren
op_star
id|spd
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;phy_mod
op_eq
id|phymod_m1011
)paren
(brace
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
l_int|0x0a
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
l_int|0xc00
)paren
op_star
id|spd
op_assign
l_int|1000
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
l_int|0x800
)paren
op_star
id|fd
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* A link-up condition has occurred, initialize and enable the&n; * rest of the chip.&n; *&n; * Must be invoked under gp-&gt;lock.&n; */
DECL|function|gem_set_link_modes
r_static
r_void
id|gem_set_link_modes
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u32
id|val
suffix:semicolon
r_int
id|full_duplex
comma
id|speed
comma
id|pause
suffix:semicolon
id|full_duplex
op_assign
l_int|0
suffix:semicolon
id|speed
op_assign
l_int|10
suffix:semicolon
id|pause
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
)paren
(brace
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|BMCR_ANENABLE
)paren
id|gem_read_mii_link_mode
c_func
(paren
id|gp
comma
op_amp
id|full_duplex
comma
op_amp
id|speed
comma
op_amp
id|pause
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|val
op_amp
id|BMCR_FULLDPLX
)paren
id|full_duplex
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|BMCR_SPEED100
)paren
id|speed
op_assign
l_int|100
suffix:semicolon
)brace
)brace
r_else
(brace
id|u32
id|pcs_lpa
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIILP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcs_lpa
op_amp
id|PCS_MIIADV_FD
)paren
id|full_duplex
op_assign
l_int|1
suffix:semicolon
id|speed
op_assign
l_int|1000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_msg_link
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Link is up at %d Mbps, %s-duplex.&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
comma
id|speed
comma
(paren
id|full_duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
)paren
suffix:semicolon
id|val
op_assign
(paren
id|MAC_TXCFG_EIPG0
op_or
id|MAC_TXCFG_NGU
)paren
suffix:semicolon
r_if
c_cond
(paren
id|full_duplex
)paren
(brace
id|val
op_or_assign
(paren
id|MAC_TXCFG_ICS
op_or
id|MAC_TXCFG_ICOLL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* MAC_TXCFG_NBO must be zero. */
)brace
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|val
op_assign
(paren
id|MAC_XIFCFG_OE
op_or
id|MAC_XIFCFG_LLED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|full_duplex
op_logical_and
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
)paren
)paren
(brace
id|val
op_or_assign
id|MAC_XIFCFG_DISE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|full_duplex
)paren
(brace
id|val
op_or_assign
id|MAC_XIFCFG_FLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|speed
op_eq
l_int|1000
)paren
id|val
op_or_assign
(paren
id|MAC_XIFCFG_GMII
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|MAC_XIFCFG
)paren
suffix:semicolon
multiline_comment|/* If gigabit and half-duplex, enable carrier extension&n;&t; * mode.  Else, disable it.&n;&t; */
r_if
c_cond
(paren
id|speed
op_eq
l_int|1000
op_logical_and
op_logical_neg
id|full_duplex
)paren
(brace
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|MAC_TXCFG_TCE
comma
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|MAC_RXCFG_RCE
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_amp
op_complement
id|MAC_TXCFG_TCE
comma
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_amp
op_complement
id|MAC_RXCFG_RCE
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_serialink
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_serdes
)paren
(brace
id|u32
id|pcs_lpa
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIILP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcs_lpa
op_amp
(paren
id|PCS_MIIADV_SP
op_or
id|PCS_MIIADV_AP
)paren
)paren
id|pause
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_msg_link
c_func
(paren
id|gp
)paren
)paren
(brace
r_if
c_cond
(paren
id|pause
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Pause is enabled &quot;
l_string|&quot;(rxfifo: %d off: %d on: %d)&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
comma
id|gp-&gt;rx_fifo_sz
comma
id|gp-&gt;rx_pause_off
comma
id|gp-&gt;rx_pause_on
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Pause is disabled&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|full_duplex
)paren
id|writel
c_func
(paren
l_int|512
comma
id|gp-&gt;regs
op_plus
id|MAC_STIME
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
l_int|64
comma
id|gp-&gt;regs
op_plus
id|MAC_STIME
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_MCCFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pause
)paren
id|val
op_or_assign
(paren
id|MAC_MCCFG_SPE
op_or
id|MAC_MCCFG_RPE
)paren
suffix:semicolon
r_else
id|val
op_and_assign
op_complement
(paren
id|MAC_MCCFG_SPE
op_or
id|MAC_MCCFG_RPE
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|MAC_MCCFG
)paren
suffix:semicolon
id|gem_start_dma
c_func
(paren
id|gp
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_mdio_link_not_up
r_static
r_int
id|gem_mdio_link_not_up
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u16
id|val
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;lstate
op_eq
id|link_force_ret
)paren
(brace
r_if
c_cond
(paren
id|netif_msg_link
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Autoneg failed again, keeping&quot;
l_string|&quot; forced mode&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|gp-&gt;link_fcntl
)paren
suffix:semicolon
id|gp-&gt;timer_ticks
op_assign
l_int|5
suffix:semicolon
id|gp-&gt;lstate
op_assign
id|link_force_ok
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gp-&gt;lstate
op_eq
id|link_aneg
)paren
(brace
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_link
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: switching to forced 100bt&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Try forced modes. */
id|val
op_and_assign
op_complement
(paren
id|BMCR_ANRESTART
op_or
id|BMCR_ANENABLE
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
(paren
id|BMCR_FULLDPLX
)paren
suffix:semicolon
id|val
op_or_assign
id|BMCR_SPEED100
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|val
)paren
suffix:semicolon
id|gp-&gt;timer_ticks
op_assign
l_int|5
suffix:semicolon
id|gp-&gt;lstate
op_assign
id|link_force_try
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Downgrade from 100 to 10 Mbps if necessary.&n;&t;&t; * If already at 10Mbps, warn user about the&n;&t;&t; * situation every 10 ticks.&n;&t;&t; */
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|BMCR_SPEED100
)paren
(brace
id|val
op_and_assign
op_complement
id|BMCR_SPEED100
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|val
)paren
suffix:semicolon
id|gp-&gt;timer_ticks
op_assign
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_link
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: switching to forced 10bt&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|gem_init_rings
c_func
(paren
r_struct
id|gem
op_star
)paren
suffix:semicolon
r_static
r_void
id|gem_init_hw
c_func
(paren
r_struct
id|gem
op_star
comma
r_int
)paren
suffix:semicolon
DECL|function|gem_reset_task
r_static
r_void
id|gem_reset_task
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
(paren
r_struct
id|gem
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* The link went down, we reset the ring, but keep&n;&t; * DMA stopped. Todo: Use this function for reset&n;&t; * on error as well.&n;&t; */
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;hw_running
op_logical_and
id|gp-&gt;opened
)paren
(brace
multiline_comment|/* Make sure we don&squot;t get interrupts or tx packets */
id|netif_stop_queue
c_func
(paren
id|gp-&gt;dev
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffffffff
comma
id|gp-&gt;regs
op_plus
id|GREG_IMASK
)paren
suffix:semicolon
multiline_comment|/* Reset the chip &amp; rings */
id|gem_stop
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gem_init_rings
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gem_init_hw
c_func
(paren
id|gp
comma
(paren
id|gp-&gt;reset_task_pending
op_eq
l_int|2
)paren
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|gp-&gt;dev
)paren
suffix:semicolon
)brace
id|gp-&gt;reset_task_pending
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|gem_link_timer
r_static
r_void
id|gem_link_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
(paren
r_struct
id|gem
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;hw_running
)paren
r_return
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* If the link of task is still pending, we just&n;&t; * reschedule the link timer&n;&t; */
r_if
c_cond
(paren
id|gp-&gt;reset_task_pending
)paren
r_goto
id|restart
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
)paren
(brace
id|u16
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BMSR
)paren
suffix:semicolon
id|u16
id|cntl
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
)paren
suffix:semicolon
r_int
id|up
suffix:semicolon
multiline_comment|/* When using autoneg, we really wait for ANEGCOMPLETE or we may&n;&t;&t; * get a &quot;transcient&quot; incorrect link state&n;&t;&t; */
r_if
c_cond
(paren
id|cntl
op_amp
id|BMCR_ANENABLE
)paren
id|up
op_assign
(paren
id|val
op_amp
(paren
id|BMSR_ANEGCOMPLETE
op_or
id|BMSR_LSTATUS
)paren
)paren
op_eq
(paren
id|BMSR_ANEGCOMPLETE
op_or
id|BMSR_LSTATUS
)paren
suffix:semicolon
r_else
id|up
op_assign
(paren
id|val
op_amp
id|BMSR_LSTATUS
)paren
op_ne
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|up
)paren
(brace
multiline_comment|/* Ok, here we got a link. If we had it due to a forced&n;&t;&t;&t; * fallback, and we were configured for autoneg, we do&n;&t;&t;&t; * retry a short autoneg pass. If you know your hub is&n;&t;&t;&t; * broken, use ethtool ;)&n;&t;&t;&t; */
r_if
c_cond
(paren
id|gp-&gt;lstate
op_eq
id|link_force_try
op_logical_and
(paren
id|gp-&gt;link_cntl
op_amp
id|BMCR_ANENABLE
)paren
)paren
(brace
id|gp-&gt;lstate
op_assign
id|link_force_ret
suffix:semicolon
id|gp-&gt;link_fcntl
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
)paren
suffix:semicolon
id|gp-&gt;timer_ticks
op_assign
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_link
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Got link after fallback, retrying&quot;
l_string|&quot; autoneg once...&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|gp-&gt;link_fcntl
op_or
id|BMCR_ANENABLE
op_or
id|BMCR_ANRESTART
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gp-&gt;lstate
op_ne
id|link_up
)paren
(brace
id|gp-&gt;lstate
op_assign
id|link_up
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;opened
)paren
id|gem_set_link_modes
c_func
(paren
id|gp
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
id|restart
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If the link was previously up, we restart the&n;&t;&t;&t; * whole process&n;&t;&t;&t; */
r_if
c_cond
(paren
id|gp-&gt;lstate
op_eq
id|link_up
)paren
(brace
id|gp-&gt;lstate
op_assign
id|link_down
suffix:semicolon
r_if
c_cond
(paren
id|netif_msg_link
c_func
(paren
id|gp
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Link down&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|gp-&gt;reset_task_pending
op_assign
l_int|2
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|gp-&gt;reset_task
)paren
suffix:semicolon
id|restart
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_increment
id|gp-&gt;timer_ticks
OG
l_int|10
)paren
id|restart
op_assign
id|gem_mdio_link_not_up
c_func
(paren
id|gp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|restart
)paren
(brace
id|gem_begin_auto_negotiation
c_func
(paren
id|gp
comma
l_int|NULL
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|u32
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIISTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|PCS_MIISTAT_LS
)paren
)paren
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIISTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
id|PCS_MIISTAT_LS
)paren
op_ne
l_int|0
)paren
(brace
id|gp-&gt;lstate
op_assign
id|link_up
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;opened
)paren
id|gem_set_link_modes
c_func
(paren
id|gp
)paren
suffix:semicolon
)brace
)brace
id|restart
suffix:colon
id|mod_timer
c_func
(paren
op_amp
id|gp-&gt;link_timer
comma
id|jiffies
op_plus
(paren
(paren
l_int|12
op_star
id|HZ
)paren
op_div
l_int|10
)paren
)paren
suffix:semicolon
id|out_unlock
suffix:colon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_clean_rings
r_static
r_void
id|gem_clean_rings
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_struct
id|gem_init_block
op_star
id|gb
op_assign
id|gp-&gt;init_block
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|gem_rxd
op_star
id|rxd
suffix:semicolon
id|rxd
op_assign
op_amp
id|gb-&gt;rxd
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;rx_skbs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|skb
op_assign
id|gp-&gt;rx_skbs
(braket
id|i
)braket
suffix:semicolon
id|dma_addr
op_assign
id|le64_to_cpu
c_func
(paren
id|rxd-&gt;buffer
)paren
suffix:semicolon
id|pci_unmap_page
c_func
(paren
id|gp-&gt;pdev
comma
id|dma_addr
comma
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|gp-&gt;rx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|rxd-&gt;status_word
op_assign
l_int|0
suffix:semicolon
id|rxd-&gt;buffer
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;tx_skbs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
r_struct
id|gem_txd
op_star
id|txd
suffix:semicolon
r_int
id|frag
suffix:semicolon
id|skb
op_assign
id|gp-&gt;tx_skbs
(braket
id|i
)braket
suffix:semicolon
id|gp-&gt;tx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|frag
op_assign
l_int|0
suffix:semicolon
id|frag
op_le
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
id|frag
op_increment
)paren
(brace
r_int
id|ent
op_assign
id|i
op_amp
(paren
id|TX_RING_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|txd
op_assign
op_amp
id|gb-&gt;txd
(braket
id|ent
)braket
suffix:semicolon
id|dma_addr
op_assign
id|le64_to_cpu
c_func
(paren
id|txd-&gt;buffer
)paren
suffix:semicolon
id|pci_unmap_page
c_func
(paren
id|gp-&gt;pdev
comma
id|dma_addr
comma
id|le64_to_cpu
c_func
(paren
id|txd-&gt;control_word
)paren
op_amp
id|TXDCTRL_BUFSZ
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frag
op_ne
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
)paren
id|i
op_increment
suffix:semicolon
)brace
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_init_rings
r_static
r_void
id|gem_init_rings
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_struct
id|gem_init_block
op_star
id|gb
op_assign
id|gp-&gt;init_block
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|gp-&gt;dev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dma_addr_t
id|dma_addr
suffix:semicolon
id|gp-&gt;rx_new
op_assign
id|gp-&gt;rx_old
op_assign
id|gp-&gt;tx_new
op_assign
id|gp-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
id|gem_clean_rings
c_func
(paren
id|gp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|gem_rxd
op_star
id|rxd
op_assign
op_amp
id|gb-&gt;rxd
(braket
id|i
)braket
suffix:semicolon
id|skb
op_assign
id|gem_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|rxd-&gt;buffer
op_assign
l_int|0
suffix:semicolon
id|rxd-&gt;status_word
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|gp-&gt;rx_skbs
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
(paren
id|ETH_FRAME_LEN
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|dma_addr
op_assign
id|pci_map_page
c_func
(paren
id|gp-&gt;pdev
comma
id|virt_to_page
c_func
(paren
id|skb-&gt;data
)paren
comma
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;data
op_amp
op_complement
id|PAGE_MASK
)paren
comma
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|rxd-&gt;buffer
op_assign
id|cpu_to_le64
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
id|rxd-&gt;status_word
op_assign
id|cpu_to_le64
c_func
(paren
id|RXDCTRL_FRESH
c_func
(paren
id|gp
)paren
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|gem_txd
op_star
id|txd
op_assign
op_amp
id|gb-&gt;txd
(braket
id|i
)braket
suffix:semicolon
id|txd-&gt;control_word
op_assign
l_int|0
suffix:semicolon
id|txd-&gt;buffer
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_reset_one_mii_phy
r_static
r_int
id|gem_reset_one_mii_phy
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
id|phy_addr
)paren
(brace
id|u16
id|val
suffix:semicolon
r_int
id|limit
op_assign
l_int|10000
suffix:semicolon
id|val
op_assign
id|__phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|phy_addr
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|BMCR_ISOLATE
suffix:semicolon
id|val
op_or_assign
id|BMCR_RESET
suffix:semicolon
id|__phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|val
comma
id|phy_addr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_while
c_loop
(paren
id|limit
op_decrement
)paren
(brace
id|val
op_assign
id|__phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|phy_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
id|BMCR_RESET
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|val
op_amp
id|BMCR_ISOLATE
)paren
op_logical_and
id|limit
OG
l_int|0
)paren
id|__phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|val
op_amp
op_complement
id|BMCR_ISOLATE
comma
id|phy_addr
)paren
suffix:semicolon
r_return
(paren
id|limit
op_le
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_init_bcm5201_phy
r_static
r_void
id|gem_init_bcm5201_phy
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u16
id|data
suffix:semicolon
id|data
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BCM5201_MULTIPHY
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
id|MII_BCM5201_MULTIPHY_SUPERISOLATE
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5201_MULTIPHY
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_init_bcm5400_phy
r_static
r_void
id|gem_init_bcm5400_phy
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u16
id|data
suffix:semicolon
multiline_comment|/* Configure for gigabit full duplex */
id|data
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BCM5400_AUXCONTROL
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_BCM5400_AUXCONTROL_PWR10BASET
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5400_AUXCONTROL
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BCM5400_GB_CONTROL
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_BCM5400_GB_CONTROL_FULLDUPLEXCAP
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5400_GB_CONTROL
comma
id|data
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Reset and configure cascaded 10/100 PHY */
id|gem_reset_one_mii_phy
c_func
(paren
id|gp
comma
l_int|0x1f
)paren
suffix:semicolon
id|data
op_assign
id|__phy_read
c_func
(paren
id|gp
comma
id|MII_BCM5201_MULTIPHY
comma
l_int|0x1f
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_BCM5201_MULTIPHY_SERIALMODE
suffix:semicolon
id|__phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5201_MULTIPHY
comma
id|data
comma
l_int|0x1f
)paren
suffix:semicolon
id|data
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BCM5400_AUXCONTROL
)paren
suffix:semicolon
id|data
op_and_assign
op_complement
id|MII_BCM5400_AUXCONTROL_PWR10BASET
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5400_AUXCONTROL
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_init_bcm5401_phy
r_static
r_void
id|gem_init_bcm5401_phy
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u16
id|data
suffix:semicolon
r_int
id|rev
suffix:semicolon
id|rev
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_PHYSID2
)paren
op_amp
l_int|0x000f
suffix:semicolon
r_if
c_cond
(paren
id|rev
op_eq
l_int|0
op_logical_or
id|rev
op_eq
l_int|3
)paren
(brace
multiline_comment|/* Some revisions of 5401 appear to need this&n;&t;&t; * initialisation sequence to disable, according&n;&t;&t; * to OF, &quot;tap power management&quot;&n;&t;&t; * &n;&t;&t; * WARNING ! OF and Darwin don&squot;t agree on the&n;&t;&t; * register addresses. OF seem to interpret the&n;&t;&t; * register numbers below as decimal&n;&t;&t; *&n;&t;&t; * Note: This should (and does) match tg3_init_5401phy_dsp&n;&t;&t; *       in the tg3.c driver. -DaveM&n;&t;&t; */
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x18
comma
l_int|0x0c20
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x17
comma
l_int|0x0012
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x15
comma
l_int|0x1804
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x17
comma
l_int|0x0013
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x15
comma
l_int|0x1204
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x17
comma
l_int|0x8006
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x15
comma
l_int|0x0132
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x17
comma
l_int|0x8006
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x15
comma
l_int|0x0232
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x17
comma
l_int|0x201f
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x15
comma
l_int|0x0a20
)paren
suffix:semicolon
)brace
multiline_comment|/* Configure for gigabit full duplex */
id|data
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BCM5400_GB_CONTROL
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_BCM5400_GB_CONTROL_FULLDUPLEXCAP
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5400_GB_CONTROL
comma
id|data
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Reset and configure cascaded 10/100 PHY */
id|gem_reset_one_mii_phy
c_func
(paren
id|gp
comma
l_int|0x1f
)paren
suffix:semicolon
id|data
op_assign
id|__phy_read
c_func
(paren
id|gp
comma
id|MII_BCM5201_MULTIPHY
comma
l_int|0x1f
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_BCM5201_MULTIPHY_SERIALMODE
suffix:semicolon
id|__phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5201_MULTIPHY
comma
id|data
comma
l_int|0x1f
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_init_bcm5411_phy
r_static
r_void
id|gem_init_bcm5411_phy
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u16
id|data
suffix:semicolon
multiline_comment|/* Here&squot;s some more Apple black magic to setup&n;&t; * some voltage stuffs.&n;&t; */
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x1c
comma
l_int|0x8c23
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x1c
comma
l_int|0x8ca3
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
l_int|0x1c
comma
l_int|0x8c23
)paren
suffix:semicolon
multiline_comment|/* Here, Apple seems to want to reset it, do&n;&t; * it as well&n;&t; */
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|BMCR_RESET
)paren
suffix:semicolon
multiline_comment|/* Start autoneg */
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
(paren
id|BMCR_ANENABLE
op_or
id|BMCR_FULLDPLX
op_or
id|BMCR_ANRESTART
op_or
id|BMCR_SPD2
)paren
)paren
suffix:semicolon
id|data
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BCM5400_GB_CONTROL
)paren
suffix:semicolon
id|data
op_or_assign
id|MII_BCM5400_GB_CONTROL_FULLDUPLEXCAP
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5400_GB_CONTROL
comma
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_init_phy
r_static
r_void
id|gem_init_phy
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u32
id|mifcfg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;wake_on_lan
op_logical_and
id|gp-&gt;phy_mod
op_eq
id|phymod_bcm5201
)paren
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5201_INTERRUPT
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Revert MIF CFG setting done on stop_phy */
id|mifcfg
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
id|mifcfg
op_and_assign
op_complement
id|MIF_CFG_BBMODE
suffix:semicolon
id|writel
c_func
(paren
id|mifcfg
comma
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ALL_PPC
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
)paren
(brace
r_int
id|i
suffix:semicolon
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_GMAC_PHY_RESET
comma
id|gp-&gt;of_node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|gp-&gt;mii_phy_addr
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
)paren
op_ne
l_int|0xffff
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|32
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: GMAC PHY not responding !&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_ALL_PPC */
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_SUN
op_logical_and
id|gp-&gt;pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_GEM
)paren
(brace
id|u32
id|val
suffix:semicolon
multiline_comment|/* Init datapath mode register. */
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
)paren
(brace
id|val
op_assign
id|PCS_DMODE_MGM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_serialink
)paren
(brace
id|val
op_assign
id|PCS_DMODE_SM
op_or
id|PCS_DMODE_GMOE
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|PCS_DMODE_ESM
suffix:semicolon
)brace
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_DMODE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
)paren
(brace
id|u32
id|phy_id
suffix:semicolon
id|u16
id|val
suffix:semicolon
multiline_comment|/* Take PHY out of isloate mode and reset it. */
id|gem_reset_one_mii_phy
c_func
(paren
id|gp
comma
id|gp-&gt;mii_phy_addr
)paren
suffix:semicolon
id|phy_id
op_assign
(paren
id|phy_read
c_func
(paren
id|gp
comma
id|MII_PHYSID1
)paren
op_lshift
l_int|16
op_or
id|phy_read
c_func
(paren
id|gp
comma
id|MII_PHYSID2
)paren
)paren
op_amp
l_int|0xfffffff0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: MII PHY ID: %x &quot;
comma
id|gp-&gt;dev-&gt;name
comma
id|phy_id
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|phy_id
)paren
(brace
r_case
l_int|0x406210
suffix:colon
id|gp-&gt;phy_mod
op_assign
id|phymod_bcm5201
suffix:semicolon
id|gem_init_bcm5201_phy
c_func
(paren
id|gp
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BCM 5201&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x4061e0
suffix:colon
id|printk
c_func
(paren
l_string|&quot;BCM 5221&bslash;n&quot;
)paren
suffix:semicolon
id|gp-&gt;phy_mod
op_assign
id|phymod_bcm5221
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x206040
suffix:colon
id|printk
c_func
(paren
l_string|&quot;BCM 5400&bslash;n&quot;
)paren
suffix:semicolon
id|gp-&gt;phy_mod
op_assign
id|phymod_bcm5400
suffix:semicolon
id|gem_init_bcm5400_phy
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gp-&gt;gigabit_capable
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x206050
suffix:colon
id|printk
c_func
(paren
l_string|&quot;BCM 5401&bslash;n&quot;
)paren
suffix:semicolon
id|gp-&gt;phy_mod
op_assign
id|phymod_bcm5401
suffix:semicolon
id|gem_init_bcm5401_phy
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gp-&gt;gigabit_capable
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x206070
suffix:colon
id|printk
c_func
(paren
l_string|&quot;BCM 5411&bslash;n&quot;
)paren
suffix:semicolon
id|gp-&gt;phy_mod
op_assign
id|phymod_bcm5411
suffix:semicolon
id|gem_init_bcm5411_phy
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gp-&gt;gigabit_capable
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1410c60
suffix:colon
id|printk
c_func
(paren
l_string|&quot;M1011 (Marvel ?)&bslash;n&quot;
)paren
suffix:semicolon
id|gp-&gt;phy_mod
op_assign
id|phymod_m1011
suffix:semicolon
id|gp-&gt;gigabit_capable
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x18074c0
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Lucent&bslash;n&quot;
)paren
suffix:semicolon
id|gp-&gt;phy_mod
op_assign
id|phymod_generic
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x437420
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Enable Semiconductor&bslash;n&quot;
)paren
suffix:semicolon
id|gp-&gt;phy_mod
op_assign
id|phymod_generic
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Unknown (Using generic mode)&bslash;n&quot;
)paren
suffix:semicolon
id|gp-&gt;phy_mod
op_assign
id|phymod_generic
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Init advertisement and enable autonegotiation. */
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|BMCR_ANENABLE
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|val
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|MII_ADVERTISE
comma
id|phy_read
c_func
(paren
id|gp
comma
id|MII_ADVERTISE
)paren
op_or
(paren
id|ADVERTISE_10HALF
op_or
id|ADVERTISE_10FULL
op_or
id|ADVERTISE_100HALF
op_or
id|ADVERTISE_100FULL
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|u32
id|val
suffix:semicolon
r_int
id|limit
suffix:semicolon
multiline_comment|/* Reset PCS unit. */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIICTRL
)paren
suffix:semicolon
id|val
op_or_assign
id|PCS_MIICTRL_RST
suffix:semicolon
id|writeb
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_MIICTRL
)paren
suffix:semicolon
id|limit
op_assign
l_int|32
suffix:semicolon
r_while
c_loop
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIICTRL
)paren
op_amp
id|PCS_MIICTRL_RST
)paren
(brace
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|limit
op_decrement
op_le
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|limit
op_le
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PCS reset bit would not clear.&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Make sure PCS is disabled while changing advertisement&n;&t;&t; * configuration.&n;&t;&t; */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_CFG
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
(paren
id|PCS_CFG_ENABLE
op_or
id|PCS_CFG_TO
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_CFG
)paren
suffix:semicolon
multiline_comment|/* Advertise all capabilities except assymetric&n;&t;&t; * pause.&n;&t;&t; */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIIADV
)paren
suffix:semicolon
id|val
op_or_assign
(paren
id|PCS_MIIADV_FD
op_or
id|PCS_MIIADV_HD
op_or
id|PCS_MIIADV_SP
op_or
id|PCS_MIIADV_AP
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_MIIADV
)paren
suffix:semicolon
multiline_comment|/* Enable and restart auto-negotiation, disable wrapback/loopback,&n;&t;&t; * and re-enable PCS.&n;&t;&t; */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIICTRL
)paren
suffix:semicolon
id|val
op_or_assign
(paren
id|PCS_MIICTRL_RAN
op_or
id|PCS_MIICTRL_ANE
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|PCS_MIICTRL_WB
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_MIICTRL
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_CFG
)paren
suffix:semicolon
id|val
op_or_assign
id|PCS_CFG_ENABLE
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_CFG
)paren
suffix:semicolon
multiline_comment|/* Make sure serialink loopback is off.  The meaning&n;&t;&t; * of this bit is logically inverted based upon whether&n;&t;&t; * you are in Serialink or SERDES mode.&n;&t;&t; */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_SCTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_serialink
)paren
id|val
op_and_assign
op_complement
id|PCS_SCTRL_LOOP
suffix:semicolon
r_else
id|val
op_or_assign
id|PCS_SCTRL_LOOP
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_SCTRL
)paren
suffix:semicolon
id|gp-&gt;gigabit_capable
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* BMCR_SPD2 is a broadcom 54xx specific thing afaik */
r_if
c_cond
(paren
id|gp-&gt;phy_mod
op_ne
id|phymod_bcm5400
op_logical_and
id|gp-&gt;phy_mod
op_ne
id|phymod_bcm5401
op_logical_and
id|gp-&gt;phy_mod
op_ne
id|phymod_bcm5411
)paren
id|gp-&gt;link_cntl
op_and_assign
op_complement
id|BMCR_SPD2
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_init_dma
r_static
r_void
id|gem_init_dma
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u64
id|desc_dma
op_assign
(paren
id|u64
)paren
id|gp-&gt;gblock_dvma
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|val
op_assign
(paren
id|TXDMA_CFG_BASE
op_or
(paren
l_int|0x7ff
op_lshift
l_int|10
)paren
op_or
id|TXDMA_CFG_PMODE
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|TXDMA_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|desc_dma
op_rshift
l_int|32
comma
id|gp-&gt;regs
op_plus
id|TXDMA_DBHI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|desc_dma
op_amp
l_int|0xffffffff
comma
id|gp-&gt;regs
op_plus
id|TXDMA_DBLOW
)paren
suffix:semicolon
id|desc_dma
op_add_assign
(paren
id|INIT_BLOCK_TX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|gem_txd
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|TXDMA_KICK
)paren
suffix:semicolon
id|val
op_assign
(paren
id|RXDMA_CFG_BASE
op_or
(paren
id|RX_OFFSET
op_lshift
l_int|10
)paren
op_or
(paren
(paren
l_int|14
op_div
l_int|2
)paren
op_lshift
l_int|13
)paren
op_or
id|RXDMA_CFG_FTHRESH_128
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|desc_dma
op_rshift
l_int|32
comma
id|gp-&gt;regs
op_plus
id|RXDMA_DBHI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|desc_dma
op_amp
l_int|0xffffffff
comma
id|gp-&gt;regs
op_plus
id|RXDMA_DBLOW
)paren
suffix:semicolon
id|writel
c_func
(paren
id|RX_RING_SIZE
op_minus
l_int|4
comma
id|gp-&gt;regs
op_plus
id|RXDMA_KICK
)paren
suffix:semicolon
id|val
op_assign
(paren
(paren
(paren
id|gp-&gt;rx_pause_off
op_div
l_int|64
)paren
op_lshift
l_int|0
)paren
op_amp
id|RXDMA_PTHRESH_OFF
)paren
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
id|gp-&gt;rx_pause_on
op_div
l_int|64
)paren
op_lshift
l_int|12
)paren
op_amp
id|RXDMA_PTHRESH_ON
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|RXDMA_PTHRESH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|GREG_BIFCFG
)paren
op_amp
id|GREG_BIFCFG_M66EN
)paren
id|writel
c_func
(paren
(paren
(paren
l_int|5
op_amp
id|RXDMA_BLANK_IPKTS
)paren
op_or
(paren
(paren
l_int|8
op_lshift
l_int|12
)paren
op_amp
id|RXDMA_BLANK_ITIME
)paren
)paren
comma
id|gp-&gt;regs
op_plus
id|RXDMA_BLANK
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
(paren
(paren
l_int|5
op_amp
id|RXDMA_BLANK_IPKTS
)paren
op_or
(paren
(paren
l_int|4
op_lshift
l_int|12
)paren
op_amp
id|RXDMA_BLANK_ITIME
)paren
)paren
comma
id|gp-&gt;regs
op_plus
id|RXDMA_BLANK
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
r_static
id|u32
DECL|function|gem_setup_multicast
id|gem_setup_multicast
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u32
id|rxcfg
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|gp-&gt;dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|gp-&gt;dev-&gt;mc_count
OG
l_int|256
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH0
op_plus
(paren
id|i
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|rxcfg
op_or_assign
id|MAC_RXCFG_HFE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gp-&gt;dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|rxcfg
op_or_assign
id|MAC_RXCFG_PROM
suffix:semicolon
)brace
r_else
(brace
id|u16
id|hash_table
(braket
l_int|16
)braket
suffix:semicolon
id|u32
id|crc
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|gp-&gt;dev-&gt;mc_list
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|gp-&gt;dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
op_star
id|addrs
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addrs
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|crc
op_assign
id|ether_crc_le
c_func
(paren
l_int|6
comma
id|addrs
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|24
suffix:semicolon
id|hash_table
(braket
id|crc
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
l_int|15
op_minus
(paren
id|crc
op_amp
l_int|0xf
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|writel
c_func
(paren
id|hash_table
(braket
id|i
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH0
op_plus
(paren
id|i
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|rxcfg
op_or_assign
id|MAC_RXCFG_HFE
suffix:semicolon
)brace
r_return
id|rxcfg
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_init_mac
r_static
r_void
id|gem_init_mac
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_int
r_char
op_star
id|e
op_assign
op_amp
id|gp-&gt;dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_SUN
op_logical_and
id|gp-&gt;pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_GEM
)paren
id|writel
c_func
(paren
l_int|0x1bf0
comma
id|gp-&gt;regs
op_plus
id|MAC_SNDPAUSE
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x00
comma
id|gp-&gt;regs
op_plus
id|MAC_IPG0
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x08
comma
id|gp-&gt;regs
op_plus
id|MAC_IPG1
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x04
comma
id|gp-&gt;regs
op_plus
id|MAC_IPG2
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x40
comma
id|gp-&gt;regs
op_plus
id|MAC_STIME
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x40
comma
id|gp-&gt;regs
op_plus
id|MAC_MINFSZ
)paren
suffix:semicolon
multiline_comment|/* Ethernet payload + header + FCS + optional VLAN tag. */
id|writel
c_func
(paren
l_int|0x20000000
op_or
(paren
id|gp-&gt;dev-&gt;mtu
op_plus
id|ETH_HLEN
op_plus
l_int|4
op_plus
l_int|4
)paren
comma
id|gp-&gt;regs
op_plus
id|MAC_MAXFSZ
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x07
comma
id|gp-&gt;regs
op_plus
id|MAC_PASIZE
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x04
comma
id|gp-&gt;regs
op_plus
id|MAC_JAMSIZE
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x10
comma
id|gp-&gt;regs
op_plus
id|MAC_ATTLIM
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x8808
comma
id|gp-&gt;regs
op_plus
id|MAC_MCTYPE
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|e
(braket
l_int|5
)braket
op_or
(paren
id|e
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
)paren
op_amp
l_int|0x3ff
comma
id|gp-&gt;regs
op_plus
id|MAC_RANDSEED
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|e
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|5
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR0
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|e
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|3
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR1
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|e
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|1
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR2
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR3
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR4
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR5
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x0001
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR6
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xc200
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR7
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x0180
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR8
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AFILT0
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AFILT1
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AFILT2
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AF21MSK
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AF0MSK
)paren
suffix:semicolon
id|gp-&gt;mac_rx_cfg
op_assign
id|gem_setup_multicast
c_func
(paren
id|gp
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_NCOLL
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_FASUCC
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_ECOLL
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_LCOLL
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_DTIMER
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_PATMPS
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_RFCTR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_LERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_FCSERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCVERR
)paren
suffix:semicolon
multiline_comment|/* Clear RX/TX/MAC/XIF config, we will set these up and enable&n;&t; * them once a link is established.&n;&t; */
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|gp-&gt;mac_rx_cfg
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_MCCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_XIFCFG
)paren
suffix:semicolon
multiline_comment|/* Setup MAC interrupts.  We want to get all of the interesting&n;&t; * counter expiration events, but we do not want to hear about&n;&t; * normal rx/tx as the DMA engine tells us that.&n;&t; */
id|writel
c_func
(paren
id|MAC_TXSTAT_XMIT
comma
id|gp-&gt;regs
op_plus
id|MAC_TXMASK
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MAC_RXSTAT_RCV
comma
id|gp-&gt;regs
op_plus
id|MAC_RXMASK
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t enable even the PAUSE interrupts for now, we&n;&t; * make no use of those events other than to record them.&n;&t; */
id|writel
c_func
(paren
l_int|0xffffffff
comma
id|gp-&gt;regs
op_plus
id|MAC_MCMASK
)paren
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_init_pause_thresholds
r_static
r_void
id|gem_init_pause_thresholds
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
multiline_comment|/* Calculate pause thresholds.  Setting the OFF threshold to the&n;&t; * full RX fifo size effectively disables PAUSE generation which&n;&t; * is what we do for 10/100 only GEMs which have FIFOs too small&n;&t; * to make real gains from PAUSE.&n;&t; */
r_if
c_cond
(paren
id|gp-&gt;rx_fifo_sz
op_le
(paren
l_int|2
op_star
l_int|1024
)paren
)paren
(brace
id|gp-&gt;rx_pause_off
op_assign
id|gp-&gt;rx_pause_on
op_assign
id|gp-&gt;rx_fifo_sz
suffix:semicolon
)brace
r_else
(brace
r_int
id|max_frame
op_assign
(paren
id|gp-&gt;dev-&gt;mtu
op_plus
id|ETH_HLEN
op_plus
l_int|4
op_plus
l_int|4
op_plus
l_int|64
)paren
op_amp
op_complement
l_int|63
suffix:semicolon
r_int
id|off
op_assign
(paren
id|gp-&gt;rx_fifo_sz
op_minus
(paren
id|max_frame
op_star
l_int|2
)paren
)paren
suffix:semicolon
r_int
id|on
op_assign
id|off
op_minus
id|max_frame
suffix:semicolon
id|gp-&gt;rx_pause_off
op_assign
id|off
suffix:semicolon
id|gp-&gt;rx_pause_on
op_assign
id|on
suffix:semicolon
)brace
(brace
id|u32
id|cfg
suffix:semicolon
id|cfg
op_assign
l_int|0
suffix:semicolon
macro_line|#if !defined(CONFIG_SPARC64) &amp;&amp; !defined(CONFIG_ALPHA)
id|cfg
op_or_assign
id|GREG_CFG_IBURST
suffix:semicolon
macro_line|#endif
id|cfg
op_or_assign
(paren
(paren
l_int|31
op_lshift
l_int|1
)paren
op_amp
id|GREG_CFG_TXDMALIM
)paren
suffix:semicolon
id|cfg
op_or_assign
(paren
(paren
l_int|31
op_lshift
l_int|6
)paren
op_amp
id|GREG_CFG_RXDMALIM
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cfg
comma
id|gp-&gt;regs
op_plus
id|GREG_CFG
)paren
suffix:semicolon
)brace
)brace
DECL|function|gem_check_invariants
r_static
r_int
id|gem_check_invariants
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|gp-&gt;pdev
suffix:semicolon
id|u32
id|mif_cfg
suffix:semicolon
multiline_comment|/* On Apple&squot;s sungem, we can&squot;t rely on registers as the chip&n;&t; * was been powered down by the firmware. The PHY is looked&n;&t; * up later on.&n;&t; */
r_if
c_cond
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
)paren
(brace
id|gp-&gt;phy_type
op_assign
id|phy_mii_mdio0
suffix:semicolon
id|gp-&gt;tx_fifo_sz
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|TXDMA_FSZ
)paren
op_star
l_int|64
suffix:semicolon
id|gp-&gt;rx_fifo_sz
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|RXDMA_FSZ
)paren
op_star
l_int|64
suffix:semicolon
id|gp-&gt;swrst_base
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mif_cfg
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_SUN
op_logical_and
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_RIO_GEM
)paren
(brace
multiline_comment|/* One of the MII PHYs _must_ be present&n;&t;&t; * as this chip has no gigabit PHY.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|mif_cfg
op_amp
(paren
id|MIF_CFG_MDI0
op_or
id|MIF_CFG_MDI1
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;RIO GEM lacks MII phy, mif_cfg[%08x]&bslash;n&quot;
comma
id|mif_cfg
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Determine initial PHY interface type guess.  MDIO1 is the&n;&t; * external PHY and thus takes precedence over MDIO0.&n;&t; */
r_if
c_cond
(paren
id|mif_cfg
op_amp
id|MIF_CFG_MDI1
)paren
(brace
id|gp-&gt;phy_type
op_assign
id|phy_mii_mdio1
suffix:semicolon
id|mif_cfg
op_or_assign
id|MIF_CFG_PSELECT
suffix:semicolon
id|writel
c_func
(paren
id|mif_cfg
comma
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mif_cfg
op_amp
id|MIF_CFG_MDI0
)paren
(brace
id|gp-&gt;phy_type
op_assign
id|phy_mii_mdio0
suffix:semicolon
id|mif_cfg
op_and_assign
op_complement
id|MIF_CFG_PSELECT
suffix:semicolon
id|writel
c_func
(paren
id|mif_cfg
comma
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
)brace
r_else
(brace
id|gp-&gt;phy_type
op_assign
id|phy_serialink
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|gp-&gt;mii_phy_addr
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
)paren
op_ne
l_int|0xffff
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|32
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;device
op_ne
id|PCI_DEVICE_ID_SUN_GEM
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;RIO MII phy will not respond.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|gp-&gt;phy_type
op_assign
id|phy_serdes
suffix:semicolon
)brace
)brace
multiline_comment|/* Fetch the FIFO configurations now too. */
id|gp-&gt;tx_fifo_sz
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|TXDMA_FSZ
)paren
op_star
l_int|64
suffix:semicolon
id|gp-&gt;rx_fifo_sz
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|RXDMA_FSZ
)paren
op_star
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_SUN
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_GEM
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;tx_fifo_sz
op_ne
(paren
l_int|9
op_star
l_int|1024
)paren
op_logical_or
id|gp-&gt;rx_fifo_sz
op_ne
(paren
l_int|20
op_star
l_int|1024
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;GEM has bogus fifo sizes tx(%d) rx(%d)&bslash;n&quot;
comma
id|gp-&gt;tx_fifo_sz
comma
id|gp-&gt;rx_fifo_sz
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|gp-&gt;swrst_base
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|gp-&gt;tx_fifo_sz
op_ne
(paren
l_int|2
op_star
l_int|1024
)paren
op_logical_or
id|gp-&gt;rx_fifo_sz
op_ne
(paren
l_int|2
op_star
l_int|1024
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;RIO GEM has bogus fifo sizes tx(%d) rx(%d)&bslash;n&quot;
comma
id|gp-&gt;tx_fifo_sz
comma
id|gp-&gt;rx_fifo_sz
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|gp-&gt;swrst_base
op_assign
(paren
l_int|64
op_div
l_int|4
)paren
op_lshift
id|GREG_SWRST_CACHE_SHIFT
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_init_hw
r_static
r_void
id|gem_init_hw
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
id|restart_link
)paren
(brace
multiline_comment|/* On Apple&squot;s gmac, I initialize the PHY only after&n;&t; * setting up the chip. It appears the gigabit PHYs&n;&t; * don&squot;t quite like beeing talked to on the GII when&n;&t; * the chip is not running, I suspect it might not&n;&t; * be clocked at that point. --BenH&n;&t; */
r_if
c_cond
(paren
id|restart_link
)paren
id|gem_init_phy
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gem_init_dma
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gem_init_mac
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gem_init_pause_thresholds
c_func
(paren
id|gp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|restart_link
)paren
(brace
multiline_comment|/* Default aneg parameters */
id|gp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|gp-&gt;lstate
op_assign
id|link_down
suffix:semicolon
multiline_comment|/* Can I advertise gigabit here ? I&squot;d need BCM PHY docs... */
id|gem_begin_auto_negotiation
c_func
(paren
id|gp
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|gp-&gt;lstate
op_eq
id|link_up
)paren
id|gem_set_link_modes
c_func
(paren
id|gp
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_ALL_PPC
multiline_comment|/* Enable the chip&squot;s clock and make sure it&squot;s config space is&n; * setup properly. There appear to be no need to restore the&n; * base addresses.&n; */
DECL|function|gem_apple_powerup
r_static
r_void
id|gem_apple_powerup
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u16
id|cmd
suffix:semicolon
id|u32
id|mif_cfg
suffix:semicolon
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_GMAC_ENABLE
comma
id|gp-&gt;of_node
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
(paren
l_int|21
op_star
id|HZ
)paren
op_div
l_int|1000
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|gp-&gt;pdev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_or_assign
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_INVALIDATE
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|gp-&gt;pdev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|gp-&gt;pdev
comma
id|PCI_LATENCY_TIMER
comma
l_int|6
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|gp-&gt;pdev
comma
id|PCI_CACHE_LINE_SIZE
comma
l_int|8
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|mif_cfg
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
id|mif_cfg
op_and_assign
op_complement
(paren
id|MIF_CFG_PSELECT
op_or
id|MIF_CFG_POLL
op_or
id|MIF_CFG_BBMODE
op_or
id|MIF_CFG_MDI1
)paren
suffix:semicolon
id|mif_cfg
op_or_assign
id|MIF_CFG_MDI0
suffix:semicolon
id|writel
c_func
(paren
id|mif_cfg
comma
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|PCS_DMODE_MGM
comma
id|gp-&gt;regs
op_plus
id|PCS_DMODE
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MAC_XIFCFG_OE
comma
id|gp-&gt;regs
op_plus
id|MAC_XIFCFG
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Turn off the chip&squot;s clock */
DECL|function|gem_apple_powerdown
r_static
r_void
id|gem_apple_powerdown
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_GMAC_ENABLE
comma
id|gp-&gt;of_node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ALL_PPC */
multiline_comment|/* Must be invoked under gp-&gt;lock. */
DECL|function|gem_stop_phy
r_static
r_void
id|gem_stop_phy
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u32
id|mifcfg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;wake_on_lan
op_logical_and
id|gp-&gt;phy_mod
op_eq
id|phymod_bcm5201
)paren
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5201_INTERRUPT
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Make sure we aren&squot;t polling PHY status change. We&n;&t; * don&squot;t currently use that feature though&n;&t; */
id|mifcfg
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
id|mifcfg
op_and_assign
op_complement
id|MIF_CFG_POLL
suffix:semicolon
id|writel
c_func
(paren
id|mifcfg
comma
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
multiline_comment|/* Here&squot;s a strange hack used by both MacOS 9 and X */
id|phy_write
c_func
(paren
id|gp
comma
id|MII_LPA
comma
id|phy_read
c_func
(paren
id|gp
comma
id|MII_LPA
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;wake_on_lan
)paren
(brace
multiline_comment|/* Setup wake-on-lan */
)brace
r_else
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_XIFCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|TXDMA_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;wake_on_lan
)paren
(brace
id|gem_stop
c_func
(paren
id|gp
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MAC_TXRST_CMD
comma
id|gp-&gt;regs
op_plus
id|MAC_TXRST
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MAC_RXRST_CMD
comma
id|gp-&gt;regs
op_plus
id|MAC_RXRST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;phy_mod
op_eq
id|phymod_bcm5400
op_logical_or
id|gp-&gt;phy_mod
op_eq
id|phymod_bcm5401
op_logical_or
id|gp-&gt;phy_mod
op_eq
id|phymod_bcm5411
)paren
(brace
macro_line|#if 0 /* Commented out in Darwin... someone has those dawn docs ? */
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|BMCR_PDOWN
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|gp-&gt;phy_mod
op_eq
id|phymod_bcm5201
op_logical_or
id|gp-&gt;phy_mod
op_eq
id|phymod_bcm5221
)paren
(brace
macro_line|#if 0 /* Commented out in Darwin... someone has those dawn docs ? */
id|u16
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BCM5201_AUXMODE2
)paren
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5201_AUXMODE2
comma
id|val
op_amp
op_complement
id|MII_BCM5201_AUXMODE2_LOWPOWER
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BCM5201_MULTIPHY
comma
id|MII_BCM5201_MULTIPHY_SUPERISOLATE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gp-&gt;phy_mod
op_eq
id|phymod_m1011
)paren
id|phy_write
c_func
(paren
id|gp
comma
id|MII_BMCR
comma
id|BMCR_PDOWN
)paren
suffix:semicolon
multiline_comment|/* According to Apple, we must set the MDIO pins to this begnign&n;&t;&t; * state or we may 1) eat more current, 2) damage some PHYs&n;&t;&t; */
id|writel
c_func
(paren
id|mifcfg
op_or
id|MIF_CFG_BBMODE
comma
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MIF_BBCLK
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MIF_BBDATA
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MIF_BBOENAB
)paren
suffix:semicolon
id|writel
c_func
(paren
id|MAC_XIFCFG_GMII
op_or
id|MAC_XIFCFG_LBCK
comma
id|gp-&gt;regs
op_plus
id|MAC_XIFCFG
)paren
suffix:semicolon
(paren
r_void
)paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_XIFCFG
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Shut down the chip, must be called with pm_sem held.  */
DECL|function|gem_shutdown
r_static
r_void
id|gem_shutdown
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
multiline_comment|/* Make us not-running to avoid timers respawning */
id|gp-&gt;hw_running
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Stop the link timer */
id|del_timer_sync
c_func
(paren
op_amp
id|gp-&gt;link_timer
)paren
suffix:semicolon
multiline_comment|/* Stop the reset task */
r_while
c_loop
(paren
id|gp-&gt;reset_task_pending
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Actually stop the chip */
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
)paren
(brace
id|gem_stop_phy
c_func
(paren
id|gp
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ALL_PPC
multiline_comment|/* Power down the chip */
id|gem_apple_powerdown
c_func
(paren
id|gp
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ALL_PPC */
)brace
r_else
(brace
id|gem_stop
c_func
(paren
id|gp
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
)brace
)brace
DECL|function|gem_pm_task
r_static
r_void
id|gem_pm_task
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
(paren
r_struct
id|gem
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* We assume if we can&squot;t lock the pm_sem, then open() was&n;&t; * called again (or suspend()), and we can safely ignore&n;&t; * the PM request&n;&t; */
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Driver was re-opened or already shut down */
r_if
c_cond
(paren
id|gp-&gt;opened
op_logical_or
op_logical_neg
id|gp-&gt;hw_running
)paren
(brace
id|up
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|gem_shutdown
c_func
(paren
id|gp
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
)brace
DECL|function|gem_pm_timer
r_static
r_void
id|gem_pm_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
(paren
r_struct
id|gem
op_star
)paren
id|data
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|gp-&gt;pm_task
)paren
suffix:semicolon
)brace
DECL|function|gem_open
r_static
r_int
id|gem_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|hw_was_up
suffix:semicolon
id|down
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
id|hw_was_up
op_assign
id|gp-&gt;hw_running
suffix:semicolon
multiline_comment|/* Stop the PM timer/task */
id|del_timer
c_func
(paren
op_amp
id|gp-&gt;pm_timer
)paren
suffix:semicolon
id|flush_scheduled_tasks
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* The power-management semaphore protects the hw_running&n;&t; * etc. state so it is safe to do this bit without gp-&gt;lock&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;hw_running
)paren
(brace
macro_line|#ifdef CONFIG_ALL_PPC
multiline_comment|/* First, we need to bring up the chip */
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
)paren
(brace
id|gem_apple_powerup
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gem_check_invariants
c_func
(paren
id|gp
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ALL_PPC */
multiline_comment|/* Reset the chip */
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gem_stop
c_func
(paren
id|gp
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gp-&gt;hw_running
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* We can now request the interrupt as we know it&squot;s masked&n;&t; * on the controller&n;&t; */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|gp-&gt;pdev-&gt;irq
comma
id|gem_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
(brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: failed to request irq !&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ALL_PPC
r_if
c_cond
(paren
op_logical_neg
id|hw_was_up
op_logical_and
id|gp-&gt;pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
)paren
id|gem_apple_powerdown
c_func
(paren
id|gp
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ALL_PPC */
multiline_comment|/* Fire the PM timer that will shut us down in about 10 seconds */
id|gp-&gt;pm_timer.expires
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|gp-&gt;pm_timer
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Allocate &amp; setup ring buffers */
id|gem_init_rings
c_func
(paren
id|gp
)paren
suffix:semicolon
multiline_comment|/* Init &amp; setup chip hardware */
id|gem_init_hw
c_func
(paren
id|gp
comma
op_logical_neg
id|hw_was_up
)paren
suffix:semicolon
id|gp-&gt;opened
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_close
r_static
r_int
id|gem_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Make sure we don&squot;t get distracted by suspend/resume */
id|down
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
multiline_comment|/* Stop traffic, mark us closed */
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gp-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffffffff
comma
id|gp-&gt;regs
op_plus
id|GREG_IMASK
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Stop chip */
id|gem_stop
c_func
(paren
id|gp
)paren
suffix:semicolon
multiline_comment|/* Get rid of rings */
id|gem_clean_rings
c_func
(paren
id|gp
)paren
suffix:semicolon
multiline_comment|/* Bye, the pm timer will finish the job */
id|free_irq
c_func
(paren
id|gp-&gt;pdev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Fire the PM timer that will shut us down in about 10 seconds */
id|gp-&gt;pm_timer.expires
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|gp-&gt;pm_timer
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
DECL|function|gem_suspend
r_static
r_int
id|gem_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* We hold the PM semaphore during entire driver&n;&t; * sleep time&n;&t; */
id|down
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: suspending, WakeOnLan %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|gp-&gt;wake_on_lan
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
multiline_comment|/* If the driver is opened, we stop the DMA */
r_if
c_cond
(paren
id|gp-&gt;opened
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Stop traffic, mark us closed */
id|netif_device_detach
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffffffff
comma
id|gp-&gt;regs
op_plus
id|GREG_IMASK
)paren
suffix:semicolon
multiline_comment|/* Stop chip */
id|gem_stop
c_func
(paren
id|gp
)paren
suffix:semicolon
multiline_comment|/* Get rid of ring buffers */
id|gem_clean_rings
c_func
(paren
id|gp
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
)paren
id|disable_irq
c_func
(paren
id|gp-&gt;pdev-&gt;irq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gp-&gt;hw_running
)paren
(brace
multiline_comment|/* Kill PM timer if any */
id|del_timer_sync
c_func
(paren
op_amp
id|gp-&gt;pm_timer
)paren
suffix:semicolon
id|flush_scheduled_tasks
c_func
(paren
)paren
suffix:semicolon
id|gem_shutdown
c_func
(paren
id|gp
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_resume
r_static
r_int
id|gem_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: resuming&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;opened
)paren
(brace
macro_line|#ifdef CONFIG_ALL_PPC
multiline_comment|/* First, we need to bring up the chip */
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
)paren
(brace
id|gem_apple_powerup
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gem_check_invariants
c_func
(paren
id|gp
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ALL_PPC */
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gem_stop
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gp-&gt;hw_running
op_assign
l_int|1
suffix:semicolon
id|gem_init_rings
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gem_init_hw
c_func
(paren
id|gp
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|netif_device_attach
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
)paren
id|enable_irq
c_func
(paren
id|gp-&gt;pdev-&gt;irq
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PM */
DECL|function|gem_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|gem_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|gp-&gt;net_stats
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;hw_running
)paren
(brace
id|stats-&gt;rx_crc_errors
op_add_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_FCSERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_FCSERR
)paren
suffix:semicolon
id|stats-&gt;rx_frame_errors
op_add_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_AERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AERR
)paren
suffix:semicolon
id|stats-&gt;rx_length_errors
op_add_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_LERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_LERR
)paren
suffix:semicolon
id|stats-&gt;tx_aborted_errors
op_add_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_ECOLL
)paren
suffix:semicolon
id|stats-&gt;collisions
op_add_assign
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_ECOLL
)paren
op_plus
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_LCOLL
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_ECOLL
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_LCOLL
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_return
op_amp
id|gp-&gt;net_stats
suffix:semicolon
)brace
DECL|function|gem_set_multicast
r_static
r_void
id|gem_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|rxcfg
comma
id|rxcfg_new
suffix:semicolon
r_int
id|limit
op_assign
l_int|10000
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;hw_running
)paren
r_return
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rxcfg
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|gp-&gt;mac_rx_cfg
op_assign
id|rxcfg_new
op_assign
id|gem_setup_multicast
c_func
(paren
id|gp
)paren
suffix:semicolon
id|writel
c_func
(paren
id|rxcfg
op_amp
op_complement
id|MAC_RXCFG_ENAB
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
op_amp
id|MAC_RXCFG_ENAB
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|limit
op_decrement
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|rxcfg
op_and_assign
op_complement
(paren
id|MAC_RXCFG_PROM
op_or
id|MAC_RXCFG_HFE
)paren
suffix:semicolon
id|rxcfg
op_or_assign
id|rxcfg_new
suffix:semicolon
id|writel
c_func
(paren
id|rxcfg
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* Eventually add support for changing the advertisement&n; * on autoneg.&n; */
DECL|function|gem_ethtool_ioctl
r_static
r_int
id|gem_ethtool_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|ep_user
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u16
id|bmcr
suffix:semicolon
r_int
id|full_duplex
comma
id|speed
comma
id|pause
suffix:semicolon
r_struct
id|ethtool_cmd
id|ecmd
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ecmd
comma
id|ep_user
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|ecmd.cmd
)paren
(brace
r_case
id|ETHTOOL_GDRVINFO
suffix:colon
(brace
r_struct
id|ethtool_drvinfo
id|info
op_assign
(brace
id|cmd
suffix:colon
id|ETHTOOL_GDRVINFO
)brace
suffix:semicolon
id|strncpy
c_func
(paren
id|info.driver
comma
id|DRV_NAME
comma
id|ETHTOOL_BUSINFO_LEN
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.version
comma
id|DRV_VERSION
comma
id|ETHTOOL_BUSINFO_LEN
)paren
suffix:semicolon
id|info.fw_version
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strncpy
c_func
(paren
id|info.bus_info
comma
id|gp-&gt;pdev-&gt;slot_name
comma
id|ETHTOOL_BUSINFO_LEN
)paren
suffix:semicolon
id|info.regdump_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*SUNGEM_NREGS;*/
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ep_user
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|ETHTOOL_GSET
suffix:colon
id|ecmd.supported
op_assign
(paren
id|SUPPORTED_10baseT_Half
op_or
id|SUPPORTED_10baseT_Full
op_or
id|SUPPORTED_100baseT_Half
op_or
id|SUPPORTED_100baseT_Full
op_or
id|SUPPORTED_Autoneg
op_or
id|SUPPORTED_TP
op_or
id|SUPPORTED_MII
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;gigabit_capable
)paren
id|ecmd.supported
op_or_assign
(paren
id|SUPPORTED_1000baseT_Half
op_or
id|SUPPORTED_1000baseT_Full
)paren
suffix:semicolon
multiline_comment|/* XXX hardcoded stuff for now */
id|ecmd.port
op_assign
id|PORT_MII
suffix:semicolon
id|ecmd.transceiver
op_assign
id|XCVR_EXTERNAL
suffix:semicolon
id|ecmd.phy_address
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX fixed PHYAD */
multiline_comment|/* Record PHY settings if HW is on. */
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;hw_running
)paren
(brace
id|bmcr
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|MII_BMCR
)paren
suffix:semicolon
id|gem_read_mii_link_mode
c_func
(paren
id|gp
comma
op_amp
id|full_duplex
comma
op_amp
id|speed
comma
op_amp
id|pause
)paren
suffix:semicolon
)brace
r_else
id|bmcr
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bmcr
op_amp
id|BMCR_ANENABLE
)paren
(brace
id|ecmd.autoneg
op_assign
id|AUTONEG_ENABLE
suffix:semicolon
id|ecmd.speed
op_assign
id|speed
op_eq
l_int|10
ques
c_cond
id|SPEED_10
suffix:colon
(paren
id|speed
op_eq
l_int|1000
ques
c_cond
id|SPEED_1000
suffix:colon
id|SPEED_100
)paren
suffix:semicolon
id|ecmd.duplex
op_assign
id|full_duplex
ques
c_cond
id|DUPLEX_FULL
suffix:colon
id|DUPLEX_HALF
suffix:semicolon
)brace
r_else
(brace
id|ecmd.autoneg
op_assign
id|AUTONEG_DISABLE
suffix:semicolon
id|ecmd.speed
op_assign
(paren
id|bmcr
op_amp
id|BMCR_SPEED100
)paren
ques
c_cond
id|SPEED_100
suffix:colon
id|SPEED_10
suffix:semicolon
id|ecmd.duplex
op_assign
(paren
id|bmcr
op_amp
id|BMCR_FULLDPLX
)paren
ques
c_cond
id|DUPLEX_FULL
suffix:colon
id|DUPLEX_HALF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ep_user
comma
op_amp
id|ecmd
comma
r_sizeof
(paren
id|ecmd
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ETHTOOL_SSET
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* Verify the settings we care about. */
r_if
c_cond
(paren
id|ecmd.autoneg
op_ne
id|AUTONEG_ENABLE
op_logical_and
id|ecmd.autoneg
op_ne
id|AUTONEG_DISABLE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ecmd.autoneg
op_eq
id|AUTONEG_DISABLE
op_logical_and
(paren
(paren
id|ecmd.speed
op_ne
id|SPEED_100
op_logical_and
id|ecmd.speed
op_ne
id|SPEED_10
)paren
op_logical_or
(paren
id|ecmd.duplex
op_ne
id|DUPLEX_HALF
op_logical_and
id|ecmd.duplex
op_ne
id|DUPLEX_FULL
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Apply settings and restart link process. */
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gem_begin_auto_negotiation
c_func
(paren
id|gp
comma
op_amp
id|ecmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ETHTOOL_NWAY_RST
suffix:colon
r_if
c_cond
(paren
(paren
id|gp-&gt;link_cntl
op_amp
id|BMCR_ANENABLE
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Restart link process. */
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gem_begin_auto_negotiation
c_func
(paren
id|gp
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ETHTOOL_GWOL
suffix:colon
r_case
id|ETHTOOL_SWOL
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* todo */
multiline_comment|/* get link status */
r_case
id|ETHTOOL_GLINK
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
op_assign
(brace
id|cmd
suffix:colon
id|ETHTOOL_GLINK
)brace
suffix:semicolon
id|edata.data
op_assign
(paren
id|gp-&gt;lstate
op_eq
id|link_up
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ep_user
comma
op_amp
id|edata
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get message-level */
r_case
id|ETHTOOL_GMSGLVL
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
op_assign
(brace
id|cmd
suffix:colon
id|ETHTOOL_GMSGLVL
)brace
suffix:semicolon
id|edata.data
op_assign
id|gp-&gt;msg_enable
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ep_user
comma
op_amp
id|edata
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set message-level */
r_case
id|ETHTOOL_SMSGLVL
suffix:colon
(brace
r_struct
id|ethtool_value
id|edata
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|edata
comma
id|ep_user
comma
r_sizeof
(paren
id|edata
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|gp-&gt;msg_enable
op_assign
id|edata.data
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
r_case
id|ETHTOOL_GREGS
suffix:colon
(brace
r_struct
id|ethtool_regs
id|regs
suffix:semicolon
id|u32
op_star
id|regbuf
suffix:semicolon
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|regs
comma
id|useraddr
comma
r_sizeof
(paren
id|regs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|regs.len
OG
id|SUNGEM_NREGS
)paren
(brace
id|regs.len
op_assign
id|SUNGEM_NREGS
suffix:semicolon
)brace
id|regs.version
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
op_amp
id|regs
comma
r_sizeof
(paren
id|regs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;hw_running
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|useraddr
op_add_assign
m_offsetof
(paren
r_struct
id|ethtool_regs
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Use kmalloc to avoid bloating the stack */
id|regbuf
op_assign
id|kmalloc
c_func
(paren
l_int|4
op_star
id|SUNGEM_NREGS
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|regbuf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
id|gem_get_regs
c_func
(paren
id|gp
comma
id|regbuf
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|np-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|useraddr
comma
id|regbuf
comma
id|regs.len
op_star
r_sizeof
(paren
id|u32
)paren
)paren
)paren
id|r
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|kfree
c_func
(paren
id|regbuf
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
macro_line|#endif&t;
)brace
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|function|gem_ioctl
r_static
r_int
id|gem_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|mii_ioctl_data
op_star
id|data
op_assign
(paren
r_struct
id|mii_ioctl_data
op_star
)paren
op_amp
id|ifr-&gt;ifr_data
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
multiline_comment|/* Hold the PM semaphore while doing ioctl&squot;s or we may collide&n;&t; * with open/close and power management and oops.&n;&t; */
id|down
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCETHTOOL
suffix:colon
id|rc
op_assign
id|gem_ethtool_ioctl
c_func
(paren
id|dev
comma
id|ifr-&gt;ifr_data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGMIIPHY
suffix:colon
multiline_comment|/* Get address of MII PHY in use. */
id|data-&gt;phy_id
op_assign
id|gp-&gt;mii_phy_addr
suffix:semicolon
multiline_comment|/* Fallthrough... */
r_case
id|SIOCGMIIREG
suffix:colon
multiline_comment|/* Read MII PHY register. */
id|data-&gt;val_out
op_assign
id|__phy_read
c_func
(paren
id|gp
comma
id|data-&gt;reg_num
op_amp
l_int|0x1f
comma
id|data-&gt;phy_id
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSMIIREG
suffix:colon
multiline_comment|/* Write MII PHY register. */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_else
(brace
id|__phy_write
c_func
(paren
id|gp
comma
id|data-&gt;reg_num
op_amp
l_int|0x1f
comma
id|data-&gt;val_in
comma
id|data-&gt;phy_id
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
suffix:semicolon
id|up
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#if (!defined(__sparc__) &amp;&amp; !defined(CONFIG_ALL_PPC))
multiline_comment|/* Fetch MAC address from vital product data of PCI ROM. */
DECL|function|find_eth_addr_in_vpd
r_static
r_void
id|find_eth_addr_in_vpd
c_func
(paren
r_void
op_star
id|rom_base
comma
r_int
id|len
comma
r_int
r_char
op_star
id|dev_addr
)paren
(brace
r_int
id|this_offset
suffix:semicolon
r_for
c_loop
(paren
id|this_offset
op_assign
l_int|0x20
suffix:semicolon
id|this_offset
OL
id|len
suffix:semicolon
id|this_offset
op_increment
)paren
(brace
r_void
op_star
id|p
op_assign
id|rom_base
op_plus
id|this_offset
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|p
op_plus
l_int|0
)paren
op_ne
l_int|0x90
op_logical_or
id|readb
c_func
(paren
id|p
op_plus
l_int|1
)paren
op_ne
l_int|0x00
op_logical_or
id|readb
c_func
(paren
id|p
op_plus
l_int|2
)paren
op_ne
l_int|0x09
op_logical_or
id|readb
c_func
(paren
id|p
op_plus
l_int|3
)paren
op_ne
l_int|0x4e
op_logical_or
id|readb
c_func
(paren
id|p
op_plus
l_int|4
)paren
op_ne
l_int|0x41
op_logical_or
id|readb
c_func
(paren
id|p
op_plus
l_int|5
)paren
op_ne
l_int|0x06
)paren
r_continue
suffix:semicolon
id|this_offset
op_add_assign
l_int|6
suffix:semicolon
id|p
op_add_assign
l_int|6
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev_addr
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
id|p
op_plus
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|get_gem_mac_nonobp
r_static
r_void
id|get_gem_mac_nonobp
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_char
op_star
id|dev_addr
)paren
(brace
id|u32
id|rom_reg_orig
suffix:semicolon
r_void
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;resource
(braket
id|PCI_ROM_RESOURCE
)braket
dot
id|parent
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pci_assign_resource
c_func
(paren
id|pdev
comma
id|PCI_ROM_RESOURCE
)paren
OL
l_int|0
)paren
r_goto
id|use_random
suffix:semicolon
)brace
id|pci_read_config_dword
c_func
(paren
id|pdev
comma
id|pdev-&gt;rom_base_reg
comma
op_amp
id|rom_reg_orig
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pdev
comma
id|pdev-&gt;rom_base_reg
comma
id|rom_reg_orig
op_or
id|PCI_ROM_ADDRESS_ENABLE
)paren
suffix:semicolon
id|p
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|PCI_ROM_RESOURCE
)paren
comma
(paren
l_int|64
op_star
l_int|1024
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ne
l_int|NULL
op_logical_and
id|readb
c_func
(paren
id|p
)paren
op_eq
l_int|0x55
op_logical_and
id|readb
c_func
(paren
id|p
op_plus
l_int|1
)paren
op_eq
l_int|0xaa
)paren
id|find_eth_addr_in_vpd
c_func
(paren
id|p
comma
(paren
l_int|64
op_star
l_int|1024
)paren
comma
id|dev_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ne
l_int|NULL
)paren
id|iounmap
c_func
(paren
id|p
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pdev
comma
id|pdev-&gt;rom_base_reg
comma
id|rom_reg_orig
)paren
suffix:semicolon
r_return
suffix:semicolon
id|use_random
suffix:colon
multiline_comment|/* Sun MAC prefix then 3 random bytes. */
id|dev_addr
(braket
l_int|0
)braket
op_assign
l_int|0x08
suffix:semicolon
id|dev_addr
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dev_addr
(braket
l_int|2
)braket
op_assign
l_int|0x20
suffix:semicolon
id|get_random_bytes
c_func
(paren
id|dev_addr
op_plus
l_int|3
comma
l_int|3
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif /* not Sparc and not PPC */
DECL|function|gem_get_device_address
r_static
r_int
id|__devinit
id|gem_get_device_address
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
macro_line|#if defined(__sparc__) || defined(CONFIG_ALL_PPC)
r_struct
id|net_device
op_star
id|dev
op_assign
id|gp-&gt;dev
suffix:semicolon
macro_line|#endif
macro_line|#if defined(__sparc__)
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|gp-&gt;pdev
suffix:semicolon
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_int
id|node
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pcp
op_ne
l_int|NULL
)paren
(brace
id|node
op_assign
id|pcp-&gt;prom_node
suffix:semicolon
r_if
c_cond
(paren
id|prom_getproplen
c_func
(paren
id|node
comma
l_string|&quot;local-mac-address&quot;
)paren
op_eq
l_int|6
)paren
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;local-mac-address&quot;
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
r_else
id|node
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node
op_eq
op_minus
l_int|1
)paren
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|idprom-&gt;id_ethaddr
comma
l_int|6
)paren
suffix:semicolon
macro_line|#elif defined(CONFIG_ALL_PPC)
r_int
r_char
op_star
id|addr
suffix:semicolon
id|addr
op_assign
id|get_property
c_func
(paren
id|gp-&gt;of_node
comma
l_string|&quot;local-mac-address&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t get mac-address&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|addr
comma
id|MAX_ADDR_LEN
)paren
suffix:semicolon
macro_line|#else
id|get_gem_mac_nonobp
c_func
(paren
id|gp-&gt;pdev
comma
id|gp-&gt;dev-&gt;dev_addr
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_init_one
r_static
r_int
id|__devinit
id|gem_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_static
r_int
id|gem_version_printed
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|gemreg_base
comma
id|gemreg_len
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|gem
op_star
id|gp
suffix:semicolon
r_int
id|i
comma
id|err
comma
id|pci_using_dac
suffix:semicolon
r_if
c_cond
(paren
id|gem_version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
multiline_comment|/* Apple gmac note: during probe, the chip is powered up by&n;&t; * the arch code to allow the code below to work (and to let&n;&t; * the chip be probed on the config space. It won&squot;t stay powered&n;&t; * up until the interface is brought up however, so we can&squot;t rely&n;&t; * on register configuration done at this point.&n;&t; */
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Cannot enable MMIO operation, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/* Configure DMA attributes. */
multiline_comment|/* All of the GEM documentation states that 64-bit DMA addressing&n;&t; * is fully supported and should work just fine.  However the&n;&t; * front end for RIO based GEMs is different and only supports&n;&t; * 32-bit addressing.&n;&t; *&n;&t; * For now we assume the various PPC GEMs are 32-bit only as well.&n;&t; */
r_if
c_cond
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_SUN
op_logical_and
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_GEM
op_logical_and
op_logical_neg
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
(paren
id|u64
)paren
l_int|0xffffffffffffffff
)paren
)paren
(brace
id|pci_using_dac
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|err
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
(paren
id|u64
)paren
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No usable DMA configuration, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|pci_using_dac
op_assign
l_int|0
suffix:semicolon
)brace
id|gemreg_base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|gemreg_len
op_assign
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|IORESOURCE_IO
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Cannot find proper PCI device &quot;
l_string|&quot;base address, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
op_star
id|gp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Etherdev alloc failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|dev-&gt;name
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Cannot obtain PCI resources, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_free_netdev
suffix:semicolon
)brace
id|gp-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
r_int
)paren
id|pdev
suffix:semicolon
id|gp-&gt;dev
op_assign
id|dev
suffix:semicolon
id|gp-&gt;msg_enable
op_assign
(paren
id|gem_debug
OL
l_int|0
ques
c_cond
id|DEFAULT_MSG
suffix:colon
id|gem_debug
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|gp-&gt;link_timer
)paren
suffix:semicolon
id|gp-&gt;link_timer.function
op_assign
id|gem_link_timer
suffix:semicolon
id|gp-&gt;link_timer.data
op_assign
(paren
r_int
r_int
)paren
id|gp
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|gp-&gt;pm_timer
)paren
suffix:semicolon
id|gp-&gt;pm_timer.function
op_assign
id|gem_pm_timer
suffix:semicolon
id|gp-&gt;pm_timer.data
op_assign
(paren
r_int
r_int
)paren
id|gp
suffix:semicolon
id|INIT_TQUEUE
c_func
(paren
op_amp
id|gp-&gt;pm_task
comma
id|gem_pm_task
comma
id|gp
)paren
suffix:semicolon
id|INIT_TQUEUE
c_func
(paren
op_amp
id|gp-&gt;reset_task
comma
id|gem_reset_task
comma
id|gp
)paren
suffix:semicolon
multiline_comment|/* Default link parameters */
r_if
c_cond
(paren
id|link_mode
op_ge
l_int|0
op_logical_and
id|link_mode
op_le
l_int|6
)paren
id|gp-&gt;link_cntl
op_assign
id|link_modes
(braket
id|link_mode
)braket
suffix:semicolon
r_else
id|gp-&gt;link_cntl
op_assign
id|BMCR_ANENABLE
suffix:semicolon
id|gp-&gt;lstate
op_assign
id|link_down
suffix:semicolon
id|gp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|gp-&gt;regs
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|gemreg_base
comma
id|gemreg_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;regs
op_eq
l_int|0UL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Cannot map device registers, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_free_res
suffix:semicolon
)brace
multiline_comment|/* On Apple, we power the chip up now in order for check&n;&t; * invariants to work, but also because the firmware might&n;&t; * not have properly shut down the PHY.&n;&t; */
macro_line|#ifdef CONFIG_ALL_PPC
r_if
c_cond
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
)paren
id|gem_apple_powerup
c_func
(paren
id|gp
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gem_stop
c_func
(paren
id|gp
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gem_check_invariants
c_func
(paren
id|gp
)paren
)paren
r_goto
id|err_out_iounmap
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gp-&gt;hw_running
op_assign
l_int|1
suffix:semicolon
id|gem_init_phy
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gem_begin_auto_negotiation
c_func
(paren
id|gp
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* It is guarenteed that the returned buffer will be at least&n;&t; * PAGE_SIZE aligned.&n;&t; */
id|gp-&gt;init_block
op_assign
(paren
r_struct
id|gem_init_block
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
r_sizeof
(paren
r_struct
id|gem_init_block
)paren
comma
op_amp
id|gp-&gt;gblock_dvma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;init_block
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Cannot allocate init block, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_iounmap
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ALL_PPC
id|gp-&gt;of_node
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|pdev
)paren
suffix:semicolon
macro_line|#endif&t;
r_if
c_cond
(paren
id|gem_get_device_address
c_func
(paren
id|gp
)paren
)paren
r_goto
id|err_out_free_consistent
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Cannot register net device, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_free_consistent
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sun GEM (PCI) 10/100/1000BaseT Ethernet &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x%c&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|i
op_eq
l_int|5
ques
c_cond
l_char|&squot; &squot;
suffix:colon
l_char|&squot;:&squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|gem_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|gem_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|gem_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|gem_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|gem_set_multicast
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|gem_ioctl
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|gem_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|gem_change_mtu
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* GEM can do it all... */
id|dev-&gt;features
op_or_assign
id|NETIF_F_SG
op_or
id|NETIF_F_HW_CSUM
suffix:semicolon
r_if
c_cond
(paren
id|pci_using_dac
)paren
id|dev-&gt;features
op_or_assign
id|NETIF_F_HIGHDMA
suffix:semicolon
multiline_comment|/* Fire the PM timer that will shut us down in about 10 seconds */
id|gp-&gt;pm_timer.expires
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|gp-&gt;pm_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_free_consistent
suffix:colon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
r_sizeof
(paren
r_struct
id|gem_init_block
)paren
comma
id|gp-&gt;init_block
comma
id|gp-&gt;gblock_dvma
)paren
suffix:semicolon
id|err_out_iounmap
suffix:colon
id|down
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
multiline_comment|/* Stop the PM timer &amp; task */
id|del_timer_sync
c_func
(paren
op_amp
id|gp-&gt;pm_timer
)paren
suffix:semicolon
id|flush_scheduled_tasks
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;hw_running
)paren
id|gem_shutdown
c_func
(paren
id|gp
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|gp-&gt;regs
)paren
suffix:semicolon
id|err_out_free_res
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out_free_netdev
suffix:colon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|gem_remove_one
r_static
r_void
id|__devexit
id|gem_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
multiline_comment|/* Stop the PM timer &amp; task */
id|del_timer_sync
c_func
(paren
op_amp
id|gp-&gt;pm_timer
)paren
suffix:semicolon
id|flush_scheduled_tasks
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;hw_running
)paren
id|gem_shutdown
c_func
(paren
id|gp
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|gp-&gt;pm_sem
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
r_sizeof
(paren
r_struct
id|gem_init_block
)paren
comma
id|gp-&gt;init_block
comma
id|gp-&gt;gblock_dvma
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|gp-&gt;regs
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
DECL|variable|gem_driver
r_static
r_struct
id|pci_driver
id|gem_driver
op_assign
(brace
id|name
suffix:colon
id|GEM_MODULE_NAME
comma
id|id_table
suffix:colon
id|gem_pci_tbl
comma
id|probe
suffix:colon
id|gem_init_one
comma
id|remove
suffix:colon
id|__devexit_p
c_func
(paren
id|gem_remove_one
)paren
comma
macro_line|#ifdef CONFIG_PM
id|suspend
suffix:colon
id|gem_suspend
comma
id|resume
suffix:colon
id|gem_resume
comma
macro_line|#endif /* CONFIG_PM */
)brace
suffix:semicolon
DECL|function|gem_init
r_static
r_int
id|__init
id|gem_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|gem_driver
)paren
suffix:semicolon
)brace
DECL|function|gem_cleanup
r_static
r_void
id|__exit
id|gem_cleanup
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|gem_driver
)paren
suffix:semicolon
)brace
DECL|variable|gem_init
id|module_init
c_func
(paren
id|gem_init
)paren
suffix:semicolon
DECL|variable|gem_cleanup
id|module_exit
c_func
(paren
id|gem_cleanup
)paren
suffix:semicolon
eof
