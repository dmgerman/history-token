multiline_comment|/* $Id: sungem.c,v 1.11 2001/04/04 14:49:40 davem Exp $&n; * sungem.c: Sun GEM ethernet driver.&n; *&n; * Copyright (C) 2000, 2001 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#ifdef __sparc__
macro_line|#include &lt;asm/idprom.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#endif
macro_line|#include &quot;sungem.h&quot;
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;sungem.c:v0.75 21/Mar/01 David S. Miller (davem@redhat.com)&bslash;n&quot;
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;David S. Miller (davem@redhat.com)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Sun GEM Gbit ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|gem_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|GEM_MODULE_NAME
mdefine_line|#define GEM_MODULE_NAME&t;&quot;gem&quot;
DECL|macro|PFX
mdefine_line|#define PFX GEM_MODULE_NAME &quot;: &quot;
macro_line|#ifdef GEM_DEBUG
DECL|variable|gem_debug
r_int
id|gem_debug
op_assign
id|GEM_DEBUG
suffix:semicolon
macro_line|#else
DECL|variable|gem_debug
r_int
id|gem_debug
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|gem_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_SUN
comma
id|PCI_DEVICE_ID_SUN_GEM
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0UL
)brace
comma
multiline_comment|/* These models only differ from the original GEM in&n;&t; * that their tx/rx fifos are of a different size and&n;&t; * they only support 10/100 speeds. -DaveM&n;&t; */
(brace
id|PCI_VENDOR_ID_SUN
comma
id|PCI_DEVICE_ID_SUN_RIO_GEM
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0UL
)brace
comma
macro_line|#if 0
multiline_comment|/* Need to figure this one out. */
(brace
id|PCI_VENDOR_ID_SUN
comma
id|PCI_DEVICE_ID_SUN_PPC_GEM
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0UL
)brace
comma
macro_line|#endif
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|gem_pci_tbl
)paren
suffix:semicolon
DECL|function|phy_read
r_static
id|u16
id|phy_read
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
id|reg
)paren
(brace
id|u32
id|cmd
suffix:semicolon
r_int
id|limit
op_assign
l_int|10000
suffix:semicolon
id|cmd
op_assign
(paren
l_int|1
op_lshift
l_int|30
)paren
suffix:semicolon
id|cmd
op_or_assign
(paren
l_int|2
op_lshift
l_int|28
)paren
suffix:semicolon
id|cmd
op_or_assign
(paren
id|gp-&gt;mii_phy_addr
op_lshift
l_int|23
)paren
op_amp
id|MIF_FRAME_PHYAD
suffix:semicolon
id|cmd
op_or_assign
(paren
id|reg
op_lshift
l_int|18
)paren
op_amp
id|MIF_FRAME_REGAD
suffix:semicolon
id|cmd
op_or_assign
(paren
id|MIF_FRAME_TAMSB
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cmd
comma
id|gp-&gt;regs
op_plus
id|MIF_FRAME
)paren
suffix:semicolon
r_while
c_loop
(paren
id|limit
op_decrement
)paren
(brace
id|cmd
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MIF_FRAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_amp
id|MIF_FRAME_TALSB
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|limit
)paren
id|cmd
op_assign
l_int|0xffff
suffix:semicolon
r_return
id|cmd
op_amp
id|MIF_FRAME_DATA
suffix:semicolon
)brace
DECL|function|phy_write
r_static
r_void
id|phy_write
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
id|reg
comma
id|u16
id|val
)paren
(brace
id|u32
id|cmd
suffix:semicolon
r_int
id|limit
op_assign
l_int|10000
suffix:semicolon
id|cmd
op_assign
(paren
l_int|1
op_lshift
l_int|30
)paren
suffix:semicolon
id|cmd
op_or_assign
(paren
l_int|1
op_lshift
l_int|28
)paren
suffix:semicolon
id|cmd
op_or_assign
(paren
id|gp-&gt;mii_phy_addr
op_lshift
l_int|23
)paren
op_amp
id|MIF_FRAME_PHYAD
suffix:semicolon
id|cmd
op_or_assign
(paren
id|reg
op_lshift
l_int|18
)paren
op_amp
id|MIF_FRAME_REGAD
suffix:semicolon
id|cmd
op_or_assign
(paren
id|MIF_FRAME_TAMSB
)paren
suffix:semicolon
id|cmd
op_or_assign
(paren
id|val
op_amp
id|MIF_FRAME_DATA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cmd
comma
id|gp-&gt;regs
op_plus
id|MIF_FRAME
)paren
suffix:semicolon
r_while
c_loop
(paren
id|limit
op_decrement
)paren
(brace
id|cmd
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MIF_FRAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_amp
id|MIF_FRAME_TALSB
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
DECL|function|gem_handle_mif_event
r_static
r_void
id|gem_handle_mif_event
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|reg_val
comma
id|u32
id|changed_bits
)paren
(brace
)brace
DECL|function|gem_pcs_interrupt
r_static
r_int
id|gem_pcs_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|pcs_istat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_ISTAT
)paren
suffix:semicolon
id|u32
id|pcs_miistat
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pcs_istat
op_amp
id|PCS_ISTAT_LSC
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCS irq but no link status change???&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The link status bit latches on zero, so you must&n;&t; * read it twice in such a case to see a transition&n;&t; * to the link being up.&n;&t; */
id|pcs_miistat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIISTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pcs_miistat
op_amp
id|PCS_MIISTAT_LS
)paren
)paren
id|pcs_miistat
op_or_assign
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIISTAT
)paren
op_amp
id|PCS_MIISTAT_LS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcs_miistat
op_amp
id|PCS_MIISTAT_ANC
)paren
(brace
multiline_comment|/* The remote-fault indication is only valid&n;&t;&t; * when autoneg has completed.&n;&t;&t; */
r_if
c_cond
(paren
id|pcs_miistat
op_amp
id|PCS_MIISTAT_RF
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PCS AutoNEG complete, &quot;
l_string|&quot;RemoteFault&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PCS AutoNEG complete.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcs_miistat
op_amp
id|PCS_MIISTAT_LS
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PCS link is now up.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PCS link is now down.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* If this happens and the link timer is not running,&n;&t;&t; * reset so we re-negotiate.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|gp-&gt;link_timer
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_txmac_interrupt
r_static
r_int
id|gem_txmac_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|txmac_stat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXSTAT
)paren
suffix:semicolon
multiline_comment|/* Defer timer expiration is quite normal,&n;&t; * don&squot;t even log the event.&n;&t; */
r_if
c_cond
(paren
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_DTE
)paren
op_logical_and
op_logical_neg
(paren
id|txmac_stat
op_amp
op_complement
id|MAC_TXSTAT_DTE
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_URUN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: TX MAC xmit underrun.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|gp-&gt;net_stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_MPE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: TX MAC max packet size error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|gp-&gt;net_stats.tx_errors
op_increment
suffix:semicolon
)brace
multiline_comment|/* The rest are all cases of one of the 16-bit TX&n;&t; * counters expiring.&n;&t; */
r_if
c_cond
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_NCE
)paren
id|gp-&gt;net_stats.collisions
op_add_assign
l_int|0x10000
suffix:semicolon
r_if
c_cond
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_ECE
)paren
(brace
id|gp-&gt;net_stats.tx_aborted_errors
op_add_assign
l_int|0x10000
suffix:semicolon
id|gp-&gt;net_stats.collisions
op_add_assign
l_int|0x10000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|txmac_stat
op_amp
id|MAC_TXSTAT_LCE
)paren
(brace
id|gp-&gt;net_stats.tx_aborted_errors
op_add_assign
l_int|0x10000
suffix:semicolon
id|gp-&gt;net_stats.collisions
op_add_assign
l_int|0x10000
suffix:semicolon
)brace
multiline_comment|/* We do not keep track of MAC_TXSTAT_FCE and&n;&t; * MAC_TXSTAT_PCE events.&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_rxmac_interrupt
r_static
r_int
id|gem_rxmac_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|rxmac_stat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXSTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rxmac_stat
op_amp
id|MAC_RXSTAT_OFLW
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: RX MAC fifo overflow.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|gp-&gt;net_stats.rx_over_errors
op_increment
suffix:semicolon
id|gp-&gt;net_stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rxmac_stat
op_amp
id|MAC_RXSTAT_ACE
)paren
id|gp-&gt;net_stats.rx_frame_errors
op_add_assign
l_int|0x10000
suffix:semicolon
r_if
c_cond
(paren
id|rxmac_stat
op_amp
id|MAC_RXSTAT_CCE
)paren
id|gp-&gt;net_stats.rx_crc_errors
op_add_assign
l_int|0x10000
suffix:semicolon
r_if
c_cond
(paren
id|rxmac_stat
op_amp
id|MAC_RXSTAT_LCE
)paren
id|gp-&gt;net_stats.rx_length_errors
op_add_assign
l_int|0x10000
suffix:semicolon
multiline_comment|/* We do not track MAC_RXSTAT_FCE and MAC_RXSTAT_VCE&n;&t; * events.&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_mac_interrupt
r_static
r_int
id|gem_mac_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|mac_cstat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_CSTAT
)paren
suffix:semicolon
multiline_comment|/* This interrupt is just for pause frame and pause&n;&t; * tracking.  It is useful for diagnostics and debug&n;&t; * but probably by default we will mask these events.&n;&t; */
r_if
c_cond
(paren
id|mac_cstat
op_amp
id|MAC_CSTAT_PS
)paren
id|gp-&gt;pause_entered
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mac_cstat
op_amp
id|MAC_CSTAT_PRCV
)paren
id|gp-&gt;pause_last_time_recvd
op_assign
(paren
id|mac_cstat
op_rshift
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_mif_interrupt
r_static
r_int
id|gem_mif_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|mif_status
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MIF_STATUS
)paren
suffix:semicolon
id|u32
id|reg_val
comma
id|changed_bits
suffix:semicolon
id|reg_val
op_assign
(paren
id|mif_status
op_amp
id|MIF_STATUS_DATA
)paren
op_rshift
l_int|16
suffix:semicolon
id|changed_bits
op_assign
(paren
id|mif_status
op_amp
id|MIF_STATUS_STAT
)paren
suffix:semicolon
id|gem_handle_mif_event
c_func
(paren
id|gp
comma
id|reg_val
comma
id|changed_bits
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_pci_interrupt
r_static
r_int
id|gem_pci_interrupt
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
id|u32
id|pci_estat
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|GREG_PCIESTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_GEM
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI error [%04x] &quot;
comma
id|dev-&gt;name
comma
id|pci_estat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_estat
op_amp
id|GREG_PCIESTAT_BADACK
)paren
id|printk
c_func
(paren
l_string|&quot;&lt;No ACK64# during ABS64 cycle&gt; &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_estat
op_amp
id|GREG_PCIESTAT_DTRTO
)paren
id|printk
c_func
(paren
l_string|&quot;&lt;Delayed transaction timeout&gt; &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_estat
op_amp
id|GREG_PCIESTAT_OTHER
)paren
id|printk
c_func
(paren
l_string|&quot;&lt;other&gt;&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|pci_estat
op_or_assign
id|GREG_PCIESTAT_OTHER
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_estat
op_amp
id|GREG_PCIESTAT_OTHER
)paren
(brace
id|u16
id|pci_cfg_stat
suffix:semicolon
multiline_comment|/* Interrogate PCI config space for the&n;&t;&t; * true cause.&n;&t;&t; */
id|pci_read_config_word
c_func
(paren
id|gp-&gt;pdev
comma
id|PCI_STATUS
comma
op_amp
id|pci_cfg_stat
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Read PCI cfg space status [%04x]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|pci_cfg_stat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_PARITY
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI parity error detected.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_SIG_TARGET_ABORT
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI target abort.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_REC_TARGET_ABORT
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI master acks target abort.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_REC_MASTER_ABORT
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI master abort.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_SIG_SYSTEM_ERROR
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI system error SERR#.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_cfg_stat
op_amp
id|PCI_STATUS_DETECTED_PARITY
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: PCI parity error.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Write the error bits back to clear them. */
id|pci_cfg_stat
op_and_assign
(paren
id|PCI_STATUS_PARITY
op_or
id|PCI_STATUS_SIG_TARGET_ABORT
op_or
id|PCI_STATUS_REC_TARGET_ABORT
op_or
id|PCI_STATUS_REC_MASTER_ABORT
op_or
id|PCI_STATUS_SIG_SYSTEM_ERROR
op_or
id|PCI_STATUS_DETECTED_PARITY
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|gp-&gt;pdev
comma
id|PCI_STATUS
comma
id|pci_cfg_stat
)paren
suffix:semicolon
)brace
multiline_comment|/* For all PCI errors, we should reset the chip. */
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_void
id|gem_stop
c_func
(paren
r_struct
id|gem
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|gem_init_rings
c_func
(paren
r_struct
id|gem
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|gem_init_hw
c_func
(paren
r_struct
id|gem
op_star
)paren
suffix:semicolon
multiline_comment|/* All non-normal interrupt conditions get serviced here.&n; * Returns non-zero if we should just exit the interrupt&n; * handler right now (ie. if we reset the card which invalidates&n; * all of the other original irq status bits).&n; */
DECL|function|gem_abnormal_irq
r_static
r_int
id|gem_abnormal_irq
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_RXNOBUF
)paren
(brace
multiline_comment|/* Frame arrived, no free RX buffers available. */
id|gp-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_RXTAGERR
)paren
(brace
multiline_comment|/* corrupt RX tag framing */
id|gp-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_PCS
)paren
(brace
r_if
c_cond
(paren
id|gem_pcs_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_TXMAC
)paren
(brace
r_if
c_cond
(paren
id|gem_txmac_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_RXMAC
)paren
(brace
r_if
c_cond
(paren
id|gem_rxmac_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_MAC
)paren
(brace
r_if
c_cond
(paren
id|gem_mac_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_MIF
)paren
(brace
r_if
c_cond
(paren
id|gem_mif_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_PCIERR
)paren
(brace
r_if
c_cond
(paren
id|gem_pci_interrupt
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|do_reset
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|do_reset
suffix:colon
id|gem_stop
c_func
(paren
id|gp
comma
id|gp-&gt;regs
)paren
suffix:semicolon
id|gem_init_rings
c_func
(paren
id|gp
comma
l_int|1
)paren
suffix:semicolon
id|gem_init_hw
c_func
(paren
id|gp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|gem_tx
r_static
id|__inline__
r_void
id|gem_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|gem
op_star
id|gp
comma
id|u32
id|gem_status
)paren
(brace
r_int
id|entry
comma
id|limit
suffix:semicolon
id|entry
op_assign
id|gp-&gt;tx_old
suffix:semicolon
id|limit
op_assign
(paren
(paren
id|gem_status
op_amp
id|GREG_STAT_TXNR
)paren
op_rshift
id|GREG_STAT_TXNR_SHIFT
)paren
suffix:semicolon
r_while
c_loop
(paren
id|entry
op_ne
id|limit
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|gem_txd
op_star
id|txd
suffix:semicolon
id|u32
id|dma_addr
suffix:semicolon
id|txd
op_assign
op_amp
id|gp-&gt;init_block-&gt;txd
(braket
id|entry
)braket
suffix:semicolon
id|skb
op_assign
id|gp-&gt;tx_skbs
(braket
id|entry
)braket
suffix:semicolon
id|dma_addr
op_assign
(paren
id|u32
)paren
id|le64_to_cpu
c_func
(paren
id|txd-&gt;buffer
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|gp-&gt;pdev
comma
id|dma_addr
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|gp-&gt;tx_skbs
(braket
id|entry
)braket
op_assign
l_int|NULL
suffix:semicolon
id|gp-&gt;net_stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|gp-&gt;net_stats.tx_packets
op_increment
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|entry
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
id|gp-&gt;tx_old
op_assign
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
op_logical_and
id|TX_BUFFS_AVAIL
c_func
(paren
id|gp
)paren
OG
l_int|0
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|gem_post_rxds
r_static
id|__inline__
r_void
id|gem_post_rxds
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
id|limit
)paren
(brace
r_int
id|cluster_start
comma
id|curr
comma
id|count
comma
id|kick
suffix:semicolon
id|cluster_start
op_assign
id|curr
op_assign
(paren
id|gp-&gt;rx_new
op_amp
op_complement
(paren
l_int|4
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
id|kick
op_assign
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|curr
op_ne
id|limit
)paren
(brace
id|curr
op_assign
id|NEXT_RX
c_func
(paren
id|curr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|count
op_eq
l_int|4
)paren
(brace
r_struct
id|gem_rxd
op_star
id|rxd
op_assign
op_amp
id|gp-&gt;init_block-&gt;rxd
(braket
id|cluster_start
)braket
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|rxd-&gt;status_word
op_assign
id|cpu_to_le64
c_func
(paren
id|RXDCTRL_FRESH
c_func
(paren
id|gp
)paren
)paren
suffix:semicolon
id|rxd
op_increment
suffix:semicolon
id|cluster_start
op_assign
id|NEXT_RX
c_func
(paren
id|cluster_start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cluster_start
op_eq
id|curr
)paren
r_break
suffix:semicolon
)brace
id|kick
op_assign
id|curr
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|kick
op_ge
l_int|0
)paren
id|writel
c_func
(paren
id|kick
comma
id|gp-&gt;regs
op_plus
id|RXDMA_KICK
)paren
suffix:semicolon
)brace
DECL|function|gem_rx
r_static
r_void
id|gem_rx
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_int
id|entry
comma
id|drops
suffix:semicolon
id|entry
op_assign
id|gp-&gt;rx_new
suffix:semicolon
id|drops
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_struct
id|gem_rxd
op_star
id|rxd
op_assign
op_amp
id|gp-&gt;init_block-&gt;rxd
(braket
id|entry
)braket
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u64
id|status
op_assign
id|cpu_to_le64
c_func
(paren
id|rxd-&gt;status_word
)paren
suffix:semicolon
id|u32
id|dma_addr
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|RXDCTRL_OWN
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|skb
op_assign
id|gp-&gt;rx_skbs
(braket
id|entry
)braket
suffix:semicolon
id|len
op_assign
(paren
id|status
op_amp
id|RXDCTRL_BUFSZ
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
OL
id|ETH_ZLEN
)paren
op_logical_or
(paren
id|status
op_amp
id|RXDCTRL_BAD
)paren
)paren
(brace
id|gp-&gt;net_stats.rx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|ETH_ZLEN
)paren
id|gp-&gt;net_stats.rx_length_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|len
op_amp
id|RXDCTRL_BAD
)paren
id|gp-&gt;net_stats.rx_crc_errors
op_increment
suffix:semicolon
multiline_comment|/* We&squot;ll just return it to GEM. */
id|drop_it
suffix:colon
id|gp-&gt;net_stats.rx_dropped
op_increment
suffix:semicolon
r_goto
id|next
suffix:semicolon
)brace
id|dma_addr
op_assign
(paren
id|u32
)paren
id|cpu_to_le64
c_func
(paren
id|rxd-&gt;buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|RX_COPY_THRESHOLD
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
id|new_skb
op_assign
id|gem_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_skb
op_eq
l_int|NULL
)paren
(brace
id|drops
op_increment
suffix:semicolon
r_goto
id|drop_it
suffix:semicolon
)brace
id|pci_unmap_single
c_func
(paren
id|gp-&gt;pdev
comma
id|dma_addr
comma
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|gp-&gt;rx_skbs
(braket
id|entry
)braket
op_assign
id|new_skb
suffix:semicolon
id|new_skb-&gt;dev
op_assign
id|gp-&gt;dev
suffix:semicolon
id|skb_put
c_func
(paren
id|new_skb
comma
(paren
id|ETH_FRAME_LEN
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|rxd-&gt;buffer
op_assign
id|cpu_to_le64
c_func
(paren
id|pci_map_single
c_func
(paren
id|gp-&gt;pdev
comma
id|new_skb-&gt;data
comma
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|new_skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
multiline_comment|/* Trim the original skb for the netif. */
id|skb_trim
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|copy_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_skb
op_eq
l_int|NULL
)paren
(brace
id|drops
op_increment
suffix:semicolon
r_goto
id|drop_it
suffix:semicolon
)brace
id|copy_skb-&gt;dev
op_assign
id|gp-&gt;dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|copy_skb
comma
l_int|2
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|copy_skb
comma
id|len
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|gp-&gt;pdev
comma
id|dma_addr
comma
id|len
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|copy_skb-&gt;data
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* We&squot;ll reuse the original ring buffer. */
id|skb
op_assign
id|copy_skb
suffix:semicolon
)brace
id|skb-&gt;csum
op_assign
(paren
(paren
id|status
op_amp
id|RXDCTRL_TCPCSUM
)paren
op_xor
l_int|0xffff
)paren
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_HW
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|gp-&gt;dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|gp-&gt;net_stats.rx_packets
op_increment
suffix:semicolon
id|gp-&gt;net_stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
id|next
suffix:colon
id|entry
op_assign
id|NEXT_RX
c_func
(paren
id|entry
)paren
suffix:semicolon
)brace
id|gem_post_rxds
c_func
(paren
id|gp
comma
id|entry
)paren
suffix:semicolon
id|gp-&gt;rx_new
op_assign
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|drops
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Memory squeeze, deferring packet.&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
DECL|function|gem_interrupt
r_static
r_void
id|gem_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|u32
id|gem_status
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|GREG_STAT
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_ABNORMAL
)paren
(brace
r_if
c_cond
(paren
id|gem_abnormal_irq
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_status
op_amp
(paren
id|GREG_STAT_TXALL
op_or
id|GREG_STAT_TXINTME
)paren
)paren
id|gem_tx
c_func
(paren
id|dev
comma
id|gp
comma
id|gem_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gem_status
op_amp
id|GREG_STAT_RXDONE
)paren
id|gem_rx
c_func
(paren
id|gp
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|gem_tx_timeout
r_static
r_void
id|gem_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: transmit timed out, resetting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: TX_STATE[%08x:%08x:%08x]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|TXDMA_CFG
)paren
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXSTAT
)paren
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: RX_STATE[%08x:%08x:%08x]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXSTAT
)paren
comma
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gem_stop
c_func
(paren
id|gp
comma
id|gp-&gt;regs
)paren
suffix:semicolon
id|gem_init_rings
c_func
(paren
id|gp
comma
l_int|1
)paren
suffix:semicolon
id|gem_init_hw
c_func
(paren
id|gp
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|gem_start_xmit
r_static
r_int
id|gem_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|entry
comma
id|avail
suffix:semicolon
id|u32
id|mapping
suffix:semicolon
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
id|mapping
op_assign
id|pci_map_single
c_func
(paren
id|gp-&gt;pdev
comma
id|skb-&gt;data
comma
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|entry
op_assign
id|gp-&gt;tx_new
suffix:semicolon
id|gp-&gt;tx_skbs
(braket
id|entry
)braket
op_assign
id|skb
suffix:semicolon
id|gp-&gt;tx_new
op_assign
id|NEXT_TX
c_func
(paren
id|entry
)paren
suffix:semicolon
id|avail
op_assign
id|TX_BUFFS_AVAIL
c_func
(paren
id|gp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|avail
op_le
l_int|0
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
(brace
r_struct
id|gem_txd
op_star
id|txd
op_assign
op_amp
id|gp-&gt;init_block-&gt;txd
(braket
id|entry
)braket
suffix:semicolon
id|u64
id|ctrl
op_assign
(paren
id|len
op_amp
id|TXDCTRL_BUFSZ
)paren
op_or
id|TXDCTRL_EOF
op_or
id|TXDCTRL_SOF
suffix:semicolon
id|txd-&gt;control_word
op_assign
id|cpu_to_le64
c_func
(paren
id|ctrl
)paren
suffix:semicolon
id|txd-&gt;buffer
op_assign
id|cpu_to_le64
c_func
(paren
id|mapping
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|gp-&gt;tx_new
comma
id|gp-&gt;regs
op_plus
id|TXDMA_KICK
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Jumbo-grams don&squot;t seem to work :-( */
macro_line|#if 1
DECL|macro|MAX_MTU
mdefine_line|#define MAX_MTU&t;&t;1500
macro_line|#else
DECL|macro|MAX_MTU
mdefine_line|#define MAX_MTU&t;&t;9000
macro_line|#endif
DECL|function|gem_change_mtu
r_static
r_int
id|gem_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|new_mtu
template_param
id|MAX_MTU
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gem_stop
c_func
(paren
id|gp
comma
id|gp-&gt;regs
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
id|gem_init_rings
c_func
(paren
id|gp
comma
l_int|1
)paren
suffix:semicolon
id|gem_init_hw
c_func
(paren
id|gp
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|STOP_TRIES
mdefine_line|#define STOP_TRIES 32
DECL|function|gem_stop
r_static
r_void
id|gem_stop
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
r_int
id|regs
)paren
(brace
r_int
id|limit
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|writel
c_func
(paren
id|GREG_SWRST_TXRST
op_or
id|GREG_SWRST_RXRST
comma
id|regs
op_plus
id|GREG_SWRST
)paren
suffix:semicolon
id|limit
op_assign
id|STOP_TRIES
suffix:semicolon
r_do
(brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|regs
op_plus
id|GREG_SWRST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|limit
op_decrement
op_le
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|val
op_amp
(paren
id|GREG_SWRST_TXRST
op_or
id|GREG_SWRST_RXRST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|limit
op_le
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gem: SW reset is ghetto.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* A link-up condition has occurred, initialize and enable the&n; * rest of the chip.&n; */
DECL|function|gem_set_link_modes
r_static
r_void
id|gem_set_link_modes
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u32
id|val
suffix:semicolon
r_int
id|full_duplex
comma
id|speed
suffix:semicolon
id|full_duplex
op_assign
l_int|0
suffix:semicolon
id|speed
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;lstate
op_eq
id|aneg_wait
)paren
(brace
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|PHY_LPA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
(paren
id|PHY_LPA_10FULL
op_or
id|PHY_LPA_100FULL
)paren
)paren
id|full_duplex
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
(paren
id|PHY_LPA_100FULL
op_or
id|PHY_LPA_100HALF
)paren
)paren
id|speed
op_assign
l_int|100
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|PHY_CTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|PHY_CTRL_FDPLX
)paren
id|full_duplex
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|PHY_CTRL_SPD100
)paren
id|speed
op_assign
l_int|100
suffix:semicolon
)brace
)brace
r_else
(brace
id|u32
id|pcs_lpa
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIILP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcs_lpa
op_amp
id|PCS_MIIADV_FD
)paren
id|full_duplex
op_assign
l_int|1
suffix:semicolon
id|speed
op_assign
l_int|1000
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Link is up at %d Mbps, %s-duplex.&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
comma
id|speed
comma
(paren
id|full_duplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
)paren
suffix:semicolon
id|val
op_assign
(paren
id|MAC_TXCFG_EIPG0
op_or
id|MAC_TXCFG_NGU
)paren
suffix:semicolon
r_if
c_cond
(paren
id|full_duplex
)paren
(brace
id|val
op_or_assign
(paren
id|MAC_TXCFG_ICS
op_or
id|MAC_TXCFG_ICOLL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* MAC_TXCFG_NBO must be zero. */
)brace
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|val
op_assign
(paren
id|MAC_XIFCFG_OE
op_or
id|MAC_XIFCFG_LLED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|full_duplex
op_logical_and
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
)paren
)paren
(brace
id|val
op_or_assign
id|MAC_XIFCFG_DISE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|full_duplex
)paren
(brace
id|val
op_or_assign
id|MAC_XIFCFG_FLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|speed
op_eq
l_int|1000
)paren
id|val
op_or_assign
(paren
id|MAC_XIFCFG_GMII
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|MAC_XIFCFG
)paren
suffix:semicolon
multiline_comment|/* If gigabit and half-duplex, enable carrier extension&n;&t; * mode.  Else, disable it.&n;&t; */
r_if
c_cond
(paren
id|speed
op_eq
l_int|1000
op_logical_and
op_logical_neg
id|full_duplex
)paren
(brace
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|MAC_TXCFG_TCE
comma
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|MAC_RXCFG_RCE
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_amp
op_complement
id|MAC_TXCFG_TCE
comma
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_amp
op_complement
id|MAC_RXCFG_RCE
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_serialink
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_serdes
)paren
(brace
id|u32
id|pcs_lpa
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIILP
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_MCCFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcs_lpa
op_amp
(paren
id|PCS_MIIADV_SP
op_or
id|PCS_MIIADV_AP
)paren
)paren
id|val
op_or_assign
(paren
id|MAC_MCCFG_SPE
op_or
id|MAC_MCCFG_RPE
)paren
suffix:semicolon
r_else
id|val
op_and_assign
op_complement
(paren
id|MAC_MCCFG_SPE
op_or
id|MAC_MCCFG_RPE
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|MAC_MCCFG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|full_duplex
)paren
id|writel
c_func
(paren
l_int|512
comma
id|gp-&gt;regs
op_plus
id|MAC_STIME
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
l_int|64
comma
id|gp-&gt;regs
op_plus
id|MAC_STIME
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Set slot-time of 64. */
id|writel
c_func
(paren
l_int|64
comma
id|gp-&gt;regs
op_plus
id|MAC_STIME
)paren
suffix:semicolon
)brace
multiline_comment|/* We are ready to rock, turn everything on. */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|TXDMA_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|TXDMA_CFG_ENABLE
comma
id|gp-&gt;regs
op_plus
id|TXDMA_CFG
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|RXDMA_CFG_ENABLE
comma
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|MAC_TXCFG_ENAB
comma
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
op_or
id|MAC_RXCFG_ENAB
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
)brace
DECL|function|gem_mdio_link_not_up
r_static
r_int
id|gem_mdio_link_not_up
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;lstate
op_eq
id|aneg_wait
)paren
(brace
id|u16
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|PHY_CTRL
)paren
suffix:semicolon
multiline_comment|/* Try forced modes. */
id|val
op_and_assign
op_complement
(paren
id|PHY_CTRL_ANRES
op_or
id|PHY_CTRL_ANENAB
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
(paren
id|PHY_CTRL_FDPLX
)paren
suffix:semicolon
id|val
op_or_assign
id|PHY_CTRL_SPD100
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|PHY_CTRL
comma
id|val
)paren
suffix:semicolon
id|gp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|gp-&gt;lstate
op_assign
id|force_wait
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Downgrade from 100 to 10 Mbps if necessary.&n;&t;&t; * If already at 10Mbps, warn user about the&n;&t;&t; * situation every 10 ticks.&n;&t;&t; */
id|u16
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|PHY_CTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|PHY_CTRL_SPD100
)paren
(brace
id|val
op_and_assign
op_complement
id|PHY_CTRL_SPD100
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|PHY_CTRL
comma
id|val
)paren
suffix:semicolon
id|gp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Link down, cable problem?&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
id|val
op_or_assign
(paren
id|PHY_CTRL_ANRES
op_or
id|PHY_CTRL_ANENAB
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|PHY_CTRL
comma
id|val
)paren
suffix:semicolon
id|gp-&gt;timer_ticks
op_assign
l_int|1
suffix:semicolon
id|gp-&gt;lstate
op_assign
id|aneg_wait
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
DECL|function|gem_link_timer
r_static
r_void
id|gem_link_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
(paren
r_struct
id|gem
op_star
)paren
id|data
suffix:semicolon
r_int
id|restart_timer
op_assign
l_int|0
suffix:semicolon
id|gp-&gt;timer_ticks
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
)paren
(brace
id|u16
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|PHY_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|PHY_STAT_LSTAT
)paren
(brace
id|gem_set_link_modes
c_func
(paren
id|gp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gp-&gt;timer_ticks
OL
l_int|10
)paren
(brace
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|restart_timer
op_assign
id|gem_mdio_link_not_up
c_func
(paren
id|gp
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|u32
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIISTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|PCS_MIISTAT_LS
)paren
)paren
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIISTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
id|PCS_MIISTAT_LS
)paren
op_eq
l_int|0
)paren
(brace
id|restart_timer
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|gem_set_link_modes
c_func
(paren
id|gp
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|restart_timer
)paren
(brace
id|gp-&gt;link_timer.expires
op_assign
id|jiffies
op_plus
(paren
(paren
l_int|12
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|gp-&gt;link_timer
)paren
suffix:semicolon
)brace
)brace
DECL|function|gem_clean_rings
r_static
r_void
id|gem_clean_rings
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_struct
id|gem_init_block
op_star
id|gb
op_assign
id|gp-&gt;init_block
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|dma_addr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|gem_rxd
op_star
id|rxd
suffix:semicolon
id|rxd
op_assign
op_amp
id|gb-&gt;rxd
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;rx_skbs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|skb
op_assign
id|gp-&gt;rx_skbs
(braket
id|i
)braket
suffix:semicolon
id|dma_addr
op_assign
(paren
id|u32
)paren
id|le64_to_cpu
c_func
(paren
id|rxd-&gt;buffer
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|gp-&gt;pdev
comma
id|dma_addr
comma
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|gp-&gt;rx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|rxd-&gt;status_word
op_assign
l_int|0
suffix:semicolon
id|rxd-&gt;buffer
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;tx_skbs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
r_struct
id|gem_txd
op_star
id|txd
suffix:semicolon
id|skb
op_assign
id|gp-&gt;tx_skbs
(braket
id|i
)braket
suffix:semicolon
id|txd
op_assign
op_amp
id|gb-&gt;txd
(braket
id|i
)braket
suffix:semicolon
id|dma_addr
op_assign
(paren
id|u32
)paren
id|le64_to_cpu
c_func
(paren
id|txd-&gt;buffer
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|gp-&gt;pdev
comma
id|dma_addr
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|gp-&gt;tx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
DECL|function|gem_init_rings
r_static
r_void
id|gem_init_rings
c_func
(paren
r_struct
id|gem
op_star
id|gp
comma
r_int
id|from_irq
)paren
(brace
r_struct
id|gem_init_block
op_star
id|gb
op_assign
id|gp-&gt;init_block
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|gp-&gt;dev
suffix:semicolon
r_int
id|i
comma
id|gfp_flags
op_assign
id|GFP_KERNEL
suffix:semicolon
id|u32
id|dma_addr
suffix:semicolon
r_if
c_cond
(paren
id|from_irq
)paren
id|gfp_flags
op_assign
id|GFP_ATOMIC
suffix:semicolon
id|gp-&gt;rx_new
op_assign
id|gp-&gt;rx_old
op_assign
id|gp-&gt;tx_new
op_assign
id|gp-&gt;tx_old
op_assign
l_int|0
suffix:semicolon
id|gem_clean_rings
c_func
(paren
id|gp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|gem_rxd
op_star
id|rxd
op_assign
op_amp
id|gb-&gt;rxd
(braket
id|i
)braket
suffix:semicolon
id|skb
op_assign
id|gem_alloc_skb
c_func
(paren
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|rxd-&gt;buffer
op_assign
l_int|0
suffix:semicolon
id|rxd-&gt;status_word
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|gp-&gt;rx_skbs
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
(paren
id|ETH_FRAME_LEN
op_plus
id|RX_OFFSET
)paren
)paren
suffix:semicolon
id|dma_addr
op_assign
id|pci_map_single
c_func
(paren
id|gp-&gt;pdev
comma
id|skb-&gt;data
comma
id|RX_BUF_ALLOC_SIZE
c_func
(paren
id|gp
)paren
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|rxd-&gt;buffer
op_assign
id|cpu_to_le64
c_func
(paren
id|dma_addr
)paren
suffix:semicolon
id|rxd-&gt;status_word
op_assign
id|cpu_to_le64
c_func
(paren
id|RXDCTRL_FRESH
c_func
(paren
id|gp
)paren
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|RX_OFFSET
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TX_RING_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|gem_txd
op_star
id|txd
op_assign
op_amp
id|gb-&gt;txd
(braket
id|i
)braket
suffix:semicolon
id|txd-&gt;control_word
op_assign
l_int|0
suffix:semicolon
id|txd-&gt;buffer
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|gem_init_phy
r_static
r_void
id|gem_init_phy
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_GEM
)paren
(brace
id|u32
id|val
suffix:semicolon
multiline_comment|/* Init datapath mode register. */
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
)paren
(brace
id|val
op_assign
id|PCS_DMODE_MGM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_serialink
)paren
(brace
id|val
op_assign
id|PCS_DMODE_SM
op_or
id|PCS_DMODE_GMOE
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|PCS_DMODE_ESM
suffix:semicolon
)brace
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_DMODE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
)paren
(brace
id|u16
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|PHY_CTRL
)paren
suffix:semicolon
r_int
id|limit
op_assign
l_int|10000
suffix:semicolon
multiline_comment|/* Take PHY out of isloate mode and reset it. */
id|val
op_and_assign
op_complement
id|PHY_CTRL_ISO
suffix:semicolon
id|val
op_or_assign
id|PHY_CTRL_RST
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|PHY_CTRL
comma
id|val
)paren
suffix:semicolon
r_while
c_loop
(paren
id|limit
op_decrement
)paren
(brace
id|val
op_assign
id|phy_read
c_func
(paren
id|gp
comma
id|PHY_CTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
id|PHY_CTRL_RST
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* Init advertisement and enable autonegotiation. */
id|phy_write
c_func
(paren
id|gp
comma
id|PHY_ADV
comma
(paren
id|PHY_ADV_10HALF
op_or
id|PHY_ADV_10FULL
op_or
id|PHY_ADV_100HALF
op_or
id|PHY_ADV_100FULL
)paren
)paren
suffix:semicolon
id|val
op_or_assign
(paren
id|PHY_CTRL_ANRES
op_or
id|PHY_CTRL_ANENAB
)paren
suffix:semicolon
id|phy_write
c_func
(paren
id|gp
comma
id|PHY_CTRL
comma
id|val
)paren
suffix:semicolon
)brace
r_else
(brace
id|u32
id|val
suffix:semicolon
r_int
id|limit
suffix:semicolon
multiline_comment|/* Reset PCS unit. */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIICTRL
)paren
suffix:semicolon
id|val
op_or_assign
id|PCS_MIICTRL_RST
suffix:semicolon
id|writeb
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_MIICTRL
)paren
suffix:semicolon
id|limit
op_assign
l_int|32
suffix:semicolon
r_while
c_loop
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIICTRL
)paren
op_amp
id|PCS_MIICTRL_RST
)paren
(brace
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|limit
op_decrement
op_le
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|limit
op_le
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PCS reset bit would not clear.&bslash;n&quot;
comma
id|gp-&gt;dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Make sure PCS is disabled while changing advertisement&n;&t;&t; * configuration.&n;&t;&t; */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_CFG
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
(paren
id|PCS_CFG_ENABLE
op_or
id|PCS_CFG_TO
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_CFG
)paren
suffix:semicolon
multiline_comment|/* Advertise all capabilities. */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIIADV
)paren
suffix:semicolon
id|val
op_or_assign
(paren
id|PCS_MIIADV_FD
op_or
id|PCS_MIIADV_HD
op_or
id|PCS_MIIADV_SP
op_or
id|PCS_MIIADV_AP
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_MIIADV
)paren
suffix:semicolon
multiline_comment|/* Enable and restart auto-negotiation, disable wrapback/loopback,&n;&t;&t; * and re-enable PCS.&n;&t;&t; */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_MIICTRL
)paren
suffix:semicolon
id|val
op_or_assign
(paren
id|PCS_MIICTRL_RAN
op_or
id|PCS_MIICTRL_ANE
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|PCS_MIICTRL_WB
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_MIICTRL
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_CFG
)paren
suffix:semicolon
id|val
op_or_assign
id|PCS_CFG_ENABLE
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_CFG
)paren
suffix:semicolon
multiline_comment|/* Make sure serialink loopback is off.  The meaning&n;&t;&t; * of this bit is logically inverted based upon whether&n;&t;&t; * you are in Serialink or SERDES mode.&n;&t;&t; */
id|val
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|PCS_SCTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_serialink
)paren
id|val
op_and_assign
op_complement
id|PCS_SCTRL_LOOP
suffix:semicolon
r_else
id|val
op_or_assign
id|PCS_SCTRL_LOOP
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|PCS_SCTRL
)paren
suffix:semicolon
)brace
)brace
DECL|function|gem_init_dma
r_static
r_void
id|gem_init_dma
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|u32
id|val
suffix:semicolon
id|val
op_assign
(paren
id|TXDMA_CFG_BASE
op_or
(paren
l_int|0x7ff
op_lshift
l_int|10
)paren
op_or
id|TXDMA_CFG_PMODE
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|TXDMA_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|TXDMA_DBHI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|gp-&gt;gblock_dvma
comma
id|gp-&gt;regs
op_plus
id|TXDMA_DBLOW
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|TXDMA_KICK
)paren
suffix:semicolon
id|val
op_assign
(paren
id|RXDMA_CFG_BASE
op_or
(paren
id|RX_OFFSET
op_lshift
l_int|10
)paren
op_or
(paren
(paren
l_int|14
op_div
l_int|2
)paren
op_lshift
l_int|13
)paren
op_or
id|RXDMA_CFG_FTHRESH_512
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|RXDMA_CFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|RXDMA_DBHI
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|gp-&gt;gblock_dvma
op_plus
(paren
id|TX_RING_SIZE
op_star
r_sizeof
(paren
r_struct
id|gem_txd
)paren
)paren
)paren
comma
id|gp-&gt;regs
op_plus
id|RXDMA_DBLOW
)paren
suffix:semicolon
id|writel
c_func
(paren
id|RX_RING_SIZE
op_minus
l_int|4
comma
id|gp-&gt;regs
op_plus
id|RXDMA_KICK
)paren
suffix:semicolon
id|val
op_assign
(paren
(paren
(paren
id|gp-&gt;rx_pause_off
op_div
l_int|64
)paren
op_lshift
l_int|0
)paren
op_amp
id|RXDMA_PTHRESH_OFF
)paren
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
id|gp-&gt;rx_pause_on
op_div
l_int|64
)paren
op_lshift
l_int|12
)paren
op_amp
id|RXDMA_PTHRESH_ON
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|gp-&gt;regs
op_plus
id|RXDMA_PTHRESH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|GREG_BIFCFG
)paren
op_amp
id|GREG_BIFCFG_M66EN
)paren
id|writel
c_func
(paren
(paren
(paren
l_int|6
op_amp
id|RXDMA_BLANK_IPKTS
)paren
op_or
(paren
(paren
l_int|4
op_lshift
l_int|12
)paren
op_amp
id|RXDMA_BLANK_ITIME
)paren
)paren
comma
id|gp-&gt;regs
op_plus
id|RXDMA_BLANK
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
(paren
(paren
l_int|6
op_amp
id|RXDMA_BLANK_IPKTS
)paren
op_or
(paren
(paren
l_int|2
op_lshift
l_int|12
)paren
op_amp
id|RXDMA_BLANK_ITIME
)paren
)paren
comma
id|gp-&gt;regs
op_plus
id|RXDMA_BLANK
)paren
suffix:semicolon
)brace
DECL|macro|CRC_POLYNOMIAL_LE
mdefine_line|#define CRC_POLYNOMIAL_LE 0xedb88320UL  /* Ethernet CRC, little endian */
DECL|function|gem_init_mac
r_static
r_void
id|gem_init_mac
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_int
r_char
op_star
id|e
op_assign
op_amp
id|gp-&gt;dev-&gt;dev_addr
(braket
l_int|0
)braket
suffix:semicolon
id|u32
id|rxcfg
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_GEM
)paren
id|writel
c_func
(paren
l_int|0x1bf0
comma
id|gp-&gt;regs
op_plus
id|MAC_SNDPAUSE
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x00
comma
id|gp-&gt;regs
op_plus
id|MAC_IPG0
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x08
comma
id|gp-&gt;regs
op_plus
id|MAC_IPG1
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x04
comma
id|gp-&gt;regs
op_plus
id|MAC_IPG2
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x40
comma
id|gp-&gt;regs
op_plus
id|MAC_STIME
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x40
comma
id|gp-&gt;regs
op_plus
id|MAC_MINFSZ
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x20000000
op_or
(paren
id|gp-&gt;dev-&gt;mtu
op_plus
l_int|18
)paren
comma
id|gp-&gt;regs
op_plus
id|MAC_MAXFSZ
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x07
comma
id|gp-&gt;regs
op_plus
id|MAC_PASIZE
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x04
comma
id|gp-&gt;regs
op_plus
id|MAC_JAMSIZE
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x10
comma
id|gp-&gt;regs
op_plus
id|MAC_ATTLIM
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x8808
comma
id|gp-&gt;regs
op_plus
id|MAC_MCTYPE
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|e
(braket
l_int|5
)braket
op_or
(paren
id|e
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
)paren
op_amp
l_int|0x3ff
comma
id|gp-&gt;regs
op_plus
id|MAC_RANDSEED
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|e
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|5
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR0
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|e
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|3
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR1
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|e
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|e
(braket
l_int|1
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR2
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR3
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR4
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR5
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x0001
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR6
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xc200
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR7
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x0180
comma
id|gp-&gt;regs
op_plus
id|MAC_ADDR8
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AFILT0
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AFILT1
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AFILT2
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AF21MSK
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AF0MSK
)paren
suffix:semicolon
id|rxcfg
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|gp-&gt;dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|gp-&gt;dev-&gt;mc_count
OG
l_int|256
)paren
)paren
(brace
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH0
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH1
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH2
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH3
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH4
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH5
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH6
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH7
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH8
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH9
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH10
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH11
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH12
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH13
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH14
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH15
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gp-&gt;dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|rxcfg
op_or_assign
id|MAC_RXCFG_PROM
suffix:semicolon
)brace
r_else
(brace
id|u16
id|hash_table
(braket
l_int|16
)braket
suffix:semicolon
id|u32
id|crc
comma
id|poly
op_assign
id|CRC_POLYNOMIAL_LE
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|gp-&gt;dev-&gt;mc_list
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|bit
comma
id|byte
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|gp-&gt;dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
op_star
id|addrs
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addrs
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|crc
op_assign
l_int|0xffffffffU
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
l_int|6
suffix:semicolon
id|byte
op_increment
)paren
(brace
r_for
c_loop
(paren
id|bit
op_assign
op_star
id|addrs
op_increment
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_int
id|test
suffix:semicolon
id|test
op_assign
(paren
(paren
id|bit
op_xor
id|crc
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|test
)paren
id|crc
op_assign
id|crc
op_xor
id|poly
suffix:semicolon
)brace
)brace
id|crc
op_rshift_assign
l_int|24
suffix:semicolon
id|hash_table
(braket
id|crc
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|crc
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|hash_table
(braket
l_int|0
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|1
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|2
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH2
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|3
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH3
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|4
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH4
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|5
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH5
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|6
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH6
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|7
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH7
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|8
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH8
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|9
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH9
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|10
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH10
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|11
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH11
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|12
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH12
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|13
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH13
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|14
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH14
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|15
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH15
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_NCOLL
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_FASUCC
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_ECOLL
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_LCOLL
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_DTIMER
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_PATMPS
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_RFCTR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_LERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_FCSERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCVERR
)paren
suffix:semicolon
multiline_comment|/* Clear RX/TX/MAC/XIF config, we will set these up and enable&n;&t; * them once a link is established.&n;&t; */
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_TXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|rxcfg
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_MCCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_XIFCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|MAC_TXSTAT_URUN
op_or
id|MAC_TXSTAT_MPE
op_or
id|MAC_TXSTAT_NCE
op_or
id|MAC_TXSTAT_ECE
op_or
id|MAC_TXSTAT_LCE
op_or
id|MAC_TXSTAT_FCE
op_or
id|MAC_TXSTAT_DTE
op_or
id|MAC_TXSTAT_PCE
)paren
comma
id|gp-&gt;regs
op_plus
id|MAC_TXMASK
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|MAC_RXSTAT_OFLW
op_or
id|MAC_RXSTAT_FCE
op_or
id|MAC_RXSTAT_ACE
op_or
id|MAC_RXSTAT_CCE
op_or
id|MAC_RXSTAT_LCE
op_or
id|MAC_RXSTAT_VCE
)paren
comma
id|gp-&gt;regs
op_plus
id|MAC_RXMASK
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_MCMASK
)paren
suffix:semicolon
)brace
DECL|function|gem_init_hw
r_static
r_void
id|gem_init_hw
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
id|gem_init_phy
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gem_init_dma
c_func
(paren
id|gp
)paren
suffix:semicolon
id|gem_init_mac
c_func
(paren
id|gp
)paren
suffix:semicolon
id|writel
c_func
(paren
id|GREG_STAT_TXDONE
comma
id|gp-&gt;regs
op_plus
id|GREG_IMASK
)paren
suffix:semicolon
id|gp-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|gp-&gt;lstate
op_assign
id|aneg_wait
suffix:semicolon
id|gp-&gt;link_timer.expires
op_assign
id|jiffies
op_plus
(paren
(paren
l_int|12
op_star
id|HZ
)paren
op_div
l_int|10
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|gp-&gt;link_timer
)paren
suffix:semicolon
)brace
DECL|function|gem_open
r_static
r_int
id|gem_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|regs
op_assign
id|gp-&gt;regs
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|gp-&gt;link_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|gp-&gt;pdev-&gt;irq
comma
id|gem_interrupt
comma
id|SA_SHIRQ
comma
id|dev-&gt;name
comma
(paren
r_void
op_star
)paren
id|dev
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|gem_stop
c_func
(paren
id|gp
comma
id|regs
)paren
suffix:semicolon
id|gem_init_rings
c_func
(paren
id|gp
comma
l_int|0
)paren
suffix:semicolon
id|gem_init_hw
c_func
(paren
id|gp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_close
r_static
r_int
id|gem_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|gp-&gt;link_timer
)paren
suffix:semicolon
id|gem_stop
c_func
(paren
id|gp
comma
id|gp-&gt;regs
)paren
suffix:semicolon
id|gem_clean_rings
c_func
(paren
id|gp
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|gp-&gt;pdev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|gem_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|gp-&gt;net_stats
suffix:semicolon
id|stats-&gt;rx_crc_errors
op_add_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_FCSERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_FCSERR
)paren
suffix:semicolon
id|stats-&gt;rx_frame_errors
op_add_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_AERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_AERR
)paren
suffix:semicolon
id|stats-&gt;rx_length_errors
op_add_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_LERR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_LERR
)paren
suffix:semicolon
id|stats-&gt;tx_aborted_errors
op_add_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_ECOLL
)paren
suffix:semicolon
id|stats-&gt;collisions
op_add_assign
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_ECOLL
)paren
op_plus
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_LCOLL
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_ECOLL
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|gp-&gt;regs
op_plus
id|MAC_LCOLL
)paren
suffix:semicolon
r_return
op_amp
id|gp-&gt;net_stats
suffix:semicolon
)brace
DECL|function|gem_set_multicast
r_static
r_void
id|gem_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|gp-&gt;dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_logical_or
(paren
id|gp-&gt;dev-&gt;mc_count
OG
l_int|256
)paren
)paren
(brace
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH0
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH1
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH2
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH3
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH4
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH5
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH6
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH7
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH8
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH9
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH10
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH11
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH12
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH13
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH14
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH15
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gp-&gt;dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
(brace
id|u32
id|rxcfg
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
r_int
id|limit
op_assign
l_int|10000
suffix:semicolon
id|writel
c_func
(paren
id|rxcfg
op_amp
op_complement
id|MAC_RXCFG_ENAB
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
op_amp
id|MAC_RXCFG_ENAB
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|limit
op_decrement
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|rxcfg
op_or_assign
id|MAC_RXCFG_PROM
suffix:semicolon
id|writel
c_func
(paren
id|rxcfg
comma
id|gp-&gt;regs
op_plus
id|MAC_RXCFG
)paren
suffix:semicolon
)brace
r_else
(brace
id|u16
id|hash_table
(braket
l_int|16
)braket
suffix:semicolon
id|u32
id|crc
comma
id|poly
op_assign
id|CRC_POLYNOMIAL_LE
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|gp-&gt;dev-&gt;mc_list
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|bit
comma
id|byte
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|hash_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
op_star
id|addrs
op_assign
id|dmi-&gt;dmi_addr
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|addrs
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|crc
op_assign
l_int|0xffffffffU
suffix:semicolon
r_for
c_loop
(paren
id|byte
op_assign
l_int|0
suffix:semicolon
id|byte
OL
l_int|6
suffix:semicolon
id|byte
op_increment
)paren
(brace
r_for
c_loop
(paren
id|bit
op_assign
op_star
id|addrs
op_increment
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
comma
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_int
id|test
suffix:semicolon
id|test
op_assign
(paren
(paren
id|bit
op_xor
id|crc
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|crc
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|test
)paren
id|crc
op_assign
id|crc
op_xor
id|poly
suffix:semicolon
)brace
)brace
id|crc
op_rshift_assign
l_int|24
suffix:semicolon
id|hash_table
(braket
id|crc
op_rshift
l_int|4
)braket
op_or_assign
l_int|1
op_lshift
(paren
id|crc
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|hash_table
(braket
l_int|0
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH0
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|1
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|2
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH2
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|3
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH3
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|4
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH4
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|5
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH5
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|6
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH6
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|7
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH7
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|8
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH8
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|9
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH9
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|10
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH10
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|11
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH11
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|12
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH12
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|13
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH13
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|14
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH14
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hash_table
(braket
l_int|15
)braket
comma
id|gp-&gt;regs
op_plus
id|MAC_HASH15
)paren
suffix:semicolon
)brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|gem_ioctl
r_static
r_int
id|gem_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|gem_check_invariants
r_static
r_int
id|__devinit
id|gem_check_invariants
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|gp-&gt;pdev
suffix:semicolon
id|u32
id|mif_cfg
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_RIO_GEM
macro_line|#if 0
op_logical_or
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_PPC_GEM
macro_line|#endif
)paren
(brace
multiline_comment|/* One of the MII PHYs _must_ be present&n;&t;&t; * as these chip versions have no gigabit&n;&t;&t; * PHY.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|mif_cfg
op_amp
(paren
id|MIF_CFG_MDI0
op_or
id|MIF_CFG_MDI1
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;RIO GEM lacks MII phy, mif_cfg[%08x]&bslash;n&quot;
comma
id|mif_cfg
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Determine initial PHY interface type guess.  MDIO1 is the&n;&t; * external PHY and thus takes precedence over MDIO0.&n;&t; */
r_if
c_cond
(paren
id|mif_cfg
op_amp
id|MIF_CFG_MDI1
)paren
(brace
id|gp-&gt;phy_type
op_assign
id|phy_mii_mdio1
suffix:semicolon
id|mif_cfg
op_or_assign
id|MIF_CFG_PSELECT
suffix:semicolon
id|writel
c_func
(paren
id|mif_cfg
comma
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mif_cfg
op_amp
id|MIF_CFG_MDI0
)paren
(brace
id|gp-&gt;phy_type
op_assign
id|phy_mii_mdio0
suffix:semicolon
id|mif_cfg
op_and_assign
op_complement
id|MIF_CFG_PSELECT
suffix:semicolon
id|writel
c_func
(paren
id|mif_cfg
comma
id|gp-&gt;regs
op_plus
id|MIF_CFG
)paren
suffix:semicolon
)brace
r_else
(brace
id|gp-&gt;phy_type
op_assign
id|phy_serialink
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio1
op_logical_or
id|gp-&gt;phy_type
op_eq
id|phy_mii_mdio0
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|gp-&gt;mii_phy_addr
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|phy_read
c_func
(paren
id|gp
comma
id|PHY_CTRL
)paren
op_ne
l_int|0xffff
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|32
)paren
(brace
r_if
c_cond
(paren
id|pdev-&gt;device
op_ne
id|PCI_DEVICE_ID_SUN_GEM
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;RIO MII phy will not respond.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|gp-&gt;phy_type
op_assign
id|phy_serdes
suffix:semicolon
)brace
)brace
multiline_comment|/* Fetch the FIFO configurations now too. */
id|gp-&gt;tx_fifo_sz
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|TXDMA_FSZ
)paren
op_star
l_int|64
suffix:semicolon
id|gp-&gt;rx_fifo_sz
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|RXDMA_FSZ
)paren
op_star
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_SUN_GEM
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;tx_fifo_sz
op_ne
(paren
l_int|9
op_star
l_int|1024
)paren
op_logical_or
id|gp-&gt;rx_fifo_sz
op_ne
(paren
l_int|20
op_star
l_int|1024
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;GEM has bogus fifo sizes tx(%d) rx(%d)&bslash;n&quot;
comma
id|gp-&gt;tx_fifo_sz
comma
id|gp-&gt;rx_fifo_sz
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|gp-&gt;tx_fifo_sz
op_ne
(paren
l_int|2
op_star
l_int|1024
)paren
op_logical_or
id|gp-&gt;rx_fifo_sz
op_ne
(paren
l_int|2
op_star
l_int|1024
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;RIO GEM has bogus fifo sizes tx(%d) rx(%d)&bslash;n&quot;
comma
id|gp-&gt;tx_fifo_sz
comma
id|gp-&gt;rx_fifo_sz
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Calculate pause thresholds.  Setting the OFF threshold to the&n;&t; * full RX fifo size effectively disables PAUSE generation which&n;&t; * is what we do for 10/100 only GEMs which have FIFOs too small&n;&t; * to make real gains from PAUSE.&n;&t; */
r_if
c_cond
(paren
id|gp-&gt;rx_fifo_sz
op_le
(paren
l_int|2
op_star
l_int|1024
)paren
)paren
(brace
id|gp-&gt;rx_pause_off
op_assign
id|gp-&gt;rx_pause_on
op_assign
id|gp-&gt;rx_fifo_sz
suffix:semicolon
)brace
r_else
(brace
r_int
id|off
op_assign
(paren
id|gp-&gt;rx_fifo_sz
op_minus
(paren
l_int|5
op_star
l_int|1024
)paren
)paren
suffix:semicolon
r_int
id|on
op_assign
id|off
op_minus
l_int|1024
suffix:semicolon
id|gp-&gt;rx_pause_off
op_assign
id|off
suffix:semicolon
id|gp-&gt;rx_pause_on
op_assign
id|on
suffix:semicolon
)brace
(brace
id|u32
id|cfg
op_assign
id|readl
c_func
(paren
id|gp-&gt;regs
op_plus
id|GREG_BIFCFG
)paren
suffix:semicolon
id|cfg
op_or_assign
id|GREG_BIFCFG_B64DIS
suffix:semicolon
id|writel
c_func
(paren
id|cfg
comma
id|gp-&gt;regs
op_plus
id|GREG_BIFCFG
)paren
suffix:semicolon
id|cfg
op_assign
id|GREG_CFG_IBURST
suffix:semicolon
id|cfg
op_or_assign
(paren
(paren
l_int|31
op_lshift
l_int|1
)paren
op_amp
id|GREG_CFG_TXDMALIM
)paren
suffix:semicolon
id|cfg
op_or_assign
(paren
(paren
l_int|31
op_lshift
l_int|6
)paren
op_amp
id|GREG_CFG_RXDMALIM
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cfg
comma
id|gp-&gt;regs
op_plus
id|GREG_CFG
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gem_get_device_address
r_static
r_void
id|__devinit
id|gem_get_device_address
c_func
(paren
r_struct
id|gem
op_star
id|gp
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|gp-&gt;dev
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|gp-&gt;pdev
suffix:semicolon
macro_line|#ifdef __sparc__
r_struct
id|pcidev_cookie
op_star
id|pcp
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
r_int
id|node
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pcp
op_ne
l_int|NULL
)paren
(brace
id|node
op_assign
id|pcp-&gt;prom_node
suffix:semicolon
r_if
c_cond
(paren
id|prom_getproplen
c_func
(paren
id|node
comma
l_string|&quot;local-mac-address&quot;
)paren
op_eq
l_int|6
)paren
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;local-mac-address&quot;
comma
id|dev-&gt;dev_addr
comma
l_int|6
)paren
suffix:semicolon
r_else
id|node
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node
op_eq
op_minus
l_int|1
)paren
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|idprom-&gt;id_ethaddr
comma
l_int|6
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|gem_init_one
r_static
r_int
id|__devinit
id|gem_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_static
r_int
id|gem_version_printed
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|gemreg_base
comma
id|gemreg_len
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|gem
op_star
id|gp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|gem_version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|gemreg_base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|gemreg_len
op_assign
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|IORESOURCE_IO
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Cannot find proper PCI device &quot;
l_string|&quot;base address, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
id|init_etherdev
c_func
(paren
l_int|NULL
comma
r_sizeof
(paren
op_star
id|gp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Etherdev init failed, aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|gemreg_base
comma
id|gemreg_len
comma
id|dev-&gt;name
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;MMIO resource (0x%lx@0x%lx) unavailable, &quot;
l_string|&quot;aborting.&bslash;n&quot;
comma
id|gemreg_base
comma
id|gemreg_len
)paren
suffix:semicolon
r_goto
id|err_out_free_netdev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Cannot enable MMIO operation, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_free_mmio_res
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|memset
c_func
(paren
id|gp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|gp
)paren
)paren
suffix:semicolon
id|gp-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|dev-&gt;base_addr
op_assign
(paren
r_int
)paren
id|pdev
suffix:semicolon
id|gp-&gt;dev
op_assign
id|dev
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|gp-&gt;lock
)paren
suffix:semicolon
id|gp-&gt;regs
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|gemreg_base
comma
id|gemreg_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gp-&gt;regs
op_eq
l_int|0UL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Cannot map device registers, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_free_mmio_res
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gem_check_invariants
c_func
(paren
id|gp
)paren
)paren
r_goto
id|err_out_iounmap
suffix:semicolon
multiline_comment|/* It is guarenteed that the returned buffer will be at least&n;&t; * PAGE_SIZE aligned.&n;&t; */
id|gp-&gt;init_block
op_assign
(paren
r_struct
id|gem_init_block
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|pdev
comma
r_sizeof
(paren
r_struct
id|gem_init_block
)paren
comma
op_amp
id|gp-&gt;gblock_dvma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;init_block
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Cannot allocate init block, &quot;
l_string|&quot;aborting.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_iounmap
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sun GEM (PCI) 10/100/1000BaseT Ethernet &quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|gem_get_device_address
c_func
(paren
id|gp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%2.2x%c&quot;
comma
id|dev-&gt;dev_addr
(braket
id|i
)braket
comma
id|i
op_eq
l_int|5
ques
c_cond
l_char|&squot; &squot;
suffix:colon
l_char|&squot;:&squot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|gp-&gt;link_timer
)paren
suffix:semicolon
id|gp-&gt;link_timer.function
op_assign
id|gem_link_timer
suffix:semicolon
id|gp-&gt;link_timer.data
op_assign
(paren
r_int
r_int
)paren
id|gp
suffix:semicolon
id|dev-&gt;open
op_assign
id|gem_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|gem_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|gem_start_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|gem_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|gem_set_multicast
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|gem_ioctl
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|gem_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|gem_change_mtu
suffix:semicolon
id|dev-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_iounmap
suffix:colon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|gp-&gt;regs
)paren
suffix:semicolon
id|err_out_free_mmio_res
suffix:colon
id|release_mem_region
c_func
(paren
id|gemreg_base
comma
id|gemreg_len
)paren
suffix:semicolon
id|err_out_free_netdev
suffix:colon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|gem_suspend
r_static
r_void
id|gem_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
)brace
DECL|function|gem_resume
r_static
r_void
id|gem_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
)brace
DECL|function|gem_remove_one
r_static
r_void
id|__devexit
id|gem_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
r_struct
id|gem
op_star
id|gp
op_assign
id|dev-&gt;priv
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
r_sizeof
(paren
r_struct
id|gem_init_block
)paren
comma
id|gp-&gt;init_block
comma
id|gp-&gt;gblock_dvma
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|gp-&gt;regs
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
DECL|variable|gem_driver
r_static
r_struct
id|pci_driver
id|gem_driver
op_assign
(brace
id|name
suffix:colon
id|GEM_MODULE_NAME
comma
id|id_table
suffix:colon
id|gem_pci_tbl
comma
id|probe
suffix:colon
id|gem_init_one
comma
id|remove
suffix:colon
id|gem_remove_one
comma
id|suspend
suffix:colon
id|gem_suspend
comma
id|resume
suffix:colon
id|gem_resume
comma
)brace
suffix:semicolon
DECL|function|gem_init
r_static
r_int
id|__init
id|gem_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|gem_driver
)paren
suffix:semicolon
)brace
DECL|function|gem_cleanup
r_static
r_void
id|__exit
id|gem_cleanup
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|gem_driver
)paren
suffix:semicolon
)brace
DECL|variable|gem_init
id|module_init
c_func
(paren
id|gem_init
)paren
suffix:semicolon
DECL|variable|gem_cleanup
id|module_exit
c_func
(paren
id|gem_cleanup
)paren
suffix:semicolon
eof
