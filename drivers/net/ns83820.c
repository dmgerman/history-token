DECL|macro|_VERSION
mdefine_line|#define _VERSION &quot;0.20&quot;
multiline_comment|/* ns83820.c by Benjamin LaHaise with contributions.&n; *&n; * Questions/comments/discussion to linux-ns83820@kvack.org.&n; *&n; * $Revision: 1.34.2.23 $&n; *&n; * Copyright 2001 Benjamin LaHaise.&n; * Copyright 2001, 2002 Red Hat.&n; *&n; * Mmmm, chocolate vanilla mocha...&n; *&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; *&n; *&n; * ChangeLog&n; * =========&n; *&t;20010414&t;0.1 - created&n; *&t;20010622&t;0.2 - basic rx and tx.&n; *&t;20010711&t;0.3 - added duplex and link state detection support.&n; *&t;20010713&t;0.4 - zero copy, no hangs.&n; *&t;&t;&t;0.5 - 64 bit dma support (davem will hate me for this)&n; *&t;&t;&t;    - disable jumbo frames to avoid tx hangs&n; *&t;&t;&t;    - work around tx deadlocks on my 1.02 card via&n; *&t;&t;&t;      fiddling with TXCFG&n; *&t;20010810&t;0.6 - use pci dma api for ringbuffers, work on ia64&n; *&t;20010816&t;0.7 - misc cleanups&n; *&t;20010826&t;0.8 - fix critical zero copy bugs&n; *&t;&t;&t;0.9 - internal experiment&n; *&t;20010827&t;0.10 - fix ia64 unaligned access.&n; *&t;20010906&t;0.11 - accept all packets with checksum errors as&n; *&t;&t;&t;       otherwise fragments get lost&n; *&t;&t;&t;     - fix &gt;&gt; 32 bugs&n; *&t;&t;&t;0.12 - add statistics counters&n; *&t;&t;&t;     - add allmulti/promisc support&n; *&t;20011009&t;0.13 - hotplug support, other smaller pci api cleanups&n; *&t;20011204&t;0.13a - optical transceiver support added&n; *&t;&t;&t;&t;by Michael Clark &lt;michael@metaparadigm.com&gt;&n; *&t;20011205&t;0.13b - call register_netdev earlier in initialization&n; *&t;&t;&t;&t;suppress duplicate link status messages&n; *&t;20011117 &t;0.14 - ethtool GDRVINFO, GLINK support from jgarzik&n; *&t;20011204 &t;0.15&t;get ppc (big endian) working&n; *&t;20011218&t;0.16&t;various cleanups&n; *&t;20020310&t;0.17&t;speedups&n; *&t;20020610&t;0.18 -&t;actually use the pci dma api for highmem&n; *&t;&t;&t;     -&t;remove pci latency register fiddling&n; *&t;&t;&t;0.19 -&t;better bist support&n; *&t;&t;&t;     -&t;add ihr and reset_phy parameters&n; *&t;&t;&t;     -&t;gmii bus probing&n; *&t;&t;&t;     -&t;fix missed txok introduced during performance&n; *&t;&t;&t;&t;tuning&n; *&t;&t;&t;0.20 -&t;fix stupid RFEN thinko.  i am such a smurf.&n; *&n; *&t;20040828&t;0.21 -&t;add hardware vlan accleration&n; *&t;&t;&t;&t;by Neil Horman &lt;nhorman@redhat.com&gt;&n; * Driver Overview&n; * ===============&n; *&n; * This driver was originally written for the National Semiconductor&n; * 83820 chip, a 10/100/1000 Mbps 64 bit PCI ethernet NIC.  Hopefully&n; * this code will turn out to be a) clean, b) correct, and c) fast.&n; * With that in mind, I&squot;m aiming to split the code up as much as&n; * reasonably possible.  At present there are X major sections that&n; * break down into a) packet receive, b) packet transmit, c) link&n; * management, d) initialization and configuration.  Where possible,&n; * these code paths are designed to run in parallel.&n; *&n; * This driver has been tested and found to work with the following&n; * cards (in no particular order):&n; *&n; *&t;Cameo&t;&t;SOHO-GA2000T&t;SOHO-GA2500T&n; *&t;D-Link&t;&t;DGE-500T&n; *&t;PureData&t;PDP8023Z-TG&n; *&t;SMC&t;&t;SMC9452TX&t;SMC9462TX&n; *&t;Netgear&t;&t;GA621&n; *&n; * Special thanks to SMC for providing hardware to test this driver on.&n; *&n; * Reports of success or failure would be greatly appreciated.&n; */
singleline_comment|//#define dprintk&t;&t;printk
DECL|macro|dprintk
mdefine_line|#define dprintk(x...)&t;&t;do { } while (0)
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ip.h&gt;&t;/* for iph */
macro_line|#include &lt;linux/in.h&gt;&t;/* for IPPROTO_... */
macro_line|#include &lt;linux/eeprom.h&gt;
macro_line|#include &lt;linux/compiler.h&gt;
macro_line|#include &lt;linux/prefetch.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/if_vlan.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME &quot;ns83820&quot;
multiline_comment|/* Global parameters.  See module_param near the bottom. */
DECL|variable|ihr
r_static
r_int
id|ihr
op_assign
l_int|2
suffix:semicolon
DECL|variable|reset_phy
r_static
r_int
id|reset_phy
op_assign
l_int|0
suffix:semicolon
DECL|variable|lnksts
r_static
r_int
id|lnksts
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CFG_LNKSTS bit polarity */
multiline_comment|/* Dprintk is used for more interesting debug events */
DECL|macro|Dprintk
macro_line|#undef Dprintk
DECL|macro|Dprintk
mdefine_line|#define&t;Dprintk&t;&t;&t;dprintk
macro_line|#if defined(CONFIG_HIGHMEM64G) || defined(__ia64__)
DECL|macro|USE_64BIT_ADDR
mdefine_line|#define USE_64BIT_ADDR&t;&quot;+&quot;
macro_line|#endif
macro_line|#if defined(USE_64BIT_ADDR)
DECL|macro|VERSION
mdefine_line|#define&t;VERSION&t;_VERSION USE_64BIT_ADDR
DECL|macro|TRY_DAC
mdefine_line|#define TRY_DAC&t;1
macro_line|#else
DECL|macro|VERSION
mdefine_line|#define&t;VERSION&t;_VERSION
DECL|macro|TRY_DAC
mdefine_line|#define TRY_DAC&t;0
macro_line|#endif
multiline_comment|/* tunables */
DECL|macro|RX_BUF_SIZE
mdefine_line|#define RX_BUF_SIZE&t;1500&t;/* 8192 */
macro_line|#if defined(CONFIG_VLAN_8021Q) || defined(CONFIG_VLAN_8021Q_MODULE)
DECL|macro|NS83820_VLAN_ACCEL_SUPPORT
mdefine_line|#define NS83820_VLAN_ACCEL_SUPPORT
macro_line|#endif
multiline_comment|/* Must not exceed ~65000. */
DECL|macro|NR_RX_DESC
mdefine_line|#define NR_RX_DESC&t;64
DECL|macro|NR_TX_DESC
mdefine_line|#define NR_TX_DESC&t;128
multiline_comment|/* not tunable */
DECL|macro|REAL_RX_BUF_SIZE
mdefine_line|#define REAL_RX_BUF_SIZE (RX_BUF_SIZE + 14)&t;/* rx/tx mac addr + type */
DECL|macro|MIN_TX_DESC_FREE
mdefine_line|#define MIN_TX_DESC_FREE&t;8
multiline_comment|/* register defines */
DECL|macro|CFGCS
mdefine_line|#define CFGCS&t;&t;0x04
DECL|macro|CR_TXE
mdefine_line|#define CR_TXE&t;&t;0x00000001
DECL|macro|CR_TXD
mdefine_line|#define CR_TXD&t;&t;0x00000002
multiline_comment|/* Ramit : Here&squot;s a tip, don&squot;t do a RXD immediately followed by an RXE&n; * The Receive engine skips one descriptor and moves&n; * onto the next one!! */
DECL|macro|CR_RXE
mdefine_line|#define CR_RXE&t;&t;0x00000004
DECL|macro|CR_RXD
mdefine_line|#define CR_RXD&t;&t;0x00000008
DECL|macro|CR_TXR
mdefine_line|#define CR_TXR&t;&t;0x00000010
DECL|macro|CR_RXR
mdefine_line|#define CR_RXR&t;&t;0x00000020
DECL|macro|CR_SWI
mdefine_line|#define CR_SWI&t;&t;0x00000080
DECL|macro|CR_RST
mdefine_line|#define CR_RST&t;&t;0x00000100
DECL|macro|PTSCR_EEBIST_FAIL
mdefine_line|#define PTSCR_EEBIST_FAIL       0x00000001
DECL|macro|PTSCR_EEBIST_EN
mdefine_line|#define PTSCR_EEBIST_EN         0x00000002
DECL|macro|PTSCR_EELOAD_EN
mdefine_line|#define PTSCR_EELOAD_EN         0x00000004
DECL|macro|PTSCR_RBIST_FAIL
mdefine_line|#define PTSCR_RBIST_FAIL        0x000001b8
DECL|macro|PTSCR_RBIST_DONE
mdefine_line|#define PTSCR_RBIST_DONE        0x00000200
DECL|macro|PTSCR_RBIST_EN
mdefine_line|#define PTSCR_RBIST_EN          0x00000400
DECL|macro|PTSCR_RBIST_RST
mdefine_line|#define PTSCR_RBIST_RST         0x00002000
DECL|macro|MEAR_EEDI
mdefine_line|#define MEAR_EEDI&t;&t;0x00000001
DECL|macro|MEAR_EEDO
mdefine_line|#define MEAR_EEDO&t;&t;0x00000002
DECL|macro|MEAR_EECLK
mdefine_line|#define MEAR_EECLK&t;&t;0x00000004
DECL|macro|MEAR_EESEL
mdefine_line|#define MEAR_EESEL&t;&t;0x00000008
DECL|macro|MEAR_MDIO
mdefine_line|#define MEAR_MDIO&t;&t;0x00000010
DECL|macro|MEAR_MDDIR
mdefine_line|#define MEAR_MDDIR&t;&t;0x00000020
DECL|macro|MEAR_MDC
mdefine_line|#define MEAR_MDC&t;&t;0x00000040
DECL|macro|ISR_TXDESC3
mdefine_line|#define ISR_TXDESC3&t;0x40000000
DECL|macro|ISR_TXDESC2
mdefine_line|#define ISR_TXDESC2&t;0x20000000
DECL|macro|ISR_TXDESC1
mdefine_line|#define ISR_TXDESC1&t;0x10000000
DECL|macro|ISR_TXDESC0
mdefine_line|#define ISR_TXDESC0&t;0x08000000
DECL|macro|ISR_RXDESC3
mdefine_line|#define ISR_RXDESC3&t;0x04000000
DECL|macro|ISR_RXDESC2
mdefine_line|#define ISR_RXDESC2&t;0x02000000
DECL|macro|ISR_RXDESC1
mdefine_line|#define ISR_RXDESC1&t;0x01000000
DECL|macro|ISR_RXDESC0
mdefine_line|#define ISR_RXDESC0&t;0x00800000
DECL|macro|ISR_TXRCMP
mdefine_line|#define ISR_TXRCMP&t;0x00400000
DECL|macro|ISR_RXRCMP
mdefine_line|#define ISR_RXRCMP&t;0x00200000
DECL|macro|ISR_DPERR
mdefine_line|#define ISR_DPERR&t;0x00100000
DECL|macro|ISR_SSERR
mdefine_line|#define ISR_SSERR&t;0x00080000
DECL|macro|ISR_RMABT
mdefine_line|#define ISR_RMABT&t;0x00040000
DECL|macro|ISR_RTABT
mdefine_line|#define ISR_RTABT&t;0x00020000
DECL|macro|ISR_RXSOVR
mdefine_line|#define ISR_RXSOVR&t;0x00010000
DECL|macro|ISR_HIBINT
mdefine_line|#define ISR_HIBINT&t;0x00008000
DECL|macro|ISR_PHY
mdefine_line|#define ISR_PHY&t;&t;0x00004000
DECL|macro|ISR_PME
mdefine_line|#define ISR_PME&t;&t;0x00002000
DECL|macro|ISR_SWI
mdefine_line|#define ISR_SWI&t;&t;0x00001000
DECL|macro|ISR_MIB
mdefine_line|#define ISR_MIB&t;&t;0x00000800
DECL|macro|ISR_TXURN
mdefine_line|#define ISR_TXURN&t;0x00000400
DECL|macro|ISR_TXIDLE
mdefine_line|#define ISR_TXIDLE&t;0x00000200
DECL|macro|ISR_TXERR
mdefine_line|#define ISR_TXERR&t;0x00000100
DECL|macro|ISR_TXDESC
mdefine_line|#define ISR_TXDESC&t;0x00000080
DECL|macro|ISR_TXOK
mdefine_line|#define ISR_TXOK&t;0x00000040
DECL|macro|ISR_RXORN
mdefine_line|#define ISR_RXORN&t;0x00000020
DECL|macro|ISR_RXIDLE
mdefine_line|#define ISR_RXIDLE&t;0x00000010
DECL|macro|ISR_RXEARLY
mdefine_line|#define ISR_RXEARLY&t;0x00000008
DECL|macro|ISR_RXERR
mdefine_line|#define ISR_RXERR&t;0x00000004
DECL|macro|ISR_RXDESC
mdefine_line|#define ISR_RXDESC&t;0x00000002
DECL|macro|ISR_RXOK
mdefine_line|#define ISR_RXOK&t;0x00000001
DECL|macro|TXCFG_CSI
mdefine_line|#define TXCFG_CSI&t;0x80000000
DECL|macro|TXCFG_HBI
mdefine_line|#define TXCFG_HBI&t;0x40000000
DECL|macro|TXCFG_MLB
mdefine_line|#define TXCFG_MLB&t;0x20000000
DECL|macro|TXCFG_ATP
mdefine_line|#define TXCFG_ATP&t;0x10000000
DECL|macro|TXCFG_ECRETRY
mdefine_line|#define TXCFG_ECRETRY&t;0x00800000
DECL|macro|TXCFG_BRST_DIS
mdefine_line|#define TXCFG_BRST_DIS&t;0x00080000
DECL|macro|TXCFG_MXDMA1024
mdefine_line|#define TXCFG_MXDMA1024&t;0x00000000
DECL|macro|TXCFG_MXDMA512
mdefine_line|#define TXCFG_MXDMA512&t;0x00700000
DECL|macro|TXCFG_MXDMA256
mdefine_line|#define TXCFG_MXDMA256&t;0x00600000
DECL|macro|TXCFG_MXDMA128
mdefine_line|#define TXCFG_MXDMA128&t;0x00500000
DECL|macro|TXCFG_MXDMA64
mdefine_line|#define TXCFG_MXDMA64&t;0x00400000
DECL|macro|TXCFG_MXDMA32
mdefine_line|#define TXCFG_MXDMA32&t;0x00300000
DECL|macro|TXCFG_MXDMA16
mdefine_line|#define TXCFG_MXDMA16&t;0x00200000
DECL|macro|TXCFG_MXDMA8
mdefine_line|#define TXCFG_MXDMA8&t;0x00100000
DECL|macro|CFG_LNKSTS
mdefine_line|#define CFG_LNKSTS&t;0x80000000
DECL|macro|CFG_SPDSTS
mdefine_line|#define CFG_SPDSTS&t;0x60000000
DECL|macro|CFG_SPDSTS1
mdefine_line|#define CFG_SPDSTS1&t;0x40000000
DECL|macro|CFG_SPDSTS0
mdefine_line|#define CFG_SPDSTS0&t;0x20000000
DECL|macro|CFG_DUPSTS
mdefine_line|#define CFG_DUPSTS&t;0x10000000
DECL|macro|CFG_TBI_EN
mdefine_line|#define CFG_TBI_EN&t;0x01000000
DECL|macro|CFG_MODE_1000
mdefine_line|#define CFG_MODE_1000&t;0x00400000
multiline_comment|/* Ramit : Dont&squot; ever use AUTO_1000, it never works and is buggy.&n; * Read the Phy response and then configure the MAC accordingly */
DECL|macro|CFG_AUTO_1000
mdefine_line|#define CFG_AUTO_1000&t;0x00200000
DECL|macro|CFG_PINT_CTL
mdefine_line|#define CFG_PINT_CTL&t;0x001c0000
DECL|macro|CFG_PINT_DUPSTS
mdefine_line|#define CFG_PINT_DUPSTS&t;0x00100000
DECL|macro|CFG_PINT_LNKSTS
mdefine_line|#define CFG_PINT_LNKSTS&t;0x00080000
DECL|macro|CFG_PINT_SPDSTS
mdefine_line|#define CFG_PINT_SPDSTS&t;0x00040000
DECL|macro|CFG_TMRTEST
mdefine_line|#define CFG_TMRTEST&t;0x00020000
DECL|macro|CFG_MRM_DIS
mdefine_line|#define CFG_MRM_DIS&t;0x00010000
DECL|macro|CFG_MWI_DIS
mdefine_line|#define CFG_MWI_DIS&t;0x00008000
DECL|macro|CFG_T64ADDR
mdefine_line|#define CFG_T64ADDR&t;0x00004000
DECL|macro|CFG_PCI64_DET
mdefine_line|#define CFG_PCI64_DET&t;0x00002000
DECL|macro|CFG_DATA64_EN
mdefine_line|#define CFG_DATA64_EN&t;0x00001000
DECL|macro|CFG_M64ADDR
mdefine_line|#define CFG_M64ADDR&t;0x00000800
DECL|macro|CFG_PHY_RST
mdefine_line|#define CFG_PHY_RST&t;0x00000400
DECL|macro|CFG_PHY_DIS
mdefine_line|#define CFG_PHY_DIS&t;0x00000200
DECL|macro|CFG_EXTSTS_EN
mdefine_line|#define CFG_EXTSTS_EN&t;0x00000100
DECL|macro|CFG_REQALG
mdefine_line|#define CFG_REQALG&t;0x00000080
DECL|macro|CFG_SB
mdefine_line|#define CFG_SB&t;&t;0x00000040
DECL|macro|CFG_POW
mdefine_line|#define CFG_POW&t;&t;0x00000020
DECL|macro|CFG_EXD
mdefine_line|#define CFG_EXD&t;&t;0x00000010
DECL|macro|CFG_PESEL
mdefine_line|#define CFG_PESEL&t;0x00000008
DECL|macro|CFG_BROM_DIS
mdefine_line|#define CFG_BROM_DIS&t;0x00000004
DECL|macro|CFG_EXT_125
mdefine_line|#define CFG_EXT_125&t;0x00000002
DECL|macro|CFG_BEM
mdefine_line|#define CFG_BEM&t;&t;0x00000001
DECL|macro|EXTSTS_UDPPKT
mdefine_line|#define EXTSTS_UDPPKT&t;0x00200000
DECL|macro|EXTSTS_TCPPKT
mdefine_line|#define EXTSTS_TCPPKT&t;0x00080000
DECL|macro|EXTSTS_IPPKT
mdefine_line|#define EXTSTS_IPPKT&t;0x00020000
DECL|macro|EXTSTS_VPKT
mdefine_line|#define EXTSTS_VPKT&t;0x00010000
DECL|macro|EXTSTS_VTG_MASK
mdefine_line|#define EXTSTS_VTG_MASK&t;0x0000ffff
DECL|macro|SPDSTS_POLARITY
mdefine_line|#define SPDSTS_POLARITY&t;(CFG_SPDSTS1 | CFG_SPDSTS0 | CFG_DUPSTS | (lnksts ? CFG_LNKSTS : 0))
DECL|macro|MIBC_MIBS
mdefine_line|#define MIBC_MIBS&t;0x00000008
DECL|macro|MIBC_ACLR
mdefine_line|#define MIBC_ACLR&t;0x00000004
DECL|macro|MIBC_FRZ
mdefine_line|#define MIBC_FRZ&t;0x00000002
DECL|macro|MIBC_WRN
mdefine_line|#define MIBC_WRN&t;0x00000001
DECL|macro|PCR_PSEN
mdefine_line|#define PCR_PSEN&t;(1 &lt;&lt; 31)
DECL|macro|PCR_PS_MCAST
mdefine_line|#define PCR_PS_MCAST&t;(1 &lt;&lt; 30)
DECL|macro|PCR_PS_DA
mdefine_line|#define PCR_PS_DA&t;(1 &lt;&lt; 29)
DECL|macro|PCR_STHI_8
mdefine_line|#define PCR_STHI_8&t;(3 &lt;&lt; 23)
DECL|macro|PCR_STLO_4
mdefine_line|#define PCR_STLO_4&t;(1 &lt;&lt; 23)
DECL|macro|PCR_FFHI_8K
mdefine_line|#define PCR_FFHI_8K&t;(3 &lt;&lt; 21)
DECL|macro|PCR_FFLO_4K
mdefine_line|#define PCR_FFLO_4K&t;(1 &lt;&lt; 21)
DECL|macro|PCR_PAUSE_CNT
mdefine_line|#define PCR_PAUSE_CNT&t;0xFFFE
DECL|macro|RXCFG_AEP
mdefine_line|#define RXCFG_AEP&t;0x80000000
DECL|macro|RXCFG_ARP
mdefine_line|#define RXCFG_ARP&t;0x40000000
DECL|macro|RXCFG_STRIPCRC
mdefine_line|#define RXCFG_STRIPCRC&t;0x20000000
DECL|macro|RXCFG_RX_FD
mdefine_line|#define RXCFG_RX_FD&t;0x10000000
DECL|macro|RXCFG_ALP
mdefine_line|#define RXCFG_ALP&t;0x08000000
DECL|macro|RXCFG_AIRL
mdefine_line|#define RXCFG_AIRL&t;0x04000000
DECL|macro|RXCFG_MXDMA512
mdefine_line|#define RXCFG_MXDMA512&t;0x00700000
DECL|macro|RXCFG_DRTH
mdefine_line|#define RXCFG_DRTH&t;0x0000003e
DECL|macro|RXCFG_DRTH0
mdefine_line|#define RXCFG_DRTH0&t;0x00000002
DECL|macro|RFCR_RFEN
mdefine_line|#define RFCR_RFEN&t;0x80000000
DECL|macro|RFCR_AAB
mdefine_line|#define RFCR_AAB&t;0x40000000
DECL|macro|RFCR_AAM
mdefine_line|#define RFCR_AAM&t;0x20000000
DECL|macro|RFCR_AAU
mdefine_line|#define RFCR_AAU&t;0x10000000
DECL|macro|RFCR_APM
mdefine_line|#define RFCR_APM&t;0x08000000
DECL|macro|RFCR_APAT
mdefine_line|#define RFCR_APAT&t;0x07800000
DECL|macro|RFCR_APAT3
mdefine_line|#define RFCR_APAT3&t;0x04000000
DECL|macro|RFCR_APAT2
mdefine_line|#define RFCR_APAT2&t;0x02000000
DECL|macro|RFCR_APAT1
mdefine_line|#define RFCR_APAT1&t;0x01000000
DECL|macro|RFCR_APAT0
mdefine_line|#define RFCR_APAT0&t;0x00800000
DECL|macro|RFCR_AARP
mdefine_line|#define RFCR_AARP&t;0x00400000
DECL|macro|RFCR_MHEN
mdefine_line|#define RFCR_MHEN&t;0x00200000
DECL|macro|RFCR_UHEN
mdefine_line|#define RFCR_UHEN&t;0x00100000
DECL|macro|RFCR_ULM
mdefine_line|#define RFCR_ULM&t;0x00080000
DECL|macro|VRCR_RUDPE
mdefine_line|#define VRCR_RUDPE&t;0x00000080
DECL|macro|VRCR_RTCPE
mdefine_line|#define VRCR_RTCPE&t;0x00000040
DECL|macro|VRCR_RIPE
mdefine_line|#define VRCR_RIPE&t;0x00000020
DECL|macro|VRCR_IPEN
mdefine_line|#define VRCR_IPEN&t;0x00000010
DECL|macro|VRCR_DUTF
mdefine_line|#define VRCR_DUTF&t;0x00000008
DECL|macro|VRCR_DVTF
mdefine_line|#define VRCR_DVTF&t;0x00000004
DECL|macro|VRCR_VTREN
mdefine_line|#define VRCR_VTREN&t;0x00000002
DECL|macro|VRCR_VTDEN
mdefine_line|#define VRCR_VTDEN&t;0x00000001
DECL|macro|VTCR_PPCHK
mdefine_line|#define VTCR_PPCHK&t;0x00000008
DECL|macro|VTCR_GCHK
mdefine_line|#define VTCR_GCHK&t;0x00000004
DECL|macro|VTCR_VPPTI
mdefine_line|#define VTCR_VPPTI&t;0x00000002
DECL|macro|VTCR_VGTI
mdefine_line|#define VTCR_VGTI&t;0x00000001
DECL|macro|CR
mdefine_line|#define CR&t;&t;0x00
DECL|macro|CFG
mdefine_line|#define CFG&t;&t;0x04
DECL|macro|MEAR
mdefine_line|#define MEAR&t;&t;0x08
DECL|macro|PTSCR
mdefine_line|#define PTSCR&t;&t;0x0c
DECL|macro|ISR
mdefine_line|#define&t;ISR&t;&t;0x10
DECL|macro|IMR
mdefine_line|#define&t;IMR&t;&t;0x14
DECL|macro|IER
mdefine_line|#define&t;IER&t;&t;0x18
DECL|macro|IHR
mdefine_line|#define&t;IHR&t;&t;0x1c
DECL|macro|TXDP
mdefine_line|#define TXDP&t;&t;0x20
DECL|macro|TXDP_HI
mdefine_line|#define TXDP_HI&t;&t;0x24
DECL|macro|TXCFG
mdefine_line|#define TXCFG&t;&t;0x28
DECL|macro|GPIOR
mdefine_line|#define GPIOR&t;&t;0x2c
DECL|macro|RXDP
mdefine_line|#define RXDP&t;&t;0x30
DECL|macro|RXDP_HI
mdefine_line|#define RXDP_HI&t;&t;0x34
DECL|macro|RXCFG
mdefine_line|#define RXCFG&t;&t;0x38
DECL|macro|PQCR
mdefine_line|#define PQCR&t;&t;0x3c
DECL|macro|WCSR
mdefine_line|#define WCSR&t;&t;0x40
DECL|macro|PCR
mdefine_line|#define PCR&t;&t;0x44
DECL|macro|RFCR
mdefine_line|#define RFCR&t;&t;0x48
DECL|macro|RFDR
mdefine_line|#define RFDR&t;&t;0x4c
DECL|macro|SRR
mdefine_line|#define SRR&t;&t;0x58
DECL|macro|VRCR
mdefine_line|#define VRCR&t;&t;0xbc
DECL|macro|VTCR
mdefine_line|#define VTCR&t;&t;0xc0
DECL|macro|VDR
mdefine_line|#define VDR&t;&t;0xc4
DECL|macro|CCSR
mdefine_line|#define CCSR&t;&t;0xcc
DECL|macro|TBICR
mdefine_line|#define TBICR&t;&t;0xe0
DECL|macro|TBISR
mdefine_line|#define TBISR&t;&t;0xe4
DECL|macro|TANAR
mdefine_line|#define TANAR&t;&t;0xe8
DECL|macro|TANLPAR
mdefine_line|#define TANLPAR&t;&t;0xec
DECL|macro|TANER
mdefine_line|#define TANER&t;&t;0xf0
DECL|macro|TESR
mdefine_line|#define TESR&t;&t;0xf4
DECL|macro|TBICR_MR_AN_ENABLE
mdefine_line|#define TBICR_MR_AN_ENABLE&t;0x00001000
DECL|macro|TBICR_MR_RESTART_AN
mdefine_line|#define TBICR_MR_RESTART_AN&t;0x00000200
DECL|macro|TBISR_MR_LINK_STATUS
mdefine_line|#define TBISR_MR_LINK_STATUS&t;0x00000020
DECL|macro|TBISR_MR_AN_COMPLETE
mdefine_line|#define TBISR_MR_AN_COMPLETE&t;0x00000004
DECL|macro|TANAR_PS2
mdefine_line|#define TANAR_PS2 &t;&t;0x00000100
DECL|macro|TANAR_PS1
mdefine_line|#define TANAR_PS1 &t;&t;0x00000080
DECL|macro|TANAR_HALF_DUP
mdefine_line|#define TANAR_HALF_DUP &t;&t;0x00000040
DECL|macro|TANAR_FULL_DUP
mdefine_line|#define TANAR_FULL_DUP &t;&t;0x00000020
DECL|macro|GPIOR_GP5_OE
mdefine_line|#define GPIOR_GP5_OE&t;&t;0x00000200
DECL|macro|GPIOR_GP4_OE
mdefine_line|#define GPIOR_GP4_OE&t;&t;0x00000100
DECL|macro|GPIOR_GP3_OE
mdefine_line|#define GPIOR_GP3_OE&t;&t;0x00000080
DECL|macro|GPIOR_GP2_OE
mdefine_line|#define GPIOR_GP2_OE&t;&t;0x00000040
DECL|macro|GPIOR_GP1_OE
mdefine_line|#define GPIOR_GP1_OE&t;&t;0x00000020
DECL|macro|GPIOR_GP3_OUT
mdefine_line|#define GPIOR_GP3_OUT&t;&t;0x00000004
DECL|macro|GPIOR_GP1_OUT
mdefine_line|#define GPIOR_GP1_OUT&t;&t;0x00000001
DECL|macro|LINK_AUTONEGOTIATE
mdefine_line|#define LINK_AUTONEGOTIATE&t;0x01
DECL|macro|LINK_DOWN
mdefine_line|#define LINK_DOWN&t;&t;0x02
DECL|macro|LINK_UP
mdefine_line|#define LINK_UP&t;&t;&t;0x04
macro_line|#ifdef USE_64BIT_ADDR
DECL|macro|HW_ADDR_LEN
mdefine_line|#define HW_ADDR_LEN&t;8
DECL|macro|desc_addr_set
mdefine_line|#define desc_addr_set(desc, addr)&t;&t;&t;&t;&bslash;&n;&t;do {&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;u64 __addr = (addr);&t;&t;&t;&t;&bslash;&n;&t;&t;(desc)[0] = cpu_to_le32(__addr);&t;&t;&bslash;&n;&t;&t;(desc)[1] = cpu_to_le32(__addr &gt;&gt; 32);&t;&t;&bslash;&n;&t;} while(0)
DECL|macro|desc_addr_get
mdefine_line|#define desc_addr_get(desc)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;(((u64)le32_to_cpu((desc)[1]) &lt;&lt; 32)&t;&t;&bslash;&n;&t;&t;     | le32_to_cpu((desc)[0]))
macro_line|#else
DECL|macro|HW_ADDR_LEN
mdefine_line|#define HW_ADDR_LEN&t;4
DECL|macro|desc_addr_set
mdefine_line|#define desc_addr_set(desc, addr)&t;((desc)[0] = cpu_to_le32(addr))
DECL|macro|desc_addr_get
mdefine_line|#define desc_addr_get(desc)&t;&t;(le32_to_cpu((desc)[0]))
macro_line|#endif
DECL|macro|DESC_LINK
mdefine_line|#define DESC_LINK&t;&t;0
DECL|macro|DESC_BUFPTR
mdefine_line|#define DESC_BUFPTR&t;&t;(DESC_LINK + HW_ADDR_LEN/4)
DECL|macro|DESC_CMDSTS
mdefine_line|#define DESC_CMDSTS&t;&t;(DESC_BUFPTR + HW_ADDR_LEN/4)
DECL|macro|DESC_EXTSTS
mdefine_line|#define DESC_EXTSTS&t;&t;(DESC_CMDSTS + 4/4)
DECL|macro|CMDSTS_OWN
mdefine_line|#define CMDSTS_OWN&t;0x80000000
DECL|macro|CMDSTS_MORE
mdefine_line|#define CMDSTS_MORE&t;0x40000000
DECL|macro|CMDSTS_INTR
mdefine_line|#define CMDSTS_INTR&t;0x20000000
DECL|macro|CMDSTS_ERR
mdefine_line|#define CMDSTS_ERR&t;0x10000000
DECL|macro|CMDSTS_OK
mdefine_line|#define CMDSTS_OK&t;0x08000000
DECL|macro|CMDSTS_RUNT
mdefine_line|#define CMDSTS_RUNT&t;0x00200000
DECL|macro|CMDSTS_LEN_MASK
mdefine_line|#define CMDSTS_LEN_MASK&t;0x0000ffff
DECL|macro|CMDSTS_DEST_MASK
mdefine_line|#define CMDSTS_DEST_MASK&t;0x01800000
DECL|macro|CMDSTS_DEST_SELF
mdefine_line|#define CMDSTS_DEST_SELF&t;0x00800000
DECL|macro|CMDSTS_DEST_MULTI
mdefine_line|#define CMDSTS_DEST_MULTI&t;0x01000000
DECL|macro|DESC_SIZE
mdefine_line|#define DESC_SIZE&t;8&t;&t;/* Should be cache line sized */
DECL|struct|rx_info
r_struct
id|rx_info
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|up
r_int
id|up
suffix:semicolon
DECL|member|idle
r_int
id|idle
suffix:semicolon
DECL|member|skbs
r_struct
id|sk_buff
op_star
id|skbs
(braket
id|NR_RX_DESC
)braket
suffix:semicolon
DECL|member|next_rx_desc
id|u32
op_star
id|next_rx_desc
suffix:semicolon
DECL|member|next_rx
DECL|member|next_empty
id|u16
id|next_rx
comma
id|next_empty
suffix:semicolon
DECL|member|descs
id|u32
op_star
id|descs
suffix:semicolon
DECL|member|phy_descs
id|dma_addr_t
id|phy_descs
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ns83820
r_struct
id|ns83820
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|base
id|u8
id|__iomem
op_star
id|base
suffix:semicolon
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
macro_line|#ifdef NS83820_VLAN_ACCEL_SUPPORT
DECL|member|vlgrp
r_struct
id|vlan_group
op_star
id|vlgrp
suffix:semicolon
macro_line|#endif
DECL|member|rx_info
r_struct
id|rx_info
id|rx_info
suffix:semicolon
DECL|member|rx_tasklet
r_struct
id|tasklet_struct
id|rx_tasklet
suffix:semicolon
DECL|member|ihr
r_int
id|ihr
suffix:semicolon
DECL|member|tq_refill
r_struct
id|work_struct
id|tq_refill
suffix:semicolon
multiline_comment|/* protects everything below.  irqsave when using. */
DECL|member|misc_lock
id|spinlock_t
id|misc_lock
suffix:semicolon
DECL|member|CFG_cache
id|u32
id|CFG_cache
suffix:semicolon
DECL|member|MEAR_cache
id|u32
id|MEAR_cache
suffix:semicolon
DECL|member|IMR_cache
id|u32
id|IMR_cache
suffix:semicolon
DECL|member|ee
r_struct
id|eeprom
id|ee
suffix:semicolon
DECL|member|linkstate
r_int
id|linkstate
suffix:semicolon
DECL|member|tx_lock
id|spinlock_t
id|tx_lock
suffix:semicolon
DECL|member|tx_done_idx
id|u16
id|tx_done_idx
suffix:semicolon
DECL|member|tx_idx
id|u16
id|tx_idx
suffix:semicolon
DECL|member|tx_free_idx
r_volatile
id|u16
id|tx_free_idx
suffix:semicolon
multiline_comment|/* idx of free desc chain */
DECL|member|tx_intr_idx
id|u16
id|tx_intr_idx
suffix:semicolon
DECL|member|nr_tx_skbs
id|atomic_t
id|nr_tx_skbs
suffix:semicolon
DECL|member|tx_skbs
r_struct
id|sk_buff
op_star
id|tx_skbs
(braket
id|NR_TX_DESC
)braket
suffix:semicolon
DECL|member|pad
r_char
id|pad
(braket
l_int|16
)braket
id|__attribute__
c_func
(paren
(paren
id|aligned
c_func
(paren
l_int|16
)paren
)paren
)paren
suffix:semicolon
DECL|member|tx_descs
id|u32
op_star
id|tx_descs
suffix:semicolon
DECL|member|tx_phy_descs
id|dma_addr_t
id|tx_phy_descs
suffix:semicolon
DECL|member|tx_watchdog
r_struct
id|timer_list
id|tx_watchdog
suffix:semicolon
)brace
suffix:semicolon
DECL|function|PRIV
r_static
r_inline
r_struct
id|ns83820
op_star
id|PRIV
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|macro|__kick_rx
mdefine_line|#define __kick_rx(dev)&t;writel(CR_RXE, dev-&gt;base + CR)
DECL|function|kick_rx
r_static
r_inline
r_void
id|kick_rx
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;kick_rx: maybe kicking&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|dev-&gt;rx_info.idle
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;actually kicking&bslash;n&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;rx_info.phy_descs
op_plus
(paren
l_int|4
op_star
id|DESC_SIZE
op_star
id|dev-&gt;rx_info.next_rx
)paren
comma
id|dev-&gt;base
op_plus
id|RXDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;rx_info.next_rx
op_eq
id|dev-&gt;rx_info.next_empty
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: uh-oh: next_rx == next_empty???&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
id|__kick_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//free = (tx_done_idx + NR_TX_DESC-2 - free_idx) % NR_TX_DESC
DECL|macro|start_tx_okay
mdefine_line|#define start_tx_okay(dev)&t;&bslash;&n;&t;(((NR_TX_DESC-2 + dev-&gt;tx_done_idx - dev-&gt;tx_free_idx) % NR_TX_DESC) &gt; MIN_TX_DESC_FREE)
macro_line|#ifdef NS83820_VLAN_ACCEL_SUPPORT 
DECL|function|ns83820_vlan_rx_register
r_static
r_void
id|ns83820_vlan_rx_register
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_struct
id|vlan_group
op_star
id|grp
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;tx_lock
)paren
suffix:semicolon
id|dev-&gt;vlgrp
op_assign
id|grp
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;tx_lock
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
)brace
DECL|function|ns83820_vlan_rx_kill_vid
r_static
r_void
id|ns83820_vlan_rx_kill_vid
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_int
r_int
id|vid
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;tx_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;vlgrp
)paren
id|dev-&gt;vlgrp-&gt;vlan_devices
(braket
id|vid
)braket
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;tx_lock
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Packet Receiver&n; *&n; * The hardware supports linked lists of receive descriptors for&n; * which ownership is transfered back and forth by means of an&n; * ownership bit.  While the hardware does support the use of a&n; * ring for receive descriptors, we only make use of a chain in&n; * an attempt to reduce bus traffic under heavy load scenarios.&n; * This will also make bugs a bit more obvious.  The current code&n; * only makes use of a single rx chain; I hope to implement&n; * priority based rx for version 1.0.  Goal: even under overload&n; * conditions, still route realtime traffic with as low jitter as&n; * possible.&n; */
DECL|function|build_rx_desc
r_static
r_inline
r_void
id|build_rx_desc
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
id|u32
op_star
id|desc
comma
id|dma_addr_t
id|link
comma
id|dma_addr_t
id|buf
comma
id|u32
id|cmdsts
comma
id|u32
id|extsts
)paren
(brace
id|desc_addr_set
c_func
(paren
id|desc
op_plus
id|DESC_LINK
comma
id|link
)paren
suffix:semicolon
id|desc_addr_set
c_func
(paren
id|desc
op_plus
id|DESC_BUFPTR
comma
id|buf
)paren
suffix:semicolon
id|desc
(braket
id|DESC_EXTSTS
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|extsts
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|desc
(braket
id|DESC_CMDSTS
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|cmdsts
)paren
suffix:semicolon
)brace
DECL|macro|nr_rx_empty
mdefine_line|#define nr_rx_empty(dev) ((NR_RX_DESC-2 + dev-&gt;rx_info.next_rx - dev-&gt;rx_info.next_empty) % NR_RX_DESC)
DECL|function|ns83820_add_rx_skb
r_static
r_inline
r_int
id|ns83820_add_rx_skb
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|next_empty
suffix:semicolon
id|u32
id|cmdsts
suffix:semicolon
id|u32
op_star
id|sg
suffix:semicolon
id|dma_addr_t
id|buf
suffix:semicolon
id|next_empty
op_assign
id|dev-&gt;rx_info.next_empty
suffix:semicolon
multiline_comment|/* don&squot;t overrun last rx marker */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|nr_rx_empty
c_func
(paren
id|dev
)paren
op_le
l_int|2
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#if 0
id|dprintk
c_func
(paren
l_string|&quot;next_empty[%d] nr_used[%d] next_rx[%d]&bslash;n&quot;
comma
id|dev-&gt;rx_info.next_empty
comma
id|dev-&gt;rx_info.nr_used
comma
id|dev-&gt;rx_info.next_rx
)paren
suffix:semicolon
macro_line|#endif
id|sg
op_assign
id|dev-&gt;rx_info.descs
op_plus
(paren
id|next_empty
op_star
id|DESC_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
l_int|NULL
op_ne
id|dev-&gt;rx_info.skbs
(braket
id|next_empty
)braket
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;rx_info.skbs
(braket
id|next_empty
)braket
op_assign
id|skb
suffix:semicolon
id|dev-&gt;rx_info.next_empty
op_assign
(paren
id|next_empty
op_plus
l_int|1
)paren
op_mod
id|NR_RX_DESC
suffix:semicolon
id|cmdsts
op_assign
id|REAL_RX_BUF_SIZE
op_or
id|CMDSTS_INTR
suffix:semicolon
id|buf
op_assign
id|pci_map_single
c_func
(paren
id|dev-&gt;pci_dev
comma
id|skb-&gt;tail
comma
id|REAL_RX_BUF_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|build_rx_desc
c_func
(paren
id|dev
comma
id|sg
comma
l_int|0
comma
id|buf
comma
id|cmdsts
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* update link of previous rx */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|next_empty
op_ne
id|dev-&gt;rx_info.next_rx
)paren
)paren
id|dev-&gt;rx_info.descs
(braket
(paren
(paren
id|NR_RX_DESC
op_plus
id|next_empty
op_minus
l_int|1
)paren
op_mod
id|NR_RX_DESC
)paren
op_star
id|DESC_SIZE
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|dev-&gt;rx_info.phy_descs
op_plus
(paren
id|next_empty
op_star
id|DESC_SIZE
op_star
l_int|4
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rx_refill
r_static
r_inline
r_int
id|rx_refill
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_int
id|gfp
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|nr_rx_empty
c_func
(paren
id|dev
)paren
op_le
l_int|2
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;rx_refill(%p)&bslash;n&quot;
comma
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gfp
op_eq
id|GFP_ATOMIC
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|res
suffix:semicolon
multiline_comment|/* extra 16 bytes for alignment */
id|skb
op_assign
id|__dev_alloc_skb
c_func
(paren
id|REAL_RX_BUF_SIZE
op_plus
l_int|16
comma
id|gfp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|skb
)paren
)paren
r_break
suffix:semicolon
id|res
op_assign
(paren
r_int
)paren
id|skb-&gt;tail
op_amp
l_int|0xf
suffix:semicolon
id|res
op_assign
l_int|0x10
op_minus
id|res
suffix:semicolon
id|res
op_and_assign
l_int|0xf
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|res
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|ndev
suffix:semicolon
r_if
c_cond
(paren
id|gfp
op_ne
id|GFP_ATOMIC
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
comma
id|flags
)paren
suffix:semicolon
id|res
op_assign
id|ns83820_add_rx_skb
c_func
(paren
id|dev
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gfp
op_ne
id|GFP_ATOMIC
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|i
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|gfp
op_eq
id|GFP_ATOMIC
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|i
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_static
r_void
id|FASTCALL
c_func
(paren
id|rx_refill_atomic
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
)paren
suffix:semicolon
DECL|function|rx_refill_atomic
r_static
r_void
id|fastcall
id|rx_refill_atomic
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
id|rx_refill
c_func
(paren
id|ndev
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
multiline_comment|/* REFILL */
DECL|function|queue_refill
r_static
r_inline
r_void
id|queue_refill
c_func
(paren
r_void
op_star
id|_dev
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
id|_dev
suffix:semicolon
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|rx_refill
c_func
(paren
id|ndev
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;rx_info.up
)paren
id|kick_rx
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
DECL|function|clear_rx_desc
r_static
r_inline
r_void
id|clear_rx_desc
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
r_int
id|i
)paren
(brace
id|build_rx_desc
c_func
(paren
id|dev
comma
id|dev-&gt;rx_info.descs
op_plus
(paren
id|DESC_SIZE
op_star
id|i
)paren
comma
l_int|0
comma
l_int|0
comma
id|CMDSTS_OWN
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
id|FASTCALL
c_func
(paren
id|phy_intr
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
)paren
suffix:semicolon
DECL|function|phy_intr
r_static
r_void
id|fastcall
id|phy_intr
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_static
r_char
op_star
id|speeds
(braket
)braket
op_assign
(brace
l_string|&quot;10&quot;
comma
l_string|&quot;100&quot;
comma
l_string|&quot;1000&quot;
comma
l_string|&quot;1000(?)&quot;
comma
l_string|&quot;1000F&quot;
)brace
suffix:semicolon
id|u32
id|cfg
comma
id|new_cfg
suffix:semicolon
id|u32
id|tbisr
comma
id|tanar
comma
id|tanlpar
suffix:semicolon
r_int
id|speed
comma
id|fullduplex
comma
id|newlinkstate
suffix:semicolon
id|cfg
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|CFG
)paren
op_xor
id|SPDSTS_POLARITY
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;CFG_cache
op_amp
id|CFG_TBI_EN
)paren
(brace
multiline_comment|/* we have an optical transceiver */
id|tbisr
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|TBISR
)paren
suffix:semicolon
id|tanar
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|TANAR
)paren
suffix:semicolon
id|tanlpar
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|TANLPAR
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;phy_intr: tbisr=%08x, tanar=%08x, tanlpar=%08x&bslash;n&quot;
comma
id|tbisr
comma
id|tanar
comma
id|tanlpar
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fullduplex
op_assign
(paren
id|tanlpar
op_amp
id|TANAR_FULL_DUP
)paren
op_logical_and
(paren
id|tanar
op_amp
id|TANAR_FULL_DUP
)paren
)paren
)paren
(brace
multiline_comment|/* both of us are full duplex */
id|writel
c_func
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|TXCFG
)paren
op_or
id|TXCFG_CSI
op_or
id|TXCFG_HBI
op_or
id|TXCFG_ATP
comma
id|dev-&gt;base
op_plus
id|TXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|RXCFG
)paren
op_or
id|RXCFG_RX_FD
comma
id|dev-&gt;base
op_plus
id|RXCFG
)paren
suffix:semicolon
multiline_comment|/* Light up full duplex LED */
id|writel
c_func
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|GPIOR
)paren
op_or
id|GPIOR_GP1_OUT
comma
id|dev-&gt;base
op_plus
id|GPIOR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
(paren
id|tanlpar
op_amp
id|TANAR_HALF_DUP
)paren
op_logical_and
(paren
id|tanar
op_amp
id|TANAR_HALF_DUP
)paren
)paren
op_logical_or
(paren
(paren
id|tanlpar
op_amp
id|TANAR_FULL_DUP
)paren
op_logical_and
(paren
id|tanar
op_amp
id|TANAR_HALF_DUP
)paren
)paren
op_logical_or
(paren
(paren
id|tanlpar
op_amp
id|TANAR_HALF_DUP
)paren
op_logical_and
(paren
id|tanar
op_amp
id|TANAR_FULL_DUP
)paren
)paren
)paren
(brace
multiline_comment|/* one or both of us are half duplex */
id|writel
c_func
(paren
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|TXCFG
)paren
op_amp
op_complement
(paren
id|TXCFG_CSI
op_or
id|TXCFG_HBI
)paren
)paren
op_or
id|TXCFG_ATP
comma
id|dev-&gt;base
op_plus
id|TXCFG
)paren
suffix:semicolon
id|writel
c_func
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|RXCFG
)paren
op_amp
op_complement
id|RXCFG_RX_FD
comma
id|dev-&gt;base
op_plus
id|RXCFG
)paren
suffix:semicolon
multiline_comment|/* Turn off full duplex LED */
id|writel
c_func
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|GPIOR
)paren
op_amp
op_complement
id|GPIOR_GP1_OUT
comma
id|dev-&gt;base
op_plus
id|GPIOR
)paren
suffix:semicolon
)brace
id|speed
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* 1000F */
)brace
r_else
(brace
multiline_comment|/* we have a copper transceiver */
id|new_cfg
op_assign
id|dev-&gt;CFG_cache
op_amp
op_complement
(paren
id|CFG_SB
op_or
id|CFG_MODE_1000
op_or
id|CFG_SPDSTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cfg
op_amp
id|CFG_SPDSTS1
)paren
id|new_cfg
op_or_assign
id|CFG_MODE_1000
suffix:semicolon
r_else
id|new_cfg
op_and_assign
op_complement
id|CFG_MODE_1000
suffix:semicolon
id|speed
op_assign
(paren
(paren
id|cfg
op_div
id|CFG_SPDSTS0
)paren
op_amp
l_int|3
)paren
suffix:semicolon
id|fullduplex
op_assign
(paren
id|cfg
op_amp
id|CFG_DUPSTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fullduplex
)paren
id|new_cfg
op_or_assign
id|CFG_SB
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cfg
op_amp
id|CFG_LNKSTS
)paren
op_logical_and
(paren
(paren
id|new_cfg
op_xor
id|dev-&gt;CFG_cache
)paren
op_amp
id|CFG_MODE_1000
)paren
)paren
(brace
id|writel
c_func
(paren
id|new_cfg
comma
id|dev-&gt;base
op_plus
id|CFG
)paren
suffix:semicolon
id|dev-&gt;CFG_cache
op_assign
id|new_cfg
suffix:semicolon
)brace
id|dev-&gt;CFG_cache
op_and_assign
op_complement
id|CFG_SPDSTS
suffix:semicolon
id|dev-&gt;CFG_cache
op_or_assign
id|cfg
op_amp
id|CFG_SPDSTS
suffix:semicolon
)brace
id|newlinkstate
op_assign
(paren
id|cfg
op_amp
id|CFG_LNKSTS
)paren
ques
c_cond
id|LINK_UP
suffix:colon
id|LINK_DOWN
suffix:semicolon
r_if
c_cond
(paren
id|newlinkstate
op_amp
id|LINK_UP
op_logical_and
id|dev-&gt;linkstate
op_ne
id|newlinkstate
)paren
(brace
id|netif_start_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link now %s mbps, %s duplex and up.&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|speeds
(braket
id|speed
)braket
comma
id|fullduplex
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|newlinkstate
op_amp
id|LINK_DOWN
op_logical_and
id|dev-&gt;linkstate
op_ne
id|newlinkstate
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link now down.&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
)brace
id|dev-&gt;linkstate
op_assign
id|newlinkstate
suffix:semicolon
)brace
DECL|function|ns83820_setup_rx
r_static
r_int
id|ns83820_setup_rx
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;ns83820_setup_rx(%p)&bslash;n&quot;
comma
id|ndev
)paren
suffix:semicolon
id|dev-&gt;rx_info.idle
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;rx_info.next_rx
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;rx_info.next_rx_desc
op_assign
id|dev-&gt;rx_info.descs
suffix:semicolon
id|dev-&gt;rx_info.next_empty
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
id|clear_rx_desc
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|RXDP_HI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;rx_info.phy_descs
comma
id|dev-&gt;base
op_plus
id|RXDP
)paren
suffix:semicolon
id|ret
op_assign
id|rx_refill
c_func
(paren
id|ndev
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;starting receiver&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* prevent the interrupt handler from stomping on us */
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x0001
comma
id|dev-&gt;base
op_plus
id|CCSR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|RFCR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x7fc00000
comma
id|dev-&gt;base
op_plus
id|RFCR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffc00000
comma
id|dev-&gt;base
op_plus
id|RFCR
)paren
suffix:semicolon
id|dev-&gt;rx_info.up
op_assign
l_int|1
suffix:semicolon
id|phy_intr
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* Okay, let it rip */
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_PHY
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_RXRCMP
suffix:semicolon
singleline_comment|//dev-&gt;IMR_cache |= ISR_RXERR;
singleline_comment|//dev-&gt;IMR_cache |= ISR_RXOK;
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_RXORN
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_RXSOVR
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_RXDESC
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_RXIDLE
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_TXDESC
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_TXIDLE
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;IMR_cache
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|1
comma
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|kick_rx
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ns83820_cleanup_rx
r_static
r_void
id|ns83820_cleanup_rx
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;ns83820_cleanup_rx(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* disable receive interrupts */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;misc_lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_and_assign
op_complement
(paren
id|ISR_RXOK
op_or
id|ISR_RXDESC
op_or
id|ISR_RXERR
op_or
id|ISR_RXEARLY
op_or
id|ISR_RXIDLE
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;IMR_cache
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;misc_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* synchronize with the interrupt handler and kill it */
id|dev-&gt;rx_info.up
op_assign
l_int|0
suffix:semicolon
id|synchronize_irq
c_func
(paren
id|dev-&gt;pci_dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* touch the pci bus... */
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
multiline_comment|/* assumes the transmitter is already disabled and reset */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|RXDP_HI
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|RXDP
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev-&gt;rx_info.skbs
(braket
id|i
)braket
suffix:semicolon
id|dev-&gt;rx_info.skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|clear_rx_desc
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
id|FASTCALL
c_func
(paren
id|ns83820_rx_kick
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
)paren
suffix:semicolon
DECL|function|ns83820_rx_kick
r_static
r_void
id|fastcall
id|ns83820_rx_kick
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/*if (nr_rx_empty(dev) &gt;= NR_RX_DESC/4)*/
(brace
r_if
c_cond
(paren
id|dev-&gt;rx_info.up
)paren
(brace
id|rx_refill_atomic
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|kick_rx
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;rx_info.up
op_logical_and
id|nr_rx_empty
c_func
(paren
id|dev
)paren
OG
id|NR_RX_DESC
op_star
l_int|3
op_div
l_int|4
)paren
id|schedule_work
c_func
(paren
op_amp
id|dev-&gt;tq_refill
)paren
suffix:semicolon
r_else
id|kick_rx
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;rx_info.idle
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: BAD&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* rx_irq&n; *&t;&n; */
r_static
r_void
id|FASTCALL
c_func
(paren
id|rx_irq
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
)paren
suffix:semicolon
DECL|function|rx_irq
r_static
r_void
id|fastcall
id|rx_irq
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_struct
id|rx_info
op_star
id|info
op_assign
op_amp
id|dev-&gt;rx_info
suffix:semicolon
r_int
id|next_rx
suffix:semicolon
r_int
id|rx_rc
comma
id|len
suffix:semicolon
id|u32
id|cmdsts
comma
op_star
id|desc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|nr
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;rx_irq(%p)&bslash;n&quot;
comma
id|ndev
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;rxdp: %08x, descs: %08lx next_rx[%d]: %p next_empty[%d]: %p&bslash;n&quot;
comma
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|RXDP
)paren
comma
(paren
r_int
)paren
(paren
id|dev-&gt;rx_info.phy_descs
)paren
comma
(paren
r_int
)paren
id|dev-&gt;rx_info.next_rx
comma
(paren
id|dev-&gt;rx_info.descs
op_plus
(paren
id|DESC_SIZE
op_star
id|dev-&gt;rx_info.next_rx
)paren
)paren
comma
(paren
r_int
)paren
id|dev-&gt;rx_info.next_empty
comma
(paren
id|dev-&gt;rx_info.descs
op_plus
(paren
id|DESC_SIZE
op_star
id|dev-&gt;rx_info.next_empty
)paren
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;up
)paren
r_goto
id|out
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;walking descs&bslash;n&quot;
)paren
suffix:semicolon
id|next_rx
op_assign
id|info-&gt;next_rx
suffix:semicolon
id|desc
op_assign
id|info-&gt;next_rx_desc
suffix:semicolon
r_while
c_loop
(paren
(paren
id|CMDSTS_OWN
op_amp
(paren
id|cmdsts
op_assign
id|le32_to_cpu
c_func
(paren
id|desc
(braket
id|DESC_CMDSTS
)braket
)paren
)paren
)paren
op_logical_and
(paren
id|cmdsts
op_ne
id|CMDSTS_OWN
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u32
id|extsts
op_assign
id|le32_to_cpu
c_func
(paren
id|desc
(braket
id|DESC_EXTSTS
)braket
)paren
suffix:semicolon
id|dma_addr_t
id|bufptr
op_assign
id|desc_addr_get
c_func
(paren
id|desc
op_plus
id|DESC_BUFPTR
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;cmdsts: %08x&bslash;n&quot;
comma
id|cmdsts
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;link: %08x&bslash;n&quot;
comma
id|cpu_to_le32
c_func
(paren
id|desc
(braket
id|DESC_LINK
)braket
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;extsts: %08x&bslash;n&quot;
comma
id|extsts
)paren
suffix:semicolon
id|skb
op_assign
id|info-&gt;skbs
(braket
id|next_rx
)braket
suffix:semicolon
id|info-&gt;skbs
(braket
id|next_rx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;next_rx
op_assign
(paren
id|next_rx
op_plus
l_int|1
)paren
op_mod
id|NR_RX_DESC
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|clear_rx_desc
c_func
(paren
id|dev
comma
id|next_rx
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|dev-&gt;pci_dev
comma
id|bufptr
comma
id|RX_BUF_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|len
op_assign
id|cmdsts
op_amp
id|CMDSTS_LEN_MASK
suffix:semicolon
macro_line|#ifdef NS83820_VLAN_ACCEL_SUPPORT
multiline_comment|/* NH: As was mentioned below, this chip is kinda&n;&t;&t; * brain dead about vlan tag stripping.  Frames&n;&t;&t; * that are 64 bytes with a vlan header appended&n;&t;&t; * like arp frames, or pings, are flagged as Runts&n;&t;&t; * when the tag is stripped and hardware.  This&n;&t;&t; * also means that the OK bit in the descriptor &n;&t;&t; * is cleared when the frame comes in so we have&n;&t;&t; * to do a specific length check here to make sure&n;&t;&t; * the frame would have been ok, had we not stripped&n;&t;&t; * the tag.&n;&t;&t; */
r_if
c_cond
(paren
id|likely
c_func
(paren
(paren
id|CMDSTS_OK
op_amp
id|cmdsts
)paren
op_logical_or
(paren
(paren
id|cmdsts
op_amp
id|CMDSTS_RUNT
)paren
op_logical_and
id|len
op_ge
l_int|56
)paren
)paren
)paren
(brace
macro_line|#else
r_if
c_cond
(paren
id|likely
c_func
(paren
id|CMDSTS_OK
op_amp
id|cmdsts
)paren
)paren
(brace
macro_line|#endif
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|skb
)paren
)paren
r_goto
id|netdev_mangle_me_harder_failed
suffix:semicolon
r_if
c_cond
(paren
id|cmdsts
op_amp
id|CMDSTS_DEST_MULTI
)paren
id|dev-&gt;stats.multicast
op_increment
suffix:semicolon
id|dev-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|dev-&gt;stats.rx_bytes
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|extsts
op_amp
l_int|0x002a0000
)paren
op_logical_and
op_logical_neg
(paren
id|extsts
op_amp
l_int|0x00540000
)paren
)paren
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|ndev
)paren
suffix:semicolon
macro_line|#ifdef NS83820_VLAN_ACCEL_SUPPORT 
r_if
c_cond
(paren
id|extsts
op_amp
id|EXTSTS_VPKT
)paren
(brace
r_int
r_int
id|tag
suffix:semicolon
id|tag
op_assign
id|ntohs
c_func
(paren
id|extsts
op_amp
id|EXTSTS_VTG_MASK
)paren
suffix:semicolon
id|rx_rc
op_assign
id|vlan_hwaccel_rx
c_func
(paren
id|skb
comma
id|dev-&gt;vlgrp
comma
id|tag
)paren
suffix:semicolon
)brace
r_else
(brace
id|rx_rc
op_assign
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
macro_line|#else
id|rx_rc
op_assign
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|NET_RX_DROP
op_eq
id|rx_rc
)paren
(brace
id|netdev_mangle_me_harder_failed
suffix:colon
id|dev-&gt;stats.rx_dropped
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|nr
op_increment
suffix:semicolon
id|next_rx
op_assign
id|info-&gt;next_rx
suffix:semicolon
id|desc
op_assign
id|info-&gt;descs
op_plus
(paren
id|DESC_SIZE
op_star
id|next_rx
)paren
suffix:semicolon
)brace
id|info-&gt;next_rx
op_assign
id|next_rx
suffix:semicolon
id|info-&gt;next_rx_desc
op_assign
id|info-&gt;descs
op_plus
(paren
id|DESC_SIZE
op_star
id|next_rx
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
l_int|0
op_logical_and
op_logical_neg
id|nr
)paren
(brace
id|Dprintk
c_func
(paren
l_string|&quot;dazed: cmdsts_f: %08x&bslash;n&quot;
comma
id|cmdsts
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|rx_action
r_static
r_void
id|rx_action
c_func
(paren
r_int
r_int
id|_dev
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
(paren
r_void
op_star
)paren
id|_dev
suffix:semicolon
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|rx_irq
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|writel
c_func
(paren
id|ihr
comma
id|dev-&gt;base
op_plus
id|IHR
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_RXDESC
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;IMR_cache
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|rx_irq
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|ns83820_rx_kick
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
multiline_comment|/* Packet Transmit code&n; */
DECL|function|kick_tx
r_static
r_inline
r_void
id|kick_tx
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;kick_tx(%p): tx_idx=%d free_idx=%d&bslash;n&quot;
comma
id|dev
comma
id|dev-&gt;tx_idx
comma
id|dev-&gt;tx_free_idx
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CR_TXE
comma
id|dev-&gt;base
op_plus
id|CR
)paren
suffix:semicolon
)brace
multiline_comment|/* No spinlock needed on the transmit irq path as the interrupt handler is&n; * serialized.&n; */
DECL|function|do_tx_done
r_static
r_void
id|do_tx_done
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|u32
id|cmdsts
comma
id|tx_done_idx
comma
op_star
id|desc
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;tx_lock
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;do_tx_done(%p)&bslash;n&quot;
comma
id|ndev
)paren
suffix:semicolon
id|tx_done_idx
op_assign
id|dev-&gt;tx_done_idx
suffix:semicolon
id|desc
op_assign
id|dev-&gt;tx_descs
op_plus
(paren
id|tx_done_idx
op_star
id|DESC_SIZE
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;tx_done_idx=%d free_idx=%d cmdsts=%08x&bslash;n&quot;
comma
id|tx_done_idx
comma
id|dev-&gt;tx_free_idx
comma
id|le32_to_cpu
c_func
(paren
id|desc
(braket
id|DESC_CMDSTS
)braket
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tx_done_idx
op_ne
id|dev-&gt;tx_free_idx
)paren
op_logical_and
op_logical_neg
(paren
id|CMDSTS_OWN
op_amp
(paren
id|cmdsts
op_assign
id|le32_to_cpu
c_func
(paren
id|desc
(braket
id|DESC_CMDSTS
)braket
)paren
)paren
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|len
suffix:semicolon
id|dma_addr_t
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|cmdsts
op_amp
id|CMDSTS_ERR
)paren
id|dev-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cmdsts
op_amp
id|CMDSTS_OK
)paren
id|dev-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cmdsts
op_amp
id|CMDSTS_OK
)paren
id|dev-&gt;stats.tx_bytes
op_add_assign
id|cmdsts
op_amp
l_int|0xffff
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;tx_done_idx=%d free_idx=%d cmdsts=%08x&bslash;n&quot;
comma
id|tx_done_idx
comma
id|dev-&gt;tx_free_idx
comma
id|cmdsts
)paren
suffix:semicolon
id|skb
op_assign
id|dev-&gt;tx_skbs
(braket
id|tx_done_idx
)braket
suffix:semicolon
id|dev-&gt;tx_skbs
(braket
id|tx_done_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;done(%p)&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
id|len
op_assign
id|cmdsts
op_amp
id|CMDSTS_LEN_MASK
suffix:semicolon
id|addr
op_assign
id|desc_addr_get
c_func
(paren
id|desc
op_plus
id|DESC_BUFPTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|dev-&gt;pci_dev
comma
id|addr
comma
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|dev-&gt;nr_tx_skbs
)paren
suffix:semicolon
)brace
r_else
id|pci_unmap_page
c_func
(paren
id|dev-&gt;pci_dev
comma
id|addr
comma
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|tx_done_idx
op_assign
(paren
id|tx_done_idx
op_plus
l_int|1
)paren
op_mod
id|NR_TX_DESC
suffix:semicolon
id|dev-&gt;tx_done_idx
op_assign
id|tx_done_idx
suffix:semicolon
id|desc
(braket
id|DESC_CMDSTS
)braket
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|desc
op_assign
id|dev-&gt;tx_descs
op_plus
(paren
id|tx_done_idx
op_star
id|DESC_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* Allow network stack to resume queueing packets after we&squot;ve&n;&t; * finished transmitting at least 1/4 of the packets in the queue.&n;&t; */
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|ndev
)paren
op_logical_and
id|start_tx_okay
c_func
(paren
id|dev
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;start_queue(%p)&bslash;n&quot;
comma
id|ndev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;tx_lock
)paren
suffix:semicolon
)brace
DECL|function|ns83820_cleanup_tx
r_static
r_void
id|ns83820_cleanup_tx
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev-&gt;tx_skbs
(braket
id|i
)braket
suffix:semicolon
id|dev-&gt;tx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|u32
op_star
id|desc
op_assign
id|dev-&gt;tx_descs
op_plus
(paren
id|i
op_star
id|DESC_SIZE
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|dev-&gt;pci_dev
comma
id|desc_addr_get
c_func
(paren
id|desc
op_plus
id|DESC_BUFPTR
)paren
comma
id|le32_to_cpu
c_func
(paren
id|desc
(braket
id|DESC_CMDSTS
)braket
)paren
op_amp
id|CMDSTS_LEN_MASK
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|dev-&gt;nr_tx_skbs
)paren
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
id|dev-&gt;tx_descs
comma
l_int|0
comma
id|NR_TX_DESC
op_star
id|DESC_SIZE
op_star
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* transmit routine.  This code relies on the network layer serializing&n; * its calls in, but will run happily in parallel with the interrupt&n; * handler.  This code currently has provisions for fragmenting tx buffers&n; * while trying to track down a bug in either the zero copy code or&n; * the tx fifo (hence the MAX_FRAG_LEN).&n; */
DECL|function|ns83820_hard_start_xmit
r_static
r_int
id|ns83820_hard_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|u32
id|free_idx
comma
id|cmdsts
comma
id|extsts
suffix:semicolon
r_int
id|nr_free
comma
id|nr_frags
suffix:semicolon
r_int
id|tx_done_idx
comma
id|last_idx
suffix:semicolon
id|dma_addr_t
id|buf
suffix:semicolon
r_int
id|len
suffix:semicolon
id|skb_frag_t
op_star
id|frag
suffix:semicolon
r_int
id|stopped
op_assign
l_int|0
suffix:semicolon
r_int
id|do_intr
op_assign
l_int|0
suffix:semicolon
r_volatile
id|u32
op_star
id|first_desc
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;ns83820_hard_start_xmit&bslash;n&quot;
)paren
suffix:semicolon
id|nr_frags
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
id|again
suffix:colon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|dev-&gt;CFG_cache
op_amp
id|CFG_LNKSTS
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|dev-&gt;CFG_cache
op_amp
id|CFG_LNKSTS
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
id|last_idx
op_assign
id|free_idx
op_assign
id|dev-&gt;tx_free_idx
suffix:semicolon
id|tx_done_idx
op_assign
id|dev-&gt;tx_done_idx
suffix:semicolon
id|nr_free
op_assign
(paren
id|tx_done_idx
op_plus
id|NR_TX_DESC
op_minus
l_int|2
op_minus
id|free_idx
)paren
op_mod
id|NR_TX_DESC
suffix:semicolon
id|nr_free
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|nr_free
op_le
id|nr_frags
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;stop_queue - not enough(%p)&bslash;n&quot;
comma
id|ndev
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* Check again: we may have raced with a tx done irq */
r_if
c_cond
(paren
id|dev-&gt;tx_done_idx
op_ne
id|tx_done_idx
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;restart queue(%p)&bslash;n&quot;
comma
id|ndev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|free_idx
op_eq
id|dev-&gt;tx_intr_idx
)paren
(brace
id|do_intr
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;tx_intr_idx
op_assign
(paren
id|dev-&gt;tx_intr_idx
op_plus
id|NR_TX_DESC
op_div
l_int|4
)paren
op_mod
id|NR_TX_DESC
suffix:semicolon
)brace
id|nr_free
op_sub_assign
id|nr_frags
suffix:semicolon
r_if
c_cond
(paren
id|nr_free
OL
id|MIN_TX_DESC_FREE
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;stop_queue - last entry(%p)&bslash;n&quot;
comma
id|ndev
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|stopped
op_assign
l_int|1
suffix:semicolon
)brace
id|frag
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nr_frags
)paren
id|frag
op_assign
l_int|NULL
suffix:semicolon
id|extsts
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;ip_summed
op_eq
id|CHECKSUM_HW
)paren
(brace
id|extsts
op_or_assign
id|EXTSTS_IPPKT
suffix:semicolon
r_if
c_cond
(paren
id|IPPROTO_TCP
op_eq
id|skb-&gt;nh.iph-&gt;protocol
)paren
id|extsts
op_or_assign
id|EXTSTS_TCPPKT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|IPPROTO_UDP
op_eq
id|skb-&gt;nh.iph-&gt;protocol
)paren
id|extsts
op_or_assign
id|EXTSTS_UDPPKT
suffix:semicolon
)brace
macro_line|#ifdef NS83820_VLAN_ACCEL_SUPPORT
r_if
c_cond
(paren
id|vlan_tx_tag_present
c_func
(paren
id|skb
)paren
)paren
(brace
multiline_comment|/* fetch the vlan tag info out of the&n;&t;&t; * ancilliary data if the vlan code&n;&t;&t; * is using hw vlan acceleration&n;&t;&t; */
r_int
id|tag
op_assign
id|vlan_tx_tag_get
c_func
(paren
id|skb
)paren
suffix:semicolon
id|extsts
op_or_assign
(paren
id|EXTSTS_VPKT
op_or
id|htons
c_func
(paren
id|tag
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|nr_frags
)paren
id|len
op_sub_assign
id|skb-&gt;data_len
suffix:semicolon
id|buf
op_assign
id|pci_map_single
c_func
(paren
id|dev-&gt;pci_dev
comma
id|skb-&gt;data
comma
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|first_desc
op_assign
id|dev-&gt;tx_descs
op_plus
(paren
id|free_idx
op_star
id|DESC_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_volatile
id|u32
op_star
id|desc
op_assign
id|dev-&gt;tx_descs
op_plus
(paren
id|free_idx
op_star
id|DESC_SIZE
)paren
suffix:semicolon
id|u32
id|residue
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;frag[%3u]: %4u @ 0x%08Lx&bslash;n&quot;
comma
id|free_idx
comma
id|len
comma
(paren
r_int
r_int
r_int
)paren
id|buf
)paren
suffix:semicolon
id|last_idx
op_assign
id|free_idx
suffix:semicolon
id|free_idx
op_assign
(paren
id|free_idx
op_plus
l_int|1
)paren
op_mod
id|NR_TX_DESC
suffix:semicolon
id|desc
(braket
id|DESC_LINK
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|dev-&gt;tx_phy_descs
op_plus
(paren
id|free_idx
op_star
id|DESC_SIZE
op_star
l_int|4
)paren
)paren
suffix:semicolon
id|desc_addr_set
c_func
(paren
id|desc
op_plus
id|DESC_BUFPTR
comma
id|buf
)paren
suffix:semicolon
id|desc
(braket
id|DESC_EXTSTS
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|extsts
)paren
suffix:semicolon
id|cmdsts
op_assign
(paren
(paren
id|nr_frags
op_or
id|residue
)paren
ques
c_cond
id|CMDSTS_MORE
suffix:colon
id|do_intr
ques
c_cond
id|CMDSTS_INTR
suffix:colon
l_int|0
)paren
suffix:semicolon
id|cmdsts
op_or_assign
(paren
id|desc
op_eq
id|first_desc
)paren
ques
c_cond
l_int|0
suffix:colon
id|CMDSTS_OWN
suffix:semicolon
id|cmdsts
op_or_assign
id|len
suffix:semicolon
id|desc
(braket
id|DESC_CMDSTS
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|cmdsts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|residue
)paren
(brace
id|buf
op_add_assign
id|len
suffix:semicolon
id|len
op_assign
id|residue
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|nr_frags
)paren
r_break
suffix:semicolon
id|buf
op_assign
id|pci_map_page
c_func
(paren
id|dev-&gt;pci_dev
comma
id|frag-&gt;page
comma
id|frag-&gt;page_offset
comma
id|frag-&gt;size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;frag: buf=%08Lx  page=%08lx offset=%08lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|buf
comma
(paren
r_int
)paren
id|page_to_pfn
c_func
(paren
id|frag-&gt;page
)paren
comma
id|frag-&gt;page_offset
)paren
suffix:semicolon
id|len
op_assign
id|frag-&gt;size
suffix:semicolon
id|frag
op_increment
suffix:semicolon
id|nr_frags
op_decrement
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;done pkt&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;tx_lock
)paren
suffix:semicolon
id|dev-&gt;tx_skbs
(braket
id|last_idx
)braket
op_assign
id|skb
suffix:semicolon
id|first_desc
(braket
id|DESC_CMDSTS
)braket
op_or_assign
id|cpu_to_le32
c_func
(paren
id|CMDSTS_OWN
)paren
suffix:semicolon
id|dev-&gt;tx_free_idx
op_assign
id|free_idx
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;nr_tx_skbs
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;tx_lock
)paren
suffix:semicolon
id|kick_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check again: we may have raced with a tx done irq */
r_if
c_cond
(paren
id|stopped
op_logical_and
(paren
id|dev-&gt;tx_done_idx
op_ne
id|tx_done_idx
)paren
op_logical_and
id|start_tx_okay
c_func
(paren
id|dev
)paren
)paren
id|netif_start_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* set the transmit start time to catch transmit timeouts */
id|ndev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ns83820_update_stats
r_static
r_void
id|ns83820_update_stats
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
id|u8
id|__iomem
op_star
id|base
op_assign
id|dev-&gt;base
suffix:semicolon
multiline_comment|/* the DP83820 will freeze counters, so we need to read all of them */
id|dev-&gt;stats.rx_errors
op_add_assign
id|readl
c_func
(paren
id|base
op_plus
l_int|0x60
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|dev-&gt;stats.rx_crc_errors
op_add_assign
id|readl
c_func
(paren
id|base
op_plus
l_int|0x64
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|dev-&gt;stats.rx_missed_errors
op_add_assign
id|readl
c_func
(paren
id|base
op_plus
l_int|0x68
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|dev-&gt;stats.rx_frame_errors
op_add_assign
id|readl
c_func
(paren
id|base
op_plus
l_int|0x6c
)paren
op_amp
l_int|0xffff
suffix:semicolon
multiline_comment|/*dev-&gt;stats.rx_symbol_errors +=*/
id|readl
c_func
(paren
id|base
op_plus
l_int|0x70
)paren
suffix:semicolon
id|dev-&gt;stats.rx_length_errors
op_add_assign
id|readl
c_func
(paren
id|base
op_plus
l_int|0x74
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|dev-&gt;stats.rx_length_errors
op_add_assign
id|readl
c_func
(paren
id|base
op_plus
l_int|0x78
)paren
op_amp
l_int|0xffff
suffix:semicolon
multiline_comment|/*dev-&gt;stats.rx_badopcode_errors += */
id|readl
c_func
(paren
id|base
op_plus
l_int|0x7c
)paren
suffix:semicolon
multiline_comment|/*dev-&gt;stats.rx_pause_count += */
id|readl
c_func
(paren
id|base
op_plus
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/*dev-&gt;stats.tx_pause_count += */
id|readl
c_func
(paren
id|base
op_plus
l_int|0x84
)paren
suffix:semicolon
id|dev-&gt;stats.tx_carrier_errors
op_add_assign
id|readl
c_func
(paren
id|base
op_plus
l_int|0x88
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
DECL|function|ns83820_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|ns83820_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* somewhat overkill */
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|ns83820_update_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
r_return
op_amp
id|dev-&gt;stats
suffix:semicolon
)brace
DECL|function|ns83820_get_drvinfo
r_static
r_void
id|ns83820_get_drvinfo
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_struct
id|ethtool_drvinfo
op_star
id|info
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;driver
comma
l_string|&quot;ns83820&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;version
comma
id|VERSION
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;bus_info
comma
id|pci_name
c_func
(paren
id|dev-&gt;pci_dev
)paren
)paren
suffix:semicolon
)brace
DECL|function|ns83820_get_link
r_static
id|u32
id|ns83820_get_link
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|u32
id|cfg
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|CFG
)paren
op_xor
id|SPDSTS_POLARITY
suffix:semicolon
r_return
id|cfg
op_amp
id|CFG_LNKSTS
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|variable|ops
r_static
r_struct
id|ethtool_ops
id|ops
op_assign
(brace
dot
id|get_drvinfo
op_assign
id|ns83820_get_drvinfo
comma
dot
id|get_link
op_assign
id|ns83820_get_link
)brace
suffix:semicolon
DECL|function|ns83820_mib_isr
r_static
r_void
id|ns83820_mib_isr
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|ns83820_update_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
)brace
r_static
r_void
id|ns83820_do_isr
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
id|u32
id|isr
)paren
suffix:semicolon
DECL|function|ns83820_irq
r_static
id|irqreturn_t
id|ns83820_irq
c_func
(paren
r_int
id|foo
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
id|data
suffix:semicolon
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|u32
id|isr
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;ns83820_irq(%p)&bslash;n&quot;
comma
id|ndev
)paren
suffix:semicolon
id|dev-&gt;ihr
op_assign
l_int|0
suffix:semicolon
id|isr
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|ISR
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;irq: %08x&bslash;n&quot;
comma
id|isr
)paren
suffix:semicolon
id|ns83820_do_isr
c_func
(paren
id|ndev
comma
id|isr
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|ns83820_do_isr
r_static
r_void
id|ns83820_do_isr
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
id|u32
id|isr
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|isr
op_amp
op_complement
(paren
id|ISR_PHY
op_or
id|ISR_RXDESC
op_or
id|ISR_RXEARLY
op_or
id|ISR_RXOK
op_or
id|ISR_RXERR
op_or
id|ISR_TXIDLE
op_or
id|ISR_TXOK
op_or
id|ISR_TXDESC
)paren
)paren
id|Dprintk
c_func
(paren
l_string|&quot;odd isr? 0x%08x&bslash;n&quot;
comma
id|isr
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ISR_RXIDLE
op_amp
id|isr
)paren
(brace
id|dev-&gt;rx_info.idle
op_assign
l_int|1
suffix:semicolon
id|Dprintk
c_func
(paren
l_string|&quot;oh dear, we are idle&bslash;n&quot;
)paren
suffix:semicolon
id|ns83820_rx_kick
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ISR_RXDESC
op_or
id|ISR_RXOK
)paren
op_amp
id|isr
)paren
(brace
id|prefetch
c_func
(paren
id|dev-&gt;rx_info.next_rx_desc
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_and_assign
op_complement
(paren
id|ISR_RXDESC
op_or
id|ISR_RXOK
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;IMR_cache
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|dev-&gt;rx_tasklet
)paren
suffix:semicolon
singleline_comment|//rx_irq(ndev);
singleline_comment|//writel(4, dev-&gt;base + IHR);
)brace
r_if
c_cond
(paren
(paren
id|ISR_RXIDLE
op_or
id|ISR_RXORN
op_or
id|ISR_RXDESC
op_or
id|ISR_RXOK
op_or
id|ISR_RXERR
)paren
op_amp
id|isr
)paren
id|ns83820_rx_kick
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ISR_RXSOVR
op_amp
id|isr
)paren
)paren
(brace
singleline_comment|//printk(&quot;overrun: rxsovr&bslash;n&quot;);
id|dev-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ISR_RXORN
op_amp
id|isr
)paren
)paren
(brace
singleline_comment|//printk(&quot;overrun: rxorn&bslash;n&quot;);
id|dev-&gt;stats.rx_fifo_errors
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ISR_RXRCMP
op_amp
id|isr
)paren
op_logical_and
id|dev-&gt;rx_info.up
)paren
id|writel
c_func
(paren
id|CR_RXE
comma
id|dev-&gt;base
op_plus
id|CR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ISR_TXIDLE
op_amp
id|isr
)paren
(brace
id|u32
id|txdp
suffix:semicolon
id|txdp
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|TXDP
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;txdp: %08x&bslash;n&quot;
comma
id|txdp
)paren
suffix:semicolon
id|txdp
op_sub_assign
id|dev-&gt;tx_phy_descs
suffix:semicolon
id|dev-&gt;tx_idx
op_assign
id|txdp
op_div
(paren
id|DESC_SIZE
op_star
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tx_idx
op_ge
id|NR_TX_DESC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;%s: BUG -- txdp out of range&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
id|dev-&gt;tx_idx
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The may have been a race between a pci originated read&n;&t;&t; * and the descriptor update from the cpu.  Just in case, &n;&t;&t; * kick the transmitter if the hardware thinks it is on a &n;&t;&t; * different descriptor than we are.&n;&t;&t; */
r_if
c_cond
(paren
id|dev-&gt;tx_idx
op_ne
id|dev-&gt;tx_free_idx
)paren
id|kick_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Defer tx ring processing until more than a minimum amount of&n;&t; * work has accumulated&n;&t; */
r_if
c_cond
(paren
(paren
id|ISR_TXDESC
op_or
id|ISR_TXIDLE
op_or
id|ISR_TXOK
op_or
id|ISR_TXERR
)paren
op_amp
id|isr
)paren
(brace
id|do_tx_done
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* Disable TxOk if there are no outstanding tx packets.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|dev-&gt;tx_done_idx
op_eq
id|dev-&gt;tx_free_idx
)paren
op_logical_and
(paren
id|dev-&gt;IMR_cache
op_amp
id|ISR_TXOK
)paren
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_and_assign
op_complement
id|ISR_TXOK
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;IMR_cache
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The TxIdle interrupt can come in before the transmit has&n;&t; * completed.  Normally we reap packets off of the combination&n;&t; * of TxDesc and TxIdle and leave TxOk disabled (since it &n;&t; * occurs on every packet), but when no further irqs of this &n;&t; * nature are expected, we must enable TxOk.&n;&t; */
r_if
c_cond
(paren
(paren
id|ISR_TXIDLE
op_amp
id|isr
)paren
op_logical_and
(paren
id|dev-&gt;tx_done_idx
op_ne
id|dev-&gt;tx_free_idx
)paren
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_TXOK
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;IMR_cache
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* MIB interrupt: one of the statistics counters is about to overflow */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ISR_MIB
op_amp
id|isr
)paren
)paren
id|ns83820_mib_isr
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* PHY: Link up/down/negotiation state change */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ISR_PHY
op_amp
id|isr
)paren
)paren
id|phy_intr
c_func
(paren
id|ndev
)paren
suffix:semicolon
macro_line|#if 0&t;/* Still working on the interrupt mitigation strategy */
r_if
c_cond
(paren
id|dev-&gt;ihr
)paren
id|writel
c_func
(paren
id|dev-&gt;ihr
comma
id|dev-&gt;base
op_plus
id|IHR
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ns83820_do_reset
r_static
r_void
id|ns83820_do_reset
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
id|u32
id|which
)paren
(brace
id|Dprintk
c_func
(paren
l_string|&quot;resetting chip...&bslash;n&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
id|which
comma
id|dev-&gt;base
op_plus
id|CR
)paren
suffix:semicolon
r_do
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|CR
)paren
op_amp
id|which
)paren
suffix:semicolon
id|Dprintk
c_func
(paren
l_string|&quot;okay!&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ns83820_stop
r_static
r_int
id|ns83820_stop
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* FIXME: protect against interrupt handler? */
id|del_timer_sync
c_func
(paren
op_amp
id|dev-&gt;tx_watchdog
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|dev-&gt;rx_info.up
op_assign
l_int|0
suffix:semicolon
id|synchronize_irq
c_func
(paren
id|dev-&gt;pci_dev-&gt;irq
)paren
suffix:semicolon
id|ns83820_do_reset
c_func
(paren
id|dev
comma
id|CR_RST
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
id|dev-&gt;pci_dev-&gt;irq
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_and_assign
op_complement
(paren
id|ISR_TXURN
op_or
id|ISR_TXIDLE
op_or
id|ISR_TXERR
op_or
id|ISR_TXDESC
op_or
id|ISR_TXOK
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|ns83820_cleanup_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ns83820_cleanup_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ns83820_tx_timeout
r_static
r_void
id|ns83820_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|u32
id|tx_done_idx
comma
op_star
id|desc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|tx_done_idx
op_assign
id|dev-&gt;tx_done_idx
suffix:semicolon
id|desc
op_assign
id|dev-&gt;tx_descs
op_plus
(paren
id|tx_done_idx
op_star
id|DESC_SIZE
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: tx_timeout: tx_done_idx=%d free_idx=%d cmdsts=%08x&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|tx_done_idx
comma
id|dev-&gt;tx_free_idx
comma
id|le32_to_cpu
c_func
(paren
id|desc
(braket
id|DESC_CMDSTS
)braket
)paren
)paren
suffix:semicolon
macro_line|#if defined(DEBUG)
(brace
id|u32
id|isr
suffix:semicolon
id|isr
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|ISR
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;irq: %08x imr: %08x&bslash;n&quot;
comma
id|isr
comma
id|dev-&gt;IMR_cache
)paren
suffix:semicolon
id|ns83820_do_isr
c_func
(paren
id|ndev
comma
id|isr
)paren
suffix:semicolon
)brace
macro_line|#endif
id|do_tx_done
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|tx_done_idx
op_assign
id|dev-&gt;tx_done_idx
suffix:semicolon
id|desc
op_assign
id|dev-&gt;tx_descs
op_plus
(paren
id|tx_done_idx
op_star
id|DESC_SIZE
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: after: tx_done_idx=%d free_idx=%d cmdsts=%08x&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|tx_done_idx
comma
id|dev-&gt;tx_free_idx
comma
id|le32_to_cpu
c_func
(paren
id|desc
(braket
id|DESC_CMDSTS
)braket
)paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ns83820_tx_watch
r_static
r_void
id|ns83820_tx_watch
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
(paren
r_void
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
macro_line|#if defined(DEBUG)
id|printk
c_func
(paren
l_string|&quot;ns83820_tx_watch: %u %u %d&bslash;n&quot;
comma
id|dev-&gt;tx_done_idx
comma
id|dev-&gt;tx_free_idx
comma
id|atomic_read
c_func
(paren
op_amp
id|dev-&gt;nr_tx_skbs
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|ndev-&gt;trans_start
op_plus
l_int|1
op_star
id|HZ
)paren
op_logical_and
id|dev-&gt;tx_done_idx
op_ne
id|dev-&gt;tx_free_idx
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: ns83820_tx_watch: %u %u %d&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|dev-&gt;tx_done_idx
comma
id|dev-&gt;tx_free_idx
comma
id|atomic_read
c_func
(paren
op_amp
id|dev-&gt;nr_tx_skbs
)paren
)paren
suffix:semicolon
id|ns83820_tx_timeout
c_func
(paren
id|ndev
)paren
suffix:semicolon
)brace
id|mod_timer
c_func
(paren
op_amp
id|dev-&gt;tx_watchdog
comma
id|jiffies
op_plus
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|ns83820_open
r_static
r_int
id|ns83820_open
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|desc
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;ns83820_open&bslash;n&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|PQCR
)paren
suffix:semicolon
id|ret
op_assign
id|ns83820_setup_rx
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|failed
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;tx_descs
comma
l_int|0
comma
l_int|4
op_star
id|NR_TX_DESC
op_star
id|DESC_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;tx_descs
(braket
(paren
id|i
op_star
id|DESC_SIZE
)paren
op_plus
id|DESC_LINK
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|dev-&gt;tx_phy_descs
op_plus
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|NR_TX_DESC
)paren
op_star
id|DESC_SIZE
op_star
l_int|4
)paren
suffix:semicolon
)brace
id|dev-&gt;tx_idx
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tx_done_idx
op_assign
l_int|0
suffix:semicolon
id|desc
op_assign
id|dev-&gt;tx_phy_descs
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|TXDP_HI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|desc
comma
id|dev-&gt;base
op_plus
id|TXDP
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|dev-&gt;tx_watchdog
)paren
suffix:semicolon
id|dev-&gt;tx_watchdog.data
op_assign
(paren
r_int
r_int
)paren
id|ndev
suffix:semicolon
id|dev-&gt;tx_watchdog.function
op_assign
id|ns83820_tx_watch
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|dev-&gt;tx_watchdog
comma
id|jiffies
op_plus
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* FIXME: wait for phy to come up */
r_return
l_int|0
suffix:semicolon
id|failed
suffix:colon
id|ns83820_stop
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ns83820_getmac
r_static
r_void
id|ns83820_getmac
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
id|u8
op_star
id|mac
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|data
suffix:semicolon
macro_line|#if 0&t;/* I&squot;ve left this in as an example of how to use eeprom.h */
id|data
op_assign
id|eeprom_readw
c_func
(paren
op_amp
id|dev-&gt;ee
comma
l_int|0xa
op_plus
l_int|2
op_minus
id|i
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* Read from the perfect match memory: this is loaded by&n;&t;&t; * the chip from the EEPROM via the EELOAD self test.&n;&t;&t; */
id|writel
c_func
(paren
id|i
op_star
l_int|2
comma
id|dev-&gt;base
op_plus
id|RFCR
)paren
suffix:semicolon
id|data
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|RFDR
)paren
suffix:semicolon
macro_line|#endif
op_star
id|mac
op_increment
op_assign
id|data
suffix:semicolon
op_star
id|mac
op_increment
op_assign
id|data
op_rshift
l_int|8
suffix:semicolon
)brace
)brace
DECL|function|ns83820_change_mtu
r_static
r_int
id|ns83820_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_int
id|new_mtu
)paren
(brace
r_if
c_cond
(paren
id|new_mtu
OG
id|RX_BUF_SIZE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ndev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ns83820_set_multicast
r_static
r_void
id|ns83820_set_multicast
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|u8
id|__iomem
op_star
id|rfcr
op_assign
id|dev-&gt;base
op_plus
id|RFCR
suffix:semicolon
id|u32
id|and_mask
op_assign
l_int|0xffffffff
suffix:semicolon
id|u32
id|or_mask
op_assign
l_int|0
suffix:semicolon
id|u32
id|val
suffix:semicolon
r_if
c_cond
(paren
id|ndev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
id|or_mask
op_or_assign
id|RFCR_AAU
op_or
id|RFCR_AAM
suffix:semicolon
r_else
id|and_mask
op_and_assign
op_complement
(paren
id|RFCR_AAU
op_or
id|RFCR_AAM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ndev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
id|or_mask
op_or_assign
id|RFCR_AAM
suffix:semicolon
r_else
id|and_mask
op_and_assign
op_complement
id|RFCR_AAM
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|val
op_assign
(paren
id|readl
c_func
(paren
id|rfcr
)paren
op_amp
id|and_mask
)paren
op_or
id|or_mask
suffix:semicolon
multiline_comment|/* Ramit : RFCR Write Fix doc says RFEN must be 0 modify other bits */
id|writel
c_func
(paren
id|val
op_amp
op_complement
id|RFCR_RFEN
comma
id|rfcr
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|rfcr
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
)brace
DECL|function|ns83820_run_bist
r_static
r_void
id|ns83820_run_bist
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
comma
r_const
r_char
op_star
id|name
comma
id|u32
id|enable
comma
id|u32
id|done
comma
id|u32
id|fail
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_int
id|timed_out
op_assign
l_int|0
suffix:semicolon
r_int
id|start
suffix:semicolon
id|u32
id|status
suffix:semicolon
r_int
id|loops
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: start %s&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|name
)paren
suffix:semicolon
id|start
op_assign
id|jiffies
suffix:semicolon
id|writel
c_func
(paren
id|enable
comma
id|dev-&gt;base
op_plus
id|PTSCR
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|loops
op_increment
suffix:semicolon
id|status
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|PTSCR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|enable
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|done
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|fail
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|start
)paren
op_ge
id|HZ
)paren
(brace
id|timed_out
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|fail
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s failed! (0x%08x &amp; 0x%08x)&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|name
comma
id|status
comma
id|fail
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|timed_out
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: run_bist %s timed out! (%08x)&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|name
comma
id|status
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: done %s in %d loops&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|name
comma
id|loops
)paren
suffix:semicolon
)brace
macro_line|#ifdef PHY_CODE_IS_FINISHED
DECL|function|ns83820_mii_write_bit
r_static
r_void
id|ns83820_mii_write_bit
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
r_int
id|bit
)paren
(brace
multiline_comment|/* drive MDC low */
id|dev-&gt;MEAR_cache
op_and_assign
op_complement
id|MEAR_MDC
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;MEAR_cache
comma
id|dev-&gt;base
op_plus
id|MEAR
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|MEAR
)paren
suffix:semicolon
multiline_comment|/* enable output, set bit */
id|dev-&gt;MEAR_cache
op_or_assign
id|MEAR_MDDIR
suffix:semicolon
r_if
c_cond
(paren
id|bit
)paren
id|dev-&gt;MEAR_cache
op_or_assign
id|MEAR_MDIO
suffix:semicolon
r_else
id|dev-&gt;MEAR_cache
op_and_assign
op_complement
id|MEAR_MDIO
suffix:semicolon
multiline_comment|/* set the output bit */
id|writel
c_func
(paren
id|dev-&gt;MEAR_cache
comma
id|dev-&gt;base
op_plus
id|MEAR
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|MEAR
)paren
suffix:semicolon
multiline_comment|/* Wait.  Max clock rate is 2.5MHz, this way we come in under 1MHz */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* drive MDC high causing the data bit to be latched */
id|dev-&gt;MEAR_cache
op_or_assign
id|MEAR_MDC
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;MEAR_cache
comma
id|dev-&gt;base
op_plus
id|MEAR
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|MEAR
)paren
suffix:semicolon
multiline_comment|/* Wait again... */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ns83820_mii_read_bit
r_static
r_int
id|ns83820_mii_read_bit
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
r_int
id|bit
suffix:semicolon
multiline_comment|/* drive MDC low, disable output */
id|dev-&gt;MEAR_cache
op_and_assign
op_complement
id|MEAR_MDC
suffix:semicolon
id|dev-&gt;MEAR_cache
op_and_assign
op_complement
id|MEAR_MDDIR
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;MEAR_cache
comma
id|dev-&gt;base
op_plus
id|MEAR
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|MEAR
)paren
suffix:semicolon
multiline_comment|/* Wait.  Max clock rate is 2.5MHz, this way we come in under 1MHz */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* drive MDC high causing the data bit to be latched */
id|bit
op_assign
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|MEAR
)paren
op_amp
id|MEAR_MDIO
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|dev-&gt;MEAR_cache
op_or_assign
id|MEAR_MDC
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;MEAR_cache
comma
id|dev-&gt;base
op_plus
id|MEAR
)paren
suffix:semicolon
multiline_comment|/* Wait again... */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
id|bit
suffix:semicolon
)brace
DECL|function|ns83820_mii_read_reg
r_static
r_int
id|ns83820_mii_read_reg
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
r_int
id|phy
comma
r_int
id|reg
)paren
(brace
r_int
id|data
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* read some garbage so that we eventually sync up */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
id|ns83820_mii_read_bit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* start */
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* opcode read */
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* write out the phy address: 5 bits, msb first */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
id|phy
op_amp
(paren
l_int|0x10
op_rshift
id|i
)paren
)paren
suffix:semicolon
multiline_comment|/* write out the register address, 5 bits, msb first */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
id|reg
op_amp
(paren
l_int|0x10
op_rshift
id|i
)paren
)paren
suffix:semicolon
id|ns83820_mii_read_bit
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* turn around cycles */
id|ns83820_mii_read_bit
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* read in the register data, 16 bits msb first */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
op_lshift_assign
l_int|1
suffix:semicolon
id|data
op_or_assign
id|ns83820_mii_read_bit
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|data
suffix:semicolon
)brace
DECL|function|ns83820_mii_write_reg
r_static
r_int
id|ns83820_mii_write_reg
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
r_int
id|phy
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* read some garbage so that we eventually sync up */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
id|ns83820_mii_read_bit
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* start */
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* opcode read */
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* write out the phy address: 5 bits, msb first */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
id|phy
op_amp
(paren
l_int|0x10
op_rshift
id|i
)paren
)paren
suffix:semicolon
multiline_comment|/* write out the register address, 5 bits, msb first */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
id|reg
op_amp
(paren
l_int|0x10
op_rshift
id|i
)paren
)paren
suffix:semicolon
id|ns83820_mii_read_bit
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* turn around cycles */
id|ns83820_mii_read_bit
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* read in the register data, 16 bits msb first */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|ns83820_mii_write_bit
c_func
(paren
id|dev
comma
(paren
id|data
op_rshift
(paren
l_int|15
op_minus
id|i
)paren
)paren
op_amp
l_int|1
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
DECL|function|ns83820_probe_phy
r_static
r_void
id|ns83820_probe_phy
c_func
(paren
r_struct
id|net_device
op_star
id|ndev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_static
r_int
id|first
suffix:semicolon
r_int
id|i
suffix:semicolon
DECL|macro|MII_PHYIDR1
mdefine_line|#define MII_PHYIDR1&t;0x02
DECL|macro|MII_PHYIDR2
mdefine_line|#define MII_PHYIDR2&t;0x03
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|first
)paren
(brace
r_int
id|tmp
suffix:semicolon
id|ns83820_mii_read_reg
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0x09
)paren
suffix:semicolon
id|ns83820_mii_write_reg
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0x10
comma
l_int|0x0d3e
)paren
suffix:semicolon
id|tmp
op_assign
id|ns83820_mii_read_reg
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0x00
)paren
suffix:semicolon
id|ns83820_mii_write_reg
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0x00
comma
id|tmp
op_or
l_int|0x8000
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1300
)paren
suffix:semicolon
id|ns83820_mii_read_reg
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0x09
)paren
suffix:semicolon
)brace
macro_line|#endif
id|first
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|j
suffix:semicolon
r_int
id|a
comma
id|b
suffix:semicolon
id|a
op_assign
id|ns83820_mii_read_reg
c_func
(paren
id|dev
comma
id|i
comma
id|MII_PHYIDR1
)paren
suffix:semicolon
id|b
op_assign
id|ns83820_mii_read_reg
c_func
(paren
id|dev
comma
id|i
comma
id|MII_PHYIDR2
)paren
suffix:semicolon
singleline_comment|//printk(&quot;%s: phy %d: 0x%04x 0x%04x&bslash;n&quot;,
singleline_comment|//&t;ndev-&gt;name, i, a, b);
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|0x16
suffix:semicolon
id|j
op_add_assign
l_int|4
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s: [0x%02x] %04x %04x %04x %04x&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|j
comma
id|ns83820_mii_read_reg
c_func
(paren
id|dev
comma
id|i
comma
l_int|0
op_plus
id|j
)paren
comma
id|ns83820_mii_read_reg
c_func
(paren
id|dev
comma
id|i
comma
l_int|1
op_plus
id|j
)paren
comma
id|ns83820_mii_read_reg
c_func
(paren
id|dev
comma
id|i
comma
l_int|2
op_plus
id|j
)paren
comma
id|ns83820_mii_read_reg
c_func
(paren
id|dev
comma
id|i
comma
l_int|3
op_plus
id|j
)paren
)paren
suffix:semicolon
)brace
)brace
(brace
r_int
id|a
comma
id|b
suffix:semicolon
multiline_comment|/* read firmware version: memory addr is 0x8402 and 0x8403 */
id|ns83820_mii_write_reg
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0x16
comma
l_int|0x000d
)paren
suffix:semicolon
id|ns83820_mii_write_reg
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0x1e
comma
l_int|0x810e
)paren
suffix:semicolon
id|a
op_assign
id|ns83820_mii_read_reg
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0x1d
)paren
suffix:semicolon
id|ns83820_mii_write_reg
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0x16
comma
l_int|0x000d
)paren
suffix:semicolon
id|ns83820_mii_write_reg
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0x1e
comma
l_int|0x810e
)paren
suffix:semicolon
id|b
op_assign
id|ns83820_mii_read_reg
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0x1d
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;version: 0x%04x 0x%04x&bslash;n&quot;
comma
id|a
comma
id|b
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|function|ns83820_init_one
r_static
r_int
id|__devinit
id|ns83820_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
suffix:semicolon
r_struct
id|ns83820
op_star
id|dev
suffix:semicolon
r_int
id|addr
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|using_dac
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* See if we can set the dma mask early on; failure is fatal. */
r_if
c_cond
(paren
id|TRY_DAC
op_logical_and
op_logical_neg
id|pci_set_dma_mask
c_func
(paren
id|pci_dev
comma
l_int|0xffffffffffffffffULL
)paren
)paren
(brace
id|using_dac
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|pci_set_dma_mask
c_func
(paren
id|pci_dev
comma
l_int|0xffffffff
)paren
)paren
(brace
id|using_dac
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ns83820.c: pci_set_dma_mask failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ndev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|ns83820
)paren
)paren
suffix:semicolon
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|out
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;tx_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|dev-&gt;pci_dev
op_assign
id|pci_dev
suffix:semicolon
id|dev-&gt;ee.cache
op_assign
op_amp
id|dev-&gt;MEAR_cache
suffix:semicolon
id|dev-&gt;ee.lock
op_assign
op_amp
id|dev-&gt;misc_lock
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|ndev
comma
op_amp
id|pci_dev-&gt;dev
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|dev-&gt;tq_refill
comma
id|queue_refill
comma
id|ndev
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|dev-&gt;rx_tasklet
comma
id|rx_action
comma
(paren
r_int
r_int
)paren
id|ndev
)paren
suffix:semicolon
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ns83820: pci_enable_dev failed: %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
id|addr
op_assign
id|pci_resource_start
c_func
(paren
id|pci_dev
comma
l_int|1
)paren
suffix:semicolon
id|dev-&gt;base
op_assign
id|ioremap_nocache
c_func
(paren
id|addr
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|dev-&gt;tx_descs
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_TX_DESC
comma
op_amp
id|dev-&gt;tx_phy_descs
)paren
suffix:semicolon
id|dev-&gt;rx_info.descs
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_RX_DESC
comma
op_amp
id|dev-&gt;rx_info.phy_descs
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;base
op_logical_or
op_logical_neg
id|dev-&gt;tx_descs
op_logical_or
op_logical_neg
id|dev-&gt;rx_info.descs
)paren
r_goto
id|out_disable
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%p: %08lx  %p: %08lx&bslash;n&quot;
comma
id|dev-&gt;tx_descs
comma
(paren
r_int
)paren
id|dev-&gt;tx_phy_descs
comma
id|dev-&gt;rx_info.descs
comma
(paren
r_int
)paren
id|dev-&gt;rx_info.phy_descs
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_assign
l_int|0
suffix:semicolon
id|setup_ee_mem_bitbanger
c_func
(paren
op_amp
id|dev-&gt;ee
comma
id|dev-&gt;base
op_plus
id|MEAR
comma
l_int|3
comma
l_int|2
comma
l_int|1
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|pci_dev-&gt;irq
comma
id|ns83820_irq
comma
id|SA_SHIRQ
comma
id|DRV_NAME
comma
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ns83820: unable to register irq %d&bslash;n&quot;
comma
id|pci_dev-&gt;irq
)paren
suffix:semicolon
r_goto
id|out_disable
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * FIXME: we are holding rtnl_lock() over obscenely long area only&n;&t; * because some of the setup code uses dev-&gt;name.  It&squot;s Wrong(tm) -&n;&t; * we should be using driver-specific names for all that stuff.&n;&t; * For now that will do, but we really need to come back and kill&n;&t; * most of the dev_alloc_name() users later.&n;&t; */
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|dev_alloc_name
c_func
(paren
id|ndev
comma
id|ndev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ns83820: unable to get netdev name: %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_goto
id|out_free_irq
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: ns83820.c: 0x22c: %08x, subsystem: %04x:%04x&bslash;n&quot;
comma
id|ndev-&gt;name
comma
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
l_int|0x22c
)paren
)paren
comma
id|pci_dev-&gt;subsystem_vendor
comma
id|pci_dev-&gt;subsystem_device
)paren
suffix:semicolon
id|ndev-&gt;open
op_assign
id|ns83820_open
suffix:semicolon
id|ndev-&gt;stop
op_assign
id|ns83820_stop
suffix:semicolon
id|ndev-&gt;hard_start_xmit
op_assign
id|ns83820_hard_start_xmit
suffix:semicolon
id|ndev-&gt;get_stats
op_assign
id|ns83820_get_stats
suffix:semicolon
id|ndev-&gt;change_mtu
op_assign
id|ns83820_change_mtu
suffix:semicolon
id|ndev-&gt;set_multicast_list
op_assign
id|ns83820_set_multicast
suffix:semicolon
id|SET_ETHTOOL_OPS
c_func
(paren
id|ndev
comma
op_amp
id|ops
)paren
suffix:semicolon
id|ndev-&gt;tx_timeout
op_assign
id|ns83820_tx_timeout
suffix:semicolon
id|ndev-&gt;watchdog_timeo
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
id|ndev
)paren
suffix:semicolon
id|ns83820_do_reset
c_func
(paren
id|dev
comma
id|CR_RST
)paren
suffix:semicolon
multiline_comment|/* Must reset the ram bist before running it */
id|writel
c_func
(paren
id|PTSCR_RBIST_RST
comma
id|dev-&gt;base
op_plus
id|PTSCR
)paren
suffix:semicolon
id|ns83820_run_bist
c_func
(paren
id|ndev
comma
l_string|&quot;sram bist&quot;
comma
id|PTSCR_RBIST_EN
comma
id|PTSCR_RBIST_DONE
comma
id|PTSCR_RBIST_FAIL
)paren
suffix:semicolon
id|ns83820_run_bist
c_func
(paren
id|ndev
comma
l_string|&quot;eeprom bist&quot;
comma
id|PTSCR_EEBIST_EN
comma
l_int|0
comma
id|PTSCR_EEBIST_FAIL
)paren
suffix:semicolon
id|ns83820_run_bist
c_func
(paren
id|ndev
comma
l_string|&quot;eeprom load&quot;
comma
id|PTSCR_EELOAD_EN
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* I love config registers */
id|dev-&gt;CFG_cache
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;CFG_cache
op_amp
id|CFG_PCI64_DET
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: detected 64 bit PCI data bus.&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*dev-&gt;CFG_cache |= CFG_DATA64_EN;*/
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;CFG_cache
op_amp
id|CFG_DATA64_EN
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: EEPROM did not enable 64 bit bus.  Disabled.&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
)brace
r_else
id|dev-&gt;CFG_cache
op_and_assign
op_complement
(paren
id|CFG_DATA64_EN
)paren
suffix:semicolon
id|dev-&gt;CFG_cache
op_and_assign
(paren
id|CFG_TBI_EN
op_or
id|CFG_MRM_DIS
op_or
id|CFG_MWI_DIS
op_or
id|CFG_T64ADDR
op_or
id|CFG_DATA64_EN
op_or
id|CFG_EXT_125
op_or
id|CFG_M64ADDR
)paren
suffix:semicolon
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_PINT_DUPSTS
op_or
id|CFG_PINT_LNKSTS
op_or
id|CFG_PINT_SPDSTS
op_or
id|CFG_EXTSTS_EN
op_or
id|CFG_EXD
op_or
id|CFG_PESEL
suffix:semicolon
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_REQALG
suffix:semicolon
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_POW
suffix:semicolon
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_TMRTEST
suffix:semicolon
multiline_comment|/* When compiled with 64 bit addressing, we must always enable&n;&t; * the 64 bit descriptor format.&n;&t; */
macro_line|#ifdef USE_64BIT_ADDR
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_M64ADDR
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|using_dac
)paren
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_T64ADDR
suffix:semicolon
multiline_comment|/* Big endian mode does not seem to do what the docs suggest */
id|dev-&gt;CFG_cache
op_and_assign
op_complement
id|CFG_BEM
suffix:semicolon
multiline_comment|/* setup optical transceiver if we have one */
r_if
c_cond
(paren
id|dev-&gt;CFG_cache
op_amp
id|CFG_TBI_EN
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: enabling optical transceiver&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
id|writel
c_func
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|GPIOR
)paren
op_or
l_int|0x3e8
comma
id|dev-&gt;base
op_plus
id|GPIOR
)paren
suffix:semicolon
multiline_comment|/* setup auto negotiation feature advertisement */
id|writel
c_func
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|TANAR
)paren
op_or
id|TANAR_HALF_DUP
op_or
id|TANAR_FULL_DUP
comma
id|dev-&gt;base
op_plus
id|TANAR
)paren
suffix:semicolon
multiline_comment|/* start auto negotiation */
id|writel
c_func
(paren
id|TBICR_MR_AN_ENABLE
op_or
id|TBICR_MR_RESTART_AN
comma
id|dev-&gt;base
op_plus
id|TBICR
)paren
suffix:semicolon
id|writel
c_func
(paren
id|TBICR_MR_AN_ENABLE
comma
id|dev-&gt;base
op_plus
id|TBICR
)paren
suffix:semicolon
id|dev-&gt;linkstate
op_assign
id|LINK_AUTONEGOTIATE
suffix:semicolon
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_MODE_1000
suffix:semicolon
)brace
id|writel
c_func
(paren
id|dev-&gt;CFG_cache
comma
id|dev-&gt;base
op_plus
id|CFG
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;CFG: %08x&bslash;n&quot;
comma
id|dev-&gt;CFG_cache
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reset_phy
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: resetting phy&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;CFG_cache
op_or
id|CFG_PHY_RST
comma
id|dev-&gt;base
op_plus
id|CFG
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
(paren
id|HZ
op_plus
l_int|99
)paren
op_div
l_int|100
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;CFG_cache
comma
id|dev-&gt;base
op_plus
id|CFG
)paren
suffix:semicolon
)brace
macro_line|#if 0&t;/* Huh?  This sets the PCI latency register.  Should be done via &n;&t; * the PCI layer.  FIXME.&n;&t; */
r_if
c_cond
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|SRR
)paren
)paren
id|writel
c_func
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
l_int|0x20c
)paren
op_or
l_int|0xfe00
comma
id|dev-&gt;base
op_plus
l_int|0x20c
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Note!  The DMA burst size interacts with packet&n;&t; * transmission, such that the largest packet that&n;&t; * can be transmitted is 8192 - FLTH - burst size.&n;&t; * If only the transmit fifo was larger...&n;&t; */
multiline_comment|/* Ramit : 1024 DMA is not a good idea, it ends up banging &n;&t; * some DELL and COMPAQ SMP systems */
id|writel
c_func
(paren
id|TXCFG_CSI
op_or
id|TXCFG_HBI
op_or
id|TXCFG_ATP
op_or
id|TXCFG_MXDMA512
op_or
(paren
(paren
l_int|1600
op_div
l_int|32
)paren
op_star
l_int|0x100
)paren
comma
id|dev-&gt;base
op_plus
id|TXCFG
)paren
suffix:semicolon
multiline_comment|/* Flush the interrupt holdoff timer */
id|writel
c_func
(paren
l_int|0x000
comma
id|dev-&gt;base
op_plus
id|IHR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x100
comma
id|dev-&gt;base
op_plus
id|IHR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x000
comma
id|dev-&gt;base
op_plus
id|IHR
)paren
suffix:semicolon
multiline_comment|/* Set Rx to full duplex, don&squot;t accept runt, errored, long or length&n;&t; * range errored packets.  Use 512 byte DMA.&n;&t; */
multiline_comment|/* Ramit : 1024 DMA is not a good idea, it ends up banging &n;&t; * some DELL and COMPAQ SMP systems &n;&t; * Turn on ALP, only we are accpeting Jumbo Packets */
id|writel
c_func
(paren
id|RXCFG_AEP
op_or
id|RXCFG_ARP
op_or
id|RXCFG_AIRL
op_or
id|RXCFG_RX_FD
op_or
id|RXCFG_STRIPCRC
singleline_comment|//| RXCFG_ALP
op_or
(paren
id|RXCFG_MXDMA512
)paren
op_or
l_int|0
comma
id|dev-&gt;base
op_plus
id|RXCFG
)paren
suffix:semicolon
multiline_comment|/* Disable priority queueing */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|PQCR
)paren
suffix:semicolon
multiline_comment|/* Enable IP checksum validation and detetion of VLAN headers.&n;&t; * Note: do not set the reject options as at least the 0x102&n;&t; * revision of the chip does not properly accept IP fragments&n;&t; * at least for UDP.&n;&t; */
multiline_comment|/* Ramit : Be sure to turn on RXCFG_ARP if VLAN&squot;s are enabled, since&n;&t; * the MAC it calculates the packetsize AFTER stripping the VLAN&n;&t; * header, and if a VLAN Tagged packet of 64 bytes is received (like&n;&t; * a ping with a VLAN header) then the card, strips the 4 byte VLAN&n;&t; * tag and then checks the packet size, so if RXCFG_ARP is not enabled,&n;&t; * it discrards it!.  These guys......&n;&t; * also turn on tag stripping if hardware acceleration is enabled&n;&t; */
macro_line|#ifdef NS83820_VLAN_ACCEL_SUPPORT
DECL|macro|VRCR_INIT_VALUE
mdefine_line|#define VRCR_INIT_VALUE (VRCR_IPEN|VRCR_VTDEN|VRCR_VTREN) 
macro_line|#else
mdefine_line|#define VRCR_INIT_VALUE (VRCR_IPEN|VRCR_VTDEN)
macro_line|#endif
id|writel
c_func
(paren
id|VRCR_INIT_VALUE
comma
id|dev-&gt;base
op_plus
id|VRCR
)paren
suffix:semicolon
multiline_comment|/* Enable per-packet TCP/UDP/IP checksumming&n;&t; * and per packet vlan tag insertion if&n;&t; * vlan hardware acceleration is enabled&n;&t; */
macro_line|#ifdef NS83820_VLAN_ACCEL_SUPPORT
DECL|macro|VTCR_INIT_VALUE
mdefine_line|#define VTCR_INIT_VALUE (VTCR_PPCHK|VTCR_VPPTI)
macro_line|#else
mdefine_line|#define VTCR_INIT_VALUE VTCR_PPCHK
macro_line|#endif
id|writel
c_func
(paren
id|VTCR_INIT_VALUE
comma
id|dev-&gt;base
op_plus
id|VTCR
)paren
suffix:semicolon
multiline_comment|/* Ramit : Enable async and sync pause frames */
multiline_comment|/* writel(0, dev-&gt;base + PCR); */
id|writel
c_func
(paren
(paren
id|PCR_PS_MCAST
op_or
id|PCR_PS_DA
op_or
id|PCR_PSEN
op_or
id|PCR_FFLO_4K
op_or
id|PCR_FFHI_8K
op_or
id|PCR_STLO_4
op_or
id|PCR_STHI_8
op_or
id|PCR_PAUSE_CNT
)paren
comma
id|dev-&gt;base
op_plus
id|PCR
)paren
suffix:semicolon
multiline_comment|/* Disable Wake On Lan */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|WCSR
)paren
suffix:semicolon
id|ns83820_getmac
c_func
(paren
id|dev
comma
id|ndev-&gt;dev_addr
)paren
suffix:semicolon
multiline_comment|/* Yes, we support dumb IP checksum on transmit */
id|ndev-&gt;features
op_or_assign
id|NETIF_F_SG
suffix:semicolon
id|ndev-&gt;features
op_or_assign
id|NETIF_F_IP_CSUM
suffix:semicolon
macro_line|#ifdef NS83820_VLAN_ACCEL_SUPPORT
multiline_comment|/* We also support hardware vlan acceleration */
id|ndev-&gt;features
op_or_assign
id|NETIF_F_HW_VLAN_TX
op_or
id|NETIF_F_HW_VLAN_RX
suffix:semicolon
id|ndev-&gt;vlan_rx_register
op_assign
id|ns83820_vlan_rx_register
suffix:semicolon
id|ndev-&gt;vlan_rx_kill_vid
op_assign
id|ns83820_vlan_rx_kill_vid
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|using_dac
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: using 64 bit addressing.&bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
id|ndev-&gt;features
op_or_assign
id|NETIF_F_HIGHDMA
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ns83820 v&quot;
id|VERSION
l_string|&quot;: DP83820 v%u.%u: %02x:%02x:%02x:%02x:%02x:%02x io=0x%08lx irq=%d f=%s&bslash;n&quot;
comma
id|ndev-&gt;name
comma
(paren
r_int
)paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|SRR
)paren
op_rshift
l_int|8
comma
(paren
r_int
)paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|SRR
)paren
op_amp
l_int|0xff
comma
id|ndev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|ndev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|ndev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|ndev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|ndev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|ndev-&gt;dev_addr
(braket
l_int|5
)braket
comma
id|addr
comma
id|pci_dev-&gt;irq
comma
(paren
id|ndev-&gt;features
op_amp
id|NETIF_F_HIGHDMA
)paren
ques
c_cond
l_string|&quot;h,sg&quot;
suffix:colon
l_string|&quot;sg&quot;
)paren
suffix:semicolon
macro_line|#ifdef PHY_CODE_IS_FINISHED
id|ns83820_probe_phy
c_func
(paren
id|ndev
)paren
suffix:semicolon
macro_line|#endif
id|err
op_assign
id|register_netdevice
c_func
(paren
id|ndev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ns83820: unable to register netdev: %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_goto
id|out_cleanup
suffix:semicolon
)brace
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_cleanup
suffix:colon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
multiline_comment|/* paranoia */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|out_free_irq
suffix:colon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|pci_dev-&gt;irq
comma
id|ndev
)paren
suffix:semicolon
id|out_disable
suffix:colon
r_if
c_cond
(paren
id|dev-&gt;base
)paren
id|iounmap
c_func
(paren
id|dev-&gt;base
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_TX_DESC
comma
id|dev-&gt;tx_descs
comma
id|dev-&gt;tx_phy_descs
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_RX_DESC
comma
id|dev-&gt;rx_info.descs
comma
id|dev-&gt;rx_info.phy_descs
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
id|out_free
suffix:colon
id|free_netdev
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
l_int|NULL
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ns83820_remove_one
r_static
r_void
id|__devexit
id|ns83820_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_struct
id|net_device
op_star
id|ndev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_struct
id|ns83820
op_star
id|dev
op_assign
id|PRIV
c_func
(paren
id|ndev
)paren
suffix:semicolon
multiline_comment|/* ok even if NULL */
r_if
c_cond
(paren
op_logical_neg
id|ndev
)paren
multiline_comment|/* paranoia */
r_return
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
multiline_comment|/* paranoia */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;pci_dev-&gt;irq
comma
id|ndev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|dev-&gt;base
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|dev-&gt;pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_TX_DESC
comma
id|dev-&gt;tx_descs
comma
id|dev-&gt;tx_phy_descs
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|dev-&gt;pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_RX_DESC
comma
id|dev-&gt;rx_info.descs
comma
id|dev-&gt;rx_info.phy_descs
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|dev-&gt;pci_dev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|ns83820_pci_tbl
r_static
r_struct
id|pci_device_id
id|ns83820_pci_tbl
(braket
)braket
op_assign
(brace
(brace
l_int|0x100b
comma
l_int|0x0022
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
dot
id|driver_data
op_assign
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|driver
r_static
r_struct
id|pci_driver
id|driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ns83820&quot;
comma
dot
id|id_table
op_assign
id|ns83820_pci_tbl
comma
dot
id|probe
op_assign
id|ns83820_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|ns83820_remove_one
)paren
comma
macro_line|#if 0&t;/* FIXME: implement */
dot
id|suspend
op_assign
comma
dot
id|resume
op_assign
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|function|ns83820_init
r_static
r_int
id|__init
id|ns83820_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ns83820.c: National Semiconductor DP83820 10/100/1000 driver.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|pci_module_init
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
DECL|function|ns83820_exit
r_static
r_void
id|__exit
id|ns83820_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Benjamin LaHaise &lt;bcrl@redhat.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;National Semiconductor DP83820 10/100/1000 driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|ns83820_pci_tbl
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|lnksts
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|lnksts
comma
l_string|&quot;Polarity of LNKSTS bit&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|ihr
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ihr
comma
l_string|&quot;Time in 100 us increments to delay interrupts (range 0-127)&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|reset_phy
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|reset_phy
comma
l_string|&quot;Set to 1 to reset the PHY on startup&quot;
)paren
suffix:semicolon
DECL|variable|ns83820_init
id|module_init
c_func
(paren
id|ns83820_init
)paren
suffix:semicolon
DECL|variable|ns83820_exit
id|module_exit
c_func
(paren
id|ns83820_exit
)paren
suffix:semicolon
eof
