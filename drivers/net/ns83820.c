DECL|macro|VERSION
mdefine_line|#define VERSION &quot;0.11&quot;
multiline_comment|/* ns83820.c by Benjamin LaHaise &lt;bcrl@redhat.com&gt;&n; *&n; * $Revision: 1.34.2.2 $&n; *&n; * Copyright 2001 Benjamin LaHaise.&n; * Copyright 2001 Red Hat.&n; *&n; * Mmmm, chocolate vanilla mocha...&n; *&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; *&n; *&n; * ChangeLog&n; * =========&n; *&t;20010414&t;0.1 - created&n; *&t;20010622&t;0.2 - basic rx and tx.&n; *&t;20010711&t;0.3 - added duplex and link state detection support.&n; *&t;20010713&t;0.4 - zero copy, no hangs.&n; *&t;&t;&t;0.5 - 64 bit dma support (davem will hate me for this)&n; *&t;&t;&t;    - disable jumbo frames to avoid tx hangs&n; *&t;&t;&t;    - work around tx deadlocks on my 1.02 card via&n; *&t;&t;&t;      fiddling with TXCFG&n; *&t;20010810&t;0.6 - use pci dma api for ringbuffers, work on ia64&n; *&t;20010816&t;0.7 - misc cleanups&n; *&t;20010826&t;0.8 - fix critical zero copy bugs&n; *&t;&t;&t;0.9 - internal experiment&n; *&t;20010827&t;0.10 - fix ia64 unaligned access.&n; *&t;20010906&t;0.11 - accept all packets with checksum errors as&n; *&t;&t;&t;       otherwise fragments get lost&n;&t;&t;&t;     - fix &gt;&gt; 32 bugs&n; *&n; * Driver Overview&n; * ===============&n; *&n; * This driver was originally written for the National Semiconductor&n; * 83820 chip, a 10/100/1000 Mbps 64 bit PCI ethernet NIC.  Hopefully&n; * this code will turn out to be a) clean, b) correct, and c) fast.&n; * With that in mind, I&squot;m aiming to split the code up as much as&n; * reasonably possible.  At present there are X major sections that&n; * break down into a) packet receive, b) packet transmit, c) link&n; * management, d) initialization and configuration.  Where possible,&n; * these code paths are designed to run in parallel.&n; *&n; * This driver has been tested and found to work with the following&n; * cards (in no particular order):&n; *&n; *&t;Cameo&t;&t;SOHO-GA2000T&t;SOHO-GA2500T&n; *&t;D-Link&t;&t;DGE-500T&n; *&t;PureData&t;PDP8023Z-TG&n; *&t;SMC&t;&t;SMC9462TX&n; *&n; * Reports of success or failure would be greatly appreciated.&n; */
singleline_comment|//#define dprintk&t;&t;printk
DECL|macro|dprintk
mdefine_line|#define dprintk(x...)&t;&t;do { } while (0)
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ip.h&gt;&t;/* for iph */
macro_line|#include &lt;linux/in.h&gt;&t;/* for IPPROTO_... */
macro_line|#include &lt;linux/eeprom.h&gt;
macro_line|#include &lt;linux/compiler.h&gt;
singleline_comment|//#include &lt;linux/skbrefill.h&gt;
multiline_comment|/* Dprintk is used for more interesting debug events */
DECL|macro|Dprintk
macro_line|#undef Dprintk
DECL|macro|Dprintk
mdefine_line|#define&t;Dprintk&t;&t;&t;dprintk
macro_line|#ifdef CONFIG_HIGHMEM64G
DECL|macro|USE_64BIT_ADDR
mdefine_line|#define USE_64BIT_ADDR
macro_line|#elif defined(__ia64__)
DECL|macro|USE_64BIT_ADDR
mdefine_line|#define USE_64BIT_ADDR
macro_line|#endif
multiline_comment|/* Tell davem to fix the pci dma api.  Grrr. */
multiline_comment|/* stolen from acenic.c */
macro_line|#ifdef CONFIG_HIGHMEM
macro_line|#if defined(CONFIG_X86)
DECL|macro|DMAADDR_OFFSET
mdefine_line|#define DMAADDR_OFFSET  0
macro_line|#if defined(CONFIG_HIGHMEM64G)
DECL|typedef|dmaaddr_high_t
r_typedef
id|u64
id|dmaaddr_high_t
suffix:semicolon
macro_line|#else
DECL|typedef|dmaaddr_high_t
r_typedef
id|u32
id|dmaaddr_high_t
suffix:semicolon
macro_line|#endif
macro_line|#elif defined(CONFIG_PPC)
DECL|macro|DMAADDR_OFFSET
mdefine_line|#define DMAADDR_OFFSET PCI_DRAM_OFFSET
DECL|typedef|dmaaddr_high_t
r_typedef
r_int
r_int
id|dmaaddr_high_t
suffix:semicolon
macro_line|#endif
r_static
r_inline
id|dmaaddr_high_t
DECL|function|pci_map_single_high
id|pci_map_single_high
c_func
(paren
r_struct
id|pci_dev
op_star
id|hwdev
comma
r_struct
id|page
op_star
id|page
comma
r_int
id|offset
comma
r_int
id|size
comma
r_int
id|dir
)paren
(brace
id|u64
id|phys
suffix:semicolon
id|phys
op_assign
id|page
op_minus
id|mem_map
suffix:semicolon
id|phys
op_lshift_assign
id|PAGE_SHIFT
suffix:semicolon
id|phys
op_add_assign
id|offset
suffix:semicolon
id|phys
op_add_assign
id|DMAADDR_OFFSET
suffix:semicolon
r_return
id|phys
suffix:semicolon
)brace
macro_line|#else
DECL|typedef|dmaaddr_high_t
r_typedef
r_int
r_int
id|dmaaddr_high_t
suffix:semicolon
r_static
r_inline
id|dmaaddr_high_t
DECL|function|pci_map_single_high
id|pci_map_single_high
c_func
(paren
r_struct
id|pci_dev
op_star
id|hwdev
comma
r_struct
id|page
op_star
id|page
comma
r_int
id|offset
comma
r_int
id|size
comma
r_int
id|dir
)paren
(brace
r_return
id|pci_map_single
c_func
(paren
id|hwdev
comma
id|page_address
c_func
(paren
id|page
)paren
op_plus
id|offset
comma
id|size
comma
id|dir
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* tunables */
DECL|macro|RX_BUF_SIZE
mdefine_line|#define RX_BUF_SIZE&t;6144&t;/* 8192 */
DECL|macro|NR_RX_DESC
mdefine_line|#define NR_RX_DESC&t;256
DECL|macro|NR_TX_DESC
mdefine_line|#define NR_TX_DESC&t;256
multiline_comment|/* register defines */
DECL|macro|CFGCS
mdefine_line|#define CFGCS&t;&t;0x04
DECL|macro|CR_TXE
mdefine_line|#define CR_TXE&t;&t;0x00000001
DECL|macro|CR_TXD
mdefine_line|#define CR_TXD&t;&t;0x00000002
DECL|macro|CR_RXE
mdefine_line|#define CR_RXE&t;&t;0x00000004
DECL|macro|CR_RXD
mdefine_line|#define CR_RXD&t;&t;0x00000008
DECL|macro|CR_TXR
mdefine_line|#define CR_TXR&t;&t;0x00000010
DECL|macro|CR_RXR
mdefine_line|#define CR_RXR&t;&t;0x00000020
DECL|macro|CR_SWI
mdefine_line|#define CR_SWI&t;&t;0x00000080
DECL|macro|CR_RST
mdefine_line|#define CR_RST&t;&t;0x00000100
DECL|macro|PTSCR_EEBIST_EN
mdefine_line|#define PTSCR_EEBIST_EN&t;0x00000002
DECL|macro|PTSCR_EELOAD_EN
mdefine_line|#define PTSCR_EELOAD_EN&t;0x00000004
DECL|macro|ISR_TXDESC3
mdefine_line|#define ISR_TXDESC3&t;0x40000000
DECL|macro|ISR_TXDESC2
mdefine_line|#define ISR_TXDESC2&t;0x20000000
DECL|macro|ISR_TXDESC1
mdefine_line|#define ISR_TXDESC1&t;0x10000000
DECL|macro|ISR_TXDESC0
mdefine_line|#define ISR_TXDESC0&t;0x08000000
DECL|macro|ISR_RXDESC3
mdefine_line|#define ISR_RXDESC3&t;0x04000000
DECL|macro|ISR_RXDESC2
mdefine_line|#define ISR_RXDESC2&t;0x02000000
DECL|macro|ISR_RXDESC1
mdefine_line|#define ISR_RXDESC1&t;0x01000000
DECL|macro|ISR_RXDESC0
mdefine_line|#define ISR_RXDESC0&t;0x00800000
DECL|macro|ISR_TXRCMP
mdefine_line|#define ISR_TXRCMP&t;0x00400000
DECL|macro|ISR_RXRCMP
mdefine_line|#define ISR_RXRCMP&t;0x00200000
DECL|macro|ISR_DPERR
mdefine_line|#define ISR_DPERR&t;0x00100000
DECL|macro|ISR_SSERR
mdefine_line|#define ISR_SSERR&t;0x00080000
DECL|macro|ISR_RMABT
mdefine_line|#define ISR_RMABT&t;0x00040000
DECL|macro|ISR_RTABT
mdefine_line|#define ISR_RTABT&t;0x00020000
DECL|macro|ISR_RXSOVR
mdefine_line|#define ISR_RXSOVR&t;0x00010000
DECL|macro|ISR_HIBINT
mdefine_line|#define ISR_HIBINT&t;0x00008000
DECL|macro|ISR_PHY
mdefine_line|#define ISR_PHY&t;&t;0x00004000
DECL|macro|ISR_PME
mdefine_line|#define ISR_PME&t;&t;0x00002000
DECL|macro|ISR_SWI
mdefine_line|#define ISR_SWI&t;&t;0x00001000
DECL|macro|ISR_MIB
mdefine_line|#define ISR_MIB&t;&t;0x00000800
DECL|macro|ISR_TXURN
mdefine_line|#define ISR_TXURN&t;0x00000400
DECL|macro|ISR_TXIDLE
mdefine_line|#define ISR_TXIDLE&t;0x00000200
DECL|macro|ISR_TXERR
mdefine_line|#define ISR_TXERR&t;0x00000100
DECL|macro|ISR_TXDESC
mdefine_line|#define ISR_TXDESC&t;0x00000080
DECL|macro|ISR_TXOK
mdefine_line|#define ISR_TXOK&t;0x00000040
DECL|macro|ISR_RXORN
mdefine_line|#define ISR_RXORN&t;0x00000020
DECL|macro|ISR_RXIDLE
mdefine_line|#define ISR_RXIDLE&t;0x00000010
DECL|macro|ISR_RXEARLY
mdefine_line|#define ISR_RXEARLY&t;0x00000008
DECL|macro|ISR_RXERR
mdefine_line|#define ISR_RXERR&t;0x00000004
DECL|macro|ISR_RXDESC
mdefine_line|#define ISR_RXDESC&t;0x00000002
DECL|macro|ISR_RXOK
mdefine_line|#define ISR_RXOK&t;0x00000001
DECL|macro|TXCFG_CSI
mdefine_line|#define TXCFG_CSI&t;0x80000000
DECL|macro|TXCFG_HBI
mdefine_line|#define TXCFG_HBI&t;0x40000000
DECL|macro|TXCFG_MLB
mdefine_line|#define TXCFG_MLB&t;0x20000000
DECL|macro|TXCFG_ATP
mdefine_line|#define TXCFG_ATP&t;0x10000000
DECL|macro|TXCFG_ECRETRY
mdefine_line|#define TXCFG_ECRETRY&t;0x00800000
DECL|macro|TXCFG_BRST_DIS
mdefine_line|#define TXCFG_BRST_DIS&t;0x00080000
DECL|macro|TXCFG_MXDMA1024
mdefine_line|#define TXCFG_MXDMA1024&t;0x00000000
DECL|macro|TXCFG_MXDMA512
mdefine_line|#define TXCFG_MXDMA512&t;0x00700000
DECL|macro|TXCFG_MXDMA256
mdefine_line|#define TXCFG_MXDMA256&t;0x00600000
DECL|macro|TXCFG_MXDMA128
mdefine_line|#define TXCFG_MXDMA128&t;0x00500000
DECL|macro|TXCFG_MXDMA64
mdefine_line|#define TXCFG_MXDMA64&t;0x00400000
DECL|macro|TXCFG_MXDMA32
mdefine_line|#define TXCFG_MXDMA32&t;0x00300000
DECL|macro|TXCFG_MXDMA16
mdefine_line|#define TXCFG_MXDMA16&t;0x00200000
DECL|macro|TXCFG_MXDMA8
mdefine_line|#define TXCFG_MXDMA8&t;0x00100000
DECL|macro|CFG_LNKSTS
mdefine_line|#define CFG_LNKSTS&t;0x80000000
DECL|macro|CFG_SPDSTS
mdefine_line|#define CFG_SPDSTS&t;0x60000000
DECL|macro|CFG_SPDSTS1
mdefine_line|#define CFG_SPDSTS1&t;0x40000000
DECL|macro|CFG_SPDSTS0
mdefine_line|#define CFG_SPDSTS0&t;0x20000000
DECL|macro|CFG_DUPSTS
mdefine_line|#define CFG_DUPSTS&t;0x10000000
DECL|macro|CFG_TBI_EN
mdefine_line|#define CFG_TBI_EN&t;0x01000000
DECL|macro|CFG_MODE_1000
mdefine_line|#define CFG_MODE_1000&t;0x00400000
DECL|macro|CFG_PINT_CTL
mdefine_line|#define CFG_PINT_CTL&t;0x001c0000
DECL|macro|CFG_PINT_DUPSTS
mdefine_line|#define CFG_PINT_DUPSTS&t;0x00100000
DECL|macro|CFG_PINT_LNKSTS
mdefine_line|#define CFG_PINT_LNKSTS&t;0x00080000
DECL|macro|CFG_PINT_SPDSTS
mdefine_line|#define CFG_PINT_SPDSTS&t;0x00040000
DECL|macro|CFG_TMRTEST
mdefine_line|#define CFG_TMRTEST&t;0x00020000
DECL|macro|CFG_MRM_DIS
mdefine_line|#define CFG_MRM_DIS&t;0x00010000
DECL|macro|CFG_MWI_DIS
mdefine_line|#define CFG_MWI_DIS&t;0x00008000
DECL|macro|CFG_T64ADDR
mdefine_line|#define CFG_T64ADDR&t;0x00004000
DECL|macro|CFG_PCI64_DET
mdefine_line|#define CFG_PCI64_DET&t;0x00002000
DECL|macro|CFG_DATA64_EN
mdefine_line|#define CFG_DATA64_EN&t;0x00001000
DECL|macro|CFG_M64ADDR
mdefine_line|#define CFG_M64ADDR&t;0x00000800
DECL|macro|CFG_PHY_RST
mdefine_line|#define CFG_PHY_RST&t;0x00000400
DECL|macro|CFG_PHY_DIS
mdefine_line|#define CFG_PHY_DIS&t;0x00000200
DECL|macro|CFG_EXTSTS_EN
mdefine_line|#define CFG_EXTSTS_EN&t;0x00000100
DECL|macro|CFG_REQALG
mdefine_line|#define CFG_REQALG&t;0x00000080
DECL|macro|CFG_SB
mdefine_line|#define CFG_SB&t;&t;0x00000040
DECL|macro|CFG_POW
mdefine_line|#define CFG_POW&t;&t;0x00000020
DECL|macro|CFG_EXD
mdefine_line|#define CFG_EXD&t;&t;0x00000010
DECL|macro|CFG_PESEL
mdefine_line|#define CFG_PESEL&t;0x00000008
DECL|macro|CFG_BROM_DIS
mdefine_line|#define CFG_BROM_DIS&t;0x00000004
DECL|macro|CFG_EXT_125
mdefine_line|#define CFG_EXT_125&t;0x00000002
DECL|macro|CFG_BEM
mdefine_line|#define CFG_BEM&t;&t;0x00000001
DECL|macro|EXTSTS_UDPPKT
mdefine_line|#define EXTSTS_UDPPKT&t;0x00200000
DECL|macro|EXTSTS_TCPPKT
mdefine_line|#define EXTSTS_TCPPKT&t;0x00080000
DECL|macro|EXTSTS_IPPKT
mdefine_line|#define EXTSTS_IPPKT&t;0x00020000
DECL|macro|SPDSTS_POLARITY
mdefine_line|#define SPDSTS_POLARITY&t;(CFG_SPDSTS1 | CFG_SPDSTS0 | CFG_DUPSTS)
DECL|macro|MIBC_MIBS
mdefine_line|#define MIBC_MIBS&t;0x00000008
DECL|macro|MIBC_ACLR
mdefine_line|#define MIBC_ACLR&t;0x00000004
DECL|macro|MIBC_FRZ
mdefine_line|#define MIBC_FRZ&t;0x00000002
DECL|macro|MIBC_WRN
mdefine_line|#define MIBC_WRN&t;0x00000001
DECL|macro|RXCFG_AEP
mdefine_line|#define RXCFG_AEP&t;0x80000000
DECL|macro|RXCFG_ARP
mdefine_line|#define RXCFG_ARP&t;0x40000000
DECL|macro|RXCFG_STRIPCRC
mdefine_line|#define RXCFG_STRIPCRC&t;0x20000000
DECL|macro|RXCFG_RX_FD
mdefine_line|#define RXCFG_RX_FD&t;0x10000000
DECL|macro|RXCFG_ALP
mdefine_line|#define RXCFG_ALP&t;0x08000000
DECL|macro|RXCFG_AIRL
mdefine_line|#define RXCFG_AIRL&t;0x04000000
DECL|macro|RXCFG_MXDMA
mdefine_line|#define RXCFG_MXDMA&t;0x00700000
DECL|macro|RXCFG_MXDMA0
mdefine_line|#define RXCFG_MXDMA0&t;0x00100000
DECL|macro|RXCFG_MXDMA64
mdefine_line|#define RXCFG_MXDMA64&t;0x00600000
DECL|macro|RXCFG_DRTH
mdefine_line|#define RXCFG_DRTH&t;0x0000003e
DECL|macro|RXCFG_DRTH0
mdefine_line|#define RXCFG_DRTH0&t;0x00000002
DECL|macro|RFCR_RFEN
mdefine_line|#define RFCR_RFEN&t;0x80000000
DECL|macro|RFCR_AAB
mdefine_line|#define RFCR_AAB&t;0x40000000
DECL|macro|RFCR_AAM
mdefine_line|#define RFCR_AAM&t;0x20000000
DECL|macro|RFCR_AAU
mdefine_line|#define RFCR_AAU&t;0x10000000
DECL|macro|RFCR_APM
mdefine_line|#define RFCR_APM&t;0x08000000
DECL|macro|RFCR_APAT
mdefine_line|#define RFCR_APAT&t;0x07800000
DECL|macro|RFCR_APAT3
mdefine_line|#define RFCR_APAT3&t;0x04000000
DECL|macro|RFCR_APAT2
mdefine_line|#define RFCR_APAT2&t;0x02000000
DECL|macro|RFCR_APAT1
mdefine_line|#define RFCR_APAT1&t;0x01000000
DECL|macro|RFCR_APAT0
mdefine_line|#define RFCR_APAT0&t;0x00800000
DECL|macro|RFCR_AARP
mdefine_line|#define RFCR_AARP&t;0x00400000
DECL|macro|RFCR_MHEN
mdefine_line|#define RFCR_MHEN&t;0x00200000
DECL|macro|RFCR_UHEN
mdefine_line|#define RFCR_UHEN&t;0x00100000
DECL|macro|RFCR_ULM
mdefine_line|#define RFCR_ULM&t;0x00080000
DECL|macro|VRCR_RUDPE
mdefine_line|#define VRCR_RUDPE&t;0x00000080
DECL|macro|VRCR_RTCPE
mdefine_line|#define VRCR_RTCPE&t;0x00000040
DECL|macro|VRCR_RIPE
mdefine_line|#define VRCR_RIPE&t;0x00000020
DECL|macro|VRCR_IPEN
mdefine_line|#define VRCR_IPEN&t;0x00000010
DECL|macro|VRCR_DUTF
mdefine_line|#define VRCR_DUTF&t;0x00000008
DECL|macro|VRCR_DVTF
mdefine_line|#define VRCR_DVTF&t;0x00000004
DECL|macro|VRCR_VTREN
mdefine_line|#define VRCR_VTREN&t;0x00000002
DECL|macro|VRCR_VTDEN
mdefine_line|#define VRCR_VTDEN&t;0x00000001
DECL|macro|VTCR_PPCHK
mdefine_line|#define VTCR_PPCHK&t;0x00000008
DECL|macro|VTCR_GCHK
mdefine_line|#define VTCR_GCHK&t;0x00000004
DECL|macro|VTCR_VPPTI
mdefine_line|#define VTCR_VPPTI&t;0x00000002
DECL|macro|VTCR_VGTI
mdefine_line|#define VTCR_VGTI&t;0x00000001
DECL|macro|CR
mdefine_line|#define CR&t;&t;0x00
DECL|macro|CFG
mdefine_line|#define CFG&t;&t;0x04
DECL|macro|MEAR
mdefine_line|#define MEAR&t;&t;0x08
DECL|macro|PTSCR
mdefine_line|#define PTSCR&t;&t;0x0c
DECL|macro|ISR
mdefine_line|#define&t;ISR&t;&t;0x10
DECL|macro|IMR
mdefine_line|#define&t;IMR&t;&t;0x14
DECL|macro|IER
mdefine_line|#define&t;IER&t;&t;0x18
DECL|macro|IHR
mdefine_line|#define&t;IHR&t;&t;0x1c
DECL|macro|TXDP
mdefine_line|#define TXDP&t;&t;0x20
DECL|macro|TXDP_HI
mdefine_line|#define TXDP_HI&t;&t;0x24
DECL|macro|TXCFG
mdefine_line|#define TXCFG&t;&t;0x28
DECL|macro|GPIOR
mdefine_line|#define GPIOR&t;&t;0x2c
DECL|macro|RXDP
mdefine_line|#define RXDP&t;&t;0x30
DECL|macro|RXDP_HI
mdefine_line|#define RXDP_HI&t;&t;0x34
DECL|macro|RXCFG
mdefine_line|#define RXCFG&t;&t;0x38
DECL|macro|PQCR
mdefine_line|#define PQCR&t;&t;0x3c
DECL|macro|WCSR
mdefine_line|#define WCSR&t;&t;0x40
DECL|macro|PCR
mdefine_line|#define PCR&t;&t;0x44
DECL|macro|RFCR
mdefine_line|#define RFCR&t;&t;0x48
DECL|macro|RFDR
mdefine_line|#define RFDR&t;&t;0x4c
DECL|macro|SRR
mdefine_line|#define SRR&t;&t;0x58
DECL|macro|VRCR
mdefine_line|#define VRCR&t;&t;0xbc
DECL|macro|VTCR
mdefine_line|#define VTCR&t;&t;0xc0
DECL|macro|VDR
mdefine_line|#define VDR&t;&t;0xc4
DECL|macro|CCSR
mdefine_line|#define CCSR&t;&t;0xcc
DECL|macro|__kick_rx
mdefine_line|#define __kick_rx(dev)&t;writel(CR_RXE, dev-&gt;base + CR)
DECL|macro|kick_rx
mdefine_line|#define kick_rx(dev) do { &bslash;&n;&t;dprintk(&quot;kick_rx: maybe kicking&bslash;n&quot;); &bslash;&n;&t;if (test_and_clear_bit(0, &amp;dev-&gt;rx_info.idle)) { &bslash;&n;&t;&t;dprintk(&quot;actually kicking&bslash;n&quot;); &bslash;&n;&t;&t;writel(dev-&gt;rx_info.phy_descs + (4 * DESC_SIZE * dev-&gt;rx_info.next_rx), dev-&gt;base + RXDP); &bslash;&n;&t;&t;if (dev-&gt;rx_info.next_rx == dev-&gt;rx_info.next_empty) &bslash;&n;&t;&t;&t;printk(KERN_DEBUG &quot;%s: uh-oh: next_rx == next_empty???&bslash;n&quot;, dev-&gt;net_dev.name);&bslash;&n;&t;&t;__kick_rx(dev); &bslash;&n;&t;} &bslash;&n;} while(0)
macro_line|#ifdef USE_64BIT_ADDR
DECL|typedef|hw_addr_t
r_typedef
id|u64
id|hw_addr_t
suffix:semicolon
macro_line|#else
DECL|typedef|hw_addr_t
r_typedef
id|u32
id|hw_addr_t
suffix:semicolon
macro_line|#endif
DECL|macro|HW_ADDR_LEN
mdefine_line|#define HW_ADDR_LEN&t;(sizeof(hw_addr_t))
DECL|macro|LINK
mdefine_line|#define LINK&t;&t;0
DECL|macro|BUFPTR
mdefine_line|#define BUFPTR&t;&t;(LINK + HW_ADDR_LEN/4)
DECL|macro|CMDSTS
mdefine_line|#define CMDSTS&t;&t;(BUFPTR + HW_ADDR_LEN/4)
DECL|macro|EXTSTS
mdefine_line|#define EXTSTS&t;&t;(CMDSTS + 4/4)
DECL|macro|DRV_NEXT
mdefine_line|#define DRV_NEXT&t;(EXTSTS + 4/4)
DECL|macro|CMDSTS_OWN
mdefine_line|#define CMDSTS_OWN&t;0x80000000
DECL|macro|CMDSTS_MORE
mdefine_line|#define CMDSTS_MORE&t;0x40000000
DECL|macro|CMDSTS_INTR
mdefine_line|#define CMDSTS_INTR&t;0x20000000
DECL|macro|CMDSTS_ERR
mdefine_line|#define CMDSTS_ERR&t;0x10000000
DECL|macro|CMDSTS_OK
mdefine_line|#define CMDSTS_OK&t;0x08000000
DECL|macro|CMDSTS_DEST_MASK
mdefine_line|#define CMDSTS_DEST_MASK&t;0x01800000
DECL|macro|CMDSTS_DEST_SELF
mdefine_line|#define CMDSTS_DEST_SELF&t;0x00800000
DECL|macro|CMDSTS_DEST_MULTI
mdefine_line|#define CMDSTS_DEST_MULTI&t;0x01000000
DECL|macro|DESC_SIZE
mdefine_line|#define DESC_SIZE&t;8&t;&t;/* Should be cache line sized */
DECL|struct|rx_info
r_struct
id|rx_info
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|up
r_int
id|up
suffix:semicolon
DECL|member|idle
r_int
id|idle
suffix:semicolon
DECL|member|skbs
r_struct
id|sk_buff
op_star
id|skbs
(braket
id|NR_RX_DESC
)braket
suffix:semicolon
DECL|member|next_rx
DECL|member|next_empty
r_int
id|next_rx
comma
id|next_empty
suffix:semicolon
DECL|member|descs
id|u32
op_star
id|descs
suffix:semicolon
DECL|member|phy_descs
id|dma_addr_t
id|phy_descs
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ns83820
r_struct
id|ns83820
(brace
DECL|member|net_dev
r_struct
id|net_device
id|net_dev
suffix:semicolon
DECL|member|base
id|u8
op_star
id|base
suffix:semicolon
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
DECL|member|next_dev
r_struct
id|ns83820
op_star
id|next_dev
suffix:semicolon
DECL|member|rx_info
r_struct
id|rx_info
id|rx_info
suffix:semicolon
DECL|member|ihr
r_int
id|ihr
suffix:semicolon
DECL|member|tq_refill
r_struct
id|tq_struct
id|tq_refill
suffix:semicolon
multiline_comment|/* protects everything below.  irqsave when using. */
DECL|member|misc_lock
id|spinlock_t
id|misc_lock
suffix:semicolon
DECL|member|CFG_cache
id|u32
id|CFG_cache
suffix:semicolon
DECL|member|MEAR_cache
id|u32
id|MEAR_cache
suffix:semicolon
DECL|member|IMR_cache
id|u32
id|IMR_cache
suffix:semicolon
DECL|member|ee
r_struct
id|eeprom
id|ee
suffix:semicolon
DECL|member|tx_lock
id|spinlock_t
id|tx_lock
suffix:semicolon
DECL|member|tx_idle
r_int
id|tx_idle
suffix:semicolon
DECL|member|tx_done_idx
id|u32
id|tx_done_idx
suffix:semicolon
DECL|member|tx_idx
id|u32
id|tx_idx
suffix:semicolon
DECL|member|tx_free_idx
r_volatile
id|u32
id|tx_free_idx
suffix:semicolon
multiline_comment|/* idx of free desc chain */
DECL|member|tx_intr_idx
id|u32
id|tx_intr_idx
suffix:semicolon
DECL|member|tx_skbs
r_struct
id|sk_buff
op_star
id|tx_skbs
(braket
id|NR_TX_DESC
)braket
suffix:semicolon
DECL|member|pad
r_char
id|pad
(braket
l_int|16
)braket
id|__attribute__
c_func
(paren
(paren
id|aligned
c_func
(paren
l_int|16
)paren
)paren
)paren
suffix:semicolon
DECL|member|tx_descs
id|u32
op_star
id|tx_descs
suffix:semicolon
DECL|member|tx_phy_descs
id|dma_addr_t
id|tx_phy_descs
suffix:semicolon
)brace
suffix:semicolon
singleline_comment|//free = (tx_done_idx + NR_TX_DESC-2 - free_idx) % NR_TX_DESC
DECL|macro|start_tx_okay
mdefine_line|#define start_tx_okay(dev)&t;&bslash;&n;&t;(((NR_TX_DESC-2 + dev-&gt;tx_done_idx - dev-&gt;tx_free_idx) % NR_TX_DESC) &gt; NR_TX_DESC/2)
DECL|variable|ns83820_chain
r_static
r_struct
id|ns83820
op_star
id|ns83820_chain
suffix:semicolon
multiline_comment|/* Packet Receiver&n; *&n; * The hardware supports linked lists of receive descriptors for&n; * which ownership is transfered back and forth by means of an&n; * ownership bit.  While the hardware does support the use of a&n; * ring for receive descriptors, we only make use of a chain in&n; * an attempt to reduce bus traffic under heavy load scenarios.&n; * This will also make bugs a bit more obvious.  The current code&n; * only makes use of a single rx chain; I hope to implement&n; * priority based rx for version 1.0.  Goal: even under overload&n; * conditions, still route realtime traffic with as low jitter as&n; * possible.&n; */
macro_line|#ifdef USE_64BIT_ADDR
DECL|function|build_rx_desc64
r_static
r_inline
r_void
id|build_rx_desc64
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
id|u32
op_star
id|desc
comma
id|u64
id|link
comma
id|u64
id|buf
comma
id|u32
id|cmdsts
comma
id|u32
id|extsts
)paren
(brace
id|desc
(braket
l_int|0
)braket
op_assign
id|link
suffix:semicolon
id|desc
(braket
l_int|1
)braket
op_assign
id|link
op_rshift
l_int|32
suffix:semicolon
id|desc
(braket
l_int|2
)braket
op_assign
id|buf
suffix:semicolon
id|desc
(braket
l_int|3
)braket
op_assign
id|buf
op_rshift
l_int|32
suffix:semicolon
id|desc
(braket
l_int|5
)braket
op_assign
id|extsts
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|desc
(braket
l_int|4
)braket
op_assign
id|cmdsts
suffix:semicolon
)brace
DECL|macro|build_rx_desc
mdefine_line|#define build_rx_desc&t;build_rx_desc64
macro_line|#else
DECL|function|build_rx_desc32
r_static
r_inline
r_void
id|build_rx_desc32
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
id|u32
op_star
id|desc
comma
id|u32
id|link
comma
id|u32
id|buf
comma
id|u32
id|cmdsts
comma
id|u32
id|extsts
)paren
(brace
id|desc
(braket
l_int|0
)braket
op_assign
id|link
suffix:semicolon
id|desc
(braket
l_int|1
)braket
op_assign
id|buf
suffix:semicolon
id|desc
(braket
l_int|3
)braket
op_assign
id|extsts
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|desc
(braket
l_int|2
)braket
op_assign
id|cmdsts
suffix:semicolon
)brace
DECL|macro|build_rx_desc
mdefine_line|#define build_rx_desc&t;build_rx_desc32
macro_line|#endif
DECL|macro|nr_rx_empty
mdefine_line|#define nr_rx_empty(dev) ((NR_RX_DESC-2 + dev-&gt;rx_info.next_rx - dev-&gt;rx_info.next_empty) % NR_RX_DESC)
DECL|function|ns83820_add_rx_skb
r_static
r_inline
r_int
id|ns83820_add_rx_skb
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|next_empty
suffix:semicolon
id|u32
id|cmdsts
suffix:semicolon
id|u32
op_star
id|sg
suffix:semicolon
id|hw_addr_t
id|buf
suffix:semicolon
id|next_empty
op_assign
id|dev-&gt;rx_info.next_empty
suffix:semicolon
multiline_comment|/* don&squot;t overrun last rx marker */
r_if
c_cond
(paren
id|nr_rx_empty
c_func
(paren
id|dev
)paren
op_le
l_int|2
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#if 0
id|dprintk
c_func
(paren
l_string|&quot;next_empty[%d] nr_used[%d] next_rx[%d]&bslash;n&quot;
comma
id|dev-&gt;rx_info.next_empty
comma
id|dev-&gt;rx_info.nr_used
comma
id|dev-&gt;rx_info.next_rx
)paren
suffix:semicolon
macro_line|#endif
id|sg
op_assign
id|dev-&gt;rx_info.descs
op_plus
(paren
id|next_empty
op_star
id|DESC_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;rx_info.skbs
(braket
id|next_empty
)braket
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;rx_info.skbs
(braket
id|next_empty
)braket
op_assign
id|skb
suffix:semicolon
id|dev-&gt;rx_info.next_empty
op_assign
(paren
id|next_empty
op_plus
l_int|1
)paren
op_mod
id|NR_RX_DESC
suffix:semicolon
id|cmdsts
op_assign
id|RX_BUF_SIZE
op_or
id|CMDSTS_INTR
suffix:semicolon
id|buf
op_assign
id|pci_map_single
c_func
(paren
id|dev-&gt;pci_dev
comma
id|skb-&gt;tail
comma
id|RX_BUF_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
id|build_rx_desc
c_func
(paren
id|dev
comma
id|sg
comma
l_int|0
comma
id|buf
comma
id|cmdsts
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* update link of previous rx */
r_if
c_cond
(paren
id|next_empty
op_ne
id|dev-&gt;rx_info.next_rx
)paren
id|dev-&gt;rx_info.descs
(braket
(paren
(paren
id|NR_RX_DESC
op_plus
id|next_empty
op_minus
l_int|1
)paren
op_mod
id|NR_RX_DESC
)paren
op_star
id|DESC_SIZE
)braket
op_assign
id|dev-&gt;rx_info.phy_descs
op_plus
(paren
id|next_empty
op_star
id|DESC_SIZE
op_star
l_int|4
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rx_refill
r_static
r_int
id|rx_refill
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
r_int
id|gfp
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;rx_refill(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gfp
op_eq
id|GFP_ATOMIC
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|res
suffix:semicolon
id|skb
op_assign
id|__dev_alloc_skb
c_func
(paren
id|RX_BUF_SIZE
op_plus
l_int|16
comma
id|gfp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_break
suffix:semicolon
id|res
op_assign
(paren
r_int
)paren
id|skb-&gt;tail
op_amp
l_int|0xf
suffix:semicolon
id|res
op_assign
l_int|0x10
op_minus
id|res
suffix:semicolon
id|res
op_and_assign
l_int|0xf
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|res
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
op_amp
id|dev-&gt;net_dev
suffix:semicolon
r_if
c_cond
(paren
id|gfp
op_ne
id|GFP_ATOMIC
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
comma
id|flags
)paren
suffix:semicolon
id|res
op_assign
id|ns83820_add_rx_skb
c_func
(paren
id|dev
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gfp
op_ne
id|GFP_ATOMIC
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|i
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|gfp
op_eq
id|GFP_ATOMIC
)paren
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|i
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* REFILL */
DECL|function|queue_refill
r_static
r_inline
r_void
id|queue_refill
c_func
(paren
r_void
op_star
id|_dev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|_dev
suffix:semicolon
id|rx_refill
c_func
(paren
id|dev
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;rx_info.up
)paren
id|kick_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|clear_rx_desc
r_static
r_inline
r_void
id|clear_rx_desc
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
r_int
id|i
)paren
(brace
id|build_rx_desc
c_func
(paren
id|dev
comma
id|dev-&gt;rx_info.descs
op_plus
(paren
id|DESC_SIZE
op_star
id|i
)paren
comma
l_int|0
comma
l_int|0
comma
id|CMDSTS_OWN
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|phy_intr
r_static
r_void
id|phy_intr
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
r_static
r_char
op_star
id|speeds
(braket
)braket
op_assign
(brace
l_string|&quot;10&quot;
comma
l_string|&quot;100&quot;
comma
l_string|&quot;1000&quot;
comma
l_string|&quot;1000(?)&quot;
)brace
suffix:semicolon
id|u32
id|cfg
comma
id|new_cfg
suffix:semicolon
id|new_cfg
op_assign
id|dev-&gt;CFG_cache
op_amp
op_complement
(paren
id|CFG_SB
op_or
id|CFG_MODE_1000
op_or
id|CFG_SPDSTS
)paren
suffix:semicolon
id|cfg
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|CFG
)paren
op_xor
id|SPDSTS_POLARITY
suffix:semicolon
r_if
c_cond
(paren
id|cfg
op_amp
id|CFG_SPDSTS1
)paren
id|new_cfg
op_or_assign
id|CFG_MODE_1000
op_or
id|CFG_SB
suffix:semicolon
r_else
id|new_cfg
op_and_assign
op_complement
id|CFG_MODE_1000
op_or
id|CFG_SB
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cfg
op_amp
id|CFG_LNKSTS
)paren
op_logical_and
(paren
(paren
id|new_cfg
op_xor
id|dev-&gt;CFG_cache
)paren
op_amp
id|CFG_MODE_1000
)paren
)paren
(brace
id|writel
c_func
(paren
id|new_cfg
comma
id|dev-&gt;base
op_plus
id|CFG
)paren
suffix:semicolon
id|dev-&gt;CFG_cache
op_assign
id|new_cfg
suffix:semicolon
)brace
id|dev-&gt;CFG_cache
op_and_assign
op_complement
id|CFG_SPDSTS
suffix:semicolon
id|dev-&gt;CFG_cache
op_or_assign
id|cfg
op_amp
id|CFG_SPDSTS
suffix:semicolon
r_if
c_cond
(paren
id|cfg
op_amp
id|CFG_LNKSTS
)paren
(brace
id|netif_start_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|netif_stop_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg
op_amp
id|CFG_LNKSTS
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link now %s mbps, %s duplex and up.&bslash;n&quot;
comma
id|dev-&gt;net_dev.name
comma
id|speeds
(braket
(paren
(paren
id|cfg
op_div
id|CFG_SPDSTS0
)paren
op_amp
l_int|3
)paren
)braket
comma
(paren
id|cfg
op_amp
id|CFG_DUPSTS
)paren
ques
c_cond
l_string|&quot;full&quot;
suffix:colon
l_string|&quot;half&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: link now down.&bslash;n&quot;
comma
id|dev-&gt;net_dev.name
)paren
suffix:semicolon
)brace
DECL|function|ns83820_setup_rx
r_static
r_int
id|ns83820_setup_rx
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;ns83820_setup_rx(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|dev-&gt;rx_info.idle
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;rx_info.next_rx
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;rx_info.next_empty
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
id|clear_rx_desc
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|RXDP_HI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;rx_info.phy_descs
comma
id|dev-&gt;base
op_plus
id|RXDP
)paren
suffix:semicolon
id|ret
op_assign
id|rx_refill
c_func
(paren
id|dev
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;starting receiver&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* prevent the interrupt handler from stomping on us */
id|spin_lock_irq
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x0001
comma
id|dev-&gt;base
op_plus
id|CCSR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|RFCR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x7fc00000
comma
id|dev-&gt;base
op_plus
id|RFCR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffc00000
comma
id|dev-&gt;base
op_plus
id|RFCR
)paren
suffix:semicolon
id|dev-&gt;rx_info.up
op_assign
l_int|1
suffix:semicolon
id|phy_intr
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Okay, let it rip */
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_PHY
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_RXRCMP
suffix:semicolon
singleline_comment|//dev-&gt;IMR_cache |= ISR_RXERR;
singleline_comment|//dev-&gt;IMR_cache |= ISR_RXOK;
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_RXORN
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_RXSOVR
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_RXDESC
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_RXIDLE
suffix:semicolon
id|dev-&gt;IMR_cache
op_or_assign
id|ISR_TXDESC
suffix:semicolon
singleline_comment|//dev-&gt;IMR_cache |= ISR_TXIDLE;
id|writel
c_func
(paren
id|dev-&gt;IMR_cache
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|1
comma
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|kick_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ns83820_cleanup_rx
r_static
r_void
id|ns83820_cleanup_rx
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;ns83820_cleanup_rx(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* disable receive interrupts */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;misc_lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_and_assign
op_complement
(paren
id|ISR_RXOK
op_or
id|ISR_RXDESC
op_or
id|ISR_RXERR
op_or
id|ISR_RXEARLY
op_or
id|ISR_RXIDLE
)paren
suffix:semicolon
id|writel
c_func
(paren
id|dev-&gt;IMR_cache
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;misc_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* synchronize with the interrupt handler and kill it */
id|dev-&gt;rx_info.up
op_assign
l_int|0
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* touch the pci bus... */
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
multiline_comment|/* assumes the transmitter is already disabled and reset */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|RXDP_HI
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|RXDP
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_RX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev-&gt;rx_info.skbs
(braket
id|i
)braket
suffix:semicolon
id|dev-&gt;rx_info.skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|clear_rx_desc
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* rx_irq&n; *&t;&n; */
r_static
r_void
id|FASTCALL
c_func
(paren
id|rx_irq
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
)paren
suffix:semicolon
DECL|function|rx_irq
r_static
r_void
id|rx_irq
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
r_struct
id|rx_info
op_star
id|info
op_assign
op_amp
id|dev-&gt;rx_info
suffix:semicolon
r_int
id|next_rx
suffix:semicolon
id|u32
id|cmdsts
comma
op_star
id|desc
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|nr
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;rx_irq(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;rxdp: %08x, descs: %08lx next_rx[%d]: %p next_empty[%d]: %p&bslash;n&quot;
comma
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|RXDP
)paren
comma
(paren
id|dev-&gt;rx_info.phy_descs
)paren
comma
id|dev-&gt;rx_info.next_rx
comma
(paren
id|dev-&gt;rx_info.descs
op_plus
(paren
id|DESC_SIZE
op_star
id|dev-&gt;rx_info.next_rx
)paren
)paren
comma
id|dev-&gt;rx_info.next_empty
comma
(paren
id|dev-&gt;rx_info.descs
op_plus
(paren
id|DESC_SIZE
op_star
id|dev-&gt;rx_info.next_empty
)paren
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;up
)paren
r_goto
id|out
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;walking descs&bslash;n&quot;
)paren
suffix:semicolon
id|next_rx
op_assign
id|info-&gt;next_rx
suffix:semicolon
id|desc
op_assign
id|info-&gt;descs
op_plus
(paren
id|DESC_SIZE
op_star
id|next_rx
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|CMDSTS_OWN
op_amp
(paren
id|cmdsts
op_assign
id|desc
(braket
id|CMDSTS
)braket
)paren
)paren
op_logical_and
(paren
id|cmdsts
op_ne
id|CMDSTS_OWN
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u32
id|extsts
op_assign
id|desc
(braket
id|EXTSTS
)braket
suffix:semicolon
id|dmaaddr_high_t
id|bufptr
op_assign
op_star
(paren
id|hw_addr_t
op_star
)paren
(paren
id|desc
op_plus
id|BUFPTR
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;cmdsts: %08x&bslash;n&quot;
comma
id|cmdsts
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;link: %08x&bslash;n&quot;
comma
id|desc
(braket
id|LINK
)braket
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;extsts: %08x&bslash;n&quot;
comma
id|desc
(braket
id|EXTSTS
)braket
)paren
suffix:semicolon
id|skb
op_assign
id|info-&gt;skbs
(braket
id|next_rx
)braket
suffix:semicolon
id|info-&gt;skbs
(braket
id|next_rx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;next_rx
op_assign
(paren
id|next_rx
op_plus
l_int|1
)paren
op_mod
id|NR_RX_DESC
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|clear_rx_desc
c_func
(paren
id|dev
comma
id|next_rx
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|dev-&gt;pci_dev
comma
id|bufptr
comma
id|RX_BUF_SIZE
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CMDSTS_OK
op_amp
id|cmdsts
)paren
(brace
macro_line|#ifndef __i386__
r_struct
id|sk_buff
op_star
id|tmp
suffix:semicolon
macro_line|#endif
r_int
id|len
op_assign
id|cmdsts
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
macro_line|#ifndef __i386__&t;/* I hate the network stack sometimes */
id|tmp
op_assign
id|__dev_alloc_skb
c_func
(paren
id|RX_BUF_SIZE
op_plus
l_int|16
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
r_goto
id|done
suffix:semicolon
id|tmp-&gt;dev
op_assign
op_amp
id|dev-&gt;net_dev
suffix:semicolon
id|skb_reserve
c_func
(paren
id|tmp
comma
l_int|2
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|tmp
comma
id|len
)paren
comma
id|skb-&gt;data
comma
id|len
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|tmp
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|extsts
op_amp
l_int|0x002a0000
)paren
op_logical_and
op_logical_neg
(paren
id|extsts
op_amp
l_int|0x00540000
)paren
)paren
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
)brace
r_else
(brace
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
)brace
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|netif_rx
c_func
(paren
id|skb
)paren
)paren
(brace
r_case
id|NET_RX_SUCCESS
suffix:colon
id|dev-&gt;ihr
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NET_RX_CN_LOW
suffix:colon
id|dev-&gt;ihr
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NET_RX_CN_MOD
suffix:colon
id|dev-&gt;ihr
op_assign
id|dev-&gt;ihr
op_plus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NET_RX_CN_HIGH
suffix:colon
id|dev-&gt;ihr
op_add_assign
id|dev-&gt;ihr
op_div
l_int|2
op_plus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NET_RX_DROP
suffix:colon
id|dev-&gt;ihr
op_assign
l_int|255
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;ihr
OG
l_int|255
)paren
id|dev-&gt;ihr
op_assign
l_int|255
suffix:semicolon
macro_line|#ifndef __i386__
id|done
suffix:colon
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_static
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|err
op_increment
OL
l_int|20
)paren
(brace
id|Dprintk
c_func
(paren
l_string|&quot;error packet: cmdsts: %08x extsts: %08x&bslash;n&quot;
comma
id|cmdsts
comma
id|extsts
)paren
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|nr
op_increment
suffix:semicolon
id|next_rx
op_assign
id|info-&gt;next_rx
suffix:semicolon
id|desc
op_assign
id|info-&gt;descs
op_plus
(paren
id|DESC_SIZE
op_star
id|next_rx
)paren
suffix:semicolon
)brace
id|info-&gt;next_rx
op_assign
id|next_rx
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
l_int|0
op_logical_and
op_logical_neg
id|nr
)paren
(brace
id|Dprintk
c_func
(paren
l_string|&quot;dazed: cmdsts_f: %08x&bslash;n&quot;
comma
id|cmdsts
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Packet Transmit code&n; */
DECL|function|kick_tx
r_static
r_inline
r_void
id|kick_tx
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;kick_tx(%p): tx_idle=%ld, tx_idx=%d free_idx=%d&bslash;n&quot;
comma
id|dev
comma
id|dev-&gt;tx_idle
comma
id|dev-&gt;tx_idx
comma
id|dev-&gt;tx_free_idx
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CR_TXE
comma
id|dev-&gt;base
op_plus
id|CR
)paren
suffix:semicolon
)brace
multiline_comment|/* no spinlock needed on the transmit irq path as the interrupt handler is serialized */
DECL|function|do_tx_done
r_static
r_void
id|do_tx_done
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
id|u32
id|cmdsts
comma
id|tx_done_idx
comma
op_star
id|desc
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;do_tx_done(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|tx_done_idx
op_assign
id|dev-&gt;tx_done_idx
suffix:semicolon
id|desc
op_assign
id|dev-&gt;tx_descs
op_plus
(paren
id|tx_done_idx
op_star
id|DESC_SIZE
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;tx_done_idx=%d free_idx=%d cmdsts=%08x&bslash;n&quot;
comma
id|tx_done_idx
comma
id|dev-&gt;tx_free_idx
comma
id|desc
(braket
id|CMDSTS
)braket
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tx_done_idx
op_ne
id|dev-&gt;tx_free_idx
)paren
op_logical_and
op_logical_neg
(paren
id|CMDSTS_OWN
op_amp
(paren
id|cmdsts
op_assign
id|desc
(braket
id|CMDSTS
)braket
)paren
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;tx_done_idx=%d free_idx=%d cmdsts=%08x&bslash;n&quot;
comma
id|tx_done_idx
comma
id|dev-&gt;tx_free_idx
comma
id|desc
(braket
id|CMDSTS
)braket
)paren
suffix:semicolon
id|skb
op_assign
id|dev-&gt;tx_skbs
(braket
id|tx_done_idx
)braket
suffix:semicolon
id|dev-&gt;tx_skbs
(braket
id|tx_done_idx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;done(%p)&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|dev-&gt;pci_dev
comma
op_star
(paren
id|hw_addr_t
op_star
)paren
(paren
id|desc
op_plus
id|BUFPTR
)paren
comma
id|skb-&gt;len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|tx_done_idx
op_assign
(paren
id|tx_done_idx
op_plus
l_int|1
)paren
op_mod
id|NR_TX_DESC
suffix:semicolon
id|dev-&gt;tx_done_idx
op_assign
id|tx_done_idx
suffix:semicolon
id|desc
(braket
id|CMDSTS
)braket
op_assign
l_int|0
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|desc
op_assign
id|dev-&gt;tx_descs
op_plus
(paren
id|tx_done_idx
op_star
id|DESC_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* Allow network stack to resume queueing packets after we&squot;ve&n;&t; * finished transmitting at least 1/4 of the packets in the queue.&n;&t; */
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
op_logical_and
id|start_tx_okay
c_func
(paren
id|dev
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;start_queue(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
)brace
)brace
DECL|function|ns83820_cleanup_tx
r_static
r_void
id|ns83820_cleanup_tx
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev-&gt;tx_skbs
(braket
id|i
)braket
suffix:semicolon
id|dev-&gt;tx_skbs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev-&gt;tx_descs
comma
l_int|0
comma
id|NR_TX_DESC
op_star
id|DESC_SIZE
op_star
l_int|4
)paren
suffix:semicolon
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
id|dev-&gt;tx_idle
)paren
suffix:semicolon
)brace
multiline_comment|/* transmit routine.  This code relies on the network layer serializing&n; * its calls in, but will run happily in parallel with the interrupt&n; * handler.  This code currently has provisions for fragmenting tx buffers&n; * while trying to track down a bug in either the zero copy code or&n; * the tx fifo (hence the MAX_FRAG_LEN).&n; */
DECL|macro|MAX_FRAG_LEN
mdefine_line|#define MAX_FRAG_LEN&t;8192&t;/* disabled for now */
DECL|function|ns83820_hard_start_xmit
r_static
r_int
id|ns83820_hard_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|_dev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
(paren
r_struct
id|ns83820
op_star
)paren
id|_dev
suffix:semicolon
id|u32
id|free_idx
comma
id|cmdsts
comma
id|extsts
suffix:semicolon
r_int
id|nr_free
comma
id|nr_frags
suffix:semicolon
r_int
id|tx_done_idx
suffix:semicolon
id|dmaaddr_high_t
id|buf
suffix:semicolon
r_int
id|len
suffix:semicolon
id|skb_frag_t
op_star
id|frag
suffix:semicolon
r_int
id|stopped
op_assign
l_int|0
suffix:semicolon
r_int
id|do_intr
op_assign
l_int|0
suffix:semicolon
r_volatile
id|u32
op_star
id|first_desc
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;ns83820_hard_start_xmit&bslash;n&quot;
)paren
suffix:semicolon
id|nr_frags
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
id|again
suffix:colon
r_if
c_cond
(paren
id|__builtin_expect
c_func
(paren
id|dev-&gt;CFG_cache
op_amp
id|CFG_LNKSTS
comma
l_int|0
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__builtin_expect
c_func
(paren
id|dev-&gt;CFG_cache
op_amp
id|CFG_LNKSTS
comma
l_int|0
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|netif_start_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
)brace
id|free_idx
op_assign
id|dev-&gt;tx_free_idx
suffix:semicolon
id|tx_done_idx
op_assign
id|dev-&gt;tx_done_idx
suffix:semicolon
id|nr_free
op_assign
(paren
id|tx_done_idx
op_plus
id|NR_TX_DESC
op_minus
l_int|2
op_minus
id|free_idx
)paren
op_mod
id|NR_TX_DESC
suffix:semicolon
id|nr_free
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nr_free
op_le
id|nr_frags
)paren
op_logical_or
(paren
id|nr_free
op_le
l_int|8192
op_div
id|MAX_FRAG_LEN
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;stop_queue - not enough(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
multiline_comment|/* Check again: we may have raced with a tx done irq */
r_if
c_cond
(paren
id|dev-&gt;tx_done_idx
op_ne
id|tx_done_idx
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;restart queue(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|free_idx
op_eq
id|dev-&gt;tx_intr_idx
)paren
(brace
id|do_intr
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;tx_intr_idx
op_assign
(paren
id|dev-&gt;tx_intr_idx
op_plus
id|NR_TX_DESC
op_div
l_int|2
)paren
op_mod
id|NR_TX_DESC
suffix:semicolon
)brace
id|nr_free
op_sub_assign
id|nr_frags
suffix:semicolon
r_if
c_cond
(paren
id|nr_free
OL
l_int|1
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;stop_queue - last entry(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
id|stopped
op_assign
l_int|1
suffix:semicolon
)brace
id|frag
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nr_frags
)paren
id|frag
op_assign
l_int|0
suffix:semicolon
id|extsts
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;ip_summed
op_eq
id|CHECKSUM_HW
)paren
(brace
id|extsts
op_or_assign
id|EXTSTS_IPPKT
suffix:semicolon
r_if
c_cond
(paren
id|IPPROTO_TCP
op_eq
id|skb-&gt;nh.iph-&gt;protocol
)paren
id|extsts
op_or_assign
id|EXTSTS_TCPPKT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|IPPROTO_UDP
op_eq
id|skb-&gt;nh.iph-&gt;protocol
)paren
id|extsts
op_or_assign
id|EXTSTS_UDPPKT
suffix:semicolon
)brace
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|nr_frags
)paren
id|len
op_sub_assign
id|skb-&gt;data_len
suffix:semicolon
id|buf
op_assign
id|pci_map_single
c_func
(paren
id|dev-&gt;pci_dev
comma
id|skb-&gt;data
comma
id|len
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|first_desc
op_assign
id|dev-&gt;tx_descs
op_plus
(paren
id|free_idx
op_star
id|DESC_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_volatile
id|u32
op_star
id|desc
op_assign
id|dev-&gt;tx_descs
op_plus
(paren
id|free_idx
op_star
id|DESC_SIZE
)paren
suffix:semicolon
id|u32
id|residue
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|len
OG
id|MAX_FRAG_LEN
)paren
(brace
id|residue
op_assign
id|len
suffix:semicolon
multiline_comment|/* align the start address of the next fragment */
id|len
op_assign
id|MAX_FRAG_LEN
suffix:semicolon
id|residue
op_sub_assign
id|len
suffix:semicolon
)brace
macro_line|#endif
id|dprintk
c_func
(paren
l_string|&quot;frag[%3u]: %4u @ 0x%x%08Lx&bslash;n&quot;
comma
id|free_idx
comma
id|len
comma
(paren
r_int
r_int
r_int
)paren
id|buf
)paren
suffix:semicolon
id|free_idx
op_assign
(paren
id|free_idx
op_plus
l_int|1
)paren
op_mod
id|NR_TX_DESC
suffix:semicolon
id|desc
(braket
id|LINK
)braket
op_assign
id|dev-&gt;tx_phy_descs
op_plus
(paren
id|free_idx
op_star
id|DESC_SIZE
op_star
l_int|4
)paren
suffix:semicolon
op_star
(paren
id|hw_addr_t
op_star
)paren
(paren
id|desc
op_plus
id|BUFPTR
)paren
op_assign
id|buf
suffix:semicolon
id|desc
(braket
id|EXTSTS
)braket
op_assign
id|extsts
suffix:semicolon
id|cmdsts
op_assign
(paren
(paren
id|nr_frags
op_or
id|residue
)paren
ques
c_cond
id|CMDSTS_MORE
suffix:colon
id|do_intr
ques
c_cond
id|CMDSTS_INTR
suffix:colon
l_int|0
)paren
suffix:semicolon
id|cmdsts
op_or_assign
(paren
id|desc
op_eq
id|first_desc
)paren
ques
c_cond
l_int|0
suffix:colon
id|CMDSTS_OWN
suffix:semicolon
id|cmdsts
op_or_assign
id|len
suffix:semicolon
id|desc
(braket
id|CMDSTS
)braket
op_assign
id|cmdsts
suffix:semicolon
r_if
c_cond
(paren
id|residue
)paren
(brace
id|buf
op_add_assign
id|len
suffix:semicolon
id|len
op_assign
id|residue
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|nr_frags
)paren
r_break
suffix:semicolon
id|buf
op_assign
id|pci_map_single_high
c_func
(paren
id|dev-&gt;pci_dev
comma
id|frag-&gt;page
comma
l_int|0
comma
id|frag-&gt;size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;frag: buf=%08Lx  page=%08lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|buf
comma
(paren
r_int
)paren
(paren
id|frag-&gt;page
op_minus
id|mem_map
)paren
)paren
suffix:semicolon
id|len
op_assign
id|frag-&gt;size
suffix:semicolon
id|frag
op_increment
suffix:semicolon
id|nr_frags
op_decrement
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;done pkt&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;tx_skbs
(braket
id|free_idx
)braket
op_assign
id|skb
suffix:semicolon
id|first_desc
(braket
id|CMDSTS
)braket
op_or_assign
id|CMDSTS_OWN
suffix:semicolon
id|dev-&gt;tx_free_idx
op_assign
id|free_idx
suffix:semicolon
id|kick_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Check again: we may have raced with a tx done irq */
r_if
c_cond
(paren
id|stopped
op_logical_and
(paren
id|dev-&gt;tx_done_idx
op_ne
id|tx_done_idx
)paren
op_logical_and
id|start_tx_okay
c_func
(paren
id|dev
)paren
)paren
id|netif_start_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ns83820_irq
r_static
r_void
id|ns83820_irq
c_func
(paren
r_int
id|foo
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
id|data
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|u32
id|isr
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;ns83820_irq(%p)&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|dev-&gt;ihr
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
op_increment
OL
l_int|32
op_logical_and
(paren
id|isr
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|ISR
)paren
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;irq: %08x&bslash;n&quot;
comma
id|isr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
op_complement
(paren
id|ISR_PHY
op_or
id|ISR_RXDESC
op_or
id|ISR_RXEARLY
op_or
id|ISR_RXOK
op_or
id|ISR_RXERR
op_or
id|ISR_TXIDLE
op_or
id|ISR_TXOK
op_or
id|ISR_TXDESC
)paren
)paren
id|Dprintk
c_func
(paren
l_string|&quot;odd isr? 0x%08x&bslash;n&quot;
comma
id|isr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ISR_RXEARLY
op_or
id|ISR_RXIDLE
op_or
id|ISR_RXORN
op_or
id|ISR_RXDESC
op_or
id|ISR_RXOK
op_or
id|ISR_RXERR
)paren
op_amp
id|isr
)paren
(brace
r_if
c_cond
(paren
id|ISR_RXIDLE
op_amp
id|isr
)paren
(brace
id|dev-&gt;rx_info.idle
op_assign
l_int|1
suffix:semicolon
id|Dprintk
c_func
(paren
l_string|&quot;oh dear, we are idle&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ISR_RXDESC
)paren
op_amp
id|isr
)paren
(brace
id|rx_irq
c_func
(paren
id|dev
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|4
comma
id|dev-&gt;base
op_plus
id|IHR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nr_rx_empty
c_func
(paren
id|dev
)paren
op_ge
id|NR_RX_DESC
op_div
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;rx_info.up
)paren
(brace
id|rx_refill
c_func
(paren
id|dev
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|kick_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;rx_info.up
op_logical_and
id|nr_rx_empty
c_func
(paren
id|dev
)paren
OG
id|NR_RX_DESC
op_star
l_int|3
op_div
l_int|4
)paren
id|schedule_task
c_func
(paren
op_amp
id|dev-&gt;tq_refill
)paren
suffix:semicolon
r_else
id|kick_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;rx_info.idle
)paren
id|Dprintk
c_func
(paren
l_string|&quot;BAD&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ISR_RXSOVR
op_amp
id|isr
)paren
id|Dprintk
c_func
(paren
l_string|&quot;overrun&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ISR_RXORN
op_amp
id|isr
)paren
id|Dprintk
c_func
(paren
l_string|&quot;overrun&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ISR_RXRCMP
op_amp
id|isr
)paren
op_logical_and
id|dev-&gt;rx_info.up
)paren
id|writel
c_func
(paren
id|CR_RXE
comma
id|dev-&gt;base
op_plus
id|CR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ISR_TXIDLE
op_amp
id|isr
)paren
(brace
id|u32
id|txdp
suffix:semicolon
id|txdp
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|TXDP
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;txdp: %08x&bslash;n&quot;
comma
id|txdp
)paren
suffix:semicolon
id|txdp
op_sub_assign
id|dev-&gt;tx_phy_descs
suffix:semicolon
id|dev-&gt;tx_idx
op_assign
id|txdp
op_div
(paren
id|DESC_SIZE
op_star
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tx_idx
op_ge
id|NR_TX_DESC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;%s: BUG -- txdp out of range&bslash;n&quot;
comma
id|dev-&gt;net_dev.name
)paren
suffix:semicolon
id|dev-&gt;tx_idx
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;tx_idx
op_ne
id|dev-&gt;tx_free_idx
)paren
id|writel
c_func
(paren
id|CR_TXE
comma
id|dev-&gt;base
op_plus
id|CR
)paren
suffix:semicolon
singleline_comment|//kick_tx(dev);
r_else
id|dev-&gt;tx_idle
op_assign
l_int|1
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;tx_idx
op_ne
id|dev-&gt;tx_free_idx
)paren
id|kick_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Defer tx ring processing until more than a minimum amount of&n;&t; * work has accumulated&n;&t; */
r_if
c_cond
(paren
(paren
id|ISR_TXDESC
op_or
id|ISR_TXIDLE
)paren
op_amp
id|isr
)paren
id|do_tx_done
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ISR_PHY
op_amp
id|isr
)paren
id|phy_intr
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#if 0&t;/* Still working on the interrupt mitigation strategy */
r_if
c_cond
(paren
id|dev-&gt;ihr
)paren
id|writel
c_func
(paren
id|dev-&gt;ihr
comma
id|dev-&gt;base
op_plus
id|IHR
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ns83820_do_reset
r_static
r_void
id|ns83820_do_reset
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
id|u32
id|which
)paren
(brace
id|Dprintk
c_func
(paren
l_string|&quot;resetting chip...&bslash;n&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
id|which
comma
id|dev-&gt;base
op_plus
id|CR
)paren
suffix:semicolon
r_do
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|CR
)paren
op_amp
id|which
)paren
suffix:semicolon
id|Dprintk
c_func
(paren
l_string|&quot;okay!&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ns83820_stop
r_static
r_int
id|ns83820_stop
c_func
(paren
r_struct
id|net_device
op_star
id|_dev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
(paren
r_struct
id|ns83820
op_star
)paren
id|_dev
suffix:semicolon
multiline_comment|/* FIXME: protect against interrupt handler? */
multiline_comment|/* disable interrupts */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|dev-&gt;rx_info.up
op_assign
l_int|0
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|ns83820_do_reset
c_func
(paren
id|dev
comma
id|CR_RST
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_and_assign
op_complement
(paren
id|ISR_TXURN
op_or
id|ISR_TXIDLE
op_or
id|ISR_TXERR
op_or
id|ISR_TXDESC
op_or
id|ISR_TXOK
)paren
suffix:semicolon
id|ns83820_cleanup_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ns83820_cleanup_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ns83820_open
r_static
r_int
id|ns83820_open
c_func
(paren
r_struct
id|net_device
op_star
id|_dev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
(paren
r_struct
id|ns83820
op_star
)paren
id|_dev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|desc
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;ns83820_open&bslash;n&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|PQCR
)paren
suffix:semicolon
id|ret
op_assign
id|ns83820_setup_rx
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|failed
suffix:semicolon
id|memset
c_func
(paren
id|dev-&gt;tx_descs
comma
l_int|0
comma
l_int|4
op_star
id|NR_TX_DESC
op_star
id|DESC_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_TX_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|hw_addr_t
op_star
)paren
(paren
id|dev-&gt;tx_descs
op_plus
(paren
id|i
op_star
id|DESC_SIZE
)paren
op_plus
id|LINK
)paren
op_assign
id|dev-&gt;tx_phy_descs
op_plus
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|NR_TX_DESC
)paren
op_star
id|DESC_SIZE
op_star
l_int|4
suffix:semicolon
)brace
id|dev-&gt;tx_idx
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tx_done_idx
op_assign
l_int|0
suffix:semicolon
id|desc
op_assign
id|dev-&gt;tx_phy_descs
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|TXDP_HI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|desc
comma
id|dev-&gt;base
op_plus
id|TXDP
)paren
suffix:semicolon
singleline_comment|//printk(&quot;IMR: %08x / %08x&bslash;n&quot;, readl(dev-&gt;base + IMR), dev-&gt;IMR_cache);
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
id|dev-&gt;tx_idle
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
multiline_comment|/* FIXME: wait for phy to come up */
r_return
l_int|0
suffix:semicolon
id|failed
suffix:colon
id|ns83820_stop
c_func
(paren
id|_dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#if 0&t;/* FIXME: implement this! */
r_static
r_void
id|ns83820_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|_dev
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
op_assign
(paren
r_struct
id|ns83820
op_star
)paren
id|_dev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ns83820_tx_timeout&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ns83820_getmac
r_static
r_void
id|ns83820_getmac
c_func
(paren
r_struct
id|ns83820
op_star
id|dev
comma
id|u8
op_star
id|mac
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|data
suffix:semicolon
macro_line|#if 0&t;/* I&squot;ve left this in as an example of how to use eeprom.h */
id|data
op_assign
id|eeprom_readw
c_func
(paren
op_amp
id|dev-&gt;ee
comma
l_int|0xa
op_plus
l_int|2
op_minus
id|i
)paren
suffix:semicolon
macro_line|#else
id|writel
c_func
(paren
id|i
op_star
l_int|2
comma
id|dev-&gt;base
op_plus
id|RFCR
)paren
suffix:semicolon
id|data
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|RFDR
)paren
suffix:semicolon
macro_line|#endif
op_star
id|mac
op_increment
op_assign
id|data
suffix:semicolon
op_star
id|mac
op_increment
op_assign
id|data
op_rshift
l_int|8
suffix:semicolon
)brace
)brace
DECL|function|ns83820_change_mtu
r_static
r_int
id|ns83820_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|_dev
comma
r_int
id|new_mtu
)paren
(brace
r_if
c_cond
(paren
id|new_mtu
OG
id|RX_BUF_SIZE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|_dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ns83820_probe
r_static
r_int
id|ns83820_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
suffix:semicolon
r_int
id|addr
suffix:semicolon
r_int
id|err
suffix:semicolon
id|dev
op_assign
(paren
r_struct
id|ns83820
op_star
)paren
id|alloc_etherdev
c_func
(paren
(paren
r_sizeof
op_star
id|dev
)paren
op_minus
(paren
r_sizeof
id|dev-&gt;net_dev
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|out
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;rx_info.lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;tx_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;misc_lock
)paren
suffix:semicolon
id|dev-&gt;pci_dev
op_assign
id|pci_dev
suffix:semicolon
id|dev-&gt;ee.cache
op_assign
op_amp
id|dev-&gt;MEAR_cache
suffix:semicolon
id|dev-&gt;ee.lock
op_assign
op_amp
id|dev-&gt;misc_lock
suffix:semicolon
id|dev-&gt;net_dev.owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|PREPARE_TQUEUE
c_func
(paren
op_amp
id|dev-&gt;tq_refill
comma
id|queue_refill
comma
id|dev
)paren
suffix:semicolon
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ns83820: pci_enable_dev: %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
id|addr
op_assign
id|pci_resource_start
c_func
(paren
id|pci_dev
comma
l_int|1
)paren
suffix:semicolon
id|dev-&gt;base
op_assign
id|ioremap_nocache
c_func
(paren
id|addr
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|dev-&gt;tx_descs
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_TX_DESC
comma
op_amp
id|dev-&gt;tx_phy_descs
)paren
suffix:semicolon
id|dev-&gt;rx_info.descs
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_RX_DESC
comma
op_amp
id|dev-&gt;rx_info.phy_descs
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;base
op_logical_or
op_logical_neg
id|dev-&gt;tx_descs
op_logical_or
op_logical_neg
id|dev-&gt;rx_info.descs
)paren
r_goto
id|out_disable
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%p: %08lx  %p: %08lx&bslash;n&quot;
comma
id|dev-&gt;tx_descs
comma
id|dev-&gt;tx_phy_descs
comma
id|dev-&gt;rx_info.descs
comma
id|dev-&gt;rx_info.phy_descs
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|dev-&gt;IMR_cache
op_assign
l_int|0
suffix:semicolon
id|setup_ee_mem_bitbanger
c_func
(paren
op_amp
id|dev-&gt;ee
comma
(paren
r_int
)paren
id|dev-&gt;base
op_plus
id|MEAR
comma
l_int|3
comma
l_int|2
comma
l_int|1
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|pci_dev-&gt;irq
comma
id|ns83820_irq
comma
id|SA_SHIRQ
comma
id|dev-&gt;net_dev.name
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ns83820: unable to register irq %d&bslash;n&quot;
comma
id|pci_dev-&gt;irq
)paren
suffix:semicolon
r_goto
id|out_unmap
suffix:semicolon
)brace
id|dev-&gt;net_dev.open
op_assign
id|ns83820_open
suffix:semicolon
id|dev-&gt;net_dev.stop
op_assign
id|ns83820_stop
suffix:semicolon
id|dev-&gt;net_dev.hard_start_xmit
op_assign
id|ns83820_hard_start_xmit
suffix:semicolon
id|dev-&gt;net_dev.change_mtu
op_assign
id|ns83820_change_mtu
suffix:semicolon
singleline_comment|//FIXME: dev-&gt;net_dev.tx_timeout = ns83820_tx_timeout;
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|dev-&gt;next_dev
op_assign
id|ns83820_chain
suffix:semicolon
id|ns83820_chain
op_assign
id|dev
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|ns83820_do_reset
c_func
(paren
id|dev
comma
id|CR_RST
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;start bist&bslash;n&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
id|PTSCR_EEBIST_EN
comma
id|dev-&gt;base
op_plus
id|PTSCR
)paren
suffix:semicolon
r_do
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|PTSCR
)paren
op_amp
id|PTSCR_EEBIST_EN
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;done bist&bslash;n&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;start eeload&bslash;n&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
id|PTSCR_EELOAD_EN
comma
id|dev-&gt;base
op_plus
id|PTSCR
)paren
suffix:semicolon
r_do
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|PTSCR
)paren
op_amp
id|PTSCR_EELOAD_EN
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;done eeload&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* I love config registers */
id|dev-&gt;CFG_cache
op_assign
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|CFG
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;CFG_cache
op_amp
id|CFG_PCI64_DET
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: enabling 64 bit PCI.&bslash;n&quot;
comma
id|dev-&gt;net_dev.name
)paren
suffix:semicolon
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_T64ADDR
op_or
id|CFG_DATA64_EN
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: disabling 64 bit PCI.&bslash;n&quot;
comma
id|dev-&gt;net_dev.name
)paren
suffix:semicolon
id|dev-&gt;CFG_cache
op_and_assign
op_complement
(paren
id|CFG_T64ADDR
op_or
id|CFG_DATA64_EN
)paren
suffix:semicolon
)brace
id|dev-&gt;CFG_cache
op_and_assign
(paren
id|CFG_TBI_EN
op_or
id|CFG_MRM_DIS
op_or
id|CFG_MWI_DIS
op_or
id|CFG_T64ADDR
op_or
id|CFG_DATA64_EN
op_or
id|CFG_EXT_125
op_or
id|CFG_M64ADDR
)paren
suffix:semicolon
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_PINT_DUPSTS
op_or
id|CFG_PINT_LNKSTS
op_or
id|CFG_PINT_SPDSTS
op_or
id|CFG_EXTSTS_EN
op_or
id|CFG_EXD
op_or
id|CFG_PESEL
suffix:semicolon
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_REQALG
suffix:semicolon
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_POW
suffix:semicolon
macro_line|#ifdef USE_64BIT_ADDR
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_M64ADDR
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;using 64 bit addressing&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef __LITTLE_ENDIAN
id|dev-&gt;CFG_cache
op_and_assign
op_complement
id|CFG_BEM
suffix:semicolon
macro_line|#elif defined(__BIG_ENDIAN)
id|dev-&gt;CFG_cache
op_or_assign
id|CFG_BEM
suffix:semicolon
macro_line|#else
macro_line|#error This driver only works for big or little endian!!!
macro_line|#endif
id|writel
c_func
(paren
id|dev-&gt;CFG_cache
comma
id|dev-&gt;base
op_plus
id|CFG
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;CFG: %08x&bslash;n&quot;
comma
id|dev-&gt;CFG_cache
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|SRR
)paren
)paren
id|writel
c_func
(paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
l_int|0x20c
)paren
op_or
l_int|0xfe00
comma
id|dev-&gt;base
op_plus
l_int|0x20c
)paren
suffix:semicolon
multiline_comment|/* Note!  The DMA burst size interacts with packet&n;&t; * transmission, such that the largest packet that&n;&t; * can be transmitted is 8192 - FLTH - burst size.&n;&t; * If only the transmit fifo was larger...&n;&t; */
id|writel
c_func
(paren
id|TXCFG_CSI
op_or
id|TXCFG_HBI
op_or
id|TXCFG_ATP
op_or
id|TXCFG_MXDMA1024
op_or
(paren
(paren
l_int|1600
op_div
l_int|32
)paren
op_star
l_int|0x100
)paren
comma
id|dev-&gt;base
op_plus
id|TXCFG
)paren
suffix:semicolon
multiline_comment|/* Flush the interrupt holdoff timer */
id|writel
c_func
(paren
l_int|0x000
comma
id|dev-&gt;base
op_plus
id|IHR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x100
comma
id|dev-&gt;base
op_plus
id|IHR
)paren
suffix:semicolon
multiline_comment|/* Set Rx to full duplex, don&squot;t accept runt, errored, long or length&n;&t; * range errored packets.  Set MXDMA to 7 =&gt; 512 word burst&n;&t; */
id|writel
c_func
(paren
id|RXCFG_AEP
op_or
id|RXCFG_ARP
op_or
id|RXCFG_AIRL
op_or
id|RXCFG_RX_FD
op_or
id|RXCFG_ALP
op_or
id|RXCFG_MXDMA
op_or
l_int|0
comma
id|dev-&gt;base
op_plus
id|RXCFG
)paren
suffix:semicolon
multiline_comment|/* Disable priority queueing */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|PQCR
)paren
suffix:semicolon
multiline_comment|/* Enable IP checksum validation and detetion of VLAN headers.&n;&t; * Note: do not set the reject options as at least the 0x102&n;&t; * revision of the chip does not properly accept IP fragments&n;&t; * at least for UDP.&n;&t; */
id|writel
c_func
(paren
id|VRCR_IPEN
op_or
id|VRCR_VTDEN
comma
id|dev-&gt;base
op_plus
id|VRCR
)paren
suffix:semicolon
multiline_comment|/* Enable per-packet TCP/UDP/IP checksumming */
id|writel
c_func
(paren
id|VTCR_PPCHK
comma
id|dev-&gt;base
op_plus
id|VTCR
)paren
suffix:semicolon
multiline_comment|/* Disable Pause frames */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|PCR
)paren
suffix:semicolon
multiline_comment|/* Disable Wake On Lan */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|WCSR
)paren
suffix:semicolon
id|ns83820_getmac
c_func
(paren
id|dev
comma
id|dev-&gt;net_dev.dev_addr
)paren
suffix:semicolon
multiline_comment|/* Yes, we support dumb IP checksum on transmit */
id|dev-&gt;net_dev.features
op_or_assign
id|NETIF_F_SG
suffix:semicolon
id|dev-&gt;net_dev.features
op_or_assign
id|NETIF_F_IP_CSUM
suffix:semicolon
macro_line|#if defined(USE_64BIT_ADDR) || defined(CONFIG_HIGHMEM4G)
id|dev-&gt;net_dev.features
op_or_assign
id|NETIF_F_HIGHDMA
suffix:semicolon
macro_line|#endif
id|register_netdev
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: ns83820.c v&quot;
id|VERSION
l_string|&quot;: DP83820 %02x:%02x:%02x:%02x:%02x:%02x pciaddr=0x%08lx irq=%d rev 0x%x&bslash;n&quot;
comma
id|dev-&gt;net_dev.name
comma
id|dev-&gt;net_dev.dev_addr
(braket
l_int|0
)braket
comma
id|dev-&gt;net_dev.dev_addr
(braket
l_int|1
)braket
comma
id|dev-&gt;net_dev.dev_addr
(braket
l_int|2
)braket
comma
id|dev-&gt;net_dev.dev_addr
(braket
l_int|3
)braket
comma
id|dev-&gt;net_dev.dev_addr
(braket
l_int|4
)braket
comma
id|dev-&gt;net_dev.dev_addr
(braket
l_int|5
)braket
comma
id|addr
comma
id|pci_dev-&gt;irq
comma
(paren
r_int
)paren
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|SRR
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_unmap
suffix:colon
id|iounmap
c_func
(paren
id|dev-&gt;base
)paren
suffix:semicolon
id|out_disable
suffix:colon
id|pci_free_consistent
c_func
(paren
id|pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_TX_DESC
comma
id|dev-&gt;tx_descs
comma
id|dev-&gt;tx_phy_descs
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_RX_DESC
comma
id|dev-&gt;rx_info.descs
comma
id|dev-&gt;rx_info.phy_descs
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
id|out_free
suffix:colon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|pci_device_id
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_int|0x100b
comma
l_int|0x0022
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|driver
r_static
r_struct
id|pci_driver
id|driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ns83820&quot;
comma
id|id_table
suffix:colon
id|pci_device_id
comma
id|probe
suffix:colon
id|ns83820_probe
comma
macro_line|#if 0&t;/* FIXME: implement */
id|remove
suffix:colon
comma
id|suspend
suffix:colon
comma
id|resume
suffix:colon
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|function|ns83820_init
r_static
r_int
id|__init
id|ns83820_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ns83820.c: National Semiconductor DP83820 10/100/100 driver.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|pci_module_init
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
DECL|function|ns83820_exit
r_static
r_void
id|ns83820_exit
c_func
(paren
r_void
)paren
(brace
r_struct
id|ns83820
op_star
id|dev
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|ns83820_chain
suffix:semicolon
id|dev
suffix:semicolon
)paren
(brace
r_struct
id|ns83820
op_star
id|next
op_assign
id|dev-&gt;next_dev
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IMR
)paren
suffix:semicolon
multiline_comment|/* paranoia */
id|writel
c_func
(paren
l_int|0
comma
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|readl
c_func
(paren
id|dev-&gt;base
op_plus
id|IER
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|dev-&gt;net_dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;pci_dev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|dev-&gt;base
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|dev-&gt;pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_TX_DESC
comma
id|dev-&gt;tx_descs
comma
id|dev-&gt;tx_phy_descs
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|dev-&gt;pci_dev
comma
l_int|4
op_star
id|DESC_SIZE
op_star
id|NR_RX_DESC
comma
id|dev-&gt;rx_info.descs
comma
id|dev-&gt;rx_info.phy_descs
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|dev-&gt;pci_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev
op_assign
id|next
suffix:semicolon
)brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
id|ns83820_chain
op_assign
l_int|NULL
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Benjamin LaHaise &lt;bcrl@redhat.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;National Semiconductor DP83820 10/100/1000 driver&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|pci_device_id
)paren
suffix:semicolon
DECL|variable|ns83820_init
id|module_init
c_func
(paren
id|ns83820_init
)paren
suffix:semicolon
DECL|variable|ns83820_exit
id|module_exit
c_func
(paren
id|ns83820_exit
)paren
suffix:semicolon
eof
