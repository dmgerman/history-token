multiline_comment|/*&n; * Fast Ethernet Controller (FEC) driver for Motorola MPC8xx.&n; *&n; * Copyright (c) 2003 Intracom S.A. &n; *  by Pantelis Antoniou &lt;panto@intracom.gr&gt;&n; *&n; * Heavily based on original FEC driver by Dan Malek &lt;dan@embeddededge.com&gt;&n; * and modifications by Joakim Tjernlund &lt;joakim.tjernlund@lumentis.se&gt;&n; *&n; * Released under the GPL&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/8xx_immap.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/mpc8xx.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/commproc.h&gt;
macro_line|#include &lt;asm/dma-mapping.h&gt;
macro_line|#include &quot;fec_8xx.h&quot;
multiline_comment|/*************************************************/
DECL|macro|FEC_MAX_MULTICAST_ADDRS
mdefine_line|#define FEC_MAX_MULTICAST_ADDRS&t;64
multiline_comment|/*************************************************/
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
id|DRV_MODULE_NAME
l_string|&quot;.c:v&quot;
id|DRV_MODULE_VERSION
l_string|&quot; (&quot;
id|DRV_MODULE_RELDATE
l_string|&quot;)&quot;
l_string|&quot;&bslash;n&quot;
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Pantelis Antoniou &lt;panto@intracom.gr&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Motorola 8xx FEC ethernet driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|fec_8xx_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|fec_8xx_debug
comma
l_string|&quot;FEC 8xx bitmapped debugging message enable value&quot;
)paren
suffix:semicolon
DECL|variable|fec_8xx_debug
r_int
id|fec_8xx_debug
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* -1 == use FEC_8XX_DEF_MSG_ENABLE as value */
multiline_comment|/*************************************************/
multiline_comment|/*&n; * Delay to wait for FEC reset command to complete (in us) &n; */
DECL|macro|FEC_RESET_DELAY
mdefine_line|#define FEC_RESET_DELAY&t;&t;50
multiline_comment|/*****************************************************************************************/
DECL|function|fec_whack_reset
r_static
r_void
id|fec_whack_reset
c_func
(paren
id|fec_t
op_star
id|fecp
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Whack a reset.  We should wait for this.  &n;&t; */
id|FW
c_func
(paren
id|fecp
comma
id|ecntrl
comma
id|FEC_ECNTRL_PINMUX
op_or
id|FEC_ECNTRL_RESET
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|FR
c_func
(paren
id|fecp
comma
id|ecntrl
)paren
op_amp
id|FEC_ECNTRL_RESET
)paren
op_ne
l_int|0
op_logical_and
id|i
OL
id|FEC_RESET_DELAY
suffix:semicolon
id|i
op_increment
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|FEC_RESET_DELAY
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;FEC Reset timeout!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************/
multiline_comment|/*&n; * Transmitter timeout.  &n; */
DECL|macro|TX_TIMEOUT
mdefine_line|#define TX_TIMEOUT (2*HZ)
multiline_comment|/****************************************************************************/
multiline_comment|/*&n; * Returns the CRC needed when filling in the hash table for&n; * multicast group filtering&n; * pAddr must point to a MAC address (6 bytes)&n; */
DECL|function|fec_mulicast_calc_crc
r_static
id|__u32
id|fec_mulicast_calc_crc
c_func
(paren
r_char
op_star
id|pAddr
)paren
(brace
id|u8
id|byte
suffix:semicolon
r_int
id|byte_count
suffix:semicolon
r_int
id|bit_count
suffix:semicolon
id|__u32
id|crc
op_assign
l_int|0xffffffff
suffix:semicolon
id|u8
id|msb
suffix:semicolon
r_for
c_loop
(paren
id|byte_count
op_assign
l_int|0
suffix:semicolon
id|byte_count
OL
l_int|6
suffix:semicolon
id|byte_count
op_increment
)paren
(brace
id|byte
op_assign
id|pAddr
(braket
id|byte_count
)braket
suffix:semicolon
r_for
c_loop
(paren
id|bit_count
op_assign
l_int|0
suffix:semicolon
id|bit_count
OL
l_int|8
suffix:semicolon
id|bit_count
op_increment
)paren
(brace
id|msb
op_assign
id|crc
op_rshift
l_int|31
suffix:semicolon
id|crc
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|msb
op_xor
(paren
id|byte
op_amp
l_int|0x1
)paren
)paren
(brace
id|crc
op_xor_assign
id|FEC_CRC_POLY
suffix:semicolon
)brace
id|byte
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
(paren
id|crc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set or clear the multicast filter for this adaptor.&n; * Skeleton taken from sunlance driver.&n; * The CPM Ethernet implementation allows Multicast as well as individual&n; * MAC address filtering.  Some of the drivers check to make sure it is&n; * a group multicast address, and discard those that are not.  I guess I&n; * will do the same for now, but just remove the test if you want&n; * individual filtering as well (do the upper net layers want or support&n; * this kind of feature?).&n; */
DECL|function|fec_set_multicast_list
r_static
r_void
id|fec_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_t
op_star
id|fecp
op_assign
id|fep-&gt;fecp
suffix:semicolon
r_struct
id|dev_mc_list
op_star
id|pmc
suffix:semicolon
id|__u32
id|crc
suffix:semicolon
r_int
id|temp
suffix:semicolon
id|__u32
id|csrVal
suffix:semicolon
r_int
id|hash_index
suffix:semicolon
id|__u32
id|hthi
comma
id|htlo
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_PROMISC
)paren
op_ne
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|FS
c_func
(paren
id|fecp
comma
id|r_cntrl
comma
id|FEC_RCNTRL_PROM
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Log any net taps. &n;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_MODULE_NAME
l_string|&quot;: %s: Promiscuous mode enabled.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_ALLMULTI
)paren
op_ne
l_int|0
op_logical_or
id|dev-&gt;mc_count
OG
id|FEC_MAX_MULTICAST_ADDRS
)paren
(brace
multiline_comment|/*&n;&t;&t; * Catch all multicast addresses, set the filter to all 1&squot;s.&n;&t;&t; */
id|hthi
op_assign
l_int|0xffffffffU
suffix:semicolon
id|htlo
op_assign
l_int|0xffffffffU
suffix:semicolon
)brace
r_else
(brace
id|hthi
op_assign
l_int|0
suffix:semicolon
id|htlo
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Now populate the hash table &n;&t;&t; */
r_for
c_loop
(paren
id|pmc
op_assign
id|dev-&gt;mc_list
suffix:semicolon
id|pmc
op_ne
l_int|NULL
suffix:semicolon
id|pmc
op_assign
id|pmc-&gt;next
)paren
(brace
id|crc
op_assign
id|fec_mulicast_calc_crc
c_func
(paren
id|pmc-&gt;dmi_addr
)paren
suffix:semicolon
id|temp
op_assign
(paren
id|crc
op_amp
l_int|0x3f
)paren
op_rshift
l_int|1
suffix:semicolon
id|hash_index
op_assign
(paren
(paren
id|temp
op_amp
l_int|0x01
)paren
op_lshift
l_int|4
)paren
op_or
(paren
(paren
id|temp
op_amp
l_int|0x02
)paren
op_lshift
l_int|2
)paren
op_or
(paren
(paren
id|temp
op_amp
l_int|0x04
)paren
)paren
op_or
(paren
(paren
id|temp
op_amp
l_int|0x08
)paren
op_rshift
l_int|2
)paren
op_or
(paren
(paren
id|temp
op_amp
l_int|0x10
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|csrVal
op_assign
(paren
l_int|1
op_lshift
id|hash_index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|crc
op_amp
l_int|1
)paren
id|hthi
op_or_assign
id|csrVal
suffix:semicolon
r_else
id|htlo
op_or_assign
id|csrVal
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|FC
c_func
(paren
id|fecp
comma
id|r_cntrl
comma
id|FEC_RCNTRL_PROM
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|hash_table_high
comma
id|hthi
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|hash_table_low
comma
id|htlo
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|fec_set_mac_address
r_static
r_int
id|fec_set_mac_address
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|addr
)paren
(brace
r_struct
id|sockaddr
op_star
id|mac
op_assign
id|addr
suffix:semicolon
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|fec
op_star
id|fecp
op_assign
id|fep-&gt;fecp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|__u32
id|addrhi
comma
id|addrlo
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Get pointer to SCC area in parameter RAM. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|mac-&gt;sa_data
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * Set station address. &n;&t; */
id|addrhi
op_assign
(paren
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
suffix:semicolon
id|addrlo
op_assign
(paren
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_lshift
l_int|16
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|addr_low
comma
id|addrhi
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|addr_high
comma
id|addrlo
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called to start or restart the FEC during a link&n; * change.  This only happens when switching between half and full&n; * duplex.&n; */
DECL|function|fec_restart
r_void
id|fec_restart
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|duplex
comma
r_int
id|speed
)paren
(brace
macro_line|#ifdef CONFIG_DUET
id|immap_t
op_star
id|immap
op_assign
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
suffix:semicolon
id|__u32
id|cptr
suffix:semicolon
macro_line|#endif
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|fec
op_star
id|fecp
op_assign
id|fep-&gt;fecp
suffix:semicolon
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
op_assign
id|fep-&gt;fpi
suffix:semicolon
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
id|__u32
id|addrhi
comma
id|addrlo
suffix:semicolon
id|fec_whack_reset
c_func
(paren
id|fep-&gt;fecp
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set station address. &n;&t; */
id|addrhi
op_assign
(paren
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|0
)braket
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|3
)braket
suffix:semicolon
id|addrlo
op_assign
(paren
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|4
)braket
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|__u32
)paren
id|dev-&gt;dev_addr
(braket
l_int|5
)braket
op_lshift
l_int|16
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|addr_low
comma
id|addrhi
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|addr_high
comma
id|addrlo
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Reset all multicast. &n;&t; */
id|FW
c_func
(paren
id|fecp
comma
id|hash_table_high
comma
l_int|0
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|hash_table_low
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set maximum receive buffer size. &n;&t; */
id|FW
c_func
(paren
id|fecp
comma
id|r_buff_size
comma
id|PKT_MAXBLR_SIZE
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|r_hash
comma
id|PKT_MAXBUF_SIZE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set receive and transmit descriptor base. &n;&t; */
id|FW
c_func
(paren
id|fecp
comma
id|r_des_start
comma
id|iopa
c_func
(paren
(paren
id|__u32
)paren
(paren
id|fep-&gt;rx_bd_base
)paren
)paren
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|x_des_start
comma
id|iopa
c_func
(paren
(paren
id|__u32
)paren
(paren
id|fep-&gt;tx_bd_base
)paren
)paren
)paren
suffix:semicolon
id|fep-&gt;dirty_tx
op_assign
id|fep-&gt;cur_tx
op_assign
id|fep-&gt;tx_bd_base
suffix:semicolon
id|fep-&gt;tx_free
op_assign
id|fep-&gt;tx_ring
suffix:semicolon
id|fep-&gt;cur_rx
op_assign
id|fep-&gt;rx_bd_base
suffix:semicolon
multiline_comment|/*&n;&t; * Reset SKB receive buffers &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fep-&gt;rx_ring
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|fep-&gt;rx_skbuff
(braket
id|i
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|fep-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Initialize the receive buffer descriptors. &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|bdp
op_assign
id|fep-&gt;rx_bd_base
suffix:semicolon
id|i
OL
id|fep-&gt;rx_ring
suffix:semicolon
id|i
op_increment
comma
id|bdp
op_increment
)paren
(brace
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|ENET_RX_FRSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_MODULE_NAME
l_string|&quot;: %s Memory squeeze, unable to allocate skb&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|fep-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|fep-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
id|skb
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|CBDW_BUFADDR
c_func
(paren
id|bdp
comma
id|dma_map_single
c_func
(paren
l_int|NULL
comma
id|skb-&gt;data
comma
id|L1_CACHE_ALIGN
c_func
(paren
id|PKT_MAXBUF_SIZE
)paren
comma
id|DMA_FROM_DEVICE
)paren
)paren
suffix:semicolon
id|CBDW_DATLEN
c_func
(paren
id|bdp
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* zero */
id|CBDW_SC
c_func
(paren
id|bdp
comma
id|BD_ENET_RX_EMPTY
op_or
(paren
(paren
id|i
OL
id|fep-&gt;rx_ring
op_minus
l_int|1
)paren
ques
c_cond
l_int|0
suffix:colon
id|BD_SC_WRAP
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * if we failed, fillup remainder &n;&t; */
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|fep-&gt;rx_ring
suffix:semicolon
id|i
op_increment
comma
id|bdp
op_increment
)paren
(brace
id|fep-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|CBDW_SC
c_func
(paren
id|bdp
comma
(paren
id|i
OL
id|fep-&gt;rx_ring
op_minus
l_int|1
)paren
ques
c_cond
l_int|0
suffix:colon
id|BD_SC_WRAP
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Reset SKB transmit buffers.  &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fep-&gt;tx_ring
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|fep-&gt;tx_skbuff
(braket
id|i
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|fep-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * ...and the same for transmit.  &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|bdp
op_assign
id|fep-&gt;tx_bd_base
suffix:semicolon
id|i
OL
id|fep-&gt;tx_ring
suffix:semicolon
id|i
op_increment
comma
id|bdp
op_increment
)paren
(brace
id|fep-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|CBDW_BUFADDR
c_func
(paren
id|bdp
comma
id|virt_to_bus
c_func
(paren
l_int|NULL
)paren
)paren
suffix:semicolon
id|CBDW_DATLEN
c_func
(paren
id|bdp
comma
l_int|0
)paren
suffix:semicolon
id|CBDW_SC
c_func
(paren
id|bdp
comma
(paren
id|i
OL
id|fep-&gt;tx_ring
op_minus
l_int|1
)paren
ques
c_cond
l_int|0
suffix:colon
id|BD_SC_WRAP
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Enable big endian and don&squot;t care about SDMA FC. &n;&t; */
id|FW
c_func
(paren
id|fecp
comma
id|fun_code
comma
l_int|0x78000000
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set MII speed. &n;&t; */
id|FW
c_func
(paren
id|fecp
comma
id|mii_speed
comma
id|fep-&gt;fec_phy_speed
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Clear any outstanding interrupt. &n;&t; */
id|FW
c_func
(paren
id|fecp
comma
id|ievent
comma
l_int|0xffc0
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|ivec
comma
(paren
id|fpi-&gt;fec_irq
op_div
l_int|2
)paren
op_lshift
l_int|29
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * adjust to speed (only for DUET &amp; RMII) &n;&t; */
macro_line|#ifdef CONFIG_DUET
id|cptr
op_assign
id|in_be32
c_func
(paren
op_amp
id|immap-&gt;im_cpm.cp_cptr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fpi-&gt;fec_no
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/*&n;&t;&t; * check if in RMII mode &n;&t;&t; */
r_if
c_cond
(paren
(paren
id|cptr
op_amp
l_int|0x100
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_eq
l_int|10
)paren
id|cptr
op_or_assign
l_int|0x0000010
suffix:semicolon
r_else
r_if
c_cond
(paren
id|speed
op_eq
l_int|100
)paren
id|cptr
op_and_assign
op_complement
l_int|0x0000010
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/*&n;&t;&t; * check if in RMII mode &n;&t;&t; */
r_if
c_cond
(paren
(paren
id|cptr
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|speed
op_eq
l_int|10
)paren
id|cptr
op_or_assign
l_int|0x0000008
suffix:semicolon
r_else
r_if
c_cond
(paren
id|speed
op_eq
l_int|100
)paren
id|cptr
op_and_assign
op_complement
l_int|0x0000008
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|out_be32
c_func
(paren
op_amp
id|immap-&gt;im_cpm.cp_cptr
comma
id|cptr
)paren
suffix:semicolon
macro_line|#endif
id|FW
c_func
(paren
id|fecp
comma
id|r_cntrl
comma
id|FEC_RCNTRL_MII_MODE
)paren
suffix:semicolon
multiline_comment|/* MII enable */
multiline_comment|/*&n;&t; * adjust to duplex mode &n;&t; */
r_if
c_cond
(paren
id|duplex
)paren
(brace
id|FC
c_func
(paren
id|fecp
comma
id|r_cntrl
comma
id|FEC_RCNTRL_DRT
)paren
suffix:semicolon
id|FS
c_func
(paren
id|fecp
comma
id|x_cntrl
comma
id|FEC_TCNTRL_FDEN
)paren
suffix:semicolon
multiline_comment|/* FD enable */
)brace
r_else
(brace
id|FS
c_func
(paren
id|fecp
comma
id|r_cntrl
comma
id|FEC_RCNTRL_DRT
)paren
suffix:semicolon
id|FC
c_func
(paren
id|fecp
comma
id|x_cntrl
comma
id|FEC_TCNTRL_FDEN
)paren
suffix:semicolon
multiline_comment|/* FD disable */
)brace
multiline_comment|/*&n;&t; * Enable interrupts we wish to service. &n;&t; */
id|FW
c_func
(paren
id|fecp
comma
id|imask
comma
id|FEC_ENET_TXF
op_or
id|FEC_ENET_TXB
op_or
id|FEC_ENET_RXF
op_or
id|FEC_ENET_RXB
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * And last, enable the transmit and receive processing. &n;&t; */
id|FW
c_func
(paren
id|fecp
comma
id|ecntrl
comma
id|FEC_ECNTRL_PINMUX
op_or
id|FEC_ECNTRL_ETHER_EN
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|r_des_active
comma
l_int|0x01000000
)paren
suffix:semicolon
)brace
DECL|function|fec_stop
r_void
id|fec_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_t
op_star
id|fecp
op_assign
id|fep-&gt;fecp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|FR
c_func
(paren
id|fecp
comma
id|ecntrl
)paren
op_amp
id|FEC_ECNTRL_ETHER_EN
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* already down */
id|FW
c_func
(paren
id|fecp
comma
id|x_cntrl
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Graceful transmit stop */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|FR
c_func
(paren
id|fecp
comma
id|ievent
)paren
op_amp
l_int|0x10000000
)paren
op_eq
l_int|0
)paren
op_logical_and
id|i
OL
id|FEC_RESET_DELAY
suffix:semicolon
id|i
op_increment
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|FEC_RESET_DELAY
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_MODULE_NAME
l_string|&quot;: %s FEC timeout on graceful transmit stop&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Disable FEC. Let only MII interrupts. &n;&t; */
id|FW
c_func
(paren
id|fecp
comma
id|imask
comma
l_int|0
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|ecntrl
comma
op_complement
id|FEC_ECNTRL_ETHER_EN
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Reset SKB transmit buffers.  &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fep-&gt;tx_ring
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|fep-&gt;tx_skbuff
(braket
id|i
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|fep-&gt;tx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Reset SKB receive buffers &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fep-&gt;rx_ring
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|fep-&gt;rx_skbuff
(braket
id|i
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|fep-&gt;rx_skbuff
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* common receive function */
DECL|function|fec_enet_rx_common
r_static
r_int
id|fec_enet_rx_common
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
op_star
id|budget
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_t
op_star
id|fecp
op_assign
id|fep-&gt;fecp
suffix:semicolon
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
op_assign
id|fep-&gt;fpi
suffix:semicolon
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|skbn
comma
op_star
id|skbt
suffix:semicolon
r_int
id|received
op_assign
l_int|0
suffix:semicolon
id|__u16
id|pkt_len
comma
id|sc
suffix:semicolon
r_int
id|curidx
suffix:semicolon
r_int
id|rx_work_limit
suffix:semicolon
r_if
c_cond
(paren
id|fpi-&gt;use_napi
)paren
(brace
id|rx_work_limit
op_assign
id|min
c_func
(paren
id|dev-&gt;quota
comma
op_star
id|budget
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * First, grab all of the stats for the incoming packet.&n;&t; * These get messed up if we get called due to a busy condition.&n;&t; */
id|bdp
op_assign
id|fep-&gt;cur_rx
suffix:semicolon
multiline_comment|/* clear RX status bits for napi*/
r_if
c_cond
(paren
id|fpi-&gt;use_napi
)paren
id|FW
c_func
(paren
id|fecp
comma
id|ievent
comma
id|FEC_ENET_RXF
op_or
id|FEC_ENET_RXB
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|sc
op_assign
id|CBDR_SC
c_func
(paren
id|bdp
)paren
)paren
op_amp
id|BD_ENET_RX_EMPTY
)paren
op_eq
l_int|0
)paren
(brace
id|curidx
op_assign
id|bdp
op_minus
id|fep-&gt;rx_bd_base
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Since we have allocated space to hold a complete frame,&n;&t;&t; * the last indicator should be set.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|sc
op_amp
id|BD_ENET_RX_LAST
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_MODULE_NAME
l_string|&quot;: %s rcv is not +last&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Check for errors. &n;&t;&t; */
r_if
c_cond
(paren
id|sc
op_amp
(paren
id|BD_ENET_RX_LG
op_or
id|BD_ENET_RX_SH
op_or
id|BD_ENET_RX_CL
op_or
id|BD_ENET_RX_NO
op_or
id|BD_ENET_RX_CR
op_or
id|BD_ENET_RX_OV
)paren
)paren
(brace
id|fep-&gt;stats.rx_errors
op_increment
suffix:semicolon
multiline_comment|/* Frame too long or too short. */
r_if
c_cond
(paren
id|sc
op_amp
(paren
id|BD_ENET_RX_LG
op_or
id|BD_ENET_RX_SH
)paren
)paren
id|fep-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
multiline_comment|/* Frame alignment */
r_if
c_cond
(paren
id|sc
op_amp
(paren
id|BD_ENET_RX_NO
op_or
id|BD_ENET_RX_CL
)paren
)paren
id|fep-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
multiline_comment|/* CRC Error */
r_if
c_cond
(paren
id|sc
op_amp
id|BD_ENET_RX_CR
)paren
id|fep-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
multiline_comment|/* FIFO overrun */
r_if
c_cond
(paren
id|sc
op_amp
id|BD_ENET_RX_OV
)paren
id|fep-&gt;stats.rx_crc_errors
op_increment
suffix:semicolon
id|skbn
op_assign
id|fep-&gt;rx_skbuff
(braket
id|curidx
)braket
suffix:semicolon
id|BUG_ON
c_func
(paren
id|skbn
op_eq
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* napi, got packet but no quota */
r_if
c_cond
(paren
id|fpi-&gt;use_napi
op_logical_and
op_decrement
id|rx_work_limit
OL
l_int|0
)paren
r_break
suffix:semicolon
id|skb
op_assign
id|fep-&gt;rx_skbuff
(braket
id|curidx
)braket
suffix:semicolon
id|BUG_ON
c_func
(paren
id|skb
op_eq
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Process the incoming frame.&n;&t;&t;&t; */
id|fep-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|pkt_len
op_assign
id|CBDR_DATLEN
c_func
(paren
id|bdp
)paren
op_minus
l_int|4
suffix:semicolon
multiline_comment|/* remove CRC */
id|fep-&gt;stats.rx_bytes
op_add_assign
id|pkt_len
op_plus
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|pkt_len
op_le
id|fpi-&gt;rx_copybreak
)paren
(brace
multiline_comment|/* +2 to make IP header L1 cache aligned */
id|skbn
op_assign
id|dev_alloc_skb
c_func
(paren
id|pkt_len
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skbn
op_ne
l_int|NULL
)paren
(brace
id|skb_reserve
c_func
(paren
id|skbn
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* align IP header */
id|memcpy
c_func
(paren
id|skbn-&gt;data
comma
id|skb-&gt;data
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* swap */
id|skbt
op_assign
id|skb
suffix:semicolon
id|skb
op_assign
id|skbn
suffix:semicolon
id|skbn
op_assign
id|skbt
suffix:semicolon
)brace
)brace
r_else
id|skbn
op_assign
id|dev_alloc_skb
c_func
(paren
id|ENET_RX_FRSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skbn
op_ne
l_int|NULL
)paren
(brace
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* Make room */
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|received
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fpi-&gt;use_napi
)paren
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_else
id|netif_receive_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_MODULE_NAME
l_string|&quot;: %s Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|fep-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|skbn
op_assign
id|skb
suffix:semicolon
)brace
)brace
id|fep-&gt;rx_skbuff
(braket
id|curidx
)braket
op_assign
id|skbn
suffix:semicolon
id|CBDW_BUFADDR
c_func
(paren
id|bdp
comma
id|dma_map_single
c_func
(paren
l_int|NULL
comma
id|skbn-&gt;data
comma
id|L1_CACHE_ALIGN
c_func
(paren
id|PKT_MAXBUF_SIZE
)paren
comma
id|DMA_FROM_DEVICE
)paren
)paren
suffix:semicolon
id|CBDW_DATLEN
c_func
(paren
id|bdp
comma
l_int|0
)paren
suffix:semicolon
id|CBDW_SC
c_func
(paren
id|bdp
comma
(paren
id|sc
op_amp
op_complement
id|BD_ENET_RX_STATS
)paren
op_or
id|BD_ENET_RX_EMPTY
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Update BD pointer to next entry. &n;&t;&t; */
r_if
c_cond
(paren
(paren
id|sc
op_amp
id|BD_ENET_RX_WRAP
)paren
op_eq
l_int|0
)paren
id|bdp
op_increment
suffix:semicolon
r_else
id|bdp
op_assign
id|fep-&gt;rx_bd_base
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Doing this here will keep the FEC running while we process&n;&t;&t; * incoming frames.  On a heavily loaded network, we should be&n;&t;&t; * able to keep up at the expense of system resources.&n;&t;&t; */
id|FW
c_func
(paren
id|fecp
comma
id|r_des_active
comma
l_int|0x01000000
)paren
suffix:semicolon
)brace
id|fep-&gt;cur_rx
op_assign
id|bdp
suffix:semicolon
r_if
c_cond
(paren
id|fpi-&gt;use_napi
)paren
(brace
id|dev-&gt;quota
op_sub_assign
id|received
suffix:semicolon
op_star
id|budget
op_sub_assign
id|received
suffix:semicolon
r_if
c_cond
(paren
id|rx_work_limit
OL
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* not done */
multiline_comment|/* done */
id|netif_rx_complete
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* enable RX interrupt bits */
id|FS
c_func
(paren
id|fecp
comma
id|imask
comma
id|FEC_ENET_RXF
op_or
id|FEC_ENET_RXB
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fec_enet_tx
r_static
r_void
id|fec_enet_tx
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|dirtyidx
comma
id|do_wake
suffix:semicolon
id|__u16
id|sc
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|bdp
op_assign
id|fep-&gt;dirty_tx
suffix:semicolon
id|do_wake
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|sc
op_assign
id|CBDR_SC
c_func
(paren
id|bdp
)paren
)paren
op_amp
id|BD_ENET_TX_READY
)paren
op_eq
l_int|0
)paren
(brace
id|dirtyidx
op_assign
id|bdp
op_minus
id|fep-&gt;tx_bd_base
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;tx_free
op_eq
id|fep-&gt;tx_ring
)paren
r_break
suffix:semicolon
id|skb
op_assign
id|fep-&gt;tx_skbuff
(braket
id|dirtyidx
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Check for errors. &n;&t;&t; */
r_if
c_cond
(paren
id|sc
op_amp
(paren
id|BD_ENET_TX_HB
op_or
id|BD_ENET_TX_LC
op_or
id|BD_ENET_TX_RL
op_or
id|BD_ENET_TX_UN
op_or
id|BD_ENET_TX_CSL
)paren
)paren
(brace
id|fep-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sc
op_amp
id|BD_ENET_TX_HB
)paren
multiline_comment|/* No heartbeat */
id|fep-&gt;stats.tx_heartbeat_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sc
op_amp
id|BD_ENET_TX_LC
)paren
multiline_comment|/* Late collision */
id|fep-&gt;stats.tx_window_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sc
op_amp
id|BD_ENET_TX_RL
)paren
multiline_comment|/* Retrans limit */
id|fep-&gt;stats.tx_aborted_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sc
op_amp
id|BD_ENET_TX_UN
)paren
multiline_comment|/* Underrun */
id|fep-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sc
op_amp
id|BD_ENET_TX_CSL
)paren
multiline_comment|/* Carrier lost */
id|fep-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_else
id|fep-&gt;stats.tx_packets
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sc
op_amp
id|BD_ENET_TX_READY
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_MODULE_NAME
l_string|&quot;: %s HEY! Enet xmit interrupt and TX_READY.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Deferred means some collisions occurred during transmit,&n;&t;&t; * but we eventually sent the packet OK.&n;&t;&t; */
r_if
c_cond
(paren
id|sc
op_amp
id|BD_ENET_TX_DEF
)paren
id|fep-&gt;stats.collisions
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Free the sk buffer associated with this last transmit. &n;&t;&t; */
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|fep-&gt;tx_skbuff
(braket
id|dirtyidx
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Update pointer to next buffer descriptor to be transmitted. &n;&t;&t; */
r_if
c_cond
(paren
(paren
id|sc
op_amp
id|BD_ENET_TX_WRAP
)paren
op_eq
l_int|0
)paren
id|bdp
op_increment
suffix:semicolon
r_else
id|bdp
op_assign
id|fep-&gt;tx_bd_base
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Since we have freed up a buffer, the ring is no longer&n;&t;&t; * full.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|fep-&gt;tx_free
op_increment
)paren
id|do_wake
op_assign
l_int|1
suffix:semicolon
)brace
id|fep-&gt;dirty_tx
op_assign
id|bdp
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_wake
op_logical_and
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The interrupt handler.&n; * This is called from the MPC core interrupt.&n; */
r_static
id|irqreturn_t
DECL|function|fec_enet_interrupt
id|fec_enet_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
suffix:semicolon
id|fec_t
op_star
id|fecp
suffix:semicolon
id|__u32
id|int_events
suffix:semicolon
id|__u32
id|int_events_napi
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|dev
op_eq
l_int|NULL
)paren
)paren
r_return
id|IRQ_NONE
suffix:semicolon
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fecp
op_assign
id|fep-&gt;fecp
suffix:semicolon
id|fpi
op_assign
id|fep-&gt;fpi
suffix:semicolon
multiline_comment|/*&n;&t; * Get the interrupt events that caused us to be here.&n;&t; */
r_while
c_loop
(paren
(paren
id|int_events
op_assign
id|FR
c_func
(paren
id|fecp
comma
id|ievent
)paren
op_amp
id|FR
c_func
(paren
id|fecp
comma
id|imask
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fpi-&gt;use_napi
)paren
id|FW
c_func
(paren
id|fecp
comma
id|ievent
comma
id|int_events
)paren
suffix:semicolon
r_else
(brace
id|int_events_napi
op_assign
id|int_events
op_amp
op_complement
(paren
id|FEC_ENET_RXF
op_or
id|FEC_ENET_RXB
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|ievent
comma
id|int_events_napi
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|int_events
op_amp
(paren
id|FEC_ENET_HBERR
op_or
id|FEC_ENET_BABR
op_or
id|FEC_ENET_BABT
op_or
id|FEC_ENET_EBERR
)paren
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_MODULE_NAME
l_string|&quot;: %s FEC ERROR(s) 0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|int_events
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|int_events
op_amp
id|FEC_ENET_RXF
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fpi-&gt;use_napi
)paren
id|fec_enet_rx_common
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|netif_rx_schedule_prep
c_func
(paren
id|dev
)paren
)paren
(brace
multiline_comment|/* disable rx interrupts */
id|FC
c_func
(paren
id|fecp
comma
id|imask
comma
id|FEC_ENET_RXF
op_or
id|FEC_ENET_RXB
)paren
suffix:semicolon
id|__netif_rx_schedule
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_MODULE_NAME
l_string|&quot;: %s driver bug! interrupt while in poll!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|FC
c_func
(paren
id|fecp
comma
id|imask
comma
id|FEC_ENET_RXF
op_or
id|FEC_ENET_RXB
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
(paren
id|int_events
op_amp
id|FEC_ENET_TXF
)paren
op_ne
l_int|0
)paren
id|fec_enet_tx
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* This interrupt occurs when the PHY detects a link change. */
r_static
id|irqreturn_t
DECL|function|fec_mii_link_interrupt
id|fec_mii_link_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|dev_id
suffix:semicolon
r_struct
id|fec_enet_private
op_star
id|fep
suffix:semicolon
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|dev
op_eq
l_int|NULL
)paren
)paren
r_return
id|IRQ_NONE
suffix:semicolon
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fpi
op_assign
id|fep-&gt;fpi
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fpi-&gt;use_mdio
)paren
r_return
id|IRQ_NONE
suffix:semicolon
multiline_comment|/*&n;&t; * Acknowledge the interrupt if possible. If we have not&n;&t; * found the PHY yet we can&squot;t process or acknowledge the&n;&t; * interrupt now. Instead we ignore this interrupt for now,&n;&t; * which we can do since it is edge triggered. It will be&n;&t; * acknowledged later by fec_enet_open().&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|fep-&gt;phy
)paren
r_return
id|IRQ_NONE
suffix:semicolon
id|fec_mii_ack_int
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_mii_link_status_change_check
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/**********************************************************************************/
DECL|function|fec_enet_start_xmit
r_static
r_int
id|fec_enet_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_t
op_star
id|fecp
op_assign
id|fep-&gt;fecp
suffix:semicolon
id|cbd_t
op_star
id|bdp
suffix:semicolon
r_int
id|curidx
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Fill in a Tx ring entry &n;&t; */
id|bdp
op_assign
id|fep-&gt;cur_tx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fep-&gt;tx_free
op_logical_or
(paren
id|CBDR_SC
c_func
(paren
id|bdp
)paren
op_amp
id|BD_ENET_TX_READY
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Ooops.  All transmit buffers are full.  Bail out.&n;&t;&t; * This should not happen, since the tx queue should be stopped.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_MODULE_NAME
l_string|&quot;: %s tx queue full!.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|curidx
op_assign
id|bdp
op_minus
id|fep-&gt;tx_bd_base
suffix:semicolon
multiline_comment|/*&n;&t; * Clear all of the status flags. &n;&t; */
id|CBDC_SC
c_func
(paren
id|bdp
comma
id|BD_ENET_TX_STATS
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Save skb pointer. &n;&t; */
id|fep-&gt;tx_skbuff
(braket
id|curidx
)braket
op_assign
id|skb
suffix:semicolon
id|fep-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/*&n;&t; * Push the data cache so the CPM does not get stale memory data. &n;&t; */
id|CBDW_BUFADDR
c_func
(paren
id|bdp
comma
id|dma_map_single
c_func
(paren
l_int|NULL
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|DMA_TO_DEVICE
)paren
)paren
suffix:semicolon
id|CBDW_DATLEN
c_func
(paren
id|bdp
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/*&n;&t; * If this was the last BD in the ring, start at the beginning again. &n;&t; */
r_if
c_cond
(paren
(paren
id|CBDR_SC
c_func
(paren
id|bdp
)paren
op_amp
id|BD_ENET_TX_WRAP
)paren
op_eq
l_int|0
)paren
id|fep-&gt;cur_tx
op_increment
suffix:semicolon
r_else
id|fep-&gt;cur_tx
op_assign
id|fep-&gt;tx_bd_base
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|fep-&gt;tx_free
)paren
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Trigger transmission start &n;&t; */
id|CBDS_SC
c_func
(paren
id|bdp
comma
id|BD_ENET_TX_READY
op_or
id|BD_ENET_TX_INTR
op_or
id|BD_ENET_TX_LAST
op_or
id|BD_ENET_TX_TC
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|x_des_active
comma
l_int|0x01000000
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;tx_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fec_timeout
r_static
r_void
id|fec_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fep-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;tx_free
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* check link status again */
id|fec_mii_link_status_change_check
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|fec_enet_open
r_static
r_int
id|fec_enet_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
op_assign
id|fep-&gt;fpi
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Install our interrupt handler. */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|fpi-&gt;fec_irq
comma
id|fec_enet_interrupt
comma
l_int|0
comma
l_string|&quot;fec&quot;
comma
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_MODULE_NAME
l_string|&quot;: %s Could not allocate FEC IRQ!&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Install our phy interrupt handler */
r_if
c_cond
(paren
id|fpi-&gt;phy_irq
op_ne
op_minus
l_int|1
op_logical_and
id|request_irq
c_func
(paren
id|fpi-&gt;phy_irq
comma
id|fec_mii_link_interrupt
comma
l_int|0
comma
l_string|&quot;fec-phy&quot;
comma
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_MODULE_NAME
l_string|&quot;: %s Could not allocate PHY IRQ!&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|fpi-&gt;fec_irq
comma
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fpi-&gt;use_mdio
)paren
(brace
id|fec_mii_startup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_mii_link_status_change_check
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|fec_restart
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|100
)paren
suffix:semicolon
multiline_comment|/* XXX this sucks */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_carrier_on
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fec_enet_close
r_static
r_int
id|fec_enet_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
op_assign
id|fep-&gt;fpi
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fpi-&gt;use_mdio
)paren
id|fec_mii_shutdown
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|fec_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* release any irqs */
r_if
c_cond
(paren
id|fpi-&gt;phy_irq
op_ne
op_minus
l_int|1
)paren
id|free_irq
c_func
(paren
id|fpi-&gt;phy_irq
comma
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|fpi-&gt;fec_irq
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fec_enet_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|fec_enet_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_amp
id|fep-&gt;stats
suffix:semicolon
)brace
DECL|function|fec_enet_poll
r_static
r_int
id|fec_enet_poll
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
op_star
id|budget
)paren
(brace
r_return
id|fec_enet_rx_common
c_func
(paren
id|dev
comma
id|budget
)paren
suffix:semicolon
)brace
multiline_comment|/*************************************************************************/
DECL|function|fec_get_drvinfo
r_static
r_void
id|fec_get_drvinfo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_drvinfo
op_star
id|info
)paren
(brace
id|strcpy
c_func
(paren
id|info-&gt;driver
comma
id|DRV_MODULE_NAME
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;version
comma
id|DRV_MODULE_VERSION
)paren
suffix:semicolon
)brace
DECL|function|fec_get_regs_len
r_static
r_int
id|fec_get_regs_len
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
r_sizeof
(paren
id|fec_t
)paren
suffix:semicolon
)brace
DECL|function|fec_get_regs
r_static
r_void
id|fec_get_regs
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_regs
op_star
id|regs
comma
r_void
op_star
id|p
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|regs-&gt;len
OL
r_sizeof
(paren
id|fec_t
)paren
)paren
r_return
suffix:semicolon
id|regs-&gt;version
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|memcpy_fromio
c_func
(paren
id|p
comma
id|fep-&gt;fecp
comma
r_sizeof
(paren
id|fec_t
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|fec_get_settings
r_static
r_int
id|fec_get_settings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|mii_ethtool_gset
c_func
(paren
op_amp
id|fep-&gt;mii_if
comma
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|fec_set_settings
r_static
r_int
id|fec_set_settings
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|mii_ethtool_sset
c_func
(paren
op_amp
id|fep-&gt;mii_if
comma
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|fec_nway_reset
r_static
r_int
id|fec_nway_reset
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|mii_nway_restart
c_func
(paren
op_amp
id|fep-&gt;mii_if
)paren
suffix:semicolon
)brace
DECL|function|fec_get_msglevel
r_static
id|__u32
id|fec_get_msglevel
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|fep-&gt;msg_enable
suffix:semicolon
)brace
DECL|function|fec_set_msglevel
r_static
r_void
id|fec_set_msglevel
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|__u32
id|value
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fep-&gt;msg_enable
op_assign
id|value
suffix:semicolon
)brace
DECL|variable|fec_ethtool_ops
r_static
r_struct
id|ethtool_ops
id|fec_ethtool_ops
op_assign
(brace
dot
id|get_drvinfo
op_assign
id|fec_get_drvinfo
comma
dot
id|get_regs_len
op_assign
id|fec_get_regs_len
comma
dot
id|get_settings
op_assign
id|fec_get_settings
comma
dot
id|set_settings
op_assign
id|fec_set_settings
comma
dot
id|nway_reset
op_assign
id|fec_nway_reset
comma
dot
id|get_link
op_assign
id|ethtool_op_get_link
comma
dot
id|get_msglevel
op_assign
id|fec_get_msglevel
comma
dot
id|set_msglevel
op_assign
id|fec_set_msglevel
comma
dot
id|get_tx_csum
op_assign
id|ethtool_op_get_tx_csum
comma
dot
id|set_tx_csum
op_assign
id|ethtool_op_set_tx_csum
comma
multiline_comment|/* local! */
dot
id|get_sg
op_assign
id|ethtool_op_get_sg
comma
dot
id|set_sg
op_assign
id|ethtool_op_set_sg
comma
dot
id|get_regs
op_assign
id|fec_get_regs
comma
)brace
suffix:semicolon
DECL|function|fec_ioctl
r_static
r_int
id|fec_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|rq
comma
r_int
id|cmd
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|mii_ioctl_data
op_star
id|mii
op_assign
(paren
r_struct
id|mii_ioctl_data
op_star
)paren
op_amp
id|rq-&gt;ifr_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|generic_mii_ioctl
c_func
(paren
op_amp
id|fep-&gt;mii_if
comma
id|mii
comma
id|cmd
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|fec_8xx_init_one
r_int
id|fec_8xx_init_one
c_func
(paren
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
comma
r_struct
id|net_device
op_star
op_star
id|devp
)paren
(brace
id|immap_t
op_star
id|immap
op_assign
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
suffix:semicolon
r_static
r_int
id|fec_8xx_version_printed
op_assign
l_int|0
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
l_int|NULL
suffix:semicolon
id|fec_t
op_star
id|fecp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|registered
op_assign
l_int|0
suffix:semicolon
id|__u32
id|siel
suffix:semicolon
op_star
id|devp
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|fpi-&gt;fec_no
)paren
(brace
r_case
l_int|0
suffix:colon
id|fecp
op_assign
op_amp
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_cpm.cp_fec
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_DUET
r_case
l_int|1
suffix:colon
id|fecp
op_assign
op_amp
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_cpm.cp_fec2
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fec_8xx_version_printed
op_increment
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
id|i
op_assign
r_sizeof
(paren
op_star
id|fep
)paren
op_plus
(paren
r_sizeof
(paren
r_struct
id|sk_buff
op_star
op_star
)paren
op_star
(paren
id|fpi-&gt;rx_ring
op_plus
id|fpi-&gt;tx_ring
)paren
)paren
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* partial reset of FEC */
id|fec_whack_reset
c_func
(paren
id|fecp
)paren
suffix:semicolon
multiline_comment|/* point rx_skbuff, tx_skbuff */
id|fep-&gt;rx_skbuff
op_assign
(paren
r_struct
id|sk_buff
op_star
op_star
)paren
op_amp
id|fep
(braket
l_int|1
)braket
suffix:semicolon
id|fep-&gt;tx_skbuff
op_assign
id|fep-&gt;rx_skbuff
op_plus
id|fpi-&gt;rx_ring
suffix:semicolon
id|fep-&gt;fecp
op_assign
id|fecp
suffix:semicolon
id|fep-&gt;fpi
op_assign
id|fpi
suffix:semicolon
multiline_comment|/* init locks */
id|spin_lock_init
c_func
(paren
op_amp
id|fep-&gt;lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|fep-&gt;tx_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the Ethernet address. &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|dev-&gt;dev_addr
(braket
id|i
)braket
op_assign
id|fpi-&gt;macaddr
(braket
id|i
)braket
suffix:semicolon
id|fep-&gt;ring_base
op_assign
id|dma_alloc_coherent
c_func
(paren
l_int|NULL
comma
(paren
id|fpi-&gt;tx_ring
op_plus
id|fpi-&gt;rx_ring
)paren
op_star
r_sizeof
(paren
id|cbd_t
)paren
comma
op_amp
id|fep-&gt;ring_mem_addr
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;ring_base
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_MODULE_NAME
l_string|&quot;: %s dma alloc failed.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set receive and transmit descriptor base.&n;&t; */
id|fep-&gt;rx_bd_base
op_assign
id|fep-&gt;ring_base
suffix:semicolon
id|fep-&gt;tx_bd_base
op_assign
id|fep-&gt;rx_bd_base
op_plus
id|fpi-&gt;rx_ring
suffix:semicolon
multiline_comment|/* initialize ring size variables */
id|fep-&gt;tx_ring
op_assign
id|fpi-&gt;tx_ring
suffix:semicolon
id|fep-&gt;rx_ring
op_assign
id|fpi-&gt;rx_ring
suffix:semicolon
multiline_comment|/* SIU interrupt */
r_if
c_cond
(paren
id|fpi-&gt;phy_irq
op_ne
op_minus
l_int|1
op_logical_and
(paren
id|fpi-&gt;phy_irq
op_ge
id|SIU_IRQ0
op_logical_and
id|fpi-&gt;phy_irq
OL
id|SIU_LEVEL7
)paren
)paren
(brace
id|siel
op_assign
id|in_be32
c_func
(paren
op_amp
id|immap-&gt;im_siu_conf.sc_siel
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fpi-&gt;phy_irq
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
id|siel
op_or_assign
(paren
l_int|0x80000000
op_rshift
id|fpi-&gt;phy_irq
)paren
suffix:semicolon
r_else
id|siel
op_and_assign
op_complement
(paren
l_int|0x80000000
op_rshift
(paren
id|fpi-&gt;phy_irq
op_amp
op_complement
l_int|1
)paren
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|immap-&gt;im_siu_conf.sc_siel
comma
id|siel
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The FEC Ethernet specific entries in the device structure. &n;&t; */
id|dev-&gt;open
op_assign
id|fec_enet_open
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|fec_enet_start_xmit
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|fec_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|TX_TIMEOUT
suffix:semicolon
id|dev-&gt;stop
op_assign
id|fec_enet_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|fec_enet_get_stats
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|fec_set_multicast_list
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|fec_set_mac_address
suffix:semicolon
r_if
c_cond
(paren
id|fpi-&gt;use_napi
)paren
(brace
id|dev-&gt;poll
op_assign
id|fec_enet_poll
suffix:semicolon
id|dev-&gt;weight
op_assign
id|fpi-&gt;napi_weight
suffix:semicolon
)brace
id|dev-&gt;ethtool_ops
op_assign
op_amp
id|fec_ethtool_ops
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|fec_ioctl
suffix:semicolon
id|fep-&gt;fec_phy_speed
op_assign
(paren
(paren
(paren
(paren
id|fpi-&gt;sys_clk
op_plus
l_int|4999999
)paren
op_div
l_int|2500000
)paren
op_div
l_int|2
)paren
op_amp
l_int|0x3F
)paren
op_lshift
l_int|1
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|fep-&gt;phy_timer_list
)paren
suffix:semicolon
multiline_comment|/* partial reset of FEC so that only MII works */
id|FW
c_func
(paren
id|fecp
comma
id|mii_speed
comma
id|fep-&gt;fec_phy_speed
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|ievent
comma
l_int|0xffc0
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|ivec
comma
(paren
id|fpi-&gt;fec_irq
op_div
l_int|2
)paren
op_lshift
l_int|29
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|imask
comma
l_int|0
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|r_cntrl
comma
id|FEC_RCNTRL_MII_MODE
)paren
suffix:semicolon
multiline_comment|/* MII enable */
id|FW
c_func
(paren
id|fecp
comma
id|ecntrl
comma
id|FEC_ECNTRL_PINMUX
op_or
id|FEC_ECNTRL_ETHER_EN
)paren
suffix:semicolon
id|netif_carrier_off
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err
op_assign
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
r_goto
id|err
suffix:semicolon
id|registered
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fpi-&gt;use_mdio
)paren
(brace
id|fep-&gt;mii_if.dev
op_assign
id|dev
suffix:semicolon
id|fep-&gt;mii_if.mdio_read
op_assign
id|fec_mii_read
suffix:semicolon
id|fep-&gt;mii_if.mdio_write
op_assign
id|fec_mii_write
suffix:semicolon
id|fep-&gt;mii_if.phy_id_mask
op_assign
l_int|0x1f
suffix:semicolon
id|fep-&gt;mii_if.reg_num_mask
op_assign
l_int|0x1f
suffix:semicolon
id|fep-&gt;mii_if.phy_id
op_assign
id|fec_mii_phy_id_detect
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
op_star
id|devp
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
r_if
c_cond
(paren
id|dev
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|fecp
op_ne
l_int|NULL
)paren
id|fec_whack_reset
c_func
(paren
id|fecp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|registered
)paren
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fep
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|fep-&gt;ring_base
)paren
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
(paren
id|fpi-&gt;tx_ring
op_plus
id|fpi-&gt;rx_ring
)paren
op_star
r_sizeof
(paren
id|cbd_t
)paren
comma
id|fep-&gt;ring_base
comma
id|fep-&gt;ring_mem_addr
)paren
suffix:semicolon
)brace
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|fec_8xx_cleanup_one
r_int
id|fec_8xx_cleanup_one
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_t
op_star
id|fecp
op_assign
id|fep-&gt;fecp
suffix:semicolon
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
op_assign
id|fep-&gt;fpi
suffix:semicolon
id|fec_whack_reset
c_func
(paren
id|fecp
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
(paren
id|fpi-&gt;tx_ring
op_plus
id|fpi-&gt;rx_ring
)paren
op_star
r_sizeof
(paren
id|cbd_t
)paren
comma
id|fep-&gt;ring_base
comma
id|fep-&gt;ring_mem_addr
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**************************************************************************************/
multiline_comment|/**************************************************************************************/
multiline_comment|/**************************************************************************************/
DECL|function|fec_8xx_init
r_static
r_int
id|__init
id|fec_8xx_init
c_func
(paren
r_void
)paren
(brace
r_return
id|fec_8xx_platform_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|fec_8xx_cleanup
r_static
r_void
id|__exit
id|fec_8xx_cleanup
c_func
(paren
r_void
)paren
(brace
id|fec_8xx_platform_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************************/
multiline_comment|/**************************************************************************************/
multiline_comment|/**************************************************************************************/
DECL|variable|fec_8xx_init
id|module_init
c_func
(paren
id|fec_8xx_init
)paren
suffix:semicolon
DECL|variable|fec_8xx_cleanup
id|module_exit
c_func
(paren
id|fec_8xx_cleanup
)paren
suffix:semicolon
eof
