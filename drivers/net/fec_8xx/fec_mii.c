multiline_comment|/*&n; * Fast Ethernet Controller (FEC) driver for Motorola MPC8xx.&n; *&n; * Copyright (c) 2003 Intracom S.A. &n; *  by Pantelis Antoniou &lt;panto@intracom.gr&gt;&n; *&n; * Heavily based on original FEC driver by Dan Malek &lt;dan@embeddededge.com&gt;&n; * and modifications by Joakim Tjernlund &lt;joakim.tjernlund@lumentis.se&gt;&n; *&n; * Released under the GPL&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/mii.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/8xx_immap.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/mpc8xx.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/commproc.h&gt;
multiline_comment|/*************************************************/
macro_line|#include &quot;fec_8xx.h&quot;
multiline_comment|/*************************************************/
multiline_comment|/* Make MII read/write commands for the FEC.&n;*/
DECL|macro|mk_mii_read
mdefine_line|#define mk_mii_read(REG)&t;(0x60020000 | ((REG &amp; 0x1f) &lt;&lt; 18))
DECL|macro|mk_mii_write
mdefine_line|#define mk_mii_write(REG, VAL)&t;(0x50020000 | ((REG &amp; 0x1f) &lt;&lt; 18) | (VAL &amp; 0xffff))
DECL|macro|mk_mii_end
mdefine_line|#define mk_mii_end&t;&t;0
multiline_comment|/*************************************************/
multiline_comment|/* XXX both FECs use the MII interface of FEC1 */
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|fec_mii_lock
)paren
suffix:semicolon
DECL|macro|FEC_MII_LOOPS
mdefine_line|#define FEC_MII_LOOPS&t;10000
DECL|function|fec_mii_read
r_int
id|fec_mii_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_t
op_star
id|fecp
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* XXX MII interface is only connected to FEC1 */
id|fecp
op_assign
op_amp
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_cpm.cp_fec
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fec_mii_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|FR
c_func
(paren
id|fecp
comma
id|r_cntrl
)paren
op_amp
id|FEC_RCNTRL_MII_MODE
)paren
op_eq
l_int|0
)paren
(brace
id|FS
c_func
(paren
id|fecp
comma
id|r_cntrl
comma
id|FEC_RCNTRL_MII_MODE
)paren
suffix:semicolon
multiline_comment|/* MII enable */
id|FS
c_func
(paren
id|fecp
comma
id|ecntrl
comma
id|FEC_ECNTRL_PINMUX
op_or
id|FEC_ECNTRL_ETHER_EN
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|ievent
comma
id|FEC_ENET_MII
)paren
suffix:semicolon
)brace
multiline_comment|/* Add PHY address to register command.  */
id|FW
c_func
(paren
id|fecp
comma
id|mii_speed
comma
id|fep-&gt;fec_phy_speed
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|mii_data
comma
(paren
id|phy_id
op_lshift
l_int|23
)paren
op_or
id|mk_mii_read
c_func
(paren
id|location
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FEC_MII_LOOPS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|FR
c_func
(paren
id|fecp
comma
id|ievent
)paren
op_amp
id|FEC_ENET_MII
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|FEC_MII_LOOPS
)paren
(brace
id|FW
c_func
(paren
id|fecp
comma
id|ievent
comma
id|FEC_ENET_MII
)paren
suffix:semicolon
id|ret
op_assign
id|FR
c_func
(paren
id|fecp
comma
id|mii_data
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fec_mii_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|fec_mii_write
r_void
id|fec_mii_write
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|phy_id
comma
r_int
id|location
comma
r_int
id|value
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_t
op_star
id|fecp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* XXX MII interface is only connected to FEC1 */
id|fecp
op_assign
op_amp
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_cpm.cp_fec
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fec_mii_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|FR
c_func
(paren
id|fecp
comma
id|r_cntrl
)paren
op_amp
id|FEC_RCNTRL_MII_MODE
)paren
op_eq
l_int|0
)paren
(brace
id|FS
c_func
(paren
id|fecp
comma
id|r_cntrl
comma
id|FEC_RCNTRL_MII_MODE
)paren
suffix:semicolon
multiline_comment|/* MII enable */
id|FS
c_func
(paren
id|fecp
comma
id|ecntrl
comma
id|FEC_ECNTRL_PINMUX
op_or
id|FEC_ECNTRL_ETHER_EN
)paren
suffix:semicolon
id|FW
c_func
(paren
id|fecp
comma
id|ievent
comma
id|FEC_ENET_MII
)paren
suffix:semicolon
)brace
multiline_comment|/* Add PHY address to register command.  */
id|FW
c_func
(paren
id|fecp
comma
id|mii_speed
comma
id|fep-&gt;fec_phy_speed
)paren
suffix:semicolon
multiline_comment|/* always adapt mii speed */
id|FW
c_func
(paren
id|fecp
comma
id|mii_data
comma
(paren
id|phy_id
op_lshift
l_int|23
)paren
op_or
id|mk_mii_write
c_func
(paren
id|location
comma
id|value
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FEC_MII_LOOPS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|FR
c_func
(paren
id|fecp
comma
id|ievent
)paren
op_amp
id|FEC_ENET_MII
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|FEC_MII_LOOPS
)paren
id|FW
c_func
(paren
id|fecp
comma
id|ievent
comma
id|FEC_ENET_MII
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fec_mii_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*************************************************/
macro_line|#ifdef CONFIG_FEC_8XX_GENERIC_PHY
multiline_comment|/*&n; * Generic PHY support.&n; * Should work for all PHYs, but link change is detected by polling&n; */
DECL|function|generic_timer_callback
r_static
r_void
id|generic_timer_callback
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|data
suffix:semicolon
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fep-&gt;phy_timer_list.expires
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|fep-&gt;phy_timer_list
)paren
suffix:semicolon
id|fec_mii_link_status_change_check
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|generic_startup
r_static
r_void
id|generic_startup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fep-&gt;phy_timer_list.expires
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
suffix:semicolon
multiline_comment|/* every 500ms */
id|fep-&gt;phy_timer_list.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|fep-&gt;phy_timer_list.function
op_assign
id|generic_timer_callback
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|fep-&gt;phy_timer_list
)paren
suffix:semicolon
)brace
DECL|function|generic_shutdown
r_static
r_void
id|generic_shutdown
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|fep-&gt;phy_timer_list
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_FEC_8XX_DM9161_PHY
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/* The Davicom DM9161 is used on the NETTA board&t;&t;&t;     */
multiline_comment|/* register definitions */
DECL|macro|MII_DM9161_ACR
mdefine_line|#define MII_DM9161_ACR&t;&t;16&t;/* Aux. Config Register         */
DECL|macro|MII_DM9161_ACSR
mdefine_line|#define MII_DM9161_ACSR&t;&t;17&t;/* Aux. Config/Status Register  */
DECL|macro|MII_DM9161_10TCSR
mdefine_line|#define MII_DM9161_10TCSR&t;18&t;/* 10BaseT Config/Status Reg.   */
DECL|macro|MII_DM9161_INTR
mdefine_line|#define MII_DM9161_INTR&t;&t;21&t;/* Interrupt Register           */
DECL|macro|MII_DM9161_RECR
mdefine_line|#define MII_DM9161_RECR&t;&t;22&t;/* Receive Error Counter Reg.   */
DECL|macro|MII_DM9161_DISCR
mdefine_line|#define MII_DM9161_DISCR&t;23&t;/* Disconnect Counter Register  */
DECL|function|dm9161_startup
r_static
r_void
id|dm9161_startup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_mii_write
c_func
(paren
id|dev
comma
id|fep-&gt;mii_if.phy_id
comma
id|MII_DM9161_INTR
comma
l_int|0x0000
)paren
suffix:semicolon
)brace
DECL|function|dm9161_ack_int
r_static
r_void
id|dm9161_ack_int
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_mii_read
c_func
(paren
id|dev
comma
id|fep-&gt;mii_if.phy_id
comma
id|MII_DM9161_INTR
)paren
suffix:semicolon
)brace
DECL|function|dm9161_shutdown
r_static
r_void
id|dm9161_shutdown
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|fec_mii_write
c_func
(paren
id|dev
comma
id|fep-&gt;mii_if.phy_id
comma
id|MII_DM9161_INTR
comma
l_int|0x0f00
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/**********************************************************************************/
DECL|variable|phy_info
r_static
r_const
r_struct
id|phy_info
id|phy_info
(braket
)braket
op_assign
(brace
macro_line|#ifdef CONFIG_FEC_8XX_DM9161_PHY
(brace
dot
id|id
op_assign
l_int|0x00181b88
comma
dot
id|name
op_assign
l_string|&quot;DM9161&quot;
comma
dot
id|startup
op_assign
id|dm9161_startup
comma
dot
id|ack_int
op_assign
id|dm9161_ack_int
comma
dot
id|shutdown
op_assign
id|dm9161_shutdown
comma
)brace
comma
macro_line|#endif
macro_line|#ifdef CONFIG_FEC_8XX_GENERIC_PHY
(brace
dot
id|id
op_assign
l_int|0
comma
dot
id|name
op_assign
l_string|&quot;GENERIC&quot;
comma
dot
id|startup
op_assign
id|generic_startup
comma
dot
id|shutdown
op_assign
id|generic_shutdown
comma
)brace
comma
macro_line|#endif
)brace
suffix:semicolon
multiline_comment|/**********************************************************************************/
DECL|function|fec_mii_phy_id_detect
r_int
id|fec_mii_phy_id_detect
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
op_assign
id|fep-&gt;fpi
suffix:semicolon
r_int
id|i
comma
id|r
comma
id|start
comma
id|end
comma
id|phytype
comma
id|physubtype
suffix:semicolon
r_const
r_struct
id|phy_info
op_star
id|phy
suffix:semicolon
r_int
id|phy_hwid
comma
id|phy_id
suffix:semicolon
multiline_comment|/* if no MDIO */
r_if
c_cond
(paren
id|fpi-&gt;use_mdio
op_eq
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|phy_hwid
op_assign
op_minus
l_int|1
suffix:semicolon
id|fep-&gt;phy
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* auto-detect? */
r_if
c_cond
(paren
id|fpi-&gt;phy_addr
op_eq
op_minus
l_int|1
)paren
(brace
id|start
op_assign
l_int|0
suffix:semicolon
id|end
op_assign
l_int|32
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* direct */
id|start
op_assign
id|fpi-&gt;phy_addr
suffix:semicolon
id|end
op_assign
id|start
op_plus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|phy_id
op_assign
id|start
suffix:semicolon
id|phy_id
OL
id|end
suffix:semicolon
id|phy_id
op_increment
)paren
(brace
id|r
op_assign
id|fec_mii_read
c_func
(paren
id|dev
comma
id|phy_id
comma
id|MII_PHYSID1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_eq
op_minus
l_int|1
op_logical_or
(paren
id|phytype
op_assign
(paren
id|r
op_amp
l_int|0xffff
)paren
)paren
op_eq
l_int|0xffff
)paren
r_continue
suffix:semicolon
id|r
op_assign
id|fec_mii_read
c_func
(paren
id|dev
comma
id|phy_id
comma
id|MII_PHYSID2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_eq
op_minus
l_int|1
op_logical_or
(paren
id|physubtype
op_assign
(paren
id|r
op_amp
l_int|0xffff
)paren
)paren
op_eq
l_int|0xffff
)paren
r_continue
suffix:semicolon
id|phy_hwid
op_assign
(paren
id|phytype
op_lshift
l_int|16
)paren
op_or
id|physubtype
suffix:semicolon
r_if
c_cond
(paren
id|phy_hwid
op_ne
op_minus
l_int|1
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|phy_hwid
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_MODULE_NAME
l_string|&quot;: %s No PHY detected!&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|phy
op_assign
id|phy_info
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|phy_info
)paren
op_div
r_sizeof
(paren
id|phy_info
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
comma
id|phy
op_increment
)paren
r_if
c_cond
(paren
id|phy-&gt;id
op_eq
(paren
id|phy_hwid
op_rshift
l_int|4
)paren
op_logical_or
id|phy-&gt;id
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
r_sizeof
(paren
id|phy_info
)paren
op_div
r_sizeof
(paren
id|phy_info
(braket
l_int|0
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_MODULE_NAME
l_string|&quot;: %s PHY id 0x%08x is not supported!&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy_hwid
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|fep-&gt;phy
op_assign
id|phy
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DRV_MODULE_NAME
l_string|&quot;: %s Phy @ 0x%x, type %s (0x%08x)&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|phy_id
comma
id|fep-&gt;phy-&gt;name
comma
id|phy_hwid
)paren
suffix:semicolon
r_return
id|phy_id
suffix:semicolon
)brace
DECL|function|fec_mii_startup
r_void
id|fec_mii_startup
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
op_assign
id|fep-&gt;fpi
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fpi-&gt;use_mdio
op_logical_or
id|fep-&gt;phy
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;phy-&gt;startup
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
(paren
op_star
id|fep-&gt;phy-&gt;startup
)paren
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|fec_mii_shutdown
r_void
id|fec_mii_shutdown
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
op_assign
id|fep-&gt;fpi
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fpi-&gt;use_mdio
op_logical_or
id|fep-&gt;phy
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;phy-&gt;shutdown
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
(paren
op_star
id|fep-&gt;phy-&gt;shutdown
)paren
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|fec_mii_ack_int
r_void
id|fec_mii_ack_int
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_const
r_struct
id|fec_platform_info
op_star
id|fpi
op_assign
id|fep-&gt;fpi
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fpi-&gt;use_mdio
op_logical_or
id|fep-&gt;phy
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|fep-&gt;phy-&gt;ack_int
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
(paren
op_star
id|fep-&gt;phy-&gt;ack_int
)paren
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* helper function */
DECL|function|mii_negotiated
r_static
r_int
id|mii_negotiated
c_func
(paren
r_struct
id|mii_if_info
op_star
id|mii
)paren
(brace
r_int
id|advert
comma
id|lpa
comma
id|val
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mii_link_ok
c_func
(paren
id|mii
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|val
op_assign
(paren
op_star
id|mii-&gt;mdio_read
)paren
(paren
id|mii-&gt;dev
comma
id|mii-&gt;phy_id
comma
id|MII_BMSR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
id|BMSR_ANEGCOMPLETE
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|advert
op_assign
(paren
op_star
id|mii-&gt;mdio_read
)paren
(paren
id|mii-&gt;dev
comma
id|mii-&gt;phy_id
comma
id|MII_ADVERTISE
)paren
suffix:semicolon
id|lpa
op_assign
(paren
op_star
id|mii-&gt;mdio_read
)paren
(paren
id|mii-&gt;dev
comma
id|mii-&gt;phy_id
comma
id|MII_LPA
)paren
suffix:semicolon
r_return
id|mii_nway_result
c_func
(paren
id|advert
op_amp
id|lpa
)paren
suffix:semicolon
)brace
DECL|function|fec_mii_link_status_change_check
r_void
id|fec_mii_link_status_change_check
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|init_media
)paren
(brace
r_struct
id|fec_enet_private
op_star
id|fep
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|media
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|mii_check_media
c_func
(paren
op_amp
id|fep-&gt;mii_if
comma
id|netif_msg_link
c_func
(paren
id|fep
)paren
comma
id|init_media
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|media
op_assign
id|mii_negotiated
c_func
(paren
op_amp
id|fep-&gt;mii_if
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_carrier_ok
c_func
(paren
id|dev
)paren
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|fec_restart
c_func
(paren
id|dev
comma
op_logical_neg
op_logical_neg
(paren
id|media
op_amp
id|ADVERTISE_FULL
)paren
comma
(paren
id|media
op_amp
(paren
id|ADVERTISE_100FULL
op_or
id|ADVERTISE_100HALF
)paren
)paren
ques
c_cond
l_int|100
suffix:colon
l_int|10
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|fec_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fep-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
eof
